<html>
<head><meta charset="utf-8"><title>wasmtime / issue #6163 Allow WASI to open directories wit... · git-wasmtime · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/index.html">git-wasmtime</a></h2>
<h3>Topic: <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.236163.20Allow.20WASI.20to.20open.20directories.20wit.2E.2E.2E.html">wasmtime / issue #6163 Allow WASI to open directories wit...</a></h3>

<hr>

<base href="https://bytecodealliance.zulipchat.com">

<head><link href="https://bytecodealliance.github.io/zulip-archive/style.css" rel="stylesheet"></head>

<a name="347285317"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%236163%20Allow%20WASI%20to%20open%20directories%20wit.../near/347285317" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.236163.20Allow.20WASI.20to.20open.20directories.20wit.2E.2E.2E.html#347285317">(Apr 06 2023 at 02:03)</a>:</h4>
<p>github-actions[bot] <a href="https://github.com/bytecodealliance/wasmtime/pull/6163#issuecomment-1498391437">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/6163">issue #6163</a>:</p>
<blockquote>
<h4>Subscribe to Label Action</h4>
<p>cc @kubkon</p>
<p>&lt;details&gt;<br>
This issue or pull request has been labeled: "wasi"</p>
<p>Thus the following users have been cc'd because of the following labels:</p>
<ul>
<li>kubkon: wasi</li>
</ul>
<p>To subscribe or unsubscribe from this label, edit the &lt;code&gt;.github/subscribe-to-label.json&lt;/code&gt; configuration file.</p>
<p><a href="https://github.com/bytecodealliance/subscribe-to-label-action">Learn more.</a><br>
&lt;/details&gt;</p>
</blockquote>



<a name="347547292"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%236163%20Allow%20WASI%20to%20open%20directories%20wit.../near/347547292" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.236163.20Allow.20WASI.20to.20open.20directories.20wit.2E.2E.2E.html#347547292">(Apr 07 2023 at 01:10)</a>:</h4>
<p>sunfishcode <a href="https://github.com/bytecodealliance/wasmtime/pull/6163#issuecomment-1499812561">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/6163">issue #6163</a>:</p>
<blockquote>
<p>Looks like this is headed in the right direction! </p>
<blockquote>
<p>I don't understand how the capabilities are supposed to work yet. Opening a directory got file_caps from fs_rights_inheriting, while opening a file got them from fs_rights_base. I haven't implemented that distinction in this PR yet.</p>
</blockquote>
<p>"Inheriting" rights are rights that should apply to derived file descriptors, such as files opened from directories. For directories opened for directories, they can just assume the same base and inheriting rights as the directory they were owned from, because the "inheriting" rights will apply to files opened <em>under</em> them.<br>
</p>
</blockquote>



<a name="350642861"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%236163%20Allow%20WASI%20to%20open%20directories%20wit.../near/350642861" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.236163.20Allow.20WASI.20to.20open.20directories.20wit.2E.2E.2E.html#350642861">(Apr 18 2023 at 00:44)</a>:</h4>
<p>jameysharp <a href="https://github.com/bytecodealliance/wasmtime/pull/6163#issuecomment-1512282733">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/6163">issue #6163</a>:</p>
<blockquote>
<p>Okay cool, so this now passes all the tests on Linux, but fails some tests on Windows. I'm probably going to need help figuring out how to fix that.</p>
</blockquote>



<a name="350872049"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%236163%20Allow%20WASI%20to%20open%20directories%20wit.../near/350872049" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.236163.20Allow.20WASI.20to.20open.20directories.20wit.2E.2E.2E.html#350872049">(Apr 18 2023 at 19:45)</a>:</h4>
<p>jameysharp <a href="https://github.com/bytecodealliance/wasmtime/pull/6163#issuecomment-1513708123">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/6163">issue #6163</a>:</p>
<blockquote>
<p>I've identified the root cause of the test failures on Windows. I pushed a commit that changes the tests, which let them pass in CI.</p>
<p>My question now: Is it okay to treat this as a bug in the tests, or do we need an implementation that supports the existing behavior of the tests?</p>
<p>Details:</p>
<p>On Windows, when opening a path which might be a directory using <code>CreateFile</code>, cap-primitives also removes the <code>FILE_SHARE_DELETE</code> mode.</p>
<p>That means that if we implement WASI's <code>path_open</code> such that it always uses <code>CreateFile</code> on Windows, for both files and directories, then holding an open file handle prevents deletion of that file.</p>
<p>So I'm changing these test programs to make sure they've closed the handle before trying to delete the file.</p>
<p>Do we need to support deleting files which still have open handles on Windows?</p>
</blockquote>



<a name="350890939"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%236163%20Allow%20WASI%20to%20open%20directories%20wit.../near/350890939" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.236163.20Allow.20WASI.20to.20open.20directories.20wit.2E.2E.2E.html#350890939">(Apr 18 2023 at 21:51)</a>:</h4>
<p>pchickey <a href="https://github.com/bytecodealliance/wasmtime/pull/6163#issuecomment-1513835355">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/6163">issue #6163</a>:</p>
<blockquote>
<p>It is OK to not support deleting files which still have open handles on windows - we have a number of other special cases where the tests expect a different behavior for things like this on windows (among them: symlink behavior, and renaming a dir to an empty dir). While it isnt a properly descriptive name, the <code>TESTCONFIG.support_dangling_filesystem()</code> boolean is false when running on windows, so please modify the test to check for whatever behavior windows does when that is false.</p>
</blockquote>



<a name="350892554"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%236163%20Allow%20WASI%20to%20open%20directories%20wit.../near/350892554" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.236163.20Allow.20WASI.20to.20open.20directories.20wit.2E.2E.2E.html#350892554">(Apr 18 2023 at 22:04)</a>:</h4>
<p>jameysharp <a href="https://github.com/bytecodealliance/wasmtime/pull/6163#issuecomment-1513845807">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/6163">issue #6163</a>:</p>
<blockquote>
<p>Just to make sure I understand: you want the tests to specifically verify that deleting files is prohibited if there are still open handles? Right now this PR just avoids trying to delete files when there are still open handles, so it passes on all platforms. But you want the tests to fail if our implementation on Windows ever starts allowing deleting open files?</p>
</blockquote>



<a name="351397533"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%236163%20Allow%20WASI%20to%20open%20directories%20wit.../near/351397533" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.236163.20Allow.20WASI.20to.20open.20directories.20wit.2E.2E.2E.html#351397533">(Apr 20 2023 at 18:11)</a>:</h4>
<p>pchickey <a href="https://github.com/bytecodealliance/wasmtime/pull/6163#issuecomment-1516748665">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/6163">issue #6163</a>:</p>
<blockquote>
<p>In keeping with the rest of the test suite, I don't think we need to test for positive behavior on windows (i.e. deleting files with open handles is prohibited), just conditionally skip the check for the deletion behavior if on windows.</p>
</blockquote>



<a name="351404951"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%236163%20Allow%20WASI%20to%20open%20directories%20wit.../near/351404951" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.236163.20Allow.20WASI.20to.20open.20directories.20wit.2E.2E.2E.html#351404951">(Apr 20 2023 at 18:48)</a>:</h4>
<p>jameysharp <a href="https://github.com/bytecodealliance/wasmtime/pull/6163#issuecomment-1516789654">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/6163">issue #6163</a>:</p>
<blockquote>
<p>I'm still confused, I guess. All I had to do to make the tests work on all platforms was to ensure that the file handle was closed before attempting to unlink the underlying file. So I don't strictly need to conditionally disable anything, unless you want it to specifically check the behavior of trying to unlink an open file. I guess you're saying we don't need to check that behavior on Windows, so are you asking for an explicit test that non-Windows systems do allow unlinking open files? I can do that, I just didn't see any sign that this was something these tests were intended to cover. It looked to me like it was more of an accident that they failed in this case.</p>
</blockquote>



<a name="351410349"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%236163%20Allow%20WASI%20to%20open%20directories%20wit.../near/351410349" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.236163.20Allow.20WASI.20to.20open.20directories.20wit.2E.2E.2E.html#351410349">(Apr 20 2023 at 19:16)</a>:</h4>
<p>pchickey <a href="https://github.com/bytecodealliance/wasmtime/pull/6163#issuecomment-1516823933">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/6163">issue #6163</a>:</p>
<blockquote>
<p>I was confused as well. </p>
<blockquote>
<p>So I'm changing these test programs to make sure they've closed the handle before trying to delete the file.<br>
This is a totally sufficient solution. I don't think we need to test any of these windows or not-windows behaviors further.</p>
</blockquote>
</blockquote>



<a name="351410366"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%236163%20Allow%20WASI%20to%20open%20directories%20wit.../near/351410366" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.236163.20Allow.20WASI.20to.20open.20directories.20wit.2E.2E.2E.html#351410366">(Apr 20 2023 at 19:16)</a>:</h4>
<p>pchickey edited a <a href="https://github.com/bytecodealliance/wasmtime/pull/6163#issuecomment-1516823933">comment</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/6163">issue #6163</a>:</p>
<blockquote>
<p>I was confused as well. </p>
<blockquote>
<p>So I'm changing these test programs to make sure they've closed the handle before trying to delete the file.</p>
</blockquote>
<p>This is a totally sufficient solution. I don't think we need to test any of these windows or not-windows behaviors further.</p>
</blockquote>



<a name="351412359"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%236163%20Allow%20WASI%20to%20open%20directories%20wit.../near/351412359" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.236163.20Allow.20WASI.20to.20open.20directories.20wit.2E.2E.2E.html#351412359">(Apr 20 2023 at 19:29)</a>:</h4>
<p>jameysharp <a href="https://github.com/bytecodealliance/wasmtime/pull/6163#issuecomment-1516837045">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/6163">issue #6163</a>:</p>
<blockquote>
<p>Hooray! Any other concerns about merging this, then? As far as I can tell, I think it's ready to go.</p>
</blockquote>



<a name="352425910"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%236163%20Allow%20WASI%20to%20open%20directories%20wit.../near/352425910" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.236163.20Allow.20WASI.20to.20open.20directories.20wit.2E.2E.2E.html#352425910">(Apr 25 2023 at 04:45)</a>:</h4>
<p>achille-roussel <a href="https://github.com/bytecodealliance/wasmtime/pull/6163#issuecomment-1521146555">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/6163">issue #6163</a>:</p>
<blockquote>
<p>Thank you for wrapping up this fix!</p>
<p>We have code in the upcoming Go release (1.21) which acted as a temporary workaround <a href="https://github.com/golang/go/blob/22d94dfdc8ab866ff6097b6b92a2860233873c95/src/syscall/fs_wasip1.go#L435-L456">https://github.com/golang/go/blob/22d94dfdc8ab866ff6097b6b92a2860233873c95/src/syscall/fs_wasip1.go#L435-L456</a></p>
<p>An automated test runner using wasmtime is also being added to Go <a href="https://github.com/golang/go/issues/59583">https://github.com/golang/go/issues/59583</a></p>
<p>It seems wasmtime has been releasing major versions mostly (around once a month). Having this fix available in an earlier release would allow us to integrate it immediately in the test suite, and remove the workaround.</p>
<p>Would it be possible to issue a patch release (v8.0.1) which includes this fix?<br>
</p>
</blockquote>



<a name="352559331"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%236163%20Allow%20WASI%20to%20open%20directories%20wit.../near/352559331" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.236163.20Allow.20WASI.20to.20open.20directories.20wit.2E.2E.2E.html#352559331">(Apr 25 2023 at 14:46)</a>:</h4>
<p>alexcrichton <a href="https://github.com/bytecodealliance/wasmtime/pull/6163#issuecomment-1521921674">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/6163">issue #6163</a>:</p>
<blockquote>
<p>We do have an <a href="https://groups.google.com/a/bytecodealliance.org/g/sec-announce/c/ecK-6G2yi90?pli=1">upcoming security release</a> this Thursday for 8.0.1, so this could ride out with that. @jameysharp do you feel confident enough in this being back-portable to 8.0.1?</p>
<p>At least IIRC we don't have a firm policy about what and what not to backport, so in lieu of that I'm assuming that explicitly requested changes are fine for considering as candidates.</p>
</blockquote>



<a name="352576109"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%236163%20Allow%20WASI%20to%20open%20directories%20wit.../near/352576109" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.236163.20Allow.20WASI.20to.20open.20directories.20wit.2E.2E.2E.html#352576109">(Apr 25 2023 at 15:45)</a>:</h4>
<p>jameysharp <a href="https://github.com/bytecodealliance/wasmtime/pull/6163#issuecomment-1522026106">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/6163">issue #6163</a>:</p>
<blockquote>
<p>I'm confident in this PR on POSIX-conforming systems. I'm not 100% confident that I didn't break something on Windows, but the fact that CI did catch Windows-specific bugs in my first attempts is reassuring. So I'd say I'm pretty confident this is fine to backport to 8.0.1.</p>
<p>Also, this commit cherry-picks cleanly onto release-8.0.0, which is nice. Would you like me to open a PR for that, Alex?</p>
</blockquote>



<a name="352578344"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%236163%20Allow%20WASI%20to%20open%20directories%20wit.../near/352578344" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.236163.20Allow.20WASI.20to.20open.20directories.20wit.2E.2E.2E.html#352578344">(Apr 25 2023 at 15:54)</a>:</h4>
<p>alexcrichton <a href="https://github.com/bytecodealliance/wasmtime/pull/6163#issuecomment-1522039208">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/6163">issue #6163</a>:</p>
<blockquote>
<p>Ok that sounds good to me, yeah. If you're up for it a PR to <code>release-8.0.0</code> would work well and then this'll get folded into Thursday's release.</p>
</blockquote>



<hr><p>Last updated: Jan 20 2025 at 06:04 UTC</p>
</html>