<html>
<head><meta charset="utf-8"><title>wasmtime / PR #7304 A couple of small refactorings to the... · git-wasmtime · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/index.html">git-wasmtime</a></h2>
<h3>Topic: <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.237304.20A.20couple.20of.20small.20refactorings.20to.20the.2E.2E.2E.html">wasmtime / PR #7304 A couple of small refactorings to the...</a></h3>

<hr>

<base href="https://bytecodealliance.zulipchat.com">

<head><link href="https://bytecodealliance.github.io/zulip-archive/style.css" rel="stylesheet"></head>

<a name="397587988"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%237304%20A%20couple%20of%20small%20refactorings%20to%20the.../near/397587988" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.237304.20A.20couple.20of.20small.20refactorings.20to.20the.2E.2E.2E.html#397587988">(Oct 19 2023 at 22:52)</a>:</h4>
<p>elliottt opened <a href="https://github.com/bytecodealliance/wasmtime/pull/7304">PR #7304</a> from <code>elliottt:trevor/elaborate-fixes</code> to <code>bytecodealliance:main</code>:</p>
<blockquote>
<p>@jameysharp and I noticed a couple of refactoring opportunities while reading through the elaboration pass:</p>
<ul>
<li>The elaboration loop doesn't need to match on the top of the stack as a reference, because each case pops it immediately. Instead we can pop and match on the popped value.</li>
<li>Computing the cost of a <code>Result</code> value that's not in the DFG was using the block that contains the instruction to determine the level, but since the instruction is already known to not be in the DFG, this would default to <code>LoopLevel::root()</code> unconditionally. This also meant that the <code>Cost::at_level</code> function turned into an identity function on the cost given, making it unnecessary.</li>
</ul>
<p>Co-authored-by: Jamey Sharp &lt;<a href="mailto:jsharp@fastly.com">jsharp@fastly.com</a>&gt;</p>
<p>&lt;!--<br>
Please make sure you include the following information:</p>
<ul>
<li>
<p>If this work has been discussed elsewhere, please include a link to that<br>
  conversation. If it was discussed in an issue, just mention "issue #...".</p>
</li>
<li>
<p>Explain why this change is needed. If the details are in an issue already,<br>
  this can be brief.</p>
</li>
</ul>
<p>Our development process is documented in the Wasmtime book:<br>
<a href="https://docs.wasmtime.dev/contributing-development-process.html">https://docs.wasmtime.dev/contributing-development-process.html</a></p>
<p>Please ensure all communication follows the code of conduct:<br>
<a href="https://github.com/bytecodealliance/wasmtime/blob/main/CODE_OF_CONDUCT.md">https://github.com/bytecodealliance/wasmtime/blob/main/CODE_OF_CONDUCT.md</a><br>
--&gt;</p>
</blockquote>



<a name="397587989"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%237304%20A%20couple%20of%20small%20refactorings%20to%20the.../near/397587989" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.237304.20A.20couple.20of.20small.20refactorings.20to.20the.2E.2E.2E.html#397587989">(Oct 19 2023 at 22:52)</a>:</h4>
<p><strong>elliottt</strong> requested <a href="https://github.com/abrown">abrown</a> for a review on <a href="https://github.com/bytecodealliance/wasmtime/pull/7304">PR #7304</a>.</p>



<a name="397587990"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%237304%20A%20couple%20of%20small%20refactorings%20to%20the.../near/397587990" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.237304.20A.20couple.20of.20small.20refactorings.20to.20the.2E.2E.2E.html#397587990">(Oct 19 2023 at 22:52)</a>:</h4>
<p><strong>elliottt</strong> requested <a href="https://github.com/orgs/bytecodealliance/teams/wasmtime-compiler-reviewers">wasmtime-compiler-reviewers</a> for a review on <a href="https://github.com/bytecodealliance/wasmtime/pull/7304">PR #7304</a>.</p>



<a name="397588018"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%237304%20A%20couple%20of%20small%20refactorings%20to%20the.../near/397588018" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.237304.20A.20couple.20of.20small.20refactorings.20to.20the.2E.2E.2E.html#397588018">(Oct 19 2023 at 22:53)</a>:</h4>
<p><strong>elliottt</strong> requested <a href="https://github.com/cfallin">cfallin</a> for a review on <a href="https://github.com/bytecodealliance/wasmtime/pull/7304">PR #7304</a>.</p>



<a name="397590181"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%237304%20A%20couple%20of%20small%20refactorings%20to%20the.../near/397590181" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.237304.20A.20couple.20of.20small.20refactorings.20to.20the.2E.2E.2E.html#397590181">(Oct 19 2023 at 23:16)</a>:</h4>
<p>elliottt edited <a href="https://github.com/bytecodealliance/wasmtime/pull/7304">PR #7304</a>:</p>
<blockquote>
<p>@jameysharp and I noticed a couple of refactoring opportunities while reading through the elaboration pass:</p>
<ul>
<li>The elaboration loop doesn't need to match on the top of the stack as a reference, because each case pops it immediately. Instead we can pop and match on the popped value.</li>
<li>Computing the cost of a pure <code>ValueDef::Result</code> was using the block that contains the instruction to determine the level, but since pure values will not be in the DFG yet, this would default to <code>LoopLevel::root()</code> unconditionally. This also meant that the <code>Cost::at_level</code> function turned into an identity function on the cost given, making it unnecessary.</li>
</ul>
<p>Co-authored-by: Jamey Sharp &lt;<a href="mailto:jsharp@fastly.com">jsharp@fastly.com</a>&gt;</p>
<p>&lt;!--<br>
Please make sure you include the following information:</p>
<ul>
<li>
<p>If this work has been discussed elsewhere, please include a link to that<br>
  conversation. If it was discussed in an issue, just mention "issue #...".</p>
</li>
<li>
<p>Explain why this change is needed. If the details are in an issue already,<br>
  this can be brief.</p>
</li>
</ul>
<p>Our development process is documented in the Wasmtime book:<br>
<a href="https://docs.wasmtime.dev/contributing-development-process.html">https://docs.wasmtime.dev/contributing-development-process.html</a></p>
<p>Please ensure all communication follows the code of conduct:<br>
<a href="https://github.com/bytecodealliance/wasmtime/blob/main/CODE_OF_CONDUCT.md">https://github.com/bytecodealliance/wasmtime/blob/main/CODE_OF_CONDUCT.md</a><br>
--&gt;</p>
</blockquote>



<a name="397593379"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%237304%20A%20couple%20of%20small%20refactorings%20to%20the.../near/397593379" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.237304.20A.20couple.20of.20small.20refactorings.20to.20the.2E.2E.2E.html#397593379">(Oct 19 2023 at 23:52)</a>:</h4>
<p>cfallin submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/7304#pullrequestreview-1688867265">PR review</a>:</p>
<blockquote>
<p>LGTM! Good find w.r.t. the loop-level cost factor being a no-op; I suspect this was left over from an earlier version of extraction. I'd be interested to hear any thoughts you or others have about using the loop level somehow, but I'm happy to see this merged for now!</p>
</blockquote>



<a name="397597619"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%237304%20A%20couple%20of%20small%20refactorings%20to%20the.../near/397597619" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.237304.20A.20couple.20of.20small.20refactorings.20to.20the.2E.2E.2E.html#397597619">(Oct 20 2023 at 00:36)</a>:</h4>
<p>cfallin merged <a href="https://github.com/bytecodealliance/wasmtime/pull/7304">PR #7304</a>.</p>



<hr><p>Last updated: Jan 20 2025 at 06:04 UTC</p>
</html>