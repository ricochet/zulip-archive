<html>
<head><meta charset="utf-8"><title>wasmtime / issue #3322 AArch64 LSE atomic_rmw support · git-wasmtime · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/index.html">git-wasmtime</a></h2>
<h3>Topic: <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.233322.20AArch64.20LSE.20atomic_rmw.20support.html">wasmtime / issue #3322 AArch64 LSE atomic_rmw support</a></h3>

<hr>

<base href="https://bytecodealliance.zulipchat.com">

<head><link href="https://bytecodealliance.github.io/zulip-archive/style.css" rel="stylesheet"></head>

<a name="252653030"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%233322%20AArch64%20LSE%20atomic_rmw%20support/near/252653030" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.233322.20AArch64.20LSE.20atomic_rmw.20support.html#252653030">(Sep 09 2021 at 16:15)</a>:</h4>
<p>afonso360 <a href="https://github.com/bytecodealliance/wasmtime/pull/3322#issuecomment-916243872">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/3322">issue #3322</a>:</p>
<blockquote>
<p>It'd be a good idea add a <code>target aarch64 has_lse</code> to <code>runtests/atomic-rmw.clif</code> and <code>runtests/atomic-rmw-2.clif</code>, if QEMU supports LSE.</p>
</blockquote>



<a name="252664779"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%233322%20AArch64%20LSE%20atomic_rmw%20support/near/252664779" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.233322.20AArch64.20LSE.20atomic_rmw.20support.html#252664779">(Sep 09 2021 at 17:35)</a>:</h4>
<p>akirilov-arm <a href="https://github.com/bytecodealliance/wasmtime/pull/3322#issuecomment-916300872">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/3322">issue #3322</a>:</p>
<blockquote>
<p>Currently we <a href="https://github.com/bytecodealliance/wasmtime/blob/main/.github/workflows/main.yml#L237">force</a> QEMU to emulate a processor that lacks LSE support.</p>
</blockquote>



<a name="252665858"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%233322%20AArch64%20LSE%20atomic_rmw%20support/near/252665858" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.233322.20AArch64.20LSE.20atomic_rmw.20support.html#252665858">(Sep 09 2021 at 17:43)</a>:</h4>
<p>cfallin <a href="https://github.com/bytecodealliance/wasmtime/pull/3322#issuecomment-916306797">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/3322">issue #3322</a>:</p>
<blockquote>
<p>I was curious if QEMU has any <code>-cpu</code> options between A72 (the current) and <code>max</code> (which we disabled to avoid pointer-auth issues on Linux, per #3183); the <a href="https://github.com/qemu/qemu/blob/bd662023e683850c085e98c8ff8297142c2dd9f2/target/arm/cpu64.c#L891-L897">latest source</a> appears to have a configuration option for the <a href="https://en.wikipedia.org/wiki/Fujitsu_A64FX">A64FX</a> as well, which is ARMv8.2 (with LSE, without PAC). Maybe we could update the CI config and try that?</p>
</blockquote>



<a name="252666074"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%233322%20AArch64%20LSE%20atomic_rmw%20support/near/252666074" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.233322.20AArch64.20LSE.20atomic_rmw.20support.html#252666074">(Sep 09 2021 at 17:45)</a>:</h4>
<p>cfallin <a href="https://github.com/bytecodealliance/wasmtime/pull/3322#issuecomment-916307838">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/3322">issue #3322</a>:</p>
<blockquote>
<p>(This was added <a href="https://github.com/qemu/qemu/commit/e31c70ac04001df5e540b79843834277e283fa71">9 days ago</a> so I expect we'd have to pull down a git checkout of qemu rather than build a release; but that's probably fine IMHO.)</p>
</blockquote>



<a name="252745050"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%233322%20AArch64%20LSE%20atomic_rmw%20support/near/252745050" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.233322.20AArch64.20LSE.20atomic_rmw.20support.html#252745050">(Sep 10 2021 at 07:36)</a>:</h4>
<p>sparker-arm <a href="https://github.com/bytecodealliance/wasmtime/pull/3322#issuecomment-916697895">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/3322">issue #3322</a>:</p>
<blockquote>
<blockquote>
<p>I was curious if QEMU has any <code>-cpu</code> options between A72 (the current) and <code>max</code> (which we disabled to avoid pointer-auth issues on Linux, per #3183); the <a href="https://github.com/qemu/qemu/blob/bd662023e683850c085e98c8ff8297142c2dd9f2/target/arm/cpu64.c#L891-L897">latest source</a> appears to have a configuration option for the <a href="https://en.wikipedia.org/wiki/Fujitsu_A64FX">A64FX</a> as well, which is ARMv8.2 (with LSE, without PAC). Maybe we could update the CI config and try that?</p>
</blockquote>
<p>What might be a more scalable, though less pretty option, would be to use the max configuration and turn off the features that we don't want (only PAC?) @akirilov-arm is working on that feature currently so I imagine we'd need testing at some point in the near future. But I haven't ever had to disable features with QEMU, and briefly looking at the code, I'm wondering if all the features have a nice user facing option...</p>
</blockquote>



<a name="252753789"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%233322%20AArch64%20LSE%20atomic_rmw%20support/near/252753789" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.233322.20AArch64.20LSE.20atomic_rmw.20support.html#252753789">(Sep 10 2021 at 08:55)</a>:</h4>
<p>afonso360 <a href="https://github.com/bytecodealliance/wasmtime/pull/3322#issuecomment-916745488">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/3322">issue #3322</a>:</p>
<blockquote>
<p>Reading <a href="https://qemu.readthedocs.io/en/latest/system/arm/cpu-features.html#tcg-vcpu-features">this</a>, it looks like we can just <code>-cpu max,pauth=off</code>. My local qemu 6.0.0 build doesn't recognize this as a invalid feature, I'll try opening a PR to see if CI fails.</p>
</blockquote>



<a name="252753985"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%233322%20AArch64%20LSE%20atomic_rmw%20support/near/252753985" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.233322.20AArch64.20LSE.20atomic_rmw.20support.html#252753985">(Sep 10 2021 at 08:57)</a>:</h4>
<p>afonso360 edited a <a href="https://github.com/bytecodealliance/wasmtime/pull/3322#issuecomment-916745488">comment</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/3322">issue #3322</a>:</p>
<blockquote>
<p>Reading <a href="https://qemu.readthedocs.io/en/latest/system/arm/cpu-features.html#tcg-vcpu-features">this</a>, it looks like we can just <code>-cpu max,pauth=off</code>. My local qemu 6.0.0 build recognizes this as a valid feature, I'll try opening a PR to see if CI fails.</p>
</blockquote>



<a name="253440846"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%233322%20AArch64%20LSE%20atomic_rmw%20support/near/253440846" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.233322.20AArch64.20LSE.20atomic_rmw.20support.html#253440846">(Sep 15 2021 at 16:10)</a>:</h4>
<p>alexcrichton <a href="https://github.com/bytecodealliance/wasmtime/pull/3322#issuecomment-920158227">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/3322">issue #3322</a>:</p>
<blockquote>
<p>As a side note, this is somewhat unlikely to get used much in practice at least with Wasmtime itself <a href="https://github.com/bytecodealliance/wasmtime/blob/d20194fa4c45c68ff1fea315eabc262e854c3074/cranelift/native/src/lib.rs#L114-L126">due to this block</a> which is gated on the off-by-default <code>stdsimd</code> feature (which requires nightly). If y'all are interseted in getting this supported in Wasmtime by default that'd need to be updated with a works-on-stable implementation. (I'm not sure of the status of stabilizing the required macro from libstd itself)</p>
</blockquote>



<a name="253444440"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%233322%20AArch64%20LSE%20atomic_rmw%20support/near/253444440" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.233322.20AArch64.20LSE.20atomic_rmw.20support.html#253444440">(Sep 15 2021 at 16:28)</a>:</h4>
<p>akirilov-arm <a href="https://github.com/bytecodealliance/wasmtime/pull/3322#issuecomment-920172751">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/3322">issue #3322</a>:</p>
<blockquote>
<p>Yes, we are aware of that - my colleague @adamgemmell from Arm's Rust team has proposed stabilising the ISA extension test macro in issue <a href="https://github.com/rust-lang/rust/issues/86941">rust-lang/rust#86941</a> independently of the <code>stdsimd</code> feature. We are going to update the block after the issue is closed, so that it just checks for the target architecture. In the meantime I think it is fine to continue with the code generation optimizations, and @afonso360's suggestion enables us to do some testing.</p>
</blockquote>



<a name="253445021"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%233322%20AArch64%20LSE%20atomic_rmw%20support/near/253445021" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.233322.20AArch64.20LSE.20atomic_rmw.20support.html#253445021">(Sep 15 2021 at 16:31)</a>:</h4>
<p>alexcrichton <a href="https://github.com/bytecodealliance/wasmtime/pull/3322#issuecomment-920175052">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/3322">issue #3322</a>:</p>
<blockquote>
<p>Nice! And yeah of course I think this is fine to land (as well as any other improvements). Just because Wasmtime doesn't use something by default doesn't mean it's not useful!</p>
</blockquote>



<a name="254344665"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%233322%20AArch64%20LSE%20atomic_rmw%20support/near/254344665" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.233322.20AArch64.20LSE.20atomic_rmw.20support.html#254344665">(Sep 22 2021 at 10:16)</a>:</h4>
<p>sparker-arm <a href="https://github.com/bytecodealliance/wasmtime/pull/3322#issuecomment-924790206">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/3322">issue #3322</a>:</p>
<blockquote>
<p>@cfallin, would you be able to look at this now the QEMU changes have landed?</p>
</blockquote>



<hr><p>Last updated: Jan 20 2025 at 06:04 UTC</p>
</html>