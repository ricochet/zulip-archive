<html>
<head><meta charset="utf-8"><title>wasmtime / PR #1734 Cranelift: Fix FPR saving and shadow ... · git-wasmtime · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/index.html">git-wasmtime</a></h2>
<h3>Topic: <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231734.20Cranelift.3A.20Fix.20FPR.20saving.20and.20shadow.20.2E.2E.2E.html">wasmtime / PR #1734 Cranelift: Fix FPR saving and shadow ...</a></h3>

<hr>

<base href="https://bytecodealliance.zulipchat.com">

<head><link href="https://bytecodealliance.github.io/zulip-archive/style.css" rel="stylesheet"></head>

<a name="198266311"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231734%20Cranelift%3A%20Fix%20FPR%20saving%20and%20shadow%20.../near/198266311" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231734.20Cranelift.3A.20Fix.20FPR.20saving.20and.20shadow.20.2E.2E.2E.html#198266311">(May 20 2020 at 22:39)</a>:</h4>
<p>peterhuene opened <a href="https://github.com/bytecodealliance/wasmtime/pull/1734">PR #1734</a> from <code>fix-saved-fprs</code> to <code>master</code>:</p>
<blockquote>
<p>This PR fixes both how FPR callee-saved registers are saved and how the<br>
shadow space allocation occurs when laying out the stack for Windows x64<br>
calling convention.</p>
<p>Importantly, this PR removes the compiler limitation of stack size for<br>
Windows x64 that was imposed because FPR saves previously couldn't always be<br>
represented in the unwind information.</p>
<p>The FPR saves are now performed without using stack slots, much like how the<br>
callee-saved GPRs are saved. The total CSR space is given to <code>layout_stack</code> so<br>
that it is included in the frame size and to offset the layout of spills and<br>
explicit slots.</p>
<p>The FPR saves are now done via an RSP offset (post adjustment) and they always<br>
follow the GPR saves on the stack. A simpler calculation can now be made to<br>
determine the proper offsets of the FPR saves for representing the unwind<br>
information.</p>
<p>Additionally, the shadow space is no longer treated as an incoming argument,<br>
but an explicit stack slot that gets laid out at the lowest address possible in<br>
the local frame. This prevents <code>layout_stack</code> from putting a spill or explicit<br>
slot in this reserved space. In the future, <code>layout_stack</code> should take<br>
advantage of the <em>caller-provided</em> shadow space for spills, but this PR does<br>
not attempt to address that.</p>
<p>The shadow space is now omitted from the local frame for leaf functions.</p>
<p>Fixes #1728.<br>
Fixes #1587.<br>
Fixes #1475.</p>
</blockquote>



<a name="198266312"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231734%20Cranelift%3A%20Fix%20FPR%20saving%20and%20shadow%20.../near/198266312" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231734.20Cranelift.3A.20Fix.20FPR.20saving.20and.20shadow.20.2E.2E.2E.html#198266312">(May 20 2020 at 22:39)</a>:</h4>
<p><strong>peterhuene</strong> requested <a href="https://github.com/bnjbvr">bnjbvr</a> and <a href="https://github.com/iximeow">iximeow</a> for a review on <a href="https://github.com/bytecodealliance/wasmtime/pull/1734">PR #1734</a>.</p>



<a name="198266313"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231734%20Cranelift%3A%20Fix%20FPR%20saving%20and%20shadow%20.../near/198266313" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231734.20Cranelift.3A.20Fix.20FPR.20saving.20and.20shadow.20.2E.2E.2E.html#198266313">(May 20 2020 at 22:39)</a>:</h4>
<p><strong>peterhuene</strong> requested <a href="https://github.com/bnjbvr">bnjbvr</a> and <a href="https://github.com/iximeow">iximeow</a> for a review on <a href="https://github.com/bytecodealliance/wasmtime/pull/1734">PR #1734</a>.</p>



<a name="198376659"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231734%20Cranelift%3A%20Fix%20FPR%20saving%20and%20shadow%20.../near/198376659" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231734.20Cranelift.3A.20Fix.20FPR.20saving.20and.20shadow.20.2E.2E.2E.html#198376659">(May 21 2020 at 20:58)</a>:</h4>
<p>iximeow submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/1734#pullrequestreview-416466219">PR Review</a>.</p>



<a name="198376660"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231734%20Cranelift%3A%20Fix%20FPR%20saving%20and%20shadow%20.../near/198376660" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231734.20Cranelift.3A.20Fix.20FPR.20saving.20and.20shadow.20.2E.2E.2E.html#198376660">(May 21 2020 at 20:58)</a>:</h4>
<p>iximeow submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/1734#pullrequestreview-416466219">PR Review</a>.</p>



<a name="198376661"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231734%20Cranelift%3A%20Fix%20FPR%20saving%20and%20shadow%20.../near/198376661" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231734.20Cranelift.3A.20Fix.20FPR.20saving.20and.20shadow.20.2E.2E.2E.html#198376661">(May 21 2020 at 20:58)</a>:</h4>
<p>iximeow created <a href="https://github.com/bytecodealliance/wasmtime/pull/1734#discussion_r428894522">PR Review Comment</a>:</p>
<blockquote>
<p>To be correct for cases where <code>isa.pointer_bytes() != 8</code>:</p>
<div class="codehilite"><pre><span></span><code>        csr_stack_size = (csr_stack_size + 15) &amp; !15;
</code></pre></div>


</blockquote>



<a name="198376662"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231734%20Cranelift%3A%20Fix%20FPR%20saving%20and%20shadow%20.../near/198376662" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231734.20Cranelift.3A.20Fix.20FPR.20saving.20and.20shadow.20.2E.2E.2E.html#198376662">(May 21 2020 at 20:58)</a>:</h4>
<p>iximeow created <a href="https://github.com/bytecodealliance/wasmtime/pull/1734#discussion_r428905072">PR Review Comment</a>:</p>
<blockquote>
<p>Being <code>winx64.rs</code>, I think the assumption that a GPR is half the size of an FPR is workable, but do you think that's worth noting in this comment?</p>
</blockquote>



<a name="198376663"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231734%20Cranelift%3A%20Fix%20FPR%20saving%20and%20shadow%20.../near/198376663" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231734.20Cranelift.3A.20Fix.20FPR.20saving.20and.20shadow.20.2E.2E.2E.html#198376663">(May 21 2020 at 20:58)</a>:</h4>
<p>iximeow created <a href="https://github.com/bytecodealliance/wasmtime/pull/1734#discussion_r428895608">PR Review Comment</a>:</p>
<blockquote>
<p>since <code>local_stack_size</code> ought to be 16-byte aligned, shouldn't <code>stack_size &amp; isa.pointer_bytes()</code> always be zero? It seems like we could lift this up to an assert on function entry, if so.</p>
</blockquote>



<a name="198376664"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231734%20Cranelift%3A%20Fix%20FPR%20saving%20and%20shadow%20.../near/198376664" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231734.20Cranelift.3A.20Fix.20FPR.20saving.20and.20shadow.20.2E.2E.2E.html#198376664">(May 21 2020 at 20:58)</a>:</h4>
<p>iximeow created <a href="https://github.com/bytecodealliance/wasmtime/pull/1734#discussion_r428906126">PR Review Comment</a>:</p>
<blockquote>
<p>Any particular reason to check the rest of the function? Seems independent of making sure there's an <code>ss0</code> and that this compiles.</p>
</blockquote>



<a name="198376665"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231734%20Cranelift%3A%20Fix%20FPR%20saving%20and%20shadow%20.../near/198376665" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231734.20Cranelift.3A.20Fix.20FPR.20saving.20and.20shadow.20.2E.2E.2E.html#198376665">(May 21 2020 at 20:58)</a>:</h4>
<p>iximeow created <a href="https://github.com/bytecodealliance/wasmtime/pull/1734#discussion_r428906406">PR Review Comment</a>:</p>
<blockquote>
<p>Likewise, I'm not sure what the checks on this function body are intending to test past the <code>ss0</code> line?</p>
</blockquote>



<a name="198376666"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231734%20Cranelift%3A%20Fix%20FPR%20saving%20and%20shadow%20.../near/198376666" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231734.20Cranelift.3A.20Fix.20FPR.20saving.20and.20shadow.20.2E.2E.2E.html#198376666">(May 21 2020 at 20:58)</a>:</h4>
<p>iximeow created <a href="https://github.com/bytecodealliance/wasmtime/pull/1734#discussion_r428907770">PR Review Comment</a>:</p>
<blockquote>
<p><span aria-label="tada" class="emoji emoji-1f389" role="img" title="tada">:tada:</span> <span aria-label="tada" class="emoji emoji-1f389" role="img" title="tada">:tada:</span> </p>
</blockquote>



<a name="198378184"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231734%20Cranelift%3A%20Fix%20FPR%20saving%20and%20shadow%20.../near/198378184" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231734.20Cranelift.3A.20Fix.20FPR.20saving.20and.20shadow.20.2E.2E.2E.html#198378184">(May 21 2020 at 21:12)</a>:</h4>
<p>peterhuene submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/1734#pullrequestreview-416495925">PR Review</a>.</p>



<a name="198378185"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231734%20Cranelift%3A%20Fix%20FPR%20saving%20and%20shadow%20.../near/198378185" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231734.20Cranelift.3A.20Fix.20FPR.20saving.20and.20shadow.20.2E.2E.2E.html#198378185">(May 21 2020 at 21:12)</a>:</h4>
<p>peterhuene created <a href="https://github.com/bytecodealliance/wasmtime/pull/1734#discussion_r428917298">PR Review Comment</a>:</p>
<blockquote>
<p><code>stack_size</code> (i.e. the adjustment to RSP) is not 16-byte aligned as it might be aligning RSP back to a 16-byte alignment.</p>
<p>Take for instance a prologue in a non-leaf function that pushes the frame pointer and then saves a single GPR.  The push of the frame pointer realigned the stack from the push of return address, but the push of the GPR causes a misalignment.  The local stack allocation will be +0x8 to account for that, which means <code>stack_size</code> itself is not a multiple of 16, but 8.</p>
<p>This lines cause causes the offset to be +0x8 when <code>stack_size</code> itself is +0x8 so that it gets subtracted out from the final offset from the post-adjusted RSP.  The end result is that the offset should always be a multiple of 16 from a post-adjusted 16-byte aligned RSP.</p>
</blockquote>



<a name="198378572"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231734%20Cranelift%3A%20Fix%20FPR%20saving%20and%20shadow%20.../near/198378572" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231734.20Cranelift.3A.20Fix.20FPR.20saving.20and.20shadow.20.2E.2E.2E.html#198378572">(May 21 2020 at 21:16)</a>:</h4>
<p>peterhuene submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/1734#pullrequestreview-416498290">PR Review</a>.</p>



<a name="198378573"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231734%20Cranelift%3A%20Fix%20FPR%20saving%20and%20shadow%20.../near/198378573" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231734.20Cranelift.3A.20Fix.20FPR.20saving.20and.20shadow.20.2E.2E.2E.html#198378573">(May 21 2020 at 21:16)</a>:</h4>
<p>peterhuene created <a href="https://github.com/bytecodealliance/wasmtime/pull/1734#discussion_r428919079">PR Review Comment</a>:</p>
<blockquote>
<p>That said, I'm totally open to calculating this in a clearer way if you have any suggestions!</p>
</blockquote>



<a name="198378666"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231734%20Cranelift%3A%20Fix%20FPR%20saving%20and%20shadow%20.../near/198378666" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231734.20Cranelift.3A.20Fix.20FPR.20saving.20and.20shadow.20.2E.2E.2E.html#198378666">(May 21 2020 at 21:17)</a>:</h4>
<p>peterhuene submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/1734#pullrequestreview-416498948">PR Review</a>.</p>



<a name="198378667"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231734%20Cranelift%3A%20Fix%20FPR%20saving%20and%20shadow%20.../near/198378667" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231734.20Cranelift.3A.20Fix.20FPR.20saving.20and.20shadow.20.2E.2E.2E.html#198378667">(May 21 2020 at 21:17)</a>:</h4>
<p>peterhuene created <a href="https://github.com/bytecodealliance/wasmtime/pull/1734#discussion_r428919565">PR Review Comment</a>:</p>
<blockquote>
<p>I think that's clearer and congruent with other places where we round up for alignment.  I'll change.</p>
</blockquote>



<a name="198378835"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231734%20Cranelift%3A%20Fix%20FPR%20saving%20and%20shadow%20.../near/198378835" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231734.20Cranelift.3A.20Fix.20FPR.20saving.20and.20shadow.20.2E.2E.2E.html#198378835">(May 21 2020 at 21:19)</a>:</h4>
<p>peterhuene submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/1734#pullrequestreview-416499895">PR Review</a>.</p>



<a name="198378836"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231734%20Cranelift%3A%20Fix%20FPR%20saving%20and%20shadow%20.../near/198378836" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231734.20Cranelift.3A.20Fix.20FPR.20saving.20and.20shadow.20.2E.2E.2E.html#198378836">(May 21 2020 at 21:19)</a>:</h4>
<p>peterhuene created <a href="https://github.com/bytecodealliance/wasmtime/pull/1734#discussion_r428920326">PR Review Comment</a>:</p>
<blockquote>
<p>I can add a comment.</p>
</blockquote>



<a name="198379086"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231734%20Cranelift%3A%20Fix%20FPR%20saving%20and%20shadow%20.../near/198379086" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231734.20Cranelift.3A.20Fix.20FPR.20saving.20and.20shadow.20.2E.2E.2E.html#198379086">(May 21 2020 at 21:21)</a>:</h4>
<p>peterhuene submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/1734#pullrequestreview-416501424">PR Review</a>.</p>



<a name="198379087"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231734%20Cranelift%3A%20Fix%20FPR%20saving%20and%20shadow%20.../near/198379087" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231734.20Cranelift.3A.20Fix.20FPR.20saving.20and.20shadow.20.2E.2E.2E.html#198379087">(May 21 2020 at 21:21)</a>:</h4>
<p>peterhuene created <a href="https://github.com/bytecodealliance/wasmtime/pull/1734#discussion_r428921586">PR Review Comment</a>:</p>
<blockquote>
<p>I wanted to check the prologues and epilogues for correctness in each function.  The intermediate instructions I'm not as concerned about, although I personally don't mind them being checked unless we think there's a likelihood that this will cause a maintenance headache for these tests.</p>
</blockquote>



<a name="198379195"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231734%20Cranelift%3A%20Fix%20FPR%20saving%20and%20shadow%20.../near/198379195" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231734.20Cranelift.3A.20Fix.20FPR.20saving.20and.20shadow.20.2E.2E.2E.html#198379195">(May 21 2020 at 21:22)</a>:</h4>
<p>peterhuene submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/1734#pullrequestreview-416501975">PR Review</a>.</p>



<a name="198379196"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231734%20Cranelift%3A%20Fix%20FPR%20saving%20and%20shadow%20.../near/198379196" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231734.20Cranelift.3A.20Fix.20FPR.20saving.20and.20shadow.20.2E.2E.2E.html#198379196">(May 21 2020 at 21:22)</a>:</h4>
<p>peterhuene created <a href="https://github.com/bytecodealliance/wasmtime/pull/1734#discussion_r428922007">PR Review Comment</a>:</p>
<blockquote>
<p>See reply above.  Do you think it would be best if we simply limited it to just the stack layout and prologue/epilogue instructions?</p>
</blockquote>



<a name="198379223"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231734%20Cranelift%3A%20Fix%20FPR%20saving%20and%20shadow%20.../near/198379223" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231734.20Cranelift.3A.20Fix.20FPR.20saving.20and.20shadow.20.2E.2E.2E.html#198379223">(May 21 2020 at 21:22)</a>:</h4>
<p>peterhuene submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/1734#pullrequestreview-416502254">PR Review</a>.</p>



<a name="198379225"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231734%20Cranelift%3A%20Fix%20FPR%20saving%20and%20shadow%20.../near/198379225" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231734.20Cranelift.3A.20Fix.20FPR.20saving.20and.20shadow.20.2E.2E.2E.html#198379225">(May 21 2020 at 21:22)</a>:</h4>
<p>peterhuene created <a href="https://github.com/bytecodealliance/wasmtime/pull/1734#discussion_r428922228">PR Review Comment</a>:</p>
<blockquote>
<p>It turns out asserting things in tests is good <span aria-label="smile" class="emoji emoji-263a" role="img" title="smile">:smile:</span>.</p>
</blockquote>



<a name="198379353"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231734%20Cranelift%3A%20Fix%20FPR%20saving%20and%20shadow%20.../near/198379353" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231734.20Cranelift.3A.20Fix.20FPR.20saving.20and.20shadow.20.2E.2E.2E.html#198379353">(May 21 2020 at 21:24)</a>:</h4>
<p>peterhuene edited <a href="https://github.com/bytecodealliance/wasmtime/pull/1734#discussion_r428917298">PR Review Comment</a>.</p>



<a name="198380916"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231734%20Cranelift%3A%20Fix%20FPR%20saving%20and%20shadow%20.../near/198380916" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231734.20Cranelift.3A.20Fix.20FPR.20saving.20and.20shadow.20.2E.2E.2E.html#198380916">(May 21 2020 at 21:42)</a>:</h4>
<p>iximeow submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/1734#pullrequestreview-416513860">PR Review</a>.</p>



<a name="198380917"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231734%20Cranelift%3A%20Fix%20FPR%20saving%20and%20shadow%20.../near/198380917" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231734.20Cranelift.3A.20Fix.20FPR.20saving.20and.20shadow.20.2E.2E.2E.html#198380917">(May 21 2020 at 21:42)</a>:</h4>
<p>iximeow created <a href="https://github.com/bytecodealliance/wasmtime/pull/1734#discussion_r428932310">PR Review Comment</a>:</p>
<blockquote>
<p>That example helps, thanks. How's <code>% types::F64X2.bytes()</code> instead of <code>&amp; isa.pointer_bytes()</code> sound to you? That picks an aligned offset for the type to store, ought to work for <code>isa.pointer_bytes() == 4</code>, and makes extension for ymm preservation (if we get to that in the future) clearer (they don't _need_ 32-byte alignment, but iiuc are somewhat penalized for misaligned access)</p>
</blockquote>



<a name="198381241"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231734%20Cranelift%3A%20Fix%20FPR%20saving%20and%20shadow%20.../near/198381241" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231734.20Cranelift.3A.20Fix.20FPR.20saving.20and.20shadow.20.2E.2E.2E.html#198381241">(May 21 2020 at 21:45)</a>:</h4>
<p>iximeow submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/1734#pullrequestreview-416515374">PR Review</a>.</p>



<a name="198381243"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231734%20Cranelift%3A%20Fix%20FPR%20saving%20and%20shadow%20.../near/198381243" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231734.20Cranelift.3A.20Fix.20FPR.20saving.20and.20shadow.20.2E.2E.2E.html#198381243">(May 21 2020 at 21:45)</a>:</h4>
<p>iximeow created <a href="https://github.com/bytecodealliance/wasmtime/pull/1734#discussion_r428933498">PR Review Comment</a>:</p>
<blockquote>
<p>Yeah I'm just thinking of maintenance for these. But I've convinced myself it's actually good to extend these checks here: I don't think we explicitly tested fastcall gpr preservation works as expected anywhere, and these aren't really liable to change in a surprising way.</p>
</blockquote>



<a name="198381268"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231734%20Cranelift%3A%20Fix%20FPR%20saving%20and%20shadow%20.../near/198381268" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231734.20Cranelift.3A.20Fix.20FPR.20saving.20and.20shadow.20.2E.2E.2E.html#198381268">(May 21 2020 at 21:45)</a>:</h4>
<p>iximeow submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/1734#pullrequestreview-416515526">PR Review</a>.</p>



<a name="198381269"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231734%20Cranelift%3A%20Fix%20FPR%20saving%20and%20shadow%20.../near/198381269" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231734.20Cranelift.3A.20Fix.20FPR.20saving.20and.20shadow.20.2E.2E.2E.html#198381269">(May 21 2020 at 21:45)</a>:</h4>
<p>iximeow created <a href="https://github.com/bytecodealliance/wasmtime/pull/1734#discussion_r428933643">PR Review Comment</a>:</p>
<blockquote>
<p>(as above, now convinced that these are Good Actually)</p>
</blockquote>



<a name="198385696"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231734%20Cranelift%3A%20Fix%20FPR%20saving%20and%20shadow%20.../near/198385696" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231734.20Cranelift.3A.20Fix.20FPR.20saving.20and.20shadow.20.2E.2E.2E.html#198385696">(May 21 2020 at 22:31)</a>:</h4>
<p>peterhuene edited <a href="https://github.com/bytecodealliance/wasmtime/pull/1734#discussion_r428917298">PR Review Comment</a>.</p>



<a name="198385710"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231734%20Cranelift%3A%20Fix%20FPR%20saving%20and%20shadow%20.../near/198385710" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231734.20Cranelift.3A.20Fix.20FPR.20saving.20and.20shadow.20.2E.2E.2E.html#198385710">(May 21 2020 at 22:31)</a>:</h4>
<p>peterhuene edited <a href="https://github.com/bytecodealliance/wasmtime/pull/1734#discussion_r428917298">PR Review Comment</a>.</p>



<a name="198385976"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231734%20Cranelift%3A%20Fix%20FPR%20saving%20and%20shadow%20.../near/198385976" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231734.20Cranelift.3A.20Fix.20FPR.20saving.20and.20shadow.20.2E.2E.2E.html#198385976">(May 21 2020 at 22:33)</a>:</h4>
<p>peterhuene submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/1734#pullrequestreview-416537771">PR Review</a>.</p>



<a name="198385977"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231734%20Cranelift%3A%20Fix%20FPR%20saving%20and%20shadow%20.../near/198385977" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231734.20Cranelift.3A.20Fix.20FPR.20saving.20and.20shadow.20.2E.2E.2E.html#198385977">(May 21 2020 at 22:33)</a>:</h4>
<p>peterhuene created <a href="https://github.com/bytecodealliance/wasmtime/pull/1734#discussion_r428951459">PR Review Comment</a>:</p>
<blockquote>
<p>Works for me.  I'll get that changed!</p>
</blockquote>



<a name="198388232"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231734%20Cranelift%3A%20Fix%20FPR%20saving%20and%20shadow%20.../near/198388232" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231734.20Cranelift.3A.20Fix.20FPR.20saving.20and.20shadow.20.2E.2E.2E.html#198388232">(May 21 2020 at 22:55)</a>:</h4>
<p>peterhuene updated <a href="https://github.com/bytecodealliance/wasmtime/pull/1734">PR #1734</a> from <code>fix-saved-fprs</code> to <code>master</code>:</p>
<blockquote>
<p>This PR fixes both how FPR callee-saved registers are saved and how the<br>
shadow space allocation occurs when laying out the stack for Windows x64<br>
calling convention.</p>
<p>Importantly, this PR removes the compiler limitation of stack size for<br>
Windows x64 that was imposed because FPR saves previously couldn't always be<br>
represented in the unwind information.</p>
<p>The FPR saves are now performed without using stack slots, much like how the<br>
callee-saved GPRs are saved. The total CSR space is given to <code>layout_stack</code> so<br>
that it is included in the frame size and to offset the layout of spills and<br>
explicit slots.</p>
<p>The FPR saves are now done via an RSP offset (post adjustment) and they always<br>
follow the GPR saves on the stack. A simpler calculation can now be made to<br>
determine the proper offsets of the FPR saves for representing the unwind<br>
information.</p>
<p>Additionally, the shadow space is no longer treated as an incoming argument,<br>
but an explicit stack slot that gets laid out at the lowest address possible in<br>
the local frame. This prevents <code>layout_stack</code> from putting a spill or explicit<br>
slot in this reserved space. In the future, <code>layout_stack</code> should take<br>
advantage of the <em>caller-provided</em> shadow space for spills, but this PR does<br>
not attempt to address that.</p>
<p>The shadow space is now omitted from the local frame for leaf functions.</p>
<p>Fixes #1728.<br>
Fixes #1587.<br>
Fixes #1475.</p>
</blockquote>



<a name="198388410"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231734%20Cranelift%3A%20Fix%20FPR%20saving%20and%20shadow%20.../near/198388410" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231734.20Cranelift.3A.20Fix.20FPR.20saving.20and.20shadow.20.2E.2E.2E.html#198388410">(May 21 2020 at 22:57)</a>:</h4>
<p>peterhuene updated <a href="https://github.com/bytecodealliance/wasmtime/pull/1734">PR #1734</a> from <code>fix-saved-fprs</code> to <code>master</code>:</p>
<blockquote>
<p>This PR fixes both how FPR callee-saved registers are saved and how the<br>
shadow space allocation occurs when laying out the stack for Windows x64<br>
calling convention.</p>
<p>Importantly, this PR removes the compiler limitation of stack size for<br>
Windows x64 that was imposed because FPR saves previously couldn't always be<br>
represented in the unwind information.</p>
<p>The FPR saves are now performed without using stack slots, much like how the<br>
callee-saved GPRs are saved. The total CSR space is given to <code>layout_stack</code> so<br>
that it is included in the frame size and to offset the layout of spills and<br>
explicit slots.</p>
<p>The FPR saves are now done via an RSP offset (post adjustment) and they always<br>
follow the GPR saves on the stack. A simpler calculation can now be made to<br>
determine the proper offsets of the FPR saves for representing the unwind<br>
information.</p>
<p>Additionally, the shadow space is no longer treated as an incoming argument,<br>
but an explicit stack slot that gets laid out at the lowest address possible in<br>
the local frame. This prevents <code>layout_stack</code> from putting a spill or explicit<br>
slot in this reserved space. In the future, <code>layout_stack</code> should take<br>
advantage of the <em>caller-provided</em> shadow space for spills, but this PR does<br>
not attempt to address that.</p>
<p>The shadow space is now omitted from the local frame for leaf functions.</p>
<p>Fixes #1728.<br>
Fixes #1587.<br>
Fixes #1475.</p>
</blockquote>



<a name="198389222"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231734%20Cranelift%3A%20Fix%20FPR%20saving%20and%20shadow%20.../near/198389222" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231734.20Cranelift.3A.20Fix.20FPR.20saving.20and.20shadow.20.2E.2E.2E.html#198389222">(May 21 2020 at 23:05)</a>:</h4>
<p>iximeow submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/1734#pullrequestreview-416550120">PR Review</a>.</p>



<a name="198391354"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231734%20Cranelift%3A%20Fix%20FPR%20saving%20and%20shadow%20.../near/198391354" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231734.20Cranelift.3A.20Fix.20FPR.20saving.20and.20shadow.20.2E.2E.2E.html#198391354">(May 21 2020 at 23:30)</a>:</h4>
<p>peterhuene submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/1734#pullrequestreview-416558365">PR Review</a>.</p>



<a name="198391355"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231734%20Cranelift%3A%20Fix%20FPR%20saving%20and%20shadow%20.../near/198391355" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231734.20Cranelift.3A.20Fix.20FPR.20saving.20and.20shadow.20.2E.2E.2E.html#198391355">(May 21 2020 at 23:30)</a>:</h4>
<p>peterhuene created <a href="https://github.com/bytecodealliance/wasmtime/pull/1734#discussion_r428968150">PR Review Comment</a>:</p>
<blockquote>
<p>This should actually check if a frame pointer is being used, even though we currently always use one.</p>
<p>If a frame pointer is not used, then the offsets for the FPRs saves should not be altered as they already have the correct offset from RSP.</p>
<p>I'll quickly fix this.</p>
</blockquote>



<a name="198392444"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231734%20Cranelift%3A%20Fix%20FPR%20saving%20and%20shadow%20.../near/198392444" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231734.20Cranelift.3A.20Fix.20FPR.20saving.20and.20shadow.20.2E.2E.2E.html#198392444">(May 21 2020 at 23:48)</a>:</h4>
<p>peterhuene updated <a href="https://github.com/bytecodealliance/wasmtime/pull/1734">PR #1734</a> from <code>fix-saved-fprs</code> to <code>master</code>:</p>
<blockquote>
<p>This PR fixes both how FPR callee-saved registers are saved and how the<br>
shadow space allocation occurs when laying out the stack for Windows x64<br>
calling convention.</p>
<p>Importantly, this PR removes the compiler limitation of stack size for<br>
Windows x64 that was imposed because FPR saves previously couldn't always be<br>
represented in the unwind information.</p>
<p>The FPR saves are now performed without using stack slots, much like how the<br>
callee-saved GPRs are saved. The total CSR space is given to <code>layout_stack</code> so<br>
that it is included in the frame size and to offset the layout of spills and<br>
explicit slots.</p>
<p>The FPR saves are now done via an RSP offset (post adjustment) and they always<br>
follow the GPR saves on the stack. A simpler calculation can now be made to<br>
determine the proper offsets of the FPR saves for representing the unwind<br>
information.</p>
<p>Additionally, the shadow space is no longer treated as an incoming argument,<br>
but an explicit stack slot that gets laid out at the lowest address possible in<br>
the local frame. This prevents <code>layout_stack</code> from putting a spill or explicit<br>
slot in this reserved space. In the future, <code>layout_stack</code> should take<br>
advantage of the <em>caller-provided</em> shadow space for spills, but this PR does<br>
not attempt to address that.</p>
<p>The shadow space is now omitted from the local frame for leaf functions.</p>
<p>Fixes #1728.<br>
Fixes #1587.<br>
Fixes #1475.</p>
</blockquote>



<a name="198482117"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231734%20Cranelift%3A%20Fix%20FPR%20saving%20and%20shadow%20.../near/198482117" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231734.20Cranelift.3A.20Fix.20FPR.20saving.20and.20shadow.20.2E.2E.2E.html#198482117">(May 22 2020 at 19:06)</a>:</h4>
<p>peterhuene merged <a href="https://github.com/bytecodealliance/wasmtime/pull/1734">PR #1734</a>.</p>



<hr><p>Last updated: Jan 20 2025 at 06:04 UTC</p>
</html>