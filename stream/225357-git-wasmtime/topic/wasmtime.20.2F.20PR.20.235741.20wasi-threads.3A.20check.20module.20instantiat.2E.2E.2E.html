<html>
<head><meta charset="utf-8"><title>wasmtime / PR #5741 wasi-threads: check module instantiat... · git-wasmtime · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/index.html">git-wasmtime</a></h2>
<h3>Topic: <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.235741.20wasi-threads.3A.20check.20module.20instantiat.2E.2E.2E.html">wasmtime / PR #5741 wasi-threads: check module instantiat...</a></h3>

<hr>

<base href="https://bytecodealliance.zulipchat.com">

<head><link href="https://bytecodealliance.github.io/zulip-archive/style.css" rel="stylesheet"></head>

<a name="326467668"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%235741%20wasi-threads%3A%20check%20module%20instantiat.../near/326467668" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.235741.20wasi-threads.3A.20check.20module.20instantiat.2E.2E.2E.html#326467668">(Feb 07 2023 at 22:08)</a>:</h4>
<p>abrown opened <a href="https://github.com/bytecodealliance/wasmtime/pull/5741">PR #5741</a> from <code>use-5675</code> to <code>main</code>:</p>
<blockquote>
<p>Due to #5675, we could not perform an early check whether the module passed to <code>wasi-threads</code> could indeed be instantiated. Now that that issue is resolved, this change performs the instantiation check (via <code>Linker::instantiate_pre</code>) during construction.</p>
<p>&lt;!--</p>
<p>Please ensure that the following steps are all taken care of before submitting<br>
the PR.</p>
<ul>
<li>
<p>[ ] This has been discussed in issue #..., or if not, please tell us why<br>
  here.</p>
</li>
<li>
<p>[ ] A short description of what this does, why it is needed; if the<br>
  description becomes long, the matter should probably be discussed in an issue<br>
  first.</p>
</li>
<li>
<p>[ ] This PR contains test cases, if meaningful.</p>
</li>
<li>[ ] A reviewer from the core maintainer team has been assigned for this PR.<br>
  If you don't know who could review this, please indicate so. The list of<br>
  suggested reviewers on the right can help you.</li>
</ul>
<p>Please ensure all communication adheres to the <a href="https://github.com/bytecodealliance/wasmtime/blob/master/CODE_OF_CONDUCT.md">code of
conduct</a>.<br>
--&gt;<br>
</p>
</blockquote>



<a name="326467735"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%235741%20wasi-threads%3A%20check%20module%20instantiat.../near/326467735" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.235741.20wasi-threads.3A.20check.20module.20instantiat.2E.2E.2E.html#326467735">(Feb 07 2023 at 22:09)</a>:</h4>
<p><strong>abrown</strong> requested <a href="https://github.com/alexcrichton">alexcrichton</a> for a review on <a href="https://github.com/bytecodealliance/wasmtime/pull/5741">PR #5741</a>.</p>



<a name="326471448"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%235741%20wasi-threads%3A%20check%20module%20instantiat.../near/326471448" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.235741.20wasi-threads.3A.20check.20module.20instantiat.2E.2E.2E.html#326471448">(Feb 07 2023 at 22:35)</a>:</h4>
<p>alexcrichton submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/5741#pullrequestreview-1288106174">PR review</a>.</p>



<a name="326471449"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%235741%20wasi-threads%3A%20check%20module%20instantiat.../near/326471449" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.235741.20wasi-threads.3A.20check.20module.20instantiat.2E.2E.2E.html#326471449">(Feb 07 2023 at 22:35)</a>:</h4>
<p>alexcrichton submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/5741#pullrequestreview-1288106174">PR review</a>.</p>



<a name="326471450"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%235741%20wasi-threads%3A%20check%20module%20instantiat.../near/326471450" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.235741.20wasi-threads.3A.20check.20module.20instantiat.2E.2E.2E.html#326471450">(Feb 07 2023 at 22:35)</a>:</h4>
<p>alexcrichton created <a href="https://github.com/bytecodealliance/wasmtime/pull/5741#discussion_r1099349503">PR review comment</a>:</p>
<blockquote>
<p>Thinking about this again, this is fine for now but I think this is still something that the wasi-threads proposal needs to happen. Basically the fallibility of spawning a thread I don't think is handled well. For example the OS could fail to spawn a thread, an embedder may want to limit threads, allocating resources for an <code>Instance</code> may fail (e.g. local linear memories if any). There's a lot of failure modes beyond "the imports didn't line up" so it's possible to trigger this <code>unwrap()</code> I think (although hard for the "CLI world").</p>
<p>Basically I think that the wasi-threads proposal needs a way for an embedder to communicate a thread spawn failure and I think that the failure here needs to be communicated back somehow. That has its own set of thorny questions though because how "blocking" is the thread-spawn intrinsic? E.g. we ideally don't want to instantiate the instance on the caller thread ,but in the child thread like this. That means though that failure would be delayed since the thread may not start for a bit. Anyway I'm rambling now. Fine for now, but I think needs more work on the proposal.</p>
</blockquote>



<a name="326471452"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%235741%20wasi-threads%3A%20check%20module%20instantiat.../near/326471452" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.235741.20wasi-threads.3A.20check.20module.20instantiat.2E.2E.2E.html#326471452">(Feb 07 2023 at 22:35)</a>:</h4>
<p>alexcrichton created <a href="https://github.com/bytecodealliance/wasmtime/pull/5741#discussion_r1099346638">PR review comment</a>:</p>
<blockquote>
<p>Thinking about this again, the <code>WasiThreadsCtx</code> could actually store <code>InstancePre&lt;T&gt;</code> and use that to instantiate as there's no need to recreate it each time a thread is spawned.</p>
<p>Could <code>::new</code> be refactored to either:</p>
<ul>
<li>Take a <code>&amp;Module</code> and <code>&amp;Linker&lt;T&gt;</code> and persist <code>Arc&lt;InstancePre&lt;T&gt;&gt;</code> within <code>WasiThreadsCtx</code></li>
<li>Or take a <code>InstancePre&lt;T&gt;</code> directly and store an <code>Arc</code> internally in the context</li>
</ul>
</blockquote>



<a name="326474665"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%235741%20wasi-threads%3A%20check%20module%20instantiat.../near/326474665" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.235741.20wasi-threads.3A.20check.20module.20instantiat.2E.2E.2E.html#326474665">(Feb 07 2023 at 23:00)</a>:</h4>
<p>abrown submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/5741#pullrequestreview-1288131170">PR review</a>.</p>



<a name="326474666"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%235741%20wasi-threads%3A%20check%20module%20instantiat.../near/326474666" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.235741.20wasi-threads.3A.20check.20module.20instantiat.2E.2E.2E.html#326474666">(Feb 07 2023 at 23:00)</a>:</h4>
<p>abrown created <a href="https://github.com/bytecodealliance/wasmtime/pull/5741#discussion_r1099375812">PR review comment</a>:</p>
<blockquote>
<p>Yeah, this is a good point. This error should be communicated back to the WebAssembly guest; it isn't always a runtime failure. The <code>wasi-threads</code> proposal currently designates negative numbers as error codes so I think what could be done here is specify some of that range to match some of the possible reasons for failure here. How can I get the full list of possible errors that could be unwrapped here?</p>
</blockquote>



<a name="326608862"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%235741%20wasi-threads%3A%20check%20module%20instantiat.../near/326608862" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.235741.20wasi-threads.3A.20check.20module.20instantiat.2E.2E.2E.html#326608862">(Feb 08 2023 at 14:57)</a>:</h4>
<p>alexcrichton submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/5741#pullrequestreview-1289350048">PR review</a>.</p>



<a name="326608864"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%235741%20wasi-threads%3A%20check%20module%20instantiat.../near/326608864" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.235741.20wasi-threads.3A.20check.20module.20instantiat.2E.2E.2E.html#326608864">(Feb 08 2023 at 14:57)</a>:</h4>
<p>alexcrichton created <a href="https://github.com/bytecodealliance/wasmtime/pull/5741#discussion_r1100252580">PR review comment</a>:</p>
<blockquote>
<p>I am not aware of an exhaustive list of errors, but some examples I can think of are:</p>
<ul>
<li>The OS thread failed to spawn for an OS-defined reason (e.g. not enough kernel memory, not enough user memory, kernel is limiting threads, etc)</li>
<li>An embedder-configured limit prevented a thread from being spawned (e.g. your store gets at most 5 threads)</li>
<li>Module instantiation on the new thread failed (e.g. not enough memory, some store configuration limited growth of table/memory, not enough virtual memory for a second non-shared linear memory, etc)</li>
<li>Module instantiation could fail due to a trap in the <code>start</code> function</li>
</ul>
<p>And that's sort of just a subset of what could happen. Not necessarily all of those should be communicated through an error code perhaps. For example maybe failure to instantiate is considered a fatal error that aborts all threads, but perhaps failure to spawn a thread at the OS level is communicated back to the thread-spawn caller. </p>
<p>In any case, though, I think the upstream proposal should have a rough set of guidelines for what to do in these failure situations and how embedders communicate this to wasm.</p>
</blockquote>



<hr><p>Last updated: Jan 20 2025 at 06:04 UTC</p>
</html>