<html>
<head><meta charset="utf-8"><title>wasmtime / PR #7947 winch: Move the stack overflow check ... · git-wasmtime · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/index.html">git-wasmtime</a></h2>
<h3>Topic: <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.237947.20winch.3A.20Move.20the.20stack.20overflow.20check.20.2E.2E.2E.html">wasmtime / PR #7947 winch: Move the stack overflow check ...</a></h3>

<hr>

<base href="https://bytecodealliance.zulipchat.com">

<head><link href="https://bytecodealliance.github.io/zulip-archive/style.css" rel="stylesheet"></head>

<a name="421733737"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%237947%20winch%3A%20Move%20the%20stack%20overflow%20check%20.../near/421733737" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.237947.20winch.3A.20Move.20the.20stack.20overflow.20check.20.2E.2E.2E.html#421733737">(Feb 15 2024 at 20:19)</a>:</h4>
<p><strong>elliottt</strong> requested <a href="https://github.com/orgs/bytecodealliance/teams/wasmtime-compiler-reviewers">wasmtime-compiler-reviewers</a> for a review on <a href="https://github.com/bytecodealliance/wasmtime/pull/7947">PR #7947</a>.</p>



<a name="421733738"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%237947%20winch%3A%20Move%20the%20stack%20overflow%20check%20.../near/421733738" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.237947.20winch.3A.20Move.20the.20stack.20overflow.20check.20.2E.2E.2E.html#421733738">(Feb 15 2024 at 20:19)</a>:</h4>
<p>elliottt opened <a href="https://github.com/bytecodealliance/wasmtime/pull/7947">PR #7947</a> from <code>elliottt:trevor/winch-stack-check-in-prologue</code> to <code>bytecodealliance:main</code>:</p>
<blockquote>
<p>Move the stack check to the function prologue in winch generated code by adding the final stack maximum to the stack min bound before comparing against the current SP.</p>
<p>This new approach is more accurate than the previous implementation that would only check the size of <code>locals</code>, but does require that we patch the function during <code>MacroAssembler::finalize</code>, as we don't know the stack high water mark until then. Enabling the patching required the addition of the <code>start_patchable</code>/<code>end_patchable</code> api to <code>MachBuffer</code>, which gives a way to name sections of the code buffer (with some restrictions) that can be edited later. We use this then to modify an add-with-immediate instruction to add the used stack space to the lower bound, when finalizing the function.</p>
<p>&lt;!--<br>
Please make sure you include the following information:</p>
<ul>
<li>
<p>If this work has been discussed elsewhere, please include a link to that<br>
  conversation. If it was discussed in an issue, just mention "issue #...".</p>
</li>
<li>
<p>Explain why this change is needed. If the details are in an issue already,<br>
  this can be brief.</p>
</li>
</ul>
<p>Our development process is documented in the Wasmtime book:<br>
<a href="https://docs.wasmtime.dev/contributing-development-process.html">https://docs.wasmtime.dev/contributing-development-process.html</a></p>
<p>Please ensure all communication follows the code of conduct:<br>
<a href="https://github.com/bytecodealliance/wasmtime/blob/main/CODE_OF_CONDUCT.md">https://github.com/bytecodealliance/wasmtime/blob/main/CODE_OF_CONDUCT.md</a><br>
--&gt;</p>
</blockquote>



<a name="421733740"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%237947%20winch%3A%20Move%20the%20stack%20overflow%20check%20.../near/421733740" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.237947.20winch.3A.20Move.20the.20stack.20overflow.20check.20.2E.2E.2E.html#421733740">(Feb 15 2024 at 20:19)</a>:</h4>
<p><strong>elliottt</strong> requested <a href="https://github.com/cfallin">cfallin</a> for a review on <a href="https://github.com/bytecodealliance/wasmtime/pull/7947">PR #7947</a>.</p>



<a name="421733856"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%237947%20winch%3A%20Move%20the%20stack%20overflow%20check%20.../near/421733856" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.237947.20winch.3A.20Move.20the.20stack.20overflow.20check.20.2E.2E.2E.html#421733856">(Feb 15 2024 at 20:20)</a>:</h4>
<p><strong>elliottt</strong> requested <a href="https://github.com/saulecabrera">saulecabrera</a> for a review on <a href="https://github.com/bytecodealliance/wasmtime/pull/7947">PR #7947</a>.</p>



<a name="421734462"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%237947%20winch%3A%20Move%20the%20stack%20overflow%20check%20.../near/421734462" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.237947.20winch.3A.20Move.20the.20stack.20overflow.20check.20.2E.2E.2E.html#421734462">(Feb 15 2024 at 20:24)</a>:</h4>
<p>elliottt updated <a href="https://github.com/bytecodealliance/wasmtime/pull/7947">PR #7947</a>.</p>



<a name="421734567"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%237947%20winch%3A%20Move%20the%20stack%20overflow%20check%20.../near/421734567" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.237947.20winch.3A.20Move.20the.20stack.20overflow.20check.20.2E.2E.2E.html#421734567">(Feb 15 2024 at 20:25)</a>:</h4>
<p>elliottt edited <a href="https://github.com/bytecodealliance/wasmtime/pull/7947">PR #7947</a>:</p>
<blockquote>
<p>Move the stack check to the function prologue in winch generated code by adding the final stack maximum to the stack min bound before comparing against the current SP.</p>
<p>This new approach is more accurate than the previous implementation that would only check the size of <code>locals</code>, but does require that we patch the function during <code>MacroAssembler::finalize</code>, as we don't know the stack high water mark until then. Enabling the patching required the addition of the <code>start_patchable</code>/<code>end_patchable</code> api to <code>MachBuffer</code>, which gives a way to name sections of the code buffer (with some restrictions) that can be edited later. We use this then to modify an add-with-immediate instruction to add the used stack space to the stack lower bound from <code>vmctx</code>, when finalizing the function.</p>
<p>&lt;!--<br>
Please make sure you include the following information:</p>
<ul>
<li>
<p>If this work has been discussed elsewhere, please include a link to that<br>
  conversation. If it was discussed in an issue, just mention "issue #...".</p>
</li>
<li>
<p>Explain why this change is needed. If the details are in an issue already,<br>
  this can be brief.</p>
</li>
</ul>
<p>Our development process is documented in the Wasmtime book:<br>
<a href="https://docs.wasmtime.dev/contributing-development-process.html">https://docs.wasmtime.dev/contributing-development-process.html</a></p>
<p>Please ensure all communication follows the code of conduct:<br>
<a href="https://github.com/bytecodealliance/wasmtime/blob/main/CODE_OF_CONDUCT.md">https://github.com/bytecodealliance/wasmtime/blob/main/CODE_OF_CONDUCT.md</a><br>
--&gt;</p>
</blockquote>



<a name="421739131"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%237947%20winch%3A%20Move%20the%20stack%20overflow%20check%20.../near/421739131" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.237947.20winch.3A.20Move.20the.20stack.20overflow.20check.20.2E.2E.2E.html#421739131">(Feb 15 2024 at 20:56)</a>:</h4>
<p>cfallin submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/7947#pullrequestreview-1883846247">PR review</a>:</p>
<blockquote>
<p>Overall approach seems fine; some thoughts on the x64 machine-code patching specifically:</p>
</blockquote>



<a name="421739133"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%237947%20winch%3A%20Move%20the%20stack%20overflow%20check%20.../near/421739133" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.237947.20winch.3A.20Move.20the.20stack.20overflow.20check.20.2E.2E.2E.html#421739133">(Feb 15 2024 at 20:56)</a>:</h4>
<p>cfallin submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/7947#pullrequestreview-1883846247">PR review</a>:</p>
<blockquote>
<p>Overall approach seems fine; some thoughts on the x64 machine-code patching specifically:</p>
</blockquote>



<a name="421739134"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%237947%20winch%3A%20Move%20the%20stack%20overflow%20check%20.../near/421739134" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.237947.20winch.3A.20Move.20the.20stack.20overflow.20check.20.2E.2E.2E.html#421739134">(Feb 15 2024 at 20:56)</a>:</h4>
<p>cfallin created <a href="https://github.com/bytecodealliance/wasmtime/pull/7947#discussion_r1491649116">PR review comment</a>:</p>
<blockquote>
<p>Can we add a bit more doc here? "Represents an editable region that is currently being emitted in the <code>MachBuffer</code>. When closed, this becomes a <code>PatchRegion</code> and allows editing the machine code post-emission." or something like that?</p>
</blockquote>



<a name="421739135"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%237947%20winch%3A%20Move%20the%20stack%20overflow%20check%20.../near/421739135" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.237947.20winch.3A.20Move.20the.20stack.20overflow.20check.20.2E.2E.2E.html#421739135">(Feb 15 2024 at 20:56)</a>:</h4>
<p>cfallin created <a href="https://github.com/bytecodealliance/wasmtime/pull/7947#discussion_r1491649410">PR review comment</a>:</p>
<blockquote>
<p>Likewise here; note what it's for.</p>
</blockquote>



<a name="421739136"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%237947%20winch%3A%20Move%20the%20stack%20overflow%20check%20.../near/421739136" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.237947.20winch.3A.20Move.20the.20stack.20overflow.20check.20.2E.2E.2E.html#421739136">(Feb 15 2024 at 20:56)</a>:</h4>
<p>cfallin created <a href="https://github.com/bytecodealliance/wasmtime/pull/7947#discussion_r1491657994">PR review comment</a>:</p>
<blockquote>
<p>This and the asserts on opcode bytes below feel a little fragile. For example if we change the way immediates are emitted in the future, this might break (we're tying masm's lowering strategy to a specific assumption about its output here). Also the REX byte is pinned by an assert, and might change if the regalloc picks a register in the other half of the 16-reg bank (!). Perhaps what we could do instead is something like:</p>
<ul>
<li>Have a <code>PatchableValueLoad</code> abstraction (either an <code>MInst</code> case or a little struct here that does its own encoding, to nail down the length-invariance); ensure that it always produces machine code of the same length. <code>::new(value: u32, reg: Reg)</code>, <code>::update_value(value: u32)</code> and <code>::emit_to_slice(&amp;mut [u8])</code> or something like that.</li>
<li>Use it here to initially put a placeholder in; we can avoid using a magic value and magic knowledge about immediate encoding then. Perhaps we can even write a wrapper <code>::emit_to_buffer(&amp;mut MachBuffer) -&gt; PatchRegion</code>.</li>
<li>Later, patch using this; perhaps with <code>::emit_to_region(&amp;mut MachBuffer, PatchRegion)</code>.</li>
</ul>
<p>Thoughts?</p>
</blockquote>



<a name="421739137"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%237947%20winch%3A%20Move%20the%20stack%20overflow%20check%20.../near/421739137" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.237947.20winch.3A.20Move.20the.20stack.20overflow.20check.20.2E.2E.2E.html#421739137">(Feb 15 2024 at 20:56)</a>:</h4>
<p>cfallin created <a href="https://github.com/bytecodealliance/wasmtime/pull/7947#discussion_r1491650969">PR review comment</a>:</p>
<blockquote>
<p>I think branches are the only case actually; and at the <code>MachBuffer</code> layer all that matters are branches that we tell the <code>MachBuffer</code> about, via <code>add_cond_branch</code> and <code>add_uncond_branch</code>. So I think we can make this more concrete by saying "It must not introduce any MachBuffer-visible branches (i.e., you must not call <code>add_cond_branch</code> or <code>add_uncond_branch</code> between <code>start_patchable</code> and <code>end_patchable</code>)."</p>
</blockquote>



<a name="421739139"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%237947%20winch%3A%20Move%20the%20stack%20overflow%20check%20.../near/421739139" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.237947.20winch.3A.20Move.20the.20stack.20overflow.20check.20.2E.2E.2E.html#421739139">(Feb 15 2024 at 20:56)</a>:</h4>
<p>cfallin created <a href="https://github.com/bytecodealliance/wasmtime/pull/7947#discussion_r1491651243">PR review comment</a>:</p>
<blockquote>
<p>Could we add this assert in <code>add_cond_branch</code> and <code>add_uncond_branch</code> as well?</p>
</blockquote>



<a name="421740682"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%237947%20winch%3A%20Move%20the%20stack%20overflow%20check%20.../near/421740682" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.237947.20winch.3A.20Move.20the.20stack.20overflow.20check.20.2E.2E.2E.html#421740682">(Feb 15 2024 at 21:05)</a>:</h4>
<p>elliottt <a href="https://github.com/bytecodealliance/wasmtime/pull/7947#issuecomment-1947338161">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/7947">PR #7947</a>:</p>
<blockquote>
<p>The tests are failing due to the addition of stack checking to one of the trampolines (as the vmctx isn't setup yet in one case). I might roll those back so that this can be debugged separately.</p>
</blockquote>



<a name="421740811"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%237947%20winch%3A%20Move%20the%20stack%20overflow%20check%20.../near/421740811" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.237947.20winch.3A.20Move.20the.20stack.20overflow.20check.20.2E.2E.2E.html#421740811">(Feb 15 2024 at 21:06)</a>:</h4>
<p>elliottt updated <a href="https://github.com/bytecodealliance/wasmtime/pull/7947">PR #7947</a>.</p>



<a name="421760850"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%237947%20winch%3A%20Move%20the%20stack%20overflow%20check%20.../near/421760850" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.237947.20winch.3A.20Move.20the.20stack.20overflow.20check.20.2E.2E.2E.html#421760850">(Feb 15 2024 at 23:44)</a>:</h4>
<p>github-actions[bot] <a href="https://github.com/bytecodealliance/wasmtime/pull/7947#issuecomment-1947517932">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/7947">PR #7947</a>:</p>
<blockquote>
<h4>Subscribe to Label Action</h4>
<p>cc @saulecabrera</p>
<p>&lt;details&gt;<br>
This issue or pull request has been labeled: "cranelift", "cranelift:area:machinst", "winch"</p>
<p>Thus the following users have been cc'd because of the following labels:</p>
<ul>
<li>saulecabrera: winch</li>
</ul>
<p>To subscribe or unsubscribe from this label, edit the &lt;code&gt;.github/subscribe-to-label.json&lt;/code&gt; configuration file.</p>
<p><a href="https://github.com/bytecodealliance/subscribe-to-label-action">Learn more.</a><br>
&lt;/details&gt;</p>
</blockquote>



<a name="421795371"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%237947%20winch%3A%20Move%20the%20stack%20overflow%20check%20.../near/421795371" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.237947.20winch.3A.20Move.20the.20stack.20overflow.20check.20.2E.2E.2E.html#421795371">(Feb 16 2024 at 05:53)</a>:</h4>
<p>elliottt submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/7947#pullrequestreview-1884357841">PR review</a>.</p>



<a name="421795373"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%237947%20winch%3A%20Move%20the%20stack%20overflow%20check%20.../near/421795373" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.237947.20winch.3A.20Move.20the.20stack.20overflow.20check.20.2E.2E.2E.html#421795373">(Feb 16 2024 at 05:53)</a>:</h4>
<p>elliottt created <a href="https://github.com/bytecodealliance/wasmtime/pull/7947#discussion_r1491987203">PR review comment</a>:</p>
<blockquote>
<p>I agree that it's fragile as-is, and something a bit more robust would be good here.</p>
<p>Adding a special <code>PatchableValueLoad</code> type sounds good to me, as long as you don't mind the more specific "add patched immediate to register" behavior. I wanted to avoid using an additional register here, so that the sequence of loading the stack lower bound and adding the immediate for the final stack value could be done with only the scratch register.</p>
<p>I'll experiment with adding a <code>PatchableAddRegImm</code> struct in the x64 backend in cranelift, as that would make it easy to reuse logic from the existing emit implemetation for add.</p>
</blockquote>



<a name="421796857"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%237947%20winch%3A%20Move%20the%20stack%20overflow%20check%20.../near/421796857" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.237947.20winch.3A.20Move.20the.20stack.20overflow.20check.20.2E.2E.2E.html#421796857">(Feb 16 2024 at 06:06)</a>:</h4>
<p>elliottt updated <a href="https://github.com/bytecodealliance/wasmtime/pull/7947">PR #7947</a>.</p>



<a name="421798541"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%237947%20winch%3A%20Move%20the%20stack%20overflow%20check%20.../near/421798541" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.237947.20winch.3A.20Move.20the.20stack.20overflow.20check.20.2E.2E.2E.html#421798541">(Feb 16 2024 at 06:28)</a>:</h4>
<p>elliottt updated <a href="https://github.com/bytecodealliance/wasmtime/pull/7947">PR #7947</a>.</p>



<a name="421799078"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%237947%20winch%3A%20Move%20the%20stack%20overflow%20check%20.../near/421799078" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.237947.20winch.3A.20Move.20the.20stack.20overflow.20check.20.2E.2E.2E.html#421799078">(Feb 16 2024 at 06:35)</a>:</h4>
<p>elliottt updated <a href="https://github.com/bytecodealliance/wasmtime/pull/7947">PR #7947</a>.</p>



<a name="422262616"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%237947%20winch%3A%20Move%20the%20stack%20overflow%20check%20.../near/422262616" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.237947.20winch.3A.20Move.20the.20stack.20overflow.20check.20.2E.2E.2E.html#422262616">(Feb 19 2024 at 15:58)</a>:</h4>
<p>saulecabrera submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/7947#pullrequestreview-1883913082">PR review</a>:</p>
<blockquote>
<p>The Winch pieces look good to me. Left a small question and a comment. I'm going to defer the final approval to Chris, given that I'm not as familiar with the <code>MachBuffer</code> implementation. </p>
</blockquote>



<a name="422262617"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%237947%20winch%3A%20Move%20the%20stack%20overflow%20check%20.../near/422262617" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.237947.20winch.3A.20Move.20the.20stack.20overflow.20check.20.2E.2E.2E.html#422262617">(Feb 19 2024 at 15:58)</a>:</h4>
<p>saulecabrera submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/7947#pullrequestreview-1883913082">PR review</a>:</p>
<blockquote>
<p>The Winch pieces look good to me. Left a small question and a comment. I'm going to defer the final approval to Chris, given that I'm not as familiar with the <code>MachBuffer</code> implementation. </p>
</blockquote>



<a name="422262619"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%237947%20winch%3A%20Move%20the%20stack%20overflow%20check%20.../near/422262619" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.237947.20winch.3A.20Move.20the.20stack.20overflow.20check.20.2E.2E.2E.html#422262619">(Feb 19 2024 at 15:58)</a>:</h4>
<p>saulecabrera created <a href="https://github.com/bytecodealliance/wasmtime/pull/7947#discussion_r1491688803">PR review comment</a>:</p>
<blockquote>
<p><div class="codehilite" data-code-language="suggestion"><pre><span></span><code>    /// Regions where the addition of the used stack must be fixed up.
</code></pre></div><br>
</p>
</blockquote>



<a name="422262620"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%237947%20winch%3A%20Move%20the%20stack%20overflow%20check%20.../near/422262620" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.237947.20winch.3A.20Move.20the.20stack.20overflow.20check.20.2E.2E.2E.html#422262620">(Feb 19 2024 at 15:58)</a>:</h4>
<p>saulecabrera created <a href="https://github.com/bytecodealliance/wasmtime/pull/7947#discussion_r1494765113">PR review comment</a>:</p>
<blockquote>
<p>Could we add a comment here on why we're using <code>.max</code>? The reason why I bring this up is that we currently don't have a way to track the "canonical stack pointer offset" across the compiler, which is what we'd probably want to use here instead (that's what <code>.max</code> is doing here if I'm understanding correctly). We currently use the <code>sp_offset</code> as the single source of truth, but lately I've been thinking that it might be a good idea to change that (but not a blocker for this change!). This is mostly relevant in control flow, where we have to  soft-reset the stack pointer in some situations.  </p>
</blockquote>



<a name="422262621"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%237947%20winch%3A%20Move%20the%20stack%20overflow%20check%20.../near/422262621" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.237947.20winch.3A.20Move.20the.20stack.20overflow.20check.20.2E.2E.2E.html#422262621">(Feb 19 2024 at 15:58)</a>:</h4>
<p>saulecabrera created <a href="https://github.com/bytecodealliance/wasmtime/pull/7947#discussion_r1493005638">PR review comment</a>:</p>
<blockquote>
<p>One clarification question here: why the <code>2</code>? Unless I'm missing something, I'm only able to spot a single <code>push</code> (via <code>add_stack_max</code>). </p>
</blockquote>



<a name="422282133"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%237947%20winch%3A%20Move%20the%20stack%20overflow%20check%20.../near/422282133" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.237947.20winch.3A.20Move.20the.20stack.20overflow.20check.20.2E.2E.2E.html#422282133">(Feb 19 2024 at 17:34)</a>:</h4>
<p>elliottt submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/7947#pullrequestreview-1888937575">PR review</a>.</p>



<a name="422282135"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%237947%20winch%3A%20Move%20the%20stack%20overflow%20check%20.../near/422282135" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.237947.20winch.3A.20Move.20the.20stack.20overflow.20check.20.2E.2E.2E.html#422282135">(Feb 19 2024 at 17:34)</a>:</h4>
<p>elliottt created <a href="https://github.com/bytecodealliance/wasmtime/pull/7947#discussion_r1494875783">PR review comment</a>:</p>
<blockquote>
<p>This could definitely be <code>1</code> or even an optional. Given that we could possibly call <code>check_stack</code> multiple times, I wanted to make sure that we would still generate valid code. Perhaps the right solution is an <code>Option&lt;PatchRegion&gt;</code> and an assert?</p>
</blockquote>



<a name="422282735"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%237947%20winch%3A%20Move%20the%20stack%20overflow%20check%20.../near/422282735" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.237947.20winch.3A.20Move.20the.20stack.20overflow.20check.20.2E.2E.2E.html#422282735">(Feb 19 2024 at 17:39)</a>:</h4>
<p>elliottt submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/7947#pullrequestreview-1888944892">PR review</a>.</p>



<a name="422282736"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%237947%20winch%3A%20Move%20the%20stack%20overflow%20check%20.../near/422282736" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.237947.20winch.3A.20Move.20the.20stack.20overflow.20check.20.2E.2E.2E.html#422282736">(Feb 19 2024 at 17:39)</a>:</h4>
<p>elliottt created <a href="https://github.com/bytecodealliance/wasmtime/pull/7947#discussion_r1494880937">PR review comment</a>:</p>
<blockquote>
<p>The intent was to track the largest stack offset throughout code generation, so that we had an upper bound for the stack space needed. As push and reserve_stack both use <code>increment_sp</code>, this felt like a pretty good proxy for tracking the maximum seen stack allocation, but maybe I'm missing something here?</p>
</blockquote>



<a name="422286043"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%237947%20winch%3A%20Move%20the%20stack%20overflow%20check%20.../near/422286043" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.237947.20winch.3A.20Move.20the.20stack.20overflow.20check.20.2E.2E.2E.html#422286043">(Feb 19 2024 at 18:07)</a>:</h4>
<p>saulecabrera submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/7947#pullrequestreview-1888977016">PR review</a>.</p>



<a name="422286044"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%237947%20winch%3A%20Move%20the%20stack%20overflow%20check%20.../near/422286044" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.237947.20winch.3A.20Move.20the.20stack.20overflow.20check.20.2E.2E.2E.html#422286044">(Feb 19 2024 at 18:07)</a>:</h4>
<p>saulecabrera created <a href="https://github.com/bytecodealliance/wasmtime/pull/7947#discussion_r1494901400">PR review comment</a>:</p>
<blockquote>
<blockquote>
<p>this felt like a pretty good proxy for tracking the maximum seen stack allocation</p>
</blockquote>
<p>I think it is! I was just thinking that maybe it makes sense to have a comment stating that we do this (<code>.max</code>) given that we currently don't explicitly track the maximum amount of stack generated anywhere in the compiler yet, which I think we could as an optimization. </p>
</blockquote>



<a name="422286282"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%237947%20winch%3A%20Move%20the%20stack%20overflow%20check%20.../near/422286282" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.237947.20winch.3A.20Move.20the.20stack.20overflow.20check.20.2E.2E.2E.html#422286282">(Feb 19 2024 at 18:09)</a>:</h4>
<p>saulecabrera submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/7947#pullrequestreview-1888978867">PR review</a>.</p>



<a name="422286283"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%237947%20winch%3A%20Move%20the%20stack%20overflow%20check%20.../near/422286283" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.237947.20winch.3A.20Move.20the.20stack.20overflow.20check.20.2E.2E.2E.html#422286283">(Feb 19 2024 at 18:09)</a>:</h4>
<p>saulecabrera created <a href="https://github.com/bytecodealliance/wasmtime/pull/7947#discussion_r1494902724">PR review comment</a>:</p>
<blockquote>
<p>Oh that makes sense, thanks for explaining. Yeah perhaps we could try going with <code>Option&lt;PatchRegion&gt;</code> + assert. </p>
</blockquote>



<a name="422304709"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%237947%20winch%3A%20Move%20the%20stack%20overflow%20check%20.../near/422304709" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.237947.20winch.3A.20Move.20the.20stack.20overflow.20check.20.2E.2E.2E.html#422304709">(Feb 19 2024 at 20:45)</a>:</h4>
<p>elliottt submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/7947#pullrequestreview-1889146093">PR review</a>.</p>



<a name="422304710"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%237947%20winch%3A%20Move%20the%20stack%20overflow%20check%20.../near/422304710" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.237947.20winch.3A.20Move.20the.20stack.20overflow.20check.20.2E.2E.2E.html#422304710">(Feb 19 2024 at 20:45)</a>:</h4>
<p>elliottt created <a href="https://github.com/bytecodealliance/wasmtime/pull/7947#discussion_r1495000126">PR review comment</a>:</p>
<blockquote>
<p>Ah! I'll add a comment to clarify the intent here. I can also put some more documentation into the <code>sp_max</code> field itself <span aria-label="+1" class="emoji emoji-1f44d" role="img" title="+1">:+1:</span> </p>
</blockquote>



<a name="422469312"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%237947%20winch%3A%20Move%20the%20stack%20overflow%20check%20.../near/422469312" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.237947.20winch.3A.20Move.20the.20stack.20overflow.20check.20.2E.2E.2E.html#422469312">(Feb 20 2024 at 17:40)</a>:</h4>
<p>elliottt updated <a href="https://github.com/bytecodealliance/wasmtime/pull/7947">PR #7947</a>.</p>



<a name="422494541"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%237947%20winch%3A%20Move%20the%20stack%20overflow%20check%20.../near/422494541" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.237947.20winch.3A.20Move.20the.20stack.20overflow.20check.20.2E.2E.2E.html#422494541">(Feb 20 2024 at 20:19)</a>:</h4>
<p>elliottt updated <a href="https://github.com/bytecodealliance/wasmtime/pull/7947">PR #7947</a>.</p>



<a name="422494617"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%237947%20winch%3A%20Move%20the%20stack%20overflow%20check%20.../near/422494617" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.237947.20winch.3A.20Move.20the.20stack.20overflow.20check.20.2E.2E.2E.html#422494617">(Feb 20 2024 at 20:19)</a>:</h4>
<p><strong>elliottt</strong> requested <a href="https://github.com/cfallin">cfallin</a> for a review on <a href="https://github.com/bytecodealliance/wasmtime/pull/7947">PR #7947</a>.</p>



<a name="422494897"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%237947%20winch%3A%20Move%20the%20stack%20overflow%20check%20.../near/422494897" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.237947.20winch.3A.20Move.20the.20stack.20overflow.20check.20.2E.2E.2E.html#422494897">(Feb 20 2024 at 20:22)</a>:</h4>
<p>elliottt submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/7947#pullrequestreview-1891514393">PR review</a>.</p>



<a name="422494898"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%237947%20winch%3A%20Move%20the%20stack%20overflow%20check%20.../near/422494898" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.237947.20winch.3A.20Move.20the.20stack.20overflow.20check.20.2E.2E.2E.html#422494898">(Feb 20 2024 at 20:22)</a>:</h4>
<p>elliottt created <a href="https://github.com/bytecodealliance/wasmtime/pull/7947#discussion_r1496445193">PR review comment</a>:</p>
<blockquote>
<p>Would you mind taking a look at the changes in x64/asm.rs? I had to copy some details over from cranelift's emit module for rex encoding, but I believe that this approach should be much more resilient: it doesn't assume anything about how cranelift would encode an instruction; it records the offset into the patch region where the immediate starts, so it should also be resilient to local changes.</p>
<p>The downside is that it brought a lot of details into the asm module, but I think that's somewhat unavoidable at this  point.</p>
</blockquote>



<a name="422495027"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%237947%20winch%3A%20Move%20the%20stack%20overflow%20check%20.../near/422495027" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.237947.20winch.3A.20Move.20the.20stack.20overflow.20check.20.2E.2E.2E.html#422495027">(Feb 20 2024 at 20:22)</a>:</h4>
<p>elliottt submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/7947#pullrequestreview-1891515751">PR review</a>.</p>



<a name="422495031"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%237947%20winch%3A%20Move%20the%20stack%20overflow%20check%20.../near/422495031" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.237947.20winch.3A.20Move.20the.20stack.20overflow.20check.20.2E.2E.2E.html#422495031">(Feb 20 2024 at 20:22)</a>:</h4>
<p>elliottt created <a href="https://github.com/bytecodealliance/wasmtime/pull/7947#discussion_r1496446451">PR review comment</a>:</p>
<blockquote>
<p>I added some more comments to this point in <code>increment_sp</code>, and to the definition of <code>sp_max</code>, would you mind taking another look?</p>
</blockquote>



<a name="422495373"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%237947%20winch%3A%20Move%20the%20stack%20overflow%20check%20.../near/422495373" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.237947.20winch.3A.20Move.20the.20stack.20overflow.20check.20.2E.2E.2E.html#422495373">(Feb 20 2024 at 20:25)</a>:</h4>
<p>elliottt updated <a href="https://github.com/bytecodealliance/wasmtime/pull/7947">PR #7947</a>.</p>



<a name="422495393"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%237947%20winch%3A%20Move%20the%20stack%20overflow%20check%20.../near/422495393" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.237947.20winch.3A.20Move.20the.20stack.20overflow.20check.20.2E.2E.2E.html#422495393">(Feb 20 2024 at 20:25)</a>:</h4>
<p>elliottt submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/7947#pullrequestreview-1891519715">PR review</a>.</p>



<a name="422495394"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%237947%20winch%3A%20Move%20the%20stack%20overflow%20check%20.../near/422495394" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.237947.20winch.3A.20Move.20the.20stack.20overflow.20check.20.2E.2E.2E.html#422495394">(Feb 20 2024 at 20:25)</a>:</h4>
<p>elliottt created <a href="https://github.com/bytecodealliance/wasmtime/pull/7947#discussion_r1496450110">PR review comment</a>:</p>
<blockquote>
<p>I've updated the language on this comment, what do you think?</p>
</blockquote>



<a name="422495684"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%237947%20winch%3A%20Move%20the%20stack%20overflow%20check%20.../near/422495684" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.237947.20winch.3A.20Move.20the.20stack.20overflow.20check.20.2E.2E.2E.html#422495684">(Feb 20 2024 at 20:27)</a>:</h4>
<p>cfallin submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/7947#pullrequestreview-1891519362">PR review</a>:</p>
<blockquote>
<p>Looks great, thanks! Just one code-reuse nit below, otherwise good to go.</p>
</blockquote>



<a name="422495685"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%237947%20winch%3A%20Move%20the%20stack%20overflow%20check%20.../near/422495685" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.237947.20winch.3A.20Move.20the.20stack.20overflow.20check.20.2E.2E.2E.html#422495685">(Feb 20 2024 at 20:27)</a>:</h4>
<p>cfallin submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/7947#pullrequestreview-1891519362">PR review</a>:</p>
<blockquote>
<p>Looks great, thanks! Just one code-reuse nit below, otherwise good to go.</p>
</blockquote>



<a name="422495688"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%237947%20winch%3A%20Move%20the%20stack%20overflow%20check%20.../near/422495688" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.237947.20winch.3A.20Move.20the.20stack.20overflow.20check.20.2E.2E.2E.html#422495688">(Feb 20 2024 at 20:27)</a>:</h4>
<p>cfallin created <a href="https://github.com/bytecodealliance/wasmtime/pull/7947#discussion_r1496449779">PR review comment</a>:</p>
<blockquote>
<p>Can we use the version of this struct and of <code>encode_modrm</code> below in <code>cranelift_codegen::isa::x64::encoding</code>? It looks like most of that path is already <code>pub</code>; only the <code>RexFlags</code> and <code>encode_modrm</code> items themselves are not. (It's a bit suboptimal to export over the public interface, but then we already reserve the right via semver to change at each release and this is the sort of thing I'd have no reservations refactoring later)</p>
</blockquote>



<a name="422496289"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%237947%20winch%3A%20Move%20the%20stack%20overflow%20check%20.../near/422496289" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.237947.20winch.3A.20Move.20the.20stack.20overflow.20check.20.2E.2E.2E.html#422496289">(Feb 20 2024 at 20:31)</a>:</h4>
<p>saulecabrera submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/7947#pullrequestreview-1891528841">PR review</a>.</p>



<a name="422496291"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%237947%20winch%3A%20Move%20the%20stack%20overflow%20check%20.../near/422496291" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.237947.20winch.3A.20Move.20the.20stack.20overflow.20check.20.2E.2E.2E.html#422496291">(Feb 20 2024 at 20:31)</a>:</h4>
<p>saulecabrera created <a href="https://github.com/bytecodealliance/wasmtime/pull/7947#discussion_r1496458723">PR review comment</a>:</p>
<blockquote>
<p><div class="codehilite" data-code-language="suggestion"><pre><span></span><code>    /// shrink as space is reserved and freed during compilation), but once all instructions have
</code></pre></div><br>
</p>
</blockquote>



<a name="422496373"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%237947%20winch%3A%20Move%20the%20stack%20overflow%20check%20.../near/422496373" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.237947.20winch.3A.20Move.20the.20stack.20overflow.20check.20.2E.2E.2E.html#422496373">(Feb 20 2024 at 20:32)</a>:</h4>
<p>saulecabrera submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/7947#pullrequestreview-1891529538">PR review</a>.</p>



<a name="422496374"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%237947%20winch%3A%20Move%20the%20stack%20overflow%20check%20.../near/422496374" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.237947.20winch.3A.20Move.20the.20stack.20overflow.20check.20.2E.2E.2E.html#422496374">(Feb 20 2024 at 20:32)</a>:</h4>
<p>saulecabrera created <a href="https://github.com/bytecodealliance/wasmtime/pull/7947#discussion_r1496459365">PR review comment</a>:</p>
<blockquote>
<p>Looks great, thanks!</p>
</blockquote>



<a name="422512233"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%237947%20winch%3A%20Move%20the%20stack%20overflow%20check%20.../near/422512233" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.237947.20winch.3A.20Move.20the.20stack.20overflow.20check.20.2E.2E.2E.html#422512233">(Feb 20 2024 at 22:31)</a>:</h4>
<p>elliottt updated <a href="https://github.com/bytecodealliance/wasmtime/pull/7947">PR #7947</a>.</p>



<a name="422512258"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%237947%20winch%3A%20Move%20the%20stack%20overflow%20check%20.../near/422512258" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.237947.20winch.3A.20Move.20the.20stack.20overflow.20check.20.2E.2E.2E.html#422512258">(Feb 20 2024 at 22:31)</a>:</h4>
<p>elliottt updated <a href="https://github.com/bytecodealliance/wasmtime/pull/7947">PR #7947</a>.</p>



<a name="422512393"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%237947%20winch%3A%20Move%20the%20stack%20overflow%20check%20.../near/422512393" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.237947.20winch.3A.20Move.20the.20stack.20overflow.20check.20.2E.2E.2E.html#422512393">(Feb 20 2024 at 22:32)</a>:</h4>
<p>elliottt submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/7947#pullrequestreview-1891712764">PR review</a>.</p>



<a name="422512394"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%237947%20winch%3A%20Move%20the%20stack%20overflow%20check%20.../near/422512394" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.237947.20winch.3A.20Move.20the.20stack.20overflow.20check.20.2E.2E.2E.html#422512394">(Feb 20 2024 at 22:32)</a>:</h4>
<p>elliottt created <a href="https://github.com/bytecodealliance/wasmtime/pull/7947#discussion_r1496623996">PR review comment</a>:</p>
<blockquote>
<p>Yep! My original worry was needing to compute the offset for what was written to the <code>MachBuffer</code>, but that's done easily enough with <code>MachBuffer::cur_offset</code>. It's much nicer not duplicating this!</p>
</blockquote>



<a name="422512436"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%237947%20winch%3A%20Move%20the%20stack%20overflow%20check%20.../near/422512436" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.237947.20winch.3A.20Move.20the.20stack.20overflow.20check.20.2E.2E.2E.html#422512436">(Feb 20 2024 at 22:32)</a>:</h4>
<p>elliottt submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/7947#pullrequestreview-1891713140">PR review</a>.</p>



<a name="422512437"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%237947%20winch%3A%20Move%20the%20stack%20overflow%20check%20.../near/422512437" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.237947.20winch.3A.20Move.20the.20stack.20overflow.20check.20.2E.2E.2E.html#422512437">(Feb 20 2024 at 22:32)</a>:</h4>
<p>elliottt created <a href="https://github.com/bytecodealliance/wasmtime/pull/7947#discussion_r1496624414">PR review comment</a>:</p>
<blockquote>
<p>Amazing spelling mistake, thank you for catching that!</p>
</blockquote>



<a name="422512449"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%237947%20winch%3A%20Move%20the%20stack%20overflow%20check%20.../near/422512449" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.237947.20winch.3A.20Move.20the.20stack.20overflow.20check.20.2E.2E.2E.html#422512449">(Feb 20 2024 at 22:33)</a>:</h4>
<p>elliottt updated <a href="https://github.com/bytecodealliance/wasmtime/pull/7947">PR #7947</a>.</p>



<a name="422517480"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%237947%20winch%3A%20Move%20the%20stack%20overflow%20check%20.../near/422517480" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.237947.20winch.3A.20Move.20the.20stack.20overflow.20check.20.2E.2E.2E.html#422517480">(Feb 20 2024 at 23:17)</a>:</h4>
<p>elliottt merged <a href="https://github.com/bytecodealliance/wasmtime/pull/7947">PR #7947</a>.</p>



<hr><p>Last updated: Jan 20 2025 at 06:04 UTC</p>
</html>