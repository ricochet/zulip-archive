<html>
<head><meta charset="utf-8"><title>wasmtime / Issue #1725 Revert fstatat on *nix and test sy... · git-wasmtime · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/index.html">git-wasmtime</a></h2>
<h3>Topic: <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20Issue.20.231725.20Revert.20fstatat.20on.20.2Anix.20and.20test.20sy.2E.2E.2E.html">wasmtime / Issue #1725 Revert fstatat on *nix and test sy...</a></h3>

<hr>

<base href="https://bytecodealliance.zulipchat.com">

<head><link href="https://bytecodealliance.github.io/zulip-archive/style.css" rel="stylesheet"></head>

<a name="198089806"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20Issue%20%231725%20Revert%20fstatat%20on%20%2Anix%20and%20test%20sy.../near/198089806" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20Issue.20.231725.20Revert.20fstatat.20on.20.2Anix.20and.20test.20sy.2E.2E.2E.html#198089806">(May 19 2020 at 16:14)</a>:</h4>
<p>github-actions[bot] <a href="https://github.com/bytecodealliance/wasmtime/pull/1725#issuecomment-630924580">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/1725">Issue #1725</a>:</p>
<blockquote>
<h4>Subscribe to Label Action</h4>
<p>cc @kubkon</p>
<p>&lt;details&gt;<br>
This issue or pull request has been labeled: "wasi"</p>
<p>Thus the following users have been cc'd because of the following labels:</p>
<ul>
<li>kubkon: wasi</li>
</ul>
<p>To subscribe or unsubscribe from this label, edit the &lt;code&gt;.github/subscribe-to-label.json&lt;/code&gt; configuration file.</p>
<p><a href="https://github.com/bytecodealliance/subscribe-to-label-action">Learn more.</a><br>
&lt;/details&gt;</p>
</blockquote>



<a name="198091233"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20Issue%20%231725%20Revert%20fstatat%20on%20%2Anix%20and%20test%20sy.../near/198091233" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20Issue.20.231725.20Revert.20fstatat.20on.20.2Anix.20and.20test.20sy.2E.2E.2E.html#198091233">(May 19 2020 at 16:25)</a>:</h4>
<p>kubkon <a href="https://github.com/bytecodealliance/wasmtime/pull/1725#issuecomment-630930756">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/1725">Issue #1725</a>:</p>
<blockquote>
<p>@sunfishcode OK, this should now be it for *nixes. However, I see that symlink resolution fails on Windows, and I'll need to investigate whether this is something new, or whether this bug was already there in the past but we missed it due to lack of testing.</p>
</blockquote>



<a name="198091670"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20Issue%20%231725%20Revert%20fstatat%20on%20%2Anix%20and%20test%20sy.../near/198091670" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20Issue.20.231725.20Revert.20fstatat.20on.20.2Anix.20and.20test.20sy.2E.2E.2E.html#198091670">(May 19 2020 at 16:28)</a>:</h4>
<p>kubkon <a href="https://github.com/bytecodealliance/wasmtime/pull/1725#issuecomment-630932852">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/1725">Issue #1725</a>:</p>
<blockquote>
<blockquote>
<p>@sunfishcode OK, this should now be it for *nixes. However, I see that symlink resolution fails on Windows, and I'll need to investigate whether this is something new, or whether this bug was already there in the past but we missed it due to lack of testing.</p>
</blockquote>
<p>Oh, it seems I applied the wrong fillers into <code>windows::path::path_filestat_{get, set_times}</code> that's why it's failing. </p>
</blockquote>



<a name="198223868"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20Issue%20%231725%20Revert%20fstatat%20on%20%2Anix%20and%20test%20sy.../near/198223868" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20Issue.20.231725.20Revert.20fstatat.20on.20.2Anix.20and.20test.20sy.2E.2E.2E.html#198223868">(May 20 2020 at 16:32)</a>:</h4>
<p>kubkon <a href="https://github.com/bytecodealliance/wasmtime/pull/1725#issuecomment-631586274">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/1725">Issue #1725</a>:</p>
<blockquote>
<p>@sunfishcode I've now found and fixed the bug on Windows. It turns out that you need to pass a special flag to stop Windows from automatically dereferencing a symlink when creating a handle for it. In essence, <code>File::open("/dir/symlink")</code> or equivalently <code>OpenOptions::new().read(true).open("/dir/symlink")</code> is not enough and will cause Windows to create a handle for the target <code>"/dir/file"</code>. To prevent Windows from doing so, we need to pass <code>FILE_FLAG_NO_REPARSE_POINT</code> to <code>OpenOptions::custom_flags</code> which will stop Windows from deref and will allow us to properly mine the file stat from the actual symlink and not the target.</p>
</blockquote>



<a name="198223929"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20Issue%20%231725%20Revert%20fstatat%20on%20%2Anix%20and%20test%20sy.../near/198223929" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20Issue.20.231725.20Revert.20fstatat.20on.20.2Anix.20and.20test.20sy.2E.2E.2E.html#198223929">(May 20 2020 at 16:33)</a>:</h4>
<p>kubkon edited a <a href="https://github.com/bytecodealliance/wasmtime/pull/1725#issuecomment-631586274">comment</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/1725">Issue #1725</a>:</p>
<blockquote>
<p>@sunfishcode I've now found and fixed the bug on Windows. It turns out that you need to pass a special flag to stop Windows from automatically dereferencing a symlink when creating a handle for it. In essence, <code>File::open("/dir/symlink")</code> or equivalently <code>OpenOptions::new().read(true).open("/dir/symlink")</code> is not enough and will cause Windows to create a handle for the target <code>"/dir/file"</code>. To prevent Windows from doing so, we need to pass <code>FILE_FLAG_NO_REPARSE_POINT</code> to <code>OpenOptions::custom_flags</code> which will stop Windows from deref and will allow us to properly mine the file stat from the actual symlink and not the target.</p>
<p>Oh and it turns out we've had this bug all along, but didn't catch it as we didn't test for symlinks in <code>path_filestat</code> tests ;-}</p>
</blockquote>



<a name="198224022"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20Issue%20%231725%20Revert%20fstatat%20on%20%2Anix%20and%20test%20sy.../near/198224022" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20Issue.20.231725.20Revert.20fstatat.20on.20.2Anix.20and.20test.20sy.2E.2E.2E.html#198224022">(May 20 2020 at 16:33)</a>:</h4>
<p>kubkon edited a <a href="https://github.com/bytecodealliance/wasmtime/pull/1725#issuecomment-631586274">comment</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/1725">Issue #1725</a>:</p>
<blockquote>
<p>@sunfishcode I've now found and fixed the bug on Windows. It turns out that you need to pass a special flag to stop Windows from automatically dereferencing a symlink when creating a handle for it. In essence, <code>File::open("/dir/symlink")</code> or equivalently <code>OpenOptions::new().read(true).open("/dir/symlink")</code> is not enough and will cause Windows to create a handle for the target <code>"/dir/file"</code>. To prevent Windows from doing so, we need to pass <code>FILE_FLAG_OPEN_REPARSE_POINT</code> to <code>OpenOptions::custom_flags</code> which will stop Windows from deref and will allow us to properly mine the file stat from the actual symlink and not the target.</p>
<p>Oh and it turns out we've had this bug all along, but didn't catch it as we didn't test for symlinks in <code>path_filestat</code> tests ;-}</p>
</blockquote>



<a name="198224225"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20Issue%20%231725%20Revert%20fstatat%20on%20%2Anix%20and%20test%20sy.../near/198224225" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20Issue.20.231725.20Revert.20fstatat.20on.20.2Anix.20and.20test.20sy.2E.2E.2E.html#198224225">(May 20 2020 at 16:35)</a>:</h4>
<p>kubkon <a href="https://github.com/bytecodealliance/wasmtime/pull/1725#issuecomment-631587744">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/1725">Issue #1725</a>:</p>
<blockquote>
<p>Oh and I guess we should reapply this fact to other syscalls targeting Windows which deref symlinks, but I guess in another PR.</p>
</blockquote>



<hr><p>Last updated: Jan 20 2025 at 06:04 UTC</p>
</html>