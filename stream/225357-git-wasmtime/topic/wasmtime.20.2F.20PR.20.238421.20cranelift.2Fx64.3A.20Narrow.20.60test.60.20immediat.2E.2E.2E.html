<html>
<head><meta charset="utf-8"><title>wasmtime / PR #8421 cranelift/x64: Narrow `test` immediat... · git-wasmtime · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/index.html">git-wasmtime</a></h2>
<h3>Topic: <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.238421.20cranelift.2Fx64.3A.20Narrow.20.60test.60.20immediat.2E.2E.2E.html">wasmtime / PR #8421 cranelift/x64: Narrow `test` immediat...</a></h3>

<hr>

<base href="https://bytecodealliance.zulipchat.com">

<head><link href="https://bytecodealliance.github.io/zulip-archive/style.css" rel="stylesheet"></head>

<a name="434455915"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%238421%20cranelift/x64%3A%20Narrow%20%60test%60%20immediat.../near/434455915" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.238421.20cranelift.2Fx64.3A.20Narrow.20.60test.60.20immediat.2E.2E.2E.html#434455915">(Apr 20 2024 at 00:51)</a>:</h4>
<p><strong>jameysharp</strong> requested <a href="https://github.com/abrown">abrown</a> for a review on <a href="https://github.com/bytecodealliance/wasmtime/pull/8421">PR #8421</a>.</p>



<a name="434455916"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%238421%20cranelift/x64%3A%20Narrow%20%60test%60%20immediat.../near/434455916" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.238421.20cranelift.2Fx64.3A.20Narrow.20.60test.60.20immediat.2E.2E.2E.html#434455916">(Apr 20 2024 at 00:51)</a>:</h4>
<p><strong>jameysharp</strong> requested <a href="https://github.com/orgs/bytecodealliance/teams/wasmtime-compiler-reviewers">wasmtime-compiler-reviewers</a> for a review on <a href="https://github.com/bytecodealliance/wasmtime/pull/8421">PR #8421</a>.</p>



<a name="434455917"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%238421%20cranelift/x64%3A%20Narrow%20%60test%60%20immediat.../near/434455917" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.238421.20cranelift.2Fx64.3A.20Narrow.20.60test.60.20immediat.2E.2E.2E.html#434455917">(Apr 20 2024 at 00:51)</a>:</h4>
<p>jameysharp opened <a href="https://github.com/bytecodealliance/wasmtime/pull/8421">PR #8421</a> from <code>jameysharp:x64-narrow-test</code> to <code>bytecodealliance:main</code>:</p>
<blockquote>
<p>The x86 <code>test</code> instruction does a bitwise-and operation, setting flags, but otherwise discarding the result. And when one operand is an immediate constant, any zero bits in the constant can't have an effect on the result. So we can emit shorter versions of this instruction by truncating the most significant zero bits and using the narrowest possible immediate form for the provided constant.</p>
<p>I think this has merge conflicts with #8408 so I'll rebase it next week.</p>
</blockquote>



<a name="434620547"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%238421%20cranelift/x64%3A%20Narrow%20%60test%60%20immediat.../near/434620547" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.238421.20cranelift.2Fx64.3A.20Narrow.20.60test.60.20immediat.2E.2E.2E.html#434620547">(Apr 21 2024 at 21:27)</a>:</h4>
<p>jameysharp updated <a href="https://github.com/bytecodealliance/wasmtime/pull/8421">PR #8421</a>.</p>



<a name="434636499"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%238421%20cranelift/x64%3A%20Narrow%20%60test%60%20immediat.../near/434636499" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.238421.20cranelift.2Fx64.3A.20Narrow.20.60test.60.20immediat.2E.2E.2E.html#434636499">(Apr 22 2024 at 02:01)</a>:</h4>
<p>jameysharp <a href="https://github.com/bytecodealliance/wasmtime/pull/8421#issuecomment-2068353853">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/8421">PR #8421</a>:</p>
<blockquote>
<p>It's not clear to me whether I made the right choice to make this change in the code for emitting into the machbuffer, rather than doing it earlier when building vcode.</p>
<p>It's a little weird that the machbuffer disassembly doesn't match the vcode disassembly for an instruction as simple as <code>test</code>.</p>
<p>On the other hand this means that Winch gets this optimization too, and I think it's simpler to implement this in Rust than in ISLE right now.</p>
<p>So I'd be interested in other people's opinions on this: @cfallin @alexcrichton @elliottt?</p>
</blockquote>



<a name="434766827"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%238421%20cranelift/x64%3A%20Narrow%20%60test%60%20immediat.../near/434766827" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.238421.20cranelift.2Fx64.3A.20Narrow.20.60test.60.20immediat.2E.2E.2E.html#434766827">(Apr 22 2024 at 14:34)</a>:</h4>
<p>alexcrichton <a href="https://github.com/bytecodealliance/wasmtime/pull/8421#issuecomment-2069685038">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/8421">PR #8421</a>:</p>
<blockquote>
<p>Personally I think I'd prefer to do this in ISLE, but I don't feel too strongly really. Given that this is already done here it seems reasonable to land to me</p>
</blockquote>



<a name="434774929"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%238421%20cranelift/x64%3A%20Narrow%20%60test%60%20immediat.../near/434774929" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.238421.20cranelift.2Fx64.3A.20Narrow.20.60test.60.20immediat.2E.2E.2E.html#434774929">(Apr 22 2024 at 15:06)</a>:</h4>
<p>cfallin <a href="https://github.com/bytecodealliance/wasmtime/pull/8421#issuecomment-2069808550">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/8421">PR #8421</a>:</p>
<blockquote>
<p>One reason to try to lift optimizations like this into ISLE, and keep the VCode insts as close to 1-to-1 correspondence with machine code as possible, is that it makes verification more tractable: rather than writing a specification for the vcode inst that is "may do this, or that, depending on the constant", we have that logic exposed in ISLE left-hand sides where we can reason about it. For that reason I think I'd prefer for us to do that as well, unless it turns out that it's not really possible or practical at all. (There's definitely room for compromise here and some VCode insts definitely are smarter than they should be! This is more of an aspirational direction for current and future work.)</p>
</blockquote>



<a name="434816262"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%238421%20cranelift/x64%3A%20Narrow%20%60test%60%20immediat.../near/434816262" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.238421.20cranelift.2Fx64.3A.20Narrow.20.60test.60.20immediat.2E.2E.2E.html#434816262">(Apr 22 2024 at 18:11)</a>:</h4>
<p>jameysharp <a href="https://github.com/bytecodealliance/wasmtime/pull/8421#issuecomment-2070495683">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/8421">PR #8421</a>:</p>
<blockquote>
<p>Okay, I'll investigate how difficult it is to do this in ISLE and let you all know what I find out, and maybe we can reevaluate then.</p>
</blockquote>



<hr><p>Last updated: Jan 20 2025 at 06:04 UTC</p>
</html>