<html>
<head><meta charset="utf-8"><title>wasmtime / issue #4163 Add a basic alias analysis with re... · git-wasmtime · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/index.html">git-wasmtime</a></h2>
<h3>Topic: <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.234163.20Add.20a.20basic.20alias.20analysis.20with.20re.2E.2E.2E.html">wasmtime / issue #4163 Add a basic alias analysis with re...</a></h3>

<hr>

<base href="https://bytecodealliance.zulipchat.com">

<head><link href="https://bytecodealliance.github.io/zulip-archive/style.css" rel="stylesheet"></head>

<a name="282867163"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%234163%20Add%20a%20basic%20alias%20analysis%20with%20re.../near/282867163" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.234163.20Add.20a.20basic.20alias.20analysis.20with.20re.2E.2E.2E.html#282867163">(May 19 2022 at 00:30)</a>:</h4>
<p>fitzgen <a href="https://github.com/bytecodealliance/wasmtime/pull/4163#issuecomment-1130827225">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/4163">issue #4163</a>:</p>
<blockquote>
<p>Great! I will take a look at this tomorrow.</p>
</blockquote>



<a name="282867189"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%234163%20Add%20a%20basic%20alias%20analysis%20with%20re.../near/282867189" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.234163.20Add.20a.20basic.20alias.20analysis.20with.20re.2E.2E.2E.html#282867189">(May 19 2022 at 00:31)</a>:</h4>
<p>cfallin <a href="https://github.com/bytecodealliance/wasmtime/pull/4163#issuecomment-1130829170">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/4163">issue #4163</a>:</p>
<blockquote>
<p>I ran the Sightglass bnechmarks on this and the only delta is for <code>meshoptimizer</code>:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="n">execution</span><span class="w"> </span>:: <span class="nc">cycles</span><span class="w"> </span>:: <span class="nc">benchmarks</span><span class="o">-</span><span class="n">next</span><span class="o">/</span><span class="n">meshoptimizer</span><span class="o">/</span><span class="n">benchmark</span><span class="p">.</span><span class="n">wasm</span><span class="w"></span>

<span class="w">  </span><span class="err">Δ</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">957833251.60</span><span class="w"> </span><span class="err">±</span><span class="w"> </span><span class="mf">610441836.41</span><span class="w"> </span><span class="p">(</span><span class="n">confidence</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">99</span><span class="o">%</span><span class="p">)</span><span class="w"></span>

<span class="w">  </span><span class="n">new</span><span class="p">.</span><span class="n">so</span><span class="w"> </span><span class="n">is</span><span class="w"> </span><span class="mf">1.02</span><span class="n">x</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="mf">1.09</span><span class="n">x</span><span class="w"> </span><span class="n">faster</span><span class="w"> </span><span class="n">than</span><span class="w"> </span><span class="n">old</span><span class="p">.</span><span class="n">so</span><span class="o">!</span><span class="w"></span>
<span class="w">  </span><span class="n">old</span><span class="p">.</span><span class="n">so</span><span class="w"> </span><span class="n">is</span><span class="w"> </span><span class="mf">0.92</span><span class="n">x</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="mf">0.98</span><span class="n">x</span><span class="w"> </span><span class="n">faster</span><span class="w"> </span><span class="n">than</span><span class="w"> </span><span class="n">new</span><span class="p">.</span><span class="n">so</span><span class="o">!</span><span class="w"></span>

<span class="w">  </span><span class="p">[</span><span class="mi">17612149560</span><span class="w"> </span><span class="mf">17873615806.60</span><span class="w"> </span><span class="mi">18098060500</span><span class="p">]</span><span class="w"> </span><span class="n">new</span><span class="p">.</span><span class="n">so</span><span class="w"></span>
<span class="w">  </span><span class="p">[</span><span class="mi">17544919808</span><span class="w"> </span><span class="mf">18831449058.20</span><span class="w"> </span><span class="mi">19306513928</span><span class="p">]</span><span class="w"> </span><span class="n">old</span><span class="p">.</span><span class="n">so</span><span class="w"></span>

<span class="n">execution</span><span class="w"> </span>:: <span class="nc">nanoseconds</span><span class="w"> </span>:: <span class="nc">benchmarks</span><span class="o">-</span><span class="n">next</span><span class="o">/</span><span class="n">meshoptimizer</span><span class="o">/</span><span class="n">benchmark</span><span class="p">.</span><span class="n">wasm</span><span class="w"></span>

<span class="w">  </span><span class="err">Δ</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">252025449.20</span><span class="w"> </span><span class="err">±</span><span class="w"> </span><span class="mf">160632667.79</span><span class="w"> </span><span class="p">(</span><span class="n">confidence</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">99</span><span class="o">%</span><span class="p">)</span><span class="w"></span>

<span class="w">  </span><span class="n">new</span><span class="p">.</span><span class="n">so</span><span class="w"> </span><span class="n">is</span><span class="w"> </span><span class="mf">1.02</span><span class="n">x</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="mf">1.09</span><span class="n">x</span><span class="w"> </span><span class="n">faster</span><span class="w"> </span><span class="n">than</span><span class="w"> </span><span class="n">old</span><span class="p">.</span><span class="n">so</span><span class="o">!</span><span class="w"></span>
<span class="w">  </span><span class="n">old</span><span class="p">.</span><span class="n">so</span><span class="w"> </span><span class="n">is</span><span class="w"> </span><span class="mf">0.92</span><span class="n">x</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="mf">0.98</span><span class="n">x</span><span class="w"> </span><span class="n">faster</span><span class="w"> </span><span class="n">than</span><span class="w"> </span><span class="n">new</span><span class="p">.</span><span class="n">so</span><span class="o">!</span><span class="w"></span>

<span class="w">  </span><span class="p">[</span><span class="mi">4634388228</span><span class="w"> </span><span class="mf">4703136639.50</span><span class="w"> </span><span class="mi">4762142132</span><span class="p">]</span><span class="w"> </span><span class="n">new</span><span class="p">.</span><span class="n">so</span><span class="w"></span>
<span class="w">  </span><span class="p">[</span><span class="mi">4616626357</span><span class="w"> </span><span class="mf">4955162088.70</span><span class="w"> </span><span class="mi">5080175835</span><span class="p">]</span><span class="w"> </span><span class="n">old</span><span class="p">.</span><span class="n">so</span><span class="w"></span>
</code></pre></div>
<p>(with no impact on compilation time for any benchmark). I'm not <em>too</em> surprised we don't see more opportunity in Wasm benchmarks, because a lot of the RLE and store-to-load opts will have already been done by the Wasm toolchain. Regardless it seems nice to have this in, if it doesn't hurt, and it could become more applicable if/when we inline.</p>
</blockquote>



<a name="282867227"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%234163%20Add%20a%20basic%20alias%20analysis%20with%20re.../near/282867227" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.234163.20Add.20a.20basic.20alias.20analysis.20with.20re.2E.2E.2E.html#282867227">(May 19 2022 at 00:31)</a>:</h4>
<p>cfallin edited a <a href="https://github.com/bytecodealliance/wasmtime/pull/4163#issuecomment-1130829170">comment</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/4163">issue #4163</a>:</p>
<blockquote>
<p>I ran the Sightglass benchmarks on this and the only delta is for <code>meshoptimizer</code>:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="n">execution</span><span class="w"> </span>:: <span class="nc">cycles</span><span class="w"> </span>:: <span class="nc">benchmarks</span><span class="o">-</span><span class="n">next</span><span class="o">/</span><span class="n">meshoptimizer</span><span class="o">/</span><span class="n">benchmark</span><span class="p">.</span><span class="n">wasm</span><span class="w"></span>

<span class="w">  </span><span class="err">Δ</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">957833251.60</span><span class="w"> </span><span class="err">±</span><span class="w"> </span><span class="mf">610441836.41</span><span class="w"> </span><span class="p">(</span><span class="n">confidence</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">99</span><span class="o">%</span><span class="p">)</span><span class="w"></span>

<span class="w">  </span><span class="n">new</span><span class="p">.</span><span class="n">so</span><span class="w"> </span><span class="n">is</span><span class="w"> </span><span class="mf">1.02</span><span class="n">x</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="mf">1.09</span><span class="n">x</span><span class="w"> </span><span class="n">faster</span><span class="w"> </span><span class="n">than</span><span class="w"> </span><span class="n">old</span><span class="p">.</span><span class="n">so</span><span class="o">!</span><span class="w"></span>
<span class="w">  </span><span class="n">old</span><span class="p">.</span><span class="n">so</span><span class="w"> </span><span class="n">is</span><span class="w"> </span><span class="mf">0.92</span><span class="n">x</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="mf">0.98</span><span class="n">x</span><span class="w"> </span><span class="n">faster</span><span class="w"> </span><span class="n">than</span><span class="w"> </span><span class="n">new</span><span class="p">.</span><span class="n">so</span><span class="o">!</span><span class="w"></span>

<span class="w">  </span><span class="p">[</span><span class="mi">17612149560</span><span class="w"> </span><span class="mf">17873615806.60</span><span class="w"> </span><span class="mi">18098060500</span><span class="p">]</span><span class="w"> </span><span class="n">new</span><span class="p">.</span><span class="n">so</span><span class="w"></span>
<span class="w">  </span><span class="p">[</span><span class="mi">17544919808</span><span class="w"> </span><span class="mf">18831449058.20</span><span class="w"> </span><span class="mi">19306513928</span><span class="p">]</span><span class="w"> </span><span class="n">old</span><span class="p">.</span><span class="n">so</span><span class="w"></span>

<span class="n">execution</span><span class="w"> </span>:: <span class="nc">nanoseconds</span><span class="w"> </span>:: <span class="nc">benchmarks</span><span class="o">-</span><span class="n">next</span><span class="o">/</span><span class="n">meshoptimizer</span><span class="o">/</span><span class="n">benchmark</span><span class="p">.</span><span class="n">wasm</span><span class="w"></span>

<span class="w">  </span><span class="err">Δ</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">252025449.20</span><span class="w"> </span><span class="err">±</span><span class="w"> </span><span class="mf">160632667.79</span><span class="w"> </span><span class="p">(</span><span class="n">confidence</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">99</span><span class="o">%</span><span class="p">)</span><span class="w"></span>

<span class="w">  </span><span class="n">new</span><span class="p">.</span><span class="n">so</span><span class="w"> </span><span class="n">is</span><span class="w"> </span><span class="mf">1.02</span><span class="n">x</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="mf">1.09</span><span class="n">x</span><span class="w"> </span><span class="n">faster</span><span class="w"> </span><span class="n">than</span><span class="w"> </span><span class="n">old</span><span class="p">.</span><span class="n">so</span><span class="o">!</span><span class="w"></span>
<span class="w">  </span><span class="n">old</span><span class="p">.</span><span class="n">so</span><span class="w"> </span><span class="n">is</span><span class="w"> </span><span class="mf">0.92</span><span class="n">x</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="mf">0.98</span><span class="n">x</span><span class="w"> </span><span class="n">faster</span><span class="w"> </span><span class="n">than</span><span class="w"> </span><span class="n">new</span><span class="p">.</span><span class="n">so</span><span class="o">!</span><span class="w"></span>

<span class="w">  </span><span class="p">[</span><span class="mi">4634388228</span><span class="w"> </span><span class="mf">4703136639.50</span><span class="w"> </span><span class="mi">4762142132</span><span class="p">]</span><span class="w"> </span><span class="n">new</span><span class="p">.</span><span class="n">so</span><span class="w"></span>
<span class="w">  </span><span class="p">[</span><span class="mi">4616626357</span><span class="w"> </span><span class="mf">4955162088.70</span><span class="w"> </span><span class="mi">5080175835</span><span class="p">]</span><span class="w"> </span><span class="n">old</span><span class="p">.</span><span class="n">so</span><span class="w"></span>
</code></pre></div>
<p>(with no impact on compilation time for any benchmark). I'm not <em>too</em> surprised we don't see more opportunity in Wasm benchmarks, because a lot of the RLE and store-to-load opts will have already been done by the Wasm toolchain. Regardless it seems nice to have this in, if it doesn't hurt, and it could become more applicable if/when we inline.</p>
</blockquote>



<a name="282884753"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%234163%20Add%20a%20basic%20alias%20analysis%20with%20re.../near/282884753" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.234163.20Add.20a.20basic.20alias.20analysis.20with.20re.2E.2E.2E.html#282884753">(May 19 2022 at 05:59)</a>:</h4>
<p>bjorn3 <a href="https://github.com/bytecodealliance/wasmtime/pull/4163#issuecomment-1131250208">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/4163">issue #4163</a>:</p>
<blockquote>
<p>I think you will need to add support for volatile loads and stores for this to not miscompile rust code. It would also be nice if you could state an exhaustive list of UB it depends on. For example that reading/writing memory racing with the compiled clif function is UB unless it is an atomic or volatile load/store.</p>
</blockquote>



<a name="282885084"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%234163%20Add%20a%20basic%20alias%20analysis%20with%20re.../near/282885084" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.234163.20Add.20a.20basic.20alias.20analysis.20with.20re.2E.2E.2E.html#282885084">(May 19 2022 at 06:04)</a>:</h4>
<p>bjorn3 <a href="https://github.com/bytecodealliance/wasmtime/pull/4163#issuecomment-1131252658">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/4163">issue #4163</a>:</p>
<blockquote>
<p>By the way what is the time complexity of this optinization pass?</p>
</blockquote>



<a name="282885779"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%234163%20Add%20a%20basic%20alias%20analysis%20with%20re.../near/282885779" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.234163.20Add.20a.20basic.20alias.20analysis.20with.20re.2E.2E.2E.html#282885779">(May 19 2022 at 06:15)</a>:</h4>
<p>cfallin <a href="https://github.com/bytecodealliance/wasmtime/pull/4163#issuecomment-1131259841">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/4163">issue #4163</a>:</p>
<blockquote>
<blockquote>
<p>volatile loads/stores to not miscompile</p>
</blockquote>
<p>@bjorn3 can you clarify if the cg\_clif frontend currently expects all loads to not be elided, or otherwise what the requirements are?</p>
<p>Otherwise removing a load and replacing it with a known value is always legal, given CLIF semantics today. (If it helps, imagine the disjoint alias categories don't exist: by default all loads/stores fall into "other", so memory locations are named by the last store of any kind.)</p>
<p>Atomics should use atomic ops at the CLIF level of course; I believe those should act as full barriers across all categories, as calls do. (I don't think I've actually added this logic yet; will ensure it's there tomorrow.)</p>
<blockquote>
<p>time complexity of this optimization pass?</p>
</blockquote>
<p>Same as any of the other iterative dataflow analyses: worst case passes over any given basic block bounded by maximum descending chain depth in the lattice. Here the last-store vector meets to "current inst" on any conflict at a merge point so the lattice is effectively three levels deep, constant; so that's O(|blocks|) to converge last-store info (likely one visit per block, rarely two). Then one more visit per block to discover and use aliases.</p>
</blockquote>



<a name="282900215"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%234163%20Add%20a%20basic%20alias%20analysis%20with%20re.../near/282900215" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.234163.20Add.20a.20basic.20alias.20analysis.20with.20re.2E.2E.2E.html#282900215">(May 19 2022 at 08:59)</a>:</h4>
<p>bjorn3 <a href="https://github.com/bytecodealliance/wasmtime/pull/4163#issuecomment-1131432119">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/4163">issue #4163</a>:</p>
<blockquote>
<blockquote>
<p>@bjorn3 can you clarify if the cg_clif frontend currently expects all loads to not be elided, or otherwise what the requirements are?</p>
</blockquote>
<p>Volatile memory operations can't be changed as they may have side effects like initiating a DMA transfer or changing the state of a device. Non-volatile and non-atomic memory accesses can be optimized as rust defines data races to be UB.</p>
</blockquote>



<a name="282905108"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%234163%20Add%20a%20basic%20alias%20analysis%20with%20re.../near/282905108" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.234163.20Add.20a.20basic.20alias.20analysis.20with.20re.2E.2E.2E.html#282905108">(May 19 2022 at 09:49)</a>:</h4>
<p>bjorn3 <a href="https://github.com/bytecodealliance/wasmtime/pull/4163#issuecomment-1131483339">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/4163">issue #4163</a>:</p>
<blockquote>
<p>This is a slight regresion for the simple-raytracer benchmark of cg_clif. I would guess it increases live-range sizes causing a regalloc pessimization. Implementing <a href="https://github.com/bytecodealliance/wasmtime/pull/4163#discussion_r876805710">https://github.com/bytecodealliance/wasmtime/pull/4163#discussion_r876805710</a> would make it a beneficial optimization I think. I used to have a simple implementation of that in cg_clif which also looks at which bytes of a stack slot were accessed by the load/store to effectively allow SROA, but I removed it in <a href="https://github.com/bjorn3/rustc_codegen_cranelift/commit/a793be8ee8895538e99acc2a855d9c4ae145fc78">https://github.com/bjorn3/rustc_codegen_cranelift/commit/a793be8ee8895538e99acc2a855d9c4ae145fc78</a> as it was buggy and I didn't think I knew how to fix it. It also only operated within a single basic block. See <a href="https://github.com/bjorn3/rustc_codegen_cranelift/issues/846">https://github.com/bjorn3/rustc_codegen_cranelift/issues/846</a>.</p>
<p><div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="n">Benchmark</span><span class="w"> </span><span class="mi">1</span>: <span class="p">.</span><span class="o">/</span><span class="n">raytracer_cg_clif_release_alias_analysis</span><span class="w"></span>
<span class="w">  </span><span class="n">Time</span><span class="w"> </span><span class="p">(</span><span class="n">mean</span><span class="w"> </span><span class="err">±</span><span class="w"> </span><span class="err">σ</span><span class="p">)</span>:      <span class="mf">5.196</span><span class="w"> </span><span class="n">s</span><span class="w"> </span><span class="err">±</span><span class="w">  </span><span class="mf">0.012</span><span class="w"> </span><span class="n">s</span><span class="w">    </span><span class="p">[</span><span class="n">User</span>: <span class="mf">5.191</span><span class="w"> </span><span class="n">s</span><span class="p">,</span><span class="w"> </span><span class="n">System</span>: <span class="mf">0.004</span><span class="w"> </span><span class="n">s</span><span class="p">]</span><span class="w"></span>
<span class="w">  </span><span class="n">Range</span><span class="w"> </span><span class="p">(</span><span class="n">min</span><span class="w"> </span><span class="err">…</span><span class="w"> </span><span class="n">max</span><span class="p">)</span>:    <span class="mf">5.169</span><span class="w"> </span><span class="n">s</span><span class="w"> </span><span class="err">…</span><span class="w">  </span><span class="mf">5.211</span><span class="w"> </span><span class="n">s</span><span class="w">    </span><span class="mi">10</span><span class="w"> </span><span class="n">runs</span><span class="w"></span>

<span class="n">Benchmark</span><span class="w"> </span><span class="mi">2</span>: <span class="p">.</span><span class="o">/</span><span class="n">raytracer_cg_clif_release_main</span><span class="w"></span>
<span class="w">  </span><span class="n">Time</span><span class="w"> </span><span class="p">(</span><span class="n">mean</span><span class="w"> </span><span class="err">±</span><span class="w"> </span><span class="err">σ</span><span class="p">)</span>:      <span class="mf">5.224</span><span class="w"> </span><span class="n">s</span><span class="w"> </span><span class="err">±</span><span class="w">  </span><span class="mf">0.024</span><span class="w"> </span><span class="n">s</span><span class="w">    </span><span class="p">[</span><span class="n">User</span>: <span class="mf">5.218</span><span class="w"> </span><span class="n">s</span><span class="p">,</span><span class="w"> </span><span class="n">System</span>: <span class="mf">0.005</span><span class="w"> </span><span class="n">s</span><span class="p">]</span><span class="w"></span>
<span class="w">  </span><span class="n">Range</span><span class="w"> </span><span class="p">(</span><span class="n">min</span><span class="w"> </span><span class="err">…</span><span class="w"> </span><span class="n">max</span><span class="p">)</span>:    <span class="mf">5.197</span><span class="w"> </span><span class="n">s</span><span class="w"> </span><span class="err">…</span><span class="w">  </span><span class="mf">5.263</span><span class="w"> </span><span class="n">s</span><span class="w">    </span><span class="mi">10</span><span class="w"> </span><span class="n">runs</span><span class="w"></span>

<span class="n">Summary</span><span class="w"></span>
<span class="w">  </span><span class="o">'</span><span class="p">.</span><span class="o">/</span><span class="n">raytracer_cg_clif_release_alias_analysis</span><span class="o">'</span><span class="w"> </span><span class="n">ran</span><span class="w"></span>
<span class="w">    </span><span class="mf">1.01</span><span class="w"> </span><span class="err">±</span><span class="w"> </span><span class="mf">0.01</span><span class="w"> </span><span class="n">times</span><span class="w"> </span><span class="n">faster</span><span class="w"> </span><span class="n">than</span><span class="w"> </span><span class="o">'</span><span class="p">.</span><span class="o">/</span><span class="n">raytracer_cg_clif_release_main</span><span class="o">'</span><span class="w"></span>
</code></pre></div><br>
</p>
</blockquote>



<a name="282941909"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%234163%20Add%20a%20basic%20alias%20analysis%20with%20re.../near/282941909" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.234163.20Add.20a.20basic.20alias.20analysis.20with.20re.2E.2E.2E.html#282941909">(May 19 2022 at 15:02)</a>:</h4>
<p>cfallin <a href="https://github.com/bytecodealliance/wasmtime/pull/4163#issuecomment-1131842065">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/4163">issue #4163</a>:</p>
<blockquote>
<blockquote>
<blockquote>
<p>@bjorn3 can you clarify if the cg_clif frontend currently expects all loads to not be elided, or otherwise what the requirements are?</p>
</blockquote>
<p>Volatile memory operations can't be changed as they may have side effects like initiating a DMA transfer or changing the state of a device. Non-volatile and non-atomic memory accesses can be optimized as rust defines data races to be UB.</p>
</blockquote>
<p>OK, so if I understand correctly, cg\_clif is currently compiling volatiles at the Rust level to normal loads/stores at the CLIF level? That I agree would result in miscompiles; the issue though isn't alias analysis as the semantics of <code>load</code> and <code>store</code> in CLIF have always been (even if not exploited until now) those of normal loads/stores. Adding volatile memory ops seems like a reasonable feature request though and I'd be happy to review a PR for that as well.</p>
</blockquote>



<a name="282942344"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%234163%20Add%20a%20basic%20alias%20analysis%20with%20re.../near/282942344" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.234163.20Add.20a.20basic.20alias.20analysis.20with.20re.2E.2E.2E.html#282942344">(May 19 2022 at 15:05)</a>:</h4>
<p>cfallin <a href="https://github.com/bytecodealliance/wasmtime/pull/4163#issuecomment-1131845260">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/4163">issue #4163</a>:</p>
<blockquote>
<p>@bjorn3 I may be misreading your benchmark result, but:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="n">Benchmark</span><span class="w"> </span><span class="mi">1</span>: <span class="p">.</span><span class="o">/</span><span class="n">raytracer_cg_clif_release_alias_analysis</span><span class="w"></span>
<span class="w">  </span><span class="n">Time</span><span class="w"> </span><span class="p">(</span><span class="n">mean</span><span class="w"> </span><span class="err">±</span><span class="w"> </span><span class="err">σ</span><span class="p">)</span>:      <span class="mf">5.196</span><span class="w"> </span><span class="n">s</span><span class="w"> </span><span class="err">±</span><span class="w">  </span><span class="mf">0.012</span><span class="w"> </span><span class="n">s</span><span class="w">    </span><span class="p">[</span><span class="n">User</span>: <span class="mf">5.191</span><span class="w"> </span><span class="n">s</span><span class="p">,</span><span class="w"> </span><span class="n">System</span>: <span class="mf">0.004</span><span class="w"> </span><span class="n">s</span><span class="p">]</span><span class="w"></span>

<span class="n">Benchmark</span><span class="w"> </span><span class="mi">2</span>: <span class="p">.</span><span class="o">/</span><span class="n">raytracer_cg_clif_release_main</span><span class="w"></span>
<span class="w">  </span><span class="n">Time</span><span class="w"> </span><span class="p">(</span><span class="n">mean</span><span class="w"> </span><span class="err">±</span><span class="w"> </span><span class="err">σ</span><span class="p">)</span>:      <span class="mf">5.224</span><span class="w"> </span><span class="n">s</span><span class="w"> </span><span class="err">±</span><span class="w">  </span><span class="mf">0.024</span><span class="w"> </span><span class="n">s</span><span class="w">    </span><span class="p">[</span><span class="n">User</span>: <span class="mf">5.218</span><span class="w"> </span><span class="n">s</span><span class="p">,</span><span class="w"> </span><span class="n">System</span>: <span class="mf">0.005</span><span class="w"> </span><span class="n">s</span><span class="p">]</span><span class="w"></span>
</code></pre></div>
<p>looks like <code>alias_analysis</code> ran a bit faster than <code>main</code>? Then <code>'./raytracer_cg_clif_release_alias_analysis' ran 1.01 ± 0.01 times faster than './raytracer_cg_clif_release_main'</code> seems to confirm -- +1%, though maybe within a margin of error.</p>
</blockquote>



<a name="282998577"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%234163%20Add%20a%20basic%20alias%20analysis%20with%20re.../near/282998577" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.234163.20Add.20a.20basic.20alias.20analysis.20with.20re.2E.2E.2E.html#282998577">(May 19 2022 at 22:10)</a>:</h4>
<p>bjorn3 <a href="https://github.com/bytecodealliance/wasmtime/pull/4163#issuecomment-1132254669">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/4163">issue #4163</a>:</p>
<blockquote>
<blockquote>
<p>looks like alias_analysis ran a bit faster than main?</p>
</blockquote>
<p>Right, my bad.</p>
</blockquote>



<a name="283005121"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%234163%20Add%20a%20basic%20alias%20analysis%20with%20re.../near/283005121" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.234163.20Add.20a.20basic.20alias.20analysis.20with.20re.2E.2E.2E.html#283005121">(May 19 2022 at 23:23)</a>:</h4>
<p>cfallin <a href="https://github.com/bytecodealliance/wasmtime/pull/4163#issuecomment-1132293667">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/4163">issue #4163</a>:</p>
<blockquote>
<p>Updated, thanks!</p>
</blockquote>



<a name="283028497"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%234163%20Add%20a%20basic%20alias%20analysis%20with%20re.../near/283028497" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.234163.20Add.20a.20basic.20alias.20analysis.20with.20re.2E.2E.2E.html#283028497">(May 20 2022 at 06:17)</a>:</h4>
<p>bjorn3 <a href="https://github.com/bytecodealliance/wasmtime/pull/4163#issuecomment-1132515266">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/4163">issue #4163</a>:</p>
<blockquote>
<p>Hang on, I think I know why it didn't help much for cg_clif. Cg_clif uses stack_load and stack_store rather than the stack_addr+load/store this opt pass needs.</p>
</blockquote>



<a name="283030360"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%234163%20Add%20a%20basic%20alias%20analysis%20with%20re.../near/283030360" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.234163.20Add.20a.20basic.20alias.20analysis.20with.20re.2E.2E.2E.html#283030360">(May 20 2022 at 06:46)</a>:</h4>
<p>cfallin <a href="https://github.com/bytecodealliance/wasmtime/pull/4163#issuecomment-1132534757">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/4163">issue #4163</a>:</p>
<blockquote>
<p>@bjorn3 the alias analysis / redundant-load pass runs after legalization, so it should see plain loads/stores rather than <code>stack_load</code>/<code>stack_store</code>, I think.</p>
</blockquote>



<a name="286379319"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%234163%20Add%20a%20basic%20alias%20analysis%20with%20re.../near/286379319" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.234163.20Add.20a.20basic.20alias.20analysis.20with.20re.2E.2E.2E.html#286379319">(Jun 16 2022 at 16:36)</a>:</h4>
<p>pepyakin <a href="https://github.com/bytecodealliance/wasmtime/pull/4163#issuecomment-1157890369">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/4163">issue #4163</a>:</p>
<blockquote>
<p>FWIW, I've noticed around ≈15% regression and bisection points on this commit.</p>
<p>the results for 0824abb:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="p">.</span><span class="o">/</span><span class="n">target</span><span class="o">/</span><span class="n">release</span><span class="o">/</span><span class="n">wasmtime</span><span class="w"> </span><span class="n">compile</span><span class="w"> </span><span class="o">-</span><span class="n">g</span><span class="w"> </span><span class="o">-</span><span class="n">O</span><span class="w"> </span><span class="n">wasmibox</span><span class="p">.</span><span class="n">wasm</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="p">,</span><span class="w"> </span><span class="n">hyperfine</span><span class="w"> </span><span class="o">--</span><span class="n">show</span><span class="o">-</span><span class="n">output</span><span class="w"> </span><span class="o">--</span><span class="n">warmup</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="s">"./target/release/wasmtime run -g -O --allow-precompiled --invoke wasm_kernel_run wasmibox.cwasm"</span><span class="w"></span>
<span class="n">Benchmark</span><span class="w"> </span><span class="mi">1</span>: <span class="p">.</span><span class="o">/</span><span class="n">target</span><span class="o">/</span><span class="n">release</span><span class="o">/</span><span class="n">wasmtime</span><span class="w"> </span><span class="n">run</span><span class="w"> </span><span class="o">-</span><span class="n">g</span><span class="w"> </span><span class="o">-</span><span class="n">O</span><span class="w"> </span><span class="o">--</span><span class="n">allow</span><span class="o">-</span><span class="n">precompiled</span><span class="w"> </span><span class="o">--</span><span class="n">invoke</span><span class="w"> </span><span class="n">wasm_kernel_run</span><span class="w"> </span><span class="n">wasmibox</span><span class="p">.</span><span class="n">cwasm</span><span class="w"></span>
<span class="w">  </span><span class="n">Time</span><span class="w"> </span><span class="p">(</span><span class="n">mean</span><span class="w"> </span><span class="err">±</span><span class="w"> </span><span class="err">σ</span><span class="p">)</span>:      <span class="mf">7.098</span><span class="w"> </span><span class="n">s</span><span class="w"> </span><span class="err">±</span><span class="w">  </span><span class="mf">0.033</span><span class="w"> </span><span class="n">s</span><span class="w">    </span><span class="p">[</span><span class="n">User</span>: <span class="mf">7.080</span><span class="w"> </span><span class="n">s</span><span class="p">,</span><span class="w"> </span><span class="n">System</span>: <span class="mf">0.015</span><span class="w"> </span><span class="n">s</span><span class="p">]</span><span class="w"></span>
<span class="w">  </span><span class="n">Range</span><span class="w"> </span><span class="p">(</span><span class="n">min</span><span class="w"> </span><span class="err">…</span><span class="w"> </span><span class="n">max</span><span class="p">)</span>:    <span class="mf">7.018</span><span class="w"> </span><span class="n">s</span><span class="w"> </span><span class="err">…</span><span class="w">  </span><span class="mf">7.146</span><span class="w"> </span><span class="n">s</span><span class="w">    </span><span class="mi">10</span><span class="w"> </span><span class="n">runs</span><span class="w"></span>
</code></pre></div>
<p>previous good, 89ccc56:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="p">.</span><span class="o">/</span><span class="n">target</span><span class="o">/</span><span class="n">release</span><span class="o">/</span><span class="n">wasmtime</span><span class="w"> </span><span class="n">compile</span><span class="w"> </span><span class="o">-</span><span class="n">g</span><span class="w"> </span><span class="o">-</span><span class="n">O</span><span class="w"> </span><span class="n">wasmibox</span><span class="p">.</span><span class="n">wasm</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="p">,</span><span class="w"> </span><span class="n">hyperfine</span><span class="w"> </span><span class="o">--</span><span class="n">show</span><span class="o">-</span><span class="n">output</span><span class="w"> </span><span class="o">--</span><span class="n">warmup</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="s">"./target/release/wasmtime run -g -O --allow-precompiled --invoke wasm_kernel_run wasmibox.cwasm"</span><span class="w"></span>
<span class="n">Benchmark</span><span class="w"> </span><span class="mi">1</span>: <span class="p">.</span><span class="o">/</span><span class="n">target</span><span class="o">/</span><span class="n">release</span><span class="o">/</span><span class="n">wasmtime</span><span class="w"> </span><span class="n">run</span><span class="w"> </span><span class="o">-</span><span class="n">g</span><span class="w"> </span><span class="o">-</span><span class="n">O</span><span class="w"> </span><span class="o">--</span><span class="n">allow</span><span class="o">-</span><span class="n">precompiled</span><span class="w"> </span><span class="o">--</span><span class="n">invoke</span><span class="w"> </span><span class="n">wasm_kernel_run</span><span class="w"> </span><span class="n">wasmibox</span><span class="p">.</span><span class="n">cwasm</span><span class="w"></span>
<span class="w">  </span><span class="n">Time</span><span class="w"> </span><span class="p">(</span><span class="n">mean</span><span class="w"> </span><span class="err">±</span><span class="w"> </span><span class="err">σ</span><span class="p">)</span>:      <span class="mf">6.071</span><span class="w"> </span><span class="n">s</span><span class="w"> </span><span class="err">±</span><span class="w">  </span><span class="mf">0.039</span><span class="w"> </span><span class="n">s</span><span class="w">    </span><span class="p">[</span><span class="n">User</span>: <span class="mf">6.052</span><span class="w"> </span><span class="n">s</span><span class="p">,</span><span class="w"> </span><span class="n">System</span>: <span class="mf">0.016</span><span class="w"> </span><span class="n">s</span><span class="p">]</span><span class="w"></span>
<span class="w">  </span><span class="n">Range</span><span class="w"> </span><span class="p">(</span><span class="n">min</span><span class="w"> </span><span class="err">…</span><span class="w"> </span><span class="n">max</span><span class="p">)</span>:    <span class="mf">6.024</span><span class="w"> </span><span class="n">s</span><span class="w"> </span><span class="err">…</span><span class="w">  </span><span class="mf">6.153</span><span class="w"> </span><span class="n">s</span><span class="w">    </span><span class="mi">10</span><span class="w"> </span><span class="n">runs</span><span class="w"></span>
</code></pre></div>
<p>This particular benchmark is a standalone wasm file, i.e. no imports. The entry point loads a test wasm binary and interprets it with compiled in wasmi. The test binary is also standalone. The test wasm generates random numbers using xorshift and takes keccak hash out of it. I can publish the wasm or the source to get the wasm.</p>
</blockquote>



<a name="286384195"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%234163%20Add%20a%20basic%20alias%20analysis%20with%20re.../near/286384195" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.234163.20Add.20a.20basic.20alias.20analysis.20with.20re.2E.2E.2E.html#286384195">(Jun 16 2022 at 17:15)</a>:</h4>
<p>pepyakin <a href="https://github.com/bytecodealliance/wasmtime/pull/4163#issuecomment-1157932904">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/4163">issue #4163</a>:</p>
<blockquote>
<p>Well, it gets weird. </p>
<p>If I apply the following change:</p>
<div class="codehilite" data-code-language="Diff"><pre><span></span><code><span class="gh">diff --cc crates/wasmtime/src/config.rs</span><span class="w"></span>
<span class="gh">index 9c1ed87ca,9c1ed87ca..6e9bcd1f7</span><span class="w"></span>
<span class="gd">--- a/crates/wasmtime/src/config.rs</span><span class="w"></span>
<span class="gi">+++ b/crates/wasmtime/src/config.rs</span><span class="w"></span>
<span class="gu">@@@ -1287,6 -1287,6 +1287,7 @@@ fn compiler_builder(strategy: Strategy</span><span class="w"></span>
<span class="w"> </span>             },<span class="w"></span>
<span class="w"> </span>         )<span class="w"></span>
<span class="w"> </span>         .unwrap();<span class="w"></span>
<span class="gi">++    builder.set("enable_pinned_reg", "true").unwrap();</span><span class="w"></span>
<span class="w"> </span>     Ok(builder)<span class="w"></span>
<span class="w"> </span> }<span class="w"></span>

<span class="gh">diff --cc crates/wasmtime/src/engine.rs</span><span class="w"></span>
<span class="gh">index c81ae6e67,c81ae6e67..cc150af3a</span><span class="w"></span>
<span class="gd">--- a/crates/wasmtime/src/engine.rs</span><span class="w"></span>
<span class="gi">+++ b/crates/wasmtime/src/engine.rs</span><span class="w"></span>
<span class="gu">@@@ -312,7 -312,7 +312,7 @@@ impl Engine</span><span class="w"></span>
<span class="w"> </span>             "baldrdash_prologue_words" =&gt; *value == FlagValue::Num(0),<span class="w"></span>
<span class="w"> </span>             "enable_llvm_abi_extensions" =&gt; *value == FlagValue::Bool(false),<span class="w"></span>
<span class="w"> </span>             "emit_all_ones_funcaddrs" =&gt; *value == FlagValue::Bool(false),<span class="w"></span>
<span class="gd">--            "enable_pinned_reg" =&gt; *value == FlagValue::Bool(false),</span><span class="w"></span>
<span class="gi">++            "enable_pinned_reg" =&gt; *value == FlagValue::Bool(true),</span><span class="w"></span>
<span class="w"> </span>             "enable_probestack" =&gt; *value == FlagValue::Bool(false),<span class="w"></span>
<span class="w"> </span>             "use_colocated_libcalls" =&gt; *value == FlagValue::Bool(false),<span class="w"></span>
<span class="w"> </span>             "use_pinned_reg_as_heap_base" =&gt; *value == FlagValue::Bool(false),<span class="w"></span>
</code></pre></div>
<p>then the result would be like this:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="n">Benchmark</span><span class="w"> </span><span class="mi">1</span>: <span class="p">.</span><span class="o">/</span><span class="n">target</span><span class="o">/</span><span class="n">release</span><span class="o">/</span><span class="n">wasmtime</span><span class="w"> </span><span class="n">run</span><span class="w"> </span><span class="o">-</span><span class="n">g</span><span class="w"> </span><span class="o">-</span><span class="n">O</span><span class="w"> </span><span class="o">--</span><span class="n">allow</span><span class="o">-</span><span class="n">precompiled</span><span class="w"> </span><span class="o">--</span><span class="n">invoke</span><span class="w"> </span><span class="n">wasm_kernel_run</span><span class="w"> </span><span class="n">wasmibox</span><span class="p">.</span><span class="n">cwasm</span><span class="w"></span>
<span class="w">  </span><span class="n">Time</span><span class="w"> </span><span class="p">(</span><span class="n">mean</span><span class="w"> </span><span class="err">±</span><span class="w"> </span><span class="err">σ</span><span class="p">)</span>:      <span class="mf">6.111</span><span class="w"> </span><span class="n">s</span><span class="w"> </span><span class="err">±</span><span class="w">  </span><span class="mf">0.050</span><span class="w"> </span><span class="n">s</span><span class="w">    </span><span class="p">[</span><span class="n">User</span>: <span class="mf">6.094</span><span class="w"> </span><span class="n">s</span><span class="p">,</span><span class="w"> </span><span class="n">System</span>: <span class="mf">0.014</span><span class="w"> </span><span class="n">s</span><span class="p">]</span><span class="w"></span>
<span class="w">  </span><span class="n">Range</span><span class="w"> </span><span class="p">(</span><span class="n">min</span><span class="w"> </span><span class="err">…</span><span class="w"> </span><span class="n">max</span><span class="p">)</span>:    <span class="mf">6.044</span><span class="w"> </span><span class="n">s</span><span class="w"> </span><span class="err">…</span><span class="w">  </span><span class="mf">6.226</span><span class="w"> </span><span class="n">s</span><span class="w">    </span><span class="mi">10</span><span class="w"> </span><span class="n">runs</span><span class="w"></span>
</code></pre></div>
<p>I'm confused because not sure how that could possibly be related.<br>
</p>
</blockquote>



<a name="286384333"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%234163%20Add%20a%20basic%20alias%20analysis%20with%20re.../near/286384333" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.234163.20Add.20a.20basic.20alias.20analysis.20with.20re.2E.2E.2E.html#286384333">(Jun 16 2022 at 17:16)</a>:</h4>
<p>pepyakin edited a <a href="https://github.com/bytecodealliance/wasmtime/pull/4163#issuecomment-1157932904">comment</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/4163">issue #4163</a>:</p>
<blockquote>
<p>Well, it gets weird. </p>
<p>If I apply the following change on top of 0824abb</p>
<div class="codehilite" data-code-language="Diff"><pre><span></span><code><span class="gh">diff --cc crates/wasmtime/src/config.rs</span><span class="w"></span>
<span class="gh">index 9c1ed87ca,9c1ed87ca..6e9bcd1f7</span><span class="w"></span>
<span class="gd">--- a/crates/wasmtime/src/config.rs</span><span class="w"></span>
<span class="gi">+++ b/crates/wasmtime/src/config.rs</span><span class="w"></span>
<span class="gu">@@@ -1287,6 -1287,6 +1287,7 @@@ fn compiler_builder(strategy: Strategy</span><span class="w"></span>
<span class="w"> </span>             },<span class="w"></span>
<span class="w"> </span>         )<span class="w"></span>
<span class="w"> </span>         .unwrap();<span class="w"></span>
<span class="gi">++    builder.set("enable_pinned_reg", "true").unwrap();</span><span class="w"></span>
<span class="w"> </span>     Ok(builder)<span class="w"></span>
<span class="w"> </span> }<span class="w"></span>

<span class="gh">diff --cc crates/wasmtime/src/engine.rs</span><span class="w"></span>
<span class="gh">index c81ae6e67,c81ae6e67..cc150af3a</span><span class="w"></span>
<span class="gd">--- a/crates/wasmtime/src/engine.rs</span><span class="w"></span>
<span class="gi">+++ b/crates/wasmtime/src/engine.rs</span><span class="w"></span>
<span class="gu">@@@ -312,7 -312,7 +312,7 @@@ impl Engine</span><span class="w"></span>
<span class="w"> </span>             "baldrdash_prologue_words" =&gt; *value == FlagValue::Num(0),<span class="w"></span>
<span class="w"> </span>             "enable_llvm_abi_extensions" =&gt; *value == FlagValue::Bool(false),<span class="w"></span>
<span class="w"> </span>             "emit_all_ones_funcaddrs" =&gt; *value == FlagValue::Bool(false),<span class="w"></span>
<span class="gd">--            "enable_pinned_reg" =&gt; *value == FlagValue::Bool(false),</span><span class="w"></span>
<span class="gi">++            "enable_pinned_reg" =&gt; *value == FlagValue::Bool(true),</span><span class="w"></span>
<span class="w"> </span>             "enable_probestack" =&gt; *value == FlagValue::Bool(false),<span class="w"></span>
<span class="w"> </span>             "use_colocated_libcalls" =&gt; *value == FlagValue::Bool(false),<span class="w"></span>
<span class="w"> </span>             "use_pinned_reg_as_heap_base" =&gt; *value == FlagValue::Bool(false),<span class="w"></span>
</code></pre></div>
<p>then the result would be like this:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="n">Benchmark</span><span class="w"> </span><span class="mi">1</span>: <span class="p">.</span><span class="o">/</span><span class="n">target</span><span class="o">/</span><span class="n">release</span><span class="o">/</span><span class="n">wasmtime</span><span class="w"> </span><span class="n">run</span><span class="w"> </span><span class="o">-</span><span class="n">g</span><span class="w"> </span><span class="o">-</span><span class="n">O</span><span class="w"> </span><span class="o">--</span><span class="n">allow</span><span class="o">-</span><span class="n">precompiled</span><span class="w"> </span><span class="o">--</span><span class="n">invoke</span><span class="w"> </span><span class="n">wasm_kernel_run</span><span class="w"> </span><span class="n">wasmibox</span><span class="p">.</span><span class="n">cwasm</span><span class="w"></span>
<span class="w">  </span><span class="n">Time</span><span class="w"> </span><span class="p">(</span><span class="n">mean</span><span class="w"> </span><span class="err">±</span><span class="w"> </span><span class="err">σ</span><span class="p">)</span>:      <span class="mf">6.111</span><span class="w"> </span><span class="n">s</span><span class="w"> </span><span class="err">±</span><span class="w">  </span><span class="mf">0.050</span><span class="w"> </span><span class="n">s</span><span class="w">    </span><span class="p">[</span><span class="n">User</span>: <span class="mf">6.094</span><span class="w"> </span><span class="n">s</span><span class="p">,</span><span class="w"> </span><span class="n">System</span>: <span class="mf">0.014</span><span class="w"> </span><span class="n">s</span><span class="p">]</span><span class="w"></span>
<span class="w">  </span><span class="n">Range</span><span class="w"> </span><span class="p">(</span><span class="n">min</span><span class="w"> </span><span class="err">…</span><span class="w"> </span><span class="n">max</span><span class="p">)</span>:    <span class="mf">6.044</span><span class="w"> </span><span class="n">s</span><span class="w"> </span><span class="err">…</span><span class="w">  </span><span class="mf">6.226</span><span class="w"> </span><span class="n">s</span><span class="w">    </span><span class="mi">10</span><span class="w"> </span><span class="n">runs</span><span class="w"></span>
</code></pre></div>
<p>i.e. the regression disappears.</p>
<p>I'm confused because not sure how that could possibly be related.<br>
</p>
</blockquote>



<a name="286540301"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%234163%20Add%20a%20basic%20alias%20analysis%20with%20re.../near/286540301" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.234163.20Add.20a.20basic.20alias.20analysis.20with.20re.2E.2E.2E.html#286540301">(Jun 17 2022 at 20:41)</a>:</h4>
<p>cfallin <a href="https://github.com/bytecodealliance/wasmtime/pull/4163#issuecomment-1159213574">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/4163">issue #4163</a>:</p>
<blockquote>
<p>@pepyakin I'm happy to take a look at this next week (I'm out of office now); can you publish the .wasm somewhere in the meantime?</p>
</blockquote>



<a name="286643094"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%234163%20Add%20a%20basic%20alias%20analysis%20with%20re.../near/286643094" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.234163.20Add.20a.20basic.20alias.20analysis.20with.20re.2E.2E.2E.html#286643094">(Jun 18 2022 at 10:16)</a>:</h4>
<p>pepyakin <a href="https://github.com/bytecodealliance/wasmtime/pull/4163#issuecomment-1159433674">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/4163">issue #4163</a>:</p>
<blockquote>
<p>Sure! </p>
<p><a href="https://github.com/bytecodealliance/wasmtime/files/8933348/wasmibox.wasm.gz">wasmibox.wasm.gz</a><br>
</p>
</blockquote>



<a name="286643498"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%234163%20Add%20a%20basic%20alias%20analysis%20with%20re.../near/286643498" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.234163.20Add.20a.20basic.20alias.20analysis.20with.20re.2E.2E.2E.html#286643498">(Jun 18 2022 at 10:26)</a>:</h4>
<p>pepyakin edited a <a href="https://github.com/bytecodealliance/wasmtime/pull/4163#issuecomment-1157890369">comment</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/4163">issue #4163</a>:</p>
<blockquote>
<p>FWIW, I've noticed around ≈15% regression and bisection points on this commit.</p>
<p>the results for 0824abb:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="p">.</span><span class="o">/</span><span class="n">target</span><span class="o">/</span><span class="n">release</span><span class="o">/</span><span class="n">wasmtime</span><span class="w"> </span><span class="n">compile</span><span class="w"> </span><span class="o">-</span><span class="n">g</span><span class="w"> </span><span class="o">-</span><span class="n">O</span><span class="w"> </span><span class="n">wasmibox</span><span class="p">.</span><span class="n">wasm</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="p">,</span><span class="w"> </span><span class="n">hyperfine</span><span class="w"> </span><span class="o">--</span><span class="n">show</span><span class="o">-</span><span class="n">output</span><span class="w"> </span><span class="o">--</span><span class="n">warmup</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="s">"./target/release/wasmtime run -g -O --allow-precompiled --invoke wasm_kernel_run wasmibox.cwasm"</span><span class="w"></span>
<span class="n">Benchmark</span><span class="w"> </span><span class="mi">1</span>: <span class="p">.</span><span class="o">/</span><span class="n">target</span><span class="o">/</span><span class="n">release</span><span class="o">/</span><span class="n">wasmtime</span><span class="w"> </span><span class="n">run</span><span class="w"> </span><span class="o">-</span><span class="n">g</span><span class="w"> </span><span class="o">-</span><span class="n">O</span><span class="w"> </span><span class="o">--</span><span class="n">allow</span><span class="o">-</span><span class="n">precompiled</span><span class="w"> </span><span class="o">--</span><span class="n">invoke</span><span class="w"> </span><span class="n">wasm_kernel_run</span><span class="w"> </span><span class="n">wasmibox</span><span class="p">.</span><span class="n">cwasm</span><span class="w"></span>
<span class="w">  </span><span class="n">Time</span><span class="w"> </span><span class="p">(</span><span class="n">mean</span><span class="w"> </span><span class="err">±</span><span class="w"> </span><span class="err">σ</span><span class="p">)</span>:      <span class="mf">7.098</span><span class="w"> </span><span class="n">s</span><span class="w"> </span><span class="err">±</span><span class="w">  </span><span class="mf">0.033</span><span class="w"> </span><span class="n">s</span><span class="w">    </span><span class="p">[</span><span class="n">User</span>: <span class="mf">7.080</span><span class="w"> </span><span class="n">s</span><span class="p">,</span><span class="w"> </span><span class="n">System</span>: <span class="mf">0.015</span><span class="w"> </span><span class="n">s</span><span class="p">]</span><span class="w"></span>
<span class="w">  </span><span class="n">Range</span><span class="w"> </span><span class="p">(</span><span class="n">min</span><span class="w"> </span><span class="err">…</span><span class="w"> </span><span class="n">max</span><span class="p">)</span>:    <span class="mf">7.018</span><span class="w"> </span><span class="n">s</span><span class="w"> </span><span class="err">…</span><span class="w">  </span><span class="mf">7.146</span><span class="w"> </span><span class="n">s</span><span class="w">    </span><span class="mi">10</span><span class="w"> </span><span class="n">runs</span><span class="w"></span>
</code></pre></div>
<p>previous good, 89ccc56:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="p">.</span><span class="o">/</span><span class="n">target</span><span class="o">/</span><span class="n">release</span><span class="o">/</span><span class="n">wasmtime</span><span class="w"> </span><span class="n">compile</span><span class="w"> </span><span class="o">-</span><span class="n">g</span><span class="w"> </span><span class="o">-</span><span class="n">O</span><span class="w"> </span><span class="n">wasmibox</span><span class="p">.</span><span class="n">wasm</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="p">,</span><span class="w"> </span><span class="n">hyperfine</span><span class="w"> </span><span class="o">--</span><span class="n">show</span><span class="o">-</span><span class="n">output</span><span class="w"> </span><span class="o">--</span><span class="n">warmup</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="s">"./target/release/wasmtime run -g -O --allow-precompiled --invoke wasm_kernel_run wasmibox.cwasm"</span><span class="w"></span>
<span class="n">Benchmark</span><span class="w"> </span><span class="mi">1</span>: <span class="p">.</span><span class="o">/</span><span class="n">target</span><span class="o">/</span><span class="n">release</span><span class="o">/</span><span class="n">wasmtime</span><span class="w"> </span><span class="n">run</span><span class="w"> </span><span class="o">-</span><span class="n">g</span><span class="w"> </span><span class="o">-</span><span class="n">O</span><span class="w"> </span><span class="o">--</span><span class="n">allow</span><span class="o">-</span><span class="n">precompiled</span><span class="w"> </span><span class="o">--</span><span class="n">invoke</span><span class="w"> </span><span class="n">wasm_kernel_run</span><span class="w"> </span><span class="n">wasmibox</span><span class="p">.</span><span class="n">cwasm</span><span class="w"></span>
<span class="w">  </span><span class="n">Time</span><span class="w"> </span><span class="p">(</span><span class="n">mean</span><span class="w"> </span><span class="err">±</span><span class="w"> </span><span class="err">σ</span><span class="p">)</span>:      <span class="mf">6.071</span><span class="w"> </span><span class="n">s</span><span class="w"> </span><span class="err">±</span><span class="w">  </span><span class="mf">0.039</span><span class="w"> </span><span class="n">s</span><span class="w">    </span><span class="p">[</span><span class="n">User</span>: <span class="mf">6.052</span><span class="w"> </span><span class="n">s</span><span class="p">,</span><span class="w"> </span><span class="n">System</span>: <span class="mf">0.016</span><span class="w"> </span><span class="n">s</span><span class="p">]</span><span class="w"></span>
<span class="w">  </span><span class="n">Range</span><span class="w"> </span><span class="p">(</span><span class="n">min</span><span class="w"> </span><span class="err">…</span><span class="w"> </span><span class="n">max</span><span class="p">)</span>:    <span class="mf">6.024</span><span class="w"> </span><span class="n">s</span><span class="w"> </span><span class="err">…</span><span class="w">  </span><span class="mf">6.153</span><span class="w"> </span><span class="n">s</span><span class="w">    </span><span class="mi">10</span><span class="w"> </span><span class="n">runs</span><span class="w"></span>
</code></pre></div>
<p>This particular benchmark is a standalone wasm file, i.e. no imports. The entry point loads a test wasm binary and interprets it with compiled in wasmi. The test binary is also standalone. The test wasm generates random numbers using xorshift and takes keccak hash out of it. I can publish the wasm or the source to get the wasm.</p>
<p>UPD: </p>
<p>uname: Linux hetzner 5.10.78 #1-NixOS SMP Sat Nov 6 13:10:10 UTC 2021 x86_64 GNU/Linux<br>
CPU: AMD Ryzen 9 5950X 16-Core Processor</p>
</blockquote>



<a name="287779954"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%234163%20Add%20a%20basic%20alias%20analysis%20with%20re.../near/287779954" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.234163.20Add.20a.20basic.20alias.20analysis.20with.20re.2E.2E.2E.html#287779954">(Jun 28 2022 at 21:43)</a>:</h4>
<p>cfallin <a href="https://github.com/bytecodealliance/wasmtime/pull/4163#issuecomment-1169303683">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/4163">issue #4163</a>:</p>
<blockquote>
<p>@pepyakin I'm just getting to this now (sorry for the delay!) and I'm actually seeing a <em>speedup</em> from alias analysis, consistently, of about 6% (6.2s to 5.8s):</p>
<div class="codehilite" data-code-language="plain"><pre><span></span><code>[cfallin@xap]~/work/wasmtime% time target/release/wasmtime run --allow-precompiled wasmibox_no_aa.cwasm --invoke wasm_kernel_run
target/release/wasmtime run --allow-precompiled wasmibox_no_aa.cwasm --invoke  6.22s user 0.01s system 99% cpu 6.246 total
[cfallin@xap]~/work/wasmtime% time target/release/wasmtime run --allow-precompiled wasmibox_aa.cwasm --invoke wasm_kernel_run
target/release/wasmtime run --allow-precompiled wasmibox_aa.cwasm --invoke   5.84s user 0.01s system 99% cpu 5.856 total
[cfallin@xap]~/work/wasmtime% time target/release/wasmtime run --allow-precompiled wasmibox_no_aa.cwasm --invoke wasm_kernel_run
target/release/wasmtime run --allow-precompiled wasmibox_no_aa.cwasm --invoke  6.19s user 0.01s system 99% cpu 6.216 total
[cfallin@xap]~/work/wasmtime% time target/release/wasmtime run --allow-precompiled wasmibox_aa.cwasm --invoke wasm_kernel_run
target/release/wasmtime run --allow-precompiled wasmibox_aa.cwasm --invoke   5.85s user 0.01s system 99% cpu 5.868 total
[cfallin@xap]~/work/wasmtime% time target/release/wasmtime run --allow-precompiled wasmibox_no_aa.cwasm --invoke wasm_kernel_run
target/release/wasmtime run --allow-precompiled wasmibox_no_aa.cwasm --invoke  6.22s user 0.01s system 99% cpu 6.242 total
[cfallin@xap]~/work/wasmtime% time target/release/wasmtime run --allow-precompiled wasmibox_aa.cwasm --invoke wasm_kernel_run
target/release/wasmtime run --allow-precompiled wasmibox_aa.cwasm --invoke   5.77s user 0.01s system 99% cpu 5.792 total
</code></pre></div>
<p>These were built with current <code>main</code> (<code>c1b3962f7b9fc1c193e1b9709db64c455699a295</code>) with <a href="https://gist.github.com/cfallin/e519aafe03b56bb5ba18bfd029388533">this patch</a> to make alias analysis / redundant-load elimination optional; then</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="cp">$</span><span class="w"> </span><span class="n">wasmtime</span><span class="w"> </span><span class="n">compile</span><span class="w"> </span><span class="o">--</span><span class="n">cranelift</span><span class="o">-</span><span class="n">set</span><span class="w"> </span><span class="n">opt_level</span><span class="o">=</span><span class="n">speed</span><span class="w"> </span><span class="o">--</span><span class="n">cranelift</span><span class="o">-</span><span class="n">set</span><span class="w"> </span><span class="n">enable_alias_analysis</span><span class="o">=</span><span class="kc">true</span><span class="w"> </span><span class="n">wasmibox</span><span class="p">.</span><span class="n">wasm</span><span class="w"> </span><span class="o">-</span><span class="n">o</span><span class="w"> </span><span class="n">wasmibox_aa</span><span class="p">.</span><span class="n">cwasm</span><span class="w"></span>
<span class="cp">$</span><span class="w"> </span><span class="n">wasmtime</span><span class="w"> </span><span class="n">compile</span><span class="w"> </span><span class="o">--</span><span class="n">cranelift</span><span class="o">-</span><span class="n">set</span><span class="w"> </span><span class="n">opt_level</span><span class="o">=</span><span class="n">speed</span><span class="w"> </span><span class="o">--</span><span class="n">cranelift</span><span class="o">-</span><span class="n">set</span><span class="w"> </span><span class="n">enable_alias_analysis</span><span class="o">=</span><span class="kc">false</span><span class="w"> </span><span class="n">wasmibox</span><span class="p">.</span><span class="n">wasm</span><span class="w"> </span><span class="o">-</span><span class="n">o</span><span class="w"> </span><span class="n">wasmibox_no_aa</span><span class="p">.</span><span class="n">cwasm</span><span class="w"></span>
</code></pre></div>
<p>and I double-checked I wasn't swapping the two. Looking at a diff of the disassemblies, it's sort of what I expect: a few extra loads are removed and carried in registers instead, and this I would indeed expect to improve performance, as it does.</p>
<p>Can you confirm you're still seeing a slowdown, not speedup, and if so at which commit and anything else about your environment and measurements?</p>
</blockquote>



<a name="288393595"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%234163%20Add%20a%20basic%20alias%20analysis%20with%20re.../near/288393595" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.234163.20Add.20a.20basic.20alias.20analysis.20with.20re.2E.2E.2E.html#288393595">(Jul 04 2022 at 10:43)</a>:</h4>
<p>pepyakin <a href="https://github.com/bytecodealliance/wasmtime/pull/4163#issuecomment-1173662729">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/4163">issue #4163</a>:</p>
<blockquote>
<p>With the following script:</p>
<div class="codehilite" data-code-language="Bash"><pre><span></span><code>./wasmtime-0824abbae compile -g -O wasmibox.wasm -o wasmibox-0824abbae.cwasm
./wasmtime-89ccc56e4 compile -g -O wasmibox.wasm -o wasmibox-89ccc56e4.cwasm
./wasmtime-a2197ebbe compile -g -O wasmibox.wasm --cranelift-set <span class="nv">enable_alias_analysis</span><span class="o">=</span><span class="nb">true</span> -o wasmibox-a2197ebbe-aa.cwasm
./wasmtime-a2197ebbe compile -g -O wasmibox.wasm --cranelift-set <span class="nv">enable_alias_analysis</span><span class="o">=</span><span class="nb">false</span> -o wasmibox-a2197ebbe-no-aa.cwasm

hyperfine --show-output --warmup <span class="m">2</span> <span class="s2">"./wasmtime-0824abbae run -g --allow-precompiled -O wasmibox-0824abbae.cwasm --invoke wasm_kernel_run"</span>
hyperfine --show-output --warmup <span class="m">2</span> <span class="s2">"./wasmtime-89ccc56e4 run -g --allow-precompiled -O wasmibox-89ccc56e4.cwasm --invoke wasm_kernel_run"</span>
hyperfine --show-output --warmup <span class="m">2</span>  <span class="s2">"./wasmtime-a2197ebbe run -g --allow-precompiled -O wasmibox-a2197ebbe-aa.cwasm --invoke wasm_kernel_run"</span>
hyperfine --show-output --warmup <span class="m">2</span> <span class="s2">"./wasmtime-a2197ebbe run -g --allow-precompiled -O wasmibox-a2197ebbe-no-aa.cwasm --invoke wasm_kernel_run"</span><span class="sb">```</span>

I am getting the following results:

<span class="sb">```</span>shell
++ hyperfine --show-output --warmup <span class="m">2</span> <span class="s1">'./wasmtime-0824abbae run -g --allow-precompiled -O wasmibox-0824abbae.cwasm --invoke wasm_kernel_run'</span>
Benchmark <span class="m">1</span>: ./wasmtime-0824abbae run -g --allow-precompiled -O wasmibox-0824abbae.cwasm --invoke wasm_kernel_run
  Time <span class="o">(</span>mean ± σ<span class="o">)</span>:      <span class="m">6</span>.887 s ±  <span class="m">0</span>.046 s    <span class="o">[</span>User: <span class="m">6</span>.872 s, System: <span class="m">0</span>.013 s<span class="o">]</span>
  Range <span class="o">(</span>min … max<span class="o">)</span>:    <span class="m">6</span>.848 s …  <span class="m">6</span>.990 s    <span class="m">10</span> runs

++ hyperfine --show-output --warmup <span class="m">2</span> <span class="s1">'./wasmtime-89ccc56e4 run -g --allow-precompiled -O wasmibox-89ccc56e4.cwasm --invoke wasm_kernel_run'</span>
Benchmark <span class="m">1</span>: ./wasmtime-89ccc56e4 run -g --allow-precompiled -O wasmibox-89ccc56e4.cwasm --invoke wasm_kernel_run
  Time <span class="o">(</span>mean ± σ<span class="o">)</span>:      <span class="m">5</span>.941 s ±  <span class="m">0</span>.024 s    <span class="o">[</span>User: <span class="m">5</span>.927 s, System: <span class="m">0</span>.013 s<span class="o">]</span>
  Range <span class="o">(</span>min … max<span class="o">)</span>:    <span class="m">5</span>.914 s …  <span class="m">5</span>.978 s    <span class="m">10</span> runs

++ hyperfine --show-output --warmup <span class="m">2</span> <span class="s1">'./wasmtime-a2197ebbe run -g --allow-precompiled -O wasmibox-a2197ebbe-aa.cwasm --invoke wasm_kernel_run'</span>
Benchmark <span class="m">1</span>: ./wasmtime-a2197ebbe run -g --allow-precompiled -O wasmibox-a2197ebbe-aa.cwasm --invoke wasm_kernel_run
  Time <span class="o">(</span>mean ± σ<span class="o">)</span>:      <span class="m">4</span>.666 s ±  <span class="m">0</span>.037 s    <span class="o">[</span>User: <span class="m">4</span>.651 s, System: <span class="m">0</span>.013 s<span class="o">]</span>
  Range <span class="o">(</span>min … max<span class="o">)</span>:    <span class="m">4</span>.627 s …  <span class="m">4</span>.743 s    <span class="m">10</span> runs

++ hyperfine --show-output --warmup <span class="m">2</span> <span class="s1">'./wasmtime-a2197ebbe run -g --allow-precompiled -O wasmibox-a2197ebbe-no-aa.cwasm --invoke wasm_kernel_run'</span>
Benchmark <span class="m">1</span>: ./wasmtime-a2197ebbe run -g --allow-precompiled -O wasmibox-a2197ebbe-no-aa.cwasm --invoke wasm_kernel_run
  Time <span class="o">(</span>mean ± σ<span class="o">)</span>:      <span class="m">4</span>.524 s ±  <span class="m">0</span>.133 s    <span class="o">[</span>User: <span class="m">4</span>.510 s, System: <span class="m">0</span>.013 s<span class="o">]</span>
  Range <span class="o">(</span>min … max<span class="o">)</span>:    <span class="m">4</span>.472 s …  <span class="m">4</span>.898 s    <span class="m">10</span> runs
</code></pre></div>
<p>It confirms that on my machine the pre-AA commit performs considerably better than the commit when AA was introduced. The current main performs better than both of them regardless if AA is enabled or not. No AA performs better than with AA on main though.</p>
<p>However, if I remove the <code>-g</code> flag then the whole picture changes:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="o">++</span><span class="w"> </span><span class="n">hyperfine</span><span class="w"> </span><span class="o">--</span><span class="n">show</span><span class="o">-</span><span class="n">output</span><span class="w"> </span><span class="o">--</span><span class="n">warmup</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="o">'</span><span class="p">.</span><span class="o">/</span><span class="n">wasmtime</span><span class="o">-</span><span class="mi">0824</span><span class="n">abbae</span><span class="w"> </span><span class="n">run</span><span class="w"> </span><span class="o">--</span><span class="n">allow</span><span class="o">-</span><span class="n">precompiled</span><span class="w"> </span><span class="o">-</span><span class="n">O</span><span class="w"> </span><span class="n">wasmibox</span><span class="o">-</span><span class="mi">0824</span><span class="n">abbae</span><span class="p">.</span><span class="n">cwasm</span><span class="w"> </span><span class="o">--</span><span class="n">invoke</span><span class="w"> </span><span class="n">wasm_kernel_run</span><span class="o">'</span><span class="w"></span>
<span class="n">Benchmark</span><span class="w"> </span><span class="mi">1</span>: <span class="p">.</span><span class="o">/</span><span class="n">wasmtime</span><span class="o">-</span><span class="mi">0824</span><span class="n">abbae</span><span class="w"> </span><span class="n">run</span><span class="w"> </span><span class="o">--</span><span class="n">allow</span><span class="o">-</span><span class="n">precompiled</span><span class="w"> </span><span class="o">-</span><span class="n">O</span><span class="w"> </span><span class="n">wasmibox</span><span class="o">-</span><span class="mi">0824</span><span class="n">abbae</span><span class="p">.</span><span class="n">cwasm</span><span class="w"> </span><span class="o">--</span><span class="n">invoke</span><span class="w"> </span><span class="n">wasm_kernel_run</span><span class="w"></span>
<span class="w">  </span><span class="n">Time</span><span class="w"> </span><span class="p">(</span><span class="n">mean</span><span class="w"> </span><span class="err">±</span><span class="w"> </span><span class="err">σ</span><span class="p">)</span>:      <span class="mf">5.826</span><span class="w"> </span><span class="n">s</span><span class="w"> </span><span class="err">±</span><span class="w">  </span><span class="mf">0.082</span><span class="w"> </span><span class="n">s</span><span class="w">    </span><span class="p">[</span><span class="n">User</span>: <span class="mf">5.815</span><span class="w"> </span><span class="n">s</span><span class="p">,</span><span class="w"> </span><span class="n">System</span>: <span class="mf">0.010</span><span class="w"> </span><span class="n">s</span><span class="p">]</span><span class="w"></span>
<span class="w">  </span><span class="n">Range</span><span class="w"> </span><span class="p">(</span><span class="n">min</span><span class="w"> </span><span class="err">…</span><span class="w"> </span><span class="n">max</span><span class="p">)</span>:    <span class="mf">5.759</span><span class="w"> </span><span class="n">s</span><span class="w"> </span><span class="err">…</span><span class="w">  </span><span class="mf">6.040</span><span class="w"> </span><span class="n">s</span><span class="w">    </span><span class="mi">10</span><span class="w"> </span><span class="n">runs</span><span class="w"></span>

<span class="o">++</span><span class="w"> </span><span class="n">hyperfine</span><span class="w"> </span><span class="o">--</span><span class="n">show</span><span class="o">-</span><span class="n">output</span><span class="w"> </span><span class="o">--</span><span class="n">warmup</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="o">'</span><span class="p">.</span><span class="o">/</span><span class="n">wasmtime</span><span class="o">-</span><span class="mi">89</span><span class="n">ccc56e4</span><span class="w"> </span><span class="n">run</span><span class="w"> </span><span class="o">--</span><span class="n">allow</span><span class="o">-</span><span class="n">precompiled</span><span class="w"> </span><span class="o">-</span><span class="n">O</span><span class="w"> </span><span class="n">wasmibox</span><span class="o">-</span><span class="mi">89</span><span class="n">ccc56e4</span><span class="p">.</span><span class="n">cwasm</span><span class="w"> </span><span class="o">--</span><span class="n">invoke</span><span class="w"> </span><span class="n">wasm_kernel_run</span><span class="o">'</span><span class="w"></span>
<span class="n">Benchmark</span><span class="w"> </span><span class="mi">1</span>: <span class="p">.</span><span class="o">/</span><span class="n">wasmtime</span><span class="o">-</span><span class="mi">89</span><span class="n">ccc56e4</span><span class="w"> </span><span class="n">run</span><span class="w"> </span><span class="o">--</span><span class="n">allow</span><span class="o">-</span><span class="n">precompiled</span><span class="w"> </span><span class="o">-</span><span class="n">O</span><span class="w"> </span><span class="n">wasmibox</span><span class="o">-</span><span class="mi">89</span><span class="n">ccc56e4</span><span class="p">.</span><span class="n">cwasm</span><span class="w"> </span><span class="o">--</span><span class="n">invoke</span><span class="w"> </span><span class="n">wasm_kernel_run</span><span class="w"></span>
<span class="w">  </span><span class="n">Time</span><span class="w"> </span><span class="p">(</span><span class="n">mean</span><span class="w"> </span><span class="err">±</span><span class="w"> </span><span class="err">σ</span><span class="p">)</span>:      <span class="mf">6.600</span><span class="w"> </span><span class="n">s</span><span class="w"> </span><span class="err">±</span><span class="w">  </span><span class="mf">0.073</span><span class="w"> </span><span class="n">s</span><span class="w">    </span><span class="p">[</span><span class="n">User</span>: <span class="mf">6.589</span><span class="w"> </span><span class="n">s</span><span class="p">,</span><span class="w"> </span><span class="n">System</span>: <span class="mf">0.009</span><span class="w"> </span><span class="n">s</span><span class="p">]</span><span class="w"></span>
<span class="w">  </span><span class="n">Range</span><span class="w"> </span><span class="p">(</span><span class="n">min</span><span class="w"> </span><span class="err">…</span><span class="w"> </span><span class="n">max</span><span class="p">)</span>:    <span class="mf">6.543</span><span class="w"> </span><span class="n">s</span><span class="w"> </span><span class="err">…</span><span class="w">  </span><span class="mf">6.722</span><span class="w"> </span><span class="n">s</span><span class="w">    </span><span class="mi">10</span><span class="w"> </span><span class="n">runs</span><span class="w"></span>

<span class="o">++</span><span class="w"> </span><span class="n">hyperfine</span><span class="w"> </span><span class="o">--</span><span class="n">show</span><span class="o">-</span><span class="n">output</span><span class="w"> </span><span class="o">--</span><span class="n">warmup</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="o">'</span><span class="p">.</span><span class="o">/</span><span class="n">wasmtime</span><span class="o">-</span><span class="n">a2197ebbe</span><span class="w"> </span><span class="n">run</span><span class="w"> </span><span class="o">--</span><span class="n">allow</span><span class="o">-</span><span class="n">precompiled</span><span class="w"> </span><span class="o">-</span><span class="n">O</span><span class="w"> </span><span class="n">wasmibox</span><span class="o">-</span><span class="n">a2197ebbe</span><span class="o">-</span><span class="n">aa</span><span class="p">.</span><span class="n">cwasm</span><span class="w"> </span><span class="o">--</span><span class="n">invoke</span><span class="w"> </span><span class="n">wasm_kernel_run</span><span class="o">'</span><span class="w"></span>
<span class="n">Benchmark</span><span class="w"> </span><span class="mi">1</span>: <span class="p">.</span><span class="o">/</span><span class="n">wasmtime</span><span class="o">-</span><span class="n">a2197ebbe</span><span class="w"> </span><span class="n">run</span><span class="w"> </span><span class="o">--</span><span class="n">allow</span><span class="o">-</span><span class="n">precompiled</span><span class="w"> </span><span class="o">-</span><span class="n">O</span><span class="w"> </span><span class="n">wasmibox</span><span class="o">-</span><span class="n">a2197ebbe</span><span class="o">-</span><span class="n">aa</span><span class="p">.</span><span class="n">cwasm</span><span class="w"> </span><span class="o">--</span><span class="n">invoke</span><span class="w"> </span><span class="n">wasm_kernel_run</span><span class="w"></span>
<span class="w">  </span><span class="n">Time</span><span class="w"> </span><span class="p">(</span><span class="n">mean</span><span class="w"> </span><span class="err">±</span><span class="w"> </span><span class="err">σ</span><span class="p">)</span>:      <span class="mf">4.375</span><span class="w"> </span><span class="n">s</span><span class="w"> </span><span class="err">±</span><span class="w">  </span><span class="mf">0.013</span><span class="w"> </span><span class="n">s</span><span class="w">    </span><span class="p">[</span><span class="n">User</span>: <span class="mf">4.364</span><span class="w"> </span><span class="n">s</span><span class="p">,</span><span class="w"> </span><span class="n">System</span>: <span class="mf">0.010</span><span class="w"> </span><span class="n">s</span><span class="p">]</span><span class="w"></span>
<span class="w">  </span><span class="n">Range</span><span class="w"> </span><span class="p">(</span><span class="n">min</span><span class="w"> </span><span class="err">…</span><span class="w"> </span><span class="n">max</span><span class="p">)</span>:    <span class="mf">4.364</span><span class="w"> </span><span class="n">s</span><span class="w"> </span><span class="err">…</span><span class="w">  </span><span class="mf">4.406</span><span class="w"> </span><span class="n">s</span><span class="w">    </span><span class="mi">10</span><span class="w"> </span><span class="n">runs</span><span class="w"></span>

<span class="o">++</span><span class="w"> </span><span class="n">hyperfine</span><span class="w"> </span><span class="o">--</span><span class="n">show</span><span class="o">-</span><span class="n">output</span><span class="w"> </span><span class="o">--</span><span class="n">warmup</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="o">'</span><span class="p">.</span><span class="o">/</span><span class="n">wasmtime</span><span class="o">-</span><span class="n">a2197ebbe</span><span class="w"> </span><span class="n">run</span><span class="w"> </span><span class="o">--</span><span class="n">allow</span><span class="o">-</span><span class="n">precompiled</span><span class="w"> </span><span class="o">-</span><span class="n">O</span><span class="w"> </span><span class="n">wasmibox</span><span class="o">-</span><span class="n">a2197ebbe</span><span class="o">-</span><span class="n">no</span><span class="o">-</span><span class="n">aa</span><span class="p">.</span><span class="n">cwasm</span><span class="w"> </span><span class="o">--</span><span class="n">invoke</span><span class="w"> </span><span class="n">wasm_kernel_run</span><span class="o">'</span><span class="w"></span>
<span class="n">Benchmark</span><span class="w"> </span><span class="mi">1</span>: <span class="p">.</span><span class="o">/</span><span class="n">wasmtime</span><span class="o">-</span><span class="n">a2197ebbe</span><span class="w"> </span><span class="n">run</span><span class="w"> </span><span class="o">--</span><span class="n">allow</span><span class="o">-</span><span class="n">precompiled</span><span class="w"> </span><span class="o">-</span><span class="n">O</span><span class="w"> </span><span class="n">wasmibox</span><span class="o">-</span><span class="n">a2197ebbe</span><span class="o">-</span><span class="n">no</span><span class="o">-</span><span class="n">aa</span><span class="p">.</span><span class="n">cwasm</span><span class="w"> </span><span class="o">--</span><span class="n">invoke</span><span class="w"> </span><span class="n">wasm_kernel_run</span><span class="w"></span>
<span class="w">  </span><span class="n">Time</span><span class="w"> </span><span class="p">(</span><span class="n">mean</span><span class="w"> </span><span class="err">±</span><span class="w"> </span><span class="err">σ</span><span class="p">)</span>:      <span class="mf">4.721</span><span class="w"> </span><span class="n">s</span><span class="w"> </span><span class="err">±</span><span class="w">  </span><span class="mf">0.016</span><span class="w"> </span><span class="n">s</span><span class="w">    </span><span class="p">[</span><span class="n">User</span>: <span class="mf">4.711</span><span class="w"> </span><span class="n">s</span><span class="p">,</span><span class="w"> </span><span class="n">System</span>: <span class="mf">0.009</span><span class="w"> </span><span class="n">s</span><span class="p">]</span><span class="w"></span>
<span class="w">  </span><span class="n">Range</span><span class="w"> </span><span class="p">(</span><span class="n">min</span><span class="w"> </span><span class="err">…</span><span class="w"> </span><span class="n">max</span><span class="p">)</span>:    <span class="mf">4.702</span><span class="w"> </span><span class="n">s</span><span class="w"> </span><span class="err">…</span><span class="w">  </span><span class="mf">4.746</span><span class="w"> </span><span class="n">s</span><span class="w">    </span><span class="mi">10</span><span class="w"> </span><span class="n">runs</span><span class="w"></span>
</code></pre></div>
<p>Now, it starts to make more sense, although I still don't understand how that could be possibly related.</p>
</blockquote>



<a name="288481071"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%234163%20Add%20a%20basic%20alias%20analysis%20with%20re.../near/288481071" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.234163.20Add.20a.20basic.20alias.20analysis.20with.20re.2E.2E.2E.html#288481071">(Jul 05 2022 at 05:42)</a>:</h4>
<p>cfallin <a href="https://github.com/bytecodealliance/wasmtime/pull/4163#issuecomment-1174638355">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/4163">issue #4163</a>:</p>
<blockquote>
<p>OK, I agree that it doesn't make any sense that <code>-g</code> would make the difference here. I suspect either some odd measurement effect or some pessimization caused by debuginfo registration or something like that. Given that (i) the normal config behaves as expected (alias analysis produces a nontrivial speedup), (ii) codegen looks as expected on manual examination (diff of no-AA vs AA in default config on <code>main</code>), and (iii) debuginfo in general is a big mess that needs more focused attention, I don't think I'm able to justify spending significantly more time looking into this; but if you find anything more please let us know.</p>
</blockquote>



<hr><p>Last updated: Jan 20 2025 at 06:04 UTC</p>
</html>