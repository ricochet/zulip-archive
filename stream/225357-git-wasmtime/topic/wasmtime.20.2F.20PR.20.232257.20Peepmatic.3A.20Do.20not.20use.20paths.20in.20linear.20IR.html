<html>
<head><meta charset="utf-8"><title>wasmtime / PR #2257 Peepmatic: Do not use paths in linear IR · git-wasmtime · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/index.html">git-wasmtime</a></h2>
<h3>Topic: <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232257.20Peepmatic.3A.20Do.20not.20use.20paths.20in.20linear.20IR.html">wasmtime / PR #2257 Peepmatic: Do not use paths in linear IR</a></h3>

<hr>

<base href="https://bytecodealliance.zulipchat.com">

<head><link href="https://bytecodealliance.github.io/zulip-archive/style.css" rel="stylesheet"></head>

<a name="212093221"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232257%20Peepmatic%3A%20Do%20not%20use%20paths%20in%20linear%20IR/near/212093221" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232257.20Peepmatic.3A.20Do.20not.20use.20paths.20in.20linear.20IR.html#212093221">(Oct 02 2020 at 15:52)</a>:</h4>
<p>fitzgen opened <a href="https://github.com/bytecodealliance/wasmtime/pull/2257">PR #2257</a> from <code>peepmatic-no-paths-in-linear-ir</code> to <code>main</code>:</p>
<blockquote>
<p>Rather than using paths from the root instruction to the instruction we are matching against or checking if it is constant or whatever, use temporary variables. When we successfully match an instruction's opcode, we simultaneously define these temporaries for the instruction's operands. This is similar to how open-coding these matches in Rust would use <code>match</code> expressions with pattern matching to bind the operands to variables at the same time as switching on the opcode.</p>
<p>This shaves off about 1.8% of instructions retired when Peepmatic is enabled.</p>
<p>@abrown would you be comfortable reviewing this? If not, no worries, I can find another reviewer. Thanks!</p>
</blockquote>



<a name="212093222"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232257%20Peepmatic%3A%20Do%20not%20use%20paths%20in%20linear%20IR/near/212093222" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232257.20Peepmatic.3A.20Do.20not.20use.20paths.20in.20linear.20IR.html#212093222">(Oct 02 2020 at 15:52)</a>:</h4>
<p><strong>fitzgen</strong> requested <a href="https://github.com/abrown">abrown</a> for a review on <a href="https://github.com/bytecodealliance/wasmtime/pull/2257">PR #2257</a>.</p>



<a name="212093590"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232257%20Peepmatic%3A%20Do%20not%20use%20paths%20in%20linear%20IR/near/212093590" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232257.20Peepmatic.3A.20Do.20not.20use.20paths.20in.20linear.20IR.html#212093590">(Oct 02 2020 at 15:55)</a>:</h4>
<p>fitzgen updated <a href="https://github.com/bytecodealliance/wasmtime/pull/2257">PR #2257</a> from <code>peepmatic-no-paths-in-linear-ir</code> to <code>main</code>:</p>
<blockquote>
<p>Rather than using paths from the root instruction to the instruction we are matching against or checking if it is constant or whatever, use temporary variables. When we successfully match an instruction's opcode, we simultaneously define these temporaries for the instruction's operands. This is similar to how open-coding these matches in Rust would use <code>match</code> expressions with pattern matching to bind the operands to variables at the same time as switching on the opcode.</p>
<p>This shaves off about 1.8% of instructions retired when Peepmatic is enabled.</p>
<p>@abrown would you be comfortable reviewing this? If not, no worries, I can find another reviewer. Thanks!</p>
</blockquote>



<a name="212592048"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232257%20Peepmatic%3A%20Do%20not%20use%20paths%20in%20linear%20IR/near/212592048" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232257.20Peepmatic.3A.20Do.20not.20use.20paths.20in.20linear.20IR.html#212592048">(Oct 07 2020 at 17:28)</a>:</h4>
<p>abrown submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/2257#pullrequestreview-504106482">PR Review</a>.</p>



<a name="212592051"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232257%20Peepmatic%3A%20Do%20not%20use%20paths%20in%20linear%20IR/near/212592051" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232257.20Peepmatic.3A.20Do.20not.20use.20paths.20in.20linear.20IR.html#212592051">(Oct 07 2020 at 17:28)</a>:</h4>
<p>abrown submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/2257#pullrequestreview-504106482">PR Review</a>.</p>



<a name="212592052"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232257%20Peepmatic%3A%20Do%20not%20use%20paths%20in%20linear%20IR/near/212592052" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232257.20Peepmatic.3A.20Do.20not.20use.20paths.20in.20linear.20IR.html#212592052">(Oct 07 2020 at 17:28)</a>:</h4>
<p>abrown created <a href="https://github.com/bytecodealliance/wasmtime/pull/2257#discussion_r501186045">PR Review Comment</a>:</p>
<blockquote>
<p>Remove?</p>
</blockquote>



<a name="212592053"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232257%20Peepmatic%3A%20Do%20not%20use%20paths%20in%20linear%20IR/near/212592053" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232257.20Peepmatic.3A.20Do.20not.20use.20paths.20in.20linear.20IR.html#212592053">(Oct 07 2020 at 17:28)</a>:</h4>
<p>abrown created <a href="https://github.com/bytecodealliance/wasmtime/pull/2257#discussion_r501184590">PR Review Comment</a>:</p>
<blockquote>
<p>I mean, I think I understand why this is necessary but it is a shame not to be able to use <a href="https://docs.rs/cranelift-codegen/0.66.0/cranelift_codegen/ir/instructions/enum.InstructionData.html#method.opcode">opcode</a> and <a href="https://docs.rs/cranelift-codegen/0.66.0/cranelift_codegen/ir/instructions/enum.InstructionData.html#method.arguments">arguments</a> off of <code>InstructionData</code> to make things a bit less verbose.</p>
</blockquote>



<a name="213193849"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232257%20Peepmatic%3A%20Do%20not%20use%20paths%20in%20linear%20IR/near/213193849" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232257.20Peepmatic.3A.20Do.20not.20use.20paths.20in.20linear.20IR.html#213193849">(Oct 13 2020 at 18:03)</a>:</h4>
<p>fitzgen submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/2257#pullrequestreview-507699200">PR Review</a>.</p>



<a name="213193850"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232257%20Peepmatic%3A%20Do%20not%20use%20paths%20in%20linear%20IR/near/213193850" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232257.20Peepmatic.3A.20Do.20not.20use.20paths.20in.20linear.20IR.html#213193850">(Oct 13 2020 at 18:03)</a>:</h4>
<p>fitzgen created <a href="https://github.com/bytecodealliance/wasmtime/pull/2257#discussion_r504153517">PR Review Comment</a>:</p>
<blockquote>
<p>There are two reasons it is the way it currently is:</p>
<ol>
<li>
<p>As written, we avoid matching on the instruction data twice. I've found that sometimes LLVM can collapse these back-to-back matches into a single match, but not always and it's kind of fragile.</p>
</li>
<li>
<p>The branching instructions supported by peepmatic ignore the block arguments, so we can't use <code>arguments</code> directly, we would still need to special case branches.</p>
</li>
</ol>
</blockquote>



<a name="213193868"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232257%20Peepmatic%3A%20Do%20not%20use%20paths%20in%20linear%20IR/near/213193868" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232257.20Peepmatic.3A.20Do.20not.20use.20paths.20in.20linear.20IR.html#213193868">(Oct 13 2020 at 18:03)</a>:</h4>
<p>fitzgen submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/2257#pullrequestreview-507699295">PR Review</a>.</p>



<a name="213193869"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232257%20Peepmatic%3A%20Do%20not%20use%20paths%20in%20linear%20IR/near/213193869" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232257.20Peepmatic.3A.20Do.20not.20use.20paths.20in.20linear.20IR.html#213193869">(Oct 13 2020 at 18:03)</a>:</h4>
<p>fitzgen created <a href="https://github.com/bytecodealliance/wasmtime/pull/2257#discussion_r504153600">PR Review Comment</a>:</p>
<blockquote>
<p>good eye! thanks</p>
</blockquote>



<a name="213194048"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232257%20Peepmatic%3A%20Do%20not%20use%20paths%20in%20linear%20IR/near/213194048" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232257.20Peepmatic.3A.20Do.20not.20use.20paths.20in.20linear.20IR.html#213194048">(Oct 13 2020 at 18:04)</a>:</h4>
<p>fitzgen updated <a href="https://github.com/bytecodealliance/wasmtime/pull/2257">PR #2257</a> from <code>peepmatic-no-paths-in-linear-ir</code> to <code>main</code>:</p>
<blockquote>
<p>Rather than using paths from the root instruction to the instruction we are matching against or checking if it is constant or whatever, use temporary variables. When we successfully match an instruction's opcode, we simultaneously define these temporaries for the instruction's operands. This is similar to how open-coding these matches in Rust would use <code>match</code> expressions with pattern matching to bind the operands to variables at the same time as switching on the opcode.</p>
<p>This shaves off about 1.8% of instructions retired when Peepmatic is enabled.</p>
<p>@abrown would you be comfortable reviewing this? If not, no worries, I can find another reviewer. Thanks!</p>
</blockquote>



<a name="213204413"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232257%20Peepmatic%3A%20Do%20not%20use%20paths%20in%20linear%20IR/near/213204413" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232257.20Peepmatic.3A.20Do.20not.20use.20paths.20in.20linear.20IR.html#213204413">(Oct 13 2020 at 19:18)</a>:</h4>
<p>fitzgen merged <a href="https://github.com/bytecodealliance/wasmtime/pull/2257">PR #2257</a>.</p>



<hr><p>Last updated: Jan 20 2025 at 06:04 UTC</p>
</html>