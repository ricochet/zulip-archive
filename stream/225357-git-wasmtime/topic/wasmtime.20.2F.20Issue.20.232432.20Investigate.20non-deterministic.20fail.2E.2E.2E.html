<html>
<head><meta charset="utf-8"><title>wasmtime / Issue #2432 Investigate non-deterministic fail... · git-wasmtime · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/index.html">git-wasmtime</a></h2>
<h3>Topic: <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20Issue.20.232432.20Investigate.20non-deterministic.20fail.2E.2E.2E.html">wasmtime / Issue #2432 Investigate non-deterministic fail...</a></h3>

<hr>

<base href="https://bytecodealliance.zulipchat.com">

<head><link href="https://bytecodealliance.github.io/zulip-archive/style.css" rel="stylesheet"></head>

<a name="218793654"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20Issue%20%232432%20Investigate%20non-deterministic%20fail.../near/218793654" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20Issue.20.232432.20Investigate.20non-deterministic.20fail.2E.2E.2E.html#218793654">(Dec 04 2020 at 04:37)</a>:</h4>
<p>abrown edited <a href="https://github.com/bytecodealliance/wasmtime/issues/2432">Issue #2432</a>:</p>
<blockquote>
<p>@jlb6740, I am opening this issue to track a failure I noticed with x64 SIMD: <a href="https://github.com/bytecodealliance/wasmtime/pull/2428/checks?check_run_id=1421136203#step:7:1582">https://github.com/bytecodealliance/wasmtime/pull/2428/checks?check_run_id=1421136203#step:7:1582</a></p>
</blockquote>



<a name="219173137"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20Issue%20%232432%20Investigate%20non-deterministic%20fail.../near/219173137" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20Issue.20.232432.20Investigate.20non-deterministic.20fail.2E.2E.2E.html#219173137">(Dec 08 2020 at 05:33)</a>:</h4>
<p>jlb6740 <a href="https://github.com/bytecodealliance/wasmtime/issues/2432#issuecomment-740387997">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/2432">Issue #2432</a>:</p>
<blockquote>
<p>FYI, I am trying to see if I can pinpoint the patch that caused the issue. Basically running:</p>
<blockquote>
<p>cargo test -p wasmtime-cli --features experimental_x64 wast::Cranelift::spec::simd::simd_</p>
</blockquote>
<p>In a loop like so:</p>
<blockquote>
<p>COUNTER=0 &amp;&amp; while [ $COUNTER -lt 1000 ] &amp;&amp; ./run_test.sh &amp;&amp; COUNTER=$((COUNTER+1)) &amp;&amp; echo -e "\n\nIteration: $COUNTER\n\n" ; do :; done | tee run_test.out</p>
</blockquote>
<p>where the cargo test command is in ./run_test.sh.</p>
<p>It seems the failure usually occurs within 100 iterations but can take as long as 200-300. </p>
</blockquote>



<a name="219235636"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20Issue%20%232432%20Investigate%20non-deterministic%20fail.../near/219235636" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20Issue.20.232432.20Investigate.20non-deterministic.20fail.2E.2E.2E.html#219235636">(Dec 08 2020 at 17:25)</a>:</h4>
<p>abrown <a href="https://github.com/bytecodealliance/wasmtime/issues/2432#issuecomment-740780895">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/2432">Issue #2432</a>:</p>
<blockquote>
<p>That's some progress!</p>
</blockquote>



<a name="219237493"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20Issue%20%232432%20Investigate%20non-deterministic%20fail.../near/219237493" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20Issue.20.232432.20Investigate.20non-deterministic.20fail.2E.2E.2E.html#219237493">(Dec 08 2020 at 17:40)</a>:</h4>
<p>julian-seward1 <a href="https://github.com/bytecodealliance/wasmtime/issues/2432#issuecomment-740789845">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/2432">Issue #2432</a>:</p>
<blockquote>
<p>@jlb6740 Can you extract from that, the actual non-shell-script program invokation that  ./run_test.sh` does, that is failing, and then run that on valgrind, to see if something is reading uninitialised memory? </p>
</blockquote>



<a name="219304283"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20Issue%20%232432%20Investigate%20non-deterministic%20fail.../near/219304283" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20Issue.20.232432.20Investigate.20non-deterministic.20fail.2E.2E.2E.html#219304283">(Dec 09 2020 at 07:26)</a>:</h4>
<p>jlb6740 <a href="https://github.com/bytecodealliance/wasmtime/issues/2432#issuecomment-741588488">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/2432">Issue #2432</a>:</p>
<blockquote>
<p>I've been attempting to both (1) isolate the patch where the issue starts and (2) simplify the reproducer but both are proving to be more difficult than anticipated. Some observations .. </p>
<p>W.r.t pinpointing the patch that introduced the issue, I am finding it impossible to reproduce this patch using the script above before <a href="https://github.com/bytecodealliance/wasmtime/pull/2365">https://github.com/bytecodealliance/wasmtime/pull/2365</a> . However I am not thinking this patch introduces this bug since it was seen as earlier as October here: <a href="https://github.com/bytecodealliance/wasmtime/runs/1323686030">https://github.com/bytecodealliance/wasmtime/runs/1323686030</a> </p>
<p>W.r.t. simplifying the reproducer I am finding the error almost always occurs with the same tests involving negation or abs .. test such as:</p>
<p>(assert_return (invoke "add-neg" (v128.const f64x2 1.125 1.125)<br>
                                 (v128.const f64x2 0.125 0.125))<br>
                                 (v128.const f64x2 -1.0 -1.0))</p>
<p>or</p>
<p>(assert_return (invoke "f64x2.abs" (v128.const f64x2 0x1.fffffffffffffp+1023 0x1.fffffffffffffp+1023))<br>
                                   (v128.const f64x2 0x1.fffffffffffffp+1023 0x1.fffffffffffffp+1023))</p>
<p>But when I try to isolate just these tests and run, the problem is not reproduced. It is hard for me to tell if the issue is with something in the lowering or something in the wast testing path. </p>
<p>I did run valgrind against a277cf for example and there is a conspicuous error:</p>
<p>==4490== Conditional jump or move depends on uninitialised value(s)<br>
==4490==    at 0x48A056: core::iter::traits::iterator::Iterator::all:<span aria-label="check" class="emoji emoji-2705" role="img" title="check">:check:</span>:{{closure}} (iterator.rs:2114)<br>
==4490==    by 0x484EBD: &lt;core::iter::adapters::Enumerate&lt;I&gt; as core::iter::traits::iterator::Iterator&gt;::try_fold::enumerate::{{closure}} (mod.rs:1413)<br>
==4490==    by 0x46FECB: core::iter::traits::iterator::Iterator::try_fold (iterator.rs:1888)<br>
==4490==    by 0x484945: &lt;core::iter::adapters::Enumerate&lt;I&gt; as core::iter::traits::iterator::Iterator&gt;::try_fold (mod.rs:1420)<br>
==4490==    by 0x4842C0: core::iter::traits::iterator::Iterator::all (iterator.rs:2117)<br>
==4490==    by 0x4791DD: wasmtime_wast::wast::v128_matches (wast.rs:471)<br>
==4490==    by 0x478B77: wasmtime_wast::wast::val_matches (wast.rs:411)<br>
==4490==    by 0x47456B: wasmtime_wast::wast::WastContext::assert_return (wast.rs:185)<br>
==4490==    by 0x476693: wasmtime_wast::wast::WastContext::run_directive (wast.rs:272)<br>
==4490==    by 0x47530B: wasmtime_wast::wast::WastContext::run_buffer (wast.rs:229)<br>
==4490==    by 0x478201: wasmtime_wast::wast::WastContext::run_file (wast.rs:353)<br>
==4490==    by 0x333EF2: all::wast::run_wast (wast.rs:46)<br>
==4490==  Uninitialised value was created by a stack allocation<br>
==4490==    at 0x56B530: &lt;core::iter::adapters::zip::Zip&lt;A,B&gt; as core::iter::adapters::zip::ZipImpl&lt;A,B&gt;&gt;::get_unchecked (zip.rs:291)</p>
<p>Which I think actually involves these lines here: <a href="https://github.com/bytecodealliance/wasmtime/blob/main/crates/wast/src/wast.rs#L507-L514">https://github.com/bytecodealliance/wasmtime/blob/main/crates/wast/src/wast.rs#L507-L514</a> in head.</p>
<p>It is not obvious to me though how to correct this yet. I think this bug should be understood and remove this bug as a next step.</p>
</blockquote>



<a name="219310918"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20Issue%20%232432%20Investigate%20non-deterministic%20fail.../near/219310918" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20Issue.20.232432.20Investigate.20non-deterministic.20fail.2E.2E.2E.html#219310918">(Dec 09 2020 at 09:03)</a>:</h4>
<p>julian-seward1 <a href="https://github.com/bytecodealliance/wasmtime/issues/2432#issuecomment-741634947">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/2432">Issue #2432</a>:</p>
<blockquote>
<p>Just to be on the safe side .. is this with valgrind 3.16.0 or later?  That has the lowest false-positive rate so far; I would recommend against any investigation based on output from a version before 3.16.0.</p>
</blockquote>



<a name="219316884"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20Issue%20%232432%20Investigate%20non-deterministic%20fail.../near/219316884" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20Issue.20.232432.20Investigate.20non-deterministic.20fail.2E.2E.2E.html#219316884">(Dec 09 2020 at 10:07)</a>:</h4>
<p>cfallin <a href="https://github.com/bytecodealliance/wasmtime/issues/2432#issuecomment-741670010">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/2432">Issue #2432</a>:</p>
<blockquote>
<p>So I was nerdsniped by this and chased it for a while -- with valgrind 3.16.1 (Fedora 33) I'm seeing the uninit value in the <code>values_vec</code> through which the trampoline passes the wasm func's return value (crates/wasmtime/src/func.rs) -- insert a println there and the uninit value is used right away, problem isn't in wast checks. The value's origin (valgrind <code>--track-origins=yes</code>) is:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="o">==</span><span class="mi">473121</span><span class="o">==</span><span class="w">  </span><span class="n">Uninitialised</span><span class="w"> </span><span class="n">value</span><span class="w"> </span><span class="n">was</span><span class="w"> </span><span class="n">created</span><span class="w"> </span><span class="n">by</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="n">stack</span><span class="w"> </span><span class="n">allocation</span><span class="w"></span>
<span class="o">==</span><span class="mi">473121</span><span class="o">==</span><span class="w">    </span><span class="n">at</span><span class="w"> </span><span class="mh">0xEFC9F0</span>: <span class="nc">wasmtime_runtime</span>::<span class="n">traphandlers</span>::<span class="n">setup_unix_sigaltstack</span>::<span class="n">TLS</span>::<span class="n">__init</span><span class="w"> </span><span class="p">(</span><span class="n">local</span><span class="p">.</span><span class="n">rs</span>:<span class="mi">157</span><span class="p">)</span><span class="w"></span>
</code></pre></div>
<p>So what I can gather from that is that we're reading uninitialized stack somewhere. I spent a while staring at the generated trampoline functions and am not seeing anything obviously wrong, but is it possible that maybe we're calling the wrong trampoline (too many/too few args or returns)?</p>
<p>Another oddity I noticed: there is no <code>WasmTy</code> impl for <code>u128</code>. Most vector code seems to work fine without this, though perhaps this is A Problem anyway (@alexcrichton any thoughts on this, plus @jlb6740's note above that the uninit behavior seems to go away prior to #2365?).</p>
</blockquote>



<a name="219318472"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20Issue%20%232432%20Investigate%20non-deterministic%20fail.../near/219318472" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20Issue.20.232432.20Investigate.20non-deterministic.20fail.2E.2E.2E.html#219318472">(Dec 09 2020 at 10:24)</a>:</h4>
<p>julian-seward1 <a href="https://github.com/bytecodealliance/wasmtime/issues/2432#issuecomment-741679285">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/2432">Issue #2432</a>:</p>
<blockquote>
<blockquote>
<p>insert a println there and the uninit value is used right away</p>
</blockquote>
<p>That reduces the chance that it's a false positive.  The clincher would however be if you can demonstrate that multiple runs print different values at that point.</p>
</blockquote>



<a name="219350296"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20Issue%20%232432%20Investigate%20non-deterministic%20fail.../near/219350296" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20Issue.20.232432.20Investigate.20non-deterministic.20fail.2E.2E.2E.html#219350296">(Dec 09 2020 at 15:21)</a>:</h4>
<p>alexcrichton <a href="https://github.com/bytecodealliance/wasmtime/issues/2432#issuecomment-741840292">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/2432">Issue #2432</a>:</p>
<blockquote>
<p>To confirm @jlb6740, are you testing recent master? #2365 had a use-after-free but if modules/stores were deallocated in the wrong order (later fixed though). That might explain why just after that commit valgrind finds issues.</p>
<p>As for <code>WasmTy for u128</code>, the reason we haven't implemented that yet is mainly that there's no native ABI for Rust to call a cranelift-generated function that takes <code>u128</code> right now. Or at least no one's said 'yep this works let us add it'. Once that's possible we can add <code>WasmTy for u128</code>, however.</p>
</blockquote>



<a name="219371456"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20Issue%20%232432%20Investigate%20non-deterministic%20fail.../near/219371456" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20Issue.20.232432.20Investigate.20non-deterministic.20fail.2E.2E.2E.html#219371456">(Dec 09 2020 at 17:44)</a>:</h4>
<p>jlb6740 <a href="https://github.com/bytecodealliance/wasmtime/issues/2432#issuecomment-741938940">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/2432">Issue #2432</a>:</p>
<blockquote>
<p>@julian-seward1 I have valgrind-3.15.0 installed. I will update to a 3.16 or higher. @alexcrichton the valgrind run is based on commit a277cf which was the last time I could readily reproduce. I've tried patches though since @cfallin disabled the tests and could reproduce up until then. Let me rerun the latest valgrind on the latest build with these tests enabled.</p>
</blockquote>



<a name="219371540"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20Issue%20%232432%20Investigate%20non-deterministic%20fail.../near/219371540" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20Issue.20.232432.20Investigate.20non-deterministic.20fail.2E.2E.2E.html#219371540">(Dec 09 2020 at 17:45)</a>:</h4>
<p>jlb6740 edited a <a href="https://github.com/bytecodealliance/wasmtime/issues/2432#issuecomment-741588488">comment</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/2432">Issue #2432</a>:</p>
<blockquote>
<p>I've been attempting to both (1) isolate the patch where the issue starts and (2) simplify the reproducer but both are proving to be more difficult than anticipated. Some observations .. </p>
<p>W.r.t pinpointing the patch that introduced the issue, I am finding it impossible to reproduce this issue using the script above before <a href="https://github.com/bytecodealliance/wasmtime/pull/2365">https://github.com/bytecodealliance/wasmtime/pull/2365</a> . However I am not thinking this patch introduces this bug since it was seen as earlier as October here: <a href="https://github.com/bytecodealliance/wasmtime/runs/1323686030">https://github.com/bytecodealliance/wasmtime/runs/1323686030</a> </p>
<p>W.r.t. simplifying the reproducer I am finding the error almost always occurs with the same tests involving negation or abs .. test such as:</p>
<p>(assert_return (invoke "add-neg" (v128.const f64x2 1.125 1.125)<br>
                                 (v128.const f64x2 0.125 0.125))<br>
                                 (v128.const f64x2 -1.0 -1.0))</p>
<p>or</p>
<p>(assert_return (invoke "f64x2.abs" (v128.const f64x2 0x1.fffffffffffffp+1023 0x1.fffffffffffffp+1023))<br>
                                   (v128.const f64x2 0x1.fffffffffffffp+1023 0x1.fffffffffffffp+1023))</p>
<p>But when I try to isolate just these tests and run, the problem is not reproduced. It is hard for me to tell if the issue is with something in the lowering or something in the wast testing path. </p>
<p>I did run valgrind against a277cf for example and there is a conspicuous error:</p>
<p>==4490== Conditional jump or move depends on uninitialised value(s)<br>
==4490==    at 0x48A056: core::iter::traits::iterator::Iterator::all:<span aria-label="check" class="emoji emoji-2705" role="img" title="check">:check:</span>:{{closure}} (iterator.rs:2114)<br>
==4490==    by 0x484EBD: &lt;core::iter::adapters::Enumerate&lt;I&gt; as core::iter::traits::iterator::Iterator&gt;::try_fold::enumerate::{{closure}} (mod.rs:1413)<br>
==4490==    by 0x46FECB: core::iter::traits::iterator::Iterator::try_fold (iterator.rs:1888)<br>
==4490==    by 0x484945: &lt;core::iter::adapters::Enumerate&lt;I&gt; as core::iter::traits::iterator::Iterator&gt;::try_fold (mod.rs:1420)<br>
==4490==    by 0x4842C0: core::iter::traits::iterator::Iterator::all (iterator.rs:2117)<br>
==4490==    by 0x4791DD: wasmtime_wast::wast::v128_matches (wast.rs:471)<br>
==4490==    by 0x478B77: wasmtime_wast::wast::val_matches (wast.rs:411)<br>
==4490==    by 0x47456B: wasmtime_wast::wast::WastContext::assert_return (wast.rs:185)<br>
==4490==    by 0x476693: wasmtime_wast::wast::WastContext::run_directive (wast.rs:272)<br>
==4490==    by 0x47530B: wasmtime_wast::wast::WastContext::run_buffer (wast.rs:229)<br>
==4490==    by 0x478201: wasmtime_wast::wast::WastContext::run_file (wast.rs:353)<br>
==4490==    by 0x333EF2: all::wast::run_wast (wast.rs:46)<br>
==4490==  Uninitialised value was created by a stack allocation<br>
==4490==    at 0x56B530: &lt;core::iter::adapters::zip::Zip&lt;A,B&gt; as core::iter::adapters::zip::ZipImpl&lt;A,B&gt;&gt;::get_unchecked (zip.rs:291)</p>
<p>Which I think actually involves these lines here: <a href="https://github.com/bytecodealliance/wasmtime/blob/main/crates/wast/src/wast.rs#L507-L514">https://github.com/bytecodealliance/wasmtime/blob/main/crates/wast/src/wast.rs#L507-L514</a> in head.</p>
<p>It is not obvious to me though how to correct this yet. I think this bug should be understood and remove this bug as a next step.</p>
</blockquote>



<a name="219371678"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20Issue%20%232432%20Investigate%20non-deterministic%20fail.../near/219371678" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20Issue.20.232432.20Investigate.20non-deterministic.20fail.2E.2E.2E.html#219371678">(Dec 09 2020 at 17:46)</a>:</h4>
<p>jlb6740 edited a <a href="https://github.com/bytecodealliance/wasmtime/issues/2432#issuecomment-741588488">comment</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/2432">Issue #2432</a>:</p>
<blockquote>
<p>I've been attempting to both (1) isolate the patch where the issue starts and (2) simplify the reproducer but both are proving to be more difficult than anticipated. Some observations .. </p>
<p>W.r.t pinpointing the patch that introduced the issue, I am finding it impossible to reproduce this issue using the script above before <a href="https://github.com/bytecodealliance/wasmtime/pull/2365">https://github.com/bytecodealliance/wasmtime/pull/2365</a> . However I am not thinking this patch introduces this bug since it was seen as earlier as October here: <a href="https://github.com/bytecodealliance/wasmtime/runs/1323686030">https://github.com/bytecodealliance/wasmtime/runs/1323686030</a> </p>
<p>W.r.t. simplifying the reproducer I am finding the error almost always occurs with the same tests involving negation or abs .. test such as:</p>
<p>(assert_return (invoke "add-neg" (v128.const f64x2 1.125 1.125)<br>
                                 (v128.const f64x2 0.125 0.125))<br>
                                 (v128.const f64x2 -1.0 -1.0))</p>
<p>or</p>
<p>(assert_return (invoke "f64x2.abs" (v128.const f64x2 0x1.fffffffffffffp+1023 0x1.fffffffffffffp+1023))<br>
                                   (v128.const f64x2 0x1.fffffffffffffp+1023 0x1.fffffffffffffp+1023))</p>
<p>But when I try to isolate just these tests and run, the problem is not reproduced. It is hard for me to tell if the issue is with something in the lowering or something in the wast testing path. </p>
<p>I did run valgrind against a277cf for example and there is a conspicuous error:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="o">==</span><span class="mi">4490</span><span class="o">==</span><span class="w"> </span><span class="n">Conditional</span><span class="w"> </span><span class="n">jump</span><span class="w"> </span><span class="n">or</span><span class="w"> </span><span class="k">move</span><span class="w"> </span><span class="n">depends</span><span class="w"> </span><span class="n">on</span><span class="w"> </span><span class="n">uninitialised</span><span class="w"> </span><span class="n">value</span><span class="p">(</span><span class="n">s</span><span class="p">)</span><span class="w"></span>
<span class="o">==</span><span class="mi">4490</span><span class="o">==</span><span class="w">    </span><span class="n">at</span><span class="w"> </span><span class="mh">0x48A056</span>: <span class="nc">core</span>::<span class="n">iter</span>::<span class="n">traits</span>::<span class="n">iterator</span>::<span class="nb">Iterator</span>::<span class="n">all</span>::<span class="n">check</span>::<span class="p">{{</span><span class="n">closure</span><span class="p">}}</span><span class="w"> </span><span class="p">(</span><span class="n">iterator</span><span class="p">.</span><span class="n">rs</span>:<span class="mi">2114</span><span class="p">)</span><span class="w"></span>
<span class="o">==</span><span class="mi">4490</span><span class="o">==</span><span class="w">    </span><span class="n">by</span><span class="w"> </span><span class="mh">0x484EBD</span>: <span class="o">&lt;</span><span class="n">core</span>::<span class="n">iter</span>::<span class="n">adapters</span>::<span class="n">Enumerate</span><span class="o">&lt;</span><span class="n">I</span><span class="o">&gt;</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">core</span>::<span class="n">iter</span>::<span class="n">traits</span>::<span class="n">iterator</span>::<span class="nb">Iterator</span><span class="o">&gt;</span>::<span class="n">try_fold</span>::<span class="n">enumerate</span>::<span class="p">{{</span><span class="n">closure</span><span class="p">}}</span><span class="w"> </span><span class="p">(</span><span class="k">mod</span><span class="p">.</span><span class="n">rs</span>:<span class="mi">1413</span><span class="p">)</span><span class="w"></span>
<span class="o">==</span><span class="mi">4490</span><span class="o">==</span><span class="w">    </span><span class="n">by</span><span class="w"> </span><span class="mh">0x46FECB</span>: <span class="nc">core</span>::<span class="n">iter</span>::<span class="n">traits</span>::<span class="n">iterator</span>::<span class="nb">Iterator</span>::<span class="n">try_fold</span><span class="w"> </span><span class="p">(</span><span class="n">iterator</span><span class="p">.</span><span class="n">rs</span>:<span class="mi">1888</span><span class="p">)</span><span class="w"></span>
<span class="o">==</span><span class="mi">4490</span><span class="o">==</span><span class="w">    </span><span class="n">by</span><span class="w"> </span><span class="mh">0x484945</span>: <span class="o">&lt;</span><span class="n">core</span>::<span class="n">iter</span>::<span class="n">adapters</span>::<span class="n">Enumerate</span><span class="o">&lt;</span><span class="n">I</span><span class="o">&gt;</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">core</span>::<span class="n">iter</span>::<span class="n">traits</span>::<span class="n">iterator</span>::<span class="nb">Iterator</span><span class="o">&gt;</span>::<span class="n">try_fold</span><span class="w"> </span><span class="p">(</span><span class="k">mod</span><span class="p">.</span><span class="n">rs</span>:<span class="mi">1420</span><span class="p">)</span><span class="w"></span>
<span class="o">==</span><span class="mi">4490</span><span class="o">==</span><span class="w">    </span><span class="n">by</span><span class="w"> </span><span class="mh">0x4842C0</span>: <span class="nc">core</span>::<span class="n">iter</span>::<span class="n">traits</span>::<span class="n">iterator</span>::<span class="nb">Iterator</span>::<span class="n">all</span><span class="w"> </span><span class="p">(</span><span class="n">iterator</span><span class="p">.</span><span class="n">rs</span>:<span class="mi">2117</span><span class="p">)</span><span class="w"></span>
<span class="o">==</span><span class="mi">4490</span><span class="o">==</span><span class="w">    </span><span class="n">by</span><span class="w"> </span><span class="mh">0x4791DD</span>: <span class="nc">wasmtime_wast</span>::<span class="n">wast</span>::<span class="n">v128_matches</span><span class="w"> </span><span class="p">(</span><span class="n">wast</span><span class="p">.</span><span class="n">rs</span>:<span class="mi">471</span><span class="p">)</span><span class="w"></span>
<span class="o">==</span><span class="mi">4490</span><span class="o">==</span><span class="w">    </span><span class="n">by</span><span class="w"> </span><span class="mh">0x478B77</span>: <span class="nc">wasmtime_wast</span>::<span class="n">wast</span>::<span class="n">val_matches</span><span class="w"> </span><span class="p">(</span><span class="n">wast</span><span class="p">.</span><span class="n">rs</span>:<span class="mi">411</span><span class="p">)</span><span class="w"></span>
<span class="o">==</span><span class="mi">4490</span><span class="o">==</span><span class="w">    </span><span class="n">by</span><span class="w"> </span><span class="mh">0x47456B</span>: <span class="nc">wasmtime_wast</span>::<span class="n">wast</span>::<span class="n">WastContext</span>::<span class="n">assert_return</span><span class="w"> </span><span class="p">(</span><span class="n">wast</span><span class="p">.</span><span class="n">rs</span>:<span class="mi">185</span><span class="p">)</span><span class="w"></span>
<span class="o">==</span><span class="mi">4490</span><span class="o">==</span><span class="w">    </span><span class="n">by</span><span class="w"> </span><span class="mh">0x476693</span>: <span class="nc">wasmtime_wast</span>::<span class="n">wast</span>::<span class="n">WastContext</span>::<span class="n">run_directive</span><span class="w"> </span><span class="p">(</span><span class="n">wast</span><span class="p">.</span><span class="n">rs</span>:<span class="mi">272</span><span class="p">)</span><span class="w"></span>
<span class="o">==</span><span class="mi">4490</span><span class="o">==</span><span class="w">    </span><span class="n">by</span><span class="w"> </span><span class="mh">0x47530B</span>: <span class="nc">wasmtime_wast</span>::<span class="n">wast</span>::<span class="n">WastContext</span>::<span class="n">run_buffer</span><span class="w"> </span><span class="p">(</span><span class="n">wast</span><span class="p">.</span><span class="n">rs</span>:<span class="mi">229</span><span class="p">)</span><span class="w"></span>
<span class="o">==</span><span class="mi">4490</span><span class="o">==</span><span class="w">    </span><span class="n">by</span><span class="w"> </span><span class="mh">0x478201</span>: <span class="nc">wasmtime_wast</span>::<span class="n">wast</span>::<span class="n">WastContext</span>::<span class="n">run_file</span><span class="w"> </span><span class="p">(</span><span class="n">wast</span><span class="p">.</span><span class="n">rs</span>:<span class="mi">353</span><span class="p">)</span><span class="w"></span>
<span class="o">==</span><span class="mi">4490</span><span class="o">==</span><span class="w">    </span><span class="n">by</span><span class="w"> </span><span class="mh">0x333EF2</span>: <span class="nc">all</span>::<span class="n">wast</span>::<span class="n">run_wast</span><span class="w"> </span><span class="p">(</span><span class="n">wast</span><span class="p">.</span><span class="n">rs</span>:<span class="mi">46</span><span class="p">)</span><span class="w"></span>
<span class="o">==</span><span class="mi">4490</span><span class="o">==</span><span class="w">  </span><span class="n">Uninitialised</span><span class="w"> </span><span class="n">value</span><span class="w"> </span><span class="n">was</span><span class="w"> </span><span class="n">created</span><span class="w"> </span><span class="n">by</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="n">stack</span><span class="w"> </span><span class="n">allocation</span><span class="w"></span>
<span class="o">==</span><span class="mi">4490</span><span class="o">==</span><span class="w">    </span><span class="n">at</span><span class="w"> </span><span class="mh">0x56B530</span>: <span class="o">&lt;</span><span class="n">core</span>::<span class="n">iter</span>::<span class="n">adapters</span>::<span class="n">zip</span>::<span class="n">Zip</span><span class="o">&lt;</span><span class="n">A</span><span class="p">,</span><span class="n">B</span><span class="o">&gt;</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">core</span>::<span class="n">iter</span>::<span class="n">adapters</span>::<span class="n">zip</span>::<span class="n">ZipImpl</span><span class="o">&lt;</span><span class="n">A</span><span class="p">,</span><span class="n">B</span><span class="o">&gt;&gt;</span>::<span class="n">get_unchecked</span><span class="w"> </span><span class="p">(</span><span class="n">zip</span><span class="p">.</span><span class="n">rs</span>:<span class="mi">291</span><span class="p">)</span><span class="w"></span>
</code></pre></div>
<p>Which I think actually involves these lines here: <a href="https://github.com/bytecodealliance/wasmtime/blob/main/crates/wast/src/wast.rs#L507-L514">https://github.com/bytecodealliance/wasmtime/blob/main/crates/wast/src/wast.rs#L507-L514</a> in head.</p>
<p>It is not obvious to me though how to correct this yet. I think this bug should be understood and remove this bug as a next step.</p>
</blockquote>



<a name="219371718"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20Issue%20%232432%20Investigate%20non-deterministic%20fail.../near/219371718" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20Issue.20.232432.20Investigate.20non-deterministic.20fail.2E.2E.2E.html#219371718">(Dec 09 2020 at 17:46)</a>:</h4>
<p>jlb6740 edited a <a href="https://github.com/bytecodealliance/wasmtime/issues/2432#issuecomment-741588488">comment</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/2432">Issue #2432</a>:</p>
<blockquote>
<p>I've been attempting to both (1) isolate the patch where the issue starts and (2) simplify the reproducer but both are proving to be more difficult than anticipated. Some observations .. </p>
<p>W.r.t pinpointing the patch that introduced the issue, I am finding it impossible to reproduce this issue using the script above before <a href="https://github.com/bytecodealliance/wasmtime/pull/2365">https://github.com/bytecodealliance/wasmtime/pull/2365</a> . However I am not thinking this patch introduces this bug since it was seen as earlier as October here: <a href="https://github.com/bytecodealliance/wasmtime/runs/1323686030">https://github.com/bytecodealliance/wasmtime/runs/1323686030</a> </p>
<p>W.r.t. simplifying the reproducer I am finding the error almost always occurs with the same tests involving negation or abs .. test such as:</p>
<p>(assert_return (invoke "add-neg" (v128.const f64x2 1.125 1.125)<br>
                                 (v128.const f64x2 0.125 0.125))<br>
                                 (v128.const f64x2 -1.0 -1.0))</p>
<p>or</p>
<p>(assert_return (invoke "f64x2.abs" (v128.const f64x2 0x1.fffffffffffffp+1023 0x1.fffffffffffffp+1023))<br>
                                   (v128.const f64x2 0x1.fffffffffffffp+1023 0x1.fffffffffffffp+1023))</p>
<p>But when I try to isolate just these tests and run, the problem is not reproduced. It is hard for me to tell if the issue is with something in the lowering or something in the wast testing path. </p>
<p>I did run valgrind against a277cf for example and there is a conspicuous error:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="o">==</span><span class="mi">4490</span><span class="o">==</span><span class="w"> </span><span class="n">Conditional</span><span class="w"> </span><span class="n">jump</span><span class="w"> </span><span class="n">or</span><span class="w"> </span><span class="k">move</span><span class="w"> </span><span class="n">depends</span><span class="w"> </span><span class="n">on</span><span class="w"> </span><span class="n">uninitialised</span><span class="w"> </span><span class="n">value</span><span class="p">(</span><span class="n">s</span><span class="p">)</span><span class="w"></span>
<span class="o">==</span><span class="mi">4490</span><span class="o">==</span><span class="w">    </span><span class="n">at</span><span class="w"> </span><span class="mh">0x48A056</span>: <span class="nc">core</span>::<span class="n">iter</span>::<span class="n">traits</span>::<span class="n">iterator</span>::<span class="nb">Iterator</span>::<span class="n">all</span>::<span class="n">check</span>::<span class="p">{{</span><span class="n">closure</span><span class="p">}}</span><span class="w"> </span><span class="p">(</span><span class="n">iterator</span><span class="p">.</span><span class="n">rs</span>:<span class="mi">2114</span><span class="p">)</span><span class="w"></span>
<span class="o">==</span><span class="mi">4490</span><span class="o">==</span><span class="w">    </span><span class="n">by</span><span class="w"> </span><span class="mh">0x484EBD</span>: <span class="o">&lt;</span><span class="n">core</span>::<span class="n">iter</span>::<span class="n">adapters</span>::<span class="n">Enumerate</span><span class="o">&lt;</span><span class="n">I</span><span class="o">&gt;</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">core</span>::<span class="n">iter</span>::<span class="n">traits</span>::<span class="n">iterator</span>::<span class="nb">Iterator</span><span class="o">&gt;</span>::<span class="n">try_fold</span>::<span class="n">enumerate</span>::<span class="p">{{</span><span class="n">closure</span><span class="p">}}</span><span class="w"> </span><span class="p">(</span><span class="k">mod</span><span class="p">.</span><span class="n">rs</span>:<span class="mi">1413</span><span class="p">)</span><span class="w"></span>
<span class="o">==</span><span class="mi">4490</span><span class="o">==</span><span class="w">    </span><span class="n">by</span><span class="w"> </span><span class="mh">0x46FECB</span>: <span class="nc">core</span>::<span class="n">iter</span>::<span class="n">traits</span>::<span class="n">iterator</span>::<span class="nb">Iterator</span>::<span class="n">try_fold</span><span class="w"> </span><span class="p">(</span><span class="n">iterator</span><span class="p">.</span><span class="n">rs</span>:<span class="mi">1888</span><span class="p">)</span><span class="w"></span>
<span class="o">==</span><span class="mi">4490</span><span class="o">==</span><span class="w">    </span><span class="n">by</span><span class="w"> </span><span class="mh">0x484945</span>: <span class="o">&lt;</span><span class="n">core</span>::<span class="n">iter</span>::<span class="n">adapters</span>::<span class="n">Enumerate</span><span class="o">&lt;</span><span class="n">I</span><span class="o">&gt;</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">core</span>::<span class="n">iter</span>::<span class="n">traits</span>::<span class="n">iterator</span>::<span class="nb">Iterator</span><span class="o">&gt;</span>::<span class="n">try_fold</span><span class="w"> </span><span class="p">(</span><span class="k">mod</span><span class="p">.</span><span class="n">rs</span>:<span class="mi">1420</span><span class="p">)</span><span class="w"></span>
<span class="o">==</span><span class="mi">4490</span><span class="o">==</span><span class="w">    </span><span class="n">by</span><span class="w"> </span><span class="mh">0x4842C0</span>: <span class="nc">core</span>::<span class="n">iter</span>::<span class="n">traits</span>::<span class="n">iterator</span>::<span class="nb">Iterator</span>::<span class="n">all</span><span class="w"> </span><span class="p">(</span><span class="n">iterator</span><span class="p">.</span><span class="n">rs</span>:<span class="mi">2117</span><span class="p">)</span><span class="w"></span>
<span class="o">==</span><span class="mi">4490</span><span class="o">==</span><span class="w">    </span><span class="n">by</span><span class="w"> </span><span class="mh">0x4791DD</span>: <span class="nc">wasmtime_wast</span>::<span class="n">wast</span>::<span class="n">v128_matches</span><span class="w"> </span><span class="p">(</span><span class="n">wast</span><span class="p">.</span><span class="n">rs</span>:<span class="mi">471</span><span class="p">)</span><span class="w"></span>
<span class="o">==</span><span class="mi">4490</span><span class="o">==</span><span class="w">    </span><span class="n">by</span><span class="w"> </span><span class="mh">0x478B77</span>: <span class="nc">wasmtime_wast</span>::<span class="n">wast</span>::<span class="n">val_matches</span><span class="w"> </span><span class="p">(</span><span class="n">wast</span><span class="p">.</span><span class="n">rs</span>:<span class="mi">411</span><span class="p">)</span><span class="w"></span>
<span class="o">==</span><span class="mi">4490</span><span class="o">==</span><span class="w">    </span><span class="n">by</span><span class="w"> </span><span class="mh">0x47456B</span>: <span class="nc">wasmtime_wast</span>::<span class="n">wast</span>::<span class="n">WastContext</span>::<span class="n">assert_return</span><span class="w"> </span><span class="p">(</span><span class="n">wast</span><span class="p">.</span><span class="n">rs</span>:<span class="mi">185</span><span class="p">)</span><span class="w"></span>
<span class="o">==</span><span class="mi">4490</span><span class="o">==</span><span class="w">    </span><span class="n">by</span><span class="w"> </span><span class="mh">0x476693</span>: <span class="nc">wasmtime_wast</span>::<span class="n">wast</span>::<span class="n">WastContext</span>::<span class="n">run_directive</span><span class="w"> </span><span class="p">(</span><span class="n">wast</span><span class="p">.</span><span class="n">rs</span>:<span class="mi">272</span><span class="p">)</span><span class="w"></span>
<span class="o">==</span><span class="mi">4490</span><span class="o">==</span><span class="w">    </span><span class="n">by</span><span class="w"> </span><span class="mh">0x47530B</span>: <span class="nc">wasmtime_wast</span>::<span class="n">wast</span>::<span class="n">WastContext</span>::<span class="n">run_buffer</span><span class="w"> </span><span class="p">(</span><span class="n">wast</span><span class="p">.</span><span class="n">rs</span>:<span class="mi">229</span><span class="p">)</span><span class="w"></span>
<span class="o">==</span><span class="mi">4490</span><span class="o">==</span><span class="w">    </span><span class="n">by</span><span class="w"> </span><span class="mh">0x478201</span>: <span class="nc">wasmtime_wast</span>::<span class="n">wast</span>::<span class="n">WastContext</span>::<span class="n">run_file</span><span class="w"> </span><span class="p">(</span><span class="n">wast</span><span class="p">.</span><span class="n">rs</span>:<span class="mi">353</span><span class="p">)</span><span class="w"></span>
<span class="o">==</span><span class="mi">4490</span><span class="o">==</span><span class="w">    </span><span class="n">by</span><span class="w"> </span><span class="mh">0x333EF2</span>: <span class="nc">all</span>::<span class="n">wast</span>::<span class="n">run_wast</span><span class="w"> </span><span class="p">(</span><span class="n">wast</span><span class="p">.</span><span class="n">rs</span>:<span class="mi">46</span><span class="p">)</span><span class="w"></span>
<span class="o">==</span><span class="mi">4490</span><span class="o">==</span><span class="w">  </span><span class="n">Uninitialised</span><span class="w"> </span><span class="n">value</span><span class="w"> </span><span class="n">was</span><span class="w"> </span><span class="n">created</span><span class="w"> </span><span class="n">by</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="n">stack</span><span class="w"> </span><span class="n">allocation</span><span class="w"></span>
<span class="o">==</span><span class="mi">4490</span><span class="o">==</span><span class="w">    </span><span class="n">at</span><span class="w"> </span><span class="mh">0x56B530</span>: <span class="o">&lt;</span><span class="n">core</span>::<span class="n">iter</span>::<span class="n">adapters</span>::<span class="n">zip</span>::<span class="n">Zip</span><span class="o">&lt;</span><span class="n">A</span><span class="p">,</span><span class="n">B</span><span class="o">&gt;</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">core</span>::<span class="n">iter</span>::<span class="n">adapters</span>::<span class="n">zip</span>::<span class="n">ZipImpl</span><span class="o">&lt;</span><span class="n">A</span><span class="p">,</span><span class="n">B</span><span class="o">&gt;&gt;</span>::<span class="n">get_unchecked</span><span class="w"> </span><span class="p">(</span><span class="n">zip</span><span class="p">.</span><span class="n">rs</span>:<span class="mi">291</span><span class="p">)</span><span class="w"></span>
</code></pre></div>
<p>Which I think actually involves these lines here: <a href="https://github.com/bytecodealliance/wasmtime/blob/main/crates/wast/src/wast.rs#L507-L514">https://github.com/bytecodealliance/wasmtime/blob/main/crates/wast/src/wast.rs#L507-L514</a> in head.</p>
<p>It is not obvious to me though how to correct this yet. I think this bug should be understood and remove as a next step.</p>
</blockquote>



<a name="219388984"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20Issue%20%232432%20Investigate%20non-deterministic%20fail.../near/219388984" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20Issue.20.232432.20Investigate.20non-deterministic.20fail.2E.2E.2E.html#219388984">(Dec 09 2020 at 19:52)</a>:</h4>
<p>alexcrichton <a href="https://github.com/bytecodealliance/wasmtime/issues/2432#issuecomment-742010055">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/2432">Issue #2432</a>:</p>
<blockquote>
<p>Ah ok in that case I'm not entirely sure what would be causing this unfortunately :( </p>
</blockquote>



<a name="219391119"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20Issue%20%232432%20Investigate%20non-deterministic%20fail.../near/219391119" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20Issue.20.232432.20Investigate.20non-deterministic.20fail.2E.2E.2E.html#219391119">(Dec 09 2020 at 20:11)</a>:</h4>
<p>jlb6740 <a href="https://github.com/bytecodealliance/wasmtime/issues/2432#issuecomment-742019865">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/2432">Issue #2432</a>:</p>
<blockquote>
<p>@alexcrichton yes, just needs more investigation. I've confirmed that use of unitialized values still occurs with the latest build with valgrind 3.16.1</p>
<p><div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="o">==</span><span class="mi">22915</span><span class="o">==</span><span class="w"> </span><span class="n">Conditional</span><span class="w"> </span><span class="n">jump</span><span class="w"> </span><span class="n">or</span><span class="w"> </span><span class="k">move</span><span class="w"> </span><span class="n">depends</span><span class="w"> </span><span class="n">on</span><span class="w"> </span><span class="n">uninitialised</span><span class="w"> </span><span class="n">value</span><span class="p">(</span><span class="n">s</span><span class="p">)</span><span class="w"></span>
<span class="o">==</span><span class="mi">22915</span><span class="o">==</span><span class="w">    </span><span class="n">at</span><span class="w"> </span><span class="mh">0x50D676</span>: <span class="nc">core</span>::<span class="n">iter</span>::<span class="n">traits</span>::<span class="n">iterator</span>::<span class="nb">Iterator</span>::<span class="n">all</span>::<span class="n">check</span>::<span class="p">{{</span><span class="n">closure</span><span class="p">}}</span><span class="w"> </span><span class="p">(</span><span class="n">iterator</span><span class="p">.</span><span class="n">rs</span>:<span class="mi">2114</span><span class="p">)</span><span class="w"></span>
<span class="o">==</span><span class="mi">22915</span><span class="o">==</span><span class="w">    </span><span class="n">by</span><span class="w"> </span><span class="mh">0x52297D</span>: <span class="o">&lt;</span><span class="n">core</span>::<span class="n">iter</span>::<span class="n">adapters</span>::<span class="n">Enumerate</span><span class="o">&lt;</span><span class="n">I</span><span class="o">&gt;</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">core</span>::<span class="n">iter</span>::<span class="n">traits</span>::<span class="n">iterator</span>::<span class="nb">Iterator</span><span class="o">&gt;</span>::<span class="n">try_fold</span>::<span class="n">enumerate</span>::<span class="p">{{</span><span class="n">closure</span><span class="p">}}</span><span class="w"> </span><span class="p">(</span><span class="k">mod</span><span class="p">.</span><span class="n">rs</span>:<span class="mi">1413</span><span class="p">)</span><span class="w"></span>
<span class="o">==</span><span class="mi">22915</span><span class="o">==</span><span class="w">    </span><span class="n">by</span><span class="w"> </span><span class="mh">0x50B1EB</span>: <span class="nc">core</span>::<span class="n">iter</span>::<span class="n">traits</span>::<span class="n">iterator</span>::<span class="nb">Iterator</span>::<span class="n">try_fold</span><span class="w"> </span><span class="p">(</span><span class="n">iterator</span><span class="p">.</span><span class="n">rs</span>:<span class="mi">1888</span><span class="p">)</span><span class="w"></span>
<span class="o">==</span><span class="mi">22915</span><span class="o">==</span><span class="w">    </span><span class="n">by</span><span class="w"> </span><span class="mh">0x522405</span>: <span class="o">&lt;</span><span class="n">core</span>::<span class="n">iter</span>::<span class="n">adapters</span>::<span class="n">Enumerate</span><span class="o">&lt;</span><span class="n">I</span><span class="o">&gt;</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">core</span>::<span class="n">iter</span>::<span class="n">traits</span>::<span class="n">iterator</span>::<span class="nb">Iterator</span><span class="o">&gt;</span>::<span class="n">try_fold</span><span class="w"> </span><span class="p">(</span><span class="k">mod</span><span class="p">.</span><span class="n">rs</span>:<span class="mi">1420</span><span class="p">)</span><span class="w"></span>
<span class="o">==</span><span class="mi">22915</span><span class="o">==</span><span class="w">    </span><span class="n">by</span><span class="w"> </span><span class="mh">0x51E660</span>: <span class="nc">core</span>::<span class="n">iter</span>::<span class="n">traits</span>::<span class="n">iterator</span>::<span class="nb">Iterator</span>::<span class="n">all</span><span class="w"> </span><span class="p">(</span><span class="n">iterator</span><span class="p">.</span><span class="n">rs</span>:<span class="mi">2117</span><span class="p">)</span><span class="w"></span>
<span class="o">==</span><span class="mi">22915</span><span class="o">==</span><span class="w">    </span><span class="n">by</span><span class="w"> </span><span class="mh">0x4FEAB7</span>: <span class="nc">wasmtime_wast</span>::<span class="n">wast</span>::<span class="n">v128_matches</span><span class="w"> </span><span class="p">(</span><span class="n">wast</span><span class="p">.</span><span class="n">rs</span>:<span class="mi">507</span><span class="p">)</span><span class="w"></span>
<span class="o">==</span><span class="mi">22915</span><span class="o">==</span><span class="w">    </span><span class="n">by</span><span class="w"> </span><span class="mh">0x4FE497</span>: <span class="nc">wasmtime_wast</span>::<span class="n">wast</span>::<span class="n">val_matches</span><span class="w"> </span><span class="p">(</span><span class="n">wast</span><span class="p">.</span><span class="n">rs</span>:<span class="mi">451</span><span class="p">)</span><span class="w"></span>
<span class="o">==</span><span class="mi">22915</span><span class="o">==</span><span class="w">    </span><span class="n">by</span><span class="w"> </span><span class="mh">0x4FC757</span>: <span class="nc">wasmtime_wast</span>::<span class="n">wast</span>::<span class="n">WastContext</span>::<span class="n">assert_return</span><span class="w"> </span><span class="p">(</span><span class="n">wast</span><span class="p">.</span><span class="n">rs</span>:<span class="mi">186</span><span class="p">)</span><span class="w"></span>
<span class="o">==</span><span class="mi">22915</span><span class="o">==</span><span class="w">    </span><span class="n">by</span><span class="w"> </span><span class="mh">0x518A7F</span>: <span class="nc">wasmtime_wast</span>::<span class="n">wast</span>::<span class="n">WastContext</span>::<span class="n">run_directive</span><span class="w"> </span><span class="p">(</span><span class="n">wast</span><span class="p">.</span><span class="n">rs</span>:<span class="mi">287</span><span class="p">)</span><span class="w"></span>
<span class="o">==</span><span class="mi">22915</span><span class="o">==</span><span class="w">    </span><span class="n">by</span><span class="w"> </span><span class="mh">0x4FD713</span>: <span class="nc">wasmtime_wast</span>::<span class="n">wast</span>::<span class="n">WastContext</span>::<span class="n">run_buffer</span><span class="w"> </span><span class="p">(</span><span class="n">wast</span><span class="p">.</span><span class="n">rs</span>:<span class="mi">236</span><span class="p">)</span><span class="w"></span>
<span class="o">==</span><span class="mi">22915</span><span class="o">==</span><span class="w">    </span><span class="n">by</span><span class="w"> </span><span class="mh">0x4FDB01</span>: <span class="nc">wasmtime_wast</span>::<span class="n">wast</span>::<span class="n">WastContext</span>::<span class="n">run_file</span><span class="w"> </span><span class="p">(</span><span class="n">wast</span><span class="p">.</span><span class="n">rs</span>:<span class="mi">368</span><span class="p">)</span><span class="w"></span>
<span class="o">==</span><span class="mi">22915</span><span class="o">==</span><span class="w">    </span><span class="n">by</span><span class="w"> </span><span class="mh">0x404274</span>: <span class="nc">all</span>::<span class="n">wast</span>::<span class="n">run_wast</span><span class="w"> </span><span class="p">(</span><span class="n">wast</span><span class="p">.</span><span class="n">rs</span>:<span class="mi">48</span><span class="p">)</span><span class="w"></span>
<span class="o">==</span><span class="mi">22915</span><span class="o">==</span><span class="w">  </span><span class="n">Uninitialised</span><span class="w"> </span><span class="n">value</span><span class="w"> </span><span class="n">was</span><span class="w"> </span><span class="n">created</span><span class="w"> </span><span class="n">by</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="n">stack</span><span class="w"> </span><span class="n">allocation</span><span class="w"></span>
<span class="o">==</span><span class="mi">22915</span><span class="o">==</span><span class="w">    </span><span class="n">at</span><span class="w"> </span><span class="mh">0x8244E0</span>: <span class="o">&lt;</span><span class="n">core</span>::<span class="n">iter</span>::<span class="n">adapters</span>::<span class="n">zip</span>::<span class="n">Zip</span><span class="o">&lt;</span><span class="n">A</span><span class="p">,</span><span class="n">B</span><span class="o">&gt;</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">core</span>::<span class="n">iter</span>::<span class="n">adapters</span>::<span class="n">zip</span>::<span class="n">ZipImpl</span><span class="o">&lt;</span><span class="n">A</span><span class="p">,</span><span class="n">B</span><span class="o">&gt;&gt;</span>::<span class="n">get_unchecked</span><span class="w"> </span><span class="p">(</span><span class="n">zip</span><span class="p">.</span><span class="n">rs</span>:<span class="mi">291</span><span class="p">)</span><span class="w"></span>
<span class="o">==</span><span class="mi">22915</span><span class="o">==</span><span class="w"></span>
</code></pre></div><br>
</p>
</blockquote>



<a name="219391148"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20Issue%20%232432%20Investigate%20non-deterministic%20fail.../near/219391148" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20Issue.20.232432.20Investigate.20non-deterministic.20fail.2E.2E.2E.html#219391148">(Dec 09 2020 at 20:11)</a>:</h4>
<p>jlb6740 edited a <a href="https://github.com/bytecodealliance/wasmtime/issues/2432#issuecomment-742019865">comment</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/2432">Issue #2432</a>:</p>
<blockquote>
<p>@alexcrichton yes, just needs more investigation. I've confirmed that use of unitialized values still occurs with the latest build (e09b9400) with valgrind 3.16.1</p>
<p><div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="o">==</span><span class="mi">22915</span><span class="o">==</span><span class="w"> </span><span class="n">Conditional</span><span class="w"> </span><span class="n">jump</span><span class="w"> </span><span class="n">or</span><span class="w"> </span><span class="k">move</span><span class="w"> </span><span class="n">depends</span><span class="w"> </span><span class="n">on</span><span class="w"> </span><span class="n">uninitialised</span><span class="w"> </span><span class="n">value</span><span class="p">(</span><span class="n">s</span><span class="p">)</span><span class="w"></span>
<span class="o">==</span><span class="mi">22915</span><span class="o">==</span><span class="w">    </span><span class="n">at</span><span class="w"> </span><span class="mh">0x50D676</span>: <span class="nc">core</span>::<span class="n">iter</span>::<span class="n">traits</span>::<span class="n">iterator</span>::<span class="nb">Iterator</span>::<span class="n">all</span>::<span class="n">check</span>::<span class="p">{{</span><span class="n">closure</span><span class="p">}}</span><span class="w"> </span><span class="p">(</span><span class="n">iterator</span><span class="p">.</span><span class="n">rs</span>:<span class="mi">2114</span><span class="p">)</span><span class="w"></span>
<span class="o">==</span><span class="mi">22915</span><span class="o">==</span><span class="w">    </span><span class="n">by</span><span class="w"> </span><span class="mh">0x52297D</span>: <span class="o">&lt;</span><span class="n">core</span>::<span class="n">iter</span>::<span class="n">adapters</span>::<span class="n">Enumerate</span><span class="o">&lt;</span><span class="n">I</span><span class="o">&gt;</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">core</span>::<span class="n">iter</span>::<span class="n">traits</span>::<span class="n">iterator</span>::<span class="nb">Iterator</span><span class="o">&gt;</span>::<span class="n">try_fold</span>::<span class="n">enumerate</span>::<span class="p">{{</span><span class="n">closure</span><span class="p">}}</span><span class="w"> </span><span class="p">(</span><span class="k">mod</span><span class="p">.</span><span class="n">rs</span>:<span class="mi">1413</span><span class="p">)</span><span class="w"></span>
<span class="o">==</span><span class="mi">22915</span><span class="o">==</span><span class="w">    </span><span class="n">by</span><span class="w"> </span><span class="mh">0x50B1EB</span>: <span class="nc">core</span>::<span class="n">iter</span>::<span class="n">traits</span>::<span class="n">iterator</span>::<span class="nb">Iterator</span>::<span class="n">try_fold</span><span class="w"> </span><span class="p">(</span><span class="n">iterator</span><span class="p">.</span><span class="n">rs</span>:<span class="mi">1888</span><span class="p">)</span><span class="w"></span>
<span class="o">==</span><span class="mi">22915</span><span class="o">==</span><span class="w">    </span><span class="n">by</span><span class="w"> </span><span class="mh">0x522405</span>: <span class="o">&lt;</span><span class="n">core</span>::<span class="n">iter</span>::<span class="n">adapters</span>::<span class="n">Enumerate</span><span class="o">&lt;</span><span class="n">I</span><span class="o">&gt;</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">core</span>::<span class="n">iter</span>::<span class="n">traits</span>::<span class="n">iterator</span>::<span class="nb">Iterator</span><span class="o">&gt;</span>::<span class="n">try_fold</span><span class="w"> </span><span class="p">(</span><span class="k">mod</span><span class="p">.</span><span class="n">rs</span>:<span class="mi">1420</span><span class="p">)</span><span class="w"></span>
<span class="o">==</span><span class="mi">22915</span><span class="o">==</span><span class="w">    </span><span class="n">by</span><span class="w"> </span><span class="mh">0x51E660</span>: <span class="nc">core</span>::<span class="n">iter</span>::<span class="n">traits</span>::<span class="n">iterator</span>::<span class="nb">Iterator</span>::<span class="n">all</span><span class="w"> </span><span class="p">(</span><span class="n">iterator</span><span class="p">.</span><span class="n">rs</span>:<span class="mi">2117</span><span class="p">)</span><span class="w"></span>
<span class="o">==</span><span class="mi">22915</span><span class="o">==</span><span class="w">    </span><span class="n">by</span><span class="w"> </span><span class="mh">0x4FEAB7</span>: <span class="nc">wasmtime_wast</span>::<span class="n">wast</span>::<span class="n">v128_matches</span><span class="w"> </span><span class="p">(</span><span class="n">wast</span><span class="p">.</span><span class="n">rs</span>:<span class="mi">507</span><span class="p">)</span><span class="w"></span>
<span class="o">==</span><span class="mi">22915</span><span class="o">==</span><span class="w">    </span><span class="n">by</span><span class="w"> </span><span class="mh">0x4FE497</span>: <span class="nc">wasmtime_wast</span>::<span class="n">wast</span>::<span class="n">val_matches</span><span class="w"> </span><span class="p">(</span><span class="n">wast</span><span class="p">.</span><span class="n">rs</span>:<span class="mi">451</span><span class="p">)</span><span class="w"></span>
<span class="o">==</span><span class="mi">22915</span><span class="o">==</span><span class="w">    </span><span class="n">by</span><span class="w"> </span><span class="mh">0x4FC757</span>: <span class="nc">wasmtime_wast</span>::<span class="n">wast</span>::<span class="n">WastContext</span>::<span class="n">assert_return</span><span class="w"> </span><span class="p">(</span><span class="n">wast</span><span class="p">.</span><span class="n">rs</span>:<span class="mi">186</span><span class="p">)</span><span class="w"></span>
<span class="o">==</span><span class="mi">22915</span><span class="o">==</span><span class="w">    </span><span class="n">by</span><span class="w"> </span><span class="mh">0x518A7F</span>: <span class="nc">wasmtime_wast</span>::<span class="n">wast</span>::<span class="n">WastContext</span>::<span class="n">run_directive</span><span class="w"> </span><span class="p">(</span><span class="n">wast</span><span class="p">.</span><span class="n">rs</span>:<span class="mi">287</span><span class="p">)</span><span class="w"></span>
<span class="o">==</span><span class="mi">22915</span><span class="o">==</span><span class="w">    </span><span class="n">by</span><span class="w"> </span><span class="mh">0x4FD713</span>: <span class="nc">wasmtime_wast</span>::<span class="n">wast</span>::<span class="n">WastContext</span>::<span class="n">run_buffer</span><span class="w"> </span><span class="p">(</span><span class="n">wast</span><span class="p">.</span><span class="n">rs</span>:<span class="mi">236</span><span class="p">)</span><span class="w"></span>
<span class="o">==</span><span class="mi">22915</span><span class="o">==</span><span class="w">    </span><span class="n">by</span><span class="w"> </span><span class="mh">0x4FDB01</span>: <span class="nc">wasmtime_wast</span>::<span class="n">wast</span>::<span class="n">WastContext</span>::<span class="n">run_file</span><span class="w"> </span><span class="p">(</span><span class="n">wast</span><span class="p">.</span><span class="n">rs</span>:<span class="mi">368</span><span class="p">)</span><span class="w"></span>
<span class="o">==</span><span class="mi">22915</span><span class="o">==</span><span class="w">    </span><span class="n">by</span><span class="w"> </span><span class="mh">0x404274</span>: <span class="nc">all</span>::<span class="n">wast</span>::<span class="n">run_wast</span><span class="w"> </span><span class="p">(</span><span class="n">wast</span><span class="p">.</span><span class="n">rs</span>:<span class="mi">48</span><span class="p">)</span><span class="w"></span>
<span class="o">==</span><span class="mi">22915</span><span class="o">==</span><span class="w">  </span><span class="n">Uninitialised</span><span class="w"> </span><span class="n">value</span><span class="w"> </span><span class="n">was</span><span class="w"> </span><span class="n">created</span><span class="w"> </span><span class="n">by</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="n">stack</span><span class="w"> </span><span class="n">allocation</span><span class="w"></span>
<span class="o">==</span><span class="mi">22915</span><span class="o">==</span><span class="w">    </span><span class="n">at</span><span class="w"> </span><span class="mh">0x8244E0</span>: <span class="o">&lt;</span><span class="n">core</span>::<span class="n">iter</span>::<span class="n">adapters</span>::<span class="n">zip</span>::<span class="n">Zip</span><span class="o">&lt;</span><span class="n">A</span><span class="p">,</span><span class="n">B</span><span class="o">&gt;</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">core</span>::<span class="n">iter</span>::<span class="n">adapters</span>::<span class="n">zip</span>::<span class="n">ZipImpl</span><span class="o">&lt;</span><span class="n">A</span><span class="p">,</span><span class="n">B</span><span class="o">&gt;&gt;</span>::<span class="n">get_unchecked</span><span class="w"> </span><span class="p">(</span><span class="n">zip</span><span class="p">.</span><span class="n">rs</span>:<span class="mi">291</span><span class="p">)</span><span class="w"></span>
<span class="o">==</span><span class="mi">22915</span><span class="o">==</span><span class="w"></span>
</code></pre></div><br>
</p>
</blockquote>



<a name="222764978"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20Issue%20%232432%20Investigate%20non-deterministic%20fail.../near/222764978" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20Issue.20.232432.20Investigate.20non-deterministic.20fail.2E.2E.2E.html#222764978">(Jan 14 2021 at 18:57)</a>:</h4>
<p>jlb6740 <a href="https://github.com/bytecodealliance/wasmtime/issues/2432#issuecomment-760401678">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/2432">Issue #2432</a>:</p>
<blockquote>
<p>@abrown @cfallin Perhaps we can close this now? Please re-open if someone disagrees. </p>
</blockquote>



<a name="222764979"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20Issue%20%232432%20Investigate%20non-deterministic%20fail.../near/222764979" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20Issue.20.232432.20Investigate.20non-deterministic.20fail.2E.2E.2E.html#222764979">(Jan 14 2021 at 18:57)</a>:</h4>
<p>jlb6740 closed <a href="https://github.com/bytecodealliance/wasmtime/issues/2432">Issue #2432</a>:</p>
<blockquote>
<p>@jlb6740, I am opening this issue to track a failure I noticed with x64 SIMD: <a href="https://github.com/bytecodealliance/wasmtime/pull/2428/checks?check_run_id=1421136203#step:7:1582">https://github.com/bytecodealliance/wasmtime/pull/2428/checks?check_run_id=1421136203#step:7:1582</a></p>
</blockquote>



<hr><p>Last updated: Jan 20 2025 at 06:04 UTC</p>
</html>