<html>
<head><meta charset="utf-8"><title>wasmtime / issue #7997 libgcc_13: SIGABORT inside `Unwind... · git-wasmtime · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/index.html">git-wasmtime</a></h2>
<h3>Topic: <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.237997.20libgcc_13.3A.20SIGABORT.20inside.20.60Unwind.2E.2E.2E.html">wasmtime / issue #7997 libgcc_13: SIGABORT inside `Unwind...</a></h3>

<hr>

<base href="https://bytecodealliance.zulipchat.com">

<head><link href="https://bytecodealliance.github.io/zulip-archive/style.css" rel="stylesheet"></head>

<a name="423392939"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%237997%20libgcc_13%3A%20SIGABORT%20inside%20%60Unwind.../near/423392939" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.237997.20libgcc_13.3A.20SIGABORT.20inside.20.60Unwind.2E.2E.2E.html#423392939">(Feb 26 2024 at 13:14)</a>:</h4>
<p>Mr-Leshiy edited <a href="https://github.com/bytecodealliance/wasmtime/issues/7997">issue #7997</a>:</p>
<blockquote>
<p>We have faced a <code>SIGABORT</code> failure during executing simple benchmark which you can find here <a href="https://github.com/input-output-hk/hermes/blob/f4d20fc06f0b558be4805a106db32480bcef649d/hermes/bin/src/wasm/module.rs#L118">https://github.com/input-output-hk/hermes/blob/f4d20fc06f0b558be4805a106db32480bcef649d/hermes/bin/src/wasm/module.rs#L118</a>.<br>
According to the stack trace </p>
<h3>Steps to Reproduce</h3>
<p>You can fully reproduce it in already prepared environment and code but cloning our repo and specifically this branch <code>libgcc-wasmtime-unwinding-bug</code>. (repo: <a href="https://github.com/input-output-hk/hermes">https://github.com/input-output-hk/hermes</a>)</p>
<p>Before start you will need to install <a href="https://earthly.dev">earthly</a> tool.<br>
To run it you will need to execute the following in the root of the repo</p>
<div class="codehilite" data-code-language="Bash"><pre><span></span><code>earthly<span class="w"> </span>-I<span class="w"> </span>./hermes+alpine-3-19-fail
</code></pre></div>
<p>This will prepare an <code>alpine:3.19</code> environment with <code>rust:1.75</code> version and all our project configuration that we have an all source code and run a benchmarks.<br>
Earthfile code <a href="https://github.com/input-output-hk/hermes/blob/libgcc-wasmtime-unwinding-bug/hermes/Earthfile#L18">https://github.com/input-output-hk/hermes/blob/libgcc-wasmtime-unwinding-bug/hermes/Earthfile#L18</a></p>
<div class="codehilite" data-code-language="earthfile"><pre><span></span><code>alpine-3-19-fail:
    FROM rust:1.75-alpine3.19

    # Install necessary packages
    RUN apk add --no-cache \
            musl-dev \
            gdb

    COPY --dir .cargo .config crates bin .
    COPY Cargo.toml .
    COPY clippy.toml deny.toml rustfmt.toml .

    RUN mkdir /wasm
    COPY --dir ../wasm+wasi-src/wasi /wasm/wasi
    # Compiled WASM component for benchmarks
    COPY ../wasm/c+build/component.wasm /wasm/c/bench_component.wasm

    # Run benchmarks
    RUN cargo bench --features bench
</code></pre></div>
<p>After the failure it will run an interacting mode <code>-i</code> flag (similar to docker interactive mode).<br>
So you will be able to collect a dump file inside this container.</p>
<div class="codehilite" data-code-language="Bash"><pre><span></span><code><span class="nb">ulimit</span><span class="w"> </span>-c<span class="w"> </span>unlimited<span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span>./target/release/deps/module-&lt;&gt;<span class="w"> </span>--bench
</code></pre></div>
<p>Then inspect it and using <code>gdb</code></p>
<div class="codehilite" data-code-language="Bash"><pre><span></span><code>gdb<span class="w">  </span>./target/release/deps/module-&lt;&gt;<span class="w"> </span>core<span class="w"> </span>--<span class="w"> </span>--bench
</code></pre></div>
<h3>Actual Results</h3>
<p>SIGABORT</p>
<h3>Versions and Environment</h3>
<p>Wasmtime version or commit: 17.0.0</p>
<p>Operating system: alpine:3.19</p>
<h3>Extra Info</h3>
<p>This is totally works on <code>alpine:3.18</code> version with the <code>libgcc:12</code> version.<br>
We have found that most probable it is an issue with <code>libgcc</code> because, there is a huge difference with the libgcc unwinding implementation between these two versions.</p>
<p>libgcc_12 - <a href="https://github.com/gcc-mirror/gcc/blob/8cbb2cade4c724760c868c9f493b169d6ec4168a/libgcc/unwind-dw2-fde.c#L201">https://github.com/gcc-mirror/gcc/blob/8cbb2cade4c724760c868c9f493b169d6ec4168a/libgcc/unwind-dw2-fde.c#L201</a></p>
<p>libgcc_13 - <a href="https://github.com/gcc-mirror/gcc/blob/0e7bc3eaa36b81004b799124d2fe00137401a43b/libgcc/unwind-dw2-fde.c#L225">https://github.com/gcc-mirror/gcc/blob/0e7bc3eaa36b81004b799124d2fe00137401a43b/libgcc/unwind-dw2-fde.c#L225</a></p>
<p>You can try it running already prepared earthly target <a href="https://github.com/input-output-hk/hermes/blob/libgcc-wasmtime-unwinding-bug/hermes/Earthfile#L38">https://github.com/input-output-hk/hermes/blob/libgcc-wasmtime-unwinding-bug/hermes/Earthfile#L38</a></p>
<p><div class="codehilite" data-code-language="Bash"><pre><span></span><code>earthly<span class="w"> </span>./hermes+alpine-3-18-pass
</code></pre></div><br>
</p>
</blockquote>



<a name="423448777"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%237997%20libgcc_13%3A%20SIGABORT%20inside%20%60Unwind.../near/423448777" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.237997.20libgcc_13.3A.20SIGABORT.20inside.20.60Unwind.2E.2E.2E.html#423448777">(Feb 26 2024 at 17:28)</a>:</h4>
<p>alexcrichton <a href="https://github.com/bytecodealliance/wasmtime/issues/7997#issuecomment-1964710406">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/7997">issue #7997</a>:</p>
<blockquote>
<p>Thanks for the report! Would you be able to upload the wasm file here directly? Also would you be able to share a copy/paste of the stack trace you're seeing? I can't reproduce locally with a "hello-world" style module loaded into <code>alpine:3.19</code> so it seems that the issue may be related to the specific unwind table for the wasm file. I don't know much about <code>earthly</code> myself so I'm hopeful that the issue can be reduced relatively quickly to just a wasm file and some simple interactions with the <code>wasmtime</code> crate.</p>
</blockquote>



<a name="423453314"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%237997%20libgcc_13%3A%20SIGABORT%20inside%20%60Unwind.../near/423453314" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.237997.20libgcc_13.3A.20SIGABORT.20inside.20.60Unwind.2E.2E.2E.html#423453314">(Feb 26 2024 at 17:55)</a>:</h4>
<p>Mr-Leshiy edited <a href="https://github.com/bytecodealliance/wasmtime/issues/7997">issue #7997</a>:</p>
<blockquote>
<p>We have faced a <code>SIGABORT</code> failure during executing simple benchmark which you can find here <a href="https://github.com/input-output-hk/hermes/blob/f4d20fc06f0b558be4805a106db32480bcef649d/hermes/bin/src/wasm/module.rs#L118">https://github.com/input-output-hk/hermes/blob/f4d20fc06f0b558be4805a106db32480bcef649d/hermes/bin/src/wasm/module.rs#L118</a>.<br>
Stack trace:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code>#<span class="mi">0</span><span class="w">  </span><span class="n">__restore_sigs</span><span class="w"> </span><span class="p">(</span><span class="n">set</span><span class="o">=</span><span class="n">set</span><span class="o">@</span><span class="n">entry</span><span class="o">=</span><span class="mh">0xffffc437ab50</span><span class="p">)</span><span class="w"> </span><span class="n">at</span><span class="w"> </span><span class="p">.</span><span class="o">/</span><span class="n">arch</span><span class="o">/</span><span class="n">aarch64</span><span class="o">/</span><span class="n">syscall_arch</span><span class="p">.</span><span class="n">h</span>:<span class="mi">48</span>
#<span class="mi">1</span><span class="w">  </span><span class="mh">0x0000ffff9c2add5c</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="n">raise</span><span class="w"> </span><span class="p">(</span><span class="n">sig</span><span class="o">=</span><span class="n">sig</span><span class="o">@</span><span class="n">entry</span><span class="o">=</span><span class="mi">6</span><span class="p">)</span><span class="w"> </span><span class="n">at</span><span class="w"> </span><span class="n">src</span><span class="o">/</span><span class="n">signal</span><span class="o">/</span><span class="n">raise</span><span class="p">.</span><span class="n">c</span>:<span class="mi">11</span>
#<span class="mi">2</span><span class="w">  </span><span class="mh">0x0000ffff9c27cbf4</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="n">abort</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="n">at</span><span class="w"> </span><span class="n">src</span><span class="o">/</span><span class="n">exit</span><span class="o">/</span><span class="n">abort</span><span class="p">.</span><span class="n">c</span>:<span class="mi">11</span>
#<span class="mi">3</span><span class="w">  </span><span class="mh">0x0000ffff9c23e8fc</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="n">__deregister_frame_info_bases</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="n">from</span><span class="w"> </span><span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">libgcc_s</span><span class="p">.</span><span class="n">so</span><span class="p">.</span><span class="mi">1</span>
#<span class="mi">4</span><span class="w">  </span><span class="mh">0x0000ffff9c23e91c</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="n">__deregister_frame</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="n">from</span><span class="w"> </span><span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">libgcc_s</span><span class="p">.</span><span class="n">so</span><span class="p">.</span><span class="mi">1</span>
#<span class="mi">5</span><span class="w">  </span><span class="mh">0x0000aaaac2c0d0a8</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="n">wasmtime_runtime</span>::<span class="n">sys</span>::<span class="n">unix</span>::<span class="n">unwind</span>::<span class="p">{</span><span class="k">impl</span>#<span class="mi">1</span><span class="p">}</span>::<span class="nb">drop</span><span class="w"> </span><span class="p">(</span><span class="bp">self</span><span class="o">=&lt;</span><span class="n">optimized</span><span class="w"> </span><span class="n">out</span><span class="o">&gt;</span><span class="p">)</span><span class="w"> </span><span class="n">at</span><span class="w"> </span><span class="n">src</span><span class="o">/</span><span class="n">sys</span><span class="o">/</span><span class="n">unix</span><span class="o">/</span><span class="n">unwind</span><span class="p">.</span><span class="n">rs</span>:<span class="mi">87</span>
#<span class="mi">6</span><span class="w">  </span><span class="mh">0x0000aaaac2ba2ba8</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="n">core</span>::<span class="n">ptr</span>::<span class="n">drop_in_place</span><span class="o">&lt;</span><span class="n">wasmtime_runtime</span>::<span class="n">sys</span>::<span class="n">unix</span>::<span class="n">unwind</span>::<span class="n">UnwindRegistration</span><span class="o">&gt;</span><span class="w"> </span><span class="p">()</span>
<span class="w">    </span><span class="n">at</span><span class="w"> </span><span class="o">/</span><span class="n">rustc</span><span class="o">/</span><span class="mf">82e1608</span><span class="n">dfa6e0b5569232559e3d385fea5a93112</span><span class="o">/</span><span class="n">library</span><span class="o">/</span><span class="n">core</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">ptr</span><span class="o">/</span><span class="k">mod</span><span class="p">.</span><span class="n">rs</span>:<span class="mi">498</span>
#<span class="mi">7</span><span class="w">  </span><span class="n">core</span>::<span class="n">ptr</span>::<span class="n">drop_in_place</span><span class="o">&lt;</span><span class="n">core</span>::<span class="n">option</span>::<span class="nb">Option</span><span class="o">&lt;</span><span class="n">wasmtime_runtime</span>::<span class="n">sys</span>::<span class="n">unix</span>::<span class="n">unwind</span>::<span class="n">UnwindRegistration</span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="p">()</span>
<span class="w">    </span><span class="n">at</span><span class="w"> </span><span class="o">/</span><span class="n">rustc</span><span class="o">/</span><span class="mf">82e1608</span><span class="n">dfa6e0b5569232559e3d385fea5a93112</span><span class="o">/</span><span class="n">library</span><span class="o">/</span><span class="n">core</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">ptr</span><span class="o">/</span><span class="k">mod</span><span class="p">.</span><span class="n">rs</span>:<span class="mi">498</span>
#<span class="mi">8</span><span class="w">  </span><span class="mh">0x0000aaaac2bb4d5c</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="n">core</span>::<span class="n">mem</span>::<span class="n">manually_drop</span>::<span class="n">ManuallyDrop</span><span class="o">&lt;</span><span class="n">core</span>::<span class="n">option</span>::<span class="nb">Option</span><span class="o">&lt;</span><span class="n">wasmtime_runtime</span>::<span class="n">sys</span>::<span class="n">unix</span>::<span class="n">unwind</span>::<span class="n">UnwindRegistration</span><span class="o">&gt;&gt;</span>::<span class="nb">drop</span><span class="o">&lt;</span><span class="n">core</span>::<span class="n">option</span>::<span class="nb">Option</span><span class="o">&lt;</span><span class="n">wasmtime_runtime</span>::<span class="n">sys</span>::<span class="n">unix</span>::<span class="n">unwind</span>::<span class="n">UnwindRegistration</span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="p">(</span><span class="n">slot</span><span class="o">=</span><span class="mh">0x0</span><span class="p">)</span>
<span class="w">    </span><span class="n">at</span><span class="w"> </span><span class="o">/</span><span class="n">rustc</span><span class="o">/</span><span class="mf">82e1608</span><span class="n">dfa6e0b5569232559e3d385fea5a93112</span><span class="o">/</span><span class="n">library</span><span class="o">/</span><span class="n">core</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">mem</span><span class="o">/</span><span class="n">manually_drop</span><span class="p">.</span><span class="n">rs</span>:<span class="mi">144</span>
<span class="o">--</span><span class="n">Type</span><span class="w"> </span><span class="o">&lt;</span><span class="n">RET</span><span class="o">&gt;</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">more</span><span class="p">,</span><span class="w"> </span><span class="n">q</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">quit</span><span class="p">,</span><span class="w"> </span><span class="n">c</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="k">continue</span><span class="w"> </span><span class="n">without</span><span class="w"> </span><span class="n">paging</span><span class="o">--</span>
#<span class="mi">9</span><span class="w">  </span><span class="n">wasmtime_jit</span>::<span class="n">code_memory</span>::<span class="p">{</span><span class="k">impl</span>#<span class="mi">0</span><span class="p">}</span>::<span class="nb">drop</span><span class="w"> </span><span class="p">(</span><span class="bp">self</span><span class="o">=</span><span class="mh">0xffff9c216eb0</span><span class="p">)</span><span class="w"> </span><span class="n">at</span><span class="w"> </span><span class="n">src</span><span class="o">/</span><span class="n">code_memory</span><span class="p">.</span><span class="n">rs</span>:<span class="mi">42</span>
#<span class="mi">10</span><span class="w"> </span><span class="n">core</span>::<span class="n">ptr</span>::<span class="n">drop_in_place</span><span class="o">&lt;</span><span class="n">wasmtime_jit</span>::<span class="n">code_memory</span>::<span class="n">CodeMemory</span><span class="o">&gt;</span><span class="w"> </span><span class="p">()</span>
<span class="w">    </span><span class="n">at</span><span class="w"> </span><span class="o">/</span><span class="n">rustc</span><span class="o">/</span><span class="mf">82e1608</span><span class="n">dfa6e0b5569232559e3d385fea5a93112</span><span class="o">/</span><span class="n">library</span><span class="o">/</span><span class="n">core</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">ptr</span><span class="o">/</span><span class="k">mod</span><span class="p">.</span><span class="n">rs</span>:<span class="mi">498</span>
#<span class="mi">11</span><span class="w"> </span><span class="n">alloc</span>::<span class="n">sync</span>::<span class="n">Arc</span><span class="o">&lt;</span><span class="n">wasmtime_jit</span>::<span class="n">code_memory</span>::<span class="n">CodeMemory</span><span class="p">,</span><span class="w"> </span><span class="n">alloc</span>::<span class="n">alloc</span>::<span class="n">Global</span><span class="o">&gt;</span>::<span class="n">drop_slow</span><span class="o">&lt;</span><span class="n">wasmtime_jit</span>::<span class="n">code_memory</span>::<span class="n">CodeMemory</span><span class="p">,</span><span class="w"> </span><span class="n">alloc</span>::<span class="n">alloc</span>::<span class="n">Global</span><span class="o">&gt;</span><span class="w"> </span><span class="p">(</span><span class="bp">self</span><span class="o">=&lt;</span><span class="n">optimized</span><span class="w"> </span><span class="n">out</span><span class="o">&gt;</span><span class="p">)</span><span class="w"> </span><span class="n">at</span><span class="w"> </span><span class="o">/</span><span class="n">rustc</span><span class="o">/</span><span class="mf">82e1608</span><span class="n">dfa6e0b5569232559e3d385fea5a93112</span><span class="o">/</span><span class="n">library</span><span class="o">/</span><span class="n">alloc</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">sync</span><span class="p">.</span><span class="n">rs</span>:<span class="mi">1752</span>
#<span class="mi">12</span><span class="w"> </span><span class="mh">0x0000aaaac27cfcb8</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="n">alloc</span>::<span class="n">sync</span>::<span class="p">{</span><span class="k">impl</span>#<span class="mi">33</span><span class="p">}</span>::<span class="nb">drop</span><span class="o">&lt;</span><span class="n">wasmtime_jit</span>::<span class="n">code_memory</span>::<span class="n">CodeMemory</span><span class="p">,</span><span class="w"> </span><span class="n">alloc</span>::<span class="n">alloc</span>::<span class="n">Global</span><span class="o">&gt;</span><span class="w"> </span><span class="p">(</span>
<span class="w">    </span><span class="bp">self</span><span class="o">=</span><span class="mh">0xffff9c213540</span><span class="p">)</span><span class="w"> </span><span class="n">at</span><span class="w"> </span><span class="o">/</span><span class="n">rustc</span><span class="o">/</span><span class="mf">82e1608</span><span class="n">dfa6e0b5569232559e3d385fea5a93112</span><span class="o">/</span><span class="n">library</span><span class="o">/</span><span class="n">alloc</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">sync</span><span class="p">.</span><span class="n">rs</span>:<span class="mi">2408</span>
#<span class="mi">13</span><span class="w"> </span><span class="n">core</span>::<span class="n">ptr</span>::<span class="n">drop_in_place</span><span class="o">&lt;</span><span class="n">alloc</span>::<span class="n">sync</span>::<span class="n">Arc</span><span class="o">&lt;</span><span class="n">wasmtime_jit</span>::<span class="n">code_memory</span>::<span class="n">CodeMemory</span><span class="p">,</span><span class="w"> </span><span class="n">alloc</span>::<span class="n">alloc</span>::<span class="n">Global</span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="p">()</span>
<span class="w">    </span><span class="n">at</span><span class="w"> </span><span class="o">/</span><span class="n">rustc</span><span class="o">/</span><span class="mf">82e1608</span><span class="n">dfa6e0b5569232559e3d385fea5a93112</span><span class="o">/</span><span class="n">library</span><span class="o">/</span><span class="n">core</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">ptr</span><span class="o">/</span><span class="k">mod</span><span class="p">.</span><span class="n">rs</span>:<span class="mi">498</span>
#<span class="mi">14</span><span class="w"> </span><span class="n">core</span>::<span class="n">ptr</span>::<span class="n">drop_in_place</span><span class="o">&lt;</span><span class="n">wasmtime</span>::<span class="n">code</span>::<span class="n">CodeObject</span><span class="o">&gt;</span><span class="w"> </span><span class="p">()</span>
<span class="w">    </span><span class="n">at</span><span class="w"> </span><span class="o">/</span><span class="n">rustc</span><span class="o">/</span><span class="mf">82e1608</span><span class="n">dfa6e0b5569232559e3d385fea5a93112</span><span class="o">/</span><span class="n">library</span><span class="o">/</span><span class="n">core</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">ptr</span><span class="o">/</span><span class="k">mod</span><span class="p">.</span><span class="n">rs</span>:<span class="mi">498</span>
#<span class="mi">15</span><span class="w"> </span><span class="n">alloc</span>::<span class="n">sync</span>::<span class="n">Arc</span><span class="o">&lt;</span><span class="n">wasmtime</span>::<span class="n">code</span>::<span class="n">CodeObject</span><span class="p">,</span><span class="w"> </span><span class="n">alloc</span>::<span class="n">alloc</span>::<span class="n">Global</span><span class="o">&gt;</span>::<span class="n">drop_slow</span><span class="o">&lt;</span><span class="n">wasmtime</span>::<span class="n">code</span>::<span class="n">CodeObject</span><span class="p">,</span><span class="w"> </span><span class="n">alloc</span>::<span class="n">alloc</span>::<span class="n">Global</span><span class="o">&gt;</span><span class="w"> </span><span class="p">(</span>
<span class="w">    </span><span class="bp">self</span><span class="o">=&lt;</span><span class="n">optimized</span><span class="w"> </span><span class="n">out</span><span class="o">&gt;</span><span class="p">)</span><span class="w"> </span><span class="n">at</span><span class="w"> </span><span class="o">/</span><span class="n">rustc</span><span class="o">/</span><span class="mf">82e1608</span><span class="n">dfa6e0b5569232559e3d385fea5a93112</span><span class="o">/</span><span class="n">library</span><span class="o">/</span><span class="n">alloc</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">sync</span><span class="p">.</span><span class="n">rs</span>:<span class="mi">1752</span>
<span class="o">--</span><span class="n">Type</span><span class="w"> </span><span class="o">&lt;</span><span class="n">RET</span><span class="o">&gt;</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">more</span><span class="p">,</span><span class="w"> </span><span class="n">q</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">quit</span><span class="p">,</span><span class="w"> </span><span class="n">c</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="k">continue</span><span class="w"> </span><span class="n">without</span><span class="w"> </span><span class="n">paging</span><span class="o">--</span>
#<span class="mi">16</span><span class="w"> </span><span class="mh">0x0000aaaac27d06a8</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="n">alloc</span>::<span class="n">sync</span>::<span class="p">{</span><span class="k">impl</span>#<span class="mi">33</span><span class="p">}</span>::<span class="nb">drop</span><span class="o">&lt;</span><span class="n">wasmtime</span>::<span class="n">code</span>::<span class="n">CodeObject</span><span class="p">,</span><span class="w"> </span><span class="n">alloc</span>::<span class="n">alloc</span>::<span class="n">Global</span><span class="o">&gt;</span><span class="w"> </span><span class="p">(</span><span class="bp">self</span><span class="o">=</span><span class="mh">0x0</span><span class="p">)</span>
<span class="w">    </span><span class="n">at</span><span class="w"> </span><span class="o">/</span><span class="n">rustc</span><span class="o">/</span><span class="mf">82e1608</span><span class="n">dfa6e0b5569232559e3d385fea5a93112</span><span class="o">/</span><span class="n">library</span><span class="o">/</span><span class="n">alloc</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">sync</span><span class="p">.</span><span class="n">rs</span>:<span class="mi">2408</span>
#<span class="mi">17</span><span class="w"> </span><span class="n">core</span>::<span class="n">ptr</span>::<span class="n">drop_in_place</span><span class="o">&lt;</span><span class="n">alloc</span>::<span class="n">sync</span>::<span class="n">Arc</span><span class="o">&lt;</span><span class="n">wasmtime</span>::<span class="n">code</span>::<span class="n">CodeObject</span><span class="p">,</span><span class="w"> </span><span class="n">alloc</span>::<span class="n">alloc</span>::<span class="n">Global</span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="p">()</span>
<span class="w">    </span><span class="n">at</span><span class="w"> </span><span class="o">/</span><span class="n">rustc</span><span class="o">/</span><span class="mf">82e1608</span><span class="n">dfa6e0b5569232559e3d385fea5a93112</span><span class="o">/</span><span class="n">library</span><span class="o">/</span><span class="n">core</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">ptr</span><span class="o">/</span><span class="k">mod</span><span class="p">.</span><span class="n">rs</span>:<span class="mi">498</span>
#<span class="mi">18</span><span class="w"> </span><span class="n">core</span>::<span class="n">ptr</span>::<span class="n">drop_in_place</span><span class="o">&lt;</span><span class="n">wasmtime</span>::<span class="n">component</span>::<span class="n">component</span>::<span class="n">ComponentInner</span><span class="o">&gt;</span><span class="w"> </span><span class="p">()</span>
<span class="w">    </span><span class="n">at</span><span class="w"> </span><span class="o">/</span><span class="n">rustc</span><span class="o">/</span><span class="mf">82e1608</span><span class="n">dfa6e0b5569232559e3d385fea5a93112</span><span class="o">/</span><span class="n">library</span><span class="o">/</span><span class="n">core</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">ptr</span><span class="o">/</span><span class="k">mod</span><span class="p">.</span><span class="n">rs</span>:<span class="mi">498</span>
#<span class="mi">19</span><span class="w"> </span><span class="n">alloc</span>::<span class="n">sync</span>::<span class="n">Arc</span><span class="o">&lt;</span><span class="n">wasmtime</span>::<span class="n">component</span>::<span class="n">component</span>::<span class="n">ComponentInner</span><span class="p">,</span><span class="w"> </span><span class="n">alloc</span>::<span class="n">alloc</span>::<span class="n">Global</span><span class="o">&gt;</span>::<span class="n">drop_slow</span><span class="o">&lt;</span><span class="n">wasmtime</span>::<span class="n">component</span>::<span class="n">component</span>::<span class="n">ComponentInner</span><span class="p">,</span><span class="w"> </span><span class="n">alloc</span>::<span class="n">alloc</span>::<span class="n">Global</span><span class="o">&gt;</span><span class="w"> </span><span class="p">(</span><span class="bp">self</span><span class="o">=&lt;</span><span class="n">optimized</span><span class="w"> </span><span class="n">out</span><span class="o">&gt;</span><span class="p">)</span>
<span class="w">    </span><span class="n">at</span><span class="w"> </span><span class="o">/</span><span class="n">rustc</span><span class="o">/</span><span class="mf">82e1608</span><span class="n">dfa6e0b5569232559e3d385fea5a93112</span><span class="o">/</span><span class="n">library</span><span class="o">/</span><span class="n">alloc</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">sync</span><span class="p">.</span><span class="n">rs</span>:<span class="mi">1752</span>
#<span class="mi">20</span><span class="w"> </span><span class="mh">0x0000aaaac275d494</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="n">alloc</span>::<span class="n">sync</span>::<span class="p">{</span><span class="k">impl</span>#<span class="mi">33</span><span class="p">}</span>::<span class="nb">drop</span><span class="o">&lt;</span><span class="n">wasmtime</span>::<span class="n">component</span>::<span class="n">component</span>::<span class="n">ComponentInner</span><span class="p">,</span><span class="w"> </span><span class="n">alloc</span>::<span class="n">alloc</span>::<span class="n">Global</span><span class="o">&gt;</span><span class="w"> </span><span class="p">(</span>
<span class="w">    </span><span class="bp">self</span><span class="o">=</span><span class="mh">0xffffc437ad40</span><span class="p">)</span><span class="w"> </span><span class="n">at</span><span class="w"> </span><span class="n">rustc</span><span class="o">/</span><span class="mf">82e1608</span><span class="n">dfa6e0b5569232559e3d385fea5a93112</span><span class="o">/</span><span class="n">library</span><span class="o">/</span><span class="n">alloc</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">sync</span><span class="p">.</span><span class="n">rs</span>:<span class="mi">2408</span>
#<span class="mi">21</span><span class="w"> </span><span class="n">core</span>::<span class="n">ptr</span>::<span class="n">drop_in_place</span><span class="o">&lt;</span><span class="n">alloc</span>::<span class="n">sync</span>::<span class="n">Arc</span><span class="o">&lt;</span><span class="n">wasmtime</span>::<span class="n">component</span>::<span class="n">component</span>::<span class="n">ComponentInner</span><span class="p">,</span><span class="w"> </span><span class="n">alloc</span>::<span class="n">alloc</span>::<span class="n">Global</span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="p">()</span>
<span class="w">    </span><span class="n">at</span><span class="w"> </span><span class="n">rustc</span><span class="o">/</span><span class="mf">82e1608</span><span class="n">dfa6e0b5569232559e3d385fea5a93112</span><span class="o">/</span><span class="n">library</span><span class="o">/</span><span class="n">core</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">ptr</span><span class="o">/</span><span class="k">mod</span><span class="p">.</span><span class="n">rs</span>:<span class="mi">498</span>
<span class="o">--</span><span class="n">Type</span><span class="w"> </span><span class="o">&lt;</span><span class="n">RET</span><span class="o">&gt;</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">more</span><span class="p">,</span><span class="w"> </span><span class="n">q</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">quit</span><span class="p">,</span><span class="w"> </span><span class="n">c</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="k">continue</span><span class="w"> </span><span class="n">without</span><span class="w"> </span><span class="n">paging</span><span class="o">--</span>
#<span class="mi">22</span><span class="w"> </span><span class="n">core</span>::<span class="n">ptr</span>::<span class="n">drop_in_place</span><span class="o">&lt;</span><span class="n">wasmtime</span>::<span class="n">component</span>::<span class="n">component</span>::<span class="n">Component</span><span class="o">&gt;</span><span class="w"> </span><span class="p">()</span>
<span class="w">    </span><span class="n">at</span><span class="w"> </span><span class="n">rustc</span><span class="o">/</span><span class="mf">82e1608</span><span class="n">dfa6e0b5569232559e3d385fea5a93112</span><span class="o">/</span><span class="n">library</span><span class="o">/</span><span class="n">core</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">ptr</span><span class="o">/</span><span class="k">mod</span><span class="p">.</span><span class="n">rs</span>:<span class="mi">498</span>
#<span class="mi">23</span><span class="w"> </span><span class="n">core</span>::<span class="n">ptr</span>::<span class="n">drop_in_place</span><span class="o">&lt;</span><span class="n">wasmtime</span>::<span class="n">component</span>::<span class="n">instance</span>::<span class="n">InstancePre</span><span class="o">&lt;</span><span class="n">hermes</span>::<span class="n">state</span>::<span class="n">HermesState</span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="p">()</span>
<span class="w">    </span><span class="n">at</span><span class="w"> </span><span class="n">rustc</span><span class="o">/</span><span class="mf">82e1608</span><span class="n">dfa6e0b5569232559e3d385fea5a93112</span><span class="o">/</span><span class="n">library</span><span class="o">/</span><span class="n">core</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">ptr</span><span class="o">/</span><span class="k">mod</span><span class="p">.</span><span class="n">rs</span>:<span class="mi">498</span>
#<span class="mi">24</span><span class="w"> </span><span class="mh">0x0000aaaac275b390</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="n">core</span>::<span class="n">ptr</span>::<span class="n">drop_in_place</span><span class="o">&lt;</span><span class="n">hermes</span>::<span class="n">wasm</span>::<span class="n">module</span>::<span class="n">Module</span><span class="o">&gt;</span><span class="w"> </span><span class="p">()</span>
<span class="w">    </span><span class="n">at</span><span class="w"> </span><span class="n">rustc</span><span class="o">/</span><span class="mf">82e1608</span><span class="n">dfa6e0b5569232559e3d385fea5a93112</span><span class="o">/</span><span class="n">library</span><span class="o">/</span><span class="n">core</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">ptr</span><span class="o">/</span><span class="k">mod</span><span class="p">.</span><span class="n">rs</span>:<span class="mi">498</span>
#<span class="mi">25</span><span class="w"> </span><span class="mh">0x0000aaaac2761460</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="n">hermes</span>::<span class="n">wasm</span>::<span class="n">module</span>::<span class="n">bench</span>::<span class="n">module_hermes_component_bench</span><span class="w"> </span><span class="p">(</span><span class="n">b</span><span class="o">=</span><span class="mh">0xffffc437ae30</span><span class="p">)</span><span class="w"> </span><span class="n">at</span><span class="w"> </span><span class="n">bin</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">wasm</span><span class="o">/</span><span class="n">module</span><span class="p">.</span><span class="n">rs</span>:<span class="mi">143</span>
</code></pre></div>
<h3>Steps to Reproduce</h3>
<p>You can fully reproduce it in already prepared environment and code but cloning our repo and specifically this branch <code>libgcc-wasmtime-unwinding-bug</code>. (repo: <a href="https://github.com/input-output-hk/hermes">https://github.com/input-output-hk/hermes</a>)</p>
<p>Before start you will need to install <a href="https://earthly.dev">earthly</a> tool.<br>
To run it you will need to execute the following in the root of the repo</p>
<div class="codehilite" data-code-language="Bash"><pre><span></span><code>earthly<span class="w"> </span>-I<span class="w"> </span>./hermes+alpine-3-19-fail
</code></pre></div>
<p>This will prepare an <code>alpine:3.19</code> environment with <code>rust:1.75</code> version and all our project configuration that we have an all source code and run a benchmarks.<br>
Earthfile code <a href="https://github.com/input-output-hk/hermes/blob/libgcc-wasmtime-unwinding-bug/hermes/Earthfile#L18">https://github.com/input-output-hk/hermes/blob/libgcc-wasmtime-unwinding-bug/hermes/Earthfile#L18</a></p>
<div class="codehilite" data-code-language="earthfile"><pre><span></span><code>alpine-3-19-fail:
    FROM rust:1.75-alpine3.19

    # Install necessary packages
    RUN apk add --no-cache \
            musl-dev \
            gdb

    COPY --dir .cargo .config crates bin .
    COPY Cargo.toml .
    COPY clippy.toml deny.toml rustfmt.toml .

    RUN mkdir /wasm
    COPY --dir ../wasm+wasi-src/wasi /wasm/wasi
    # Compiled WASM component for benchmarks
    COPY ../wasm/c+build/component.wasm /wasm/c/bench_component.wasm

    # Run benchmarks
    RUN cargo bench --features bench
</code></pre></div>
<p>After the failure it will run an interacting mode <code>-i</code> flag (similar to docker interactive mode).<br>
So you will be able to collect a dump file inside this container.</p>
<div class="codehilite" data-code-language="Bash"><pre><span></span><code><span class="nb">ulimit</span><span class="w"> </span>-c<span class="w"> </span>unlimited<span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span>./target/release/deps/module-&lt;&gt;<span class="w"> </span>--bench
</code></pre></div>
<p>Then inspect it and using <code>gdb</code></p>
<div class="codehilite" data-code-language="Bash"><pre><span></span><code>gdb<span class="w">  </span>./target/release/deps/module-&lt;&gt;<span class="w"> </span>core<span class="w"> </span>--<span class="w"> </span>--bench
</code></pre></div>
<h3>Actual Results</h3>
<p>SIGABORT</p>
<h3>Versions and Environment</h3>
<p>Wasmtime version or commit: 17.0.0</p>
<p>Operating system: alpine:3.19</p>
<h3>Extra Info</h3>
<p>This is totally works on <code>alpine:3.18</code> version with the <code>libgcc:12</code> version.<br>
We have found that most probable it is an issue with <code>libgcc</code> because, there is a huge difference with the libgcc unwinding implementation between these two versions.</p>
<p>libgcc_12 - <a href="https://github.com/gcc-mirror/gcc/blob/8cbb2cade4c724760c868c9f493b169d6ec4168a/libgcc/unwind-dw2-fde.c#L201">https://github.com/gcc-mirror/gcc/blob/8cbb2cade4c724760c868c9f493b169d6ec4168a/libgcc/unwind-dw2-fde.c#L201</a></p>
<p>libgcc_13 - <a href="https://github.com/gcc-mirror/gcc/blob/0e7bc3eaa36b81004b799124d2fe00137401a43b/libgcc/unwind-dw2-fde.c#L225">https://github.com/gcc-mirror/gcc/blob/0e7bc3eaa36b81004b799124d2fe00137401a43b/libgcc/unwind-dw2-fde.c#L225</a></p>
<p>You can try it running already prepared earthly target <a href="https://github.com/input-output-hk/hermes/blob/libgcc-wasmtime-unwinding-bug/hermes/Earthfile#L38">https://github.com/input-output-hk/hermes/blob/libgcc-wasmtime-unwinding-bug/hermes/Earthfile#L38</a></p>
<p><div class="codehilite" data-code-language="Bash"><pre><span></span><code>earthly<span class="w"> </span>./hermes+alpine-3-18-pass
</code></pre></div><br>
</p>
</blockquote>



<a name="423550499"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%237997%20libgcc_13%3A%20SIGABORT%20inside%20%60Unwind.../near/423550499" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.237997.20libgcc_13.3A.20SIGABORT.20inside.20.60Unwind.2E.2E.2E.html#423550499">(Feb 27 2024 at 07:57)</a>:</h4>
<p>Mr-Leshiy <a href="https://github.com/bytecodealliance/wasmtime/issues/7997#issuecomment-1965975966">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/7997">issue #7997</a>:</p>
<blockquote>
<p>@alexcrichton Yea, this bug appears with this specific WASM component.</p>
<p>Give me some time I will try to make a separate simple project reproducing this thing.</p>
<p><a href="https://github.com/bytecodealliance/wasmtime/files/14416067/bench_component.wasm.zip">bench_component.wasm.zip</a><br>
</p>
</blockquote>



<a name="423689563"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%237997%20libgcc_13%3A%20SIGABORT%20inside%20%60Unwind.../near/423689563" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.237997.20libgcc_13.3A.20SIGABORT.20inside.20.60Unwind.2E.2E.2E.html#423689563">(Feb 27 2024 at 20:23)</a>:</h4>
<p>alexcrichton <a href="https://github.com/bytecodealliance/wasmtime/issues/7997#issuecomment-1967529403">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/7997">issue #7997</a>:</p>
<blockquote>
<p>Ok thanks for the component! Looks like just compiling the component, dropping it, and doing that a few times is not sufficient to trigger any bugs. A more minimal repro would be much appreciated, even if it's just a high-level description of how the component is instantiated and worked with. A runnable repro would be perfect!</p>
<p>Otherwise though I'll try to dig in later this week and see if I can't see anything that's awry.</p>
</blockquote>



<a name="423938362"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%237997%20libgcc_13%3A%20SIGABORT%20inside%20%60Unwind.../near/423938362" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.237997.20libgcc_13.3A.20SIGABORT.20inside.20.60Unwind.2E.2E.2E.html#423938362">(Feb 29 2024 at 02:16)</a>:</h4>
<p>alexcrichton <a href="https://github.com/bytecodealliance/wasmtime/issues/7997#issuecomment-1970274767">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/7997">issue #7997</a>:</p>
<blockquote>
<p>Ok I'm able to reproduce this with:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="k">use</span><span class="w"> </span><span class="n">wasmtime</span>::<span class="o">*</span><span class="p">;</span>

<span class="k">fn</span> <span class="nf">main</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="mi">0</span><span class="o">..</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="fm">println!</span><span class="p">(</span><span class="s">"{i}"</span><span class="p">);</span>
<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">config</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Config</span>::<span class="n">new</span><span class="p">();</span>
<span class="w">        </span><span class="n">config</span><span class="p">.</span><span class="n">parallel_compilation</span><span class="p">(</span><span class="kc">false</span><span class="p">);</span>
<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="n">e</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Engine</span>::<span class="n">new</span><span class="p">(</span><span class="o">&amp;</span><span class="n">config</span><span class="p">).</span><span class="n">unwrap</span><span class="p">();</span>
<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="n">m</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">component</span>::<span class="n">Component</span>::<span class="n">from_file</span><span class="p">(</span><span class="o">&amp;</span><span class="n">e</span><span class="p">,</span><span class="w"> </span><span class="s">"/src/bench_component.wasm"</span><span class="p">).</span><span class="n">unwrap</span><span class="p">();</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
<p>when specifically compiling with <code>RUSTFLAGS='-Ctarget-feature=-crt-static'</code> in a <code>rust:1.75-alpine3.19</code> container.</p>
<p>Still trying to figure out what's going on here, but in the meantime setting <a href="https://docs.rs/wasmtime/latest/wasmtime/struct.Config.html#method.native_unwind_info">this config</a> to <code>false</code> should fix the issue.</p>
</blockquote>



<a name="423941479"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%237997%20libgcc_13%3A%20SIGABORT%20inside%20%60Unwind.../near/423941479" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.237997.20libgcc_13.3A.20SIGABORT.20inside.20.60Unwind.2E.2E.2E.html#423941479">(Feb 29 2024 at 02:56)</a>:</h4>
<p>alexcrichton <a href="https://github.com/bytecodealliance/wasmtime/issues/7997#issuecomment-1970307030">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/7997">issue #7997</a>:</p>
<blockquote>
<p>Ok and I think that <a href="https://github.com/bytecodealliance/wasmtime/pull/8028">https://github.com/bytecodealliance/wasmtime/pull/8028</a> should completely fix this</p>
</blockquote>



<a name="423963875"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%237997%20libgcc_13%3A%20SIGABORT%20inside%20%60Unwind.../near/423963875" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.237997.20libgcc_13.3A.20SIGABORT.20inside.20.60Unwind.2E.2E.2E.html#423963875">(Feb 29 2024 at 07:34)</a>:</h4>
<p>Mr-Leshiy <a href="https://github.com/bytecodealliance/wasmtime/issues/7997#issuecomment-1970565638">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/7997">issue #7997</a>:</p>
<blockquote>
<p>@alexcrichton BTW don't you think it could be a bug inside the libgcc as well ?</p>
</blockquote>



<a name="424056649"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%237997%20libgcc_13%3A%20SIGABORT%20inside%20%60Unwind.../near/424056649" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.237997.20libgcc_13.3A.20SIGABORT.20inside.20.60Unwind.2E.2E.2E.html#424056649">(Feb 29 2024 at 16:20)</a>:</h4>
<p>alexcrichton <a href="https://github.com/bytecodealliance/wasmtime/issues/7997#issuecomment-1971490620">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/7997">issue #7997</a>:</p>
<blockquote>
<p>Perhaps! I wouldn't be able to conclude that with any certainty though. The libgcc code is pretty opaque to me. I think it's probably lucky that this worked before because libgcc's interface is clearly different than libunwind's and we were using the wrong one on musl. With the above PR we should correctly use the libgcc-desired interface on musl by seeing that libunwind isn't available.</p>
</blockquote>



<a name="424067519"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%237997%20libgcc_13%3A%20SIGABORT%20inside%20%60Unwind.../near/424067519" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.237997.20libgcc_13.3A.20SIGABORT.20inside.20.60Unwind.2E.2E.2E.html#424067519">(Feb 29 2024 at 17:10)</a>:</h4>
<p>Mr-Leshiy <a href="https://github.com/bytecodealliance/wasmtime/issues/7997#issuecomment-1971590355">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/7997">issue #7997</a>:</p>
<blockquote>
<p>I see, thank a lot for your so quick response !<br>
Will apply this patch to our code in days and let you know how it works.</p>
</blockquote>



<a name="424067550"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%237997%20libgcc_13%3A%20SIGABORT%20inside%20%60Unwind.../near/424067550" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.237997.20libgcc_13.3A.20SIGABORT.20inside.20.60Unwind.2E.2E.2E.html#424067550">(Feb 29 2024 at 17:11)</a>:</h4>
<p>Mr-Leshiy edited a <a href="https://github.com/bytecodealliance/wasmtime/issues/7997#issuecomment-1971590355">comment</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/7997">issue #7997</a>:</p>
<blockquote>
<p>I see, thanks a lot for your so quick response !<br>
Will apply this patch to our code in days and let you know how it works.</p>
</blockquote>



<a name="424070696"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%237997%20libgcc_13%3A%20SIGABORT%20inside%20%60Unwind.../near/424070696" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.237997.20libgcc_13.3A.20SIGABORT.20inside.20.60Unwind.2E.2E.2E.html#424070696">(Feb 29 2024 at 17:27)</a>:</h4>
<p>alexcrichton closed <a href="https://github.com/bytecodealliance/wasmtime/issues/7997">issue #7997</a>:</p>
<blockquote>
<p>We have faced a <code>SIGABORT</code> failure during executing simple benchmark which you can find here <a href="https://github.com/input-output-hk/hermes/blob/f4d20fc06f0b558be4805a106db32480bcef649d/hermes/bin/src/wasm/module.rs#L118">https://github.com/input-output-hk/hermes/blob/f4d20fc06f0b558be4805a106db32480bcef649d/hermes/bin/src/wasm/module.rs#L118</a>.<br>
Stack trace:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code>#<span class="mi">0</span><span class="w">  </span><span class="n">__restore_sigs</span><span class="w"> </span><span class="p">(</span><span class="n">set</span><span class="o">=</span><span class="n">set</span><span class="o">@</span><span class="n">entry</span><span class="o">=</span><span class="mh">0xffffc437ab50</span><span class="p">)</span><span class="w"> </span><span class="n">at</span><span class="w"> </span><span class="p">.</span><span class="o">/</span><span class="n">arch</span><span class="o">/</span><span class="n">aarch64</span><span class="o">/</span><span class="n">syscall_arch</span><span class="p">.</span><span class="n">h</span>:<span class="mi">48</span>
#<span class="mi">1</span><span class="w">  </span><span class="mh">0x0000ffff9c2add5c</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="n">raise</span><span class="w"> </span><span class="p">(</span><span class="n">sig</span><span class="o">=</span><span class="n">sig</span><span class="o">@</span><span class="n">entry</span><span class="o">=</span><span class="mi">6</span><span class="p">)</span><span class="w"> </span><span class="n">at</span><span class="w"> </span><span class="n">src</span><span class="o">/</span><span class="n">signal</span><span class="o">/</span><span class="n">raise</span><span class="p">.</span><span class="n">c</span>:<span class="mi">11</span>
#<span class="mi">2</span><span class="w">  </span><span class="mh">0x0000ffff9c27cbf4</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="n">abort</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="n">at</span><span class="w"> </span><span class="n">src</span><span class="o">/</span><span class="n">exit</span><span class="o">/</span><span class="n">abort</span><span class="p">.</span><span class="n">c</span>:<span class="mi">11</span>
#<span class="mi">3</span><span class="w">  </span><span class="mh">0x0000ffff9c23e8fc</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="n">__deregister_frame_info_bases</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="n">from</span><span class="w"> </span><span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">libgcc_s</span><span class="p">.</span><span class="n">so</span><span class="p">.</span><span class="mi">1</span>
#<span class="mi">4</span><span class="w">  </span><span class="mh">0x0000ffff9c23e91c</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="n">__deregister_frame</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="n">from</span><span class="w"> </span><span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">libgcc_s</span><span class="p">.</span><span class="n">so</span><span class="p">.</span><span class="mi">1</span>
#<span class="mi">5</span><span class="w">  </span><span class="mh">0x0000aaaac2c0d0a8</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="n">wasmtime_runtime</span>::<span class="n">sys</span>::<span class="n">unix</span>::<span class="n">unwind</span>::<span class="p">{</span><span class="k">impl</span>#<span class="mi">1</span><span class="p">}</span>::<span class="nb">drop</span><span class="w"> </span><span class="p">(</span><span class="bp">self</span><span class="o">=&lt;</span><span class="n">optimized</span><span class="w"> </span><span class="n">out</span><span class="o">&gt;</span><span class="p">)</span><span class="w"> </span><span class="n">at</span><span class="w"> </span><span class="n">src</span><span class="o">/</span><span class="n">sys</span><span class="o">/</span><span class="n">unix</span><span class="o">/</span><span class="n">unwind</span><span class="p">.</span><span class="n">rs</span>:<span class="mi">87</span>
#<span class="mi">6</span><span class="w">  </span><span class="mh">0x0000aaaac2ba2ba8</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="n">core</span>::<span class="n">ptr</span>::<span class="n">drop_in_place</span><span class="o">&lt;</span><span class="n">wasmtime_runtime</span>::<span class="n">sys</span>::<span class="n">unix</span>::<span class="n">unwind</span>::<span class="n">UnwindRegistration</span><span class="o">&gt;</span><span class="w"> </span><span class="p">()</span>
<span class="w">    </span><span class="n">at</span><span class="w"> </span><span class="o">/</span><span class="n">rustc</span><span class="o">/</span><span class="mf">82e1608</span><span class="n">dfa6e0b5569232559e3d385fea5a93112</span><span class="o">/</span><span class="n">library</span><span class="o">/</span><span class="n">core</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">ptr</span><span class="o">/</span><span class="k">mod</span><span class="p">.</span><span class="n">rs</span>:<span class="mi">498</span>
#<span class="mi">7</span><span class="w">  </span><span class="n">core</span>::<span class="n">ptr</span>::<span class="n">drop_in_place</span><span class="o">&lt;</span><span class="n">core</span>::<span class="n">option</span>::<span class="nb">Option</span><span class="o">&lt;</span><span class="n">wasmtime_runtime</span>::<span class="n">sys</span>::<span class="n">unix</span>::<span class="n">unwind</span>::<span class="n">UnwindRegistration</span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="p">()</span>
<span class="w">    </span><span class="n">at</span><span class="w"> </span><span class="o">/</span><span class="n">rustc</span><span class="o">/</span><span class="mf">82e1608</span><span class="n">dfa6e0b5569232559e3d385fea5a93112</span><span class="o">/</span><span class="n">library</span><span class="o">/</span><span class="n">core</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">ptr</span><span class="o">/</span><span class="k">mod</span><span class="p">.</span><span class="n">rs</span>:<span class="mi">498</span>
#<span class="mi">8</span><span class="w">  </span><span class="mh">0x0000aaaac2bb4d5c</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="n">core</span>::<span class="n">mem</span>::<span class="n">manually_drop</span>::<span class="n">ManuallyDrop</span><span class="o">&lt;</span><span class="n">core</span>::<span class="n">option</span>::<span class="nb">Option</span><span class="o">&lt;</span><span class="n">wasmtime_runtime</span>::<span class="n">sys</span>::<span class="n">unix</span>::<span class="n">unwind</span>::<span class="n">UnwindRegistration</span><span class="o">&gt;&gt;</span>::<span class="nb">drop</span><span class="o">&lt;</span><span class="n">core</span>::<span class="n">option</span>::<span class="nb">Option</span><span class="o">&lt;</span><span class="n">wasmtime_runtime</span>::<span class="n">sys</span>::<span class="n">unix</span>::<span class="n">unwind</span>::<span class="n">UnwindRegistration</span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="p">(</span><span class="n">slot</span><span class="o">=</span><span class="mh">0x0</span><span class="p">)</span>
<span class="w">    </span><span class="n">at</span><span class="w"> </span><span class="o">/</span><span class="n">rustc</span><span class="o">/</span><span class="mf">82e1608</span><span class="n">dfa6e0b5569232559e3d385fea5a93112</span><span class="o">/</span><span class="n">library</span><span class="o">/</span><span class="n">core</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">mem</span><span class="o">/</span><span class="n">manually_drop</span><span class="p">.</span><span class="n">rs</span>:<span class="mi">144</span>
<span class="o">--</span><span class="n">Type</span><span class="w"> </span><span class="o">&lt;</span><span class="n">RET</span><span class="o">&gt;</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">more</span><span class="p">,</span><span class="w"> </span><span class="n">q</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">quit</span><span class="p">,</span><span class="w"> </span><span class="n">c</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="k">continue</span><span class="w"> </span><span class="n">without</span><span class="w"> </span><span class="n">paging</span><span class="o">--</span>
#<span class="mi">9</span><span class="w">  </span><span class="n">wasmtime_jit</span>::<span class="n">code_memory</span>::<span class="p">{</span><span class="k">impl</span>#<span class="mi">0</span><span class="p">}</span>::<span class="nb">drop</span><span class="w"> </span><span class="p">(</span><span class="bp">self</span><span class="o">=</span><span class="mh">0xffff9c216eb0</span><span class="p">)</span><span class="w"> </span><span class="n">at</span><span class="w"> </span><span class="n">src</span><span class="o">/</span><span class="n">code_memory</span><span class="p">.</span><span class="n">rs</span>:<span class="mi">42</span>
#<span class="mi">10</span><span class="w"> </span><span class="n">core</span>::<span class="n">ptr</span>::<span class="n">drop_in_place</span><span class="o">&lt;</span><span class="n">wasmtime_jit</span>::<span class="n">code_memory</span>::<span class="n">CodeMemory</span><span class="o">&gt;</span><span class="w"> </span><span class="p">()</span>
<span class="w">    </span><span class="n">at</span><span class="w"> </span><span class="o">/</span><span class="n">rustc</span><span class="o">/</span><span class="mf">82e1608</span><span class="n">dfa6e0b5569232559e3d385fea5a93112</span><span class="o">/</span><span class="n">library</span><span class="o">/</span><span class="n">core</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">ptr</span><span class="o">/</span><span class="k">mod</span><span class="p">.</span><span class="n">rs</span>:<span class="mi">498</span>
#<span class="mi">11</span><span class="w"> </span><span class="n">alloc</span>::<span class="n">sync</span>::<span class="n">Arc</span><span class="o">&lt;</span><span class="n">wasmtime_jit</span>::<span class="n">code_memory</span>::<span class="n">CodeMemory</span><span class="p">,</span><span class="w"> </span><span class="n">alloc</span>::<span class="n">alloc</span>::<span class="n">Global</span><span class="o">&gt;</span>::<span class="n">drop_slow</span><span class="o">&lt;</span><span class="n">wasmtime_jit</span>::<span class="n">code_memory</span>::<span class="n">CodeMemory</span><span class="p">,</span><span class="w"> </span><span class="n">alloc</span>::<span class="n">alloc</span>::<span class="n">Global</span><span class="o">&gt;</span><span class="w"> </span><span class="p">(</span><span class="bp">self</span><span class="o">=&lt;</span><span class="n">optimized</span><span class="w"> </span><span class="n">out</span><span class="o">&gt;</span><span class="p">)</span><span class="w"> </span><span class="n">at</span><span class="w"> </span><span class="o">/</span><span class="n">rustc</span><span class="o">/</span><span class="mf">82e1608</span><span class="n">dfa6e0b5569232559e3d385fea5a93112</span><span class="o">/</span><span class="n">library</span><span class="o">/</span><span class="n">alloc</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">sync</span><span class="p">.</span><span class="n">rs</span>:<span class="mi">1752</span>
#<span class="mi">12</span><span class="w"> </span><span class="mh">0x0000aaaac27cfcb8</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="n">alloc</span>::<span class="n">sync</span>::<span class="p">{</span><span class="k">impl</span>#<span class="mi">33</span><span class="p">}</span>::<span class="nb">drop</span><span class="o">&lt;</span><span class="n">wasmtime_jit</span>::<span class="n">code_memory</span>::<span class="n">CodeMemory</span><span class="p">,</span><span class="w"> </span><span class="n">alloc</span>::<span class="n">alloc</span>::<span class="n">Global</span><span class="o">&gt;</span><span class="w"> </span><span class="p">(</span>
<span class="w">    </span><span class="bp">self</span><span class="o">=</span><span class="mh">0xffff9c213540</span><span class="p">)</span><span class="w"> </span><span class="n">at</span><span class="w"> </span><span class="o">/</span><span class="n">rustc</span><span class="o">/</span><span class="mf">82e1608</span><span class="n">dfa6e0b5569232559e3d385fea5a93112</span><span class="o">/</span><span class="n">library</span><span class="o">/</span><span class="n">alloc</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">sync</span><span class="p">.</span><span class="n">rs</span>:<span class="mi">2408</span>
#<span class="mi">13</span><span class="w"> </span><span class="n">core</span>::<span class="n">ptr</span>::<span class="n">drop_in_place</span><span class="o">&lt;</span><span class="n">alloc</span>::<span class="n">sync</span>::<span class="n">Arc</span><span class="o">&lt;</span><span class="n">wasmtime_jit</span>::<span class="n">code_memory</span>::<span class="n">CodeMemory</span><span class="p">,</span><span class="w"> </span><span class="n">alloc</span>::<span class="n">alloc</span>::<span class="n">Global</span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="p">()</span>
<span class="w">    </span><span class="n">at</span><span class="w"> </span><span class="o">/</span><span class="n">rustc</span><span class="o">/</span><span class="mf">82e1608</span><span class="n">dfa6e0b5569232559e3d385fea5a93112</span><span class="o">/</span><span class="n">library</span><span class="o">/</span><span class="n">core</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">ptr</span><span class="o">/</span><span class="k">mod</span><span class="p">.</span><span class="n">rs</span>:<span class="mi">498</span>
#<span class="mi">14</span><span class="w"> </span><span class="n">core</span>::<span class="n">ptr</span>::<span class="n">drop_in_place</span><span class="o">&lt;</span><span class="n">wasmtime</span>::<span class="n">code</span>::<span class="n">CodeObject</span><span class="o">&gt;</span><span class="w"> </span><span class="p">()</span>
<span class="w">    </span><span class="n">at</span><span class="w"> </span><span class="o">/</span><span class="n">rustc</span><span class="o">/</span><span class="mf">82e1608</span><span class="n">dfa6e0b5569232559e3d385fea5a93112</span><span class="o">/</span><span class="n">library</span><span class="o">/</span><span class="n">core</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">ptr</span><span class="o">/</span><span class="k">mod</span><span class="p">.</span><span class="n">rs</span>:<span class="mi">498</span>
#<span class="mi">15</span><span class="w"> </span><span class="n">alloc</span>::<span class="n">sync</span>::<span class="n">Arc</span><span class="o">&lt;</span><span class="n">wasmtime</span>::<span class="n">code</span>::<span class="n">CodeObject</span><span class="p">,</span><span class="w"> </span><span class="n">alloc</span>::<span class="n">alloc</span>::<span class="n">Global</span><span class="o">&gt;</span>::<span class="n">drop_slow</span><span class="o">&lt;</span><span class="n">wasmtime</span>::<span class="n">code</span>::<span class="n">CodeObject</span><span class="p">,</span><span class="w"> </span><span class="n">alloc</span>::<span class="n">alloc</span>::<span class="n">Global</span><span class="o">&gt;</span><span class="w"> </span><span class="p">(</span>
<span class="w">    </span><span class="bp">self</span><span class="o">=&lt;</span><span class="n">optimized</span><span class="w"> </span><span class="n">out</span><span class="o">&gt;</span><span class="p">)</span><span class="w"> </span><span class="n">at</span><span class="w"> </span><span class="o">/</span><span class="n">rustc</span><span class="o">/</span><span class="mf">82e1608</span><span class="n">dfa6e0b5569232559e3d385fea5a93112</span><span class="o">/</span><span class="n">library</span><span class="o">/</span><span class="n">alloc</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">sync</span><span class="p">.</span><span class="n">rs</span>:<span class="mi">1752</span>
<span class="o">--</span><span class="n">Type</span><span class="w"> </span><span class="o">&lt;</span><span class="n">RET</span><span class="o">&gt;</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">more</span><span class="p">,</span><span class="w"> </span><span class="n">q</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">quit</span><span class="p">,</span><span class="w"> </span><span class="n">c</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="k">continue</span><span class="w"> </span><span class="n">without</span><span class="w"> </span><span class="n">paging</span><span class="o">--</span>
#<span class="mi">16</span><span class="w"> </span><span class="mh">0x0000aaaac27d06a8</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="n">alloc</span>::<span class="n">sync</span>::<span class="p">{</span><span class="k">impl</span>#<span class="mi">33</span><span class="p">}</span>::<span class="nb">drop</span><span class="o">&lt;</span><span class="n">wasmtime</span>::<span class="n">code</span>::<span class="n">CodeObject</span><span class="p">,</span><span class="w"> </span><span class="n">alloc</span>::<span class="n">alloc</span>::<span class="n">Global</span><span class="o">&gt;</span><span class="w"> </span><span class="p">(</span><span class="bp">self</span><span class="o">=</span><span class="mh">0x0</span><span class="p">)</span>
<span class="w">    </span><span class="n">at</span><span class="w"> </span><span class="o">/</span><span class="n">rustc</span><span class="o">/</span><span class="mf">82e1608</span><span class="n">dfa6e0b5569232559e3d385fea5a93112</span><span class="o">/</span><span class="n">library</span><span class="o">/</span><span class="n">alloc</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">sync</span><span class="p">.</span><span class="n">rs</span>:<span class="mi">2408</span>
#<span class="mi">17</span><span class="w"> </span><span class="n">core</span>::<span class="n">ptr</span>::<span class="n">drop_in_place</span><span class="o">&lt;</span><span class="n">alloc</span>::<span class="n">sync</span>::<span class="n">Arc</span><span class="o">&lt;</span><span class="n">wasmtime</span>::<span class="n">code</span>::<span class="n">CodeObject</span><span class="p">,</span><span class="w"> </span><span class="n">alloc</span>::<span class="n">alloc</span>::<span class="n">Global</span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="p">()</span>
<span class="w">    </span><span class="n">at</span><span class="w"> </span><span class="o">/</span><span class="n">rustc</span><span class="o">/</span><span class="mf">82e1608</span><span class="n">dfa6e0b5569232559e3d385fea5a93112</span><span class="o">/</span><span class="n">library</span><span class="o">/</span><span class="n">core</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">ptr</span><span class="o">/</span><span class="k">mod</span><span class="p">.</span><span class="n">rs</span>:<span class="mi">498</span>
#<span class="mi">18</span><span class="w"> </span><span class="n">core</span>::<span class="n">ptr</span>::<span class="n">drop_in_place</span><span class="o">&lt;</span><span class="n">wasmtime</span>::<span class="n">component</span>::<span class="n">component</span>::<span class="n">ComponentInner</span><span class="o">&gt;</span><span class="w"> </span><span class="p">()</span>
<span class="w">    </span><span class="n">at</span><span class="w"> </span><span class="o">/</span><span class="n">rustc</span><span class="o">/</span><span class="mf">82e1608</span><span class="n">dfa6e0b5569232559e3d385fea5a93112</span><span class="o">/</span><span class="n">library</span><span class="o">/</span><span class="n">core</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">ptr</span><span class="o">/</span><span class="k">mod</span><span class="p">.</span><span class="n">rs</span>:<span class="mi">498</span>
#<span class="mi">19</span><span class="w"> </span><span class="n">alloc</span>::<span class="n">sync</span>::<span class="n">Arc</span><span class="o">&lt;</span><span class="n">wasmtime</span>::<span class="n">component</span>::<span class="n">component</span>::<span class="n">ComponentInner</span><span class="p">,</span><span class="w"> </span><span class="n">alloc</span>::<span class="n">alloc</span>::<span class="n">Global</span><span class="o">&gt;</span>::<span class="n">drop_slow</span><span class="o">&lt;</span><span class="n">wasmtime</span>::<span class="n">component</span>::<span class="n">component</span>::<span class="n">ComponentInner</span><span class="p">,</span><span class="w"> </span><span class="n">alloc</span>::<span class="n">alloc</span>::<span class="n">Global</span><span class="o">&gt;</span><span class="w"> </span><span class="p">(</span><span class="bp">self</span><span class="o">=&lt;</span><span class="n">optimized</span><span class="w"> </span><span class="n">out</span><span class="o">&gt;</span><span class="p">)</span>
<span class="w">    </span><span class="n">at</span><span class="w"> </span><span class="o">/</span><span class="n">rustc</span><span class="o">/</span><span class="mf">82e1608</span><span class="n">dfa6e0b5569232559e3d385fea5a93112</span><span class="o">/</span><span class="n">library</span><span class="o">/</span><span class="n">alloc</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">sync</span><span class="p">.</span><span class="n">rs</span>:<span class="mi">1752</span>
#<span class="mi">20</span><span class="w"> </span><span class="mh">0x0000aaaac275d494</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="n">alloc</span>::<span class="n">sync</span>::<span class="p">{</span><span class="k">impl</span>#<span class="mi">33</span><span class="p">}</span>::<span class="nb">drop</span><span class="o">&lt;</span><span class="n">wasmtime</span>::<span class="n">component</span>::<span class="n">component</span>::<span class="n">ComponentInner</span><span class="p">,</span><span class="w"> </span><span class="n">alloc</span>::<span class="n">alloc</span>::<span class="n">Global</span><span class="o">&gt;</span><span class="w"> </span><span class="p">(</span>
<span class="w">    </span><span class="bp">self</span><span class="o">=</span><span class="mh">0xffffc437ad40</span><span class="p">)</span><span class="w"> </span><span class="n">at</span><span class="w"> </span><span class="n">rustc</span><span class="o">/</span><span class="mf">82e1608</span><span class="n">dfa6e0b5569232559e3d385fea5a93112</span><span class="o">/</span><span class="n">library</span><span class="o">/</span><span class="n">alloc</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">sync</span><span class="p">.</span><span class="n">rs</span>:<span class="mi">2408</span>
#<span class="mi">21</span><span class="w"> </span><span class="n">core</span>::<span class="n">ptr</span>::<span class="n">drop_in_place</span><span class="o">&lt;</span><span class="n">alloc</span>::<span class="n">sync</span>::<span class="n">Arc</span><span class="o">&lt;</span><span class="n">wasmtime</span>::<span class="n">component</span>::<span class="n">component</span>::<span class="n">ComponentInner</span><span class="p">,</span><span class="w"> </span><span class="n">alloc</span>::<span class="n">alloc</span>::<span class="n">Global</span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="p">()</span>
<span class="w">    </span><span class="n">at</span><span class="w"> </span><span class="n">rustc</span><span class="o">/</span><span class="mf">82e1608</span><span class="n">dfa6e0b5569232559e3d385fea5a93112</span><span class="o">/</span><span class="n">library</span><span class="o">/</span><span class="n">core</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">ptr</span><span class="o">/</span><span class="k">mod</span><span class="p">.</span><span class="n">rs</span>:<span class="mi">498</span>
<span class="o">--</span><span class="n">Type</span><span class="w"> </span><span class="o">&lt;</span><span class="n">RET</span><span class="o">&gt;</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">more</span><span class="p">,</span><span class="w"> </span><span class="n">q</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">quit</span><span class="p">,</span><span class="w"> </span><span class="n">c</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="k">continue</span><span class="w"> </span><span class="n">without</span><span class="w"> </span><span class="n">paging</span><span class="o">--</span>
#<span class="mi">22</span><span class="w"> </span><span class="n">core</span>::<span class="n">ptr</span>::<span class="n">drop_in_place</span><span class="o">&lt;</span><span class="n">wasmtime</span>::<span class="n">component</span>::<span class="n">component</span>::<span class="n">Component</span><span class="o">&gt;</span><span class="w"> </span><span class="p">()</span>
<span class="w">    </span><span class="n">at</span><span class="w"> </span><span class="n">rustc</span><span class="o">/</span><span class="mf">82e1608</span><span class="n">dfa6e0b5569232559e3d385fea5a93112</span><span class="o">/</span><span class="n">library</span><span class="o">/</span><span class="n">core</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">ptr</span><span class="o">/</span><span class="k">mod</span><span class="p">.</span><span class="n">rs</span>:<span class="mi">498</span>
#<span class="mi">23</span><span class="w"> </span><span class="n">core</span>::<span class="n">ptr</span>::<span class="n">drop_in_place</span><span class="o">&lt;</span><span class="n">wasmtime</span>::<span class="n">component</span>::<span class="n">instance</span>::<span class="n">InstancePre</span><span class="o">&lt;</span><span class="n">hermes</span>::<span class="n">state</span>::<span class="n">HermesState</span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="p">()</span>
<span class="w">    </span><span class="n">at</span><span class="w"> </span><span class="n">rustc</span><span class="o">/</span><span class="mf">82e1608</span><span class="n">dfa6e0b5569232559e3d385fea5a93112</span><span class="o">/</span><span class="n">library</span><span class="o">/</span><span class="n">core</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">ptr</span><span class="o">/</span><span class="k">mod</span><span class="p">.</span><span class="n">rs</span>:<span class="mi">498</span>
#<span class="mi">24</span><span class="w"> </span><span class="mh">0x0000aaaac275b390</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="n">core</span>::<span class="n">ptr</span>::<span class="n">drop_in_place</span><span class="o">&lt;</span><span class="n">hermes</span>::<span class="n">wasm</span>::<span class="n">module</span>::<span class="n">Module</span><span class="o">&gt;</span><span class="w"> </span><span class="p">()</span>
<span class="w">    </span><span class="n">at</span><span class="w"> </span><span class="n">rustc</span><span class="o">/</span><span class="mf">82e1608</span><span class="n">dfa6e0b5569232559e3d385fea5a93112</span><span class="o">/</span><span class="n">library</span><span class="o">/</span><span class="n">core</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">ptr</span><span class="o">/</span><span class="k">mod</span><span class="p">.</span><span class="n">rs</span>:<span class="mi">498</span>
#<span class="mi">25</span><span class="w"> </span><span class="mh">0x0000aaaac2761460</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="n">hermes</span>::<span class="n">wasm</span>::<span class="n">module</span>::<span class="n">bench</span>::<span class="n">module_hermes_component_bench</span><span class="w"> </span><span class="p">(</span><span class="n">b</span><span class="o">=</span><span class="mh">0xffffc437ae30</span><span class="p">)</span><span class="w"> </span><span class="n">at</span><span class="w"> </span><span class="n">bin</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">wasm</span><span class="o">/</span><span class="n">module</span><span class="p">.</span><span class="n">rs</span>:<span class="mi">143</span>
</code></pre></div>
<h3>Steps to Reproduce</h3>
<p>You can fully reproduce it in already prepared environment and code but cloning our repo and specifically this branch <code>libgcc-wasmtime-unwinding-bug</code>. (repo: <a href="https://github.com/input-output-hk/hermes">https://github.com/input-output-hk/hermes</a>)</p>
<p>Before start you will need to install <a href="https://earthly.dev">earthly</a> tool.<br>
To run it you will need to execute the following in the root of the repo</p>
<div class="codehilite" data-code-language="Bash"><pre><span></span><code>earthly<span class="w"> </span>-I<span class="w"> </span>./hermes+alpine-3-19-fail
</code></pre></div>
<p>This will prepare an <code>alpine:3.19</code> environment with <code>rust:1.75</code> version and all our project configuration that we have an all source code and run a benchmarks.<br>
Earthfile code <a href="https://github.com/input-output-hk/hermes/blob/libgcc-wasmtime-unwinding-bug/hermes/Earthfile#L18">https://github.com/input-output-hk/hermes/blob/libgcc-wasmtime-unwinding-bug/hermes/Earthfile#L18</a></p>
<div class="codehilite" data-code-language="earthfile"><pre><span></span><code>alpine-3-19-fail:
    FROM rust:1.75-alpine3.19

    # Install necessary packages
    RUN apk add --no-cache \
            musl-dev \
            gdb

    COPY --dir .cargo .config crates bin .
    COPY Cargo.toml .
    COPY clippy.toml deny.toml rustfmt.toml .

    RUN mkdir /wasm
    COPY --dir ../wasm+wasi-src/wasi /wasm/wasi
    # Compiled WASM component for benchmarks
    COPY ../wasm/c+build/component.wasm /wasm/c/bench_component.wasm

    # Run benchmarks
    RUN cargo bench --features bench
</code></pre></div>
<p>After the failure it will run an interacting mode <code>-i</code> flag (similar to docker interactive mode).<br>
So you will be able to collect a dump file inside this container.</p>
<div class="codehilite" data-code-language="Bash"><pre><span></span><code><span class="nb">ulimit</span><span class="w"> </span>-c<span class="w"> </span>unlimited<span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span>./target/release/deps/module-&lt;&gt;<span class="w"> </span>--bench
</code></pre></div>
<p>Then inspect it and using <code>gdb</code></p>
<div class="codehilite" data-code-language="Bash"><pre><span></span><code>gdb<span class="w">  </span>./target/release/deps/module-&lt;&gt;<span class="w"> </span>core<span class="w"> </span>--<span class="w"> </span>--bench
</code></pre></div>
<h3>Actual Results</h3>
<p>SIGABORT</p>
<h3>Versions and Environment</h3>
<p>Wasmtime version or commit: 17.0.0</p>
<p>Operating system: alpine:3.19</p>
<h3>Extra Info</h3>
<p>This is totally works on <code>alpine:3.18</code> version with the <code>libgcc:12</code> version.<br>
We have found that most probable it is an issue with <code>libgcc</code> because, there is a huge difference with the libgcc unwinding implementation between these two versions.</p>
<p>libgcc_12 - <a href="https://github.com/gcc-mirror/gcc/blob/8cbb2cade4c724760c868c9f493b169d6ec4168a/libgcc/unwind-dw2-fde.c#L201">https://github.com/gcc-mirror/gcc/blob/8cbb2cade4c724760c868c9f493b169d6ec4168a/libgcc/unwind-dw2-fde.c#L201</a></p>
<p>libgcc_13 - <a href="https://github.com/gcc-mirror/gcc/blob/0e7bc3eaa36b81004b799124d2fe00137401a43b/libgcc/unwind-dw2-fde.c#L225">https://github.com/gcc-mirror/gcc/blob/0e7bc3eaa36b81004b799124d2fe00137401a43b/libgcc/unwind-dw2-fde.c#L225</a></p>
<p>You can try it running already prepared earthly target <a href="https://github.com/input-output-hk/hermes/blob/libgcc-wasmtime-unwinding-bug/hermes/Earthfile#L38">https://github.com/input-output-hk/hermes/blob/libgcc-wasmtime-unwinding-bug/hermes/Earthfile#L38</a></p>
<p><div class="codehilite" data-code-language="Bash"><pre><span></span><code>earthly<span class="w"> </span>./hermes+alpine-3-18-pass
</code></pre></div><br>
</p>
</blockquote>



<hr><p>Last updated: Jan 20 2025 at 06:04 UTC</p>
</html>