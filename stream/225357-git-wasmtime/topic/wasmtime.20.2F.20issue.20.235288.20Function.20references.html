<html>
<head><meta charset="utf-8"><title>wasmtime / issue #5288 Function references · git-wasmtime · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/index.html">git-wasmtime</a></h2>
<h3>Topic: <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.235288.20Function.20references.html">wasmtime / issue #5288 Function references</a></h3>

<hr>

<base href="https://bytecodealliance.zulipchat.com">

<head><link href="https://bytecodealliance.github.io/zulip-archive/style.css" rel="stylesheet"></head>

<a name="310545094"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%235288%20Function%20references/near/310545094" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.235288.20Function.20references.html#310545094">(Nov 17 2022 at 04:49)</a>:</h4>
<p>github-actions[bot] <a href="https://github.com/bytecodealliance/wasmtime/pull/5288#issuecomment-1318070718">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/5288">issue #5288</a>:</p>
<blockquote>
<h4>Subscribe to Label Action</h4>
<p>cc @peterhuene</p>
<p>&lt;details&gt;<br>
This issue or pull request has been labeled: "cranelift", "cranelift:wasm", "wasmtime:api", "wasmtime:config"</p>
<p>Thus the following users have been cc'd because of the following labels:</p>
<ul>
<li>peterhuene: wasmtime:api</li>
</ul>
<p>To subscribe or unsubscribe from this label, edit the &lt;code&gt;.github/subscribe-to-label.json&lt;/code&gt; configuration file.</p>
<p><a href="https://github.com/bytecodealliance/subscribe-to-label-action">Learn more.</a><br>
&lt;/details&gt;</p>
</blockquote>



<a name="310545144"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%235288%20Function%20references/near/310545144" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.235288.20Function.20references.html#310545144">(Nov 17 2022 at 04:50)</a>:</h4>
<p>github-actions[bot] <a href="https://github.com/bytecodealliance/wasmtime/pull/5288#issuecomment-1318070886">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/5288">issue #5288</a>:</p>
<blockquote>
<h4>Label Messager: wasmtime:config</h4>
<p>It looks like you are changing Wasmtime's configuration options. Make sure to<br>
complete this check list:</p>
<ul>
<li>
<p>[ ] If you added a new <code>Config</code> method, you wrote extensive documentation for<br>
      it.</p>
<p>&lt;details&gt;</p>
<p>Our documentation should be of the following form:</p>
<p>```text<br>
Short, simple summary sentence.</p>
<p>More details. These details can be multiple paragraphs. There should be<br>
information about not just the method, but its parameters and results as<br>
well.</p>
<p>Is this method fallible? If so, when can it return an error?</p>
<p>Can this method panic? If so, when does it panic?</p>
<h1>Example</h1>
<p>Optional example here.<br>
```</p>
<p>&lt;/details&gt;</p>
</li>
<li>
<p>[ ] If you added a new <code>Config</code> method, or modified an existing one, you<br>
  ensured that this configuration is exercised by the fuzz targets.</p>
<p>&lt;details&gt;</p>
<p>For example, if you expose a new strategy for allocating the next instance<br>
slot inside the pooling allocator, you should ensure that at least one of our<br>
fuzz targets exercises that new strategy.</p>
<p>Often, all that is required of you is to ensure that there is a knob for this<br>
configuration option in [<code>wasmtime_fuzzing::Config</code>][fuzzing-config] (or one<br>
of its nested <code>struct</code>s).</p>
<p>Rarely, this may require authoring a new fuzz target to specifically test this<br>
configuration. See [our docs on fuzzing][fuzzing-docs] for more details.</p>
<p>&lt;/details&gt;</p>
</li>
<li>
<p>[ ] If you are enabling a configuration option by default, make sure that it<br>
  has been fuzzed for at least two weeks before turning it on by default.</p>
</li>
</ul>
<p>[fuzzing-config]: <a href="https://github.com/bytecodealliance/wasmtime/blob/ca0e8d0a1d8cefc0496dba2f77a670571d8fdcab/crates/fuzzing/src/generators.rs#L182-L194">https://github.com/bytecodealliance/wasmtime/blob/ca0e8d0a1d8cefc0496dba2f77a670571d8fdcab/crates/fuzzing/src/generators.rs#L182-L194</a><br>
[fuzzing-docs]: <a href="https://docs.wasmtime.dev/contributing-fuzzing.html">https://docs.wasmtime.dev/contributing-fuzzing.html</a></p>
<hr>
<p>&lt;details&gt;</p>
<p>To modify this label's message, edit the &lt;code&gt;.github/label-messager/wasmtime-config.md&lt;/code&gt; file.</p>
<p>To add new label messages or remove existing label messages, edit the<br>
&lt;code&gt;.github/label-messager.json&lt;/code&gt; configuration file.</p>
<p><a href="https://github.com/bytecodealliance/label-messager-action">Learn more.</a></p>
<p>&lt;/details&gt;</p>
</blockquote>



<a name="310573571"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%235288%20Function%20references/near/310573571" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.235288.20Function.20references.html#310573571">(Nov 17 2022 at 09:35)</a>:</h4>
<p>bjorn3 <a href="https://github.com/bytecodealliance/wasmtime/pull/5288#issuecomment-1318348142">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/5288">issue #5288</a>:</p>
<blockquote>
<blockquote>
<p>call_ref is simply translated as a cranelift indirect_call. A faster cranelift indirect call that does not check the callee signature can (and should) eventually be added and used. Further, no null check is elided.</p>
</blockquote>
<p>call_indirect doesn't check the function signature, nor does it check for null pointers.</p>
</blockquote>



<a name="329731864"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%235288%20Function%20references/near/329731864" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.235288.20Function.20references.html#329731864">(Feb 23 2023 at 14:24)</a>:</h4>
<p>dhil <a href="https://github.com/bytecodealliance/wasmtime/pull/5288#issuecomment-1441885473">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/5288">issue #5288</a>:</p>
<blockquote>
<p>I'm interested in resuming work on this patch and dedicating the necessary time to bring it into an acceptable state. I have a patch which merges this PR with the recent changes to <code>main</code> (c.f. <a href="https://github.com/effect-handlers/wasmtime/issues/13">effect-handlers/wasmtime#13</a>). I will merge that patch into this PR later today.</p>
<p>I think the current status is as follows:</p>
<ul>
<li>Compatible with latest wasm-tools</li>
<li>All new function reference instructions have been implemented (save for <code>return_call_ref</code>) (tested on x86_64).</li>
<li>10 test case failures:</li>
</ul>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="n">failures</span>:
    <span class="nc">wast</span>::<span class="n">Cranelift</span>::<span class="n">spec</span>::<span class="n">function_references</span>::<span class="n">br_table</span>
<span class="w">    </span><span class="n">wast</span>::<span class="n">Cranelift</span>::<span class="n">spec</span>::<span class="n">function_references</span>::<span class="n">br_table_pooling</span>
<span class="w">    </span><span class="n">wast</span>::<span class="n">Cranelift</span>::<span class="n">spec</span>::<span class="n">function_references</span>::<span class="n">linking</span>
<span class="w">    </span><span class="n">wast</span>::<span class="n">Cranelift</span>::<span class="n">spec</span>::<span class="n">function_references</span>::<span class="n">linking_pooling</span>
<span class="w">    </span><span class="n">wast</span>::<span class="n">Cranelift</span>::<span class="n">spec</span>::<span class="n">function_references</span>::<span class="n">return_call_ref</span>
<span class="w">    </span><span class="n">wast</span>::<span class="n">Cranelift</span>::<span class="n">spec</span>::<span class="n">function_references</span>::<span class="n">return_call_ref_pooling</span>
<span class="w">    </span><span class="n">wast</span>::<span class="n">Cranelift</span>::<span class="n">spec</span>::<span class="n">function_references</span>::<span class="n">table</span>
<span class="w">    </span><span class="n">wast</span>::<span class="n">Cranelift</span>::<span class="n">spec</span>::<span class="n">function_references</span>::<span class="n">table_pooling</span>
<span class="w">    </span><span class="n">wast</span>::<span class="n">Cranelift</span>::<span class="n">spec</span>::<span class="n">function_references</span>::<span class="n">type_equivalence</span>
<span class="w">    </span><span class="n">wast</span>::<span class="n">Cranelift</span>::<span class="n">spec</span>::<span class="n">function_references</span>::<span class="n">type_equivalence_pooling</span>

<span class="n">test</span><span class="w"> </span><span class="n">result</span>: <span class="nc">FAILED</span><span class="p">.</span><span class="w"> </span><span class="mi">872</span><span class="w"> </span><span class="n">passed</span><span class="p">;</span><span class="w"> </span><span class="mi">10</span><span class="w"> </span><span class="n">failed</span><span class="p">;</span><span class="w"> </span><span class="mi">10</span><span class="w"> </span><span class="n">ignored</span><span class="p">;</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="n">measured</span><span class="p">;</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="n">filtered</span><span class="w"> </span><span class="n">out</span><span class="p">;</span><span class="w"> </span><span class="n">finished</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="mf">77.91</span><span class="n">s</span>
</code></pre></div>
<p>Here <code>return_call_ref</code> is expected to fail as we have not implemented the tail calls proposal. I haven't worked out why <code>linking</code> and <code>type_equivalence</code> fail yet. The test <code>br_table</code> fails because of how the <code>wast</code> crate of <code>wasm-tools</code> elaborates single element tables</p>
<div class="codehilite" data-code-language="WebAssembly"><pre><span></span><code><span class="p">(</span><span class="k">module</span>
  <span class="p">(</span><span class="k">type</span> <span class="nv">$t</span> <span class="p">(</span><span class="k">func</span><span class="p">))</span>
  <span class="p">(</span><span class="k">func</span> <span class="nv">$tf</span><span class="p">)</span>
  <span class="p">(</span><span class="k">table</span> <span class="nv">$t</span> <span class="p">(</span><span class="err">ref</span> <span class="err">null</span> <span class="nv">$t</span><span class="p">)</span> <span class="p">(</span><span class="k">elem</span> <span class="nv">$tf</span><span class="p">)))</span>
</code></pre></div>
<p>The <code>table</code> test fails due to the incompleteness of the type reconstruction procedure <code>wasmtime::values::Val::ty()</code>. The procedure has to infer the nullability of an <code>ExternRef</code> or <code>FuncRef</code> by looking at their respective shape, which is impossible.</p>
<p>I will probably need some help with this latter issue as it seems to require a slight redesign/refactor to keep source value type information around, at least in the <code>wast</code> crate of wasmtime. I will probably also need some help with diagnosing the remaining failure cases. I am also positive that there are several code quality improvements that need to be implemented in order to make this PR satisfactory.</p>
</blockquote>



<a name="349183027"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%235288%20Function%20references/near/349183027" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.235288.20Function.20references.html#349183027">(Apr 13 2023 at 18:22)</a>:</h4>
<p>abrown <a href="https://github.com/bytecodealliance/wasmtime/pull/5288#issuecomment-1507429885">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/5288">issue #5288</a>:</p>
<blockquote>
<p>This review got auto-assigned to me but I think @fitzgen and @alexcrichton have the right context for the review here.</p>
</blockquote>



<a name="351050728"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%235288%20Function%20references/near/351050728" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.235288.20Function.20references.html#351050728">(Apr 19 2023 at 13:34)</a>:</h4>
<p>dhil <a href="https://github.com/bytecodealliance/wasmtime/pull/5288#issuecomment-1514746801">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/5288">issue #5288</a>:</p>
<blockquote>
<p>@alexcrichton @fitzgen I have reverted the changes to the wasmtime public API. The end result is not too bad; there are a couple of more test failures now. I haven't looked into the failures in detail yet.</p>
</blockquote>



<a name="351051785"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%235288%20Function%20references/near/351051785" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.235288.20Function.20references.html#351051785">(Apr 19 2023 at 13:38)</a>:</h4>
<p>dhil edited a <a href="https://github.com/bytecodealliance/wasmtime/pull/5288#issuecomment-1514746801">comment</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/5288">issue #5288</a>:</p>
<blockquote>
<p>@alexcrichton @fitzgen I have reverted the changes to the wasmtime public API. The end result is not too bad; there are a couple of more test failures now. I haven't looked into the failures in detail yet.</p>
<p>If you want I can reopen this PR from my personal fork such that you can get write permissions. I think GitHub do not grant write permissions on PRs originating from an organisation account.</p>
</blockquote>



<a name="351111171"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%235288%20Function%20references/near/351111171" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.235288.20Function.20references.html#351111171">(Apr 19 2023 at 17:22)</a>:</h4>
<p>alexcrichton <a href="https://github.com/bytecodealliance/wasmtime/pull/5288#issuecomment-1515099901">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/5288">issue #5288</a>:</p>
<blockquote>
<p>Some things I'm seeing:</p>
<ul>
<li>I sent <a href="https://github.com/effect-handlers/wasmtime/pull/19">https://github.com/effect-handlers/wasmtime/pull/19</a> to surface the failures here on this PR</li>
<li>One test failure, <code>wast::Cranelift::spec::function_references::linking</code>, relates to <a href="https://github.com/bytecodealliance/wasmtime/blob/ef7af28ef095277f5979dcbc6ff03964c1e0ba12/crates/wasmtime/src/types/matching.rs#L183-L193">this function</a> which needs to be souped up for typed function references. Note though that this function will need to grow <code>&amp;ModuleTypes</code> arguments to perform the subtyping check between two different modules (this is basically the same code that's in <code>wasmparser</code>, just at link-time instead of validation-time).</li>
<li><code>wast::Cranelift::spec::function_references::table</code> looks like it may be a bug in table initialization?</li>
<li><code>wast::Cranelift::spec::function_references::br_table</code> is failing due to <a href="https://github.com/bytecodealliance/wasm-tools/pull/952">https://github.com/bytecodealliance/wasm-tools/pull/952</a> I think</li>
<li><code>wast::Cranelift::spec::function_references::type_equivalence</code> looks like it may be some sort of code generator bug? Unsure.</li>
</ul>
<p>There are additionally a number of tests as you've found which all panic due to the one you inserted to avoid changes to the public API. Those tests will need to be skipped as-is from the upstream testsuite, but they can be copied to to <code>tests/misc_testsuite</code> with updates to run in Wasmtime.</p>
</blockquote>



<a name="351359622"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%235288%20Function%20references/near/351359622" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.235288.20Function.20references.html#351359622">(Apr 20 2023 at 15:27)</a>:</h4>
<p>dhil <a href="https://github.com/bytecodealliance/wasmtime/pull/5288#issuecomment-1516534670">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/5288">issue #5288</a>:</p>
<blockquote>
<blockquote>
<p>Some things I'm seeing:</p>
<div class="codehilite"><pre><span></span><code>* I sent [Get more CI passing effect-handlers/wasmtime#19](https://github.com/effect-handlers/wasmtime/pull/19) to surface the failures here on this PR

* One test failure, `wast::Cranelift::spec::function_references::linking`, relates to [this function](https://github.com/bytecodealliance/wasmtime/blob/ef7af28ef095277f5979dcbc6ff03964c1e0ba12/crates/wasmtime/src/types/matching.rs#L183-L193) which needs to be souped up for typed function references. Note though that this function will need to grow `&amp;ModuleTypes` arguments to perform the subtyping check between two different modules (this is basically the same code that&#39;s in `wasmparser`, just at link-time instead of validation-time).

* `wast::Cranelift::spec::function_references::table` looks like it may be a bug in table initialization?

* `wast::Cranelift::spec::function_references::br_table` is failing due to [Support for Wast table initialisation syntactic sugar with typeful references wasm-tools#952](https://github.com/bytecodealliance/wasm-tools/pull/952) I think

* `wast::Cranelift::spec::function_references::type_equivalence` looks like it may be some sort of code generator bug? Unsure.
</code></pre></div>

<p>There are additionally a number of tests as you've found which all panic due to the one you inserted to avoid changes to the public API. Those tests will need to be skipped as-is from the upstream testsuite, but they can be copied to to <code>tests/misc_testsuite</code> with updates to run in Wasmtime.</p>
</blockquote>
<p>Excellent, thank you! I am down to two failures now <code>type_equivalence</code> and <code>table</code>.</p>
</blockquote>



<a name="351359858"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%235288%20Function%20references/near/351359858" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.235288.20Function.20references.html#351359858">(Apr 20 2023 at 15:28)</a>:</h4>
<p>dhil edited a <a href="https://github.com/bytecodealliance/wasmtime/pull/5288#issuecomment-1516534670">comment</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/5288">issue #5288</a>:</p>
<blockquote>
<p>Excellent, thank you! I am down to two failures now <code>type_equivalence</code> and <code>table</code>.</p>
<blockquote>
<p>There are additionally a number of tests as you've found which all panic due to the one you inserted to avoid changes to the public API. Those tests will need to be skipped as-is from the upstream testsuite, but they can be copied to to <code>tests/misc_testsuite</code> with updates to run in Wasmtime.</p>
</blockquote>
<p>I will move some of the content of the ignored tests to the misc testsuite too.</p>
</blockquote>



<a name="355382534"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%235288%20Function%20references/near/355382534" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.235288.20Function.20references.html#355382534">(May 03 2023 at 10:01)</a>:</h4>
<p>dhil <a href="https://github.com/bytecodealliance/wasmtime/pull/5288#issuecomment-1532758696">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/5288">issue #5288</a>:</p>
<blockquote>
<p>I have been trying to track down the remaining two failures. In the <code>table.wast</code> file, the problem is that tables aren't properly initialised. Looking at the code it indeed seems like table initialisers get ignored altogether (<a href="https://github.com/bytecodealliance/wasmtime/blob/main/crates/environ/src/module_environ.rs#L303-L307">https://github.com/bytecodealliance/wasmtime/blob/main/crates/environ/src/module_environ.rs#L303-L307</a>), which would explain why table entries always seem to be initialised to <code>null</code> (c.f. <a href="https://github.com/bytecodealliance/wasmtime/blob/main/crates/runtime/src/instance.rs#L872-L874">https://github.com/bytecodealliance/wasmtime/blob/main/crates/runtime/src/instance.rs#L872-L874</a>). From reading the code, I understand that great care is being taken to ensure lazy initialisation of tables, and thus, I wonder what semantics you want for tables with initialising expressions? @alexcrichton @fitzgen </p>
</blockquote>



<a name="355577999"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%235288%20Function%20references/near/355577999" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.235288.20Function.20references.html#355577999">(May 03 2023 at 18:27)</a>:</h4>
<p>alexcrichton <a href="https://github.com/bytecodealliance/wasmtime/pull/5288#issuecomment-1533510312">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/5288">issue #5288</a>:</p>
<blockquote>
<blockquote>
<p>Looking at the code it indeed seems like table initialisers get ignored altogether</p>
</blockquote>
<p>Indeed! Table intializers were added with the function-references proposal so that's why they're "ignored". When we updated <code>wasmparser</code> we probably should have made it an error if a non-null initializer was indicated.</p>
<p>I think what you'll want to do is to update <code>TableInitialization</code> to store the default initializer and then update <code>try_func_table_init</code> to not use <code>FuncTable</code> if there's a non-null initializer. We can probably lazy-initialize with initializers but that's fine to to in a future PR. It's probably best to get the base set of functionality working first.</p>
</blockquote>



<a name="358673668"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%235288%20Function%20references/near/358673668" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.235288.20Function.20references.html#358673668">(May 16 2023 at 09:41)</a>:</h4>
<p>dhil <a href="https://github.com/bytecodealliance/wasmtime/pull/5288#issuecomment-1549335620">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/5288">issue #5288</a>:</p>
<blockquote>
<p>Commit 5de9a246fc0c8a0b9ae7a4a60b2ce74cceba86ce implements a fix for the table initialisation problem, though, it is ended up a bit more roundabout than I initially anticipated. If I understand correctly, <code>TableInitialization</code> is global per module, so to avoid penalising pre-function-references code I introduced a new table initialisation strategy <code>EagerFuncTable</code>, which eagerly initialises all table fields. I am not sure whether this aligns with what you had in mind.</p>
<p>As for the final failing test <code>type-equivalence</code>, it fails, seemingly, because the type test for <code>call_indirect</code> is nominal rather than structural (c.f. <a href="https://github.com/bytecodealliance/wasmtime/blob/6dc3eb717d7cf9b3539557ea7b393dd51225336d/crates/cranelift/src/func_environ.rs#L1662C1-L1665">https://github.com/bytecodealliance/wasmtime/blob/6dc3eb717d7cf9b3539557ea7b393dd51225336d/crates/cranelift/src/func_environ.rs#L1662C1-L1665</a>). Here is a minimal example to reproduce:</p>
<div class="codehilite" data-code-language="WebAssembly"><pre><span></span><code><span class="p">(</span><span class="k">module</span>
  <span class="p">(</span><span class="k">type</span> <span class="nv">$s0</span> <span class="p">(</span><span class="k">func</span> <span class="p">(</span><span class="k">param</span> <span class="kt">i32</span><span class="p">)))</span>
  <span class="p">(</span><span class="k">type</span> <span class="nv">$s1</span> <span class="p">(</span><span class="k">func</span> <span class="p">(</span><span class="k">param</span> <span class="kt">i32</span> <span class="p">(</span><span class="err">ref</span> <span class="nv">$s0</span><span class="p">))))</span>
  <span class="p">(</span><span class="k">type</span> <span class="nv">$t1</span> <span class="p">(</span><span class="k">func</span> <span class="p">(</span><span class="k">param</span> <span class="p">(</span><span class="err">ref</span> <span class="nv">$s1</span><span class="p">))))</span>

  <span class="p">(</span><span class="k">func</span> <span class="nv">$s1</span> <span class="p">(</span><span class="k">type</span> <span class="nv">$s1</span><span class="p">))</span>
  <span class="p">(</span><span class="k">table</span> <span class="k">funcref</span> <span class="p">(</span><span class="k">elem</span> <span class="nv">$s1</span><span class="p">))</span>

  <span class="p">(</span><span class="k">func</span> <span class="p">(</span><span class="k">export</span> <span class="s2">"run"</span><span class="p">)</span>
    <span class="p">(</span><span class="nb">call_indirect</span> <span class="p">(</span><span class="k">type</span> <span class="nv">$t1</span><span class="p">)</span> <span class="p">(</span><span class="err">ref.</span><span class="k">func</span> <span class="nv">$s1</span><span class="p">)</span> <span class="p">(</span><span class="nb">i32.const</span> <span class="mi">0</span><span class="p">))</span>
  <span class="p">)</span>
<span class="p">)</span>
<span class="p">(</span><span class="err">assert_</span><span class="nb">return</span> <span class="p">(</span><span class="err">invoke</span> <span class="s2">"run"</span><span class="p">))</span>
</code></pre></div>
<p>I am not quite sure what the best course of action is here. I would have expected type/type signature canonicalisation to solve this problem.</p>
</blockquote>



<a name="358772098"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%235288%20Function%20references/near/358772098" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.235288.20Function.20references.html#358772098">(May 16 2023 at 15:39)</a>:</h4>
<p>alexcrichton <a href="https://github.com/bytecodealliance/wasmtime/pull/5288#issuecomment-1549914494">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/5288">issue #5288</a>:</p>
<blockquote>
<blockquote>
<p>which eagerly initialises all table fields. I am not sure whether this aligns with what you had in mind.</p>
</blockquote>
<p>Seems reasonable to me! One adjustment I might recommend though is to reuse the existing <code>TableInitialization::Segments</code> initializer. That's the "eager" mode which is optimized, if possible, to <code>TableInitialization::FuncTable</code> which is lazy initialization. During that optimization you can add a check that if anything is not null-initialized then the optimization can be skipped. I think this'll all have the same effect as what you've implemented but avoids <code>EagerTableInitializer</code> and <code>Segments</code> being sort of duplicates of each other.</p>
<p>I'll look more into the <code>call_indirect</code> issue now.</p>
</blockquote>



<a name="358775058"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%235288%20Function%20references/near/358775058" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.235288.20Function.20references.html#358775058">(May 16 2023 at 15:49)</a>:</h4>
<p>alexcrichton <a href="https://github.com/bytecodealliance/wasmtime/pull/5288#issuecomment-1549930882">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/5288">issue #5288</a>:</p>
<blockquote>
<p>Ok so I can definitely imagine that canonicalization has a bug in it and something isn't working as expected. My guess is that something is hashing a module-local u32 when it actually needs to hash something module-independent, or something like that. </p>
<p>That being said I'm not sure that your reduction showcases the issue? You're invoking, indirectly, a function that takes two parameters with only one parameter. In that sense I think a runtime error is expected there?</p>
</blockquote>



<a name="358977341"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%235288%20Function%20references/near/358977341" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.235288.20Function.20references.html#358977341">(May 17 2023 at 13:00)</a>:</h4>
<p>dhil <a href="https://github.com/bytecodealliance/wasmtime/pull/5288#issuecomment-1551349261">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/5288">issue #5288</a>:</p>
<blockquote>
<blockquote>
<p>Ok so I can definitely imagine that canonicalization has a bug in it and something isn't working as expected. My guess is that something is hashing a module-local u32 when it actually needs to hash something module-independent, or something like that.</p>
<p>That being said I'm not sure that your reduction showcases the issue? You're invoking, indirectly, a function that takes two parameters with only one parameter. In that sense I think a runtime error is expected there?</p>
</blockquote>
<p>Ah yes, sorry. I deleted a little bit too much. Here is a (valid) repro:</p>
<div class="codehilite" data-code-language="WebAssembly"><pre><span></span><code><span class="p">(</span><span class="k">module</span>
  <span class="p">(</span><span class="k">type</span> <span class="nv">$s0</span> <span class="p">(</span><span class="k">func</span> <span class="p">(</span><span class="k">param</span> <span class="kt">i32</span><span class="p">)))</span>
  <span class="p">(</span><span class="k">type</span> <span class="nv">$s1</span> <span class="p">(</span><span class="k">func</span> <span class="p">(</span><span class="k">param</span> <span class="kt">i32</span> <span class="p">(</span><span class="err">ref</span> <span class="nv">$s0</span><span class="p">))))</span>
  <span class="p">(</span><span class="k">type</span> <span class="nv">$s2</span> <span class="p">(</span><span class="k">func</span> <span class="p">(</span><span class="k">param</span> <span class="kt">i32</span> <span class="p">(</span><span class="err">ref</span> <span class="nv">$s0</span><span class="p">))))</span>
  <span class="p">(</span><span class="k">type</span> <span class="nv">$t1</span> <span class="p">(</span><span class="k">func</span> <span class="p">(</span><span class="k">param</span> <span class="p">(</span><span class="err">ref</span> <span class="nv">$s1</span><span class="p">))))</span>
  <span class="p">(</span><span class="k">type</span> <span class="nv">$t2</span> <span class="p">(</span><span class="k">func</span> <span class="p">(</span><span class="k">param</span> <span class="p">(</span><span class="err">ref</span> <span class="nv">$s2</span><span class="p">))))</span>

  <span class="p">(</span><span class="k">func</span> <span class="nv">$s1</span> <span class="p">(</span><span class="k">type</span> <span class="nv">$s1</span><span class="p">))</span>
  <span class="p">(</span><span class="k">func</span> <span class="nv">$f1</span> <span class="p">(</span><span class="k">type</span> <span class="nv">$t1</span><span class="p">))</span>
  <span class="p">(</span><span class="k">func</span> <span class="nv">$f2</span> <span class="p">(</span><span class="k">type</span> <span class="nv">$t2</span><span class="p">))</span>
  <span class="p">(</span><span class="k">table</span> <span class="k">funcref</span> <span class="p">(</span><span class="k">elem</span> <span class="nv">$f1</span> <span class="nv">$f2</span> <span class="nv">$s1</span><span class="p">))</span>

  <span class="p">(</span><span class="k">func</span> <span class="p">(</span><span class="k">export</span> <span class="s2">"run"</span><span class="p">)</span>
    <span class="p">(</span><span class="nb">call_indirect</span> <span class="p">(</span><span class="k">type</span> <span class="nv">$t1</span><span class="p">)</span> <span class="p">(</span><span class="err">ref.</span><span class="k">func</span> <span class="nv">$s1</span><span class="p">)</span> <span class="p">(</span><span class="nb">i32.const</span> <span class="mi">1</span><span class="p">))</span>
  <span class="p">)</span>
<span class="p">)</span>
</code></pre></div>
<p>It is extracted from <code>type-equivalence.wast</code>, the <code>;; Indirect types</code> section.</p>
</blockquote>



<a name="358977452"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%235288%20Function%20references/near/358977452" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.235288.20Function.20references.html#358977452">(May 17 2023 at 13:00)</a>:</h4>
<p>dhil edited a <a href="https://github.com/bytecodealliance/wasmtime/pull/5288#issuecomment-1551349261">comment</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/5288">issue #5288</a>:</p>
<blockquote>
<blockquote>
<p>Ok so I can definitely imagine that canonicalization has a bug in it and something isn't working as expected. My guess is that something is hashing a module-local u32 when it actually needs to hash something module-independent, or something like that.</p>
<p>That being said I'm not sure that your reduction showcases the issue? You're invoking, indirectly, a function that takes two parameters with only one parameter. In that sense I think a runtime error is expected there?</p>
</blockquote>
<p>Ah yes, sorry. I deleted a little bit too much. Here is a (valid) repro:</p>
<div class="codehilite" data-code-language="WebAssembly"><pre><span></span><code><span class="p">(</span><span class="k">module</span>
  <span class="p">(</span><span class="k">type</span> <span class="nv">$s0</span> <span class="p">(</span><span class="k">func</span> <span class="p">(</span><span class="k">param</span> <span class="kt">i32</span><span class="p">)))</span>
  <span class="p">(</span><span class="k">type</span> <span class="nv">$s1</span> <span class="p">(</span><span class="k">func</span> <span class="p">(</span><span class="k">param</span> <span class="kt">i32</span> <span class="p">(</span><span class="err">ref</span> <span class="nv">$s0</span><span class="p">))))</span>
  <span class="p">(</span><span class="k">type</span> <span class="nv">$s2</span> <span class="p">(</span><span class="k">func</span> <span class="p">(</span><span class="k">param</span> <span class="kt">i32</span> <span class="p">(</span><span class="err">ref</span> <span class="nv">$s0</span><span class="p">))))</span>
  <span class="p">(</span><span class="k">type</span> <span class="nv">$t1</span> <span class="p">(</span><span class="k">func</span> <span class="p">(</span><span class="k">param</span> <span class="p">(</span><span class="err">ref</span> <span class="nv">$s1</span><span class="p">))))</span>
  <span class="p">(</span><span class="k">type</span> <span class="nv">$t2</span> <span class="p">(</span><span class="k">func</span> <span class="p">(</span><span class="k">param</span> <span class="p">(</span><span class="err">ref</span> <span class="nv">$s2</span><span class="p">))))</span>

  <span class="p">(</span><span class="k">func</span> <span class="nv">$s1</span> <span class="p">(</span><span class="k">type</span> <span class="nv">$s1</span><span class="p">))</span>
  <span class="p">(</span><span class="k">func</span> <span class="nv">$f1</span> <span class="p">(</span><span class="k">type</span> <span class="nv">$t1</span><span class="p">))</span>
  <span class="p">(</span><span class="k">func</span> <span class="nv">$f2</span> <span class="p">(</span><span class="k">type</span> <span class="nv">$t2</span><span class="p">))</span>
  <span class="p">(</span><span class="k">table</span> <span class="k">funcref</span> <span class="p">(</span><span class="k">elem</span> <span class="nv">$f1</span> <span class="nv">$f2</span> <span class="nv">$s1</span><span class="p">))</span>

  <span class="p">(</span><span class="k">func</span> <span class="p">(</span><span class="k">export</span> <span class="s2">"run"</span><span class="p">)</span>
    <span class="p">(</span><span class="nb">call_indirect</span> <span class="p">(</span><span class="k">type</span> <span class="nv">$t1</span><span class="p">)</span> <span class="p">(</span><span class="err">ref.</span><span class="k">func</span> <span class="nv">$s1</span><span class="p">)</span> <span class="p">(</span><span class="nb">i32.const</span> <span class="mi">1</span><span class="p">))</span>
  <span class="p">)</span>
<span class="p">)</span>
<span class="p">(</span><span class="err">assert_</span><span class="nb">return</span> <span class="p">(</span><span class="err">invoke</span> <span class="s2">"run"</span><span class="p">))</span>
</code></pre></div>
<p>It is extracted from <code>type-equivalence.wast</code>, the <code>;; Indirect types</code> section.</p>
</blockquote>



<a name="358977682"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%235288%20Function%20references/near/358977682" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.235288.20Function.20references.html#358977682">(May 17 2023 at 13:01)</a>:</h4>
<p>dhil edited a <a href="https://github.com/bytecodealliance/wasmtime/pull/5288#issuecomment-1551349261">comment</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/5288">issue #5288</a>:</p>
<blockquote>
<blockquote>
<p>Ok so I can definitely imagine that canonicalization has a bug in it and something isn't working as expected. My guess is that something is hashing a module-local u32 when it actually needs to hash something module-independent, or something like that.</p>
<p>That being said I'm not sure that your reduction showcases the issue? You're invoking, indirectly, a function that takes two parameters with only one parameter. In that sense I think a runtime error is expected there?</p>
</blockquote>
<p>Ah yes, sorry. I deleted a little bit too much. Here is a (valid) repro:</p>
<div class="codehilite" data-code-language="WebAssembly"><pre><span></span><code><span class="p">(</span><span class="k">module</span>
  <span class="p">(</span><span class="k">type</span> <span class="nv">$s0</span> <span class="p">(</span><span class="k">func</span> <span class="p">(</span><span class="k">param</span> <span class="kt">i32</span><span class="p">)))</span>
  <span class="p">(</span><span class="k">type</span> <span class="nv">$s1</span> <span class="p">(</span><span class="k">func</span> <span class="p">(</span><span class="k">param</span> <span class="kt">i32</span> <span class="p">(</span><span class="err">ref</span> <span class="nv">$s0</span><span class="p">))))</span>
  <span class="p">(</span><span class="k">type</span> <span class="nv">$s2</span> <span class="p">(</span><span class="k">func</span> <span class="p">(</span><span class="k">param</span> <span class="kt">i32</span> <span class="p">(</span><span class="err">ref</span> <span class="nv">$s0</span><span class="p">))))</span>
  <span class="p">(</span><span class="k">type</span> <span class="nv">$t1</span> <span class="p">(</span><span class="k">func</span> <span class="p">(</span><span class="k">param</span> <span class="p">(</span><span class="err">ref</span> <span class="nv">$s1</span><span class="p">))))</span>
  <span class="p">(</span><span class="k">type</span> <span class="nv">$t2</span> <span class="p">(</span><span class="k">func</span> <span class="p">(</span><span class="k">param</span> <span class="p">(</span><span class="err">ref</span> <span class="nv">$s2</span><span class="p">))))</span>

  <span class="p">(</span><span class="k">func</span> <span class="nv">$s1</span> <span class="p">(</span><span class="k">type</span> <span class="nv">$s1</span><span class="p">))</span>
  <span class="p">(</span><span class="k">func</span> <span class="nv">$f2</span> <span class="p">(</span><span class="k">type</span> <span class="nv">$t2</span><span class="p">))</span>
  <span class="p">(</span><span class="k">table</span> <span class="k">funcref</span> <span class="p">(</span><span class="k">elem</span> <span class="nv">$f2</span> <span class="nv">$s1</span><span class="p">))</span>

  <span class="p">(</span><span class="k">func</span> <span class="p">(</span><span class="k">export</span> <span class="s2">"run"</span><span class="p">)</span>
    <span class="p">(</span><span class="nb">call_indirect</span> <span class="p">(</span><span class="k">type</span> <span class="nv">$t1</span><span class="p">)</span> <span class="p">(</span><span class="err">ref.</span><span class="k">func</span> <span class="nv">$s1</span><span class="p">)</span> <span class="p">(</span><span class="nb">i32.const</span> <span class="mi">0</span><span class="p">))</span>
  <span class="p">)</span>
<span class="p">)</span>
<span class="p">(</span><span class="err">assert_</span><span class="nb">return</span> <span class="p">(</span><span class="err">invoke</span> <span class="s2">"run"</span><span class="p">))</span>
</code></pre></div>
<p>It is extracted from <code>type-equivalence.wast</code>, the <code>;; Indirect types</code> section.</p>
</blockquote>



<a name="358977887"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%235288%20Function%20references/near/358977887" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.235288.20Function.20references.html#358977887">(May 17 2023 at 13:02)</a>:</h4>
<p>dhil <a href="https://github.com/bytecodealliance/wasmtime/pull/5288#issuecomment-1551352905">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/5288">issue #5288</a>:</p>
<blockquote>
<blockquote>
<blockquote>
<p>which eagerly initialises all table fields. I am not sure whether this aligns with what you had in mind.</p>
</blockquote>
<p>Seems reasonable to me! One adjustment I might recommend though is to reuse the existing <code>TableInitialization::Segments</code> initializer. That's the "eager" mode which is optimized, if possible, to <code>TableInitialization::FuncTable</code> which is lazy initialization. During that optimization you can add a check that if anything is not null-initialized then the optimization can be skipped. I think this'll all have the same effect as what you've implemented but avoids <code>EagerTableInitializer</code> and <code>Segments</code> being sort of duplicates of each other.</p>
<p>I'll look more into the <code>call_indirect</code> issue now.</p>
</blockquote>
<p>I have attempted to clean this up in the latest commit. Is this closer to what you had in mind?</p>
</blockquote>



<a name="358996467"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%235288%20Function%20references/near/358996467" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.235288.20Function.20references.html#358996467">(May 17 2023 at 14:18)</a>:</h4>
<p>alexcrichton <a href="https://github.com/bytecodealliance/wasmtime/pull/5288#issuecomment-1551484653">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/5288">issue #5288</a>:</p>
<blockquote>
<p>Ok so I think the issue is in two locations:</p>
<ul>
<li><a href="https://github.com/effect-handlers/wasmtime/blob/function-references/crates/wasmtime/src/signatures.rs#L74">Here</a> in the engine-level signature registry, which is a hash map of types across modules registered in an engine.</li>
<li><a href="https://github.com/effect-handlers/wasmtime/blob/function-references/crates/environ/src/module_types.rs#L40">Here</a> where there's a module-level map of types-to-indexes which should be deduplicating the above types but isn't.</li>
</ul>
<p>This bug is due to <a href="https://github.com/effect-handlers/wasmtime/blob/function-references/crates/types/src/lib.rs#L172"><code>derive(Hash)</code></a> on <code>WasmFuncType</code> which delegates all the way through to <code>WasmHeapType</code> which hashes the raw index. I think the best solution would be to remove the auto-derived trait impls from <code>WasmType</code> about equality and hashing, and then work backwards from there. The raw <code>WasmHeapType::Index</code> should probably take a <code>SignatureIndex</code> to assist in deduplicating within a module. That should solve the second bullet above.</p>
<p>The first bullet above, however, is much more difficult. That'll need to perform a "deep hash" of the entire structural type since it must be module-independent (and <code>SignatureIndex</code> is module-local). If the second bullet is enough to get tests passing for this PR though then that seems ok to defer to an issue and get this landed instead. </p>
<p>(to clarify, at this point I think it's fine to land this PR so long as it passes CI, it's been long enough and I'm sure y'all are tired of rebasing. It's ok to defer work so long as there's issues on file and the work is gated, which it all is)</p>
</blockquote>



<a name="359616406"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%235288%20Function%20references/near/359616406" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.235288.20Function.20references.html#359616406">(May 19 2023 at 10:49)</a>:</h4>
<p>dhil <a href="https://github.com/bytecodealliance/wasmtime/pull/5288#issuecomment-1554388609">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/5288">issue #5288</a>:</p>
<blockquote>
<p>Thanks! I see the culprit now. Just to clarify, when you say</p>
<blockquote>
<p>The raw WasmHeapType::Index should probably take a SignatureIndex to assist in deduplicating within a module.</p>
</blockquote>
<p>Do you mean that <code>WasmHeapType</code> should be parameterised by a <code>SignatureIndex</code> rather than <code>u32</code>? I can see how that would make the interning easier, though, how does this affect conversion to/from <code>wasmparser</code> types?</p>
</blockquote>



<a name="359690214"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%235288%20Function%20references/near/359690214" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.235288.20Function.20references.html#359690214">(May 19 2023 at 15:06)</a>:</h4>
<p>alexcrichton <a href="https://github.com/bytecodealliance/wasmtime/pull/5288#issuecomment-1554729088">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/5288">issue #5288</a>:</p>
<blockquote>
<p>No need to worry about conversion into a <code>wasmparser</code> type, that in theory shouldn't happen (or at least not that I know of). For conversion from a <code>wasmparser</code> type it may mean that a <code>From</code> impl needs to be removed in favor of a method on <code>ModuleTypes</code> or something like that where the indexing/hashing context is available.</p>
<p>So thinking more on this, sort of what this wants is <code>WasmType&lt;T&gt;</code> where a <code>Module</code> store <code>WasmType&lt;SignatureIndex&gt;</code> but an <code>Engine</code> stores a <code>WasmType&lt;VMSharedSignatureIndex&gt;</code>. I think then the <code>derive(Hash)</code> should continue to work with <code>PartialEq</code> as well?</p>
</blockquote>



<a name="360235419"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%235288%20Function%20references/near/360235419" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.235288.20Function.20references.html#360235419">(May 22 2023 at 11:14)</a>:</h4>
<p>dhil <a href="https://github.com/bytecodealliance/wasmtime/pull/5288#issuecomment-1557031851">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/5288">issue #5288</a>:</p>
<blockquote>
<p>I am OK with trying this approach, but it is a sizeable refactoring I think as <code>WasmType&lt;T&gt;</code> implies a type bound on <code>Table</code>, <code>Global</code>, and <code>EntityType</code> (at least). I suppose for each of those the same logic applies: at the module level we want <code>T = SignatureIndex</code> and at the engine level <code>T = VMSharedSignatureIndex</code> (if relevant).</p>
<p>The <code>From</code> trait will need to be removed, or at least supported by an alternative to support conversion from typed references.</p>
<p>Should I give this refactoring a go?</p>
</blockquote>



<a name="360252277"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%235288%20Function%20references/near/360252277" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.235288.20Function.20references.html#360252277">(May 22 2023 at 12:25)</a>:</h4>
<p>dhil edited a <a href="https://github.com/bytecodealliance/wasmtime/pull/5288#issuecomment-1557031851">comment</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/5288">issue #5288</a>:</p>
<blockquote>
<p>I am OK with trying this approach, but it is a sizeable refactoring I think as <code>WasmType&lt;T&gt;</code> implies a type bound on <code>Table</code>, <code>Global</code>, and <code>EntityType</code> (I suppose if they are only module-local then they can instantiate <code>T = SignatureIndex</code> internally). </p>
<p>The <code>From</code> trait will need to be removed, or at least supported by an alternative to support conversion from typed references.</p>
<p>Should I give this refactoring a go?</p>
</blockquote>



<a name="360312120"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%235288%20Function%20references/near/360312120" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.235288.20Function.20references.html#360312120">(May 22 2023 at 15:49)</a>:</h4>
<p>CosineP <a href="https://github.com/bytecodealliance/wasmtime/pull/5288#issuecomment-1557467207">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/5288">issue #5288</a>:</p>
<blockquote>
<p>This needs to happen for typed continuations support as well.   Currently we assume everything is a function, but if we do this refactor I think we can look up in the types table whether a ref is a function or a continuation, which we need to know in a number of places in Wasmtime (at least in the embedding API; we managed to fudge the table layout stuff).   But as a result I can say firsthand it is absolutely a hefty undertaking which is why we resorted to our current hack.   I may still have a local branch with part of this refactoring underway.</p>
</blockquote>



<a name="360350839"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%235288%20Function%20references/near/360350839" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.235288.20Function.20references.html#360350839">(May 22 2023 at 18:44)</a>:</h4>
<p>alexcrichton <a href="https://github.com/bytecodealliance/wasmtime/pull/5288#issuecomment-1557722953">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/5288">issue #5288</a>:</p>
<blockquote>
<p>If you're ok with it, I think it's ok to set the test to ignore and land this. It's true that this refactoring will require a bit of finesse, but it's one I'm happy to take on myself rather than having y'all do yet-more work on top of what you've already got here. </p>
<p>Otherwise I'd be happy to merge this with a green CI run (which will require ignoring tests) and a list of items to tackle tracked in an issue (such as fixing the failing tests, this possible refactoring, the embedder API, etc)</p>
</blockquote>



<a name="360511684"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%235288%20Function%20references/near/360511684" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.235288.20Function.20references.html#360511684">(May 23 2023 at 12:10)</a>:</h4>
<p>dhil <a href="https://github.com/bytecodealliance/wasmtime/pull/5288#issuecomment-1559163707">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/5288">issue #5288</a>:</p>
<blockquote>
<p>I have added the test <code>type-equivalence.wast</code> to the ignore set. How should we go about documenting the issues? Should I open each issue as a separate issue here on GitHub?</p>
</blockquote>



<a name="360533369"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%235288%20Function%20references/near/360533369" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.235288.20Function.20references.html#360533369">(May 23 2023 at 13:33)</a>:</h4>
<p>alexcrichton <a href="https://github.com/bytecodealliance/wasmtime/pull/5288#issuecomment-1559371933">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/5288">issue #5288</a>:</p>
<blockquote>
<p>I think one tracking issue should be good to start off with and it can branch from there as necessary. I'll work on giving this a final pass today. Thanks again for y'all's work here!</p>
</blockquote>



<a name="360810772"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%235288%20Function%20references/near/360810772" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.235288.20Function.20references.html#360810772">(May 24 2023 at 14:41)</a>:</h4>
<p>alexcrichton <a href="https://github.com/bytecodealliance/wasmtime/pull/5288#issuecomment-1561292503">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/5288">issue #5288</a>:</p>
<blockquote>
<p>@dhil to answer <a href="https://github.com/effect-handlers/wasmtime/pull/21#pullrequestreview-1441048960">this question</a> (over here for a bit more visibility) my thinking is that at the wasm AST layer there's only "this index" as a type but at the Wasmtime layer we'll be able to be more principled than that by having, for example:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="k">enum</span> <span class="nc">WasmHeapType</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">Func</span><span class="p">,</span>
<span class="w">    </span><span class="n">Extern</span><span class="p">,</span>
<span class="w">    </span><span class="n">TypedFunc</span><span class="p">(</span><span class="n">SignatureIndex</span><span class="p">),</span>
<span class="w">    </span><span class="n">Array</span><span class="p">,</span>
<span class="w">    </span><span class="n">TypedArray</span><span class="p">(</span><span class="n">StorageType</span><span class="p">),</span>
<span class="w">    </span><span class="n">Struct</span><span class="p">,</span>
<span class="w">    </span><span class="n">TypedStruct</span><span class="p">(</span><span class="n">StructIndex</span><span class="p">),</span>
<span class="w">    </span><span class="c1">// ..</span>
<span class="p">}</span>
</code></pre></div>
<p>or something along the lines of that where <code>WasmHeapType</code> stores effectively the discriminant of what it refers to rather than requiring the indexing operation to then verify the type of the result.</p>
<p>One of the things I was worried about was that there was the pervasive assumption that <code>WasmHeapType::Index(_)</code> was a function which won't be true once the GC proposal was implemented. I wanted to head off issues there by having the Wasmtime-level name be called <code>TypedFunc</code> so it's clear that all the cases handling <code>Func</code> and <code>TypedFunc</code> are only there for handling function-related things. In the future when more variants are added it'll require adding more <code>match</code> arms to handle in all these places.</p>
</blockquote>



<a name="361033124"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%235288%20Function%20references/near/361033124" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.235288.20Function.20references.html#361033124">(May 25 2023 at 11:41)</a>:</h4>
<p>dhil <a href="https://github.com/bytecodealliance/wasmtime/pull/5288#issuecomment-1562754872">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/5288">issue #5288</a>:</p>
<blockquote>
<p>I've opened a issue to track the unresolved bits of this PR. See #6455. I hopefully I managed to cover them all.</p>
</blockquote>



<a name="361153195"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%235288%20Function%20references/near/361153195" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.235288.20Function.20references.html#361153195">(May 25 2023 at 19:47)</a>:</h4>
<p>fitzgen <a href="https://github.com/bytecodealliance/wasmtime/pull/5288#issuecomment-1563423756">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/5288">issue #5288</a>:</p>
<blockquote>
<p>Seems like there are some conflicts and this needs a rebase/merge.</p>
</blockquote>



<a name="361251252"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%235288%20Function%20references/near/361251252" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.235288.20Function.20references.html#361251252">(May 26 2023 at 08:23)</a>:</h4>
<p>dhil <a href="https://github.com/bytecodealliance/wasmtime/pull/5288#issuecomment-1564002478">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/5288">issue #5288</a>:</p>
<blockquote>
<blockquote>
<p>Seems like there are some conflicts and this needs a rebase/merge.</p>
</blockquote>
<p>I have synchronised with upstream again. Hopefully everything ticks green again :-)</p>
</blockquote>



<a name="361374121"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%235288%20Function%20references/near/361374121" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.235288.20Function.20references.html#361374121">(May 26 2023 at 16:07)</a>:</h4>
<p>alexcrichton <a href="https://github.com/bytecodealliance/wasmtime/pull/5288#issuecomment-1564614634">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/5288">issue #5288</a>:</p>
<blockquote>
<p><span aria-label="confetti" class="emoji emoji-1f38a" role="img" title="confetti">:confetti:</span> </p>
</blockquote>



<hr><p>Last updated: Jan 20 2025 at 06:04 UTC</p>
</html>