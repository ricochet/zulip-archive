<html>
<head><meta charset="utf-8"><title>wasmtime / Issue #1376 Support WASI snapshot0 in the C API. · git-wasmtime · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/index.html">git-wasmtime</a></h2>
<h3>Topic: <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20Issue.20.231376.20Support.20WASI.20snapshot0.20in.20the.20C.20API.2E.html">wasmtime / Issue #1376 Support WASI snapshot0 in the C API.</a></h3>

<hr>

<base href="https://bytecodealliance.zulipchat.com">

<head><link href="https://bytecodealliance.github.io/zulip-archive/style.css" rel="stylesheet"></head>

<a name="191317951"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20Issue%20%231376%20Support%20WASI%20snapshot0%20in%20the%20C%20API./near/191317951" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20Issue.20.231376.20Support.20WASI.20snapshot0.20in.20the.20C.20API.2E.html#191317951">(Mar 21 2020 at 00:10)</a>:</h4>
<p>github-actions[bot] <a href="https://github.com/bytecodealliance/wasmtime/pull/1376#issuecomment-601961330" target="_blank" title="https://github.com/bytecodealliance/wasmtime/pull/1376#issuecomment-601961330">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/1376" target="_blank" title="https://github.com/bytecodealliance/wasmtime/pull/1376">Issue #1376</a>:</p>
<blockquote>
<h4>Subscribe to Label Action</h4>
<p>This issue or pull request has been labeled: "wasi", "wasmtime:c-api"</p>
<p>&lt;details&gt; &lt;summary&gt;Users Subscribed to "wasmtime:c-api"&lt;/summary&gt;</p>
<ul>
<li>@peterhuene</li>
</ul>
<p>&lt;/details&gt;</p>
<p>To subscribe or unsubscribe from this label, edit the &lt;code&gt;.github/subscribe-to-label.json&lt;/code&gt; configuration file.</p>
<p><a href="https://github.com/bytecodealliance/subscribe-to-label-action" target="_blank" title="https://github.com/bytecodealliance/subscribe-to-label-action">Learn more.</a></p>
</blockquote>



<a name="191319374"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20Issue%20%231376%20Support%20WASI%20snapshot0%20in%20the%20C%20API./near/191319374" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20Issue.20.231376.20Support.20WASI.20snapshot0.20in.20the.20C.20API.2E.html#191319374">(Mar 21 2020 at 00:35)</a>:</h4>
<p>peterhuene <a href="https://github.com/bytecodealliance/wasmtime/pull/1376#issuecomment-601966130" target="_blank" title="https://github.com/bytecodealliance/wasmtime/pull/1376#issuecomment-601966130">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/1376" target="_blank" title="https://github.com/bytecodealliance/wasmtime/pull/1376">Issue #1376</a>:</p>
<blockquote>
<p>Sigh.  To get the shared (between the multiple WASI context builders) file handles working on Windows, we'd need to open with sharing options specifically on Windows.</p>
<p>I'm not really a big fan of this impl (i.e. having the multiple WASI instances).  I may take another stab at this to fix #1220.</p>
</blockquote>



<a name="191319425"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20Issue%20%231376%20Support%20WASI%20snapshot0%20in%20the%20C%20API./near/191319425" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20Issue.20.231376.20Support.20WASI.20snapshot0.20in.20the.20C.20API.2E.html#191319425">(Mar 21 2020 at 00:36)</a>:</h4>
<p>peterhuene edited a <a href="https://github.com/bytecodealliance/wasmtime/pull/1376#issuecomment-601966130" target="_blank" title="https://github.com/bytecodealliance/wasmtime/pull/1376#issuecomment-601966130">comment</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/1376" target="_blank" title="https://github.com/bytecodealliance/wasmtime/pull/1376">Issue #1376</a>:</p>
<blockquote>
<p>Sigh.  To get the shared stdio (between the multiple WASI context builders) file handles working on Windows, we'd need to open with sharing options.</p>
<p>I'm not really a big fan of this impl (i.e. having the multiple WASI instances).  I may take another stab at this to fix #1220.</p>
</blockquote>



<a name="191477078"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20Issue%20%231376%20Support%20WASI%20snapshot0%20in%20the%20C%20API./near/191477078" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20Issue.20.231376.20Support.20WASI.20snapshot0.20in.20the.20C.20API.2E.html#191477078">(Mar 23 2020 at 14:05)</a>:</h4>
<p>alexcrichton <a href="https://github.com/bytecodealliance/wasmtime/pull/1376#issuecomment-602614054" target="_blank" title="https://github.com/bytecodealliance/wasmtime/pull/1376#issuecomment-602614054">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/1376" target="_blank" title="https://github.com/bytecodealliance/wasmtime/pull/1376">Issue #1376</a>:</p>
<blockquote>
<p>I'm actually a little confused myself as to this error, what's the sycall that's failing due to sharing?</p>
</blockquote>



<a name="191492417"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20Issue%20%231376%20Support%20WASI%20snapshot0%20in%20the%20C%20API./near/191492417" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20Issue.20.231376.20Support.20WASI.20snapshot0.20in.20the.20C.20API.2E.html#191492417">(Mar 23 2020 at 15:44)</a>:</h4>
<p>peterhuene <a href="https://github.com/bytecodealliance/wasmtime/pull/1376#issuecomment-602683974" target="_blank" title="https://github.com/bytecodealliance/wasmtime/pull/1376#issuecomment-602683974">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/1376" target="_blank" title="https://github.com/bytecodealliance/wasmtime/pull/1376">Issue #1376</a>:</p>
<blockquote>
<p>Right now I'm doing a <code>try_clone</code> on the <code>File</code> we open/create for the file path specified in <code>wasi_config_std[in|out|err]_path</code> as well as <code>wasi_config_preopen</code> since it needs to be shared between the two underlying context builders.  By default, it's not being opened with Windows sharing flags, so the try_clone is failing when trying to use those functions.</p>
</blockquote>



<a name="191493160"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20Issue%20%231376%20Support%20WASI%20snapshot0%20in%20the%20C%20API./near/191493160" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20Issue.20.231376.20Support.20WASI.20snapshot0.20in.20the.20C.20API.2E.html#191493160">(Mar 23 2020 at 15:49)</a>:</h4>
<p>peterhuene <a href="https://github.com/bytecodealliance/wasmtime/pull/1376#issuecomment-602687197" target="_blank" title="https://github.com/bytecodealliance/wasmtime/pull/1376#issuecomment-602687197">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/1376" target="_blank" title="https://github.com/bytecodealliance/wasmtime/pull/1376">Issue #1376</a>:</p>
<blockquote>
<p>I have a solution in mind that's going to change the WASI C API functions so that users can request a particular WASI "module" and it'll be represented as a <code>wasm_module_t</code> and thus can be instantiated normally, rather than this special instance type.  That should allow people to use the snapshot of WASI they want, provided the engine supports it.</p>
<p>The C# API would then change so that when you want to instantiate a module with WASI, you get an <code>Instance</code> like any other module and <code>Module.Instantiate</code> will take an enumeration of modules to link against, one of which can be an instantiated WASI module.</p>
</blockquote>



<a name="191493213"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20Issue%20%231376%20Support%20WASI%20snapshot0%20in%20the%20C%20API./near/191493213" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20Issue.20.231376.20Support.20WASI.20snapshot0.20in.20the.20C.20API.2E.html#191493213">(Mar 23 2020 at 15:50)</a>:</h4>
<p>peterhuene edited a <a href="https://github.com/bytecodealliance/wasmtime/pull/1376#issuecomment-602687197" target="_blank" title="https://github.com/bytecodealliance/wasmtime/pull/1376#issuecomment-602687197">comment</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/1376" target="_blank" title="https://github.com/bytecodealliance/wasmtime/pull/1376">Issue #1376</a>:</p>
<blockquote>
<p>I have a solution in mind that's going to change the WASI C API functions so that users can request a particular WASI "module" and it'll be represented as a <code>wasm_module_t</code> and thus can be instantiated normally, rather than this special <code>wasi_instance_t</code> type.  That should allow people to use the snapshot of WASI they want, provided the engine supports it.</p>
<p>The C# API would then change so that when you want to instantiate a module with WASI, you get an <code>Instance</code> like any other module and <code>Module.Instantiate</code> will take an enumeration of modules to link against, one of which can be an instantiated WASI module.</p>
</blockquote>



<a name="191493335"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20Issue%20%231376%20Support%20WASI%20snapshot0%20in%20the%20C%20API./near/191493335" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20Issue.20.231376.20Support.20WASI.20snapshot0.20in.20the.20C.20API.2E.html#191493335">(Mar 23 2020 at 15:50)</a>:</h4>
<p>peterhuene edited a <a href="https://github.com/bytecodealliance/wasmtime/pull/1376#issuecomment-602687197" target="_blank" title="https://github.com/bytecodealliance/wasmtime/pull/1376#issuecomment-602687197">comment</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/1376" target="_blank" title="https://github.com/bytecodealliance/wasmtime/pull/1376">Issue #1376</a>:</p>
<blockquote>
<p>I have a solution in mind that's going to change the WASI C API functions so that users can request a particular WASI "module" and it'll be represented as a <code>wasm_module_t</code> and thus can be instantiated normally, rather than this special <code>wasi_instance_t</code> type.  That should allow people to use the snapshot of WASI they want, provided the engine supports it.</p>
<p>The C# API would then change so that when you want to instantiate a module with WASI, you get an <code>Instance</code> like any other module and <code>Module.Instantiate</code> will take an enumeration of instances to link against, one of which can be an instantiated WASI module.</p>
</blockquote>



<a name="191493818"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20Issue%20%231376%20Support%20WASI%20snapshot0%20in%20the%20C%20API./near/191493818" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20Issue.20.231376.20Support.20WASI.20snapshot0.20in.20the.20C.20API.2E.html#191493818">(Mar 23 2020 at 15:53)</a>:</h4>
<p>peterhuene edited a <a href="https://github.com/bytecodealliance/wasmtime/pull/1376#issuecomment-602687197" target="_blank" title="https://github.com/bytecodealliance/wasmtime/pull/1376#issuecomment-602687197">comment</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/1376" target="_blank" title="https://github.com/bytecodealliance/wasmtime/pull/1376">Issue #1376</a>:</p>
<blockquote>
<p>I have a solution in mind that's going to change the WASI C API functions so that users can request a particular WASI "module" and it'll be represented as a <code>wasm_module_t</code> and thus can be instantiated normally, rather than this special <code>wasi_instance_t</code> type.  That should allow people to use the snapshot of WASI they want, provided the engine supports it.</p>
<p>The C# API would then change so that when you want to instantiate a module with WASI, you get an <code>Instance</code> like any other module and <code>Module.Instantiate</code> will take an enumeration of instances to link against, one of which can be an instantiated WASI module.</p>
<p>This solution would forego this particular PR.  I'm leaving this one open for now until I get that work finished.</p>
</blockquote>



<a name="191493835"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20Issue%20%231376%20Support%20WASI%20snapshot0%20in%20the%20C%20API./near/191493835" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20Issue.20.231376.20Support.20WASI.20snapshot0.20in.20the.20C.20API.2E.html#191493835">(Mar 23 2020 at 15:53)</a>:</h4>
<p>peterhuene edited a <a href="https://github.com/bytecodealliance/wasmtime/pull/1376#issuecomment-602687197" target="_blank" title="https://github.com/bytecodealliance/wasmtime/pull/1376#issuecomment-602687197">comment</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/1376" target="_blank" title="https://github.com/bytecodealliance/wasmtime/pull/1376">Issue #1376</a>:</p>
<blockquote>
<p>I have a solution in mind that's going to change the WASI C API functions so that users can request a particular WASI "module" and it'll be represented as a <code>wasm_module_t</code> and thus can be instantiated normally, rather than this special <code>wasi_instance_t</code> type.  That should allow people to use the snapshot of WASI they want, provided the engine supports it.</p>
<p>The C# API would then change so that when you want to instantiate a module with WASI, you get an <code>Instance</code> like any other module and <code>Module.Instantiate</code> will take an enumeration of instances to link against, one of which can be an instantiated WASI module.</p>
<p>That solution would forego this particular PR.  I'm leaving this one open for now until I get that work finished.</p>
</blockquote>



<a name="191499224"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20Issue%20%231376%20Support%20WASI%20snapshot0%20in%20the%20C%20API./near/191499224" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20Issue.20.231376.20Support.20WASI.20snapshot0.20in.20the.20C.20API.2E.html#191499224">(Mar 23 2020 at 16:29)</a>:</h4>
<p>alexcrichton <a href="https://github.com/bytecodealliance/wasmtime/pull/1376#issuecomment-602710788" target="_blank" title="https://github.com/bytecodealliance/wasmtime/pull/1376#issuecomment-602710788">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/1376" target="_blank" title="https://github.com/bytecodealliance/wasmtime/pull/1376">Issue #1376</a>:</p>
<blockquote>
<p>Hm ok I think I'm not familiar enough with windows sharing things to know what's going on. I would naively think that we should open files with sharing rights and/or this is a bug in libstd if <code>try_clone</code> never works.</p>
<p>I'm slightly hesitant to get a <code>wasm_module_t</code> or a <code>wasm_instance_t</code> from wasi items since they're not actually compiled object code but rather more of a "everyone's gotta have a <code>enum Instance</code> with one variant as jit code and one as wasi modules. I also see though how it'd be quite nice to not have to deal with wasi instances at all and you've only got normal instances/modules. In that sense I think it definitely seems worthwhile to explore! I'll wait until I have some code to peek at :)</p>
</blockquote>



<a name="191507816"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20Issue%20%231376%20Support%20WASI%20snapshot0%20in%20the%20C%20API./near/191507816" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20Issue.20.231376.20Support.20WASI.20snapshot0.20in.20the.20C.20API.2E.html#191507816">(Mar 23 2020 at 17:26)</a>:</h4>
<p>peterhuene <a href="https://github.com/bytecodealliance/wasmtime/pull/1376#issuecomment-602743903" target="_blank" title="https://github.com/bytecodealliance/wasmtime/pull/1376#issuecomment-602743903">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/1376" target="_blank" title="https://github.com/bytecodealliance/wasmtime/pull/1376">Issue #1376</a>:</p>
<blockquote>
<p>We definitely can use the Windows stdlib extensions for opening with sharing to get this green, which is simple to do.</p>
<p>I'm just not a fan of this approach after (even) more consideration.  This doesn't scale well as more and more snapshots get released and we have to support them, assuming we don't solve the problem with a single WASI instance that knows how to polyfill previous snapshots itself.</p>
<p>I'll take a stab at the alternative approach today and put it up for your review.</p>
</blockquote>



<a name="191508045"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20Issue%20%231376%20Support%20WASI%20snapshot0%20in%20the%20C%20API./near/191508045" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20Issue.20.231376.20Support.20WASI.20snapshot0.20in.20the.20C.20API.2E.html#191508045">(Mar 23 2020 at 17:28)</a>:</h4>
<p>peterhuene edited a <a href="https://github.com/bytecodealliance/wasmtime/pull/1376#issuecomment-602743903" target="_blank" title="https://github.com/bytecodealliance/wasmtime/pull/1376#issuecomment-602743903">comment</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/1376" target="_blank" title="https://github.com/bytecodealliance/wasmtime/pull/1376">Issue #1376</a>:</p>
<blockquote>
<p>We definitely can use the Windows stdlib extensions for opening with sharing to get this green, which is simple to do.</p>
<p>I'm just not a fan of this approach after (even) more consideration.  This doesn't scale well as more and more snapshots get released and we have to support them, assuming we don't solve the problem with a single WASI instance that knows how to polyfill previous snapshots itself.</p>
<p>Regarding the enum problem, it should be at least limited to the C API to answer the "what kind of module is this?" question.  At least it wouldn't complicate the Rust API unnecessarily.</p>
<p>I'll take a stab at the alternative approach today and put it up for your review.</p>
</blockquote>



<a name="191832592"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20Issue%20%231376%20Support%20WASI%20snapshot0%20in%20the%20C%20API./near/191832592" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20Issue.20.231376.20Support.20WASI.20snapshot0.20in.20the.20C.20API.2E.html#191832592">(Mar 26 2020 at 01:53)</a>:</h4>
<p>peterhuene <a href="https://github.com/bytecodealliance/wasmtime/pull/1376#issuecomment-604182458" title="https://github.com/bytecodealliance/wasmtime/pull/1376#issuecomment-604182458">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/1376" title="https://github.com/bytecodealliance/wasmtime/pull/1376">Issue #1376</a>:</p>
<blockquote>
<p>I'm closing this in favor of the commit that adds support for WASI snapshot0 in #1411.</p>
</blockquote>



<hr><p>Last updated: Jan 20 2025 at 06:04 UTC</p>
</html>