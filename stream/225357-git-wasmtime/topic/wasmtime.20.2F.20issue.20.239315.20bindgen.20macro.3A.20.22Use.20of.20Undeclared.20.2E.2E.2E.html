<html>
<head><meta charset="utf-8"><title>wasmtime / issue #9315 bindgen macro: &quot;Use of Undeclared ... · git-wasmtime · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/index.html">git-wasmtime</a></h2>
<h3>Topic: <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.239315.20bindgen.20macro.3A.20.22Use.20of.20Undeclared.20.2E.2E.2E.html">wasmtime / issue #9315 bindgen macro: &quot;Use of Undeclared ...</a></h3>

<hr>

<base href="https://bytecodealliance.zulipchat.com">

<head><link href="https://bytecodealliance.github.io/zulip-archive/style.css" rel="stylesheet"></head>

<a name="472892311"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%239315%20bindgen%20macro%3A%20%22Use%20of%20Undeclared%20.../near/472892311" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.239315.20bindgen.20macro.3A.20.22Use.20of.20Undeclared.20.2E.2E.2E.html#472892311">(Sep 26 2024 at 13:06)</a>:</h4>
<p>esarver opened <a href="https://github.com/bytecodealliance/wasmtime/issues/9315">issue #9315</a>:</p>
<blockquote>
<h2>Problem Description</h2>
<p>I created a simple <code>host.wit</code> file to start playing with the component model in an embedded runtime. In this file, I created a world by the name <code>host</code>. I was following the examples in the <a href="https://docs.rs/wasmtime/latest/wasmtime/component/bindgen_examples/_1_world_imports/index.html">wasmtime bindgen examples</a> and got an error stating that <code>HostImports</code> did not exist but there was a similar trait named <code>Host_Imports</code> (see build output below). I changed my trait impl to the one shown below and got an error stating that <code>bindgen</code> was creating some code that referenced <code>HostImports</code>. </p>
<p>If I change the world name to anything else, the problem goes away.</p>
<h2>Identified Problem Area</h2>
<p>I found that there is a function in <code>wasmtime/crates/wit-bindgen/src/rust.rs</code> called <a href="https://github.com/bytecodealliance/wasmtime/blob/main/crates/wit-bindgen/src/rust.rs#L420-L427"><code>to_rust_upper_camel_case</code></a> that uses <code>Host_</code> if the provided <code>name</code> is <code>host</code>. This is not being used consistently somewhere.</p>
<h2>Project Files</h2>
<p>Here are my project files that replicate the issue, along with the <code>cargo expand</code> output that shows the code with an issue (collapsed to improve readability of this ticket). </p>
<h3><code>./Cargo.toml</code></h3>
<div class="codehilite" data-code-language="TOML"><pre><span></span><code><span class="k">[package]</span>
<span class="n">name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"host"</span>
<span class="n">version</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"0.1.0"</span>
<span class="n">edition</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"2021"</span>

<span class="k">[dependencies]</span>
<span class="n">wasmtime</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"25.0.1"</span>
<span class="n">wit-bindgen</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"0.32.0"</span>
</code></pre></div>
<h3><code>./wit/host.wit</code></h3>
<div class="codehilite" data-code-language="wit"><pre><span></span><code>package system:system;

world host {
    import print: func(msg: string);
    export run: func();
}
</code></pre></div>
<h3><code>./src/main.rs</code></h3>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="k">use</span><span class="w"> </span><span class="n">wasmtime</span><span class="p">::</span><span class="o">*</span><span class="p">;</span>

<span class="n">wasmtime</span><span class="p">::</span><span class="n">component</span><span class="p">::</span><span class="n">bindgen</span><span class="o">!</span><span class="p">(</span><span class="s">"host"</span><span class="p">);</span>

<span class="k">struct</span><span class="w"> </span><span class="nc">State</span><span class="p">;</span>

<span class="k">impl</span><span class="w"> </span><span class="n">Host_Imports</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">State</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">fn</span><span class="w"> </span><span class="nf">print</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="bp">self</span><span class="p">,</span><span class="w"> </span><span class="n">msg</span><span class="p">:</span><span class="w"> </span><span class="nb">String</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="fm">println!</span><span class="p">(</span><span class="s">"{msg}"</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>

<span class="k">fn</span><span class="w"> </span><span class="nf">main</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="fm">println!</span><span class="p">(</span><span class="s">"Hello, world!"</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div>
<p>&lt;details&gt;<br>
&lt;summary&gt;</p>
<h3>Expanded <code>main.rs</code></h3>
<p>&lt;/summary&gt;</p>
<p><div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="cp">#![feature(prelude_import)]</span>
<span class="cp">#[prelude_import]</span>
<span class="k">use</span><span class="w"> </span><span class="n">std</span><span class="p">::</span><span class="n">prelude</span><span class="p">::</span><span class="n">rust_2021</span><span class="p">::</span><span class="o">*</span><span class="p">;</span>
<span class="cp">#[macro_use]</span>
<span class="k">extern</span><span class="w"> </span><span class="k">crate</span><span class="w"> </span><span class="n">std</span><span class="p">;</span>
<span class="k">use</span><span class="w"> </span><span class="n">wasmtime</span><span class="p">::</span><span class="o">*</span><span class="p">;</span>
<span class="sd">/// Auto-generated bindings for a pre-instantiated version of a</span>
<span class="sd">/// component which implements the world `host`.</span>
<span class="sd">///</span>
<span class="sd">/// This structure is created through [`Host_Pre::new`] which</span>
<span class="sd">/// takes a [`InstancePre`](wasmtime::component::InstancePre) that</span>
<span class="sd">/// has been created through a [`Linker`](wasmtime::component::Linker).</span>
<span class="sd">///</span>
<span class="sd">/// For more information see [`Host_`] as well.</span>
<span class="k">pub</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">Host_Pre</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">instance_pre</span><span class="p">:</span><span class="w"> </span><span class="nc">wasmtime</span><span class="p">::</span><span class="n">component</span><span class="p">::</span><span class="n">InstancePre</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span><span class="p">,</span>
<span class="w">    </span><span class="n">indices</span><span class="p">:</span><span class="w"> </span><span class="nc">Host_Indices</span><span class="p">,</span>
<span class="p">}</span>
<span class="k">impl</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span><span class="w"> </span><span class="nb">Clone</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">Host_Pre</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">fn</span><span class="w"> </span><span class="nf">clone</span><span class="p">(</span><span class="o">&amp;</span><span class="bp">self</span><span class="p">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w"> </span><span class="nc">Self</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="bp">Self</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">instance_pre</span><span class="p">:</span><span class="w"> </span><span class="nc">self</span><span class="p">.</span><span class="n">instance_pre</span><span class="p">.</span><span class="n">clone</span><span class="p">(),</span>
<span class="w">            </span><span class="n">indices</span><span class="p">:</span><span class="w"> </span><span class="nc">self</span><span class="p">.</span><span class="n">indices</span><span class="p">.</span><span class="n">clone</span><span class="p">(),</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
<span class="k">impl</span><span class="o">&lt;</span><span class="n">_T</span><span class="o">&gt;</span><span class="w"> </span><span class="n">Host_Pre</span><span class="o">&lt;</span><span class="n">_T</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="sd">/// Creates a new copy of `Host_Pre` bindings which can then</span>
<span class="w">    </span><span class="sd">/// be used to instantiate into a particular store.</span>
<span class="w">    </span><span class="sd">///</span>
<span class="w">    </span><span class="sd">/// This method may fail if the component behind `instance_pre`</span>
<span class="w">    </span><span class="sd">/// does not have the required exports.</span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="k">fn</span><span class="w"> </span><span class="nf">new</span><span class="p">(</span>
<span class="w">        </span><span class="n">instance_pre</span><span class="p">:</span><span class="w"> </span><span class="nc">wasmtime</span><span class="p">::</span><span class="n">component</span><span class="p">::</span><span class="n">InstancePre</span><span class="o">&lt;</span><span class="n">_T</span><span class="o">&gt;</span><span class="p">,</span>
<span class="w">    </span><span class="p">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w"> </span><span class="nc">wasmtime</span><span class="p">::</span><span class="nb">Result</span><span class="o">&lt;</span><span class="bp">Self</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="n">indices</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Host_Indices</span><span class="p">::</span><span class="n">new</span><span class="p">(</span><span class="n">instance_pre</span><span class="p">.</span><span class="n">component</span><span class="p">())</span><span class="o">?</span><span class="p">;</span>
<span class="w">        </span><span class="nb">Ok</span><span class="p">(</span><span class="bp">Self</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">instance_pre</span><span class="p">,</span><span class="w"> </span><span class="n">indices</span><span class="w"> </span><span class="p">})</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="k">fn</span><span class="w"> </span><span class="nf">engine</span><span class="p">(</span><span class="o">&amp;</span><span class="bp">self</span><span class="p">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w"> </span><span class="kp">&amp;</span><span class="nc">wasmtime</span><span class="p">::</span><span class="n">Engine</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="bp">self</span><span class="p">.</span><span class="n">instance_pre</span><span class="p">.</span><span class="n">engine</span><span class="p">()</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="k">fn</span><span class="w"> </span><span class="nf">instance_pre</span><span class="p">(</span><span class="o">&amp;</span><span class="bp">self</span><span class="p">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w"> </span><span class="kp">&amp;</span><span class="nc">wasmtime</span><span class="p">::</span><span class="n">component</span><span class="p">::</span><span class="n">InstancePre</span><span class="o">&lt;</span><span class="n">_T</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="o">&amp;</span><span class="bp">self</span><span class="p">.</span><span class="n">instance_pre</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="sd">/// Instantiates a new instance of [`Host_`] within the</span>
<span class="w">    </span><span class="sd">/// `store` provided.</span>
<span class="w">    </span><span class="sd">///</span>
<span class="w">    </span><span class="sd">/// This function will use `self` as the pre-instantiated</span>
<span class="w">    </span><span class="sd">/// instance to perform instantiation. Afterwards the preloaded</span>
<span class="w">    </span><span class="sd">/// indices in `self` are used to lookup all exports on the</span>
<span class="w">    </span><span class="sd">/// resulting instance.</span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="k">fn</span><span class="w"> </span><span class="nf">instantiate</span><span class="p">(</span>
<span class="w">        </span><span class="o">&amp;</span><span class="bp">self</span><span class="p">,</span>
<span class="w">        </span><span class="k">mut</span><span class="w"> </span><span class="n">store</span><span class="p">:</span><span class="w"> </span><span class="nc">impl</span><span class="w"> </span><span class="n">wasmtime</span><span class="p">::</span><span class="n">AsContextMut</span><span class="o">&lt;</span><span class="n">Data</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">_T</span><span class="o">&gt;</span><span class="p">,</span>
<span class="w">    </span><span class="p">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w"> </span><span class="nc">wasmtime</span><span class="p">::</span><span class="nb">Result</span><span class="o">&lt;</span><span class="n">Host_</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">store</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">store</span><span class="p">.</span><span class="n">as_context_mut</span><span class="p">();</span>
<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="n">instance</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="bp">self</span><span class="p">.</span><span class="n">instance_pre</span><span class="p">.</span><span class="n">instantiate</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="n">store</span><span class="p">)</span><span class="o">?</span><span class="p">;</span>
<span class="w">        </span><span class="bp">self</span><span class="p">.</span><span class="n">indices</span><span class="p">.</span><span class="n">load</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="n">store</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">instance</span><span class="p">)</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
<span class="sd">/// Auto-generated bindings for index of the exports of</span>
<span class="sd">/// `host`.</span>
<span class="sd">///</span>
<span class="sd">/// This is an implementation detail of [`Host_Pre`] and can</span>
<span class="sd">/// be constructed if needed as well.</span>
<span class="sd">///</span>
<span class="sd">/// For more information see [`Host_`] as well.</span>
<span class="k">pub</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">Host_Indices</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">run</span><span class="p">:</span><span class="w"> </span><span class="nc">wasmtime</span><span class="p">::</span><span class="n">component</span><span class="p">::</span><span class="n">ComponentExportIndex</span><span class="p">,</span>
<span class="p">}</span>
<span class="cp">#[automatically_derived]</span>
<span class="k">impl</span><span class="w"> </span><span class="p">::</span><span class="n">core</span><span class="p">::</span><span class="n">clone</span><span class="p">::</span><span class="nb">Clone</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">Host_Indices</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="cp">#[inline]</span>
<span class="w">    </span><span class="k">fn</span><span class="w"> </span><span class="nf">clone</span><span class="p">(</span><span class="o">&amp;</span><span class="bp">self</span><span class="p">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w"> </span><span class="nc">Host_Indices</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">Host_Indices</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">run</span><span class="p">:</span><span class="w"> </span><span class="p">::</span><span class="n">core</span><span class="p">::</span><span class="n">clone</span><span class="p">::</span><span class="nb">Clone</span><span class="p">::</span><span class="n">clone</span><span class="p">(</span><span class="o">&amp;</span><span class="bp">self</span><span class="p">.</span><span class="n">run</span><span class="p">),</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
<span class="sd">/// Auto-generated bindings for an instance a component which</span>
<span class="sd">/// implements the world `host`.</span>
<span class="sd">///</span>
<span class="sd">/// This structure can be created through a number of means</span>
<span class="sd">/// depending on your requirements and what you have on hand:</span>
<span class="sd">///</span>
<span class="sd">/// * The most convenient way is to use</span>
<span class="sd">///   [`Host_::instantiate`] which only needs a</span>
<span class="sd">///   [`Store`], [`Component`], and [`Linker`].</span>
<span class="sd">///</span>
<span class="sd">/// * Alternatively you can create a [`Host_Pre`] ahead of</span>
<span class="sd">///   time with a [`Component`] to front-load string lookups</span>
<span class="sd">///   of exports once instead of per-instantiation. This</span>
<span class="sd">///   method then uses [`Host_Pre::instantiate`] to</span>
<span class="sd">///   create a [`Host_`].</span>
<span class="sd">///</span>
<span class="sd">/// * If you've instantiated the instance yourself already</span>
<span class="sd">///   then you can use [`Host_::new`].</span>
<span class="sd">///</span>
<span class="sd">/// * You can also access the guts of instantiation through</span>
<span class="sd">///   [`Host_Indices::new_instance`] followed</span>
<span class="sd">///   by [`Host_Indices::load`] to crate an instance of this</span>
<span class="sd">///   type.</span>
<span class="sd">///</span>
<span class="sd">/// These methods are all equivalent to one another and move</span>
<span class="sd">/// around the tradeoff of what work is performed when.</span>
<span class="sd">///</span>
<span class="sd">/// [`Store`]: wasmtime::Store</span>
<span class="sd">/// [`Component`]: wasmtime::component::Component</span>
<span class="sd">/// [`Linker`]: wasmtime::component::Linker</span>
<span class="k">pub</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">Host_</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">run</span><span class="p">:</span><span class="w"> </span><span class="nc">wasmtime</span><span class="p">::</span><span class="n">component</span><span class="p">::</span><span class="n">Func</span><span class="p">,</span>
<span class="p">}</span>
<span class="k">pub</span><span class="w"> </span><span class="k">trait</span><span class="w"> </span><span class="n">Host_Imports</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">fn</span><span class="w"> </span><span class="nf">print</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="bp">self</span><span class="p">,</span><span class="w"> </span><span class="n">msg</span><span class="p">:</span><span class="w"> </span><span class="nc">wasmtime</span><span class="p">::</span><span class="n">component</span><span class="p">::</span><span class="n">__internal</span><span class="p">::</span><span class="nb">String</span><span class="p">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w"> </span><span class="p">();</span>
<span class="p">}</span>
<span class="k">pub</span><span class="w"> </span><span class="k">trait</span><span class="w"> </span><span class="n">Host_ImportsGetHost</span><span class="o">&lt;</span>
<span class="w">    </span><span class="n">T</span><span class="p">,</span>
<span class="o">&gt;</span><span class="p">:</span><span class="w"> </span><span class="nb">Fn</span><span class="p">(</span><span class="n">T</span><span class="p">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w"> </span><span class="o">&lt;</span><span class="bp">Self</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">Host_ImportsGetHost</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;&gt;</span><span class="p">::</span><span class="n">Host</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nb">Send</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nb">Sync</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nb">Copy</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="o">'</span><span class="nb">static</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">type</span><span class="w"> </span><span class="nc">Host</span><span class="p">:</span><span class="w"> </span><span class="nc">Host_Imports</span><span class="p">;</span>
<span class="p">}</span>
<span class="k">impl</span><span class="o">&lt;</span><span class="n">F</span><span class="p">,</span><span class="w"> </span><span class="n">T</span><span class="p">,</span><span class="w"> </span><span class="n">O</span><span class="o">&gt;</span><span class="w"> </span><span class="n">Host_ImportsGetHost</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">F</span>
<span class="k">where</span>
<span class="w">    </span><span class="n">F</span><span class="p">:</span><span class="w"> </span><span class="nb">Fn</span><span class="p">(</span><span class="n">T</span><span class="p">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w"> </span><span class="nc">O</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nb">Send</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nb">Sync</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nb">Copy</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="o">'</span><span class="nb">static</span><span class="p">,</span>
<span class="w">    </span><span class="n">O</span><span class="p">:</span><span class="w"> </span><span class="nc">Host_Imports</span><span class="p">,</span>
<span class="p">{</span>
<span class="w">    </span><span class="k">type</span><span class="w"> </span><span class="nc">Host</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">O</span><span class="p">;</span>
<span class="p">}</span>
<span class="k">impl</span><span class="o">&lt;</span><span class="n">_T</span><span class="p">:</span><span class="w"> </span><span class="nc">Host_Imports</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="o">?</span><span class="nb">Sized</span><span class="o">&gt;</span><span class="w"> </span><span class="n">Host_Imports</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="n">_T</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">fn</span><span class="w"> </span><span class="nf">print</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="bp">self</span><span class="p">,</span><span class="w"> </span><span class="n">msg</span><span class="p">:</span><span class="w"> </span><span class="nc">wasmtime</span><span class="p">::</span><span class="n">component</span><span class="p">::</span><span class="n">__internal</span><span class="p">::</span><span class="nb">String</span><span class="p">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">Host_Imports</span><span class="p">::</span><span class="n">print</span><span class="p">(</span><span class="o">*</span><span class="bp">self</span><span class="p">,</span><span class="w"> </span><span class="n">msg</span><span class="p">)</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
<span class="k">const</span><span class="w"> </span><span class="n">_</span><span class="p">:</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="cp">#[allow(unused_imports)]</span>
<span class="w">    </span><span class="k">use</span><span class="w"> </span><span class="n">wasmtime</span><span class="p">::</span><span class="n">component</span><span class="p">::</span><span class="n">__internal</span><span class="p">::</span><span class="n">anyhow</span><span class="p">;</span>
<span class="w">    </span><span class="k">impl</span><span class="w"> </span><span class="n">Host_Indices</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="sd">/// Creates a new copy of `Host_Indices` bindings which can then</span>
<span class="w">        </span><span class="sd">/// be used to instantiate into a particular store.</span>
<span class="w">        </span><span class="sd">///</span>
<span class="w">        </span><span class="sd">/// This method may fail if the component does not have the</span>
<span class="w">        </span><span class="sd">/// required exports.</span>
<span class="w">        </span><span class="k">pub</span><span class="w"> </span><span class="k">fn</span><span class="w"> </span><span class="nf">new</span><span class="p">(</span>
<span class="w">            </span><span class="n">component</span><span class="p">:</span><span class="w"> </span><span class="kp">&amp;</span><span class="nc">wasmtime</span><span class="p">::</span><span class="n">component</span><span class="p">::</span><span class="n">Component</span><span class="p">,</span>
<span class="w">        </span><span class="p">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w"> </span><span class="nc">wasmtime</span><span class="p">::</span><span class="nb">Result</span><span class="o">&lt;</span><span class="bp">Self</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="kd">let</span><span class="w"> </span><span class="n">_component</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">component</span><span class="p">;</span>
<span class="w">            </span><span class="kd">let</span><span class="w"> </span><span class="n">run</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">_component</span>
<span class="w">                </span><span class="p">.</span><span class="n">export_index</span><span class="p">(</span><span class="nb">None</span><span class="p">,</span><span class="w"> </span><span class="s">"run"</span><span class="p">)</span>
<span class="w">                </span><span class="p">.</span><span class="n">ok_or_else</span><span class="p">(</span><span class="o">||</span><span class="w"> </span><span class="p">::</span><span class="n">anyhow</span><span class="p">::</span><span class="n">__private</span><span class="p">::</span><span class="n">must_use</span><span class="p">({</span>
<span class="w">                    </span><span class="kd">let</span><span class="w"> </span><span class="n">error</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">::</span><span class="n">anyhow</span><span class="p">::</span><span class="n">__private</span><span class="p">::</span><span class="n">format_err</span><span class="p">(</span>
<span class="w">                        </span><span class="fm">format_args!</span><span class="p">(</span><span class="s">"no function export `run` found"</span><span class="p">),</span>
<span class="w">                    </span><span class="p">);</span>
<span class="w">                    </span><span class="n">error</span>
<span class="w">                </span><span class="p">}))</span><span class="o">?</span>
<span class="w">                </span><span class="p">.</span><span class="mi">1</span><span class="p">;</span>
<span class="w">            </span><span class="nb">Ok</span><span class="p">(</span><span class="n">Host_Indices</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">run</span><span class="w"> </span><span class="p">})</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">        </span><span class="sd">/// Creates a new instance of [`Host_Indices`] from an</span>
<span class="w">        </span><span class="sd">/// instantiated component.</span>
<span class="w">        </span><span class="sd">///</span>
<span class="w">        </span><span class="sd">/// This method of creating a [`Host_`] will perform string</span>
<span class="w">        </span><span class="sd">/// lookups for all exports when this method is called. This</span>
<span class="w">        </span><span class="sd">/// will only succeed if the provided instance matches the</span>
<span class="w">        </span><span class="sd">/// requirements of [`Host_`].</span>
<span class="w">        </span><span class="k">pub</span><span class="w"> </span><span class="k">fn</span><span class="w"> </span><span class="nf">new_instance</span><span class="p">(</span>
<span class="w">            </span><span class="k">mut</span><span class="w"> </span><span class="n">store</span><span class="p">:</span><span class="w"> </span><span class="nc">impl</span><span class="w"> </span><span class="n">wasmtime</span><span class="p">::</span><span class="n">AsContextMut</span><span class="p">,</span>
<span class="w">            </span><span class="n">instance</span><span class="p">:</span><span class="w"> </span><span class="kp">&amp;</span><span class="nc">wasmtime</span><span class="p">::</span><span class="n">component</span><span class="p">::</span><span class="n">Instance</span><span class="p">,</span>
<span class="w">        </span><span class="p">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w"> </span><span class="nc">wasmtime</span><span class="p">::</span><span class="nb">Result</span><span class="o">&lt;</span><span class="bp">Self</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="kd">let</span><span class="w"> </span><span class="n">_instance</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">instance</span><span class="p">;</span>
<span class="w">            </span><span class="kd">let</span><span class="w"> </span><span class="n">run</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">_instance</span>
<span class="w">                </span><span class="p">.</span><span class="n">get_export</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="n">store</span><span class="p">,</span><span class="w"> </span><span class="nb">None</span><span class="p">,</span><span class="w"> </span><span class="s">"run"</span><span class="p">)</span>
<span class="w">                </span><span class="p">.</span><span class="n">ok_or_else</span><span class="p">(</span><span class="o">||</span><span class="w"> </span><span class="p">::</span><span class="n">anyhow</span><span class="p">::</span><span class="n">__private</span><span class="p">::</span><span class="n">must_use</span><span class="p">({</span>
<span class="w">                    </span><span class="kd">let</span><span class="w"> </span><span class="n">error</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">::</span><span class="n">anyhow</span><span class="p">::</span><span class="n">__private</span><span class="p">::</span><span class="n">format_err</span><span class="p">(</span>
<span class="w">                        </span><span class="fm">format_args!</span><span class="p">(</span><span class="s">"no function export `run` found"</span><span class="p">),</span>
<span class="w">                    </span><span class="p">);</span>
<span class="w">                    </span><span class="n">error</span>
<span class="w">                </span><span class="p">}))</span><span class="o">?</span><span class="p">;</span>
<span class="w">            </span><span class="nb">Ok</span><span class="p">(</span><span class="n">Host_Indices</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">run</span><span class="w"> </span><span class="p">})</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">        </span><span class="sd">/// Uses the indices stored in `self` to load an instance</span>
<span class="w">        </span><span class="sd">/// of [`Host_`] from the instance provided.</span>
<span class="w">        </span><span class="sd">///</span>
<span class="w">        </span><span class="sd">/// Note that at this time this method will additionally</span>
<span class="w">        </span><span class="sd">/// perform type-checks of all exports.</span>
<span class="w">        </span><span class="k">pub</span><span class="w"> </span><span class="k">fn</span><span class="w"> </span><span class="nf">load</span><span class="p">(</span>
<span class="w">            </span><span class="o">&amp;</span><span class="bp">self</span><span class="p">,</span>
<span class="w">            </span><span class="k">mut</span><span class="w"> </span><span class="n">store</span><span class="p">:</span><span class="w"> </span><span class="nc">impl</span><span class="w"> </span><span class="n">wasmtime</span><span class="p">::</span><span class="n">AsContextMut</span><span class="p">,</span>
<span class="w">            </span><span class="n">instance</span><span class="p">:</span><span class="w"> </span><span class="kp">&amp;</span><span class="nc">wasmtime</span><span class="p">::</span><span class="n">component</span><span class="p">::</span><span class="n">Instance</span><span class="p">,</span>
<span class="w">        </span><span class="p">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w"> </span><span class="nc">wasmtime</span><span class="p">::</span><span class="nb">Result</span><span class="o">&lt;</span><span class="n">Host_</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="kd">let</span><span class="w"> </span><span class="n">_instance</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">instance</span><span class="p">;</span>
<span class="w">            </span><span class="kd">let</span><span class="w"> </span><span class="n">run</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">*</span><span class="n">_instance</span><span class="p">.</span><span class="n">get_typed_func</span><span class="p">::</span><span class="o">&lt;</span><span class="p">(),</span><span class="w"> </span><span class="p">()</span><span class="o">&gt;</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="n">store</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="bp">self</span><span class="p">.</span><span class="n">run</span><span class="p">)</span><span class="o">?</span><span class="p">.</span><span class="n">func</span><span class="p">();</span>
<span class="w">            </span><span class="nb">Ok</span><span class="p">(</span><span class="n">Host_</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">run</span><span class="w"> </span><span class="p">})</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="k">impl</span><span class="w"> </span><span class="n">Host_</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="sd">/// Convenience wrapper around [`Host_Pre::new`] and</span>
<span class="w">        </span><span class="sd">/// [`Host_Pre::instantiate`].</span>
<span class="w">        </span><span class="k">pub</span><span class="w"> </span><span class="k">fn</span><span class="w"> </span><span class="nf">instantiate</span><span class="o">&lt;</span><span class="n">_T</span><span class="o">&gt;</span><span class="p">(</span>
<span class="w">            </span><span class="k">mut</span><span class="w"> </span><span class="n">store</span><span class="p">:</span><span class="w"> </span><span class="nc">impl</span><span class="w"> </span><span class="n">wasmtime</span><span class="p">::</span><span class="n">AsContextMut</span><span class="o">&lt;</span><span class="n">Data</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">_T</span><span class="o">&gt;</span><span class="p">,</span>
<span class="w">            </span><span class="n">component</span><span class="p">:</span><span class="w"> </span><span class="kp">&amp;</span><span class="nc">wasmtime</span><span class="p">::</span><span class="n">component</span><span class="p">::</span><span class="n">Component</span><span class="p">,</span>
<span class="w">            </span><span class="n">linker</span><span class="p">:</span><span class="w"> </span><span class="kp">&amp;</span><span class="nc">wasmtime</span><span class="p">::</span><span class="n">component</span><span class="p">::</span><span class="n">Linker</span><span class="o">&lt;</span><span class="n">_T</span><span class="o">&gt;</span><span class="p">,</span>
<span class="w">        </span><span class="p">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w"> </span><span class="nc">wasmtime</span><span class="p">::</span><span class="nb">Result</span><span class="o">&lt;</span><span class="n">Host_</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="kd">let</span><span class="w"> </span><span class="n">pre</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">linker</span><span class="p">.</span><span class="n">instantiate_pre</span><span class="p">(</span><span class="n">component</span><span class="p">)</span><span class="o">?</span><span class="p">;</span>
<span class="w">            </span><span class="n">Host_Pre</span><span class="p">::</span><span class="n">new</span><span class="p">(</span><span class="n">pre</span><span class="p">)</span><span class="o">?</span><span class="p">.</span><span class="n">instantiate</span><span class="p">(</span><span class="n">store</span><span class="p">)</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">        </span><span class="sd">/// Convenience wrapper around [`Host_Indices::new_instance`] and</span>
<span class="w">        </span><span class="sd">/// [`Host_Indices::load`].</span>
<span class="w">        </span><span class="k">pub</span><span class="w"> </span><span class="k">fn</span><span class="w"> </span><span class="nf">new</span><span class="p">(</span>
<span class="w">            </span><span class="k">mut</span><span class="w"> </span><span class="n">store</span><span class="p">:</span><span class="w"> </span><span class="nc">impl</span><span class="w"> </span><span class="n">wasmtime</span><span class="p">::</span><span class="n">AsContextMut</span><span class="p">,</span>
<span class="w">            </span><span class="n">instance</span><span class="p">:</span><span class="w"> </span><span class="kp">&amp;</span><span class="nc">wasmtime</span><span class="p">::</span><span class="n">component</span><span class="p">::</span><span class="n">Instance</span><span class="p">,</span>
<span class="w">        </span><span class="p">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w"> </span><span class="nc">wasmtime</span><span class="p">::</span><span class="nb">Result</span><span class="o">&lt;</span><span class="n">Host_</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="kd">let</span><span class="w"> </span><span class="n">indices</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Host_Indices</span><span class="p">::</span><span class="n">new_instance</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="n">store</span><span class="p">,</span><span class="w"> </span><span class="n">instance</span><span class="p">)</span><span class="o">?</span><span class="p">;</span>
<span class="w">            </span><span class="n">indices</span>
<span class="p">[</span><span class="n">message</span><span class="w"> </span><span class="n">truncated</span><span class="p">]</span>
</code></pre></div><br>
</p>
</blockquote>



<a name="472898617"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%239315%20bindgen%20macro%3A%20%22Use%20of%20Undeclared%20.../near/472898617" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.239315.20bindgen.20macro.3A.20.22Use.20of.20Undeclared.20.2E.2E.2E.html#472898617">(Sep 26 2024 at 13:33)</a>:</h4>
<p>esarver <a href="https://github.com/bytecodealliance/wasmtime/issues/9315#issuecomment-2376993863">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/9315">issue #9315</a>:</p>
<blockquote>
<p>The issue appears to be in <a href="https://github.com/bytecodealliance/wasmtime/blob/main/crates/wit-bindgen/src/lib.rs#L2608"><code>wasmtime/crates/wit-bindgen/src/lib.rs</code></a></p>
<p>I'll try making a quick change to see if I can get it to work and then submit a PR.</p>
</blockquote>



<a name="472898709"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%239315%20bindgen%20macro%3A%20%22Use%20of%20Undeclared%20.../near/472898709" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.239315.20bindgen.20macro.3A.20.22Use.20of.20Undeclared.20.2E.2E.2E.html#472898709">(Sep 26 2024 at 13:34)</a>:</h4>
<p>esarver edited a <a href="https://github.com/bytecodealliance/wasmtime/issues/9315#issuecomment-2376993863">comment</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/9315">issue #9315</a>:</p>
<blockquote>
<p>The issue appears to be in <a href="https://github.com/bytecodealliance/wasmtime/blob/main/crates/wit-bindgen/src/lib.rs#L2608"><code>wasmtime/crates/wit-bindgen/src/lib.rs:2608</code></a></p>
<p>I'll try making a quick change to see if I can get it to work and then submit a PR.</p>
</blockquote>



<a name="473362574"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%239315%20bindgen%20macro%3A%20%22Use%20of%20Undeclared%20.../near/473362574" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.239315.20bindgen.20macro.3A.20.22Use.20of.20Undeclared.20.2E.2E.2E.html#473362574">(Sep 28 2024 at 16:20)</a>:</h4>
<p>alexcrichton closed <a href="https://github.com/bytecodealliance/wasmtime/issues/9315">issue #9315</a>:</p>
<blockquote>
<h2>Problem Description</h2>
<p>I created a simple <code>host.wit</code> file to start playing with the component model in an embedded runtime. In this file, I created a world by the name <code>host</code>. I was following the examples in the <a href="https://docs.rs/wasmtime/latest/wasmtime/component/bindgen_examples/_1_world_imports/index.html">wasmtime bindgen examples</a> and got an error stating that <code>HostImports</code> did not exist but there was a similar trait named <code>Host_Imports</code> (see build output below). I changed my trait impl to the one shown below and got an error stating that <code>bindgen</code> was creating some code that referenced <code>HostImports</code>. </p>
<p>If I change the world name to anything else, the problem goes away.</p>
<h2>Identified Problem Area</h2>
<p>I found that there is a function in <code>wasmtime/crates/wit-bindgen/src/rust.rs</code> called <a href="https://github.com/bytecodealliance/wasmtime/blob/main/crates/wit-bindgen/src/rust.rs#L420-L427"><code>to_rust_upper_camel_case</code></a> that uses <code>Host_</code> if the provided <code>name</code> is <code>host</code>. This is not being used consistently somewhere.</p>
<h2>Project Files</h2>
<p>Here are my project files that replicate the issue, along with the <code>cargo expand</code> output that shows the code with an issue (collapsed to improve readability of this ticket). </p>
<h3><code>./Cargo.toml</code></h3>
<div class="codehilite" data-code-language="TOML"><pre><span></span><code><span class="k">[package]</span>
<span class="n">name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"host"</span>
<span class="n">version</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"0.1.0"</span>
<span class="n">edition</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"2021"</span>

<span class="k">[dependencies]</span>
<span class="n">wasmtime</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"25.0.1"</span>
<span class="n">wit-bindgen</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"0.32.0"</span>
</code></pre></div>
<h3><code>./wit/host.wit</code></h3>
<div class="codehilite" data-code-language="wit"><pre><span></span><code>package system:system;

world host {
    import print: func(msg: string);
    export run: func();
}
</code></pre></div>
<h3><code>./src/main.rs</code></h3>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="k">use</span><span class="w"> </span><span class="n">wasmtime</span><span class="p">::</span><span class="o">*</span><span class="p">;</span>

<span class="n">wasmtime</span><span class="p">::</span><span class="n">component</span><span class="p">::</span><span class="n">bindgen</span><span class="o">!</span><span class="p">(</span><span class="s">"host"</span><span class="p">);</span>

<span class="k">struct</span><span class="w"> </span><span class="nc">State</span><span class="p">;</span>

<span class="k">impl</span><span class="w"> </span><span class="n">Host_Imports</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">State</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">fn</span><span class="w"> </span><span class="nf">print</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="bp">self</span><span class="p">,</span><span class="w"> </span><span class="n">msg</span><span class="p">:</span><span class="w"> </span><span class="nb">String</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="fm">println!</span><span class="p">(</span><span class="s">"{msg}"</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>

<span class="k">fn</span><span class="w"> </span><span class="nf">main</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="fm">println!</span><span class="p">(</span><span class="s">"Hello, world!"</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div>
<p>&lt;details&gt;<br>
&lt;summary&gt;</p>
<h3>Expanded <code>main.rs</code></h3>
<p>&lt;/summary&gt;</p>
<p><div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="cp">#![feature(prelude_import)]</span>
<span class="cp">#[prelude_import]</span>
<span class="k">use</span><span class="w"> </span><span class="n">std</span><span class="p">::</span><span class="n">prelude</span><span class="p">::</span><span class="n">rust_2021</span><span class="p">::</span><span class="o">*</span><span class="p">;</span>
<span class="cp">#[macro_use]</span>
<span class="k">extern</span><span class="w"> </span><span class="k">crate</span><span class="w"> </span><span class="n">std</span><span class="p">;</span>
<span class="k">use</span><span class="w"> </span><span class="n">wasmtime</span><span class="p">::</span><span class="o">*</span><span class="p">;</span>
<span class="sd">/// Auto-generated bindings for a pre-instantiated version of a</span>
<span class="sd">/// component which implements the world `host`.</span>
<span class="sd">///</span>
<span class="sd">/// This structure is created through [`Host_Pre::new`] which</span>
<span class="sd">/// takes a [`InstancePre`](wasmtime::component::InstancePre) that</span>
<span class="sd">/// has been created through a [`Linker`](wasmtime::component::Linker).</span>
<span class="sd">///</span>
<span class="sd">/// For more information see [`Host_`] as well.</span>
<span class="k">pub</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">Host_Pre</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">instance_pre</span><span class="p">:</span><span class="w"> </span><span class="nc">wasmtime</span><span class="p">::</span><span class="n">component</span><span class="p">::</span><span class="n">InstancePre</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span><span class="p">,</span>
<span class="w">    </span><span class="n">indices</span><span class="p">:</span><span class="w"> </span><span class="nc">Host_Indices</span><span class="p">,</span>
<span class="p">}</span>
<span class="k">impl</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span><span class="w"> </span><span class="nb">Clone</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">Host_Pre</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">fn</span><span class="w"> </span><span class="nf">clone</span><span class="p">(</span><span class="o">&amp;</span><span class="bp">self</span><span class="p">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w"> </span><span class="nc">Self</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="bp">Self</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">instance_pre</span><span class="p">:</span><span class="w"> </span><span class="nc">self</span><span class="p">.</span><span class="n">instance_pre</span><span class="p">.</span><span class="n">clone</span><span class="p">(),</span>
<span class="w">            </span><span class="n">indices</span><span class="p">:</span><span class="w"> </span><span class="nc">self</span><span class="p">.</span><span class="n">indices</span><span class="p">.</span><span class="n">clone</span><span class="p">(),</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
<span class="k">impl</span><span class="o">&lt;</span><span class="n">_T</span><span class="o">&gt;</span><span class="w"> </span><span class="n">Host_Pre</span><span class="o">&lt;</span><span class="n">_T</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="sd">/// Creates a new copy of `Host_Pre` bindings which can then</span>
<span class="w">    </span><span class="sd">/// be used to instantiate into a particular store.</span>
<span class="w">    </span><span class="sd">///</span>
<span class="w">    </span><span class="sd">/// This method may fail if the component behind `instance_pre`</span>
<span class="w">    </span><span class="sd">/// does not have the required exports.</span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="k">fn</span><span class="w"> </span><span class="nf">new</span><span class="p">(</span>
<span class="w">        </span><span class="n">instance_pre</span><span class="p">:</span><span class="w"> </span><span class="nc">wasmtime</span><span class="p">::</span><span class="n">component</span><span class="p">::</span><span class="n">InstancePre</span><span class="o">&lt;</span><span class="n">_T</span><span class="o">&gt;</span><span class="p">,</span>
<span class="w">    </span><span class="p">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w"> </span><span class="nc">wasmtime</span><span class="p">::</span><span class="nb">Result</span><span class="o">&lt;</span><span class="bp">Self</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="n">indices</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Host_Indices</span><span class="p">::</span><span class="n">new</span><span class="p">(</span><span class="n">instance_pre</span><span class="p">.</span><span class="n">component</span><span class="p">())</span><span class="o">?</span><span class="p">;</span>
<span class="w">        </span><span class="nb">Ok</span><span class="p">(</span><span class="bp">Self</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">instance_pre</span><span class="p">,</span><span class="w"> </span><span class="n">indices</span><span class="w"> </span><span class="p">})</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="k">fn</span><span class="w"> </span><span class="nf">engine</span><span class="p">(</span><span class="o">&amp;</span><span class="bp">self</span><span class="p">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w"> </span><span class="kp">&amp;</span><span class="nc">wasmtime</span><span class="p">::</span><span class="n">Engine</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="bp">self</span><span class="p">.</span><span class="n">instance_pre</span><span class="p">.</span><span class="n">engine</span><span class="p">()</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="k">fn</span><span class="w"> </span><span class="nf">instance_pre</span><span class="p">(</span><span class="o">&amp;</span><span class="bp">self</span><span class="p">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w"> </span><span class="kp">&amp;</span><span class="nc">wasmtime</span><span class="p">::</span><span class="n">component</span><span class="p">::</span><span class="n">InstancePre</span><span class="o">&lt;</span><span class="n">_T</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="o">&amp;</span><span class="bp">self</span><span class="p">.</span><span class="n">instance_pre</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="sd">/// Instantiates a new instance of [`Host_`] within the</span>
<span class="w">    </span><span class="sd">/// `store` provided.</span>
<span class="w">    </span><span class="sd">///</span>
<span class="w">    </span><span class="sd">/// This function will use `self` as the pre-instantiated</span>
<span class="w">    </span><span class="sd">/// instance to perform instantiation. Afterwards the preloaded</span>
<span class="w">    </span><span class="sd">/// indices in `self` are used to lookup all exports on the</span>
<span class="w">    </span><span class="sd">/// resulting instance.</span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="k">fn</span><span class="w"> </span><span class="nf">instantiate</span><span class="p">(</span>
<span class="w">        </span><span class="o">&amp;</span><span class="bp">self</span><span class="p">,</span>
<span class="w">        </span><span class="k">mut</span><span class="w"> </span><span class="n">store</span><span class="p">:</span><span class="w"> </span><span class="nc">impl</span><span class="w"> </span><span class="n">wasmtime</span><span class="p">::</span><span class="n">AsContextMut</span><span class="o">&lt;</span><span class="n">Data</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">_T</span><span class="o">&gt;</span><span class="p">,</span>
<span class="w">    </span><span class="p">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w"> </span><span class="nc">wasmtime</span><span class="p">::</span><span class="nb">Result</span><span class="o">&lt;</span><span class="n">Host_</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">store</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">store</span><span class="p">.</span><span class="n">as_context_mut</span><span class="p">();</span>
<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="n">instance</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="bp">self</span><span class="p">.</span><span class="n">instance_pre</span><span class="p">.</span><span class="n">instantiate</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="n">store</span><span class="p">)</span><span class="o">?</span><span class="p">;</span>
<span class="w">        </span><span class="bp">self</span><span class="p">.</span><span class="n">indices</span><span class="p">.</span><span class="n">load</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="n">store</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">instance</span><span class="p">)</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
<span class="sd">/// Auto-generated bindings for index of the exports of</span>
<span class="sd">/// `host`.</span>
<span class="sd">///</span>
<span class="sd">/// This is an implementation detail of [`Host_Pre`] and can</span>
<span class="sd">/// be constructed if needed as well.</span>
<span class="sd">///</span>
<span class="sd">/// For more information see [`Host_`] as well.</span>
<span class="k">pub</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">Host_Indices</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">run</span><span class="p">:</span><span class="w"> </span><span class="nc">wasmtime</span><span class="p">::</span><span class="n">component</span><span class="p">::</span><span class="n">ComponentExportIndex</span><span class="p">,</span>
<span class="p">}</span>
<span class="cp">#[automatically_derived]</span>
<span class="k">impl</span><span class="w"> </span><span class="p">::</span><span class="n">core</span><span class="p">::</span><span class="n">clone</span><span class="p">::</span><span class="nb">Clone</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">Host_Indices</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="cp">#[inline]</span>
<span class="w">    </span><span class="k">fn</span><span class="w"> </span><span class="nf">clone</span><span class="p">(</span><span class="o">&amp;</span><span class="bp">self</span><span class="p">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w"> </span><span class="nc">Host_Indices</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">Host_Indices</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">run</span><span class="p">:</span><span class="w"> </span><span class="p">::</span><span class="n">core</span><span class="p">::</span><span class="n">clone</span><span class="p">::</span><span class="nb">Clone</span><span class="p">::</span><span class="n">clone</span><span class="p">(</span><span class="o">&amp;</span><span class="bp">self</span><span class="p">.</span><span class="n">run</span><span class="p">),</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
<span class="sd">/// Auto-generated bindings for an instance a component which</span>
<span class="sd">/// implements the world `host`.</span>
<span class="sd">///</span>
<span class="sd">/// This structure can be created through a number of means</span>
<span class="sd">/// depending on your requirements and what you have on hand:</span>
<span class="sd">///</span>
<span class="sd">/// * The most convenient way is to use</span>
<span class="sd">///   [`Host_::instantiate`] which only needs a</span>
<span class="sd">///   [`Store`], [`Component`], and [`Linker`].</span>
<span class="sd">///</span>
<span class="sd">/// * Alternatively you can create a [`Host_Pre`] ahead of</span>
<span class="sd">///   time with a [`Component`] to front-load string lookups</span>
<span class="sd">///   of exports once instead of per-instantiation. This</span>
<span class="sd">///   method then uses [`Host_Pre::instantiate`] to</span>
<span class="sd">///   create a [`Host_`].</span>
<span class="sd">///</span>
<span class="sd">/// * If you've instantiated the instance yourself already</span>
<span class="sd">///   then you can use [`Host_::new`].</span>
<span class="sd">///</span>
<span class="sd">/// * You can also access the guts of instantiation through</span>
<span class="sd">///   [`Host_Indices::new_instance`] followed</span>
<span class="sd">///   by [`Host_Indices::load`] to crate an instance of this</span>
<span class="sd">///   type.</span>
<span class="sd">///</span>
<span class="sd">/// These methods are all equivalent to one another and move</span>
<span class="sd">/// around the tradeoff of what work is performed when.</span>
<span class="sd">///</span>
<span class="sd">/// [`Store`]: wasmtime::Store</span>
<span class="sd">/// [`Component`]: wasmtime::component::Component</span>
<span class="sd">/// [`Linker`]: wasmtime::component::Linker</span>
<span class="k">pub</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">Host_</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">run</span><span class="p">:</span><span class="w"> </span><span class="nc">wasmtime</span><span class="p">::</span><span class="n">component</span><span class="p">::</span><span class="n">Func</span><span class="p">,</span>
<span class="p">}</span>
<span class="k">pub</span><span class="w"> </span><span class="k">trait</span><span class="w"> </span><span class="n">Host_Imports</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">fn</span><span class="w"> </span><span class="nf">print</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="bp">self</span><span class="p">,</span><span class="w"> </span><span class="n">msg</span><span class="p">:</span><span class="w"> </span><span class="nc">wasmtime</span><span class="p">::</span><span class="n">component</span><span class="p">::</span><span class="n">__internal</span><span class="p">::</span><span class="nb">String</span><span class="p">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w"> </span><span class="p">();</span>
<span class="p">}</span>
<span class="k">pub</span><span class="w"> </span><span class="k">trait</span><span class="w"> </span><span class="n">Host_ImportsGetHost</span><span class="o">&lt;</span>
<span class="w">    </span><span class="n">T</span><span class="p">,</span>
<span class="o">&gt;</span><span class="p">:</span><span class="w"> </span><span class="nb">Fn</span><span class="p">(</span><span class="n">T</span><span class="p">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w"> </span><span class="o">&lt;</span><span class="bp">Self</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">Host_ImportsGetHost</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;&gt;</span><span class="p">::</span><span class="n">Host</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nb">Send</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nb">Sync</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nb">Copy</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="o">'</span><span class="nb">static</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">type</span><span class="w"> </span><span class="nc">Host</span><span class="p">:</span><span class="w"> </span><span class="nc">Host_Imports</span><span class="p">;</span>
<span class="p">}</span>
<span class="k">impl</span><span class="o">&lt;</span><span class="n">F</span><span class="p">,</span><span class="w"> </span><span class="n">T</span><span class="p">,</span><span class="w"> </span><span class="n">O</span><span class="o">&gt;</span><span class="w"> </span><span class="n">Host_ImportsGetHost</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">F</span>
<span class="k">where</span>
<span class="w">    </span><span class="n">F</span><span class="p">:</span><span class="w"> </span><span class="nb">Fn</span><span class="p">(</span><span class="n">T</span><span class="p">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w"> </span><span class="nc">O</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nb">Send</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nb">Sync</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nb">Copy</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="o">'</span><span class="nb">static</span><span class="p">,</span>
<span class="w">    </span><span class="n">O</span><span class="p">:</span><span class="w"> </span><span class="nc">Host_Imports</span><span class="p">,</span>
<span class="p">{</span>
<span class="w">    </span><span class="k">type</span><span class="w"> </span><span class="nc">Host</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">O</span><span class="p">;</span>
<span class="p">}</span>
<span class="k">impl</span><span class="o">&lt;</span><span class="n">_T</span><span class="p">:</span><span class="w"> </span><span class="nc">Host_Imports</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="o">?</span><span class="nb">Sized</span><span class="o">&gt;</span><span class="w"> </span><span class="n">Host_Imports</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="n">_T</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">fn</span><span class="w"> </span><span class="nf">print</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="bp">self</span><span class="p">,</span><span class="w"> </span><span class="n">msg</span><span class="p">:</span><span class="w"> </span><span class="nc">wasmtime</span><span class="p">::</span><span class="n">component</span><span class="p">::</span><span class="n">__internal</span><span class="p">::</span><span class="nb">String</span><span class="p">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">Host_Imports</span><span class="p">::</span><span class="n">print</span><span class="p">(</span><span class="o">*</span><span class="bp">self</span><span class="p">,</span><span class="w"> </span><span class="n">msg</span><span class="p">)</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
<span class="k">const</span><span class="w"> </span><span class="n">_</span><span class="p">:</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="cp">#[allow(unused_imports)]</span>
<span class="w">    </span><span class="k">use</span><span class="w"> </span><span class="n">wasmtime</span><span class="p">::</span><span class="n">component</span><span class="p">::</span><span class="n">__internal</span><span class="p">::</span><span class="n">anyhow</span><span class="p">;</span>
<span class="w">    </span><span class="k">impl</span><span class="w"> </span><span class="n">Host_Indices</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="sd">/// Creates a new copy of `Host_Indices` bindings which can then</span>
<span class="w">        </span><span class="sd">/// be used to instantiate into a particular store.</span>
<span class="w">        </span><span class="sd">///</span>
<span class="w">        </span><span class="sd">/// This method may fail if the component does not have the</span>
<span class="w">        </span><span class="sd">/// required exports.</span>
<span class="w">        </span><span class="k">pub</span><span class="w"> </span><span class="k">fn</span><span class="w"> </span><span class="nf">new</span><span class="p">(</span>
<span class="w">            </span><span class="n">component</span><span class="p">:</span><span class="w"> </span><span class="kp">&amp;</span><span class="nc">wasmtime</span><span class="p">::</span><span class="n">component</span><span class="p">::</span><span class="n">Component</span><span class="p">,</span>
<span class="w">        </span><span class="p">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w"> </span><span class="nc">wasmtime</span><span class="p">::</span><span class="nb">Result</span><span class="o">&lt;</span><span class="bp">Self</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="kd">let</span><span class="w"> </span><span class="n">_component</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">component</span><span class="p">;</span>
<span class="w">            </span><span class="kd">let</span><span class="w"> </span><span class="n">run</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">_component</span>
<span class="w">                </span><span class="p">.</span><span class="n">export_index</span><span class="p">(</span><span class="nb">None</span><span class="p">,</span><span class="w"> </span><span class="s">"run"</span><span class="p">)</span>
<span class="w">                </span><span class="p">.</span><span class="n">ok_or_else</span><span class="p">(</span><span class="o">||</span><span class="w"> </span><span class="p">::</span><span class="n">anyhow</span><span class="p">::</span><span class="n">__private</span><span class="p">::</span><span class="n">must_use</span><span class="p">({</span>
<span class="w">                    </span><span class="kd">let</span><span class="w"> </span><span class="n">error</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">::</span><span class="n">anyhow</span><span class="p">::</span><span class="n">__private</span><span class="p">::</span><span class="n">format_err</span><span class="p">(</span>
<span class="w">                        </span><span class="fm">format_args!</span><span class="p">(</span><span class="s">"no function export `run` found"</span><span class="p">),</span>
<span class="w">                    </span><span class="p">);</span>
<span class="w">                    </span><span class="n">error</span>
<span class="w">                </span><span class="p">}))</span><span class="o">?</span>
<span class="w">                </span><span class="p">.</span><span class="mi">1</span><span class="p">;</span>
<span class="w">            </span><span class="nb">Ok</span><span class="p">(</span><span class="n">Host_Indices</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">run</span><span class="w"> </span><span class="p">})</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">        </span><span class="sd">/// Creates a new instance of [`Host_Indices`] from an</span>
<span class="w">        </span><span class="sd">/// instantiated component.</span>
<span class="w">        </span><span class="sd">///</span>
<span class="w">        </span><span class="sd">/// This method of creating a [`Host_`] will perform string</span>
<span class="w">        </span><span class="sd">/// lookups for all exports when this method is called. This</span>
<span class="w">        </span><span class="sd">/// will only succeed if the provided instance matches the</span>
<span class="w">        </span><span class="sd">/// requirements of [`Host_`].</span>
<span class="w">        </span><span class="k">pub</span><span class="w"> </span><span class="k">fn</span><span class="w"> </span><span class="nf">new_instance</span><span class="p">(</span>
<span class="w">            </span><span class="k">mut</span><span class="w"> </span><span class="n">store</span><span class="p">:</span><span class="w"> </span><span class="nc">impl</span><span class="w"> </span><span class="n">wasmtime</span><span class="p">::</span><span class="n">AsContextMut</span><span class="p">,</span>
<span class="w">            </span><span class="n">instance</span><span class="p">:</span><span class="w"> </span><span class="kp">&amp;</span><span class="nc">wasmtime</span><span class="p">::</span><span class="n">component</span><span class="p">::</span><span class="n">Instance</span><span class="p">,</span>
<span class="w">        </span><span class="p">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w"> </span><span class="nc">wasmtime</span><span class="p">::</span><span class="nb">Result</span><span class="o">&lt;</span><span class="bp">Self</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="kd">let</span><span class="w"> </span><span class="n">_instance</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">instance</span><span class="p">;</span>
<span class="w">            </span><span class="kd">let</span><span class="w"> </span><span class="n">run</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">_instance</span>
<span class="w">                </span><span class="p">.</span><span class="n">get_export</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="n">store</span><span class="p">,</span><span class="w"> </span><span class="nb">None</span><span class="p">,</span><span class="w"> </span><span class="s">"run"</span><span class="p">)</span>
<span class="w">                </span><span class="p">.</span><span class="n">ok_or_else</span><span class="p">(</span><span class="o">||</span><span class="w"> </span><span class="p">::</span><span class="n">anyhow</span><span class="p">::</span><span class="n">__private</span><span class="p">::</span><span class="n">must_use</span><span class="p">({</span>
<span class="w">                    </span><span class="kd">let</span><span class="w"> </span><span class="n">error</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">::</span><span class="n">anyhow</span><span class="p">::</span><span class="n">__private</span><span class="p">::</span><span class="n">format_err</span><span class="p">(</span>
<span class="w">                        </span><span class="fm">format_args!</span><span class="p">(</span><span class="s">"no function export `run` found"</span><span class="p">),</span>
<span class="w">                    </span><span class="p">);</span>
<span class="w">                    </span><span class="n">error</span>
<span class="w">                </span><span class="p">}))</span><span class="o">?</span><span class="p">;</span>
<span class="w">            </span><span class="nb">Ok</span><span class="p">(</span><span class="n">Host_Indices</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">run</span><span class="w"> </span><span class="p">})</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">        </span><span class="sd">/// Uses the indices stored in `self` to load an instance</span>
<span class="w">        </span><span class="sd">/// of [`Host_`] from the instance provided.</span>
<span class="w">        </span><span class="sd">///</span>
<span class="w">        </span><span class="sd">/// Note that at this time this method will additionally</span>
<span class="w">        </span><span class="sd">/// perform type-checks of all exports.</span>
<span class="w">        </span><span class="k">pub</span><span class="w"> </span><span class="k">fn</span><span class="w"> </span><span class="nf">load</span><span class="p">(</span>
<span class="w">            </span><span class="o">&amp;</span><span class="bp">self</span><span class="p">,</span>
<span class="w">            </span><span class="k">mut</span><span class="w"> </span><span class="n">store</span><span class="p">:</span><span class="w"> </span><span class="nc">impl</span><span class="w"> </span><span class="n">wasmtime</span><span class="p">::</span><span class="n">AsContextMut</span><span class="p">,</span>
<span class="w">            </span><span class="n">instance</span><span class="p">:</span><span class="w"> </span><span class="kp">&amp;</span><span class="nc">wasmtime</span><span class="p">::</span><span class="n">component</span><span class="p">::</span><span class="n">Instance</span><span class="p">,</span>
<span class="w">        </span><span class="p">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w"> </span><span class="nc">wasmtime</span><span class="p">::</span><span class="nb">Result</span><span class="o">&lt;</span><span class="n">Host_</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="kd">let</span><span class="w"> </span><span class="n">_instance</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">instance</span><span class="p">;</span>
<span class="w">            </span><span class="kd">let</span><span class="w"> </span><span class="n">run</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">*</span><span class="n">_instance</span><span class="p">.</span><span class="n">get_typed_func</span><span class="p">::</span><span class="o">&lt;</span><span class="p">(),</span><span class="w"> </span><span class="p">()</span><span class="o">&gt;</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="n">store</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="bp">self</span><span class="p">.</span><span class="n">run</span><span class="p">)</span><span class="o">?</span><span class="p">.</span><span class="n">func</span><span class="p">();</span>
<span class="w">            </span><span class="nb">Ok</span><span class="p">(</span><span class="n">Host_</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">run</span><span class="w"> </span><span class="p">})</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="k">impl</span><span class="w"> </span><span class="n">Host_</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="sd">/// Convenience wrapper around [`Host_Pre::new`] and</span>
<span class="w">        </span><span class="sd">/// [`Host_Pre::instantiate`].</span>
<span class="w">        </span><span class="k">pub</span><span class="w"> </span><span class="k">fn</span><span class="w"> </span><span class="nf">instantiate</span><span class="o">&lt;</span><span class="n">_T</span><span class="o">&gt;</span><span class="p">(</span>
<span class="w">            </span><span class="k">mut</span><span class="w"> </span><span class="n">store</span><span class="p">:</span><span class="w"> </span><span class="nc">impl</span><span class="w"> </span><span class="n">wasmtime</span><span class="p">::</span><span class="n">AsContextMut</span><span class="o">&lt;</span><span class="n">Data</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">_T</span><span class="o">&gt;</span><span class="p">,</span>
<span class="w">            </span><span class="n">component</span><span class="p">:</span><span class="w"> </span><span class="kp">&amp;</span><span class="nc">wasmtime</span><span class="p">::</span><span class="n">component</span><span class="p">::</span><span class="n">Component</span><span class="p">,</span>
<span class="w">            </span><span class="n">linker</span><span class="p">:</span><span class="w"> </span><span class="kp">&amp;</span><span class="nc">wasmtime</span><span class="p">::</span><span class="n">component</span><span class="p">::</span><span class="n">Linker</span><span class="o">&lt;</span><span class="n">_T</span><span class="o">&gt;</span><span class="p">,</span>
<span class="w">        </span><span class="p">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w"> </span><span class="nc">wasmtime</span><span class="p">::</span><span class="nb">Result</span><span class="o">&lt;</span><span class="n">Host_</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="kd">let</span><span class="w"> </span><span class="n">pre</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">linker</span><span class="p">.</span><span class="n">instantiate_pre</span><span class="p">(</span><span class="n">component</span><span class="p">)</span><span class="o">?</span><span class="p">;</span>
<span class="w">            </span><span class="n">Host_Pre</span><span class="p">::</span><span class="n">new</span><span class="p">(</span><span class="n">pre</span><span class="p">)</span><span class="o">?</span><span class="p">.</span><span class="n">instantiate</span><span class="p">(</span><span class="n">store</span><span class="p">)</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">        </span><span class="sd">/// Convenience wrapper around [`Host_Indices::new_instance`] and</span>
<span class="w">        </span><span class="sd">/// [`Host_Indices::load`].</span>
<span class="w">        </span><span class="k">pub</span><span class="w"> </span><span class="k">fn</span><span class="w"> </span><span class="nf">new</span><span class="p">(</span>
<span class="w">            </span><span class="k">mut</span><span class="w"> </span><span class="n">store</span><span class="p">:</span><span class="w"> </span><span class="nc">impl</span><span class="w"> </span><span class="n">wasmtime</span><span class="p">::</span><span class="n">AsContextMut</span><span class="p">,</span>
<span class="w">            </span><span class="n">instance</span><span class="p">:</span><span class="w"> </span><span class="kp">&amp;</span><span class="nc">wasmtime</span><span class="p">::</span><span class="n">component</span><span class="p">::</span><span class="n">Instance</span><span class="p">,</span>
<span class="w">        </span><span class="p">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w"> </span><span class="nc">wasmtime</span><span class="p">::</span><span class="nb">Result</span><span class="o">&lt;</span><span class="n">Host_</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="kd">let</span><span class="w"> </span><span class="n">indices</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Host_Indices</span><span class="p">::</span><span class="n">new_instance</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="n">store</span><span class="p">,</span><span class="w"> </span><span class="n">instance</span><span class="p">)</span><span class="o">?</span><span class="p">;</span>
<span class="w">            </span><span class="k">in</span>
<span class="p">[</span><span class="n">message</span><span class="w"> </span><span class="n">truncated</span><span class="p">]</span>
</code></pre></div><br>
</p>
</blockquote>



<a name="473362576"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%239315%20bindgen%20macro%3A%20%22Use%20of%20Undeclared%20.../near/473362576" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.239315.20bindgen.20macro.3A.20.22Use.20of.20Undeclared.20.2E.2E.2E.html#473362576">(Sep 28 2024 at 16:20)</a>:</h4>
<p>alexcrichton <a href="https://github.com/bytecodealliance/wasmtime/issues/9315#issuecomment-2380724888">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/9315">issue #9315</a>:</p>
<blockquote>
<p>Fixed in <a href="https://github.com/bytecodealliance/wasmtime/pull/9316">https://github.com/bytecodealliance/wasmtime/pull/9316</a></p>
</blockquote>



<hr><p>Last updated: Jan 20 2025 at 06:04 UTC</p>
</html>