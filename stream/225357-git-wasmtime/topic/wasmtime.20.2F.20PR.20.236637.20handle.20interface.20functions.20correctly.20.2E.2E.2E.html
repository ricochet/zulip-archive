<html>
<head><meta charset="utf-8"><title>wasmtime / PR #6637 handle interface functions correctly ... · git-wasmtime · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/index.html">git-wasmtime</a></h2>
<h3>Topic: <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.236637.20handle.20interface.20functions.20correctly.20.2E.2E.2E.html">wasmtime / PR #6637 handle interface functions correctly ...</a></h3>

<hr>

<base href="https://bytecodealliance.zulipchat.com">

<head><link href="https://bytecodealliance.github.io/zulip-archive/style.css" rel="stylesheet"></head>

<a name="369034419"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%236637%20handle%20interface%20functions%20correctly%20.../near/369034419" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.236637.20handle.20interface.20functions.20correctly.20.2E.2E.2E.html#369034419">(Jun 23 2023 at 22:26)</a>:</h4>
<p>dicej opened <a href="https://github.com/bytecodealliance/wasmtime/pull/6637">PR #6637</a> from <code>dicej:functions_in_instances</code> to <code>bytecodealliance:main</code>:</p>
<blockquote>
<p>Many months ago, I implemented <code>func_new</code>, but only supporting top-level function imports.  If you tried to link a host function under an imported interface, it would mistakenly treat it as a top-level function and either error out if it couldn't find a corresponding type definition in the passed <code>&amp;Component</code>; or, if it found a top-level function that happened to have the same name, it would use that type (which would coincidentally work if the type happens to match, but lead to a runtime error later on otherwise).</p>
<p>This fixes the issue by looking up the correct component instance when necessary and getting the type from there.</p>
<p>Note I've made no effort to optimize for performance here.  Happy to revisit that if there's a need.</p>
<p>&lt;!--<br>
Please make sure you include the following information:</p>
<ul>
<li>
<p>If this work has been discussed elsewhere, please include a link to that<br>
  conversation. If it was discussed in an issue, just mention "issue #...".</p>
</li>
<li>
<p>Explain why this change is needed. If the details are in an issue already,<br>
  this can be brief.</p>
</li>
</ul>
<p>Our development process is documented in the Wasmtime book:<br>
<a href="https://docs.wasmtime.dev/contributing-development-process.html">https://docs.wasmtime.dev/contributing-development-process.html</a></p>
<p>Please ensure all communication follows the code of conduct:<br>
<a href="https://github.com/bytecodealliance/wasmtime/blob/main/CODE_OF_CONDUCT.md">https://github.com/bytecodealliance/wasmtime/blob/main/CODE_OF_CONDUCT.md</a><br>
--&gt;</p>
</blockquote>



<a name="369034421"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%236637%20handle%20interface%20functions%20correctly%20.../near/369034421" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.236637.20handle.20interface.20functions.20correctly.20.2E.2E.2E.html#369034421">(Jun 23 2023 at 22:26)</a>:</h4>
<p><strong>dicej</strong> requested <a href="https://github.com/jameysharp">jameysharp</a> for a review on <a href="https://github.com/bytecodealliance/wasmtime/pull/6637">PR #6637</a>.</p>



<a name="369034422"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%236637%20handle%20interface%20functions%20correctly%20.../near/369034422" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.236637.20handle.20interface.20functions.20correctly.20.2E.2E.2E.html#369034422">(Jun 23 2023 at 22:26)</a>:</h4>
<p><strong>dicej</strong> requested <a href="https://github.com/orgs/bytecodealliance/teams/wasmtime-core-reviewers">wasmtime-core-reviewers</a> for a review on <a href="https://github.com/bytecodealliance/wasmtime/pull/6637">PR #6637</a>.</p>



<a name="369042864"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%236637%20handle%20interface%20functions%20correctly%20.../near/369042864" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.236637.20handle.20interface.20functions.20correctly.20.2E.2E.2E.html#369042864">(Jun 23 2023 at 23:40)</a>:</h4>
<p>jameysharp submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/6637#pullrequestreview-1496155330">PR review</a>:</p>
<blockquote>
<p>I've gone ahead and reviewed this because I want to better understand the component-model implementation, but I want to leave final approval to @alexcrichton.</p>
<p>I think this does what you said it should do <span aria-label="+1" class="emoji emoji-1f44d" role="img" title="+1">:+1:</span>.</p>
<p>That said, I wonder if you can assign sequential integers to instances, somewhat like <code>Strings::intern</code> does for names. Then a <code>Linker</code> would have a single <code>Vec&lt;NameMap&gt;</code> indexed by this sequential instance ID; <code>Definition::Instance</code> would store this index instead of the full map; and a <code>LinkerInstance</code> would store only its instance index instead of a full path.</p>
<p>If that's feasible, I think it's simpler than the reference-counted singly-linked-list. As a nice bonus, it's also asymptotically faster since <code>func_new</code> can find the right map in constant time instead of linear time.</p>
</blockquote>



<a name="369042865"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%236637%20handle%20interface%20functions%20correctly%20.../near/369042865" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.236637.20handle.20interface.20functions.20correctly.20.2E.2E.2E.html#369042865">(Jun 23 2023 at 23:40)</a>:</h4>
<p>jameysharp submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/6637#pullrequestreview-1496155330">PR review</a>:</p>
<blockquote>
<p>I've gone ahead and reviewed this because I want to better understand the component-model implementation, but I want to leave final approval to @alexcrichton.</p>
<p>I think this does what you said it should do <span aria-label="+1" class="emoji emoji-1f44d" role="img" title="+1">:+1:</span>.</p>
<p>That said, I wonder if you can assign sequential integers to instances, somewhat like <code>Strings::intern</code> does for names. Then a <code>Linker</code> would have a single <code>Vec&lt;NameMap&gt;</code> indexed by this sequential instance ID; <code>Definition::Instance</code> would store this index instead of the full map; and a <code>LinkerInstance</code> would store only its instance index instead of a full path.</p>
<p>If that's feasible, I think it's simpler than the reference-counted singly-linked-list. As a nice bonus, it's also asymptotically faster since <code>func_new</code> can find the right map in constant time instead of linear time.</p>
</blockquote>



<a name="369042866"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%236637%20handle%20interface%20functions%20correctly%20.../near/369042866" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.236637.20handle.20interface.20functions.20correctly.20.2E.2E.2E.html#369042866">(Jun 23 2023 at 23:40)</a>:</h4>
<p>jameysharp created <a href="https://github.com/bytecodealliance/wasmtime/pull/6637#discussion_r1240480077">PR review comment</a>:</p>
<blockquote>
<p>Should these uses of <code>name</code> all be the string version of the name, rather than the interned usize?</p>
</blockquote>



<a name="369044356"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%236637%20handle%20interface%20functions%20correctly%20.../near/369044356" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.236637.20handle.20interface.20functions.20correctly.20.2E.2E.2E.html#369044356">(Jun 23 2023 at 23:57)</a>:</h4>
<p>dicej created <a href="https://github.com/bytecodealliance/wasmtime/pull/6637#discussion_r1240526322">PR review comment</a>:</p>
<blockquote>
<p>Yup, good catch.</p>
</blockquote>



<a name="369044491"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%236637%20handle%20interface%20functions%20correctly%20.../near/369044491" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.236637.20handle.20interface.20functions.20correctly.20.2E.2E.2E.html#369044491">(Jun 23 2023 at 23:58)</a>:</h4>
<p>dicej updated <a href="https://github.com/bytecodealliance/wasmtime/pull/6637">PR #6637</a>.</p>



<a name="369045008"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%236637%20handle%20interface%20functions%20correctly%20.../near/369045008" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.236637.20handle.20interface.20functions.20correctly.20.2E.2E.2E.html#369045008">(Jun 24 2023 at 00:03)</a>:</h4>
<p><strong>jameysharp</strong> requested <a href="https://github.com/alexcrichton">alexcrichton</a> for a review on <a href="https://github.com/bytecodealliance/wasmtime/pull/6637">PR #6637</a>.</p>



<a name="369052558"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%236637%20handle%20interface%20functions%20correctly%20.../near/369052558" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.236637.20handle.20interface.20functions.20correctly.20.2E.2E.2E.html#369052558">(Jun 24 2023 at 01:00)</a>:</h4>
<p>alexcrichton submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/6637#pullrequestreview-1496259244">PR review</a>:</p>
<blockquote>
<p>Seems reasonable to me <span aria-label="+1" class="emoji emoji-1f44d" role="img" title="+1">:+1:</span> </p>
<p>I'd be slightly averse though to a custom <code>Rc</code>-based linked list, so I'd lean more towards something <code>Vec</code> like such as this (feel free to take it or leave it though)</p>
<p>&lt;details&gt;</p>
<div class="codehilite" data-code-language="Diff"><pre><span></span><code><span class="gh">diff --git a/crates/wasmtime/src/component/linker.rs b/crates/wasmtime/src/component/linker.rs</span>
<span class="gh">index 6665eccf7..db8daa89d 100644</span>
<span class="gd">--- a/crates/wasmtime/src/component/linker.rs</span>
<span class="gi">+++ b/crates/wasmtime/src/component/linker.rs</span>
<span class="gu">@@ -10,7 +10,6 @@ use std::future::Future;</span>
<span class="w"> </span>use std::marker;
<span class="w"> </span>use std::ops::Deref;
<span class="w"> </span>use std::pin::Pin;
<span class="gd">-use std::rc::Rc;</span>
<span class="w"> </span>use std::sync::Arc;
<span class="w"> </span>use wasmtime_environ::component::TypeDef;
<span class="w"> </span>use wasmtime_environ::PrimaryMap;
<span class="gu">@@ -25,6 +24,7 @@ pub struct Linker&lt;T&gt; {</span>
<span class="w"> </span>    engine: Engine,
<span class="w"> </span>    strings: Strings,
<span class="w"> </span>    map: NameMap,
<span class="gi">+    path: Vec&lt;usize&gt;,</span>
<span class="w"> </span>    allow_shadowing: bool,
<span class="w"> </span>    _marker: marker::PhantomData&lt;fn() -&gt; T&gt;,
<span class="w"> </span>}
<span class="gu">@@ -35,25 +35,15 @@ pub struct Strings {</span>
<span class="w"> </span>    strings: Vec&lt;Arc&lt;str&gt;&gt;,
<span class="w"> </span>}

<span class="gd">-struct PathCell {</span>
<span class="gd">-    name: usize,</span>
<span class="gd">-    next: Path,</span>
<span class="gd">-}</span>
<span class="gd">-</span>
<span class="gd">-#[derive(Clone)]</span>
<span class="gd">-enum Path {</span>
<span class="gd">-    Nil,</span>
<span class="gd">-    Cell(Rc&lt;PathCell&gt;),</span>
<span class="gd">-}</span>
<span class="gd">-</span>
<span class="w"> </span>/// Structure representing an "instance" being defined within a linker.
<span class="w"> </span>///
<span class="w"> </span>/// Instances do not need to be actual [`Instance`]s and instead are defined by
<span class="w"> </span>/// a "bag of named items", so each [`LinkerInstance`] can further define items
<span class="w"> </span>/// internally.
<span class="w"> </span>pub struct LinkerInstance&lt;'a, T&gt; {
<span class="gd">-    engine: Engine,</span>
<span class="gd">-    path: Path,</span>
<span class="gi">+    engine: &amp;'a Engine,</span>
<span class="gi">+    path: &amp;'a mut Vec&lt;usize&gt;,</span>
<span class="gi">+    path_len: usize,</span>
<span class="w"> </span>    strings: &amp;'a mut Strings,
<span class="w"> </span>    map: &amp;'a mut NameMap,
<span class="w"> </span>    allow_shadowing: bool,
<span class="gu">@@ -78,6 +68,7 @@ impl&lt;T&gt; Linker&lt;T&gt; {</span>
<span class="w"> </span>            strings: Strings::default(),
<span class="w"> </span>            map: NameMap::default(),
<span class="w"> </span>            allow_shadowing: false,
<span class="gi">+            path: Vec::new(),</span>
<span class="w"> </span>            _marker: marker::PhantomData,
<span class="w"> </span>        }
<span class="w"> </span>    }
<span class="gu">@@ -100,8 +91,9 @@ impl&lt;T&gt; Linker&lt;T&gt; {</span>
<span class="w"> </span>    /// the root namespace.
<span class="w"> </span>    pub fn root(&amp;mut self) -&gt; LinkerInstance&lt;'_, T&gt; {
<span class="w"> </span>        LinkerInstance {
<span class="gd">-            engine: self.engine.clone(),</span>
<span class="gd">-            path: Path::Nil,</span>
<span class="gi">+            engine: &amp;self.engine,</span>
<span class="gi">+            path: &amp;mut self.path,</span>
<span class="gi">+            path_len: 0,</span>
<span class="w"> </span>            strings: &amp;mut self.strings,
<span class="w"> </span>            map: &amp;mut self.map,
<span class="w"> </span>            allow_shadowing: self.allow_shadowing,
<span class="gu">@@ -246,8 +238,9 @@ impl&lt;T&gt; Linker&lt;T&gt; {</span>
<span class="w"> </span>impl&lt;T&gt; LinkerInstance&lt;'_, T&gt; {
<span class="w"> </span>    fn as_mut(&amp;mut self) -&gt; LinkerInstance&lt;'_, T&gt; {
<span class="w"> </span>        LinkerInstance {
<span class="gd">-            engine: self.engine.clone(),</span>
<span class="gd">-            path: self.path.clone(),</span>
<span class="gi">+            engine: self.engine,</span>
<span class="gi">+            path: self.path,</span>
<span class="gi">+            path_len: self.path_len,</span>
<span class="w"> </span>            strings: self.strings,
<span class="w"> </span>            map: self.map,
<span class="w"> </span>            allow_shadowing: self.allow_shadowing,
<span class="gu">@@ -327,13 +320,6 @@ impl&lt;T&gt; LinkerInstance&lt;'_, T&gt; {</span>
<span class="w"> </span>        name: &amp;str,
<span class="w"> </span>        func: F,
<span class="w"> </span>    ) -&gt; Result&lt;()&gt; {
<span class="gd">-        let mut names = Vec::new();</span>
<span class="gd">-        let mut path = &amp;self.path;</span>
<span class="gd">-        while let Path::Cell(cell) = path {</span>
<span class="gd">-            names.push(cell.name);</span>
<span class="gd">-            path = &amp;cell.next;</span>
<span class="gd">-        }</span>
<span class="gd">-</span>
<span class="w"> </span>        let mut map = &amp;component
<span class="w"> </span>            .env_component()
<span class="w"> </span>            .import_types
<span class="gu">@@ -341,7 +327,7 @@ impl&lt;T&gt; LinkerInstance&lt;'_, T&gt; {</span>
<span class="w"> </span>            .map(|(k, v)| (k.clone(), *v))
<span class="w"> </span>            .collect::&lt;IndexMap&lt;_, _&gt;&gt;();

<span class="gd">-        while let Some(name) = names.pop() {</span>
<span class="gi">+        for name in self.path.iter().copied().take(self.path_len) {</span>
<span class="w"> </span>            let name = self.strings.strings[name].deref();
<span class="w"> </span>            if let Some(ty) = map.get(name) {
<span class="w"> </span>                if let TypeDef::ComponentInstance(index) = ty {
<span class="gu">@@ -409,10 +395,8 @@ impl&lt;T&gt; LinkerInstance&lt;'_, T&gt; {</span>
<span class="w"> </span>            Definition::Instance(map) =&gt; map,
<span class="w"> </span>            _ =&gt; unreachable!(),
<span class="w"> </span>        };
<span class="gd">-        self.path = Path::Cell(Rc::new(PathCell {</span>
<span class="gd">-            name,</span>
<span class="gd">-            next: self.path,</span>
<span class="gd">-        }));</span>
<span class="gi">+        self.path.truncate(self.path_len);</span>
<span class="gi">+        self.path.push(name);</span>
<span class="w"> </span>        Ok(self)
<span class="w"> </span>    }
</code></pre></div>
<p>&lt;/details&gt;</p>
</blockquote>



<a name="369062749"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%236637%20handle%20interface%20functions%20correctly%20.../near/369062749" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.236637.20handle.20interface.20functions.20correctly.20.2E.2E.2E.html#369062749">(Jun 24 2023 at 02:32)</a>:</h4>
<p>dicej updated <a href="https://github.com/bytecodealliance/wasmtime/pull/6637">PR #6637</a>.</p>



<a name="372731805"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%236637%20handle%20interface%20functions%20correctly%20.../near/372731805" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.236637.20handle.20interface.20functions.20correctly.20.2E.2E.2E.html#372731805">(Jul 05 2023 at 23:35)</a>:</h4>
<p>alexcrichton merged <a href="https://github.com/bytecodealliance/wasmtime/pull/6637">PR #6637</a>.</p>



<hr><p>Last updated: Jan 20 2025 at 06:04 UTC</p>
</html>