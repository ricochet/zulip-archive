<html>
<head><meta charset="utf-8"><title>wasmtime / PR #5624 Add support for WASI sockets to C API · git-wasmtime · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/index.html">git-wasmtime</a></h2>
<h3>Topic: <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.235624.20Add.20support.20for.20WASI.20sockets.20to.20C.20API.html">wasmtime / PR #5624 Add support for WASI sockets to C API</a></h3>

<hr>

<base href="https://bytecodealliance.zulipchat.com">

<head><link href="https://bytecodealliance.github.io/zulip-archive/style.css" rel="stylesheet"></head>

<a name="323130528"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%235624%20Add%20support%20for%20WASI%20sockets%20to%20C%20API/near/323130528" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.235624.20Add.20support.20for.20WASI.20sockets.20to.20C.20API.html#323130528">(Jan 23 2023 at 22:30)</a>:</h4>
<p>font opened <a href="https://github.com/bytecodealliance/wasmtime/pull/5624">PR #5624</a> from <code>sockets-c-api</code> to <code>main</code>:</p>
<blockquote>
<p>This adds support for WASI sockets to the C API by adding a new API to handle preopening sockets for clients. This uses <code>HashMap</code> instead of <code>Vec</code> for preopened sockets to identify if the caller has called in more than once with the same FD number. If so, then we return false so caller is at least given a hint that they may be misusing the API e.g. attempting to overwrite an already existing socket FD.</p>
<p>I stuck with the same <code>bool</code> return value because it was already being done for the other APIs e.g. <code>wasi_config_preopen_dir</code>. I think it would be beneficial to have a more specific error type, if possible, but not something to address in this PR.</p>
<p>I don't think there are any tests for these APIs so none were added. Of course I was personally testing this with the <code>crun</code> container runtime that is using these APIs.</p>
<p>I don't know who could review this so any help identifying the right people would be greatly appreciated!</p>
<p>Fixes #5071</p>
<p>&lt;!--</p>
<p>Please ensure that the following steps are all taken care of before submitting<br>
the PR.</p>
<ul>
<li>
<p>[ ] This has been discussed in issue #..., or if not, please tell us why<br>
  here.</p>
</li>
<li>
<p>[ ] A short description of what this does, why it is needed; if the<br>
  description becomes long, the matter should probably be discussed in an issue<br>
  first.</p>
</li>
<li>
<p>[ ] This PR contains test cases, if meaningful.</p>
</li>
<li>[ ] A reviewer from the core maintainer team has been assigned for this PR.<br>
  If you don't know who could review this, please indicate so. The list of<br>
  suggested reviewers on the right can help you.</li>
</ul>
<p>Please ensure all communication adheres to the <a href="https://github.com/bytecodealliance/wasmtime/blob/master/CODE_OF_CONDUCT.md">code of
conduct</a>.<br>
--&gt;<br>
</p>
</blockquote>



<a name="323356369"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%235624%20Add%20support%20for%20WASI%20sockets%20to%20C%20API/near/323356369" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.235624.20Add.20support.20for.20WASI.20sockets.20to.20C.20API.html#323356369">(Jan 24 2023 at 21:23)</a>:</h4>
<p>font updated <a href="https://github.com/bytecodealliance/wasmtime/pull/5624">PR #5624</a> from <code>sockets-c-api</code> to <code>main</code>.</p>



<a name="324166352"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%235624%20Add%20support%20for%20WASI%20sockets%20to%20C%20API/near/324166352" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.235624.20Add.20support.20for.20WASI.20sockets.20to.20C.20API.html#324166352">(Jan 27 2023 at 22:30)</a>:</h4>
<p>peterhuene submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/5624#pullrequestreview-1273528037">PR review</a>.</p>



<a name="324166353"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%235624%20Add%20support%20for%20WASI%20sockets%20to%20C%20API/near/324166353" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.235624.20Add.20support.20for.20WASI.20sockets.20to.20C.20API.html#324166353">(Jan 27 2023 at 22:30)</a>:</h4>
<p>peterhuene submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/5624#pullrequestreview-1273528037">PR review</a>.</p>



<a name="324166354"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%235624%20Add%20support%20for%20WASI%20sockets%20to%20C%20API/near/324166354" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.235624.20Add.20support.20for.20WASI.20sockets.20to.20C.20API.html#324166354">(Jan 27 2023 at 22:30)</a>:</h4>
<p>peterhuene created <a href="https://github.com/bytecodealliance/wasmtime/pull/5624#discussion_r1089464857">PR review comment</a>:</p>
<blockquote>
<p><div class="codehilite" data-code-language="suggestion"><pre><span></span><code> * "127.0.0.1:8080") requested to listen on.
</code></pre></div><br>
</p>
</blockquote>



<a name="324166356"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%235624%20Add%20support%20for%20WASI%20sockets%20to%20C%20API/near/324166356" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.235624.20Add.20support.20for.20WASI.20sockets.20to.20C.20API.html#324166356">(Jan 27 2023 at 22:30)</a>:</h4>
<p>peterhuene created <a href="https://github.com/bytecodealliance/wasmtime/pull/5624#discussion_r1089464553">PR review comment</a>:</p>
<blockquote>
<p><div class="codehilite" data-code-language="suggestion"><pre><span></span><code> * \brief Configures a "preopened" listen socket to be available to WASI APIs.
</code></pre></div><br>
</p>
</blockquote>



<a name="324166357"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%235624%20Add%20support%20for%20WASI%20sockets%20to%20C%20API/near/324166357" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.235624.20Add.20support.20for.20WASI.20sockets.20to.20C.20API.html#324166357">(Jan 27 2023 at 22:30)</a>:</h4>
<p>peterhuene created <a href="https://github.com/bytecodealliance/wasmtime/pull/5624#discussion_r1089465944">PR review comment</a>:</p>
<blockquote>
<p>Cast seems unnecessary?</p>
<p><div class="codehilite" data-code-language="suggestion"><pre><span></span><code>            builder = builder.preopened_socket(fd_num, listener)?;
</code></pre></div><br>
</p>
</blockquote>



<a name="324166359"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%235624%20Add%20support%20for%20WASI%20sockets%20to%20C%20API/near/324166359" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.235624.20Add.20support.20for.20WASI.20sockets.20to.20C.20API.html#324166359">(Jan 27 2023 at 22:30)</a>:</h4>
<p>peterhuene created <a href="https://github.com/bytecodealliance/wasmtime/pull/5624#discussion_r1089471228">PR review comment</a>:</p>
<blockquote>
<p>I think this might be better represented with:</p>
<div class="codehilite" data-code-language="suggestion"><pre><span></span><code>unsafe fn cstr_to_str&lt;'a&gt;(s: *const c_char) -&gt; Option&lt;&amp;'a str&gt; {
    CStr::from_ptr(s).to_str().ok()
}
</code></pre></div>
<p>Which we can then also call from <code>cstr_to_path</code>.</p>
</blockquote>



<a name="324166361"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%235624%20Add%20support%20for%20WASI%20sockets%20to%20C%20API/near/324166361" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.235624.20Add.20support.20for.20WASI.20sockets.20to.20C.20API.html#324166361">(Jan 27 2023 at 22:30)</a>:</h4>
<p>peterhuene created <a href="https://github.com/bytecodealliance/wasmtime/pull/5624#discussion_r1089474086">PR review comment</a>:</p>
<blockquote>
<p><div class="codehilite" data-code-language="suggestion"><pre><span></span><code>    host_port: *const c_char,
</code></pre></div><br>
</p>
</blockquote>



<a name="324166362"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%235624%20Add%20support%20for%20WASI%20sockets%20to%20C%20API/near/324166362" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.235624.20Add.20support.20for.20WASI.20sockets.20to.20C.20API.html#324166362">(Jan 27 2023 at 22:30)</a>:</h4>
<p>peterhuene created <a href="https://github.com/bytecodealliance/wasmtime/pull/5624#discussion_r1089474469">PR review comment</a>:</p>
<blockquote>
<p>Nit: we don't need to call it <code>stdlistener</code> as we're directly using the <code>wasmtime_wasi::TcpListener</code> type.</p>
<p>Perhaps simply <code>listener</code> would be a better name to use here?</p>
</blockquote>



<a name="324166364"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%235624%20Add%20support%20for%20WASI%20sockets%20to%20C%20API/near/324166364" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.235624.20Add.20support.20for.20WASI.20sockets.20to.20C.20API.html#324166364">(Jan 27 2023 at 22:30)</a>:</h4>
<p>peterhuene created <a href="https://github.com/bytecodealliance/wasmtime/pull/5624#discussion_r1089474117">PR review comment</a>:</p>
<blockquote>
<p>If we change to <code>cstr_to_str</code> above:</p>
<p><div class="codehilite" data-code-language="suggestion"><pre><span></span><code>    let address = match cstr_to_str(host_port) {
        Some(s) =&gt; s,
        None =&gt; return false,
    };
</code></pre></div><br>
</p>
</blockquote>



<a name="325531845"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%235624%20Add%20support%20for%20WASI%20sockets%20to%20C%20API/near/325531845" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.235624.20Add.20support.20for.20WASI.20sockets.20to.20C.20API.html#325531845">(Feb 03 2023 at 01:40)</a>:</h4>
<p>font updated <a href="https://github.com/bytecodealliance/wasmtime/pull/5624">PR #5624</a> from <code>sockets-c-api</code> to <code>main</code>.</p>



<a name="325532314"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%235624%20Add%20support%20for%20WASI%20sockets%20to%20C%20API/near/325532314" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.235624.20Add.20support.20for.20WASI.20sockets.20to.20C.20API.html#325532314">(Feb 03 2023 at 01:46)</a>:</h4>
<p>font updated <a href="https://github.com/bytecodealliance/wasmtime/pull/5624">PR #5624</a> from <code>sockets-c-api</code> to <code>main</code>.</p>



<a name="325533967"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%235624%20Add%20support%20for%20WASI%20sockets%20to%20C%20API/near/325533967" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.235624.20Add.20support.20for.20WASI.20sockets.20to.20C.20API.html#325533967">(Feb 03 2023 at 02:03)</a>:</h4>
<p>font submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/5624#pullrequestreview-1282150197">PR review</a>.</p>



<a name="325533968"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%235624%20Add%20support%20for%20WASI%20sockets%20to%20C%20API/near/325533968" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.235624.20Add.20support.20for.20WASI.20sockets.20to.20C.20API.html#325533968">(Feb 03 2023 at 02:03)</a>:</h4>
<p>font submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/5624#pullrequestreview-1282150197">PR review</a>.</p>



<a name="325533969"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%235624%20Add%20support%20for%20WASI%20sockets%20to%20C%20API/near/325533969" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.235624.20Add.20support.20for.20WASI.20sockets.20to.20C.20API.html#325533969">(Feb 03 2023 at 02:03)</a>:</h4>
<p>font created <a href="https://github.com/bytecodealliance/wasmtime/pull/5624#discussion_r1095262134">PR review comment</a>:</p>
<blockquote>
<p>Ah yes, thanks! Left over from using a different type previously.</p>
</blockquote>



<a name="326938626"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%235624%20Add%20support%20for%20WASI%20sockets%20to%20C%20API/near/326938626" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.235624.20Add.20support.20for.20WASI.20sockets.20to.20C.20API.html#326938626">(Feb 09 2023 at 23:55)</a>:</h4>
<p>peterhuene submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/5624#pullrequestreview-1292200640">PR review</a>.</p>



<a name="326938729"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%235624%20Add%20support%20for%20WASI%20sockets%20to%20C%20API/near/326938729" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.235624.20Add.20support.20for.20WASI.20sockets.20to.20C.20API.html#326938729">(Feb 09 2023 at 23:56)</a>:</h4>
<p>peterhuene has enabled auto merge for <a href="https://github.com/bytecodealliance/wasmtime/pull/5624">PR #5624</a>.</p>



<a name="326941349"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%235624%20Add%20support%20for%20WASI%20sockets%20to%20C%20API/near/326941349" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.235624.20Add.20support.20for.20WASI.20sockets.20to.20C.20API.html#326941349">(Feb 10 2023 at 00:22)</a>:</h4>
<p>peterhuene merged <a href="https://github.com/bytecodealliance/wasmtime/pull/5624">PR #5624</a>.</p>



<hr><p>Last updated: Jan 20 2025 at 06:04 UTC</p>
</html>