<html>
<head><meta charset="utf-8"><title>wasmtime / issue #4170 Cranelift: pinned_reg does not wor... · git-wasmtime · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/index.html">git-wasmtime</a></h2>
<h3>Topic: <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.234170.20Cranelift.3A.20pinned_reg.20does.20not.20wor.2E.2E.2E.html">wasmtime / issue #4170 Cranelift: pinned_reg does not wor...</a></h3>

<hr>

<base href="https://bytecodealliance.zulipchat.com">

<head><link href="https://bytecodealliance.github.io/zulip-archive/style.css" rel="stylesheet"></head>

<a name="283060296"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%234170%20Cranelift%3A%20pinned_reg%20does%20not%20wor.../near/283060296" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.234170.20Cranelift.3A.20pinned_reg.20does.20not.20wor.2E.2E.2E.html#283060296">(May 20 2022 at 12:16)</a>:</h4>
<p>pepyakin opened <a href="https://github.com/bytecodealliance/wasmtime/issues/4170">issue #4170</a>:</p>
<blockquote>
<h3><code>.clif</code> Test Case</h3>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="n">function</span><span class="w"> </span><span class="n">u0</span>:<span class="mi">0</span><span class="p">(</span><span class="kt">i64</span><span class="w"> </span><span class="n">vmctx</span><span class="p">,</span><span class="w"> </span><span class="kt">i64</span><span class="p">)</span><span class="w"> </span><span class="n">wasmtime_system_v</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">gv0</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">vmctx</span><span class="w"></span>
<span class="w">    </span><span class="n">gv1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">load</span><span class="p">.</span><span class="kt">i64</span><span class="w"> </span><span class="n">notrap</span><span class="w"> </span><span class="n">aligned</span><span class="w"> </span><span class="n">readonly</span><span class="w"> </span><span class="n">gv0</span><span class="w"></span>
<span class="w">    </span><span class="n">gv2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">load</span><span class="p">.</span><span class="kt">i64</span><span class="w"> </span><span class="n">notrap</span><span class="w"> </span><span class="n">aligned</span><span class="w"> </span><span class="n">gv1</span><span class="w"></span>
<span class="w">    </span><span class="n">gv3</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">vmctx</span><span class="w"></span>
<span class="w">    </span><span class="n">stack_limit</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">gv2</span><span class="w"></span>

<span class="w">    </span><span class="n">block0</span><span class="p">(</span><span class="n">v0</span>: <span class="kt">i64</span><span class="p">,</span><span class="w"> </span><span class="n">v1</span>: <span class="kt">i64</span><span class="p">)</span>:
        <span class="nc">v2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">global_value</span><span class="p">.</span><span class="kt">i64</span><span class="w"> </span><span class="n">gv3</span><span class="w"></span>
<span class="w">        </span><span class="n">v3</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">load</span><span class="p">.</span><span class="kt">i64</span><span class="w"> </span><span class="n">notrap</span><span class="w"> </span><span class="n">aligned</span><span class="w"> </span><span class="n">v2</span><span class="w"></span>
<span class="w">        </span><span class="n">v4</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">get_pinned_reg</span><span class="p">.</span><span class="kt">i64</span><span class="w"></span>
<span class="w">        </span><span class="n">v5</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">iadd_imm</span><span class="w"> </span><span class="n">v4</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="w"></span>
<span class="w">        </span><span class="n">set_pinned_reg</span><span class="w"> </span><span class="n">v5</span><span class="w"></span>
<span class="w">        </span><span class="n">jump</span><span class="w"> </span><span class="n">block1</span><span class="w"></span>

<span class="w">    </span><span class="n">block1</span>:
        <span class="nc">return</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>
<h3>Steps to Reproduce</h3>
<div class="codehilite" data-code-language="Bash"><pre><span></span><code>$ clif-util compile -D --target x86_64 pinned_reg.clif --set enable_pinned_reg
.byte <span class="m">85</span>, <span class="m">72</span>, <span class="m">137</span>, <span class="m">229</span>, <span class="m">72</span>, <span class="m">131</span>, <span class="m">236</span>, <span class="m">16</span>, <span class="m">76</span>, <span class="m">137</span>, <span class="m">60</span>, <span class="m">36</span>, <span class="m">76</span>, <span class="m">139</span>, <span class="m">15</span>, <span class="m">73</span>, <span class="m">131</span>, <span class="m">199</span>, <span class="m">1</span>, <span class="m">76</span>, <span class="m">139</span>, <span class="m">60</span>, <span class="m">36</span>, <span class="m">72</span>, <span class="m">131</span>, <span class="m">196</span>, <span class="m">16</span>, <span class="m">72</span>, <span class="m">137</span>, <span class="m">236</span>, <span class="m">93</span>, <span class="m">195</span>

Disassembly of <span class="m">32</span> bytes:
   <span class="m">0</span>:   <span class="m">55</span>                      push    rbp
   <span class="m">1</span>:   <span class="m">48</span> <span class="m">89</span> e5                mov     rbp, rsp
   <span class="m">4</span>:   <span class="m">48</span> <span class="m">83</span> ec <span class="m">10</span>             sub     rsp, 0x10
   <span class="m">8</span>:   4c <span class="m">89</span> 3c <span class="m">24</span>             mov     qword ptr <span class="o">[</span>rsp<span class="o">]</span>, r15
   c:   4c 8b 0f                mov     r9, qword ptr <span class="o">[</span>rdi<span class="o">]</span>
   f:   <span class="m">49</span> <span class="m">83</span> c7 <span class="m">01</span>             add     r15, <span class="m">1</span>
  <span class="m">13</span>:   4c 8b 3c <span class="m">24</span>             mov     r15, qword ptr <span class="o">[</span>rsp<span class="o">]</span>
  <span class="m">17</span>:   <span class="m">48</span> <span class="m">83</span> c4 <span class="m">10</span>             add     rsp, 0x10
  1b:   <span class="m">48</span> <span class="m">89</span> ec                mov     rsp, rbp
  1e:   5d                      pop     rbp
  1f:   c3                      ret
</code></pre></div>
<h3>Expected Results</h3>
<p><code>get_pinned_reg</code> and <code>set_pinned_reg</code> either work in this situation or at least the verifier rejects the code.</p>
<h3>Actual Results</h3>
<p>r15, the pinned register, gets saved and restored as a CSR making it impossible to use as a pinned register.</p>
<h3>Versions and Environment</h3>
<p>Cranelift version or commit: f19d8cc85</p>
<h3>Extra Info</h3>
<p>Found this while hacking on <a href="https://github.com/bytecodealliance/wasmtime/issues/4109#issuecomment-1130527740">https://github.com/bytecodealliance/wasmtime/issues/4109#issuecomment-1130527740</a>. I've worked around it by setting this predicate in <code>gen_clobber_restore</code>.</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="n">call_conv</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">isa</span>::<span class="n">CallConv</span>::<span class="n">WasmtimeSystemV</span><span class="w"></span>
<span class="w">                </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">flags</span><span class="p">.</span><span class="n">enable_pinned_reg</span><span class="p">()</span><span class="w"></span>
<span class="w">                </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">reg</span><span class="p">.</span><span class="n">to_reg</span><span class="p">()</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">regs</span>::<span class="n">r15</span><span class="p">().</span><span class="n">to_real_reg</span><span class="p">().</span><span class="n">unwrap</span><span class="p">()</span><span class="w"></span>
<span class="w">            </span><span class="p">{</span><span class="w"></span>
<span class="w">                </span><span class="c1">// HACK: don't restore r15 if pinned_reg enabled.</span>
<span class="w">                </span><span class="c1">// continue;</span>
<span class="w">            </span><span class="p">}</span><span class="w"></span>
</code></pre></div>
<p>I am pretty sure that this is also the case for the aarch64 backend.</p>
<p>cc @cfallin </p>
</blockquote>



<a name="283060297"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%234170%20Cranelift%3A%20pinned_reg%20does%20not%20wor.../near/283060297" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.234170.20Cranelift.3A.20pinned_reg.20does.20not.20wor.2E.2E.2E.html#283060297">(May 20 2022 at 12:16)</a>:</h4>
<p>pepyakin labeled <a href="https://github.com/bytecodealliance/wasmtime/issues/4170">issue #4170</a>:</p>
<blockquote>
<h3><code>.clif</code> Test Case</h3>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="n">function</span><span class="w"> </span><span class="n">u0</span>:<span class="mi">0</span><span class="p">(</span><span class="kt">i64</span><span class="w"> </span><span class="n">vmctx</span><span class="p">,</span><span class="w"> </span><span class="kt">i64</span><span class="p">)</span><span class="w"> </span><span class="n">wasmtime_system_v</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">gv0</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">vmctx</span><span class="w"></span>
<span class="w">    </span><span class="n">gv1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">load</span><span class="p">.</span><span class="kt">i64</span><span class="w"> </span><span class="n">notrap</span><span class="w"> </span><span class="n">aligned</span><span class="w"> </span><span class="n">readonly</span><span class="w"> </span><span class="n">gv0</span><span class="w"></span>
<span class="w">    </span><span class="n">gv2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">load</span><span class="p">.</span><span class="kt">i64</span><span class="w"> </span><span class="n">notrap</span><span class="w"> </span><span class="n">aligned</span><span class="w"> </span><span class="n">gv1</span><span class="w"></span>
<span class="w">    </span><span class="n">gv3</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">vmctx</span><span class="w"></span>
<span class="w">    </span><span class="n">stack_limit</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">gv2</span><span class="w"></span>

<span class="w">    </span><span class="n">block0</span><span class="p">(</span><span class="n">v0</span>: <span class="kt">i64</span><span class="p">,</span><span class="w"> </span><span class="n">v1</span>: <span class="kt">i64</span><span class="p">)</span>:
        <span class="nc">v2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">global_value</span><span class="p">.</span><span class="kt">i64</span><span class="w"> </span><span class="n">gv3</span><span class="w"></span>
<span class="w">        </span><span class="n">v3</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">load</span><span class="p">.</span><span class="kt">i64</span><span class="w"> </span><span class="n">notrap</span><span class="w"> </span><span class="n">aligned</span><span class="w"> </span><span class="n">v2</span><span class="w"></span>
<span class="w">        </span><span class="n">v4</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">get_pinned_reg</span><span class="p">.</span><span class="kt">i64</span><span class="w"></span>
<span class="w">        </span><span class="n">v5</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">iadd_imm</span><span class="w"> </span><span class="n">v4</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="w"></span>
<span class="w">        </span><span class="n">set_pinned_reg</span><span class="w"> </span><span class="n">v5</span><span class="w"></span>
<span class="w">        </span><span class="n">jump</span><span class="w"> </span><span class="n">block1</span><span class="w"></span>

<span class="w">    </span><span class="n">block1</span>:
        <span class="nc">return</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>
<h3>Steps to Reproduce</h3>
<div class="codehilite" data-code-language="Bash"><pre><span></span><code>$ clif-util compile -D --target x86_64 pinned_reg.clif --set enable_pinned_reg
.byte <span class="m">85</span>, <span class="m">72</span>, <span class="m">137</span>, <span class="m">229</span>, <span class="m">72</span>, <span class="m">131</span>, <span class="m">236</span>, <span class="m">16</span>, <span class="m">76</span>, <span class="m">137</span>, <span class="m">60</span>, <span class="m">36</span>, <span class="m">76</span>, <span class="m">139</span>, <span class="m">15</span>, <span class="m">73</span>, <span class="m">131</span>, <span class="m">199</span>, <span class="m">1</span>, <span class="m">76</span>, <span class="m">139</span>, <span class="m">60</span>, <span class="m">36</span>, <span class="m">72</span>, <span class="m">131</span>, <span class="m">196</span>, <span class="m">16</span>, <span class="m">72</span>, <span class="m">137</span>, <span class="m">236</span>, <span class="m">93</span>, <span class="m">195</span>

Disassembly of <span class="m">32</span> bytes:
   <span class="m">0</span>:   <span class="m">55</span>                      push    rbp
   <span class="m">1</span>:   <span class="m">48</span> <span class="m">89</span> e5                mov     rbp, rsp
   <span class="m">4</span>:   <span class="m">48</span> <span class="m">83</span> ec <span class="m">10</span>             sub     rsp, 0x10
   <span class="m">8</span>:   4c <span class="m">89</span> 3c <span class="m">24</span>             mov     qword ptr <span class="o">[</span>rsp<span class="o">]</span>, r15
   c:   4c 8b 0f                mov     r9, qword ptr <span class="o">[</span>rdi<span class="o">]</span>
   f:   <span class="m">49</span> <span class="m">83</span> c7 <span class="m">01</span>             add     r15, <span class="m">1</span>
  <span class="m">13</span>:   4c 8b 3c <span class="m">24</span>             mov     r15, qword ptr <span class="o">[</span>rsp<span class="o">]</span>
  <span class="m">17</span>:   <span class="m">48</span> <span class="m">83</span> c4 <span class="m">10</span>             add     rsp, 0x10
  1b:   <span class="m">48</span> <span class="m">89</span> ec                mov     rsp, rbp
  1e:   5d                      pop     rbp
  1f:   c3                      ret
</code></pre></div>
<h3>Expected Results</h3>
<p><code>get_pinned_reg</code> and <code>set_pinned_reg</code> either work in this situation or at least the verifier rejects the code.</p>
<h3>Actual Results</h3>
<p>r15, the pinned register, gets saved and restored as a CSR making it impossible to use as a pinned register.</p>
<h3>Versions and Environment</h3>
<p>Cranelift version or commit: f19d8cc85</p>
<h3>Extra Info</h3>
<p>Found this while hacking on <a href="https://github.com/bytecodealliance/wasmtime/issues/4109#issuecomment-1130527740">https://github.com/bytecodealliance/wasmtime/issues/4109#issuecomment-1130527740</a>. I've worked around it by setting this predicate in <code>gen_clobber_restore</code>.</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="n">call_conv</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">isa</span>::<span class="n">CallConv</span>::<span class="n">WasmtimeSystemV</span><span class="w"></span>
<span class="w">                </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">flags</span><span class="p">.</span><span class="n">enable_pinned_reg</span><span class="p">()</span><span class="w"></span>
<span class="w">                </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">reg</span><span class="p">.</span><span class="n">to_reg</span><span class="p">()</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">regs</span>::<span class="n">r15</span><span class="p">().</span><span class="n">to_real_reg</span><span class="p">().</span><span class="n">unwrap</span><span class="p">()</span><span class="w"></span>
<span class="w">            </span><span class="p">{</span><span class="w"></span>
<span class="w">                </span><span class="c1">// HACK: don't restore r15 if pinned_reg enabled.</span>
<span class="w">                </span><span class="c1">// continue;</span>
<span class="w">            </span><span class="p">}</span><span class="w"></span>
</code></pre></div>
<p>I am pretty sure that this is also the case for the aarch64 backend.</p>
<p>cc @cfallin </p>
</blockquote>



<a name="283060298"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%234170%20Cranelift%3A%20pinned_reg%20does%20not%20wor.../near/283060298" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.234170.20Cranelift.3A.20pinned_reg.20does.20not.20wor.2E.2E.2E.html#283060298">(May 20 2022 at 12:16)</a>:</h4>
<p>pepyakin labeled <a href="https://github.com/bytecodealliance/wasmtime/issues/4170">issue #4170</a>:</p>
<blockquote>
<h3><code>.clif</code> Test Case</h3>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="n">function</span><span class="w"> </span><span class="n">u0</span>:<span class="mi">0</span><span class="p">(</span><span class="kt">i64</span><span class="w"> </span><span class="n">vmctx</span><span class="p">,</span><span class="w"> </span><span class="kt">i64</span><span class="p">)</span><span class="w"> </span><span class="n">wasmtime_system_v</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">gv0</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">vmctx</span><span class="w"></span>
<span class="w">    </span><span class="n">gv1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">load</span><span class="p">.</span><span class="kt">i64</span><span class="w"> </span><span class="n">notrap</span><span class="w"> </span><span class="n">aligned</span><span class="w"> </span><span class="n">readonly</span><span class="w"> </span><span class="n">gv0</span><span class="w"></span>
<span class="w">    </span><span class="n">gv2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">load</span><span class="p">.</span><span class="kt">i64</span><span class="w"> </span><span class="n">notrap</span><span class="w"> </span><span class="n">aligned</span><span class="w"> </span><span class="n">gv1</span><span class="w"></span>
<span class="w">    </span><span class="n">gv3</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">vmctx</span><span class="w"></span>
<span class="w">    </span><span class="n">stack_limit</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">gv2</span><span class="w"></span>

<span class="w">    </span><span class="n">block0</span><span class="p">(</span><span class="n">v0</span>: <span class="kt">i64</span><span class="p">,</span><span class="w"> </span><span class="n">v1</span>: <span class="kt">i64</span><span class="p">)</span>:
        <span class="nc">v2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">global_value</span><span class="p">.</span><span class="kt">i64</span><span class="w"> </span><span class="n">gv3</span><span class="w"></span>
<span class="w">        </span><span class="n">v3</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">load</span><span class="p">.</span><span class="kt">i64</span><span class="w"> </span><span class="n">notrap</span><span class="w"> </span><span class="n">aligned</span><span class="w"> </span><span class="n">v2</span><span class="w"></span>
<span class="w">        </span><span class="n">v4</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">get_pinned_reg</span><span class="p">.</span><span class="kt">i64</span><span class="w"></span>
<span class="w">        </span><span class="n">v5</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">iadd_imm</span><span class="w"> </span><span class="n">v4</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="w"></span>
<span class="w">        </span><span class="n">set_pinned_reg</span><span class="w"> </span><span class="n">v5</span><span class="w"></span>
<span class="w">        </span><span class="n">jump</span><span class="w"> </span><span class="n">block1</span><span class="w"></span>

<span class="w">    </span><span class="n">block1</span>:
        <span class="nc">return</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>
<h3>Steps to Reproduce</h3>
<div class="codehilite" data-code-language="Bash"><pre><span></span><code>$ clif-util compile -D --target x86_64 pinned_reg.clif --set enable_pinned_reg
.byte <span class="m">85</span>, <span class="m">72</span>, <span class="m">137</span>, <span class="m">229</span>, <span class="m">72</span>, <span class="m">131</span>, <span class="m">236</span>, <span class="m">16</span>, <span class="m">76</span>, <span class="m">137</span>, <span class="m">60</span>, <span class="m">36</span>, <span class="m">76</span>, <span class="m">139</span>, <span class="m">15</span>, <span class="m">73</span>, <span class="m">131</span>, <span class="m">199</span>, <span class="m">1</span>, <span class="m">76</span>, <span class="m">139</span>, <span class="m">60</span>, <span class="m">36</span>, <span class="m">72</span>, <span class="m">131</span>, <span class="m">196</span>, <span class="m">16</span>, <span class="m">72</span>, <span class="m">137</span>, <span class="m">236</span>, <span class="m">93</span>, <span class="m">195</span>

Disassembly of <span class="m">32</span> bytes:
   <span class="m">0</span>:   <span class="m">55</span>                      push    rbp
   <span class="m">1</span>:   <span class="m">48</span> <span class="m">89</span> e5                mov     rbp, rsp
   <span class="m">4</span>:   <span class="m">48</span> <span class="m">83</span> ec <span class="m">10</span>             sub     rsp, 0x10
   <span class="m">8</span>:   4c <span class="m">89</span> 3c <span class="m">24</span>             mov     qword ptr <span class="o">[</span>rsp<span class="o">]</span>, r15
   c:   4c 8b 0f                mov     r9, qword ptr <span class="o">[</span>rdi<span class="o">]</span>
   f:   <span class="m">49</span> <span class="m">83</span> c7 <span class="m">01</span>             add     r15, <span class="m">1</span>
  <span class="m">13</span>:   4c 8b 3c <span class="m">24</span>             mov     r15, qword ptr <span class="o">[</span>rsp<span class="o">]</span>
  <span class="m">17</span>:   <span class="m">48</span> <span class="m">83</span> c4 <span class="m">10</span>             add     rsp, 0x10
  1b:   <span class="m">48</span> <span class="m">89</span> ec                mov     rsp, rbp
  1e:   5d                      pop     rbp
  1f:   c3                      ret
</code></pre></div>
<h3>Expected Results</h3>
<p><code>get_pinned_reg</code> and <code>set_pinned_reg</code> either work in this situation or at least the verifier rejects the code.</p>
<h3>Actual Results</h3>
<p>r15, the pinned register, gets saved and restored as a CSR making it impossible to use as a pinned register.</p>
<h3>Versions and Environment</h3>
<p>Cranelift version or commit: f19d8cc85</p>
<h3>Extra Info</h3>
<p>Found this while hacking on <a href="https://github.com/bytecodealliance/wasmtime/issues/4109#issuecomment-1130527740">https://github.com/bytecodealliance/wasmtime/issues/4109#issuecomment-1130527740</a>. I've worked around it by setting this predicate in <code>gen_clobber_restore</code>.</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="n">call_conv</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">isa</span>::<span class="n">CallConv</span>::<span class="n">WasmtimeSystemV</span><span class="w"></span>
<span class="w">                </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">flags</span><span class="p">.</span><span class="n">enable_pinned_reg</span><span class="p">()</span><span class="w"></span>
<span class="w">                </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">reg</span><span class="p">.</span><span class="n">to_reg</span><span class="p">()</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">regs</span>::<span class="n">r15</span><span class="p">().</span><span class="n">to_real_reg</span><span class="p">().</span><span class="n">unwrap</span><span class="p">()</span><span class="w"></span>
<span class="w">            </span><span class="p">{</span><span class="w"></span>
<span class="w">                </span><span class="c1">// HACK: don't restore r15 if pinned_reg enabled.</span>
<span class="w">                </span><span class="c1">// continue;</span>
<span class="w">            </span><span class="p">}</span><span class="w"></span>
</code></pre></div>
<p>I am pretty sure that this is also the case for the aarch64 backend.</p>
<p>cc @cfallin </p>
</blockquote>



<a name="283060299"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%234170%20Cranelift%3A%20pinned_reg%20does%20not%20wor.../near/283060299" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.234170.20Cranelift.3A.20pinned_reg.20does.20not.20wor.2E.2E.2E.html#283060299">(May 20 2022 at 12:16)</a>:</h4>
<p>pepyakin labeled <a href="https://github.com/bytecodealliance/wasmtime/issues/4170">issue #4170</a>:</p>
<blockquote>
<h3><code>.clif</code> Test Case</h3>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="n">function</span><span class="w"> </span><span class="n">u0</span>:<span class="mi">0</span><span class="p">(</span><span class="kt">i64</span><span class="w"> </span><span class="n">vmctx</span><span class="p">,</span><span class="w"> </span><span class="kt">i64</span><span class="p">)</span><span class="w"> </span><span class="n">wasmtime_system_v</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">gv0</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">vmctx</span><span class="w"></span>
<span class="w">    </span><span class="n">gv1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">load</span><span class="p">.</span><span class="kt">i64</span><span class="w"> </span><span class="n">notrap</span><span class="w"> </span><span class="n">aligned</span><span class="w"> </span><span class="n">readonly</span><span class="w"> </span><span class="n">gv0</span><span class="w"></span>
<span class="w">    </span><span class="n">gv2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">load</span><span class="p">.</span><span class="kt">i64</span><span class="w"> </span><span class="n">notrap</span><span class="w"> </span><span class="n">aligned</span><span class="w"> </span><span class="n">gv1</span><span class="w"></span>
<span class="w">    </span><span class="n">gv3</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">vmctx</span><span class="w"></span>
<span class="w">    </span><span class="n">stack_limit</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">gv2</span><span class="w"></span>

<span class="w">    </span><span class="n">block0</span><span class="p">(</span><span class="n">v0</span>: <span class="kt">i64</span><span class="p">,</span><span class="w"> </span><span class="n">v1</span>: <span class="kt">i64</span><span class="p">)</span>:
        <span class="nc">v2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">global_value</span><span class="p">.</span><span class="kt">i64</span><span class="w"> </span><span class="n">gv3</span><span class="w"></span>
<span class="w">        </span><span class="n">v3</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">load</span><span class="p">.</span><span class="kt">i64</span><span class="w"> </span><span class="n">notrap</span><span class="w"> </span><span class="n">aligned</span><span class="w"> </span><span class="n">v2</span><span class="w"></span>
<span class="w">        </span><span class="n">v4</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">get_pinned_reg</span><span class="p">.</span><span class="kt">i64</span><span class="w"></span>
<span class="w">        </span><span class="n">v5</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">iadd_imm</span><span class="w"> </span><span class="n">v4</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="w"></span>
<span class="w">        </span><span class="n">set_pinned_reg</span><span class="w"> </span><span class="n">v5</span><span class="w"></span>
<span class="w">        </span><span class="n">jump</span><span class="w"> </span><span class="n">block1</span><span class="w"></span>

<span class="w">    </span><span class="n">block1</span>:
        <span class="nc">return</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>
<h3>Steps to Reproduce</h3>
<div class="codehilite" data-code-language="Bash"><pre><span></span><code>$ clif-util compile -D --target x86_64 pinned_reg.clif --set enable_pinned_reg
.byte <span class="m">85</span>, <span class="m">72</span>, <span class="m">137</span>, <span class="m">229</span>, <span class="m">72</span>, <span class="m">131</span>, <span class="m">236</span>, <span class="m">16</span>, <span class="m">76</span>, <span class="m">137</span>, <span class="m">60</span>, <span class="m">36</span>, <span class="m">76</span>, <span class="m">139</span>, <span class="m">15</span>, <span class="m">73</span>, <span class="m">131</span>, <span class="m">199</span>, <span class="m">1</span>, <span class="m">76</span>, <span class="m">139</span>, <span class="m">60</span>, <span class="m">36</span>, <span class="m">72</span>, <span class="m">131</span>, <span class="m">196</span>, <span class="m">16</span>, <span class="m">72</span>, <span class="m">137</span>, <span class="m">236</span>, <span class="m">93</span>, <span class="m">195</span>

Disassembly of <span class="m">32</span> bytes:
   <span class="m">0</span>:   <span class="m">55</span>                      push    rbp
   <span class="m">1</span>:   <span class="m">48</span> <span class="m">89</span> e5                mov     rbp, rsp
   <span class="m">4</span>:   <span class="m">48</span> <span class="m">83</span> ec <span class="m">10</span>             sub     rsp, 0x10
   <span class="m">8</span>:   4c <span class="m">89</span> 3c <span class="m">24</span>             mov     qword ptr <span class="o">[</span>rsp<span class="o">]</span>, r15
   c:   4c 8b 0f                mov     r9, qword ptr <span class="o">[</span>rdi<span class="o">]</span>
   f:   <span class="m">49</span> <span class="m">83</span> c7 <span class="m">01</span>             add     r15, <span class="m">1</span>
  <span class="m">13</span>:   4c 8b 3c <span class="m">24</span>             mov     r15, qword ptr <span class="o">[</span>rsp<span class="o">]</span>
  <span class="m">17</span>:   <span class="m">48</span> <span class="m">83</span> c4 <span class="m">10</span>             add     rsp, 0x10
  1b:   <span class="m">48</span> <span class="m">89</span> ec                mov     rsp, rbp
  1e:   5d                      pop     rbp
  1f:   c3                      ret
</code></pre></div>
<h3>Expected Results</h3>
<p><code>get_pinned_reg</code> and <code>set_pinned_reg</code> either work in this situation or at least the verifier rejects the code.</p>
<h3>Actual Results</h3>
<p>r15, the pinned register, gets saved and restored as a CSR making it impossible to use as a pinned register.</p>
<h3>Versions and Environment</h3>
<p>Cranelift version or commit: f19d8cc85</p>
<h3>Extra Info</h3>
<p>Found this while hacking on <a href="https://github.com/bytecodealliance/wasmtime/issues/4109#issuecomment-1130527740">https://github.com/bytecodealliance/wasmtime/issues/4109#issuecomment-1130527740</a>. I've worked around it by setting this predicate in <code>gen_clobber_restore</code>.</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="n">call_conv</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">isa</span>::<span class="n">CallConv</span>::<span class="n">WasmtimeSystemV</span><span class="w"></span>
<span class="w">                </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">flags</span><span class="p">.</span><span class="n">enable_pinned_reg</span><span class="p">()</span><span class="w"></span>
<span class="w">                </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">reg</span><span class="p">.</span><span class="n">to_reg</span><span class="p">()</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">regs</span>::<span class="n">r15</span><span class="p">().</span><span class="n">to_real_reg</span><span class="p">().</span><span class="n">unwrap</span><span class="p">()</span><span class="w"></span>
<span class="w">            </span><span class="p">{</span><span class="w"></span>
<span class="w">                </span><span class="c1">// HACK: don't restore r15 if pinned_reg enabled.</span>
<span class="w">                </span><span class="c1">// continue;</span>
<span class="w">            </span><span class="p">}</span><span class="w"></span>
</code></pre></div>
<p>I am pretty sure that this is also the case for the aarch64 backend.</p>
<p>cc @cfallin </p>
</blockquote>



<a name="283060324"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%234170%20Cranelift%3A%20pinned_reg%20does%20not%20wor.../near/283060324" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.234170.20Cranelift.3A.20pinned_reg.20does.20not.20wor.2E.2E.2E.html#283060324">(May 20 2022 at 12:16)</a>:</h4>
<p>pepyakin edited <a href="https://github.com/bytecodealliance/wasmtime/issues/4170">issue #4170</a>:</p>
<blockquote>
<h3><code>.clif</code> Test Case</h3>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="n">function</span><span class="w"> </span><span class="n">u0</span>:<span class="mi">0</span><span class="p">(</span><span class="kt">i64</span><span class="w"> </span><span class="n">vmctx</span><span class="p">,</span><span class="w"> </span><span class="kt">i64</span><span class="p">)</span><span class="w"> </span><span class="n">wasmtime_system_v</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">gv0</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">vmctx</span><span class="w"></span>
<span class="w">    </span><span class="n">gv1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">load</span><span class="p">.</span><span class="kt">i64</span><span class="w"> </span><span class="n">notrap</span><span class="w"> </span><span class="n">aligned</span><span class="w"> </span><span class="n">readonly</span><span class="w"> </span><span class="n">gv0</span><span class="w"></span>
<span class="w">    </span><span class="n">gv2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">load</span><span class="p">.</span><span class="kt">i64</span><span class="w"> </span><span class="n">notrap</span><span class="w"> </span><span class="n">aligned</span><span class="w"> </span><span class="n">gv1</span><span class="w"></span>
<span class="w">    </span><span class="n">gv3</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">vmctx</span><span class="w"></span>
<span class="w">    </span><span class="n">stack_limit</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">gv2</span><span class="w"></span>

<span class="w">    </span><span class="n">block0</span><span class="p">(</span><span class="n">v0</span>: <span class="kt">i64</span><span class="p">,</span><span class="w"> </span><span class="n">v1</span>: <span class="kt">i64</span><span class="p">)</span>:
        <span class="nc">v2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">global_value</span><span class="p">.</span><span class="kt">i64</span><span class="w"> </span><span class="n">gv3</span><span class="w"></span>
<span class="w">        </span><span class="n">v3</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">load</span><span class="p">.</span><span class="kt">i64</span><span class="w"> </span><span class="n">notrap</span><span class="w"> </span><span class="n">aligned</span><span class="w"> </span><span class="n">v2</span><span class="w"></span>
<span class="w">        </span><span class="n">v4</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">get_pinned_reg</span><span class="p">.</span><span class="kt">i64</span><span class="w"></span>
<span class="w">        </span><span class="n">v5</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">iadd_imm</span><span class="w"> </span><span class="n">v4</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="w"></span>
<span class="w">        </span><span class="n">set_pinned_reg</span><span class="w"> </span><span class="n">v5</span><span class="w"></span>
<span class="w">        </span><span class="n">jump</span><span class="w"> </span><span class="n">block1</span><span class="w"></span>

<span class="w">    </span><span class="n">block1</span>:
        <span class="nc">return</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>
<h3>Steps to Reproduce</h3>
<div class="codehilite" data-code-language="Bash"><pre><span></span><code>$ clif-util compile -D --target x86_64 pinned_reg.clif --set enable_pinned_reg
.byte <span class="m">85</span>, <span class="m">72</span>, <span class="m">137</span>, <span class="m">229</span>, <span class="m">72</span>, <span class="m">131</span>, <span class="m">236</span>, <span class="m">16</span>, <span class="m">76</span>, <span class="m">137</span>, <span class="m">60</span>, <span class="m">36</span>, <span class="m">76</span>, <span class="m">139</span>, <span class="m">15</span>, <span class="m">73</span>, <span class="m">131</span>, <span class="m">199</span>, <span class="m">1</span>, <span class="m">76</span>, <span class="m">139</span>, <span class="m">60</span>, <span class="m">36</span>, <span class="m">72</span>, <span class="m">131</span>, <span class="m">196</span>, <span class="m">16</span>, <span class="m">72</span>, <span class="m">137</span>, <span class="m">236</span>, <span class="m">93</span>, <span class="m">195</span>

Disassembly of <span class="m">32</span> bytes:
   <span class="m">0</span>:   <span class="m">55</span>                      push    rbp
   <span class="m">1</span>:   <span class="m">48</span> <span class="m">89</span> e5                mov     rbp, rsp
   <span class="m">4</span>:   <span class="m">48</span> <span class="m">83</span> ec <span class="m">10</span>             sub     rsp, 0x10
   <span class="m">8</span>:   4c <span class="m">89</span> 3c <span class="m">24</span>             mov     qword ptr <span class="o">[</span>rsp<span class="o">]</span>, r15
   c:   4c 8b 0f                mov     r9, qword ptr <span class="o">[</span>rdi<span class="o">]</span>
   f:   <span class="m">49</span> <span class="m">83</span> c7 <span class="m">01</span>             add     r15, <span class="m">1</span>
  <span class="m">13</span>:   4c 8b 3c <span class="m">24</span>             mov     r15, qword ptr <span class="o">[</span>rsp<span class="o">]</span>
  <span class="m">17</span>:   <span class="m">48</span> <span class="m">83</span> c4 <span class="m">10</span>             add     rsp, 0x10
  1b:   <span class="m">48</span> <span class="m">89</span> ec                mov     rsp, rbp
  1e:   5d                      pop     rbp
  1f:   c3                      ret
</code></pre></div>
<h3>Expected Results</h3>
<p><code>get_pinned_reg</code> and <code>set_pinned_reg</code> either work in this situation or at least the verifier rejects the code.</p>
<h3>Actual Results</h3>
<p>r15, the pinned register, gets saved and restored as a CSR making it impossible to use as a pinned register.</p>
<h3>Versions and Environment</h3>
<p>Cranelift version or commit: f19d8cc85</p>
<h3>Extra Info</h3>
<p>Found this while hacking on <a href="https://github.com/bytecodealliance/wasmtime/issues/4109#issuecomment-1130527740">https://github.com/bytecodealliance/wasmtime/issues/4109#issuecomment-1130527740</a>. I've worked around it by setting this predicate in <code>gen_clobber_restore</code>.</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="n">call_conv</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">isa</span>::<span class="n">CallConv</span>::<span class="n">WasmtimeSystemV</span><span class="w"></span>
<span class="w">                </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">flags</span><span class="p">.</span><span class="n">enable_pinned_reg</span><span class="p">()</span><span class="w"></span>
<span class="w">                </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">reg</span><span class="p">.</span><span class="n">to_reg</span><span class="p">()</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">regs</span>::<span class="n">r15</span><span class="p">().</span><span class="n">to_real_reg</span><span class="p">().</span><span class="n">unwrap</span><span class="p">()</span><span class="w"></span>
<span class="w">            </span><span class="p">{</span><span class="w"></span>
<span class="w">                </span><span class="c1">// HACK: don't restore r15 if pinned_reg enabled.</span>
<span class="w">                </span><span class="k">continue</span><span class="p">;</span><span class="w"></span>
<span class="w">            </span><span class="p">}</span><span class="w"></span>
</code></pre></div>
<p>I am pretty sure that this is also the case for the aarch64 backend.</p>
<p>cc @cfallin </p>
</blockquote>



<a name="283060823"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%234170%20Cranelift%3A%20pinned_reg%20does%20not%20wor.../near/283060823" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.234170.20Cranelift.3A.20pinned_reg.20does.20not.20wor.2E.2E.2E.html#283060823">(May 20 2022 at 12:21)</a>:</h4>
<p>pepyakin edited <a href="https://github.com/bytecodealliance/wasmtime/issues/4170">issue #4170</a>:</p>
<blockquote>
<h3><code>.clif</code> Test Case</h3>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="n">function</span><span class="w"> </span><span class="n">u0</span>:<span class="mi">0</span><span class="p">(</span><span class="kt">i64</span><span class="w"> </span><span class="n">vmctx</span><span class="p">,</span><span class="w"> </span><span class="kt">i64</span><span class="p">)</span><span class="w"> </span><span class="n">wasmtime_system_v</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">gv0</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">vmctx</span><span class="w"></span>
<span class="w">    </span><span class="n">gv1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">load</span><span class="p">.</span><span class="kt">i64</span><span class="w"> </span><span class="n">notrap</span><span class="w"> </span><span class="n">aligned</span><span class="w"> </span><span class="n">readonly</span><span class="w"> </span><span class="n">gv0</span><span class="w"></span>
<span class="w">    </span><span class="n">gv2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">load</span><span class="p">.</span><span class="kt">i64</span><span class="w"> </span><span class="n">notrap</span><span class="w"> </span><span class="n">aligned</span><span class="w"> </span><span class="n">gv1</span><span class="w"></span>
<span class="w">    </span><span class="n">gv3</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">vmctx</span><span class="w"></span>
<span class="w">    </span><span class="n">stack_limit</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">gv2</span><span class="w"></span>

<span class="w">    </span><span class="n">block0</span><span class="p">(</span><span class="n">v0</span>: <span class="kt">i64</span><span class="p">,</span><span class="w"> </span><span class="n">v1</span>: <span class="kt">i64</span><span class="p">)</span>:
        <span class="nc">v2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">global_value</span><span class="p">.</span><span class="kt">i64</span><span class="w"> </span><span class="n">gv3</span><span class="w"></span>
<span class="w">        </span><span class="n">v3</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">load</span><span class="p">.</span><span class="kt">i64</span><span class="w"> </span><span class="n">notrap</span><span class="w"> </span><span class="n">aligned</span><span class="w"> </span><span class="n">v2</span><span class="w"></span>
<span class="w">        </span><span class="n">v4</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">get_pinned_reg</span><span class="p">.</span><span class="kt">i64</span><span class="w"></span>
<span class="w">        </span><span class="n">v5</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">iadd_imm</span><span class="w"> </span><span class="n">v4</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="w"></span>
<span class="w">        </span><span class="n">set_pinned_reg</span><span class="w"> </span><span class="n">v5</span><span class="w"></span>
<span class="w">        </span><span class="n">jump</span><span class="w"> </span><span class="n">block1</span><span class="w"></span>

<span class="w">    </span><span class="n">block1</span>:
        <span class="nc">return</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>
<h3>Steps to Reproduce</h3>
<div class="codehilite" data-code-language="Bash"><pre><span></span><code>$ clif-util compile -D --target x86_64 pinned_reg.clif --set enable_pinned_reg
.byte <span class="m">85</span>, <span class="m">72</span>, <span class="m">137</span>, <span class="m">229</span>, <span class="m">72</span>, <span class="m">131</span>, <span class="m">236</span>, <span class="m">16</span>, <span class="m">76</span>, <span class="m">137</span>, <span class="m">60</span>, <span class="m">36</span>, <span class="m">76</span>, <span class="m">139</span>, <span class="m">15</span>, <span class="m">73</span>, <span class="m">131</span>, <span class="m">199</span>, <span class="m">1</span>, <span class="m">76</span>, <span class="m">139</span>, <span class="m">60</span>, <span class="m">36</span>, <span class="m">72</span>, <span class="m">131</span>, <span class="m">196</span>, <span class="m">16</span>, <span class="m">72</span>, <span class="m">137</span>, <span class="m">236</span>, <span class="m">93</span>, <span class="m">195</span>

Disassembly of <span class="m">32</span> bytes:
   <span class="m">0</span>:   <span class="m">55</span>                      push    rbp
   <span class="m">1</span>:   <span class="m">48</span> <span class="m">89</span> e5                mov     rbp, rsp
   <span class="m">4</span>:   <span class="m">48</span> <span class="m">83</span> ec <span class="m">10</span>             sub     rsp, 0x10
   <span class="m">8</span>:   4c <span class="m">89</span> 3c <span class="m">24</span>             mov     qword ptr <span class="o">[</span>rsp<span class="o">]</span>, r15
   c:   4c 8b 0f                mov     r9, qword ptr <span class="o">[</span>rdi<span class="o">]</span>
   f:   <span class="m">49</span> <span class="m">83</span> c7 <span class="m">01</span>             add     r15, <span class="m">1</span>
  <span class="m">13</span>:   4c 8b 3c <span class="m">24</span>             mov     r15, qword ptr <span class="o">[</span>rsp<span class="o">]</span>
  <span class="m">17</span>:   <span class="m">48</span> <span class="m">83</span> c4 <span class="m">10</span>             add     rsp, 0x10
  1b:   <span class="m">48</span> <span class="m">89</span> ec                mov     rsp, rbp
  1e:   5d                      pop     rbp
  1f:   c3                      ret
</code></pre></div>
<h3>Expected Results</h3>
<p><code>get_pinned_reg</code> and <code>set_pinned_reg</code> either work in this situation or at least the verifier rejects the code.</p>
<h3>Actual Results</h3>
<p>r15, the pinned register, gets saved and restored as a CSR making it impossible to use as a pinned register.</p>
<h3>Versions and Environment</h3>
<p>Cranelift version or commit: f19d8cc85</p>
<h3>Extra Info</h3>
<p>Found this while hacking on <a href="https://github.com/bytecodealliance/wasmtime/issues/4109">https://github.com/bytecodealliance/wasmtime/issues/4109</a>. I've worked around it by setting this predicate in <code>gen_clobber_restore</code>.</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="n">call_conv</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">isa</span>::<span class="n">CallConv</span>::<span class="n">WasmtimeSystemV</span><span class="w"></span>
<span class="w">                </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">flags</span><span class="p">.</span><span class="n">enable_pinned_reg</span><span class="p">()</span><span class="w"></span>
<span class="w">                </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">reg</span><span class="p">.</span><span class="n">to_reg</span><span class="p">()</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">regs</span>::<span class="n">r15</span><span class="p">().</span><span class="n">to_real_reg</span><span class="p">().</span><span class="n">unwrap</span><span class="p">()</span><span class="w"></span>
<span class="w">            </span><span class="p">{</span><span class="w"></span>
<span class="w">                </span><span class="c1">// HACK: don't restore r15 if pinned_reg enabled.</span>
<span class="w">                </span><span class="k">continue</span><span class="p">;</span><span class="w"></span>
<span class="w">            </span><span class="p">}</span><span class="w"></span>
</code></pre></div>
<p>I am pretty sure that this is also the case for the aarch64 backend.</p>
<p>cc @cfallin </p>
</blockquote>



<a name="283099924"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%234170%20Cranelift%3A%20pinned_reg%20does%20not%20wor.../near/283099924" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.234170.20Cranelift.3A.20pinned_reg.20does.20not.20wor.2E.2E.2E.html#283099924">(May 20 2022 at 17:12)</a>:</h4>
<p>cfallin <a href="https://github.com/bytecodealliance/wasmtime/issues/4170#issuecomment-1133135010">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/4170">issue #4170</a>:</p>
<blockquote>
<p>I'll take a look at this, thanks! I think this is probably a result of only ever having used pinned registers with the SpiderMonkey ("baldrdash") calling convention support, so the SysV code doesn't account for it.</p>
</blockquote>



<a name="283342368"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%234170%20Cranelift%3A%20pinned_reg%20does%20not%20wor.../near/283342368" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.234170.20Cranelift.3A.20pinned_reg.20does.20not.20wor.2E.2E.2E.html#283342368">(May 23 2022 at 16:18)</a>:</h4>
<p>cfallin closed <a href="https://github.com/bytecodealliance/wasmtime/issues/4170">issue #4170</a>:</p>
<blockquote>
<h3><code>.clif</code> Test Case</h3>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="n">function</span><span class="w"> </span><span class="n">u0</span>:<span class="mi">0</span><span class="p">(</span><span class="kt">i64</span><span class="w"> </span><span class="n">vmctx</span><span class="p">,</span><span class="w"> </span><span class="kt">i64</span><span class="p">)</span><span class="w"> </span><span class="n">wasmtime_system_v</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">gv0</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">vmctx</span><span class="w"></span>
<span class="w">    </span><span class="n">gv1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">load</span><span class="p">.</span><span class="kt">i64</span><span class="w"> </span><span class="n">notrap</span><span class="w"> </span><span class="n">aligned</span><span class="w"> </span><span class="n">readonly</span><span class="w"> </span><span class="n">gv0</span><span class="w"></span>
<span class="w">    </span><span class="n">gv2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">load</span><span class="p">.</span><span class="kt">i64</span><span class="w"> </span><span class="n">notrap</span><span class="w"> </span><span class="n">aligned</span><span class="w"> </span><span class="n">gv1</span><span class="w"></span>
<span class="w">    </span><span class="n">gv3</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">vmctx</span><span class="w"></span>
<span class="w">    </span><span class="n">stack_limit</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">gv2</span><span class="w"></span>

<span class="w">    </span><span class="n">block0</span><span class="p">(</span><span class="n">v0</span>: <span class="kt">i64</span><span class="p">,</span><span class="w"> </span><span class="n">v1</span>: <span class="kt">i64</span><span class="p">)</span>:
        <span class="nc">v2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">global_value</span><span class="p">.</span><span class="kt">i64</span><span class="w"> </span><span class="n">gv3</span><span class="w"></span>
<span class="w">        </span><span class="n">v3</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">load</span><span class="p">.</span><span class="kt">i64</span><span class="w"> </span><span class="n">notrap</span><span class="w"> </span><span class="n">aligned</span><span class="w"> </span><span class="n">v2</span><span class="w"></span>
<span class="w">        </span><span class="n">v4</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">get_pinned_reg</span><span class="p">.</span><span class="kt">i64</span><span class="w"></span>
<span class="w">        </span><span class="n">v5</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">iadd_imm</span><span class="w"> </span><span class="n">v4</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="w"></span>
<span class="w">        </span><span class="n">set_pinned_reg</span><span class="w"> </span><span class="n">v5</span><span class="w"></span>
<span class="w">        </span><span class="n">jump</span><span class="w"> </span><span class="n">block1</span><span class="w"></span>

<span class="w">    </span><span class="n">block1</span>:
        <span class="nc">return</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>
<h3>Steps to Reproduce</h3>
<div class="codehilite" data-code-language="Bash"><pre><span></span><code>$ clif-util compile -D --target x86_64 pinned_reg.clif --set enable_pinned_reg
.byte <span class="m">85</span>, <span class="m">72</span>, <span class="m">137</span>, <span class="m">229</span>, <span class="m">72</span>, <span class="m">131</span>, <span class="m">236</span>, <span class="m">16</span>, <span class="m">76</span>, <span class="m">137</span>, <span class="m">60</span>, <span class="m">36</span>, <span class="m">76</span>, <span class="m">139</span>, <span class="m">15</span>, <span class="m">73</span>, <span class="m">131</span>, <span class="m">199</span>, <span class="m">1</span>, <span class="m">76</span>, <span class="m">139</span>, <span class="m">60</span>, <span class="m">36</span>, <span class="m">72</span>, <span class="m">131</span>, <span class="m">196</span>, <span class="m">16</span>, <span class="m">72</span>, <span class="m">137</span>, <span class="m">236</span>, <span class="m">93</span>, <span class="m">195</span>

Disassembly of <span class="m">32</span> bytes:
   <span class="m">0</span>:   <span class="m">55</span>                      push    rbp
   <span class="m">1</span>:   <span class="m">48</span> <span class="m">89</span> e5                mov     rbp, rsp
   <span class="m">4</span>:   <span class="m">48</span> <span class="m">83</span> ec <span class="m">10</span>             sub     rsp, 0x10
   <span class="m">8</span>:   4c <span class="m">89</span> 3c <span class="m">24</span>             mov     qword ptr <span class="o">[</span>rsp<span class="o">]</span>, r15
   c:   4c 8b 0f                mov     r9, qword ptr <span class="o">[</span>rdi<span class="o">]</span>
   f:   <span class="m">49</span> <span class="m">83</span> c7 <span class="m">01</span>             add     r15, <span class="m">1</span>
  <span class="m">13</span>:   4c 8b 3c <span class="m">24</span>             mov     r15, qword ptr <span class="o">[</span>rsp<span class="o">]</span>
  <span class="m">17</span>:   <span class="m">48</span> <span class="m">83</span> c4 <span class="m">10</span>             add     rsp, 0x10
  1b:   <span class="m">48</span> <span class="m">89</span> ec                mov     rsp, rbp
  1e:   5d                      pop     rbp
  1f:   c3                      ret
</code></pre></div>
<h3>Expected Results</h3>
<p><code>get_pinned_reg</code> and <code>set_pinned_reg</code> either work in this situation or at least the verifier rejects the code.</p>
<h3>Actual Results</h3>
<p>r15, the pinned register, gets saved and restored as a CSR making it impossible to use as a pinned register.</p>
<h3>Versions and Environment</h3>
<p>Cranelift version or commit: f19d8cc85</p>
<h3>Extra Info</h3>
<p>Found this while hacking on <a href="https://github.com/bytecodealliance/wasmtime/issues/4109">https://github.com/bytecodealliance/wasmtime/issues/4109</a>. I've worked around it by setting this predicate in <code>gen_clobber_restore</code>.</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="n">call_conv</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">isa</span>::<span class="n">CallConv</span>::<span class="n">WasmtimeSystemV</span><span class="w"></span>
<span class="w">                </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">flags</span><span class="p">.</span><span class="n">enable_pinned_reg</span><span class="p">()</span><span class="w"></span>
<span class="w">                </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">reg</span><span class="p">.</span><span class="n">to_reg</span><span class="p">()</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">regs</span>::<span class="n">r15</span><span class="p">().</span><span class="n">to_real_reg</span><span class="p">().</span><span class="n">unwrap</span><span class="p">()</span><span class="w"></span>
<span class="w">            </span><span class="p">{</span><span class="w"></span>
<span class="w">                </span><span class="c1">// HACK: don't restore r15 if pinned_reg enabled.</span>
<span class="w">                </span><span class="k">continue</span><span class="p">;</span><span class="w"></span>
<span class="w">            </span><span class="p">}</span><span class="w"></span>
</code></pre></div>
<p>I am pretty sure that this is also the case for the aarch64 backend.</p>
<p>cc @cfallin </p>
</blockquote>



<hr><p>Last updated: Jan 20 2025 at 06:04 UTC</p>
</html>