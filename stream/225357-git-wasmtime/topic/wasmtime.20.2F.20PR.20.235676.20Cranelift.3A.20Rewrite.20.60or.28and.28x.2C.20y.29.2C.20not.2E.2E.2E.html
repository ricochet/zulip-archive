<html>
<head><meta charset="utf-8"><title>wasmtime / PR #5676 Cranelift: Rewrite `or(and(x, y), not... · git-wasmtime · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/index.html">git-wasmtime</a></h2>
<h3>Topic: <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.235676.20Cranelift.3A.20Rewrite.20.60or.28and.28x.2C.20y.29.2C.20not.2E.2E.2E.html">wasmtime / PR #5676 Cranelift: Rewrite `or(and(x, y), not...</a></h3>

<hr>

<base href="https://bytecodealliance.zulipchat.com">

<head><link href="https://bytecodealliance.github.io/zulip-archive/style.css" rel="stylesheet"></head>

<a name="325014536"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%235676%20Cranelift%3A%20Rewrite%20%60or%28and%28x%2C%20y%29%2C%20not.../near/325014536" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.235676.20Cranelift.3A.20Rewrite.20.60or.28and.28x.2C.20y.29.2C.20not.2E.2E.2E.html#325014536">(Jan 31 2023 at 20:59)</a>:</h4>
<p>fitzgen opened <a href="https://github.com/bytecodealliance/wasmtime/pull/5676">PR #5676</a> from <code>or-and-y-with-not-y</code> to <code>main</code>:</p>
<blockquote>
<p>Thanks again to Souper for pointing this one out! cc @regehr</p>
<p>&lt;!--</p>
<p>Please ensure that the following steps are all taken care of before submitting<br>
the PR.</p>
<ul>
<li>
<p>[ ] This has been discussed in issue #..., or if not, please tell us why<br>
  here.</p>
</li>
<li>
<p>[ ] A short description of what this does, why it is needed; if the<br>
  description becomes long, the matter should probably be discussed in an issue<br>
  first.</p>
</li>
<li>
<p>[ ] This PR contains test cases, if meaningful.</p>
</li>
<li>[ ] A reviewer from the core maintainer team has been assigned for this PR.<br>
  If you don't know who could review this, please indicate so. The list of<br>
  suggested reviewers on the right can help you.</li>
</ul>
<p>Please ensure all communication adheres to the <a href="https://github.com/bytecodealliance/wasmtime/blob/master/CODE_OF_CONDUCT.md">code of
conduct</a>.<br>
--&gt;<br>
</p>
</blockquote>



<a name="325014538"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%235676%20Cranelift%3A%20Rewrite%20%60or%28and%28x%2C%20y%29%2C%20not.../near/325014538" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.235676.20Cranelift.3A.20Rewrite.20.60or.28and.28x.2C.20y.29.2C.20not.2E.2E.2E.html#325014538">(Jan 31 2023 at 20:59)</a>:</h4>
<p><strong>fitzgen</strong> requested <a href="https://github.com/cfallin">cfallin</a> for a review on <a href="https://github.com/bytecodealliance/wasmtime/pull/5676">PR #5676</a>.</p>



<a name="325018144"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%235676%20Cranelift%3A%20Rewrite%20%60or%28and%28x%2C%20y%29%2C%20not.../near/325018144" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.235676.20Cranelift.3A.20Rewrite.20.60or.28and.28x.2C.20y.29.2C.20not.2E.2E.2E.html#325018144">(Jan 31 2023 at 21:20)</a>:</h4>
<p>cfallin submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/5676#pullrequestreview-1278038738">PR review</a>.</p>



<a name="325019578"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%235676%20Cranelift%3A%20Rewrite%20%60or%28and%28x%2C%20y%29%2C%20not.../near/325019578" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.235676.20Cranelift.3A.20Rewrite.20.60or.28and.28x.2C.20y.29.2C.20not.2E.2E.2E.html#325019578">(Jan 31 2023 at 21:28)</a>:</h4>
<p>fitzgen updated <a href="https://github.com/bytecodealliance/wasmtime/pull/5676">PR #5676</a> from <code>or-and-y-with-not-y</code> to <code>main</code>.</p>



<a name="325019681"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%235676%20Cranelift%3A%20Rewrite%20%60or%28and%28x%2C%20y%29%2C%20not.../near/325019681" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.235676.20Cranelift.3A.20Rewrite.20.60or.28and.28x.2C.20y.29.2C.20not.2E.2E.2E.html#325019681">(Jan 31 2023 at 21:29)</a>:</h4>
<p>fitzgen has enabled auto merge for <a href="https://github.com/bytecodealliance/wasmtime/pull/5676">PR #5676</a>.</p>



<a name="325019843"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%235676%20Cranelift%3A%20Rewrite%20%60or%28and%28x%2C%20y%29%2C%20not.../near/325019843" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.235676.20Cranelift.3A.20Rewrite.20.60or.28and.28x.2C.20y.29.2C.20not.2E.2E.2E.html#325019843">(Jan 31 2023 at 21:30)</a>:</h4>
<p>jameysharp submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/5676#pullrequestreview-1278045298">PR review</a>.</p>



<a name="325019847"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%235676%20Cranelift%3A%20Rewrite%20%60or%28and%28x%2C%20y%29%2C%20not.../near/325019847" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.235676.20Cranelift.3A.20Rewrite.20.60or.28and.28x.2C.20y.29.2C.20not.2E.2E.2E.html#325019847">(Jan 31 2023 at 21:30)</a>:</h4>
<p>jameysharp submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/5676#pullrequestreview-1278045298">PR review</a>.</p>



<a name="325019848"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%235676%20Cranelift%3A%20Rewrite%20%60or%28and%28x%2C%20y%29%2C%20not.../near/325019848" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.235676.20Cranelift.3A.20Rewrite.20.60or.28and.28x.2C.20y.29.2C.20not.2E.2E.2E.html#325019848">(Jan 31 2023 at 21:30)</a>:</h4>
<p>jameysharp created <a href="https://github.com/bytecodealliance/wasmtime/pull/5676#discussion_r1092500398">PR review comment</a>:</p>
<blockquote>
<p>I think there's an equivalent version of this rule where the <code>bnot</code> is inside the <code>band</code>, and the operand to <code>bor</code> is the uninverted value.</p>
</blockquote>



<a name="325019849"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%235676%20Cranelift%3A%20Rewrite%20%60or%28and%28x%2C%20y%29%2C%20not.../near/325019849" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.235676.20Cranelift.3A.20Rewrite.20.60or.28and.28x.2C.20y.29.2C.20not.2E.2E.2E.html#325019849">(Jan 31 2023 at 21:30)</a>:</h4>
<p>jameysharp created <a href="https://github.com/bytecodealliance/wasmtime/pull/5676#discussion_r1092498558">PR review comment</a>:</p>
<blockquote>
<p>Could you duplicate the egraph filetests so there's a second version of each one with the operands to <code>bor</code> flipped? I suspect some of these will pass but maybe not all of them.</p>
</blockquote>



<a name="325019850"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%235676%20Cranelift%3A%20Rewrite%20%60or%28and%28x%2C%20y%29%2C%20not.../near/325019850" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.235676.20Cranelift.3A.20Rewrite.20.60or.28and.28x.2C.20y.29.2C.20not.2E.2E.2E.html#325019850">(Jan 31 2023 at 21:30)</a>:</h4>
<p>jameysharp created <a href="https://github.com/bytecodealliance/wasmtime/pull/5676#discussion_r1092497506">PR review comment</a>:</p>
<blockquote>
<p>Do the <code>check</code> lines do anything in runtests?</p>
</blockquote>



<a name="325023371"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%235676%20Cranelift%3A%20Rewrite%20%60or%28and%28x%2C%20y%29%2C%20not.../near/325023371" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.235676.20Cranelift.3A.20Rewrite.20.60or.28and.28x.2C.20y.29.2C.20not.2E.2E.2E.html#325023371">(Jan 31 2023 at 21:50)</a>:</h4>
<p>fitzgen has disabled auto merge for <a href="https://github.com/bytecodealliance/wasmtime/pull/5676">PR #5676</a>.</p>



<a name="325024667"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%235676%20Cranelift%3A%20Rewrite%20%60or%28and%28x%2C%20y%29%2C%20not.../near/325024667" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.235676.20Cranelift.3A.20Rewrite.20.60or.28and.28x.2C.20y.29.2C.20not.2E.2E.2E.html#325024667">(Jan 31 2023 at 21:58)</a>:</h4>
<p>fitzgen updated <a href="https://github.com/bytecodealliance/wasmtime/pull/5676">PR #5676</a> from <code>or-and-y-with-not-y</code> to <code>main</code>.</p>



<a name="325024709"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%235676%20Cranelift%3A%20Rewrite%20%60or%28and%28x%2C%20y%29%2C%20not.../near/325024709" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.235676.20Cranelift.3A.20Rewrite.20.60or.28and.28x.2C.20y.29.2C.20not.2E.2E.2E.html#325024709">(Jan 31 2023 at 21:58)</a>:</h4>
<p>fitzgen submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/5676#pullrequestreview-1278085468">PR review</a>.</p>



<a name="325024710"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%235676%20Cranelift%3A%20Rewrite%20%60or%28and%28x%2C%20y%29%2C%20not.../near/325024710" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.235676.20Cranelift.3A.20Rewrite.20.60or.28and.28x.2C.20y.29.2C.20not.2E.2E.2E.html#325024710">(Jan 31 2023 at 21:58)</a>:</h4>
<p>fitzgen created <a href="https://github.com/bytecodealliance/wasmtime/pull/5676#discussion_r1092526319">PR review comment</a>:</p>
<blockquote>
<p>We talked, decided this was one rabbit hole too deep.</p>
</blockquote>



<a name="325024749"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%235676%20Cranelift%3A%20Rewrite%20%60or%28and%28x%2C%20y%29%2C%20not.../near/325024749" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.235676.20Cranelift.3A.20Rewrite.20.60or.28and.28x.2C.20y.29.2C.20not.2E.2E.2E.html#325024749">(Jan 31 2023 at 21:59)</a>:</h4>
<p>fitzgen has enabled auto merge for <a href="https://github.com/bytecodealliance/wasmtime/pull/5676">PR #5676</a>.</p>



<a name="325032589"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%235676%20Cranelift%3A%20Rewrite%20%60or%28and%28x%2C%20y%29%2C%20not.../near/325032589" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.235676.20Cranelift.3A.20Rewrite.20.60or.28and.28x.2C.20y.29.2C.20not.2E.2E.2E.html#325032589">(Jan 31 2023 at 22:44)</a>:</h4>
<p>fitzgen merged <a href="https://github.com/bytecodealliance/wasmtime/pull/5676">PR #5676</a>.</p>



<a name="325224081"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%235676%20Cranelift%3A%20Rewrite%20%60or%28and%28x%2C%20y%29%2C%20not.../near/325224081" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.235676.20Cranelift.3A.20Rewrite.20.60or.28and.28x.2C.20y.29.2C.20not.2E.2E.2E.html#325224081">(Feb 01 2023 at 17:34)</a>:</h4>
<p>avanhatt submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/5676#pullrequestreview-1279573762">PR review</a>.</p>



<a name="325224084"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%235676%20Cranelift%3A%20Rewrite%20%60or%28and%28x%2C%20y%29%2C%20not.../near/325224084" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.235676.20Cranelift.3A.20Rewrite.20.60or.28and.28x.2C.20y.29.2C.20not.2E.2E.2E.html#325224084">(Feb 01 2023 at 17:34)</a>:</h4>
<p>avanhatt created <a href="https://github.com/bytecodealliance/wasmtime/pull/5676#discussion_r1093535023">PR review comment</a>:</p>
<blockquote>
<p>Our verifier prototype finds the following counterexample for this rule (lightly edited for readability):</p>
<p><div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="n">simplify</span><span class="w"> </span><span class="p">(</span><span class="n">lhs</span><span class="p">)</span>:
#<span class="n">x0000000000000000</span><span class="w"></span>
#<span class="n">b0</span><span class="w"></span>

<span class="n">bor</span><span class="w"> </span><span class="p">(</span><span class="n">rhs</span><span class="p">)</span>:
#<span class="n">x0000000000000001</span><span class="w"></span>
#<span class="n">b1</span><span class="w"></span>

<span class="n">x</span>:
#<span class="n">x0000000000000001</span><span class="w"></span>
#<span class="n">b1</span><span class="w"></span>

<span class="n">y</span>:
#<span class="n">x0000000000000002</span><span class="w"></span>
#<span class="n">b10</span><span class="w"></span>

<span class="n">z</span>:
#<span class="n">x0000000000000000</span><span class="w"></span>
#<span class="n">b0</span><span class="w"></span>

<span class="n">zk</span>:
#<span class="n">x0000000000000000</span><span class="w"></span>
#<span class="n">b0</span><span class="w"></span>
</code></pre></div><br>
</p>
</blockquote>



<a name="325228487"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%235676%20Cranelift%3A%20Rewrite%20%60or%28and%28x%2C%20y%29%2C%20not.../near/325228487" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.235676.20Cranelift.3A.20Rewrite.20.60or.28and.28x.2C.20y.29.2C.20not.2E.2E.2E.html#325228487">(Feb 01 2023 at 17:53)</a>:</h4>
<p>fitzgen submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/5676#pullrequestreview-1279603598">PR review</a>.</p>



<a name="325228488"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%235676%20Cranelift%3A%20Rewrite%20%60or%28and%28x%2C%20y%29%2C%20not.../near/325228488" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.235676.20Cranelift.3A.20Rewrite.20.60or.28and.28x.2C.20y.29.2C.20not.2E.2E.2E.html#325228488">(Feb 01 2023 at 17:53)</a>:</h4>
<p>fitzgen created <a href="https://github.com/bytecodealliance/wasmtime/pull/5676#discussion_r1093555479">PR review comment</a>:</p>
<blockquote>
<p>I believe that this is because the <code>if</code> precondition is buggy. It is just checking whether the constructor succeeds or not, it is <em>not</em> checking if it returned <code>true</code>. Basically ignoring that predicate. (Funnily enough, because <code>u64_eq</code> is <code>pure</code>, the constructor will <em>always</em> succeed! This seems like something the ISLE compiler can check for and reject.) This is a pretty big foot gun with <code>if</code>, IMHO.</p>
<p>Anyways, the predicate needs to be rewritten as <code>(if-let $true ...)</code>.</p>
</blockquote>



<a name="325232664"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%235676%20Cranelift%3A%20Rewrite%20%60or%28and%28x%2C%20y%29%2C%20not.../near/325232664" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.235676.20Cranelift.3A.20Rewrite.20.60or.28and.28x.2C.20y.29.2C.20not.2E.2E.2E.html#325232664">(Feb 01 2023 at 18:10)</a>:</h4>
<p>jameysharp submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/5676#pullrequestreview-1279628377">PR review</a>.</p>



<a name="325232665"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%235676%20Cranelift%3A%20Rewrite%20%60or%28and%28x%2C%20y%29%2C%20not.../near/325232665" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.235676.20Cranelift.3A.20Rewrite.20.60or.28and.28x.2C.20y.29.2C.20not.2E.2E.2E.html#325232665">(Feb 01 2023 at 18:10)</a>:</h4>
<p>jameysharp created <a href="https://github.com/bytecodealliance/wasmtime/pull/5676#discussion_r1093571829">PR review comment</a>:</p>
<blockquote>
<p>That's so cool! I don't understand it but it's awesome. <span aria-label="laughing" class="emoji emoji-1f606" role="img" title="laughing">:laughing:</span> </p>
<p>Here's what's confusing me: The rule should only fire if <code>zk</code> is equal to <code>!y</code>. But in this counterexample, <code>y</code> is 2, so <code>u64_not y</code> is <code>0xfffffffffffffffd</code>, but <code>zk</code> is 0. Is the verifier missing the <code>if</code> condition? Or is <code>u64_not</code> modeled incorrectly, maybe? (It's supposed to be bitwise-not, but this counterexample would make sense if that were modeled as boolean-not, turning non-zero values into 0.)</p>
<p>Also, what type is this counterexample for? I'd be especially interested if you can find counterexamples for I64 specifically, because I think the rule as-written is wrong for any other width. That said, I'd expect other widths to just fail to match the rule most of the time, rather than ever rewriting incorrectly, so if you find a narrower counterexample it's probably a real issue.</p>
</blockquote>



<a name="325233642"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%235676%20Cranelift%3A%20Rewrite%20%60or%28and%28x%2C%20y%29%2C%20not.../near/325233642" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.235676.20Cranelift.3A.20Rewrite.20.60or.28and.28x.2C.20y.29.2C.20not.2E.2E.2E.html#325233642">(Feb 01 2023 at 18:15)</a>:</h4>
<p>jameysharp submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/5676#pullrequestreview-1279634008">PR review</a>.</p>



<a name="325233643"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%235676%20Cranelift%3A%20Rewrite%20%60or%28and%28x%2C%20y%29%2C%20not.../near/325233643" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.235676.20Cranelift.3A.20Rewrite.20.60or.28and.28x.2C.20y.29.2C.20not.2E.2E.2E.html#325233643">(Feb 01 2023 at 18:15)</a>:</h4>
<p>jameysharp created <a href="https://github.com/bytecodealliance/wasmtime/pull/5676#discussion_r1093575694">PR review comment</a>:</p>
<blockquote>
<p>Ohhh, Nick's got it right. Although it's because <code>u64_eq</code> is not <code>partial</code>, not because it's <code>pure</code>. (Those flags are independent now.)</p>
<p>We also need to mask both constants down to the appropriate width if we want to make the rule fire on &lt;64-bit types.</p>
</blockquote>



<a name="325234042"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%235676%20Cranelift%3A%20Rewrite%20%60or%28and%28x%2C%20y%29%2C%20not.../near/325234042" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.235676.20Cranelift.3A.20Rewrite.20.60or.28and.28x.2C.20y.29.2C.20not.2E.2E.2E.html#325234042">(Feb 01 2023 at 18:16)</a>:</h4>
<p>avanhatt created <a href="https://github.com/bytecodealliance/wasmtime/pull/5676#discussion_r1093577169">PR review comment</a>:</p>
<blockquote>
<p>To restate what @fitzgen realized:</p>
<p><code> (if (u64_eq zk (u64_not y)))</code> desugars to <code> (if-let _ (u64_eq zk (u64_not y)))</code>, which ISLE is perfectly happy to match on. That is, the semantics for <code>if</code> is whether some match is possible, _not_ whether the match is possible <em>and</em> its boolean value is truthy. The verifier matches these weird semantics, since it treats <code>if-let</code> statements as constraints setting the LHS and RHS of the statement to be equal---in this case, happily setting the wildcard to false and considering the rule to have matched. </p>
<p>Right now, this counterexample is for BVs of width 64, and the verifier is complaining that the rule is infeasible (that is, doesn't match) for other widths (which, based on your comment, seems correct?). </p>
</blockquote>



<a name="325234043"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%235676%20Cranelift%3A%20Rewrite%20%60or%28and%28x%2C%20y%29%2C%20not.../near/325234043" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.235676.20Cranelift.3A.20Rewrite.20.60or.28and.28x.2C.20y.29.2C.20not.2E.2E.2E.html#325234043">(Feb 01 2023 at 18:16)</a>:</h4>
<p>avanhatt submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/5676#pullrequestreview-1279636292">PR review</a>.</p>



<a name="325234504"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%235676%20Cranelift%3A%20Rewrite%20%60or%28and%28x%2C%20y%29%2C%20not.../near/325234504" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.235676.20Cranelift.3A.20Rewrite.20.60or.28and.28x.2C.20y.29.2C.20not.2E.2E.2E.html#325234504">(Feb 01 2023 at 18:19)</a>:</h4>
<p>avanhatt edited <a href="https://github.com/bytecodealliance/wasmtime/pull/5676#discussion_r1093577169">PR review comment</a>.</p>



<hr><p>Last updated: Jan 20 2025 at 06:04 UTC</p>
</html>