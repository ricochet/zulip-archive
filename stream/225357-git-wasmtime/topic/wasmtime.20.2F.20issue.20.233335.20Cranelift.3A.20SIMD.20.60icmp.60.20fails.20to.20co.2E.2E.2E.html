<html>
<head><meta charset="utf-8"><title>wasmtime / issue #3335 Cranelift: SIMD `icmp` fails to co... · git-wasmtime · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/index.html">git-wasmtime</a></h2>
<h3>Topic: <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.233335.20Cranelift.3A.20SIMD.20.60icmp.60.20fails.20to.20co.2E.2E.2E.html">wasmtime / issue #3335 Cranelift: SIMD `icmp` fails to co...</a></h3>

<hr>

<base href="https://bytecodealliance.zulipchat.com">

<head><link href="https://bytecodealliance.github.io/zulip-archive/style.css" rel="stylesheet"></head>

<a name="252921974"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%233335%20Cranelift%3A%20SIMD%20%60icmp%60%20fails%20to%20co.../near/252921974" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.233335.20Cranelift.3A.20SIMD.20.60icmp.60.20fails.20to.20co.2E.2E.2E.html#252921974">(Sep 11 2021 at 16:58)</a>:</h4>
<p>afonso360 labeled <a href="https://github.com/bytecodealliance/wasmtime/issues/3335">issue #3335</a>:</p>
<blockquote>
<p>Hey,</p>
<p>It looks like SIMD <code>icmp</code> is failing to compile on aarch64. We have a similar situation on #3334 for x64, but for different reasons. The test below is only for <code>icmp eq</code>, but this fails for any condition code.</p>
<h3><code>.clif</code> Test Case</h3>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="n">test</span><span class="w"> </span><span class="n">run</span><span class="w"></span>
<span class="n">target</span><span class="w"> </span><span class="n">aarch64</span><span class="w"></span>

<span class="n">function</span><span class="w"> </span><span class="o">%</span><span class="n">simd_icmp_eq_i8</span><span class="p">(</span><span class="n">i8x16</span><span class="p">,</span><span class="w"> </span><span class="n">i8x16</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nc">b8x16</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="n">block0</span><span class="p">(</span><span class="n">v0</span>: <span class="nc">i8x16</span><span class="p">,</span><span class="w"> </span><span class="n">v1</span>: <span class="nc">i8x16</span><span class="p">)</span>:
    <span class="nc">v2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">icmp</span><span class="w"> </span><span class="n">eq</span><span class="w"> </span><span class="n">v0</span><span class="p">,</span><span class="w"> </span><span class="n">v1</span><span class="w"></span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">v2</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
<span class="p">;</span><span class="w"> </span><span class="n">run</span>: <span class="o">%</span><span class="n">simd_icmp_eq_i8</span><span class="p">([</span><span class="mi">1</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="o">-</span><span class="mi">1</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="mi">1</span><span class="p">],</span><span class="w"> </span><span class="p">[</span><span class="mi">1</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="o">-</span><span class="mi">1</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="mi">0</span><span class="p">])</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="p">[</span><span class="kc">true</span><span class="w"> </span><span class="kc">true</span><span class="w"> </span><span class="kc">true</span><span class="w"> </span><span class="kc">false</span><span class="w"> </span><span class="kc">false</span><span class="w"> </span><span class="kc">false</span><span class="w"> </span><span class="kc">false</span><span class="w"> </span><span class="kc">false</span><span class="w"> </span><span class="kc">false</span><span class="w"> </span><span class="kc">false</span><span class="w"> </span><span class="kc">false</span><span class="w"> </span><span class="kc">false</span><span class="w"> </span><span class="kc">false</span><span class="w"> </span><span class="kc">false</span><span class="w"> </span><span class="kc">false</span><span class="w"> </span><span class="kc">false</span><span class="p">]</span><span class="w"></span>

<span class="n">function</span><span class="w"> </span><span class="o">%</span><span class="n">simd_icmp_eq_i16</span><span class="p">(</span><span class="n">i16x8</span><span class="p">,</span><span class="w"> </span><span class="n">i16x8</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nc">b16x8</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="n">block0</span><span class="p">(</span><span class="n">v0</span>: <span class="nc">i16x8</span><span class="p">,</span><span class="w"> </span><span class="n">v1</span>: <span class="nc">i16x8</span><span class="p">)</span>:
    <span class="nc">v2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">icmp</span><span class="w"> </span><span class="n">eq</span><span class="w"> </span><span class="n">v0</span><span class="p">,</span><span class="w"> </span><span class="n">v1</span><span class="w"></span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">v2</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
<span class="p">;</span><span class="w"> </span><span class="n">run</span>: <span class="o">%</span><span class="n">simd_icmp_eq_i16</span><span class="p">([</span><span class="mi">1</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="o">-</span><span class="mi">1</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="mi">1</span><span class="p">],</span><span class="w"> </span><span class="p">[</span><span class="mi">1</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="o">-</span><span class="mi">1</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="mi">0</span><span class="p">])</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="p">[</span><span class="kc">true</span><span class="w"> </span><span class="kc">true</span><span class="w"> </span><span class="kc">true</span><span class="w"> </span><span class="kc">false</span><span class="w"> </span><span class="kc">false</span><span class="w"> </span><span class="kc">false</span><span class="w"> </span><span class="kc">false</span><span class="w"> </span><span class="kc">false</span><span class="p">]</span><span class="w"></span>

<span class="n">function</span><span class="w"> </span><span class="o">%</span><span class="n">simd_icmp_eq_i32</span><span class="p">(</span><span class="n">i32x4</span><span class="p">,</span><span class="w"> </span><span class="n">i32x4</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nc">b32x4</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="n">block0</span><span class="p">(</span><span class="n">v0</span>: <span class="nc">i32x4</span><span class="p">,</span><span class="w"> </span><span class="n">v1</span>: <span class="nc">i32x4</span><span class="p">)</span>:
    <span class="nc">v2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">icmp</span><span class="w"> </span><span class="n">eq</span><span class="w"> </span><span class="n">v0</span><span class="p">,</span><span class="w"> </span><span class="n">v1</span><span class="w"></span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">v2</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
<span class="p">;</span><span class="w"> </span><span class="n">run</span>: <span class="o">%</span><span class="n">simd_icmp_eq_i32</span><span class="p">([</span><span class="mi">1</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="o">-</span><span class="mi">1</span><span class="w"> </span><span class="mi">1</span><span class="p">],</span><span class="w"> </span><span class="p">[</span><span class="mi">1</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="o">-</span><span class="mi">1</span><span class="w"> </span><span class="mi">0</span><span class="p">])</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="p">[</span><span class="kc">true</span><span class="w"> </span><span class="kc">true</span><span class="w"> </span><span class="kc">true</span><span class="w"> </span><span class="kc">false</span><span class="p">]</span><span class="w"></span>

<span class="n">function</span><span class="w"> </span><span class="o">%</span><span class="n">simd_icmp_eq_i64</span><span class="p">(</span><span class="n">i64x2</span><span class="p">,</span><span class="w"> </span><span class="n">i64x2</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nc">b64x2</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="n">block0</span><span class="p">(</span><span class="n">v0</span>: <span class="nc">i64x2</span><span class="p">,</span><span class="w"> </span><span class="n">v1</span>: <span class="nc">i64x2</span><span class="p">)</span>:
    <span class="nc">v2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">icmp</span><span class="w"> </span><span class="n">eq</span><span class="w"> </span><span class="n">v0</span><span class="p">,</span><span class="w"> </span><span class="n">v1</span><span class="w"></span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">v2</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
<span class="p">;</span><span class="w"> </span><span class="n">run</span>: <span class="o">%</span><span class="n">simd_icmp_eq_i64</span><span class="p">([</span><span class="mi">10</span><span class="w"> </span><span class="mi">0</span><span class="p">],</span><span class="w"> </span><span class="p">[</span><span class="mi">1</span><span class="w"> </span><span class="mi">0</span><span class="p">])</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="p">[</span><span class="kc">false</span><span class="w"> </span><span class="kc">true</span><span class="p">]</span><span class="w"></span>
<span class="p">;</span><span class="w"> </span><span class="n">run</span>: <span class="o">%</span><span class="n">simd_icmp_eq_i64</span><span class="p">([</span><span class="o">-</span><span class="mi">1</span><span class="w"> </span><span class="mi">1</span><span class="p">],</span><span class="w"> </span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="w"> </span><span class="mi">0</span><span class="p">])</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="p">[</span><span class="kc">true</span><span class="w"> </span><span class="kc">false</span><span class="p">]</span><span class="w"></span>
</code></pre></div>
<h3>Steps to Reproduce</h3>
<p><code>clif-util test ./the-above.clif</code></p>
<h3>Expected Results</h3>
<p>The test to pass</p>
<h3>Actual Results</h3>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="n">Running</span><span class="w"> </span><span class="err">`</span><span class="n">qemu</span><span class="o">-</span><span class="n">aarch64</span><span class="w"> </span><span class="o">-</span><span class="n">L</span><span class="w"> </span><span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">aarch64</span><span class="o">-</span><span class="n">linux</span><span class="o">-</span><span class="n">gnu</span><span class="w"> </span><span class="o">-</span><span class="n">E</span><span class="w"> </span><span class="n">LD_LIBRARY_PATH</span><span class="o">=/</span><span class="n">usr</span><span class="o">/</span><span class="n">aarch64</span><span class="o">-</span><span class="n">linux</span><span class="o">-</span><span class="n">gnu</span><span class="o">/</span><span class="n">lib</span><span class="w"> </span><span class="o">/</span><span class="n">mnt</span><span class="o">/</span><span class="n">c</span><span class="o">/</span><span class="n">Users</span><span class="o">/</span><span class="n">Afonso</span><span class="o">/</span><span class="n">CLionProjects</span><span class="o">/</span><span class="n">wasmtime</span><span class="o">/</span><span class="n">target</span><span class="o">/</span><span class="n">aarch64</span><span class="o">-</span><span class="n">unknown</span><span class="o">-</span><span class="n">linux</span><span class="o">-</span><span class="n">gnu</span><span class="o">/</span><span class="n">debug</span><span class="o">/</span><span class="n">clif</span><span class="o">-</span><span class="n">util</span><span class="w"> </span><span class="n">test</span><span class="w"> </span><span class="p">.</span><span class="o">/</span><span class="n">filetests</span><span class="o">/</span><span class="n">filetests</span><span class="o">/</span><span class="n">runtes</span><span class="w"></span>
<span class="n">ts</span><span class="o">/</span><span class="n">simd</span><span class="o">-</span><span class="n">icmp</span><span class="o">-</span><span class="n">eq</span><span class="p">.</span><span class="n">clif</span><span class="err">`</span><span class="w"></span>
<span class="n">thread</span><span class="w"> </span><span class="o">'</span><span class="na">worker</span><span class="w"> </span>#<span class="mi">0</span><span class="o">'</span><span class="w"> </span><span class="n">panicked</span><span class="w"> </span><span class="n">at</span><span class="w"> </span><span class="o">'</span><span class="na">assertion</span><span class="w"> </span><span class="n">failed</span>: <span class="err">`</span><span class="p">(</span><span class="n">left</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">right</span><span class="p">)</span><span class="err">`</span><span class="w"></span>
<span class="w">  </span><span class="n">left</span>: <span class="err">`</span><span class="n">V128</span><span class="err">`</span><span class="p">,</span><span class="w"></span>
<span class="w"> </span><span class="n">right</span>: <span class="err">`</span><span class="n">I64</span><span class="err">`</span><span class="o">'</span><span class="p">,</span><span class="w"> </span><span class="n">cranelift</span><span class="o">/</span><span class="n">codegen</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">isa</span><span class="o">/</span><span class="n">aarch64</span><span class="o">/</span><span class="n">inst</span><span class="o">/</span><span class="n">emit</span><span class="p">.</span><span class="n">rs</span>:<span class="mi">100</span>:<span class="mi">5</span><span class="w"></span>
<span class="n">note</span>: <span class="nc">run</span><span class="w"> </span><span class="n">with</span><span class="w"> </span><span class="err">`</span><span class="n">RUST_BACKTRACE</span><span class="o">=</span><span class="mi">1</span><span class="err">`</span><span class="w"> </span><span class="n">environment</span><span class="w"> </span><span class="n">variable</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">display</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="n">backtrace</span><span class="w"></span>
<span class="n">FAIL</span><span class="w"> </span><span class="p">.</span><span class="o">/</span><span class="n">filetests</span><span class="o">/</span><span class="n">filetests</span><span class="o">/</span><span class="n">runtests</span><span class="o">/</span><span class="n">simd</span><span class="o">-</span><span class="n">icmp</span><span class="o">-</span><span class="n">eq</span><span class="p">.</span><span class="n">clif</span>: <span class="nc">panicked</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="n">worker</span><span class="w"> </span>#<span class="mi">0</span>: <span class="nc">assertion</span><span class="w"> </span><span class="n">failed</span>: <span class="err">`</span><span class="p">(</span><span class="n">left</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">right</span><span class="p">)</span><span class="err">`</span><span class="w"></span>
<span class="w">  </span><span class="n">left</span>: <span class="err">`</span><span class="n">V128</span><span class="err">`</span><span class="p">,</span><span class="w"></span>
<span class="w"> </span><span class="n">right</span>: <span class="err">`</span><span class="n">I64</span><span class="err">`</span><span class="w"></span>
<span class="mi">1</span><span class="w"> </span><span class="n">tests</span><span class="w"></span>
<span class="n">Error</span>: <span class="mi">1</span><span class="w"> </span><span class="n">failure</span><span class="w"></span>
</code></pre></div>
<h3>Versions and Environment</h3>
<p>Cranelift version or commit: main<br>
Operating system: Linux<br>
Architecture: aarch64 QEMU</p>
<h3>Extra Info</h3>
<p>A <code>icmp</code> SIMD test suite was added in #3332<br>
</p>
</blockquote>



<a name="252921975"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%233335%20Cranelift%3A%20SIMD%20%60icmp%60%20fails%20to%20co.../near/252921975" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.233335.20Cranelift.3A.20SIMD.20.60icmp.60.20fails.20to.20co.2E.2E.2E.html#252921975">(Sep 11 2021 at 16:58)</a>:</h4>
<p>afonso360 opened <a href="https://github.com/bytecodealliance/wasmtime/issues/3335">issue #3335</a>:</p>
<blockquote>
<p>Hey,</p>
<p>It looks like SIMD <code>icmp</code> is failing to compile on aarch64. We have a similar situation on #3334 for x64, but for different reasons. The test below is only for <code>icmp eq</code>, but this fails for any condition code.</p>
<h3><code>.clif</code> Test Case</h3>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="n">test</span><span class="w"> </span><span class="n">run</span><span class="w"></span>
<span class="n">target</span><span class="w"> </span><span class="n">aarch64</span><span class="w"></span>

<span class="n">function</span><span class="w"> </span><span class="o">%</span><span class="n">simd_icmp_eq_i8</span><span class="p">(</span><span class="n">i8x16</span><span class="p">,</span><span class="w"> </span><span class="n">i8x16</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nc">b8x16</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="n">block0</span><span class="p">(</span><span class="n">v0</span>: <span class="nc">i8x16</span><span class="p">,</span><span class="w"> </span><span class="n">v1</span>: <span class="nc">i8x16</span><span class="p">)</span>:
    <span class="nc">v2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">icmp</span><span class="w"> </span><span class="n">eq</span><span class="w"> </span><span class="n">v0</span><span class="p">,</span><span class="w"> </span><span class="n">v1</span><span class="w"></span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">v2</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
<span class="p">;</span><span class="w"> </span><span class="n">run</span>: <span class="o">%</span><span class="n">simd_icmp_eq_i8</span><span class="p">([</span><span class="mi">1</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="o">-</span><span class="mi">1</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="mi">1</span><span class="p">],</span><span class="w"> </span><span class="p">[</span><span class="mi">1</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="o">-</span><span class="mi">1</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="mi">0</span><span class="p">])</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="p">[</span><span class="kc">true</span><span class="w"> </span><span class="kc">true</span><span class="w"> </span><span class="kc">true</span><span class="w"> </span><span class="kc">false</span><span class="w"> </span><span class="kc">false</span><span class="w"> </span><span class="kc">false</span><span class="w"> </span><span class="kc">false</span><span class="w"> </span><span class="kc">false</span><span class="w"> </span><span class="kc">false</span><span class="w"> </span><span class="kc">false</span><span class="w"> </span><span class="kc">false</span><span class="w"> </span><span class="kc">false</span><span class="w"> </span><span class="kc">false</span><span class="w"> </span><span class="kc">false</span><span class="w"> </span><span class="kc">false</span><span class="w"> </span><span class="kc">false</span><span class="p">]</span><span class="w"></span>

<span class="n">function</span><span class="w"> </span><span class="o">%</span><span class="n">simd_icmp_eq_i16</span><span class="p">(</span><span class="n">i16x8</span><span class="p">,</span><span class="w"> </span><span class="n">i16x8</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nc">b16x8</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="n">block0</span><span class="p">(</span><span class="n">v0</span>: <span class="nc">i16x8</span><span class="p">,</span><span class="w"> </span><span class="n">v1</span>: <span class="nc">i16x8</span><span class="p">)</span>:
    <span class="nc">v2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">icmp</span><span class="w"> </span><span class="n">eq</span><span class="w"> </span><span class="n">v0</span><span class="p">,</span><span class="w"> </span><span class="n">v1</span><span class="w"></span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">v2</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
<span class="p">;</span><span class="w"> </span><span class="n">run</span>: <span class="o">%</span><span class="n">simd_icmp_eq_i16</span><span class="p">([</span><span class="mi">1</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="o">-</span><span class="mi">1</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="mi">1</span><span class="p">],</span><span class="w"> </span><span class="p">[</span><span class="mi">1</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="o">-</span><span class="mi">1</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="mi">0</span><span class="p">])</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="p">[</span><span class="kc">true</span><span class="w"> </span><span class="kc">true</span><span class="w"> </span><span class="kc">true</span><span class="w"> </span><span class="kc">false</span><span class="w"> </span><span class="kc">false</span><span class="w"> </span><span class="kc">false</span><span class="w"> </span><span class="kc">false</span><span class="w"> </span><span class="kc">false</span><span class="p">]</span><span class="w"></span>

<span class="n">function</span><span class="w"> </span><span class="o">%</span><span class="n">simd_icmp_eq_i32</span><span class="p">(</span><span class="n">i32x4</span><span class="p">,</span><span class="w"> </span><span class="n">i32x4</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nc">b32x4</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="n">block0</span><span class="p">(</span><span class="n">v0</span>: <span class="nc">i32x4</span><span class="p">,</span><span class="w"> </span><span class="n">v1</span>: <span class="nc">i32x4</span><span class="p">)</span>:
    <span class="nc">v2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">icmp</span><span class="w"> </span><span class="n">eq</span><span class="w"> </span><span class="n">v0</span><span class="p">,</span><span class="w"> </span><span class="n">v1</span><span class="w"></span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">v2</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
<span class="p">;</span><span class="w"> </span><span class="n">run</span>: <span class="o">%</span><span class="n">simd_icmp_eq_i32</span><span class="p">([</span><span class="mi">1</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="o">-</span><span class="mi">1</span><span class="w"> </span><span class="mi">1</span><span class="p">],</span><span class="w"> </span><span class="p">[</span><span class="mi">1</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="o">-</span><span class="mi">1</span><span class="w"> </span><span class="mi">0</span><span class="p">])</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="p">[</span><span class="kc">true</span><span class="w"> </span><span class="kc">true</span><span class="w"> </span><span class="kc">true</span><span class="w"> </span><span class="kc">false</span><span class="p">]</span><span class="w"></span>

<span class="n">function</span><span class="w"> </span><span class="o">%</span><span class="n">simd_icmp_eq_i64</span><span class="p">(</span><span class="n">i64x2</span><span class="p">,</span><span class="w"> </span><span class="n">i64x2</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nc">b64x2</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="n">block0</span><span class="p">(</span><span class="n">v0</span>: <span class="nc">i64x2</span><span class="p">,</span><span class="w"> </span><span class="n">v1</span>: <span class="nc">i64x2</span><span class="p">)</span>:
    <span class="nc">v2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">icmp</span><span class="w"> </span><span class="n">eq</span><span class="w"> </span><span class="n">v0</span><span class="p">,</span><span class="w"> </span><span class="n">v1</span><span class="w"></span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">v2</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
<span class="p">;</span><span class="w"> </span><span class="n">run</span>: <span class="o">%</span><span class="n">simd_icmp_eq_i64</span><span class="p">([</span><span class="mi">10</span><span class="w"> </span><span class="mi">0</span><span class="p">],</span><span class="w"> </span><span class="p">[</span><span class="mi">1</span><span class="w"> </span><span class="mi">0</span><span class="p">])</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="p">[</span><span class="kc">false</span><span class="w"> </span><span class="kc">true</span><span class="p">]</span><span class="w"></span>
<span class="p">;</span><span class="w"> </span><span class="n">run</span>: <span class="o">%</span><span class="n">simd_icmp_eq_i64</span><span class="p">([</span><span class="o">-</span><span class="mi">1</span><span class="w"> </span><span class="mi">1</span><span class="p">],</span><span class="w"> </span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="w"> </span><span class="mi">0</span><span class="p">])</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="p">[</span><span class="kc">true</span><span class="w"> </span><span class="kc">false</span><span class="p">]</span><span class="w"></span>
</code></pre></div>
<h3>Steps to Reproduce</h3>
<p><code>clif-util test ./the-above.clif</code></p>
<h3>Expected Results</h3>
<p>The test to pass</p>
<h3>Actual Results</h3>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="n">Running</span><span class="w"> </span><span class="err">`</span><span class="n">qemu</span><span class="o">-</span><span class="n">aarch64</span><span class="w"> </span><span class="o">-</span><span class="n">L</span><span class="w"> </span><span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">aarch64</span><span class="o">-</span><span class="n">linux</span><span class="o">-</span><span class="n">gnu</span><span class="w"> </span><span class="o">-</span><span class="n">E</span><span class="w"> </span><span class="n">LD_LIBRARY_PATH</span><span class="o">=/</span><span class="n">usr</span><span class="o">/</span><span class="n">aarch64</span><span class="o">-</span><span class="n">linux</span><span class="o">-</span><span class="n">gnu</span><span class="o">/</span><span class="n">lib</span><span class="w"> </span><span class="o">/</span><span class="n">mnt</span><span class="o">/</span><span class="n">c</span><span class="o">/</span><span class="n">Users</span><span class="o">/</span><span class="n">Afonso</span><span class="o">/</span><span class="n">CLionProjects</span><span class="o">/</span><span class="n">wasmtime</span><span class="o">/</span><span class="n">target</span><span class="o">/</span><span class="n">aarch64</span><span class="o">-</span><span class="n">unknown</span><span class="o">-</span><span class="n">linux</span><span class="o">-</span><span class="n">gnu</span><span class="o">/</span><span class="n">debug</span><span class="o">/</span><span class="n">clif</span><span class="o">-</span><span class="n">util</span><span class="w"> </span><span class="n">test</span><span class="w"> </span><span class="p">.</span><span class="o">/</span><span class="n">filetests</span><span class="o">/</span><span class="n">filetests</span><span class="o">/</span><span class="n">runtes</span><span class="w"></span>
<span class="n">ts</span><span class="o">/</span><span class="n">simd</span><span class="o">-</span><span class="n">icmp</span><span class="o">-</span><span class="n">eq</span><span class="p">.</span><span class="n">clif</span><span class="err">`</span><span class="w"></span>
<span class="n">thread</span><span class="w"> </span><span class="o">'</span><span class="na">worker</span><span class="w"> </span>#<span class="mi">0</span><span class="o">'</span><span class="w"> </span><span class="n">panicked</span><span class="w"> </span><span class="n">at</span><span class="w"> </span><span class="o">'</span><span class="na">assertion</span><span class="w"> </span><span class="n">failed</span>: <span class="err">`</span><span class="p">(</span><span class="n">left</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">right</span><span class="p">)</span><span class="err">`</span><span class="w"></span>
<span class="w">  </span><span class="n">left</span>: <span class="err">`</span><span class="n">V128</span><span class="err">`</span><span class="p">,</span><span class="w"></span>
<span class="w"> </span><span class="n">right</span>: <span class="err">`</span><span class="n">I64</span><span class="err">`</span><span class="o">'</span><span class="p">,</span><span class="w"> </span><span class="n">cranelift</span><span class="o">/</span><span class="n">codegen</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">isa</span><span class="o">/</span><span class="n">aarch64</span><span class="o">/</span><span class="n">inst</span><span class="o">/</span><span class="n">emit</span><span class="p">.</span><span class="n">rs</span>:<span class="mi">100</span>:<span class="mi">5</span><span class="w"></span>
<span class="n">note</span>: <span class="nc">run</span><span class="w"> </span><span class="n">with</span><span class="w"> </span><span class="err">`</span><span class="n">RUST_BACKTRACE</span><span class="o">=</span><span class="mi">1</span><span class="err">`</span><span class="w"> </span><span class="n">environment</span><span class="w"> </span><span class="n">variable</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">display</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="n">backtrace</span><span class="w"></span>
<span class="n">FAIL</span><span class="w"> </span><span class="p">.</span><span class="o">/</span><span class="n">filetests</span><span class="o">/</span><span class="n">filetests</span><span class="o">/</span><span class="n">runtests</span><span class="o">/</span><span class="n">simd</span><span class="o">-</span><span class="n">icmp</span><span class="o">-</span><span class="n">eq</span><span class="p">.</span><span class="n">clif</span>: <span class="nc">panicked</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="n">worker</span><span class="w"> </span>#<span class="mi">0</span>: <span class="nc">assertion</span><span class="w"> </span><span class="n">failed</span>: <span class="err">`</span><span class="p">(</span><span class="n">left</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">right</span><span class="p">)</span><span class="err">`</span><span class="w"></span>
<span class="w">  </span><span class="n">left</span>: <span class="err">`</span><span class="n">V128</span><span class="err">`</span><span class="p">,</span><span class="w"></span>
<span class="w"> </span><span class="n">right</span>: <span class="err">`</span><span class="n">I64</span><span class="err">`</span><span class="w"></span>
<span class="mi">1</span><span class="w"> </span><span class="n">tests</span><span class="w"></span>
<span class="n">Error</span>: <span class="mi">1</span><span class="w"> </span><span class="n">failure</span><span class="w"></span>
</code></pre></div>
<h3>Versions and Environment</h3>
<p>Cranelift version or commit: main<br>
Operating system: Linux<br>
Architecture: aarch64 QEMU</p>
<h3>Extra Info</h3>
<p>A <code>icmp</code> SIMD test suite was added in #3332<br>
</p>
</blockquote>



<a name="252921976"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%233335%20Cranelift%3A%20SIMD%20%60icmp%60%20fails%20to%20co.../near/252921976" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.233335.20Cranelift.3A.20SIMD.20.60icmp.60.20fails.20to.20co.2E.2E.2E.html#252921976">(Sep 11 2021 at 16:58)</a>:</h4>
<p>afonso360 labeled <a href="https://github.com/bytecodealliance/wasmtime/issues/3335">issue #3335</a>:</p>
<blockquote>
<p>Hey,</p>
<p>It looks like SIMD <code>icmp</code> is failing to compile on aarch64. We have a similar situation on #3334 for x64, but for different reasons. The test below is only for <code>icmp eq</code>, but this fails for any condition code.</p>
<h3><code>.clif</code> Test Case</h3>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="n">test</span><span class="w"> </span><span class="n">run</span><span class="w"></span>
<span class="n">target</span><span class="w"> </span><span class="n">aarch64</span><span class="w"></span>

<span class="n">function</span><span class="w"> </span><span class="o">%</span><span class="n">simd_icmp_eq_i8</span><span class="p">(</span><span class="n">i8x16</span><span class="p">,</span><span class="w"> </span><span class="n">i8x16</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nc">b8x16</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="n">block0</span><span class="p">(</span><span class="n">v0</span>: <span class="nc">i8x16</span><span class="p">,</span><span class="w"> </span><span class="n">v1</span>: <span class="nc">i8x16</span><span class="p">)</span>:
    <span class="nc">v2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">icmp</span><span class="w"> </span><span class="n">eq</span><span class="w"> </span><span class="n">v0</span><span class="p">,</span><span class="w"> </span><span class="n">v1</span><span class="w"></span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">v2</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
<span class="p">;</span><span class="w"> </span><span class="n">run</span>: <span class="o">%</span><span class="n">simd_icmp_eq_i8</span><span class="p">([</span><span class="mi">1</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="o">-</span><span class="mi">1</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="mi">1</span><span class="p">],</span><span class="w"> </span><span class="p">[</span><span class="mi">1</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="o">-</span><span class="mi">1</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="mi">0</span><span class="p">])</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="p">[</span><span class="kc">true</span><span class="w"> </span><span class="kc">true</span><span class="w"> </span><span class="kc">true</span><span class="w"> </span><span class="kc">false</span><span class="w"> </span><span class="kc">false</span><span class="w"> </span><span class="kc">false</span><span class="w"> </span><span class="kc">false</span><span class="w"> </span><span class="kc">false</span><span class="w"> </span><span class="kc">false</span><span class="w"> </span><span class="kc">false</span><span class="w"> </span><span class="kc">false</span><span class="w"> </span><span class="kc">false</span><span class="w"> </span><span class="kc">false</span><span class="w"> </span><span class="kc">false</span><span class="w"> </span><span class="kc">false</span><span class="w"> </span><span class="kc">false</span><span class="p">]</span><span class="w"></span>

<span class="n">function</span><span class="w"> </span><span class="o">%</span><span class="n">simd_icmp_eq_i16</span><span class="p">(</span><span class="n">i16x8</span><span class="p">,</span><span class="w"> </span><span class="n">i16x8</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nc">b16x8</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="n">block0</span><span class="p">(</span><span class="n">v0</span>: <span class="nc">i16x8</span><span class="p">,</span><span class="w"> </span><span class="n">v1</span>: <span class="nc">i16x8</span><span class="p">)</span>:
    <span class="nc">v2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">icmp</span><span class="w"> </span><span class="n">eq</span><span class="w"> </span><span class="n">v0</span><span class="p">,</span><span class="w"> </span><span class="n">v1</span><span class="w"></span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">v2</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
<span class="p">;</span><span class="w"> </span><span class="n">run</span>: <span class="o">%</span><span class="n">simd_icmp_eq_i16</span><span class="p">([</span><span class="mi">1</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="o">-</span><span class="mi">1</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="mi">1</span><span class="p">],</span><span class="w"> </span><span class="p">[</span><span class="mi">1</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="o">-</span><span class="mi">1</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="mi">0</span><span class="p">])</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="p">[</span><span class="kc">true</span><span class="w"> </span><span class="kc">true</span><span class="w"> </span><span class="kc">true</span><span class="w"> </span><span class="kc">false</span><span class="w"> </span><span class="kc">false</span><span class="w"> </span><span class="kc">false</span><span class="w"> </span><span class="kc">false</span><span class="w"> </span><span class="kc">false</span><span class="p">]</span><span class="w"></span>

<span class="n">function</span><span class="w"> </span><span class="o">%</span><span class="n">simd_icmp_eq_i32</span><span class="p">(</span><span class="n">i32x4</span><span class="p">,</span><span class="w"> </span><span class="n">i32x4</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nc">b32x4</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="n">block0</span><span class="p">(</span><span class="n">v0</span>: <span class="nc">i32x4</span><span class="p">,</span><span class="w"> </span><span class="n">v1</span>: <span class="nc">i32x4</span><span class="p">)</span>:
    <span class="nc">v2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">icmp</span><span class="w"> </span><span class="n">eq</span><span class="w"> </span><span class="n">v0</span><span class="p">,</span><span class="w"> </span><span class="n">v1</span><span class="w"></span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">v2</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
<span class="p">;</span><span class="w"> </span><span class="n">run</span>: <span class="o">%</span><span class="n">simd_icmp_eq_i32</span><span class="p">([</span><span class="mi">1</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="o">-</span><span class="mi">1</span><span class="w"> </span><span class="mi">1</span><span class="p">],</span><span class="w"> </span><span class="p">[</span><span class="mi">1</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="o">-</span><span class="mi">1</span><span class="w"> </span><span class="mi">0</span><span class="p">])</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="p">[</span><span class="kc">true</span><span class="w"> </span><span class="kc">true</span><span class="w"> </span><span class="kc">true</span><span class="w"> </span><span class="kc">false</span><span class="p">]</span><span class="w"></span>

<span class="n">function</span><span class="w"> </span><span class="o">%</span><span class="n">simd_icmp_eq_i64</span><span class="p">(</span><span class="n">i64x2</span><span class="p">,</span><span class="w"> </span><span class="n">i64x2</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nc">b64x2</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="n">block0</span><span class="p">(</span><span class="n">v0</span>: <span class="nc">i64x2</span><span class="p">,</span><span class="w"> </span><span class="n">v1</span>: <span class="nc">i64x2</span><span class="p">)</span>:
    <span class="nc">v2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">icmp</span><span class="w"> </span><span class="n">eq</span><span class="w"> </span><span class="n">v0</span><span class="p">,</span><span class="w"> </span><span class="n">v1</span><span class="w"></span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">v2</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
<span class="p">;</span><span class="w"> </span><span class="n">run</span>: <span class="o">%</span><span class="n">simd_icmp_eq_i64</span><span class="p">([</span><span class="mi">10</span><span class="w"> </span><span class="mi">0</span><span class="p">],</span><span class="w"> </span><span class="p">[</span><span class="mi">1</span><span class="w"> </span><span class="mi">0</span><span class="p">])</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="p">[</span><span class="kc">false</span><span class="w"> </span><span class="kc">true</span><span class="p">]</span><span class="w"></span>
<span class="p">;</span><span class="w"> </span><span class="n">run</span>: <span class="o">%</span><span class="n">simd_icmp_eq_i64</span><span class="p">([</span><span class="o">-</span><span class="mi">1</span><span class="w"> </span><span class="mi">1</span><span class="p">],</span><span class="w"> </span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="w"> </span><span class="mi">0</span><span class="p">])</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="p">[</span><span class="kc">true</span><span class="w"> </span><span class="kc">false</span><span class="p">]</span><span class="w"></span>
</code></pre></div>
<h3>Steps to Reproduce</h3>
<p><code>clif-util test ./the-above.clif</code></p>
<h3>Expected Results</h3>
<p>The test to pass</p>
<h3>Actual Results</h3>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="n">Running</span><span class="w"> </span><span class="err">`</span><span class="n">qemu</span><span class="o">-</span><span class="n">aarch64</span><span class="w"> </span><span class="o">-</span><span class="n">L</span><span class="w"> </span><span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">aarch64</span><span class="o">-</span><span class="n">linux</span><span class="o">-</span><span class="n">gnu</span><span class="w"> </span><span class="o">-</span><span class="n">E</span><span class="w"> </span><span class="n">LD_LIBRARY_PATH</span><span class="o">=/</span><span class="n">usr</span><span class="o">/</span><span class="n">aarch64</span><span class="o">-</span><span class="n">linux</span><span class="o">-</span><span class="n">gnu</span><span class="o">/</span><span class="n">lib</span><span class="w"> </span><span class="o">/</span><span class="n">mnt</span><span class="o">/</span><span class="n">c</span><span class="o">/</span><span class="n">Users</span><span class="o">/</span><span class="n">Afonso</span><span class="o">/</span><span class="n">CLionProjects</span><span class="o">/</span><span class="n">wasmtime</span><span class="o">/</span><span class="n">target</span><span class="o">/</span><span class="n">aarch64</span><span class="o">-</span><span class="n">unknown</span><span class="o">-</span><span class="n">linux</span><span class="o">-</span><span class="n">gnu</span><span class="o">/</span><span class="n">debug</span><span class="o">/</span><span class="n">clif</span><span class="o">-</span><span class="n">util</span><span class="w"> </span><span class="n">test</span><span class="w"> </span><span class="p">.</span><span class="o">/</span><span class="n">filetests</span><span class="o">/</span><span class="n">filetests</span><span class="o">/</span><span class="n">runtes</span><span class="w"></span>
<span class="n">ts</span><span class="o">/</span><span class="n">simd</span><span class="o">-</span><span class="n">icmp</span><span class="o">-</span><span class="n">eq</span><span class="p">.</span><span class="n">clif</span><span class="err">`</span><span class="w"></span>
<span class="n">thread</span><span class="w"> </span><span class="o">'</span><span class="na">worker</span><span class="w"> </span>#<span class="mi">0</span><span class="o">'</span><span class="w"> </span><span class="n">panicked</span><span class="w"> </span><span class="n">at</span><span class="w"> </span><span class="o">'</span><span class="na">assertion</span><span class="w"> </span><span class="n">failed</span>: <span class="err">`</span><span class="p">(</span><span class="n">left</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">right</span><span class="p">)</span><span class="err">`</span><span class="w"></span>
<span class="w">  </span><span class="n">left</span>: <span class="err">`</span><span class="n">V128</span><span class="err">`</span><span class="p">,</span><span class="w"></span>
<span class="w"> </span><span class="n">right</span>: <span class="err">`</span><span class="n">I64</span><span class="err">`</span><span class="o">'</span><span class="p">,</span><span class="w"> </span><span class="n">cranelift</span><span class="o">/</span><span class="n">codegen</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">isa</span><span class="o">/</span><span class="n">aarch64</span><span class="o">/</span><span class="n">inst</span><span class="o">/</span><span class="n">emit</span><span class="p">.</span><span class="n">rs</span>:<span class="mi">100</span>:<span class="mi">5</span><span class="w"></span>
<span class="n">note</span>: <span class="nc">run</span><span class="w"> </span><span class="n">with</span><span class="w"> </span><span class="err">`</span><span class="n">RUST_BACKTRACE</span><span class="o">=</span><span class="mi">1</span><span class="err">`</span><span class="w"> </span><span class="n">environment</span><span class="w"> </span><span class="n">variable</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">display</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="n">backtrace</span><span class="w"></span>
<span class="n">FAIL</span><span class="w"> </span><span class="p">.</span><span class="o">/</span><span class="n">filetests</span><span class="o">/</span><span class="n">filetests</span><span class="o">/</span><span class="n">runtests</span><span class="o">/</span><span class="n">simd</span><span class="o">-</span><span class="n">icmp</span><span class="o">-</span><span class="n">eq</span><span class="p">.</span><span class="n">clif</span>: <span class="nc">panicked</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="n">worker</span><span class="w"> </span>#<span class="mi">0</span>: <span class="nc">assertion</span><span class="w"> </span><span class="n">failed</span>: <span class="err">`</span><span class="p">(</span><span class="n">left</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">right</span><span class="p">)</span><span class="err">`</span><span class="w"></span>
<span class="w">  </span><span class="n">left</span>: <span class="err">`</span><span class="n">V128</span><span class="err">`</span><span class="p">,</span><span class="w"></span>
<span class="w"> </span><span class="n">right</span>: <span class="err">`</span><span class="n">I64</span><span class="err">`</span><span class="w"></span>
<span class="mi">1</span><span class="w"> </span><span class="n">tests</span><span class="w"></span>
<span class="n">Error</span>: <span class="mi">1</span><span class="w"> </span><span class="n">failure</span><span class="w"></span>
</code></pre></div>
<h3>Versions and Environment</h3>
<p>Cranelift version or commit: main<br>
Operating system: Linux<br>
Architecture: aarch64 QEMU</p>
<h3>Extra Info</h3>
<p>A <code>icmp</code> SIMD test suite was added in #3332<br>
</p>
</blockquote>



<a name="253064211"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%233335%20Cranelift%3A%20SIMD%20%60icmp%60%20fails%20to%20co.../near/253064211" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.233335.20Cranelift.3A.20SIMD.20.60icmp.60.20fails.20to.20co.2E.2E.2E.html#253064211">(Sep 13 2021 at 10:00)</a>:</h4>
<p>akirilov-arm labeled <a href="https://github.com/bytecodealliance/wasmtime/issues/3335">issue #3335</a>:</p>
<blockquote>
<p>Hey,</p>
<p>It looks like SIMD <code>icmp</code> is failing to compile on aarch64. We have a similar situation on #3334 for x64, but for different reasons. The test below is only for <code>icmp eq</code>, but this fails for any condition code.</p>
<h3><code>.clif</code> Test Case</h3>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="n">test</span><span class="w"> </span><span class="n">run</span><span class="w"></span>
<span class="n">target</span><span class="w"> </span><span class="n">aarch64</span><span class="w"></span>

<span class="n">function</span><span class="w"> </span><span class="o">%</span><span class="n">simd_icmp_eq_i8</span><span class="p">(</span><span class="n">i8x16</span><span class="p">,</span><span class="w"> </span><span class="n">i8x16</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nc">b8x16</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="n">block0</span><span class="p">(</span><span class="n">v0</span>: <span class="nc">i8x16</span><span class="p">,</span><span class="w"> </span><span class="n">v1</span>: <span class="nc">i8x16</span><span class="p">)</span>:
    <span class="nc">v2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">icmp</span><span class="w"> </span><span class="n">eq</span><span class="w"> </span><span class="n">v0</span><span class="p">,</span><span class="w"> </span><span class="n">v1</span><span class="w"></span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">v2</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
<span class="p">;</span><span class="w"> </span><span class="n">run</span>: <span class="o">%</span><span class="n">simd_icmp_eq_i8</span><span class="p">([</span><span class="mi">1</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="o">-</span><span class="mi">1</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="mi">1</span><span class="p">],</span><span class="w"> </span><span class="p">[</span><span class="mi">1</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="o">-</span><span class="mi">1</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="mi">0</span><span class="p">])</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="p">[</span><span class="kc">true</span><span class="w"> </span><span class="kc">true</span><span class="w"> </span><span class="kc">true</span><span class="w"> </span><span class="kc">false</span><span class="w"> </span><span class="kc">false</span><span class="w"> </span><span class="kc">false</span><span class="w"> </span><span class="kc">false</span><span class="w"> </span><span class="kc">false</span><span class="w"> </span><span class="kc">false</span><span class="w"> </span><span class="kc">false</span><span class="w"> </span><span class="kc">false</span><span class="w"> </span><span class="kc">false</span><span class="w"> </span><span class="kc">false</span><span class="w"> </span><span class="kc">false</span><span class="w"> </span><span class="kc">false</span><span class="w"> </span><span class="kc">false</span><span class="p">]</span><span class="w"></span>

<span class="n">function</span><span class="w"> </span><span class="o">%</span><span class="n">simd_icmp_eq_i16</span><span class="p">(</span><span class="n">i16x8</span><span class="p">,</span><span class="w"> </span><span class="n">i16x8</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nc">b16x8</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="n">block0</span><span class="p">(</span><span class="n">v0</span>: <span class="nc">i16x8</span><span class="p">,</span><span class="w"> </span><span class="n">v1</span>: <span class="nc">i16x8</span><span class="p">)</span>:
    <span class="nc">v2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">icmp</span><span class="w"> </span><span class="n">eq</span><span class="w"> </span><span class="n">v0</span><span class="p">,</span><span class="w"> </span><span class="n">v1</span><span class="w"></span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">v2</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
<span class="p">;</span><span class="w"> </span><span class="n">run</span>: <span class="o">%</span><span class="n">simd_icmp_eq_i16</span><span class="p">([</span><span class="mi">1</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="o">-</span><span class="mi">1</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="mi">1</span><span class="p">],</span><span class="w"> </span><span class="p">[</span><span class="mi">1</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="o">-</span><span class="mi">1</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="mi">0</span><span class="p">])</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="p">[</span><span class="kc">true</span><span class="w"> </span><span class="kc">true</span><span class="w"> </span><span class="kc">true</span><span class="w"> </span><span class="kc">false</span><span class="w"> </span><span class="kc">false</span><span class="w"> </span><span class="kc">false</span><span class="w"> </span><span class="kc">false</span><span class="w"> </span><span class="kc">false</span><span class="p">]</span><span class="w"></span>

<span class="n">function</span><span class="w"> </span><span class="o">%</span><span class="n">simd_icmp_eq_i32</span><span class="p">(</span><span class="n">i32x4</span><span class="p">,</span><span class="w"> </span><span class="n">i32x4</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nc">b32x4</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="n">block0</span><span class="p">(</span><span class="n">v0</span>: <span class="nc">i32x4</span><span class="p">,</span><span class="w"> </span><span class="n">v1</span>: <span class="nc">i32x4</span><span class="p">)</span>:
    <span class="nc">v2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">icmp</span><span class="w"> </span><span class="n">eq</span><span class="w"> </span><span class="n">v0</span><span class="p">,</span><span class="w"> </span><span class="n">v1</span><span class="w"></span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">v2</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
<span class="p">;</span><span class="w"> </span><span class="n">run</span>: <span class="o">%</span><span class="n">simd_icmp_eq_i32</span><span class="p">([</span><span class="mi">1</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="o">-</span><span class="mi">1</span><span class="w"> </span><span class="mi">1</span><span class="p">],</span><span class="w"> </span><span class="p">[</span><span class="mi">1</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="o">-</span><span class="mi">1</span><span class="w"> </span><span class="mi">0</span><span class="p">])</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="p">[</span><span class="kc">true</span><span class="w"> </span><span class="kc">true</span><span class="w"> </span><span class="kc">true</span><span class="w"> </span><span class="kc">false</span><span class="p">]</span><span class="w"></span>

<span class="n">function</span><span class="w"> </span><span class="o">%</span><span class="n">simd_icmp_eq_i64</span><span class="p">(</span><span class="n">i64x2</span><span class="p">,</span><span class="w"> </span><span class="n">i64x2</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nc">b64x2</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="n">block0</span><span class="p">(</span><span class="n">v0</span>: <span class="nc">i64x2</span><span class="p">,</span><span class="w"> </span><span class="n">v1</span>: <span class="nc">i64x2</span><span class="p">)</span>:
    <span class="nc">v2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">icmp</span><span class="w"> </span><span class="n">eq</span><span class="w"> </span><span class="n">v0</span><span class="p">,</span><span class="w"> </span><span class="n">v1</span><span class="w"></span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">v2</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
<span class="p">;</span><span class="w"> </span><span class="n">run</span>: <span class="o">%</span><span class="n">simd_icmp_eq_i64</span><span class="p">([</span><span class="mi">10</span><span class="w"> </span><span class="mi">0</span><span class="p">],</span><span class="w"> </span><span class="p">[</span><span class="mi">1</span><span class="w"> </span><span class="mi">0</span><span class="p">])</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="p">[</span><span class="kc">false</span><span class="w"> </span><span class="kc">true</span><span class="p">]</span><span class="w"></span>
<span class="p">;</span><span class="w"> </span><span class="n">run</span>: <span class="o">%</span><span class="n">simd_icmp_eq_i64</span><span class="p">([</span><span class="o">-</span><span class="mi">1</span><span class="w"> </span><span class="mi">1</span><span class="p">],</span><span class="w"> </span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="w"> </span><span class="mi">0</span><span class="p">])</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="p">[</span><span class="kc">true</span><span class="w"> </span><span class="kc">false</span><span class="p">]</span><span class="w"></span>
</code></pre></div>
<h3>Steps to Reproduce</h3>
<p><code>clif-util test ./the-above.clif</code></p>
<h3>Expected Results</h3>
<p>The test to pass</p>
<h3>Actual Results</h3>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="n">Running</span><span class="w"> </span><span class="err">`</span><span class="n">qemu</span><span class="o">-</span><span class="n">aarch64</span><span class="w"> </span><span class="o">-</span><span class="n">L</span><span class="w"> </span><span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">aarch64</span><span class="o">-</span><span class="n">linux</span><span class="o">-</span><span class="n">gnu</span><span class="w"> </span><span class="o">-</span><span class="n">E</span><span class="w"> </span><span class="n">LD_LIBRARY_PATH</span><span class="o">=/</span><span class="n">usr</span><span class="o">/</span><span class="n">aarch64</span><span class="o">-</span><span class="n">linux</span><span class="o">-</span><span class="n">gnu</span><span class="o">/</span><span class="n">lib</span><span class="w"> </span><span class="o">/</span><span class="n">mnt</span><span class="o">/</span><span class="n">c</span><span class="o">/</span><span class="n">Users</span><span class="o">/</span><span class="n">Afonso</span><span class="o">/</span><span class="n">CLionProjects</span><span class="o">/</span><span class="n">wasmtime</span><span class="o">/</span><span class="n">target</span><span class="o">/</span><span class="n">aarch64</span><span class="o">-</span><span class="n">unknown</span><span class="o">-</span><span class="n">linux</span><span class="o">-</span><span class="n">gnu</span><span class="o">/</span><span class="n">debug</span><span class="o">/</span><span class="n">clif</span><span class="o">-</span><span class="n">util</span><span class="w"> </span><span class="n">test</span><span class="w"> </span><span class="p">.</span><span class="o">/</span><span class="n">filetests</span><span class="o">/</span><span class="n">filetests</span><span class="o">/</span><span class="n">runtes</span><span class="w"></span>
<span class="n">ts</span><span class="o">/</span><span class="n">simd</span><span class="o">-</span><span class="n">icmp</span><span class="o">-</span><span class="n">eq</span><span class="p">.</span><span class="n">clif</span><span class="err">`</span><span class="w"></span>
<span class="n">thread</span><span class="w"> </span><span class="o">'</span><span class="na">worker</span><span class="w"> </span>#<span class="mi">0</span><span class="o">'</span><span class="w"> </span><span class="n">panicked</span><span class="w"> </span><span class="n">at</span><span class="w"> </span><span class="o">'</span><span class="na">assertion</span><span class="w"> </span><span class="n">failed</span>: <span class="err">`</span><span class="p">(</span><span class="n">left</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">right</span><span class="p">)</span><span class="err">`</span><span class="w"></span>
<span class="w">  </span><span class="n">left</span>: <span class="err">`</span><span class="n">V128</span><span class="err">`</span><span class="p">,</span><span class="w"></span>
<span class="w"> </span><span class="n">right</span>: <span class="err">`</span><span class="n">I64</span><span class="err">`</span><span class="o">'</span><span class="p">,</span><span class="w"> </span><span class="n">cranelift</span><span class="o">/</span><span class="n">codegen</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">isa</span><span class="o">/</span><span class="n">aarch64</span><span class="o">/</span><span class="n">inst</span><span class="o">/</span><span class="n">emit</span><span class="p">.</span><span class="n">rs</span>:<span class="mi">100</span>:<span class="mi">5</span><span class="w"></span>
<span class="n">note</span>: <span class="nc">run</span><span class="w"> </span><span class="n">with</span><span class="w"> </span><span class="err">`</span><span class="n">RUST_BACKTRACE</span><span class="o">=</span><span class="mi">1</span><span class="err">`</span><span class="w"> </span><span class="n">environment</span><span class="w"> </span><span class="n">variable</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">display</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="n">backtrace</span><span class="w"></span>
<span class="n">FAIL</span><span class="w"> </span><span class="p">.</span><span class="o">/</span><span class="n">filetests</span><span class="o">/</span><span class="n">filetests</span><span class="o">/</span><span class="n">runtests</span><span class="o">/</span><span class="n">simd</span><span class="o">-</span><span class="n">icmp</span><span class="o">-</span><span class="n">eq</span><span class="p">.</span><span class="n">clif</span>: <span class="nc">panicked</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="n">worker</span><span class="w"> </span>#<span class="mi">0</span>: <span class="nc">assertion</span><span class="w"> </span><span class="n">failed</span>: <span class="err">`</span><span class="p">(</span><span class="n">left</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">right</span><span class="p">)</span><span class="err">`</span><span class="w"></span>
<span class="w">  </span><span class="n">left</span>: <span class="err">`</span><span class="n">V128</span><span class="err">`</span><span class="p">,</span><span class="w"></span>
<span class="w"> </span><span class="n">right</span>: <span class="err">`</span><span class="n">I64</span><span class="err">`</span><span class="w"></span>
<span class="mi">1</span><span class="w"> </span><span class="n">tests</span><span class="w"></span>
<span class="n">Error</span>: <span class="mi">1</span><span class="w"> </span><span class="n">failure</span><span class="w"></span>
</code></pre></div>
<h3>Versions and Environment</h3>
<p>Cranelift version or commit: main<br>
Operating system: Linux<br>
Architecture: aarch64 QEMU</p>
<h3>Extra Info</h3>
<p>A <code>icmp</code> SIMD test suite was added in #3332<br>
</p>
</blockquote>



<a name="253080858"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%233335%20Cranelift%3A%20SIMD%20%60icmp%60%20fails%20to%20co.../near/253080858" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.233335.20Cranelift.3A.20SIMD.20.60icmp.60.20fails.20to.20co.2E.2E.2E.html#253080858">(Sep 13 2021 at 12:30)</a>:</h4>
<p>akirilov-arm <a href="https://github.com/bytecodealliance/wasmtime/issues/3335#issuecomment-918143401">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/3335">issue #3335</a>:</p>
<blockquote>
<p>This issue looks weird because <code>clif-util compile --target arm64</code> with the same test case succeeds and the generated code looks fine. Is the problem in some layer above the backend that assumes that the <code>Icmp</code> result is a scalar integer?</p>
</blockquote>



<a name="253081422"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%233335%20Cranelift%3A%20SIMD%20%60icmp%60%20fails%20to%20co.../near/253081422" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.233335.20Cranelift.3A.20SIMD.20.60icmp.60.20fails.20to.20co.2E.2E.2E.html#253081422">(Sep 13 2021 at 12:34)</a>:</h4>
<p>bjorn3 <a href="https://github.com/bytecodealliance/wasmtime/issues/3335#issuecomment-918146735">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/3335">issue #3335</a>:</p>
<blockquote>
<p>Could this issue be during compilation the generated run wrapper instead of the test function itself?</p>
</blockquote>



<a name="253084586"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%233335%20Cranelift%3A%20SIMD%20%60icmp%60%20fails%20to%20co.../near/253084586" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.233335.20Cranelift.3A.20SIMD.20.60icmp.60.20fails.20to.20co.2E.2E.2E.html#253084586">(Sep 13 2021 at 12:58)</a>:</h4>
<p>afonso360 <a href="https://github.com/bytecodealliance/wasmtime/issues/3335#issuecomment-918163632">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/3335">issue #3335</a>:</p>
<blockquote>
<p>Yes, it looks like this is an issue with the generated trampoline. It looks like in the run test machinery we compile the source function ok, but then fail when compiling the trampoline.</p>
<p>We're generating the following trampoline (this is for x86_64, but i suspect the issue is the same for aarch64):</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="n">function</span><span class="w"> </span><span class="n">u0</span>:<span class="mi">0</span><span class="p">(</span><span class="kt">i64</span><span class="p">,</span><span class="w"> </span><span class="kt">i64</span><span class="p">)</span><span class="w"> </span><span class="n">windows_fastcall</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">sig0</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">i64x2</span><span class="p">,</span><span class="w"> </span><span class="n">i64x2</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nc">b64x2</span><span class="w"> </span><span class="n">windows_fastcall</span><span class="w"></span>

<span class="n">block0</span><span class="p">(</span><span class="n">v0</span>: <span class="kt">i64</span><span class="p">,</span><span class="w"> </span><span class="n">v1</span>: <span class="kt">i64</span><span class="p">)</span>:
    <span class="nc">v2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">load</span><span class="p">.</span><span class="n">i64x2</span><span class="w"> </span><span class="n">notrap</span><span class="w"> </span><span class="n">aligned</span><span class="w"> </span><span class="n">v1</span><span class="w"></span>
<span class="w">    </span><span class="n">v3</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">load</span><span class="p">.</span><span class="n">i64x2</span><span class="w"> </span><span class="n">notrap</span><span class="w"> </span><span class="n">aligned</span><span class="w"> </span><span class="n">v1</span><span class="o">+</span><span class="mi">16</span><span class="w"></span>
<span class="w">    </span><span class="n">v4</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">call_indirect</span><span class="w"> </span><span class="n">sig0</span><span class="p">,</span><span class="w"> </span><span class="n">v0</span><span class="p">(</span><span class="n">v2</span><span class="p">,</span><span class="w"> </span><span class="n">v3</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="n">v5</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">bint</span><span class="p">.</span><span class="kt">i64</span><span class="w"> </span><span class="n">v4</span><span class="w"></span>
<span class="w">    </span><span class="n">store</span><span class="w"> </span><span class="n">notrap</span><span class="w"> </span><span class="n">aligned</span><span class="w"> </span><span class="n">v5</span><span class="p">,</span><span class="w"> </span><span class="n">v1</span><span class="w"></span>
<span class="w">    </span><span class="k">return</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>
<p>I'm going to dig a bit further into this.</p>
</blockquote>



<a name="253084613"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%233335%20Cranelift%3A%20SIMD%20%60icmp%60%20fails%20to%20co.../near/253084613" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.233335.20Cranelift.3A.20SIMD.20.60icmp.60.20fails.20to.20co.2E.2E.2E.html#253084613">(Sep 13 2021 at 12:58)</a>:</h4>
<p>afonso360 edited a <a href="https://github.com/bytecodealliance/wasmtime/issues/3335#issuecomment-918163632">comment</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/3335">issue #3335</a>:</p>
<blockquote>
<p>Yes, it looks like this is an issue with the generated trampoline. It looks like in the run test machinery we compile the source function ok, but then fail when compiling the trampoline.</p>
<p>We're generating the following trampoline, which fails to compile (this is for x86_64, but i suspect the issue is the same for aarch64):</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="n">function</span><span class="w"> </span><span class="n">u0</span>:<span class="mi">0</span><span class="p">(</span><span class="kt">i64</span><span class="p">,</span><span class="w"> </span><span class="kt">i64</span><span class="p">)</span><span class="w"> </span><span class="n">windows_fastcall</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">sig0</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">i64x2</span><span class="p">,</span><span class="w"> </span><span class="n">i64x2</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nc">b64x2</span><span class="w"> </span><span class="n">windows_fastcall</span><span class="w"></span>

<span class="n">block0</span><span class="p">(</span><span class="n">v0</span>: <span class="kt">i64</span><span class="p">,</span><span class="w"> </span><span class="n">v1</span>: <span class="kt">i64</span><span class="p">)</span>:
    <span class="nc">v2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">load</span><span class="p">.</span><span class="n">i64x2</span><span class="w"> </span><span class="n">notrap</span><span class="w"> </span><span class="n">aligned</span><span class="w"> </span><span class="n">v1</span><span class="w"></span>
<span class="w">    </span><span class="n">v3</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">load</span><span class="p">.</span><span class="n">i64x2</span><span class="w"> </span><span class="n">notrap</span><span class="w"> </span><span class="n">aligned</span><span class="w"> </span><span class="n">v1</span><span class="o">+</span><span class="mi">16</span><span class="w"></span>
<span class="w">    </span><span class="n">v4</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">call_indirect</span><span class="w"> </span><span class="n">sig0</span><span class="p">,</span><span class="w"> </span><span class="n">v0</span><span class="p">(</span><span class="n">v2</span><span class="p">,</span><span class="w"> </span><span class="n">v3</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="n">v5</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">bint</span><span class="p">.</span><span class="kt">i64</span><span class="w"> </span><span class="n">v4</span><span class="w"></span>
<span class="w">    </span><span class="n">store</span><span class="w"> </span><span class="n">notrap</span><span class="w"> </span><span class="n">aligned</span><span class="w"> </span><span class="n">v5</span><span class="p">,</span><span class="w"> </span><span class="n">v1</span><span class="w"></span>
<span class="w">    </span><span class="k">return</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>
<p>I'm going to dig a bit further into this.</p>
</blockquote>



<a name="253085383"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%233335%20Cranelift%3A%20SIMD%20%60icmp%60%20fails%20to%20co.../near/253085383" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.233335.20Cranelift.3A.20SIMD.20.60icmp.60.20fails.20to.20co.2E.2E.2E.html#253085383">(Sep 13 2021 at 13:03)</a>:</h4>
<p>akirilov-arm <a href="https://github.com/bytecodealliance/wasmtime/issues/3335#issuecomment-918168180">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/3335">issue #3335</a>:</p>
<blockquote>
<p>The <code>Bint</code> operation doesn't make sense because <code>Bint</code> can't convert from vector to scalar - the backends are right to complain.</p>
</blockquote>



<a name="253088328"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%233335%20Cranelift%3A%20SIMD%20%60icmp%60%20fails%20to%20co.../near/253088328" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.233335.20Cranelift.3A.20SIMD.20.60icmp.60.20fails.20to.20co.2E.2E.2E.html#253088328">(Sep 13 2021 at 13:24)</a>:</h4>
<p>afonso360 <a href="https://github.com/bytecodealliance/wasmtime/issues/3335#issuecomment-918187251">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/3335">issue #3335</a>:</p>
<blockquote>
<blockquote>
<p>The Bint operation doesn't make sense because Bint can't convert from vector to scalar - the backends are right to complain.</p>
</blockquote>
<p>That's true, however this should probably be a verifier error. <code>bint</code> vector to scalar shouldn't be an accepted instruction.</p>
<p>Setting the correct type for <code>bint</code> doesen't fix the issue, since it isn't implemented for aarch64 (for simd values), but we can work around this by <code>raw_bitcast</code>'ing it into the appropriate integer type.</p>
<p>I'll open a PR with this. Thanks for looking into this, I didn't realize it wasn't a backend issue.</p>
</blockquote>



<a name="253090264"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%233335%20Cranelift%3A%20SIMD%20%60icmp%60%20fails%20to%20co.../near/253090264" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.233335.20Cranelift.3A.20SIMD.20.60icmp.60.20fails.20to.20co.2E.2E.2E.html#253090264">(Sep 13 2021 at 13:37)</a>:</h4>
<p>akirilov-arm <a href="https://github.com/bytecodealliance/wasmtime/issues/3335#issuecomment-918199524">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/3335">issue #3335</a>:</p>
<blockquote>
<blockquote>
<p>... we can work around this by <code>raw_bitcast</code>'ing it into the appropriate integer type.</p>
</blockquote>
<p>No, that's wrong (but it's probably going to work) - I don't think we agreed in #3205 to change the representation of vector booleans. This would be an appropriate work-around for <code>Bmask</code> (but then we have #1429).</p>
</blockquote>



<a name="319632477"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%233335%20Cranelift%3A%20SIMD%20%60icmp%60%20fails%20to%20co.../near/319632477" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.233335.20Cranelift.3A.20SIMD.20.60icmp.60.20fails.20to.20co.2E.2E.2E.html#319632477">(Jan 05 2023 at 17:19)</a>:</h4>
<p>elliottt closed <a href="https://github.com/bytecodealliance/wasmtime/issues/3335">issue #3335</a>:</p>
<blockquote>
<p>Hey,</p>
<p>It looks like SIMD <code>icmp</code> is failing to compile on aarch64. We have a similar situation on #3334 for x64, but for different reasons. The test below is only for <code>icmp eq</code>, but this fails for any condition code.</p>
<h3><code>.clif</code> Test Case</h3>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="n">test</span><span class="w"> </span><span class="n">run</span><span class="w"></span>
<span class="n">target</span><span class="w"> </span><span class="n">aarch64</span><span class="w"></span>

<span class="n">function</span><span class="w"> </span><span class="o">%</span><span class="n">simd_icmp_eq_i8</span><span class="p">(</span><span class="n">i8x16</span><span class="p">,</span><span class="w"> </span><span class="n">i8x16</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nc">b8x16</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="n">block0</span><span class="p">(</span><span class="n">v0</span>: <span class="nc">i8x16</span><span class="p">,</span><span class="w"> </span><span class="n">v1</span>: <span class="nc">i8x16</span><span class="p">)</span>:
    <span class="nc">v2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">icmp</span><span class="w"> </span><span class="n">eq</span><span class="w"> </span><span class="n">v0</span><span class="p">,</span><span class="w"> </span><span class="n">v1</span><span class="w"></span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">v2</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
<span class="p">;</span><span class="w"> </span><span class="n">run</span>: <span class="o">%</span><span class="n">simd_icmp_eq_i8</span><span class="p">([</span><span class="mi">1</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="o">-</span><span class="mi">1</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="mi">1</span><span class="p">],</span><span class="w"> </span><span class="p">[</span><span class="mi">1</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="o">-</span><span class="mi">1</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="mi">0</span><span class="p">])</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="p">[</span><span class="kc">true</span><span class="w"> </span><span class="kc">true</span><span class="w"> </span><span class="kc">true</span><span class="w"> </span><span class="kc">false</span><span class="w"> </span><span class="kc">false</span><span class="w"> </span><span class="kc">false</span><span class="w"> </span><span class="kc">false</span><span class="w"> </span><span class="kc">false</span><span class="w"> </span><span class="kc">false</span><span class="w"> </span><span class="kc">false</span><span class="w"> </span><span class="kc">false</span><span class="w"> </span><span class="kc">false</span><span class="w"> </span><span class="kc">false</span><span class="w"> </span><span class="kc">false</span><span class="w"> </span><span class="kc">false</span><span class="w"> </span><span class="kc">false</span><span class="p">]</span><span class="w"></span>

<span class="n">function</span><span class="w"> </span><span class="o">%</span><span class="n">simd_icmp_eq_i16</span><span class="p">(</span><span class="n">i16x8</span><span class="p">,</span><span class="w"> </span><span class="n">i16x8</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nc">b16x8</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="n">block0</span><span class="p">(</span><span class="n">v0</span>: <span class="nc">i16x8</span><span class="p">,</span><span class="w"> </span><span class="n">v1</span>: <span class="nc">i16x8</span><span class="p">)</span>:
    <span class="nc">v2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">icmp</span><span class="w"> </span><span class="n">eq</span><span class="w"> </span><span class="n">v0</span><span class="p">,</span><span class="w"> </span><span class="n">v1</span><span class="w"></span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">v2</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
<span class="p">;</span><span class="w"> </span><span class="n">run</span>: <span class="o">%</span><span class="n">simd_icmp_eq_i16</span><span class="p">([</span><span class="mi">1</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="o">-</span><span class="mi">1</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="mi">1</span><span class="p">],</span><span class="w"> </span><span class="p">[</span><span class="mi">1</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="o">-</span><span class="mi">1</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="mi">0</span><span class="p">])</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="p">[</span><span class="kc">true</span><span class="w"> </span><span class="kc">true</span><span class="w"> </span><span class="kc">true</span><span class="w"> </span><span class="kc">false</span><span class="w"> </span><span class="kc">false</span><span class="w"> </span><span class="kc">false</span><span class="w"> </span><span class="kc">false</span><span class="w"> </span><span class="kc">false</span><span class="p">]</span><span class="w"></span>

<span class="n">function</span><span class="w"> </span><span class="o">%</span><span class="n">simd_icmp_eq_i32</span><span class="p">(</span><span class="n">i32x4</span><span class="p">,</span><span class="w"> </span><span class="n">i32x4</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nc">b32x4</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="n">block0</span><span class="p">(</span><span class="n">v0</span>: <span class="nc">i32x4</span><span class="p">,</span><span class="w"> </span><span class="n">v1</span>: <span class="nc">i32x4</span><span class="p">)</span>:
    <span class="nc">v2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">icmp</span><span class="w"> </span><span class="n">eq</span><span class="w"> </span><span class="n">v0</span><span class="p">,</span><span class="w"> </span><span class="n">v1</span><span class="w"></span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">v2</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
<span class="p">;</span><span class="w"> </span><span class="n">run</span>: <span class="o">%</span><span class="n">simd_icmp_eq_i32</span><span class="p">([</span><span class="mi">1</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="o">-</span><span class="mi">1</span><span class="w"> </span><span class="mi">1</span><span class="p">],</span><span class="w"> </span><span class="p">[</span><span class="mi">1</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="o">-</span><span class="mi">1</span><span class="w"> </span><span class="mi">0</span><span class="p">])</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="p">[</span><span class="kc">true</span><span class="w"> </span><span class="kc">true</span><span class="w"> </span><span class="kc">true</span><span class="w"> </span><span class="kc">false</span><span class="p">]</span><span class="w"></span>

<span class="n">function</span><span class="w"> </span><span class="o">%</span><span class="n">simd_icmp_eq_i64</span><span class="p">(</span><span class="n">i64x2</span><span class="p">,</span><span class="w"> </span><span class="n">i64x2</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nc">b64x2</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="n">block0</span><span class="p">(</span><span class="n">v0</span>: <span class="nc">i64x2</span><span class="p">,</span><span class="w"> </span><span class="n">v1</span>: <span class="nc">i64x2</span><span class="p">)</span>:
    <span class="nc">v2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">icmp</span><span class="w"> </span><span class="n">eq</span><span class="w"> </span><span class="n">v0</span><span class="p">,</span><span class="w"> </span><span class="n">v1</span><span class="w"></span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">v2</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
<span class="p">;</span><span class="w"> </span><span class="n">run</span>: <span class="o">%</span><span class="n">simd_icmp_eq_i64</span><span class="p">([</span><span class="mi">10</span><span class="w"> </span><span class="mi">0</span><span class="p">],</span><span class="w"> </span><span class="p">[</span><span class="mi">1</span><span class="w"> </span><span class="mi">0</span><span class="p">])</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="p">[</span><span class="kc">false</span><span class="w"> </span><span class="kc">true</span><span class="p">]</span><span class="w"></span>
<span class="p">;</span><span class="w"> </span><span class="n">run</span>: <span class="o">%</span><span class="n">simd_icmp_eq_i64</span><span class="p">([</span><span class="o">-</span><span class="mi">1</span><span class="w"> </span><span class="mi">1</span><span class="p">],</span><span class="w"> </span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="w"> </span><span class="mi">0</span><span class="p">])</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="p">[</span><span class="kc">true</span><span class="w"> </span><span class="kc">false</span><span class="p">]</span><span class="w"></span>
</code></pre></div>
<h3>Steps to Reproduce</h3>
<p><code>clif-util test ./the-above.clif</code></p>
<h3>Expected Results</h3>
<p>The test to pass</p>
<h3>Actual Results</h3>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="n">Running</span><span class="w"> </span><span class="err">`</span><span class="n">qemu</span><span class="o">-</span><span class="n">aarch64</span><span class="w"> </span><span class="o">-</span><span class="n">L</span><span class="w"> </span><span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">aarch64</span><span class="o">-</span><span class="n">linux</span><span class="o">-</span><span class="n">gnu</span><span class="w"> </span><span class="o">-</span><span class="n">E</span><span class="w"> </span><span class="n">LD_LIBRARY_PATH</span><span class="o">=/</span><span class="n">usr</span><span class="o">/</span><span class="n">aarch64</span><span class="o">-</span><span class="n">linux</span><span class="o">-</span><span class="n">gnu</span><span class="o">/</span><span class="n">lib</span><span class="w"> </span><span class="o">/</span><span class="n">mnt</span><span class="o">/</span><span class="n">c</span><span class="o">/</span><span class="n">Users</span><span class="o">/</span><span class="n">Afonso</span><span class="o">/</span><span class="n">CLionProjects</span><span class="o">/</span><span class="n">wasmtime</span><span class="o">/</span><span class="n">target</span><span class="o">/</span><span class="n">aarch64</span><span class="o">-</span><span class="n">unknown</span><span class="o">-</span><span class="n">linux</span><span class="o">-</span><span class="n">gnu</span><span class="o">/</span><span class="n">debug</span><span class="o">/</span><span class="n">clif</span><span class="o">-</span><span class="n">util</span><span class="w"> </span><span class="n">test</span><span class="w"> </span><span class="p">.</span><span class="o">/</span><span class="n">filetests</span><span class="o">/</span><span class="n">filetests</span><span class="o">/</span><span class="n">runtes</span><span class="w"></span>
<span class="n">ts</span><span class="o">/</span><span class="n">simd</span><span class="o">-</span><span class="n">icmp</span><span class="o">-</span><span class="n">eq</span><span class="p">.</span><span class="n">clif</span><span class="err">`</span><span class="w"></span>
<span class="n">thread</span><span class="w"> </span><span class="o">'</span><span class="na">worker</span><span class="w"> </span>#<span class="mi">0</span><span class="o">'</span><span class="w"> </span><span class="n">panicked</span><span class="w"> </span><span class="n">at</span><span class="w"> </span><span class="o">'</span><span class="na">assertion</span><span class="w"> </span><span class="n">failed</span>: <span class="err">`</span><span class="p">(</span><span class="n">left</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">right</span><span class="p">)</span><span class="err">`</span><span class="w"></span>
<span class="w">  </span><span class="n">left</span>: <span class="err">`</span><span class="n">V128</span><span class="err">`</span><span class="p">,</span><span class="w"></span>
<span class="w"> </span><span class="n">right</span>: <span class="err">`</span><span class="n">I64</span><span class="err">`</span><span class="o">'</span><span class="p">,</span><span class="w"> </span><span class="n">cranelift</span><span class="o">/</span><span class="n">codegen</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">isa</span><span class="o">/</span><span class="n">aarch64</span><span class="o">/</span><span class="n">inst</span><span class="o">/</span><span class="n">emit</span><span class="p">.</span><span class="n">rs</span>:<span class="mi">100</span>:<span class="mi">5</span><span class="w"></span>
<span class="n">note</span>: <span class="nc">run</span><span class="w"> </span><span class="n">with</span><span class="w"> </span><span class="err">`</span><span class="n">RUST_BACKTRACE</span><span class="o">=</span><span class="mi">1</span><span class="err">`</span><span class="w"> </span><span class="n">environment</span><span class="w"> </span><span class="n">variable</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">display</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="n">backtrace</span><span class="w"></span>
<span class="n">FAIL</span><span class="w"> </span><span class="p">.</span><span class="o">/</span><span class="n">filetests</span><span class="o">/</span><span class="n">filetests</span><span class="o">/</span><span class="n">runtests</span><span class="o">/</span><span class="n">simd</span><span class="o">-</span><span class="n">icmp</span><span class="o">-</span><span class="n">eq</span><span class="p">.</span><span class="n">clif</span>: <span class="nc">panicked</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="n">worker</span><span class="w"> </span>#<span class="mi">0</span>: <span class="nc">assertion</span><span class="w"> </span><span class="n">failed</span>: <span class="err">`</span><span class="p">(</span><span class="n">left</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">right</span><span class="p">)</span><span class="err">`</span><span class="w"></span>
<span class="w">  </span><span class="n">left</span>: <span class="err">`</span><span class="n">V128</span><span class="err">`</span><span class="p">,</span><span class="w"></span>
<span class="w"> </span><span class="n">right</span>: <span class="err">`</span><span class="n">I64</span><span class="err">`</span><span class="w"></span>
<span class="mi">1</span><span class="w"> </span><span class="n">tests</span><span class="w"></span>
<span class="n">Error</span>: <span class="mi">1</span><span class="w"> </span><span class="n">failure</span><span class="w"></span>
</code></pre></div>
<h3>Versions and Environment</h3>
<p>Cranelift version or commit: main<br>
Operating system: Linux<br>
Architecture: aarch64 QEMU</p>
<h3>Extra Info</h3>
<p>A <code>icmp</code> SIMD test suite was added in #3332<br>
</p>
</blockquote>



<hr><p>Last updated: Jan 20 2025 at 06:04 UTC</p>
</html>