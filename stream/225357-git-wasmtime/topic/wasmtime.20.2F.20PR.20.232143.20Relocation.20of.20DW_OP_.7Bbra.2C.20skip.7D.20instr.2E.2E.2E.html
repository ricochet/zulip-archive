<html>
<head><meta charset="utf-8"><title>wasmtime / PR #2143 Relocation of DW_OP_{bra, skip} instr... · git-wasmtime · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/index.html">git-wasmtime</a></h2>
<h3>Topic: <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232143.20Relocation.20of.20DW_OP_.7Bbra.2C.20skip.7D.20instr.2E.2E.2E.html">wasmtime / PR #2143 Relocation of DW_OP_{bra, skip} instr...</a></h3>

<hr>

<base href="https://bytecodealliance.zulipchat.com">

<head><link href="https://bytecodealliance.github.io/zulip-archive/style.css" rel="stylesheet"></head>

<a name="207382040"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232143%20Relocation%20of%20DW_OP_%7Bbra%2C%20skip%7D%20instr.../near/207382040" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232143.20Relocation.20of.20DW_OP_.7Bbra.2C.20skip.7D.20instr.2E.2E.2E.html#207382040">(Aug 19 2020 at 08:30)</a>:</h4>
<p>ggreif opened <a href="https://github.com/bytecodealliance/wasmtime/pull/2143">PR #2143</a> from <code>main</code> to <code>main</code>:</p>
<blockquote>
<p>&lt;!--</p>
<p>Please ensure that the following steps are all taken care of before submitting<br>
the PR.</p>
<ul>
<li>
<p>[ ] This has been discussed in issue #..., or if not, please tell us why<br>
  here.</p>
</li>
<li>
<p>[ ] A short description of what this does, why it is needed; if the<br>
  description becomes long, the matter should probably be discussed in an issue<br>
  first.</p>
</li>
<li>
<p>[ ] This PR contains test cases, if meaningful.</p>
</li>
<li>[ ] A reviewer from the core maintainer team has been assigned for this PR.<br>
  If you don't know who could review this, please indicate so. The list of<br>
  suggested reviewers on the right can help you.</li>
</ul>
<p>Please ensure all communication adheres to the <a href="https://github.com/bytecodealliance/wasmtime/blob/master/CODE_OF_CONDUCT.md">code of
conduct</a>.<br>
--&gt;</p>
</blockquote>



<a name="207382089"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232143%20Relocation%20of%20DW_OP_%7Bbra%2C%20skip%7D%20instr.../near/207382089" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232143.20Relocation.20of.20DW_OP_.7Bbra.2C.20skip.7D.20instr.2E.2E.2E.html#207382089">(Aug 19 2020 at 08:31)</a>:</h4>
<p>ggreif edited <a href="https://github.com/bytecodealliance/wasmtime/pull/2143">PR #2143</a> from <code>main</code> to <code>main</code>:</p>
<blockquote>
<p>Please don't look just yet.</p>
<p>&lt;!--</p>
<p>Please ensure that the following steps are all taken care of before submitting<br>
the PR.</p>
<ul>
<li>
<p>[ ] This has been discussed in issue #..., or if not, please tell us why<br>
  here.</p>
</li>
<li>
<p>[ ] A short description of what this does, why it is needed; if the<br>
  description becomes long, the matter should probably be discussed in an issue<br>
  first.</p>
</li>
<li>
<p>[ ] This PR contains test cases, if meaningful.</p>
</li>
<li>[ ] A reviewer from the core maintainer team has been assigned for this PR.<br>
  If you don't know who could review this, please indicate so. The list of<br>
  suggested reviewers on the right can help you.</li>
</ul>
<p>Please ensure all communication adheres to the <a href="https://github.com/bytecodealliance/wasmtime/blob/master/CODE_OF_CONDUCT.md">code of
conduct</a>.<br>
--&gt;</p>
</blockquote>



<a name="207385394"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232143%20Relocation%20of%20DW_OP_%7Bbra%2C%20skip%7D%20instr.../near/207385394" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232143.20Relocation.20of.20DW_OP_.7Bbra.2C.20skip.7D.20instr.2E.2E.2E.html#207385394">(Aug 19 2020 at 09:13)</a>:</h4>
<p>ggreif updated <a href="https://github.com/bytecodealliance/wasmtime/pull/2143">PR #2143</a> from <code>main</code> to <code>main</code>:</p>
<blockquote>
<p>Please don't look just yet.</p>
<p>&lt;!--</p>
<p>Please ensure that the following steps are all taken care of before submitting<br>
the PR.</p>
<ul>
<li>
<p>[ ] This has been discussed in issue #..., or if not, please tell us why<br>
  here.</p>
</li>
<li>
<p>[ ] A short description of what this does, why it is needed; if the<br>
  description becomes long, the matter should probably be discussed in an issue<br>
  first.</p>
</li>
<li>
<p>[ ] This PR contains test cases, if meaningful.</p>
</li>
<li>[ ] A reviewer from the core maintainer team has been assigned for this PR.<br>
  If you don't know who could review this, please indicate so. The list of<br>
  suggested reviewers on the right can help you.</li>
</ul>
<p>Please ensure all communication adheres to the <a href="https://github.com/bytecodealliance/wasmtime/blob/master/CODE_OF_CONDUCT.md">code of
conduct</a>.<br>
--&gt;</p>
</blockquote>



<a name="207387751"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232143%20Relocation%20of%20DW_OP_%7Bbra%2C%20skip%7D%20instr.../near/207387751" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232143.20Relocation.20of.20DW_OP_.7Bbra.2C.20skip.7D.20instr.2E.2E.2E.html#207387751">(Aug 19 2020 at 09:44)</a>:</h4>
<p>ggreif updated <a href="https://github.com/bytecodealliance/wasmtime/pull/2143">PR #2143</a> from <code>main</code> to <code>main</code>:</p>
<blockquote>
<p>Please don't look just yet.</p>
<p>&lt;!--</p>
<p>Please ensure that the following steps are all taken care of before submitting<br>
the PR.</p>
<ul>
<li>
<p>[ ] This has been discussed in issue #..., or if not, please tell us why<br>
  here.</p>
</li>
<li>
<p>[ ] A short description of what this does, why it is needed; if the<br>
  description becomes long, the matter should probably be discussed in an issue<br>
  first.</p>
</li>
<li>
<p>[ ] This PR contains test cases, if meaningful.</p>
</li>
<li>[ ] A reviewer from the core maintainer team has been assigned for this PR.<br>
  If you don't know who could review this, please indicate so. The list of<br>
  suggested reviewers on the right can help you.</li>
</ul>
<p>Please ensure all communication adheres to the <a href="https://github.com/bytecodealliance/wasmtime/blob/master/CODE_OF_CONDUCT.md">code of
conduct</a>.<br>
--&gt;</p>
</blockquote>



<a name="207392410"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232143%20Relocation%20of%20DW_OP_%7Bbra%2C%20skip%7D%20instr.../near/207392410" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232143.20Relocation.20of.20DW_OP_.7Bbra.2C.20skip.7D.20instr.2E.2E.2E.html#207392410">(Aug 19 2020 at 10:40)</a>:</h4>
<p>ggreif updated <a href="https://github.com/bytecodealliance/wasmtime/pull/2143">PR #2143</a> from <code>main</code> to <code>main</code>:</p>
<blockquote>
<p>Please don't look just yet.</p>
<p>&lt;!--</p>
<p>Please ensure that the following steps are all taken care of before submitting<br>
the PR.</p>
<ul>
<li>
<p>[ ] This has been discussed in issue #..., or if not, please tell us why<br>
  here.</p>
</li>
<li>
<p>[ ] A short description of what this does, why it is needed; if the<br>
  description becomes long, the matter should probably be discussed in an issue<br>
  first.</p>
</li>
<li>
<p>[ ] This PR contains test cases, if meaningful.</p>
</li>
<li>[ ] A reviewer from the core maintainer team has been assigned for this PR.<br>
  If you don't know who could review this, please indicate so. The list of<br>
  suggested reviewers on the right can help you.</li>
</ul>
<p>Please ensure all communication adheres to the <a href="https://github.com/bytecodealliance/wasmtime/blob/master/CODE_OF_CONDUCT.md">code of
conduct</a>.<br>
--&gt;</p>
</blockquote>



<a name="207393834"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232143%20Relocation%20of%20DW_OP_%7Bbra%2C%20skip%7D%20instr.../near/207393834" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232143.20Relocation.20of.20DW_OP_.7Bbra.2C.20skip.7D.20instr.2E.2E.2E.html#207393834">(Aug 19 2020 at 10:58)</a>:</h4>
<p>ggreif updated <a href="https://github.com/bytecodealliance/wasmtime/pull/2143">PR #2143</a> from <code>main</code> to <code>main</code>:</p>
<blockquote>
<p>Please don't look just yet.</p>
<p>&lt;!--</p>
<p>Please ensure that the following steps are all taken care of before submitting<br>
the PR.</p>
<ul>
<li>
<p>[ ] This has been discussed in issue #..., or if not, please tell us why<br>
  here.</p>
</li>
<li>
<p>[ ] A short description of what this does, why it is needed; if the<br>
  description becomes long, the matter should probably be discussed in an issue<br>
  first.</p>
</li>
<li>
<p>[ ] This PR contains test cases, if meaningful.</p>
</li>
<li>[ ] A reviewer from the core maintainer team has been assigned for this PR.<br>
  If you don't know who could review this, please indicate so. The list of<br>
  suggested reviewers on the right can help you.</li>
</ul>
<p>Please ensure all communication adheres to the <a href="https://github.com/bytecodealliance/wasmtime/blob/master/CODE_OF_CONDUCT.md">code of
conduct</a>.<br>
--&gt;</p>
</blockquote>



<a name="207405979"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232143%20Relocation%20of%20DW_OP_%7Bbra%2C%20skip%7D%20instr.../near/207405979" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232143.20Relocation.20of.20DW_OP_.7Bbra.2C.20skip.7D.20instr.2E.2E.2E.html#207405979">(Aug 19 2020 at 13:19)</a>:</h4>
<p>ggreif submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/2143#pullrequestreview-470448004">PR Review</a>.</p>



<a name="207405980"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232143%20Relocation%20of%20DW_OP_%7Bbra%2C%20skip%7D%20instr.../near/207405980" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232143.20Relocation.20of.20DW_OP_.7Bbra.2C.20skip.7D.20instr.2E.2E.2E.html#207405980">(Aug 19 2020 at 13:19)</a>:</h4>
<p>ggreif created <a href="https://github.com/bytecodealliance/wasmtime/pull/2143#discussion_r473022488">PR Review Comment</a>:</p>
<blockquote>
<p><code>target</code> is informational only, never used</p>
</blockquote>



<a name="207406435"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232143%20Relocation%20of%20DW_OP_%7Bbra%2C%20skip%7D%20instr.../near/207406435" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232143.20Relocation.20of.20DW_OP_.7Bbra.2C.20skip.7D.20instr.2E.2E.2E.html#207406435">(Aug 19 2020 at 13:22)</a>:</h4>
<p>ggreif updated <a href="https://github.com/bytecodealliance/wasmtime/pull/2143">PR #2143</a> from <code>main</code> to <code>main</code>:</p>
<blockquote>
<p>Please don't look just yet.</p>
<p>&lt;!--</p>
<p>Please ensure that the following steps are all taken care of before submitting<br>
the PR.</p>
<ul>
<li>
<p>[ ] This has been discussed in issue #..., or if not, please tell us why<br>
  here.</p>
</li>
<li>
<p>[ ] A short description of what this does, why it is needed; if the<br>
  description becomes long, the matter should probably be discussed in an issue<br>
  first.</p>
</li>
<li>
<p>[ ] This PR contains test cases, if meaningful.</p>
</li>
<li>[ ] A reviewer from the core maintainer team has been assigned for this PR.<br>
  If you don't know who could review this, please indicate so. The list of<br>
  suggested reviewers on the right can help you.</li>
</ul>
<p>Please ensure all communication adheres to the <a href="https://github.com/bytecodealliance/wasmtime/blob/master/CODE_OF_CONDUCT.md">code of
conduct</a>.<br>
--&gt;</p>
</blockquote>



<a name="207410132"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232143%20Relocation%20of%20DW_OP_%7Bbra%2C%20skip%7D%20instr.../near/207410132" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232143.20Relocation.20of.20DW_OP_.7Bbra.2C.20skip.7D.20instr.2E.2E.2E.html#207410132">(Aug 19 2020 at 13:51)</a>:</h4>
<p>ggreif submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/2143#pullrequestreview-470478096">PR Review</a>.</p>



<a name="207410133"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232143%20Relocation%20of%20DW_OP_%7Bbra%2C%20skip%7D%20instr.../near/207410133" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232143.20Relocation.20of.20DW_OP_.7Bbra.2C.20skip.7D.20instr.2E.2E.2E.html#207410133">(Aug 19 2020 at 13:51)</a>:</h4>
<p>ggreif created <a href="https://github.com/bytecodealliance/wasmtime/pull/2143#discussion_r473045269">PR Review Comment</a>:</p>
<blockquote>
<p>This is hard-coded to be little-endian for now.</p>
</blockquote>



<a name="207427049"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232143%20Relocation%20of%20DW_OP_%7Bbra%2C%20skip%7D%20instr.../near/207427049" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232143.20Relocation.20of.20DW_OP_.7Bbra.2C.20skip.7D.20instr.2E.2E.2E.html#207427049">(Aug 19 2020 at 16:02)</a>:</h4>
<p>ggreif updated <a href="https://github.com/bytecodealliance/wasmtime/pull/2143">PR #2143</a> from <code>main</code> to <code>main</code>:</p>
<blockquote>
<p>Please don't look just yet.</p>
<p>&lt;!--</p>
<p>Please ensure that the following steps are all taken care of before submitting<br>
the PR.</p>
<ul>
<li>
<p>[ ] This has been discussed in issue #..., or if not, please tell us why<br>
  here.</p>
</li>
<li>
<p>[ ] A short description of what this does, why it is needed; if the<br>
  description becomes long, the matter should probably be discussed in an issue<br>
  first.</p>
</li>
<li>
<p>[ ] This PR contains test cases, if meaningful.</p>
</li>
<li>[ ] A reviewer from the core maintainer team has been assigned for this PR.<br>
  If you don't know who could review this, please indicate so. The list of<br>
  suggested reviewers on the right can help you.</li>
</ul>
<p>Please ensure all communication adheres to the <a href="https://github.com/bytecodealliance/wasmtime/blob/master/CODE_OF_CONDUCT.md">code of
conduct</a>.<br>
--&gt;</p>
</blockquote>



<a name="207465531"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232143%20Relocation%20of%20DW_OP_%7Bbra%2C%20skip%7D%20instr.../near/207465531" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232143.20Relocation.20of.20DW_OP_.7Bbra.2C.20skip.7D.20instr.2E.2E.2E.html#207465531">(Aug 19 2020 at 21:49)</a>:</h4>
<p>ggreif edited <a href="https://github.com/bytecodealliance/wasmtime/pull/2143">PR #2143</a> from <code>main</code> to <code>main</code>:</p>
<blockquote>
<p>Please don't look just yet.</p>
<p>Progress:</p>
<ul>
<li>relocation of branch edges works</li>
<li>open problem: the <code>need_deref</code> flag. What when different branches want to set the flag differently?</li>
</ul>
<p>&lt;!--</p>
<p>Please ensure that the following steps are all taken care of before submitting<br>
the PR.</p>
<ul>
<li>
<p>[ ] This has been discussed in issue #..., or if not, please tell us why<br>
  here.</p>
</li>
<li>
<p>[ ] A short description of what this does, why it is needed; if the<br>
  description becomes long, the matter should probably be discussed in an issue<br>
  first.</p>
</li>
<li>
<p>[ ] This PR contains test cases, if meaningful.</p>
</li>
<li>[ ] A reviewer from the core maintainer team has been assigned for this PR.<br>
  If you don't know who could review this, please indicate so. The list of<br>
  suggested reviewers on the right can help you.</li>
</ul>
<p>Please ensure all communication adheres to the <a href="https://github.com/bytecodealliance/wasmtime/blob/master/CODE_OF_CONDUCT.md">code of
conduct</a>.<br>
--&gt;</p>
</blockquote>



<a name="207550334"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232143%20Relocation%20of%20DW_OP_%7Bbra%2C%20skip%7D%20instr.../near/207550334" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232143.20Relocation.20of.20DW_OP_.7Bbra.2C.20skip.7D.20instr.2E.2E.2E.html#207550334">(Aug 20 2020 at 17:29)</a>:</h4>
<p>ggreif updated <a href="https://github.com/bytecodealliance/wasmtime/pull/2143">PR #2143</a> from <code>main</code> to <code>main</code>:</p>
<blockquote>
<p>Please don't look just yet.</p>
<p>Progress:</p>
<ul>
<li>relocation of branch edges works</li>
<li>open problem: the <code>need_deref</code> flag. What when different branches want to set the flag differently?</li>
</ul>
<p>&lt;!--</p>
<p>Please ensure that the following steps are all taken care of before submitting<br>
the PR.</p>
<ul>
<li>
<p>[ ] This has been discussed in issue #..., or if not, please tell us why<br>
  here.</p>
</li>
<li>
<p>[ ] A short description of what this does, why it is needed; if the<br>
  description becomes long, the matter should probably be discussed in an issue<br>
  first.</p>
</li>
<li>
<p>[ ] This PR contains test cases, if meaningful.</p>
</li>
<li>[ ] A reviewer from the core maintainer team has been assigned for this PR.<br>
  If you don't know who could review this, please indicate so. The list of<br>
  suggested reviewers on the right can help you.</li>
</ul>
<p>Please ensure all communication adheres to the <a href="https://github.com/bytecodealliance/wasmtime/blob/master/CODE_OF_CONDUCT.md">code of
conduct</a>.<br>
--&gt;</p>
</blockquote>



<a name="207550541"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232143%20Relocation%20of%20DW_OP_%7Bbra%2C%20skip%7D%20instr.../near/207550541" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232143.20Relocation.20of.20DW_OP_.7Bbra.2C.20skip.7D.20instr.2E.2E.2E.html#207550541">(Aug 20 2020 at 17:30)</a>:</h4>
<p>ggreif submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/2143#pullrequestreview-471836101">PR Review</a>.</p>



<a name="207550542"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232143%20Relocation%20of%20DW_OP_%7Bbra%2C%20skip%7D%20instr.../near/207550542" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232143.20Relocation.20of.20DW_OP_.7Bbra.2C.20skip.7D.20instr.2E.2E.2E.html#207550542">(Aug 20 2020 at 17:30)</a>:</h4>
<p>ggreif created <a href="https://github.com/bytecodealliance/wasmtime/pull/2143#discussion_r474156135">PR Review Comment</a>:</p>
<blockquote>
<p>This I'll submit separately.</p>
</blockquote>



<a name="207550583"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232143%20Relocation%20of%20DW_OP_%7Bbra%2C%20skip%7D%20instr.../near/207550583" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232143.20Relocation.20of.20DW_OP_.7Bbra.2C.20skip.7D.20instr.2E.2E.2E.html#207550583">(Aug 20 2020 at 17:31)</a>:</h4>
<p>ggreif submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/2143#pullrequestreview-471836400">PR Review</a>.</p>



<a name="207550584"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232143%20Relocation%20of%20DW_OP_%7Bbra%2C%20skip%7D%20instr.../near/207550584" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232143.20Relocation.20of.20DW_OP_.7Bbra.2C.20skip.7D.20instr.2E.2E.2E.html#207550584">(Aug 20 2020 at 17:31)</a>:</h4>
<p>ggreif created <a href="https://github.com/bytecodealliance/wasmtime/pull/2143#discussion_r474156362">PR Review Comment</a>:</p>
<blockquote>
<p>Dito, refactoring.</p>
</blockquote>



<a name="207581110"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232143%20Relocation%20of%20DW_OP_%7Bbra%2C%20skip%7D%20instr.../near/207581110" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232143.20Relocation.20of.20DW_OP_.7Bbra.2C.20skip.7D.20instr.2E.2E.2E.html#207581110">(Aug 20 2020 at 22:18)</a>:</h4>
<p>yurydelendik created <a href="https://github.com/bytecodealliance/wasmtime/pull/2143#discussion_r474303175">PR Review Comment</a>:</p>
<blockquote>
<p>Let's make <code>jump_arcs</code> as field of <code>CompiledExpression</code> (<code>from_label</code> will have empty map)</p>
</blockquote>



<a name="207581111"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232143%20Relocation%20of%20DW_OP_%7Bbra%2C%20skip%7D%20instr.../near/207581111" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232143.20Relocation.20of.20DW_OP_.7Bbra.2C.20skip.7D.20instr.2E.2E.2E.html#207581111">(Aug 20 2020 at 22:18)</a>:</h4>
<p>yurydelendik submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/2143#pullrequestreview-472023424">PR Review</a>.</p>



<a name="207619837"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232143%20Relocation%20of%20DW_OP_%7Bbra%2C%20skip%7D%20instr.../near/207619837" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232143.20Relocation.20of.20DW_OP_.7Bbra.2C.20skip.7D.20instr.2E.2E.2E.html#207619837">(Aug 21 2020 at 10:31)</a>:</h4>
<p>ggreif updated <a href="https://github.com/bytecodealliance/wasmtime/pull/2143">PR #2143</a> from <code>main</code> to <code>main</code>:</p>
<blockquote>
<p>Please don't look just yet.</p>
<p>Progress:</p>
<ul>
<li>relocation of branch edges works</li>
<li>open problem: the <code>need_deref</code> flag. What when different branches want to set the flag differently?</li>
</ul>
<p>&lt;!--</p>
<p>Please ensure that the following steps are all taken care of before submitting<br>
the PR.</p>
<ul>
<li>
<p>[ ] This has been discussed in issue #..., or if not, please tell us why<br>
  here.</p>
</li>
<li>
<p>[ ] A short description of what this does, why it is needed; if the<br>
  description becomes long, the matter should probably be discussed in an issue<br>
  first.</p>
</li>
<li>
<p>[ ] This PR contains test cases, if meaningful.</p>
</li>
<li>[ ] A reviewer from the core maintainer team has been assigned for this PR.<br>
  If you don't know who could review this, please indicate so. The list of<br>
  suggested reviewers on the right can help you.</li>
</ul>
<p>Please ensure all communication adheres to the <a href="https://github.com/bytecodealliance/wasmtime/blob/master/CODE_OF_CONDUCT.md">code of
conduct</a>.<br>
--&gt;</p>
</blockquote>



<a name="207620077"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232143%20Relocation%20of%20DW_OP_%7Bbra%2C%20skip%7D%20instr.../near/207620077" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232143.20Relocation.20of.20DW_OP_.7Bbra.2C.20skip.7D.20instr.2E.2E.2E.html#207620077">(Aug 21 2020 at 10:34)</a>:</h4>
<p>ggreif updated <a href="https://github.com/bytecodealliance/wasmtime/pull/2143">PR #2143</a> from <code>main</code> to <code>main</code>:</p>
<blockquote>
<p>Please don't look just yet.</p>
<p>Progress:</p>
<ul>
<li>relocation of branch edges works</li>
<li>open problem: the <code>need_deref</code> flag. What when different branches want to set the flag differently?</li>
</ul>
<p>&lt;!--</p>
<p>Please ensure that the following steps are all taken care of before submitting<br>
the PR.</p>
<ul>
<li>
<p>[ ] This has been discussed in issue #..., or if not, please tell us why<br>
  here.</p>
</li>
<li>
<p>[ ] A short description of what this does, why it is needed; if the<br>
  description becomes long, the matter should probably be discussed in an issue<br>
  first.</p>
</li>
<li>
<p>[ ] This PR contains test cases, if meaningful.</p>
</li>
<li>[ ] A reviewer from the core maintainer team has been assigned for this PR.<br>
  If you don't know who could review this, please indicate so. The list of<br>
  suggested reviewers on the right can help you.</li>
</ul>
<p>Please ensure all communication adheres to the <a href="https://github.com/bytecodealliance/wasmtime/blob/master/CODE_OF_CONDUCT.md">code of
conduct</a>.<br>
--&gt;</p>
</blockquote>



<a name="207620112"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232143%20Relocation%20of%20DW_OP_%7Bbra%2C%20skip%7D%20instr.../near/207620112" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232143.20Relocation.20of.20DW_OP_.7Bbra.2C.20skip.7D.20instr.2E.2E.2E.html#207620112">(Aug 21 2020 at 10:35)</a>:</h4>
<p>ggreif submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/2143#pullrequestreview-472385147">PR Review</a>.</p>



<a name="207620113"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232143%20Relocation%20of%20DW_OP_%7Bbra%2C%20skip%7D%20instr.../near/207620113" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232143.20Relocation.20of.20DW_OP_.7Bbra.2C.20skip.7D.20instr.2E.2E.2E.html#207620113">(Aug 21 2020 at 10:35)</a>:</h4>
<p>ggreif created <a href="https://github.com/bytecodealliance/wasmtime/pull/2143#discussion_r474616755">PR Review Comment</a>:</p>
<blockquote>
<p>Can we avoid this clone?</p>
</blockquote>



<a name="207620227"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232143%20Relocation%20of%20DW_OP_%7Bbra%2C%20skip%7D%20instr.../near/207620227" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232143.20Relocation.20of.20DW_OP_.7Bbra.2C.20skip.7D.20instr.2E.2E.2E.html#207620227">(Aug 21 2020 at 10:37)</a>:</h4>
<p>ggreif submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/2143#pullrequestreview-472386185">PR Review</a>.</p>



<a name="207620228"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232143%20Relocation%20of%20DW_OP_%7Bbra%2C%20skip%7D%20instr.../near/207620228" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232143.20Relocation.20of.20DW_OP_.7Bbra.2C.20skip.7D.20instr.2E.2E.2E.html#207620228">(Aug 21 2020 at 10:37)</a>:</h4>
<p>ggreif created <a href="https://github.com/bytecodealliance/wasmtime/pull/2143#discussion_r474617596">PR Review Comment</a>:</p>
<blockquote>
<p>Due to different macro expansions, sometimes this becomes a dead write. Can we suppress the warning in this particular cases?</p>
</blockquote>



<a name="207620244"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232143%20Relocation%20of%20DW_OP_%7Bbra%2C%20skip%7D%20instr.../near/207620244" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232143.20Relocation.20of.20DW_OP_.7Bbra.2C.20skip.7D.20instr.2E.2E.2E.html#207620244">(Aug 21 2020 at 10:37)</a>:</h4>
<p>ggreif edited <a href="https://github.com/bytecodealliance/wasmtime/pull/2143#discussion_r474617596">PR Review Comment</a>.</p>



<a name="207620334"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232143%20Relocation%20of%20DW_OP_%7Bbra%2C%20skip%7D%20instr.../near/207620334" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232143.20Relocation.20of.20DW_OP_.7Bbra.2C.20skip.7D.20instr.2E.2E.2E.html#207620334">(Aug 21 2020 at 10:38)</a>:</h4>
<p>ggreif submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/2143#pullrequestreview-472386871">PR Review</a>.</p>



<a name="207620335"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232143%20Relocation%20of%20DW_OP_%7Bbra%2C%20skip%7D%20instr.../near/207620335" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232143.20Relocation.20of.20DW_OP_.7Bbra.2C.20skip.7D.20instr.2E.2E.2E.html#207620335">(Aug 21 2020 at 10:38)</a>:</h4>
<p>ggreif created <a href="https://github.com/bytecodealliance/wasmtime/pull/2143#discussion_r474618113">PR Review Comment</a>:</p>
<blockquote>
<p>TODO: Go through all <code>DW_OP_*</code> and check if they are mentioned here.</p>
</blockquote>



<a name="207621152"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232143%20Relocation%20of%20DW_OP_%7Bbra%2C%20skip%7D%20instr.../near/207621152" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232143.20Relocation.20of.20DW_OP_.7Bbra.2C.20skip.7D.20instr.2E.2E.2E.html#207621152">(Aug 21 2020 at 10:50)</a>:</h4>
<p>ggreif updated <a href="https://github.com/bytecodealliance/wasmtime/pull/2143">PR #2143</a> from <code>main</code> to <code>main</code>:</p>
<blockquote>
<p>Please don't look just yet.</p>
<p>Progress:</p>
<ul>
<li>relocation of branch edges works</li>
<li>open problem: the <code>need_deref</code> flag. What when different branches want to set the flag differently?</li>
</ul>
<p>&lt;!--</p>
<p>Please ensure that the following steps are all taken care of before submitting<br>
the PR.</p>
<ul>
<li>
<p>[ ] This has been discussed in issue #..., or if not, please tell us why<br>
  here.</p>
</li>
<li>
<p>[ ] A short description of what this does, why it is needed; if the<br>
  description becomes long, the matter should probably be discussed in an issue<br>
  first.</p>
</li>
<li>
<p>[ ] This PR contains test cases, if meaningful.</p>
</li>
<li>[ ] A reviewer from the core maintainer team has been assigned for this PR.<br>
  If you don't know who could review this, please indicate so. The list of<br>
  suggested reviewers on the right can help you.</li>
</ul>
<p>Please ensure all communication adheres to the <a href="https://github.com/bytecodealliance/wasmtime/blob/master/CODE_OF_CONDUCT.md">code of
conduct</a>.<br>
--&gt;</p>
</blockquote>



<a name="207621196"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232143%20Relocation%20of%20DW_OP_%7Bbra%2C%20skip%7D%20instr.../near/207621196" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232143.20Relocation.20of.20DW_OP_.7Bbra.2C.20skip.7D.20instr.2E.2E.2E.html#207621196">(Aug 21 2020 at 10:50)</a>:</h4>
<p>ggreif submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/2143#pullrequestreview-472393713">PR Review</a>.</p>



<a name="207621197"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232143%20Relocation%20of%20DW_OP_%7Bbra%2C%20skip%7D%20instr.../near/207621197" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232143.20Relocation.20of.20DW_OP_.7Bbra.2C.20skip.7D.20instr.2E.2E.2E.html#207621197">(Aug 21 2020 at 10:50)</a>:</h4>
<p>ggreif created <a href="https://github.com/bytecodealliance/wasmtime/pull/2143#discussion_r474623449">PR Review Comment</a>:</p>
<blockquote>
<p>See #2154.</p>
</blockquote>



<a name="207622365"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232143%20Relocation%20of%20DW_OP_%7Bbra%2C%20skip%7D%20instr.../near/207622365" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232143.20Relocation.20of.20DW_OP_.7Bbra.2C.20skip.7D.20instr.2E.2E.2E.html#207622365">(Aug 21 2020 at 11:08)</a>:</h4>
<p>ggreif edited <a href="https://github.com/bytecodealliance/wasmtime/pull/2143">PR #2143</a> from <code>main</code> to <code>main</code>:</p>
<blockquote>
<p>The fundamental problem is that the target distance of jump-like operations may change in the DWARF expression translation process. Intervening <code>DW_OP_deref</code> will expand to about 10 bytes, for example.</p>
<p>So the jumps must be relocated. We approach this task by inserting artificial <code>LandingPad</code> markers (new <code>ExpressionPart</code> constructors) into the parsed vector at all relevant positions:</p>
<ul>
<li>immediately after a <code>Jump</code></li>
<li>at actual <code>Jump</code> targets</li>
<li>before <code>Code</code> chunks when the jump target goes properly into an inner bytecode position.</li>
</ul>
<p><code>LandingPad</code>s are identified by the bytecode instruction offset _before_ translation.</p>
<p>Additionally we now parse the <code>Jump</code> instructions. Upon <code>write</code>ing we record the <code>LandingPad</code>'s translated positions into a relocation map and using that we are able to recompute the target distance for every jump-like instruction.</p>
<p>Progress:</p>
<ul>
<li>relocation of branch edges works</li>
<li>open problem: the <code>need_deref</code> flag. What when different branches want to set the flag differently?</li>
</ul>
<p>&lt;!--</p>
<p>Please ensure that the following steps are all taken care of before submitting<br>
the PR.</p>
<ul>
<li>
<p>[ ] This has been discussed in issue #..., or if not, please tell us why<br>
  here.</p>
</li>
<li>
<p>[ ] A short description of what this does, why it is needed; if the<br>
  description becomes long, the matter should probably be discussed in an issue<br>
  first.</p>
</li>
<li>
<p>[ ] This PR contains test cases, if meaningful.</p>
</li>
<li>[ ] A reviewer from the core maintainer team has been assigned for this PR.<br>
  If you don't know who could review this, please indicate so. The list of<br>
  suggested reviewers on the right can help you.</li>
</ul>
<p>Please ensure all communication adheres to the <a href="https://github.com/bytecodealliance/wasmtime/blob/master/CODE_OF_CONDUCT.md">code of
conduct</a>.<br>
--&gt;</p>
</blockquote>



<a name="207622401"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232143%20Relocation%20of%20DW_OP_%7Bbra%2C%20skip%7D%20instr.../near/207622401" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232143.20Relocation.20of.20DW_OP_.7Bbra.2C.20skip.7D.20instr.2E.2E.2E.html#207622401">(Aug 21 2020 at 11:08)</a>:</h4>
<p>ggreif edited <a href="https://github.com/bytecodealliance/wasmtime/pull/2143">PR #2143</a> from <code>main</code> to <code>main</code>:</p>
<blockquote>
<p>The fundamental problem is that the target distance of jump-like operations may change in the DWARF expression translation process. Intervening <code>DW_OP_deref</code> will expand to about 10 bytes, for example.</p>
<p>So the jumps must be relocated. We approach this task by inserting artificial <code>LandingPad</code> markers (new <code>ExpressionPart</code> constructors) into the parsed vector at all relevant positions:</p>
<ul>
<li>immediately after a <code>Jump</code></li>
<li>at actual <code>Jump</code> targets</li>
<li>before <code>Code</code> chunks when the jump target goes properly into an inner bytecode position.</li>
</ul>
<p><code>LandingPad</code>s are identified by the bytecode instruction offset _before_ translation.</p>
<p>Additionally we now parse the <code>Jump</code> instructions. Upon <code>write</code>ing we record every <code>LandingPad</code>'s translated position into a relocation map and using that we are able to recompute the target distance for every jump-like instruction.</p>
<p>Progress:</p>
<ul>
<li>relocation of branch edges works</li>
<li>open problem: the <code>need_deref</code> flag. What when different branches want to set the flag differently?</li>
</ul>
<p>&lt;!--</p>
<p>Please ensure that the following steps are all taken care of before submitting<br>
the PR.</p>
<ul>
<li>
<p>[ ] This has been discussed in issue #..., or if not, please tell us why<br>
  here.</p>
</li>
<li>
<p>[ ] A short description of what this does, why it is needed; if the<br>
  description becomes long, the matter should probably be discussed in an issue<br>
  first.</p>
</li>
<li>
<p>[ ] This PR contains test cases, if meaningful.</p>
</li>
<li>[ ] A reviewer from the core maintainer team has been assigned for this PR.<br>
  If you don't know who could review this, please indicate so. The list of<br>
  suggested reviewers on the right can help you.</li>
</ul>
<p>Please ensure all communication adheres to the <a href="https://github.com/bytecodealliance/wasmtime/blob/master/CODE_OF_CONDUCT.md">code of
conduct</a>.<br>
--&gt;</p>
</blockquote>



<a name="207622655"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232143%20Relocation%20of%20DW_OP_%7Bbra%2C%20skip%7D%20instr.../near/207622655" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232143.20Relocation.20of.20DW_OP_.7Bbra.2C.20skip.7D.20instr.2E.2E.2E.html#207622655">(Aug 21 2020 at 11:12)</a>:</h4>
<p>ggreif edited <a href="https://github.com/bytecodealliance/wasmtime/pull/2143">PR #2143</a> from <code>main</code> to <code>main</code>:</p>
<blockquote>
<p>The fundamental problem is that the target distance of jump-like operations may change in the DWARF expression translation process. Intervening <code>DW_OP_deref</code> will expand to about 10 bytes, for example.</p>
<p>So the jumps must be relocated. We approach this task by inserting artificial <code>LandingPad</code> markers (new <code>ExpressionPart</code> constructors) into the parsed vector at all relevant positions:</p>
<ul>
<li>immediately after a <code>Jump</code></li>
<li>at actual <code>Jump</code> targets</li>
<li>before <code>Code</code> chunks when the jump target goes properly into an inner bytecode position.</li>
</ul>
<p><code>LandingPad</code>s are identified by the bytecode instruction offset _before_ translation.</p>
<p>Additionally we now parse the <code>Jump</code> instructions. Upon <code>write</code>ing we record every <code>LandingPad</code>'s translated position into a relocation map and using that we are able to recompute the target distance for every jump-like instruction.</p>
<p>Since we don't know in advance if we will need <code>LandingPad</code>s, we speculatively add all, and clean up after parsing is done.<br>
Caveat: Currently we make no attempt to gracefully degrade when jump targets point into a multibyte operation.</p>
<p>Progress:</p>
<ul>
<li>relocation of branch edges works</li>
<li>open problem: the <code>need_deref</code> flag. What when different branches want to set the flag differently?</li>
</ul>
<p>&lt;!--</p>
<p>Please ensure that the following steps are all taken care of before submitting<br>
the PR.</p>
<ul>
<li>
<p>[ ] This has been discussed in issue #..., or if not, please tell us why<br>
  here.</p>
</li>
<li>
<p>[ ] A short description of what this does, why it is needed; if the<br>
  description becomes long, the matter should probably be discussed in an issue<br>
  first.</p>
</li>
<li>
<p>[ ] This PR contains test cases, if meaningful.</p>
</li>
<li>[ ] A reviewer from the core maintainer team has been assigned for this PR.<br>
  If you don't know who could review this, please indicate so. The list of<br>
  suggested reviewers on the right can help you.</li>
</ul>
<p>Please ensure all communication adheres to the <a href="https://github.com/bytecodealliance/wasmtime/blob/master/CODE_OF_CONDUCT.md">code of
conduct</a>.<br>
--&gt;</p>
</blockquote>



<a name="207622926"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232143%20Relocation%20of%20DW_OP_%7Bbra%2C%20skip%7D%20instr.../near/207622926" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232143.20Relocation.20of.20DW_OP_.7Bbra.2C.20skip.7D.20instr.2E.2E.2E.html#207622926">(Aug 21 2020 at 11:16)</a>:</h4>
<p>ggreif updated <a href="https://github.com/bytecodealliance/wasmtime/pull/2143">PR #2143</a> from <code>main</code> to <code>main</code>:</p>
<blockquote>
<p>The fundamental problem is that the target distance of jump-like operations may change in the DWARF expression translation process. Intervening <code>DW_OP_deref</code> will expand to about 10 bytes, for example.</p>
<p>So the jumps must be relocated. We approach this task by inserting artificial <code>LandingPad</code> markers (new <code>ExpressionPart</code> constructors) into the parsed vector at all relevant positions:</p>
<ul>
<li>immediately after a <code>Jump</code></li>
<li>at actual <code>Jump</code> targets</li>
<li>before <code>Code</code> chunks when the jump target goes properly into an inner bytecode position.</li>
</ul>
<p><code>LandingPad</code>s are identified by the bytecode instruction offset _before_ translation.</p>
<p>Additionally we now parse the <code>Jump</code> instructions. Upon <code>write</code>ing we record every <code>LandingPad</code>'s translated position into a relocation map and using that we are able to recompute the target distance for every jump-like instruction.</p>
<p>Since we don't know in advance if we will need <code>LandingPad</code>s, we speculatively add all, and clean up after parsing is done.<br>
Caveat: Currently we make no attempt to gracefully degrade when jump targets point into a multibyte operation.</p>
<p>Progress:</p>
<ul>
<li>relocation of branch edges works</li>
<li>open problem: the <code>need_deref</code> flag. What when different branches want to set the flag differently?</li>
</ul>
<p>&lt;!--</p>
<p>Please ensure that the following steps are all taken care of before submitting<br>
the PR.</p>
<ul>
<li>
<p>[ ] This has been discussed in issue #..., or if not, please tell us why<br>
  here.</p>
</li>
<li>
<p>[ ] A short description of what this does, why it is needed; if the<br>
  description becomes long, the matter should probably be discussed in an issue<br>
  first.</p>
</li>
<li>
<p>[ ] This PR contains test cases, if meaningful.</p>
</li>
<li>[ ] A reviewer from the core maintainer team has been assigned for this PR.<br>
  If you don't know who could review this, please indicate so. The list of<br>
  suggested reviewers on the right can help you.</li>
</ul>
<p>Please ensure all communication adheres to the <a href="https://github.com/bytecodealliance/wasmtime/blob/master/CODE_OF_CONDUCT.md">code of
conduct</a>.<br>
--&gt;</p>
</blockquote>



<a name="207624111"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232143%20Relocation%20of%20DW_OP_%7Bbra%2C%20skip%7D%20instr.../near/207624111" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232143.20Relocation.20of.20DW_OP_.7Bbra.2C.20skip.7D.20instr.2E.2E.2E.html#207624111">(Aug 21 2020 at 11:35)</a>:</h4>
<p>ggreif updated <a href="https://github.com/bytecodealliance/wasmtime/pull/2143">PR #2143</a> from <code>main</code> to <code>main</code>:</p>
<blockquote>
<p>The fundamental problem is that the target distance of jump-like operations may change in the DWARF expression translation process. Intervening <code>DW_OP_deref</code> will expand to about 10 bytes, for example.</p>
<p>So the jumps must be relocated. We approach this task by inserting artificial <code>LandingPad</code> markers (new <code>ExpressionPart</code> constructors) into the parsed vector at all relevant positions:</p>
<ul>
<li>immediately after a <code>Jump</code></li>
<li>at actual <code>Jump</code> targets</li>
<li>before <code>Code</code> chunks when the jump target goes properly into an inner bytecode position.</li>
</ul>
<p><code>LandingPad</code>s are identified by the bytecode instruction offset _before_ translation.</p>
<p>Additionally we now parse the <code>Jump</code> instructions. Upon <code>write</code>ing we record every <code>LandingPad</code>'s translated position into a relocation map and using that we are able to recompute the target distance for every jump-like instruction.</p>
<p>Since we don't know in advance if we will need <code>LandingPad</code>s, we speculatively add all, and clean up after parsing is done.<br>
Caveat: Currently we make no attempt to gracefully degrade when jump targets point into a multibyte operation.</p>
<p>Progress:</p>
<ul>
<li>relocation of branch edges works</li>
<li>open problem: the <code>need_deref</code> flag. What when different branches want to set the flag differently?</li>
</ul>
<p>&lt;!--</p>
<p>Please ensure that the following steps are all taken care of before submitting<br>
the PR.</p>
<ul>
<li>
<p>[ ] This has been discussed in issue #..., or if not, please tell us why<br>
  here.</p>
</li>
<li>
<p>[ ] A short description of what this does, why it is needed; if the<br>
  description becomes long, the matter should probably be discussed in an issue<br>
  first.</p>
</li>
<li>
<p>[ ] This PR contains test cases, if meaningful.</p>
</li>
<li>[ ] A reviewer from the core maintainer team has been assigned for this PR.<br>
  If you don't know who could review this, please indicate so. The list of<br>
  suggested reviewers on the right can help you.</li>
</ul>
<p>Please ensure all communication adheres to the <a href="https://github.com/bytecodealliance/wasmtime/blob/master/CODE_OF_CONDUCT.md">code of
conduct</a>.<br>
--&gt;</p>
</blockquote>



<a name="207624950"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232143%20Relocation%20of%20DW_OP_%7Bbra%2C%20skip%7D%20instr.../near/207624950" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232143.20Relocation.20of.20DW_OP_.7Bbra.2C.20skip.7D.20instr.2E.2E.2E.html#207624950">(Aug 21 2020 at 11:47)</a>:</h4>
<p>ggreif updated <a href="https://github.com/bytecodealliance/wasmtime/pull/2143">PR #2143</a> from <code>main</code> to <code>main</code>:</p>
<blockquote>
<p>The fundamental problem is that the target distance of jump-like operations may change in the DWARF expression translation process. Intervening <code>DW_OP_deref</code> will expand to about 10 bytes, for example.</p>
<p>So the jumps must be relocated. We approach this task by inserting artificial <code>LandingPad</code> markers (new <code>ExpressionPart</code> constructors) into the parsed vector at all relevant positions:</p>
<ul>
<li>immediately after a <code>Jump</code></li>
<li>at actual <code>Jump</code> targets</li>
<li>before <code>Code</code> chunks when the jump target goes properly into an inner bytecode position.</li>
</ul>
<p><code>LandingPad</code>s are identified by the bytecode instruction offset _before_ translation.</p>
<p>Additionally we now parse the <code>Jump</code> instructions. Upon <code>write</code>ing we record every <code>LandingPad</code>'s translated position into a relocation map and using that we are able to recompute the target distance for every jump-like instruction.</p>
<p>Since we don't know in advance if we will need <code>LandingPad</code>s, we speculatively add all, and clean up after parsing is done.<br>
Caveat: Currently we make no attempt to gracefully degrade when jump targets point into a multibyte operation.</p>
<p>Progress:</p>
<ul>
<li>relocation of branch edges works</li>
<li>open problem: the <code>need_deref</code> flag. What when different branches want to set the flag differently?</li>
</ul>
<p>&lt;!--</p>
<p>Please ensure that the following steps are all taken care of before submitting<br>
the PR.</p>
<ul>
<li>
<p>[ ] This has been discussed in issue #..., or if not, please tell us why<br>
  here.</p>
</li>
<li>
<p>[ ] A short description of what this does, why it is needed; if the<br>
  description becomes long, the matter should probably be discussed in an issue<br>
  first.</p>
</li>
<li>
<p>[ ] This PR contains test cases, if meaningful.</p>
</li>
<li>[ ] A reviewer from the core maintainer team has been assigned for this PR.<br>
  If you don't know who could review this, please indicate so. The list of<br>
  suggested reviewers on the right can help you.</li>
</ul>
<p>Please ensure all communication adheres to the <a href="https://github.com/bytecodealliance/wasmtime/blob/master/CODE_OF_CONDUCT.md">code of
conduct</a>.<br>
--&gt;</p>
</blockquote>



<a name="207625299"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232143%20Relocation%20of%20DW_OP_%7Bbra%2C%20skip%7D%20instr.../near/207625299" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232143.20Relocation.20of.20DW_OP_.7Bbra.2C.20skip.7D.20instr.2E.2E.2E.html#207625299">(Aug 21 2020 at 11:53)</a>:</h4>
<p>ggreif updated <a href="https://github.com/bytecodealliance/wasmtime/pull/2143">PR #2143</a> from <code>main</code> to <code>main</code>:</p>
<blockquote>
<p>The fundamental problem is that the target distance of jump-like operations may change in the DWARF expression translation process. Intervening <code>DW_OP_deref</code> will expand to about 10 bytes, for example.</p>
<p>So the jumps must be relocated. We approach this task by inserting artificial <code>LandingPad</code> markers (new <code>ExpressionPart</code> constructors) into the parsed vector at all relevant positions:</p>
<ul>
<li>immediately after a <code>Jump</code></li>
<li>at actual <code>Jump</code> targets</li>
<li>before <code>Code</code> chunks when the jump target goes properly into an inner bytecode position.</li>
</ul>
<p><code>LandingPad</code>s are identified by the bytecode instruction offset _before_ translation.</p>
<p>Additionally we now parse the <code>Jump</code> instructions. Upon <code>write</code>ing we record every <code>LandingPad</code>'s translated position into a relocation map and using that we are able to recompute the target distance for every jump-like instruction.</p>
<p>Since we don't know in advance if we will need <code>LandingPad</code>s, we speculatively add all, and clean up after parsing is done.<br>
Caveat: Currently we make no attempt to gracefully degrade when jump targets point into a multibyte operation.</p>
<p>Progress:</p>
<ul>
<li>relocation of branch edges works</li>
<li>open problem: the <code>need_deref</code> flag. What when different branches want to set the flag differently?</li>
</ul>
<p>&lt;!--</p>
<p>Please ensure that the following steps are all taken care of before submitting<br>
the PR.</p>
<ul>
<li>
<p>[ ] This has been discussed in issue #..., or if not, please tell us why<br>
  here.</p>
</li>
<li>
<p>[ ] A short description of what this does, why it is needed; if the<br>
  description becomes long, the matter should probably be discussed in an issue<br>
  first.</p>
</li>
<li>
<p>[ ] This PR contains test cases, if meaningful.</p>
</li>
<li>[ ] A reviewer from the core maintainer team has been assigned for this PR.<br>
  If you don't know who could review this, please indicate so. The list of<br>
  suggested reviewers on the right can help you.</li>
</ul>
<p>Please ensure all communication adheres to the <a href="https://github.com/bytecodealliance/wasmtime/blob/master/CODE_OF_CONDUCT.md">code of
conduct</a>.<br>
--&gt;</p>
</blockquote>



<a name="207630449"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232143%20Relocation%20of%20DW_OP_%7Bbra%2C%20skip%7D%20instr.../near/207630449" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232143.20Relocation.20of.20DW_OP_.7Bbra.2C.20skip.7D.20instr.2E.2E.2E.html#207630449">(Aug 21 2020 at 12:55)</a>:</h4>
<p>ggreif updated <a href="https://github.com/bytecodealliance/wasmtime/pull/2143">PR #2143</a> from <code>main</code> to <code>main</code>:</p>
<blockquote>
<p>The fundamental problem is that the target distance of jump-like operations may change in the DWARF expression translation process. Intervening <code>DW_OP_deref</code> will expand to about 10 bytes, for example.</p>
<p>So the jumps must be relocated. We approach this task by inserting artificial <code>LandingPad</code> markers (new <code>ExpressionPart</code> constructors) into the parsed vector at all relevant positions:</p>
<ul>
<li>immediately after a <code>Jump</code></li>
<li>at actual <code>Jump</code> targets</li>
<li>before <code>Code</code> chunks when the jump target goes properly into an inner bytecode position.</li>
</ul>
<p><code>LandingPad</code>s are identified by the bytecode instruction offset _before_ translation.</p>
<p>Additionally we now parse the <code>Jump</code> instructions. Upon <code>write</code>ing we record every <code>LandingPad</code>'s translated position into a relocation map and using that we are able to recompute the target distance for every jump-like instruction.</p>
<p>Since we don't know in advance if we will need <code>LandingPad</code>s, we speculatively add all, and clean up after parsing is done.<br>
Caveat: Currently we make no attempt to gracefully degrade when jump targets point into a multibyte operation.</p>
<p>Progress:</p>
<ul>
<li>relocation of branch edges works</li>
<li>open problem: the <code>need_deref</code> flag. What when different branches want to set the flag differently?</li>
</ul>
<p>&lt;!--</p>
<p>Please ensure that the following steps are all taken care of before submitting<br>
the PR.</p>
<ul>
<li>
<p>[ ] This has been discussed in issue #..., or if not, please tell us why<br>
  here.</p>
</li>
<li>
<p>[ ] A short description of what this does, why it is needed; if the<br>
  description becomes long, the matter should probably be discussed in an issue<br>
  first.</p>
</li>
<li>
<p>[ ] This PR contains test cases, if meaningful.</p>
</li>
<li>[ ] A reviewer from the core maintainer team has been assigned for this PR.<br>
  If you don't know who could review this, please indicate so. The list of<br>
  suggested reviewers on the right can help you.</li>
</ul>
<p>Please ensure all communication adheres to the <a href="https://github.com/bytecodealliance/wasmtime/blob/master/CODE_OF_CONDUCT.md">code of
conduct</a>.<br>
--&gt;</p>
</blockquote>



<a name="207631312"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232143%20Relocation%20of%20DW_OP_%7Bbra%2C%20skip%7D%20instr.../near/207631312" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232143.20Relocation.20of.20DW_OP_.7Bbra.2C.20skip.7D.20instr.2E.2E.2E.html#207631312">(Aug 21 2020 at 13:05)</a>:</h4>
<p>ggreif updated <a href="https://github.com/bytecodealliance/wasmtime/pull/2143">PR #2143</a> from <code>main</code> to <code>main</code>:</p>
<blockquote>
<p>The fundamental problem is that the target distance of jump-like operations may change in the DWARF expression translation process. Intervening <code>DW_OP_deref</code> will expand to about 10 bytes, for example.</p>
<p>So the jumps must be relocated. We approach this task by inserting artificial <code>LandingPad</code> markers (new <code>ExpressionPart</code> constructors) into the parsed vector at all relevant positions:</p>
<ul>
<li>immediately after a <code>Jump</code></li>
<li>at actual <code>Jump</code> targets</li>
<li>before <code>Code</code> chunks when the jump target goes properly into an inner bytecode position.</li>
</ul>
<p><code>LandingPad</code>s are identified by the bytecode instruction offset _before_ translation.</p>
<p>Additionally we now parse the <code>Jump</code> instructions. Upon <code>write</code>ing we record every <code>LandingPad</code>'s translated position into a relocation map and using that we are able to recompute the target distance for every jump-like instruction.</p>
<p>Since we don't know in advance if we will need <code>LandingPad</code>s, we speculatively add all, and clean up after parsing is done.<br>
Caveat: Currently we make no attempt to gracefully degrade when jump targets point into a multibyte operation.</p>
<p>Progress:</p>
<ul>
<li>relocation of branch edges works</li>
<li>open problem: the <code>need_deref</code> flag. What when different branches want to set the flag differently?</li>
</ul>
<p>&lt;!--</p>
<p>Please ensure that the following steps are all taken care of before submitting<br>
the PR.</p>
<ul>
<li>
<p>[ ] This has been discussed in issue #..., or if not, please tell us why<br>
  here.</p>
</li>
<li>
<p>[ ] A short description of what this does, why it is needed; if the<br>
  description becomes long, the matter should probably be discussed in an issue<br>
  first.</p>
</li>
<li>
<p>[ ] This PR contains test cases, if meaningful.</p>
</li>
<li>[ ] A reviewer from the core maintainer team has been assigned for this PR.<br>
  If you don't know who could review this, please indicate so. The list of<br>
  suggested reviewers on the right can help you.</li>
</ul>
<p>Please ensure all communication adheres to the <a href="https://github.com/bytecodealliance/wasmtime/blob/master/CODE_OF_CONDUCT.md">code of
conduct</a>.<br>
--&gt;</p>
</blockquote>



<a name="207631494"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232143%20Relocation%20of%20DW_OP_%7Bbra%2C%20skip%7D%20instr.../near/207631494" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232143.20Relocation.20of.20DW_OP_.7Bbra.2C.20skip.7D.20instr.2E.2E.2E.html#207631494">(Aug 21 2020 at 13:07)</a>:</h4>
<p>ggreif submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/2143#pullrequestreview-472471465">PR Review</a>.</p>



<a name="207631495"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232143%20Relocation%20of%20DW_OP_%7Bbra%2C%20skip%7D%20instr.../near/207631495" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232143.20Relocation.20of.20DW_OP_.7Bbra.2C.20skip.7D.20instr.2E.2E.2E.html#207631495">(Aug 21 2020 at 13:07)</a>:</h4>
<p>ggreif created <a href="https://github.com/bytecodealliance/wasmtime/pull/2143#discussion_r474684424">PR Review Comment</a>:</p>
<blockquote>
<p>We now mention all possibilities, but bail out on some, below. We are strictly doing a better job now than before.</p>
</blockquote>



<a name="207631571"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232143%20Relocation%20of%20DW_OP_%7Bbra%2C%20skip%7D%20instr.../near/207631571" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232143.20Relocation.20of.20DW_OP_.7Bbra.2C.20skip.7D.20instr.2E.2E.2E.html#207631571">(Aug 21 2020 at 13:07)</a>:</h4>
<p>ggreif submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/2143#pullrequestreview-472472000">PR Review</a>.</p>



<a name="207631574"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232143%20Relocation%20of%20DW_OP_%7Bbra%2C%20skip%7D%20instr.../near/207631574" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232143.20Relocation.20of.20DW_OP_.7Bbra.2C.20skip.7D.20instr.2E.2E.2E.html#207631574">(Aug 21 2020 at 13:07)</a>:</h4>
<p>ggreif created <a href="https://github.com/bytecodealliance/wasmtime/pull/2143#discussion_r474684836">PR Review Comment</a>:</p>
<blockquote>
<p>Done, thanks for the tip, it simplified matters considerably!</p>
</blockquote>



<a name="207632742"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232143%20Relocation%20of%20DW_OP_%7Bbra%2C%20skip%7D%20instr.../near/207632742" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232143.20Relocation.20of.20DW_OP_.7Bbra.2C.20skip.7D.20instr.2E.2E.2E.html#207632742">(Aug 21 2020 at 13:19)</a>:</h4>
<p>ggreif submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/2143#pullrequestreview-472480015">PR Review</a>.</p>



<a name="207632743"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232143%20Relocation%20of%20DW_OP_%7Bbra%2C%20skip%7D%20instr.../near/207632743" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232143.20Relocation.20of.20DW_OP_.7Bbra.2C.20skip.7D.20instr.2E.2E.2E.html#207632743">(Aug 21 2020 at 13:19)</a>:</h4>
<p>ggreif created <a href="https://github.com/bytecodealliance/wasmtime/pull/2143#discussion_r474690732">PR Review Comment</a>:</p>
<blockquote>
<p>Actually these might be pass-through, as they would push a Wasm bytecode address, which can be <code>DW_OP_deref</code>-ed. Will leave them here until we have a real use case though. It is hard to predict heap addresses at DWARF generation time.</p>
</blockquote>



<a name="207632772"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232143%20Relocation%20of%20DW_OP_%7Bbra%2C%20skip%7D%20instr.../near/207632772" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232143.20Relocation.20of.20DW_OP_.7Bbra.2C.20skip.7D.20instr.2E.2E.2E.html#207632772">(Aug 21 2020 at 13:19)</a>:</h4>
<p>ggreif edited <a href="https://github.com/bytecodealliance/wasmtime/pull/2143#discussion_r474690732">PR Review Comment</a>.</p>



<a name="207632942"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232143%20Relocation%20of%20DW_OP_%7Bbra%2C%20skip%7D%20instr.../near/207632942" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232143.20Relocation.20of.20DW_OP_.7Bbra.2C.20skip.7D.20instr.2E.2E.2E.html#207632942">(Aug 21 2020 at 13:21)</a>:</h4>
<p>ggreif edited <a href="https://github.com/bytecodealliance/wasmtime/pull/2143">PR #2143</a> from <code>main</code> to <code>main</code>:</p>
<blockquote>
<p>The fundamental problem is that the target distance of jump-like operations may change in the DWARF expression translation process. Intervening <code>DW_OP_deref</code> will expand to about 10 bytes, for example.</p>
<p>So the jumps must be relocated. We approach this task by inserting artificial <code>LandingPad</code> markers (new <code>CompiledExpressionParts</code> constructors) into the parsed vector at all relevant positions:</p>
<ul>
<li>immediately after a <code>Jump</code></li>
<li>at actual <code>Jump</code> targets</li>
<li>before <code>Code</code> chunks when the jump target goes properly into an inner bytecode position.</li>
</ul>
<p><code>LandingPad</code>s are identified by the bytecode instruction offset _before_ translation.</p>
<p>Additionally we now parse the <code>Jump</code> instructions. Upon <code>write</code>ing we record every <code>LandingPad</code>'s translated position into a relocation map and using that we are able to recompute the target distance for every jump-like instruction.</p>
<p>Since we don't know in advance if we will need <code>LandingPad</code>s, we speculatively add all, and clean up after parsing is done.<br>
Caveat: Currently we make no attempt to gracefully degrade when jump targets point into a multibyte operation.</p>
<p>Progress:</p>
<ul>
<li>relocation of branch edges works</li>
<li>open problem: the <code>need_deref</code> flag. What when different branches want to set the flag differently?</li>
</ul>
<p>&lt;!--</p>
<p>Please ensure that the following steps are all taken care of before submitting<br>
the PR.</p>
<ul>
<li>
<p>[ ] This has been discussed in issue #..., or if not, please tell us why<br>
  here.</p>
</li>
<li>
<p>[ ] A short description of what this does, why it is needed; if the<br>
  description becomes long, the matter should probably be discussed in an issue<br>
  first.</p>
</li>
<li>
<p>[ ] This PR contains test cases, if meaningful.</p>
</li>
<li>[ ] A reviewer from the core maintainer team has been assigned for this PR.<br>
  If you don't know who could review this, please indicate so. The list of<br>
  suggested reviewers on the right can help you.</li>
</ul>
<p>Please ensure all communication adheres to the <a href="https://github.com/bytecodealliance/wasmtime/blob/master/CODE_OF_CONDUCT.md">code of
conduct</a>.<br>
--&gt;</p>
</blockquote>



<a name="207633305"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232143%20Relocation%20of%20DW_OP_%7Bbra%2C%20skip%7D%20instr.../near/207633305" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232143.20Relocation.20of.20DW_OP_.7Bbra.2C.20skip.7D.20instr.2E.2E.2E.html#207633305">(Aug 21 2020 at 13:24)</a>:</h4>
<p>ggreif edited <a href="https://github.com/bytecodealliance/wasmtime/pull/2143">PR #2143</a> from <code>main</code> to <code>main</code>:</p>
<blockquote>
<p>The fundamental problem is that the target distance of jump-like operations may change in the DWARF expression translation process. Intervening <code>DW_OP_deref</code> will expand to about 10 bytes, for example.</p>
<p>So the jumps must be relocated. We approach this task by inserting artificial <code>LandingPad</code> markers (new <code>CompiledExpressionParts</code> constructors) into the parsed vector at all relevant positions:</p>
<ul>
<li>immediately after a <code>Jump</code></li>
<li>at actual <code>Jump</code> targets</li>
<li>before <code>Code</code> chunks when the jump target goes properly into an inner bytecode position.</li>
</ul>
<p><code>LandingPad</code>s are identified by the bytecode instruction offset _before_ translation.</p>
<p>Additionally we now parse the <code>Jump</code> instructions. Upon <code>write</code>ing we record every <code>LandingPad</code>'s translated position into a relocation map and using that we are able to recompute the target distance for every jump-like instruction.</p>
<p>Since we don't know in advance if we will need <code>LandingPad</code>s, we speculatively add all, and clean up after parsing is concluded. At this point the map from jump sources to destinations is complete.</p>
<p>Caveat: Currently we make no attempt to gracefully degrade when jump targets point into a multibyte operation.</p>
<p>Progress:</p>
<ul>
<li>relocation of branch edges works</li>
<li>open problem: the <code>need_deref</code> flag. What when different branches want to set the flag differently?</li>
</ul>
<p>&lt;!--</p>
<p>Please ensure that the following steps are all taken care of before submitting<br>
the PR.</p>
<ul>
<li>
<p>[ ] This has been discussed in issue #..., or if not, please tell us why<br>
  here.</p>
</li>
<li>
<p>[ ] A short description of what this does, why it is needed; if the<br>
  description becomes long, the matter should probably be discussed in an issue<br>
  first.</p>
</li>
<li>
<p>[ ] This PR contains test cases, if meaningful.</p>
</li>
<li>[ ] A reviewer from the core maintainer team has been assigned for this PR.<br>
  If you don't know who could review this, please indicate so. The list of<br>
  suggested reviewers on the right can help you.</li>
</ul>
<p>Please ensure all communication adheres to the <a href="https://github.com/bytecodealliance/wasmtime/blob/master/CODE_OF_CONDUCT.md">code of
conduct</a>.<br>
--&gt;</p>
</blockquote>



<a name="207633603"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232143%20Relocation%20of%20DW_OP_%7Bbra%2C%20skip%7D%20instr.../near/207633603" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232143.20Relocation.20of.20DW_OP_.7Bbra.2C.20skip.7D.20instr.2E.2E.2E.html#207633603">(Aug 21 2020 at 13:27)</a>:</h4>
<p>ggreif updated <a href="https://github.com/bytecodealliance/wasmtime/pull/2143">PR #2143</a> from <code>main</code> to <code>main</code>:</p>
<blockquote>
<p>The fundamental problem is that the target distance of jump-like operations may change in the DWARF expression translation process. Intervening <code>DW_OP_deref</code> will expand to about 10 bytes, for example.</p>
<p>So the jumps must be relocated. We approach this task by inserting artificial <code>LandingPad</code> markers (new <code>CompiledExpressionParts</code> constructors) into the parsed vector at all relevant positions:</p>
<ul>
<li>immediately after a <code>Jump</code></li>
<li>at actual <code>Jump</code> targets</li>
<li>before <code>Code</code> chunks when the jump target goes properly into an inner bytecode position.</li>
</ul>
<p><code>LandingPad</code>s are identified by the bytecode instruction offset _before_ translation.</p>
<p>Additionally we now parse the <code>Jump</code> instructions. Upon <code>write</code>ing we record every <code>LandingPad</code>'s translated position into a relocation map and using that we are able to recompute the target distance for every jump-like instruction.</p>
<p>Since we don't know in advance if we will need <code>LandingPad</code>s, we speculatively add all, and clean up after parsing is concluded. At this point the map from jump sources to destinations is complete.</p>
<p>Caveat: Currently we make no attempt to gracefully degrade when jump targets point into a multibyte operation.</p>
<p>Progress:</p>
<ul>
<li>relocation of branch edges works</li>
<li>open problem: the <code>need_deref</code> flag. What when different branches want to set the flag differently?</li>
</ul>
<p>&lt;!--</p>
<p>Please ensure that the following steps are all taken care of before submitting<br>
the PR.</p>
<ul>
<li>
<p>[ ] This has been discussed in issue #..., or if not, please tell us why<br>
  here.</p>
</li>
<li>
<p>[ ] A short description of what this does, why it is needed; if the<br>
  description becomes long, the matter should probably be discussed in an issue<br>
  first.</p>
</li>
<li>
<p>[ ] This PR contains test cases, if meaningful.</p>
</li>
<li>[ ] A reviewer from the core maintainer team has been assigned for this PR.<br>
  If you don't know who could review this, please indicate so. The list of<br>
  suggested reviewers on the right can help you.</li>
</ul>
<p>Please ensure all communication adheres to the <a href="https://github.com/bytecodealliance/wasmtime/blob/master/CODE_OF_CONDUCT.md">code of
conduct</a>.<br>
--&gt;</p>
</blockquote>



<a name="207634326"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232143%20Relocation%20of%20DW_OP_%7Bbra%2C%20skip%7D%20instr.../near/207634326" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232143.20Relocation.20of.20DW_OP_.7Bbra.2C.20skip.7D.20instr.2E.2E.2E.html#207634326">(Aug 21 2020 at 13:34)</a>:</h4>
<p>yurydelendik submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/2143#pullrequestreview-472493344">PR Review</a>.</p>



<a name="207634327"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232143%20Relocation%20of%20DW_OP_%7Bbra%2C%20skip%7D%20instr.../near/207634327" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232143.20Relocation.20of.20DW_OP_.7Bbra.2C.20skip.7D.20instr.2E.2E.2E.html#207634327">(Aug 21 2020 at 13:34)</a>:</h4>
<p>yurydelendik created <a href="https://github.com/bytecodealliance/wasmtime/pull/2143#discussion_r474701054">PR Review Comment</a>:</p>
<blockquote>
<p>it is hard code to read without comment, perhaps <code>let found  = old_to_new.iter().find(|(_, new)| new == code_buf.len()); if let Some((old, new)) = found.cloned() { // update old_to_new ...</code></p>
</blockquote>



<a name="207635531"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232143%20Relocation%20of%20DW_OP_%7Bbra%2C%20skip%7D%20instr.../near/207635531" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232143.20Relocation.20of.20DW_OP_.7Bbra.2C.20skip.7D.20instr.2E.2E.2E.html#207635531">(Aug 21 2020 at 13:45)</a>:</h4>
<p>ggreif submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/2143#pullrequestreview-472502281">PR Review</a>.</p>



<a name="207635532"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232143%20Relocation%20of%20DW_OP_%7Bbra%2C%20skip%7D%20instr.../near/207635532" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232143.20Relocation.20of.20DW_OP_.7Bbra.2C.20skip.7D.20instr.2E.2E.2E.html#207635532">(Aug 21 2020 at 13:45)</a>:</h4>
<p>ggreif created <a href="https://github.com/bytecodealliance/wasmtime/pull/2143#discussion_r474707931">PR Review Comment</a>:</p>
<blockquote>
<p>I tried to have <code>in &amp;mut old_to_new</code> but the borrow checker didn't like it. Modifying an iterated-over container is a bad idea, I suppose :-)</p>
</blockquote>



<a name="207635638"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232143%20Relocation%20of%20DW_OP_%7Bbra%2C%20skip%7D%20instr.../near/207635638" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232143.20Relocation.20of.20DW_OP_.7Bbra.2C.20skip.7D.20instr.2E.2E.2E.html#207635638">(Aug 21 2020 at 13:46)</a>:</h4>
<p>ggreif submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/2143#pullrequestreview-472503019">PR Review</a>.</p>



<a name="207635639"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232143%20Relocation%20of%20DW_OP_%7Bbra%2C%20skip%7D%20instr.../near/207635639" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232143.20Relocation.20of.20DW_OP_.7Bbra.2C.20skip.7D.20instr.2E.2E.2E.html#207635639">(Aug 21 2020 at 13:46)</a>:</h4>
<p>ggreif created <a href="https://github.com/bytecodealliance/wasmtime/pull/2143#discussion_r474708499">PR Review Comment</a>:</p>
<blockquote>
<p>It causes CI failures, too.</p>
</blockquote>



<a name="207636339"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232143%20Relocation%20of%20DW_OP_%7Bbra%2C%20skip%7D%20instr.../near/207636339" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232143.20Relocation.20of.20DW_OP_.7Bbra.2C.20skip.7D.20instr.2E.2E.2E.html#207636339">(Aug 21 2020 at 13:52)</a>:</h4>
<p>yurydelendik submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/2143#pullrequestreview-472507576">PR Review</a>.</p>



<a name="207636340"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232143%20Relocation%20of%20DW_OP_%7Bbra%2C%20skip%7D%20instr.../near/207636340" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232143.20Relocation.20of.20DW_OP_.7Bbra.2C.20skip.7D.20instr.2E.2E.2E.html#207636340">(Aug 21 2020 at 13:52)</a>:</h4>
<p>yurydelendik created <a href="https://github.com/bytecodealliance/wasmtime/pull/2143#discussion_r474711774">PR Review Comment</a>:</p>
<blockquote>
<p>I recommend removing <code>unread_bytes</code> as a local and add it as a "parameter" to the push! macro</p>
</blockquote>



<a name="207638284"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232143%20Relocation%20of%20DW_OP_%7Bbra%2C%20skip%7D%20instr.../near/207638284" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232143.20Relocation.20of.20DW_OP_.7Bbra.2C.20skip.7D.20instr.2E.2E.2E.html#207638284">(Aug 21 2020 at 14:10)</a>:</h4>
<p>ggreif updated <a href="https://github.com/bytecodealliance/wasmtime/pull/2143">PR #2143</a> from <code>main</code> to <code>main</code>:</p>
<blockquote>
<p>The fundamental problem is that the target distance of jump-like operations may change in the DWARF expression translation process. Intervening <code>DW_OP_deref</code> will expand to about 10 bytes, for example.</p>
<p>So the jumps must be relocated. We approach this task by inserting artificial <code>LandingPad</code> markers (new <code>CompiledExpressionParts</code> constructors) into the parsed vector at all relevant positions:</p>
<ul>
<li>immediately after a <code>Jump</code></li>
<li>at actual <code>Jump</code> targets</li>
<li>before <code>Code</code> chunks when the jump target goes properly into an inner bytecode position.</li>
</ul>
<p><code>LandingPad</code>s are identified by the bytecode instruction offset _before_ translation.</p>
<p>Additionally we now parse the <code>Jump</code> instructions. Upon <code>write</code>ing we record every <code>LandingPad</code>'s translated position into a relocation map and using that we are able to recompute the target distance for every jump-like instruction.</p>
<p>Since we don't know in advance if we will need <code>LandingPad</code>s, we speculatively add all, and clean up after parsing is concluded. At this point the map from jump sources to destinations is complete.</p>
<p>Caveat: Currently we make no attempt to gracefully degrade when jump targets point into a multibyte operation.</p>
<p>Progress:</p>
<ul>
<li>relocation of branch edges works</li>
<li>open problem: the <code>need_deref</code> flag. What when different branches want to set the flag differently?</li>
</ul>
<p>&lt;!--</p>
<p>Please ensure that the following steps are all taken care of before submitting<br>
the PR.</p>
<ul>
<li>
<p>[ ] This has been discussed in issue #..., or if not, please tell us why<br>
  here.</p>
</li>
<li>
<p>[ ] A short description of what this does, why it is needed; if the<br>
  description becomes long, the matter should probably be discussed in an issue<br>
  first.</p>
</li>
<li>
<p>[ ] This PR contains test cases, if meaningful.</p>
</li>
<li>[ ] A reviewer from the core maintainer team has been assigned for this PR.<br>
  If you don't know who could review this, please indicate so. The list of<br>
  suggested reviewers on the right can help you.</li>
</ul>
<p>Please ensure all communication adheres to the <a href="https://github.com/bytecodealliance/wasmtime/blob/master/CODE_OF_CONDUCT.md">code of
conduct</a>.<br>
--&gt;</p>
</blockquote>



<a name="207638685"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232143%20Relocation%20of%20DW_OP_%7Bbra%2C%20skip%7D%20instr.../near/207638685" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232143.20Relocation.20of.20DW_OP_.7Bbra.2C.20skip.7D.20instr.2E.2E.2E.html#207638685">(Aug 21 2020 at 14:13)</a>:</h4>
<p>ggreif submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/2143#pullrequestreview-472525732">PR Review</a>.</p>



<a name="207638686"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232143%20Relocation%20of%20DW_OP_%7Bbra%2C%20skip%7D%20instr.../near/207638686" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232143.20Relocation.20of.20DW_OP_.7Bbra.2C.20skip.7D.20instr.2E.2E.2E.html#207638686">(Aug 21 2020 at 14:13)</a>:</h4>
<p>ggreif created <a href="https://github.com/bytecodealliance/wasmtime/pull/2143#discussion_r474724844">PR Review Comment</a>:</p>
<blockquote>
<p>Added better comment, since I cannot locate any encoding hint in the context that would let me decide cleanly. For that we would need a <code>gimli</code>-style <code>writer</code>. Another refactor to tackle sometime.</p>
</blockquote>



<a name="207638709"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232143%20Relocation%20of%20DW_OP_%7Bbra%2C%20skip%7D%20instr.../near/207638709" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232143.20Relocation.20of.20DW_OP_.7Bbra.2C.20skip.7D.20instr.2E.2E.2E.html#207638709">(Aug 21 2020 at 14:13)</a>:</h4>
<p>ggreif edited <a href="https://github.com/bytecodealliance/wasmtime/pull/2143#discussion_r474724844">PR Review Comment</a>.</p>



<a name="207639194"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232143%20Relocation%20of%20DW_OP_%7Bbra%2C%20skip%7D%20instr.../near/207639194" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232143.20Relocation.20of.20DW_OP_.7Bbra.2C.20skip.7D.20instr.2E.2E.2E.html#207639194">(Aug 21 2020 at 14:18)</a>:</h4>
<p>yurydelendik submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/2143#pullrequestreview-472529340">PR Review</a>.</p>



<a name="207639195"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232143%20Relocation%20of%20DW_OP_%7Bbra%2C%20skip%7D%20instr.../near/207639195" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232143.20Relocation.20of.20DW_OP_.7Bbra.2C.20skip.7D.20instr.2E.2E.2E.html#207639195">(Aug 21 2020 at 14:18)</a>:</h4>
<p>yurydelendik created <a href="https://github.com/bytecodealliance/wasmtime/pull/2143#discussion_r474727500">PR Review Comment</a>:</p>
<blockquote>
<p>indeed. If I understand the logic, you are searching for <code>new == code.buf.len()</code>. Means you need to use find <code>old_to_new.iter().find(|(_, new)| new == code_buf.len()).cloned()</code>. Then you can modify old_to_new based on found (if) <code>old</code>. No?</p>
</blockquote>



<a name="207678021"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232143%20Relocation%20of%20DW_OP_%7Bbra%2C%20skip%7D%20instr.../near/207678021" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232143.20Relocation.20of.20DW_OP_.7Bbra.2C.20skip.7D.20instr.2E.2E.2E.html#207678021">(Aug 21 2020 at 20:00)</a>:</h4>
<p>ggreif updated <a href="https://github.com/bytecodealliance/wasmtime/pull/2143">PR #2143</a> from <code>main</code> to <code>main</code>:</p>
<blockquote>
<p>The fundamental problem is that the target distance of jump-like operations may change in the DWARF expression translation process. Intervening <code>DW_OP_deref</code> will expand to about 10 bytes, for example.</p>
<p>So the jumps must be relocated. We approach this task by inserting artificial <code>LandingPad</code> markers (new <code>CompiledExpressionParts</code> constructors) into the parsed vector at all relevant positions:</p>
<ul>
<li>immediately after a <code>Jump</code></li>
<li>at actual <code>Jump</code> targets</li>
<li>before <code>Code</code> chunks when the jump target goes properly into an inner bytecode position.</li>
</ul>
<p><code>LandingPad</code>s are identified by the bytecode instruction offset _before_ translation.</p>
<p>Additionally we now parse the <code>Jump</code> instructions. Upon <code>write</code>ing we record every <code>LandingPad</code>'s translated position into a relocation map and using that we are able to recompute the target distance for every jump-like instruction.</p>
<p>Since we don't know in advance if we will need <code>LandingPad</code>s, we speculatively add all, and clean up after parsing is concluded. At this point the map from jump sources to destinations is complete.</p>
<p>Caveat: Currently we make no attempt to gracefully degrade when jump targets point into a multibyte operation.</p>
<p>Progress:</p>
<ul>
<li>relocation of branch edges works</li>
<li>open problem: the <code>need_deref</code> flag. What when different branches want to set the flag differently?</li>
</ul>
<p>&lt;!--</p>
<p>Please ensure that the following steps are all taken care of before submitting<br>
the PR.</p>
<ul>
<li>
<p>[ ] This has been discussed in issue #..., or if not, please tell us why<br>
  here.</p>
</li>
<li>
<p>[ ] A short description of what this does, why it is needed; if the<br>
  description becomes long, the matter should probably be discussed in an issue<br>
  first.</p>
</li>
<li>
<p>[ ] This PR contains test cases, if meaningful.</p>
</li>
<li>[ ] A reviewer from the core maintainer team has been assigned for this PR.<br>
  If you don't know who could review this, please indicate so. The list of<br>
  suggested reviewers on the right can help you.</li>
</ul>
<p>Please ensure all communication adheres to the <a href="https://github.com/bytecodealliance/wasmtime/blob/master/CODE_OF_CONDUCT.md">code of
conduct</a>.<br>
--&gt;</p>
</blockquote>



<a name="207698517"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232143%20Relocation%20of%20DW_OP_%7Bbra%2C%20skip%7D%20instr.../near/207698517" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232143.20Relocation.20of.20DW_OP_.7Bbra.2C.20skip.7D.20instr.2E.2E.2E.html#207698517">(Aug 22 2020 at 00:19)</a>:</h4>
<p>ggreif submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/2143#pullrequestreview-472875661">PR Review</a>.</p>



<a name="207698518"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232143%20Relocation%20of%20DW_OP_%7Bbra%2C%20skip%7D%20instr.../near/207698518" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232143.20Relocation.20of.20DW_OP_.7Bbra.2C.20skip.7D.20instr.2E.2E.2E.html#207698518">(Aug 22 2020 at 00:19)</a>:</h4>
<p>ggreif created <a href="https://github.com/bytecodealliance/wasmtime/pull/2143#discussion_r475019543">PR Review Comment</a>:</p>
<blockquote>
<p>As suggested (elsewhere?) this could be a <code>find</code> followed by <code>insert</code>s on success.</p>
</blockquote>



<a name="207698572"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232143%20Relocation%20of%20DW_OP_%7Bbra%2C%20skip%7D%20instr.../near/207698572" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232143.20Relocation.20of.20DW_OP_.7Bbra.2C.20skip.7D.20instr.2E.2E.2E.html#207698572">(Aug 22 2020 at 00:20)</a>:</h4>
<p>ggreif edited <a href="https://github.com/bytecodealliance/wasmtime/pull/2143#discussion_r475019543">PR Review Comment</a>.</p>



<a name="207698591"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232143%20Relocation%20of%20DW_OP_%7Bbra%2C%20skip%7D%20instr.../near/207698591" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232143.20Relocation.20of.20DW_OP_.7Bbra.2C.20skip.7D.20instr.2E.2E.2E.html#207698591">(Aug 22 2020 at 00:21)</a>:</h4>
<p>ggreif submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/2143#pullrequestreview-472875933">PR Review</a>.</p>



<a name="207698592"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232143%20Relocation%20of%20DW_OP_%7Bbra%2C%20skip%7D%20instr.../near/207698592" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232143.20Relocation.20of.20DW_OP_.7Bbra.2C.20skip.7D.20instr.2E.2E.2E.html#207698592">(Aug 22 2020 at 00:21)</a>:</h4>
<p>ggreif created <a href="https://github.com/bytecodealliance/wasmtime/pull/2143#discussion_r475019825">PR Review Comment</a>:</p>
<blockquote>
<p>remove</p>
</blockquote>



<a name="207698796"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232143%20Relocation%20of%20DW_OP_%7Bbra%2C%20skip%7D%20instr.../near/207698796" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232143.20Relocation.20of.20DW_OP_.7Bbra.2C.20skip.7D.20instr.2E.2E.2E.html#207698796">(Aug 22 2020 at 00:26)</a>:</h4>
<p>ggreif updated <a href="https://github.com/bytecodealliance/wasmtime/pull/2143">PR #2143</a> from <code>main</code> to <code>main</code>:</p>
<blockquote>
<p>The fundamental problem is that the target distance of jump-like operations may change in the DWARF expression translation process. Intervening <code>DW_OP_deref</code> will expand to about 10 bytes, for example.</p>
<p>So the jumps must be relocated. We approach this task by inserting artificial <code>LandingPad</code> markers (new <code>CompiledExpressionParts</code> constructors) into the parsed vector at all relevant positions:</p>
<ul>
<li>immediately after a <code>Jump</code></li>
<li>at actual <code>Jump</code> targets</li>
<li>before <code>Code</code> chunks when the jump target goes properly into an inner bytecode position.</li>
</ul>
<p><code>LandingPad</code>s are identified by the bytecode instruction offset _before_ translation.</p>
<p>Additionally we now parse the <code>Jump</code> instructions. Upon <code>write</code>ing we record every <code>LandingPad</code>'s translated position into a relocation map and using that we are able to recompute the target distance for every jump-like instruction.</p>
<p>Since we don't know in advance if we will need <code>LandingPad</code>s, we speculatively add all, and clean up after parsing is concluded. At this point the map from jump sources to destinations is complete.</p>
<p>Caveat: Currently we make no attempt to gracefully degrade when jump targets point into a multibyte operation.</p>
<p>Progress:</p>
<ul>
<li>relocation of branch edges works</li>
<li>open problem: the <code>need_deref</code> flag. What when different branches want to set the flag differently?</li>
</ul>
<p>&lt;!--</p>
<p>Please ensure that the following steps are all taken care of before submitting<br>
the PR.</p>
<ul>
<li>
<p>[ ] This has been discussed in issue #..., or if not, please tell us why<br>
  here.</p>
</li>
<li>
<p>[ ] A short description of what this does, why it is needed; if the<br>
  description becomes long, the matter should probably be discussed in an issue<br>
  first.</p>
</li>
<li>
<p>[ ] This PR contains test cases, if meaningful.</p>
</li>
<li>[ ] A reviewer from the core maintainer team has been assigned for this PR.<br>
  If you don't know who could review this, please indicate so. The list of<br>
  suggested reviewers on the right can help you.</li>
</ul>
<p>Please ensure all communication adheres to the <a href="https://github.com/bytecodealliance/wasmtime/blob/master/CODE_OF_CONDUCT.md">code of
conduct</a>.<br>
--&gt;</p>
</blockquote>



<a name="207713839"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232143%20Relocation%20of%20DW_OP_%7Bbra%2C%20skip%7D%20instr.../near/207713839" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232143.20Relocation.20of.20DW_OP_.7Bbra.2C.20skip.7D.20instr.2E.2E.2E.html#207713839">(Aug 22 2020 at 08:14)</a>:</h4>
<p>ggreif updated <a href="https://github.com/bytecodealliance/wasmtime/pull/2143">PR #2143</a> from <code>main</code> to <code>main</code>:</p>
<blockquote>
<p>The fundamental problem is that the target distance of jump-like operations may change in the DWARF expression translation process. Intervening <code>DW_OP_deref</code> will expand to about 10 bytes, for example.</p>
<p>So the jumps must be relocated. We approach this task by inserting artificial <code>LandingPad</code> markers (new <code>CompiledExpressionParts</code> constructors) into the parsed vector at all relevant positions:</p>
<ul>
<li>immediately after a <code>Jump</code></li>
<li>at actual <code>Jump</code> targets</li>
<li>before <code>Code</code> chunks when the jump target goes properly into an inner bytecode position.</li>
</ul>
<p><code>LandingPad</code>s are identified by the bytecode instruction offset _before_ translation.</p>
<p>Additionally we now parse the <code>Jump</code> instructions. Upon <code>write</code>ing we record every <code>LandingPad</code>'s translated position into a relocation map and using that we are able to recompute the target distance for every jump-like instruction.</p>
<p>Since we don't know in advance if we will need <code>LandingPad</code>s, we speculatively add all, and clean up after parsing is concluded. At this point the map from jump sources to destinations is complete.</p>
<p>Caveat: Currently we make no attempt to gracefully degrade when jump targets point into a multibyte operation.</p>
<p>Progress:</p>
<ul>
<li>relocation of branch edges works</li>
<li>open problem: the <code>need_deref</code> flag. What when different branches want to set the flag differently?</li>
</ul>
<p>&lt;!--</p>
<p>Please ensure that the following steps are all taken care of before submitting<br>
the PR.</p>
<ul>
<li>
<p>[ ] This has been discussed in issue #..., or if not, please tell us why<br>
  here.</p>
</li>
<li>
<p>[ ] A short description of what this does, why it is needed; if the<br>
  description becomes long, the matter should probably be discussed in an issue<br>
  first.</p>
</li>
<li>
<p>[ ] This PR contains test cases, if meaningful.</p>
</li>
<li>[ ] A reviewer from the core maintainer team has been assigned for this PR.<br>
  If you don't know who could review this, please indicate so. The list of<br>
  suggested reviewers on the right can help you.</li>
</ul>
<p>Please ensure all communication adheres to the <a href="https://github.com/bytecodealliance/wasmtime/blob/master/CODE_OF_CONDUCT.md">code of
conduct</a>.<br>
--&gt;</p>
</blockquote>



<a name="207716729"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232143%20Relocation%20of%20DW_OP_%7Bbra%2C%20skip%7D%20instr.../near/207716729" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232143.20Relocation.20of.20DW_OP_.7Bbra.2C.20skip.7D.20instr.2E.2E.2E.html#207716729">(Aug 22 2020 at 09:46)</a>:</h4>
<p>ggreif updated <a href="https://github.com/bytecodealliance/wasmtime/pull/2143">PR #2143</a> from <code>main</code> to <code>main</code>:</p>
<blockquote>
<p>The fundamental problem is that the target distance of jump-like operations may change in the DWARF expression translation process. Intervening <code>DW_OP_deref</code> will expand to about 10 bytes, for example.</p>
<p>So the jumps must be relocated. We approach this task by inserting artificial <code>LandingPad</code> markers (new <code>CompiledExpressionParts</code> constructors) into the parsed vector at all relevant positions:</p>
<ul>
<li>immediately after a <code>Jump</code></li>
<li>at actual <code>Jump</code> targets</li>
<li>before <code>Code</code> chunks when the jump target goes properly into an inner bytecode position.</li>
</ul>
<p><code>LandingPad</code>s are identified by the bytecode instruction offset _before_ translation.</p>
<p>Additionally we now parse the <code>Jump</code> instructions. Upon <code>write</code>ing we record every <code>LandingPad</code>'s translated position into a relocation map and using that we are able to recompute the target distance for every jump-like instruction.</p>
<p>Since we don't know in advance if we will need <code>LandingPad</code>s, we speculatively add all, and clean up after parsing is concluded. At this point the map from jump sources to destinations is complete.</p>
<p>Caveat: Currently we make no attempt to gracefully degrade when jump targets point into a multibyte operation.</p>
<p>Progress:</p>
<ul>
<li>relocation of branch edges works</li>
<li>open problem: the <code>need_deref</code> flag. What when different branches want to set the flag differently?</li>
</ul>
<p>&lt;!--</p>
<p>Please ensure that the following steps are all taken care of before submitting<br>
the PR.</p>
<ul>
<li>
<p>[ ] This has been discussed in issue #..., or if not, please tell us why<br>
  here.</p>
</li>
<li>
<p>[ ] A short description of what this does, why it is needed; if the<br>
  description becomes long, the matter should probably be discussed in an issue<br>
  first.</p>
</li>
<li>
<p>[ ] This PR contains test cases, if meaningful.</p>
</li>
<li>[ ] A reviewer from the core maintainer team has been assigned for this PR.<br>
  If you don't know who could review this, please indicate so. The list of<br>
  suggested reviewers on the right can help you.</li>
</ul>
<p>Please ensure all communication adheres to the <a href="https://github.com/bytecodealliance/wasmtime/blob/master/CODE_OF_CONDUCT.md">code of
conduct</a>.<br>
--&gt;</p>
</blockquote>



<a name="207716743"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232143%20Relocation%20of%20DW_OP_%7Bbra%2C%20skip%7D%20instr.../near/207716743" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232143.20Relocation.20of.20DW_OP_.7Bbra.2C.20skip.7D.20instr.2E.2E.2E.html#207716743">(Aug 22 2020 at 09:47)</a>:</h4>
<p>ggreif submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/2143#pullrequestreview-472915604">PR Review</a>.</p>



<a name="207716744"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232143%20Relocation%20of%20DW_OP_%7Bbra%2C%20skip%7D%20instr.../near/207716744" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232143.20Relocation.20of.20DW_OP_.7Bbra.2C.20skip.7D.20instr.2E.2E.2E.html#207716744">(Aug 22 2020 at 09:47)</a>:</h4>
<p>ggreif created <a href="https://github.com/bytecodealliance/wasmtime/pull/2143#discussion_r475073463">PR Review Comment</a>:</p>
<blockquote>
<p>Done.</p>
</blockquote>



<a name="207717753"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232143%20Relocation%20of%20DW_OP_%7Bbra%2C%20skip%7D%20instr.../near/207717753" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232143.20Relocation.20of.20DW_OP_.7Bbra.2C.20skip.7D.20instr.2E.2E.2E.html#207717753">(Aug 22 2020 at 10:19)</a>:</h4>
<p>ggreif updated <a href="https://github.com/bytecodealliance/wasmtime/pull/2143">PR #2143</a> from <code>main</code> to <code>main</code>:</p>
<blockquote>
<p>The fundamental problem is that the target distance of jump-like operations may change in the DWARF expression translation process. Intervening <code>DW_OP_deref</code> will expand to about 10 bytes, for example.</p>
<p>So the jumps must be relocated. We approach this task by inserting artificial <code>LandingPad</code> markers (new <code>CompiledExpressionParts</code> constructors) into the parsed vector at all relevant positions:</p>
<ul>
<li>immediately after a <code>Jump</code></li>
<li>at actual <code>Jump</code> targets</li>
<li>before <code>Code</code> chunks when the jump target goes properly into an inner bytecode position.</li>
</ul>
<p><code>LandingPad</code>s are identified by the bytecode instruction offset _before_ translation.</p>
<p>Additionally we now parse the <code>Jump</code> instructions. Upon <code>write</code>ing we record every <code>LandingPad</code>'s translated position into a relocation map and using that we are able to recompute the target distance for every jump-like instruction.</p>
<p>Since we don't know in advance if we will need <code>LandingPad</code>s, we speculatively add all, and clean up after parsing is concluded. At this point the map from jump sources to destinations is complete.</p>
<p>Caveat: Currently we make no attempt to gracefully degrade when jump targets point into a multibyte operation.</p>
<p>Progress:</p>
<ul>
<li>relocation of branch edges works</li>
<li>open problem: the <code>need_deref</code> flag. What when different branches want to set the flag differently?</li>
</ul>
<p>&lt;!--</p>
<p>Please ensure that the following steps are all taken care of before submitting<br>
the PR.</p>
<ul>
<li>
<p>[ ] This has been discussed in issue #..., or if not, please tell us why<br>
  here.</p>
</li>
<li>
<p>[ ] A short description of what this does, why it is needed; if the<br>
  description becomes long, the matter should probably be discussed in an issue<br>
  first.</p>
</li>
<li>
<p>[ ] This PR contains test cases, if meaningful.</p>
</li>
<li>[ ] A reviewer from the core maintainer team has been assigned for this PR.<br>
  If you don't know who could review this, please indicate so. The list of<br>
  suggested reviewers on the right can help you.</li>
</ul>
<p>Please ensure all communication adheres to the <a href="https://github.com/bytecodealliance/wasmtime/blob/master/CODE_OF_CONDUCT.md">code of
conduct</a>.<br>
--&gt;</p>
</blockquote>



<a name="207717819"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232143%20Relocation%20of%20DW_OP_%7Bbra%2C%20skip%7D%20instr.../near/207717819" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232143.20Relocation.20of.20DW_OP_.7Bbra.2C.20skip.7D.20instr.2E.2E.2E.html#207717819">(Aug 22 2020 at 10:20)</a>:</h4>
<p>ggreif submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/2143#pullrequestreview-472917155">PR Review</a>.</p>



<a name="207717820"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232143%20Relocation%20of%20DW_OP_%7Bbra%2C%20skip%7D%20instr.../near/207717820" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232143.20Relocation.20of.20DW_OP_.7Bbra.2C.20skip.7D.20instr.2E.2E.2E.html#207717820">(Aug 22 2020 at 10:20)</a>:</h4>
<p>ggreif created <a href="https://github.com/bytecodealliance/wasmtime/pull/2143#discussion_r475075965">PR Review Comment</a>:</p>
<blockquote>
<p>Done!</p>
</blockquote>



<a name="207717836"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232143%20Relocation%20of%20DW_OP_%7Bbra%2C%20skip%7D%20instr.../near/207717836" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232143.20Relocation.20of.20DW_OP_.7Bbra.2C.20skip.7D.20instr.2E.2E.2E.html#207717836">(Aug 22 2020 at 10:21)</a>:</h4>
<p>ggreif submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/2143#pullrequestreview-472917178">PR Review</a>.</p>



<a name="207717837"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232143%20Relocation%20of%20DW_OP_%7Bbra%2C%20skip%7D%20instr.../near/207717837" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232143.20Relocation.20of.20DW_OP_.7Bbra.2C.20skip.7D.20instr.2E.2E.2E.html#207717837">(Aug 22 2020 at 10:21)</a>:</h4>
<p>ggreif created <a href="https://github.com/bytecodealliance/wasmtime/pull/2143#discussion_r475075994">PR Review Comment</a>:</p>
<blockquote>
<p>Done.</p>
</blockquote>



<a name="207717897"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232143%20Relocation%20of%20DW_OP_%7Bbra%2C%20skip%7D%20instr.../near/207717897" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232143.20Relocation.20of.20DW_OP_.7Bbra.2C.20skip.7D.20instr.2E.2E.2E.html#207717897">(Aug 22 2020 at 10:22)</a>:</h4>
<p>ggreif submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/2143#pullrequestreview-472917220">PR Review</a>.</p>



<a name="207717898"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232143%20Relocation%20of%20DW_OP_%7Bbra%2C%20skip%7D%20instr.../near/207717898" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232143.20Relocation.20of.20DW_OP_.7Bbra.2C.20skip.7D.20instr.2E.2E.2E.html#207717898">(Aug 22 2020 at 10:22)</a>:</h4>
<p>ggreif created <a href="https://github.com/bytecodealliance/wasmtime/pull/2143#discussion_r475076065">PR Review Comment</a>:</p>
<blockquote>
<p>This is a nice use case for <a href="https://doc.rust-lang.org/std/primitive.bool.html#method.then">https://doc.rust-lang.org/std/primitive.bool.html#method.then</a></p>
</blockquote>



<a name="207717918"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232143%20Relocation%20of%20DW_OP_%7Bbra%2C%20skip%7D%20instr.../near/207717918" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232143.20Relocation.20of.20DW_OP_.7Bbra.2C.20skip.7D.20instr.2E.2E.2E.html#207717918">(Aug 22 2020 at 10:23)</a>:</h4>
<p>ggreif edited <a href="https://github.com/bytecodealliance/wasmtime/pull/2143#discussion_r475076065">PR Review Comment</a>.</p>



<a name="207718043"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232143%20Relocation%20of%20DW_OP_%7Bbra%2C%20skip%7D%20instr.../near/207718043" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232143.20Relocation.20of.20DW_OP_.7Bbra.2C.20skip.7D.20instr.2E.2E.2E.html#207718043">(Aug 22 2020 at 10:27)</a>:</h4>
<p>ggreif edited <a href="https://github.com/bytecodealliance/wasmtime/pull/2143#discussion_r475076065">PR Review Comment</a>.</p>



<a name="207718170"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232143%20Relocation%20of%20DW_OP_%7Bbra%2C%20skip%7D%20instr.../near/207718170" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232143.20Relocation.20of.20DW_OP_.7Bbra.2C.20skip.7D.20instr.2E.2E.2E.html#207718170">(Aug 22 2020 at 10:30)</a>:</h4>
<p>ggreif edited <a href="https://github.com/bytecodealliance/wasmtime/pull/2143#discussion_r475076065">PR Review Comment</a>.</p>



<a name="207718303"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232143%20Relocation%20of%20DW_OP_%7Bbra%2C%20skip%7D%20instr.../near/207718303" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232143.20Relocation.20of.20DW_OP_.7Bbra.2C.20skip.7D.20instr.2E.2E.2E.html#207718303">(Aug 22 2020 at 10:34)</a>:</h4>
<p><strong>ggreif</strong> has marked <a href="https://github.com/bytecodealliance/wasmtime/pull/2143">PR #2143</a> as ready for review.</p>



<a name="207718325"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232143%20Relocation%20of%20DW_OP_%7Bbra%2C%20skip%7D%20instr.../near/207718325" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232143.20Relocation.20of.20DW_OP_.7Bbra.2C.20skip.7D.20instr.2E.2E.2E.html#207718325">(Aug 22 2020 at 10:35)</a>:</h4>
<p>ggreif edited <a href="https://github.com/bytecodealliance/wasmtime/pull/2143">PR #2143</a> from <code>main</code> to <code>main</code>:</p>
<blockquote>
<p>The fundamental problem is that the target distance of jump-like operations may change in the DWARF expression translation process. Intervening <code>DW_OP_deref</code> will expand to about 10 bytes, for example.</p>
<p>So the jumps must be relocated. We approach this task by inserting artificial <code>LandingPad</code> markers (new <code>CompiledExpressionParts</code> constructors) into the parsed vector at all relevant positions:</p>
<ul>
<li>immediately after a <code>Jump</code></li>
<li>at actual <code>Jump</code> targets</li>
<li>before <code>Code</code> chunks when the jump target goes properly into an inner bytecode position.</li>
</ul>
<p><code>LandingPad</code>s are identified by the bytecode instruction offset _before_ translation.</p>
<p>Additionally we now parse the <code>Jump</code> instructions. Upon <code>write</code>ing we record every <code>LandingPad</code>'s translated position into a relocation map and using that we are able to recompute the target distance for every jump-like instruction.</p>
<p>Since we don't know in advance if we will need <code>LandingPad</code>s, we speculatively add all, and clean up after parsing is concluded. At this point the map from jump sources to destinations is complete.</p>
<p>Caveat: Currently we make no attempt to gracefully degrade when jump targets point into a multibyte operation (i.e. an illegal jump target).</p>
<p>Progress:</p>
<ul>
<li>relocation of branch edges works</li>
<li>open problem: the <code>need_deref</code> flag. What when different branches want to set the flag differently?</li>
</ul>
<p>&lt;!--</p>
<p>Please ensure that the following steps are all taken care of before submitting<br>
the PR.</p>
<ul>
<li>
<p>[ ] This has been discussed in issue #..., or if not, please tell us why<br>
  here.</p>
</li>
<li>
<p>[ ] A short description of what this does, why it is needed; if the<br>
  description becomes long, the matter should probably be discussed in an issue<br>
  first.</p>
</li>
<li>
<p>[ ] This PR contains test cases, if meaningful.</p>
</li>
<li>[ ] A reviewer from the core maintainer team has been assigned for this PR.<br>
  If you don't know who could review this, please indicate so. The list of<br>
  suggested reviewers on the right can help you.</li>
</ul>
<p>Please ensure all communication adheres to the <a href="https://github.com/bytecodealliance/wasmtime/blob/master/CODE_OF_CONDUCT.md">code of
conduct</a>.<br>
--&gt;</p>
</blockquote>



<a name="207718365"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232143%20Relocation%20of%20DW_OP_%7Bbra%2C%20skip%7D%20instr.../near/207718365" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232143.20Relocation.20of.20DW_OP_.7Bbra.2C.20skip.7D.20instr.2E.2E.2E.html#207718365">(Aug 22 2020 at 10:36)</a>:</h4>
<p><strong>ggreif</strong> requested <a href="https://github.com/yurydelendik">yurydelendik</a> for a review on <a href="https://github.com/bytecodealliance/wasmtime/pull/2143">PR #2143</a>.</p>



<a name="207719448"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232143%20Relocation%20of%20DW_OP_%7Bbra%2C%20skip%7D%20instr.../near/207719448" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232143.20Relocation.20of.20DW_OP_.7Bbra.2C.20skip.7D.20instr.2E.2E.2E.html#207719448">(Aug 22 2020 at 11:06)</a>:</h4>
<p>ggreif submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/2143#pullrequestreview-472919095">PR Review</a>.</p>



<a name="207719449"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232143%20Relocation%20of%20DW_OP_%7Bbra%2C%20skip%7D%20instr.../near/207719449" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232143.20Relocation.20of.20DW_OP_.7Bbra.2C.20skip.7D.20instr.2E.2E.2E.html#207719449">(Aug 22 2020 at 11:06)</a>:</h4>
<p>ggreif created <a href="https://github.com/bytecodealliance/wasmtime/pull/2143#discussion_r475079304">PR Review Comment</a>:</p>
<blockquote>
<p>Leaving here the _nightly_-depending diff</p>
<div class="codehilite"><pre><span></span><code>$ git diff
<span class="gh">diff --git a/crates/debug/src/lib.rs b/crates/debug/src/lib.rs</span>
<span class="gh">index 259c86975..901b171de 100644</span>
<span class="gd">--- a/crates/debug/src/lib.rs</span>
<span class="gi">+++ b/crates/debug/src/lib.rs</span>
<span class="gu">@@ -1,6 +1,7 @@</span>
 //! Debug utils for WebAssembly using Cranelift.

 #![allow(clippy::cast_ptr_alignment)]
<span class="gi">+#![feature(bool_to_option)]</span>

 use anyhow::{bail, ensure, Error};
 use object::{RelocationEncoding, RelocationKind};
<span class="gh">diff --git a/crates/debug/src/transform/expression.rs b/crates/debug/src/transform/expression.rs</span>
<span class="gh">index ceee274f3..002bacd33 100644</span>
<span class="gd">--- a/crates/debug/src/transform/expression.rs</span>
<span class="gi">+++ b/crates/debug/src/transform/expression.rs</span>
<span class="gu">@@ -340,10 +340,10 @@ impl CompiledExpression {</span>
                         for part in &amp;self.parts {
                             match part {
                                 CompiledExpressionPart::Code(c) =&gt; {
<span class="gd">-                                    if let Some((old, new)) = old_to_new</span>
<span class="gd">-                                        .iter()</span>
<span class="gd">-                                        .find(|(_, new)| *new == &amp;code_buf.len())</span>
<span class="gd">-                                        .map(|(old, new)| (*old, *new))</span>
<span class="gi">+                                    if let Some((old, new)) =</span>
<span class="gi">+                                        old_to_new.iter().find_map(|(old, new)| {</span>
<span class="gi">+                                            (*new == code_buf.len()).then(|| (*old, *new))</span>
<span class="gi">+                                        })</span>
                                     {
                                         // when `new` comes from the preceding LandingPad
                                         for i in 1..c.len() {
</code></pre></div>


<p>for posterity :-)</p>
</blockquote>



<a name="207719806"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232143%20Relocation%20of%20DW_OP_%7Bbra%2C%20skip%7D%20instr.../near/207719806" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232143.20Relocation.20of.20DW_OP_.7Bbra.2C.20skip.7D.20instr.2E.2E.2E.html#207719806">(Aug 22 2020 at 11:16)</a>:</h4>
<p>ggreif updated <a href="https://github.com/bytecodealliance/wasmtime/pull/2143">PR #2143</a> from <code>main</code> to <code>main</code>:</p>
<blockquote>
<p>The fundamental problem is that the target distance of jump-like operations may change in the DWARF expression translation process. Intervening <code>DW_OP_deref</code> will expand to about 10 bytes, for example.</p>
<p>So the jumps must be relocated. We approach this task by inserting artificial <code>LandingPad</code> markers (new <code>CompiledExpressionParts</code> constructors) into the parsed vector at all relevant positions:</p>
<ul>
<li>immediately after a <code>Jump</code></li>
<li>at actual <code>Jump</code> targets</li>
<li>before <code>Code</code> chunks when the jump target goes properly into an inner bytecode position.</li>
</ul>
<p><code>LandingPad</code>s are identified by the bytecode instruction offset _before_ translation.</p>
<p>Additionally we now parse the <code>Jump</code> instructions. Upon <code>write</code>ing we record every <code>LandingPad</code>'s translated position into a relocation map and using that we are able to recompute the target distance for every jump-like instruction.</p>
<p>Since we don't know in advance if we will need <code>LandingPad</code>s, we speculatively add all, and clean up after parsing is concluded. At this point the map from jump sources to destinations is complete.</p>
<p>Caveat: Currently we make no attempt to gracefully degrade when jump targets point into a multibyte operation (i.e. an illegal jump target).</p>
<p>Progress:</p>
<ul>
<li>relocation of branch edges works</li>
<li>open problem: the <code>need_deref</code> flag. What when different branches want to set the flag differently?</li>
</ul>
<p>&lt;!--</p>
<p>Please ensure that the following steps are all taken care of before submitting<br>
the PR.</p>
<ul>
<li>
<p>[ ] This has been discussed in issue #..., or if not, please tell us why<br>
  here.</p>
</li>
<li>
<p>[ ] A short description of what this does, why it is needed; if the<br>
  description becomes long, the matter should probably be discussed in an issue<br>
  first.</p>
</li>
<li>
<p>[ ] This PR contains test cases, if meaningful.</p>
</li>
<li>[ ] A reviewer from the core maintainer team has been assigned for this PR.<br>
  If you don't know who could review this, please indicate so. The list of<br>
  suggested reviewers on the right can help you.</li>
</ul>
<p>Please ensure all communication adheres to the <a href="https://github.com/bytecodealliance/wasmtime/blob/master/CODE_OF_CONDUCT.md">code of
conduct</a>.<br>
--&gt;</p>
</blockquote>



<a name="207721315"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232143%20Relocation%20of%20DW_OP_%7Bbra%2C%20skip%7D%20instr.../near/207721315" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232143.20Relocation.20of.20DW_OP_.7Bbra.2C.20skip.7D.20instr.2E.2E.2E.html#207721315">(Aug 22 2020 at 12:02)</a>:</h4>
<p>ggreif updated <a href="https://github.com/bytecodealliance/wasmtime/pull/2143">PR #2143</a> from <code>main</code> to <code>main</code>:</p>
<blockquote>
<p>The fundamental problem is that the target distance of jump-like operations may change in the DWARF expression translation process. Intervening <code>DW_OP_deref</code> will expand to about 10 bytes, for example.</p>
<p>So the jumps must be relocated. We approach this task by inserting artificial <code>LandingPad</code> markers (new <code>CompiledExpressionParts</code> constructors) into the parsed vector at all relevant positions:</p>
<ul>
<li>immediately after a <code>Jump</code></li>
<li>at actual <code>Jump</code> targets</li>
<li>before <code>Code</code> chunks when the jump target goes properly into an inner bytecode position.</li>
</ul>
<p><code>LandingPad</code>s are identified by the bytecode instruction offset _before_ translation.</p>
<p>Additionally we now parse the <code>Jump</code> instructions. Upon <code>write</code>ing we record every <code>LandingPad</code>'s translated position into a relocation map and using that we are able to recompute the target distance for every jump-like instruction.</p>
<p>Since we don't know in advance if we will need <code>LandingPad</code>s, we speculatively add all, and clean up after parsing is concluded. At this point the map from jump sources to destinations is complete.</p>
<p>Caveat: Currently we make no attempt to gracefully degrade when jump targets point into a multibyte operation (i.e. an illegal jump target).</p>
<p>Progress:</p>
<ul>
<li>relocation of branch edges works</li>
<li>open problem: the <code>need_deref</code> flag. What when different branches want to set the flag differently?</li>
</ul>
<p>&lt;!--</p>
<p>Please ensure that the following steps are all taken care of before submitting<br>
the PR.</p>
<ul>
<li>
<p>[ ] This has been discussed in issue #..., or if not, please tell us why<br>
  here.</p>
</li>
<li>
<p>[ ] A short description of what this does, why it is needed; if the<br>
  description becomes long, the matter should probably be discussed in an issue<br>
  first.</p>
</li>
<li>
<p>[ ] This PR contains test cases, if meaningful.</p>
</li>
<li>[ ] A reviewer from the core maintainer team has been assigned for this PR.<br>
  If you don't know who could review this, please indicate so. The list of<br>
  suggested reviewers on the right can help you.</li>
</ul>
<p>Please ensure all communication adheres to the <a href="https://github.com/bytecodealliance/wasmtime/blob/master/CODE_OF_CONDUCT.md">code of
conduct</a>.<br>
--&gt;</p>
</blockquote>



<a name="207721569"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232143%20Relocation%20of%20DW_OP_%7Bbra%2C%20skip%7D%20instr.../near/207721569" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232143.20Relocation.20of.20DW_OP_.7Bbra.2C.20skip.7D.20instr.2E.2E.2E.html#207721569">(Aug 22 2020 at 12:08)</a>:</h4>
<p>ggreif submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/2143#pullrequestreview-472921893">PR Review</a>.</p>



<a name="207721570"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232143%20Relocation%20of%20DW_OP_%7Bbra%2C%20skip%7D%20instr.../near/207721570" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232143.20Relocation.20of.20DW_OP_.7Bbra.2C.20skip.7D.20instr.2E.2E.2E.html#207721570">(Aug 22 2020 at 12:08)</a>:</h4>
<p>ggreif created <a href="https://github.com/bytecodealliance/wasmtime/pull/2143#discussion_r475083974">PR Review Comment</a>:</p>
<blockquote>
<p>Removed.</p>
</blockquote>



<a name="207725312"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232143%20Relocation%20of%20DW_OP_%7Bbra%2C%20skip%7D%20instr.../near/207725312" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232143.20Relocation.20of.20DW_OP_.7Bbra.2C.20skip.7D.20instr.2E.2E.2E.html#207725312">(Aug 22 2020 at 13:47)</a>:</h4>
<p>yurydelendik submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/2143#pullrequestreview-472927780">PR Review</a>.</p>



<a name="207725313"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232143%20Relocation%20of%20DW_OP_%7Bbra%2C%20skip%7D%20instr.../near/207725313" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232143.20Relocation.20of.20DW_OP_.7Bbra.2C.20skip.7D.20instr.2E.2E.2E.html#207725313">(Aug 22 2020 at 13:47)</a>:</h4>
<p>yurydelendik created <a href="https://github.com/bytecodealliance/wasmtime/pull/2143#discussion_r475092891">PR Review Comment</a>:</p>
<blockquote>
<p>use <code>to_le_bytes</code> and <code>copy_from_slice</code> ?</p>
</blockquote>



<a name="207730217"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232143%20Relocation%20of%20DW_OP_%7Bbra%2C%20skip%7D%20instr.../near/207730217" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232143.20Relocation.20of.20DW_OP_.7Bbra.2C.20skip.7D.20instr.2E.2E.2E.html#207730217">(Aug 22 2020 at 16:01)</a>:</h4>
<p>ggreif submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/2143#pullrequestreview-472935333">PR Review</a>.</p>



<a name="207730218"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232143%20Relocation%20of%20DW_OP_%7Bbra%2C%20skip%7D%20instr.../near/207730218" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232143.20Relocation.20of.20DW_OP_.7Bbra.2C.20skip.7D.20instr.2E.2E.2E.html#207730218">(Aug 22 2020 at 16:01)</a>:</h4>
<p>ggreif created <a href="https://github.com/bytecodealliance/wasmtime/pull/2143#discussion_r475104310">PR Review Comment</a>:</p>
<blockquote>
<p>Does that allow me to position in the array?</p>
</blockquote>



<a name="207730349"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232143%20Relocation%20of%20DW_OP_%7Bbra%2C%20skip%7D%20instr.../near/207730349" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232143.20Relocation.20of.20DW_OP_.7Bbra.2C.20skip.7D.20instr.2E.2E.2E.html#207730349">(Aug 22 2020 at 16:04)</a>:</h4>
<p>ggreif submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/2143#pullrequestreview-472935503">PR Review</a>.</p>



<a name="207730350"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232143%20Relocation%20of%20DW_OP_%7Bbra%2C%20skip%7D%20instr.../near/207730350" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232143.20Relocation.20of.20DW_OP_.7Bbra.2C.20skip.7D.20instr.2E.2E.2E.html#207730350">(Aug 22 2020 at 16:04)</a>:</h4>
<p>ggreif created <a href="https://github.com/bytecodealliance/wasmtime/pull/2143#discussion_r475104611">PR Review Comment</a>:</p>
<blockquote>
<p>N/m, I have it: <a href="https://doc.rust-lang.org/book/ch04-03-slices.html">https://doc.rust-lang.org/book/ch04-03-slices.html</a></p>
</blockquote>



<a name="207730439"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232143%20Relocation%20of%20DW_OP_%7Bbra%2C%20skip%7D%20instr.../near/207730439" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232143.20Relocation.20of.20DW_OP_.7Bbra.2C.20skip.7D.20instr.2E.2E.2E.html#207730439">(Aug 22 2020 at 16:07)</a>:</h4>
<p>ggreif updated <a href="https://github.com/bytecodealliance/wasmtime/pull/2143">PR #2143</a> from <code>main</code> to <code>main</code>:</p>
<blockquote>
<p>The fundamental problem is that the target distance of jump-like operations may change in the DWARF expression translation process. Intervening <code>DW_OP_deref</code> will expand to about 10 bytes, for example.</p>
<p>So the jumps must be relocated. We approach this task by inserting artificial <code>LandingPad</code> markers (new <code>CompiledExpressionParts</code> constructors) into the parsed vector at all relevant positions:</p>
<ul>
<li>immediately after a <code>Jump</code></li>
<li>at actual <code>Jump</code> targets</li>
<li>before <code>Code</code> chunks when the jump target goes properly into an inner bytecode position.</li>
</ul>
<p><code>LandingPad</code>s are identified by the bytecode instruction offset _before_ translation.</p>
<p>Additionally we now parse the <code>Jump</code> instructions. Upon <code>write</code>ing we record every <code>LandingPad</code>'s translated position into a relocation map and using that we are able to recompute the target distance for every jump-like instruction.</p>
<p>Since we don't know in advance if we will need <code>LandingPad</code>s, we speculatively add all, and clean up after parsing is concluded. At this point the map from jump sources to destinations is complete.</p>
<p>Caveat: Currently we make no attempt to gracefully degrade when jump targets point into a multibyte operation (i.e. an illegal jump target).</p>
<p>Progress:</p>
<ul>
<li>relocation of branch edges works</li>
<li>open problem: the <code>need_deref</code> flag. What when different branches want to set the flag differently?</li>
</ul>
<p>&lt;!--</p>
<p>Please ensure that the following steps are all taken care of before submitting<br>
the PR.</p>
<ul>
<li>
<p>[ ] This has been discussed in issue #..., or if not, please tell us why<br>
  here.</p>
</li>
<li>
<p>[ ] A short description of what this does, why it is needed; if the<br>
  description becomes long, the matter should probably be discussed in an issue<br>
  first.</p>
</li>
<li>
<p>[ ] This PR contains test cases, if meaningful.</p>
</li>
<li>[ ] A reviewer from the core maintainer team has been assigned for this PR.<br>
  If you don't know who could review this, please indicate so. The list of<br>
  suggested reviewers on the right can help you.</li>
</ul>
<p>Please ensure all communication adheres to the <a href="https://github.com/bytecodealliance/wasmtime/blob/master/CODE_OF_CONDUCT.md">code of
conduct</a>.<br>
--&gt;</p>
</blockquote>



<a name="207731583"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232143%20Relocation%20of%20DW_OP_%7Bbra%2C%20skip%7D%20instr.../near/207731583" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232143.20Relocation.20of.20DW_OP_.7Bbra.2C.20skip.7D.20instr.2E.2E.2E.html#207731583">(Aug 22 2020 at 16:31)</a>:</h4>
<p>ggreif edited <a href="https://github.com/bytecodealliance/wasmtime/pull/2143">PR #2143</a> from <code>main</code> to <code>main</code>:</p>
<blockquote>
<p>The fundamental problem is that the target distance of jump-like operations may change in the DWARF expression translation process. Intervening <code>DW_OP_deref</code> will expand to about 10 bytes, for example.</p>
<p>So the jumps must be relocated. We approach this task by inserting artificial <code>LandingPad</code> markers (new <code>CompiledExpressionParts</code> constructors) into the parsed vector at all relevant positions:</p>
<ul>
<li>immediately after a <code>Jump</code></li>
<li>at actual <code>Jump</code> targets</li>
<li>before <code>Code</code> chunks when the jump target goes properly into an inner bytecode position.</li>
</ul>
<p><code>LandingPad</code>s are identified by the bytecode instruction offset _before_ translation.</p>
<p>Additionally we now parse the <code>Jump</code> instructions. Upon <code>write</code>ing we record every <code>LandingPad</code>'s translated position into a relocation map and using that we are able to recompute the target distance for every jump-like instruction.</p>
<p>Since we don't know in advance if we will need <code>LandingPad</code>s, we speculatively add all, and clean up after parsing is concluded. At this point the map from jump sources to destinations is complete.</p>
<p>Caveat: Currently we make no attempt to gracefully degrade when jump targets point into a multibyte operation (i.e. an illegal jump target).</p>
<p>Progress:</p>
<ul>
<li>relocation of branch edges works</li>
<li>open problem: the <code>need_deref</code> flag. What when different branches want to set the flag differently?</li>
</ul>
<p>Example:</p>
<div class="codehilite"><pre><span></span><code>                  <span class="kt">DW_AT_location</span>    <span class="p">(</span><span class="kt">DW_OP_WASM_location</span> <span class="mh">0x0</span> <span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="kt">DW_OP_dup</span><span class="p">,</span> <span class="kt">DW_OP_lit1</span><span class="p">,</span> <span class="kt">DW_OP_and</span><span class="p">,</span> <span class="kt">DW_OP_bra</span> <span class="o">+</span><span class="mi">5</span><span class="p">,</span> <span class="kt">DW_OP_lit1</span><span class="p">,</span> <span class="kt">DW_OP_shr</span><span class="p">,</span> <span class="kt">DW_OP_skip</span> <span class="o">+</span><span class="mi">3</span><span class="p">,</span> <span class="kt">DW_OP_plus_uconst</span> <span class="mh">0x5</span><span class="p">,</span> <span class="kt">DW_OP_deref</span><span class="p">,</span> <span class="kt">DW_OP_stack_value</span><span class="p">)</span>
</code></pre></div>


<p>gets transformed into:</p>
<div class="codehilite"><pre><span></span><code>                  <span class="kt">DW_AT_location</span>    <span class="p">(</span><span class="kt">DW_OP_breg6</span> <span class="kt">RBP</span><span class="o">-</span><span class="mi">36</span><span class="p">,</span> <span class="kt">DW_OP_deref</span><span class="p">,</span> <span class="kt">DW_OP_dup</span><span class="p">,</span> <span class="kt">DW_OP_lit1</span><span class="p">,</span> <span class="kt">DW_OP_and</span><span class="p">,</span> <span class="kt">DW_OP_bra</span> <span class="o">+</span><span class="mi">5</span><span class="p">,</span> <span class="kt">DW_OP_lit1</span><span class="p">,</span> <span class="kt">DW_OP_shr</span><span class="p">,</span> <span class="kt">DW_OP_skip</span> <span class="o">+</span><span class="mi">19</span><span class="p">,</span> <span class="kt">DW_OP_plus_uconst</span> <span class="mh">0x5</span><span class="p">,</span> <span class="kt">DW_OP_breg6</span> <span class="kt">RBP</span><span class="o">-</span><span class="mi">56</span><span class="p">,</span> <span class="kt">DW_OP_deref</span><span class="p">,</span> <span class="kt">DW_OP_consts</span> <span class="o">+</span><span class="mi">152</span><span class="p">,</span> <span class="kt">DW_OP_plus</span><span class="p">,</span> <span class="kt">DW_OP_deref</span><span class="p">,</span> <span class="kt">DW_OP_swap</span><span class="p">,</span> <span class="kt">DW_OP_const4u</span> <span class="mh">0xffffffff</span><span class="p">,</span> <span class="kt">DW_OP_and</span><span class="p">,</span> <span class="kt">DW_OP_plus</span><span class="p">,</span> <span class="kt">DW_OP_deref</span><span class="p">,</span> <span class="kt">DW_OP_stack_value</span><span class="p">)</span>
</code></pre></div>


<p>&lt;!--</p>
<p>Please ensure that the following steps are all taken care of before submitting<br>
the PR.</p>
<ul>
<li>
<p>[ ] This has been discussed in issue #..., or if not, please tell us why<br>
  here.</p>
</li>
<li>
<p>[ ] A short description of what this does, why it is needed; if the<br>
  description becomes long, the matter should probably be discussed in an issue<br>
  first.</p>
</li>
<li>
<p>[ ] This PR contains test cases, if meaningful.</p>
</li>
<li>[ ] A reviewer from the core maintainer team has been assigned for this PR.<br>
  If you don't know who could review this, please indicate so. The list of<br>
  suggested reviewers on the right can help you.</li>
</ul>
<p>Please ensure all communication adheres to the <a href="https://github.com/bytecodealliance/wasmtime/blob/master/CODE_OF_CONDUCT.md">code of
conduct</a>.<br>
--&gt;</p>
</blockquote>



<a name="207731623"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232143%20Relocation%20of%20DW_OP_%7Bbra%2C%20skip%7D%20instr.../near/207731623" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232143.20Relocation.20of.20DW_OP_.7Bbra.2C.20skip.7D.20instr.2E.2E.2E.html#207731623">(Aug 22 2020 at 16:32)</a>:</h4>
<p>ggreif edited <a href="https://github.com/bytecodealliance/wasmtime/pull/2143">PR #2143</a> from <code>main</code> to <code>main</code>:</p>
<blockquote>
<p>The fundamental problem is that the target distance of jump-like operations may change in the DWARF expression translation process. Intervening <code>DW_OP_deref</code> will expand to about 10 bytes, for example.</p>
<p>So the jumps must be relocated. We approach this task by inserting artificial <code>LandingPad</code> markers (new <code>CompiledExpressionParts</code> constructors) into the parsed vector at all relevant positions:</p>
<ul>
<li>immediately after a <code>Jump</code></li>
<li>at actual <code>Jump</code> targets</li>
<li>before <code>Code</code> chunks when the jump target goes properly into an inner bytecode position.</li>
</ul>
<p><code>LandingPad</code>s are identified by the bytecode instruction offset _before_ translation.</p>
<p>Additionally we now parse the <code>Jump</code> instructions. Upon <code>write</code>ing we record every <code>LandingPad</code>'s translated position into a relocation map and using that we are able to recompute the target distance for every jump-like instruction.</p>
<p>Since we don't know in advance if we will need <code>LandingPad</code>s, we speculatively add all, and clean up after parsing is concluded. At this point the map from jump sources to destinations is complete.</p>
<p>Caveat: Currently we make no attempt to gracefully degrade when jump targets point into a multibyte operation (i.e. an illegal jump target).</p>
<p>Progress:</p>
<ul>
<li>relocation of branch edges works</li>
<li>open problem: the <code>need_deref</code> flag. What when different branches want to set the flag differently?</li>
</ul>
<p>Example:</p>
<div class="codehilite"><pre><span></span><code><span class="kt">DW_AT_location</span>  <span class="p">(</span><span class="kt">DW_OP_WASM_location</span> <span class="mh">0x0</span> <span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="kt">DW_OP_dup</span><span class="p">,</span> <span class="kt">DW_OP_lit1</span><span class="p">,</span> <span class="kt">DW_OP_and</span><span class="p">,</span> <span class="kt">DW_OP_bra</span> <span class="o">+</span><span class="mi">5</span><span class="p">,</span> <span class="kt">DW_OP_lit1</span><span class="p">,</span> <span class="kt">DW_OP_shr</span><span class="p">,</span> <span class="kt">DW_OP_skip</span> <span class="o">+</span><span class="mi">3</span><span class="p">,</span> <span class="kt">DW_OP_plus_uconst</span> <span class="mh">0x5</span><span class="p">,</span> <span class="kt">DW_OP_deref</span><span class="p">,</span> <span class="kt">DW_OP_stack_value</span><span class="p">)</span>
</code></pre></div>


<p>gets transformed into:</p>
<div class="codehilite"><pre><span></span><code><span class="kt">DW_AT_location</span>  <span class="p">(</span><span class="kt">DW_OP_breg6</span> <span class="kt">RBP</span><span class="o">-</span><span class="mi">36</span><span class="p">,</span> <span class="kt">DW_OP_deref</span><span class="p">,</span> <span class="kt">DW_OP_dup</span><span class="p">,</span> <span class="kt">DW_OP_lit1</span><span class="p">,</span> <span class="kt">DW_OP_and</span><span class="p">,</span> <span class="kt">DW_OP_bra</span> <span class="o">+</span><span class="mi">5</span><span class="p">,</span> <span class="kt">DW_OP_lit1</span><span class="p">,</span> <span class="kt">DW_OP_shr</span><span class="p">,</span> <span class="kt">DW_OP_skip</span> <span class="o">+</span><span class="mi">19</span><span class="p">,</span> <span class="kt">DW_OP_plus_uconst</span> <span class="mh">0x5</span><span class="p">,</span> <span class="kt">DW_OP_breg6</span> <span class="kt">RBP</span><span class="o">-</span><span class="mi">56</span><span class="p">,</span> <span class="kt">DW_OP_deref</span><span class="p">,</span> <span class="kt">DW_OP_consts</span> <span class="o">+</span><span class="mi">152</span><span class="p">,</span> <span class="kt">DW_OP_plus</span><span class="p">,</span> <span class="kt">DW_OP_deref</span><span class="p">,</span> <span class="kt">DW_OP_swap</span><span class="p">,</span> <span class="kt">DW_OP_const4u</span> <span class="mh">0xffffffff</span><span class="p">,</span> <span class="kt">DW_OP_and</span><span class="p">,</span> <span class="kt">DW_OP_plus</span><span class="p">,</span> <span class="kt">DW_OP_deref</span><span class="p">,</span> <span class="kt">DW_OP_stack_value</span><span class="p">)</span>
</code></pre></div>


<p>&lt;!--</p>
<p>Please ensure that the following steps are all taken care of before submitting<br>
the PR.</p>
<ul>
<li>
<p>[ ] This has been discussed in issue #..., or if not, please tell us why<br>
  here.</p>
</li>
<li>
<p>[ ] A short description of what this does, why it is needed; if the<br>
  description becomes long, the matter should probably be discussed in an issue<br>
  first.</p>
</li>
<li>
<p>[ ] This PR contains test cases, if meaningful.</p>
</li>
<li>[ ] A reviewer from the core maintainer team has been assigned for this PR.<br>
  If you don't know who could review this, please indicate so. The list of<br>
  suggested reviewers on the right can help you.</li>
</ul>
<p>Please ensure all communication adheres to the <a href="https://github.com/bytecodealliance/wasmtime/blob/master/CODE_OF_CONDUCT.md">code of
conduct</a>.<br>
--&gt;</p>
</blockquote>



<a name="207732078"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232143%20Relocation%20of%20DW_OP_%7Bbra%2C%20skip%7D%20instr.../near/207732078" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232143.20Relocation.20of.20DW_OP_.7Bbra.2C.20skip.7D.20instr.2E.2E.2E.html#207732078">(Aug 22 2020 at 16:42)</a>:</h4>
<p>ggreif edited <a href="https://github.com/bytecodealliance/wasmtime/pull/2143">PR #2143</a> from <code>main</code> to <code>main</code>:</p>
<blockquote>
<p>The fundamental problem is that the target distance of jump-like operations may change in the DWARF expression translation process. Intervening <code>DW_OP_deref</code> will expand to about 10 bytes, for example.</p>
<p>So the jumps must be relocated. We approach this task by inserting artificial <code>LandingPad</code> markers (new <code>CompiledExpressionParts</code> constructors) into the parsed vector at all relevant positions:</p>
<ul>
<li>immediately after a <code>Jump</code></li>
<li>at actual <code>Jump</code> targets</li>
<li>before <code>Code</code> chunks when the jump target goes properly into an inner bytecode position.</li>
</ul>
<p><code>LandingPad</code>s are identified by the bytecode instruction offset _before_ translation.</p>
<p>Additionally we now parse the <code>Jump</code> instructions. Upon <code>write</code>ing we record every <code>LandingPad</code>'s translated position into a relocation map and using that we are able to recompute the target distance for every jump-like instruction.</p>
<p>Since we don't know in advance if we will need <code>LandingPad</code>s, we speculatively add all, and clean up after parsing is concluded. At this point the map from jump sources to destinations is complete.</p>
<p>Caveat: Currently we make no attempt to gracefully degrade when jump targets point into a multibyte operation (i.e. an illegal jump target).</p>
<p>Progress:</p>
<ul>
<li>relocation of branch edges works</li>
<li>open problem: the <code>need_deref</code> flag. What when different branches want to set the flag differently? Probably not a biggie as long as all control-flow paths end e.g. with <code>DW_OP_stack_value</code> (or without).</li>
</ul>
<p>Example:</p>
<div class="codehilite"><pre><span></span><code><span class="kt">DW_AT_location</span>  <span class="p">(</span><span class="kt">DW_OP_WASM_location</span> <span class="mh">0x0</span> <span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="kt">DW_OP_dup</span><span class="p">,</span> <span class="kt">DW_OP_lit1</span><span class="p">,</span> <span class="kt">DW_OP_and</span><span class="p">,</span> <span class="kt">DW_OP_bra</span> <span class="o">+</span><span class="mi">5</span><span class="p">,</span> <span class="kt">DW_OP_lit1</span><span class="p">,</span> <span class="kt">DW_OP_shr</span><span class="p">,</span> <span class="kt">DW_OP_skip</span> <span class="o">+</span><span class="mi">3</span><span class="p">,</span> <span class="kt">DW_OP_plus_uconst</span> <span class="mh">0x5</span><span class="p">,</span> <span class="kt">DW_OP_deref</span><span class="p">,</span> <span class="kt">DW_OP_stack_value</span><span class="p">)</span>
</code></pre></div>


<p>gets transformed into:</p>
<div class="codehilite"><pre><span></span><code><span class="kt">DW_AT_location</span>  <span class="p">(</span><span class="kt">DW_OP_breg6</span> <span class="kt">RBP</span><span class="o">-</span><span class="mi">36</span><span class="p">,</span> <span class="kt">DW_OP_deref</span><span class="p">,</span> <span class="kt">DW_OP_dup</span><span class="p">,</span> <span class="kt">DW_OP_lit1</span><span class="p">,</span> <span class="kt">DW_OP_and</span><span class="p">,</span> <span class="kt">DW_OP_bra</span> <span class="o">+</span><span class="mi">5</span><span class="p">,</span> <span class="kt">DW_OP_lit1</span><span class="p">,</span> <span class="kt">DW_OP_shr</span><span class="p">,</span> <span class="kt">DW_OP_skip</span> <span class="o">+</span><span class="mi">19</span><span class="p">,</span> <span class="kt">DW_OP_plus_uconst</span> <span class="mh">0x5</span><span class="p">,</span> <span class="kt">DW_OP_breg6</span> <span class="kt">RBP</span><span class="o">-</span><span class="mi">56</span><span class="p">,</span> <span class="kt">DW_OP_deref</span><span class="p">,</span> <span class="kt">DW_OP_consts</span> <span class="o">+</span><span class="mi">152</span><span class="p">,</span> <span class="kt">DW_OP_plus</span><span class="p">,</span> <span class="kt">DW_OP_deref</span><span class="p">,</span> <span class="kt">DW_OP_swap</span><span class="p">,</span> <span class="kt">DW_OP_const4u</span> <span class="mh">0xffffffff</span><span class="p">,</span> <span class="kt">DW_OP_and</span><span class="p">,</span> <span class="kt">DW_OP_plus</span><span class="p">,</span> <span class="kt">DW_OP_deref</span><span class="p">,</span> <span class="kt">DW_OP_stack_value</span><span class="p">)</span>
</code></pre></div>


<p>&lt;!--</p>
<p>Please ensure that the following steps are all taken care of before submitting<br>
the PR.</p>
<ul>
<li>
<p>[ ] This has been discussed in issue #..., or if not, please tell us why<br>
  here.</p>
</li>
<li>
<p>[ ] A short description of what this does, why it is needed; if the<br>
  description becomes long, the matter should probably be discussed in an issue<br>
  first.</p>
</li>
<li>
<p>[ ] This PR contains test cases, if meaningful.</p>
</li>
<li>[ ] A reviewer from the core maintainer team has been assigned for this PR.<br>
  If you don't know who could review this, please indicate so. The list of<br>
  suggested reviewers on the right can help you.</li>
</ul>
<p>Please ensure all communication adheres to the <a href="https://github.com/bytecodealliance/wasmtime/blob/master/CODE_OF_CONDUCT.md">code of
conduct</a>.<br>
--&gt;</p>
</blockquote>



<a name="207732089"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232143%20Relocation%20of%20DW_OP_%7Bbra%2C%20skip%7D%20instr.../near/207732089" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232143.20Relocation.20of.20DW_OP_.7Bbra.2C.20skip.7D.20instr.2E.2E.2E.html#207732089">(Aug 22 2020 at 16:42)</a>:</h4>
<p>ggreif submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/2143#pullrequestreview-472937542">PR Review</a>.</p>



<a name="207732090"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232143%20Relocation%20of%20DW_OP_%7Bbra%2C%20skip%7D%20instr.../near/207732090" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232143.20Relocation.20of.20DW_OP_.7Bbra.2C.20skip.7D.20instr.2E.2E.2E.html#207732090">(Aug 22 2020 at 16:42)</a>:</h4>
<p>ggreif created <a href="https://github.com/bytecodealliance/wasmtime/pull/2143#discussion_r475107979">PR Review Comment</a>:</p>
<blockquote>
<p>Done.</p>
</blockquote>



<a name="207899569"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232143%20Relocation%20of%20DW_OP_%7Bbra%2C%20skip%7D%20instr.../near/207899569" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232143.20Relocation.20of.20DW_OP_.7Bbra.2C.20skip.7D.20instr.2E.2E.2E.html#207899569">(Aug 24 2020 at 21:25)</a>:</h4>
<p>yurydelendik submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/2143#pullrequestreview-473864367">PR Review</a>.</p>



<a name="207899570"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232143%20Relocation%20of%20DW_OP_%7Bbra%2C%20skip%7D%20instr.../near/207899570" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232143.20Relocation.20of.20DW_OP_.7Bbra.2C.20skip.7D.20instr.2E.2E.2E.html#207899570">(Aug 24 2020 at 21:25)</a>:</h4>
<p>yurydelendik submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/2143#pullrequestreview-473864367">PR Review</a>.</p>



<a name="207899571"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232143%20Relocation%20of%20DW_OP_%7Bbra%2C%20skip%7D%20instr.../near/207899571" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232143.20Relocation.20of.20DW_OP_.7Bbra.2C.20skip.7D.20instr.2E.2E.2E.html#207899571">(Aug 24 2020 at 21:25)</a>:</h4>
<p>yurydelendik created <a href="https://github.com/bytecodealliance/wasmtime/pull/2143#discussion_r475900565">PR Review Comment</a>:</p>
<blockquote>
<p>is <code>combined</code> == to result of <code>parts.pop()</code>? so you don't have to clone</p>
</blockquote>



<a name="207899623"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232143%20Relocation%20of%20DW_OP_%7Bbra%2C%20skip%7D%20instr.../near/207899623" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232143.20Relocation.20of.20DW_OP_.7Bbra.2C.20skip.7D.20instr.2E.2E.2E.html#207899623">(Aug 24 2020 at 21:26)</a>:</h4>
<p>yurydelendik submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/2143#pullrequestreview-473864367">PR Review</a>.</p>



<a name="207945965"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232143%20Relocation%20of%20DW_OP_%7Bbra%2C%20skip%7D%20instr.../near/207945965" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232143.20Relocation.20of.20DW_OP_.7Bbra.2C.20skip.7D.20instr.2E.2E.2E.html#207945965">(Aug 25 2020 at 10:36)</a>:</h4>
<p>ggreif submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/2143#pullrequestreview-474351440">PR Review</a>.</p>



<a name="207945966"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232143%20Relocation%20of%20DW_OP_%7Bbra%2C%20skip%7D%20instr.../near/207945966" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232143.20Relocation.20of.20DW_OP_.7Bbra.2C.20skip.7D.20instr.2E.2E.2E.html#207945966">(Aug 25 2020 at 10:36)</a>:</h4>
<p>ggreif created <a href="https://github.com/bytecodealliance/wasmtime/pull/2143#discussion_r476349524">PR Review Comment</a>:</p>
<blockquote>
<p>What I'd really like to do is:</p>
<div class="codehilite"><pre><span></span><code><span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="kd">let</span><span class="w"> </span><span class="p">(</span><span class="n">CompiledExpressionPart</span>::<span class="n">Code</span><span class="p">(</span><span class="n">cc2</span><span class="p">),</span><span class="w"> </span><span class="nb">Some</span><span class="p">(</span><span class="n">CompiledExpressionPart</span>::<span class="n">Code</span><span class="p">(</span><span class="n">cc1</span><span class="p">)))</span><span class="w"> </span><span class="o">=</span><span class="w"></span>
<span class="w">                </span><span class="p">(</span><span class="o">&amp;</span><span class="n">part</span><span class="p">,</span><span class="w"> </span><span class="n">parts</span><span class="p">.</span><span class="n">last</span><span class="p">())</span><span class="w"></span>
<span class="w">            </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="n">cc1</span><span class="p">.</span><span class="n">extend_from_slice</span><span class="p">(</span><span class="n">cc2</span><span class="p">);</span><span class="w"></span>
<span class="w">            </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">                </span><span class="n">parts</span><span class="p">.</span><span class="n">push</span><span class="p">(</span><span class="n">CompiledExpressionPart</span>::<span class="n">LandingPad</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">                    </span><span class="n">original_pos</span>: <span class="p">(</span><span class="n">expr</span><span class="p">.</span><span class="mf">0.</span><span class="n">len</span><span class="p">().</span><span class="n">into_u64</span><span class="p">()</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="cp">$unread</span><span class="p">)</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="kt">usize</span><span class="p">,</span><span class="w"></span>
<span class="w">                </span><span class="p">});</span><span class="w"></span>
<span class="w">                </span><span class="n">parts</span><span class="p">.</span><span class="n">push</span><span class="p">(</span><span class="n">part</span><span class="p">)</span><span class="w"></span>
<span class="w">            </span><span class="p">}</span><span class="w"></span>
</code></pre></div>


<p>But for that <code>Code</code> needs to carry a mutable vector.<br>
I tried various other ways of getting rid of the <code>.clone()</code> but I guess my Rust-fu is not strong enough for that. I'd love to see your idea written out though. Indeed the <code>.pop()</code> removes the <code>Code</code> which has <code>cc1</code> in it, and then it gets appended by <code>cc2</code> and. pushed back as a fresh <code>Code</code>.</p>
</blockquote>



<a name="207946142"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232143%20Relocation%20of%20DW_OP_%7Bbra%2C%20skip%7D%20instr.../near/207946142" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232143.20Relocation.20of.20DW_OP_.7Bbra.2C.20skip.7D.20instr.2E.2E.2E.html#207946142">(Aug 25 2020 at 10:39)</a>:</h4>
<p>ggreif edited <a href="https://github.com/bytecodealliance/wasmtime/pull/2143#discussion_r476349524">PR Review Comment</a>.</p>



<a name="207962091"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232143%20Relocation%20of%20DW_OP_%7Bbra%2C%20skip%7D%20instr.../near/207962091" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232143.20Relocation.20of.20DW_OP_.7Bbra.2C.20skip.7D.20instr.2E.2E.2E.html#207962091">(Aug 25 2020 at 13:26)</a>:</h4>
<p>yurydelendik submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/2143#pullrequestreview-473864367">PR Review</a>.</p>



<a name="207962876"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232143%20Relocation%20of%20DW_OP_%7Bbra%2C%20skip%7D%20instr.../near/207962876" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232143.20Relocation.20of.20DW_OP_.7Bbra.2C.20skip.7D.20instr.2E.2E.2E.html#207962876">(Aug 25 2020 at 13:32)</a>:</h4>
<p>yurydelendik submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/2143#pullrequestreview-474484547">PR Review</a>.</p>



<a name="207962877"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232143%20Relocation%20of%20DW_OP_%7Bbra%2C%20skip%7D%20instr.../near/207962877" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232143.20Relocation.20of.20DW_OP_.7Bbra.2C.20skip.7D.20instr.2E.2E.2E.html#207962877">(Aug 25 2020 at 13:32)</a>:</h4>
<p>yurydelendik created <a href="https://github.com/bytecodealliance/wasmtime/pull/2143#discussion_r476451139">PR Review Comment</a>:</p>
<blockquote>
<p>You are not wrong above, just use <code>parts.last_mut()</code> instead of <code>.last()</code>.</p>
</blockquote>



<a name="207974610"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232143%20Relocation%20of%20DW_OP_%7Bbra%2C%20skip%7D%20instr.../near/207974610" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232143.20Relocation.20of.20DW_OP_.7Bbra.2C.20skip.7D.20instr.2E.2E.2E.html#207974610">(Aug 25 2020 at 15:04)</a>:</h4>
<p>ggreif submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/2143#pullrequestreview-474574448">PR Review</a>.</p>



<a name="207974611"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232143%20Relocation%20of%20DW_OP_%7Bbra%2C%20skip%7D%20instr.../near/207974611" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232143.20Relocation.20of.20DW_OP_.7Bbra.2C.20skip.7D.20instr.2E.2E.2E.html#207974611">(Aug 25 2020 at 15:04)</a>:</h4>
<p>ggreif created <a href="https://github.com/bytecodealliance/wasmtime/pull/2143#discussion_r476520611">PR Review Comment</a>:</p>
<blockquote>
<p>Success!</p>
</blockquote>



<a name="207974722"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232143%20Relocation%20of%20DW_OP_%7Bbra%2C%20skip%7D%20instr.../near/207974722" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232143.20Relocation.20of.20DW_OP_.7Bbra.2C.20skip.7D.20instr.2E.2E.2E.html#207974722">(Aug 25 2020 at 15:05)</a>:</h4>
<p>ggreif updated <a href="https://github.com/bytecodealliance/wasmtime/pull/2143">PR #2143</a> from <code>main</code> to <code>main</code>:</p>
<blockquote>
<p>The fundamental problem is that the target distance of jump-like operations may change in the DWARF expression translation process. Intervening <code>DW_OP_deref</code> will expand to about 10 bytes, for example.</p>
<p>So the jumps must be relocated. We approach this task by inserting artificial <code>LandingPad</code> markers (new <code>CompiledExpressionParts</code> constructors) into the parsed vector at all relevant positions:</p>
<ul>
<li>immediately after a <code>Jump</code></li>
<li>at actual <code>Jump</code> targets</li>
<li>before <code>Code</code> chunks when the jump target goes properly into an inner bytecode position.</li>
</ul>
<p><code>LandingPad</code>s are identified by the bytecode instruction offset _before_ translation.</p>
<p>Additionally we now parse the <code>Jump</code> instructions. Upon <code>write</code>ing we record every <code>LandingPad</code>'s translated position into a relocation map and using that we are able to recompute the target distance for every jump-like instruction.</p>
<p>Since we don't know in advance if we will need <code>LandingPad</code>s, we speculatively add all, and clean up after parsing is concluded. At this point the map from jump sources to destinations is complete.</p>
<p>Caveat: Currently we make no attempt to gracefully degrade when jump targets point into a multibyte operation (i.e. an illegal jump target).</p>
<p>Progress:</p>
<ul>
<li>relocation of branch edges works</li>
<li>open problem: the <code>need_deref</code> flag. What when different branches want to set the flag differently? Probably not a biggie as long as all control-flow paths end e.g. with <code>DW_OP_stack_value</code> (or without).</li>
</ul>
<p>Example:</p>
<div class="codehilite"><pre><span></span><code><span class="kt">DW_AT_location</span>  <span class="p">(</span><span class="kt">DW_OP_WASM_location</span> <span class="mh">0x0</span> <span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="kt">DW_OP_dup</span><span class="p">,</span> <span class="kt">DW_OP_lit1</span><span class="p">,</span> <span class="kt">DW_OP_and</span><span class="p">,</span> <span class="kt">DW_OP_bra</span> <span class="o">+</span><span class="mi">5</span><span class="p">,</span> <span class="kt">DW_OP_lit1</span><span class="p">,</span> <span class="kt">DW_OP_shr</span><span class="p">,</span> <span class="kt">DW_OP_skip</span> <span class="o">+</span><span class="mi">3</span><span class="p">,</span> <span class="kt">DW_OP_plus_uconst</span> <span class="mh">0x5</span><span class="p">,</span> <span class="kt">DW_OP_deref</span><span class="p">,</span> <span class="kt">DW_OP_stack_value</span><span class="p">)</span>
</code></pre></div>


<p>gets transformed into:</p>
<div class="codehilite"><pre><span></span><code><span class="kt">DW_AT_location</span>  <span class="p">(</span><span class="kt">DW_OP_breg6</span> <span class="kt">RBP</span><span class="o">-</span><span class="mi">36</span><span class="p">,</span> <span class="kt">DW_OP_deref</span><span class="p">,</span> <span class="kt">DW_OP_dup</span><span class="p">,</span> <span class="kt">DW_OP_lit1</span><span class="p">,</span> <span class="kt">DW_OP_and</span><span class="p">,</span> <span class="kt">DW_OP_bra</span> <span class="o">+</span><span class="mi">5</span><span class="p">,</span> <span class="kt">DW_OP_lit1</span><span class="p">,</span> <span class="kt">DW_OP_shr</span><span class="p">,</span> <span class="kt">DW_OP_skip</span> <span class="o">+</span><span class="mi">19</span><span class="p">,</span> <span class="kt">DW_OP_plus_uconst</span> <span class="mh">0x5</span><span class="p">,</span> <span class="kt">DW_OP_breg6</span> <span class="kt">RBP</span><span class="o">-</span><span class="mi">56</span><span class="p">,</span> <span class="kt">DW_OP_deref</span><span class="p">,</span> <span class="kt">DW_OP_consts</span> <span class="o">+</span><span class="mi">152</span><span class="p">,</span> <span class="kt">DW_OP_plus</span><span class="p">,</span> <span class="kt">DW_OP_deref</span><span class="p">,</span> <span class="kt">DW_OP_swap</span><span class="p">,</span> <span class="kt">DW_OP_const4u</span> <span class="mh">0xffffffff</span><span class="p">,</span> <span class="kt">DW_OP_and</span><span class="p">,</span> <span class="kt">DW_OP_plus</span><span class="p">,</span> <span class="kt">DW_OP_deref</span><span class="p">,</span> <span class="kt">DW_OP_stack_value</span><span class="p">)</span>
</code></pre></div>


<p>&lt;!--</p>
<p>Please ensure that the following steps are all taken care of before submitting<br>
the PR.</p>
<ul>
<li>
<p>[ ] This has been discussed in issue #..., or if not, please tell us why<br>
  here.</p>
</li>
<li>
<p>[ ] A short description of what this does, why it is needed; if the<br>
  description becomes long, the matter should probably be discussed in an issue<br>
  first.</p>
</li>
<li>
<p>[ ] This PR contains test cases, if meaningful.</p>
</li>
<li>[ ] A reviewer from the core maintainer team has been assigned for this PR.<br>
  If you don't know who could review this, please indicate so. The list of<br>
  suggested reviewers on the right can help you.</li>
</ul>
<p>Please ensure all communication adheres to the <a href="https://github.com/bytecodealliance/wasmtime/blob/master/CODE_OF_CONDUCT.md">code of
conduct</a>.<br>
--&gt;</p>
</blockquote>



<a name="207975789"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232143%20Relocation%20of%20DW_OP_%7Bbra%2C%20skip%7D%20instr.../near/207975789" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232143.20Relocation.20of.20DW_OP_.7Bbra.2C.20skip.7D.20instr.2E.2E.2E.html#207975789">(Aug 25 2020 at 15:12)</a>:</h4>
<p>ggreif updated <a href="https://github.com/bytecodealliance/wasmtime/pull/2143">PR #2143</a> from <code>main</code> to <code>main</code>:</p>
<blockquote>
<p>The fundamental problem is that the target distance of jump-like operations may change in the DWARF expression translation process. Intervening <code>DW_OP_deref</code> will expand to about 10 bytes, for example.</p>
<p>So the jumps must be relocated. We approach this task by inserting artificial <code>LandingPad</code> markers (new <code>CompiledExpressionParts</code> constructors) into the parsed vector at all relevant positions:</p>
<ul>
<li>immediately after a <code>Jump</code></li>
<li>at actual <code>Jump</code> targets</li>
<li>before <code>Code</code> chunks when the jump target goes properly into an inner bytecode position.</li>
</ul>
<p><code>LandingPad</code>s are identified by the bytecode instruction offset _before_ translation.</p>
<p>Additionally we now parse the <code>Jump</code> instructions. Upon <code>write</code>ing we record every <code>LandingPad</code>'s translated position into a relocation map and using that we are able to recompute the target distance for every jump-like instruction.</p>
<p>Since we don't know in advance if we will need <code>LandingPad</code>s, we speculatively add all, and clean up after parsing is concluded. At this point the map from jump sources to destinations is complete.</p>
<p>Caveat: Currently we make no attempt to gracefully degrade when jump targets point into a multibyte operation (i.e. an illegal jump target).</p>
<p>Progress:</p>
<ul>
<li>relocation of branch edges works</li>
<li>open problem: the <code>need_deref</code> flag. What when different branches want to set the flag differently? Probably not a biggie as long as all control-flow paths end e.g. with <code>DW_OP_stack_value</code> (or without).</li>
</ul>
<p>Example:</p>
<div class="codehilite"><pre><span></span><code><span class="kt">DW_AT_location</span>  <span class="p">(</span><span class="kt">DW_OP_WASM_location</span> <span class="mh">0x0</span> <span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="kt">DW_OP_dup</span><span class="p">,</span> <span class="kt">DW_OP_lit1</span><span class="p">,</span> <span class="kt">DW_OP_and</span><span class="p">,</span> <span class="kt">DW_OP_bra</span> <span class="o">+</span><span class="mi">5</span><span class="p">,</span> <span class="kt">DW_OP_lit1</span><span class="p">,</span> <span class="kt">DW_OP_shr</span><span class="p">,</span> <span class="kt">DW_OP_skip</span> <span class="o">+</span><span class="mi">3</span><span class="p">,</span> <span class="kt">DW_OP_plus_uconst</span> <span class="mh">0x5</span><span class="p">,</span> <span class="kt">DW_OP_deref</span><span class="p">,</span> <span class="kt">DW_OP_stack_value</span><span class="p">)</span>
</code></pre></div>


<p>gets transformed into:</p>
<div class="codehilite"><pre><span></span><code><span class="kt">DW_AT_location</span>  <span class="p">(</span><span class="kt">DW_OP_breg6</span> <span class="kt">RBP</span><span class="o">-</span><span class="mi">36</span><span class="p">,</span> <span class="kt">DW_OP_deref</span><span class="p">,</span> <span class="kt">DW_OP_dup</span><span class="p">,</span> <span class="kt">DW_OP_lit1</span><span class="p">,</span> <span class="kt">DW_OP_and</span><span class="p">,</span> <span class="kt">DW_OP_bra</span> <span class="o">+</span><span class="mi">5</span><span class="p">,</span> <span class="kt">DW_OP_lit1</span><span class="p">,</span> <span class="kt">DW_OP_shr</span><span class="p">,</span> <span class="kt">DW_OP_skip</span> <span class="o">+</span><span class="mi">19</span><span class="p">,</span> <span class="kt">DW_OP_plus_uconst</span> <span class="mh">0x5</span><span class="p">,</span> <span class="kt">DW_OP_breg6</span> <span class="kt">RBP</span><span class="o">-</span><span class="mi">56</span><span class="p">,</span> <span class="kt">DW_OP_deref</span><span class="p">,</span> <span class="kt">DW_OP_consts</span> <span class="o">+</span><span class="mi">152</span><span class="p">,</span> <span class="kt">DW_OP_plus</span><span class="p">,</span> <span class="kt">DW_OP_deref</span><span class="p">,</span> <span class="kt">DW_OP_swap</span><span class="p">,</span> <span class="kt">DW_OP_const4u</span> <span class="mh">0xffffffff</span><span class="p">,</span> <span class="kt">DW_OP_and</span><span class="p">,</span> <span class="kt">DW_OP_plus</span><span class="p">,</span> <span class="kt">DW_OP_deref</span><span class="p">,</span> <span class="kt">DW_OP_stack_value</span><span class="p">)</span>
</code></pre></div>


<p>&lt;!--</p>
<p>Please ensure that the following steps are all taken care of before submitting<br>
the PR.</p>
<ul>
<li>
<p>[ ] This has been discussed in issue #..., or if not, please tell us why<br>
  here.</p>
</li>
<li>
<p>[ ] A short description of what this does, why it is needed; if the<br>
  description becomes long, the matter should probably be discussed in an issue<br>
  first.</p>
</li>
<li>
<p>[ ] This PR contains test cases, if meaningful.</p>
</li>
<li>[ ] A reviewer from the core maintainer team has been assigned for this PR.<br>
  If you don't know who could review this, please indicate so. The list of<br>
  suggested reviewers on the right can help you.</li>
</ul>
<p>Please ensure all communication adheres to the <a href="https://github.com/bytecodealliance/wasmtime/blob/master/CODE_OF_CONDUCT.md">code of
conduct</a>.<br>
--&gt;</p>
</blockquote>



<a name="208017273"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232143%20Relocation%20of%20DW_OP_%7Bbra%2C%20skip%7D%20instr.../near/208017273" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232143.20Relocation.20of.20DW_OP_.7Bbra.2C.20skip.7D.20instr.2E.2E.2E.html#208017273">(Aug 25 2020 at 20:17)</a>:</h4>
<p>ggreif updated <a href="https://github.com/bytecodealliance/wasmtime/pull/2143">PR #2143</a> from <code>main</code> to <code>main</code>:</p>
<blockquote>
<p>The fundamental problem is that the target distance of jump-like operations may change in the DWARF expression translation process. Intervening <code>DW_OP_deref</code> will expand to about 10 bytes, for example.</p>
<p>So the jumps must be relocated. We approach this task by inserting artificial <code>LandingPad</code> markers (new <code>CompiledExpressionParts</code> constructors) into the parsed vector at all relevant positions:</p>
<ul>
<li>immediately after a <code>Jump</code></li>
<li>at actual <code>Jump</code> targets</li>
<li>before <code>Code</code> chunks when the jump target goes properly into an inner bytecode position.</li>
</ul>
<p><code>LandingPad</code>s are identified by the bytecode instruction offset _before_ translation.</p>
<p>Additionally we now parse the <code>Jump</code> instructions. Upon <code>write</code>ing we record every <code>LandingPad</code>'s translated position into a relocation map and using that we are able to recompute the target distance for every jump-like instruction.</p>
<p>Since we don't know in advance if we will need <code>LandingPad</code>s, we speculatively add all, and clean up after parsing is concluded. At this point the map from jump sources to destinations is complete.</p>
<p>Caveat: Currently we make no attempt to gracefully degrade when jump targets point into a multibyte operation (i.e. an illegal jump target).</p>
<p>Progress:</p>
<ul>
<li>relocation of branch edges works</li>
<li>open problem: the <code>need_deref</code> flag. What when different branches want to set the flag differently? Probably not a biggie as long as all control-flow paths end e.g. with <code>DW_OP_stack_value</code> (or without).</li>
</ul>
<p>Example:</p>
<div class="codehilite"><pre><span></span><code><span class="kt">DW_AT_location</span>  <span class="p">(</span><span class="kt">DW_OP_WASM_location</span> <span class="mh">0x0</span> <span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="kt">DW_OP_dup</span><span class="p">,</span> <span class="kt">DW_OP_lit1</span><span class="p">,</span> <span class="kt">DW_OP_and</span><span class="p">,</span> <span class="kt">DW_OP_bra</span> <span class="o">+</span><span class="mi">5</span><span class="p">,</span> <span class="kt">DW_OP_lit1</span><span class="p">,</span> <span class="kt">DW_OP_shr</span><span class="p">,</span> <span class="kt">DW_OP_skip</span> <span class="o">+</span><span class="mi">3</span><span class="p">,</span> <span class="kt">DW_OP_plus_uconst</span> <span class="mh">0x5</span><span class="p">,</span> <span class="kt">DW_OP_deref</span><span class="p">,</span> <span class="kt">DW_OP_stack_value</span><span class="p">)</span>
</code></pre></div>


<p>gets transformed into:</p>
<div class="codehilite"><pre><span></span><code><span class="kt">DW_AT_location</span>  <span class="p">(</span><span class="kt">DW_OP_breg6</span> <span class="kt">RBP</span><span class="o">-</span><span class="mi">36</span><span class="p">,</span> <span class="kt">DW_OP_deref</span><span class="p">,</span> <span class="kt">DW_OP_dup</span><span class="p">,</span> <span class="kt">DW_OP_lit1</span><span class="p">,</span> <span class="kt">DW_OP_and</span><span class="p">,</span> <span class="kt">DW_OP_bra</span> <span class="o">+</span><span class="mi">5</span><span class="p">,</span> <span class="kt">DW_OP_lit1</span><span class="p">,</span> <span class="kt">DW_OP_shr</span><span class="p">,</span> <span class="kt">DW_OP_skip</span> <span class="o">+</span><span class="mi">19</span><span class="p">,</span> <span class="kt">DW_OP_plus_uconst</span> <span class="mh">0x5</span><span class="p">,</span> <span class="kt">DW_OP_breg6</span> <span class="kt">RBP</span><span class="o">-</span><span class="mi">56</span><span class="p">,</span> <span class="kt">DW_OP_deref</span><span class="p">,</span> <span class="kt">DW_OP_consts</span> <span class="o">+</span><span class="mi">152</span><span class="p">,</span> <span class="kt">DW_OP_plus</span><span class="p">,</span> <span class="kt">DW_OP_deref</span><span class="p">,</span> <span class="kt">DW_OP_swap</span><span class="p">,</span> <span class="kt">DW_OP_const4u</span> <span class="mh">0xffffffff</span><span class="p">,</span> <span class="kt">DW_OP_and</span><span class="p">,</span> <span class="kt">DW_OP_plus</span><span class="p">,</span> <span class="kt">DW_OP_deref</span><span class="p">,</span> <span class="kt">DW_OP_stack_value</span><span class="p">)</span>
</code></pre></div>


<p>&lt;!--</p>
<p>Please ensure that the following steps are all taken care of before submitting<br>
the PR.</p>
<ul>
<li>
<p>[ ] This has been discussed in issue #..., or if not, please tell us why<br>
  here.</p>
</li>
<li>
<p>[ ] A short description of what this does, why it is needed; if the<br>
  description becomes long, the matter should probably be discussed in an issue<br>
  first.</p>
</li>
<li>
<p>[ ] This PR contains test cases, if meaningful.</p>
</li>
<li>[ ] A reviewer from the core maintainer team has been assigned for this PR.<br>
  If you don't know who could review this, please indicate so. The list of<br>
  suggested reviewers on the right can help you.</li>
</ul>
<p>Please ensure all communication adheres to the <a href="https://github.com/bytecodealliance/wasmtime/blob/master/CODE_OF_CONDUCT.md">code of
conduct</a>.<br>
--&gt;</p>
</blockquote>



<a name="208030814"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232143%20Relocation%20of%20DW_OP_%7Bbra%2C%20skip%7D%20instr.../near/208030814" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232143.20Relocation.20of.20DW_OP_.7Bbra.2C.20skip.7D.20instr.2E.2E.2E.html#208030814">(Aug 25 2020 at 22:11)</a>:</h4>
<p>yurydelendik submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/2143#pullrequestreview-474952115">PR Review</a>.</p>



<a name="208030815"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232143%20Relocation%20of%20DW_OP_%7Bbra%2C%20skip%7D%20instr.../near/208030815" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232143.20Relocation.20of.20DW_OP_.7Bbra.2C.20skip.7D.20instr.2E.2E.2E.html#208030815">(Aug 25 2020 at 22:11)</a>:</h4>
<p>yurydelendik created <a href="https://github.com/bytecodealliance/wasmtime/pull/2143#discussion_r476787878">PR Review Comment</a>:</p>
<blockquote>
<p>I think this and above test cases are incorrect. Can you verify that?</p>
</blockquote>



<a name="208038569"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232143%20Relocation%20of%20DW_OP_%7Bbra%2C%20skip%7D%20instr.../near/208038569" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232143.20Relocation.20of.20DW_OP_.7Bbra.2C.20skip.7D.20instr.2E.2E.2E.html#208038569">(Aug 25 2020 at 23:50)</a>:</h4>
<p>ggreif submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/2143#pullrequestreview-475059742">PR Review</a>.</p>



<a name="208038570"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232143%20Relocation%20of%20DW_OP_%7Bbra%2C%20skip%7D%20instr.../near/208038570" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232143.20Relocation.20of.20DW_OP_.7Bbra.2C.20skip.7D.20instr.2E.2E.2E.html#208038570">(Aug 25 2020 at 23:50)</a>:</h4>
<p>ggreif created <a href="https://github.com/bytecodealliance/wasmtime/pull/2143#discussion_r476879160">PR Review Comment</a>:</p>
<blockquote>
<p>The parsing tests pass</p>
<div class="codehilite"><pre><span></span><code><span class="n">test</span><span class="w"> </span><span class="n">transform</span>::<span class="n">expression</span>::<span class="n">tests</span>::<span class="n">test_debug_parse_expressions</span><span class="w"> </span><span class="o">..</span><span class="p">.</span><span class="w"> </span><span class="n">ok</span><span class="w"></span>
</code></pre></div>


<p>The tests themselves are not intended to make sense, if that is what you mean. The example in the PR description is an actual location expression with its translation.</p>
</blockquote>



<a name="208040581"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232143%20Relocation%20of%20DW_OP_%7Bbra%2C%20skip%7D%20instr.../near/208040581" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232143.20Relocation.20of.20DW_OP_.7Bbra.2C.20skip.7D.20instr.2E.2E.2E.html#208040581">(Aug 26 2020 at 00:22)</a>:</h4>
<p>ggreif submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/2143#pullrequestreview-475070116">PR Review</a>.</p>



<a name="208040582"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232143%20Relocation%20of%20DW_OP_%7Bbra%2C%20skip%7D%20instr.../near/208040582" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232143.20Relocation.20of.20DW_OP_.7Bbra.2C.20skip.7D.20instr.2E.2E.2E.html#208040582">(Aug 26 2020 at 00:22)</a>:</h4>
<p>ggreif created <a href="https://github.com/bytecodealliance/wasmtime/pull/2143#discussion_r476907800">PR Review Comment</a>:</p>
<blockquote>
<p>The <code>original_pos: 5</code> appearing twice is probably which is confusing. It confused me too. But actually it makes sense. The jump goes from 5 to 7. The <code>LandingPad</code> before <code>Code</code> just orients it and tells that there are potential jump targets in <code>Code</code> (pre-translation) pos 6: <code>DW_OP_lit0</code>, pos 7: <code>DW_OP_stack_value</code>.</p>
</blockquote>



<a name="208040656"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232143%20Relocation%20of%20DW_OP_%7Bbra%2C%20skip%7D%20instr.../near/208040656" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232143.20Relocation.20of.20DW_OP_.7Bbra.2C.20skip.7D.20instr.2E.2E.2E.html#208040656">(Aug 26 2020 at 00:23)</a>:</h4>
<p>ggreif edited <a href="https://github.com/bytecodealliance/wasmtime/pull/2143#discussion_r476907800">PR Review Comment</a>.</p>



<a name="208040877"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232143%20Relocation%20of%20DW_OP_%7Bbra%2C%20skip%7D%20instr.../near/208040877" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232143.20Relocation.20of.20DW_OP_.7Bbra.2C.20skip.7D.20instr.2E.2E.2E.html#208040877">(Aug 26 2020 at 00:26)</a>:</h4>
<p>ggreif edited <a href="https://github.com/bytecodealliance/wasmtime/pull/2143#discussion_r476907800">PR Review Comment</a>.</p>



<a name="208041051"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232143%20Relocation%20of%20DW_OP_%7Bbra%2C%20skip%7D%20instr.../near/208041051" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232143.20Relocation.20of.20DW_OP_.7Bbra.2C.20skip.7D.20instr.2E.2E.2E.html#208041051">(Aug 26 2020 at 00:28)</a>:</h4>
<p>ggreif edited <a href="https://github.com/bytecodealliance/wasmtime/pull/2143#discussion_r476907800">PR Review Comment</a>.</p>



<a name="208113095"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232143%20Relocation%20of%20DW_OP_%7Bbra%2C%20skip%7D%20instr.../near/208113095" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232143.20Relocation.20of.20DW_OP_.7Bbra.2C.20skip.7D.20instr.2E.2E.2E.html#208113095">(Aug 26 2020 at 16:13)</a>:</h4>
<p>ggreif updated <a href="https://github.com/bytecodealliance/wasmtime/pull/2143">PR #2143</a> from <code>main</code> to <code>main</code>:</p>
<blockquote>
<p>The fundamental problem is that the target distance of jump-like operations may change in the DWARF expression translation process. Intervening <code>DW_OP_deref</code> will expand to about 10 bytes, for example.</p>
<p>So the jumps must be relocated. We approach this task by inserting artificial <code>LandingPad</code> markers (new <code>CompiledExpressionParts</code> constructors) into the parsed vector at all relevant positions:</p>
<ul>
<li>immediately after a <code>Jump</code></li>
<li>at actual <code>Jump</code> targets</li>
<li>before <code>Code</code> chunks when the jump target goes properly into an inner bytecode position.</li>
</ul>
<p><code>LandingPad</code>s are identified by the bytecode instruction offset _before_ translation.</p>
<p>Additionally we now parse the <code>Jump</code> instructions. Upon <code>write</code>ing we record every <code>LandingPad</code>'s translated position into a relocation map and using that we are able to recompute the target distance for every jump-like instruction.</p>
<p>Since we don't know in advance if we will need <code>LandingPad</code>s, we speculatively add all, and clean up after parsing is concluded. At this point the map from jump sources to destinations is complete.</p>
<p>Caveat: Currently we make no attempt to gracefully degrade when jump targets point into a multibyte operation (i.e. an illegal jump target).</p>
<p>Progress:</p>
<ul>
<li>relocation of branch edges works</li>
<li>open problem: the <code>need_deref</code> flag. What when different branches want to set the flag differently? Probably not a biggie as long as all control-flow paths end e.g. with <code>DW_OP_stack_value</code> (or without).</li>
</ul>
<p>Example:</p>
<div class="codehilite"><pre><span></span><code><span class="kt">DW_AT_location</span>  <span class="p">(</span><span class="kt">DW_OP_WASM_location</span> <span class="mh">0x0</span> <span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="kt">DW_OP_dup</span><span class="p">,</span> <span class="kt">DW_OP_lit1</span><span class="p">,</span> <span class="kt">DW_OP_and</span><span class="p">,</span> <span class="kt">DW_OP_bra</span> <span class="o">+</span><span class="mi">5</span><span class="p">,</span> <span class="kt">DW_OP_lit1</span><span class="p">,</span> <span class="kt">DW_OP_shr</span><span class="p">,</span> <span class="kt">DW_OP_skip</span> <span class="o">+</span><span class="mi">3</span><span class="p">,</span> <span class="kt">DW_OP_plus_uconst</span> <span class="mh">0x5</span><span class="p">,</span> <span class="kt">DW_OP_deref</span><span class="p">,</span> <span class="kt">DW_OP_stack_value</span><span class="p">)</span>
</code></pre></div>


<p>gets transformed into:</p>
<div class="codehilite"><pre><span></span><code><span class="kt">DW_AT_location</span>  <span class="p">(</span><span class="kt">DW_OP_breg6</span> <span class="kt">RBP</span><span class="o">-</span><span class="mi">36</span><span class="p">,</span> <span class="kt">DW_OP_deref</span><span class="p">,</span> <span class="kt">DW_OP_dup</span><span class="p">,</span> <span class="kt">DW_OP_lit1</span><span class="p">,</span> <span class="kt">DW_OP_and</span><span class="p">,</span> <span class="kt">DW_OP_bra</span> <span class="o">+</span><span class="mi">5</span><span class="p">,</span> <span class="kt">DW_OP_lit1</span><span class="p">,</span> <span class="kt">DW_OP_shr</span><span class="p">,</span> <span class="kt">DW_OP_skip</span> <span class="o">+</span><span class="mi">19</span><span class="p">,</span> <span class="kt">DW_OP_plus_uconst</span> <span class="mh">0x5</span><span class="p">,</span> <span class="kt">DW_OP_breg6</span> <span class="kt">RBP</span><span class="o">-</span><span class="mi">56</span><span class="p">,</span> <span class="kt">DW_OP_deref</span><span class="p">,</span> <span class="kt">DW_OP_consts</span> <span class="o">+</span><span class="mi">152</span><span class="p">,</span> <span class="kt">DW_OP_plus</span><span class="p">,</span> <span class="kt">DW_OP_deref</span><span class="p">,</span> <span class="kt">DW_OP_swap</span><span class="p">,</span> <span class="kt">DW_OP_const4u</span> <span class="mh">0xffffffff</span><span class="p">,</span> <span class="kt">DW_OP_and</span><span class="p">,</span> <span class="kt">DW_OP_plus</span><span class="p">,</span> <span class="kt">DW_OP_deref</span><span class="p">,</span> <span class="kt">DW_OP_stack_value</span><span class="p">)</span>
</code></pre></div>


<p>&lt;!--</p>
<p>Please ensure that the following steps are all taken care of before submitting<br>
the PR.</p>
<ul>
<li>
<p>[ ] This has been discussed in issue #..., or if not, please tell us why<br>
  here.</p>
</li>
<li>
<p>[ ] A short description of what this does, why it is needed; if the<br>
  description becomes long, the matter should probably be discussed in an issue<br>
  first.</p>
</li>
<li>
<p>[ ] This PR contains test cases, if meaningful.</p>
</li>
<li>[ ] A reviewer from the core maintainer team has been assigned for this PR.<br>
  If you don't know who could review this, please indicate so. The list of<br>
  suggested reviewers on the right can help you.</li>
</ul>
<p>Please ensure all communication adheres to the <a href="https://github.com/bytecodealliance/wasmtime/blob/master/CODE_OF_CONDUCT.md">code of
conduct</a>.<br>
--&gt;</p>
</blockquote>



<a name="208116647"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232143%20Relocation%20of%20DW_OP_%7Bbra%2C%20skip%7D%20instr.../near/208116647" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232143.20Relocation.20of.20DW_OP_.7Bbra.2C.20skip.7D.20instr.2E.2E.2E.html#208116647">(Aug 26 2020 at 16:43)</a>:</h4>
<p>ggreif updated <a href="https://github.com/bytecodealliance/wasmtime/pull/2143">PR #2143</a> from <code>main</code> to <code>main</code>:</p>
<blockquote>
<p>The fundamental problem is that the target distance of jump-like operations may change in the DWARF expression translation process. Intervening <code>DW_OP_deref</code> will expand to about 10 bytes, for example.</p>
<p>So the jumps must be relocated. We approach this task by inserting artificial <code>LandingPad</code> markers (new <code>CompiledExpressionParts</code> constructors) into the parsed vector at all relevant positions:</p>
<ul>
<li>immediately after a <code>Jump</code></li>
<li>at actual <code>Jump</code> targets</li>
<li>before <code>Code</code> chunks when the jump target goes properly into an inner bytecode position.</li>
</ul>
<p><code>LandingPad</code>s are identified by the bytecode instruction offset _before_ translation.</p>
<p>Additionally we now parse the <code>Jump</code> instructions. Upon <code>write</code>ing we record every <code>LandingPad</code>'s translated position into a relocation map and using that we are able to recompute the target distance for every jump-like instruction.</p>
<p>Since we don't know in advance if we will need <code>LandingPad</code>s, we speculatively add all, and clean up after parsing is concluded. At this point the map from jump sources to destinations is complete.</p>
<p>Caveat: Currently we make no attempt to gracefully degrade when jump targets point into a multibyte operation (i.e. an illegal jump target).</p>
<p>Progress:</p>
<ul>
<li>relocation of branch edges works</li>
<li>open problem: the <code>need_deref</code> flag. What when different branches want to set the flag differently? Probably not a biggie as long as all control-flow paths end e.g. with <code>DW_OP_stack_value</code> (or without).</li>
</ul>
<p>Example:</p>
<div class="codehilite"><pre><span></span><code><span class="kt">DW_AT_location</span>  <span class="p">(</span><span class="kt">DW_OP_WASM_location</span> <span class="mh">0x0</span> <span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="kt">DW_OP_dup</span><span class="p">,</span> <span class="kt">DW_OP_lit1</span><span class="p">,</span> <span class="kt">DW_OP_and</span><span class="p">,</span> <span class="kt">DW_OP_bra</span> <span class="o">+</span><span class="mi">5</span><span class="p">,</span> <span class="kt">DW_OP_lit1</span><span class="p">,</span> <span class="kt">DW_OP_shr</span><span class="p">,</span> <span class="kt">DW_OP_skip</span> <span class="o">+</span><span class="mi">3</span><span class="p">,</span> <span class="kt">DW_OP_plus_uconst</span> <span class="mh">0x5</span><span class="p">,</span> <span class="kt">DW_OP_deref</span><span class="p">,</span> <span class="kt">DW_OP_stack_value</span><span class="p">)</span>
</code></pre></div>


<p>gets transformed into:</p>
<div class="codehilite"><pre><span></span><code><span class="kt">DW_AT_location</span>  <span class="p">(</span><span class="kt">DW_OP_breg6</span> <span class="kt">RBP</span><span class="o">-</span><span class="mi">36</span><span class="p">,</span> <span class="kt">DW_OP_deref</span><span class="p">,</span> <span class="kt">DW_OP_dup</span><span class="p">,</span> <span class="kt">DW_OP_lit1</span><span class="p">,</span> <span class="kt">DW_OP_and</span><span class="p">,</span> <span class="kt">DW_OP_bra</span> <span class="o">+</span><span class="mi">5</span><span class="p">,</span> <span class="kt">DW_OP_lit1</span><span class="p">,</span> <span class="kt">DW_OP_shr</span><span class="p">,</span> <span class="kt">DW_OP_skip</span> <span class="o">+</span><span class="mi">19</span><span class="p">,</span> <span class="kt">DW_OP_plus_uconst</span> <span class="mh">0x5</span><span class="p">,</span> <span class="kt">DW_OP_breg6</span> <span class="kt">RBP</span><span class="o">-</span><span class="mi">56</span><span class="p">,</span> <span class="kt">DW_OP_deref</span><span class="p">,</span> <span class="kt">DW_OP_consts</span> <span class="o">+</span><span class="mi">152</span><span class="p">,</span> <span class="kt">DW_OP_plus</span><span class="p">,</span> <span class="kt">DW_OP_deref</span><span class="p">,</span> <span class="kt">DW_OP_swap</span><span class="p">,</span> <span class="kt">DW_OP_const4u</span> <span class="mh">0xffffffff</span><span class="p">,</span> <span class="kt">DW_OP_and</span><span class="p">,</span> <span class="kt">DW_OP_plus</span><span class="p">,</span> <span class="kt">DW_OP_deref</span><span class="p">,</span> <span class="kt">DW_OP_stack_value</span><span class="p">)</span>
</code></pre></div>


<p>&lt;!--</p>
<p>Please ensure that the following steps are all taken care of before submitting<br>
the PR.</p>
<ul>
<li>
<p>[ ] This has been discussed in issue #..., or if not, please tell us why<br>
  here.</p>
</li>
<li>
<p>[ ] A short description of what this does, why it is needed; if the<br>
  description becomes long, the matter should probably be discussed in an issue<br>
  first.</p>
</li>
<li>
<p>[ ] This PR contains test cases, if meaningful.</p>
</li>
<li>[ ] A reviewer from the core maintainer team has been assigned for this PR.<br>
  If you don't know who could review this, please indicate so. The list of<br>
  suggested reviewers on the right can help you.</li>
</ul>
<p>Please ensure all communication adheres to the <a href="https://github.com/bytecodealliance/wasmtime/blob/master/CODE_OF_CONDUCT.md">code of
conduct</a>.<br>
--&gt;</p>
</blockquote>



<a name="208117319"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232143%20Relocation%20of%20DW_OP_%7Bbra%2C%20skip%7D%20instr.../near/208117319" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232143.20Relocation.20of.20DW_OP_.7Bbra.2C.20skip.7D.20instr.2E.2E.2E.html#208117319">(Aug 26 2020 at 16:48)</a>:</h4>
<p>ggreif edited <a href="https://github.com/bytecodealliance/wasmtime/pull/2143">PR #2143</a> from <code>main</code> to <code>main</code>:</p>
<blockquote>
<p>The fundamental problem is that the target distance of jump-like operations may change in the DWARF expression translation process. Intervening <code>DW_OP_deref</code> will expand to about 10 bytes, for example.</p>
<p>So the jumps must be relocated. We approach this task by inserting artificial <code>LandingPad</code> markers (new <code>CompiledExpressionParts</code> constructors) into the parsed vector at actual <code>Jump</code> targets.</p>
<p><code>LandingPad</code>s are identified by <code>JumpTarget</code> tokens which are generated on the fly.</p>
<p>Additionally we now parse the <code>Jump</code> instructions. These also get corresponding <code>JumpTarget</code> token.</p>
<p>We bail in two situations:</p>
<ul>
<li><code>frame_</code> is too complicated (i.e. itself contains <code>Jump</code>)</li>
<li>some jump distance in the original expression is fishy.</li>
</ul>
<p>Open problem: the <code>need_deref</code> flag. What when different branches want to set the flag differently? Probably not a biggie as long as all control-flow paths end e.g. with <code>DW_OP_stack_value</code> (or without).</p>
<p>Example:</p>
<div class="codehilite"><pre><span></span><code><span class="kt">DW_AT_location</span>  <span class="p">(</span><span class="kt">DW_OP_WASM_location</span> <span class="mh">0x0</span> <span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="kt">DW_OP_dup</span><span class="p">,</span> <span class="kt">DW_OP_lit1</span><span class="p">,</span> <span class="kt">DW_OP_and</span><span class="p">,</span> <span class="kt">DW_OP_bra</span> <span class="o">+</span><span class="mi">5</span><span class="p">,</span> <span class="kt">DW_OP_lit1</span><span class="p">,</span> <span class="kt">DW_OP_shr</span><span class="p">,</span> <span class="kt">DW_OP_skip</span> <span class="o">+</span><span class="mi">3</span><span class="p">,</span> <span class="kt">DW_OP_plus_uconst</span> <span class="mh">0x5</span><span class="p">,</span> <span class="kt">DW_OP_deref</span><span class="p">,</span> <span class="kt">DW_OP_stack_value</span><span class="p">)</span>
</code></pre></div>


<p>gets transformed into:</p>
<div class="codehilite"><pre><span></span><code><span class="kt">DW_AT_location</span>  <span class="p">(</span><span class="kt">DW_OP_breg6</span> <span class="kt">RBP</span><span class="o">-</span><span class="mi">36</span><span class="p">,</span> <span class="kt">DW_OP_deref</span><span class="p">,</span> <span class="kt">DW_OP_dup</span><span class="p">,</span> <span class="kt">DW_OP_lit1</span><span class="p">,</span> <span class="kt">DW_OP_and</span><span class="p">,</span> <span class="kt">DW_OP_bra</span> <span class="o">+</span><span class="mi">5</span><span class="p">,</span> <span class="kt">DW_OP_lit1</span><span class="p">,</span> <span class="kt">DW_OP_shr</span><span class="p">,</span> <span class="kt">DW_OP_skip</span> <span class="o">+</span><span class="mi">19</span><span class="p">,</span> <span class="kt">DW_OP_plus_uconst</span> <span class="mh">0x5</span><span class="p">,</span> <span class="kt">DW_OP_breg6</span> <span class="kt">RBP</span><span class="o">-</span><span class="mi">56</span><span class="p">,</span> <span class="kt">DW_OP_deref</span><span class="p">,</span> <span class="kt">DW_OP_consts</span> <span class="o">+</span><span class="mi">152</span><span class="p">,</span> <span class="kt">DW_OP_plus</span><span class="p">,</span> <span class="kt">DW_OP_deref</span><span class="p">,</span> <span class="kt">DW_OP_swap</span><span class="p">,</span> <span class="kt">DW_OP_const4u</span> <span class="mh">0xffffffff</span><span class="p">,</span> <span class="kt">DW_OP_and</span><span class="p">,</span> <span class="kt">DW_OP_plus</span><span class="p">,</span> <span class="kt">DW_OP_deref</span><span class="p">,</span> <span class="kt">DW_OP_stack_value</span><span class="p">)</span>
</code></pre></div>


<p>&lt;!--</p>
<p>Please ensure that the following steps are all taken care of before submitting<br>
the PR.</p>
<ul>
<li>
<p>[ ] This has been discussed in issue #..., or if not, please tell us why<br>
  here.</p>
</li>
<li>
<p>[ ] A short description of what this does, why it is needed; if the<br>
  description becomes long, the matter should probably be discussed in an issue<br>
  first.</p>
</li>
<li>
<p>[ ] This PR contains test cases, if meaningful.</p>
</li>
<li>[ ] A reviewer from the core maintainer team has been assigned for this PR.<br>
  If you don't know who could review this, please indicate so. The list of<br>
  suggested reviewers on the right can help you.</li>
</ul>
<p>Please ensure all communication adheres to the <a href="https://github.com/bytecodealliance/wasmtime/blob/master/CODE_OF_CONDUCT.md">code of
conduct</a>.<br>
--&gt;</p>
</blockquote>



<a name="208117359"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232143%20Relocation%20of%20DW_OP_%7Bbra%2C%20skip%7D%20instr.../near/208117359" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232143.20Relocation.20of.20DW_OP_.7Bbra.2C.20skip.7D.20instr.2E.2E.2E.html#208117359">(Aug 26 2020 at 16:49)</a>:</h4>
<p>ggreif edited <a href="https://github.com/bytecodealliance/wasmtime/pull/2143">PR #2143</a> from <code>main</code> to <code>main</code>:</p>
<blockquote>
<p>The fundamental problem is that the target distance of jump-like operations may change in the DWARF expression translation process. Intervening <code>DW_OP_deref</code> will expand to about 10 bytes, for example.</p>
<p>So the jumps must be relocated. We approach this task by inserting artificial <code>LandingPad</code> markers (new <code>CompiledExpressionParts</code> constructors) into the parsed vector at actual <code>Jump</code> targets.</p>
<p><code>LandingPad</code>s are identified by <code>JumpTarget</code> tokens which are generated on the fly.</p>
<p>Additionally we now parse the <code>Jump</code> instructions. These also get corresponding <code>JumpTarget</code> token.</p>
<p>We bail in two situations:</p>
<ul>
<li><code>frame_base</code> is too complicated (i.e. itself contains <code>Jump</code>)</li>
<li>some jump distance in the original expression is fishy.</li>
</ul>
<p>Open problem: the <code>need_deref</code> flag. What when different branches want to set the flag differently? Probably not a biggie as long as all control-flow paths end e.g. with <code>DW_OP_stack_value</code> (or without).</p>
<p>Example:</p>
<div class="codehilite"><pre><span></span><code><span class="kt">DW_AT_location</span>  <span class="p">(</span><span class="kt">DW_OP_WASM_location</span> <span class="mh">0x0</span> <span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="kt">DW_OP_dup</span><span class="p">,</span> <span class="kt">DW_OP_lit1</span><span class="p">,</span> <span class="kt">DW_OP_and</span><span class="p">,</span> <span class="kt">DW_OP_bra</span> <span class="o">+</span><span class="mi">5</span><span class="p">,</span> <span class="kt">DW_OP_lit1</span><span class="p">,</span> <span class="kt">DW_OP_shr</span><span class="p">,</span> <span class="kt">DW_OP_skip</span> <span class="o">+</span><span class="mi">3</span><span class="p">,</span> <span class="kt">DW_OP_plus_uconst</span> <span class="mh">0x5</span><span class="p">,</span> <span class="kt">DW_OP_deref</span><span class="p">,</span> <span class="kt">DW_OP_stack_value</span><span class="p">)</span>
</code></pre></div>


<p>gets transformed into:</p>
<div class="codehilite"><pre><span></span><code><span class="kt">DW_AT_location</span>  <span class="p">(</span><span class="kt">DW_OP_breg6</span> <span class="kt">RBP</span><span class="o">-</span><span class="mi">36</span><span class="p">,</span> <span class="kt">DW_OP_deref</span><span class="p">,</span> <span class="kt">DW_OP_dup</span><span class="p">,</span> <span class="kt">DW_OP_lit1</span><span class="p">,</span> <span class="kt">DW_OP_and</span><span class="p">,</span> <span class="kt">DW_OP_bra</span> <span class="o">+</span><span class="mi">5</span><span class="p">,</span> <span class="kt">DW_OP_lit1</span><span class="p">,</span> <span class="kt">DW_OP_shr</span><span class="p">,</span> <span class="kt">DW_OP_skip</span> <span class="o">+</span><span class="mi">19</span><span class="p">,</span> <span class="kt">DW_OP_plus_uconst</span> <span class="mh">0x5</span><span class="p">,</span> <span class="kt">DW_OP_breg6</span> <span class="kt">RBP</span><span class="o">-</span><span class="mi">56</span><span class="p">,</span> <span class="kt">DW_OP_deref</span><span class="p">,</span> <span class="kt">DW_OP_consts</span> <span class="o">+</span><span class="mi">152</span><span class="p">,</span> <span class="kt">DW_OP_plus</span><span class="p">,</span> <span class="kt">DW_OP_deref</span><span class="p">,</span> <span class="kt">DW_OP_swap</span><span class="p">,</span> <span class="kt">DW_OP_const4u</span> <span class="mh">0xffffffff</span><span class="p">,</span> <span class="kt">DW_OP_and</span><span class="p">,</span> <span class="kt">DW_OP_plus</span><span class="p">,</span> <span class="kt">DW_OP_deref</span><span class="p">,</span> <span class="kt">DW_OP_stack_value</span><span class="p">)</span>
</code></pre></div>


<p>&lt;!--</p>
<p>Please ensure that the following steps are all taken care of before submitting<br>
the PR.</p>
<ul>
<li>
<p>[ ] This has been discussed in issue #..., or if not, please tell us why<br>
  here.</p>
</li>
<li>
<p>[ ] A short description of what this does, why it is needed; if the<br>
  description becomes long, the matter should probably be discussed in an issue<br>
  first.</p>
</li>
<li>
<p>[ ] This PR contains test cases, if meaningful.</p>
</li>
<li>[ ] A reviewer from the core maintainer team has been assigned for this PR.<br>
  If you don't know who could review this, please indicate so. The list of<br>
  suggested reviewers on the right can help you.</li>
</ul>
<p>Please ensure all communication adheres to the <a href="https://github.com/bytecodealliance/wasmtime/blob/master/CODE_OF_CONDUCT.md">code of
conduct</a>.<br>
--&gt;</p>
</blockquote>



<a name="208117423"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232143%20Relocation%20of%20DW_OP_%7Bbra%2C%20skip%7D%20instr.../near/208117423" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232143.20Relocation.20of.20DW_OP_.7Bbra.2C.20skip.7D.20instr.2E.2E.2E.html#208117423">(Aug 26 2020 at 16:49)</a>:</h4>
<p>ggreif edited <a href="https://github.com/bytecodealliance/wasmtime/pull/2143">PR #2143</a> from <code>main</code> to <code>main</code>:</p>
<blockquote>
<p>The fundamental problem is that the target distance of jump-like operations may change in the DWARF expression translation process. Intervening <code>DW_OP_deref</code> will expand to about 10 bytes, for example.</p>
<p>So the jumps must be relocated. We approach this task by inserting artificial <code>LandingPad</code> markers (new <code>CompiledExpressionParts</code> constructors) into the parsed vector at actual <code>Jump</code> targets.</p>
<p><code>LandingPad</code>s are identified by <code>JumpTargetMarker</code> tokens which are generated on the fly.</p>
<p>Additionally we now parse the <code>Jump</code> instructions. These also get corresponding <code>JumpTargetMarker</code> token.</p>
<p>We bail in two situations:</p>
<ul>
<li><code>frame_base</code> is too complicated (i.e. itself contains <code>Jump</code>)</li>
<li>some jump distance in the original expression is fishy.</li>
</ul>
<p>Open problem: the <code>need_deref</code> flag. What when different branches want to set the flag differently? Probably not a biggie as long as all control-flow paths end e.g. with <code>DW_OP_stack_value</code> (or without).</p>
<p>Example:</p>
<div class="codehilite"><pre><span></span><code><span class="kt">DW_AT_location</span>  <span class="p">(</span><span class="kt">DW_OP_WASM_location</span> <span class="mh">0x0</span> <span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="kt">DW_OP_dup</span><span class="p">,</span> <span class="kt">DW_OP_lit1</span><span class="p">,</span> <span class="kt">DW_OP_and</span><span class="p">,</span> <span class="kt">DW_OP_bra</span> <span class="o">+</span><span class="mi">5</span><span class="p">,</span> <span class="kt">DW_OP_lit1</span><span class="p">,</span> <span class="kt">DW_OP_shr</span><span class="p">,</span> <span class="kt">DW_OP_skip</span> <span class="o">+</span><span class="mi">3</span><span class="p">,</span> <span class="kt">DW_OP_plus_uconst</span> <span class="mh">0x5</span><span class="p">,</span> <span class="kt">DW_OP_deref</span><span class="p">,</span> <span class="kt">DW_OP_stack_value</span><span class="p">)</span>
</code></pre></div>


<p>gets transformed into:</p>
<div class="codehilite"><pre><span></span><code><span class="kt">DW_AT_location</span>  <span class="p">(</span><span class="kt">DW_OP_breg6</span> <span class="kt">RBP</span><span class="o">-</span><span class="mi">36</span><span class="p">,</span> <span class="kt">DW_OP_deref</span><span class="p">,</span> <span class="kt">DW_OP_dup</span><span class="p">,</span> <span class="kt">DW_OP_lit1</span><span class="p">,</span> <span class="kt">DW_OP_and</span><span class="p">,</span> <span class="kt">DW_OP_bra</span> <span class="o">+</span><span class="mi">5</span><span class="p">,</span> <span class="kt">DW_OP_lit1</span><span class="p">,</span> <span class="kt">DW_OP_shr</span><span class="p">,</span> <span class="kt">DW_OP_skip</span> <span class="o">+</span><span class="mi">19</span><span class="p">,</span> <span class="kt">DW_OP_plus_uconst</span> <span class="mh">0x5</span><span class="p">,</span> <span class="kt">DW_OP_breg6</span> <span class="kt">RBP</span><span class="o">-</span><span class="mi">56</span><span class="p">,</span> <span class="kt">DW_OP_deref</span><span class="p">,</span> <span class="kt">DW_OP_consts</span> <span class="o">+</span><span class="mi">152</span><span class="p">,</span> <span class="kt">DW_OP_plus</span><span class="p">,</span> <span class="kt">DW_OP_deref</span><span class="p">,</span> <span class="kt">DW_OP_swap</span><span class="p">,</span> <span class="kt">DW_OP_const4u</span> <span class="mh">0xffffffff</span><span class="p">,</span> <span class="kt">DW_OP_and</span><span class="p">,</span> <span class="kt">DW_OP_plus</span><span class="p">,</span> <span class="kt">DW_OP_deref</span><span class="p">,</span> <span class="kt">DW_OP_stack_value</span><span class="p">)</span>
</code></pre></div>


<p>&lt;!--</p>
<p>Please ensure that the following steps are all taken care of before submitting<br>
the PR.</p>
<ul>
<li>
<p>[ ] This has been discussed in issue #..., or if not, please tell us why<br>
  here.</p>
</li>
<li>
<p>[ ] A short description of what this does, why it is needed; if the<br>
  description becomes long, the matter should probably be discussed in an issue<br>
  first.</p>
</li>
<li>
<p>[ ] This PR contains test cases, if meaningful.</p>
</li>
<li>[ ] A reviewer from the core maintainer team has been assigned for this PR.<br>
  If you don't know who could review this, please indicate so. The list of<br>
  suggested reviewers on the right can help you.</li>
</ul>
<p>Please ensure all communication adheres to the <a href="https://github.com/bytecodealliance/wasmtime/blob/master/CODE_OF_CONDUCT.md">code of
conduct</a>.<br>
--&gt;</p>
</blockquote>



<a name="208117532"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232143%20Relocation%20of%20DW_OP_%7Bbra%2C%20skip%7D%20instr.../near/208117532" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232143.20Relocation.20of.20DW_OP_.7Bbra.2C.20skip.7D.20instr.2E.2E.2E.html#208117532">(Aug 26 2020 at 16:50)</a>:</h4>
<p>ggreif edited <a href="https://github.com/bytecodealliance/wasmtime/pull/2143">PR #2143</a> from <code>main</code> to <code>main</code>:</p>
<blockquote>
<p>The fundamental problem is that the target distance of jump-like operations may change in the DWARF expression translation process. Intervening <code>DW_OP_deref</code> will expand to about 10 bytes, for example.</p>
<p>So the jumps must be relocated. We approach this task by inserting artificial <code>LandingPad</code> markers (new <code>CompiledExpressionParts</code> constructors) into the parsed vector at actual <code>Jump</code> targets.</p>
<p><code>LandingPad</code>s are identified by <code>JumpTargetMarker</code> tokens which are generated on the fly.</p>
<p>Additionally we now parse the <code>Jump</code> instructions. These also get their corresponding <code>JumpTargetMarker</code> token.</p>
<p>We bail in two situations:</p>
<ul>
<li><code>frame_base</code> is too complicated (i.e. itself contains <code>Jump</code>)</li>
<li>some jump distance in the original expression is fishy.</li>
</ul>
<p>Open problem: the <code>need_deref</code> flag. What when different branches want to set the flag differently? Probably not a biggie as long as all control-flow paths end e.g. with <code>DW_OP_stack_value</code> (or without).</p>
<p>Example:</p>
<div class="codehilite"><pre><span></span><code><span class="kt">DW_AT_location</span>  <span class="p">(</span><span class="kt">DW_OP_WASM_location</span> <span class="mh">0x0</span> <span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="kt">DW_OP_dup</span><span class="p">,</span> <span class="kt">DW_OP_lit1</span><span class="p">,</span> <span class="kt">DW_OP_and</span><span class="p">,</span> <span class="kt">DW_OP_bra</span> <span class="o">+</span><span class="mi">5</span><span class="p">,</span> <span class="kt">DW_OP_lit1</span><span class="p">,</span> <span class="kt">DW_OP_shr</span><span class="p">,</span> <span class="kt">DW_OP_skip</span> <span class="o">+</span><span class="mi">3</span><span class="p">,</span> <span class="kt">DW_OP_plus_uconst</span> <span class="mh">0x5</span><span class="p">,</span> <span class="kt">DW_OP_deref</span><span class="p">,</span> <span class="kt">DW_OP_stack_value</span><span class="p">)</span>
</code></pre></div>


<p>gets transformed into:</p>
<div class="codehilite"><pre><span></span><code><span class="kt">DW_AT_location</span>  <span class="p">(</span><span class="kt">DW_OP_breg6</span> <span class="kt">RBP</span><span class="o">-</span><span class="mi">36</span><span class="p">,</span> <span class="kt">DW_OP_deref</span><span class="p">,</span> <span class="kt">DW_OP_dup</span><span class="p">,</span> <span class="kt">DW_OP_lit1</span><span class="p">,</span> <span class="kt">DW_OP_and</span><span class="p">,</span> <span class="kt">DW_OP_bra</span> <span class="o">+</span><span class="mi">5</span><span class="p">,</span> <span class="kt">DW_OP_lit1</span><span class="p">,</span> <span class="kt">DW_OP_shr</span><span class="p">,</span> <span class="kt">DW_OP_skip</span> <span class="o">+</span><span class="mi">19</span><span class="p">,</span> <span class="kt">DW_OP_plus_uconst</span> <span class="mh">0x5</span><span class="p">,</span> <span class="kt">DW_OP_breg6</span> <span class="kt">RBP</span><span class="o">-</span><span class="mi">56</span><span class="p">,</span> <span class="kt">DW_OP_deref</span><span class="p">,</span> <span class="kt">DW_OP_consts</span> <span class="o">+</span><span class="mi">152</span><span class="p">,</span> <span class="kt">DW_OP_plus</span><span class="p">,</span> <span class="kt">DW_OP_deref</span><span class="p">,</span> <span class="kt">DW_OP_swap</span><span class="p">,</span> <span class="kt">DW_OP_const4u</span> <span class="mh">0xffffffff</span><span class="p">,</span> <span class="kt">DW_OP_and</span><span class="p">,</span> <span class="kt">DW_OP_plus</span><span class="p">,</span> <span class="kt">DW_OP_deref</span><span class="p">,</span> <span class="kt">DW_OP_stack_value</span><span class="p">)</span>
</code></pre></div>


<p>&lt;!--</p>
<p>Please ensure that the following steps are all taken care of before submitting<br>
the PR.</p>
<ul>
<li>
<p>[ ] This has been discussed in issue #..., or if not, please tell us why<br>
  here.</p>
</li>
<li>
<p>[ ] A short description of what this does, why it is needed; if the<br>
  description becomes long, the matter should probably be discussed in an issue<br>
  first.</p>
</li>
<li>
<p>[ ] This PR contains test cases, if meaningful.</p>
</li>
<li>[ ] A reviewer from the core maintainer team has been assigned for this PR.<br>
  If you don't know who could review this, please indicate so. The list of<br>
  suggested reviewers on the right can help you.</li>
</ul>
<p>Please ensure all communication adheres to the <a href="https://github.com/bytecodealliance/wasmtime/blob/master/CODE_OF_CONDUCT.md">code of
conduct</a>.<br>
--&gt;</p>
</blockquote>



<a name="208117600"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232143%20Relocation%20of%20DW_OP_%7Bbra%2C%20skip%7D%20instr.../near/208117600" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232143.20Relocation.20of.20DW_OP_.7Bbra.2C.20skip.7D.20instr.2E.2E.2E.html#208117600">(Aug 26 2020 at 16:51)</a>:</h4>
<p>ggreif edited <a href="https://github.com/bytecodealliance/wasmtime/pull/2143">PR #2143</a> from <code>main</code> to <code>main</code>:</p>
<blockquote>
<p>The fundamental problem is that the target distance of jump-like operations may change in the DWARF expression translation process. Intervening <code>DW_OP_deref</code> will expand to about 10 bytes, for example.</p>
<p>So the jumps must be relocated. We approach this task by inserting artificial <code>LandingPad</code> markers (new <code>CompiledExpressionParts</code> constructors) into the parsed vector at actual <code>Jump</code> targets.</p>
<p><code>LandingPad</code>s are identified by <code>JumpTargetMarker</code> tokens which are generated on the fly.</p>
<p>Additionally we now parse the <code>Jump</code> instructions. These also get their corresponding <code>JumpTargetMarker</code> token.</p>
<p>We bail in two situations:</p>
<ul>
<li><code>frame_base</code> is too complicated (i.e. itself contains <code>Jump</code>)</li>
<li>some jump distance in the original expression is fishy.</li>
</ul>
<p>Open problem: the <code>need_deref</code> flag. What when different branches want to set the flag differently? Probably not a biggie as long as all control-flow paths end e.g. with <code>DW_OP_stack_value</code> (or without).</p>
<hr>
<p>Example:</p>
<div class="codehilite"><pre><span></span><code><span class="kt">DW_AT_location</span>  <span class="p">(</span><span class="kt">DW_OP_WASM_location</span> <span class="mh">0x0</span> <span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="kt">DW_OP_dup</span><span class="p">,</span> <span class="kt">DW_OP_lit1</span><span class="p">,</span> <span class="kt">DW_OP_and</span><span class="p">,</span> <span class="kt">DW_OP_bra</span> <span class="o">+</span><span class="mi">5</span><span class="p">,</span> <span class="kt">DW_OP_lit1</span><span class="p">,</span> <span class="kt">DW_OP_shr</span><span class="p">,</span> <span class="kt">DW_OP_skip</span> <span class="o">+</span><span class="mi">3</span><span class="p">,</span> <span class="kt">DW_OP_plus_uconst</span> <span class="mh">0x5</span><span class="p">,</span> <span class="kt">DW_OP_deref</span><span class="p">,</span> <span class="kt">DW_OP_stack_value</span><span class="p">)</span>
</code></pre></div>


<p>gets transformed into:</p>
<div class="codehilite"><pre><span></span><code><span class="kt">DW_AT_location</span>  <span class="p">(</span><span class="kt">DW_OP_breg6</span> <span class="kt">RBP</span><span class="o">-</span><span class="mi">36</span><span class="p">,</span> <span class="kt">DW_OP_deref</span><span class="p">,</span> <span class="kt">DW_OP_dup</span><span class="p">,</span> <span class="kt">DW_OP_lit1</span><span class="p">,</span> <span class="kt">DW_OP_and</span><span class="p">,</span> <span class="kt">DW_OP_bra</span> <span class="o">+</span><span class="mi">5</span><span class="p">,</span> <span class="kt">DW_OP_lit1</span><span class="p">,</span> <span class="kt">DW_OP_shr</span><span class="p">,</span> <span class="kt">DW_OP_skip</span> <span class="o">+</span><span class="mi">19</span><span class="p">,</span> <span class="kt">DW_OP_plus_uconst</span> <span class="mh">0x5</span><span class="p">,</span> <span class="kt">DW_OP_breg6</span> <span class="kt">RBP</span><span class="o">-</span><span class="mi">56</span><span class="p">,</span> <span class="kt">DW_OP_deref</span><span class="p">,</span> <span class="kt">DW_OP_consts</span> <span class="o">+</span><span class="mi">152</span><span class="p">,</span> <span class="kt">DW_OP_plus</span><span class="p">,</span> <span class="kt">DW_OP_deref</span><span class="p">,</span> <span class="kt">DW_OP_swap</span><span class="p">,</span> <span class="kt">DW_OP_const4u</span> <span class="mh">0xffffffff</span><span class="p">,</span> <span class="kt">DW_OP_and</span><span class="p">,</span> <span class="kt">DW_OP_plus</span><span class="p">,</span> <span class="kt">DW_OP_deref</span><span class="p">,</span> <span class="kt">DW_OP_stack_value</span><span class="p">)</span>
</code></pre></div>


<p>&lt;!--</p>
<p>Please ensure that the following steps are all taken care of before submitting<br>
the PR.</p>
<ul>
<li>
<p>[ ] This has been discussed in issue #..., or if not, please tell us why<br>
  here.</p>
</li>
<li>
<p>[ ] A short description of what this does, why it is needed; if the<br>
  description becomes long, the matter should probably be discussed in an issue<br>
  first.</p>
</li>
<li>
<p>[ ] This PR contains test cases, if meaningful.</p>
</li>
<li>[ ] A reviewer from the core maintainer team has been assigned for this PR.<br>
  If you don't know who could review this, please indicate so. The list of<br>
  suggested reviewers on the right can help you.</li>
</ul>
<p>Please ensure all communication adheres to the <a href="https://github.com/bytecodealliance/wasmtime/blob/master/CODE_OF_CONDUCT.md">code of
conduct</a>.<br>
--&gt;</p>
</blockquote>



<a name="208117852"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232143%20Relocation%20of%20DW_OP_%7Bbra%2C%20skip%7D%20instr.../near/208117852" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232143.20Relocation.20of.20DW_OP_.7Bbra.2C.20skip.7D.20instr.2E.2E.2E.html#208117852">(Aug 26 2020 at 16:52)</a>:</h4>
<p><strong>ggreif</strong> requested <a href="https://github.com/yurydelendik">yurydelendik</a> for a review on <a href="https://github.com/bytecodealliance/wasmtime/pull/2143">PR #2143</a>.</p>



<a name="208121703"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232143%20Relocation%20of%20DW_OP_%7Bbra%2C%20skip%7D%20instr.../near/208121703" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232143.20Relocation.20of.20DW_OP_.7Bbra.2C.20skip.7D.20instr.2E.2E.2E.html#208121703">(Aug 26 2020 at 17:23)</a>:</h4>
<p>yurydelendik submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/2143#pullrequestreview-475698760">PR Review</a>.</p>



<a name="208121704"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232143%20Relocation%20of%20DW_OP_%7Bbra%2C%20skip%7D%20instr.../near/208121704" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232143.20Relocation.20of.20DW_OP_.7Bbra.2C.20skip.7D.20instr.2E.2E.2E.html#208121704">(Aug 26 2020 at 17:23)</a>:</h4>
<p>yurydelendik submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/2143#pullrequestreview-475698760">PR Review</a>.</p>



<a name="208121705"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232143%20Relocation%20of%20DW_OP_%7Bbra%2C%20skip%7D%20instr.../near/208121705" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232143.20Relocation.20of.20DW_OP_.7Bbra.2C.20skip.7D.20instr.2E.2E.2E.html#208121705">(Aug 26 2020 at 17:23)</a>:</h4>
<p>yurydelendik created <a href="https://github.com/bytecodealliance/wasmtime/pull/2143#discussion_r477462182">PR Review Comment</a>:</p>
<blockquote>
<p>can we revert this change?</p>
</blockquote>



<a name="208121706"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232143%20Relocation%20of%20DW_OP_%7Bbra%2C%20skip%7D%20instr.../near/208121706" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232143.20Relocation.20of.20DW_OP_.7Bbra.2C.20skip.7D.20instr.2E.2E.2E.html#208121706">(Aug 26 2020 at 17:23)</a>:</h4>
<p>yurydelendik created <a href="https://github.com/bytecodealliance/wasmtime/pull/2143#discussion_r477463332">PR Review Comment</a>:</p>
<blockquote>
<div class="codehilite"><pre><span></span><code>    // Looks hacky but it is fast; does not need to be really exact.
</code></pre></div>


</blockquote>



<a name="208121708"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232143%20Relocation%20of%20DW_OP_%7Bbra%2C%20skip%7D%20instr.../near/208121708" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232143.20Relocation.20of.20DW_OP_.7Bbra.2C.20skip.7D.20instr.2E.2E.2E.html#208121708">(Aug 26 2020 at 17:23)</a>:</h4>
<p>yurydelendik created <a href="https://github.com/bytecodealliance/wasmtime/pull/2143#discussion_r477463672">PR Review Comment</a>:</p>
<blockquote>
<div class="codehilite"><pre><span></span><code>        // Create somewhat unique hash data -- using part of
</code></pre></div>


</blockquote>



<a name="208121709"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232143%20Relocation%20of%20DW_OP_%7Bbra%2C%20skip%7D%20instr.../near/208121709" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232143.20Relocation.20of.20DW_OP_.7Bbra.2C.20skip.7D.20instr.2E.2E.2E.html#208121709">(Aug 26 2020 at 17:23)</a>:</h4>
<p>yurydelendik created <a href="https://github.com/bytecodealliance/wasmtime/pull/2143#discussion_r477464419">PR Review Comment</a>:</p>
<blockquote>
<div class="codehilite"><pre><span></span><code>        // Internal hash_data test (theoretically can fail intermittently).
</code></pre></div>


</blockquote>



<a name="208123483"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232143%20Relocation%20of%20DW_OP_%7Bbra%2C%20skip%7D%20instr.../near/208123483" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232143.20Relocation.20of.20DW_OP_.7Bbra.2C.20skip.7D.20instr.2E.2E.2E.html#208123483">(Aug 26 2020 at 17:39)</a>:</h4>
<p>yurydelendik updated <a href="https://github.com/bytecodealliance/wasmtime/pull/2143">PR #2143</a> from <code>main</code> to <code>main</code>:</p>
<blockquote>
<p>The fundamental problem is that the target distance of jump-like operations may change in the DWARF expression translation process. Intervening <code>DW_OP_deref</code> will expand to about 10 bytes, for example.</p>
<p>So the jumps must be relocated. We approach this task by inserting artificial <code>LandingPad</code> markers (new <code>CompiledExpressionParts</code> constructors) into the parsed vector at actual <code>Jump</code> targets.</p>
<p><code>LandingPad</code>s are identified by <code>JumpTargetMarker</code> tokens which are generated on the fly.</p>
<p>Additionally we now parse the <code>Jump</code> instructions. These also get their corresponding <code>JumpTargetMarker</code> token.</p>
<p>We bail in two situations:</p>
<ul>
<li><code>frame_base</code> is too complicated (i.e. itself contains <code>Jump</code>)</li>
<li>some jump distance in the original expression is fishy.</li>
</ul>
<p>Open problem: the <code>need_deref</code> flag. What when different branches want to set the flag differently? Probably not a biggie as long as all control-flow paths end e.g. with <code>DW_OP_stack_value</code> (or without).</p>
<hr>
<p>Example:</p>
<div class="codehilite"><pre><span></span><code><span class="kt">DW_AT_location</span>  <span class="p">(</span><span class="kt">DW_OP_WASM_location</span> <span class="mh">0x0</span> <span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="kt">DW_OP_dup</span><span class="p">,</span> <span class="kt">DW_OP_lit1</span><span class="p">,</span> <span class="kt">DW_OP_and</span><span class="p">,</span> <span class="kt">DW_OP_bra</span> <span class="o">+</span><span class="mi">5</span><span class="p">,</span> <span class="kt">DW_OP_lit1</span><span class="p">,</span> <span class="kt">DW_OP_shr</span><span class="p">,</span> <span class="kt">DW_OP_skip</span> <span class="o">+</span><span class="mi">3</span><span class="p">,</span> <span class="kt">DW_OP_plus_uconst</span> <span class="mh">0x5</span><span class="p">,</span> <span class="kt">DW_OP_deref</span><span class="p">,</span> <span class="kt">DW_OP_stack_value</span><span class="p">)</span>
</code></pre></div>


<p>gets transformed into:</p>
<div class="codehilite"><pre><span></span><code><span class="kt">DW_AT_location</span>  <span class="p">(</span><span class="kt">DW_OP_breg6</span> <span class="kt">RBP</span><span class="o">-</span><span class="mi">36</span><span class="p">,</span> <span class="kt">DW_OP_deref</span><span class="p">,</span> <span class="kt">DW_OP_dup</span><span class="p">,</span> <span class="kt">DW_OP_lit1</span><span class="p">,</span> <span class="kt">DW_OP_and</span><span class="p">,</span> <span class="kt">DW_OP_bra</span> <span class="o">+</span><span class="mi">5</span><span class="p">,</span> <span class="kt">DW_OP_lit1</span><span class="p">,</span> <span class="kt">DW_OP_shr</span><span class="p">,</span> <span class="kt">DW_OP_skip</span> <span class="o">+</span><span class="mi">19</span><span class="p">,</span> <span class="kt">DW_OP_plus_uconst</span> <span class="mh">0x5</span><span class="p">,</span> <span class="kt">DW_OP_breg6</span> <span class="kt">RBP</span><span class="o">-</span><span class="mi">56</span><span class="p">,</span> <span class="kt">DW_OP_deref</span><span class="p">,</span> <span class="kt">DW_OP_consts</span> <span class="o">+</span><span class="mi">152</span><span class="p">,</span> <span class="kt">DW_OP_plus</span><span class="p">,</span> <span class="kt">DW_OP_deref</span><span class="p">,</span> <span class="kt">DW_OP_swap</span><span class="p">,</span> <span class="kt">DW_OP_const4u</span> <span class="mh">0xffffffff</span><span class="p">,</span> <span class="kt">DW_OP_and</span><span class="p">,</span> <span class="kt">DW_OP_plus</span><span class="p">,</span> <span class="kt">DW_OP_deref</span><span class="p">,</span> <span class="kt">DW_OP_stack_value</span><span class="p">)</span>
</code></pre></div>


<p>&lt;!--</p>
<p>Please ensure that the following steps are all taken care of before submitting<br>
the PR.</p>
<ul>
<li>
<p>[ ] This has been discussed in issue #..., or if not, please tell us why<br>
  here.</p>
</li>
<li>
<p>[ ] A short description of what this does, why it is needed; if the<br>
  description becomes long, the matter should probably be discussed in an issue<br>
  first.</p>
</li>
<li>
<p>[ ] This PR contains test cases, if meaningful.</p>
</li>
<li>[ ] A reviewer from the core maintainer team has been assigned for this PR.<br>
  If you don't know who could review this, please indicate so. The list of<br>
  suggested reviewers on the right can help you.</li>
</ul>
<p>Please ensure all communication adheres to the <a href="https://github.com/bytecodealliance/wasmtime/blob/master/CODE_OF_CONDUCT.md">code of
conduct</a>.<br>
--&gt;</p>
</blockquote>



<a name="208123489"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232143%20Relocation%20of%20DW_OP_%7Bbra%2C%20skip%7D%20instr.../near/208123489" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232143.20Relocation.20of.20DW_OP_.7Bbra.2C.20skip.7D.20instr.2E.2E.2E.html#208123489">(Aug 26 2020 at 17:39)</a>:</h4>
<p>yurydelendik deleted <a href="https://github.com/bytecodealliance/wasmtime/pull/2143#discussion_r477464419">PR Review Comment</a>.</p>



<a name="208123496"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232143%20Relocation%20of%20DW_OP_%7Bbra%2C%20skip%7D%20instr.../near/208123496" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232143.20Relocation.20of.20DW_OP_.7Bbra.2C.20skip.7D.20instr.2E.2E.2E.html#208123496">(Aug 26 2020 at 17:39)</a>:</h4>
<p>yurydelendik deleted <a href="https://github.com/bytecodealliance/wasmtime/pull/2143#discussion_r477463672">PR Review Comment</a>.</p>



<a name="208123501"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232143%20Relocation%20of%20DW_OP_%7Bbra%2C%20skip%7D%20instr.../near/208123501" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232143.20Relocation.20of.20DW_OP_.7Bbra.2C.20skip.7D.20instr.2E.2E.2E.html#208123501">(Aug 26 2020 at 17:39)</a>:</h4>
<p>yurydelendik deleted <a href="https://github.com/bytecodealliance/wasmtime/pull/2143#discussion_r477463332">PR Review Comment</a>.</p>



<a name="208130383"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232143%20Relocation%20of%20DW_OP_%7Bbra%2C%20skip%7D%20instr.../near/208130383" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232143.20Relocation.20of.20DW_OP_.7Bbra.2C.20skip.7D.20instr.2E.2E.2E.html#208130383">(Aug 26 2020 at 18:35)</a>:</h4>
<p>ggreif submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/2143#pullrequestreview-475754403">PR Review</a>.</p>



<a name="208130384"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232143%20Relocation%20of%20DW_OP_%7Bbra%2C%20skip%7D%20instr.../near/208130384" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232143.20Relocation.20of.20DW_OP_.7Bbra.2C.20skip.7D.20instr.2E.2E.2E.html#208130384">(Aug 26 2020 at 18:35)</a>:</h4>
<p>ggreif created <a href="https://github.com/bytecodealliance/wasmtime/pull/2143#discussion_r477506348">PR Review Comment</a>:</p>
<blockquote>
<div class="codehilite"><pre><span></span><code>                parts.push(CompiledExpressionPart::Code(code_chunk));
                code_chunk = Vec::new();
</code></pre></div>


<p>like this?</p>
</blockquote>



<a name="208130420"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232143%20Relocation%20of%20DW_OP_%7Bbra%2C%20skip%7D%20instr.../near/208130420" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232143.20Relocation.20of.20DW_OP_.7Bbra.2C.20skip.7D.20instr.2E.2E.2E.html#208130420">(Aug 26 2020 at 18:35)</a>:</h4>
<p>ggreif deleted <a href="https://github.com/bytecodealliance/wasmtime/pull/2143#discussion_r477506348">PR Review Comment</a>.</p>



<a name="208130552"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232143%20Relocation%20of%20DW_OP_%7Bbra%2C%20skip%7D%20instr.../near/208130552" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232143.20Relocation.20of.20DW_OP_.7Bbra.2C.20skip.7D.20instr.2E.2E.2E.html#208130552">(Aug 26 2020 at 18:36)</a>:</h4>
<p>ggreif submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/2143#pullrequestreview-475755244">PR Review</a>.</p>



<a name="208130554"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232143%20Relocation%20of%20DW_OP_%7Bbra%2C%20skip%7D%20instr.../near/208130554" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232143.20Relocation.20of.20DW_OP_.7Bbra.2C.20skip.7D.20instr.2E.2E.2E.html#208130554">(Aug 26 2020 at 18:36)</a>:</h4>
<p>ggreif created <a href="https://github.com/bytecodealliance/wasmtime/pull/2143#discussion_r477507023">PR Review Comment</a>:</p>
<blockquote>
<div class="codehilite"><pre><span></span><code>                parts.push(CompiledExpressionPart::Code(code_chunk));
                code_chunk = Vec::new();
</code></pre></div>


</blockquote>



<a name="208130599"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232143%20Relocation%20of%20DW_OP_%7Bbra%2C%20skip%7D%20instr.../near/208130599" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232143.20Relocation.20of.20DW_OP_.7Bbra.2C.20skip.7D.20instr.2E.2E.2E.html#208130599">(Aug 26 2020 at 18:37)</a>:</h4>
<p>ggreif edited <a href="https://github.com/bytecodealliance/wasmtime/pull/2143#discussion_r477507023">PR Review Comment</a>.</p>



<a name="208130893"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232143%20Relocation%20of%20DW_OP_%7Bbra%2C%20skip%7D%20instr.../near/208130893" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232143.20Relocation.20of.20DW_OP_.7Bbra.2C.20skip.7D.20instr.2E.2E.2E.html#208130893">(Aug 26 2020 at 18:39)</a>:</h4>
<p>ggreif edited <a href="https://github.com/bytecodealliance/wasmtime/pull/2143#discussion_r477507023">PR Review Comment</a>.</p>



<a name="208131016"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232143%20Relocation%20of%20DW_OP_%7Bbra%2C%20skip%7D%20instr.../near/208131016" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232143.20Relocation.20of.20DW_OP_.7Bbra.2C.20skip.7D.20instr.2E.2E.2E.html#208131016">(Aug 26 2020 at 18:40)</a>:</h4>
<p>ggreif edited <a href="https://github.com/bytecodealliance/wasmtime/pull/2143#discussion_r477507023">PR Review Comment</a>.</p>



<a name="208131033"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232143%20Relocation%20of%20DW_OP_%7Bbra%2C%20skip%7D%20instr.../near/208131033" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232143.20Relocation.20of.20DW_OP_.7Bbra.2C.20skip.7D.20instr.2E.2E.2E.html#208131033">(Aug 26 2020 at 18:40)</a>:</h4>
<p>ggreif edited <a href="https://github.com/bytecodealliance/wasmtime/pull/2143#discussion_r477507023">PR Review Comment</a>.</p>



<a name="208131661"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232143%20Relocation%20of%20DW_OP_%7Bbra%2C%20skip%7D%20instr.../near/208131661" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232143.20Relocation.20of.20DW_OP_.7Bbra.2C.20skip.7D.20instr.2E.2E.2E.html#208131661">(Aug 26 2020 at 18:44)</a>:</h4>
<p>yurydelendik submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/2143#pullrequestreview-475760794">PR Review</a>.</p>



<a name="208131662"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232143%20Relocation%20of%20DW_OP_%7Bbra%2C%20skip%7D%20instr.../near/208131662" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232143.20Relocation.20of.20DW_OP_.7Bbra.2C.20skip.7D.20instr.2E.2E.2E.html#208131662">(Aug 26 2020 at 18:44)</a>:</h4>
<p>yurydelendik created <a href="https://github.com/bytecodealliance/wasmtime/pull/2143#discussion_r477511432">PR Review Comment</a>:</p>
<blockquote>
<p>Can <code>push!(</code> stay? I was thinking about <code>code_chunk.clone()</code> and <code>code_chunk = Vec::new()</code> stuff.</p>
</blockquote>



<a name="208131853"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232143%20Relocation%20of%20DW_OP_%7Bbra%2C%20skip%7D%20instr.../near/208131853" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232143.20Relocation.20of.20DW_OP_.7Bbra.2C.20skip.7D.20instr.2E.2E.2E.html#208131853">(Aug 26 2020 at 18:46)</a>:</h4>
<p>ggreif edited <a href="https://github.com/bytecodealliance/wasmtime/pull/2143#discussion_r477507023">PR Review Comment</a>.</p>



<a name="208132312"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232143%20Relocation%20of%20DW_OP_%7Bbra%2C%20skip%7D%20instr.../near/208132312" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232143.20Relocation.20of.20DW_OP_.7Bbra.2C.20skip.7D.20instr.2E.2E.2E.html#208132312">(Aug 26 2020 at 18:51)</a>:</h4>
<p>ggreif submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/2143#pullrequestreview-475765535">PR Review</a>.</p>



<a name="208132313"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232143%20Relocation%20of%20DW_OP_%7Bbra%2C%20skip%7D%20instr.../near/208132313" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232143.20Relocation.20of.20DW_OP_.7Bbra.2C.20skip.7D.20instr.2E.2E.2E.html#208132313">(Aug 26 2020 at 18:51)</a>:</h4>
<p>ggreif created <a href="https://github.com/bytecodealliance/wasmtime/pull/2143#discussion_r477515226">PR Review Comment</a>:</p>
<blockquote>
<p>I hope to keep <code>push!(</code> (see above), but no idea how to fix the warning without artificially reading the <code>code_chunk</code> after the last macro invocation.</p>
</blockquote>



<a name="208132338"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232143%20Relocation%20of%20DW_OP_%7Bbra%2C%20skip%7D%20instr.../near/208132338" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232143.20Relocation.20of.20DW_OP_.7Bbra.2C.20skip.7D.20instr.2E.2E.2E.html#208132338">(Aug 26 2020 at 18:51)</a>:</h4>
<p>ggreif edited <a href="https://github.com/bytecodealliance/wasmtime/pull/2143#discussion_r477515226">PR Review Comment</a>.</p>



<a name="208133881"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232143%20Relocation%20of%20DW_OP_%7Bbra%2C%20skip%7D%20instr.../near/208133881" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232143.20Relocation.20of.20DW_OP_.7Bbra.2C.20skip.7D.20instr.2E.2E.2E.html#208133881">(Aug 26 2020 at 19:04)</a>:</h4>
<p>yurydelendik submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/2143#pullrequestreview-475778678">PR Review</a>.</p>



<a name="208133882"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232143%20Relocation%20of%20DW_OP_%7Bbra%2C%20skip%7D%20instr.../near/208133882" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232143.20Relocation.20of.20DW_OP_.7Bbra.2C.20skip.7D.20instr.2E.2E.2E.html#208133882">(Aug 26 2020 at 19:04)</a>:</h4>
<p>yurydelendik created <a href="https://github.com/bytecodealliance/wasmtime/pull/2143#discussion_r477524096">PR Review Comment</a>:</p>
<blockquote>
<p>I see. Yeah, it just needs <code>if !code_chunk.is_empty() {</code> without <code>code_chunk = Vec::new()</code></p>
</blockquote>



<a name="208142964"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232143%20Relocation%20of%20DW_OP_%7Bbra%2C%20skip%7D%20instr.../near/208142964" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232143.20Relocation.20of.20DW_OP_.7Bbra.2C.20skip.7D.20instr.2E.2E.2E.html#208142964">(Aug 26 2020 at 20:17)</a>:</h4>
<p>ggreif updated <a href="https://github.com/bytecodealliance/wasmtime/pull/2143">PR #2143</a> from <code>main</code> to <code>main</code>:</p>
<blockquote>
<p>The fundamental problem is that the target distance of jump-like operations may change in the DWARF expression translation process. Intervening <code>DW_OP_deref</code> will expand to about 10 bytes, for example.</p>
<p>So the jumps must be relocated. We approach this task by inserting artificial <code>LandingPad</code> markers (new <code>CompiledExpressionParts</code> constructors) into the parsed vector at actual <code>Jump</code> targets.</p>
<p><code>LandingPad</code>s are identified by <code>JumpTargetMarker</code> tokens which are generated on the fly.</p>
<p>Additionally we now parse the <code>Jump</code> instructions. These also get their corresponding <code>JumpTargetMarker</code> token.</p>
<p>We bail in two situations:</p>
<ul>
<li><code>frame_base</code> is too complicated (i.e. itself contains <code>Jump</code>)</li>
<li>some jump distance in the original expression is fishy.</li>
</ul>
<p>Open problem: the <code>need_deref</code> flag. What when different branches want to set the flag differently? Probably not a biggie as long as all control-flow paths end e.g. with <code>DW_OP_stack_value</code> (or without).</p>
<hr>
<p>Example:</p>
<div class="codehilite"><pre><span></span><code><span class="kt">DW_AT_location</span>  <span class="p">(</span><span class="kt">DW_OP_WASM_location</span> <span class="mh">0x0</span> <span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="kt">DW_OP_dup</span><span class="p">,</span> <span class="kt">DW_OP_lit1</span><span class="p">,</span> <span class="kt">DW_OP_and</span><span class="p">,</span> <span class="kt">DW_OP_bra</span> <span class="o">+</span><span class="mi">5</span><span class="p">,</span> <span class="kt">DW_OP_lit1</span><span class="p">,</span> <span class="kt">DW_OP_shr</span><span class="p">,</span> <span class="kt">DW_OP_skip</span> <span class="o">+</span><span class="mi">3</span><span class="p">,</span> <span class="kt">DW_OP_plus_uconst</span> <span class="mh">0x5</span><span class="p">,</span> <span class="kt">DW_OP_deref</span><span class="p">,</span> <span class="kt">DW_OP_stack_value</span><span class="p">)</span>
</code></pre></div>


<p>gets transformed into:</p>
<div class="codehilite"><pre><span></span><code><span class="kt">DW_AT_location</span>  <span class="p">(</span><span class="kt">DW_OP_breg6</span> <span class="kt">RBP</span><span class="o">-</span><span class="mi">36</span><span class="p">,</span> <span class="kt">DW_OP_deref</span><span class="p">,</span> <span class="kt">DW_OP_dup</span><span class="p">,</span> <span class="kt">DW_OP_lit1</span><span class="p">,</span> <span class="kt">DW_OP_and</span><span class="p">,</span> <span class="kt">DW_OP_bra</span> <span class="o">+</span><span class="mi">5</span><span class="p">,</span> <span class="kt">DW_OP_lit1</span><span class="p">,</span> <span class="kt">DW_OP_shr</span><span class="p">,</span> <span class="kt">DW_OP_skip</span> <span class="o">+</span><span class="mi">19</span><span class="p">,</span> <span class="kt">DW_OP_plus_uconst</span> <span class="mh">0x5</span><span class="p">,</span> <span class="kt">DW_OP_breg6</span> <span class="kt">RBP</span><span class="o">-</span><span class="mi">56</span><span class="p">,</span> <span class="kt">DW_OP_deref</span><span class="p">,</span> <span class="kt">DW_OP_consts</span> <span class="o">+</span><span class="mi">152</span><span class="p">,</span> <span class="kt">DW_OP_plus</span><span class="p">,</span> <span class="kt">DW_OP_deref</span><span class="p">,</span> <span class="kt">DW_OP_swap</span><span class="p">,</span> <span class="kt">DW_OP_const4u</span> <span class="mh">0xffffffff</span><span class="p">,</span> <span class="kt">DW_OP_and</span><span class="p">,</span> <span class="kt">DW_OP_plus</span><span class="p">,</span> <span class="kt">DW_OP_deref</span><span class="p">,</span> <span class="kt">DW_OP_stack_value</span><span class="p">)</span>
</code></pre></div>


<p>&lt;!--</p>
<p>Please ensure that the following steps are all taken care of before submitting<br>
the PR.</p>
<ul>
<li>
<p>[ ] This has been discussed in issue #..., or if not, please tell us why<br>
  here.</p>
</li>
<li>
<p>[ ] A short description of what this does, why it is needed; if the<br>
  description becomes long, the matter should probably be discussed in an issue<br>
  first.</p>
</li>
<li>
<p>[ ] This PR contains test cases, if meaningful.</p>
</li>
<li>[ ] A reviewer from the core maintainer team has been assigned for this PR.<br>
  If you don't know who could review this, please indicate so. The list of<br>
  suggested reviewers on the right can help you.</li>
</ul>
<p>Please ensure all communication adheres to the <a href="https://github.com/bytecodealliance/wasmtime/blob/master/CODE_OF_CONDUCT.md">code of
conduct</a>.<br>
--&gt;</p>
</blockquote>



<a name="208143094"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232143%20Relocation%20of%20DW_OP_%7Bbra%2C%20skip%7D%20instr.../near/208143094" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232143.20Relocation.20of.20DW_OP_.7Bbra.2C.20skip.7D.20instr.2E.2E.2E.html#208143094">(Aug 26 2020 at 20:18)</a>:</h4>
<p>ggreif submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/2143#pullrequestreview-475827880">PR Review</a>.</p>



<a name="208143095"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232143%20Relocation%20of%20DW_OP_%7Bbra%2C%20skip%7D%20instr.../near/208143095" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232143.20Relocation.20of.20DW_OP_.7Bbra.2C.20skip.7D.20instr.2E.2E.2E.html#208143095">(Aug 26 2020 at 20:18)</a>:</h4>
<p>ggreif created <a href="https://github.com/bytecodealliance/wasmtime/pull/2143#discussion_r477564560">PR Review Comment</a>:</p>
<blockquote>
<p>I did something that works. But I feel dense and am not sure if this is what you meant. Please feel free to fix.</p>
</blockquote>



<a name="208143326"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232143%20Relocation%20of%20DW_OP_%7Bbra%2C%20skip%7D%20instr.../near/208143326" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232143.20Relocation.20of.20DW_OP_.7Bbra.2C.20skip.7D.20instr.2E.2E.2E.html#208143326">(Aug 26 2020 at 20:20)</a>:</h4>
<p>ggreif updated <a href="https://github.com/bytecodealliance/wasmtime/pull/2143">PR #2143</a> from <code>main</code> to <code>main</code>:</p>
<blockquote>
<p>The fundamental problem is that the target distance of jump-like operations may change in the DWARF expression translation process. Intervening <code>DW_OP_deref</code> will expand to about 10 bytes, for example.</p>
<p>So the jumps must be relocated. We approach this task by inserting artificial <code>LandingPad</code> markers (new <code>CompiledExpressionParts</code> constructors) into the parsed vector at actual <code>Jump</code> targets.</p>
<p><code>LandingPad</code>s are identified by <code>JumpTargetMarker</code> tokens which are generated on the fly.</p>
<p>Additionally we now parse the <code>Jump</code> instructions. These also get their corresponding <code>JumpTargetMarker</code> token.</p>
<p>We bail in two situations:</p>
<ul>
<li><code>frame_base</code> is too complicated (i.e. itself contains <code>Jump</code>)</li>
<li>some jump distance in the original expression is fishy.</li>
</ul>
<p>Open problem: the <code>need_deref</code> flag. What when different branches want to set the flag differently? Probably not a biggie as long as all control-flow paths end e.g. with <code>DW_OP_stack_value</code> (or without).</p>
<hr>
<p>Example:</p>
<div class="codehilite"><pre><span></span><code><span class="kt">DW_AT_location</span>  <span class="p">(</span><span class="kt">DW_OP_WASM_location</span> <span class="mh">0x0</span> <span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="kt">DW_OP_dup</span><span class="p">,</span> <span class="kt">DW_OP_lit1</span><span class="p">,</span> <span class="kt">DW_OP_and</span><span class="p">,</span> <span class="kt">DW_OP_bra</span> <span class="o">+</span><span class="mi">5</span><span class="p">,</span> <span class="kt">DW_OP_lit1</span><span class="p">,</span> <span class="kt">DW_OP_shr</span><span class="p">,</span> <span class="kt">DW_OP_skip</span> <span class="o">+</span><span class="mi">3</span><span class="p">,</span> <span class="kt">DW_OP_plus_uconst</span> <span class="mh">0x5</span><span class="p">,</span> <span class="kt">DW_OP_deref</span><span class="p">,</span> <span class="kt">DW_OP_stack_value</span><span class="p">)</span>
</code></pre></div>


<p>gets transformed into:</p>
<div class="codehilite"><pre><span></span><code><span class="kt">DW_AT_location</span>  <span class="p">(</span><span class="kt">DW_OP_breg6</span> <span class="kt">RBP</span><span class="o">-</span><span class="mi">36</span><span class="p">,</span> <span class="kt">DW_OP_deref</span><span class="p">,</span> <span class="kt">DW_OP_dup</span><span class="p">,</span> <span class="kt">DW_OP_lit1</span><span class="p">,</span> <span class="kt">DW_OP_and</span><span class="p">,</span> <span class="kt">DW_OP_bra</span> <span class="o">+</span><span class="mi">5</span><span class="p">,</span> <span class="kt">DW_OP_lit1</span><span class="p">,</span> <span class="kt">DW_OP_shr</span><span class="p">,</span> <span class="kt">DW_OP_skip</span> <span class="o">+</span><span class="mi">19</span><span class="p">,</span> <span class="kt">DW_OP_plus_uconst</span> <span class="mh">0x5</span><span class="p">,</span> <span class="kt">DW_OP_breg6</span> <span class="kt">RBP</span><span class="o">-</span><span class="mi">56</span><span class="p">,</span> <span class="kt">DW_OP_deref</span><span class="p">,</span> <span class="kt">DW_OP_consts</span> <span class="o">+</span><span class="mi">152</span><span class="p">,</span> <span class="kt">DW_OP_plus</span><span class="p">,</span> <span class="kt">DW_OP_deref</span><span class="p">,</span> <span class="kt">DW_OP_swap</span><span class="p">,</span> <span class="kt">DW_OP_const4u</span> <span class="mh">0xffffffff</span><span class="p">,</span> <span class="kt">DW_OP_and</span><span class="p">,</span> <span class="kt">DW_OP_plus</span><span class="p">,</span> <span class="kt">DW_OP_deref</span><span class="p">,</span> <span class="kt">DW_OP_stack_value</span><span class="p">)</span>
</code></pre></div>


<p>&lt;!--</p>
<p>Please ensure that the following steps are all taken care of before submitting<br>
the PR.</p>
<ul>
<li>
<p>[ ] This has been discussed in issue #..., or if not, please tell us why<br>
  here.</p>
</li>
<li>
<p>[ ] A short description of what this does, why it is needed; if the<br>
  description becomes long, the matter should probably be discussed in an issue<br>
  first.</p>
</li>
<li>
<p>[ ] This PR contains test cases, if meaningful.</p>
</li>
<li>[ ] A reviewer from the core maintainer team has been assigned for this PR.<br>
  If you don't know who could review this, please indicate so. The list of<br>
  suggested reviewers on the right can help you.</li>
</ul>
<p>Please ensure all communication adheres to the <a href="https://github.com/bytecodealliance/wasmtime/blob/master/CODE_OF_CONDUCT.md">code of
conduct</a>.<br>
--&gt;</p>
</blockquote>



<a name="208143550"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232143%20Relocation%20of%20DW_OP_%7Bbra%2C%20skip%7D%20instr.../near/208143550" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232143.20Relocation.20of.20DW_OP_.7Bbra.2C.20skip.7D.20instr.2E.2E.2E.html#208143550">(Aug 26 2020 at 20:22)</a>:</h4>
<p>ggreif submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/2143#pullrequestreview-475830342">PR Review</a>.</p>



<a name="208143551"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232143%20Relocation%20of%20DW_OP_%7Bbra%2C%20skip%7D%20instr.../near/208143551" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232143.20Relocation.20of.20DW_OP_.7Bbra.2C.20skip.7D.20instr.2E.2E.2E.html#208143551">(Aug 26 2020 at 20:22)</a>:</h4>
<p>ggreif created <a href="https://github.com/bytecodealliance/wasmtime/pull/2143#discussion_r477566577">PR Review Comment</a>:</p>
<blockquote>
<div class="codehilite"><pre><span></span><code>            // Discarding out-of-bounds jumps (also some of falsely detected ops)
</code></pre></div>


</blockquote>



<a name="208143558"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232143%20Relocation%20of%20DW_OP_%7Bbra%2C%20skip%7D%20instr.../near/208143558" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232143.20Relocation.20of.20DW_OP_.7Bbra.2C.20skip.7D.20instr.2E.2E.2E.html#208143558">(Aug 26 2020 at 20:22)</a>:</h4>
<p>ggreif updated <a href="https://github.com/bytecodealliance/wasmtime/pull/2143">PR #2143</a> from <code>main</code> to <code>main</code>:</p>
<blockquote>
<p>The fundamental problem is that the target distance of jump-like operations may change in the DWARF expression translation process. Intervening <code>DW_OP_deref</code> will expand to about 10 bytes, for example.</p>
<p>So the jumps must be relocated. We approach this task by inserting artificial <code>LandingPad</code> markers (new <code>CompiledExpressionParts</code> constructors) into the parsed vector at actual <code>Jump</code> targets.</p>
<p><code>LandingPad</code>s are identified by <code>JumpTargetMarker</code> tokens which are generated on the fly.</p>
<p>Additionally we now parse the <code>Jump</code> instructions. These also get their corresponding <code>JumpTargetMarker</code> token.</p>
<p>We bail in two situations:</p>
<ul>
<li><code>frame_base</code> is too complicated (i.e. itself contains <code>Jump</code>)</li>
<li>some jump distance in the original expression is fishy.</li>
</ul>
<p>Open problem: the <code>need_deref</code> flag. What when different branches want to set the flag differently? Probably not a biggie as long as all control-flow paths end e.g. with <code>DW_OP_stack_value</code> (or without).</p>
<hr>
<p>Example:</p>
<div class="codehilite"><pre><span></span><code><span class="kt">DW_AT_location</span>  <span class="p">(</span><span class="kt">DW_OP_WASM_location</span> <span class="mh">0x0</span> <span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="kt">DW_OP_dup</span><span class="p">,</span> <span class="kt">DW_OP_lit1</span><span class="p">,</span> <span class="kt">DW_OP_and</span><span class="p">,</span> <span class="kt">DW_OP_bra</span> <span class="o">+</span><span class="mi">5</span><span class="p">,</span> <span class="kt">DW_OP_lit1</span><span class="p">,</span> <span class="kt">DW_OP_shr</span><span class="p">,</span> <span class="kt">DW_OP_skip</span> <span class="o">+</span><span class="mi">3</span><span class="p">,</span> <span class="kt">DW_OP_plus_uconst</span> <span class="mh">0x5</span><span class="p">,</span> <span class="kt">DW_OP_deref</span><span class="p">,</span> <span class="kt">DW_OP_stack_value</span><span class="p">)</span>
</code></pre></div>


<p>gets transformed into:</p>
<div class="codehilite"><pre><span></span><code><span class="kt">DW_AT_location</span>  <span class="p">(</span><span class="kt">DW_OP_breg6</span> <span class="kt">RBP</span><span class="o">-</span><span class="mi">36</span><span class="p">,</span> <span class="kt">DW_OP_deref</span><span class="p">,</span> <span class="kt">DW_OP_dup</span><span class="p">,</span> <span class="kt">DW_OP_lit1</span><span class="p">,</span> <span class="kt">DW_OP_and</span><span class="p">,</span> <span class="kt">DW_OP_bra</span> <span class="o">+</span><span class="mi">5</span><span class="p">,</span> <span class="kt">DW_OP_lit1</span><span class="p">,</span> <span class="kt">DW_OP_shr</span><span class="p">,</span> <span class="kt">DW_OP_skip</span> <span class="o">+</span><span class="mi">19</span><span class="p">,</span> <span class="kt">DW_OP_plus_uconst</span> <span class="mh">0x5</span><span class="p">,</span> <span class="kt">DW_OP_breg6</span> <span class="kt">RBP</span><span class="o">-</span><span class="mi">56</span><span class="p">,</span> <span class="kt">DW_OP_deref</span><span class="p">,</span> <span class="kt">DW_OP_consts</span> <span class="o">+</span><span class="mi">152</span><span class="p">,</span> <span class="kt">DW_OP_plus</span><span class="p">,</span> <span class="kt">DW_OP_deref</span><span class="p">,</span> <span class="kt">DW_OP_swap</span><span class="p">,</span> <span class="kt">DW_OP_const4u</span> <span class="mh">0xffffffff</span><span class="p">,</span> <span class="kt">DW_OP_and</span><span class="p">,</span> <span class="kt">DW_OP_plus</span><span class="p">,</span> <span class="kt">DW_OP_deref</span><span class="p">,</span> <span class="kt">DW_OP_stack_value</span><span class="p">)</span>
</code></pre></div>


<p>&lt;!--</p>
<p>Please ensure that the following steps are all taken care of before submitting<br>
the PR.</p>
<ul>
<li>
<p>[ ] This has been discussed in issue #..., or if not, please tell us why<br>
  here.</p>
</li>
<li>
<p>[ ] A short description of what this does, why it is needed; if the<br>
  description becomes long, the matter should probably be discussed in an issue<br>
  first.</p>
</li>
<li>
<p>[ ] This PR contains test cases, if meaningful.</p>
</li>
<li>[ ] A reviewer from the core maintainer team has been assigned for this PR.<br>
  If you don't know who could review this, please indicate so. The list of<br>
  suggested reviewers on the right can help you.</li>
</ul>
<p>Please ensure all communication adheres to the <a href="https://github.com/bytecodealliance/wasmtime/blob/master/CODE_OF_CONDUCT.md">code of
conduct</a>.<br>
--&gt;</p>
</blockquote>



<a name="208152748"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232143%20Relocation%20of%20DW_OP_%7Bbra%2C%20skip%7D%20instr.../near/208152748" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232143.20Relocation.20of.20DW_OP_.7Bbra.2C.20skip.7D.20instr.2E.2E.2E.html#208152748">(Aug 26 2020 at 21:41)</a>:</h4>
<p>yurydelendik updated <a href="https://github.com/bytecodealliance/wasmtime/pull/2143">PR #2143</a> from <code>main</code> to <code>main</code>:</p>
<blockquote>
<p>The fundamental problem is that the target distance of jump-like operations may change in the DWARF expression translation process. Intervening <code>DW_OP_deref</code> will expand to about 10 bytes, for example.</p>
<p>So the jumps must be relocated. We approach this task by inserting artificial <code>LandingPad</code> markers (new <code>CompiledExpressionParts</code> constructors) into the parsed vector at actual <code>Jump</code> targets.</p>
<p><code>LandingPad</code>s are identified by <code>JumpTargetMarker</code> tokens which are generated on the fly.</p>
<p>Additionally we now parse the <code>Jump</code> instructions. These also get their corresponding <code>JumpTargetMarker</code> token.</p>
<p>We bail in two situations:</p>
<ul>
<li><code>frame_base</code> is too complicated (i.e. itself contains <code>Jump</code>)</li>
<li>some jump distance in the original expression is fishy.</li>
</ul>
<p>Open problem: the <code>need_deref</code> flag. What when different branches want to set the flag differently? Probably not a biggie as long as all control-flow paths end e.g. with <code>DW_OP_stack_value</code> (or without).</p>
<hr>
<p>Example:</p>
<div class="codehilite"><pre><span></span><code><span class="kt">DW_AT_location</span>  <span class="p">(</span><span class="kt">DW_OP_WASM_location</span> <span class="mh">0x0</span> <span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="kt">DW_OP_dup</span><span class="p">,</span> <span class="kt">DW_OP_lit1</span><span class="p">,</span> <span class="kt">DW_OP_and</span><span class="p">,</span> <span class="kt">DW_OP_bra</span> <span class="o">+</span><span class="mi">5</span><span class="p">,</span> <span class="kt">DW_OP_lit1</span><span class="p">,</span> <span class="kt">DW_OP_shr</span><span class="p">,</span> <span class="kt">DW_OP_skip</span> <span class="o">+</span><span class="mi">3</span><span class="p">,</span> <span class="kt">DW_OP_plus_uconst</span> <span class="mh">0x5</span><span class="p">,</span> <span class="kt">DW_OP_deref</span><span class="p">,</span> <span class="kt">DW_OP_stack_value</span><span class="p">)</span>
</code></pre></div>


<p>gets transformed into:</p>
<div class="codehilite"><pre><span></span><code><span class="kt">DW_AT_location</span>  <span class="p">(</span><span class="kt">DW_OP_breg6</span> <span class="kt">RBP</span><span class="o">-</span><span class="mi">36</span><span class="p">,</span> <span class="kt">DW_OP_deref</span><span class="p">,</span> <span class="kt">DW_OP_dup</span><span class="p">,</span> <span class="kt">DW_OP_lit1</span><span class="p">,</span> <span class="kt">DW_OP_and</span><span class="p">,</span> <span class="kt">DW_OP_bra</span> <span class="o">+</span><span class="mi">5</span><span class="p">,</span> <span class="kt">DW_OP_lit1</span><span class="p">,</span> <span class="kt">DW_OP_shr</span><span class="p">,</span> <span class="kt">DW_OP_skip</span> <span class="o">+</span><span class="mi">19</span><span class="p">,</span> <span class="kt">DW_OP_plus_uconst</span> <span class="mh">0x5</span><span class="p">,</span> <span class="kt">DW_OP_breg6</span> <span class="kt">RBP</span><span class="o">-</span><span class="mi">56</span><span class="p">,</span> <span class="kt">DW_OP_deref</span><span class="p">,</span> <span class="kt">DW_OP_consts</span> <span class="o">+</span><span class="mi">152</span><span class="p">,</span> <span class="kt">DW_OP_plus</span><span class="p">,</span> <span class="kt">DW_OP_deref</span><span class="p">,</span> <span class="kt">DW_OP_swap</span><span class="p">,</span> <span class="kt">DW_OP_const4u</span> <span class="mh">0xffffffff</span><span class="p">,</span> <span class="kt">DW_OP_and</span><span class="p">,</span> <span class="kt">DW_OP_plus</span><span class="p">,</span> <span class="kt">DW_OP_deref</span><span class="p">,</span> <span class="kt">DW_OP_stack_value</span><span class="p">)</span>
</code></pre></div>


<p>&lt;!--</p>
<p>Please ensure that the following steps are all taken care of before submitting<br>
the PR.</p>
<ul>
<li>
<p>[ ] This has been discussed in issue #..., or if not, please tell us why<br>
  here.</p>
</li>
<li>
<p>[ ] A short description of what this does, why it is needed; if the<br>
  description becomes long, the matter should probably be discussed in an issue<br>
  first.</p>
</li>
<li>
<p>[ ] This PR contains test cases, if meaningful.</p>
</li>
<li>[ ] A reviewer from the core maintainer team has been assigned for this PR.<br>
  If you don't know who could review this, please indicate so. The list of<br>
  suggested reviewers on the right can help you.</li>
</ul>
<p>Please ensure all communication adheres to the <a href="https://github.com/bytecodealliance/wasmtime/blob/master/CODE_OF_CONDUCT.md">code of
conduct</a>.<br>
--&gt;</p>
</blockquote>



<a name="208153407"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232143%20Relocation%20of%20DW_OP_%7Bbra%2C%20skip%7D%20instr.../near/208153407" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232143.20Relocation.20of.20DW_OP_.7Bbra.2C.20skip.7D.20instr.2E.2E.2E.html#208153407">(Aug 26 2020 at 21:47)</a>:</h4>
<p>ggreif submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/2143#pullrequestreview-475882635">PR Review</a>.</p>



<a name="208153408"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232143%20Relocation%20of%20DW_OP_%7Bbra%2C%20skip%7D%20instr.../near/208153408" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232143.20Relocation.20of.20DW_OP_.7Bbra.2C.20skip.7D.20instr.2E.2E.2E.html#208153408">(Aug 26 2020 at 21:47)</a>:</h4>
<p>ggreif created <a href="https://github.com/bytecodealliance/wasmtime/pull/2143#discussion_r477608380">PR Review Comment</a>:</p>
<blockquote>
<p>I see, thanks!</p>
</blockquote>



<a name="208156295"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232143%20Relocation%20of%20DW_OP_%7Bbra%2C%20skip%7D%20instr.../near/208156295" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232143.20Relocation.20of.20DW_OP_.7Bbra.2C.20skip.7D.20instr.2E.2E.2E.html#208156295">(Aug 26 2020 at 22:19)</a>:</h4>
<p>yurydelendik merged <a href="https://github.com/bytecodealliance/wasmtime/pull/2143">PR #2143</a>.</p>



<hr><p>Last updated: Jan 20 2025 at 06:04 UTC</p>
</html>