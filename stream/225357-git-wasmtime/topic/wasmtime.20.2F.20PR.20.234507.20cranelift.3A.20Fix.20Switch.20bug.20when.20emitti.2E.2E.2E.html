<html>
<head><meta charset="utf-8"><title>wasmtime / PR #4507 cranelift: Fix Switch bug when emitti... · git-wasmtime · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/index.html">git-wasmtime</a></h2>
<h3>Topic: <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.234507.20cranelift.3A.20Fix.20Switch.20bug.20when.20emitti.2E.2E.2E.html">wasmtime / PR #4507 cranelift: Fix Switch bug when emitti...</a></h3>

<hr>

<base href="https://bytecodealliance.zulipchat.com">

<head><link href="https://bytecodealliance.github.io/zulip-archive/style.css" rel="stylesheet"></head>

<a name="290487955"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%234507%20cranelift%3A%20Fix%20Switch%20bug%20when%20emitti.../near/290487955" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.234507.20cranelift.3A.20Fix.20Switch.20bug.20when.20emitti.2E.2E.2E.html#290487955">(Jul 22 2022 at 10:17)</a>:</h4>
<p>afonso360 opened <a href="https://github.com/bytecodealliance/wasmtime/pull/4507">PR #4507</a> from <code>switch-fix</code> to <code>main</code>:</p>
<blockquote>
<p><span aria-label="wave" class="emoji emoji-1f44b" role="img" title="wave">:wave:</span>  Hey,</p>
<p>In #4502 we discovered a bug in the switch api where it would emit <code>icmp_imm</code>'s with types that were not able to fully represent the destination index.</p>
<p>The fix for this is to extend the input type to a type suitable for representing the largest index possible.</p>
<p>We also remove a check preventing small types from being compared. This has been fixed in the x86 backend for a while.</p>
<p>CC: #4502<br>
CC: @jameysharp @bjorn3 </p>
</blockquote>



<a name="290494295"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%234507%20cranelift%3A%20Fix%20Switch%20bug%20when%20emitti.../near/290494295" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.234507.20cranelift.3A.20Fix.20Switch.20bug.20when.20emitti.2E.2E.2E.html#290494295">(Jul 22 2022 at 11:34)</a>:</h4>
<p>bjorn3 created <a href="https://github.com/bytecodealliance/wasmtime/pull/4507#discussion_r927565225">PR review comment</a>:</p>
<blockquote>
<p>This is not a valid input IMHO. I don't think we should support cases larger than what the maximum value of the input (in this case 255 as it uses an i8). They can't be hit anyway.</p>
</blockquote>



<a name="290494296"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%234507%20cranelift%3A%20Fix%20Switch%20bug%20when%20emitti.../near/290494296" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.234507.20cranelift.3A.20Fix.20Switch.20bug.20when.20emitti.2E.2E.2E.html#290494296">(Jul 22 2022 at 11:34)</a>:</h4>
<p>bjorn3 submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/4507#pullrequestreview-1047779241">PR review</a>.</p>



<a name="290496110"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%234507%20cranelift%3A%20Fix%20Switch%20bug%20when%20emitti.../near/290496110" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.234507.20cranelift.3A.20Fix.20Switch.20bug.20when.20emitti.2E.2E.2E.html#290496110">(Jul 22 2022 at 11:57)</a>:</h4>
<p>afonso360 submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/4507#pullrequestreview-1047800764">PR review</a>.</p>



<a name="290496112"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%234507%20cranelift%3A%20Fix%20Switch%20bug%20when%20emitti.../near/290496112" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.234507.20cranelift.3A.20Fix.20Switch.20bug.20when.20emitti.2E.2E.2E.html#290496112">(Jul 22 2022 at 11:57)</a>:</h4>
<p>afonso360 created <a href="https://github.com/bytecodealliance/wasmtime/pull/4507#discussion_r927580348">PR review comment</a>:</p>
<blockquote>
<p>Makes sense. I'll reject these inputs instead.</p>
</blockquote>



<a name="290497033"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%234507%20cranelift%3A%20Fix%20Switch%20bug%20when%20emitti.../near/290497033" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.234507.20cranelift.3A.20Fix.20Switch.20bug.20when.20emitti.2E.2E.2E.html#290497033">(Jul 22 2022 at 12:06)</a>:</h4>
<p>afonso360 submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/4507#pullrequestreview-1047810120">PR review</a>.</p>



<a name="290497034"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%234507%20cranelift%3A%20Fix%20Switch%20bug%20when%20emitti.../near/290497034" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.234507.20cranelift.3A.20Fix.20Switch.20bug.20when.20emitti.2E.2E.2E.html#290497034">(Jul 22 2022 at 12:06)</a>:</h4>
<p>afonso360 created <a href="https://github.com/bytecodealliance/wasmtime/pull/4507#discussion_r927586672">PR review comment</a>:</p>
<blockquote>
<p>Wait, what about if we have something like this <code>setup!(1, [10, 0x4100_0000_00bf_d470,]);</code></p>
<p>We are able to hit one of the outputs, does it make sense to reject that as well?<br>
</p>
</blockquote>



<a name="290497106"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%234507%20cranelift%3A%20Fix%20Switch%20bug%20when%20emitti.../near/290497106" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.234507.20cranelift.3A.20Fix.20Switch.20bug.20when.20emitti.2E.2E.2E.html#290497106">(Jul 22 2022 at 12:07)</a>:</h4>
<p>afonso360 edited <a href="https://github.com/bytecodealliance/wasmtime/pull/4507#discussion_r927586672">PR review comment</a>.</p>



<a name="290497274"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%234507%20cranelift%3A%20Fix%20Switch%20bug%20when%20emitti.../near/290497274" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.234507.20cranelift.3A.20Fix.20Switch.20bug.20when.20emitti.2E.2E.2E.html#290497274">(Jul 22 2022 at 12:09)</a>:</h4>
<p>afonso360 edited <a href="https://github.com/bytecodealliance/wasmtime/pull/4507#discussion_r927586672">PR review comment</a>.</p>



<a name="290499918"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%234507%20cranelift%3A%20Fix%20Switch%20bug%20when%20emitti.../near/290499918" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.234507.20cranelift.3A.20Fix.20Switch.20bug.20when.20emitti.2E.2E.2E.html#290499918">(Jul 22 2022 at 12:34)</a>:</h4>
<p>bjorn3 submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/4507#pullrequestreview-1047839905">PR review</a>.</p>



<a name="290499919"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%234507%20cranelift%3A%20Fix%20Switch%20bug%20when%20emitti.../near/290499919" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.234507.20cranelift.3A.20Fix.20Switch.20bug.20when.20emitti.2E.2E.2E.html#290499919">(Jul 22 2022 at 12:34)</a>:</h4>
<p>bjorn3 created <a href="https://github.com/bytecodealliance/wasmtime/pull/4507#discussion_r927607220">PR review comment</a>:</p>
<blockquote>
<p>I think so too. I think it should require all cases to be in bounds.</p>
</blockquote>



<a name="290502628"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%234507%20cranelift%3A%20Fix%20Switch%20bug%20when%20emitti.../near/290502628" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.234507.20cranelift.3A.20Fix.20Switch.20bug.20when.20emitti.2E.2E.2E.html#290502628">(Jul 22 2022 at 12:59)</a>:</h4>
<p>afonso360 updated <a href="https://github.com/bytecodealliance/wasmtime/pull/4507">PR #4507</a> from <code>switch-fix</code> to <code>main</code>.</p>



<a name="290502777"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%234507%20cranelift%3A%20Fix%20Switch%20bug%20when%20emitti.../near/290502777" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.234507.20cranelift.3A.20Fix.20Switch.20bug.20when.20emitti.2E.2E.2E.html#290502777">(Jul 22 2022 at 13:00)</a>:</h4>
<p>afonso360 updated <a href="https://github.com/bytecodealliance/wasmtime/pull/4507">PR #4507</a> from <code>switch-fix</code> to <code>main</code>.</p>



<a name="290504464"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%234507%20cranelift%3A%20Fix%20Switch%20bug%20when%20emitti.../near/290504464" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.234507.20cranelift.3A.20Fix.20Switch.20bug.20when.20emitti.2E.2E.2E.html#290504464">(Jul 22 2022 at 13:16)</a>:</h4>
<p>afonso360 edited <a href="https://github.com/bytecodealliance/wasmtime/pull/4507">PR #4507</a> from <code>switch-fix</code> to <code>main</code>:</p>
<blockquote>
<p><span aria-label="wave" class="emoji emoji-1f44b" role="img" title="wave">:wave:</span>  Hey,</p>
<p>In #4502 we discovered a bug in the switch api where it would emit <code>icmp_imm</code>'s with types that were not able to fully represent the destination index.</p>
<p>We now reject these inputs. The index val must always have a type that is capable of addressing the entire range of inputs.</p>
<p>We also remove a check preventing small types from being compared. This has been fixed in the x86 backend for a while.</p>
<p>CC: #4502<br>
CC: @jameysharp @bjorn3 </p>
</blockquote>



<a name="290507540"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%234507%20cranelift%3A%20Fix%20Switch%20bug%20when%20emitti.../near/290507540" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.234507.20cranelift.3A.20Fix.20Switch.20bug.20when.20emitti.2E.2E.2E.html#290507540">(Jul 22 2022 at 13:45)</a>:</h4>
<p>bjorn3 submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/4507#pullrequestreview-1047929092">PR review</a>.</p>



<a name="290545749"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%234507%20cranelift%3A%20Fix%20Switch%20bug%20when%20emitti.../near/290545749" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.234507.20cranelift.3A.20Fix.20Switch.20bug.20when.20emitti.2E.2E.2E.html#290545749">(Jul 22 2022 at 17:54)</a>:</h4>
<p>jameysharp submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/4507#pullrequestreview-1048230691">PR review</a>.</p>



<a name="290545812"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%234507%20cranelift%3A%20Fix%20Switch%20bug%20when%20emitti.../near/290545812" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.234507.20cranelift.3A.20Fix.20Switch.20bug.20when.20emitti.2E.2E.2E.html#290545812">(Jul 22 2022 at 17:55)</a>:</h4>
<p>jameysharp merged <a href="https://github.com/bytecodealliance/wasmtime/pull/4507">PR #4507</a>.</p>



<hr><p>Last updated: Jan 20 2025 at 06:04 UTC</p>
</html>