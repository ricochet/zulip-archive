<html>
<head><meta charset="utf-8"><title>wasmtime / PR #5331 Flush icache on Android aarch64 too (... · git-wasmtime · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/index.html">git-wasmtime</a></h2>
<h3>Topic: <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.235331.20Flush.20icache.20on.20Android.20aarch64.20too.20.28.2E.2E.2E.html">wasmtime / PR #5331 Flush icache on Android aarch64 too (...</a></h3>

<hr>

<base href="https://bytecodealliance.zulipchat.com">

<head><link href="https://bytecodealliance.github.io/zulip-archive/style.css" rel="stylesheet"></head>

<a name="312681696"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%235331%20Flush%20icache%20on%20Android%20aarch64%20too%20%28.../near/312681696" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.235331.20Flush.20icache.20on.20Android.20aarch64.20too.20.28.2E.2E.2E.html#312681696">(Nov 28 2022 at 17:35)</a>:</h4>
<p>bnjbvr edited <a href="https://github.com/bytecodealliance/wasmtime/pull/5331">PR #5331</a> from <code>flush-icache-on-android-aarch64</code> to <code>main</code>:</p>
<blockquote>
<p>This updates the icache flushing code so it does the flushing on Android as well. From fuzzy memories working on this in the past and <a href="https://searchfox.org/mozilla-central/source/js/src/jit/FlushICache.cpp#112">quick inspection of what Firefox does these days</a>, this is required for both Android and linux, and Android is guaranteed to have access to the <code>membarrier</code> function.</p>
<p>I've also slightly refactored the code to use an internal module named <code>details</code>, I find it slightly cleaner as it avoids all the dead code in other combinations of targets/archs, but it's mostly esthetic, so I could revert that part.</p>
<p>In addition to correctness, this also fixes the build of wasmtime 3.0.0 on the android architecture, which we rely on. If that fix is deemed acceptable, it would be extra nice to get a dot release of wasmtime with that build fix too!</p>
<p>cc @afonso360 @akirilov-arm @alexcrichton @cfallin </p>
</blockquote>



<a name="312686129"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%235331%20Flush%20icache%20on%20Android%20aarch64%20too%20%28.../near/312686129" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.235331.20Flush.20icache.20on.20Android.20aarch64.20too.20.28.2E.2E.2E.html#312686129">(Nov 28 2022 at 17:51)</a>:</h4>
<p>afonso360 submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/5331#pullrequestreview-1196298427">PR review</a>.</p>



<a name="312688314"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%235331%20Flush%20icache%20on%20Android%20aarch64%20too%20%28.../near/312688314" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.235331.20Flush.20icache.20on.20Android.20aarch64.20too.20.28.2E.2E.2E.html#312688314">(Nov 28 2022 at 18:02)</a>:</h4>
<p>cfallin submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/5331#pullrequestreview-1196311253">PR review</a>.</p>



<a name="312688322"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%235331%20Flush%20icache%20on%20Android%20aarch64%20too%20%28.../near/312688322" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.235331.20Flush.20icache.20on.20Android.20aarch64.20too.20.28.2E.2E.2E.html#312688322">(Nov 28 2022 at 18:02)</a>:</h4>
<p>cfallin submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/5331#pullrequestreview-1196311253">PR review</a>.</p>



<a name="312688325"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%235331%20Flush%20icache%20on%20Android%20aarch64%20too%20%28.../near/312688325" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.235331.20Flush.20icache.20on.20Android.20aarch64.20too.20.28.2E.2E.2E.html#312688325">(Nov 28 2022 at 18:02)</a>:</h4>
<p>cfallin created <a href="https://github.com/bytecodealliance/wasmtime/pull/5331#discussion_r1033874713">PR review comment</a>:</p>
<blockquote>
<p>It looks like <code>membarrier</code> is now defined only on AArch64, whereas previously it was defined on all architectures (and IIRC it's used on RISC-V, or at least will eventually need to be, as well) -- could you revert this bit of code-motion?</p>
</blockquote>



<a name="312698576"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%235331%20Flush%20icache%20on%20Android%20aarch64%20too%20%28.../near/312698576" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.235331.20Flush.20icache.20on.20Android.20aarch64.20too.20.28.2E.2E.2E.html#312698576">(Nov 28 2022 at 18:53)</a>:</h4>
<p>afonso360 created <a href="https://github.com/bytecodealliance/wasmtime/pull/5331#discussion_r1033934282">PR review comment</a>:</p>
<blockquote>
<p>RISC-V is going to need a custom syscall for this operation. IIRC the kernel membarrier interface is not a good fit for the RISC-V model.</p>
<p>See #5033 and #5078 for more details.</p>
<p>Moving this out may still be useful for other arch's though.</p>
</blockquote>



<a name="312698577"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%235331%20Flush%20icache%20on%20Android%20aarch64%20too%20%28.../near/312698577" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.235331.20Flush.20icache.20on.20Android.20aarch64.20too.20.28.2E.2E.2E.html#312698577">(Nov 28 2022 at 18:53)</a>:</h4>
<p>afonso360 submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/5331#pullrequestreview-1196377600">PR review</a>.</p>



<a name="312807108"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%235331%20Flush%20icache%20on%20Android%20aarch64%20too%20%28.../near/312807108" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.235331.20Flush.20icache.20on.20Android.20aarch64.20too.20.28.2E.2E.2E.html#312807108">(Nov 29 2022 at 10:10)</a>:</h4>
<p>bnjbvr created <a href="https://github.com/bytecodealliance/wasmtime/pull/5331#discussion_r1034551167">PR review comment</a>:</p>
<blockquote>
<p>Fine, I can revert this change. I try to favor the current state of things over future possible uses, but I don't have a strong opinion here.</p>
</blockquote>



<a name="312807109"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%235331%20Flush%20icache%20on%20Android%20aarch64%20too%20%28.../near/312807109" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.235331.20Flush.20icache.20on.20Android.20aarch64.20too.20.28.2E.2E.2E.html#312807109">(Nov 29 2022 at 10:10)</a>:</h4>
<p>bnjbvr submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/5331#pullrequestreview-1197257354">PR review</a>.</p>



<a name="312807430"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%235331%20Flush%20icache%20on%20Android%20aarch64%20too%20%28.../near/312807430" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.235331.20Flush.20icache.20on.20Android.20aarch64.20too.20.28.2E.2E.2E.html#312807430">(Nov 29 2022 at 10:12)</a>:</h4>
<p>bnjbvr submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/5331#pullrequestreview-1197260315">PR review</a>.</p>



<a name="312807435"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%235331%20Flush%20icache%20on%20Android%20aarch64%20too%20%28.../near/312807435" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.235331.20Flush.20icache.20on.20Android.20aarch64.20too.20.28.2E.2E.2E.html#312807435">(Nov 29 2022 at 10:12)</a>:</h4>
<p>bnjbvr created <a href="https://github.com/bytecodealliance/wasmtime/pull/5331#discussion_r1034553172">PR review comment</a>:</p>
<blockquote>
<p>Actually, let me have a semi-strong opinion here: if I put the function back where it was, then it needs to be either annotated with the exact same <code>cfg</code>, or with an <code>#[allow(unused)]</code> directive so the compiler doesn't complain about it being unused... So overall it seems better to keep it here, to reflect the current state?</p>
</blockquote>



<a name="313035310"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%235331%20Flush%20icache%20on%20Android%20aarch64%20too%20%28.../near/313035310" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.235331.20Flush.20icache.20on.20Android.20aarch64.20too.20.28.2E.2E.2E.html#313035310">(Nov 30 2022 at 11:15)</a>:</h4>
<p>bnjbvr submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/5331#pullrequestreview-1199137222">PR review</a>.</p>



<a name="313035311"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%235331%20Flush%20icache%20on%20Android%20aarch64%20too%20%28.../near/313035311" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.235331.20Flush.20icache.20on.20Android.20aarch64.20too.20.28.2E.2E.2E.html#313035311">(Nov 30 2022 at 11:15)</a>:</h4>
<p>bnjbvr created <a href="https://github.com/bytecodealliance/wasmtime/pull/5331#discussion_r1035841745">PR review comment</a>:</p>
<blockquote>
<p>@cfallin what are your thoughts regarding ^?</p>
</blockquote>



<a name="313082005"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%235331%20Flush%20icache%20on%20Android%20aarch64%20too%20%28.../near/313082005" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.235331.20Flush.20icache.20on.20Android.20aarch64.20too.20.28.2E.2E.2E.html#313082005">(Nov 30 2022 at 15:14)</a>:</h4>
<p>cfallin submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/5331#pullrequestreview-1199516270">PR review</a>.</p>



<a name="313082012"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%235331%20Flush%20icache%20on%20Android%20aarch64%20too%20%28.../near/313082012" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.235331.20Flush.20icache.20on.20Android.20aarch64.20too.20.28.2E.2E.2E.html#313082012">(Nov 30 2022 at 15:14)</a>:</h4>
<p>cfallin created <a href="https://github.com/bytecodealliance/wasmtime/pull/5331#discussion_r1036099019">PR review comment</a>:</p>
<blockquote>
<p>Ah, yeah, given the above it seems it's actually only needed on aarch64 right now, so current state is fine. Thanks :-)</p>
</blockquote>



<a name="313082106"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%235331%20Flush%20icache%20on%20Android%20aarch64%20too%20%28.../near/313082106" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.235331.20Flush.20icache.20on.20Android.20aarch64.20too.20.28.2E.2E.2E.html#313082106">(Nov 30 2022 at 15:15)</a>:</h4>
<p><strong>bnjbvr</strong> requested <a href="https://github.com/cfallin">cfallin</a> for a review on <a href="https://github.com/bytecodealliance/wasmtime/pull/5331">PR #5331</a>.</p>



<a name="313082141"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%235331%20Flush%20icache%20on%20Android%20aarch64%20too%20%28.../near/313082141" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.235331.20Flush.20icache.20on.20Android.20aarch64.20too.20.28.2E.2E.2E.html#313082141">(Nov 30 2022 at 15:15)</a>:</h4>
<p>cfallin submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/5331#pullrequestreview-1199517827">PR review</a>.</p>



<a name="313082188"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%235331%20Flush%20icache%20on%20Android%20aarch64%20too%20%28.../near/313082188" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.235331.20Flush.20icache.20on.20Android.20aarch64.20too.20.28.2E.2E.2E.html#313082188">(Nov 30 2022 at 15:15)</a>:</h4>
<p>cfallin merged <a href="https://github.com/bytecodealliance/wasmtime/pull/5331">PR #5331</a>.</p>



<hr><p>Last updated: Jan 20 2025 at 06:04 UTC</p>
</html>