<html>
<head><meta charset="utf-8"><title>wasmtime / PR #8588 riscv64: Add `fmsub`/`fnmsub`/`fnmadd... · git-wasmtime · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/index.html">git-wasmtime</a></h2>
<h3>Topic: <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.238588.20riscv64.3A.20Add.20.60fmsub.60.2F.60fnmsub.60.2F.60fnmadd.2E.2E.2E.html">wasmtime / PR #8588 riscv64: Add `fmsub`/`fnmsub`/`fnmadd...</a></h3>

<hr>

<base href="https://bytecodealliance.zulipchat.com">

<head><link href="https://bytecodealliance.github.io/zulip-archive/style.css" rel="stylesheet"></head>

<a name="437796662"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%238588%20riscv64%3A%20Add%20%60fmsub%60/%60fnmsub%60/%60fnmadd.../near/437796662" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.238588.20riscv64.3A.20Add.20.60fmsub.60.2F.60fnmsub.60.2F.60fnmadd.2E.2E.2E.html#437796662">(May 09 2024 at 10:12)</a>:</h4>
<p>afonso360 opened <a href="https://github.com/bytecodealliance/wasmtime/pull/8588">PR #8588</a> from <code>afonso360:riscv-fma-v2</code> to <code>bytecodealliance:main</code>:</p>
<blockquote>
<p><span aria-label="wave" class="emoji emoji-1f44b" role="img" title="wave">:wave:</span> Hey,</p>
<p>This PR adds lowering rules for the  <code>fmsub</code>/<code>fnmsub</code>/<code>fnmadd</code> instructions. </p>
<p>These instructions were already implemented in the backend, but had no lowering rules associated with them, so they were never emitted.</p>
</blockquote>



<a name="437796663"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%238588%20riscv64%3A%20Add%20%60fmsub%60/%60fnmsub%60/%60fnmadd.../near/437796663" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.238588.20riscv64.3A.20Add.20.60fmsub.60.2F.60fnmsub.60.2F.60fnmadd.2E.2E.2E.html#437796663">(May 09 2024 at 10:12)</a>:</h4>
<p><strong>afonso360</strong> requested <a href="https://github.com/abrown">abrown</a> for a review on <a href="https://github.com/bytecodealliance/wasmtime/pull/8588">PR #8588</a>.</p>



<a name="437796664"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%238588%20riscv64%3A%20Add%20%60fmsub%60/%60fnmsub%60/%60fnmadd.../near/437796664" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.238588.20riscv64.3A.20Add.20.60fmsub.60.2F.60fnmsub.60.2F.60fnmadd.2E.2E.2E.html#437796664">(May 09 2024 at 10:12)</a>:</h4>
<p><strong>afonso360</strong> requested <a href="https://github.com/orgs/bytecodealliance/teams/wasmtime-compiler-reviewers">wasmtime-compiler-reviewers</a> for a review on <a href="https://github.com/bytecodealliance/wasmtime/pull/8588">PR #8588</a>.</p>



<a name="437839410"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%238588%20riscv64%3A%20Add%20%60fmsub%60/%60fnmsub%60/%60fnmadd.../near/437839410" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.238588.20riscv64.3A.20Add.20.60fmsub.60.2F.60fnmsub.60.2F.60fnmadd.2E.2E.2E.html#437839410">(May 09 2024 at 15:32)</a>:</h4>
<p>alexcrichton submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/8588#pullrequestreview-2048232277">PR review</a>:</p>
<blockquote>
<p>Nice!</p>
</blockquote>



<a name="437843054"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%238588%20riscv64%3A%20Add%20%60fmsub%60/%60fnmsub%60/%60fnmadd.../near/437843054" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.238588.20riscv64.3A.20Add.20.60fmsub.60.2F.60fnmsub.60.2F.60fnmadd.2E.2E.2E.html#437843054">(May 09 2024 at 15:55)</a>:</h4>
<p>alexcrichton merged <a href="https://github.com/bytecodealliance/wasmtime/pull/8588">PR #8588</a>.</p>



<a name="437917279"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%238588%20riscv64%3A%20Add%20%60fmsub%60/%60fnmsub%60/%60fnmadd.../near/437917279" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.238588.20riscv64.3A.20Add.20.60fmsub.60.2F.60fnmsub.60.2F.60fnmadd.2E.2E.2E.html#437917279">(May 10 2024 at 03:03)</a>:</h4>
<p>jameysharp <a href="https://github.com/bytecodealliance/wasmtime/pull/8588#issuecomment-2103773727">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/8588">PR #8588</a>:</p>
<blockquote>
<p>This is neat!</p>
<p>Out of curiosity, can't you use these same fnmsub/fnmadd instructions if <code>y</code> is negated instead of <code>x</code>? Similarly if both <code>x</code> and <code>y</code> are negated, I think you can use fmadd/fmsub, depending on whether <code>z</code> is negated or not. And of course you could also match on <code>(fneg (fma ...))</code>, leading to 16 possible rules in total.</p>
<p>That said, I'm a little worried about whether fusing negation into an <code>fma</code> can change its results. I'm hoping the answer is "no", but do either of you happen to know for sure and can you explain it to me? I'm reasonably confident that negating the result is equivalent to negating both terms and both cases are safe to fuse without loss of precision. I'm less confident that, for example, <code>fmadd x y (fneg z)</code> will always give the same results as <code>fmsub x y z</code> if the magnitude of <code>z</code> is very different than <code>x*y</code>.</p>
<p>Anyway, I thought way too much about this and I think you can fold those 16 cases into four rules based on how many of <code>x</code>, <code>y</code>, <code>z</code>, or the result are wrapped in <code>fneg</code>:</p>
<ul>
<li>Even number of <code>fneg</code>s in (result, x, y): use <code>fm*</code></li>
<li>Odd number of <code>fneg</code>s in (result, x, y): use <code>fnm*</code></li>
<li>Even number of <code>fneg</code>s in (x, y, z): use <code>*add</code></li>
<li>Odd number of <code>fneg</code>s in (x, y, z): use <code>*sub</code></li>
</ul>
<p>With the right helpers you can write the four rules all at the same priority. This is a little awkward and would be easier if ISLE had or-patterns or match expressions or something, but I think the following should work and generate about as good of a pattern-matching tree as we're capable of right now.</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="p">(</span><span class="k">type</span> <span class="nc">IsFneg</span><span class="w"> </span><span class="p">(</span><span class="k">enum</span> <span class="p">(</span><span class="nb">Result</span><span class="w"> </span><span class="p">(</span><span class="n">negate</span><span class="w"> </span><span class="kt">u64</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="n">value</span><span class="w"> </span><span class="n">Value</span><span class="p">))))</span>

<span class="p">(</span><span class="n">decl</span><span class="w"> </span><span class="n">is_fneg</span><span class="w"> </span><span class="p">(</span><span class="n">Value</span><span class="p">)</span><span class="w"> </span><span class="n">IsFneg</span><span class="p">)</span>
<span class="p">(</span><span class="n">rule</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="p">(</span><span class="n">is_fneg</span><span class="w"> </span><span class="p">(</span><span class="n">fneg</span><span class="w"> </span><span class="n">x</span><span class="p">))</span><span class="w"> </span><span class="p">(</span><span class="n">IsFneg</span><span class="p">.</span><span class="nb">Result</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="n">x</span><span class="p">))</span>
<span class="p">(</span><span class="n">rule</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="p">(</span><span class="n">is_fneg</span><span class="w"> </span><span class="n">x</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="n">IsFneg</span><span class="p">.</span><span class="nb">Result</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="n">x</span><span class="p">))</span>

<span class="p">(</span><span class="n">rule</span><span class="w"> </span><span class="p">(</span><span class="n">lower</span><span class="w"> </span><span class="p">(</span><span class="n">has_type</span><span class="w"> </span><span class="n">ty</span><span class="w"> </span><span class="p">(</span><span class="n">fma</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="n">y</span><span class="w"> </span><span class="n">z</span><span class="p">)))</span>
<span class="w">  </span><span class="p">(</span><span class="k">if</span><span class="o">-</span><span class="kd">let</span><span class="w"> </span><span class="p">(</span><span class="n">IsFneg</span><span class="p">.</span><span class="nb">Result</span><span class="w"> </span><span class="n">neg_x</span><span class="w"> </span><span class="n">x</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="n">is_fneg</span><span class="w"> </span><span class="n">x</span><span class="p">))</span>
<span class="w">  </span><span class="p">(</span><span class="k">if</span><span class="o">-</span><span class="kd">let</span><span class="w"> </span><span class="p">(</span><span class="n">IsFneg</span><span class="p">.</span><span class="nb">Result</span><span class="w"> </span><span class="n">neg_y</span><span class="w"> </span><span class="n">y</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="n">is_fneg</span><span class="w"> </span><span class="n">y</span><span class="p">))</span>
<span class="w">  </span><span class="p">(</span><span class="k">if</span><span class="o">-</span><span class="kd">let</span><span class="w"> </span><span class="p">(</span><span class="n">IsFneg</span><span class="p">.</span><span class="nb">Result</span><span class="w"> </span><span class="n">neg_z</span><span class="w"> </span><span class="n">z</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="n">is_fneg</span><span class="w"> </span><span class="n">z</span><span class="p">))</span>
<span class="w">  </span><span class="p">(</span><span class="n">rv_fma</span><span class="w"> </span><span class="n">ty</span><span class="w"> </span><span class="p">(</span><span class="n">u64_xor</span><span class="w"> </span><span class="n">neg_x</span><span class="w"> </span><span class="n">neg_y</span><span class="p">)</span><span class="w"> </span><span class="n">neg_z</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="n">y</span><span class="w"> </span><span class="n">z</span><span class="p">))</span>

<span class="p">;</span><span class="w"> </span><span class="n">this</span><span class="w"> </span><span class="n">rule</span><span class="w"> </span><span class="n">will</span><span class="w"> </span><span class="n">need</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="n">rule</span><span class="w"> </span><span class="n">priority</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">not</span><span class="w"> </span><span class="n">overlap</span><span class="w"> </span><span class="n">with</span><span class="w"> </span><span class="n">other</span><span class="w"> </span><span class="n">top</span><span class="o">-</span><span class="n">level</span><span class="w"> </span><span class="n">fneg</span><span class="w"> </span><span class="n">rules</span>
<span class="p">(</span><span class="n">rule</span><span class="w"> </span><span class="p">(</span><span class="n">lower</span><span class="w"> </span><span class="p">(</span><span class="n">has_type</span><span class="w"> </span><span class="n">ty</span><span class="w"> </span><span class="p">(</span><span class="n">fneg</span><span class="w"> </span><span class="p">(</span><span class="n">fma</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="n">y</span><span class="w"> </span><span class="n">z</span><span class="p">))))</span>
<span class="w">  </span><span class="p">(</span><span class="k">if</span><span class="o">-</span><span class="kd">let</span><span class="w"> </span><span class="p">(</span><span class="n">IsFneg</span><span class="p">.</span><span class="nb">Result</span><span class="w"> </span><span class="n">neg_x</span><span class="w"> </span><span class="n">x</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="n">is_fneg</span><span class="w"> </span><span class="n">x</span><span class="p">))</span>
<span class="w">  </span><span class="p">(</span><span class="k">if</span><span class="o">-</span><span class="kd">let</span><span class="w"> </span><span class="p">(</span><span class="n">IsFneg</span><span class="p">.</span><span class="nb">Result</span><span class="w"> </span><span class="n">neg_y</span><span class="w"> </span><span class="n">y</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="n">is_fneg</span><span class="w"> </span><span class="n">y</span><span class="p">))</span>
<span class="w">  </span><span class="p">(</span><span class="k">if</span><span class="o">-</span><span class="kd">let</span><span class="w"> </span><span class="p">(</span><span class="n">IsFneg</span><span class="p">.</span><span class="nb">Result</span><span class="w"> </span><span class="n">neg_z</span><span class="w"> </span><span class="n">z</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="n">is_fneg</span><span class="w"> </span><span class="n">z</span><span class="p">))</span>
<span class="w">  </span><span class="p">(</span><span class="n">rv_fma</span><span class="w"> </span><span class="n">ty</span><span class="w"> </span><span class="p">(</span><span class="n">u64_xor</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="p">(</span><span class="n">u64_xor</span><span class="w"> </span><span class="n">neg_x</span><span class="w"> </span><span class="n">neg_y</span><span class="p">))</span><span class="w"> </span><span class="p">(</span><span class="n">u64_xor</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="n">neg_z</span><span class="p">)</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="n">y</span><span class="w"> </span><span class="n">z</span><span class="p">))</span>

<span class="p">;</span><span class="w"> </span><span class="n">parity</span><span class="w"> </span><span class="n">arguments</span><span class="w"> </span><span class="n">indicate</span><span class="w"> </span><span class="n">whether</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">negate</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">x</span><span class="o">*</span><span class="n">y</span><span class="w"> </span><span class="n">term</span><span class="w"> </span><span class="n">or</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">z</span><span class="w"> </span><span class="n">term</span><span class="p">,</span><span class="w"> </span><span class="n">respectively</span>
<span class="p">(</span><span class="n">decl</span><span class="w"> </span><span class="n">rv_fma</span><span class="w"> </span><span class="p">(</span><span class="n">Type</span><span class="w"> </span><span class="kt">u64</span><span class="w"> </span><span class="kt">u64</span><span class="w"> </span><span class="n">Value</span><span class="w"> </span><span class="n">Value</span><span class="w"> </span><span class="n">Value</span><span class="p">)</span><span class="w"> </span><span class="n">InstOutput</span><span class="p">)</span>
<span class="p">(</span><span class="n">rule</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="p">(</span><span class="n">rv_fma</span><span class="w"> </span><span class="p">(</span><span class="n">ty_scalar_float</span><span class="w"> </span><span class="n">ty</span><span class="p">)</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="n">y</span><span class="w"> </span><span class="n">z</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="n">rv_fmadd</span><span class="w"> </span><span class="n">ty</span><span class="w"> </span><span class="p">(</span><span class="n">FRM</span><span class="p">.</span><span class="n">RME</span><span class="p">)</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="n">y</span><span class="w"> </span><span class="n">z</span><span class="p">))</span>
<span class="p">(</span><span class="n">rule</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="p">(</span><span class="n">rv_fma</span><span class="w"> </span><span class="p">(</span><span class="n">ty_scalar_float</span><span class="w"> </span><span class="n">ty</span><span class="p">)</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="n">y</span><span class="w"> </span><span class="n">z</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="n">rv_fmsub</span><span class="w"> </span><span class="n">ty</span><span class="w"> </span><span class="p">(</span><span class="n">FRM</span><span class="p">.</span><span class="n">RME</span><span class="p">)</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="n">y</span><span class="w"> </span><span class="n">z</span><span class="p">))</span>
<span class="p">(</span><span class="n">rule</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="p">(</span><span class="n">rv_fma</span><span class="w"> </span><span class="p">(</span><span class="n">ty_scalar_float</span><span class="w"> </span><span class="n">ty</span><span class="p">)</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="n">y</span><span class="w"> </span><span class="n">z</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="n">rv_fnmsub</span><span class="w"> </span><span class="n">ty</span><span class="w"> </span><span class="p">(</span><span class="n">FRM</span><span class="p">.</span><span class="n">RME</span><span class="p">)</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="n">y</span><span class="w"> </span><span class="n">z</span><span class="p">))</span>
<span class="p">(</span><span class="n">rule</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="p">(</span><span class="n">rv_fma</span><span class="w"> </span><span class="p">(</span><span class="n">ty_scalar_float</span><span class="w"> </span><span class="n">ty</span><span class="p">)</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="n">y</span><span class="w"> </span><span class="n">z</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="n">rv_fnmadd</span><span class="w"> </span><span class="n">ty</span><span class="w"> </span><span class="p">(</span><span class="n">FRM</span><span class="p">.</span><span class="n">RME</span><span class="p">)</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="n">y</span><span class="w"> </span><span class="n">z</span><span class="p">))</span>
<span class="p">(</span><span class="n">rule</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="p">(</span><span class="n">rv_fma</span><span class="w"> </span><span class="p">(</span><span class="n">ty_vec_fits_in_register</span><span class="w"> </span><span class="n">ty</span><span class="p">)</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="n">y</span><span class="w"> </span><span class="n">z</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="n">rv_vfmacc_vv</span><span class="w"> </span><span class="n">z</span><span class="w"> </span><span class="n">y</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="p">(</span><span class="n">unmasked</span><span class="p">)</span><span class="w"> </span><span class="n">ty</span><span class="p">))</span>
<span class="p">(</span><span class="n">rule</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="p">(</span><span class="n">rv_fma</span><span class="w"> </span><span class="p">(</span><span class="n">ty_vec_fits_in_register</span><span class="w"> </span><span class="n">ty</span><span class="p">)</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="n">y</span><span class="w"> </span><span class="n">z</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="n">rv_vfmsac_vv</span><span class="w"> </span><span class="n">z</span><span class="w"> </span><span class="n">y</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="p">(</span><span class="n">unmasked</span><span class="p">)</span><span class="w"> </span><span class="n">ty</span><span class="p">))</span>
<span class="p">(</span><span class="n">rule</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="p">(</span><span class="n">rv_fma</span><span class="w"> </span><span class="p">(</span><span class="n">ty_vec_fits_in_register</span><span class="w"> </span><span class="n">ty</span><span class="p">)</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="n">y</span><span class="w"> </span><span class="n">z</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="n">rv_vfnmsac_vv</span><span class="w"> </span><span class="n">z</span><span class="w"> </span><span class="n">y</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="p">(</span><span class="n">unmasked</span><span class="p">)</span><span class="w"> </span><span class="n">ty</span><span class="p">))</span>
<span class="p">(</span><span class="n">rule</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="p">(</span><span class="n">rv_fma</span><span class="w"> </span><span class="p">(</span><span class="n">ty_vec_fits_in_register</span><span class="w"> </span><span class="n">ty</span><span class="p">)</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="n">y</span><span class="w"> </span><span class="n">z</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="n">rv_vfnmacc_vv</span><span class="w"> </span><span class="n">z</span><span class="w"> </span><span class="n">y</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="p">(</span><span class="n">unmasked</span><span class="p">)</span><span class="w"> </span><span class="n">ty</span><span class="p">))</span>
<span class="p">(</span><span class="n">rule</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="p">(</span><span class="n">rv_fma</span><span class="w"> </span><span class="p">(</span><span class="n">ty_vec_fits_in_register</span><span class="w"> </span><span class="n">ty</span><span class="p">)</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="p">(</span><span class="n">splat</span><span class="w"> </span><span class="n">x</span><span class="p">)</span><span class="w"> </span><span class="n">y</span><span class="w"> </span><span class="n">z</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="n">rv_vfmacc_vf</span><span class="w"> </span><span class="n">z</span><span class="w"> </span><span class="n">y</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="p">(</span><span class="n">unmasked</span><span class="p">)</span><span class="w"> </span><span class="n">ty</span><span class="p">))</span>
<span class="p">(</span><span class="n">rule</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="p">(</span><span class="n">rv_fma</span><span class="w"> </span><span class="p">(</span><span class="n">ty_vec_fits_in_register</span><span class="w"> </span><span class="n">ty</span><span class="p">)</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="p">(</span><span class="n">splat</span><span class="w"> </span><span class="n">x</span><span class="p">)</span><span class="w"> </span><span class="n">y</span><span class="w"> </span><span class="n">z</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="n">rv_vfmsac_vf</span><span class="w"> </span><span class="n">z</span><span class="w"> </span><span class="n">y</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="p">(</span><span class="n">unmasked</span><span class="p">)</span><span class="w"> </span><span class="n">ty</span><span class="p">))</span>
<span class="p">(</span><span class="n">rule</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="p">(</span><span class="n">rv_fma</span><span class="w"> </span><span class="p">(</span><span class="n">ty_vec_fits_in_register</span><span class="w"> </span><span class="n">ty</span><span class="p">)</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="p">(</span><span class="n">splat</span><span class="w"> </span><span class="n">x</span><span class="p">)</span><span class="w"> </span><span class="n">y</span><span class="w"> </span><span class="n">z</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="n">rv_vfnmsac_vf</span><span class="w"> </span><span class="n">z</span><span class="w"> </span><span class="n">y</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="p">(</span><span class="n">unmasked</span><span class="p">)</span><span class="w"> </span><span class="n">ty</span><span class="p">))</span>
<span class="p">(</span><span class="n">rule</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="p">(</span><span class="n">rv_fma</span><span class="w"> </span><span class="p">(</span><span class="n">ty_vec_fits_in_register</span><span class="w"> </span><span class="n">ty</span><span class="p">)</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="p">(</span><span class="n">splat</span><span class="w"> </span><span class="n">x</span><span class="p">)</span><span class="w"> </span><span class="n">y</span><span class="w"> </span><span class="n">z</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="n">rv_vfnmacc_vf</span><span class="w"> </span><span class="n">z</span><span class="w"> </span><span class="n">y</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="p">(</span><span class="n">unmasked</span><span class="p">)</span><span class="w"> </span><span class="n">ty</span><span class="p">))</span>
</code></pre></div>
<p>Also I think you might be able to handle <code>(splat y)</code> as well because I guess floating-point multiplication is commutative assuming NaN canonicalization. So you can safely swap <code>x</code> and <code>y</code>, if I'm not mistaken…</p>
</blockquote>



<a name="437956346"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%238588%20riscv64%3A%20Add%20%60fmsub%60/%60fnmsub%60/%60fnmadd.../near/437956346" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.238588.20riscv64.3A.20Add.20.60fmsub.60.2F.60fnmsub.60.2F.60fnmadd.2E.2E.2E.html#437956346">(May 10 2024 at 09:56)</a>:</h4>
<p>afonso360 <a href="https://github.com/bytecodealliance/wasmtime/pull/8588#issuecomment-2104315843">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/8588">PR #8588</a>:</p>
<blockquote>
<p>I'm not entirely sure, for these 4 instructions I pretty much copied the <a href="https://github.com/llvm/llvm-project/blob/c84c74e67839a5207d7c6318fc37e607f088a994/llvm/lib/Target/RISCV/RISCVInstrInfoF.td#L548-L567">LLVM lowerings for them</a>. I also briefly looked at our x64 backend and noted that it had some <a href="https://github.com/bytecodealliance/wasmtime/blob/bc081b74bc559cfddee4f01a02a018b903f31f1a/cranelift/codegen/src/isa/x64/lower.isle#L2853-L2864">similar rules for <code>fnmadd</code></a>. I can't really explain these transformations in great detail, FP Math makes my head hurt <span aria-label="confounded" class="emoji emoji-1f616" role="img" title="confounded">:confounded:</span> .</p>
<blockquote>
<p>I'm less confident that, for example, fmadd x y (fneg z) will always give the same results as fmsub x y z if the magnitude of z is very different than x*y.</p>
</blockquote>
<p>That case isn't represented in our backend, and I'm not entirely sure how to prove it. My z3 skills are non existent, but I probably can implement it for the x64 backend and fuzz it for a few days.</p>
<hr>
<p><code>(fneg (fma ...))</code> I think is a no-go since LLVM has this rule, but only with the <code>nsz</code> (No Signed Zero) flag, which means it probably swaps <code>-0.0</code> with <code>0.0</code> or vice-versa.</p>
<hr>
<p>Adding the <code>fneg y</code> variations seems like it would work, at least we have those rules in the x64 backend. And de-duplicating those rules with the vector rules seems really neat, since we have pretty much the same instructions for both.<br>
</p>
</blockquote>



<a name="437956614"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%238588%20riscv64%3A%20Add%20%60fmsub%60/%60fnmsub%60/%60fnmadd.../near/437956614" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.238588.20riscv64.3A.20Add.20.60fmsub.60.2F.60fnmsub.60.2F.60fnmadd.2E.2E.2E.html#437956614">(May 10 2024 at 09:59)</a>:</h4>
<p>afonso360 edited a <a href="https://github.com/bytecodealliance/wasmtime/pull/8588#issuecomment-2104315843">comment</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/8588">PR #8588</a>:</p>
<blockquote>
<p>I'm not entirely sure, for these 4 instructions I pretty much copied the <a href="https://github.com/llvm/llvm-project/blob/c84c74e67839a5207d7c6318fc37e607f088a994/llvm/lib/Target/RISCV/RISCVInstrInfoF.td#L548-L567">LLVM lowerings for them</a>. I also briefly looked at our x64 backend and noted that it had some <a href="https://github.com/bytecodealliance/wasmtime/blob/bc081b74bc559cfddee4f01a02a018b903f31f1a/cranelift/codegen/src/isa/x64/lower.isle#L2853-L2864">similar rules for <code>fnmadd</code></a>. I can't really explain these transformations in great detail, FP Math makes my head hurt <span aria-label="confounded" class="emoji emoji-1f616" role="img" title="confounded">:confounded:</span> .</p>
<blockquote>
<p>I'm less confident that, for example, fmadd x y (fneg z) will always give the same results as fmsub x y z if the magnitude of z is very different than x*y.</p>
</blockquote>
<p>That case isn't represented in our backend, and I'm not entirely sure how to prove it. My z3 skills are non existent, but I probably can implement it for the x64 backend and fuzz it for a few days.</p>
<p>Edit: I was searching for related fma transformations and found this <a href="https://alive2.llvm.org/ce/z/XxwBAJ">alive2</a> testcase that seems like a good starting point to try to play around and prove these transformations. I've never used alive, but I'll give it a go this afternoon, seems like it should be fairly easy.</p>
<hr>
<p><code>(fneg (fma ...))</code> I think is a no-go since LLVM has this rule, but only with the <code>nsz</code> (No Signed Zero) flag, which means it probably swaps <code>-0.0</code> with <code>0.0</code> or vice-versa.</p>
<hr>
<p>Adding the <code>fneg y</code> variations seems like it would work, at least we have those rules in the x64 backend. And de-duplicating those rules with the vector rules seems really neat, since we have pretty much the same instructions for both.<br>
</p>
</blockquote>



<a name="437956878"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%238588%20riscv64%3A%20Add%20%60fmsub%60/%60fnmsub%60/%60fnmadd.../near/437956878" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.238588.20riscv64.3A.20Add.20.60fmsub.60.2F.60fnmsub.60.2F.60fnmadd.2E.2E.2E.html#437956878">(May 10 2024 at 10:01)</a>:</h4>
<p>afonso360 edited a <a href="https://github.com/bytecodealliance/wasmtime/pull/8588#issuecomment-2104315843">comment</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/8588">PR #8588</a>:</p>
<blockquote>
<p>I'm not entirely sure, for these 4 instructions I pretty much copied the <a href="https://github.com/llvm/llvm-project/blob/c84c74e67839a5207d7c6318fc37e607f088a994/llvm/lib/Target/RISCV/RISCVInstrInfoF.td#L548-L567">LLVM lowerings for them</a>. I also briefly looked at our x64 backend and noted that it had some <a href="https://github.com/bytecodealliance/wasmtime/blob/bc081b74bc559cfddee4f01a02a018b903f31f1a/cranelift/codegen/src/isa/x64/lower.isle#L2853-L2864">similar rules for <code>fnmadd</code></a>. I can't really explain these transformations in great detail, FP Math makes my head hurt <span aria-label="confounded" class="emoji emoji-1f616" role="img" title="confounded">:confounded:</span> .</p>
<blockquote>
<p>I'm less confident that, for example, fmadd x y (fneg z) will always give the same results as fmsub x y z if the magnitude of z is very different than x*y.</p>
</blockquote>
<p>That case isn't represented in our backend, and I'm not entirely sure how to prove it. My z3 skills are non existent, but I probably can implement it for the x64 backend and fuzz it for a few days.</p>
<p>Edit: I was searching for related fma transformations and found this <a href="https://alive2.llvm.org/ce/z/XxwBAJ">alive2</a> testcase that seems like a good starting point to try to play around and prove these transformations. I've never used alive, but I'll give it a go this afternoon, seems like it should be fairly easy.</p>
<hr>
<p><code>(fneg (fma ...))</code> I think is a no-go since LLVM has this rule, but only with the <code>nsz</code> (No Signed Zero) flag, which means it probably swaps <code>-0.0</code> with <code>0.0</code> or vice-versa.</p>
<hr>
<p>Adding the <code>fneg y</code> variations seems like it would work, at least we have those rules in the x64 backend. And de-duplicating those rules with the vector rules seems really neat, since we have pretty much the same instructions for both. I'll try and merge those rules together like you suggested.</p>
</blockquote>



<a name="437957874"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%238588%20riscv64%3A%20Add%20%60fmsub%60/%60fnmsub%60/%60fnmadd.../near/437957874" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.238588.20riscv64.3A.20Add.20.60fmsub.60.2F.60fnmsub.60.2F.60fnmadd.2E.2E.2E.html#437957874">(May 10 2024 at 10:08)</a>:</h4>
<p>afonso360 edited a <a href="https://github.com/bytecodealliance/wasmtime/pull/8588#issuecomment-2104315843">comment</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/8588">PR #8588</a>:</p>
<blockquote>
<p>I'm not entirely sure, for these 4 instructions I pretty much copied the <a href="https://github.com/llvm/llvm-project/blob/c84c74e67839a5207d7c6318fc37e607f088a994/llvm/lib/Target/RISCV/RISCVInstrInfoF.td#L548-L567">LLVM lowerings for them</a>. I also briefly looked at our x64 backend and noted that it had some <a href="https://github.com/bytecodealliance/wasmtime/blob/bc081b74bc559cfddee4f01a02a018b903f31f1a/cranelift/codegen/src/isa/x64/lower.isle#L2853-L2864">similar rules for <code>fnmadd</code></a>. I can't really explain these transformations in great detail, FP Math makes my head hurt <span aria-label="confounded" class="emoji emoji-1f616" role="img" title="confounded">:confounded:</span> .</p>
<blockquote>
<p>I'm less confident that, for example, fmadd x y (fneg z) will always give the same results as fmsub x y z if the magnitude of z is very different than x*y.</p>
</blockquote>
<p>That case isn't represented in our X64 backend, and I'm not entirely sure how to prove it. My z3 skills are non existent, but I probably can implement it for the x64 backend and fuzz it for a few days.</p>
<p>Edit: I was searching for related fma transformations and found this <a href="https://alive2.llvm.org/ce/z/XxwBAJ">alive2</a> testcase that seems like a good starting point to try to play around and prove these transformations. I've never used alive, but I'll give it a go this afternoon, seems like it should be fairly easy.</p>
<hr>
<p><code>(fneg (fma ...))</code> I think is a no-go since LLVM has this rule, but only with the <code>nsz</code> (No Signed Zero) flag, which means it probably swaps <code>-0.0</code> with <code>0.0</code> or vice-versa.</p>
<hr>
<p>Adding the <code>fneg y</code> variations seems like it would work, at least we have those rules in the x64 backend. And de-duplicating those rules with the vector rules seems really neat, since we have pretty much the same instructions for both. I'll try and merge those rules together like you suggested.</p>
</blockquote>



<a name="437960505"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%238588%20riscv64%3A%20Add%20%60fmsub%60/%60fnmsub%60/%60fnmadd.../near/437960505" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.238588.20riscv64.3A.20Add.20.60fmsub.60.2F.60fnmsub.60.2F.60fnmadd.2E.2E.2E.html#437960505">(May 10 2024 at 10:31)</a>:</h4>
<p>afonso360 edited a <a href="https://github.com/bytecodealliance/wasmtime/pull/8588#issuecomment-2104315843">comment</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/8588">PR #8588</a>:</p>
<blockquote>
<p>I'm not entirely sure, for these 4 instructions I pretty much copied the <a href="https://github.com/llvm/llvm-project/blob/c84c74e67839a5207d7c6318fc37e607f088a994/llvm/lib/Target/RISCV/RISCVInstrInfoF.td#L548-L567">LLVM lowerings for them</a>. I also briefly looked at our x64 backend and noted that it had some <a href="https://github.com/bytecodealliance/wasmtime/blob/bc081b74bc559cfddee4f01a02a018b903f31f1a/cranelift/codegen/src/isa/x64/lower.isle#L2853-L2864">similar rules for <code>fnmadd</code></a>. I can't really explain these transformations in great detail, FP Math makes my head hurt <span aria-label="confounded" class="emoji emoji-1f616" role="img" title="confounded">:confounded:</span> .</p>
<blockquote>
<p>I'm less confident that, for example, fmadd x y (fneg z) will always give the same results as fmsub x y z if the magnitude of z is very different than x*y.</p>
</blockquote>
<p>That case isn't represented in our X64 backend, and I'm not entirely sure how to prove it. My z3 skills are non existent, but I probably can implement it for the x64 backend and fuzz it for a few days. </p>
<p>I also don't think magnitudes should matter here, <code>fneg</code> is a bitwise operation, it shouldn't do any early rounding that would be affected by magnitude.</p>
<p>Edit: I was searching for related fma transformations and found this <a href="https://alive2.llvm.org/ce/z/XxwBAJ">alive2</a> testcase that seems like a good starting point to try to play around and prove these transformations. I've never used alive, but I'll give it a go this afternoon, seems like it should be fairly easy.</p>
<hr>
<p><code>(fneg (fma ...))</code> I think is a no-go since LLVM has this rule, but only with the <code>nsz</code> (No Signed Zero) flag, which means it probably swaps <code>-0.0</code> with <code>0.0</code> or vice-versa.</p>
<hr>
<p>Adding the <code>fneg y</code> variations seems like it would work, at least we have those rules in the x64 backend. And de-duplicating those rules with the vector rules seems really neat, since we have pretty much the same instructions for both. I'll try and merge those rules together like you suggested.</p>
</blockquote>



<a name="438088578"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%238588%20riscv64%3A%20Add%20%60fmsub%60/%60fnmsub%60/%60fnmadd.../near/438088578" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.238588.20riscv64.3A.20Add.20.60fmsub.60.2F.60fnmsub.60.2F.60fnmadd.2E.2E.2E.html#438088578">(May 11 2024 at 07:51)</a>:</h4>
<p>afonso360 <a href="https://github.com/bytecodealliance/wasmtime/pull/8588#issuecomment-2105622411">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/8588">PR #8588</a>:</p>
<blockquote>
<p>So, I played around with alive for a bit. Really cool tool! Unfortunately the compiler explorer for alive2 has a short timeout so I had to run these locally.</p>
<blockquote>
<p>Out of curiosity, can't you use these same fnmsub/fnmadd instructions if y is negated instead of x? </p>
</blockquote>
<p>Yes you can! Here's the <a href="https://alive2.llvm.org/ce/z/sp-dNg">proof that I built for this</a> and it does validate. <br>
&lt;details&gt;<br>
  &lt;summary&gt;Result&lt;/summary&gt;</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="n">afonso</span><span class="o">@</span><span class="n">DESKTOP</span><span class="o">-</span><span class="mi">1</span><span class="n">AHKMV2</span>:<span class="o">~/</span><span class="n">git</span><span class="o">/</span><span class="n">alive2</span><span class="o">/</span><span class="n">build</span><span class="cp">$</span><span class="w"> </span><span class="p">.</span><span class="o">/</span><span class="n">alive</span><span class="o">-</span><span class="n">tv</span><span class="w"> </span><span class="o">--</span><span class="n">disable</span><span class="o">-</span><span class="n">undef</span><span class="o">-</span><span class="n">input</span><span class="w"> </span><span class="o">--</span><span class="n">smt</span><span class="o">-</span><span class="n">to</span><span class="o">=</span><span class="mi">1800000</span><span class="w">  </span><span class="p">.</span><span class="o">/</span><span class="n">tgt</span><span class="p">.</span><span class="n">ll</span>

<span class="o">----------------------------------------</span>
<span class="n">define</span><span class="w"> </span><span class="n">half</span><span class="w"> </span><span class="o">@</span><span class="n">src</span><span class="p">(</span><span class="n">half</span><span class="w"> </span><span class="o">%</span><span class="n">x</span><span class="p">,</span><span class="w"> </span><span class="n">half</span><span class="w"> </span><span class="o">%</span><span class="n">y</span><span class="p">,</span><span class="w"> </span><span class="n">half</span><span class="w"> </span><span class="o">%</span><span class="n">z</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
#<span class="mi">0</span>:
  <span class="o">%</span><span class="n">negx</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">fneg</span><span class="w"> </span><span class="n">half</span><span class="w"> </span><span class="o">%</span><span class="n">x</span>
<span class="w">  </span><span class="o">%</span><span class="n">fma</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">fma</span><span class="w"> </span><span class="n">half</span><span class="w"> </span><span class="o">%</span><span class="n">negx</span><span class="p">,</span><span class="w"> </span><span class="n">half</span><span class="w"> </span><span class="o">%</span><span class="n">y</span><span class="p">,</span><span class="w"> </span><span class="n">half</span><span class="w"> </span><span class="o">%</span><span class="n">z</span>
<span class="w">  </span><span class="n">ret</span><span class="w"> </span><span class="n">half</span><span class="w"> </span><span class="o">%</span><span class="n">fma</span>
<span class="p">}</span>
<span class="o">=&gt;</span>
<span class="n">define</span><span class="w"> </span><span class="n">half</span><span class="w"> </span><span class="o">@</span><span class="n">tgt</span><span class="p">(</span><span class="n">half</span><span class="w"> </span><span class="o">%</span><span class="n">x</span><span class="p">,</span><span class="w"> </span><span class="n">half</span><span class="w"> </span><span class="o">%</span><span class="n">y</span><span class="p">,</span><span class="w"> </span><span class="n">half</span><span class="w"> </span><span class="o">%</span><span class="n">z</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
#<span class="mi">0</span>:
  <span class="o">%</span><span class="n">negy</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">fneg</span><span class="w"> </span><span class="n">half</span><span class="w"> </span><span class="o">%</span><span class="n">y</span>
<span class="w">  </span><span class="o">%</span><span class="n">fma</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">fma</span><span class="w"> </span><span class="n">half</span><span class="w"> </span><span class="o">%</span><span class="n">x</span><span class="p">,</span><span class="w"> </span><span class="n">half</span><span class="w"> </span><span class="o">%</span><span class="n">negy</span><span class="p">,</span><span class="w"> </span><span class="n">half</span><span class="w"> </span><span class="o">%</span><span class="n">z</span>
<span class="w">  </span><span class="n">ret</span><span class="w"> </span><span class="n">half</span><span class="w"> </span><span class="o">%</span><span class="n">fma</span>
<span class="p">}</span>
<span class="n">Transformation</span><span class="w"> </span><span class="n">seems</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">be</span><span class="w"> </span><span class="n">correct</span><span class="o">!</span>
</code></pre></div>
<p>&lt;/details&gt;</p>
<blockquote>
<p>I'm reasonably confident that negating the result is equivalent to negating both terms and both cases are safe to fuse without loss of precision.</p>
</blockquote>
<p>This one doesn't seem to pan out, it seems to have the issue with the signed zero. <a href="https://alive2.llvm.org/ce/z/6q5sCj">Proof</a></p>
<p>&lt;details&gt;<br>
  &lt;summary&gt;Result&lt;/summary&gt;</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="n">afonso</span><span class="o">@</span><span class="n">DESKTOP</span><span class="o">-</span><span class="mi">1</span><span class="n">AHKMV2</span>:<span class="o">~/</span><span class="n">git</span><span class="o">/</span><span class="n">alive2</span><span class="o">/</span><span class="n">proofs</span><span class="cp">$</span><span class="w"> </span><span class="o">../</span><span class="n">build</span><span class="o">/</span><span class="n">alive</span><span class="o">-</span><span class="n">tv</span><span class="w"> </span><span class="o">--</span><span class="n">disable</span><span class="o">-</span><span class="n">undef</span><span class="o">-</span><span class="n">input</span><span class="w"> </span><span class="o">--</span><span class="n">smt</span><span class="o">-</span><span class="n">to</span><span class="o">=</span><span class="mi">1800000</span><span class="w"> </span><span class="p">.</span><span class="o">/</span><span class="n">neg_fma_eq_fma_negxz</span><span class="p">.</span><span class="n">ll</span>

<span class="o">----------------------------------------</span>
<span class="n">define</span><span class="w"> </span><span class="n">half</span><span class="w"> </span><span class="o">@</span><span class="n">src</span><span class="p">(</span><span class="n">half</span><span class="w"> </span><span class="o">%</span><span class="n">x</span><span class="p">,</span><span class="w"> </span><span class="n">half</span><span class="w"> </span><span class="o">%</span><span class="n">y</span><span class="p">,</span><span class="w"> </span><span class="n">half</span><span class="w"> </span><span class="o">%</span><span class="n">z</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
#<span class="mi">0</span>:
  <span class="o">%</span><span class="n">fma</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">fma</span><span class="w"> </span><span class="n">half</span><span class="w"> </span><span class="o">%</span><span class="n">x</span><span class="p">,</span><span class="w"> </span><span class="n">half</span><span class="w"> </span><span class="o">%</span><span class="n">y</span><span class="p">,</span><span class="w"> </span><span class="n">half</span><span class="w"> </span><span class="o">%</span><span class="n">z</span>
<span class="w">  </span><span class="o">%</span><span class="n">n</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">fneg</span><span class="w"> </span><span class="n">half</span><span class="w"> </span><span class="o">%</span><span class="n">fma</span>
<span class="w">  </span><span class="n">ret</span><span class="w"> </span><span class="n">half</span><span class="w"> </span><span class="o">%</span><span class="n">n</span>
<span class="p">}</span>
<span class="o">=&gt;</span>
<span class="n">define</span><span class="w"> </span><span class="n">half</span><span class="w"> </span><span class="o">@</span><span class="n">tgt</span><span class="p">(</span><span class="n">half</span><span class="w"> </span><span class="o">%</span><span class="n">x</span><span class="p">,</span><span class="w"> </span><span class="n">half</span><span class="w"> </span><span class="o">%</span><span class="n">y</span><span class="p">,</span><span class="w"> </span><span class="n">half</span><span class="w"> </span><span class="o">%</span><span class="n">z</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
#<span class="mi">0</span>:
  <span class="o">%</span><span class="n">negy</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">fneg</span><span class="w"> </span><span class="n">half</span><span class="w"> </span><span class="o">%</span><span class="n">y</span>
<span class="w">  </span><span class="o">%</span><span class="n">negz</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">fneg</span><span class="w"> </span><span class="n">half</span><span class="w"> </span><span class="o">%</span><span class="n">z</span>
<span class="w">  </span><span class="o">%</span><span class="n">fma</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">fma</span><span class="w"> </span><span class="n">half</span><span class="w"> </span><span class="o">%</span><span class="n">x</span><span class="p">,</span><span class="w"> </span><span class="n">half</span><span class="w"> </span><span class="o">%</span><span class="n">negy</span><span class="p">,</span><span class="w"> </span><span class="n">half</span><span class="w"> </span><span class="o">%</span><span class="n">negz</span>
<span class="w">  </span><span class="n">ret</span><span class="w"> </span><span class="n">half</span><span class="w"> </span><span class="o">%</span><span class="n">fma</span>
<span class="p">}</span>
<span class="n">Transformation</span><span class="w"> </span><span class="n">doesn</span><span class="o">'</span><span class="na">t</span><span class="w"> </span><span class="n">verify</span><span class="o">!</span>

<span class="n">ERROR</span>: <span class="nc">Value</span><span class="w"> </span><span class="n">mismatch</span>

<span class="n">Example</span>:
<span class="nc">half</span><span class="w"> </span><span class="o">%</span><span class="n">x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>#<span class="n">x0000</span><span class="w"> </span><span class="p">(</span><span class="o">+</span><span class="mf">0.0</span><span class="p">)</span>
<span class="n">half</span><span class="w"> </span><span class="o">%</span><span class="n">y</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>#<span class="n">x8100</span><span class="w"> </span><span class="p">(</span><span class="o">-</span><span class="mf">0.000015258789</span><span class="o">?</span><span class="p">)</span>
<span class="n">half</span><span class="w"> </span><span class="o">%</span><span class="n">z</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>#<span class="n">x0000</span><span class="w"> </span><span class="p">(</span><span class="o">+</span><span class="mf">0.0</span><span class="p">)</span>

<span class="n">Source</span>:
<span class="nc">half</span><span class="w"> </span><span class="o">%</span><span class="n">fma</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>#<span class="n">x0000</span><span class="w"> </span><span class="p">(</span><span class="o">+</span><span class="mf">0.0</span><span class="p">)</span>
<span class="n">half</span><span class="w"> </span><span class="o">%</span><span class="n">n</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>#<span class="n">x8000</span><span class="w"> </span><span class="p">(</span><span class="o">-</span><span class="mf">0.0</span><span class="p">)</span>

<span class="n">Target</span>:
<span class="nc">half</span><span class="w"> </span><span class="o">%</span><span class="n">negy</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>#<span class="n">x0100</span><span class="w"> </span><span class="p">(</span><span class="mf">0.000015258789</span><span class="o">?</span><span class="p">)</span>
<span class="n">half</span><span class="w"> </span><span class="o">%</span><span class="n">negz</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>#<span class="n">x8000</span><span class="w"> </span><span class="p">(</span><span class="o">-</span><span class="mf">0.0</span><span class="p">)</span>
<span class="n">half</span><span class="w"> </span><span class="o">%</span><span class="n">fma</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>#<span class="n">x0000</span><span class="w"> </span><span class="p">(</span><span class="o">+</span><span class="mf">0.0</span><span class="p">)</span>
<span class="n">Source</span><span class="w"> </span><span class="n">value</span>: #<span class="n">x8000</span><span class="w"> </span><span class="p">(</span><span class="o">-</span><span class="mf">0.0</span><span class="p">)</span>
<span class="n">Target</span><span class="w"> </span><span class="n">value</span>: #<span class="n">x0000</span><span class="w"> </span><span class="p">(</span><span class="o">+</span><span class="mf">0.0</span><span class="p">)</span>
</code></pre></div>
<p>&lt;/details&gt;</p>
<blockquote>
<p>I'm less confident that, for example, fmadd x y (fneg z) will always give the same results as fmsub x y z if the magnitude of z is very different than x*y</p>
</blockquote>
<p>I can't really test this using alive, since it doesn't have a fmsub intrinsic. But I did something similar using <code>fmul+f{add,sub}</code>, which has 2 rounding steps instead of one, which is what I think really matters. In this case the proof does check out and you can remove an intermediary <code>fneg</code>. <a href="https://alive2.llvm.org/ce/z/Qw_qo1">Proof</a></p>
<p>&lt;details&gt;<br>
  &lt;summary&gt;Result&lt;/summary&gt;</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="n">afonso</span><span class="o">@</span><span class="n">DESKTOP</span><span class="o">-</span><span class="mi">1</span><span class="n">AHKMV2</span>:<span class="o">~/</span><span class="n">git</span><span class="o">/</span><span class="n">alive2</span><span class="o">/</span><span class="n">proofs</span><span class="cp">$</span><span class="w"> </span><span class="o">../</span><span class="n">build</span><span class="o">/</span><span class="n">alive</span><span class="o">-</span><span class="n">tv</span><span class="w"> </span><span class="o">--</span><span class="n">disable</span><span class="o">-</span><span class="n">undef</span><span class="o">-</span><span class="n">input</span><span class="w"> </span><span class="o">--</span><span class="n">smt</span><span class="o">-</span><span class="n">to</span><span class="o">=</span><span class="mi">1800000</span><span class="w"> </span><span class="p">.</span><span class="o">/</span><span class="n">fma_split_neg</span><span class="p">.</span><span class="n">ll</span>

<span class="o">----------------------------------------</span>
<span class="n">define</span><span class="w"> </span><span class="n">half</span><span class="w"> </span><span class="o">@</span><span class="n">src</span><span class="p">(</span><span class="n">half</span><span class="w"> </span><span class="o">%</span><span class="n">x</span><span class="p">,</span><span class="w"> </span><span class="n">half</span><span class="w"> </span><span class="o">%</span><span class="n">y</span><span class="p">,</span><span class="w"> </span><span class="n">half</span><span class="w"> </span><span class="o">%</span><span class="n">z</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
#<span class="mi">0</span>:
  <span class="o">%</span><span class="n">mul</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">fmul</span><span class="w"> </span><span class="n">half</span><span class="w"> </span><span class="o">%</span><span class="n">x</span><span class="p">,</span><span class="w"> </span><span class="o">%</span><span class="n">y</span>
<span class="w">  </span><span class="o">%</span><span class="n">negz</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">fneg</span><span class="w"> </span><span class="n">half</span><span class="w"> </span><span class="o">%</span><span class="n">z</span>
<span class="w">  </span><span class="o">%</span><span class="n">res</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">fadd</span><span class="w"> </span><span class="n">half</span><span class="w"> </span><span class="o">%</span><span class="n">mul</span><span class="p">,</span><span class="w"> </span><span class="o">%</span><span class="n">negz</span>
<span class="w">  </span><span class="n">ret</span><span class="w"> </span><span class="n">half</span><span class="w"> </span><span class="o">%</span><span class="n">res</span>
<span class="p">}</span>
<span class="o">=&gt;</span>
<span class="n">define</span><span class="w"> </span><span class="n">half</span><span class="w"> </span><span class="o">@</span><span class="n">tgt</span><span class="p">(</span><span class="n">half</span><span class="w"> </span><span class="o">%</span><span class="n">x</span><span class="p">,</span><span class="w"> </span><span class="n">half</span><span class="w"> </span><span class="o">%</span><span class="n">y</span><span class="p">,</span><span class="w"> </span><span class="n">half</span><span class="w"> </span><span class="o">%</span><span class="n">z</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
#<span class="mi">0</span>:
  <span class="o">%</span><span class="n">mul</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">fmul</span><span class="w"> </span><span class="n">half</span><span class="w"> </span><span class="o">%</span><span class="n">x</span><span class="p">,</span><span class="w"> </span><span class="o">%</span><span class="n">y</span>
<span class="w">  </span><span class="o">%</span><span class="n">res</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">fsub</span><span class="w"> </span><span class="n">half</span><span class="w"> </span><span class="o">%</span><span class="n">mul</span><span class="p">,</span><span class="w"> </span><span class="o">%</span><span class="n">z</span>
<span class="w">  </span><span class="n">ret</span><span class="w"> </span><span class="n">half</span><span class="w"> </span><span class="o">%</span><span class="n">res</span>
<span class="p">}</span>
<span class="n">Transformation</span><span class="w"> </span><span class="n">seems</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">be</span><span class="w"> </span><span class="n">correct</span><span class="o">!</span>
</code></pre></div>
<p>&lt;/details&gt;</p>
<p>We should probably add a mid end rule for this case!</p>
<blockquote>
<p>Similarly if both x and y are negated, I think you can use fmadd/fmsub, depending on whether z is negated or not. </p>
</blockquote>
<p>I'm not too worried about this case because it's already covered by a <a href="https://github.com/bytecodealliance/wasmtime/blob/e6f9ca5efa0c4bf59c9cf133d9abeaab63ec07bb/cranelift/codegen/src/opts/arithmetic.isle#L107-L110">mid end rule</a>. That being said, it looks like It comes pretty much for free with the solution that you proposed above, so might as well have it.</p>
<p>I'm going to write up a PR using that. Thanks for looking at this in so much detail!</p>
</blockquote>



<a name="438088599"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%238588%20riscv64%3A%20Add%20%60fmsub%60/%60fnmsub%60/%60fnmadd.../near/438088599" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.238588.20riscv64.3A.20Add.20.60fmsub.60.2F.60fnmsub.60.2F.60fnmadd.2E.2E.2E.html#438088599">(May 11 2024 at 07:52)</a>:</h4>
<p>afonso360 edited a <a href="https://github.com/bytecodealliance/wasmtime/pull/8588#issuecomment-2105622411">comment</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/8588">PR #8588</a>:</p>
<blockquote>
<p>So, I played around with alive for a bit. Really cool tool! Unfortunately the compiler explorer for alive2 has a short timeout so I had to run these locally.</p>
<blockquote>
<p>Out of curiosity, can't you use these same fnmsub/fnmadd instructions if y is negated instead of x? </p>
</blockquote>
<p>Yes you can! Here's the <a href="https://alive2.llvm.org/ce/z/sp-dNg">proof that I built for this</a> and it does validate. <br>
&lt;details&gt;<br>
  &lt;summary&gt;Result&lt;/summary&gt;</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="n">afonso</span><span class="o">@</span><span class="n">DESKTOP</span><span class="o">-</span><span class="mi">1</span><span class="n">AHKMV2</span>:<span class="o">~/</span><span class="n">git</span><span class="o">/</span><span class="n">alive2</span><span class="o">/</span><span class="n">build</span><span class="cp">$</span><span class="w"> </span><span class="p">.</span><span class="o">/</span><span class="n">alive</span><span class="o">-</span><span class="n">tv</span><span class="w"> </span><span class="o">--</span><span class="n">disable</span><span class="o">-</span><span class="n">undef</span><span class="o">-</span><span class="n">input</span><span class="w"> </span><span class="o">--</span><span class="n">smt</span><span class="o">-</span><span class="n">to</span><span class="o">=</span><span class="mi">1800000</span><span class="w">  </span><span class="p">.</span><span class="o">/</span><span class="n">tgt</span><span class="p">.</span><span class="n">ll</span>

<span class="o">----------------------------------------</span>
<span class="n">define</span><span class="w"> </span><span class="n">half</span><span class="w"> </span><span class="o">@</span><span class="n">src</span><span class="p">(</span><span class="n">half</span><span class="w"> </span><span class="o">%</span><span class="n">x</span><span class="p">,</span><span class="w"> </span><span class="n">half</span><span class="w"> </span><span class="o">%</span><span class="n">y</span><span class="p">,</span><span class="w"> </span><span class="n">half</span><span class="w"> </span><span class="o">%</span><span class="n">z</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
#<span class="mi">0</span>:
  <span class="o">%</span><span class="n">negx</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">fneg</span><span class="w"> </span><span class="n">half</span><span class="w"> </span><span class="o">%</span><span class="n">x</span>
<span class="w">  </span><span class="o">%</span><span class="n">fma</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">fma</span><span class="w"> </span><span class="n">half</span><span class="w"> </span><span class="o">%</span><span class="n">negx</span><span class="p">,</span><span class="w"> </span><span class="n">half</span><span class="w"> </span><span class="o">%</span><span class="n">y</span><span class="p">,</span><span class="w"> </span><span class="n">half</span><span class="w"> </span><span class="o">%</span><span class="n">z</span>
<span class="w">  </span><span class="n">ret</span><span class="w"> </span><span class="n">half</span><span class="w"> </span><span class="o">%</span><span class="n">fma</span>
<span class="p">}</span>
<span class="o">=&gt;</span>
<span class="n">define</span><span class="w"> </span><span class="n">half</span><span class="w"> </span><span class="o">@</span><span class="n">tgt</span><span class="p">(</span><span class="n">half</span><span class="w"> </span><span class="o">%</span><span class="n">x</span><span class="p">,</span><span class="w"> </span><span class="n">half</span><span class="w"> </span><span class="o">%</span><span class="n">y</span><span class="p">,</span><span class="w"> </span><span class="n">half</span><span class="w"> </span><span class="o">%</span><span class="n">z</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
#<span class="mi">0</span>:
  <span class="o">%</span><span class="n">negy</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">fneg</span><span class="w"> </span><span class="n">half</span><span class="w"> </span><span class="o">%</span><span class="n">y</span>
<span class="w">  </span><span class="o">%</span><span class="n">fma</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">fma</span><span class="w"> </span><span class="n">half</span><span class="w"> </span><span class="o">%</span><span class="n">x</span><span class="p">,</span><span class="w"> </span><span class="n">half</span><span class="w"> </span><span class="o">%</span><span class="n">negy</span><span class="p">,</span><span class="w"> </span><span class="n">half</span><span class="w"> </span><span class="o">%</span><span class="n">z</span>
<span class="w">  </span><span class="n">ret</span><span class="w"> </span><span class="n">half</span><span class="w"> </span><span class="o">%</span><span class="n">fma</span>
<span class="p">}</span>
<span class="n">Transformation</span><span class="w"> </span><span class="n">seems</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">be</span><span class="w"> </span><span class="n">correct</span><span class="o">!</span>
</code></pre></div>
<p>&lt;/details&gt;</p>
<blockquote>
<p>I'm reasonably confident that negating the result is equivalent to negating both terms and both cases are safe to fuse without loss of precision.</p>
</blockquote>
<p>This one doesn't seem to pan out, it seems to have the issue with the signed zero. <a href="https://alive2.llvm.org/ce/z/6q5sCj">Proof</a></p>
<p>&lt;details&gt;<br>
  &lt;summary&gt;Result&lt;/summary&gt;</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="n">afonso</span><span class="o">@</span><span class="n">DESKTOP</span><span class="o">-</span><span class="mi">1</span><span class="n">AHKMV2</span>:<span class="o">~/</span><span class="n">git</span><span class="o">/</span><span class="n">alive2</span><span class="o">/</span><span class="n">proofs</span><span class="cp">$</span><span class="w"> </span><span class="o">../</span><span class="n">build</span><span class="o">/</span><span class="n">alive</span><span class="o">-</span><span class="n">tv</span><span class="w"> </span><span class="o">--</span><span class="n">disable</span><span class="o">-</span><span class="n">undef</span><span class="o">-</span><span class="n">input</span><span class="w"> </span><span class="o">--</span><span class="n">smt</span><span class="o">-</span><span class="n">to</span><span class="o">=</span><span class="mi">1800000</span><span class="w"> </span><span class="p">.</span><span class="o">/</span><span class="n">neg_fma_eq_fma_negxz</span><span class="p">.</span><span class="n">ll</span>

<span class="o">----------------------------------------</span>
<span class="n">define</span><span class="w"> </span><span class="n">half</span><span class="w"> </span><span class="o">@</span><span class="n">src</span><span class="p">(</span><span class="n">half</span><span class="w"> </span><span class="o">%</span><span class="n">x</span><span class="p">,</span><span class="w"> </span><span class="n">half</span><span class="w"> </span><span class="o">%</span><span class="n">y</span><span class="p">,</span><span class="w"> </span><span class="n">half</span><span class="w"> </span><span class="o">%</span><span class="n">z</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
#<span class="mi">0</span>:
  <span class="o">%</span><span class="n">fma</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">fma</span><span class="w"> </span><span class="n">half</span><span class="w"> </span><span class="o">%</span><span class="n">x</span><span class="p">,</span><span class="w"> </span><span class="n">half</span><span class="w"> </span><span class="o">%</span><span class="n">y</span><span class="p">,</span><span class="w"> </span><span class="n">half</span><span class="w"> </span><span class="o">%</span><span class="n">z</span>
<span class="w">  </span><span class="o">%</span><span class="n">n</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">fneg</span><span class="w"> </span><span class="n">half</span><span class="w"> </span><span class="o">%</span><span class="n">fma</span>
<span class="w">  </span><span class="n">ret</span><span class="w"> </span><span class="n">half</span><span class="w"> </span><span class="o">%</span><span class="n">n</span>
<span class="p">}</span>
<span class="o">=&gt;</span>
<span class="n">define</span><span class="w"> </span><span class="n">half</span><span class="w"> </span><span class="o">@</span><span class="n">tgt</span><span class="p">(</span><span class="n">half</span><span class="w"> </span><span class="o">%</span><span class="n">x</span><span class="p">,</span><span class="w"> </span><span class="n">half</span><span class="w"> </span><span class="o">%</span><span class="n">y</span><span class="p">,</span><span class="w"> </span><span class="n">half</span><span class="w"> </span><span class="o">%</span><span class="n">z</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
#<span class="mi">0</span>:
  <span class="o">%</span><span class="n">negy</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">fneg</span><span class="w"> </span><span class="n">half</span><span class="w"> </span><span class="o">%</span><span class="n">y</span>
<span class="w">  </span><span class="o">%</span><span class="n">negz</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">fneg</span><span class="w"> </span><span class="n">half</span><span class="w"> </span><span class="o">%</span><span class="n">z</span>
<span class="w">  </span><span class="o">%</span><span class="n">fma</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">fma</span><span class="w"> </span><span class="n">half</span><span class="w"> </span><span class="o">%</span><span class="n">x</span><span class="p">,</span><span class="w"> </span><span class="n">half</span><span class="w"> </span><span class="o">%</span><span class="n">negy</span><span class="p">,</span><span class="w"> </span><span class="n">half</span><span class="w"> </span><span class="o">%</span><span class="n">negz</span>
<span class="w">  </span><span class="n">ret</span><span class="w"> </span><span class="n">half</span><span class="w"> </span><span class="o">%</span><span class="n">fma</span>
<span class="p">}</span>
<span class="n">Transformation</span><span class="w"> </span><span class="n">doesn</span><span class="o">'</span><span class="na">t</span><span class="w"> </span><span class="n">verify</span><span class="o">!</span>

<span class="n">ERROR</span>: <span class="nc">Value</span><span class="w"> </span><span class="n">mismatch</span>

<span class="n">Example</span>:
<span class="nc">half</span><span class="w"> </span><span class="o">%</span><span class="n">x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>#<span class="n">x0000</span><span class="w"> </span><span class="p">(</span><span class="o">+</span><span class="mf">0.0</span><span class="p">)</span>
<span class="n">half</span><span class="w"> </span><span class="o">%</span><span class="n">y</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>#<span class="n">x8100</span><span class="w"> </span><span class="p">(</span><span class="o">-</span><span class="mf">0.000015258789</span><span class="o">?</span><span class="p">)</span>
<span class="n">half</span><span class="w"> </span><span class="o">%</span><span class="n">z</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>#<span class="n">x0000</span><span class="w"> </span><span class="p">(</span><span class="o">+</span><span class="mf">0.0</span><span class="p">)</span>

<span class="n">Source</span>:
<span class="nc">half</span><span class="w"> </span><span class="o">%</span><span class="n">fma</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>#<span class="n">x0000</span><span class="w"> </span><span class="p">(</span><span class="o">+</span><span class="mf">0.0</span><span class="p">)</span>
<span class="n">half</span><span class="w"> </span><span class="o">%</span><span class="n">n</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>#<span class="n">x8000</span><span class="w"> </span><span class="p">(</span><span class="o">-</span><span class="mf">0.0</span><span class="p">)</span>

<span class="n">Target</span>:
<span class="nc">half</span><span class="w"> </span><span class="o">%</span><span class="n">negy</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>#<span class="n">x0100</span><span class="w"> </span><span class="p">(</span><span class="mf">0.000015258789</span><span class="o">?</span><span class="p">)</span>
<span class="n">half</span><span class="w"> </span><span class="o">%</span><span class="n">negz</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>#<span class="n">x8000</span><span class="w"> </span><span class="p">(</span><span class="o">-</span><span class="mf">0.0</span><span class="p">)</span>
<span class="n">half</span><span class="w"> </span><span class="o">%</span><span class="n">fma</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>#<span class="n">x0000</span><span class="w"> </span><span class="p">(</span><span class="o">+</span><span class="mf">0.0</span><span class="p">)</span>
<span class="n">Source</span><span class="w"> </span><span class="n">value</span>: #<span class="n">x8000</span><span class="w"> </span><span class="p">(</span><span class="o">-</span><span class="mf">0.0</span><span class="p">)</span>
<span class="n">Target</span><span class="w"> </span><span class="n">value</span>: #<span class="n">x0000</span><span class="w"> </span><span class="p">(</span><span class="o">+</span><span class="mf">0.0</span><span class="p">)</span>
</code></pre></div>
<p>&lt;/details&gt;</p>
<blockquote>
<p>I'm less confident that, for example, fmadd x y (fneg z) will always give the same results as fmsub x y z if the magnitude of z is very different than x*y</p>
</blockquote>
<p>I can't really test this using alive, since it doesn't have a fmsub intrinsic. But I did something similar using <code>fmul+f{add,sub}</code>, which has 2 rounding steps instead of one, which is what I think really matters here. In this case the proof does check out and you can remove an intermediary <code>fneg</code>. <a href="https://alive2.llvm.org/ce/z/Qw_qo1">Proof</a></p>
<p>&lt;details&gt;<br>
  &lt;summary&gt;Result&lt;/summary&gt;</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="n">afonso</span><span class="o">@</span><span class="n">DESKTOP</span><span class="o">-</span><span class="mi">1</span><span class="n">AHKMV2</span>:<span class="o">~/</span><span class="n">git</span><span class="o">/</span><span class="n">alive2</span><span class="o">/</span><span class="n">proofs</span><span class="cp">$</span><span class="w"> </span><span class="o">../</span><span class="n">build</span><span class="o">/</span><span class="n">alive</span><span class="o">-</span><span class="n">tv</span><span class="w"> </span><span class="o">--</span><span class="n">disable</span><span class="o">-</span><span class="n">undef</span><span class="o">-</span><span class="n">input</span><span class="w"> </span><span class="o">--</span><span class="n">smt</span><span class="o">-</span><span class="n">to</span><span class="o">=</span><span class="mi">1800000</span><span class="w"> </span><span class="p">.</span><span class="o">/</span><span class="n">fma_split_neg</span><span class="p">.</span><span class="n">ll</span>

<span class="o">----------------------------------------</span>
<span class="n">define</span><span class="w"> </span><span class="n">half</span><span class="w"> </span><span class="o">@</span><span class="n">src</span><span class="p">(</span><span class="n">half</span><span class="w"> </span><span class="o">%</span><span class="n">x</span><span class="p">,</span><span class="w"> </span><span class="n">half</span><span class="w"> </span><span class="o">%</span><span class="n">y</span><span class="p">,</span><span class="w"> </span><span class="n">half</span><span class="w"> </span><span class="o">%</span><span class="n">z</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
#<span class="mi">0</span>:
  <span class="o">%</span><span class="n">mul</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">fmul</span><span class="w"> </span><span class="n">half</span><span class="w"> </span><span class="o">%</span><span class="n">x</span><span class="p">,</span><span class="w"> </span><span class="o">%</span><span class="n">y</span>
<span class="w">  </span><span class="o">%</span><span class="n">negz</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">fneg</span><span class="w"> </span><span class="n">half</span><span class="w"> </span><span class="o">%</span><span class="n">z</span>
<span class="w">  </span><span class="o">%</span><span class="n">res</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">fadd</span><span class="w"> </span><span class="n">half</span><span class="w"> </span><span class="o">%</span><span class="n">mul</span><span class="p">,</span><span class="w"> </span><span class="o">%</span><span class="n">negz</span>
<span class="w">  </span><span class="n">ret</span><span class="w"> </span><span class="n">half</span><span class="w"> </span><span class="o">%</span><span class="n">res</span>
<span class="p">}</span>
<span class="o">=&gt;</span>
<span class="n">define</span><span class="w"> </span><span class="n">half</span><span class="w"> </span><span class="o">@</span><span class="n">tgt</span><span class="p">(</span><span class="n">half</span><span class="w"> </span><span class="o">%</span><span class="n">x</span><span class="p">,</span><span class="w"> </span><span class="n">half</span><span class="w"> </span><span class="o">%</span><span class="n">y</span><span class="p">,</span><span class="w"> </span><span class="n">half</span><span class="w"> </span><span class="o">%</span><span class="n">z</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
#<span class="mi">0</span>:
  <span class="o">%</span><span class="n">mul</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">fmul</span><span class="w"> </span><span class="n">half</span><span class="w"> </span><span class="o">%</span><span class="n">x</span><span class="p">,</span><span class="w"> </span><span class="o">%</span><span class="n">y</span>
<span class="w">  </span><span class="o">%</span><span class="n">res</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">fsub</span><span class="w"> </span><span class="n">half</span><span class="w"> </span><span class="o">%</span><span class="n">mul</span><span class="p">,</span><span class="w"> </span><span class="o">%</span><span class="n">z</span>
<span class="w">  </span><span class="n">ret</span><span class="w"> </span><span class="n">half</span><span class="w"> </span><span class="o">%</span><span class="n">res</span>
<span class="p">}</span>
<span class="n">Transformation</span><span class="w"> </span><span class="n">seems</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">be</span><span class="w"> </span><span class="n">correct</span><span class="o">!</span>
</code></pre></div>
<p>&lt;/details&gt;</p>
<p>We should probably add a mid end rule for this case!</p>
<blockquote>
<p>Similarly if both x and y are negated, I think you can use fmadd/fmsub, depending on whether z is negated or not. </p>
</blockquote>
<p>I'm not too worried about this case because it's already covered by a <a href="https://github.com/bytecodealliance/wasmtime/blob/e6f9ca5efa0c4bf59c9cf133d9abeaab63ec07bb/cranelift/codegen/src/opts/arithmetic.isle#L107-L110">mid end rule</a>. That being said, it looks like It comes pretty much for free with the solution that you proposed above, so might as well have it.</p>
<p>I'm going to write up a PR using that. Thanks for looking at this in so much detail!</p>
</blockquote>



<hr><p>Last updated: Jan 20 2025 at 06:04 UTC</p>
</html>