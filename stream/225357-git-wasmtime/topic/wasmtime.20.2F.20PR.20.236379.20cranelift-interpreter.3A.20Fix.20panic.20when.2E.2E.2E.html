<html>
<head><meta charset="utf-8"><title>wasmtime / PR #6379 cranelift-interpreter: Fix panic when... · git-wasmtime · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/index.html">git-wasmtime</a></h2>
<h3>Topic: <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.236379.20cranelift-interpreter.3A.20Fix.20panic.20when.2E.2E.2E.html">wasmtime / PR #6379 cranelift-interpreter: Fix panic when...</a></h3>

<hr>

<base href="https://bytecodealliance.zulipchat.com">

<head><link href="https://bytecodealliance.github.io/zulip-archive/style.css" rel="stylesheet"></head>

<a name="358550262"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%236379%20cranelift-interpreter%3A%20Fix%20panic%20when.../near/358550262" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.236379.20cranelift-interpreter.3A.20Fix.20panic.20when.2E.2E.2E.html#358550262">(May 15 2023 at 19:08)</a>:</h4>
<p>jan-justin opened <a href="https://github.com/bytecodealliance/wasmtime/pull/6379">PR #6379</a> from <code>jan-justin:cranelift-interpreter-bitcast-simd-panic</code> to <code>bytecodealliance:main</code>:</p>
<blockquote>
<p>Fixes panic caused due to exceeding expected bounds when creating vector values, as mentioned over at #5915</p>
<p>&lt;!--<br>
Please make sure you include the following information:</p>
<ul>
<li>
<p>If this work has been discussed elsewhere, please include a link to that<br>
  conversation. If it was discussed in an issue, just mention "issue #...".</p>
</li>
<li>
<p>Explain why this change is needed. If the details are in an issue already,<br>
  this can be brief.</p>
</li>
</ul>
<p>Our development process is documented in the Wasmtime book:<br>
<a href="https://docs.wasmtime.dev/contributing-development-process.html">https://docs.wasmtime.dev/contributing-development-process.html</a></p>
<p>Please ensure all communication follows the code of conduct:<br>
<a href="https://github.com/bytecodealliance/wasmtime/blob/main/CODE_OF_CONDUCT.md">https://github.com/bytecodealliance/wasmtime/blob/main/CODE_OF_CONDUCT.md</a><br>
--&gt;</p>
</blockquote>



<a name="358550272"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%236379%20cranelift-interpreter%3A%20Fix%20panic%20when.../near/358550272" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.236379.20cranelift-interpreter.3A.20Fix.20panic.20when.2E.2E.2E.html#358550272">(May 15 2023 at 19:08)</a>:</h4>
<p><strong>jan-justin</strong> requested <a href="https://github.com/abrown">abrown</a> for a review on <a href="https://github.com/bytecodealliance/wasmtime/pull/6379">PR #6379</a>.</p>



<a name="358550274"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%236379%20cranelift-interpreter%3A%20Fix%20panic%20when.../near/358550274" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.236379.20cranelift-interpreter.3A.20Fix.20panic.20when.2E.2E.2E.html#358550274">(May 15 2023 at 19:08)</a>:</h4>
<p><strong>jan-justin</strong> requested <a href="https://github.com/orgs/bytecodealliance/teams/wasmtime-compiler-reviewers">wasmtime-compiler-reviewers</a> for a review on <a href="https://github.com/bytecodealliance/wasmtime/pull/6379">PR #6379</a>.</p>



<a name="358633095"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%236379%20cranelift-interpreter%3A%20Fix%20panic%20when.../near/358633095" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.236379.20cranelift-interpreter.3A.20Fix.20panic.20when.2E.2E.2E.html#358633095">(May 16 2023 at 06:24)</a>:</h4>
<p>jan-justin edited <a href="https://github.com/bytecodealliance/wasmtime/pull/6379">PR #6379</a>:</p>
<blockquote>
<p>Fixes panic caused due to exceeding expected bounds when creating vector values, as mentioned over at #5915</p>
<p>&lt;!--<br>
Please make sure you include the following information:</p>
<ul>
<li>
<p>If this work has been discussed elsewhere, please include a link to that<br>
  conversation. If it was discussed in an issue, just mention "issue #...".</p>
</li>
<li>
<p>Explain why this change is needed. If the details are in an issue already,<br>
  this can be brief.</p>
</li>
</ul>
<p>Our development process is documented in the Wasmtime book:<br>
<a href="https://docs.wasmtime.dev/contributing-development-process.html">https://docs.wasmtime.dev/contributing-development-process.html</a></p>
<p>Please ensure all communication follows the code of conduct:<br>
<a href="https://github.com/bytecodealliance/wasmtime/blob/main/CODE_OF_CONDUCT.md">https://github.com/bytecodealliance/wasmtime/blob/main/CODE_OF_CONDUCT.md</a><br>
--&gt;</p>
</blockquote>



<a name="358656888"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%236379%20cranelift-interpreter%3A%20Fix%20panic%20when.../near/358656888" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.236379.20cranelift-interpreter.3A.20Fix.20panic.20when.2E.2E.2E.html#358656888">(May 16 2023 at 08:31)</a>:</h4>
<p>jan-justin updated <a href="https://github.com/bytecodealliance/wasmtime/pull/6379">PR #6379</a>.</p>



<a name="358722639"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%236379%20cranelift-interpreter%3A%20Fix%20panic%20when.../near/358722639" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.236379.20cranelift-interpreter.3A.20Fix.20panic.20when.2E.2E.2E.html#358722639">(May 16 2023 at 12:56)</a>:</h4>
<p>afonso360 submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/6379#pullrequestreview-1428517580">PR review</a>:</p>
<blockquote>
<p>LGTM! Thanks! Just a small note.</p>
</blockquote>



<a name="358722644"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%236379%20cranelift-interpreter%3A%20Fix%20panic%20when.../near/358722644" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.236379.20cranelift-interpreter.3A.20Fix.20panic.20when.2E.2E.2E.html#358722644">(May 16 2023 at 12:56)</a>:</h4>
<p>afonso360 submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/6379#pullrequestreview-1428517580">PR review</a>:</p>
<blockquote>
<p>LGTM! Thanks! Just a small note.</p>
</blockquote>



<a name="358722645"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%236379%20cranelift-interpreter%3A%20Fix%20panic%20when.../near/358722645" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.236379.20cranelift-interpreter.3A.20Fix.20panic.20when.2E.2E.2E.html#358722645">(May 16 2023 at 12:56)</a>:</h4>
<p>afonso360 created <a href="https://github.com/bytecodealliance/wasmtime/pull/6379#discussion_r1195124285">PR review comment</a>:</p>
<blockquote>
<p>This seems to not handle big endian bitcasts. Can we add an assert somewhere here to ensure that we panic in that case? Something along these lines:</p>
<p><div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="fm">assert_eq!</span><span class="p">(</span>
<span class="w">    </span><span class="n">mem_flags</span><span class="p">.</span><span class="n">endianness</span><span class="p">(</span><span class="n">Endianness</span>::<span class="n">Little</span><span class="p">),</span>
<span class="w">    </span><span class="n">Endianness</span>::<span class="n">Little</span><span class="p">,</span>
<span class="w">    </span><span class="s">"Only little endian bitcasts are supported"</span>
<span class="p">);</span>
</code></pre></div><br>
</p>
</blockquote>



<a name="358722970"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%236379%20cranelift-interpreter%3A%20Fix%20panic%20when.../near/358722970" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.236379.20cranelift-interpreter.3A.20Fix.20panic.20when.2E.2E.2E.html#358722970">(May 16 2023 at 12:58)</a>:</h4>
<p>afonso360 edited <a href="https://github.com/bytecodealliance/wasmtime/pull/6379#discussion_r1195124285">PR review comment</a>.</p>



<a name="358734689"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%236379%20cranelift-interpreter%3A%20Fix%20panic%20when.../near/358734689" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.236379.20cranelift-interpreter.3A.20Fix.20panic.20when.2E.2E.2E.html#358734689">(May 16 2023 at 13:37)</a>:</h4>
<p>jan-justin created <a href="https://github.com/bytecodealliance/wasmtime/pull/6379#discussion_r1195180145">PR review comment</a>:</p>
<blockquote>
<p>Sure, I could certainly do that.</p>
<p>I would, however, like to know where it seems to indicate that the bitcasts on s390x are not handled? It might be useful for me in future since the CI run is indicating green for s390x. It failed on a previous run when I used <code>DataValue::read_from_slice_ne</code> variant.</p>
</blockquote>



<a name="358744967"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%236379%20cranelift-interpreter%3A%20Fix%20panic%20when.../near/358744967" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.236379.20cranelift-interpreter.3A.20Fix.20panic.20when.2E.2E.2E.html#358744967">(May 16 2023 at 14:10)</a>:</h4>
<p>afonso360 created <a href="https://github.com/bytecodealliance/wasmtime/pull/6379#discussion_r1195229387">PR review comment</a>:</p>
<blockquote>
<p>Well, I adapted the testcases into big endian and tried it out in s390x, and they are pointing out different results.</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="p">;;</span><span class="w"> </span><span class="n">cargo</span><span class="w"> </span><span class="n">run</span><span class="w"> </span><span class="o">--</span><span class="n">target</span><span class="o">=</span><span class="n">s390x</span><span class="o">-</span><span class="n">unknown</span><span class="o">-</span><span class="n">linux</span><span class="o">-</span><span class="n">gnu</span><span class="w">  </span><span class="o">--</span><span class="w"> </span><span class="n">test</span><span class="w"> </span><span class="p">.</span><span class="o">/</span><span class="n">filetests</span><span class="o">/</span><span class="n">filetests</span><span class="o">/</span><span class="n">runtests</span><span class="o">/</span><span class="n">simd</span><span class="o">-</span><span class="n">bitcast</span><span class="p">.</span><span class="n">clif</span>

<span class="n">test</span><span class="w"> </span><span class="n">interpret</span>
<span class="n">test</span><span class="w"> </span><span class="n">run</span>
<span class="n">target</span><span class="w"> </span><span class="n">s390x</span>

<span class="n">function</span><span class="w"> </span><span class="o">%</span><span class="n">bitcast_more_lanes_big</span><span class="p">(</span><span class="n">i64x2</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nc">i32x4</span><span class="w"> </span><span class="p">{</span>
<span class="n">block0</span><span class="p">(</span><span class="n">v0</span>: <span class="nc">i64x2</span><span class="p">)</span>:
    <span class="nc">v1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">bitcast</span><span class="p">.</span><span class="n">i32x4</span><span class="w"> </span><span class="n">big</span><span class="w"> </span><span class="n">v0</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">v1</span>
<span class="p">}</span>
<span class="p">;</span><span class="w"> </span><span class="n">run</span>: <span class="o">%</span><span class="n">bitcast_more_lanes_big</span><span class="p">(</span><span class="mh">0x00000000000000000000000000000000</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mh">0x00000000000000000000000000000000</span>
<span class="p">;</span><span class="w"> </span><span class="n">run</span>: <span class="o">%</span><span class="n">bitcast_more_lanes_big</span><span class="p">(</span><span class="mh">0x00000000000000ff00000000000000ff</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mh">0x000000ff00000000000000ff00000000</span>

<span class="n">function</span><span class="w"> </span><span class="o">%</span><span class="n">bitcast_fewer_lanes_big</span><span class="p">(</span><span class="n">i16x8</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nc">i64x2</span><span class="w"> </span><span class="p">{</span>
<span class="n">block0</span><span class="p">(</span><span class="n">v0</span>: <span class="nc">i16x8</span><span class="p">)</span>:
    <span class="nc">v1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">bitcast</span><span class="p">.</span><span class="n">i64x2</span><span class="w"> </span><span class="n">big</span><span class="w"> </span><span class="n">v0</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">v1</span>
<span class="p">}</span>
<span class="p">;</span><span class="w"> </span><span class="n">run</span>: <span class="o">%</span><span class="n">bitcast_fewer_lanes_big</span><span class="p">(</span><span class="mh">0x00000000000000000000000000000000</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mh">0x00000000000000000000000000000000</span>
<span class="p">;</span><span class="w"> </span><span class="n">run</span>: <span class="o">%</span><span class="n">bitcast_fewer_lanes_big</span><span class="p">(</span><span class="mh">0x00ff0000000000000000000000000000</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mh">0x00000000000000ff0000000000000000</span>
</code></pre></div>
<p>Those would be good tests to add though! I don't think we have many big endian bitcast runtests. Although it should be noted that only s390x really supports this, I don't think any of the other backends do.</p>
<p>I don't think using <code>ne</code> here is the right solution since we explicitly pick one of the two. I think to make this work with big endian we would have to map each lane, apply a <code>to_be/to_le</code> depending on memflags.</p>
</blockquote>



<a name="358920136"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%236379%20cranelift-interpreter%3A%20Fix%20panic%20when.../near/358920136" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.236379.20cranelift-interpreter.3A.20Fix.20panic.20when.2E.2E.2E.html#358920136">(May 17 2023 at 08:24)</a>:</h4>
<p>jan-justin created <a href="https://github.com/bytecodealliance/wasmtime/pull/6379#discussion_r1196130362">PR review comment</a>:</p>
<blockquote>
<p>I see, thank you for the clarification!</p>
<p>So then is your preference for me to include a panic on big endian bitcasts, or to spend some additional time ensuring that it is correctly handled? </p>
</blockquote>



<a name="358927829"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%236379%20cranelift-interpreter%3A%20Fix%20panic%20when.../near/358927829" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.236379.20cranelift-interpreter.3A.20Fix.20panic.20when.2E.2E.2E.html#358927829">(May 17 2023 at 09:02)</a>:</h4>
<p>afonso360 created <a href="https://github.com/bytecodealliance/wasmtime/pull/6379#discussion_r1196178948">PR review comment</a>:</p>
<blockquote>
<p>Up to you! I'm happy either way.</p>
</blockquote>



<a name="359453597"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%236379%20cranelift-interpreter%3A%20Fix%20panic%20when.../near/359453597" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.236379.20cranelift-interpreter.3A.20Fix.20panic.20when.2E.2E.2E.html#359453597">(May 18 2023 at 17:16)</a>:</h4>
<p>jan-justin created <a href="https://github.com/bytecodealliance/wasmtime/pull/6379#discussion_r1198077812">PR review comment</a>:</p>
<blockquote>
<p>I will give it a whirl. I need to set up qemu to test it and get back to you.</p>
</blockquote>



<a name="360821416"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%236379%20cranelift-interpreter%3A%20Fix%20panic%20when.../near/360821416" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.236379.20cranelift-interpreter.3A.20Fix.20panic.20when.2E.2E.2E.html#360821416">(May 24 2023 at 15:18)</a>:</h4>
<p>jan-justin created <a href="https://github.com/bytecodealliance/wasmtime/pull/6379#discussion_r1204371779">PR review comment</a>:</p>
<blockquote>
<p>Hey, sorry for the delay but I was unable to setup an s390x environment on my M1 MacBook.</p>
<p>At this point it would seem that I would go the assert route, however, I have a question regarding your <a href="https://github.com/bytecodealliance/wasmtime/pull/6379#discussion_r1195229387">comment</a> containing the CLIF. Is your comment stating the assertions you expect to be true, or was that simply the output you received when running on a s390x machine?</p>
<p>I ask because have been wrapping myself around an axle over it.</p>
</blockquote>



<a name="360840700"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%236379%20cranelift-interpreter%3A%20Fix%20panic%20when.../near/360840700" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.236379.20cranelift-interpreter.3A.20Fix.20panic.20when.2E.2E.2E.html#360840700">(May 24 2023 at 16:35)</a>:</h4>
<p>afonso360 created <a href="https://github.com/bytecodealliance/wasmtime/pull/6379#discussion_r1204487373">PR review comment</a>:</p>
<blockquote>
<p>I mostly took that test ran it in QEMU s390x and recorded the output. I didn't look at it particularly hard, however I have some faith that the s390x backend would be correct in this regard. If you'd like to look further into this there is a very long <a href="https://github.com/bytecodealliance/wasmtime/issues/4566">thread</a> where we nailed down the bitcast semantics</p>
</blockquote>



<a name="361148244"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%236379%20cranelift-interpreter%3A%20Fix%20panic%20when.../near/361148244" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.236379.20cranelift-interpreter.3A.20Fix.20panic.20when.2E.2E.2E.html#361148244">(May 25 2023 at 19:20)</a>:</h4>
<p>jan-justin created <a href="https://github.com/bytecodealliance/wasmtime/pull/6379#discussion_r1205920221">PR review comment</a>:</p>
<blockquote>
<p>Thank you, the thread definitely helped me understand the semantics.</p>
<p>I am subsequently able to get the expected output for <code>bitcast_more_lanes_big</code>, however, I am not quite as successful with <code>bitcast_fewer_lanes_big</code>. If you have the time, could you kindly confirm the expected output for <code>bitcast_fewer_lanes_big</code> since I am getting: <code>Failed test: run: %bitcast_fewer_lanes_big(0x00ff0000000000000000000000000000) == 0x00000000000000ff0000000000000000, actual: 0x000000000000000000ff000000000000</code><br>
</p>
</blockquote>



<a name="361161285"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%236379%20cranelift-interpreter%3A%20Fix%20panic%20when.../near/361161285" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.236379.20cranelift-interpreter.3A.20Fix.20panic.20when.2E.2E.2E.html#361161285">(May 25 2023 at 20:37)</a>:</h4>
<p>afonso360 created <a href="https://github.com/bytecodealliance/wasmtime/pull/6379#discussion_r1205981430">PR review comment</a>:</p>
<blockquote>
<p>That test does pass on s390x, and at least at a first glance it makes some sense to me, since the first lane glance it appears that that lane gets mirrored in the i64? This at least seems consistent with the behavior described in page 12 of the <a href="https://github.com/bytecodealliance/wasmtime/issues/4566#issuecomment-1208336548">Vector Bitcast Presentation</a> which essentially makes bitcast a permute? Sorry if I can't help too much here, this stuff really confuses me.</p>
<p>I've tested a few more cases to try and explore this a bit more:</p>
<p><div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="p">;</span><span class="w"> </span><span class="n">run</span>: <span class="o">%</span><span class="n">bitcast_fewer_lanes_big</span><span class="p">(</span><span class="mh">0x00000000000000000000000000000000</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mh">0x00000000000000000000000000000000</span>
<span class="p">;</span><span class="w"> </span><span class="n">run</span>: <span class="o">%</span><span class="n">bitcast_fewer_lanes_big</span><span class="p">(</span><span class="mh">0x00ff0000000000000000000000000000</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mh">0x00000000000000ff0000000000000000</span>
<span class="p">;</span><span class="w"> </span><span class="n">run</span>: <span class="o">%</span><span class="n">bitcast_fewer_lanes_big</span><span class="p">(</span><span class="mh">0x00ff00ff000000000000000000000000</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mh">0x0000000000ff00ff0000000000000000</span>
<span class="p">;</span><span class="w"> </span><span class="n">run</span>: <span class="o">%</span><span class="n">bitcast_fewer_lanes_big</span><span class="p">(</span><span class="mh">0x00ff00ff000000ff0000000000000000</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mh">0x00ff000000ff00ff0000000000000000</span>
<span class="p">;</span><span class="w"> </span><span class="n">run</span>: <span class="o">%</span><span class="n">bitcast_fewer_lanes_big</span><span class="p">(</span><span class="mh">0x00ff00ff000000ff00000000000000ff</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mh">0x00ff000000ff00ff00ff000000000000</span>
<span class="p">;</span><span class="w"> </span><span class="n">run</span>: <span class="o">%</span><span class="n">bitcast_fewer_lanes_big</span><span class="p">(</span><span class="mh">0x00ff00ff000000ff00ff0000000000ff</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mh">0x00ff000000ff00ff00ff0000000000ff</span>
</code></pre></div><br>
</p>
</blockquote>



<a name="361161407"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%236379%20cranelift-interpreter%3A%20Fix%20panic%20when.../near/361161407" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.236379.20cranelift-interpreter.3A.20Fix.20panic.20when.2E.2E.2E.html#361161407">(May 25 2023 at 20:37)</a>:</h4>
<p>afonso360 edited <a href="https://github.com/bytecodealliance/wasmtime/pull/6379#discussion_r1205981430">PR review comment</a>.</p>



<a name="361162262"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%236379%20cranelift-interpreter%3A%20Fix%20panic%20when.../near/361162262" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.236379.20cranelift-interpreter.3A.20Fix.20panic.20when.2E.2E.2E.html#361162262">(May 25 2023 at 20:42)</a>:</h4>
<p>afonso360 edited <a href="https://github.com/bytecodealliance/wasmtime/pull/6379#discussion_r1205981430">PR review comment</a>.</p>



<a name="361162437"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%236379%20cranelift-interpreter%3A%20Fix%20panic%20when.../near/361162437" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.236379.20cranelift-interpreter.3A.20Fix.20panic.20when.2E.2E.2E.html#361162437">(May 25 2023 at 20:43)</a>:</h4>
<p>afonso360 edited <a href="https://github.com/bytecodealliance/wasmtime/pull/6379#discussion_r1205981430">PR review comment</a>.</p>



<a name="361162482"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%236379%20cranelift-interpreter%3A%20Fix%20panic%20when.../near/361162482" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.236379.20cranelift-interpreter.3A.20Fix.20panic.20when.2E.2E.2E.html#361162482">(May 25 2023 at 20:43)</a>:</h4>
<p>afonso360 edited <a href="https://github.com/bytecodealliance/wasmtime/pull/6379#discussion_r1205981430">PR review comment</a>.</p>



<a name="361162574"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%236379%20cranelift-interpreter%3A%20Fix%20panic%20when.../near/361162574" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.236379.20cranelift-interpreter.3A.20Fix.20panic.20when.2E.2E.2E.html#361162574">(May 25 2023 at 20:44)</a>:</h4>
<p>afonso360 edited <a href="https://github.com/bytecodealliance/wasmtime/pull/6379#discussion_r1205981430">PR review comment</a>.</p>



<a name="361240097"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%236379%20cranelift-interpreter%3A%20Fix%20panic%20when.../near/361240097" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.236379.20cranelift-interpreter.3A.20Fix.20panic.20when.2E.2E.2E.html#361240097">(May 26 2023 at 07:36)</a>:</h4>
<p>jan-justin created <a href="https://github.com/bytecodealliance/wasmtime/pull/6379#discussion_r1206351356">PR review comment</a>:</p>
<blockquote>
<p>That is indeed interesting!</p>
<p>I will try to dig a little deeper to see if I can shed some light on this.</p>
<p>Thank you for the additional information, it is really appreciated!</p>
</blockquote>



<a name="362493998"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%236379%20cranelift-interpreter%3A%20Fix%20panic%20when.../near/362493998" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.236379.20cranelift-interpreter.3A.20Fix.20panic.20when.2E.2E.2E.html#362493998">(May 31 2023 at 15:33)</a>:</h4>
<p>jan-justin updated <a href="https://github.com/bytecodealliance/wasmtime/pull/6379">PR #6379</a>.</p>



<a name="362753334"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%236379%20cranelift-interpreter%3A%20Fix%20panic%20when.../near/362753334" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.236379.20cranelift-interpreter.3A.20Fix.20panic.20when.2E.2E.2E.html#362753334">(Jun 01 2023 at 13:24)</a>:</h4>
<p>jan-justin updated <a href="https://github.com/bytecodealliance/wasmtime/pull/6379">PR #6379</a>.</p>



<a name="362772364"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%236379%20cranelift-interpreter%3A%20Fix%20panic%20when.../near/362772364" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.236379.20cranelift-interpreter.3A.20Fix.20panic.20when.2E.2E.2E.html#362772364">(Jun 01 2023 at 14:18)</a>:</h4>
<p>jan-justin created <a href="https://github.com/bytecodealliance/wasmtime/pull/6379#discussion_r1213232841">PR review comment</a>:</p>
<blockquote>
<p>Hey,</p>
<p>So I removed the explicit calls to <code>DataValue::read_from_slice</code> since it was superfluous. Nevertheless, it seems the output when running the Big endian tests through the interpreter still does not yield the expected results you showed.</p>
<p>I won't hold the fix hostage any longer than I already have, so I have added a panic when attempting to bitcast on vectors when the big endian mem flag is set.</p>
</blockquote>



<a name="362882227"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%236379%20cranelift-interpreter%3A%20Fix%20panic%20when.../near/362882227" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.236379.20cranelift-interpreter.3A.20Fix.20panic.20when.2E.2E.2E.html#362882227">(Jun 01 2023 at 21:11)</a>:</h4>
<p>afonso360 created <a href="https://github.com/bytecodealliance/wasmtime/pull/6379#discussion_r1213685531">PR review comment</a>:</p>
<blockquote>
<p>I think disabling big endian for now seems like a reasonable solutions. I'm not entirely sure what is up with filetest infrastructure. Thanks for looking into this!</p>
</blockquote>



<a name="362937685"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%236379%20cranelift-interpreter%3A%20Fix%20panic%20when.../near/362937685" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.236379.20cranelift-interpreter.3A.20Fix.20panic.20when.2E.2E.2E.html#362937685">(Jun 02 2023 at 06:02)</a>:</h4>
<p>jan-justin created <a href="https://github.com/bytecodealliance/wasmtime/pull/6379#discussion_r1213958567">PR review comment</a>:</p>
<blockquote>
<p>No problem at all. Thank you for your patience!</p>
</blockquote>



<a name="363021122"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%236379%20cranelift-interpreter%3A%20Fix%20panic%20when.../near/363021122" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.236379.20cranelift-interpreter.3A.20Fix.20panic.20when.2E.2E.2E.html#363021122">(Jun 02 2023 at 11:53)</a>:</h4>
<p>afonso360 merged <a href="https://github.com/bytecodealliance/wasmtime/pull/6379">PR #6379</a>.</p>



<hr><p>Last updated: Jan 20 2025 at 06:04 UTC</p>
</html>