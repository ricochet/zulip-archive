<html>
<head><meta charset="utf-8"><title>wasmtime / PR #6196 egraphs: Add `bmask` bit pattern opti... · git-wasmtime · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/index.html">git-wasmtime</a></h2>
<h3>Topic: <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.236196.20egraphs.3A.20Add.20.60bmask.60.20bit.20pattern.20opti.2E.2E.2E.html">wasmtime / PR #6196 egraphs: Add `bmask` bit pattern opti...</a></h3>

<hr>

<base href="https://bytecodealliance.zulipchat.com">

<head><link href="https://bytecodealliance.github.io/zulip-archive/style.css" rel="stylesheet"></head>

<a name="348423781"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%236196%20egraphs%3A%20Add%20%60bmask%60%20bit%20pattern%20opti.../near/348423781" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.236196.20egraphs.3A.20Add.20.60bmask.60.20bit.20pattern.20opti.2E.2E.2E.html#348423781">(Apr 11 2023 at 10:54)</a>:</h4>
<p>afonso360 opened <a href="https://github.com/bytecodealliance/wasmtime/pull/6196">PR #6196</a> from <code>afonso360:long-bmask</code> to <code>bytecodealliance:main</code>:</p>
<blockquote>
<p><span aria-label="wave" class="emoji emoji-1f44b" role="img" title="wave">:wave:</span> Hey,</p>
<p>This is something I wrote in #5888 and then <a href="https://github.com/bytecodealliance/wasmtime/pull/5888/commits/497922f547c2299f5d317a73e843b48866c9e863#r1161902682">@elliottt pointed out that It's just <code>bmask</code></a>. I checked if we had a rule for this in the mid end and we don't.</p>
<p>This is a really long long rule, so I'm not sure how often it's going to fire. But I also got that lowering from <a href="https://github.com/RustCrypto/utils/blob/0256fff4d67edb4956f5200b877f41038c4ef7e7/cmov/src/portable.rs#L46-L47">here</a> so it is out there in the real world.</p>
<p>This is based on top of #6140 so that we don't have to rebase that again.<br>
</p>
</blockquote>



<a name="348423785"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%236196%20egraphs%3A%20Add%20%60bmask%60%20bit%20pattern%20opti.../near/348423785" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.236196.20egraphs.3A.20Add.20.60bmask.60.20bit.20pattern.20opti.2E.2E.2E.html#348423785">(Apr 11 2023 at 10:54)</a>:</h4>
<p><strong>afonso360</strong> requested <a href="https://github.com/fitzgen">fitzgen</a> for a review on <a href="https://github.com/bytecodealliance/wasmtime/pull/6196">PR #6196</a>.</p>



<a name="348423787"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%236196%20egraphs%3A%20Add%20%60bmask%60%20bit%20pattern%20opti.../near/348423787" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.236196.20egraphs.3A.20Add.20.60bmask.60.20bit.20pattern.20opti.2E.2E.2E.html#348423787">(Apr 11 2023 at 10:54)</a>:</h4>
<p><strong>afonso360</strong> requested <a href="https://github.com/orgs/bytecodealliance/teams/wasmtime-compiler-reviewers">wasmtime-compiler-reviewers</a> for a review on <a href="https://github.com/bytecodealliance/wasmtime/pull/6196">PR #6196</a>.</p>



<a name="348423954"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%236196%20egraphs%3A%20Add%20%60bmask%60%20bit%20pattern%20opti.../near/348423954" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.236196.20egraphs.3A.20Add.20.60bmask.60.20bit.20pattern.20opti.2E.2E.2E.html#348423954">(Apr 11 2023 at 10:55)</a>:</h4>
<p>afonso360 edited <a href="https://github.com/bytecodealliance/wasmtime/pull/6196">PR #6196</a>:</p>
<blockquote>
<p><span aria-label="wave" class="emoji emoji-1f44b" role="img" title="wave">:wave:</span> Hey,</p>
<p>This is something I wrote in #5888 and then <a href="https://github.com/bytecodealliance/wasmtime/pull/5888/commits/497922f547c2299f5d317a73e843b48866c9e863#r1161902682">@elliottt pointed out that It's just <code>bmask</code></a>. I checked if we had a rule for this in the mid end and we don't.</p>
<p>This is a really long long rule, and I'm not sure how often it's going to fire. But I also got that lowering from <a href="https://github.com/RustCrypto/utils/blob/0256fff4d67edb4956f5200b877f41038c4ef7e7/cmov/src/portable.rs#L46-L47">here</a> so it is out there in the real world.</p>
<p>This is based on top of #6140 so that we don't have to rebase that again.<br>
</p>
</blockquote>



<a name="348425242"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%236196%20egraphs%3A%20Add%20%60bmask%60%20bit%20pattern%20opti.../near/348425242" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.236196.20egraphs.3A.20Add.20.60bmask.60.20bit.20pattern.20opti.2E.2E.2E.html#348425242">(Apr 11 2023 at 11:01)</a>:</h4>
<p>afonso360 updated <a href="https://github.com/bytecodealliance/wasmtime/pull/6196">PR #6196</a>.</p>



<a name="348425295"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%236196%20egraphs%3A%20Add%20%60bmask%60%20bit%20pattern%20opti.../near/348425295" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.236196.20egraphs.3A.20Add.20.60bmask.60.20bit.20pattern.20opti.2E.2E.2E.html#348425295">(Apr 11 2023 at 11:01)</a>:</h4>
<p>afonso360 edited <a href="https://github.com/bytecodealliance/wasmtime/pull/6196">PR #6196</a>:</p>
<blockquote>
<p><span aria-label="wave" class="emoji emoji-1f44b" role="img" title="wave">:wave:</span> Hey,</p>
<p>This is something I wrote in #5888 and then <a href="https://github.com/bytecodealliance/wasmtime/pull/5888/commits/497922f547c2299f5d317a73e843b48866c9e863#r1161902682">@elliottt pointed out that It's just <code>bmask</code></a>. I checked if we had a rule for this in the mid end and we don't.</p>
<p>This is a really long long rule, and I'm not sure how often it's going to fire. But I also got that lowering from <a href="https://github.com/RustCrypto/utils/blob/0256fff4d67edb4956f5200b877f41038c4ef7e7/cmov/src/portable.rs#L46-L47">here</a> so it is out there in the real world.</p>
<p>This is based on top of #6140 so that we don't have to rebase that again.</p>
<p>I'm going to let the fuzzer run on this for a while.<br>
</p>
</blockquote>



<a name="348425350"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%236196%20egraphs%3A%20Add%20%60bmask%60%20bit%20pattern%20opti.../near/348425350" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.236196.20egraphs.3A.20Add.20.60bmask.60.20bit.20pattern.20opti.2E.2E.2E.html#348425350">(Apr 11 2023 at 11:01)</a>:</h4>
<p>afonso360 edited <a href="https://github.com/bytecodealliance/wasmtime/pull/6196">PR #6196</a>:</p>
<blockquote>
<p><span aria-label="wave" class="emoji emoji-1f44b" role="img" title="wave">:wave:</span> Hey,</p>
<p>This is something I wrote in #5888 and then <a href="https://github.com/bytecodealliance/wasmtime/pull/5888/commits/497922f547c2299f5d317a73e843b48866c9e863#r1161902682">@elliottt pointed out that It's just <code>bmask</code></a>. I checked if we had a rule for this in the mid end and we don't.</p>
<p>This is a really long rule, and I'm not sure how often it's going to fire. But I also got that lowering from <a href="https://github.com/RustCrypto/utils/blob/0256fff4d67edb4956f5200b877f41038c4ef7e7/cmov/src/portable.rs#L46-L47">here</a> so it is out there in the real world.</p>
<p>This is based on top of #6140 so that we don't have to rebase that again.</p>
<p>I'm going to let the fuzzer run on this for a while.<br>
</p>
</blockquote>



<a name="348428828"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%236196%20egraphs%3A%20Add%20%60bmask%60%20bit%20pattern%20opti.../near/348428828" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.236196.20egraphs.3A.20Add.20.60bmask.60.20bit.20pattern.20opti.2E.2E.2E.html#348428828">(Apr 11 2023 at 11:16)</a>:</h4>
<p>afonso360 updated <a href="https://github.com/bytecodealliance/wasmtime/pull/6196">PR #6196</a>.</p>



<a name="348429322"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%236196%20egraphs%3A%20Add%20%60bmask%60%20bit%20pattern%20opti.../near/348429322" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.236196.20egraphs.3A.20Add.20.60bmask.60.20bit.20pattern.20opti.2E.2E.2E.html#348429322">(Apr 11 2023 at 11:18)</a>:</h4>
<p>afonso360 updated <a href="https://github.com/bytecodealliance/wasmtime/pull/6196">PR #6196</a>.</p>



<a name="348430879"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%236196%20egraphs%3A%20Add%20%60bmask%60%20bit%20pattern%20opti.../near/348430879" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.236196.20egraphs.3A.20Add.20.60bmask.60.20bit.20pattern.20opti.2E.2E.2E.html#348430879">(Apr 11 2023 at 11:24)</a>:</h4>
<p>afonso360 updated <a href="https://github.com/bytecodealliance/wasmtime/pull/6196">PR #6196</a>.</p>



<a name="348530058"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%236196%20egraphs%3A%20Add%20%60bmask%60%20bit%20pattern%20opti.../near/348530058" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.236196.20egraphs.3A.20Add.20.60bmask.60.20bit.20pattern.20opti.2E.2E.2E.html#348530058">(Apr 11 2023 at 18:00)</a>:</h4>
<p>fitzgen submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/6196#pullrequestreview-1379816842">PR review</a>.</p>



<a name="348530059"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%236196%20egraphs%3A%20Add%20%60bmask%60%20bit%20pattern%20opti.../near/348530059" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.236196.20egraphs.3A.20Add.20.60bmask.60.20bit.20pattern.20opti.2E.2E.2E.html#348530059">(Apr 11 2023 at 18:00)</a>:</h4>
<p>fitzgen submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/6196#pullrequestreview-1379816842">PR review</a>.</p>



<a name="348530061"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%236196%20egraphs%3A%20Add%20%60bmask%60%20bit%20pattern%20opti.../near/348530061" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.236196.20egraphs.3A.20Add.20.60bmask.60.20bit.20pattern.20opti.2E.2E.2E.html#348530061">(Apr 11 2023 at 18:00)</a>:</h4>
<p>fitzgen created <a href="https://github.com/bytecodealliance/wasmtime/pull/6196#discussion_r1163159019">PR review comment</a>:</p>
<blockquote>
<p>Is this actually correct? I couldn't convince myself, so I asked Z3 to find an <code>x</code> for which <code>bmask(x)</code> and <code>!(((x | ((!x) + 1)) &gt;&gt; (ty_bits - 1)) - 1)</code> were not equal (that is, I asked it to find a counterexample):</p>
<div class="codehilite" data-code-language="Common Lisp"><pre><span></span><code><span class="p">(</span><span class="nv">declare-const</span><span class="w"> </span><span class="nv">x</span><span class="w"> </span><span class="p">(</span><span class="nv">_</span><span class="w"> </span><span class="nv">BitVec</span><span class="w"> </span><span class="mi">32</span><span class="p">))</span>

<span class="p">(</span><span class="nb">assert</span><span class="w"> </span><span class="p">(</span><span class="nv">!</span><span class="w"> </span><span class="p">(</span><span class="nb">=</span><span class="w"> </span><span class="p">(</span><span class="nv">ite</span><span class="w"> </span><span class="p">(</span><span class="nb">=</span><span class="w"> </span><span class="nv">x</span><span class="w"> </span><span class="mh">#x00000000</span><span class="p">)</span>
<span class="w">                   </span><span class="mh">#x00000000</span>
<span class="w">                   </span><span class="mh">#xffffffff</span><span class="p">)</span>
<span class="w">              </span><span class="c1">;; !(((x | ((!x) + 1)) &gt;&gt; 31) - 1)</span>
<span class="w">              </span><span class="p">(</span><span class="nv">bvnot</span><span class="w"> </span><span class="p">(</span><span class="nv">bvsub</span><span class="w"> </span><span class="p">(</span><span class="nv">bvlshr</span><span class="w"> </span><span class="p">(</span><span class="nv">bvor</span><span class="w"> </span><span class="nv">x</span>
<span class="w">                                          </span><span class="p">(</span><span class="nv">bvadd</span><span class="w"> </span><span class="p">(</span><span class="nv">bvnot</span><span class="w"> </span><span class="nv">x</span><span class="p">)</span>
<span class="w">                                                 </span><span class="mh">#x00000001</span><span class="p">))</span>
<span class="w">                                    </span><span class="mh">#x0000001f</span><span class="p">)</span>
<span class="w">                            </span><span class="mh">#x00000001</span><span class="p">)))))</span>

<span class="p">(</span><span class="nv">check-sat</span><span class="p">)</span>
<span class="p">(</span><span class="nv">get-model</span><span class="p">)</span>
</code></pre></div>
<p>It reports <code>sat</code>, meaning that it found a counterexample, and it says the counterexample is zero:</p>
<div class="codehilite" data-code-language="Common Lisp"><pre><span></span><code><span class="nv">sat</span>
<span class="p">(</span>
<span class="w">  </span><span class="p">(</span><span class="nv">define-fun</span><span class="w"> </span><span class="nv">x</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="p">(</span><span class="nv">_</span><span class="w"> </span><span class="nv">BitVec</span><span class="w"> </span><span class="mi">32</span><span class="p">)</span>
<span class="w">    </span><span class="mh">#x00000000</span><span class="p">)</span>
<span class="p">)</span>
</code></pre></div>
<p>So unless I'm missing something and/or translated the expression incorrectly, I think this optimization is incorrect?</p>
</blockquote>



<a name="348530338"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%236196%20egraphs%3A%20Add%20%60bmask%60%20bit%20pattern%20opti.../near/348530338" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.236196.20egraphs.3A.20Add.20.60bmask.60.20bit.20pattern.20opti.2E.2E.2E.html#348530338">(Apr 11 2023 at 18:01)</a>:</h4>
<p>fitzgen submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/6196#pullrequestreview-1379819108">PR review</a>.</p>



<a name="348530339"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%236196%20egraphs%3A%20Add%20%60bmask%60%20bit%20pattern%20opti.../near/348530339" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.236196.20egraphs.3A.20Add.20.60bmask.60.20bit.20pattern.20opti.2E.2E.2E.html#348530339">(Apr 11 2023 at 18:01)</a>:</h4>
<p>fitzgen created <a href="https://github.com/bytecodealliance/wasmtime/pull/6196#discussion_r1163160466">PR review comment</a>:</p>
<blockquote>
<p>Then again, there is an explicit test for 0 in the run tests, so I must have done something wrong...</p>
</blockquote>



<a name="348532782"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%236196%20egraphs%3A%20Add%20%60bmask%60%20bit%20pattern%20opti.../near/348532782" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.236196.20egraphs.3A.20Add.20.60bmask.60.20bit.20pattern.20opti.2E.2E.2E.html#348532782">(Apr 11 2023 at 18:14)</a>:</h4>
<p>cfallin submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/6196#pullrequestreview-1379837040">PR review</a>.</p>



<a name="348532784"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%236196%20egraphs%3A%20Add%20%60bmask%60%20bit%20pattern%20opti.../near/348532784" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.236196.20egraphs.3A.20Add.20.60bmask.60.20bit.20pattern.20opti.2E.2E.2E.html#348532784">(Apr 11 2023 at 18:14)</a>:</h4>
<p>cfallin created <a href="https://github.com/bytecodealliance/wasmtime/pull/6196#discussion_r1163172030">PR review comment</a>:</p>
<blockquote>
<p>The SMT counterexample is confusing me too:</p>
<ul>
<li><code>x1 := (bvnot x)</code> with <code>x := 0</code> -&gt; <code>0xffffffff</code></li>
<li><code>x2 := (bvadd x1 1)</code> -&gt; <code>0</code></li>
<li><code>x3 := (bvor x2 x)</code> -&gt; <code>(bvor 0 0)</code> -&gt; <code>0</code></li>
<li><code>x4 := (bvlshr x3 31)</code> -&gt; <code>0</code></li>
<li><code>x5 := (bvsub x4 1)</code> -&gt; <code>0xffffffff</code></li>
<li><code>x6 := (bvnot x5)</code> -&gt; <code>0</code></li>
</ul>
<p>and on the LHS for the if-then-else we have <code>(ite (= 0 0) 0 0xffffffff)</code> -&gt; <code>0</code>. Seems like the optimization did what it was supposed to? I too am confused why we get SAT here. </p>
</blockquote>



<a name="348533779"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%236196%20egraphs%3A%20Add%20%60bmask%60%20bit%20pattern%20opti.../near/348533779" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.236196.20egraphs.3A.20Add.20.60bmask.60.20bit.20pattern.20opti.2E.2E.2E.html#348533779">(Apr 11 2023 at 18:19)</a>:</h4>
<p>jameysharp submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/6196#pullrequestreview-1379843983">PR review</a>.</p>



<a name="348533780"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%236196%20egraphs%3A%20Add%20%60bmask%60%20bit%20pattern%20opti.../near/348533780" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.236196.20egraphs.3A.20Add.20.60bmask.60.20bit.20pattern.20opti.2E.2E.2E.html#348533780">(Apr 11 2023 at 18:19)</a>:</h4>
<p>jameysharp created <a href="https://github.com/bytecodealliance/wasmtime/pull/6196#discussion_r1163176855">PR review comment</a>:</p>
<blockquote>
<p>That Z3 expression looks like a correct translation of that pattern to my eyes, so I'm confused too.</p>
<p>I think the rule seems correct:</p>
<ul>
<li><code>!input + 1</code> is equivalent to <code>-input</code> in two's-complement.</li>
<li>0 is the only value which, when negated, leaves the sign bit clear. (<code>INT_MIN</code> leaves the sign bit set; all other cases flip the sign bit.)</li>
<li>Shifting the sign bit down after <code>x | -x</code> then gives us 0 if the input was 0, and 1 otherwise.</li>
<li>Subtracting 1 means we get -1 if the input was 0, and 0 otherwise.</li>
<li>Inverting the result should then give us the right answer.</li>
</ul>
</blockquote>



<a name="348534564"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%236196%20egraphs%3A%20Add%20%60bmask%60%20bit%20pattern%20opti.../near/348534564" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.236196.20egraphs.3A.20Add.20.60bmask.60.20bit.20pattern.20opti.2E.2E.2E.html#348534564">(Apr 11 2023 at 18:23)</a>:</h4>
<p>cfallin submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/6196#pullrequestreview-1379849426">PR review</a>.</p>



<a name="348534566"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%236196%20egraphs%3A%20Add%20%60bmask%60%20bit%20pattern%20opti.../near/348534566" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.236196.20egraphs.3A.20Add.20.60bmask.60.20bit.20pattern.20opti.2E.2E.2E.html#348534566">(Apr 11 2023 at 18:23)</a>:</h4>
<p>cfallin created <a href="https://github.com/bytecodealliance/wasmtime/pull/6196#discussion_r1163180454">PR review comment</a>:</p>
<blockquote>
<p>And I think this is a reasonable informal proof, by cases:</p>
<p>Prove: <code>;; bmask(input) = !(((input | ((!input) + 1)) &gt;&gt; 63) - 1)</code> (for 64-bit input)</p>
<ul>
<li>Take the three cases<ul>
<li><code>input == 0</code>: we have the above evaluation; the RHS produces <code>0</code> and <code>bmask(0) == 0</code>.</li>
<li><code>input &lt; 0</code>: <code>input</code> has MSB = 1, thus <code>input | ...</code> has MSB = 1. Right-shift by 63, we have <code>1</code>; <code>1 - 1</code> = <code>0</code>; outer bnot gives us all-ones.</li>
<li><code>input &gt; 0</code>: <code>input</code> has MSB = 0, thus <code>!input</code> has MSB = 1. Furthermore <code>!input != 0xffff...ffff</code> (else we would have had <code>input == 0</code>). So <code>!input + 1</code> also has MSB = 1 (because it will not wrap around, because of previous statement). So <code>input | ((!input) + 1)</code> has MSB = 1. Right-shift by 63, we have <code>1</code>; <code>1 - 1</code> = <code>0</code>; outer bnot gives us all-ones.</li>
</ul>
</li>
</ul>
</blockquote>



<a name="348534725"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%236196%20egraphs%3A%20Add%20%60bmask%60%20bit%20pattern%20opti.../near/348534725" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.236196.20egraphs.3A.20Add.20.60bmask.60.20bit.20pattern.20opti.2E.2E.2E.html#348534725">(Apr 11 2023 at 18:24)</a>:</h4>
<p>cfallin submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/6196#pullrequestreview-1379850438">PR review</a>.</p>



<a name="348534728"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%236196%20egraphs%3A%20Add%20%60bmask%60%20bit%20pattern%20opti.../near/348534728" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.236196.20egraphs.3A.20Add.20.60bmask.60.20bit.20pattern.20opti.2E.2E.2E.html#348534728">(Apr 11 2023 at 18:24)</a>:</h4>
<p>cfallin created <a href="https://github.com/bytecodealliance/wasmtime/pull/6196#discussion_r1163181110">PR review comment</a>:</p>
<blockquote>
<p>(@afonso360 a comment to this effect in the source would be very useful for the future!)</p>
</blockquote>



<a name="348535241"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%236196%20egraphs%3A%20Add%20%60bmask%60%20bit%20pattern%20opti.../near/348535241" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.236196.20egraphs.3A.20Add.20.60bmask.60.20bit.20pattern.20opti.2E.2E.2E.html#348535241">(Apr 11 2023 at 18:27)</a>:</h4>
<p>cfallin submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/6196#pullrequestreview-1379854159">PR review</a>.</p>



<a name="348535243"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%236196%20egraphs%3A%20Add%20%60bmask%60%20bit%20pattern%20opti.../near/348535243" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.236196.20egraphs.3A.20Add.20.60bmask.60.20bit.20pattern.20opti.2E.2E.2E.html#348535243">(Apr 11 2023 at 18:27)</a>:</h4>
<p>cfallin created <a href="https://github.com/bytecodealliance/wasmtime/pull/6196#discussion_r1163183680">PR review comment</a>:</p>
<blockquote>
<p>Ah, and after posting I see @jameysharp 's comment too. Both of us arrived at the same reasoning more or less so I'm fairly confident here :-)</p>
</blockquote>



<a name="348538839"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%236196%20egraphs%3A%20Add%20%60bmask%60%20bit%20pattern%20opti.../near/348538839" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.236196.20egraphs.3A.20Add.20.60bmask.60.20bit.20pattern.20opti.2E.2E.2E.html#348538839">(Apr 11 2023 at 18:46)</a>:</h4>
<p>jameysharp submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/6196#pullrequestreview-1379879754">PR review</a>.</p>



<a name="348538840"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%236196%20egraphs%3A%20Add%20%60bmask%60%20bit%20pattern%20opti.../near/348538840" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.236196.20egraphs.3A.20Add.20.60bmask.60.20bit.20pattern.20opti.2E.2E.2E.html#348538840">(Apr 11 2023 at 18:46)</a>:</h4>
<p>jameysharp created <a href="https://github.com/bytecodealliance/wasmtime/pull/6196#discussion_r1163200495">PR review comment</a>:</p>
<blockquote>
<p>We can extract out more broadly-applicable rules that should compose nicely into this one.</p>
<p>Rewrite both of these patterns to <code>(ineg ty input)</code>:</p>
<ul>
<li><code>(iadd ty (bnot ty input) (iconst ty (u64_from_imm64 1)))</code></li>
<li><code>(bnot ty (isub ty input (iconst ty (u64_from_imm64 1))))</code></li>
</ul>
<p>In a 64-bit word, <code>-(x &gt;&gt; 63)</code>, where right-shift is unsigned, should I think be equivalent to <code>x &gt;&gt; 63</code> with a signed right-shift. Or in general, rewrite negation of unsigned shifts by N-1 bits in N-bit words.</p>
<p>Then this rule only needs to match <code>(x | -x) &gt;&gt; (N-1)</code>, with a signed right-shift.</p>
<p>That should make all these rules more broadly applicable as well as (somewhat) easier to understand.</p>
<p><code>x | -x</code> leaves the trailing 0s alone and sets the remaining bits to 1. (I found the inverse of this pattern in "Hacker's Delight", on page 12.) I don't think there's a useful rule we can extract from that pattern alone.</p>
</blockquote>



<a name="348539396"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%236196%20egraphs%3A%20Add%20%60bmask%60%20bit%20pattern%20opti.../near/348539396" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.236196.20egraphs.3A.20Add.20.60bmask.60.20bit.20pattern.20opti.2E.2E.2E.html#348539396">(Apr 11 2023 at 18:49)</a>:</h4>
<p>elliottt submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/6196#pullrequestreview-1379883803">PR review</a>.</p>



<a name="348539398"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%236196%20egraphs%3A%20Add%20%60bmask%60%20bit%20pattern%20opti.../near/348539398" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.236196.20egraphs.3A.20Add.20.60bmask.60.20bit.20pattern.20opti.2E.2E.2E.html#348539398">(Apr 11 2023 at 18:49)</a>:</h4>
<p>elliottt created <a href="https://github.com/bytecodealliance/wasmtime/pull/6196#discussion_r1163203196">PR review comment</a>:</p>
<blockquote>
<p>The problem with the smtlib version was the use of <code>!</code>, which is for annotating expressions: switching to <code>not</code> fixes the problem:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="p">(</span><span class="n">declare</span><span class="o">-</span><span class="k">const</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="p">(</span><span class="n">_</span><span class="w"> </span><span class="n">BitVec</span><span class="w"> </span><span class="mi">32</span><span class="p">))</span>

<span class="p">(</span><span class="n">assert</span><span class="w"> </span><span class="p">(</span><span class="n">not</span><span class="w"> </span><span class="p">(</span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">ite</span><span class="w"> </span><span class="p">(</span><span class="o">=</span><span class="w"> </span><span class="n">x</span><span class="w"> </span>#<span class="n">x00000000</span><span class="p">)</span>
<span class="w">                   </span>#<span class="n">x00000000</span>
<span class="w">                   </span>#<span class="n">xffffffff</span><span class="p">)</span>
<span class="w">              </span><span class="p">;;</span><span class="w"> </span><span class="o">!</span><span class="p">(((</span><span class="n">x</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="p">((</span><span class="o">!</span><span class="n">x</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">))</span><span class="w"> </span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="mi">31</span><span class="p">)</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span>
<span class="w">              </span><span class="p">(</span><span class="n">bvnot</span><span class="w"> </span><span class="p">(</span><span class="n">bvsub</span><span class="w"> </span><span class="p">(</span><span class="n">bvlshr</span><span class="w"> </span><span class="p">(</span><span class="n">bvor</span><span class="w"> </span><span class="n">x</span>
<span class="w">                                          </span><span class="p">(</span><span class="n">bvadd</span><span class="w"> </span><span class="p">(</span><span class="n">bvnot</span><span class="w"> </span><span class="n">x</span><span class="p">)</span>
<span class="w">                                                 </span>#<span class="n">x00000001</span><span class="p">))</span>
<span class="w">                                    </span>#<span class="n">x0000001f</span><span class="p">)</span>
<span class="w">                            </span>#<span class="n">x00000001</span><span class="p">)))))</span>

<span class="p">(</span><span class="n">check</span><span class="o">-</span><span class="n">sat</span><span class="p">)</span>
<span class="p">(</span><span class="n">get</span><span class="o">-</span><span class="n">model</span><span class="p">)</span>
</code></pre></div>
<p>produces the following output:</p>
<p><div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="o">%</span><span class="w"> </span><span class="n">z3</span><span class="w"> </span><span class="o">-</span><span class="n">smt2</span><span class="w"> </span><span class="n">test</span><span class="p">.</span><span class="n">smt</span>
<span class="n">unsat</span>
<span class="p">(</span><span class="n">error</span><span class="w"> </span><span class="s">"line 14 column 10: model is not available"</span><span class="p">)</span>
</code></pre></div><br>
</p>
</blockquote>



<a name="348543125"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%236196%20egraphs%3A%20Add%20%60bmask%60%20bit%20pattern%20opti.../near/348543125" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.236196.20egraphs.3A.20Add.20.60bmask.60.20bit.20pattern.20opti.2E.2E.2E.html#348543125">(Apr 11 2023 at 19:08)</a>:</h4>
<p>fitzgen submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/6196#pullrequestreview-1379910391">PR review</a>.</p>



<a name="348543127"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%236196%20egraphs%3A%20Add%20%60bmask%60%20bit%20pattern%20opti.../near/348543127" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.236196.20egraphs.3A.20Add.20.60bmask.60.20bit.20pattern.20opti.2E.2E.2E.html#348543127">(Apr 11 2023 at 19:08)</a>:</h4>
<p>fitzgen submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/6196#pullrequestreview-1379910391">PR review</a>.</p>



<a name="348543131"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%236196%20egraphs%3A%20Add%20%60bmask%60%20bit%20pattern%20opti.../near/348543131" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.236196.20egraphs.3A.20Add.20.60bmask.60.20bit.20pattern.20opti.2E.2E.2E.html#348543131">(Apr 11 2023 at 19:08)</a>:</h4>
<p>fitzgen created <a href="https://github.com/bytecodealliance/wasmtime/pull/6196#discussion_r1163220103">PR review comment</a>:</p>
<blockquote>
<p>Nitpick: instead of hard coding <code>63</code> lets make this <code>bits(ty) - 1</code>.</p>
<p>Also, lets add a comment with an informal proof / argument about why this is correct, as @cfallin mentioned.</p>
</blockquote>



<a name="348548384"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%236196%20egraphs%3A%20Add%20%60bmask%60%20bit%20pattern%20opti.../near/348548384" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.236196.20egraphs.3A.20Add.20.60bmask.60.20bit.20pattern.20opti.2E.2E.2E.html#348548384">(Apr 11 2023 at 19:36)</a>:</h4>
<p>jameysharp submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/6196#pullrequestreview-1379948105">PR review</a>.</p>



<a name="348548386"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%236196%20egraphs%3A%20Add%20%60bmask%60%20bit%20pattern%20opti.../near/348548386" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.236196.20egraphs.3A.20Add.20.60bmask.60.20bit.20pattern.20opti.2E.2E.2E.html#348548386">(Apr 11 2023 at 19:36)</a>:</h4>
<p>jameysharp created <a href="https://github.com/bytecodealliance/wasmtime/pull/6196#discussion_r1163244717">PR review comment</a>:</p>
<blockquote>
<p>I think the correctness argument is much less important to write out if this is split into the four separate rules I suggested. They're individually much easier to verify.</p>
</blockquote>



<a name="349105869"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%236196%20egraphs%3A%20Add%20%60bmask%60%20bit%20pattern%20opti.../near/349105869" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.236196.20egraphs.3A.20Add.20.60bmask.60.20bit.20pattern.20opti.2E.2E.2E.html#349105869">(Apr 13 2023 at 13:10)</a>:</h4>
<p>afonso360 updated <a href="https://github.com/bytecodealliance/wasmtime/pull/6196">PR #6196</a>.</p>



<a name="349121531"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%236196%20egraphs%3A%20Add%20%60bmask%60%20bit%20pattern%20opti.../near/349121531" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.236196.20egraphs.3A.20Add.20.60bmask.60.20bit.20pattern.20opti.2E.2E.2E.html#349121531">(Apr 13 2023 at 14:09)</a>:</h4>
<p>afonso360 updated <a href="https://github.com/bytecodealliance/wasmtime/pull/6196">PR #6196</a>.</p>



<a name="349124094"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%236196%20egraphs%3A%20Add%20%60bmask%60%20bit%20pattern%20opti.../near/349124094" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.236196.20egraphs.3A.20Add.20.60bmask.60.20bit.20pattern.20opti.2E.2E.2E.html#349124094">(Apr 13 2023 at 14:17)</a>:</h4>
<p>afonso360 updated <a href="https://github.com/bytecodealliance/wasmtime/pull/6196">PR #6196</a>.</p>



<a name="349190514"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%236196%20egraphs%3A%20Add%20%60bmask%60%20bit%20pattern%20opti.../near/349190514" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.236196.20egraphs.3A.20Add.20.60bmask.60.20bit.20pattern.20opti.2E.2E.2E.html#349190514">(Apr 13 2023 at 18:58)</a>:</h4>
<p>jameysharp submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/6196#pullrequestreview-1383749355">PR review</a>.</p>



<a name="349190515"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%236196%20egraphs%3A%20Add%20%60bmask%60%20bit%20pattern%20opti.../near/349190515" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.236196.20egraphs.3A.20Add.20.60bmask.60.20bit.20pattern.20opti.2E.2E.2E.html#349190515">(Apr 13 2023 at 18:58)</a>:</h4>
<p>jameysharp submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/6196#pullrequestreview-1383749355">PR review</a>.</p>



<a name="349190517"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%236196%20egraphs%3A%20Add%20%60bmask%60%20bit%20pattern%20opti.../near/349190517" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.236196.20egraphs.3A.20Add.20.60bmask.60.20bit.20pattern.20opti.2E.2E.2E.html#349190517">(Apr 13 2023 at 18:58)</a>:</h4>
<p>jameysharp created <a href="https://github.com/bytecodealliance/wasmtime/pull/6196#discussion_r1165739099">PR review comment</a>:</p>
<blockquote>
<p>This comment is great, thank you!</p>
<p>I guess we should add the commutative version of this too, for <code>(-x | x)</code>, to go with <code>(x | -x)</code>.</p>
</blockquote>



<a name="349190518"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%236196%20egraphs%3A%20Add%20%60bmask%60%20bit%20pattern%20opti.../near/349190518" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.236196.20egraphs.3A.20Add.20.60bmask.60.20bit.20pattern.20opti.2E.2E.2E.html#349190518">(Apr 13 2023 at 18:58)</a>:</h4>
<p>jameysharp created <a href="https://github.com/bytecodealliance/wasmtime/pull/6196#discussion_r1165751518">PR review comment</a>:</p>
<blockquote>
<p>I'd like a couple more cases, maybe instead of the cases for 2 or 3:</p>
<ul>
<li>0xFFFF_FFFF_FFFF_FFFF</li>
<li>0x8000_0000_0000_0000</li>
</ul>
<p>I'd also be fine with narrowing this to <code>i32</code> or <code>i16</code> so the interesting edge cases have smaller constants…</p>
</blockquote>



<a name="349190519"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%236196%20egraphs%3A%20Add%20%60bmask%60%20bit%20pattern%20opti.../near/349190519" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.236196.20egraphs.3A.20Add.20.60bmask.60.20bit.20pattern.20opti.2E.2E.2E.html#349190519">(Apr 13 2023 at 18:58)</a>:</h4>
<p>jameysharp created <a href="https://github.com/bytecodealliance/wasmtime/pull/6196#discussion_r1165742971">PR review comment</a>:</p>
<blockquote>
<p>This rule would also work for <code>(x + (-1))</code> and its commutative equivalent.</p>
<p>I considered suggesting that we should have a rule that transforms <code>isub</code> where the second operand is constant into <code>iadd</code> of the negation of that constant. Then any rules involving addition with a constant can fire for <code>isub</code> as well. For example, <code>(!x) - (-1)</code> would fire the rules above.</p>
<p>That's not ideal though since it replaces an instruction with another instruction of equal cost, and I think we're converging on the idea that every egraph rule should rewrite to an expression of lower total cost. So in this case we'd want six rules in total:</p>
<ul>
<li><code>!x + 1 == 1 + !x == !x - (-1) == -x</code></li>
<li><code>!(x - 1) == !(x + (-1)) == !((-1) + x) == -x</code></li>
</ul>
</blockquote>



<a name="349190520"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%236196%20egraphs%3A%20Add%20%60bmask%60%20bit%20pattern%20opti.../near/349190520" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.236196.20egraphs.3A.20Add.20.60bmask.60.20bit.20pattern.20opti.2E.2E.2E.html#349190520">(Apr 13 2023 at 18:58)</a>:</h4>
<p>jameysharp created <a href="https://github.com/bytecodealliance/wasmtime/pull/6196#discussion_r1165764900">PR review comment</a>:</p>
<blockquote>
<p>Elsewhere in this file these comments were written in the other order, with the pattern we're looking for first and the simpler equivalent afterward, and I think that makes a little more sense. So this example would instead be:</p>
<div class="codehilite" data-code-language="suggestion"><pre><span></span><code>;; (!x) + 1 == ineg(x)
</code></pre></div>
<p>And similarly through the rest of the rules in this PR.</p>
</blockquote>



<a name="349199347"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%236196%20egraphs%3A%20Add%20%60bmask%60%20bit%20pattern%20opti.../near/349199347" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.236196.20egraphs.3A.20Add.20.60bmask.60.20bit.20pattern.20opti.2E.2E.2E.html#349199347">(Apr 13 2023 at 19:51)</a>:</h4>
<p>afonso360 updated <a href="https://github.com/bytecodealliance/wasmtime/pull/6196">PR #6196</a>.</p>



<a name="349199618"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%236196%20egraphs%3A%20Add%20%60bmask%60%20bit%20pattern%20opti.../near/349199618" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.236196.20egraphs.3A.20Add.20.60bmask.60.20bit.20pattern.20opti.2E.2E.2E.html#349199618">(Apr 13 2023 at 19:52)</a>:</h4>
<p>afonso360 submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/6196#pullrequestreview-1384115092">PR review</a>.</p>



<a name="350031788"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%236196%20egraphs%3A%20Add%20%60bmask%60%20bit%20pattern%20opti.../near/350031788" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.236196.20egraphs.3A.20Add.20.60bmask.60.20bit.20pattern.20opti.2E.2E.2E.html#350031788">(Apr 14 2023 at 19:29)</a>:</h4>
<p>jameysharp merged <a href="https://github.com/bytecodealliance/wasmtime/pull/6196">PR #6196</a>.</p>



<hr><p>Last updated: Jan 20 2025 at 06:04 UTC</p>
</html>