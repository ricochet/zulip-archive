<html>
<head><meta charset="utf-8"><title>wasmtime / Issue #1931 Write ELF image and instantiate co... · git-wasmtime · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/index.html">git-wasmtime</a></h2>
<h3>Topic: <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20Issue.20.231931.20Write.20ELF.20image.20and.20instantiate.20co.2E.2E.2E.html">wasmtime / Issue #1931 Write ELF image and instantiate co...</a></h3>

<hr>

<base href="https://bytecodealliance.zulipchat.com">

<head><link href="https://bytecodealliance.github.io/zulip-archive/style.css" rel="stylesheet"></head>

<a name="202143932"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20Issue%20%231931%20Write%20ELF%20image%20and%20instantiate%20co.../near/202143932" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20Issue.20.231931.20Write.20ELF.20image.20and.20instantiate.20co.2E.2E.2E.html#202143932">(Jun 26 2020 at 21:20)</a>:</h4>
<p>yurydelendik <a href="https://github.com/bytecodealliance/wasmtime/pull/1931#issuecomment-650406792">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/1931">Issue #1931</a>:</p>
<blockquote>
<p>Items to verify:</p>
<ul>
<li>[ ] AArch64</li>
<li>[ ] Windows unwind info</li>
</ul>
</blockquote>



<a name="202146901"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20Issue%20%231931%20Write%20ELF%20image%20and%20instantiate%20co.../near/202146901" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20Issue.20.231931.20Write.20ELF.20image.20and.20instantiate.20co.2E.2E.2E.html#202146901">(Jun 26 2020 at 21:53)</a>:</h4>
<p>github-actions[bot] <a href="https://github.com/bytecodealliance/wasmtime/pull/1931#issuecomment-650420025">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/1931">Issue #1931</a>:</p>
<blockquote>
<h4>Subscribe to Label Action</h4>
<p>cc @bnjbvr, @peterhuene</p>
<p>&lt;details&gt;<br>
This issue or pull request has been labeled: "cranelift", "cranelift:wasm", "wasmtime:api"</p>
<p>Thus the following users have been cc'd because of the following labels:</p>
<ul>
<li>bnjbvr: cranelift</li>
<li>peterhuene: wasmtime:api</li>
</ul>
<p>To subscribe or unsubscribe from this label, edit the &lt;code&gt;.github/subscribe-to-label.json&lt;/code&gt; configuration file.</p>
<p><a href="https://github.com/bytecodealliance/subscribe-to-label-action">Learn more.</a><br>
&lt;/details&gt;</p>
</blockquote>



<a name="202180482"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20Issue%20%231931%20Write%20ELF%20image%20and%20instantiate%20co.../near/202180482" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20Issue.20.231931.20Write.20ELF.20image.20and.20instantiate.20co.2E.2E.2E.html#202180482">(Jun 27 2020 at 11:05)</a>:</h4>
<p>tschneidereit <a href="https://github.com/bytecodealliance/wasmtime/pull/1931#issuecomment-650544226">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/1931">Issue #1931</a>:</p>
<blockquote>
<p>CC @pchickey, would be good to get your input on the general approach here.</p>
<blockquote>
<p>There is somewhat common/duplicated code in <code>cranelift-object</code> and <code>creates/obj</code>, this PR is not refactoring these crates yet. It is a work for follow up PRs.</p>
</blockquote>
<p>Can you give some details on why this should be done as a follow-up? I think it might be good to do this refactoring as part of the initial landing if possible.</p>
</blockquote>



<a name="202337355"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20Issue%20%231931%20Write%20ELF%20image%20and%20instantiate%20co.../near/202337355" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20Issue.20.231931.20Write.20ELF.20image.20and.20instantiate.20co.2E.2E.2E.html#202337355">(Jun 29 2020 at 16:48)</a>:</h4>
<p>yurydelendik <a href="https://github.com/bytecodealliance/wasmtime/pull/1931#issuecomment-651237774">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/1931">Issue #1931</a>:</p>
<blockquote>
<blockquote>
<blockquote>
<p>There is somewhat common/duplicated code in cranelift-object and creates/obj, this PR is not refactoring these crates yet. It is a work for follow up PRs.</p>
</blockquote>
<p>Can you give some details on why this should be done as a follow-up? I think it might be good to do this refactoring as part of the initial landing if possible.</p>
</blockquote>
<p><code>cranelift-object</code> is more generic backend for creating (ELF) object files, and does not fully reflect what is needed for wasm atm. <code>crates/obj</code> is close to what we need though it emits information such as tables or data segments into object file (as well as supporting other formats than ELF).</p>
<p>Once we define how <code>crates/obj</code> and "wasm2obj" are used, we can merge/refactor its and this PR code to remove duplicated logic. I wonder who are the users of these crate and utility. @pchickey, are you using it these in some way?</p>
</blockquote>



<a name="202339371"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20Issue%20%231931%20Write%20ELF%20image%20and%20instantiate%20co.../near/202339371" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20Issue.20.231931.20Write.20ELF.20image.20and.20instantiate.20co.2E.2E.2E.html#202339371">(Jun 29 2020 at 17:03)</a>:</h4>
<p>yurydelendik <a href="https://github.com/bytecodealliance/wasmtime/pull/1931#issuecomment-651245460">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/1931">Issue #1931</a>:</p>
<blockquote>
<blockquote>
<p>One of my main thoughts when reading this is about the various copies happening. To make sure I understand thing, can you double check this?</p>
<ul>
<li>When generating code for the first time, we first invoke cranelift which emits function code into a buffer for each function.</li>
<li>Next we copy (?) each buffer into an object data structure to create an ELF image</li>
<li>Next we copy that ELF image into the final executable page residing in CodeMemory</li>
</ul>
</blockquote>
<p>That is about to be correct. Notice that we generated the ELF image for GDB JIT code, so for debug mode nothing is changed is term of copies.</p>
<p>I'm looking into making <code>object</code> to emit image directly into CodeMemory, where we can directly protect regions for execution. Alternatively, the last copy operation can be removed when the code becomes PIC, so we don't have to patch the image, so there is a potential to use mmap+fs, and compete with current caching logic. </p>
</blockquote>



<a name="202352238"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20Issue%20%231931%20Write%20ELF%20image%20and%20instantiate%20co.../near/202352238" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20Issue.20.231931.20Write.20ELF.20image.20and.20instantiate.20co.2E.2E.2E.html#202352238">(Jun 29 2020 at 18:46)</a>:</h4>
<p>yurydelendik edited a <a href="https://github.com/bytecodealliance/wasmtime/pull/1931#issuecomment-651237774">comment</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/1931">Issue #1931</a>:</p>
<blockquote>
<blockquote>
<blockquote>
<p>There is somewhat common/duplicated code in cranelift-object and creates/obj, this PR is not refactoring these crates yet. It is a work for follow up PRs.</p>
</blockquote>
<p>Can you give some details on why this should be done as a follow-up? I think it might be good to do this refactoring as part of the initial landing if possible.</p>
</blockquote>
<p><code>cranelift-object</code> is more generic backend for creating (ELF) object files, and does not fully reflect what is needed for wasm atm. <code>crates/obj</code> is close to what we need though it emits information such as tables or data segments into object file (as well as supporting other formats than ELF).</p>
<p>Once we define how <code>crates/obj</code> and "wasm2obj" are used, we can merge/refactor its and this PR code to remove duplicated logic. I wonder who are the users of these crate and utility. @pchickey, are you using it these in some unique way?</p>
</blockquote>



<a name="202375654"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20Issue%20%231931%20Write%20ELF%20image%20and%20instantiate%20co.../near/202375654" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20Issue.20.231931.20Write.20ELF.20image.20and.20instantiate.20co.2E.2E.2E.html#202375654">(Jun 29 2020 at 22:28)</a>:</h4>
<p>yurydelendik <a href="https://github.com/bytecodealliance/wasmtime/pull/1931#issuecomment-651403032">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/1931">Issue #1931</a>:</p>
<blockquote>
<ul>
<li>[ ] check if <a href="https://github.com/gimli-rs/object/issues/240">https://github.com/gimli-rs/object/issues/240</a> will help with copy reduction</li>
</ul>
</blockquote>



<a name="202445782"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20Issue%20%231931%20Write%20ELF%20image%20and%20instantiate%20co.../near/202445782" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20Issue.20.231931.20Write.20ELF.20image.20and.20instantiate.20co.2E.2E.2E.html#202445782">(Jun 30 2020 at 14:48)</a>:</h4>
<p>alexcrichton <a href="https://github.com/bytecodealliance/wasmtime/pull/1931#issuecomment-651842764">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/1931">Issue #1931</a>:</p>
<blockquote>
<p>Ok, it seems reasonable to go ahead with this in the meantime if more refactoring is required internally to get to the goal of "mmap and go". I'd want to make sure we don't paint ourselves into a corner where that's not possible, but it sounds like that's not the case.</p>
<p>Can you ad some high-level documentation somewhere for this, too? It'd be good I think to have a doc block describing how a wasm module is transformed into an ELF image, so whenever we read/write that we can refer back to those docs about what should go where.</p>
</blockquote>



<a name="202575338"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20Issue%20%231931%20Write%20ELF%20image%20and%20instantiate%20co.../near/202575338" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20Issue.20.231931.20Write.20ELF.20image.20and.20instantiate.20co.2E.2E.2E.html#202575338">(Jul 01 2020 at 14:29)</a>:</h4>
<p>yurydelendik <a href="https://github.com/bytecodealliance/wasmtime/pull/1931#issuecomment-652452832">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/1931">Issue #1931</a>:</p>
<blockquote>
<blockquote>
<p>Items to verify:
* AArch64</p>
</blockquote>
<p>@cfallin could you verify if I refactored Arm64Call properly ? Not sure how to test it.  </p>
<blockquote>
<ul>
<li>Windows unwind info</li>
</ul>
</blockquote>
<p>@peterhuene I think the Windows Unwind stuff where properly refactored and tests are passing. If you have time, can you glance the changes? </p>
</blockquote>



<a name="202579590"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20Issue%20%231931%20Write%20ELF%20image%20and%20instantiate%20co.../near/202579590" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20Issue.20.231931.20Write.20ELF.20image.20and.20instantiate.20co.2E.2E.2E.html#202579590">(Jul 01 2020 at 15:03)</a>:</h4>
<p>yurydelendik edited a <a href="https://github.com/bytecodealliance/wasmtime/pull/1931#issuecomment-652452832">comment</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/1931">Issue #1931</a>:</p>
<blockquote>
<blockquote>
<p>Items to verify:
* AArch64</p>
</blockquote>
<p>@cfallin could you verify if I refactored Arm64Call properly ? Not sure how to test it.  </p>
<blockquote>
<ul>
<li>Windows unwind info</li>
</ul>
</blockquote>
<p>@peterhuene I think the Windows Unwind stuff were properly refactored and tests are passing. If you have time, can you glance the changes? </p>
</blockquote>



<a name="202615800"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20Issue%20%231931%20Write%20ELF%20image%20and%20instantiate%20co.../near/202615800" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20Issue.20.231931.20Write.20ELF.20image.20and.20instantiate.20co.2E.2E.2E.html#202615800">(Jul 01 2020 at 19:48)</a>:</h4>
<p>peterhuene <a href="https://github.com/bytecodealliance/wasmtime/pull/1931#issuecomment-652613735">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/1931">Issue #1931</a>:</p>
<blockquote>
<p>The unwind changes seem reasonable to me.</p>
</blockquote>



<a name="202616035"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20Issue%20%231931%20Write%20ELF%20image%20and%20instantiate%20co.../near/202616035" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20Issue.20.231931.20Write.20ELF.20image.20and.20instantiate.20co.2E.2E.2E.html#202616035">(Jul 01 2020 at 19:50)</a>:</h4>
<p>yurydelendik edited a <a href="https://github.com/bytecodealliance/wasmtime/pull/1931#issuecomment-650406792">comment</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/1931">Issue #1931</a>:</p>
<blockquote>
<p>Items to verify:</p>
<ul>
<li>[ ] AArch64</li>
<li>[x] Windows unwind info</li>
</ul>
</blockquote>



<a name="203027074"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20Issue%20%231931%20Write%20ELF%20image%20and%20instantiate%20co.../near/203027074" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20Issue.20.231931.20Write.20ELF.20image.20and.20instantiate.20co.2E.2E.2E.html#203027074">(Jul 06 2020 at 18:54)</a>:</h4>
<p>yurydelendik edited a <a href="https://github.com/bytecodealliance/wasmtime/pull/1931#issuecomment-650406792">comment</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/1931">Issue #1931</a>:</p>
<blockquote>
<p>Items to verify:</p>
<ul>
<li>[x] AArch64</li>
<li>[x] Windows unwind info</li>
</ul>
</blockquote>



<a name="203032700"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20Issue%20%231931%20Write%20ELF%20image%20and%20instantiate%20co.../near/203032700" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20Issue.20.231931.20Write.20ELF.20image.20and.20instantiate.20co.2E.2E.2E.html#203032700">(Jul 06 2020 at 19:49)</a>:</h4>
<p>yurydelendik <a href="https://github.com/bytecodealliance/wasmtime/pull/1931#issuecomment-654432484">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/1931">Issue #1931</a>:</p>
<blockquote>
<p>Information related no absolute relocations code discussion:</p>
<p>@sunfishcode @alexcrichton to observe relocations, I'm adding dump of the generated ELF at</p>
<div class="codehilite"><pre><span></span><code>diff --git a/crates/jit/src/compiler.rs b/crates/jit/src/compiler.rs
index 46280c120..96aed7a51 100644
--- a/crates/jit/src/compiler.rs
+++ b/crates/jit/src/compiler.rs
@@ -189,4 +189,7 @@ impl Compiler {
         })?;

+        let mut file = ::std::fs::File::create(::std::path::Path::new(&quot;test.o&quot;)).expect(&quot;file&quot;);
+        ::std::io::Write::write_all(&amp;mut file, &amp;obj).expect(&quot;write&quot;);
+
         Ok(Compilation {
             obj,
</code></pre></div>


<p>I after <code>cargo run -- tests/all/debug/testsuite/reverse-str.wasm &amp;&amp; gobjdump -xD test.o</code> the following can be observed:</p>
<div class="codehilite"><pre><span></span><code>...
    16b:       48 b8 00 00 00 00 00    movabs $0x0,%rax
     172:       00 00 00
                        16d: R_X86_64_64        _wasm_function_0
     175:       49 89 fe                mov    %rdi,%r14
     178:       4c 89 ef                mov    %r13,%rdi
     17b:       4c 89 f6                mov    %r14,%rsi
     17e:       44 89 fa                mov    %r15d,%edx
     181:       40 ff d0                rex callq *%rax
     184:       44 8b bc 24 0c 00 00    mov    0xc(%rsp),%r15d
...
</code></pre></div>


</blockquote>



<a name="203035028"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20Issue%20%231931%20Write%20ELF%20image%20and%20instantiate%20co.../near/203035028" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20Issue.20.231931.20Write.20ELF.20image.20and.20instantiate.20co.2E.2E.2E.html#203035028">(Jul 06 2020 at 20:10)</a>:</h4>
<p>yurydelendik edited a <a href="https://github.com/bytecodealliance/wasmtime/pull/1931#issuecomment-654432484">comment</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/1931">Issue #1931</a>:</p>
<blockquote>
<p>Information related to no absolute relocations code discussion:</p>
<p>@sunfishcode @alexcrichton to observe relocations, I'm adding dump of the generated ELF at</p>
<div class="codehilite"><pre><span></span><code>diff --git a/crates/jit/src/compiler.rs b/crates/jit/src/compiler.rs
index 46280c120..96aed7a51 100644
--- a/crates/jit/src/compiler.rs
+++ b/crates/jit/src/compiler.rs
@@ -189,4 +189,7 @@ impl Compiler {
         })?;

+        let mut file = ::std::fs::File::create(::std::path::Path::new(&quot;test.o&quot;)).expect(&quot;file&quot;);
+        ::std::io::Write::write_all(&amp;mut file, &amp;obj).expect(&quot;write&quot;);
+
         Ok(Compilation {
             obj,
</code></pre></div>


<p>I after <code>cargo run -- tests/all/debug/testsuite/reverse-str.wasm &amp;&amp; gobjdump -xD test.o</code> the following can be observed:</p>
<div class="codehilite"><pre><span></span><code>...
    16b:       48 b8 00 00 00 00 00    movabs $0x0,%rax
     172:       00 00 00
                        16d: R_X86_64_64        _wasm_function_0
     175:       49 89 fe                mov    %rdi,%r14
     178:       4c 89 ef                mov    %r13,%rdi
     17b:       4c 89 f6                mov    %r14,%rsi
     17e:       44 89 fa                mov    %r15d,%edx
     181:       40 ff d0                rex callq *%rax
     184:       44 8b bc 24 0c 00 00    mov    0xc(%rsp),%r15d
...
</code></pre></div>


</blockquote>



<a name="203119916"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20Issue%20%231931%20Write%20ELF%20image%20and%20instantiate%20co.../near/203119916" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20Issue.20.231931.20Write.20ELF.20image.20and.20instantiate.20co.2E.2E.2E.html#203119916">(Jul 07 2020 at 15:43)</a>:</h4>
<p>yurydelendik edited a <a href="https://github.com/bytecodealliance/wasmtime/pull/1931#issuecomment-654432484">comment</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/1931">Issue #1931</a>:</p>
<blockquote>
<p>Information related to no absolute relocations code discussion:</p>
<p>@sunfishcode @alexcrichton to observe relocations, I'm adding dump of the generated ELF at</p>
<div class="codehilite"><pre><span></span><code>diff --git a/crates/jit/src/compiler.rs b/crates/jit/src/compiler.rs
index 46280c120..96aed7a51 100644
--- a/crates/jit/src/compiler.rs
+++ b/crates/jit/src/compiler.rs
@@ -189,4 +189,7 @@ impl Compiler {
         })?;

+        let mut file = ::std::fs::File::create(::std::path::Path::new(&quot;test.o&quot;)).expect(&quot;file&quot;);
+        ::std::io::Write::write_all(&amp;mut file, &amp;obj).expect(&quot;write&quot;);
+
         Ok(Compilation {
             obj,
</code></pre></div>


<p>And after <code>cargo run -- tests/all/debug/testsuite/reverse-str.wasm &amp;&amp; gobjdump -xD test.o</code> the following can be observed:</p>
<div class="codehilite"><pre><span></span><code>...
    16b:       48 b8 00 00 00 00 00    movabs $0x0,%rax
     172:       00 00 00
                        16d: R_X86_64_64        _wasm_function_0
     175:       49 89 fe                mov    %rdi,%r14
     178:       4c 89 ef                mov    %r13,%rdi
     17b:       4c 89 f6                mov    %r14,%rsi
     17e:       44 89 fa                mov    %r15d,%edx
     181:       40 ff d0                rex callq *%rax
     184:       44 8b bc 24 0c 00 00    mov    0xc(%rsp),%r15d
...
</code></pre></div>


</blockquote>



<hr><p>Last updated: Jan 20 2025 at 06:04 UTC</p>
</html>