<html>
<head><meta charset="utf-8"><title>wasmtime / Issue #1407 OOB memory access · git-wasmtime · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/index.html">git-wasmtime</a></h2>
<h3>Topic: <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20Issue.20.231407.20OOB.20memory.20access.html">wasmtime / Issue #1407 OOB memory access</a></h3>

<hr>

<base href="https://bytecodealliance.zulipchat.com">

<head><link href="https://bytecodealliance.github.io/zulip-archive/style.css" rel="stylesheet"></head>

<a name="191814123"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20Issue%20%231407%20OOB%20memory%20access/near/191814123" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20Issue.20.231407.20OOB.20memory.20access.html#191814123">(Mar 25 2020 at 21:36)</a>:</h4>
<p>abrown labeled <a href="https://github.com/bytecodealliance/wasmtime/issues/1407" title="https://github.com/bytecodealliance/wasmtime/issues/1407">Issue #1407</a>:</p>
<blockquote>
<h3>What do you expect to happen? What does actually happen? Does it panic, and if so, with which assertion?</h3>
<p><code>wasmtime</code> traps with an OOB memory access; Node does not. In Node</p>
<div class="codehilite"><pre><span></span>$ node --version
v13.9.0
$ node --experimental-wasm-simd emscripten-built-for-js.js
source: vertex data 32064032 bytes, index data 24000000 bytes
pass 0: vertex data 18518385 bytes, index data 2332680 bytes
decode: vertex 16.32 ms (1.83 GB/sec), index 11.15 ms (2.00 GB/sec)
decode: vertex 16.33 ms (1.83 GB/sec), index 11.15 ms (2.00 GB/sec)
decode: vertex 16.57 ms (1.80 GB/sec), index 11.23 ms (1.99 GB/sec)
decode: vertex 16.19 ms (1.84 GB/sec), index 11.35 ms (1.97 GB/sec)
decode: vertex 16.18 ms (1.85 GB/sec), index 11.16 ms (2.00 GB/sec)
decode: vertex 16.12 ms (1.85 GB/sec), index 11.19 ms (2.00 GB/sec)
decode: vertex 16.19 ms (1.84 GB/sec), index 11.15 ms (2.01 GB/sec)
decode: vertex 16.16 ms (1.85 GB/sec), index 11.14 ms (2.01 GB/sec)
decode: vertex 16.15 ms (1.85 GB/sec), index 11.17 ms (2.00 GB/sec)
decode: vertex 16.17 ms (1.85 GB/sec), index 11.16 ms (2.00 GB/sec)
pass 1: vertex data 18518204 bytes, index data 2001016 bytes
decode: vertex 16.12 ms (1.85 GB/sec), index 11.07 ms (2.02 GB/sec)
decode: vertex 16.17 ms (1.85 GB/sec), index 11.08 ms (2.02 GB/sec)
decode: vertex 16.11 ms (1.85 GB/sec), index 11.11 ms (2.01 GB/sec)
decode: vertex 16.21 ms (1.84 GB/sec), index 11.09 ms (2.02 GB/sec)
decode: vertex 16.17 ms (1.85 GB/sec), index 11.10 ms (2.01 GB/sec)
decode: vertex 16.07 ms (1.86 GB/sec), index 11.13 ms (2.01 GB/sec)
decode: vertex 16.19 ms (1.84 GB/sec), index 11.06 ms (2.02 GB/sec)
decode: vertex 16.17 ms (1.85 GB/sec), index 11.10 ms (2.01 GB/sec)
decode: vertex 16.04 ms (1.86 GB/sec), index 11.14 ms (2.01 GB/sec)
decode: vertex 16.19 ms (1.84 GB/sec), index 11.07 ms (2.02 GB/sec)
filters: oct8 data 4000000 bytes, oct12/quat12 data 8000000 bytes
filter: oct8 2.12 ms (1.76 GB/sec), oct12 2.26 ms (3.29 GB/sec), quat12 2.84 ms (2.63 GB/sec)
filter: oct8 2.11 ms (1.76 GB/sec), oct12 2.19 ms (3.40 GB/sec), quat12 2.79 ms (2.67 GB/sec)
filter: oct8 2.11 ms (1.77 GB/sec), oct12 2.17 ms (3.43 GB/sec), quat12 2.79 ms (2.67 GB/sec)
filter: oct8 2.13 ms (1.75 GB/sec), oct12 2.25 ms (3.32 GB/sec), quat12 2.86 ms (2.61 GB/sec)
filter: oct8 2.10 ms (1.77 GB/sec), oct12 2.17 ms (3.43 GB/sec), quat12 2.80 ms (2.66 GB/sec)
filter: oct8 2.09 ms (1.78 GB/sec), oct12 2.16 ms (3.45 GB/sec), quat12 2.81 ms (2.65 GB/sec)
filter: oct8 2.13 ms (1.75 GB/sec), oct12 2.28 ms (3.26 GB/sec), quat12 2.82 ms (2.64 GB/sec)
filter: oct8 2.23 ms (1.67 GB/sec), oct12 2.16 ms (3.44 GB/sec), quat12 2.81 ms (2.65 GB/sec)
filter: oct8 2.10 ms (1.78 GB/sec), oct12 2.15 ms (3.47 GB/sec), quat12 2.83 ms (2.63 GB/sec)
filter: oct8 2.14 ms (1.74 GB/sec), oct12 2.17 ms (3.44 GB/sec), quat12 2.80 ms (2.66 GB/sec)
</pre></div>


<p>In wasmtime (on branch <a href="https://github.com/abrown/wasmtime/tree/additional-i8x16-shift" title="https://github.com/abrown/wasmtime/tree/additional-i8x16-shift">https://github.com/abrown/wasmtime/tree/additional-i8x16-shift</a> which implements needed instructions). I tried various versions of the same code built with different tools:</p>
<div class="codehilite"><pre><span></span>$ ls ../oob/*.wasm | xargs -I{} sh -c &quot;cargo run -- run --enable-simd --disable-cache {}&quot;


    Finished dev [unoptimized + debuginfo] target(s) in 0.07s
     Running `target/debug/wasmtime run --enable-simd --disable-cache ../oob/emscripten-built-for-js.wasm`
Error: failed to run main module `../oob/emscripten-built-for-js.wasm`

Caused by:
    import module `a` was not found



    Finished dev [unoptimized + debuginfo] target(s) in 0.07s
     Running `target/debug/wasmtime run --enable-simd --disable-cache ../oob/emscripten-built.wasm`
source: vertex data 32064032 bytes, index data 24000000 bytes
pass 0: vertex data 18518385 bytes, index data 2332680 bytes
Error: failed to run main module `../oob/emscripten-built.wasm`

Caused by:
    0: failed to invoke `_start`
    1: wasm trap: out of bounds memory access, source location: @7d97
       wasm backtrace:
         0: &lt;unknown&gt;!&lt;wasm function 74&gt;
         1: &lt;unknown&gt;!&lt;wasm function 37&gt;
         2: &lt;unknown&gt;!&lt;wasm function 75&gt;
         3: &lt;unknown&gt;!&lt;wasm function 28&gt;
         4: &lt;unknown&gt;!&lt;wasm function 67&gt;



    Finished dev [unoptimized + debuginfo] target(s) in 0.07s
     Running `target/debug/wasmtime run --enable-simd --disable-cache ../oob/wasi-sdk-built-extra-memory.wasm`
source: vertex data 32064032 bytes, index data 24000000 bytes
pass 0: vertex data 18518385 bytes, index data 2332680 bytes
Error: failed to run main module `../oob/wasi-sdk-built-extra-memory.wasm`

Caused by:
    0: failed to invoke `_start`
    1: wasm trap: out of bounds memory access, source location: @22a5
       wasm backtrace:
         0: &lt;unknown&gt;!meshopt::decodeVertexBlockSimd(unsigned char const*, unsigned char const*, unsigned char*, unsigned long, unsigned long, unsigned char*)
         1: &lt;unknown&gt;!meshopt_decodeVertexBuffer
         2: &lt;unknown&gt;!benchCodecs(std::__2::vector&lt;Vertex, std::__2::allocator&lt;Vertex&gt; &gt; const&amp;, std::__2::vector&lt;unsigned int, std::__2::allocator&lt;unsigned int&gt; &gt; const&amp;)
         3: &lt;unknown&gt;!__original_main
         4: &lt;unknown&gt;!_start



    Finished dev [unoptimized + debuginfo] target(s) in 0.07s
     Running `target/debug/wasmtime run --enable-simd --disable-cache ../oob/wasi-sdk-built.wasm`
source: vertex data 32064032 bytes, index data 24000000 bytes
pass 0: vertex data 18518385 bytes, index data 2332680 bytes
Error: failed to run main module `../oob/wasi-sdk-built.wasm`

Caused by:
    0: failed to invoke `_start`
    1: wasm trap: out of bounds memory access, source location: @22a4
       wasm backtrace:
         0: &lt;unknown&gt;!meshopt::decodeVertexBlockSimd(unsigned char const*, unsigned char const*, unsigned char*, unsigned long, unsigned long, unsigned char*)
         1: &lt;unknown&gt;!meshopt_decodeVertexBuffer
         2: &lt;unknown&gt;!benchCodecs(std::__2::vector&lt;Vertex, std::__2::allocator&lt;Vertex&gt; &gt; const&amp;, std::__2::vector&lt;unsigned int, std::__2::allocator&lt;unsigned int&gt; &gt; const&amp;)
         3: &lt;unknown&gt;!__original_main
         4: &lt;unknown&gt;!_start
</pre></div>


<h3>Which Wasmtime version / commit hash / branch are you using?</h3>
<p>On branch <a href="https://github.com/abrown/wasmtime/tree/additional-i8x16-shift" title="https://github.com/abrown/wasmtime/tree/additional-i8x16-shift">https://github.com/abrown/wasmtime/tree/additional-i8x16-shift</a> which implements needed instructions.</p>
<h3>What are the steps to reproduce the issue?</h3>
<p>See above. Also, here are steps for building the Wasm modules from <a href="https://github.com/zeux/meshoptimizer/tree/9047ac1936351d0508bb26b5b82ec1101f9735b4" title="https://github.com/zeux/meshoptimizer/tree/9047ac1936351d0508bb26b5b82ec1101f9735b4">https://github.com/zeux/meshoptimizer/tree/9047ac1936351d0508bb26b5b82ec1101f9735b4</a>:</p>
<div class="codehilite"><pre><span></span># wasi-sdi-built.wasm (2^28 bytes of memory, 4096x64K pages)
$ /opt/wasi-sdk/bin/clang++ --version
clang version 11.0.0 (https://github.com/llvm/llvm-project 46bb6613a31fd43b6d4485ce7e71a387dc22cbc7)
Target: wasm32-unknown-wasi
Thread model: posix
InstalledDir: /opt/wasi-sdk/bin
$ make clean &amp;&amp; make codecbench-simd.wasm
/opt/wasi-sdk/bin/clang++ tools/codecbench.cpp src/vertexcodec.cpp src/vertexfilter.cpp src/overdrawanalyzer.cpp src/indexgenerator.cpp src/vcacheoptimizer.cpp src/indexcodec.cpp src/vfetchanalyzer.cpp src/spatialorder.cpp src/clusterizer.cpp src/allocator.cpp src/vcacheanalyzer.cpp src/vfetchoptimizer.cpp src/overdrawoptimizer.cpp src/simplifier.cpp src/stripifier.cpp -O3 -DNDEBUG -fno-exceptions -Wl,--initial-memory=268435456 -msimd128 -o codecbench-simd.wasm

# wasi-sdk-built-extra-memory.wasm (2^30 bytes, 16384x64K pages)
$ make clean &amp;&amp; make codecbench-simd.wasm
/opt/wasi-sdk/bin/clang++ tools/codecbench.cpp src/vertexcodec.cpp src/vertexfilter.cpp src/overdrawanalyzer.cpp src/indexgenerator.cpp src/vcacheoptimizer.cpp src/indexcodec.cpp src/vfetchanalyzer.cpp src/spatialorder.cpp src/clusterizer.cpp src/allocator.cpp src/vcacheanalyzer.cpp src/vfetchoptimizer.cpp src/overdrawoptimizer.cpp src/simplifier.cpp src/stripifier.cpp -O3 -DNDEBUG -fno-exceptions -Wl,--initial-memory=1073741824 -msimd128 -o codecbench-simd.wasm

# emscripten-built.wasm
$ emcc --version
emcc (Emscripten gcc/clang-like replacement) 1.39.10 (commit 1bd7d547598f3fc74699c172f6c9c59a1e8484f1)
$ make clean &amp;&amp; make codecbench-simd.wasm
emcc tools/codecbench.cpp src/vertexcodec.cpp src/vertexfilter.cpp src/overdrawanalyzer.cpp src/indexgenerator.cpp src/vcacheoptimizer.cpp src/indexcodec.cpp src/vfetchanalyzer.cpp src/spatialorder.cpp src/clusterizer.cpp src/allocator.cpp src/vcacheanalyzer.cpp src/vfetchoptimizer.cpp src/overdrawoptimizer.cpp src/simplifier.cpp src/stripifier.cpp -O3 -DNDEBUG -s TOTAL_MEMORY=268435456 -msimd128 -o codecbench-simd.wasm

# then generated wat and dump files with
ls *.wasm | xargs -I{} sh -c &quot;wasm2wat --enable-all {} &gt; {}.wat&quot;
ls *.wasm | xargs -I{} sh -c &quot;wasm-objdump -d {} &gt; {}.dump&quot;
</pre></div>


<p><a href="https://github.com/bytecodealliance/wasmtime/files/4383623/emscripten-built.wasm.txt" title="https://github.com/bytecodealliance/wasmtime/files/4383623/emscripten-built.wasm.txt">emscripten-built.wasm.txt</a><br>
<a href="https://github.com/bytecodealliance/wasmtime/files/4383624/emscripten-built.wasm.wat.txt" title="https://github.com/bytecodealliance/wasmtime/files/4383624/emscripten-built.wasm.wat.txt">emscripten-built.wasm.wat.txt</a><br>
<a href="https://github.com/bytecodealliance/wasmtime/files/4383625/emscripten-built-for-js.js.txt" title="https://github.com/bytecodealliance/wasmtime/files/4383625/emscripten-built-for-js.js.txt">emscripten-built-for-js.js.txt</a><br>
<a href="https://github.com/bytecodealliance/wasmtime/files/4383626/emscripten-built-for-js.wasm.dump.txt" title="https://github.com/bytecodealliance/wasmtime/files/4383626/emscripten-built-for-js.wasm.dump.txt">emscripten-built-for-js.wasm.dump.txt</a><br>
<a href="https://github.com/bytecodealliance/wasmtime/files/4383627/emscripten-built-for-js.wasm.txt" title="https://github.com/bytecodealliance/wasmtime/files/4383627/emscripten-built-for-js.wasm.txt">emscripten-built-for-js.wasm.txt</a><br>
<a href="https://github.com/bytecodealliance/wasmtime/files/4383628/emscripten-built-for-js.wasm.wat.txt" title="https://github.com/bytecodealliance/wasmtime/files/4383628/emscripten-built-for-js.wasm.wat.txt">emscripten-built-for-js.wasm.wat.txt</a><br>
<a href="https://github.com/bytecodealliance/wasmtime/files/4383629/wasi-sdk-built.wasm.dump.txt" title="https://github.com/bytecodealliance/wasmtime/files/4383629/wasi-sdk-built.wasm.dump.txt">wasi-sdk-built.wasm.dump.txt</a><br>
<a href="https://github.com/bytecodealliance/wasmtime/files/4383630/wasi-sdk-built.wasm.txt" title="https://github.com/bytecodealliance/wasmtime/files/4383630/wasi-sdk-built.wasm.txt">wasi-sdk-built.wasm.txt</a><br>
<a href="https://github.com/bytecodealliance/wasmtime/files/4383631/wasi-sdk-built.wasm.wat.txt" title="https://github.com/bytecodealliance/wasmtime/files/4383631/wasi-sdk-built.wasm.wat.txt">wasi-sdk-built.wasm.wat.txt</a><br>
[wasi-sdk-built-extra-memory.wasm.dump.txt](<a href="https://github.com/bytecodealliance/wasmti" title="https://github.com/bytecodealliance/wasmti">https://github.com/bytecodealliance/wasmti</a><br>
[message truncated]</p>
</blockquote>



<a name="191814125"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20Issue%20%231407%20OOB%20memory%20access/near/191814125" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20Issue.20.231407.20OOB.20memory.20access.html#191814125">(Mar 25 2020 at 21:36)</a>:</h4>
<p>abrown opened <a href="https://github.com/bytecodealliance/wasmtime/issues/1407" title="https://github.com/bytecodealliance/wasmtime/issues/1407">Issue #1407</a>:</p>
<blockquote>
<h3>What do you expect to happen? What does actually happen? Does it panic, and if so, with which assertion?</h3>
<p><code>wasmtime</code> traps with an OOB memory access; Node does not. In Node</p>
<div class="codehilite"><pre><span></span>$ node --version
v13.9.0
$ node --experimental-wasm-simd emscripten-built-for-js.js
source: vertex data 32064032 bytes, index data 24000000 bytes
pass 0: vertex data 18518385 bytes, index data 2332680 bytes
decode: vertex 16.32 ms (1.83 GB/sec), index 11.15 ms (2.00 GB/sec)
decode: vertex 16.33 ms (1.83 GB/sec), index 11.15 ms (2.00 GB/sec)
decode: vertex 16.57 ms (1.80 GB/sec), index 11.23 ms (1.99 GB/sec)
decode: vertex 16.19 ms (1.84 GB/sec), index 11.35 ms (1.97 GB/sec)
decode: vertex 16.18 ms (1.85 GB/sec), index 11.16 ms (2.00 GB/sec)
decode: vertex 16.12 ms (1.85 GB/sec), index 11.19 ms (2.00 GB/sec)
decode: vertex 16.19 ms (1.84 GB/sec), index 11.15 ms (2.01 GB/sec)
decode: vertex 16.16 ms (1.85 GB/sec), index 11.14 ms (2.01 GB/sec)
decode: vertex 16.15 ms (1.85 GB/sec), index 11.17 ms (2.00 GB/sec)
decode: vertex 16.17 ms (1.85 GB/sec), index 11.16 ms (2.00 GB/sec)
pass 1: vertex data 18518204 bytes, index data 2001016 bytes
decode: vertex 16.12 ms (1.85 GB/sec), index 11.07 ms (2.02 GB/sec)
decode: vertex 16.17 ms (1.85 GB/sec), index 11.08 ms (2.02 GB/sec)
decode: vertex 16.11 ms (1.85 GB/sec), index 11.11 ms (2.01 GB/sec)
decode: vertex 16.21 ms (1.84 GB/sec), index 11.09 ms (2.02 GB/sec)
decode: vertex 16.17 ms (1.85 GB/sec), index 11.10 ms (2.01 GB/sec)
decode: vertex 16.07 ms (1.86 GB/sec), index 11.13 ms (2.01 GB/sec)
decode: vertex 16.19 ms (1.84 GB/sec), index 11.06 ms (2.02 GB/sec)
decode: vertex 16.17 ms (1.85 GB/sec), index 11.10 ms (2.01 GB/sec)
decode: vertex 16.04 ms (1.86 GB/sec), index 11.14 ms (2.01 GB/sec)
decode: vertex 16.19 ms (1.84 GB/sec), index 11.07 ms (2.02 GB/sec)
filters: oct8 data 4000000 bytes, oct12/quat12 data 8000000 bytes
filter: oct8 2.12 ms (1.76 GB/sec), oct12 2.26 ms (3.29 GB/sec), quat12 2.84 ms (2.63 GB/sec)
filter: oct8 2.11 ms (1.76 GB/sec), oct12 2.19 ms (3.40 GB/sec), quat12 2.79 ms (2.67 GB/sec)
filter: oct8 2.11 ms (1.77 GB/sec), oct12 2.17 ms (3.43 GB/sec), quat12 2.79 ms (2.67 GB/sec)
filter: oct8 2.13 ms (1.75 GB/sec), oct12 2.25 ms (3.32 GB/sec), quat12 2.86 ms (2.61 GB/sec)
filter: oct8 2.10 ms (1.77 GB/sec), oct12 2.17 ms (3.43 GB/sec), quat12 2.80 ms (2.66 GB/sec)
filter: oct8 2.09 ms (1.78 GB/sec), oct12 2.16 ms (3.45 GB/sec), quat12 2.81 ms (2.65 GB/sec)
filter: oct8 2.13 ms (1.75 GB/sec), oct12 2.28 ms (3.26 GB/sec), quat12 2.82 ms (2.64 GB/sec)
filter: oct8 2.23 ms (1.67 GB/sec), oct12 2.16 ms (3.44 GB/sec), quat12 2.81 ms (2.65 GB/sec)
filter: oct8 2.10 ms (1.78 GB/sec), oct12 2.15 ms (3.47 GB/sec), quat12 2.83 ms (2.63 GB/sec)
filter: oct8 2.14 ms (1.74 GB/sec), oct12 2.17 ms (3.44 GB/sec), quat12 2.80 ms (2.66 GB/sec)
</pre></div>


<p>In wasmtime (on branch <a href="https://github.com/abrown/wasmtime/tree/additional-i8x16-shift" title="https://github.com/abrown/wasmtime/tree/additional-i8x16-shift">https://github.com/abrown/wasmtime/tree/additional-i8x16-shift</a> which implements needed instructions). I tried various versions of the same code built with different tools:</p>
<div class="codehilite"><pre><span></span>$ ls ../oob/*.wasm | xargs -I{} sh -c &quot;cargo run -- run --enable-simd --disable-cache {}&quot;


    Finished dev [unoptimized + debuginfo] target(s) in 0.07s
     Running `target/debug/wasmtime run --enable-simd --disable-cache ../oob/emscripten-built-for-js.wasm`
Error: failed to run main module `../oob/emscripten-built-for-js.wasm`

Caused by:
    import module `a` was not found



    Finished dev [unoptimized + debuginfo] target(s) in 0.07s
     Running `target/debug/wasmtime run --enable-simd --disable-cache ../oob/emscripten-built.wasm`
source: vertex data 32064032 bytes, index data 24000000 bytes
pass 0: vertex data 18518385 bytes, index data 2332680 bytes
Error: failed to run main module `../oob/emscripten-built.wasm`

Caused by:
    0: failed to invoke `_start`
    1: wasm trap: out of bounds memory access, source location: @7d97
       wasm backtrace:
         0: &lt;unknown&gt;!&lt;wasm function 74&gt;
         1: &lt;unknown&gt;!&lt;wasm function 37&gt;
         2: &lt;unknown&gt;!&lt;wasm function 75&gt;
         3: &lt;unknown&gt;!&lt;wasm function 28&gt;
         4: &lt;unknown&gt;!&lt;wasm function 67&gt;



    Finished dev [unoptimized + debuginfo] target(s) in 0.07s
     Running `target/debug/wasmtime run --enable-simd --disable-cache ../oob/wasi-sdk-built-extra-memory.wasm`
source: vertex data 32064032 bytes, index data 24000000 bytes
pass 0: vertex data 18518385 bytes, index data 2332680 bytes
Error: failed to run main module `../oob/wasi-sdk-built-extra-memory.wasm`

Caused by:
    0: failed to invoke `_start`
    1: wasm trap: out of bounds memory access, source location: @22a5
       wasm backtrace:
         0: &lt;unknown&gt;!meshopt::decodeVertexBlockSimd(unsigned char const*, unsigned char const*, unsigned char*, unsigned long, unsigned long, unsigned char*)
         1: &lt;unknown&gt;!meshopt_decodeVertexBuffer
         2: &lt;unknown&gt;!benchCodecs(std::__2::vector&lt;Vertex, std::__2::allocator&lt;Vertex&gt; &gt; const&amp;, std::__2::vector&lt;unsigned int, std::__2::allocator&lt;unsigned int&gt; &gt; const&amp;)
         3: &lt;unknown&gt;!__original_main
         4: &lt;unknown&gt;!_start



    Finished dev [unoptimized + debuginfo] target(s) in 0.07s
     Running `target/debug/wasmtime run --enable-simd --disable-cache ../oob/wasi-sdk-built.wasm`
source: vertex data 32064032 bytes, index data 24000000 bytes
pass 0: vertex data 18518385 bytes, index data 2332680 bytes
Error: failed to run main module `../oob/wasi-sdk-built.wasm`

Caused by:
    0: failed to invoke `_start`
    1: wasm trap: out of bounds memory access, source location: @22a4
       wasm backtrace:
         0: &lt;unknown&gt;!meshopt::decodeVertexBlockSimd(unsigned char const*, unsigned char const*, unsigned char*, unsigned long, unsigned long, unsigned char*)
         1: &lt;unknown&gt;!meshopt_decodeVertexBuffer
         2: &lt;unknown&gt;!benchCodecs(std::__2::vector&lt;Vertex, std::__2::allocator&lt;Vertex&gt; &gt; const&amp;, std::__2::vector&lt;unsigned int, std::__2::allocator&lt;unsigned int&gt; &gt; const&amp;)
         3: &lt;unknown&gt;!__original_main
         4: &lt;unknown&gt;!_start
</pre></div>


<h3>Which Wasmtime version / commit hash / branch are you using?</h3>
<p>On branch <a href="https://github.com/abrown/wasmtime/tree/additional-i8x16-shift" title="https://github.com/abrown/wasmtime/tree/additional-i8x16-shift">https://github.com/abrown/wasmtime/tree/additional-i8x16-shift</a> which implements needed instructions.</p>
<h3>What are the steps to reproduce the issue?</h3>
<p>See above. Also, here are steps for building the Wasm modules from <a href="https://github.com/zeux/meshoptimizer/tree/9047ac1936351d0508bb26b5b82ec1101f9735b4" title="https://github.com/zeux/meshoptimizer/tree/9047ac1936351d0508bb26b5b82ec1101f9735b4">https://github.com/zeux/meshoptimizer/tree/9047ac1936351d0508bb26b5b82ec1101f9735b4</a>:</p>
<div class="codehilite"><pre><span></span># wasi-sdi-built.wasm (2^28 bytes of memory, 4096x64K pages)
$ /opt/wasi-sdk/bin/clang++ --version
clang version 11.0.0 (https://github.com/llvm/llvm-project 46bb6613a31fd43b6d4485ce7e71a387dc22cbc7)
Target: wasm32-unknown-wasi
Thread model: posix
InstalledDir: /opt/wasi-sdk/bin
$ make clean &amp;&amp; make codecbench-simd.wasm
/opt/wasi-sdk/bin/clang++ tools/codecbench.cpp src/vertexcodec.cpp src/vertexfilter.cpp src/overdrawanalyzer.cpp src/indexgenerator.cpp src/vcacheoptimizer.cpp src/indexcodec.cpp src/vfetchanalyzer.cpp src/spatialorder.cpp src/clusterizer.cpp src/allocator.cpp src/vcacheanalyzer.cpp src/vfetchoptimizer.cpp src/overdrawoptimizer.cpp src/simplifier.cpp src/stripifier.cpp -O3 -DNDEBUG -fno-exceptions -Wl,--initial-memory=268435456 -msimd128 -o codecbench-simd.wasm

# wasi-sdk-built-extra-memory.wasm (2^30 bytes, 16384x64K pages)
$ make clean &amp;&amp; make codecbench-simd.wasm
/opt/wasi-sdk/bin/clang++ tools/codecbench.cpp src/vertexcodec.cpp src/vertexfilter.cpp src/overdrawanalyzer.cpp src/indexgenerator.cpp src/vcacheoptimizer.cpp src/indexcodec.cpp src/vfetchanalyzer.cpp src/spatialorder.cpp src/clusterizer.cpp src/allocator.cpp src/vcacheanalyzer.cpp src/vfetchoptimizer.cpp src/overdrawoptimizer.cpp src/simplifier.cpp src/stripifier.cpp -O3 -DNDEBUG -fno-exceptions -Wl,--initial-memory=1073741824 -msimd128 -o codecbench-simd.wasm

# emscripten-built.wasm
$ emcc --version
emcc (Emscripten gcc/clang-like replacement) 1.39.10 (commit 1bd7d547598f3fc74699c172f6c9c59a1e8484f1)
$ make clean &amp;&amp; make codecbench-simd.wasm
emcc tools/codecbench.cpp src/vertexcodec.cpp src/vertexfilter.cpp src/overdrawanalyzer.cpp src/indexgenerator.cpp src/vcacheoptimizer.cpp src/indexcodec.cpp src/vfetchanalyzer.cpp src/spatialorder.cpp src/clusterizer.cpp src/allocator.cpp src/vcacheanalyzer.cpp src/vfetchoptimizer.cpp src/overdrawoptimizer.cpp src/simplifier.cpp src/stripifier.cpp -O3 -DNDEBUG -s TOTAL_MEMORY=268435456 -msimd128 -o codecbench-simd.wasm

# then generated wat and dump files with
ls *.wasm | xargs -I{} sh -c &quot;wasm2wat --enable-all {} &gt; {}.wat&quot;
ls *.wasm | xargs -I{} sh -c &quot;wasm-objdump -d {} &gt; {}.dump&quot;
</pre></div>


<p><a href="https://github.com/bytecodealliance/wasmtime/files/4383623/emscripten-built.wasm.txt" title="https://github.com/bytecodealliance/wasmtime/files/4383623/emscripten-built.wasm.txt">emscripten-built.wasm.txt</a><br>
<a href="https://github.com/bytecodealliance/wasmtime/files/4383624/emscripten-built.wasm.wat.txt" title="https://github.com/bytecodealliance/wasmtime/files/4383624/emscripten-built.wasm.wat.txt">emscripten-built.wasm.wat.txt</a><br>
<a href="https://github.com/bytecodealliance/wasmtime/files/4383625/emscripten-built-for-js.js.txt" title="https://github.com/bytecodealliance/wasmtime/files/4383625/emscripten-built-for-js.js.txt">emscripten-built-for-js.js.txt</a><br>
<a href="https://github.com/bytecodealliance/wasmtime/files/4383626/emscripten-built-for-js.wasm.dump.txt" title="https://github.com/bytecodealliance/wasmtime/files/4383626/emscripten-built-for-js.wasm.dump.txt">emscripten-built-for-js.wasm.dump.txt</a><br>
<a href="https://github.com/bytecodealliance/wasmtime/files/4383627/emscripten-built-for-js.wasm.txt" title="https://github.com/bytecodealliance/wasmtime/files/4383627/emscripten-built-for-js.wasm.txt">emscripten-built-for-js.wasm.txt</a><br>
<a href="https://github.com/bytecodealliance/wasmtime/files/4383628/emscripten-built-for-js.wasm.wat.txt" title="https://github.com/bytecodealliance/wasmtime/files/4383628/emscripten-built-for-js.wasm.wat.txt">emscripten-built-for-js.wasm.wat.txt</a><br>
<a href="https://github.com/bytecodealliance/wasmtime/files/4383629/wasi-sdk-built.wasm.dump.txt" title="https://github.com/bytecodealliance/wasmtime/files/4383629/wasi-sdk-built.wasm.dump.txt">wasi-sdk-built.wasm.dump.txt</a><br>
<a href="https://github.com/bytecodealliance/wasmtime/files/4383630/wasi-sdk-built.wasm.txt" title="https://github.com/bytecodealliance/wasmtime/files/4383630/wasi-sdk-built.wasm.txt">wasi-sdk-built.wasm.txt</a><br>
<a href="https://github.com/bytecodealliance/wasmtime/files/4383631/wasi-sdk-built.wasm.wat.txt" title="https://github.com/bytecodealliance/wasmtime/files/4383631/wasi-sdk-built.wasm.wat.txt">wasi-sdk-built.wasm.wat.txt</a><br>
[wasi-sdk-built-extra-memory.wasm.dump.txt](<a href="https://github.com/bytecodealliance/wasmtim" title="https://github.com/bytecodealliance/wasmtim">https://github.com/bytecodealliance/wasmtim</a><br>
[message truncated]</p>
</blockquote>



<a name="191814408"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20Issue%20%231407%20OOB%20memory%20access/near/191814408" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20Issue.20.231407.20OOB.20memory.20access.html#191814408">(Mar 25 2020 at 21:39)</a>:</h4>
<p>abrown <a href="https://github.com/bytecodealliance/wasmtime/issues/1407#issuecomment-604101859" title="https://github.com/bytecodealliance/wasmtime/issues/1407#issuecomment-604101859">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/1407" title="https://github.com/bytecodealliance/wasmtime/issues/1407">Issue #1407</a>:</p>
<blockquote>
<p>It is interesting that the OOB is triggered in different places:</p>
<div class="codehilite"><pre><span></span>$ wasm-objdump -d emscripten-built.wasm | grep -A5 -B5 7d97
 007d8a: 0e 03 01 02 03 00          |                       br_table 1 2 3 0
 007d90: 0b                         |                     end
 007d91: 20 07                      |                     local.get 7
 007d93: 41 00                      |                     i32.const 0
 007d95: fd 0c                      |                     i32x4.splat
&gt;007d97: fd 01 04 10                |                     v128.store 4 16
 007d9b: 0c 03                      |                     br 3
 007d9d: 0b                         |                   end
 007d9e: 20 07                      |                   local.get 7
 007da0: 20 00                      |                   local.get 0
 007da2: fd 00 00 04                |                   v128.load 0 4
abrown@abrown-desk:~/Code/oob$ wasm-objdump -d wasi-sdk-built.wasm | grep -A5 -B5 22a4
 002297: fd 06 00                   |                     i8x16.extract_lane_u 0
 00229a: 6a                         |                     i32.add
 00229b: 20 17                      |                     local.get 23
 00229d: 41 f0 b0 80 80 00          |                     i32.const 6256
 0022a3: 6a                         |                     i32.add
&gt;0022a4: 2d 00 00                   |                     i32.load8_u 0 0
 0022a7: 6a                         |                     i32.add
 0022a8: 21 00                      |                     local.set 0
 0022aa: 0c 02                      |                     br 2
 0022ac: 0b                         |                   end
 0022ad: 20 0f                      |                   local.get 15
</pre></div>


</blockquote>



<a name="191814448"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20Issue%20%231407%20OOB%20memory%20access/near/191814448" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20Issue.20.231407.20OOB.20memory.20access.html#191814448">(Mar 25 2020 at 21:39)</a>:</h4>
<p>abrown edited a <a href="https://github.com/bytecodealliance/wasmtime/issues/1407#issuecomment-604101859" title="https://github.com/bytecodealliance/wasmtime/issues/1407#issuecomment-604101859">comment</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/1407" title="https://github.com/bytecodealliance/wasmtime/issues/1407">Issue #1407</a>:</p>
<blockquote>
<p>It is interesting that the OOB is triggered in different places:</p>
<div class="codehilite"><pre><span></span>$ wasm-objdump -d emscripten-built.wasm | grep -A5 -B5 7d97
 007d8a: 0e 03 01 02 03 00          |                       br_table 1 2 3 0
 007d90: 0b                         |                     end
 007d91: 20 07                      |                     local.get 7
 007d93: 41 00                      |                     i32.const 0
 007d95: fd 0c                      |                     i32x4.splat
&gt;007d97: fd 01 04 10                |                     v128.store 4 16
 007d9b: 0c 03                      |                     br 3
 007d9d: 0b                         |                   end
 007d9e: 20 07                      |                   local.get 7
 007da0: 20 00                      |                   local.get 0
 007da2: fd 00 00 04                |                   v128.load 0 4
$ wasm-objdump -d wasi-sdk-built.wasm | grep -A5 -B5 22a4
 002297: fd 06 00                   |                     i8x16.extract_lane_u 0
 00229a: 6a                         |                     i32.add
 00229b: 20 17                      |                     local.get 23
 00229d: 41 f0 b0 80 80 00          |                     i32.const 6256
 0022a3: 6a                         |                     i32.add
&gt;0022a4: 2d 00 00                   |                     i32.load8_u 0 0
 0022a7: 6a                         |                     i32.add
 0022a8: 21 00                      |                     local.set 0
 0022aa: 0c 02                      |                     br 2
 0022ac: 0b                         |                   end
 0022ad: 20 0f                      |                   local.get 15
</pre></div>


</blockquote>



<a name="191814627"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20Issue%20%231407%20OOB%20memory%20access/near/191814627" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20Issue.20.231407.20OOB.20memory.20access.html#191814627">(Mar 25 2020 at 21:41)</a>:</h4>
<p>abrown edited <a href="https://github.com/bytecodealliance/wasmtime/issues/1407" title="https://github.com/bytecodealliance/wasmtime/issues/1407">Issue #1407</a>:</p>
<blockquote>
<h3>What do you expect to happen? What does actually happen? Does it panic, and if so, with which assertion?</h3>
<p><code>wasmtime</code> traps with an OOB memory access; Node does not. </p>
<p>In Node the code runs as expected (though we have to run it from the JS wrapper):</p>
<div class="codehilite"><pre><span></span>$ node --version
v13.9.0
$ node --experimental-wasm-simd emscripten-built-for-js.js
source: vertex data 32064032 bytes, index data 24000000 bytes
pass 0: vertex data 18518385 bytes, index data 2332680 bytes
decode: vertex 16.32 ms (1.83 GB/sec), index 11.15 ms (2.00 GB/sec)
decode: vertex 16.33 ms (1.83 GB/sec), index 11.15 ms (2.00 GB/sec)
decode: vertex 16.57 ms (1.80 GB/sec), index 11.23 ms (1.99 GB/sec)
decode: vertex 16.19 ms (1.84 GB/sec), index 11.35 ms (1.97 GB/sec)
decode: vertex 16.18 ms (1.85 GB/sec), index 11.16 ms (2.00 GB/sec)
decode: vertex 16.12 ms (1.85 GB/sec), index 11.19 ms (2.00 GB/sec)
decode: vertex 16.19 ms (1.84 GB/sec), index 11.15 ms (2.01 GB/sec)
decode: vertex 16.16 ms (1.85 GB/sec), index 11.14 ms (2.01 GB/sec)
decode: vertex 16.15 ms (1.85 GB/sec), index 11.17 ms (2.00 GB/sec)
decode: vertex 16.17 ms (1.85 GB/sec), index 11.16 ms (2.00 GB/sec)
pass 1: vertex data 18518204 bytes, index data 2001016 bytes
decode: vertex 16.12 ms (1.85 GB/sec), index 11.07 ms (2.02 GB/sec)
decode: vertex 16.17 ms (1.85 GB/sec), index 11.08 ms (2.02 GB/sec)
decode: vertex 16.11 ms (1.85 GB/sec), index 11.11 ms (2.01 GB/sec)
decode: vertex 16.21 ms (1.84 GB/sec), index 11.09 ms (2.02 GB/sec)
decode: vertex 16.17 ms (1.85 GB/sec), index 11.10 ms (2.01 GB/sec)
decode: vertex 16.07 ms (1.86 GB/sec), index 11.13 ms (2.01 GB/sec)
decode: vertex 16.19 ms (1.84 GB/sec), index 11.06 ms (2.02 GB/sec)
decode: vertex 16.17 ms (1.85 GB/sec), index 11.10 ms (2.01 GB/sec)
decode: vertex 16.04 ms (1.86 GB/sec), index 11.14 ms (2.01 GB/sec)
decode: vertex 16.19 ms (1.84 GB/sec), index 11.07 ms (2.02 GB/sec)
filters: oct8 data 4000000 bytes, oct12/quat12 data 8000000 bytes
filter: oct8 2.12 ms (1.76 GB/sec), oct12 2.26 ms (3.29 GB/sec), quat12 2.84 ms (2.63 GB/sec)
filter: oct8 2.11 ms (1.76 GB/sec), oct12 2.19 ms (3.40 GB/sec), quat12 2.79 ms (2.67 GB/sec)
filter: oct8 2.11 ms (1.77 GB/sec), oct12 2.17 ms (3.43 GB/sec), quat12 2.79 ms (2.67 GB/sec)
filter: oct8 2.13 ms (1.75 GB/sec), oct12 2.25 ms (3.32 GB/sec), quat12 2.86 ms (2.61 GB/sec)
filter: oct8 2.10 ms (1.77 GB/sec), oct12 2.17 ms (3.43 GB/sec), quat12 2.80 ms (2.66 GB/sec)
filter: oct8 2.09 ms (1.78 GB/sec), oct12 2.16 ms (3.45 GB/sec), quat12 2.81 ms (2.65 GB/sec)
filter: oct8 2.13 ms (1.75 GB/sec), oct12 2.28 ms (3.26 GB/sec), quat12 2.82 ms (2.64 GB/sec)
filter: oct8 2.23 ms (1.67 GB/sec), oct12 2.16 ms (3.44 GB/sec), quat12 2.81 ms (2.65 GB/sec)
filter: oct8 2.10 ms (1.78 GB/sec), oct12 2.15 ms (3.47 GB/sec), quat12 2.83 ms (2.63 GB/sec)
filter: oct8 2.14 ms (1.74 GB/sec), oct12 2.17 ms (3.44 GB/sec), quat12 2.80 ms (2.66 GB/sec)
</pre></div>


<p>In wasmtime (on branch <a href="https://github.com/abrown/wasmtime/tree/additional-i8x16-shift" title="https://github.com/abrown/wasmtime/tree/additional-i8x16-shift">https://github.com/abrown/wasmtime/tree/additional-i8x16-shift</a> which implements needed instructions). I tried various versions of the same code built with different tools:</p>
<div class="codehilite"><pre><span></span>$ ls ../oob/*.wasm | xargs -I{} sh -c &quot;cargo run -- run --enable-simd --disable-cache {}&quot;


    Finished dev [unoptimized + debuginfo] target(s) in 0.07s
     Running `target/debug/wasmtime run --enable-simd --disable-cache ../oob/emscripten-built-for-js.wasm`
Error: failed to run main module `../oob/emscripten-built-for-js.wasm`

Caused by:
    import module `a` was not found



    Finished dev [unoptimized + debuginfo] target(s) in 0.07s
     Running `target/debug/wasmtime run --enable-simd --disable-cache ../oob/emscripten-built.wasm`
source: vertex data 32064032 bytes, index data 24000000 bytes
pass 0: vertex data 18518385 bytes, index data 2332680 bytes
Error: failed to run main module `../oob/emscripten-built.wasm`

Caused by:
    0: failed to invoke `_start`
    1: wasm trap: out of bounds memory access, source location: @7d97
       wasm backtrace:
         0: &lt;unknown&gt;!&lt;wasm function 74&gt;
         1: &lt;unknown&gt;!&lt;wasm function 37&gt;
         2: &lt;unknown&gt;!&lt;wasm function 75&gt;
         3: &lt;unknown&gt;!&lt;wasm function 28&gt;
         4: &lt;unknown&gt;!&lt;wasm function 67&gt;



    Finished dev [unoptimized + debuginfo] target(s) in 0.07s
     Running `target/debug/wasmtime run --enable-simd --disable-cache ../oob/wasi-sdk-built-extra-memory.wasm`
source: vertex data 32064032 bytes, index data 24000000 bytes
pass 0: vertex data 18518385 bytes, index data 2332680 bytes
Error: failed to run main module `../oob/wasi-sdk-built-extra-memory.wasm`

Caused by:
    0: failed to invoke `_start`
    1: wasm trap: out of bounds memory access, source location: @22a5
       wasm backtrace:
         0: &lt;unknown&gt;!meshopt::decodeVertexBlockSimd(unsigned char const*, unsigned char const*, unsigned char*, unsigned long, unsigned long, unsigned char*)
         1: &lt;unknown&gt;!meshopt_decodeVertexBuffer
         2: &lt;unknown&gt;!benchCodecs(std::__2::vector&lt;Vertex, std::__2::allocator&lt;Vertex&gt; &gt; const&amp;, std::__2::vector&lt;unsigned int, std::__2::allocator&lt;unsigned int&gt; &gt; const&amp;)
         3: &lt;unknown&gt;!__original_main
         4: &lt;unknown&gt;!_start



    Finished dev [unoptimized + debuginfo] target(s) in 0.07s
     Running `target/debug/wasmtime run --enable-simd --disable-cache ../oob/wasi-sdk-built.wasm`
source: vertex data 32064032 bytes, index data 24000000 bytes
pass 0: vertex data 18518385 bytes, index data 2332680 bytes
Error: failed to run main module `../oob/wasi-sdk-built.wasm`

Caused by:
    0: failed to invoke `_start`
    1: wasm trap: out of bounds memory access, source location: @22a4
       wasm backtrace:
         0: &lt;unknown&gt;!meshopt::decodeVertexBlockSimd(unsigned char const*, unsigned char const*, unsigned char*, unsigned long, unsigned long, unsigned char*)
         1: &lt;unknown&gt;!meshopt_decodeVertexBuffer
         2: &lt;unknown&gt;!benchCodecs(std::__2::vector&lt;Vertex, std::__2::allocator&lt;Vertex&gt; &gt; const&amp;, std::__2::vector&lt;unsigned int, std::__2::allocator&lt;unsigned int&gt; &gt; const&amp;)
         3: &lt;unknown&gt;!__original_main
         4: &lt;unknown&gt;!_start
</pre></div>


<h3>Which Wasmtime version / commit hash / branch are you using?</h3>
<p>On branch <a href="https://github.com/abrown/wasmtime/tree/additional-i8x16-shift" title="https://github.com/abrown/wasmtime/tree/additional-i8x16-shift">https://github.com/abrown/wasmtime/tree/additional-i8x16-shift</a> which implements needed instructions.</p>
<h3>What are the steps to reproduce the issue?</h3>
<p>See above. Also, here are steps for building the Wasm modules from <a href="https://github.com/zeux/meshoptimizer/tree/9047ac1936351d0508bb26b5b82ec1101f9735b4" title="https://github.com/zeux/meshoptimizer/tree/9047ac1936351d0508bb26b5b82ec1101f9735b4">https://github.com/zeux/meshoptimizer/tree/9047ac1936351d0508bb26b5b82ec1101f9735b4</a>:</p>
<div class="codehilite"><pre><span></span># wasi-sdi-built.wasm (2^28 bytes of memory, 4096x64K pages)
$ /opt/wasi-sdk/bin/clang++ --version
clang version 11.0.0 (https://github.com/llvm/llvm-project 46bb6613a31fd43b6d4485ce7e71a387dc22cbc7)
Target: wasm32-unknown-wasi
Thread model: posix
InstalledDir: /opt/wasi-sdk/bin
$ make clean &amp;&amp; make codecbench-simd.wasm
/opt/wasi-sdk/bin/clang++ tools/codecbench.cpp src/vertexcodec.cpp src/vertexfilter.cpp src/overdrawanalyzer.cpp src/indexgenerator.cpp src/vcacheoptimizer.cpp src/indexcodec.cpp src/vfetchanalyzer.cpp src/spatialorder.cpp src/clusterizer.cpp src/allocator.cpp src/vcacheanalyzer.cpp src/vfetchoptimizer.cpp src/overdrawoptimizer.cpp src/simplifier.cpp src/stripifier.cpp -O3 -DNDEBUG -fno-exceptions -Wl,--initial-memory=268435456 -msimd128 -o codecbench-simd.wasm

# wasi-sdk-built-extra-memory.wasm (2^30 bytes, 16384x64K pages)
$ make clean &amp;&amp; make codecbench-simd.wasm
/opt/wasi-sdk/bin/clang++ tools/codecbench.cpp src/vertexcodec.cpp src/vertexfilter.cpp src/overdrawanalyzer.cpp src/indexgenerator.cpp src/vcacheoptimizer.cpp src/indexcodec.cpp src/vfetchanalyzer.cpp src/spatialorder.cpp src/clusterizer.cpp src/allocator.cpp src/vcacheanalyzer.cpp src/vfetchoptimizer.cpp src/overdrawoptimizer.cpp src/simplifier.cpp src/stripifier.cpp -O3 -DNDEBUG -fno-exceptions -Wl,--initial-memory=1073741824 -msimd128 -o codecbench-simd.wasm

# emscripten-built.wasm
$ emcc --version
emcc (Emscripten gcc/clang-like replacement) 1.39.10 (commit 1bd7d547598f3fc74699c172f6c9c59a1e8484f1)
$ make clean &amp;&amp; make codecbench-simd.wasm
emcc tools/codecbench.cpp src/vertexcodec.cpp src/vertexfilter.cpp src/overdrawanalyzer.cpp src/indexgenerator.cpp src/vcacheoptimizer.cpp src/indexcodec.cpp src/vfetchanalyzer.cpp src/spatialorder.cpp src/clusterizer.cpp src/allocator.cpp src/vcacheanalyzer.cpp src/vfetchoptimizer.cpp src/overdrawoptimizer.cpp src/simplifier.cpp src/stripifier.cpp -O3 -DNDEBUG -s TOTAL_MEMORY=268435456 -msimd128 -o codecbench-simd.wasm

# then generated wat and dump files with
ls *.wasm | xargs -I{} sh -c &quot;wasm2wat --enable-all {} &gt; {}.wat&quot;
ls *.wasm | xargs -I{} sh -c &quot;wasm-objdump -d {} &gt; {}.dump&quot;
</pre></div>


<p><a href="https://github.com/bytecodealliance/wasmtime/files/4383623/emscripten-built.wasm.txt" title="https://github.com/bytecodealliance/wasmtime/files/4383623/emscripten-built.wasm.txt">emscripten-built.wasm.txt</a><br>
<a href="https://github.com/bytecodealliance/wasmtime/files/4383624/emscripten-built.wasm.wat.txt" title="https://github.com/bytecodealliance/wasmtime/files/4383624/emscripten-built.wasm.wat.txt">emscripten-built.wasm.wat.txt</a><br>
<a href="https://github.com/bytecodealliance/wasmtime/files/4383625/emscripten-built-for-js.js.txt" title="https://github.com/bytecodealliance/wasmtime/files/4383625/emscripten-built-for-js.js.txt">emscripten-built-for-js.js.txt</a><br>
<a href="https://github.com/bytecodealliance/wasmtime/files/4383626/emscripten-built-for-js.wasm.dump.txt" title="https://github.com/bytecodealliance/wasmtime/files/4383626/emscripten-built-for-js.wasm.dump.txt">emscripten-built-for-js.wasm.dump.txt</a><br>
<a href="https://github.com/bytecodealliance/wasmtime/files/4383627/emscripten-built-for-js.wasm.txt" title="https://github.com/bytecodealliance/wasmtime/files/4383627/emscripten-built-for-js.wasm.txt">emscripten-built-for-js.wasm.txt</a><br>
<a href="https://github.com/bytecodealliance/wasmtime/files/4383628/emscripten-built-for-js.wasm.wat.txt" title="https://github.com/bytecodealliance/wasmtime/files/4383628/emscripten-built-for-js.wasm.wat.txt">emscripten-built-for-js.wasm.wat.txt</a><br>
<a href="https://github.com/bytecodealliance/wasmtime/files/4383629/wasi-sdk-built.wasm.dump.txt" title="https://github.com/bytecodealliance/wasmtime/files/4383629/wasi-sdk-built.wasm.dump.txt">wasi-sdk-built.wasm.dump.txt</a><br>
<a href="https://github.com/bytecodealliance/wasmtime/files/4383630/wasi-sdk-built.wasm.txt" title="https://github.com/bytecodealliance/wasmtime/files/4383630/wasi-sdk-built.wasm.txt">wasi-sdk-built.wasm.txt</a><br>
<a href="https://github.com/bytecodealliance/wasmtime/files/4383631/wasi-sdk-built.wasm.wat.txt" title="https://github.com/bytecodealliance/wasmtime/files/4383631/wasi-sdk-built.wasm.wat.txt">wasi-sdk-built.wasm.wat.txt</a><br>
[wasi-sdk-b<br>
[message truncated]</p>
</blockquote>



<a name="191815657"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20Issue%20%231407%20OOB%20memory%20access/near/191815657" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20Issue.20.231407.20OOB.20memory.20access.html#191815657">(Mar 25 2020 at 21:53)</a>:</h4>
<p>alexcrichton <a href="https://github.com/bytecodealliance/wasmtime/issues/1407#issuecomment-604107317" title="https://github.com/bytecodealliance/wasmtime/issues/1407#issuecomment-604107317">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/1407" title="https://github.com/bytecodealliance/wasmtime/issues/1407">Issue #1407</a>:</p>
<blockquote>
<p>Are the wasm files emitted here intended to be run directly? I would imagine that the JS does some sort of setup/glue which might prepare the runtime and/or size memory appropriately. Without that it might be expected that the wasm faults if run directly? (mostly in that node is running more code than we are, so a difference in behavior may not mean something wrong is happening)</p>
</blockquote>



<a name="191817098"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20Issue%20%231407%20OOB%20memory%20access/near/191817098" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20Issue.20.231407.20OOB.20memory.20access.html#191817098">(Mar 25 2020 at 22:08)</a>:</h4>
<p>abrown <a href="https://github.com/bytecodealliance/wasmtime/issues/1407#issuecomment-604113060" title="https://github.com/bytecodealliance/wasmtime/issues/1407#issuecomment-604113060">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/1407" title="https://github.com/bytecodealliance/wasmtime/issues/1407">Issue #1407</a>:</p>
<blockquote>
<p>Perhaps there is some Emscripten/Node-specific setup that I'm not aware of (@zeux, what do you think?). In the minified JS I do see code like <code>var DYNAMIC_BASE=5249984,DYNAMICTOP_PTR=6944</code> that might be doing something special. But I wouldn't think that the wasi-sdk-built Wasm code should need any of that setup: the files compiled are normal-looking C++.</p>
</blockquote>



<a name="191817519"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20Issue%20%231407%20OOB%20memory%20access/near/191817519" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20Issue.20.231407.20OOB.20memory.20access.html#191817519">(Mar 25 2020 at 22:13)</a>:</h4>
<p>abrown <a href="https://github.com/bytecodealliance/wasmtime/issues/1407#issuecomment-604114920" title="https://github.com/bytecodealliance/wasmtime/issues/1407#issuecomment-604114920">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/1407" title="https://github.com/bytecodealliance/wasmtime/issues/1407">Issue #1407</a>:</p>
<blockquote>
<p>In answer to,</p>
<blockquote>
<p>Are the wasm files emitted here intended to be run directly?</p>
</blockquote>
<p>I think, yes, the files that are not <code>*-for-js</code> should be runnable directly. Or at least looking at the <code>*.wat</code> versions I do not see why not.</p>
</blockquote>



<a name="192741003"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20Issue%20%231407%20OOB%20memory%20access/near/192741003" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20Issue.20.231407.20OOB.20memory.20access.html#192741003">(Apr 02 2020 at 23:28)</a>:</h4>
<p>zeux <a href="https://github.com/bytecodealliance/wasmtime/issues/1407#issuecomment-608145018" title="https://github.com/bytecodealliance/wasmtime/issues/1407#issuecomment-608145018">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/1407" title="https://github.com/bytecodealliance/wasmtime/issues/1407">Issue #1407</a>:</p>
<blockquote>
<p>I'm wondering if wasmtime is hitting one of the cases where the code might actually hit an OOB access in practice. There's a couple of TODO comments in the code around this, where the right thing to do is to use a load_splat, but load_splat isn't available in node/Chrome so I'm not using it...</p>
<p>Let me look closer at what these accesses are actually doing.</p>
</blockquote>



<a name="192743307"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20Issue%20%231407%20OOB%20memory%20access/near/192743307" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20Issue.20.231407.20OOB.20memory.20access.html#192743307">(Apr 02 2020 at 23:59)</a>:</h4>
<p>abrown <a href="https://github.com/bytecodealliance/wasmtime/issues/1407#issuecomment-608154670" title="https://github.com/bytecodealliance/wasmtime/issues/1407#issuecomment-608154670">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/1407" title="https://github.com/bytecodealliance/wasmtime/issues/1407">Issue #1407</a>:</p>
<blockquote>
<p>This shouldn't theoretically be an issue but Cranelift is lowering <code>load_splat</code> to <code>load + splat</code> at the moment (eventually optimized by #1175)... in case that matters.</p>
</blockquote>



<a name="192748495"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20Issue%20%231407%20OOB%20memory%20access/near/192748495" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20Issue.20.231407.20OOB.20memory.20access.html#192748495">(Apr 03 2020 at 01:16)</a>:</h4>
<p>zeux <a href="https://github.com/bytecodealliance/wasmtime/issues/1407#issuecomment-608176279" title="https://github.com/bytecodealliance/wasmtime/issues/1407#issuecomment-608176279">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/1407" title="https://github.com/bytecodealliance/wasmtime/issues/1407">Issue #1407</a>:</p>
<blockquote>
<p>I tried to reproduce this but (maybe because I'm using a later version of Emscripten) I'm hitting this:</p>
<div class="codehilite"><pre><span></span>Error: failed to run main module `codecbench-simd.wasm`

Caused by:
    0: WebAssembly failed to compile
    1: Compilation error: function u0:73(i64 vmctx, i64, i32, i32, i32, i32, i32) -&gt; i32 system_v {
...
       @7bf3                               v154 = iadd v152, v153
       ;~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
       ; error: inst149 (v154 = iadd.i32 v152, v153): arg 1 (v153) has type i8, expected i32
</pre></div>


<p>wasm-validate doesn't agree with this assessment but maybe it's because it doesn't validate something properly? Attaching the .wasm file in question.</p>
<p><a href="https://github.com/bytecodealliance/wasmtime/files/4424539/codecbench-simd.zip" title="https://github.com/bytecodealliance/wasmtime/files/4424539/codecbench-simd.zip">codecbench-simd.zip</a></p>
</blockquote>



<a name="192771839"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20Issue%20%231407%20OOB%20memory%20access/near/192771839" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20Issue.20.231407.20OOB.20memory.20access.html#192771839">(Apr 03 2020 at 08:33)</a>:</h4>
<p>bjorn3 <a href="https://github.com/bytecodealliance/wasmtime/issues/1407#issuecomment-608305629" title="https://github.com/bytecodealliance/wasmtime/issues/1407#issuecomment-608305629">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/1407" title="https://github.com/bytecodealliance/wasmtime/issues/1407">Issue #1407</a>:</p>
<blockquote>
<p>Where is v153 defined?</p>
</blockquote>



<a name="192812497"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20Issue%20%231407%20OOB%20memory%20access/near/192812497" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20Issue.20.231407.20OOB.20memory.20access.html#192812497">(Apr 03 2020 at 14:34)</a>:</h4>
<p>zeux <a href="https://github.com/bytecodealliance/wasmtime/issues/1407#issuecomment-608467646" title="https://github.com/bytecodealliance/wasmtime/issues/1407#issuecomment-608467646">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/1407" title="https://github.com/bytecodealliance/wasmtime/issues/1407">Issue #1407</a>:</p>
<blockquote>
<p><a href="https://github.com/bytecodealliance/wasmtime/files/4427915/codecbench-simd.txt" title="https://github.com/bytecodealliance/wasmtime/files/4427915/codecbench-simd.txt">codecbench-simd.txt</a></p>
</blockquote>



<a name="192844787"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20Issue%20%231407%20OOB%20memory%20access/near/192844787" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20Issue.20.231407.20OOB.20memory.20access.html#192844787">(Apr 03 2020 at 18:19)</a>:</h4>
<p>abrown <a href="https://github.com/bytecodealliance/wasmtime/issues/1407#issuecomment-608589666" title="https://github.com/bytecodealliance/wasmtime/issues/1407#issuecomment-608589666">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/1407" title="https://github.com/bytecodealliance/wasmtime/issues/1407">Issue #1407</a>:</p>
<blockquote>
<p>@zeux, I was in a special branch that has some fixes and additional instructions that make it possible to get past those types of errors:  <a href="https://github.com/abrown/wasmtime/tree/additional-i8x16-shift" title="https://github.com/abrown/wasmtime/tree/additional-i8x16-shift">https://github.com/abrown/wasmtime/tree/additional-i8x16-shift</a>. I'm waiting on a review for #1377 and then I can try to merge #1409; then all of that functionality should be in master.</p>
</blockquote>



<a name="192846485"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20Issue%20%231407%20OOB%20memory%20access/near/192846485" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20Issue.20.231407.20OOB.20memory.20access.html#192846485">(Apr 03 2020 at 18:33)</a>:</h4>
<p>zeux <a href="https://github.com/bytecodealliance/wasmtime/issues/1407#issuecomment-608595508" title="https://github.com/bytecodealliance/wasmtime/issues/1407#issuecomment-608595508">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/1407" title="https://github.com/bytecodealliance/wasmtime/issues/1407">Issue #1407</a>:</p>
<blockquote>
<p>@abrown Ahh, git :( I did check out that branch initially but had issues with the submodule links, and forgot to switch back to it after re-cloning it recursively. After syncing to this branch properly I can indeed reproduce the error, thanks! Will update once I understand this more.</p>
</blockquote>



<a name="192855128"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20Issue%20%231407%20OOB%20memory%20access/near/192855128" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20Issue.20.231407.20OOB.20memory.20access.html#192855128">(Apr 03 2020 at 19:46)</a>:</h4>
<p>zeux <a href="https://github.com/bytecodealliance/wasmtime/issues/1407#issuecomment-608626236" title="https://github.com/bytecodealliance/wasmtime/issues/1407#issuecomment-608626236">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/1407" title="https://github.com/bytecodealliance/wasmtime/issues/1407">Issue #1407</a>:</p>
<blockquote>
<p>I strongly suspect this isn't an issue in the benchmark; the behavior seems highly dependent on the inlining here. Adding <code>noinline</code> to decodeBytesGroupSimd &amp; decodeBytesSimd &amp; decodeVertexBlockSimd fixes this. With only decodeBytesSimd marked as noinline, I get this instead:</p>
<div class="codehilite"><pre><span></span>/mnt/c/work/meshoptimizer $ make -B codecbench-simd.wasm &amp;&amp; ../wasmtime/target/debug/wasmtime --enable-simd codecbench-simd.wasm
emcc tools/codecbench.cpp src/vertexcodec.cpp src/vertexfilter.cpp src/overdrawanalyzer.cpp src/indexgenerator.cpp src/vcacheoptimizer.cpp src/clusterizer.cpp src/indexcodec.cpp src/vfetchanalyzer.cpp src/spatialorder.cpp src/allocator.cpp src/vcacheanalyzer.cpp src/vfetchoptimizer.cpp src/overdrawoptimizer.c
pp src/simplifier.cpp src/stripifier.cpp -O3 -DNDEBUG -s TOTAL_MEMORY=268435456 -msimd128 -o codecbench-simd.wasm -g
source: vertex data 32064032 bytes, index data 24000000 bytes
pass 0: vertex data 18518385 bytes, index data 2332680 bytes
Error: failed to run main module `codecbench-simd.wasm`

Caused by:
    0: failed to invoke `_start`
    1: wasm trap: call stack exhausted, source location: @-
       wasm backtrace:
         0: &lt;unknown&gt;!meshopt::decodeBytesSimd(unsigned char const*, unsigned char const*, unsigned char*, unsigned long)
         1: &lt;unknown&gt;!meshopt::decodeVertexBlockSimd(unsigned char const*, unsigned char const*, unsigned char*, unsigned long, unsigned long, unsigned char*)
         2: &lt;unknown&gt;!meshopt_decodeVertexBuffer
         3: &lt;unknown&gt;!benchCodecs(std::__2::vector&lt;Vertex, std::__2::allocator&lt;Vertex&gt; &gt; const&amp;, std::__2::vector&lt;unsigned int, std::__2::allocator&lt;unsigned int&gt; &gt; const&amp;)
         4: &lt;unknown&gt;!__original_main
         5: &lt;unknown&gt;!_start
</pre></div>


<p>The expected call sequence here is meshopt_decodeVertexBuffer -&gt; decodeVertexBlockSimd -&gt; decodeBytesSimd -&gt; decodeBytesGroupSimd, with no recursion. Unsure what "call stack exhausted" indicates here...</p>
<p>Unfortunately trying to add prints to this to understand the behavior fixes the issue as well, so the investigation here might be complicated. Is there a way to coerce wasmtime to generate a debuggable binary?</p>
</blockquote>



<a name="192855428"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20Issue%20%231407%20OOB%20memory%20access/near/192855428" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20Issue.20.231407.20OOB.20memory.20access.html#192855428">(Apr 03 2020 at 19:49)</a>:</h4>
<p>zeux edited a <a href="https://github.com/bytecodealliance/wasmtime/issues/1407#issuecomment-608626236" title="https://github.com/bytecodealliance/wasmtime/issues/1407#issuecomment-608626236">comment</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/1407" title="https://github.com/bytecodealliance/wasmtime/issues/1407">Issue #1407</a>:</p>
<blockquote>
<p>I strongly suspect this isn't an issue in the benchmark; the behavior seems highly dependent on the inlining here. Adding <code>noinline</code> to decodeBytesGroupSimd &amp; decodeBytesSimd &amp; decodeVertexBlockSimd fixes this. With only decodeBytesSimd marked as noinline, I get this instead:</p>
<div class="codehilite"><pre><span></span>/mnt/c/work/meshoptimizer $ make -B codecbench-simd.wasm &amp;&amp; ../wasmtime/target/debug/wasmtime --enable-simd codecbench-simd.wasm
emcc tools/codecbench.cpp src/vertexcodec.cpp src/vertexfilter.cpp src/overdrawanalyzer.cpp src/indexgenerator.cpp src/vcacheoptimizer.cpp src/clusterizer.cpp src/indexcodec.cpp src/vfetchanalyzer.cpp src/spatialorder.cpp src/allocator.cpp src/vcacheanalyzer.cpp src/vfetchoptimizer.cpp src/overdrawoptimizer.c
pp src/simplifier.cpp src/stripifier.cpp -O3 -DNDEBUG -s TOTAL_MEMORY=268435456 -msimd128 -o codecbench-simd.wasm -g
source: vertex data 32064032 bytes, index data 24000000 bytes
pass 0: vertex data 18518385 bytes, index data 2332680 bytes
Error: failed to run main module `codecbench-simd.wasm`

Caused by:
    0: failed to invoke `_start`
    1: wasm trap: call stack exhausted, source location: @-
       wasm backtrace:
         0: &lt;unknown&gt;!meshopt::decodeBytesSimd(unsigned char const*, unsigned char const*, unsigned char*, unsigned long)
         1: &lt;unknown&gt;!meshopt::decodeVertexBlockSimd(unsigned char const*, unsigned char const*, unsigned char*, unsigned long, unsigned long, unsigned char*)
         2: &lt;unknown&gt;!meshopt_decodeVertexBuffer
         3: &lt;unknown&gt;!benchCodecs(std::__2::vector&lt;Vertex, std::__2::allocator&lt;Vertex&gt; &gt; const&amp;, std::__2::vector&lt;unsigned int, std::__2::allocator&lt;unsigned int&gt; &gt; const&amp;)
         4: &lt;unknown&gt;!__original_main
         5: &lt;unknown&gt;!_start
</pre></div>


<p>The expected call sequence here is meshopt_decodeVertexBuffer -&gt; decodeVertexBlockSimd -&gt; decodeBytesSimd -&gt; decodeBytesGroupSimd, with no recursion. Unsure what "call stack exhausted" indicates here...</p>
<p>Also worth noting is that expanding various buffers to accomodate for possible overruns didn't help; in some configurations I'm not getting a stack overflow, but meshopt_decodeVertexBuffer returns a non-0 result because it exits early during parsing, which suggests some issues with control flow here.</p>
<p>Unfortunately trying to add prints to this to understand the behavior fixes the issue as well, so the investigation here might be complicated. Is there a way to coerce wasmtime to generate a debuggable binary?</p>
</blockquote>



<a name="192855526"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20Issue%20%231407%20OOB%20memory%20access/near/192855526" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20Issue.20.231407.20OOB.20memory.20access.html#192855526">(Apr 03 2020 at 19:50)</a>:</h4>
<p>zeux edited a <a href="https://github.com/bytecodealliance/wasmtime/issues/1407#issuecomment-608626236" title="https://github.com/bytecodealliance/wasmtime/issues/1407#issuecomment-608626236">comment</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/1407" title="https://github.com/bytecodealliance/wasmtime/issues/1407">Issue #1407</a>:</p>
<blockquote>
<p>I strongly suspect this isn't an issue in the benchmark; the behavior seems highly dependent on the inlining here. Adding <code>noinline</code> to decodeBytesGroupSimd &amp; decodeBytesSimd &amp; decodeVertexBlockSimd fixes this. With only decodeBytesSimd marked as noinline, I get this instead:</p>
<div class="codehilite"><pre><span></span>/mnt/c/work/meshoptimizer $ make -B codecbench-simd.wasm &amp;&amp; ../wasmtime/target/debug/wasmtime --enable-simd codecbench-simd.wasm
emcc tools/codecbench.cpp src/vertexcodec.cpp src/vertexfilter.cpp src/overdrawanalyzer.cpp src/indexgenerator.cpp src/vcacheoptimizer.cpp src/clusterizer.cpp src/indexcodec.cpp src/vfetchanalyzer.cpp src/spatialorder.cpp src/allocator.cpp src/vcacheanalyzer.cpp src/vfetchoptimizer.cpp src/overdrawoptimizer.c
pp src/simplifier.cpp src/stripifier.cpp -O3 -DNDEBUG -s TOTAL_MEMORY=268435456 -msimd128 -o codecbench-simd.wasm -g
source: vertex data 32064032 bytes, index data 24000000 bytes
pass 0: vertex data 18518385 bytes, index data 2332680 bytes
Error: failed to run main module `codecbench-simd.wasm`

Caused by:
    0: failed to invoke `_start`
    1: wasm trap: call stack exhausted, source location: @-
       wasm backtrace:
         0: &lt;unknown&gt;!meshopt::decodeBytesSimd(unsigned char const*, unsigned char const*, unsigned char*, unsigned long)
         1: &lt;unknown&gt;!meshopt::decodeVertexBlockSimd(unsigned char const*, unsigned char const*, unsigned char*, unsigned long, unsigned long, unsigned char*)
         2: &lt;unknown&gt;!meshopt_decodeVertexBuffer
         3: &lt;unknown&gt;!benchCodecs(std::__2::vector&lt;Vertex, std::__2::allocator&lt;Vertex&gt; &gt; const&amp;, std::__2::vector&lt;unsigned int, std::__2::allocator&lt;unsigned int&gt; &gt; const&amp;)
         4: &lt;unknown&gt;!__original_main
         5: &lt;unknown&gt;!_start
</pre></div>


<p>The expected call sequence here is meshopt_decodeVertexBuffer -&gt; decodeVertexBlockSimd -&gt; decodeBytesSimd -&gt; decodeBytesGroupSimd, with no recursion. Unsure what "call stack exhausted" indicates here...</p>
<p>Also worth noting is that expanding various buffers to accomodate for possible overruns didn't help; also in some inlining/codegen configurations I'm not getting a stack overflow or OOB, but meshopt_decodeVertexBuffer returns a non-0 result because it exits early during parsing, which suggests some issues with control flow here.</p>
<p>Unfortunately trying to add prints to this to understand the behavior fixes the issue as well, so the investigation here might be complicated. Is there a way to coerce wasmtime to generate a debuggable binary?</p>
</blockquote>



<a name="192855650"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20Issue%20%231407%20OOB%20memory%20access/near/192855650" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20Issue.20.231407.20OOB.20memory.20access.html#192855650">(Apr 03 2020 at 19:51)</a>:</h4>
<p>bjorn3 <a href="https://github.com/bytecodealliance/wasmtime/issues/1407#issuecomment-608628152" title="https://github.com/bytecodealliance/wasmtime/issues/1407#issuecomment-608628152">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/1407" title="https://github.com/bytecodealliance/wasmtime/issues/1407">Issue #1407</a>:</p>
<blockquote>
<p>Pass <code>-g</code> if your wasm file was build with debuginfo. I don't know if wasm2obj supports it though.</p>
</blockquote>



<a name="192857837"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20Issue%20%231407%20OOB%20memory%20access/near/192857837" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20Issue.20.231407.20OOB.20memory.20access.html#192857837">(Apr 03 2020 at 20:10)</a>:</h4>
<p>zeux <a href="https://github.com/bytecodealliance/wasmtime/issues/1407#issuecomment-608635837" title="https://github.com/bytecodealliance/wasmtime/issues/1407#issuecomment-608635837">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/1407" title="https://github.com/bytecodealliance/wasmtime/issues/1407">Issue #1407</a>:</p>
<blockquote>
<p><code>-g</code> doesn't seem to work with Emscripten-generated debug info here:</p>
<div class="codehilite"><pre><span></span>Error: failed to emit debug sections

Caused by:
    The end offset of a location list entry must not be before the beginning.`
</pre></div>


<p>Might be an Emscripten bug, not sure.</p>
<p><a href="https://github.com/bytecodealliance/wasmtime/files/4429672/codecbench-simd.zip" title="https://github.com/bytecodealliance/wasmtime/files/4429672/codecbench-simd.zip">codecbench-simd.zip</a></p>
</blockquote>



<a name="192858733"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20Issue%20%231407%20OOB%20memory%20access/near/192858733" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20Issue.20.231407.20OOB.20memory.20access.html#192858733">(Apr 03 2020 at 20:19)</a>:</h4>
<p>zeux <a href="https://github.com/bytecodealliance/wasmtime/issues/1407#issuecomment-608639504" title="https://github.com/bytecodealliance/wasmtime/issues/1407#issuecomment-608639504">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/1407" title="https://github.com/bytecodealliance/wasmtime/issues/1407">Issue #1407</a>:</p>
<blockquote>
<p>One other observation is that <code>--opt-level 0</code> doesn't trigger this bug:</p>
<div class="codehilite"><pre><span></span>/mnt/c/work/meshoptimizer $ ../wasmtime/target/debug/wasmtime --enable-simd --disable-cache --opt-level 0 codecbench-simd.wasm
source: vertex data 32064032 bytes, index data 24000000 bytes
pass 0: vertex data 18518385 bytes, index data 2332680 bytes
decode: vertex 28.46 ms (1.05 GB/sec), index 25.10 ms (0.89 GB/sec); rv 0 ri 0
...

/mnt/c/work/meshoptimizer $ ../wasmtime/target/debug/wasmtime --enable-simd --disable-cache --opt-level 1 codecbench-simd.wasm
source: vertex data 32064032 bytes, index data 24000000 bytes
pass 0: vertex data 18518385 bytes, index data 2332680 bytes
Error: failed to run main module `codecbench-simd.wasm`

Caused by:
    0: failed to invoke `_start`
    1: wasm trap: out of bounds memory access, source location: @7ca4
       wasm backtrace:
         0: &lt;unknown&gt;!&lt;wasm function 75&gt;
         1: &lt;unknown&gt;!&lt;wasm function 37&gt;
         2: &lt;unknown&gt;!&lt;wasm function 76&gt;
         3: &lt;unknown&gt;!&lt;wasm function 28&gt;
         4: &lt;unknown&gt;!&lt;wasm function 67&gt;
</pre></div>


<p>This is on a file without Emscripten-generated debug info.<br>
<a href="https://github.com/bytecodealliance/wasmtime/files/4429744/codecbench-simd.zip" title="https://github.com/bytecodealliance/wasmtime/files/4429744/codecbench-simd.zip">codecbench-simd.zip</a></p>
<p>I don't think I have enough understanding here to provide further help, but it looks to me as if the .wasm file in question has control flow that is complicated enough to trigger some miscompilation if optimizations are enabled, and the out of bounds access is just an odd side effect.</p>
</blockquote>



<a name="192859727"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20Issue%20%231407%20OOB%20memory%20access/near/192859727" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20Issue.20.231407.20OOB.20memory.20access.html#192859727">(Apr 03 2020 at 20:28)</a>:</h4>
<p>abrown <a href="https://github.com/bytecodealliance/wasmtime/issues/1407#issuecomment-608643395" title="https://github.com/bytecodealliance/wasmtime/issues/1407#issuecomment-608643395">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/1407" title="https://github.com/bytecodealliance/wasmtime/issues/1407">Issue #1407</a>:</p>
<blockquote>
<p>Glad you were able to replicate and that <code>--opt-level 0</code> difference is actually pretty interesting. There is a pass that converts a load with an offset that is the result of a sum to a complex load; I wonder if something weird is happening there.</p>
</blockquote>



<a name="195782744"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20Issue%20%231407%20OOB%20memory%20access/near/195782744" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20Issue.20.231407.20OOB.20memory.20access.html#195782744">(Apr 29 2020 at 23:26)</a>:</h4>
<p>abrown <a href="https://github.com/bytecodealliance/wasmtime/issues/1407#issuecomment-621521705" title="https://github.com/bytecodealliance/wasmtime/issues/1407#issuecomment-621521705">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/1407" title="https://github.com/bytecodealliance/wasmtime/issues/1407">Issue #1407</a>:</p>
<blockquote>
<p>I just re-ran the Wasm files above and they ran without issue in the master branch of wasmtime (except for <code>emscripten-built-for-js.wasm</code> of course--that failure is expected). It's hard to say exactly what has changed that would have fixed this but I'm going to close it since I can't reproduce now (thankfully!).</p>
</blockquote>



<a name="195782745"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20Issue%20%231407%20OOB%20memory%20access/near/195782745" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20Issue.20.231407.20OOB.20memory.20access.html#195782745">(Apr 29 2020 at 23:26)</a>:</h4>
<p>abrown closed <a href="https://github.com/bytecodealliance/wasmtime/issues/1407" title="https://github.com/bytecodealliance/wasmtime/issues/1407">Issue #1407</a>:</p>
<blockquote>
<h3>What do you expect to happen? What does actually happen? Does it panic, and if so, with which assertion?</h3>
<p><code>wasmtime</code> traps with an OOB memory access; Node does not. </p>
<p>In Node the code runs as expected (though we have to run it from the JS wrapper):</p>
<div class="codehilite"><pre><span></span><code>$ node --version
v13.9.0
$ node --experimental-wasm-simd emscripten-built-for-js.js
source: vertex data 32064032 bytes, index data 24000000 bytes
pass 0: vertex data 18518385 bytes, index data 2332680 bytes
decode: vertex 16.32 ms (1.83 GB/sec), index 11.15 ms (2.00 GB/sec)
decode: vertex 16.33 ms (1.83 GB/sec), index 11.15 ms (2.00 GB/sec)
decode: vertex 16.57 ms (1.80 GB/sec), index 11.23 ms (1.99 GB/sec)
decode: vertex 16.19 ms (1.84 GB/sec), index 11.35 ms (1.97 GB/sec)
decode: vertex 16.18 ms (1.85 GB/sec), index 11.16 ms (2.00 GB/sec)
decode: vertex 16.12 ms (1.85 GB/sec), index 11.19 ms (2.00 GB/sec)
decode: vertex 16.19 ms (1.84 GB/sec), index 11.15 ms (2.01 GB/sec)
decode: vertex 16.16 ms (1.85 GB/sec), index 11.14 ms (2.01 GB/sec)
decode: vertex 16.15 ms (1.85 GB/sec), index 11.17 ms (2.00 GB/sec)
decode: vertex 16.17 ms (1.85 GB/sec), index 11.16 ms (2.00 GB/sec)
pass 1: vertex data 18518204 bytes, index data 2001016 bytes
decode: vertex 16.12 ms (1.85 GB/sec), index 11.07 ms (2.02 GB/sec)
decode: vertex 16.17 ms (1.85 GB/sec), index 11.08 ms (2.02 GB/sec)
decode: vertex 16.11 ms (1.85 GB/sec), index 11.11 ms (2.01 GB/sec)
decode: vertex 16.21 ms (1.84 GB/sec), index 11.09 ms (2.02 GB/sec)
decode: vertex 16.17 ms (1.85 GB/sec), index 11.10 ms (2.01 GB/sec)
decode: vertex 16.07 ms (1.86 GB/sec), index 11.13 ms (2.01 GB/sec)
decode: vertex 16.19 ms (1.84 GB/sec), index 11.06 ms (2.02 GB/sec)
decode: vertex 16.17 ms (1.85 GB/sec), index 11.10 ms (2.01 GB/sec)
decode: vertex 16.04 ms (1.86 GB/sec), index 11.14 ms (2.01 GB/sec)
decode: vertex 16.19 ms (1.84 GB/sec), index 11.07 ms (2.02 GB/sec)
filters: oct8 data 4000000 bytes, oct12/quat12 data 8000000 bytes
filter: oct8 2.12 ms (1.76 GB/sec), oct12 2.26 ms (3.29 GB/sec), quat12 2.84 ms (2.63 GB/sec)
filter: oct8 2.11 ms (1.76 GB/sec), oct12 2.19 ms (3.40 GB/sec), quat12 2.79 ms (2.67 GB/sec)
filter: oct8 2.11 ms (1.77 GB/sec), oct12 2.17 ms (3.43 GB/sec), quat12 2.79 ms (2.67 GB/sec)
filter: oct8 2.13 ms (1.75 GB/sec), oct12 2.25 ms (3.32 GB/sec), quat12 2.86 ms (2.61 GB/sec)
filter: oct8 2.10 ms (1.77 GB/sec), oct12 2.17 ms (3.43 GB/sec), quat12 2.80 ms (2.66 GB/sec)
filter: oct8 2.09 ms (1.78 GB/sec), oct12 2.16 ms (3.45 GB/sec), quat12 2.81 ms (2.65 GB/sec)
filter: oct8 2.13 ms (1.75 GB/sec), oct12 2.28 ms (3.26 GB/sec), quat12 2.82 ms (2.64 GB/sec)
filter: oct8 2.23 ms (1.67 GB/sec), oct12 2.16 ms (3.44 GB/sec), quat12 2.81 ms (2.65 GB/sec)
filter: oct8 2.10 ms (1.78 GB/sec), oct12 2.15 ms (3.47 GB/sec), quat12 2.83 ms (2.63 GB/sec)
filter: oct8 2.14 ms (1.74 GB/sec), oct12 2.17 ms (3.44 GB/sec), quat12 2.80 ms (2.66 GB/sec)
</code></pre></div>


<p>In wasmtime (on branch <a href="https://github.com/abrown/wasmtime/tree/additional-i8x16-shift" title="https://github.com/abrown/wasmtime/tree/additional-i8x16-shift">https://github.com/abrown/wasmtime/tree/additional-i8x16-shift</a> which implements needed instructions). I tried various versions of the same code built with different tools:</p>
<div class="codehilite"><pre><span></span><code>$ ls ../oob/*.wasm | xargs -I{} sh -c &quot;cargo run -- run --enable-simd --disable-cache {}&quot;


    Finished dev [unoptimized + debuginfo] target(s) in 0.07s
     Running `target/debug/wasmtime run --enable-simd --disable-cache ../oob/emscripten-built-for-js.wasm`
Error: failed to run main module `../oob/emscripten-built-for-js.wasm`

Caused by:
    import module `a` was not found



    Finished dev [unoptimized + debuginfo] target(s) in 0.07s
     Running `target/debug/wasmtime run --enable-simd --disable-cache ../oob/emscripten-built.wasm`
source: vertex data 32064032 bytes, index data 24000000 bytes
pass 0: vertex data 18518385 bytes, index data 2332680 bytes
Error: failed to run main module `../oob/emscripten-built.wasm`

Caused by:
    0: failed to invoke `_start`
    1: wasm trap: out of bounds memory access, source location: @7d97
       wasm backtrace:
         0: &lt;unknown&gt;!&lt;wasm function 74&gt;
         1: &lt;unknown&gt;!&lt;wasm function 37&gt;
         2: &lt;unknown&gt;!&lt;wasm function 75&gt;
         3: &lt;unknown&gt;!&lt;wasm function 28&gt;
         4: &lt;unknown&gt;!&lt;wasm function 67&gt;



    Finished dev [unoptimized + debuginfo] target(s) in 0.07s
     Running `target/debug/wasmtime run --enable-simd --disable-cache ../oob/wasi-sdk-built-extra-memory.wasm`
source: vertex data 32064032 bytes, index data 24000000 bytes
pass 0: vertex data 18518385 bytes, index data 2332680 bytes
Error: failed to run main module `../oob/wasi-sdk-built-extra-memory.wasm`

Caused by:
    0: failed to invoke `_start`
    1: wasm trap: out of bounds memory access, source location: @22a5
       wasm backtrace:
         0: &lt;unknown&gt;!meshopt::decodeVertexBlockSimd(unsigned char const*, unsigned char const*, unsigned char*, unsigned long, unsigned long, unsigned char*)
         1: &lt;unknown&gt;!meshopt_decodeVertexBuffer
         2: &lt;unknown&gt;!benchCodecs(std::__2::vector&lt;Vertex, std::__2::allocator&lt;Vertex&gt; &gt; const&amp;, std::__2::vector&lt;unsigned int, std::__2::allocator&lt;unsigned int&gt; &gt; const&amp;)
         3: &lt;unknown&gt;!__original_main
         4: &lt;unknown&gt;!_start



    Finished dev [unoptimized + debuginfo] target(s) in 0.07s
     Running `target/debug/wasmtime run --enable-simd --disable-cache ../oob/wasi-sdk-built.wasm`
source: vertex data 32064032 bytes, index data 24000000 bytes
pass 0: vertex data 18518385 bytes, index data 2332680 bytes
Error: failed to run main module `../oob/wasi-sdk-built.wasm`

Caused by:
    0: failed to invoke `_start`
    1: wasm trap: out of bounds memory access, source location: @22a4
       wasm backtrace:
         0: &lt;unknown&gt;!meshopt::decodeVertexBlockSimd(unsigned char const*, unsigned char const*, unsigned char*, unsigned long, unsigned long, unsigned char*)
         1: &lt;unknown&gt;!meshopt_decodeVertexBuffer
         2: &lt;unknown&gt;!benchCodecs(std::__2::vector&lt;Vertex, std::__2::allocator&lt;Vertex&gt; &gt; const&amp;, std::__2::vector&lt;unsigned int, std::__2::allocator&lt;unsigned int&gt; &gt; const&amp;)
         3: &lt;unknown&gt;!__original_main
         4: &lt;unknown&gt;!_start
</code></pre></div>


<h3>Which Wasmtime version / commit hash / branch are you using?</h3>
<p>On branch <a href="https://github.com/abrown/wasmtime/tree/additional-i8x16-shift" title="https://github.com/abrown/wasmtime/tree/additional-i8x16-shift">https://github.com/abrown/wasmtime/tree/additional-i8x16-shift</a> which implements needed instructions.</p>
<h3>What are the steps to reproduce the issue?</h3>
<p>See above. Also, here are steps for building the Wasm modules from <a href="https://github.com/zeux/meshoptimizer/tree/9047ac1936351d0508bb26b5b82ec1101f9735b4" title="https://github.com/zeux/meshoptimizer/tree/9047ac1936351d0508bb26b5b82ec1101f9735b4">https://github.com/zeux/meshoptimizer/tree/9047ac1936351d0508bb26b5b82ec1101f9735b4</a>:</p>
<div class="codehilite"><pre><span></span><code># wasi-sdi-built.wasm (2^28 bytes of memory, 4096x64K pages)
$ /opt/wasi-sdk/bin/clang++ --version
clang version 11.0.0 (https://github.com/llvm/llvm-project 46bb6613a31fd43b6d4485ce7e71a387dc22cbc7)
Target: wasm32-unknown-wasi
Thread model: posix
InstalledDir: /opt/wasi-sdk/bin
$ make clean &amp;&amp; make codecbench-simd.wasm
/opt/wasi-sdk/bin/clang++ tools/codecbench.cpp src/vertexcodec.cpp src/vertexfilter.cpp src/overdrawanalyzer.cpp src/indexgenerator.cpp src/vcacheoptimizer.cpp src/indexcodec.cpp src/vfetchanalyzer.cpp src/spatialorder.cpp src/clusterizer.cpp src/allocator.cpp src/vcacheanalyzer.cpp src/vfetchoptimizer.cpp src/overdrawoptimizer.cpp src/simplifier.cpp src/stripifier.cpp -O3 -DNDEBUG -fno-exceptions -Wl,--initial-memory=268435456 -msimd128 -o codecbench-simd.wasm

# wasi-sdk-built-extra-memory.wasm (2^30 bytes, 16384x64K pages)
$ make clean &amp;&amp; make codecbench-simd.wasm
/opt/wasi-sdk/bin/clang++ tools/codecbench.cpp src/vertexcodec.cpp src/vertexfilter.cpp src/overdrawanalyzer.cpp src/indexgenerator.cpp src/vcacheoptimizer.cpp src/indexcodec.cpp src/vfetchanalyzer.cpp src/spatialorder.cpp src/clusterizer.cpp src/allocator.cpp src/vcacheanalyzer.cpp src/vfetchoptimizer.cpp src/overdrawoptimizer.cpp src/simplifier.cpp src/stripifier.cpp -O3 -DNDEBUG -fno-exceptions -Wl,--initial-memory=1073741824 -msimd128 -o codecbench-simd.wasm

# emscripten-built.wasm
$ emcc --version
emcc (Emscripten gcc/clang-like replacement) 1.39.10 (commit 1bd7d547598f3fc74699c172f6c9c59a1e8484f1)
$ make clean &amp;&amp; make codecbench-simd.wasm
emcc tools/codecbench.cpp src/vertexcodec.cpp src/vertexfilter.cpp src/overdrawanalyzer.cpp src/indexgenerator.cpp src/vcacheoptimizer.cpp src/indexcodec.cpp src/vfetchanalyzer.cpp src/spatialorder.cpp src/clusterizer.cpp src/allocator.cpp src/vcacheanalyzer.cpp src/vfetchoptimizer.cpp src/overdrawoptimizer.cpp src/simplifier.cpp src/stripifier.cpp -O3 -DNDEBUG -s TOTAL_MEMORY=268435456 -msimd128 -o codecbench-simd.wasm

# then generated wat and dump files with
ls *.wasm | xargs -I{} sh -c &quot;wasm2wat --enable-all {} &gt; {}.wat&quot;
ls *.wasm | xargs -I{} sh -c &quot;wasm-objdump -d {} &gt; {}.dump&quot;
</code></pre></div>


<p><a href="https://github.com/bytecodealliance/wasmtime/files/4383623/emscripten-built.wasm.txt" title="https://github.com/bytecodealliance/wasmtime/files/4383623/emscripten-built.wasm.txt">emscripten-built.wasm.txt</a><br>
<a href="https://github.com/bytecodealliance/wasmtime/files/4383624/emscripten-built.wasm.wat.txt" title="https://github.com/bytecodealliance/wasmtime/files/4383624/emscripten-built.wasm.wat.txt">emscripten-built.wasm.wat.txt</a><br>
<a href="https://github.com/bytecodealliance/wasmtime/files/4383625/emscripten-built-for-js.js.txt" title="https://github.com/bytecodealliance/wasmtime/files/4383625/emscripten-built-for-js.js.txt">emscripten-built-for-js.js.txt</a><br>
<a href="https://github.com/bytecodealliance/wasmtime/files/4383626/emscripten-built-for-js.wasm.dump.txt" title="https://github.com/bytecodealliance/wasmtime/files/4383626/emscripten-built-for-js.wasm.dump.txt">emscripten-built-for-js.wasm.dump.txt</a><br>
<a href="https://github.com/bytecodealliance/wasmtime/files/4383627/emscripten-built-for-js.wasm.txt" title="https://github.com/bytecodealliance/wasmtime/files/4383627/emscripten-built-for-js.wasm.txt">emscripten-built-for-js.wasm.txt</a><br>
<a href="https://github.com/bytecodealliance/wasmtime/files/4383628/emscripten-built-for-js.wasm.wat.txt" title="https://github.com/bytecodealliance/wasmtime/files/4383628/emscripten-built-for-js.wasm.wat.txt">emscripten-built-for-js.wasm.wat.txt</a><br>
<a href="https://github.com/bytecodealliance/wasmtime/files/4383629/wasi-sdk-built.wasm.dump.txt" title="https://github.com/bytecodealliance/wasmtime/files/4383629/wasi-sdk-built.wasm.dump.txt">wasi-sdk-built.wasm.dump.txt</a><br>
<a href="https://github.com/bytecodealliance/wasmtime/files/4383630/wasi-sdk-built.wasm.txt" title="https://github.com/bytecodealliance/wasmtime/files/4383630/wasi-sdk-built.wasm.txt">wasi-sdk-built.wasm.txt</a><br>
<a href="https://github.com/bytecodealliance/wasmtime/files/4383631/wasi-sdk-built.wasm.wat.txt" title="https://github.com/bytecodealliance/wasmtime/files/4383631/wasi-sdk-built.wasm.wat.txt">wasi-sdk-built.wasm.wat.txt</a><br>
[wasi-sdk-b<br>
[message truncated]</p>
</blockquote>



<hr><p>Last updated: Jan 20 2025 at 06:04 UTC</p>
</html>