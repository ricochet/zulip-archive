<html>
<head><meta charset="utf-8"><title>wasmtime / PR #7364 mpk: limit the number of protection keys · git-wasmtime · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/index.html">git-wasmtime</a></h2>
<h3>Topic: <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.237364.20mpk.3A.20limit.20the.20number.20of.20protection.20keys.html">wasmtime / PR #7364 mpk: limit the number of protection keys</a></h3>

<hr>

<base href="https://bytecodealliance.zulipchat.com">

<head><link href="https://bytecodealliance.github.io/zulip-archive/style.css" rel="stylesheet"></head>

<a name="398540259"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%237364%20mpk%3A%20limit%20the%20number%20of%20protection%20keys/near/398540259" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.237364.20mpk.3A.20limit.20the.20number.20of.20protection.20keys.html#398540259">(Oct 25 2023 at 18:27)</a>:</h4>
<p>abrown edited <a href="https://github.com/bytecodealliance/wasmtime/pull/7364">PR #7364</a>:</p>
<blockquote>
<p>This change stems from how slicing memory slots into MPK-protected regions limits the number of memories each store can access: e.g., with fifteen keys in use, a store only has access to a fifteenth of the available slots. If we simply multiple the number of memory slots needed to run the <code>*.wast</code> spec tests by fifteen, we run out of available memory. This limits the number of protection keys used to two, which still allows us to test the functionality without reserving too much memory.</p>
<p>Also, if Wasmtime is ever embedded in an application that also uses memory protection keys, it could be useful to limit how many Wasmtime allocates and uses.. This change not only limits the number of protection keys used at runtime, but takes that<br>
further to attempt to limit the initial number of keys allocated. The unfortunate side effect of using a <code>OnceLock</code> is that the <code>max</code> setting is only applicable on the first invocation, the one that sets the <code>OnceLock</code>.</p>
</blockquote>



<a name="398540323"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%237364%20mpk%3A%20limit%20the%20number%20of%20protection%20keys/near/398540323" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.237364.20mpk.3A.20limit.20the.20number.20of.20protection.20keys.html#398540323">(Oct 25 2023 at 18:27)</a>:</h4>
<p><strong>abrown</strong> requested <a href="https://github.com/alexcrichton">alexcrichton</a> for a review on <a href="https://github.com/bytecodealliance/wasmtime/pull/7364">PR #7364</a>.</p>



<a name="398540367"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%237364%20mpk%3A%20limit%20the%20number%20of%20protection%20keys/near/398540367" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.237364.20mpk.3A.20limit.20the.20number.20of.20protection.20keys.html#398540367">(Oct 25 2023 at 18:27)</a>:</h4>
<p>abrown submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/7364#pullrequestreview-1698014356">PR review</a>.</p>



<a name="398540368"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%237364%20mpk%3A%20limit%20the%20number%20of%20protection%20keys/near/398540368" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.237364.20mpk.3A.20limit.20the.20number.20of.20protection.20keys.html#398540368">(Oct 25 2023 at 18:27)</a>:</h4>
<p>abrown created <a href="https://github.com/bytecodealliance/wasmtime/pull/7364#discussion_r1372163668">PR review comment</a>:</p>
<blockquote>
<p>Not sure about this?</p>
</blockquote>



<a name="398540618"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%237364%20mpk%3A%20limit%20the%20number%20of%20protection%20keys/near/398540618" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.237364.20mpk.3A.20limit.20the.20number.20of.20protection.20keys.html#398540618">(Oct 25 2023 at 18:29)</a>:</h4>
<p>abrown submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/7364#pullrequestreview-1698017555">PR review</a>.</p>



<a name="398540619"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%237364%20mpk%3A%20limit%20the%20number%20of%20protection%20keys/near/398540619" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.237364.20mpk.3A.20limit.20the.20number.20of.20protection.20keys.html#398540619">(Oct 25 2023 at 18:29)</a>:</h4>
<p>abrown created <a href="https://github.com/bytecodealliance/wasmtime/pull/7364#discussion_r1372165815">PR review comment</a>:</p>
<blockquote>
<p>@alexcrichton, I'm not sure I like how the <code>max</code> parameter is really only a hint: it only applies the first time one calls <code>keys</code>.</p>
</blockquote>



<a name="398540742"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%237364%20mpk%3A%20limit%20the%20number%20of%20protection%20keys/near/398540742" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.237364.20mpk.3A.20limit.20the.20number.20of.20protection.20keys.html#398540742">(Oct 25 2023 at 18:30)</a>:</h4>
<p>abrown submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/7364#pullrequestreview-1698018442">PR review</a>.</p>



<a name="398540743"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%237364%20mpk%3A%20limit%20the%20number%20of%20protection%20keys/near/398540743" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.237364.20mpk.3A.20limit.20the.20number.20of.20protection.20keys.html#398540743">(Oct 25 2023 at 18:30)</a>:</h4>
<p>abrown created <a href="https://github.com/bytecodealliance/wasmtime/pull/7364#discussion_r1372166636">PR review comment</a>:</p>
<blockquote>
<p>I guess I should just move this logic into <code>keys</code> if we end up using this approach.</p>
</blockquote>



<a name="398546067"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%237364%20mpk%3A%20limit%20the%20number%20of%20protection%20keys/near/398546067" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.237364.20mpk.3A.20limit.20the.20number.20of.20protection.20keys.html#398546067">(Oct 25 2023 at 19:08)</a>:</h4>
<p>alexcrichton submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/7364#pullrequestreview-1698076068">PR review</a>:</p>
<blockquote>
<p>Seems reasonable to me! I think this is fine to start out with at least and we can iterate on it over time. I do agree with what you mentioned though of pushing the handling of <code>max</code> directly into the <code>keys</code> function.</p>
</blockquote>



<a name="398546069"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%237364%20mpk%3A%20limit%20the%20number%20of%20protection%20keys/near/398546069" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.237364.20mpk.3A.20limit.20the.20number.20of.20protection.20keys.html#398546069">(Oct 25 2023 at 19:08)</a>:</h4>
<p>alexcrichton submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/7364#pullrequestreview-1698076068">PR review</a>:</p>
<blockquote>
<p>Seems reasonable to me! I think this is fine to start out with at least and we can iterate on it over time. I do agree with what you mentioned though of pushing the handling of <code>max</code> directly into the <code>keys</code> function.</p>
</blockquote>



<a name="398546070"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%237364%20mpk%3A%20limit%20the%20number%20of%20protection%20keys/near/398546070" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.237364.20mpk.3A.20limit.20the.20number.20of.20protection.20keys.html#398546070">(Oct 25 2023 at 19:08)</a>:</h4>
<p>alexcrichton created <a href="https://github.com/bytecodealliance/wasmtime/pull/7364#discussion_r1372210274">PR review comment</a>:</p>
<blockquote>
<p>This makes some sense to me in that you doubled the number of memories which would halve the limit of concurrent tests because right now each test creates its own engine.</p>
</blockquote>



<a name="398556079"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%237364%20mpk%3A%20limit%20the%20number%20of%20protection%20keys/near/398556079" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.237364.20mpk.3A.20limit.20the.20number.20of.20protection.20keys.html#398556079">(Oct 25 2023 at 20:26)</a>:</h4>
<p>abrown updated <a href="https://github.com/bytecodealliance/wasmtime/pull/7364">PR #7364</a>.</p>



<a name="398556124"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%237364%20mpk%3A%20limit%20the%20number%20of%20protection%20keys/near/398556124" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.237364.20mpk.3A.20limit.20the.20number.20of.20protection.20keys.html#398556124">(Oct 25 2023 at 20:26)</a>:</h4>
<p><strong>abrown</strong> has marked <a href="https://github.com/bytecodealliance/wasmtime/pull/7364">PR #7364</a> as ready for review.</p>



<a name="398556126"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%237364%20mpk%3A%20limit%20the%20number%20of%20protection%20keys/near/398556126" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.237364.20mpk.3A.20limit.20the.20number.20of.20protection.20keys.html#398556126">(Oct 25 2023 at 20:26)</a>:</h4>
<p><strong>abrown</strong> requested <a href="https://github.com/orgs/bytecodealliance/teams/wasmtime-core-reviewers">wasmtime-core-reviewers</a> for a review on <a href="https://github.com/bytecodealliance/wasmtime/pull/7364">PR #7364</a>.</p>



<a name="398556175"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%237364%20mpk%3A%20limit%20the%20number%20of%20protection%20keys/near/398556175" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.237364.20mpk.3A.20limit.20the.20number.20of.20protection.20keys.html#398556175">(Oct 25 2023 at 20:27)</a>:</h4>
<p>abrown has enabled auto merge for <a href="https://github.com/bytecodealliance/wasmtime/pull/7364">PR #7364</a>.</p>



<a name="398561923"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%237364%20mpk%3A%20limit%20the%20number%20of%20protection%20keys/near/398561923" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.237364.20mpk.3A.20limit.20the.20number.20of.20protection.20keys.html#398561923">(Oct 25 2023 at 21:17)</a>:</h4>
<p>abrown updated <a href="https://github.com/bytecodealliance/wasmtime/pull/7364">PR #7364</a>.</p>



<a name="398568145"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%237364%20mpk%3A%20limit%20the%20number%20of%20protection%20keys/near/398568145" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.237364.20mpk.3A.20limit.20the.20number.20of.20protection.20keys.html#398568145">(Oct 25 2023 at 22:14)</a>:</h4>
<p>abrown merged <a href="https://github.com/bytecodealliance/wasmtime/pull/7364">PR #7364</a>.</p>



<hr><p>Last updated: Jan 20 2025 at 06:04 UTC</p>
</html>