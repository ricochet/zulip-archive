<html>
<head><meta charset="utf-8"><title>wasmtime / issue #7954 cranelift: Use `DominatorTreePreor... · git-wasmtime · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/index.html">git-wasmtime</a></h2>
<h3>Topic: <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.237954.20cranelift.3A.20Use.20.60DominatorTreePreor.2E.2E.2E.html">wasmtime / issue #7954 cranelift: Use `DominatorTreePreor...</a></h3>

<hr>

<base href="https://bytecodealliance.zulipchat.com">

<head><link href="https://bytecodealliance.github.io/zulip-archive/style.css" rel="stylesheet"></head>

<a name="421955060"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%237954%20cranelift%3A%20Use%20%60DominatorTreePreor.../near/421955060" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.237954.20cranelift.3A.20Use.20.60DominatorTreePreor.2E.2E.2E.html#421955060">(Feb 16 2024 at 23:35)</a>:</h4>
<p><a href="https://github.com/jameysharp">jameysharp</a> added the good first issue label to <a href="https://github.com/bytecodealliance/wasmtime/issues/7954">Issue #7954</a>.</p>



<a name="421955061"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%237954%20cranelift%3A%20Use%20%60DominatorTreePreor.../near/421955061" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.237954.20cranelift.3A.20Use.20.60DominatorTreePreor.2E.2E.2E.html#421955061">(Feb 16 2024 at 23:35)</a>:</h4>
<p><a href="https://github.com/jameysharp">jameysharp</a> added the cranelift:E-easy label to <a href="https://github.com/bytecodealliance/wasmtime/issues/7954">Issue #7954</a>.</p>



<a name="421955062"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%237954%20cranelift%3A%20Use%20%60DominatorTreePreor.../near/421955062" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.237954.20cranelift.3A.20Use.20.60DominatorTreePreor.2E.2E.2E.html#421955062">(Feb 16 2024 at 23:35)</a>:</h4>
<p><a href="https://github.com/jameysharp">jameysharp</a> added the cranelift:mid-end label to <a href="https://github.com/bytecodealliance/wasmtime/issues/7954">Issue #7954</a>.</p>



<a name="421955063"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%237954%20cranelift%3A%20Use%20%60DominatorTreePreor.../near/421955063" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.237954.20cranelift.3A.20Use.20.60DominatorTreePreor.2E.2E.2E.html#421955063">(Feb 16 2024 at 23:35)</a>:</h4>
<p><a href="https://github.com/jameysharp">jameysharp</a> added the cranelift<span aria-label="goal" class="emoji emoji-1f945" role="img" title="goal">:goal:</span>compile-time label to <a href="https://github.com/bytecodealliance/wasmtime/issues/7954">Issue #7954</a>.</p>



<a name="421955065"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%237954%20cranelift%3A%20Use%20%60DominatorTreePreor.../near/421955065" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.237954.20cranelift.3A.20Use.20.60DominatorTreePreor.2E.2E.2E.html#421955065">(Feb 16 2024 at 23:35)</a>:</h4>
<p>jameysharp opened <a href="https://github.com/bytecodealliance/wasmtime/issues/7954">issue #7954</a>:</p>
<blockquote>
<h4>Feature</h4>
<p>We have two interfaces in Cranelift for navigating <a href="https://en.wikipedia.org/wiki/Dominator_(graph_theory)">dominator</a> trees, both defined in the <code>cranelift_codegen::dominator_tree</code> module: <code>DominatorTree</code> and <code>DominatorTreePreorder</code>. But we weren't using the latter outside of tests after #3434 landed in 2021, until I switched the egraph pass over to using it in #7948 today.</p>
<ol>
<li>We should audit all uses of <code>DominatorTree</code> to see if they would be better served by using <code>DominatorTreePreorder</code> instead.</li>
<li>If we end up using <code>DominatorTreePreorder</code> in more places than just the egraph pass, then we should compute it once and share it.</li>
<li>If it turns out that we always need a <code>DominatorTreePreorder</code> when compiling any function, then we should fold the two types into one and always compute the preorder when we're computing the dominator tree.</li>
</ol>
<h4>Benefit</h4>
<p>These two interfaces both provide a method named <code>dominates</code> which checks whether one basic block dominates another. However, <code>DominatorTree</code> does this in time proportional to the length of the path from one block to the other within the dominator tree. Thanks to a linear-time preprocessing step performed once, <code>DominatorTreePreorder</code> can answer this question in constant time.</p>
<p>So if we're using the <code>DominatorTree::dominates</code> method anywhere that's performance-critical, switching to <code>DominatorTreePreorder</code> could provide an asymptotic-complexity improvement.</p>
<p>On top of that, sharing a precomputed preorder across multiple uses saves time redoing the preprocessing step and also may allow us to reuse a heap allocation for the temporary storage used during that preprocessing step.</p>
<h4>Implementation</h4>
<p>To start with, search for all uses of <code>DominatorTree::dominates</code>. For each one, see if we can just replace it with <code>DominatorTreePreorder::dominates</code>.</p>
<p>This is easy if both arguments are <code>Block</code> IDs, but either one is currently also allowed to be an instruction ID (<code>Inst</code>) or a <code>ProgramPoint</code>. If we're relying on that feature somewhere, it's only slightly more complicated: If two instructions are in the same block then the earlier instruction dominates the later instruction; otherwise we can go back to the easy case and compare the blocks they're in to see if one block dominates the other.</p>
<p>If some instances of <code>DominatorTree</code> are only being used to call <code>dominates</code>, then removing that structure from those instances in favor of <code>DominatorTreePreorder</code> is the next step. However, some cases may also be using other methods such as <code>cfg_postorder</code> or <code>idom</code>, which are not available on <code>DominatorTreePreorder</code>.</p>
<h4>Alternatives</h4>
<p>We can always leave this alone, but I think it's a good source of small changes that may give us performance improvements during compilation.</p>
</blockquote>



<a name="422069008"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%237954%20cranelift%3A%20Use%20%60DominatorTreePreor.../near/422069008" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.237954.20cranelift.3A.20Use.20.60DominatorTreePreor.2E.2E.2E.html#422069008">(Feb 18 2024 at 05:35)</a>:</h4>
<p>MuhtasimTanmoy <a href="https://github.com/bytecodealliance/wasmtime/issues/7954#issuecomment-1950968765">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/7954">issue #7954</a>:</p>
<blockquote>
<p>Would like to take this one<br>
</p>
</blockquote>



<a name="422472230"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%237954%20cranelift%3A%20Use%20%60DominatorTreePreor.../near/422472230" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.237954.20cranelift.3A.20Use.20.60DominatorTreePreor.2E.2E.2E.html#422472230">(Feb 20 2024 at 17:59)</a>:</h4>
<p>jameysharp <a href="https://github.com/bytecodealliance/wasmtime/issues/7954#issuecomment-1954774080">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/7954">issue #7954</a>:</p>
<blockquote>
<p>Great, please do! If you have any questions, let us know. We're happy to help!</p>
</blockquote>



<a name="466661648"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%237954%20cranelift%3A%20Use%20%60DominatorTreePreor.../near/466661648" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.237954.20cranelift.3A.20Use.20.60DominatorTreePreor.2E.2E.2E.html#466661648">(Sep 01 2024 at 08:06)</a>:</h4>
<p>badumbatish <a href="https://github.com/bytecodealliance/wasmtime/issues/7954#issuecomment-2323222426">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/7954">issue #7954</a>:</p>
<blockquote>
<p>hi there! is this issue still on going?</p>
</blockquote>



<a name="468076689"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%237954%20cranelift%3A%20Use%20%60DominatorTreePreor.../near/468076689" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.237954.20cranelift.3A.20Use.20.60DominatorTreePreor.2E.2E.2E.html#468076689">(Sep 06 2024 at 05:58)</a>:</h4>
<p>badumbatish <a href="https://github.com/bytecodealliance/wasmtime/issues/7954#issuecomment-2333302149">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/7954">issue #7954</a>:</p>
<blockquote>
<p>i'll give this one a try if nobody's doing this</p>
</blockquote>



<hr><p>Last updated: Jan 20 2025 at 06:04 UTC</p>
</html>