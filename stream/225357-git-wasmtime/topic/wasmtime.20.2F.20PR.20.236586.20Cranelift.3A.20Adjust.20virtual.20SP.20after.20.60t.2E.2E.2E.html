<html>
<head><meta charset="utf-8"><title>wasmtime / PR #6586 Cranelift: Adjust virtual SP after `t... · git-wasmtime · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/index.html">git-wasmtime</a></h2>
<h3>Topic: <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.236586.20Cranelift.3A.20Adjust.20virtual.20SP.20after.20.60t.2E.2E.2E.html">wasmtime / PR #6586 Cranelift: Adjust virtual SP after `t...</a></h3>

<hr>

<base href="https://bytecodealliance.zulipchat.com">

<head><link href="https://bytecodealliance.github.io/zulip-archive/style.css" rel="stylesheet"></head>

<a name="366628239"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%236586%20Cranelift%3A%20Adjust%20virtual%20SP%20after%20%60t.../near/366628239" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.236586.20Cranelift.3A.20Adjust.20virtual.20SP.20after.20.60t.2E.2E.2E.html#366628239">(Jun 15 2023 at 21:12)</a>:</h4>
<p>fitzgen opened <a href="https://github.com/bytecodealliance/wasmtime/pull/6586">PR #6586</a> from <code>fitzgen:call-pop-virtual-sp</code> to <code>bytecodealliance:main</code>:</p>
<blockquote>
<p>Callees that use the <code>tail</code> calling convention will pop stack arguments from the stack for their callers. They do not, however, adjust the caller's virtual SP, so that still needs to happen in our ABI and <code>CallSite</code> code. This is, however, slightly trickier than just emitting a nominal SP adjustment pseudo-instruction because we cannot let regalloc attempt to spill or reload values between the call and the SP adjustment because the stack offsets will be off by the size of the stack arguments to the call. Therefore, we add the number of bytes that the callee pops to the <code>CallInfo</code> structures and have emission update the virtual SP atomically with regards to the call itself.</p>
<p>Fixes #6581<br>
Fixes #6582</p>
<p>&lt;!--<br>
Please make sure you include the following information:</p>
<ul>
<li>
<p>If this work has been discussed elsewhere, please include a link to that<br>
  conversation. If it was discussed in an issue, just mention "issue #...".</p>
</li>
<li>
<p>Explain why this change is needed. If the details are in an issue already,<br>
  this can be brief.</p>
</li>
</ul>
<p>Our development process is documented in the Wasmtime book:<br>
<a href="https://docs.wasmtime.dev/contributing-development-process.html">https://docs.wasmtime.dev/contributing-development-process.html</a></p>
<p>Please ensure all communication follows the code of conduct:<br>
<a href="https://github.com/bytecodealliance/wasmtime/blob/main/CODE_OF_CONDUCT.md">https://github.com/bytecodealliance/wasmtime/blob/main/CODE_OF_CONDUCT.md</a><br>
--&gt;</p>
</blockquote>



<a name="366628242"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%236586%20Cranelift%3A%20Adjust%20virtual%20SP%20after%20%60t.../near/366628242" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.236586.20Cranelift.3A.20Adjust.20virtual.20SP.20after.20.60t.2E.2E.2E.html#366628242">(Jun 15 2023 at 21:12)</a>:</h4>
<p><strong>fitzgen</strong> requested <a href="https://github.com/abrown">abrown</a> for a review on <a href="https://github.com/bytecodealliance/wasmtime/pull/6586">PR #6586</a>.</p>



<a name="366628243"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%236586%20Cranelift%3A%20Adjust%20virtual%20SP%20after%20%60t.../near/366628243" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.236586.20Cranelift.3A.20Adjust.20virtual.20SP.20after.20.60t.2E.2E.2E.html#366628243">(Jun 15 2023 at 21:12)</a>:</h4>
<p><strong>fitzgen</strong> requested <a href="https://github.com/orgs/bytecodealliance/teams/wasmtime-compiler-reviewers">wasmtime-compiler-reviewers</a> for a review on <a href="https://github.com/bytecodealliance/wasmtime/pull/6586">PR #6586</a>.</p>



<a name="366629739"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%236586%20Cranelift%3A%20Adjust%20virtual%20SP%20after%20%60t.../near/366629739" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.236586.20Cranelift.3A.20Adjust.20virtual.20SP.20after.20.60t.2E.2E.2E.html#366629739">(Jun 15 2023 at 21:21)</a>:</h4>
<p>fitzgen updated <a href="https://github.com/bytecodealliance/wasmtime/pull/6586">PR #6586</a>.</p>



<a name="366630718"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%236586%20Cranelift%3A%20Adjust%20virtual%20SP%20after%20%60t.../near/366630718" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.236586.20Cranelift.3A.20Adjust.20virtual.20SP.20after.20.60t.2E.2E.2E.html#366630718">(Jun 15 2023 at 21:27)</a>:</h4>
<p><strong>fitzgen</strong> requested <a href="https://github.com/cfallin">cfallin</a> for a review on <a href="https://github.com/bytecodealliance/wasmtime/pull/6586">PR #6586</a>.</p>



<a name="366631136"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%236586%20Cranelift%3A%20Adjust%20virtual%20SP%20after%20%60t.../near/366631136" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.236586.20Cranelift.3A.20Adjust.20virtual.20SP.20after.20.60t.2E.2E.2E.html#366631136">(Jun 15 2023 at 21:29)</a>:</h4>
<p>fitzgen updated <a href="https://github.com/bytecodealliance/wasmtime/pull/6586">PR #6586</a>.</p>



<a name="366635238"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%236586%20Cranelift%3A%20Adjust%20virtual%20SP%20after%20%60t.../near/366635238" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.236586.20Cranelift.3A.20Adjust.20virtual.20SP.20after.20.60t.2E.2E.2E.html#366635238">(Jun 15 2023 at 21:53)</a>:</h4>
<p>fitzgen updated <a href="https://github.com/bytecodealliance/wasmtime/pull/6586">PR #6586</a>.</p>



<a name="366636077"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%236586%20Cranelift%3A%20Adjust%20virtual%20SP%20after%20%60t.../near/366636077" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.236586.20Cranelift.3A.20Adjust.20virtual.20SP.20after.20.60t.2E.2E.2E.html#366636077">(Jun 15 2023 at 21:59)</a>:</h4>
<p>cfallin submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/6586#pullrequestreview-1482441536">PR review</a>:</p>
<blockquote>
<p>Looks right to me! Just one nit below.</p>
</blockquote>



<a name="366636078"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%236586%20Cranelift%3A%20Adjust%20virtual%20SP%20after%20%60t.../near/366636078" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.236586.20Cranelift.3A.20Adjust.20virtual.20SP.20after.20.60t.2E.2E.2E.html#366636078">(Jun 15 2023 at 21:59)</a>:</h4>
<p>cfallin submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/6586#pullrequestreview-1482441536">PR review</a>:</p>
<blockquote>
<p>Looks right to me! Just one nit below.</p>
</blockquote>



<a name="366636079"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%236586%20Cranelift%3A%20Adjust%20virtual%20SP%20after%20%60t.../near/366636079" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.236586.20Cranelift.3A.20Adjust.20virtual.20SP.20after.20.60t.2E.2E.2E.html#366636079">(Jun 15 2023 at 21:59)</a>:</h4>
<p>cfallin created <a href="https://github.com/bytecodealliance/wasmtime/pull/6586#discussion_r1231571909">PR review comment</a>:</p>
<blockquote>
<p>Accidentally left this in from debugging?</p>
<p>(Aside: this seems to be really easy to do; we had it slip into a release previously; perhaps we could add a grep or something to a CI check-job to make sure we don't regress again?)</p>
</blockquote>



<a name="366637162"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%236586%20Cranelift%3A%20Adjust%20virtual%20SP%20after%20%60t.../near/366637162" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.236586.20Cranelift.3A.20Adjust.20virtual.20SP.20after.20.60t.2E.2E.2E.html#366637162">(Jun 15 2023 at 22:05)</a>:</h4>
<p>jameysharp created <a href="https://github.com/bytecodealliance/wasmtime/pull/6586#discussion_r1231582600">PR review comment</a>:</p>
<blockquote>
<p>I objected to this change during pair programming but Nick convinced me that since the cranelift tools are not performance critical it's actually more useful to leave this always-on in that specific case.</p>
</blockquote>



<a name="366641200"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%236586%20Cranelift%3A%20Adjust%20virtual%20SP%20after%20%60t.../near/366641200" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.236586.20Cranelift.3A.20Adjust.20virtual.20SP.20after.20.60t.2E.2E.2E.html#366641200">(Jun 15 2023 at 22:33)</a>:</h4>
<p>fitzgen created <a href="https://github.com/bytecodealliance/wasmtime/pull/6586#discussion_r1231598590">PR review comment</a>:</p>
<blockquote>
<p>This was intentional because <code>clif-util</code> is a debugging tool, so it should enable our debugging-related Cargo features. It isn't changing anything about the default features for <code>cranelift-codegen</code> itself.</p>
</blockquote>



<a name="366643931"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%236586%20Cranelift%3A%20Adjust%20virtual%20SP%20after%20%60t.../near/366643931" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.236586.20Cranelift.3A.20Adjust.20virtual.20SP.20after.20.60t.2E.2E.2E.html#366643931">(Jun 15 2023 at 22:52)</a>:</h4>
<p>cfallin created <a href="https://github.com/bytecodealliance/wasmtime/pull/6586#discussion_r1231607084">PR review comment</a>:</p>
<blockquote>
<p>Ah, this is for the CLI crate only; I see. Yeah, I think that's actually a useful change.</p>
</blockquote>



<a name="366665827"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%236586%20Cranelift%3A%20Adjust%20virtual%20SP%20after%20%60t.../near/366665827" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.236586.20Cranelift.3A.20Adjust.20virtual.20SP.20after.20.60t.2E.2E.2E.html#366665827">(Jun 16 2023 at 01:49)</a>:</h4>
<p>fitzgen merged <a href="https://github.com/bytecodealliance/wasmtime/pull/6586">PR #6586</a>.</p>



<hr><p>Last updated: Jan 20 2025 at 06:04 UTC</p>
</html>