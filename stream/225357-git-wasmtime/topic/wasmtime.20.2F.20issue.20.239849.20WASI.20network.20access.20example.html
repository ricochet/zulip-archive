<html>
<head><meta charset="utf-8"><title>wasmtime / issue #9849 WASI network access example · git-wasmtime · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/index.html">git-wasmtime</a></h2>
<h3>Topic: <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.239849.20WASI.20network.20access.20example.html">wasmtime / issue #9849 WASI network access example</a></h3>

<hr>

<base href="https://bytecodealliance.zulipchat.com">

<head><link href="https://bytecodealliance.github.io/zulip-archive/style.css" rel="stylesheet"></head>

<a name="489735797"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%239849%20WASI%20network%20access%20example/near/489735797" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.239849.20WASI.20network.20access.20example.html#489735797">(Dec 18 2024 at 11:28)</a>:</h4>
<p>JMLX42 edited <a href="https://github.com/bytecodealliance/wasmtime/issues/9849">issue #9849</a>:</p>
<blockquote>
<p>Hello,</p>
<p>I am trying to use <code>container2wasm</code> to run a Linux VM inside <code>wasmtime</code>. Here is my code:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="cp">#[tokio::main]</span>
<span class="k">async</span><span class="w"> </span><span class="k">fn</span><span class="w"> </span><span class="nf">main</span><span class="p">()</span><span class="w"> </span><span class="p">-&gt;</span><span class="w"> </span><span class="nb">Result</span><span class="o">&lt;</span><span class="p">(),</span><span class="w"> </span><span class="nb">Box</span><span class="o">&lt;</span><span class="k">dyn</span><span class="w"> </span><span class="n">Error</span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="c1">// Create a new Wasmtime engine and store with unit data.</span>
<span class="w">    </span><span class="c1">// Construct the wasm engine with async support enabled.</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">config</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Config</span><span class="p">::</span><span class="n">new</span><span class="p">();</span>
<span class="w">    </span><span class="n">config</span><span class="p">.</span><span class="n">async_support</span><span class="p">(</span><span class="kc">true</span><span class="p">);</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">engine</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Engine</span><span class="p">::</span><span class="n">new</span><span class="p">(</span><span class="o">&amp;</span><span class="n">config</span><span class="p">)</span><span class="o">?</span><span class="p">;</span>

<span class="w">    </span><span class="c1">// Embed the WebAssembly module into the binary.</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">wasm_bytes</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="fm">include_bytes!</span><span class="p">(</span><span class="s">"../images/ubuntu:22.04.wasm"</span><span class="p">);</span>

<span class="w">    </span><span class="c1">// Create a linker to link the WASI module.</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">linker</span><span class="p">:</span><span class="w"> </span><span class="nc">Linker</span><span class="o">&lt;</span><span class="n">WasiP1Ctx</span><span class="o">&gt;</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Linker</span><span class="p">::</span><span class="n">new</span><span class="p">(</span><span class="o">&amp;</span><span class="n">engine</span><span class="p">);</span>
<span class="w">    </span><span class="n">preview1</span><span class="p">::</span><span class="n">add_to_linker_async</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="n">linker</span><span class="p">,</span><span class="w"> </span><span class="o">|</span><span class="n">t</span><span class="o">|</span><span class="w"> </span><span class="n">t</span><span class="p">)</span><span class="o">?</span><span class="p">;</span>

<span class="w">    </span><span class="c1">// Create a WASI context and put it in a Store; all instances in the store</span>
<span class="w">    </span><span class="c1">// share this context. `WasiCtxBuilder` provides a number of ways to</span>
<span class="w">    </span><span class="c1">// configure what the target program will have access to.</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">wasi_ctx</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">WasiCtxBuilder</span><span class="p">::</span><span class="n">new</span><span class="p">()</span>
<span class="w">        </span><span class="p">.</span><span class="n">inherit_stdio</span><span class="p">()</span>
<span class="w">        </span><span class="p">.</span><span class="n">inherit_network</span><span class="p">()</span>
<span class="w">        </span><span class="p">.</span><span class="n">socket_addr_check</span><span class="p">(</span><span class="o">|</span><span class="n">_</span><span class="p">,</span><span class="w"> </span><span class="n">_</span><span class="o">|</span><span class="w"> </span><span class="nb">Box</span><span class="p">::</span><span class="n">pin</span><span class="p">(</span><span class="n">ready</span><span class="p">(</span><span class="kc">true</span><span class="p">)))</span>
<span class="w">        </span><span class="p">.</span><span class="n">allow_ip_name_lookup</span><span class="p">(</span><span class="kc">true</span><span class="p">)</span>
<span class="w">        </span><span class="p">.</span><span class="n">allow_tcp</span><span class="p">(</span><span class="kc">true</span><span class="p">)</span>
<span class="w">        </span><span class="p">.</span><span class="n">allow_udp</span><span class="p">(</span><span class="kc">true</span><span class="p">)</span>
<span class="w">        </span><span class="p">.</span><span class="n">build_p1</span><span class="p">();</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">store</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Store</span><span class="p">::</span><span class="n">new</span><span class="p">(</span><span class="o">&amp;</span><span class="n">engine</span><span class="p">,</span><span class="w"> </span><span class="n">wasi_ctx</span><span class="p">);</span>

<span class="w">    </span><span class="c1">// Load the WebAssembly module from the embedded bytes.</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">module</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Module</span><span class="p">::</span><span class="n">new</span><span class="p">(</span><span class="o">&amp;</span><span class="n">engine</span><span class="p">,</span><span class="w"> </span><span class="n">wasm_bytes</span><span class="p">)</span><span class="o">?</span><span class="p">;</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">func</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">linker</span>
<span class="w">        </span><span class="p">.</span><span class="n">module_async</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="n">store</span><span class="p">,</span><span class="w"> </span><span class="s">""</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">module</span><span class="p">)</span>
<span class="w">        </span><span class="p">.</span><span class="k">await</span><span class="o">?</span>
<span class="w">        </span><span class="p">.</span><span class="n">get_default</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="n">store</span><span class="p">,</span><span class="w"> </span><span class="s">""</span><span class="p">)</span><span class="o">?</span>
<span class="w">        </span><span class="p">.</span><span class="n">typed</span><span class="p">::</span><span class="o">&lt;</span><span class="p">(),</span><span class="w"> </span><span class="p">()</span><span class="o">&gt;</span><span class="p">(</span><span class="o">&amp;</span><span class="n">store</span><span class="p">)</span><span class="o">?</span><span class="p">;</span>

<span class="w">    </span><span class="c1">// Create an instance of the module with a mutable store.</span>
<span class="w">    </span><span class="n">func</span><span class="p">.</span><span class="n">call_async</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="n">store</span><span class="p">,</span><span class="w"> </span><span class="p">()).</span><span class="k">await</span><span class="o">?</span><span class="p">;</span>

<span class="w">    </span><span class="nb">Ok</span><span class="p">(())</span>
<span class="p">}</span>
</code></pre></div>
<p>It works great and I have access to a shell/prompt. But for some reason, network requests fail:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="cp">$</span><span class="w"> </span><span class="n">cargo</span><span class="w"> </span><span class="n">run</span><span class="w"> </span><span class="o">--</span><span class="n">release</span>
<span class="w">    </span><span class="n">Finished</span><span class="w"> </span><span class="err">`</span><span class="n">release</span><span class="err">`</span><span class="w"> </span><span class="n">profile</span><span class="w"> </span><span class="p">[</span><span class="n">optimized</span><span class="p">]</span><span class="w"> </span><span class="n">target</span><span class="p">(</span><span class="n">s</span><span class="p">)</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="mf">0.07</span><span class="n">s</span>
<span class="w">     </span><span class="n">Running</span><span class="w"> </span><span class="err">`</span><span class="n">target</span><span class="o">/</span><span class="n">release</span><span class="o">/</span><span class="n">prositronic</span><span class="err">`</span>
<span class="n">root</span><span class="o">@</span><span class="n">localhost</span><span class="p">:</span><span class="o">/</span><span class="p">#</span><span class="w"> </span><span class="n">apt</span><span class="o">-</span><span class="n">get</span><span class="w"> </span><span class="n">update</span>
<span class="n">apt</span><span class="o">-</span><span class="n">get</span><span class="w"> </span><span class="n">update</span>
<span class="n">Ign</span><span class="p">:</span><span class="mi">1</span><span class="w"> </span><span class="n">http</span><span class="p">:</span><span class="c1">//security.ubuntu.com/ubuntu jammy-security InRelease</span>
<span class="n">Ign</span><span class="p">:</span><span class="mi">2</span><span class="w"> </span><span class="n">http</span><span class="p">:</span><span class="c1">//archive.ubuntu.com/ubuntu jammy InRelease</span>
<span class="n">Ign</span><span class="p">:</span><span class="mi">3</span><span class="w"> </span><span class="n">http</span><span class="p">:</span><span class="c1">//archive.ubuntu.com/ubuntu jammy-updates InRelease</span>
<span class="n">Ign</span><span class="p">:</span><span class="mi">4</span><span class="w"> </span><span class="n">http</span><span class="p">:</span><span class="c1">//archive.ubuntu.com/ubuntu jammy-backports InRelease</span>
<span class="n">Ign</span><span class="p">:</span><span class="mi">1</span><span class="w"> </span><span class="n">http</span><span class="p">:</span><span class="c1">//security.ubuntu.com/ubuntu jammy-security InRelease</span>
<span class="n">Ign</span><span class="p">:</span><span class="mi">2</span><span class="w"> </span><span class="n">http</span><span class="p">:</span><span class="c1">//archive.ubuntu.com/ubuntu jammy InRelease</span>
<span class="n">Ign</span><span class="p">:</span><span class="mi">3</span><span class="w"> </span><span class="n">http</span><span class="p">:</span><span class="c1">//archive.ubuntu.com/ubuntu jammy-updates InRelease</span>
<span class="n">Ign</span><span class="p">:</span><span class="mi">4</span><span class="w"> </span><span class="n">http</span><span class="p">:</span><span class="c1">//archive.ubuntu.com/ubuntu jammy-backports InRelease</span>
<span class="n">Ign</span><span class="p">:</span><span class="mi">2</span><span class="w"> </span><span class="n">http</span><span class="p">:</span><span class="c1">//archive.ubuntu.com/ubuntu jammy InRelease</span>
<span class="n">Ign</span><span class="p">:</span><span class="mi">1</span><span class="w"> </span><span class="n">http</span><span class="p">:</span><span class="c1">//security.ubuntu.com/ubuntu jammy-security InRelease</span>
<span class="n">Ign</span><span class="p">:</span><span class="mi">3</span><span class="w"> </span><span class="n">http</span><span class="p">:</span><span class="c1">//archive.ubuntu.com/ubuntu jammy-updates InRelease</span>
<span class="n">Ign</span><span class="p">:</span><span class="mi">4</span><span class="w"> </span><span class="n">http</span><span class="p">:</span><span class="c1">//archive.ubuntu.com/ubuntu jammy-backports InRelease</span>
<span class="nb">Err</span><span class="p">:</span><span class="mi">1</span><span class="w"> </span><span class="n">http</span><span class="p">:</span><span class="c1">//security.ubuntu.com/ubuntu jammy-security InRelease</span>
<span class="w">  </span><span class="n">Temporary</span><span class="w"> </span><span class="n">failure</span><span class="w"> </span><span class="n">resolving</span><span class="w"> </span><span class="o">'</span><span class="na">security</span><span class="p">.</span><span class="n">ubuntu</span><span class="p">.</span><span class="n">com</span><span class="o">'</span>
<span class="nb">Err</span><span class="p">:</span><span class="mi">2</span><span class="w"> </span><span class="n">http</span><span class="p">:</span><span class="c1">//archive.ubuntu.com/ubuntu jammy InRelease</span>
<span class="w">  </span><span class="n">Temporary</span><span class="w"> </span><span class="n">failure</span><span class="w"> </span><span class="n">resolving</span><span class="w"> </span><span class="o">'</span><span class="na">archive</span><span class="p">.</span><span class="n">ubuntu</span><span class="p">.</span><span class="n">com</span><span class="o">'</span>
<span class="nb">Err</span><span class="p">:</span><span class="mi">3</span><span class="w"> </span><span class="n">http</span><span class="p">:</span><span class="c1">//archive.ubuntu.com/ubuntu jammy-updates InRelease</span>
<span class="w">  </span><span class="n">Temporary</span><span class="w"> </span><span class="n">failure</span><span class="w"> </span><span class="n">resolving</span><span class="w"> </span><span class="o">'</span><span class="na">archive</span><span class="p">.</span><span class="n">ubuntu</span><span class="p">.</span><span class="n">com</span><span class="o">'</span>
<span class="nb">Err</span><span class="p">:</span><span class="mi">4</span><span class="w"> </span><span class="n">http</span><span class="p">:</span><span class="c1">//archive.ubuntu.com/ubuntu jammy-backports InRelease</span>
<span class="w">  </span><span class="n">Temporary</span><span class="w"> </span><span class="n">failure</span><span class="w"> </span><span class="n">resolving</span><span class="w"> </span><span class="o">'</span><span class="na">archive</span><span class="p">.</span><span class="n">ubuntu</span><span class="p">.</span><span class="n">com</span><span class="o">'</span>
<span class="n">Reading</span><span class="w"> </span><span class="n">package</span><span class="w"> </span><span class="n">lists</span><span class="o">..</span><span class="p">.</span><span class="w"> </span><span class="n">Done</span>
<span class="n">W</span><span class="p">:</span><span class="w"> </span><span class="nc">Failed</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">fetch</span><span class="w"> </span><span class="n">http</span><span class="p">:</span><span class="c1">//archive.ubuntu.com/ubuntu/dists/jammy/InRelease  Temporary failure resolving 'archive.ubuntu.com'</span>
<span class="n">W</span><span class="p">:</span><span class="w"> </span><span class="nc">Failed</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">fetch</span><span class="w"> </span><span class="n">http</span><span class="p">:</span><span class="c1">//archive.ubuntu.com/ubuntu/dists/jammy-updates/InRelease  Temporary failure resolving 'archive.ubuntu.com'</span>
<span class="n">W</span><span class="p">:</span><span class="w"> </span><span class="nc">Failed</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">fetch</span><span class="w"> </span><span class="n">http</span><span class="p">:</span><span class="c1">//archive.ubuntu.com/ubuntu/dists/jammy-backports/InRelease  Temporary failure resolving 'archive.ubuntu.com'</span>
<span class="n">W</span><span class="p">:</span><span class="w"> </span><span class="nc">Failed</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">fetch</span><span class="w"> </span><span class="n">http</span><span class="p">:</span><span class="c1">//security.ubuntu.com/ubuntu/dists/jammy-security/InRelease  Temporary failure resolving 'security.ubuntu.com'</span>
<span class="n">W</span><span class="p">:</span><span class="w"> </span><span class="nb">Some</span><span class="w"> </span><span class="nc">index</span><span class="w"> </span><span class="n">files</span><span class="w"> </span><span class="n">failed</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">download</span><span class="p">.</span><span class="w"> </span><span class="n">They</span><span class="w"> </span><span class="n">have</span><span class="w"> </span><span class="n">been</span><span class="w"> </span><span class="n">ignored</span><span class="p">,</span><span class="w"> </span><span class="n">or</span><span class="w"> </span><span class="n">old</span><span class="w"> </span><span class="n">ones</span><span class="w"> </span><span class="n">used</span><span class="w"> </span><span class="n">instead</span><span class="p">.</span>
<span class="n">root</span><span class="o">@</span><span class="n">localhost</span><span class="p">:</span><span class="o">/</span><span class="p">#</span>
</code></pre></div>
<p>What am I missing?</p>
</blockquote>



<a name="489776328"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%239849%20WASI%20network%20access%20example/near/489776328" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.239849.20WASI.20network.20access.20example.html#489776328">(Dec 18 2024 at 15:01)</a>:</h4>
<p>bjorn3 <a href="https://github.com/bytecodealliance/wasmtime/issues/9849#issuecomment-2551553682">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/9849">issue #9849</a>:</p>
<blockquote>
<p>container2wasm only supports networking through the use of a helper program c2w-net running on the host as native program: <a href="https://github.com/ktock/container2wasm/tree/main/examples/networking/wasi">https://github.com/ktock/container2wasm/tree/main/examples/networking/wasi</a> It looks like container2wasm targets wasip1 which only supports exposing a server over the network listening at a wasm runtime defined port (which c2w-net seems to take advantage of). You need wasip2 to be able to actually connect to arbitrary servers without a proxy like c2w-net.</p>
</blockquote>



<a name="489776986"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%239849%20WASI%20network%20access%20example/near/489776986" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.239849.20WASI.20network.20access.20example.html#489776986">(Dec 18 2024 at 15:04)</a>:</h4>
<p>JMLX42 <a href="https://github.com/bytecodealliance/wasmtime/issues/9849#issuecomment-2551559675">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/9849">issue #9849</a>:</p>
<blockquote>
<p>@bjorn3 thank you for your quick response!</p>
<blockquote>
<p>You need wasip2 to be able to actually connect to arbitrary servers</p>
</blockquote>
<p>How do I do that? I thought my code was already already targeting preview2</p>
</blockquote>



<a name="489777885"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%239849%20WASI%20network%20access%20example/near/489777885" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.239849.20WASI.20network.20access.20example.html#489777885">(Dec 18 2024 at 15:08)</a>:</h4>
<p>bjorn3 <a href="https://github.com/bytecodealliance/wasmtime/issues/9849#issuecomment-2551569483">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/9849">issue #9849</a>:</p>
<blockquote>
<p>Container2wasm doesn't use wasip2. You did have to ask the maintainer of container2wasm to add wasip2 support.</p>
</blockquote>



<a name="489779399"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%239849%20WASI%20network%20access%20example/near/489779399" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.239849.20WASI.20network.20access.20example.html#489779399">(Dec 18 2024 at 15:14)</a>:</h4>
<p>JMLX42 <a href="https://github.com/bytecodealliance/wasmtime/issues/9849#issuecomment-2551585323">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/9849">issue #9849</a>:</p>
<blockquote>
<blockquote>
<p>You did have to ask the maintainer of container2wasm to add wasip2 support.</p>
</blockquote>
<p>@bjorn3 so you mean my code is fine and supports preview 2, but the loaded WASM module produced by converter2wasm does <em>not</em> support preview2 ?</p>
</blockquote>



<a name="489779548"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%239849%20WASI%20network%20access%20example/near/489779548" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.239849.20WASI.20network.20access.20example.html#489779548">(Dec 18 2024 at 15:15)</a>:</h4>
<p>JMLX42 edited a <a href="https://github.com/bytecodealliance/wasmtime/issues/9849#issuecomment-2551585323">comment</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/9849">issue #9849</a>:</p>
<blockquote>
<blockquote>
<p>You did have to ask the maintainer of container2wasm to add wasip2 support.</p>
</blockquote>
<p>@bjorn3 so you mean my code is fine and supports preview 2, but the loaded WASM module produced by <code>container2wasm</code> does <em>not</em> support preview2 ?</p>
</blockquote>



<a name="489781057"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%239849%20WASI%20network%20access%20example/near/489781057" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.239849.20WASI.20network.20access.20example.html#489781057">(Dec 18 2024 at 15:21)</a>:</h4>
<p>bjorn3 <a href="https://github.com/bytecodealliance/wasmtime/issues/9849#issuecomment-2551603293">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/9849">issue #9849</a>:</p>
<blockquote>
<blockquote>
<p>but the loaded WASM module produced by container2wasm does not support preview2 ?</p>
</blockquote>
<p>Indeed. container2wasm produces wasip1 rather than wasip2 wasm modules.</p>
<blockquote>
<p>so you mean my code is fine and supports preview 2</p>
</blockquote>
<p>You need different code to load wasip1 and wasip2 modules. Your current code is correct for wasip1, but once container2wasm supports producing wasip2 modules, you will need some changes to load the wasip2 module.</p>
</blockquote>



<a name="489781494"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%239849%20WASI%20network%20access%20example/near/489781494" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.239849.20WASI.20network.20access.20example.html#489781494">(Dec 18 2024 at 15:23)</a>:</h4>
<p>JMLX42 <a href="https://github.com/bytecodealliance/wasmtime/issues/9849#issuecomment-2551608463">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/9849">issue #9849</a>:</p>
<blockquote>
<blockquote>
<p>you will need some changes to load the wasip2 module.</p>
</blockquote>
<p>@bjorn3 are there any examples for wasip2?</p>
</blockquote>



<a name="489782053"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%239849%20WASI%20network%20access%20example/near/489782053" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.239849.20WASI.20network.20access.20example.html#489782053">(Dec 18 2024 at 15:26)</a>:</h4>
<p>dicej <a href="https://github.com/bytecodealliance/wasmtime/issues/9849#issuecomment-2551614108">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/9849">issue #9849</a>:</p>
<blockquote>
<p><a href="https://github.com/bytecodealliance/wasmtime/pull/9788">This PR</a> updates the WASI example in this repo to wasip2.</p>
</blockquote>



<a name="489822093"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%239849%20WASI%20network%20access%20example/near/489822093" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.239849.20WASI.20network.20access.20example.html#489822093">(Dec 18 2024 at 18:54)</a>:</h4>
<p>alexcrichton closed <a href="https://github.com/bytecodealliance/wasmtime/issues/9849">issue #9849</a>:</p>
<blockquote>
<p>Hello,</p>
<p>I am trying to use <code>container2wasm</code> to run a Linux VM inside <code>wasmtime</code>. Here is my code:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="cp">#[tokio::main]</span>
<span class="k">async</span><span class="w"> </span><span class="k">fn</span><span class="w"> </span><span class="nf">main</span><span class="p">()</span><span class="w"> </span><span class="p">-&gt;</span><span class="w"> </span><span class="nb">Result</span><span class="o">&lt;</span><span class="p">(),</span><span class="w"> </span><span class="nb">Box</span><span class="o">&lt;</span><span class="k">dyn</span><span class="w"> </span><span class="n">Error</span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="c1">// Create a new Wasmtime engine and store with unit data.</span>
<span class="w">    </span><span class="c1">// Construct the wasm engine with async support enabled.</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">config</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Config</span><span class="p">::</span><span class="n">new</span><span class="p">();</span>
<span class="w">    </span><span class="n">config</span><span class="p">.</span><span class="n">async_support</span><span class="p">(</span><span class="kc">true</span><span class="p">);</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">engine</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Engine</span><span class="p">::</span><span class="n">new</span><span class="p">(</span><span class="o">&amp;</span><span class="n">config</span><span class="p">)</span><span class="o">?</span><span class="p">;</span>

<span class="w">    </span><span class="c1">// Embed the WebAssembly module into the binary.</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">wasm_bytes</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="fm">include_bytes!</span><span class="p">(</span><span class="s">"../images/ubuntu:22.04.wasm"</span><span class="p">);</span>

<span class="w">    </span><span class="c1">// Create a linker to link the WASI module.</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">linker</span><span class="p">:</span><span class="w"> </span><span class="nc">Linker</span><span class="o">&lt;</span><span class="n">WasiP1Ctx</span><span class="o">&gt;</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Linker</span><span class="p">::</span><span class="n">new</span><span class="p">(</span><span class="o">&amp;</span><span class="n">engine</span><span class="p">);</span>
<span class="w">    </span><span class="n">preview1</span><span class="p">::</span><span class="n">add_to_linker_async</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="n">linker</span><span class="p">,</span><span class="w"> </span><span class="o">|</span><span class="n">t</span><span class="o">|</span><span class="w"> </span><span class="n">t</span><span class="p">)</span><span class="o">?</span><span class="p">;</span>

<span class="w">    </span><span class="c1">// Create a WASI context and put it in a Store; all instances in the store</span>
<span class="w">    </span><span class="c1">// share this context. `WasiCtxBuilder` provides a number of ways to</span>
<span class="w">    </span><span class="c1">// configure what the target program will have access to.</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">wasi_ctx</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">WasiCtxBuilder</span><span class="p">::</span><span class="n">new</span><span class="p">()</span>
<span class="w">        </span><span class="p">.</span><span class="n">inherit_stdio</span><span class="p">()</span>
<span class="w">        </span><span class="p">.</span><span class="n">inherit_network</span><span class="p">()</span>
<span class="w">        </span><span class="p">.</span><span class="n">socket_addr_check</span><span class="p">(</span><span class="o">|</span><span class="n">_</span><span class="p">,</span><span class="w"> </span><span class="n">_</span><span class="o">|</span><span class="w"> </span><span class="nb">Box</span><span class="p">::</span><span class="n">pin</span><span class="p">(</span><span class="n">ready</span><span class="p">(</span><span class="kc">true</span><span class="p">)))</span>
<span class="w">        </span><span class="p">.</span><span class="n">allow_ip_name_lookup</span><span class="p">(</span><span class="kc">true</span><span class="p">)</span>
<span class="w">        </span><span class="p">.</span><span class="n">allow_tcp</span><span class="p">(</span><span class="kc">true</span><span class="p">)</span>
<span class="w">        </span><span class="p">.</span><span class="n">allow_udp</span><span class="p">(</span><span class="kc">true</span><span class="p">)</span>
<span class="w">        </span><span class="p">.</span><span class="n">build_p1</span><span class="p">();</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">store</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Store</span><span class="p">::</span><span class="n">new</span><span class="p">(</span><span class="o">&amp;</span><span class="n">engine</span><span class="p">,</span><span class="w"> </span><span class="n">wasi_ctx</span><span class="p">);</span>

<span class="w">    </span><span class="c1">// Load the WebAssembly module from the embedded bytes.</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">module</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Module</span><span class="p">::</span><span class="n">new</span><span class="p">(</span><span class="o">&amp;</span><span class="n">engine</span><span class="p">,</span><span class="w"> </span><span class="n">wasm_bytes</span><span class="p">)</span><span class="o">?</span><span class="p">;</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">func</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">linker</span>
<span class="w">        </span><span class="p">.</span><span class="n">module_async</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="n">store</span><span class="p">,</span><span class="w"> </span><span class="s">""</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">module</span><span class="p">)</span>
<span class="w">        </span><span class="p">.</span><span class="k">await</span><span class="o">?</span>
<span class="w">        </span><span class="p">.</span><span class="n">get_default</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="n">store</span><span class="p">,</span><span class="w"> </span><span class="s">""</span><span class="p">)</span><span class="o">?</span>
<span class="w">        </span><span class="p">.</span><span class="n">typed</span><span class="p">::</span><span class="o">&lt;</span><span class="p">(),</span><span class="w"> </span><span class="p">()</span><span class="o">&gt;</span><span class="p">(</span><span class="o">&amp;</span><span class="n">store</span><span class="p">)</span><span class="o">?</span><span class="p">;</span>

<span class="w">    </span><span class="c1">// Create an instance of the module with a mutable store.</span>
<span class="w">    </span><span class="n">func</span><span class="p">.</span><span class="n">call_async</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="n">store</span><span class="p">,</span><span class="w"> </span><span class="p">()).</span><span class="k">await</span><span class="o">?</span><span class="p">;</span>

<span class="w">    </span><span class="nb">Ok</span><span class="p">(())</span>
<span class="p">}</span>
</code></pre></div>
<p>It works great and I have access to a shell/prompt. But for some reason, network requests fail:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="cp">$</span><span class="w"> </span><span class="n">cargo</span><span class="w"> </span><span class="n">run</span><span class="w"> </span><span class="o">--</span><span class="n">release</span>
<span class="w">    </span><span class="n">Finished</span><span class="w"> </span><span class="err">`</span><span class="n">release</span><span class="err">`</span><span class="w"> </span><span class="n">profile</span><span class="w"> </span><span class="p">[</span><span class="n">optimized</span><span class="p">]</span><span class="w"> </span><span class="n">target</span><span class="p">(</span><span class="n">s</span><span class="p">)</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="mf">0.07</span><span class="n">s</span>
<span class="w">     </span><span class="n">Running</span><span class="w"> </span><span class="err">`</span><span class="n">target</span><span class="o">/</span><span class="n">release</span><span class="o">/</span><span class="n">prositronic</span><span class="err">`</span>
<span class="n">root</span><span class="o">@</span><span class="n">localhost</span><span class="p">:</span><span class="o">/</span><span class="p">#</span><span class="w"> </span><span class="n">apt</span><span class="o">-</span><span class="n">get</span><span class="w"> </span><span class="n">update</span>
<span class="n">apt</span><span class="o">-</span><span class="n">get</span><span class="w"> </span><span class="n">update</span>
<span class="n">Ign</span><span class="p">:</span><span class="mi">1</span><span class="w"> </span><span class="n">http</span><span class="p">:</span><span class="c1">//security.ubuntu.com/ubuntu jammy-security InRelease</span>
<span class="n">Ign</span><span class="p">:</span><span class="mi">2</span><span class="w"> </span><span class="n">http</span><span class="p">:</span><span class="c1">//archive.ubuntu.com/ubuntu jammy InRelease</span>
<span class="n">Ign</span><span class="p">:</span><span class="mi">3</span><span class="w"> </span><span class="n">http</span><span class="p">:</span><span class="c1">//archive.ubuntu.com/ubuntu jammy-updates InRelease</span>
<span class="n">Ign</span><span class="p">:</span><span class="mi">4</span><span class="w"> </span><span class="n">http</span><span class="p">:</span><span class="c1">//archive.ubuntu.com/ubuntu jammy-backports InRelease</span>
<span class="n">Ign</span><span class="p">:</span><span class="mi">1</span><span class="w"> </span><span class="n">http</span><span class="p">:</span><span class="c1">//security.ubuntu.com/ubuntu jammy-security InRelease</span>
<span class="n">Ign</span><span class="p">:</span><span class="mi">2</span><span class="w"> </span><span class="n">http</span><span class="p">:</span><span class="c1">//archive.ubuntu.com/ubuntu jammy InRelease</span>
<span class="n">Ign</span><span class="p">:</span><span class="mi">3</span><span class="w"> </span><span class="n">http</span><span class="p">:</span><span class="c1">//archive.ubuntu.com/ubuntu jammy-updates InRelease</span>
<span class="n">Ign</span><span class="p">:</span><span class="mi">4</span><span class="w"> </span><span class="n">http</span><span class="p">:</span><span class="c1">//archive.ubuntu.com/ubuntu jammy-backports InRelease</span>
<span class="n">Ign</span><span class="p">:</span><span class="mi">2</span><span class="w"> </span><span class="n">http</span><span class="p">:</span><span class="c1">//archive.ubuntu.com/ubuntu jammy InRelease</span>
<span class="n">Ign</span><span class="p">:</span><span class="mi">1</span><span class="w"> </span><span class="n">http</span><span class="p">:</span><span class="c1">//security.ubuntu.com/ubuntu jammy-security InRelease</span>
<span class="n">Ign</span><span class="p">:</span><span class="mi">3</span><span class="w"> </span><span class="n">http</span><span class="p">:</span><span class="c1">//archive.ubuntu.com/ubuntu jammy-updates InRelease</span>
<span class="n">Ign</span><span class="p">:</span><span class="mi">4</span><span class="w"> </span><span class="n">http</span><span class="p">:</span><span class="c1">//archive.ubuntu.com/ubuntu jammy-backports InRelease</span>
<span class="nb">Err</span><span class="p">:</span><span class="mi">1</span><span class="w"> </span><span class="n">http</span><span class="p">:</span><span class="c1">//security.ubuntu.com/ubuntu jammy-security InRelease</span>
<span class="w">  </span><span class="n">Temporary</span><span class="w"> </span><span class="n">failure</span><span class="w"> </span><span class="n">resolving</span><span class="w"> </span><span class="o">'</span><span class="na">security</span><span class="p">.</span><span class="n">ubuntu</span><span class="p">.</span><span class="n">com</span><span class="o">'</span>
<span class="nb">Err</span><span class="p">:</span><span class="mi">2</span><span class="w"> </span><span class="n">http</span><span class="p">:</span><span class="c1">//archive.ubuntu.com/ubuntu jammy InRelease</span>
<span class="w">  </span><span class="n">Temporary</span><span class="w"> </span><span class="n">failure</span><span class="w"> </span><span class="n">resolving</span><span class="w"> </span><span class="o">'</span><span class="na">archive</span><span class="p">.</span><span class="n">ubuntu</span><span class="p">.</span><span class="n">com</span><span class="o">'</span>
<span class="nb">Err</span><span class="p">:</span><span class="mi">3</span><span class="w"> </span><span class="n">http</span><span class="p">:</span><span class="c1">//archive.ubuntu.com/ubuntu jammy-updates InRelease</span>
<span class="w">  </span><span class="n">Temporary</span><span class="w"> </span><span class="n">failure</span><span class="w"> </span><span class="n">resolving</span><span class="w"> </span><span class="o">'</span><span class="na">archive</span><span class="p">.</span><span class="n">ubuntu</span><span class="p">.</span><span class="n">com</span><span class="o">'</span>
<span class="nb">Err</span><span class="p">:</span><span class="mi">4</span><span class="w"> </span><span class="n">http</span><span class="p">:</span><span class="c1">//archive.ubuntu.com/ubuntu jammy-backports InRelease</span>
<span class="w">  </span><span class="n">Temporary</span><span class="w"> </span><span class="n">failure</span><span class="w"> </span><span class="n">resolving</span><span class="w"> </span><span class="o">'</span><span class="na">archive</span><span class="p">.</span><span class="n">ubuntu</span><span class="p">.</span><span class="n">com</span><span class="o">'</span>
<span class="n">Reading</span><span class="w"> </span><span class="n">package</span><span class="w"> </span><span class="n">lists</span><span class="o">..</span><span class="p">.</span><span class="w"> </span><span class="n">Done</span>
<span class="n">W</span><span class="p">:</span><span class="w"> </span><span class="nc">Failed</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">fetch</span><span class="w"> </span><span class="n">http</span><span class="p">:</span><span class="c1">//archive.ubuntu.com/ubuntu/dists/jammy/InRelease  Temporary failure resolving 'archive.ubuntu.com'</span>
<span class="n">W</span><span class="p">:</span><span class="w"> </span><span class="nc">Failed</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">fetch</span><span class="w"> </span><span class="n">http</span><span class="p">:</span><span class="c1">//archive.ubuntu.com/ubuntu/dists/jammy-updates/InRelease  Temporary failure resolving 'archive.ubuntu.com'</span>
<span class="n">W</span><span class="p">:</span><span class="w"> </span><span class="nc">Failed</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">fetch</span><span class="w"> </span><span class="n">http</span><span class="p">:</span><span class="c1">//archive.ubuntu.com/ubuntu/dists/jammy-backports/InRelease  Temporary failure resolving 'archive.ubuntu.com'</span>
<span class="n">W</span><span class="p">:</span><span class="w"> </span><span class="nc">Failed</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">fetch</span><span class="w"> </span><span class="n">http</span><span class="p">:</span><span class="c1">//security.ubuntu.com/ubuntu/dists/jammy-security/InRelease  Temporary failure resolving 'security.ubuntu.com'</span>
<span class="n">W</span><span class="p">:</span><span class="w"> </span><span class="nb">Some</span><span class="w"> </span><span class="nc">index</span><span class="w"> </span><span class="n">files</span><span class="w"> </span><span class="n">failed</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">download</span><span class="p">.</span><span class="w"> </span><span class="n">They</span><span class="w"> </span><span class="n">have</span><span class="w"> </span><span class="n">been</span><span class="w"> </span><span class="n">ignored</span><span class="p">,</span><span class="w"> </span><span class="n">or</span><span class="w"> </span><span class="n">old</span><span class="w"> </span><span class="n">ones</span><span class="w"> </span><span class="n">used</span><span class="w"> </span><span class="n">instead</span><span class="p">.</span>
<span class="n">root</span><span class="o">@</span><span class="n">localhost</span><span class="p">:</span><span class="o">/</span><span class="p">#</span>
</code></pre></div>
<p>What am I missing?</p>
</blockquote>



<a name="489822097"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%239849%20WASI%20network%20access%20example/near/489822097" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.239849.20WASI.20network.20access.20example.html#489822097">(Dec 18 2024 at 18:54)</a>:</h4>
<p>alexcrichton <a href="https://github.com/bytecodealliance/wasmtime/issues/9849#issuecomment-2552049992">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/9849">issue #9849</a>:</p>
<blockquote>
<p>It looks like Wasmtime is performing as-expected here and while there's perhaps follow-up items with tools like <code>container2wasm</code> I'm going to close this as I don't think there's anything to track on the Wasmtime side of things. If I'm wrong though let me know!</p>
</blockquote>



<hr><p>Last updated: Jan 20 2025 at 06:04 UTC</p>
</html>