<html>
<head><meta charset="utf-8"><title>wasmtime / PR #5819 x64: Add most remaining AVX lowerings · git-wasmtime · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/index.html">git-wasmtime</a></h2>
<h3>Topic: <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.235819.20x64.3A.20Add.20most.20remaining.20AVX.20lowerings.html">wasmtime / PR #5819 x64: Add most remaining AVX lowerings</a></h3>

<hr>

<base href="https://bytecodealliance.zulipchat.com">

<head><link href="https://bytecodealliance.github.io/zulip-archive/style.css" rel="stylesheet"></head>

<a name="328521360"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%235819%20x64%3A%20Add%20most%20remaining%20AVX%20lowerings/near/328521360" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.235819.20x64.3A.20Add.20most.20remaining.20AVX.20lowerings.html#328521360">(Feb 17 2023 at 17:11)</a>:</h4>
<p>alexcrichton opened <a href="https://github.com/bytecodealliance/wasmtime/pull/5819">PR #5819</a> from <code>more-avx</code> to <code>main</code>:</p>
<blockquote>
<p>This commit goes through <code>inst.isle</code> and adds a corresponding AVX lowering for most SSE lowerings. I opted to skip instructions where the SSE lowering didn't read/modify a register, such as <code>roundps</code>. I think that AVX will benefit these instructions when there's load-merging since AVX doesn't require alignment, but I've deferred that work to a future PR.</p>
<p>Otherwise though in this PR I think all (or almost all) of the 3-operand forms of AVX instructions are supported with their SSE counterparts. This should ideally improve codegen slightly by removing register pressure and the need for <code>movdqa</code> between registers. I've attempted to ensure that there's at least one codegen test for all the new instructions.</p>
<p>As a side note, the recent capstone integration into <code>precise-output</code> tests helped me catch a number of encoding bugs much earlier than otherwise, so I've found that incredibly useful in tests!</p>
<p>&lt;!--</p>
<p>Please ensure that the following steps are all taken care of before submitting<br>
the PR.</p>
<ul>
<li>
<p>[ ] This has been discussed in issue #..., or if not, please tell us why<br>
  here.</p>
</li>
<li>
<p>[ ] A short description of what this does, why it is needed; if the<br>
  description becomes long, the matter should probably be discussed in an issue<br>
  first.</p>
</li>
<li>
<p>[ ] This PR contains test cases, if meaningful.</p>
</li>
<li>[ ] A reviewer from the core maintainer team has been assigned for this PR.<br>
  If you don't know who could review this, please indicate so. The list of<br>
  suggested reviewers on the right can help you.</li>
</ul>
<p>Please ensure all communication adheres to the <a href="https://github.com/bytecodealliance/wasmtime/blob/master/CODE_OF_CONDUCT.md">code of
conduct</a>.<br>
--&gt;<br>
</p>
</blockquote>



<a name="328533310"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%235819%20x64%3A%20Add%20most%20remaining%20AVX%20lowerings/near/328533310" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.235819.20x64.3A.20Add.20most.20remaining.20AVX.20lowerings.html#328533310">(Feb 17 2023 at 18:08)</a>:</h4>
<p>cfallin submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/5819#pullrequestreview-1303934012">PR review</a>.</p>



<a name="328533312"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%235819%20x64%3A%20Add%20most%20remaining%20AVX%20lowerings/near/328533312" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.235819.20x64.3A.20Add.20most.20remaining.20AVX.20lowerings.html#328533312">(Feb 17 2023 at 18:08)</a>:</h4>
<p>cfallin submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/5819#pullrequestreview-1303934012">PR review</a>.</p>



<a name="328533313"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%235819%20x64%3A%20Add%20most%20remaining%20AVX%20lowerings/near/328533313" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.235819.20x64.3A.20Add.20most.20remaining.20AVX.20lowerings.html#328533313">(Feb 17 2023 at 18:08)</a>:</h4>
<p>cfallin created <a href="https://github.com/bytecodealliance/wasmtime/pull/5819#discussion_r1110160028">PR review comment</a>:</p>
<blockquote>
<p>I'm not wild about the argument-dependent regalloc metadata shape here, and ideally I'd prefer us to split out variants like <code>XmmRmiRVexConst</code> that are used instead whenever the intent of an instruction is to produce a constant 0/1/whatever, and that assert the correct setup for that; but that's a separate refactor you don't necessarily need to do in this PR. Just noting as I see the existing pattern expanding...</p>
</blockquote>



<a name="328533314"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%235819%20x64%3A%20Add%20most%20remaining%20AVX%20lowerings/near/328533314" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.235819.20x64.3A.20Add.20most.20remaining.20AVX.20lowerings.html#328533314">(Feb 17 2023 at 18:08)</a>:</h4>
<p>cfallin created <a href="https://github.com/bytecodealliance/wasmtime/pull/5819#discussion_r1110137833">PR review comment</a>:</p>
<blockquote>
<p>Given that, could we split this into two enum variants, one with <code>XmmMem</code> and one with <code>GprMem</code>, to keep the type safety?</p>
</blockquote>



<a name="328541285"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%235819%20x64%3A%20Add%20most%20remaining%20AVX%20lowerings/near/328541285" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.235819.20x64.3A.20Add.20most.20remaining.20AVX.20lowerings.html#328541285">(Feb 17 2023 at 18:51)</a>:</h4>
<p>alexcrichton submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/5819#pullrequestreview-1304047360">PR review</a>.</p>



<a name="328541286"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%235819%20x64%3A%20Add%20most%20remaining%20AVX%20lowerings/near/328541286" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.235819.20x64.3A.20Add.20most.20remaining.20AVX.20lowerings.html#328541286">(Feb 17 2023 at 18:51)</a>:</h4>
<p>alexcrichton created <a href="https://github.com/bytecodealliance/wasmtime/pull/5819#discussion_r1110210841">PR review comment</a>:</p>
<blockquote>
<p>Sure, I was following <a href="https://github.com/bytecodealliance/wasmtime/blob/4fc768df36e53d1c9f42db6b3ea52af45a3dc129/cranelift/codegen/src/isa/x64/inst.isle#L356-L358">this precedent</a> but I can split out too.</p>
</blockquote>



<a name="328541410"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%235819%20x64%3A%20Add%20most%20remaining%20AVX%20lowerings/near/328541410" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.235819.20x64.3A.20Add.20most.20remaining.20AVX.20lowerings.html#328541410">(Feb 17 2023 at 18:51)</a>:</h4>
<p>alexcrichton submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/5819#pullrequestreview-1304048854">PR review</a>.</p>



<a name="328541411"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%235819%20x64%3A%20Add%20most%20remaining%20AVX%20lowerings/near/328541411" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.235819.20x64.3A.20Add.20most.20remaining.20AVX.20lowerings.html#328541411">(Feb 17 2023 at 18:51)</a>:</h4>
<p>alexcrichton created <a href="https://github.com/bytecodealliance/wasmtime/pull/5819#discussion_r1110211613">PR review comment</a>:</p>
<blockquote>
<p>Sure yeah, I was just following the preexisting pattern for the xmm instructions, but I can try to update those too in a subsequent PR.</p>
</blockquote>



<a name="328569628"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%235819%20x64%3A%20Add%20most%20remaining%20AVX%20lowerings/near/328569628" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.235819.20x64.3A.20Add.20most.20remaining.20AVX.20lowerings.html#328569628">(Feb 17 2023 at 21:50)</a>:</h4>
<p>alexcrichton updated <a href="https://github.com/bytecodealliance/wasmtime/pull/5819">PR #5819</a> from <code>more-avx</code> to <code>main</code>.</p>



<a name="328571214"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%235819%20x64%3A%20Add%20most%20remaining%20AVX%20lowerings/near/328571214" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.235819.20x64.3A.20Add.20most.20remaining.20AVX.20lowerings.html#328571214">(Feb 17 2023 at 22:02)</a>:</h4>
<p>alexcrichton updated <a href="https://github.com/bytecodealliance/wasmtime/pull/5819">PR #5819</a> from <code>more-avx</code> to <code>main</code>.</p>



<a name="328577684"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%235819%20x64%3A%20Add%20most%20remaining%20AVX%20lowerings/near/328577684" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.235819.20x64.3A.20Add.20most.20remaining.20AVX.20lowerings.html#328577684">(Feb 17 2023 at 22:51)</a>:</h4>
<p>cfallin submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/5819#pullrequestreview-1304289652">PR review</a>.</p>



<a name="328581908"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%235819%20x64%3A%20Add%20most%20remaining%20AVX%20lowerings/near/328581908" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.235819.20x64.3A.20Add.20most.20remaining.20AVX.20lowerings.html#328581908">(Feb 17 2023 at 23:28)</a>:</h4>
<p>alexcrichton updated <a href="https://github.com/bytecodealliance/wasmtime/pull/5819">PR #5819</a> from <code>more-avx</code> to <code>main</code>.</p>



<a name="329020278"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%235819%20x64%3A%20Add%20most%20remaining%20AVX%20lowerings/near/329020278" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.235819.20x64.3A.20Add.20most.20remaining.20AVX.20lowerings.html#329020278">(Feb 20 2023 at 16:19)</a>:</h4>
<p>alexcrichton merged <a href="https://github.com/bytecodealliance/wasmtime/pull/5819">PR #5819</a>.</p>



<hr><p>Last updated: Jan 20 2025 at 06:04 UTC</p>
</html>