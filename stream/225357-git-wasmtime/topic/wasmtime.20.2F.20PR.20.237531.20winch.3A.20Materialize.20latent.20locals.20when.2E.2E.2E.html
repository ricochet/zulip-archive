<html>
<head><meta charset="utf-8"><title>wasmtime / PR #7531 winch: Materialize latent locals when... · git-wasmtime · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/index.html">git-wasmtime</a></h2>
<h3>Topic: <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.237531.20winch.3A.20Materialize.20latent.20locals.20when.2E.2E.2E.html">wasmtime / PR #7531 winch: Materialize latent locals when...</a></h3>

<hr>

<base href="https://bytecodealliance.zulipchat.com">

<head><link href="https://bytecodealliance.github.io/zulip-archive/style.css" rel="stylesheet"></head>

<a name="401830533"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%237531%20winch%3A%20Materialize%20latent%20locals%20when.../near/401830533" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.237531.20winch.3A.20Materialize.20latent.20locals.20when.2E.2E.2E.html#401830533">(Nov 13 2023 at 19:22)</a>:</h4>
<p>jeffcharles opened <a href="https://github.com/bytecodealliance/wasmtime/pull/7531">PR #7531</a> from <code>jeffcharles:winch-materialize-latent-locals</code> to <code>bytecodealliance:main</code>:</p>
<blockquote>
<p>&lt;!--<br>
Please make sure you include the following information:</p>
<ul>
<li>
<p>If this work has been discussed elsewhere, please include a link to that<br>
  conversation. If it was discussed in an issue, just mention "issue #...".</p>
</li>
<li>
<p>Explain why this change is needed. If the details are in an issue already,<br>
  this can be brief.</p>
</li>
</ul>
<p>Our development process is documented in the Wasmtime book:<br>
<a href="https://docs.wasmtime.dev/contributing-development-process.html">https://docs.wasmtime.dev/contributing-development-process.html</a></p>
<p>Please ensure all communication follows the code of conduct:<br>
<a href="https://github.com/bytecodealliance/wasmtime/blob/main/CODE_OF_CONDUCT.md">https://github.com/bytecodealliance/wasmtime/blob/main/CODE_OF_CONDUCT.md</a><br>
--&gt;<br>
Winch has a bug where when setting or teeing a local, and that local is in the value stack but not at the top of the value stack, the local on the stack will pop with an incorrect value because the value of the local is determined lazily (that is, when it's needed). To address that, we can detect if the value stack contains a reference to the local that is not the top-most element, and spill registers and locals into memory if it does, which will materialize the value in the local before the value of the local is changed.</p>
</blockquote>



<a name="401830535"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%237531%20winch%3A%20Materialize%20latent%20locals%20when.../near/401830535" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.237531.20winch.3A.20Materialize.20latent.20locals.20when.2E.2E.2E.html#401830535">(Nov 13 2023 at 19:22)</a>:</h4>
<p><strong>jeffcharles</strong> requested <a href="https://github.com/orgs/bytecodealliance/teams/wasmtime-compiler-reviewers">wasmtime-compiler-reviewers</a> for a review on <a href="https://github.com/bytecodealliance/wasmtime/pull/7531">PR #7531</a>.</p>



<a name="401830536"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%237531%20winch%3A%20Materialize%20latent%20locals%20when.../near/401830536" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.237531.20winch.3A.20Materialize.20latent.20locals.20when.2E.2E.2E.html#401830536">(Nov 13 2023 at 19:22)</a>:</h4>
<p><strong>jeffcharles</strong> requested <a href="https://github.com/abrown">abrown</a> for a review on <a href="https://github.com/bytecodealliance/wasmtime/pull/7531">PR #7531</a>.</p>



<a name="401830629"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%237531%20winch%3A%20Materialize%20latent%20locals%20when.../near/401830629" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.237531.20winch.3A.20Materialize.20latent.20locals.20when.2E.2E.2E.html#401830629">(Nov 13 2023 at 19:23)</a>:</h4>
<p>jeffcharles submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/7531#pullrequestreview-1728085278">PR review</a>.</p>



<a name="401830630"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%237531%20winch%3A%20Materialize%20latent%20locals%20when.../near/401830630" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.237531.20winch.3A.20Materialize.20latent.20locals.20when.2E.2E.2E.html#401830630">(Nov 13 2023 at 19:23)</a>:</h4>
<p>jeffcharles created <a href="https://github.com/bytecodealliance/wasmtime/pull/7531#discussion_r1391584299">PR review comment</a>:</p>
<blockquote>
<p>I added this because it made some of my debugging a little easier and all the address implementations implement <code>Debug</code>.</p>
</blockquote>



<a name="401831113"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%237531%20winch%3A%20Materialize%20latent%20locals%20when.../near/401831113" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.237531.20winch.3A.20Materialize.20latent.20locals.20when.2E.2E.2E.html#401831113">(Nov 13 2023 at 19:25)</a>:</h4>
<p>jeffcharles submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/7531#pullrequestreview-1728090761">PR review</a>.</p>



<a name="401831114"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%237531%20winch%3A%20Materialize%20latent%20locals%20when.../near/401831114" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.237531.20winch.3A.20Materialize.20latent.20locals.20when.2E.2E.2E.html#401831114">(Nov 13 2023 at 19:25)</a>:</h4>
<p>jeffcharles created <a href="https://github.com/bytecodealliance/wasmtime/pull/7531#discussion_r1391587394">PR review comment</a>:</p>
<blockquote>
<p>I looked at using <code>peekn</code> but the iterator it returns is in bottom-most to top-most order and the return type is not a trait that allows me to reverse the order of the entries so I can ignore the top-most element of the stack.</p>
</blockquote>



<a name="401832500"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%237531%20winch%3A%20Materialize%20latent%20locals%20when.../near/401832500" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.237531.20winch.3A.20Materialize.20latent.20locals.20when.2E.2E.2E.html#401832500">(Nov 13 2023 at 19:35)</a>:</h4>
<p>saulecabrera submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/7531#pullrequestreview-1728109127">PR review</a>.</p>



<a name="401832501"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%237531%20winch%3A%20Materialize%20latent%20locals%20when.../near/401832501" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.237531.20winch.3A.20Materialize.20latent.20locals.20when.2E.2E.2E.html#401832501">(Nov 13 2023 at 19:35)</a>:</h4>
<p>saulecabrera submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/7531#pullrequestreview-1728109127">PR review</a>.</p>



<a name="401832503"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%237531%20winch%3A%20Materialize%20latent%20locals%20when.../near/401832503" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.237531.20winch.3A.20Materialize.20latent.20locals.20when.2E.2E.2E.html#401832503">(Nov 13 2023 at 19:35)</a>:</h4>
<p>saulecabrera created <a href="https://github.com/bytecodealliance/wasmtime/pull/7531#discussion_r1391599810">PR review comment</a>:</p>
<blockquote>
<p>Some thoughts on this snippet:</p>
<ul>
<li>I was hoping that we would be able to avoid iterating over all the entries in the stack every time we do this check, as it could get quite expensive plus we really don't have to: the stack must hold the invariant that memory entries precede locals and registers, in that sense, if we're able to track down the index of the last memory entry, we can optimize this check so that it only accounts for entries beyond such index. </li>
<li>Can we make this a method on <code>Stack</code>? Something like <code>Stack::has_local(index)</code>?</li>
</ul>
</blockquote>



<a name="401845774"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%237531%20winch%3A%20Materialize%20latent%20locals%20when.../near/401845774" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.237531.20winch.3A.20Materialize.20latent.20locals.20when.2E.2E.2E.html#401845774">(Nov 13 2023 at 21:09)</a>:</h4>
<p>jeffcharles submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/7531#pullrequestreview-1728290077">PR review</a>.</p>



<a name="401845775"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%237531%20winch%3A%20Materialize%20latent%20locals%20when.../near/401845775" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.237531.20winch.3A.20Materialize.20latent.20locals.20when.2E.2E.2E.html#401845775">(Nov 13 2023 at 21:09)</a>:</h4>
<p>jeffcharles created <a href="https://github.com/bytecodealliance/wasmtime/pull/7531#discussion_r1391709462">PR review comment</a>:</p>
<blockquote>
<p>We talked offline.</p>
<p>We can use an <code>iter().rev().take_while(|v| /* v is not mem or a const */)</code> approach to avoid iterating over the entire stack. And the stack method I'm adding will be named in such a way that it indicates it does not check the top element. This is because we can safely avoid spilling if it's only the top element that references the local since we're going to pop the top element immediately after performing the check to see if the stack contains the local.</p>
</blockquote>



<a name="401846018"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%237531%20winch%3A%20Materialize%20latent%20locals%20when.../near/401846018" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.237531.20winch.3A.20Materialize.20latent.20locals.20when.2E.2E.2E.html#401846018">(Nov 13 2023 at 21:11)</a>:</h4>
<p>jeffcharles edited <a href="https://github.com/bytecodealliance/wasmtime/pull/7531#discussion_r1391709462">PR review comment</a>.</p>



<a name="401848622"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%237531%20winch%3A%20Materialize%20latent%20locals%20when.../near/401848622" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.237531.20winch.3A.20Materialize.20latent.20locals.20when.2E.2E.2E.html#401848622">(Nov 13 2023 at 21:32)</a>:</h4>
<p>jeffcharles updated <a href="https://github.com/bytecodealliance/wasmtime/pull/7531">PR #7531</a>.</p>



<a name="401848731"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%237531%20winch%3A%20Materialize%20latent%20locals%20when.../near/401848731" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.237531.20winch.3A.20Materialize.20latent.20locals.20when.2E.2E.2E.html#401848731">(Nov 13 2023 at 21:33)</a>:</h4>
<p><strong>jeffcharles</strong> requested <a href="https://github.com/saulecabrera">saulecabrera</a> for a review on <a href="https://github.com/bytecodealliance/wasmtime/pull/7531">PR #7531</a>.</p>



<a name="401968939"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%237531%20winch%3A%20Materialize%20latent%20locals%20when.../near/401968939" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.237531.20winch.3A.20Materialize.20latent.20locals.20when.2E.2E.2E.html#401968939">(Nov 14 2023 at 11:46)</a>:</h4>
<p>saulecabrera submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/7531#pullrequestreview-1729557936">PR review</a>.</p>



<a name="401976358"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%237531%20winch%3A%20Materialize%20latent%20locals%20when.../near/401976358" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.237531.20winch.3A.20Materialize.20latent.20locals.20when.2E.2E.2E.html#401976358">(Nov 14 2023 at 12:30)</a>:</h4>
<p>saulecabrera merged <a href="https://github.com/bytecodealliance/wasmtime/pull/7531">PR #7531</a>.</p>



<hr><p>Last updated: Jan 20 2025 at 06:04 UTC</p>
</html>