<html>
<head><meta charset="utf-8"><title>wasmtime / PR #8450 Wasmtime(gc): Support `(ref.i31 (glob... · git-wasmtime · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/index.html">git-wasmtime</a></h2>
<h3>Topic: <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.238450.20Wasmtime.28gc.29.3A.20Support.20.60.28ref.2Ei31.20.28glob.2E.2E.2E.html">wasmtime / PR #8450 Wasmtime(gc): Support `(ref.i31 (glob...</a></h3>

<hr>

<base href="https://bytecodealliance.zulipchat.com">

<head><link href="https://bytecodealliance.github.io/zulip-archive/style.css" rel="stylesheet"></head>

<a name="435070830"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%238450%20Wasmtime%28gc%29%3A%20Support%20%60%28ref.i31%20%28glob.../near/435070830" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.238450.20Wasmtime.28gc.29.3A.20Support.20.60.28ref.2Ei31.20.28glob.2E.2E.2E.html#435070830">(Apr 23 2024 at 21:29)</a>:</h4>
<p>fitzgen opened <a href="https://github.com/bytecodealliance/wasmtime/pull/8450">PR #8450</a> from <code>fitzgen:i31-global-initializers</code> to <code>bytecodealliance:main</code>:</p>
<blockquote>
<p>We had something hacked together to support <code>(ref.i31 (i32.const N))</code>. It wasn't a long-term solution. This is the first time that we have to really deal with multi-instruction const expressions.</p>
<p>This commit introduces a tiny interpreter to evaluate const expressions.</p>
<p>&lt;!--<br>
Please make sure you include the following information:</p>
<ul>
<li>
<p>If this work has been discussed elsewhere, please include a link to that<br>
  conversation. If it was discussed in an issue, just mention "issue #...".</p>
</li>
<li>
<p>Explain why this change is needed. If the details are in an issue already,<br>
  this can be brief.</p>
</li>
</ul>
<p>Our development process is documented in the Wasmtime book:<br>
<a href="https://docs.wasmtime.dev/contributing-development-process.html">https://docs.wasmtime.dev/contributing-development-process.html</a></p>
<p>Please ensure all communication follows the code of conduct:<br>
<a href="https://github.com/bytecodealliance/wasmtime/blob/main/CODE_OF_CONDUCT.md">https://github.com/bytecodealliance/wasmtime/blob/main/CODE_OF_CONDUCT.md</a><br>
--&gt;</p>
</blockquote>



<a name="435070831"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%238450%20Wasmtime%28gc%29%3A%20Support%20%60%28ref.i31%20%28glob.../near/435070831" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.238450.20Wasmtime.28gc.29.3A.20Support.20.60.28ref.2Ei31.20.28glob.2E.2E.2E.html#435070831">(Apr 23 2024 at 21:29)</a>:</h4>
<p><strong>fitzgen</strong> requested <a href="https://github.com/abrown">abrown</a> for a review on <a href="https://github.com/bytecodealliance/wasmtime/pull/8450">PR #8450</a>.</p>



<a name="435070832"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%238450%20Wasmtime%28gc%29%3A%20Support%20%60%28ref.i31%20%28glob.../near/435070832" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.238450.20Wasmtime.28gc.29.3A.20Support.20.60.28ref.2Ei31.20.28glob.2E.2E.2E.html#435070832">(Apr 23 2024 at 21:29)</a>:</h4>
<p><strong>fitzgen</strong> requested <a href="https://github.com/orgs/bytecodealliance/teams/wasmtime-compiler-reviewers">wasmtime-compiler-reviewers</a> for a review on <a href="https://github.com/bytecodealliance/wasmtime/pull/8450">PR #8450</a>.</p>



<a name="435070833"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%238450%20Wasmtime%28gc%29%3A%20Support%20%60%28ref.i31%20%28glob.../near/435070833" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.238450.20Wasmtime.28gc.29.3A.20Support.20.60.28ref.2Ei31.20.28glob.2E.2E.2E.html#435070833">(Apr 23 2024 at 21:29)</a>:</h4>
<p><strong>fitzgen</strong> requested <a href="https://github.com/alexcrichton">alexcrichton</a> for a review on <a href="https://github.com/bytecodealliance/wasmtime/pull/8450">PR #8450</a>.</p>



<a name="435070834"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%238450%20Wasmtime%28gc%29%3A%20Support%20%60%28ref.i31%20%28glob.../near/435070834" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.238450.20Wasmtime.28gc.29.3A.20Support.20.60.28ref.2Ei31.20.28glob.2E.2E.2E.html#435070834">(Apr 23 2024 at 21:29)</a>:</h4>
<p><strong>fitzgen</strong> requested <a href="https://github.com/orgs/bytecodealliance/teams/wasmtime-core-reviewers">wasmtime-core-reviewers</a> for a review on <a href="https://github.com/bytecodealliance/wasmtime/pull/8450">PR #8450</a>.</p>



<a name="435070835"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%238450%20Wasmtime%28gc%29%3A%20Support%20%60%28ref.i31%20%28glob.../near/435070835" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.238450.20Wasmtime.28gc.29.3A.20Support.20.60.28ref.2Ei31.20.28glob.2E.2E.2E.html#435070835">(Apr 23 2024 at 21:29)</a>:</h4>
<p><strong>fitzgen</strong> requested <a href="https://github.com/orgs/bytecodealliance/teams/wasmtime-default-reviewers">wasmtime-default-reviewers</a> for a review on <a href="https://github.com/bytecodealliance/wasmtime/pull/8450">PR #8450</a>.</p>



<a name="435070975"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%238450%20Wasmtime%28gc%29%3A%20Support%20%60%28ref.i31%20%28glob.../near/435070975" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.238450.20Wasmtime.28gc.29.3A.20Support.20.60.28ref.2Ei31.20.28glob.2E.2E.2E.html#435070975">(Apr 23 2024 at 21:30)</a>:</h4>
<p>fitzgen updated <a href="https://github.com/bytecodealliance/wasmtime/pull/8450">PR #8450</a>.</p>



<a name="435075002"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%238450%20Wasmtime%28gc%29%3A%20Support%20%60%28ref.i31%20%28glob.../near/435075002" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.238450.20Wasmtime.28gc.29.3A.20Support.20.60.28ref.2Ei31.20.28glob.2E.2E.2E.html#435075002">(Apr 23 2024 at 22:05)</a>:</h4>
<p>fitzgen updated <a href="https://github.com/bytecodealliance/wasmtime/pull/8450">PR #8450</a>.</p>



<a name="435076335"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%238450%20Wasmtime%28gc%29%3A%20Support%20%60%28ref.i31%20%28glob.../near/435076335" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.238450.20Wasmtime.28gc.29.3A.20Support.20.60.28ref.2Ei31.20.28glob.2E.2E.2E.html#435076335">(Apr 23 2024 at 22:19)</a>:</h4>
<p>alexcrichton submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/8450#pullrequestreview-2018421960">PR review</a>:</p>
<blockquote>
<p>Looks good to me, I think the organization worked out well here.</p>
<p>My main comment is that the <code>unsafe </code>methods feel a little too unsafe and while I don't think there's a whole lot that can be done about that I still think it would be good to at least assert that <code>Concrete</code> heap types are functions for now to avoid accidental confusion in the future.</p>
</blockquote>



<a name="435076336"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%238450%20Wasmtime%28gc%29%3A%20Support%20%60%28ref.i31%20%28glob.../near/435076336" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.238450.20Wasmtime.28gc.29.3A.20Support.20.60.28ref.2Ei31.20.28glob.2E.2E.2E.html#435076336">(Apr 23 2024 at 22:19)</a>:</h4>
<p>alexcrichton created <a href="https://github.com/bytecodealliance/wasmtime/pull/8450#discussion_r1576967432">PR review comment</a>:</p>
<blockquote>
<p>If this <code>.to_ne_bytes()</code> is required I think that means we're doing something wrong in <code>ValRaw</code>, perhaps a missing <code>from_le_bytes</code> in <code>get_v128</code>?</p>
<p>No matter what if this is the only one that does <code>.to_ne_bytes()</code> is should have docs as to why it's omitted on the others.</p>
</blockquote>



<a name="435076337"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%238450%20Wasmtime%28gc%29%3A%20Support%20%60%28ref.i31%20%28glob.../near/435076337" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.238450.20Wasmtime.28gc.29.3A.20Support.20.60.28ref.2Ei31.20.28glob.2E.2E.2E.html#435076337">(Apr 23 2024 at 22:19)</a>:</h4>
<p>alexcrichton submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/8450#pullrequestreview-2018421960">PR review</a>:</p>
<blockquote>
<p>Looks good to me, I think the organization worked out well here.</p>
<p>My main comment is that the <code>unsafe </code>methods feel a little too unsafe and while I don't think there's a whole lot that can be done about that I still think it would be good to at least assert that <code>Concrete</code> heap types are functions for now to avoid accidental confusion in the future.</p>
</blockquote>



<a name="435076338"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%238450%20Wasmtime%28gc%29%3A%20Support%20%60%28ref.i31%20%28glob.../near/435076338" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.238450.20Wasmtime.28gc.29.3A.20Support.20.60.28ref.2Ei31.20.28glob.2E.2E.2E.html#435076338">(Apr 23 2024 at 22:19)</a>:</h4>
<p>alexcrichton created <a href="https://github.com/bytecodealliance/wasmtime/pull/8450#discussion_r1576968409">PR review comment</a>:</p>
<blockquote>
<p>Bit of a side comment, but I get a little uncomfortable with <code>Concrete(_)</code> here since it seems very easy to overlook this in the future when the concrete type may be a function or may be a struct. Is it possible to perhaps restructure this or add an assert? </p>
<p>It seems especially relevant here and above given how unsafe the methods are</p>
</blockquote>



<a name="435076339"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%238450%20Wasmtime%28gc%29%3A%20Support%20%60%28ref.i31%20%28glob.../near/435076339" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.238450.20Wasmtime.28gc.29.3A.20Support.20.60.28ref.2Ei31.20.28glob.2E.2E.2E.html#435076339">(Apr 23 2024 at 22:19)</a>:</h4>
<p>alexcrichton created <a href="https://github.com/bytecodealliance/wasmtime/pull/8450#discussion_r1576969283">PR review comment</a>:</p>
<blockquote>
<p>Do you think we can structure this as an enum or similar? E.g. a <code>.classify()</code> returning an enum of some kind. The differences between these functions feels really subtle and easy to get wrong, and getting it wrong feels like it could lead to unsafety pretty easily</p>
</blockquote>



<a name="435076340"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%238450%20Wasmtime%28gc%29%3A%20Support%20%60%28ref.i31%20%28glob.../near/435076340" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.238450.20Wasmtime.28gc.29.3A.20Support.20.60.28ref.2Ei31.20.28glob.2E.2E.2E.html#435076340">(Apr 23 2024 at 22:19)</a>:</h4>
<p>alexcrichton created <a href="https://github.com/bytecodealliance/wasmtime/pull/8450#discussion_r1576969698">PR review comment</a>:</p>
<blockquote>
<p>8 seems pretty big here given how often we'll be storing this, could this perhaps be tuned to be the native size of <code>SmallVec</code>?</p>
</blockquote>



<a name="435077645"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%238450%20Wasmtime%28gc%29%3A%20Support%20%60%28ref.i31%20%28glob.../near/435077645" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.238450.20Wasmtime.28gc.29.3A.20Support.20.60.28ref.2Ei31.20.28glob.2E.2E.2E.html#435077645">(Apr 23 2024 at 22:32)</a>:</h4>
<p>fitzgen submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/8450#pullrequestreview-2018438000">PR review</a>.</p>



<a name="435077646"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%238450%20Wasmtime%28gc%29%3A%20Support%20%60%28ref.i31%20%28glob.../near/435077646" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.238450.20Wasmtime.28gc.29.3A.20Support.20.60.28ref.2Ei31.20.28glob.2E.2E.2E.html#435077646">(Apr 23 2024 at 22:32)</a>:</h4>
<p>fitzgen created <a href="https://github.com/bytecodealliance/wasmtime/pull/8450#discussion_r1576978411">PR review comment</a>:</p>
<blockquote>
<p>WasmHeapType::Extern</p>
</blockquote>



<a name="435077701"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%238450%20Wasmtime%28gc%29%3A%20Support%20%60%28ref.i31%20%28glob.../near/435077701" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.238450.20Wasmtime.28gc.29.3A.20Support.20.60.28ref.2Ei31.20.28glob.2E.2E.2E.html#435077701">(Apr 23 2024 at 22:32)</a>:</h4>
<p>fitzgen edited <a href="https://github.com/bytecodealliance/wasmtime/pull/8450#discussion_r1576978411">PR review comment</a>.</p>



<a name="435083648"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%238450%20Wasmtime%28gc%29%3A%20Support%20%60%28ref.i31%20%28glob.../near/435083648" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.238450.20Wasmtime.28gc.29.3A.20Support.20.60.28ref.2Ei31.20.28glob.2E.2E.2E.html#435083648">(Apr 23 2024 at 23:40)</a>:</h4>
<p>fitzgen submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/8450#pullrequestreview-2018505607">PR review</a>.</p>



<a name="435083657"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%238450%20Wasmtime%28gc%29%3A%20Support%20%60%28ref.i31%20%28glob.../near/435083657" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.238450.20Wasmtime.28gc.29.3A.20Support.20.60.28ref.2Ei31.20.28glob.2E.2E.2E.html#435083657">(Apr 23 2024 at 23:40)</a>:</h4>
<p>fitzgen created <a href="https://github.com/bytecodealliance/wasmtime/pull/8450#discussion_r1577024062">PR review comment</a>:</p>
<blockquote>
<p>I was just doing this to get a <code>[u8; 16]</code> but it turns out that isn't necessary: we have a method on <code>wasmtime_runtime::Global</code> to get the value as a <code>&amp;mut u128</code>, which I didn't see before.</p>
</blockquote>



<a name="435083910"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%238450%20Wasmtime%28gc%29%3A%20Support%20%60%28ref.i31%20%28glob.../near/435083910" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.238450.20Wasmtime.28gc.29.3A.20Support.20.60.28ref.2Ei31.20.28glob.2E.2E.2E.html#435083910">(Apr 23 2024 at 23:43)</a>:</h4>
<p>fitzgen submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/8450#pullrequestreview-2018509866">PR review</a>.</p>



<a name="435083911"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%238450%20Wasmtime%28gc%29%3A%20Support%20%60%28ref.i31%20%28glob.../near/435083911" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.238450.20Wasmtime.28gc.29.3A.20Support.20.60.28ref.2Ei31.20.28glob.2E.2E.2E.html#435083911">(Apr 23 2024 at 23:43)</a>:</h4>
<p>fitzgen created <a href="https://github.com/bytecodealliance/wasmtime/pull/8450#discussion_r1577027080">PR review comment</a>:</p>
<blockquote>
<p>Unfortunately there isn't a good way to resolve this, given the <code>wasmtime</code> vs <code>wasmtime-runtime</code> crate split. We would need to take a <code>wasmtime::Engine</code> here and then look up the type index in the engine's types registry and match on the resulting value (which can only be a function type right now). But we can't get an engine inside the <code>wasmtime-runtime</code> crate.</p>
</blockquote>



<a name="435204878"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%238450%20Wasmtime%28gc%29%3A%20Support%20%60%28ref.i31%20%28glob.../near/435204878" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.238450.20Wasmtime.28gc.29.3A.20Support.20.60.28ref.2Ei31.20.28glob.2E.2E.2E.html#435204878">(Apr 24 2024 at 14:36)</a>:</h4>
<p>alexcrichton submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/8450#pullrequestreview-2020069796">PR review</a>.</p>



<a name="435204879"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%238450%20Wasmtime%28gc%29%3A%20Support%20%60%28ref.i31%20%28glob.../near/435204879" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.238450.20Wasmtime.28gc.29.3A.20Support.20.60.28ref.2Ei31.20.28glob.2E.2E.2E.html#435204879">(Apr 24 2024 at 14:36)</a>:</h4>
<p>alexcrichton created <a href="https://github.com/bytecodealliance/wasmtime/pull/8450#discussion_r1578006230">PR review comment</a>:</p>
<blockquote>
<p>We have to solve this in the near future though right?</p>
<p>Originally I was hoping we could have <code>Concrete</code> renamed to <code>ConcreteFunc</code> and then also have <code>Concrete{Struct,Array}</code> or something like that, but I'm not sure if that's still possible.</p>
<p>Do you have other ideas though on what to do here once arrays/structs are implemented?</p>
</blockquote>



<a name="435210250"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%238450%20Wasmtime%28gc%29%3A%20Support%20%60%28ref.i31%20%28glob.../near/435210250" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.238450.20Wasmtime.28gc.29.3A.20Support.20.60.28ref.2Ei31.20.28glob.2E.2E.2E.html#435210250">(Apr 24 2024 at 15:00)</a>:</h4>
<p>fitzgen submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/8450#pullrequestreview-2020131646">PR review</a>.</p>



<a name="435210252"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%238450%20Wasmtime%28gc%29%3A%20Support%20%60%28ref.i31%20%28glob.../near/435210252" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.238450.20Wasmtime.28gc.29.3A.20Support.20.60.28ref.2Ei31.20.28glob.2E.2E.2E.html#435210252">(Apr 24 2024 at 15:00)</a>:</h4>
<p>fitzgen created <a href="https://github.com/bytecodealliance/wasmtime/pull/8450#discussion_r1578043978">PR review comment</a>:</p>
<blockquote>
<p>My plan was to start passing in a function to these sorts of methods that need to do the index-to-type resolution. Between that, fuzzing, and using LSP to find all uses of <code>Concrete(_)</code> I wasn't too too worried about missing a spot to update.</p>
<p>The other thing we could do is try moving the type registry into <code>wasmtime-runtime</code>.</p>
</blockquote>



<a name="435216823"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%238450%20Wasmtime%28gc%29%3A%20Support%20%60%28ref.i31%20%28glob.../near/435216823" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.238450.20Wasmtime.28gc.29.3A.20Support.20.60.28ref.2Ei31.20.28glob.2E.2E.2E.html#435216823">(Apr 24 2024 at 15:21)</a>:</h4>
<p>alexcrichton submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/8450#pullrequestreview-2020189192">PR review</a>.</p>



<a name="435216825"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%238450%20Wasmtime%28gc%29%3A%20Support%20%60%28ref.i31%20%28glob.../near/435216825" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.238450.20Wasmtime.28gc.29.3A.20Support.20.60.28ref.2Ei31.20.28glob.2E.2E.2E.html#435216825">(Apr 24 2024 at 15:21)</a>:</h4>
<p>alexcrichton created <a href="https://github.com/bytecodealliance/wasmtime/pull/8450#discussion_r1578078182">PR review comment</a>:</p>
<blockquote>
<p>Even without a const fn could this perhaps be smaller to start? A <code>ConstOp</code> is 32 bytes large and 8 of them inline here is 256 bytes for a single expression which seems pretty egregious especially if a table is initialized with a list of constant expressions.</p>
<p>I'm basically pretty fearful of the impact of using this everywhere when the representation is 8x larger than it is today</p>
</blockquote>



<a name="435217716"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%238450%20Wasmtime%28gc%29%3A%20Support%20%60%28ref.i31%20%28glob.../near/435217716" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.238450.20Wasmtime.28gc.29.3A.20Support.20.60.28ref.2Ei31.20.28glob.2E.2E.2E.html#435217716">(Apr 24 2024 at 15:25)</a>:</h4>
<p>alexcrichton created <a href="https://github.com/bytecodealliance/wasmtime/pull/8450#discussion_r1578084158">PR review comment</a>:</p>
<blockquote>
<p>I may be blowing things out of proportion here perhaps, but I'm personally pretty worried about this. I just ran across <a href="https://github.com/bytecodealliance/wasmtime/blob/1f8c3df2d305c4e8e32529911bd97fe376f90bd7/crates/wasmtime/src/runtime/types.rs#L592-L597">another instance</a> of where type information will be needed as well.</p>
<p>I'm basically pretty worried that we've pretty deeply baked in the assumption that "<code>Concrete</code> is always a function" and I'd like to avoid baking it in any further, especially here where it's necessary for safety. </p>
<p>I suppose for the sake of this PR could you add an assertion to the constructors of <code>Concrete</code> that it's always a function? (or double-check such an assertion already exists?) More-or-less we need to re-audit all usages of <code>Concrete</code> when the GC implementation gets further along.</p>
</blockquote>



<a name="435217741"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%238450%20Wasmtime%28gc%29%3A%20Support%20%60%28ref.i31%20%28glob.../near/435217741" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.238450.20Wasmtime.28gc.29.3A.20Support.20.60.28ref.2Ei31.20.28glob.2E.2E.2E.html#435217741">(Apr 24 2024 at 15:25)</a>:</h4>
<p>alexcrichton submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/8450#pullrequestreview-2020198880">PR review</a>.</p>



<a name="435217800"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%238450%20Wasmtime%28gc%29%3A%20Support%20%60%28ref.i31%20%28glob.../near/435217800" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.238450.20Wasmtime.28gc.29.3A.20Support.20.60.28ref.2Ei31.20.28glob.2E.2E.2E.html#435217800">(Apr 24 2024 at 15:25)</a>:</h4>
<p>fitzgen submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/8450#pullrequestreview-2020199979">PR review</a>.</p>



<a name="435217801"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%238450%20Wasmtime%28gc%29%3A%20Support%20%60%28ref.i31%20%28glob.../near/435217801" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.238450.20Wasmtime.28gc.29.3A.20Support.20.60.28ref.2Ei31.20.28glob.2E.2E.2E.html#435217801">(Apr 24 2024 at 15:25)</a>:</h4>
<p>fitzgen created <a href="https://github.com/bytecodealliance/wasmtime/pull/8450#discussion_r1578084823">PR review comment</a>:</p>
<blockquote>
<p>Yeah I dropped it to 2 locally, just haven't pushed the updates yet until I finish addressing the other comments.</p>
</blockquote>



<a name="435258578"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%238450%20Wasmtime%28gc%29%3A%20Support%20%60%28ref.i31%20%28glob.../near/435258578" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.238450.20Wasmtime.28gc.29.3A.20Support.20.60.28ref.2Ei31.20.28glob.2E.2E.2E.html#435258578">(Apr 24 2024 at 19:27)</a>:</h4>
<p>fitzgen submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/8450#pullrequestreview-2020754193">PR review</a>.</p>



<a name="435258579"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%238450%20Wasmtime%28gc%29%3A%20Support%20%60%28ref.i31%20%28glob.../near/435258579" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.238450.20Wasmtime.28gc.29.3A.20Support.20.60.28ref.2Ei31.20.28glob.2E.2E.2E.html#435258579">(Apr 24 2024 at 19:27)</a>:</h4>
<p>fitzgen created <a href="https://github.com/bytecodealliance/wasmtime/pull/8450#discussion_r1578408282">PR review comment</a>:</p>
<blockquote>
<p>(We talked offline about this and decided to just rename the predicates).</p>
</blockquote>



<a name="435258927"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%238450%20Wasmtime%28gc%29%3A%20Support%20%60%28ref.i31%20%28glob.../near/435258927" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.238450.20Wasmtime.28gc.29.3A.20Support.20.60.28ref.2Ei31.20.28glob.2E.2E.2E.html#435258927">(Apr 24 2024 at 19:30)</a>:</h4>
<p>fitzgen submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/8450#pullrequestreview-2020758237">PR review</a>.</p>



<a name="435258936"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%238450%20Wasmtime%28gc%29%3A%20Support%20%60%28ref.i31%20%28glob.../near/435258936" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.238450.20Wasmtime.28gc.29.3A.20Support.20.60.28ref.2Ei31.20.28glob.2E.2E.2E.html#435258936">(Apr 24 2024 at 19:30)</a>:</h4>
<p>fitzgen created <a href="https://github.com/bytecodealliance/wasmtime/pull/8450#discussion_r1578411925">PR review comment</a>:</p>
<blockquote>
<p>(We talked offline about this and decided that renaming <code>Concrete(_)</code> to <code>ConcreteFunc(_)</code> actually is okay, and will do it in a future PR. It wasn't workable for <code>wasmparser</code>, since that crate needs to be able to parse opcodes without having a validated types section where we can look things up in and determine whether we are talking about a concrete func or e.g. struct, but that constraint doesn't apply here.)</p>
</blockquote>



<a name="435259872"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%238450%20Wasmtime%28gc%29%3A%20Support%20%60%28ref.i31%20%28glob.../near/435259872" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.238450.20Wasmtime.28gc.29.3A.20Support.20.60.28ref.2Ei31.20.28glob.2E.2E.2E.html#435259872">(Apr 24 2024 at 19:37)</a>:</h4>
<p>fitzgen updated <a href="https://github.com/bytecodealliance/wasmtime/pull/8450">PR #8450</a>.</p>



<a name="435260142"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%238450%20Wasmtime%28gc%29%3A%20Support%20%60%28ref.i31%20%28glob.../near/435260142" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.238450.20Wasmtime.28gc.29.3A.20Support.20.60.28ref.2Ei31.20.28glob.2E.2E.2E.html#435260142">(Apr 24 2024 at 19:38)</a>:</h4>
<p>alexcrichton submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/8450#pullrequestreview-2020776196">PR review</a>.</p>



<a name="435260394"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%238450%20Wasmtime%28gc%29%3A%20Support%20%60%28ref.i31%20%28glob.../near/435260394" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.238450.20Wasmtime.28gc.29.3A.20Support.20.60.28ref.2Ei31.20.28glob.2E.2E.2E.html#435260394">(Apr 24 2024 at 19:40)</a>:</h4>
<p>fitzgen has enabled auto merge for <a href="https://github.com/bytecodealliance/wasmtime/pull/8450">PR #8450</a>.</p>



<a name="435266495"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%238450%20Wasmtime%28gc%29%3A%20Support%20%60%28ref.i31%20%28glob.../near/435266495" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.238450.20Wasmtime.28gc.29.3A.20Support.20.60.28ref.2Ei31.20.28glob.2E.2E.2E.html#435266495">(Apr 24 2024 at 20:23)</a>:</h4>
<p>fitzgen merged <a href="https://github.com/bytecodealliance/wasmtime/pull/8450">PR #8450</a>.</p>



<hr><p>Last updated: Jan 20 2025 at 06:04 UTC</p>
</html>