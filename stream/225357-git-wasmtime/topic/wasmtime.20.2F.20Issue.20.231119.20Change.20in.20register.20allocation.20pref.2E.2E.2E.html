<html>
<head><meta charset="utf-8"><title>wasmtime / Issue #1119 Change in register allocation pref... · git-wasmtime · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/index.html">git-wasmtime</a></h2>
<h3>Topic: <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20Issue.20.231119.20Change.20in.20register.20allocation.20pref.2E.2E.2E.html">wasmtime / Issue #1119 Change in register allocation pref...</a></h3>

<hr>

<base href="https://bytecodealliance.zulipchat.com">

<head><link href="https://bytecodealliance.github.io/zulip-archive/style.css" rel="stylesheet"></head>

<a name="225072241"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20Issue%20%231119%20Change%20in%20register%20allocation%20pref.../near/225072241" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20Issue.20.231119.20Change.20in.20register.20allocation.20pref.2E.2E.2E.html#225072241">(Feb 03 2021 at 19:56)</a>:</h4>
<p>bjorn3 <a href="https://github.com/bytecodealliance/wasmtime/issues/1119#issuecomment-772780975">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/1119">Issue #1119</a>:</p>
<blockquote>
<p>Is this still the case with <a href="http://regalloc.rs">regalloc.rs</a>?</p>
</blockquote>



<a name="225074093"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20Issue%20%231119%20Change%20in%20register%20allocation%20pref.../near/225074093" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20Issue.20.231119.20Change.20in.20register.20allocation.20pref.2E.2E.2E.html#225074093">(Feb 03 2021 at 20:09)</a>:</h4>
<p>cfallin <a href="https://github.com/bytecodealliance/wasmtime/issues/1119#issuecomment-772788561">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/1119">Issue #1119</a>:</p>
<blockquote>
<p>We've looked at whether to use callee- or caller-saved registers preferentially in the new backends and the current heuristic is to allocate caller-saved registers first, with the additional detail that the clobber modeling (every call instruction <code>def</code>s all clobbered registers) will naturally push values that are live across calls into callee-saved registers where they're available. So I <em>think</em> we should be able to close this as it's an issue specific to the old regalloc.</p>
</blockquote>



<a name="225074094"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20Issue%20%231119%20Change%20in%20register%20allocation%20pref.../near/225074094" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20Issue.20.231119.20Change.20in.20register.20allocation.20pref.2E.2E.2E.html#225074094">(Feb 03 2021 at 20:09)</a>:</h4>
<p>cfallin closed <a href="https://github.com/bytecodealliance/wasmtime/issues/1119">Issue #1119</a>:</p>
<blockquote>
<p>To start, some clif:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="p">;</span><span class="w"> </span><span class="n">guest_func_10</span><span class="w"></span>
<span class="n">function</span><span class="w"> </span><span class="n">u0</span>:<span class="mi">10</span><span class="p">(</span><span class="kt">i64</span><span class="w"> </span><span class="n">vmctx</span><span class="p">,</span><span class="w"> </span><span class="kt">i32</span><span class="p">,</span><span class="w"> </span><span class="kt">i32</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="kt">i32</span> <span class="nc">system_v</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">sig0</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="kt">i64</span><span class="w"> </span><span class="n">vmctx</span><span class="p">,</span><span class="w"> </span><span class="kt">i32</span><span class="p">,</span><span class="w"> </span><span class="kt">i32</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="kt">i32</span> <span class="nc">system_v</span><span class="w"></span>
<span class="w">    </span><span class="n">fn0</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">colocated</span><span class="w"> </span><span class="n">u0</span>:<span class="mi">10</span><span class="w"> </span><span class="n">sig0</span><span class="w"></span>

<span class="w">                                </span><span class="n">ebb0</span><span class="p">(</span><span class="n">v0</span>: <span class="kt">i64</span><span class="p">,</span><span class="w"> </span><span class="n">v1</span>: <span class="kt">i32</span><span class="p">,</span><span class="w"> </span><span class="n">v2</span>: <span class="kt">i32</span><span class="p">)</span>:
<span class="o">@</span><span class="mi">09</span><span class="n">ca</span><span class="w">                               </span><span class="n">v4</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">iconst</span><span class="p">.</span><span class="kt">i32</span><span class="w"> </span><span class="mi">0</span><span class="w"></span>
<span class="o">@</span><span class="mi">09</span><span class="n">d0</span><span class="w">                               </span><span class="n">v5</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">icmp_imm</span><span class="w"> </span><span class="n">eq</span><span class="w"> </span><span class="n">v1</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="w"></span>
<span class="o">@</span><span class="mi">09</span><span class="n">d0</span><span class="w">                               </span><span class="n">v6</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">bint</span><span class="p">.</span><span class="kt">i32</span><span class="w"> </span><span class="n">v5</span><span class="w"></span>
<span class="o">@</span><span class="mi">09</span><span class="n">d1</span><span class="w">                               </span><span class="n">brnz</span><span class="w"> </span><span class="n">v6</span><span class="p">,</span><span class="w"> </span><span class="n">ebb2</span><span class="p">(</span><span class="n">v2</span><span class="p">)</span><span class="w"></span>
<span class="o">@</span><span class="mi">09</span><span class="n">d3</span><span class="w">                               </span><span class="n">jump</span><span class="w"> </span><span class="n">ebb3</span><span class="p">(</span><span class="n">v1</span><span class="p">,</span><span class="w"> </span><span class="n">v2</span><span class="p">)</span><span class="w"></span>

<span class="w">                                </span><span class="n">ebb3</span><span class="p">(</span><span class="n">v7</span>: <span class="kt">i32</span><span class="p">,</span><span class="w"> </span><span class="n">v10</span>: <span class="kt">i32</span><span class="p">)</span>:
<span class="o">@</span><span class="mi">09</span><span class="n">d7</span><span class="w">                               </span><span class="n">v8</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">iconst</span><span class="p">.</span><span class="kt">i32</span><span class="w"> </span><span class="o">-</span><span class="mi">1</span><span class="w"></span>
<span class="o">@</span><span class="mi">09</span><span class="n">d9</span><span class="w">                               </span><span class="n">v9</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">iadd</span><span class="w"> </span><span class="n">v7</span><span class="p">,</span><span class="w"> </span><span class="n">v8</span><span class="w"></span>
<span class="o">@</span><span class="mi">09</span><span class="n">de</span><span class="w">                               </span><span class="n">brz</span><span class="w"> </span><span class="n">v10</span><span class="p">,</span><span class="w"> </span><span class="n">ebb5</span><span class="w"></span>
<span class="o">@</span><span class="mf">09e4</span><span class="w">                               </span><span class="n">v11</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">iconst</span><span class="p">.</span><span class="kt">i32</span><span class="w"> </span><span class="o">-</span><span class="mi">1</span><span class="w"></span>
<span class="o">@</span><span class="mf">09e6</span><span class="w">                               </span><span class="n">v12</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">iadd</span><span class="w"> </span><span class="n">v10</span><span class="p">,</span><span class="w"> </span><span class="n">v11</span><span class="w"></span>
<span class="o">@</span><span class="mf">09e7</span><span class="w">                               </span><span class="n">v13</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">call</span><span class="w"> </span><span class="n">fn0</span><span class="p">(</span><span class="n">v0</span><span class="p">,</span><span class="w"> </span><span class="n">v7</span><span class="p">,</span><span class="w"> </span><span class="n">v12</span><span class="p">)</span><span class="w"></span>
<span class="o">@</span><span class="mi">09</span><span class="n">ef</span><span class="w">                               </span><span class="n">brnz</span><span class="w"> </span><span class="n">v9</span><span class="p">,</span><span class="w"> </span><span class="n">ebb3</span><span class="p">(</span><span class="n">v9</span><span class="p">,</span><span class="w"> </span><span class="n">v13</span><span class="p">)</span><span class="w"></span>
<span class="o">@</span><span class="mi">09</span><span class="n">f1</span><span class="w">                               </span><span class="n">jump</span><span class="w"> </span><span class="n">ebb2</span><span class="p">(</span><span class="n">v13</span><span class="p">)</span><span class="w"></span>

<span class="w">                                </span><span class="n">ebb5</span>:
<span class="o">@</span><span class="mi">09</span><span class="n">f4</span><span class="w">                               </span><span class="n">v14</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">iconst</span><span class="p">.</span><span class="kt">i32</span><span class="w"> </span><span class="mi">1</span><span class="w"></span>
<span class="o">@</span><span class="mi">09</span><span class="n">fc</span><span class="w">                               </span><span class="n">brnz</span><span class="p">.</span><span class="kt">i32</span><span class="w"> </span><span class="n">v9</span><span class="p">,</span><span class="w"> </span><span class="n">ebb3</span><span class="p">(</span><span class="n">v9</span><span class="p">,</span><span class="w"> </span><span class="n">v14</span><span class="p">)</span><span class="w"></span>
<span class="o">@</span><span class="mi">09</span><span class="n">fe</span><span class="w">                               </span><span class="n">jump</span><span class="w"> </span><span class="n">ebb4</span><span class="w"></span>

<span class="w">                                </span><span class="n">ebb4</span>:
<span class="o">@</span><span class="mi">09</span><span class="n">ff</span><span class="w">                               </span><span class="n">jump</span><span class="w"> </span><span class="n">ebb2</span><span class="p">(</span><span class="n">v14</span><span class="p">)</span><span class="w"></span>

<span class="w">                                </span><span class="n">ebb2</span><span class="p">(</span><span class="n">v15</span>: <span class="kt">i32</span><span class="p">)</span>:
<span class="o">@</span><span class="mi">0</span><span class="n">a02</span><span class="w">                               </span><span class="n">v16</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">iconst</span><span class="p">.</span><span class="kt">i32</span><span class="w"> </span><span class="mi">1</span><span class="w"></span>
<span class="o">@</span><span class="mi">0</span><span class="n">a04</span><span class="w">                               </span><span class="n">v17</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">iadd</span><span class="w"> </span><span class="n">v15</span><span class="p">,</span><span class="w"> </span><span class="n">v16</span><span class="w"></span>
<span class="o">@</span><span class="mi">0</span><span class="n">a05</span><span class="w">                               </span><span class="n">jump</span><span class="w"> </span><span class="n">ebb1</span><span class="p">(</span><span class="n">v17</span><span class="p">)</span><span class="w"></span>

<span class="w">                                </span><span class="n">ebb1</span><span class="p">(</span><span class="n">v3</span>: <span class="kt">i32</span><span class="p">)</span>:
<span class="o">@</span><span class="mi">0</span><span class="n">a05</span><span class="w">                               </span><span class="k">return</span><span class="w"> </span><span class="n">v3</span><span class="w"></span>
</code></pre></div>
<p>this had been producing</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="n">sym</span><span class="p">.</span><span class="n">guest_func_10</span><span class="w"> </span><span class="p">();</span><span class="w"></span>
<span class="w">           </span><span class="mh">0x00003ac0</span><span class="w"> </span><span class="n">push</span><span class="w"> </span><span class="n">rbp</span><span class="w"></span>
<span class="w">           </span><span class="mh">0x00003ac1</span><span class="w"> </span><span class="n">mov</span><span class="w"> </span><span class="n">rbp</span><span class="p">,</span><span class="w"> </span><span class="n">rsp</span><span class="w"></span>
<span class="w">           </span><span class="mh">0x00003ac4</span><span class="w"> </span><span class="n">sub</span><span class="w"> </span><span class="n">rsp</span><span class="p">,</span><span class="w"> </span><span class="mh">0x10</span><span class="w"></span>
<span class="w">           </span><span class="mh">0x00003ac8</span><span class="w"> </span><span class="n">mov</span><span class="w"> </span><span class="n">qword</span><span class="w"> </span><span class="p">[</span><span class="n">rsp</span><span class="p">],</span><span class="w"> </span><span class="n">rdi</span><span class="w"></span>
<span class="w">           </span><span class="mh">0x00003ad0</span><span class="w"> </span><span class="n">mov</span><span class="w"> </span><span class="n">dword</span><span class="w"> </span><span class="p">[</span><span class="n">local_ch</span><span class="p">],</span><span class="w"> </span><span class="n">edx</span><span class="w"></span>
<span class="w">           </span><span class="mh">0x00003ad7</span><span class="w"> </span><span class="n">test</span><span class="w"> </span><span class="n">esi</span><span class="p">,</span><span class="w"> </span><span class="n">esi</span><span class="w"></span>
<span class="w">       </span><span class="p">,</span><span class="o">=&lt;</span><span class="w"> </span><span class="mh">0x00003ad9</span><span class="w"> </span><span class="n">je</span><span class="w"> </span><span class="mh">0x3b56</span><span class="w"></span>
<span class="w">       </span><span class="o">|</span><span class="w">   </span><span class="mh">0x00003adb</span><span class="w"> </span><span class="n">mov</span><span class="w"> </span><span class="n">eax</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="w"></span>
<span class="w">       </span><span class="o">|</span><span class="w">   </span><span class="mh">0x00003ae0</span><span class="w"> </span><span class="n">mov</span><span class="w"> </span><span class="n">dword</span><span class="w"> </span><span class="p">[</span><span class="n">local_ch</span><span class="p">],</span><span class="w"> </span><span class="n">eax</span><span class="w"></span>
<span class="w">     </span><span class="o">..-</span>-&gt; <span class="mh">0x00003ae7</span><span class="w"> </span><span class="n">mov</span><span class="w"> </span><span class="n">eax</span><span class="p">,</span><span class="w"> </span><span class="n">esi</span><span class="w"></span>
<span class="w">     </span>::<span class="o">|</span><span class="w">   </span><span class="mh">0x00003ae9</span><span class="w"> </span><span class="n">add</span><span class="w"> </span><span class="n">eax</span><span class="p">,</span><span class="w"> </span><span class="o">-</span><span class="mi">1</span><span class="w"></span>
<span class="w">     </span>::<span class="o">|</span><span class="w">   </span><span class="mh">0x00003aec</span><span class="w"> </span><span class="n">mov</span><span class="w"> </span><span class="n">dword</span><span class="w"> </span><span class="p">[</span><span class="n">local_8h</span><span class="p">],</span><span class="w"> </span><span class="n">eax</span><span class="w"></span>
<span class="w">     </span>::<span class="o">|</span><span class="w">   </span><span class="mh">0x00003af3</span><span class="w"> </span><span class="n">test</span><span class="w"> </span><span class="n">edx</span><span class="p">,</span><span class="w"> </span><span class="n">edx</span><span class="w"></span>
<span class="w">    </span><span class="p">,</span><span class="o">====&lt;</span><span class="w"> </span><span class="mh">0x00003af5</span><span class="w"> </span><span class="n">je</span><span class="w"> </span><span class="mh">0x3b31</span><span class="w"></span>
<span class="w">    </span><span class="o">|</span>::<span class="o">|</span><span class="w">   </span><span class="mh">0x00003af7</span><span class="w"> </span><span class="n">add</span><span class="w"> </span><span class="n">edx</span><span class="p">,</span><span class="w"> </span><span class="o">-</span><span class="mi">1</span><span class="w"></span>
<span class="w">    </span><span class="o">|</span>::<span class="o">|</span><span class="w">   </span><span class="mh">0x00003afa</span><span class="w"> </span><span class="n">mov</span><span class="w"> </span><span class="n">rax</span><span class="p">,</span><span class="w"> </span><span class="n">qword</span><span class="w"> </span><span class="p">[</span><span class="n">rsp</span><span class="p">]</span><span class="w"></span>
<span class="w">    </span><span class="o">|</span>::<span class="o">|</span><span class="w">   </span><span class="mh">0x00003b02</span><span class="w"> </span><span class="n">mov</span><span class="w"> </span><span class="n">rdi</span><span class="p">,</span><span class="w"> </span><span class="n">rax</span><span class="w"></span>
<span class="w">    </span><span class="o">|</span>::<span class="o">|</span><span class="w">   </span><span class="mh">0x00003b05</span><span class="w"> </span><span class="n">call</span><span class="w"> </span><span class="n">sym</span><span class="p">.</span><span class="n">guest_func_10</span><span class="w"></span>
<span class="w">    </span><span class="o">|</span>::<span class="o">|</span><span class="w">   </span><span class="mh">0x00003b0a</span><span class="w"> </span><span class="n">mov</span><span class="w"> </span><span class="n">ecx</span><span class="p">,</span><span class="w"> </span><span class="n">dword</span><span class="w"> </span><span class="p">[</span><span class="n">local_8h</span><span class="p">]</span><span class="w"></span>
<span class="w">    </span><span class="o">|</span>::<span class="o">|</span><span class="w">   </span><span class="mh">0x00003b11</span><span class="w"> </span><span class="n">mov</span><span class="w"> </span><span class="n">edx</span><span class="p">,</span><span class="w"> </span><span class="n">dword</span><span class="w"> </span><span class="p">[</span><span class="n">local_8h</span><span class="p">]</span><span class="w"></span>
<span class="w">    </span><span class="o">|</span>::<span class="o">|</span><span class="w">   </span><span class="mh">0x00003b18</span><span class="w"> </span><span class="n">mov</span><span class="w"> </span><span class="n">esi</span><span class="p">,</span><span class="w"> </span><span class="n">ecx</span><span class="w"></span>
<span class="w">    </span><span class="o">|</span>::<span class="o">|</span><span class="w">   </span><span class="mh">0x00003b1b</span><span class="w"> </span><span class="n">mov</span><span class="w"> </span><span class="n">ecx</span><span class="p">,</span><span class="w"> </span><span class="n">edx</span><span class="w"></span>
<span class="w">    </span><span class="o">|</span>::<span class="o">|</span><span class="w">   </span><span class="mh">0x00003b1e</span><span class="w"> </span><span class="n">mov</span><span class="w"> </span><span class="n">edx</span><span class="p">,</span><span class="w"> </span><span class="n">eax</span><span class="w"></span>
<span class="w">    </span><span class="o">|</span>::<span class="o">|</span><span class="w">   </span><span class="mh">0x00003b21</span><span class="w"> </span><span class="n">mov</span><span class="w"> </span><span class="n">eax</span><span class="p">,</span><span class="w"> </span><span class="n">ecx</span><span class="w"></span>
<span class="w">    </span><span class="o">|</span>::<span class="o">|</span><span class="w">   </span><span class="mh">0x00003b24</span><span class="w"> </span><span class="n">test</span><span class="w"> </span><span class="n">eax</span><span class="p">,</span><span class="w"> </span><span class="n">eax</span><span class="w"></span>
<span class="w">    </span><span class="o">|</span><span class="err">`</span><span class="o">===&lt;</span><span class="w"> </span><span class="mh">0x00003b26</span><span class="w"> </span><span class="n">jne</span><span class="w"> </span><span class="mh">0x3ae7</span><span class="w"></span>
<span class="w">    </span><span class="o">|</span><span class="w"> </span>:<span class="o">|</span><span class="w">   </span><span class="mh">0x00003b28</span><span class="w"> </span><span class="n">mov</span><span class="w"> </span><span class="n">dword</span><span class="w"> </span><span class="p">[</span><span class="n">local_ch</span><span class="p">],</span><span class="w"> </span><span class="n">edx</span><span class="w"></span>
<span class="w">    </span><span class="o">|</span><span class="p">,</span><span class="o">===&lt;</span><span class="w"> </span><span class="mh">0x00003b2f</span><span class="w"> </span><span class="n">jmp</span><span class="w"> </span><span class="mh">0x3b56</span><span class="w"></span>
<span class="w">    </span><span class="err">`</span><span class="o">---</span>-&gt; <span class="mh">0x00003b31</span><span class="w"> </span><span class="n">mov</span><span class="w"> </span><span class="n">eax</span><span class="p">,</span><span class="w"> </span><span class="n">dword</span><span class="w"> </span><span class="p">[</span><span class="n">local_ch</span><span class="p">]</span><span class="w"></span>
<span class="w">     </span><span class="o">|</span>:<span class="o">|</span><span class="w">   </span><span class="mh">0x00003b38</span><span class="w"> </span><span class="n">mov</span><span class="w"> </span><span class="n">ecx</span><span class="p">,</span><span class="w"> </span><span class="n">dword</span><span class="w"> </span><span class="p">[</span><span class="n">local_8h</span><span class="p">]</span><span class="w"></span>
<span class="w">     </span><span class="o">|</span>:<span class="o">|</span><span class="w">   </span><span class="mh">0x00003b3f</span><span class="w"> </span><span class="n">mov</span><span class="w"> </span><span class="n">edx</span><span class="p">,</span><span class="w"> </span><span class="n">dword</span><span class="w"> </span><span class="p">[</span><span class="n">local_8h</span><span class="p">]</span><span class="w"></span>
<span class="w">     </span><span class="o">|</span>:<span class="o">|</span><span class="w">   </span><span class="mh">0x00003b46</span><span class="w"> </span><span class="n">mov</span><span class="w"> </span><span class="n">esi</span><span class="p">,</span><span class="w"> </span><span class="n">ecx</span><span class="w"></span>
<span class="w">     </span><span class="o">|</span>:<span class="o">|</span><span class="w">   </span><span class="mh">0x00003b49</span><span class="w"> </span><span class="n">mov</span><span class="w"> </span><span class="n">ecx</span><span class="p">,</span><span class="w"> </span><span class="n">edx</span><span class="w"></span>
<span class="w">     </span><span class="o">|</span>:<span class="o">|</span><span class="w">   </span><span class="mh">0x00003b4c</span><span class="w"> </span><span class="n">mov</span><span class="w"> </span><span class="n">edx</span><span class="p">,</span><span class="w"> </span><span class="n">eax</span><span class="w"></span>
<span class="w">     </span><span class="o">|</span>:<span class="o">|</span><span class="w">   </span><span class="mh">0x00003b4f</span><span class="w"> </span><span class="n">mov</span><span class="w"> </span><span class="n">eax</span><span class="p">,</span><span class="w"> </span><span class="n">ecx</span><span class="w"></span>
<span class="w">     </span><span class="o">|</span>:<span class="o">|</span><span class="w">   </span><span class="mh">0x00003b52</span><span class="w"> </span><span class="n">test</span><span class="w"> </span><span class="n">eax</span><span class="p">,</span><span class="w"> </span><span class="n">eax</span><span class="w"></span>
<span class="w">     </span><span class="o">|</span><span class="err">`</span><span class="o">==&lt;</span><span class="w"> </span><span class="mh">0x00003b54</span><span class="w"> </span><span class="n">jne</span><span class="w"> </span><span class="mh">0x3ae7</span><span class="w"></span>
<span class="w">     </span><span class="err">`</span><span class="o">-</span><span class="err">`</span>-&gt; <span class="mh">0x00003b56</span><span class="w"> </span><span class="n">mov</span><span class="w"> </span><span class="n">eax</span><span class="p">,</span><span class="w"> </span><span class="n">dword</span><span class="w"> </span><span class="p">[</span><span class="n">local_ch</span><span class="p">]</span><span class="w"></span>
<span class="w">           </span><span class="mh">0x00003b5d</span><span class="w"> </span><span class="n">add</span><span class="w"> </span><span class="n">eax</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="w"></span>
<span class="w">           </span><span class="mh">0x00003b60</span><span class="w"> </span><span class="n">add</span><span class="w"> </span><span class="n">rsp</span><span class="p">,</span><span class="w"> </span><span class="mh">0x10</span><span class="w"></span>
<span class="w">           </span><span class="mh">0x00003b64</span><span class="w"> </span><span class="n">pop</span><span class="w"> </span><span class="n">rbp</span><span class="w"></span>
<span class="w">           </span><span class="mh">0x00003b65</span><span class="w"> </span><span class="n">ret</span><span class="w"></span>
</code></pre></div>
<p>with redundant reloads</p>
<p>in <a href="https://github.com/CraneStation/cranelift/commit/164f91a1f473e582e18e48d056c51787d9a1c24d"><code>164f91a</code></a> the redundant reloads are removed (<span aria-label="tada" class="emoji emoji-1f389" role="img" title="tada">:tada:</span>) but ends up picking (on x86-64) callee-save registers to load into, then producing</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="n">sym</span><span class="p">.</span><span class="n">guest_func_10</span><span class="w"> </span><span class="p">();</span><span class="w"></span>
<span class="w">           </span><span class="mh">0x00003ac0</span><span class="w"> </span><span class="n">push</span><span class="w"> </span><span class="n">rbp</span><span class="w"></span>
<span class="w">           </span><span class="mh">0x00003ac1</span><span class="w"> </span><span class="n">mov</span><span class="w"> </span><span class="n">rbp</span><span class="p">,</span><span class="w"> </span><span class="n">rsp</span><span class="w"></span>
<span class="w">           </span><span class="mh">0x00003ac4</span><span class="w"> </span><span class="n">push</span><span class="w"> </span><span class="n">r12</span><span class="w"></span>
<span class="w">           </span><span class="mh">0x00003ac6</span><span class="w"> </span><span class="n">push</span><span class="w"> </span><span class="n">r13</span><span class="w"></span>
<span class="w">           </span><span class="mh">0x00003ac8</span><span class="w"> </span><span class="n">push</span><span class="w"> </span><span class="n">r14</span><span class="w"></span>
<span class="w">           </span><span class="mh">0x00003aca</span><span class="w"> </span><span class="n">sub</span><span class="w"> </span><span class="n">rsp</span><span class="p">,</span><span class="w"> </span><span class="mh">0x18</span><span class="w"></span>
<span class="w">           </span><span class="mh">0x00003ace</span><span class="w"> </span><span class="n">mov</span><span class="w"> </span><span class="n">qword</span><span class="w"> </span><span class="p">[</span><span class="n">local_8h</span><span class="p">],</span><span class="w"> </span><span class="n">rdi</span><span class="w"></span>
<span class="w">           </span><span class="mh">0x00003ad6</span><span class="w"> </span><span class="n">mov</span><span class="w"> </span><span class="n">dword</span><span class="w"> </span><span class="p">[</span><span class="n">local_14h</span><span class="p">],</span><span class="w"> </span><span class="n">edx</span><span class="w"></span>
<span class="w">           </span><span class="mh">0x00003add</span><span class="w"> </span><span class="n">test</span><span class="w"> </span><span class="n">esi</span><span class="p">,</span><span class="w"> </span><span class="n">esi</span><span class="w"></span>
<span class="w">       </span><span class="p">,</span><span class="o">=&lt;</span><span class="w"> </span><span class="mh">0x00003adf</span><span class="w"> </span><span class="n">je</span><span class="w"> </span><span class="mh">0x3b48</span><span class="w"></span>
<span class="w">       </span><span class="o">|</span><span class="w">   </span><span class="mh">0x00003ae1</span><span class="w"> </span><span class="n">mov</span><span class="w"> </span><span class="n">eax</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="w"></span>
<span class="w">       </span><span class="o">|</span><span class="w">   </span><span class="mh">0x00003ae6</span><span class="w"> </span><span class="n">mov</span><span class="w"> </span><span class="n">dword</span><span class="w"> </span><span class="p">[</span><span class="n">local_14h</span><span class="p">],</span><span class="w"> </span><span class="n">eax</span><span class="w"></span>
<span class="w">     </span><span class="o">..-</span>-&gt; <span class="mh">0x00003aed</span><span class="w"> </span><span class="n">mov</span><span class="w"> </span><span class="n">eax</span><span class="p">,</span><span class="w"> </span><span class="n">esi</span><span class="w"></span>
<span class="w">     </span>::<span class="o">|</span><span class="w">   </span><span class="mh">0x00003aef</span><span class="w"> </span><span class="n">add</span><span class="w"> </span><span class="n">eax</span><span class="p">,</span><span class="w"> </span><span class="o">-</span><span class="mi">1</span><span class="w"></span>
<span class="w">     </span>::<span class="o">|</span><span class="w">   </span><span class="mh">0x00003af2</span><span class="w"> </span><span class="n">mov</span><span class="w"> </span><span class="n">dword</span><span class="w"> </span><span class="p">[</span><span class="n">local_10h</span><span class="p">],</span><span class="w"> </span><span class="n">eax</span><span class="w"></span>
<span class="w">     </span>::<span class="o">|</span><span class="w">   </span><span class="mh">0x00003af9</span><span class="w"> </span><span class="n">test</span><span class="w"> </span><span class="n">edx</span><span class="p">,</span><span class="w"> </span><span class="n">edx</span><span class="w"></span>
<span class="w">    </span><span class="p">,</span><span class="o">====&lt;</span><span class="w"> </span><span class="mh">0x00003afb</span><span class="w"> </span><span class="n">je</span><span class="w"> </span><span class="mh">0x3b2f</span><span class="w"></span>
<span class="w">    </span><span class="o">|</span>::<span class="o">|</span><span class="w">   </span><span class="mh">0x00003afd</span><span class="w"> </span><span class="n">add</span><span class="w"> </span><span class="n">edx</span><span class="p">,</span><span class="w"> </span><span class="o">-</span><span class="mi">1</span><span class="w"></span>
<span class="w">    </span><span class="o">|</span>::<span class="o">|</span><span class="w">   </span><span class="mh">0x00003b00</span><span class="w"> </span><span class="n">mov</span><span class="w"> </span><span class="n">r14</span><span class="p">,</span><span class="w"> </span><span class="n">qword</span><span class="w"> </span><span class="p">[</span><span class="n">local_8h</span><span class="p">]</span><span class="w"></span>
<span class="w">    </span><span class="o">|</span>::<span class="o">|</span><span class="w">   </span><span class="mh">0x00003b08</span><span class="w"> </span><span class="n">mov</span><span class="w"> </span><span class="n">rdi</span><span class="p">,</span><span class="w"> </span><span class="n">r14</span><span class="w"></span>
<span class="w">    </span><span class="o">|</span>::<span class="o">|</span><span class="w">   </span><span class="mh">0x00003b0b</span><span class="w"> </span><span class="n">call</span><span class="w"> </span><span class="n">sym</span><span class="p">.</span><span class="n">guest_func_10</span><span class="w"></span>
<span class="w">    </span><span class="o">|</span>::<span class="o">|</span><span class="w">   </span><span class="mh">0x00003b10</span><span class="w"> </span><span class="n">mov</span><span class="w"> </span><span class="n">r14d</span><span class="p">,</span><span class="w"> </span><span class="n">dword</span><span class="w"> </span><span class="p">[</span><span class="n">local_10h</span><span class="p">]</span><span class="w"></span>
<span class="w">    </span><span class="o">|</span>::<span class="o">|</span><span class="w">   </span><span class="mh">0x00003b18</span><span class="w"> </span><span class="n">mov</span><span class="w"> </span><span class="n">r13d</span><span class="p">,</span><span class="w"> </span><span class="n">r14d</span><span class="w"></span>
<span class="w">    </span><span class="o">|</span>::<span class="o">|</span><span class="w">   </span><span class="mh">0x00003b1b</span><span class="w"> </span><span class="n">mov</span><span class="w"> </span><span class="n">esi</span><span class="p">,</span><span class="w"> </span><span class="n">r14d</span><span class="w"></span>
<span class="w">    </span><span class="o">|</span>::<span class="o">|</span><span class="w">   </span><span class="mh">0x00003b1e</span><span class="w"> </span><span class="n">mov</span><span class="w"> </span><span class="n">edx</span><span class="p">,</span><span class="w"> </span><span class="n">eax</span><span class="w"></span>
<span class="w">    </span><span class="o">|</span>::<span class="o">|</span><span class="w">   </span><span class="mh">0x00003b21</span><span class="w"> </span><span class="n">test</span><span class="w"> </span><span class="n">r13d</span><span class="p">,</span><span class="w"> </span><span class="n">r13d</span><span class="w"></span>
<span class="w">    </span><span class="o">|</span><span class="err">`</span><span class="o">===&lt;</span><span class="w"> </span><span class="mh">0x00003b24</span><span class="w"> </span><span class="n">jne</span><span class="w"> </span><span class="mh">0x3aed</span><span class="w"></span>
<span class="w">    </span><span class="o">|</span><span class="w"> </span>:<span class="o">|</span><span class="w">   </span><span class="mh">0x00003b26</span><span class="w"> </span><span class="n">mov</span><span class="w"> </span><span class="n">dword</span><span class="w"> </span><span class="p">[</span><span class="n">local_14h</span><span class="p">],</span><span class="w"> </span><span class="n">edx</span><span class="w"></span>
<span class="w">    </span><span class="o">|</span><span class="p">,</span><span class="o">===&lt;</span><span class="w"> </span><span class="mh">0x00003b2d</span><span class="w"> </span><span class="n">jmp</span><span class="w"> </span><span class="mh">0x3b48</span><span class="w"></span>
<span class="w">    </span><span class="err">`</span><span class="o">---</span>-&gt; <span class="mh">0x00003b2f</span><span class="w"> </span><span class="n">mov</span><span class="w"> </span><span class="n">r14d</span><span class="p">,</span><span class="w"> </span><span class="n">dword</span><span class="w"> </span><span class="p">[</span><span class="n">local_14h</span><span class="p">]</span><span class="w"></span>
<span class="w">     </span><span class="o">|</span>:<span class="o">|</span><span class="w">   </span><span class="mh">0x00003b37</span><span class="w"> </span><span class="n">mov</span><span class="w"> </span><span class="n">r13d</span><span class="p">,</span><span class="w"> </span><span class="n">eax</span><span class="w"></span>
<span class="w">     </span><span class="o">|</span>:<span class="o">|</span><span class="w">   </span><span class="mh">0x00003b3a</span><span class="w"> </span><span class="n">mov</span><span class="w"> </span><span class="n">r12d</span><span class="p">,</span><span class="w"> </span><span class="n">eax</span><span class="w"></span>
<span class="w">     </span><span class="o">|</span>:<span class="o">|</span><span class="w">   </span><span class="mh">0x00003b3d</span><span class="w"> </span><span class="n">mov</span><span class="w"> </span><span class="n">esi</span><span class="p">,</span><span class="w"> </span><span class="n">r13d</span><span class="w"></span>
<span class="w">     </span><span class="o">|</span>:<span class="o">|</span><span class="w">   </span><span class="mh">0x00003b40</span><span class="w"> </span><span class="n">mov</span><span class="w"> </span><span class="n">edx</span><span class="p">,</span><span class="w"> </span><span class="n">r14d</span><span class="w"></span>
<span class="w">     </span><span class="o">|</span>:<span class="o">|</span><span class="w">   </span><span class="mh">0x00003b43</span><span class="w"> </span><span class="n">test</span><span class="w"> </span><span class="n">r12d</span><span class="p">,</span><span class="w"> </span><span class="n">r12d</span><span class="w"></span>
<span class="w">     </span><span class="o">|</span><span class="err">`</span><span class="o">==&lt;</span><span class="w"> </span><span class="mh">0x00003b46</span><span class="w"> </span><span class="n">jne</span><span class="w"> </span><span class="mh">0x3aed</span><span class="w"></span>
<span class="w">     </span><span class="err">`</span><span class="o">-</span><span class="err">`</span>-&gt; <span class="mh">0x00003b48</span><span class="w"> </span><span class="n">mov</span><span class="w"> </span><span class="n">r14d</span><span class="p">,</span><span class="w"> </span><span class="n">dword</span><span class="w"> </span><span class="p">[</span><span class="n">local_14h</span><span class="p">]</span><span class="w"></span>
<span class="w">           </span><span class="mh">0x00003b50</span><span class="w"> </span><span class="n">add</span><span class="w"> </span><span class="n">r14d</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="w"></span>
<span class="w">           </span><span class="mh">0x00003b54</span><span class="w"> </span><span class="n">mov</span><span class="w"> </span><span class="n">eax</span><span class="p">,</span><span class="w"> </span><span class="n">r14d</span><span class="w"></span>
<span class="w">           </span><span class="mh">0x00003b57</span><span class="w"> </span><span class="n">add</span><span class="w"> </span><span class="n">rsp</span><span class="p">,</span><span class="w"> </span><span class="mh">0x18</span><span class="w"></span>
<span class="w">           </span><span class="mh">0x00003b5b</span><span class="w"> </span><span class="n">pop</span><span class="w"> </span><span class="n">r14</span><span class="w"></span>
<span class="w">           </span><span class="mh">0x00003b5d</span><span class="w"> </span><span class="n">pop</span><span class="w"> </span><span class="n">r13</span><span class="w"></span>
<span class="w">           </span><span class="mh">0x00003b5f</span><span class="w"> </span><span class="n">pop</span><span class="w"> </span><span class="n">r12</span><span class="w"></span>
<span class="w">           </span><span class="mh">0x00003b61</span><span class="w"> </span><span class="n">pop</span><span class="w"> </span><span class="n">rbp</span><span class="w"></span>
<span class="w">           </span><span class="mh">0x00003b62</span><span class="w"> </span><span class="n">ret</span><span class="w"></span>
</code></pre></div>
<p>because of the callee-save use here we end up net +3 memory accesses from push/pops, even though three redundant loads were removed</p>
<p>In a particularly contorted benchmark (Lucet's <code>ackermann</code> benchmark) this ends up dropping runtime by ~30%, though I think in most cases it's probably about the same before and after.</p>
<p>ediit: didn't include addresses initially, which didn't read well</p>
</blockquote>



<hr><p>Last updated: Jan 20 2025 at 06:04 UTC</p>
</html>