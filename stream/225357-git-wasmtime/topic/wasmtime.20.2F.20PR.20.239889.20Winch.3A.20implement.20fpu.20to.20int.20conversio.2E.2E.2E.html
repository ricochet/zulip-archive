<html>
<head><meta charset="utf-8"><title>wasmtime / PR #9889 Winch: implement fpu to int conversio... · git-wasmtime · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/index.html">git-wasmtime</a></h2>
<h3>Topic: <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.239889.20Winch.3A.20implement.20fpu.20to.20int.20conversio.2E.2E.2E.html">wasmtime / PR #9889 Winch: implement fpu to int conversio...</a></h3>

<hr>

<base href="https://bytecodealliance.zulipchat.com">

<head><link href="https://bytecodealliance.github.io/zulip-archive/style.css" rel="stylesheet"></head>

<a name="490317243"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%239889%20Winch%3A%20implement%20fpu%20to%20int%20conversio.../near/490317243" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.239889.20Winch.3A.20implement.20fpu.20to.20int.20conversio.2E.2E.2E.html#490317243">(Dec 21 2024 at 17:56)</a>:</h4>
<p>MarinPostma edited <a href="https://github.com/bytecodealliance/wasmtime/pull/9889">PR #9889</a>.</p>



<a name="491516850"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%239889%20Winch%3A%20implement%20fpu%20to%20int%20conversio.../near/491516850" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.239889.20Winch.3A.20implement.20fpu.20to.20int.20conversio.2E.2E.2E.html#491516850">(Jan 01 2025 at 17:47)</a>:</h4>
<p>saulecabrera <a href="https://github.com/bytecodealliance/wasmtime/pull/9889#issuecomment-2567092704">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/9889">PR #9889</a>:</p>
<blockquote>
<p>I can help reviewing this one. </p>
</blockquote>



<a name="491516855"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%239889%20Winch%3A%20implement%20fpu%20to%20int%20conversio.../near/491516855" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.239889.20Winch.3A.20implement.20fpu.20to.20int.20conversio.2E.2E.2E.html#491516855">(Jan 01 2025 at 17:47)</a>:</h4>
<p><strong>saulecabrera</strong> requested <a href="https://github.com/saulecabrera">saulecabrera</a> for a review on <a href="https://github.com/bytecodealliance/wasmtime/pull/9889">PR #9889</a>.</p>



<a name="491646991"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%239889%20Winch%3A%20implement%20fpu%20to%20int%20conversio.../near/491646991" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.239889.20Winch.3A.20implement.20fpu.20to.20int.20conversio.2E.2E.2E.html#491646991">(Jan 02 2025 at 18:12)</a>:</h4>
<p>saulecabrera submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/9889#pullrequestreview-2527896742">PR review</a>:</p>
<blockquote>
<p>Looking good. Left some comments inline.</p>
<p>As a general comment, the <code>emit_*</code> naming convention is not standard across the assembler implementations (as noted and fixed in <a href="https://github.com/bytecodealliance/wasmtime/pull/9918">https://github.com/bytecodealliance/wasmtime/pull/9918</a>), so I´d suggest dropping the <code>emit_</code> prefix in the assembler methods introduced in this PR. </p>
</blockquote>



<a name="491646992"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%239889%20Winch%3A%20implement%20fpu%20to%20int%20conversio.../near/491646992" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.239889.20Winch.3A.20implement.20fpu.20to.20int.20conversio.2E.2E.2E.html#491646992">(Jan 02 2025 at 18:12)</a>:</h4>
<p>saulecabrera created <a href="https://github.com/bytecodealliance/wasmtime/pull/9889#discussion_r1901079539">PR review comment</a>:</p>
<blockquote>
<p>Similar comment here, I think it should be possible to omit the <code>OperandSize</code> prefix in both match arms. </p>
</blockquote>



<a name="491646994"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%239889%20Winch%3A%20implement%20fpu%20to%20int%20conversio.../near/491646994" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.239889.20Winch.3A.20implement.20fpu.20to.20int.20conversio.2E.2E.2E.html#491646994">(Jan 02 2025 at 18:12)</a>:</h4>
<p>saulecabrera created <a href="https://github.com/bytecodealliance/wasmtime/pull/9889#discussion_r1901078851">PR review comment</a>:</p>
<blockquote>
<p>Nit: I believe that here and in the next match arm below you can omit the <code>OperandSize::</code> prefix given that you're already importing it above (e.g., <code>use OperandSize::*</code>)</p>
</blockquote>



<a name="491646995"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%239889%20Winch%3A%20implement%20fpu%20to%20int%20conversio.../near/491646995" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.239889.20Winch.3A.20implement.20fpu.20to.20int.20conversio.2E.2E.2E.html#491646995">(Jan 02 2025 at 18:12)</a>:</h4>
<p>saulecabrera created <a href="https://github.com/bytecodealliance/wasmtime/pull/9889#discussion_r1901073856">PR review comment</a>:</p>
<blockquote>
<p><div class="codehilite" data-code-language="suggestion"><pre><span></span><code>    /// Load the max value for an integer of size out_size, as a floating-point
    /// of size `in_size`, into register `rd`.
</code></pre></div><br>
</p>
</blockquote>



<a name="491646996"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%239889%20Winch%3A%20implement%20fpu%20to%20int%20conversio.../near/491646996" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.239889.20Winch.3A.20implement.20fpu.20to.20int.20conversio.2E.2E.2E.html#491646996">(Jan 02 2025 at 18:12)</a>:</h4>
<p>saulecabrera created <a href="https://github.com/bytecodealliance/wasmtime/pull/9889#discussion_r1901137302">PR review comment</a>:</p>
<blockquote>
<p>I´d suggest avoiding passing a placeholder register here. The temp register that is passed to <code>unsigned_truncate</code> is an allocatable register, therefore there's very little chance of it getting unintentionally clobbered.  Instead having a single implementation for both cases, I´d suggest breaking down the implementation in the assembler into two methods, one for each case (signed/unsigned), then in each implementation you can decide to use the scratch register, immediately before emission, without the risk of unintentionally clobbering it. This is similar to how the x64 assembler implementation works. </p>
</blockquote>



<a name="491646997"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%239889%20Winch%3A%20implement%20fpu%20to%20int%20conversio.../near/491646997" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.239889.20Winch.3A.20implement.20fpu.20to.20int.20conversio.2E.2E.2E.html#491646997">(Jan 02 2025 at 18:12)</a>:</h4>
<p>saulecabrera created <a href="https://github.com/bytecodealliance/wasmtime/pull/9889#discussion_r1901121925">PR review comment</a>:</p>
<blockquote>
<p>If we're writing to <code>tmp_reg</code>, I think this should be defined in the signature, similar to <code>dst</code>: <code>tmp_reg: Writable&lt;Reg&gt;</code></p>
</blockquote>



<a name="491646998"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%239889%20Winch%3A%20implement%20fpu%20to%20int%20conversio.../near/491646998" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.239889.20Winch.3A.20implement.20fpu.20to.20int.20conversio.2E.2E.2E.html#491646998">(Jan 02 2025 at 18:12)</a>:</h4>
<p>saulecabrera created <a href="https://github.com/bytecodealliance/wasmtime/pull/9889#discussion_r1901068773">PR review comment</a>:</p>
<blockquote>
<p>Here we don´t need to duplicate this method, <code>fcmp</code> already exists. </p>
</blockquote>



<a name="491766351"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%239889%20Winch%3A%20implement%20fpu%20to%20int%20conversio.../near/491766351" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.239889.20Winch.3A.20implement.20fpu.20to.20int.20conversio.2E.2E.2E.html#491766351">(Jan 03 2025 at 14:36)</a>:</h4>
<p>MarinPostma submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/9889#pullrequestreview-2529184719">PR review</a>.</p>



<a name="491766352"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%239889%20Winch%3A%20implement%20fpu%20to%20int%20conversio.../near/491766352" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.239889.20Winch.3A.20implement.20fpu.20to.20int.20conversio.2E.2E.2E.html#491766352">(Jan 03 2025 at 14:36)</a>:</h4>
<p>MarinPostma created <a href="https://github.com/bytecodealliance/wasmtime/pull/9889#discussion_r1901843347">PR review comment</a>:</p>
<blockquote>
<p>To make sure I understand, similarly to how x86 implementation, you would like to have two methods, <code>fpu_to_sint</code> and <code>fpu_to_uint</code> in asm, and also, those methods should be passed a temporary register in <code>masm</code>, rather than using the provided one in the case of <code>unsigned_truncate</code>?</p>
<p>I have a few questions/remarks:</p>
<ul>
<li>what is the purpose of the temp reg in the <code>unsigned</code> variant? Why must this registry be allocated rather than used as a temp register? Is the caller expecting to find something in there? It is not explicitly passed as a writable register, but the x64 implementation implicitly converts it to one.</li>
<li>While splitting the <code>convert_</code> methods for x64 makes sense to me since they correspond to a single instruction, we must emit a bunch of checks that are aware of the sign in the case of aarch64. Do you suggest duplicating all the checks in signed and unsigned variants? Or do we have two methods in ASM that call the current implementation with the <code>signed</code> argument set accordingly?</li>
<li>I'm sorry if that sounds very ignorant, but why do we have to worry about clobbering a tmp register anyway? Can't it, by definition, be used for any purpose, and one should not have too strong an assumption about what it may contain, especially when handing it over to a callee?</li>
<li>I'm surely missing something, but it seems to me that splitting the <code>convert</code> method into a signed and unsigned variant, and the use of tmp regs are orthogonal things, so I want to make sure I understand what you want correctly :)</li>
</ul>
</blockquote>



<a name="491766831"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%239889%20Winch%3A%20implement%20fpu%20to%20int%20conversio.../near/491766831" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.239889.20Winch.3A.20implement.20fpu.20to.20int.20conversio.2E.2E.2E.html#491766831">(Jan 03 2025 at 14:41)</a>:</h4>
<p>MarinPostma <a href="https://github.com/bytecodealliance/wasmtime/pull/9889#issuecomment-2569331751">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/9889">PR #9889</a>:</p>
<blockquote>
<p>@saulecabrera I addressed most of the review comments but left a few questions</p>
</blockquote>



<a name="491767347"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%239889%20Winch%3A%20implement%20fpu%20to%20int%20conversio.../near/491767347" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.239889.20Winch.3A.20implement.20fpu.20to.20int.20conversio.2E.2E.2E.html#491767347">(Jan 03 2025 at 14:45)</a>:</h4>
<p>MarinPostma updated <a href="https://github.com/bytecodealliance/wasmtime/pull/9889">PR #9889</a>.</p>



<a name="491767447"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%239889%20Winch%3A%20implement%20fpu%20to%20int%20conversio.../near/491767447" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.239889.20Winch.3A.20implement.20fpu.20to.20int.20conversio.2E.2E.2E.html#491767447">(Jan 03 2025 at 14:46)</a>:</h4>
<p>MarinPostma updated <a href="https://github.com/bytecodealliance/wasmtime/pull/9889">PR #9889</a>.</p>



<a name="491889904"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%239889%20Winch%3A%20implement%20fpu%20to%20int%20conversio.../near/491889904" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.239889.20Winch.3A.20implement.20fpu.20to.20int.20conversio.2E.2E.2E.html#491889904">(Jan 04 2025 at 16:38)</a>:</h4>
<p>saulecabrera submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/9889#pullrequestreview-2530765154">PR review</a>.</p>



<a name="491889905"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%239889%20Winch%3A%20implement%20fpu%20to%20int%20conversio.../near/491889905" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.239889.20Winch.3A.20implement.20fpu.20to.20int.20conversio.2E.2E.2E.html#491889905">(Jan 04 2025 at 16:38)</a>:</h4>
<p>saulecabrera created <a href="https://github.com/bytecodealliance/wasmtime/pull/9889#discussion_r1903123268">PR review comment</a>:</p>
<blockquote>
<p>The purpose of the allocatable temporary register is to provide an extra<br>
register to aid in the emission of the instruction sequence needed for the<br>
unsigned case; in x64, 4 registers are required for the instruction sequence:<br>
1 for the destination and 3 temporary registers. Since in the case of x64 the<br>
instruction sequence is completely handled by Cranelift, there's no risk of<br>
unintentionally clobbering any of the registers passed to it, the unintentional<br>
clobbering risk is particularly important in the case of scratch registers in Winch: even<br>
though they can be used for any purpose, one important detail about them is that<br>
they are not tracked by Winch's regalloc therefore they must be used sparingly<br>
and with extreme caution: a misuse could result in unintentional clobbering and<br>
therefore subtle bugs. Ideally, the live range of the scratch registers should be<br>
as short as possible to avoid potential bugs.</p>
<p>In this particular case the reason why I am suggestion improving the usage of<br>
the scratch register is to minimize the risk of unintentional clobbering of such<br>
registers: once a scratch register is passed as a parameter, its live range is<br>
extended and the risk of misuse is greater. A concrete example in this case of<br>
a potential risk of unintentional clobbering is passing the scratch register to<br>
<code>fpu_to_int</code> and then using the float scratch register in any of the methods<br>
needed for the instruction sequence needed to fulfill the truncate instructions<br>
(this is not the case today, but by passing the float scratch register around as<br>
if it were any other register, it becomes harder to reason and audit in the<br>
future).</p>
<p>There are some alternatives that I've thought about to improve the<br>
handling/usage of the scratch registers to address some of the challenges<br>
exposed in the previous paragraph. We could discuss those in a separate<br>
issue/PR (e.g., relying on the type system to identify/audit scratch register usage and/or<br>
providing exclusive access to the scratch registers, similar to what we have for<br>
the allocatable registers). Care needs to be taken here to ensure that none of<br>
the solutions explored affect compilation performance. </p>
<p>Taking a deeper look at your changes for the unsigned case, only 3 registers are<br>
needed here compared to the x64 implementation which demands 4. This  means that<br>
you can effectively ignore the temporary register defined in the Masm<br>
<code>unsigned_truncate</code> signature and only rely on the float scratch register.</p>
<p>Taking this into account, my concrete suggestion to move forward here is to:</p>
<ul>
<li>Redefine the <code>unsigned_truncate</code> signature to be:</li>
</ul>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="k">fn</span><span class="w"> </span><span class="nf">unsigned_truncate</span><span class="p">(</span>
<span class="w">    </span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="bp">self</span><span class="p">,</span>
<span class="w">    </span><span class="n">context</span><span class="p">:</span><span class="w"> </span><span class="kp">&amp;</span><span class="nc">mut</span><span class="w"> </span><span class="n">CodeGenContext</span><span class="o">&lt;</span><span class="n">Emission</span><span class="o">&gt;</span><span class="p">,</span>
<span class="w">    </span><span class="n">src_size</span><span class="p">:</span><span class="w"> </span><span class="nc">OperandSize</span><span class="p">,</span>
<span class="w">    </span><span class="n">dst_size</span><span class="p">:</span><span class="w"> </span><span class="nc">OperandSize</span><span class="p">,</span>
<span class="w">    </span><span class="n">kind</span><span class="p">:</span><span class="w"> </span><span class="nc">TruncKind</span>
<span class="p">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w"> </span><span class="nb">Result</span><span class="o">&lt;</span><span class="p">()</span><span class="o">&gt;</span><span class="p">;</span>
</code></pre></div>
<p>This allows maximum flexibility to encode the ISA differences and more<br>
importantly reduces register pressure in cases where only 3 registers are<br>
needed, reducing unnecessary register pressure where possible is important to<br>
minimize memory traffic. </p>
<p>This is similar to how we handle the <code>div</code> instruction, given that the<br>
requirements vary between ISAs.</p>
<ul>
<li>Redefine <code>fpu_to_int</code> to be:</li>
</ul>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="k">fn</span><span class="w"> </span><span class="nf">fpu_to_int</span><span class="p">(</span>
<span class="w">    </span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="bp">self</span><span class="p">,</span>
<span class="w">    </span><span class="n">dst</span><span class="p">:</span><span class="w"> </span><span class="nc">Writable</span><span class="o">&lt;</span><span class="n">Reg</span><span class="o">&gt;</span><span class="p">,</span>
<span class="w">    </span><span class="n">src</span><span class="p">:</span><span class="w"> </span><span class="nc">Reg</span><span class="p">,</span>
<span class="w">    </span><span class="n">src_size</span><span class="p">:</span><span class="w"> </span><span class="nc">OperandSize</span><span class="p">,</span>
<span class="w">    </span><span class="n">dst_size</span><span class="p">:</span><span class="w"> </span><span class="nc">OperandSize</span><span class="p">,</span>
<span class="w">    </span><span class="n">kind</span><span class="p">:</span><span class="w"> </span><span class="nc">TruncKind</span><span class="p">,</span>
<span class="w">    </span><span class="n">signed</span><span class="p">:</span><span class="w"> </span><span class="kt">bool</span>
<span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="o">..</span><span class="p">.</span><span class="w"> </span><span class="p">};</span>
</code></pre></div>
<p>Avoiding passing the scratch registers as params and shortening their live<br>
range as much as possible by using them explicitly in each of the helper<br>
functions that you have to fulfill the instruction sequence. </p>
<hr>
<p>I believe that with this approach, my concerns will be addressed and there won't<br>
be a need to split the signed/unsigned implementations (initially I was confused<br>
with the <code>TODO</code> comment in the code and had assumed that the implementation was<br>
making use of a scratch register that wasn't actually needed, although that's<br>
not the case). </p>
</blockquote>



<a name="491889921"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%239889%20Winch%3A%20implement%20fpu%20to%20int%20conversio.../near/491889921" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.239889.20Winch.3A.20implement.20fpu.20to.20int.20conversio.2E.2E.2E.html#491889921">(Jan 04 2025 at 16:38)</a>:</h4>
<p>saulecabrera edited <a href="https://github.com/bytecodealliance/wasmtime/pull/9889#discussion_r1903123268">PR review comment</a>.</p>



<a name="491894284"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%239889%20Winch%3A%20implement%20fpu%20to%20int%20conversio.../near/491894284" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.239889.20Winch.3A.20implement.20fpu.20to.20int.20conversio.2E.2E.2E.html#491894284">(Jan 04 2025 at 17:49)</a>:</h4>
<p>MarinPostma submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/9889#pullrequestreview-2530772873">PR review</a>.</p>



<a name="491894285"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%239889%20Winch%3A%20implement%20fpu%20to%20int%20conversio.../near/491894285" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.239889.20Winch.3A.20implement.20fpu.20to.20int.20conversio.2E.2E.2E.html#491894285">(Jan 04 2025 at 17:49)</a>:</h4>
<p>MarinPostma created <a href="https://github.com/bytecodealliance/wasmtime/pull/9889#discussion_r1903131962">PR review comment</a>:</p>
<blockquote>
<p>Thanks a lot for the detailed writeup! This makes things a lot clearer. I'll make the changes <span aria-label="+1" class="emoji emoji-1f44d" role="img" title="+1">:+1:</span> </p>
</blockquote>



<a name="491918699"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%239889%20Winch%3A%20implement%20fpu%20to%20int%20conversio.../near/491918699" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.239889.20Winch.3A.20implement.20fpu.20to.20int.20conversio.2E.2E.2E.html#491918699">(Jan 04 2025 at 23:47)</a>:</h4>
<p>MarinPostma updated <a href="https://github.com/bytecodealliance/wasmtime/pull/9889">PR #9889</a>.</p>



<a name="491918972"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%239889%20Winch%3A%20implement%20fpu%20to%20int%20conversio.../near/491918972" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.239889.20Winch.3A.20implement.20fpu.20to.20int.20conversio.2E.2E.2E.html#491918972">(Jan 04 2025 at 23:51)</a>:</h4>
<p>MarinPostma <a href="https://github.com/bytecodealliance/wasmtime/pull/9889#issuecomment-2571442814">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/9889">PR #9889</a>:</p>
<blockquote>
<p>@saulecabrera I have made the requested changes</p>
</blockquote>



<a name="491983919"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%239889%20Winch%3A%20implement%20fpu%20to%20int%20conversio.../near/491983919" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.239889.20Winch.3A.20implement.20fpu.20to.20int.20conversio.2E.2E.2E.html#491983919">(Jan 05 2025 at 17:31)</a>:</h4>
<p>saulecabrera submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/9889#pullrequestreview-2530938351">PR review</a>:</p>
<blockquote>
<p>Looks great! Thanks for all your patience iterating on this. Left two minor comments and then we should be able to land this one. </p>
</blockquote>



<a name="491983920"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%239889%20Winch%3A%20implement%20fpu%20to%20int%20conversio.../near/491983920" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.239889.20Winch.3A.20implement.20fpu.20to.20int.20conversio.2E.2E.2E.html#491983920">(Jan 05 2025 at 17:31)</a>:</h4>
<p>saulecabrera created <a href="https://github.com/bytecodealliance/wasmtime/pull/9889#discussion_r1903311241">PR review comment</a>:</p>
<blockquote>
<p>Similar here, you can use  the appropriate error constructor. </p>
</blockquote>



<a name="491983921"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%239889%20Winch%3A%20implement%20fpu%20to%20int%20conversio.../near/491983921" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.239889.20Winch.3A.20implement.20fpu.20to.20int.20conversio.2E.2E.2E.html#491983921">(Jan 05 2025 at 17:31)</a>:</h4>
<p>saulecabrera created <a href="https://github.com/bytecodealliance/wasmtime/pull/9889#discussion_r1903311090">PR review comment</a>:</p>
<blockquote>
<p>Here you can use <code>CodeGenError::unexpected_operand_size()</code> instead. <a href="https://github.com/bytecodealliance/wasmtime/blob/main/winch/codegen/src/codegen/error.rs#L139">https://github.com/bytecodealliance/wasmtime/blob/main/winch/codegen/src/codegen/error.rs#L139</a></p>
</blockquote>



<a name="492321508"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%239889%20Winch%3A%20implement%20fpu%20to%20int%20conversio.../near/492321508" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.239889.20Winch.3A.20implement.20fpu.20to.20int.20conversio.2E.2E.2E.html#492321508">(Jan 07 2025 at 14:37)</a>:</h4>
<p>MarinPostma updated <a href="https://github.com/bytecodealliance/wasmtime/pull/9889">PR #9889</a>.</p>



<a name="492321624"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%239889%20Winch%3A%20implement%20fpu%20to%20int%20conversio.../near/492321624" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.239889.20Winch.3A.20implement.20fpu.20to.20int.20conversio.2E.2E.2E.html#492321624">(Jan 07 2025 at 14:38)</a>:</h4>
<p>MarinPostma <a href="https://github.com/bytecodealliance/wasmtime/pull/9889#issuecomment-2575458912">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/9889">PR #9889</a>:</p>
<blockquote>
<p>It should be good now @saulecabrera </p>
</blockquote>



<a name="492328324"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%239889%20Winch%3A%20implement%20fpu%20to%20int%20conversio.../near/492328324" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.239889.20Winch.3A.20implement.20fpu.20to.20int.20conversio.2E.2E.2E.html#492328324">(Jan 07 2025 at 15:12)</a>:</h4>
<p>saulecabrera submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/9889#pullrequestreview-2534593692">PR review</a>:</p>
<blockquote>
<p>Thanks!</p>
</blockquote>



<a name="492332397"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%239889%20Winch%3A%20implement%20fpu%20to%20int%20conversio.../near/492332397" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.239889.20Winch.3A.20implement.20fpu.20to.20int.20conversio.2E.2E.2E.html#492332397">(Jan 07 2025 at 15:30)</a>:</h4>
<p>saulecabrera merged <a href="https://github.com/bytecodealliance/wasmtime/pull/9889">PR #9889</a>.</p>



<hr><p>Last updated: Jan 20 2025 at 06:04 UTC</p>
</html>