<html>
<head><meta charset="utf-8"><title>wasmtime / issue #3785 [RFC] ISLE: Migrate call and retur... · git-wasmtime · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/index.html">git-wasmtime</a></h2>
<h3>Topic: <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.233785.20.5BRFC.5D.20ISLE.3A.20Migrate.20call.20and.20retur.2E.2E.2E.html">wasmtime / issue #3785 [RFC] ISLE: Migrate call and retur...</a></h3>

<hr>

<base href="https://bytecodealliance.zulipchat.com">

<head><link href="https://bytecodealliance.github.io/zulip-archive/style.css" rel="stylesheet"></head>

<a name="271279653"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%233785%20%5BRFC%5D%20ISLE%3A%20Migrate%20call%20and%20retur.../near/271279653" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.233785.20.5BRFC.5D.20ISLE.3A.20Migrate.20call.20and.20retur.2E.2E.2E.html#271279653">(Feb 09 2022 at 13:49)</a>:</h4>
<p>github-actions[bot] <a href="https://github.com/bytecodealliance/wasmtime/pull/3785#issuecomment-1033780680">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/3785">issue #3785</a>:</p>
<blockquote>
<h4>Subscribe to Label Action</h4>
<p>cc @cfallin, @fitzgen</p>
<p>&lt;details&gt;<br>
This issue or pull request has been labeled: "cranelift", "cranelift:area:aarch64", "cranelift:area:machinst", "cranelift:area:x64", "isle"</p>
<p>Thus the following users have been cc'd because of the following labels:</p>
<ul>
<li>cfallin: isle</li>
<li>fitzgen: isle</li>
</ul>
<p>To subscribe or unsubscribe from this label, edit the &lt;code&gt;.github/subscribe-to-label.json&lt;/code&gt; configuration file.</p>
<p><a href="https://github.com/bytecodealliance/subscribe-to-label-action">Learn more.</a><br>
&lt;/details&gt;</p>
</blockquote>



<a name="273170562"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%233785%20%5BRFC%5D%20ISLE%3A%20Migrate%20call%20and%20retur.../near/273170562" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.233785.20.5BRFC.5D.20ISLE.3A.20Migrate.20call.20and.20retur.2E.2E.2E.html#273170562">(Feb 25 2022 at 00:42)</a>:</h4>
<p>uweigand <a href="https://github.com/bytecodealliance/wasmtime/pull/3785#issuecomment-1050402549">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/3785">issue #3785</a>:</p>
<blockquote>
<p>Rebased now that both prerequisite PRs were merged.  This is probably still not quite ready to merge, but I'd certainly appreciate any comments!</p>
</blockquote>



<a name="282527678"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%233785%20%5BRFC%5D%20ISLE%3A%20Migrate%20call%20and%20retur.../near/282527678" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.233785.20.5BRFC.5D.20ISLE.3A.20Migrate.20call.20and.20retur.2E.2E.2E.html#282527678">(May 16 2022 at 17:02)</a>:</h4>
<p>uweigand <a href="https://github.com/bytecodealliance/wasmtime/pull/3785#issuecomment-1127915414">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/3785">issue #3785</a>:</p>
<blockquote>
<p>Hi @cfallin, this doesn't implement the <code>ABISig</code> refactor yet, it's just a rebase to current mainline.</p>
<p>However, this shows the regalloc issue I was mentioning earlier today.  You'll notice the patch changes the <code>reftypes.clif</code> file, which shows the regalloc regression I've been seeing.  Note the one additional move in (new) line 80, and the extra use of call-clobbered register <code>%r10</code>.<br>
</p>
</blockquote>



<a name="282528586"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%233785%20%5BRFC%5D%20ISLE%3A%20Migrate%20call%20and%20retur.../near/282528586" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.233785.20.5BRFC.5D.20ISLE.3A.20Migrate.20call.20and.20retur.2E.2E.2E.html#282528586">(May 16 2022 at 17:08)</a>:</h4>
<p>uweigand edited a <a href="https://github.com/bytecodealliance/wasmtime/pull/3785#issuecomment-1127915414">comment</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/3785">issue #3785</a>:</p>
<blockquote>
<p>Hi @cfallin, this doesn't implement the <code>ABISig</code> refactor yet, it's just a rebase to current mainline.</p>
<p>However, this shows the regalloc issue I was mentioning earlier today.  You'll notice the patch changes the <code>reftypes.clif</code> file, which shows the regalloc regression I've been seeing.  Note the one additional move in (new) line 80, and the extra use of call-saved register <code>%r10</code>.<br>
</p>
</blockquote>



<a name="282563016"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%233785%20%5BRFC%5D%20ISLE%3A%20Migrate%20call%20and%20retur.../near/282563016" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.233785.20.5BRFC.5D.20ISLE.3A.20Migrate.20call.20and.20retur.2E.2E.2E.html#282563016">(May 16 2022 at 21:26)</a>:</h4>
<p>cfallin <a href="https://github.com/bytecodealliance/wasmtime/pull/3785#issuecomment-1128154020">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/3785">issue #3785</a>:</p>
<blockquote>
<p>@uweigand I spent a few hours digging into exactly why the extra move occurs here, to see if there is anything actionable. To summarize, here is what's going on:</p>
<ul>
<li>There is a liverange from the definition of the ref (initially a move-from-preg to pick up the arg value in r3) until its return at the bottom of the function.</li>
<li>When building this liverange, we add uses that constrain to preg r3, and later that constrain to stack at the safepoint.</li>
<li>We recognize that this is a conflict, so we split.</li>
<li>The split nominally happens just before the conflict -- inst4 at the safepoint -- so we get a new LR and bundle starting at inst4 until return at inst12, and the original LR at inst1..inst4.</li>
<li>But the "spill bundle" mechanism that tries to have a common fallback location between LRs-with-actual-uses chops off the bit of the first bundle after the def, so we get a bundle at inst1..inst1 with preg constraint r3, a backing spill bundle, and a bundle at inst4..inst12 with constraint to stack.</li>
<li>The "second chance" logic tries to assign a register to every spill bundle before giving up and giving it a stack slot. In this case the spill bundle gets r10, a callee-saved register, because of the call at inst3. So we have the value in r3 initially, then r10 across the call, then on the stack for the explicit stack safepoint.</li>
</ul>
<p>So how could we address this?</p>
<ul>
<li>We could avoid chopping off the trailing bits of LRs when splitting; but this turns out to be a really useful thing in most cases, because it shrinks the post-split pieces to just around their uses and significantly reduces contention. I measured high-single-digits perf improvements from this when I was initially tuning things.</li>
<li>We could somehow hint that the spill bundle can be a stack location. But this requires looking "down" the split tree from the spillbundle at root to all its pieces, and seeing that they have explicit stack constraints. And it also requires some flow-specific knowledge: that we're flowing into a place with a stack constraint, rather than out of one. And probably would need some weighting mechanism.</li>
<li>We could let stack-constrained uses live directly on the spillbundle, and then constrain the spillbundle to just a stack slot (no second-chance register choice). This is probably the best option; it doesn't touch the heuristics at all for non-reftype cases. But it would require some careful thought, because currently spillbundles don't carry uses at all.</li>
</ul>
<p>So there's a plausible path forward (last option above), but it's not an easy fix.</p>
<p>In general, there is going to be "noise" like this with any shift in complex heuristics; I do apologize, and wish we could always avoid regressions like this, but it's also an impossible request (not saying you are making it, but stating this out loud since it's the topic at hand) to <em>always</em> avoid regressions. In general the best we can do is measure and hill-climb toward better performance in aggregate. In any case, I'll file an issue over in regalloc2 to note the above idea, and at some point I might have a slice of time (it would probably take ~a few days to a week) to get to it.</p>
</blockquote>



<a name="282579335"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%233785%20%5BRFC%5D%20ISLE%3A%20Migrate%20call%20and%20retur.../near/282579335" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.233785.20.5BRFC.5D.20ISLE.3A.20Migrate.20call.20and.20retur.2E.2E.2E.html#282579335">(May 17 2022 at 00:42)</a>:</h4>
<p>cfallin <a href="https://github.com/bytecodealliance/wasmtime/pull/3785#issuecomment-1128279552">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/3785">issue #3785</a>:</p>
<blockquote>
<p>OK, so given all the above, I got nerd-sniped for the rest of the afternoon and did <a href="https://github.com/bytecodealliance/regalloc2/issues/49">bytecodealliance/regalloc2#49</a>. It seems to address the issue above (in fact the code is a little shorter than with <a href="http://regalloc.rs">regalloc.rs</a>).</p>
</blockquote>



<a name="282614475"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%233785%20%5BRFC%5D%20ISLE%3A%20Migrate%20call%20and%20retur.../near/282614475" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.233785.20.5BRFC.5D.20ISLE.3A.20Migrate.20call.20and.20retur.2E.2E.2E.html#282614475">(May 17 2022 at 09:43)</a>:</h4>
<p>uweigand <a href="https://github.com/bytecodealliance/wasmtime/pull/3785#issuecomment-1128653551">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/3785">issue #3785</a>:</p>
<blockquote>
<p>Hi @cfallin, thanks for the detailed analysis and the quick fix!   I can confirm that with regalloc2 0.1.3 the code generated for the reftypes.clif test case is improved, both without this PR and with this PR applied.  So this regalloc change looks like a clear improvement to me.</p>
<p>However, I'm still wondering why we are seeing <em>any</em> regalloc differences from this PR - both with and without your regalloc2 change applied.  <em>Without</em> the regalloc2 change, we're seeing the regression shown in the PR.  But even with the regalloc2 change, we are seeing a <em>change</em> in generated code (not a regression, but still a change):</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="mi">7</span><span class="p">,</span><span class="mi">8</span><span class="n">c7</span><span class="p">,</span><span class="mi">8</span><span class="w"></span>
<span class="o">&lt;</span><span class="w">         </span><span class="s">"  bras %r1, 12 ; data %f + 0 ; lg %r5, 0(%r1)"</span><span class="p">,</span><span class="w"></span>
<span class="o">&lt;</span><span class="w">         </span><span class="s">"  basr %r14, %r5"</span><span class="p">,</span><span class="w"></span>
<span class="o">---</span><span class="w"></span>
<span class="o">&gt;</span><span class="w">         </span><span class="s">"  bras %r1, 12 ; data %f + 0 ; lg %r4, 0(%r1)"</span><span class="p">,</span><span class="w"></span>
<span class="o">&gt;</span><span class="w">         </span><span class="s">"  basr %r14, %r4"</span><span class="p">,</span><span class="w"></span>
<span class="mi">12</span><span class="p">,</span><span class="mi">13</span><span class="n">c12</span><span class="p">,</span><span class="mi">13</span><span class="w"></span>
<span class="o">&lt;</span><span class="w">         </span><span class="s">"  llcr %r5, %r2"</span><span class="p">,</span><span class="w"></span>
<span class="o">&lt;</span><span class="w">         </span><span class="s">"  chi %r5, 0"</span><span class="p">,</span><span class="w"></span>
<span class="o">---</span><span class="w"></span>
<span class="o">&gt;</span><span class="w">         </span><span class="s">"  llcr %r3, %r2"</span><span class="p">,</span><span class="w"></span>
<span class="o">&gt;</span><span class="w">         </span><span class="s">"  chi %r3, 0"</span><span class="p">,</span><span class="w"></span>
<span class="mi">28</span><span class="p">,</span><span class="mi">29</span><span class="n">c28</span><span class="p">,</span><span class="mi">29</span><span class="w"></span>
<span class="o">&lt;</span><span class="w">         </span><span class="s">"  la %r4, 160(%r15)"</span><span class="p">,</span><span class="w"></span>
<span class="o">&lt;</span><span class="w">         </span><span class="s">"  lg %r4, 0(%r4)"</span><span class="p">,</span><span class="w"></span>
<span class="o">---</span><span class="w"></span>
<span class="o">&gt;</span><span class="w">         </span><span class="s">"  la %r5, 160(%r15)"</span><span class="p">,</span><span class="w"></span>
<span class="o">&gt;</span><span class="w">         </span><span class="s">"  lg %r4, 0(%r5)"</span><span class="p">,</span><span class="w"></span>
</code></pre></div>
<p>This seems strange given that the code regalloc sees before and after this PR is nearly identical.<br>
Before this PR:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="w">  </span><span class="n">Entry</span><span class="w"> </span><span class="n">block</span>: <span class="mi">0</span><span class="w"></span>
<span class="w">  </span><span class="n">v131</span><span class="w"> </span>:<span class="o">=</span><span class="w"> </span><span class="n">v146</span><span class="w"></span>
<span class="w">  </span><span class="n">v134</span><span class="w"> </span>:<span class="o">=</span><span class="w"> </span><span class="n">v140</span><span class="w"></span>
<span class="w">  </span><span class="n">v135</span><span class="w"> </span>:<span class="o">=</span><span class="w"> </span><span class="n">v139</span><span class="w"></span>
<span class="n">Block</span><span class="w"> </span><span class="mi">0</span>:
    <span class="p">(</span><span class="n">original</span><span class="w"> </span><span class="n">IR</span><span class="w"> </span><span class="n">block</span>: <span class="nc">block0</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="p">(</span><span class="n">successor</span>: <span class="nc">Block</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="p">(</span><span class="n">successor</span>: <span class="nc">Block</span><span class="w"> </span><span class="mi">3</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="p">(</span><span class="n">instruction</span><span class="w"> </span><span class="n">range</span>: <span class="mi">0</span><span class="w"> </span><span class="o">..</span><span class="w"> </span><span class="mi">11</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="n">Inst</span><span class="w"> </span><span class="mi">0</span>: <span class="nc">lgr</span><span class="w"> </span><span class="o">%</span><span class="n">v128</span><span class="p">,</span><span class="w"> </span><span class="o">%</span><span class="n">r2</span><span class="w"></span>
<span class="w">  </span><span class="n">Inst</span><span class="w"> </span><span class="mi">1</span>: <span class="nc">lgr</span><span class="w"> </span><span class="o">%</span><span class="n">v129</span><span class="p">,</span><span class="w"> </span><span class="o">%</span><span class="n">r3</span><span class="w"></span>
<span class="w">  </span><span class="n">Inst</span><span class="w"> </span><span class="mi">2</span>: <span class="nc">lgr</span><span class="w"> </span><span class="o">%</span><span class="n">r2</span><span class="p">,</span><span class="w"> </span><span class="o">%</span><span class="n">v128</span><span class="w"></span>
<span class="w">  </span><span class="n">Inst</span><span class="w"> </span><span class="mi">3</span>: <span class="nc">bras</span><span class="w"> </span><span class="o">%</span><span class="n">r1</span><span class="p">,</span><span class="w"> </span><span class="mi">12</span><span class="w"> </span><span class="p">;</span><span class="w"> </span><span class="n">data</span><span class="w"> </span><span class="o">%</span><span class="n">f</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="p">;</span><span class="w"> </span><span class="n">lg</span><span class="w"> </span><span class="o">%</span><span class="n">v147</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">(</span><span class="o">%</span><span class="n">r1</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="n">Inst</span><span class="w"> </span><span class="mi">4</span>: <span class="nc">basr</span><span class="w"> </span><span class="o">%</span><span class="n">r14</span><span class="p">,</span><span class="w"> </span><span class="o">%</span><span class="n">v147</span><span class="w"></span>
<span class="w">  </span><span class="n">Inst</span><span class="w"> </span><span class="mi">5</span>: <span class="nc">lr</span><span class="w"> </span><span class="o">%</span><span class="n">v130</span><span class="p">,</span><span class="w"> </span><span class="o">%</span><span class="n">r2</span><span class="w"></span>
<span class="w">  </span><span class="n">Inst</span><span class="w"> </span><span class="mi">6</span>: <span class="nc">la</span><span class="w"> </span><span class="o">%</span><span class="n">v146</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">(</span><span class="o">%</span><span class="n">r15</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="n">Inst</span><span class="w"> </span><span class="mi">7</span>: <span class="nc">stg</span><span class="w"> </span><span class="o">%</span><span class="n">v128</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">(</span><span class="o">%</span><span class="n">v131</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="n">Inst</span><span class="w"> </span><span class="mi">8</span>: <span class="nc">llcr</span><span class="w"> </span><span class="o">%</span><span class="n">v145</span><span class="p">,</span><span class="w"> </span><span class="o">%</span><span class="n">v130</span><span class="w"></span>
<span class="w">  </span><span class="n">Inst</span><span class="w"> </span><span class="mi">9</span>: <span class="nc">chi</span><span class="w"> </span><span class="o">%</span><span class="n">v145</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="w"></span>
<span class="w">  </span><span class="n">Inst</span><span class="w"> </span><span class="mi">10</span>: <span class="nc">jgnlh</span><span class="w"> </span><span class="n">label1</span><span class="w"> </span><span class="p">;</span><span class="w"> </span><span class="n">jg</span><span class="w"> </span><span class="n">label3</span><span class="w"></span>
</code></pre></div>
<p>After this PR:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="w">  </span><span class="n">Entry</span><span class="w"> </span><span class="n">block</span>: <span class="mi">0</span><span class="w"></span>
<span class="w">  </span><span class="n">v130</span><span class="w"> </span>:<span class="o">=</span><span class="w"> </span><span class="n">v148</span><span class="w"></span>
<span class="w">  </span><span class="n">v131</span><span class="w"> </span>:<span class="o">=</span><span class="w"> </span><span class="n">v146</span><span class="w"></span>
<span class="w">  </span><span class="n">v134</span><span class="w"> </span>:<span class="o">=</span><span class="w"> </span><span class="n">v140</span><span class="w"></span>
<span class="w">  </span><span class="n">v135</span><span class="w"> </span>:<span class="o">=</span><span class="w"> </span><span class="n">v139</span><span class="w"></span>
<span class="n">Block</span><span class="w"> </span><span class="mi">0</span>:
    <span class="p">(</span><span class="n">original</span><span class="w"> </span><span class="n">IR</span><span class="w"> </span><span class="n">block</span>: <span class="nc">block0</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="p">(</span><span class="n">successor</span>: <span class="nc">Block</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="p">(</span><span class="n">successor</span>: <span class="nc">Block</span><span class="w"> </span><span class="mi">3</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="p">(</span><span class="n">instruction</span><span class="w"> </span><span class="n">range</span>: <span class="mi">0</span><span class="w"> </span><span class="o">..</span><span class="w"> </span><span class="mi">11</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="n">Inst</span><span class="w"> </span><span class="mi">0</span>: <span class="nc">lgr</span><span class="w"> </span><span class="o">%</span><span class="n">v128</span><span class="p">,</span><span class="w"> </span><span class="o">%</span><span class="n">r2</span><span class="w"></span>
<span class="w">  </span><span class="n">Inst</span><span class="w"> </span><span class="mi">1</span>: <span class="nc">lgr</span><span class="w"> </span><span class="o">%</span><span class="n">v129</span><span class="p">,</span><span class="w"> </span><span class="o">%</span><span class="n">r3</span><span class="w"></span>
<span class="w">  </span><span class="n">Inst</span><span class="w"> </span><span class="mi">2</span>: <span class="nc">lgr</span><span class="w"> </span><span class="o">%</span><span class="n">r2</span><span class="p">,</span><span class="w"> </span><span class="o">%</span><span class="n">v128</span><span class="w"></span>
<span class="w">  </span><span class="n">Inst</span><span class="w"> </span><span class="mi">3</span>: <span class="nc">bras</span><span class="w"> </span><span class="o">%</span><span class="n">r1</span><span class="p">,</span><span class="w"> </span><span class="mi">12</span><span class="w"> </span><span class="p">;</span><span class="w"> </span><span class="n">data</span><span class="w"> </span><span class="o">%</span><span class="n">f</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="p">;</span><span class="w"> </span><span class="n">lg</span><span class="w"> </span><span class="o">%</span><span class="n">v147</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">(</span><span class="o">%</span><span class="n">r1</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="n">Inst</span><span class="w"> </span><span class="mi">4</span>: <span class="nc">basr</span><span class="w"> </span><span class="o">%</span><span class="n">r14</span><span class="p">,</span><span class="w"> </span><span class="o">%</span><span class="n">v147</span><span class="w"></span>
<span class="w">  </span><span class="n">Inst</span><span class="w"> </span><span class="mi">5</span>: <span class="nc">lr</span><span class="w"> </span><span class="o">%</span><span class="n">v148</span><span class="p">,</span><span class="w"> </span><span class="o">%</span><span class="n">r2</span><span class="w"></span>
<span class="w">  </span><span class="n">Inst</span><span class="w"> </span><span class="mi">6</span>: <span class="nc">la</span><span class="w"> </span><span class="o">%</span><span class="n">v146</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">(</span><span class="o">%</span><span class="n">r15</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="n">Inst</span><span class="w"> </span><span class="mi">7</span>: <span class="nc">stg</span><span class="w"> </span><span class="o">%</span><span class="n">v128</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">(</span><span class="o">%</span><span class="n">v131</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="n">Inst</span><span class="w"> </span><span class="mi">8</span>: <span class="nc">llcr</span><span class="w"> </span><span class="o">%</span><span class="n">v145</span><span class="p">,</span><span class="w"> </span><span class="o">%</span><span class="n">v130</span><span class="w"></span>
<span class="w">  </span><span class="n">Inst</span><span class="w"> </span><span class="mi">9</span>: <span class="nc">chi</span><span class="w"> </span><span class="o">%</span><span class="n">v145</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="w"></span>
<span class="w">  </span><span class="n">Inst</span><span class="w"> </span><span class="mi">10</span>: <span class="nc">jgnlh</span><span class="w"> </span><span class="n">label1</span><span class="w"> </span><span class="p">;</span><span class="w"> </span><span class="n">jg</span><span class="w"> </span><span class="n">label3</span><span class="w"></span>
</code></pre></div>
<p>The only difference is that before the PR, insts 5 and 8 use the same vreg (v130), while after the PR, they use two different vregs (v130 and v148), which are marked as aliases.</p>
<p>If aliased vregs are indeed treated identically by regalloc, why does this change still appear to make a difference?<br>
</p>
</blockquote>



<a name="282678749"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%233785%20%5BRFC%5D%20ISLE%3A%20Migrate%20call%20and%20retur.../near/282678749" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.233785.20.5BRFC.5D.20ISLE.3A.20Migrate.20call.20and.20retur.2E.2E.2E.html#282678749">(May 17 2022 at 17:40)</a>:</h4>
<p>cfallin <a href="https://github.com/bytecodealliance/wasmtime/pull/3785#issuecomment-1129142818">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/3785">issue #3785</a>:</p>
<blockquote>
<p>Ah, so I think what is happening is that the aliasing rewrites toward the new vreg, not the old one: <code>v130</code> is made an alias of <code>v148</code>, so all instances of <code>v130</code> become <code>v148</code> as seen by regalloc.</p>
<p>This means that the order of vregs seen by regalloc2 is not quite the same, so allocation decisions may be made in a slightly different order. </p>
<p>This aligns with what is seen in your diff above, I think: the instruction sequence is exactly the same, but the specific register numbers are different in a few cases.</p>
</blockquote>



<a name="282681129"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%233785%20%5BRFC%5D%20ISLE%3A%20Migrate%20call%20and%20retur.../near/282681129" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.233785.20.5BRFC.5D.20ISLE.3A.20Migrate.20call.20and.20retur.2E.2E.2E.html#282681129">(May 17 2022 at 17:56)</a>:</h4>
<p>uweigand <a href="https://github.com/bytecodealliance/wasmtime/pull/3785#issuecomment-1129156773">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/3785">issue #3785</a>:</p>
<blockquote>
<blockquote>
<p>This means that the order of vregs seen by regalloc2 is not quite the same, so allocation decisions may be made in a slightly different order.</p>
</blockquote>
<p>I see, that does indeed look like it explains the difference.  I think with the regalloc2 patch we should be all good then.  Thanks again!</p>
</blockquote>



<a name="287712434"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%233785%20%5BRFC%5D%20ISLE%3A%20Migrate%20call%20and%20retur.../near/287712434" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.233785.20.5BRFC.5D.20ISLE.3A.20Migrate.20call.20and.20retur.2E.2E.2E.html#287712434">(Jun 28 2022 at 13:04)</a>:</h4>
<p>uweigand <a href="https://github.com/bytecodealliance/wasmtime/pull/3785#issuecomment-1168695575">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/3785">issue #3785</a>:</p>
<blockquote>
<p>Hi @cfallin, this latest version now has the <code>ABISig</code> refactoring and a bunch of other general interface cleanups.</p>
<p>As far as I am concerned, this should now be ready to be merged, so I'd appreciate another review - any comments welcome!</p>
</blockquote>



<a name="287747421"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%233785%20%5BRFC%5D%20ISLE%3A%20Migrate%20call%20and%20retur.../near/287747421" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.233785.20.5BRFC.5D.20ISLE.3A.20Migrate.20call.20and.20retur.2E.2E.2E.html#287747421">(Jun 28 2022 at 17:12)</a>:</h4>
<p>uweigand <a href="https://github.com/bytecodealliance/wasmtime/pull/3785#issuecomment-1169002925">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/3785">issue #3785</a>:</p>
<blockquote>
<p>Updated to resolve merge conflicts due to the <code>uses_defs_clobbers</code> change.</p>
</blockquote>



<hr><p>Last updated: Jan 20 2025 at 06:04 UTC</p>
</html>