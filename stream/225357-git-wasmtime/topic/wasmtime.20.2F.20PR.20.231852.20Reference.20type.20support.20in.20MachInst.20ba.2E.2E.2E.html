<html>
<head><meta charset="utf-8"><title>wasmtime / PR #1852 Reference type support in MachInst ba... · git-wasmtime · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/index.html">git-wasmtime</a></h2>
<h3>Topic: <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231852.20Reference.20type.20support.20in.20MachInst.20ba.2E.2E.2E.html">wasmtime / PR #1852 Reference type support in MachInst ba...</a></h3>

<hr>

<base href="https://bytecodealliance.zulipchat.com">

<head><link href="https://bytecodealliance.github.io/zulip-archive/style.css" rel="stylesheet"></head>

<a name="202159980"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231852%20Reference%20type%20support%20in%20MachInst%20ba.../near/202159980" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231852.20Reference.20type.20support.20in.20MachInst.20ba.2E.2E.2E.html#202159980">(Jun 27 2020 at 01:04)</a>:</h4>
<p>cfallin edited <a href="https://github.com/bytecodealliance/wasmtime/pull/1852">PR #1852</a> from <code>reftypes</code> to <code>main</code>:</p>
<blockquote>
<p>This PR adds the inital support to allow reftypes to flow through the<br>
program when targetting aarch64. It also adds a fix to the<br>
<code>ModuleTranslationState</code> needed to send R32/R64 types over from the<br>
SpiderMonkey embedding.</p>
<p>This PR does not include any support for safepoints in aarch64 or the<br>
<code>MachInst</code> infrastructure. That work will come as a second PR, following<br>
some needed changes to <a href="http://regalloc.rs">regalloc.rs</a>.</p>
<p>This PR also makes a drive-by improvement to <code>Bint</code>, avoiding an<br>
unneeded zero-extension op when the extended value comes directly from a<br>
conditional-set (which produces a full-width 0 or 1).</p>
<p>With this PR, and a companion patch in SpiderMonkey, we're able to make it<br>
through all of the reftypes tests in the spec testsuite, though we aren't emitting<br>
stackmaps yet so if the GC had been triggered we would have been in trouble.<br>
Still, it's a start!</p>
<p>&lt;!--</p>
<p>Please ensure that the following steps are all taken care of before submitting<br>
the PR.</p>
<ul>
<li>
<p>[ ] This has been discussed in issue #..., or if not, please tell us why<br>
  here.</p>
</li>
<li>
<p>[ ] A short description of what this does, why it is needed; if the<br>
  description becomes long, the matter should probably be discussed in an issue<br>
  first.</p>
</li>
<li>
<p>[ ] This PR contains test cases, if meaningful.</p>
</li>
<li>[ ] A reviewer from the core maintainer team has been assigned for this PR.<br>
  If you don't know who could review this, please indicate so. The list of<br>
  suggested reviewers on the right can help you.</li>
</ul>
<p>Please ensure all communication adheres to the <a href="https://github.com/bytecodealliance/wasmtime/blob/master/CODE_OF_CONDUCT.md">code of
conduct</a>.<br>
--&gt;</p>
</blockquote>



<a name="202160143"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231852%20Reference%20type%20support%20in%20MachInst%20ba.../near/202160143" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231852.20Reference.20type.20support.20in.20MachInst.20ba.2E.2E.2E.html#202160143">(Jun 27 2020 at 01:08)</a>:</h4>
<p>cfallin edited <a href="https://github.com/bytecodealliance/wasmtime/pull/1852">PR #1852</a> from <code>reftypes</code> to <code>main</code>:</p>
<blockquote>
<p>This PR adds support for reference types in the <code>MachInst</code> backend framework and on AArch64. It comes in two parts: the initial support for allowing <code>R32</code>/<code>R64</code> types to flow through the Wasm program and call boundaries, and the implementation of opcodes that support them (<code>is_null</code>, etc.); and then stackmap support to allow GCs to occur while Wasm stackframes are active.</p>
<p>This has been tested with SpiderMonkey and is known to work there with GCs occuring during calls from Wasm into JS. We plan to do further testing in <a href="http://regalloc.rs">regalloc.rs</a> directly (with our checker) too.</p>
<p>This requires a <a href="http://regalloc.rs">regalloc.rs</a> version bump (with wasmtime/regalloc.rs#79 included) and dep version update; the CI build here will be red until that change is made.</p>
<p>&lt;!--</p>
<p>Please ensure that the following steps are all taken care of before submitting<br>
the PR.</p>
<ul>
<li>
<p>[ ] This has been discussed in issue #..., or if not, please tell us why<br>
  here.</p>
</li>
<li>
<p>[ ] A short description of what this does, why it is needed; if the<br>
  description becomes long, the matter should probably be discussed in an issue<br>
  first.</p>
</li>
<li>
<p>[ ] This PR contains test cases, if meaningful.</p>
</li>
<li>[ ] A reviewer from the core maintainer team has been assigned for this PR.<br>
  If you don't know who could review this, please indicate so. The list of<br>
  suggested reviewers on the right can help you.</li>
</ul>
<p>Please ensure all communication adheres to the <a href="https://github.com/bytecodealliance/wasmtime/blob/master/CODE_OF_CONDUCT.md">code of
conduct</a>.<br>
--&gt;</p>
</blockquote>



<a name="202160163"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231852%20Reference%20type%20support%20in%20MachInst%20ba.../near/202160163" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231852.20Reference.20type.20support.20in.20MachInst.20ba.2E.2E.2E.html#202160163">(Jun 27 2020 at 01:09)</a>:</h4>
<p>cfallin edited <a href="https://github.com/bytecodealliance/wasmtime/pull/1852">PR #1852</a> from <code>reftypes</code> to <code>main</code>:</p>
<blockquote>
<p>This PR adds support for reference types in the <code>MachInst</code> backend framework and on AArch64. It comes in two parts: the initial support for allowing <code>R32</code>/<code>R64</code> types to flow through the Wasm program and call boundaries, and the implementation of opcodes that support them (<code>is_null</code>, etc.); and then stackmap support to allow GCs to occur while Wasm stackframes are active.</p>
<p>This has been tested with SpiderMonkey and is known to work there with GCs occuring during calls from Wasm into JS. We plan to do further testing in <a href="http://regalloc.rs">regalloc.rs</a> directly (with our checker) too.</p>
<p>This requires a <a href="http://regalloc.rs">regalloc.rs</a> version bump (with bytecodealliance/regalloc.rs#79 included) and dep version update; the CI build here will be red until that change is made.</p>
<p>&lt;!--</p>
<p>Please ensure that the following steps are all taken care of before submitting<br>
the PR.</p>
<ul>
<li>
<p>[ ] This has been discussed in issue #..., or if not, please tell us why<br>
  here.</p>
</li>
<li>
<p>[ ] A short description of what this does, why it is needed; if the<br>
  description becomes long, the matter should probably be discussed in an issue<br>
  first.</p>
</li>
<li>
<p>[ ] This PR contains test cases, if meaningful.</p>
</li>
<li>[ ] A reviewer from the core maintainer team has been assigned for this PR.<br>
  If you don't know who could review this, please indicate so. The list of<br>
  suggested reviewers on the right can help you.</li>
</ul>
<p>Please ensure all communication adheres to the <a href="https://github.com/bytecodealliance/wasmtime/blob/master/CODE_OF_CONDUCT.md">code of
conduct</a>.<br>
--&gt;</p>
</blockquote>



<a name="202160329"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231852%20Reference%20type%20support%20in%20MachInst%20ba.../near/202160329" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231852.20Reference.20type.20support.20in.20MachInst.20ba.2E.2E.2E.html#202160329">(Jun 27 2020 at 01:13)</a>:</h4>
<p>cfallin updated <a href="https://github.com/bytecodealliance/wasmtime/pull/1852">PR #1852</a> from <code>reftypes</code> to <code>main</code>:</p>
<blockquote>
<p>This PR adds support for reference types in the <code>MachInst</code> backend framework and on AArch64. It comes in two parts: the initial support for allowing <code>R32</code>/<code>R64</code> types to flow through the Wasm program and call boundaries, and the implementation of opcodes that support them (<code>is_null</code>, etc.); and then stackmap support to allow GCs to occur while Wasm stackframes are active.</p>
<p>This has been tested with SpiderMonkey and is known to work there with GCs occuring during calls from Wasm into JS. We plan to do further testing in <a href="http://regalloc.rs">regalloc.rs</a> directly (with our checker) too.</p>
<p>This requires a <a href="http://regalloc.rs">regalloc.rs</a> version bump (with bytecodealliance/regalloc.rs#79 included) and dep version update; the CI build here will be red until that change is made.</p>
<p>&lt;!--</p>
<p>Please ensure that the following steps are all taken care of before submitting<br>
the PR.</p>
<ul>
<li>
<p>[ ] This has been discussed in issue #..., or if not, please tell us why<br>
  here.</p>
</li>
<li>
<p>[ ] A short description of what this does, why it is needed; if the<br>
  description becomes long, the matter should probably be discussed in an issue<br>
  first.</p>
</li>
<li>
<p>[ ] This PR contains test cases, if meaningful.</p>
</li>
<li>[ ] A reviewer from the core maintainer team has been assigned for this PR.<br>
  If you don't know who could review this, please indicate so. The list of<br>
  suggested reviewers on the right can help you.</li>
</ul>
<p>Please ensure all communication adheres to the <a href="https://github.com/bytecodealliance/wasmtime/blob/master/CODE_OF_CONDUCT.md">code of
conduct</a>.<br>
--&gt;</p>
</blockquote>



<a name="202378821"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231852%20Reference%20type%20support%20in%20MachInst%20ba.../near/202378821" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231852.20Reference.20type.20support.20in.20MachInst.20ba.2E.2E.2E.html#202378821">(Jun 29 2020 at 23:12)</a>:</h4>
<p>cfallin updated <a href="https://github.com/bytecodealliance/wasmtime/pull/1852">PR #1852</a> from <code>reftypes</code> to <code>main</code>:</p>
<blockquote>
<p>This PR adds support for reference types in the <code>MachInst</code> backend framework and on AArch64. It comes in two parts: the initial support for allowing <code>R32</code>/<code>R64</code> types to flow through the Wasm program and call boundaries, and the implementation of opcodes that support them (<code>is_null</code>, etc.); and then stackmap support to allow GCs to occur while Wasm stackframes are active.</p>
<p>This has been tested with SpiderMonkey and is known to work there with GCs occuring during calls from Wasm into JS. We plan to do further testing in <a href="http://regalloc.rs">regalloc.rs</a> directly (with our checker) too.</p>
<p>This requires a <a href="http://regalloc.rs">regalloc.rs</a> version bump (with bytecodealliance/regalloc.rs#79 included) and dep version update; the CI build here will be red until that change is made.</p>
<p>&lt;!--</p>
<p>Please ensure that the following steps are all taken care of before submitting<br>
the PR.</p>
<ul>
<li>
<p>[ ] This has been discussed in issue #..., or if not, please tell us why<br>
  here.</p>
</li>
<li>
<p>[ ] A short description of what this does, why it is needed; if the<br>
  description becomes long, the matter should probably be discussed in an issue<br>
  first.</p>
</li>
<li>
<p>[ ] This PR contains test cases, if meaningful.</p>
</li>
<li>[ ] A reviewer from the core maintainer team has been assigned for this PR.<br>
  If you don't know who could review this, please indicate so. The list of<br>
  suggested reviewers on the right can help you.</li>
</ul>
<p>Please ensure all communication adheres to the <a href="https://github.com/bytecodealliance/wasmtime/blob/master/CODE_OF_CONDUCT.md">code of
conduct</a>.<br>
--&gt;</p>
</blockquote>



<a name="202727833"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231852%20Reference%20type%20support%20in%20MachInst%20ba.../near/202727833" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231852.20Reference.20type.20support.20in.20MachInst.20ba.2E.2E.2E.html#202727833">(Jul 02 2020 at 18:33)</a>:</h4>
<p>cfallin updated <a href="https://github.com/bytecodealliance/wasmtime/pull/1852">PR #1852</a> from <code>reftypes</code> to <code>main</code>:</p>
<blockquote>
<p>This PR adds support for reference types in the <code>MachInst</code> backend framework and on AArch64. It comes in two parts: the initial support for allowing <code>R32</code>/<code>R64</code> types to flow through the Wasm program and call boundaries, and the implementation of opcodes that support them (<code>is_null</code>, etc.); and then stackmap support to allow GCs to occur while Wasm stackframes are active.</p>
<p>This has been tested with SpiderMonkey and is known to work there with GCs occuring during calls from Wasm into JS. We plan to do further testing in <a href="http://regalloc.rs">regalloc.rs</a> directly (with our checker) too.</p>
<p>This requires a <a href="http://regalloc.rs">regalloc.rs</a> version bump (with bytecodealliance/regalloc.rs#79 included) and dep version update; the CI build here will be red until that change is made.</p>
<p>&lt;!--</p>
<p>Please ensure that the following steps are all taken care of before submitting<br>
the PR.</p>
<ul>
<li>
<p>[ ] This has been discussed in issue #..., or if not, please tell us why<br>
  here.</p>
</li>
<li>
<p>[ ] A short description of what this does, why it is needed; if the<br>
  description becomes long, the matter should probably be discussed in an issue<br>
  first.</p>
</li>
<li>
<p>[ ] This PR contains test cases, if meaningful.</p>
</li>
<li>[ ] A reviewer from the core maintainer team has been assigned for this PR.<br>
  If you don't know who could review this, please indicate so. The list of<br>
  suggested reviewers on the right can help you.</li>
</ul>
<p>Please ensure all communication adheres to the <a href="https://github.com/bytecodealliance/wasmtime/blob/master/CODE_OF_CONDUCT.md">code of
conduct</a>.<br>
--&gt;</p>
</blockquote>



<a name="202728004"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231852%20Reference%20type%20support%20in%20MachInst%20ba.../near/202728004" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231852.20Reference.20type.20support.20in.20MachInst.20ba.2E.2E.2E.html#202728004">(Jul 02 2020 at 18:34)</a>:</h4>
<p>cfallin updated <a href="https://github.com/bytecodealliance/wasmtime/pull/1852">PR #1852</a> from <code>reftypes</code> to <code>main</code>:</p>
<blockquote>
<p>This PR adds support for reference types in the <code>MachInst</code> backend framework and on AArch64. It comes in two parts: the initial support for allowing <code>R32</code>/<code>R64</code> types to flow through the Wasm program and call boundaries, and the implementation of opcodes that support them (<code>is_null</code>, etc.); and then stackmap support to allow GCs to occur while Wasm stackframes are active.</p>
<p>This has been tested with SpiderMonkey and is known to work there with GCs occuring during calls from Wasm into JS. We plan to do further testing in <a href="http://regalloc.rs">regalloc.rs</a> directly (with our checker) too.</p>
<p>This requires a <a href="http://regalloc.rs">regalloc.rs</a> version bump (with bytecodealliance/regalloc.rs#79 included) and dep version update; the CI build here will be red until that change is made.</p>
<p>&lt;!--</p>
<p>Please ensure that the following steps are all taken care of before submitting<br>
the PR.</p>
<ul>
<li>
<p>[ ] This has been discussed in issue #..., or if not, please tell us why<br>
  here.</p>
</li>
<li>
<p>[ ] A short description of what this does, why it is needed; if the<br>
  description becomes long, the matter should probably be discussed in an issue<br>
  first.</p>
</li>
<li>
<p>[ ] This PR contains test cases, if meaningful.</p>
</li>
<li>[ ] A reviewer from the core maintainer team has been assigned for this PR.<br>
  If you don't know who could review this, please indicate so. The list of<br>
  suggested reviewers on the right can help you.</li>
</ul>
<p>Please ensure all communication adheres to the <a href="https://github.com/bytecodealliance/wasmtime/blob/master/CODE_OF_CONDUCT.md">code of
conduct</a>.<br>
--&gt;</p>
</blockquote>



<a name="202728785"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231852%20Reference%20type%20support%20in%20MachInst%20ba.../near/202728785" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231852.20Reference.20type.20support.20in.20MachInst.20ba.2E.2E.2E.html#202728785">(Jul 02 2020 at 18:40)</a>:</h4>
<p>cfallin updated <a href="https://github.com/bytecodealliance/wasmtime/pull/1852">PR #1852</a> from <code>reftypes</code> to <code>main</code>:</p>
<blockquote>
<p>This PR adds support for reference types in the <code>MachInst</code> backend framework and on AArch64. It comes in two parts: the initial support for allowing <code>R32</code>/<code>R64</code> types to flow through the Wasm program and call boundaries, and the implementation of opcodes that support them (<code>is_null</code>, etc.); and then stackmap support to allow GCs to occur while Wasm stackframes are active.</p>
<p>This has been tested with SpiderMonkey and is known to work there with GCs occuring during calls from Wasm into JS. We plan to do further testing in <a href="http://regalloc.rs">regalloc.rs</a> directly (with our checker) too.</p>
<p>This requires a <a href="http://regalloc.rs">regalloc.rs</a> version bump (with bytecodealliance/regalloc.rs#79 included) and dep version update; the CI build here will be red until that change is made.</p>
<p>&lt;!--</p>
<p>Please ensure that the following steps are all taken care of before submitting<br>
the PR.</p>
<ul>
<li>
<p>[ ] This has been discussed in issue #..., or if not, please tell us why<br>
  here.</p>
</li>
<li>
<p>[ ] A short description of what this does, why it is needed; if the<br>
  description becomes long, the matter should probably be discussed in an issue<br>
  first.</p>
</li>
<li>
<p>[ ] This PR contains test cases, if meaningful.</p>
</li>
<li>[ ] A reviewer from the core maintainer team has been assigned for this PR.<br>
  If you don't know who could review this, please indicate so. The list of<br>
  suggested reviewers on the right can help you.</li>
</ul>
<p>Please ensure all communication adheres to the <a href="https://github.com/bytecodealliance/wasmtime/blob/master/CODE_OF_CONDUCT.md">code of
conduct</a>.<br>
--&gt;</p>
</blockquote>



<a name="203763680"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231852%20Reference%20type%20support%20in%20MachInst%20ba.../near/203763680" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231852.20Reference.20type.20support.20in.20MachInst.20ba.2E.2E.2E.html#203763680">(Jul 13 2020 at 20:01)</a>:</h4>
<p>cfallin updated <a href="https://github.com/bytecodealliance/wasmtime/pull/1852">PR #1852</a> from <code>reftypes</code> to <code>main</code>:</p>
<blockquote>
<p>This PR adds support for reference types in the <code>MachInst</code> backend framework and on AArch64. It comes in two parts: the initial support for allowing <code>R32</code>/<code>R64</code> types to flow through the Wasm program and call boundaries, and the implementation of opcodes that support them (<code>is_null</code>, etc.); and then stackmap support to allow GCs to occur while Wasm stackframes are active.</p>
<p>This has been tested with SpiderMonkey and is known to work there with GCs occuring during calls from Wasm into JS. We plan to do further testing in <a href="http://regalloc.rs">regalloc.rs</a> directly (with our checker) too.</p>
<p>This requires a <a href="http://regalloc.rs">regalloc.rs</a> version bump (with bytecodealliance/regalloc.rs#79 included) and dep version update; the CI build here will be red until that change is made.</p>
<p>&lt;!--</p>
<p>Please ensure that the following steps are all taken care of before submitting<br>
the PR.</p>
<ul>
<li>
<p>[ ] This has been discussed in issue #..., or if not, please tell us why<br>
  here.</p>
</li>
<li>
<p>[ ] A short description of what this does, why it is needed; if the<br>
  description becomes long, the matter should probably be discussed in an issue<br>
  first.</p>
</li>
<li>
<p>[ ] This PR contains test cases, if meaningful.</p>
</li>
<li>[ ] A reviewer from the core maintainer team has been assigned for this PR.<br>
  If you don't know who could review this, please indicate so. The list of<br>
  suggested reviewers on the right can help you.</li>
</ul>
<p>Please ensure all communication adheres to the <a href="https://github.com/bytecodealliance/wasmtime/blob/master/CODE_OF_CONDUCT.md">code of
conduct</a>.<br>
--&gt;</p>
</blockquote>



<a name="203763839"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231852%20Reference%20type%20support%20in%20MachInst%20ba.../near/203763839" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231852.20Reference.20type.20support.20in.20MachInst.20ba.2E.2E.2E.html#203763839">(Jul 13 2020 at 20:03)</a>:</h4>
<p>cfallin updated <a href="https://github.com/bytecodealliance/wasmtime/pull/1852">PR #1852</a> from <code>reftypes</code> to <code>main</code>:</p>
<blockquote>
<p>This PR adds support for reference types in the <code>MachInst</code> backend framework and on AArch64. It comes in two parts: the initial support for allowing <code>R32</code>/<code>R64</code> types to flow through the Wasm program and call boundaries, and the implementation of opcodes that support them (<code>is_null</code>, etc.); and then stackmap support to allow GCs to occur while Wasm stackframes are active.</p>
<p>This has been tested with SpiderMonkey and is known to work there with GCs occuring during calls from Wasm into JS. We plan to do further testing in <a href="http://regalloc.rs">regalloc.rs</a> directly (with our checker) too.</p>
<p>This requires a <a href="http://regalloc.rs">regalloc.rs</a> version bump (with bytecodealliance/regalloc.rs#79 included) and dep version update; the CI build here will be red until that change is made.</p>
<p>&lt;!--</p>
<p>Please ensure that the following steps are all taken care of before submitting<br>
the PR.</p>
<ul>
<li>
<p>[ ] This has been discussed in issue #..., or if not, please tell us why<br>
  here.</p>
</li>
<li>
<p>[ ] A short description of what this does, why it is needed; if the<br>
  description becomes long, the matter should probably be discussed in an issue<br>
  first.</p>
</li>
<li>
<p>[ ] This PR contains test cases, if meaningful.</p>
</li>
<li>[ ] A reviewer from the core maintainer team has been assigned for this PR.<br>
  If you don't know who could review this, please indicate so. The list of<br>
  suggested reviewers on the right can help you.</li>
</ul>
<p>Please ensure all communication adheres to the <a href="https://github.com/bytecodealliance/wasmtime/blob/master/CODE_OF_CONDUCT.md">code of
conduct</a>.<br>
--&gt;</p>
</blockquote>



<a name="203850039"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231852%20Reference%20type%20support%20in%20MachInst%20ba.../near/203850039" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231852.20Reference.20type.20support.20in.20MachInst.20ba.2E.2E.2E.html#203850039">(Jul 14 2020 at 15:48)</a>:</h4>
<p>julian-seward1 submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/1852#pullrequestreview-448212915">PR Review</a>.</p>



<a name="203850040"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231852%20Reference%20type%20support%20in%20MachInst%20ba.../near/203850040" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231852.20Reference.20type.20support.20in.20MachInst.20ba.2E.2E.2E.html#203850040">(Jul 14 2020 at 15:48)</a>:</h4>
<p>julian-seward1 submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/1852#pullrequestreview-448212915">PR Review</a>.</p>



<a name="203850041"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231852%20Reference%20type%20support%20in%20MachInst%20ba.../near/203850041" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231852.20Reference.20type.20support.20in.20MachInst.20ba.2E.2E.2E.html#203850041">(Jul 14 2020 at 15:48)</a>:</h4>
<p>julian-seward1 created <a href="https://github.com/bytecodealliance/wasmtime/pull/1852#discussion_r454439603">PR Review Comment</a>:</p>
<blockquote>
<p>nit: "is right here" is hard to parse.  Does it mean "is correct here"?   Or "at this point in the frame construction, nominal SP = actual SP" etc?  Can you clarify?</p>
</blockquote>



<a name="203850042"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231852%20Reference%20type%20support%20in%20MachInst%20ba.../near/203850042" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231852.20Reference.20type.20support.20in.20MachInst.20ba.2E.2E.2E.html#203850042">(Jul 14 2020 at 15:48)</a>:</h4>
<p>julian-seward1 created <a href="https://github.com/bytecodealliance/wasmtime/pull/1852#discussion_r454446226">PR Review Comment</a>:</p>
<blockquote>
<p>Errr, <code>*end*</code> is too vague.  Please specify exactly.  Do you mean: the code offset for the last (highest-addressed) byte of the instruction ..</p>
</blockquote>



<a name="203850043"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231852%20Reference%20type%20support%20in%20MachInst%20ba.../near/203850043" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231852.20Reference.20type.20support.20in.20MachInst.20ba.2E.2E.2E.html#203850043">(Jul 14 2020 at 15:48)</a>:</h4>
<p>julian-seward1 created <a href="https://github.com/bytecodealliance/wasmtime/pull/1852#discussion_r454441298">PR Review Comment</a>:</p>
<blockquote>
<p>Can it happen that <code>Some(t)</code> is inconsistent with the second (here, ignored) component of the tuple?  It would be good to add a comment explaining the meaning of this function.  In particular why the first component has priority.</p>
</blockquote>



<a name="203850045"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231852%20Reference%20type%20support%20in%20MachInst%20ba.../near/203850045" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231852.20Reference.20type.20support.20in.20MachInst.20ba.2E.2E.2E.html#203850045">(Jul 14 2020 at 15:48)</a>:</h4>
<p>julian-seward1 created <a href="https://github.com/bytecodealliance/wasmtime/pull/1852#discussion_r454449598">PR Review Comment</a>:</p>
<blockquote>
<p>nit: <code>..rc</code> feels a bit too terse here; can you call it <code>ref_type_regclass</code> ?</p>
</blockquote>



<a name="203850046"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231852%20Reference%20type%20support%20in%20MachInst%20ba.../near/203850046" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231852.20Reference.20type.20support.20in.20MachInst.20ba.2E.2E.2E.html#203850046">(Jul 14 2020 at 15:48)</a>:</h4>
<p>julian-seward1 created <a href="https://github.com/bytecodealliance/wasmtime/pull/1852#discussion_r454448077">PR Review Comment</a>:</p>
<blockquote>
<p>How is this used?  In particular, will we have to call <code>is_safepoint</code> on every insn that is processed?  That would seem to be an undesirable compiler performance hit, if so?  (Tell me it ain't so!)</p>
</blockquote>



<a name="203850048"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231852%20Reference%20type%20support%20in%20MachInst%20ba.../near/203850048" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231852.20Reference.20type.20support.20in.20MachInst.20ba.2E.2E.2E.html#203850048">(Jul 14 2020 at 15:48)</a>:</h4>
<p>julian-seward1 created <a href="https://github.com/bytecodealliance/wasmtime/pull/1852#discussion_r454451883">PR Review Comment</a>:</p>
<blockquote>
<p>nano-nit: since most of our users will be coming at this on 64-bit targets, maybe put that first in the disjunction?  That way we can save perhaps 1/3 of a nanosecond per call :-)</p>
</blockquote>



<a name="203850049"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231852%20Reference%20type%20support%20in%20MachInst%20ba.../near/203850049" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231852.20Reference.20type.20support.20in.20MachInst.20ba.2E.2E.2E.html#203850049">(Jul 14 2020 at 15:48)</a>:</h4>
<p>julian-seward1 created <a href="https://github.com/bytecodealliance/wasmtime/pull/1852#discussion_r454455663">PR Review Comment</a>:</p>
<blockquote>
<p>Here and below, it concerns me that we are accepting <code>R32</code> on a 64-bit target without comment.  IIUC, if anything claiming to be <code>R32</code> turns up on a 64-bit target, we have gone way off the rails -- perhaps even to the extent of having a security problem.  In such a circumstance I would much prefer that we bring the system to a halt, even in release builds (== panic in every such <code>match</code> on <code>ty</code>s); and similarly for x64 stubs, if you have similarly modified them.</p>
</blockquote>



<a name="203861552"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231852%20Reference%20type%20support%20in%20MachInst%20ba.../near/203861552" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231852.20Reference.20type.20support.20in.20MachInst.20ba.2E.2E.2E.html#203861552">(Jul 14 2020 at 17:23)</a>:</h4>
<p>cfallin updated <a href="https://github.com/bytecodealliance/wasmtime/pull/1852">PR #1852</a> from <code>reftypes</code> to <code>main</code>:</p>
<blockquote>
<p>This PR adds support for reference types in the <code>MachInst</code> backend framework and on AArch64. It comes in two parts: the initial support for allowing <code>R32</code>/<code>R64</code> types to flow through the Wasm program and call boundaries, and the implementation of opcodes that support them (<code>is_null</code>, etc.); and then stackmap support to allow GCs to occur while Wasm stackframes are active.</p>
<p>This has been tested with SpiderMonkey and is known to work there with GCs occuring during calls from Wasm into JS. We plan to do further testing in <a href="http://regalloc.rs">regalloc.rs</a> directly (with our checker) too.</p>
<p>This requires a <a href="http://regalloc.rs">regalloc.rs</a> version bump (with bytecodealliance/regalloc.rs#79 included) and dep version update; the CI build here will be red until that change is made.</p>
<p>&lt;!--</p>
<p>Please ensure that the following steps are all taken care of before submitting<br>
the PR.</p>
<ul>
<li>
<p>[ ] This has been discussed in issue #..., or if not, please tell us why<br>
  here.</p>
</li>
<li>
<p>[ ] A short description of what this does, why it is needed; if the<br>
  description becomes long, the matter should probably be discussed in an issue<br>
  first.</p>
</li>
<li>
<p>[ ] This PR contains test cases, if meaningful.</p>
</li>
<li>[ ] A reviewer from the core maintainer team has been assigned for this PR.<br>
  If you don't know who could review this, please indicate so. The list of<br>
  suggested reviewers on the right can help you.</li>
</ul>
<p>Please ensure all communication adheres to the <a href="https://github.com/bytecodealliance/wasmtime/blob/master/CODE_OF_CONDUCT.md">code of
conduct</a>.<br>
--&gt;</p>
</blockquote>



<a name="203861575"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231852%20Reference%20type%20support%20in%20MachInst%20ba.../near/203861575" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231852.20Reference.20type.20support.20in.20MachInst.20ba.2E.2E.2E.html#203861575">(Jul 14 2020 at 17:23)</a>:</h4>
<p>cfallin submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/1852#pullrequestreview-448311883">PR Review</a>.</p>



<a name="203861576"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231852%20Reference%20type%20support%20in%20MachInst%20ba.../near/203861576" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231852.20Reference.20type.20support.20in.20MachInst.20ba.2E.2E.2E.html#203861576">(Jul 14 2020 at 17:23)</a>:</h4>
<p>cfallin created <a href="https://github.com/bytecodealliance/wasmtime/pull/1852#discussion_r454519057">PR Review Comment</a>:</p>
<blockquote>
<p>Done, excellent point.</p>
</blockquote>



<a name="203861642"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231852%20Reference%20type%20support%20in%20MachInst%20ba.../near/203861642" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231852.20Reference.20type.20support.20in.20MachInst.20ba.2E.2E.2E.html#203861642">(Jul 14 2020 at 17:23)</a>:</h4>
<p>cfallin submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/1852#pullrequestreview-448312340">PR Review</a>.</p>



<a name="203861643"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231852%20Reference%20type%20support%20in%20MachInst%20ba.../near/203861643" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231852.20Reference.20type.20support.20in.20MachInst.20ba.2E.2E.2E.html#203861643">(Jul 14 2020 at 17:23)</a>:</h4>
<p>cfallin created <a href="https://github.com/bytecodealliance/wasmtime/pull/1852#discussion_r454519453">PR Review Comment</a>:</p>
<blockquote>
<p>Sorry, this was left over from an earlier iteration that did indeed call <code>is_safepoint</code> on every instruction; but we no longer do that, and the function was dead, so I removed it.</p>
</blockquote>



<a name="203861736"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231852%20Reference%20type%20support%20in%20MachInst%20ba.../near/203861736" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231852.20Reference.20type.20support.20in.20MachInst.20ba.2E.2E.2E.html#203861736">(Jul 14 2020 at 17:24)</a>:</h4>
<p>cfallin submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/1852#pullrequestreview-448312766">PR Review</a>.</p>



<a name="203861737"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231852%20Reference%20type%20support%20in%20MachInst%20ba.../near/203861737" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231852.20Reference.20type.20support.20in.20MachInst.20ba.2E.2E.2E.html#203861737">(Jul 14 2020 at 17:24)</a>:</h4>
<p>cfallin created <a href="https://github.com/bytecodealliance/wasmtime/pull/1852#discussion_r454519843">PR Review Comment</a>:</p>
<blockquote>
<p>Updated comment, thanks!</p>
</blockquote>



<a name="203861936"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231852%20Reference%20type%20support%20in%20MachInst%20ba.../near/203861936" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231852.20Reference.20type.20support.20in.20MachInst.20ba.2E.2E.2E.html#203861936">(Jul 14 2020 at 17:26)</a>:</h4>
<p>cfallin submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/1852#pullrequestreview-448314146">PR Review</a>.</p>



<a name="203861937"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231852%20Reference%20type%20support%20in%20MachInst%20ba.../near/203861937" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231852.20Reference.20type.20support.20in.20MachInst.20ba.2E.2E.2E.html#203861937">(Jul 14 2020 at 17:26)</a>:</h4>
<p>cfallin created <a href="https://github.com/bytecodealliance/wasmtime/pull/1852#discussion_r454521043">PR Review Comment</a>:</p>
<blockquote>
<p>The type should always be consistent with the register class; the <code>Option&lt;Type&gt;</code> is only missing when the regalloc requests a spill of a realreg (for which it doesn't have a vreg, hence no vcode-level type) at a safepoint, and this will always be an <code>I64</code> reg. Added comments to clarify.</p>
</blockquote>



<a name="203868655"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231852%20Reference%20type%20support%20in%20MachInst%20ba.../near/203868655" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231852.20Reference.20type.20support.20in.20MachInst.20ba.2E.2E.2E.html#203868655">(Jul 14 2020 at 18:22)</a>:</h4>
<p>cfallin merged <a href="https://github.com/bytecodealliance/wasmtime/pull/1852">PR #1852</a>.</p>



<hr><p>Last updated: Jan 20 2025 at 06:04 UTC</p>
</html>