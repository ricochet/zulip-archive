<html>
<head><meta charset="utf-8"><title>wasmtime / issue #6785 macos: &quot;failed to set thread excep... · git-wasmtime · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/index.html">git-wasmtime</a></h2>
<h3>Topic: <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.236785.20macos.3A.20.22failed.20to.20set.20thread.20excep.2E.2E.2E.html">wasmtime / issue #6785 macos: &quot;failed to set thread excep...</a></h3>

<hr>

<base href="https://bytecodealliance.zulipchat.com">

<head><link href="https://bytecodealliance.github.io/zulip-archive/style.css" rel="stylesheet"></head>

<a name="379925275"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%236785%20macos%3A%20%22failed%20to%20set%20thread%20excep.../near/379925275" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.236785.20macos.3A.20.22failed.20to.20set.20thread.20excep.2E.2E.2E.html#379925275">(Jul 30 2023 at 02:43)</a>:</h4>
<p>thibaultcha opened <a href="https://github.com/bytecodealliance/wasmtime/issues/6785">issue #6785</a>:</p>
<blockquote>
<p>Hello,</p>
<p>Avid Wasmtime users in our <a href="https://github.com/Kong/ngx_wasm_module">Nginx embedding</a>, we are facing an assertion failure when running it with Wasmtime on macos (x86 and arm64):</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="n">thread</span><span class="w"> </span><span class="o">'&lt;</span><span class="n">unnamed</span><span class="o">&gt;'</span><span class="w"> </span><span class="n">panicked</span><span class="w"> </span><span class="n">at</span><span class="w"> </span><span class="o">'</span><span class="na">assertion</span><span class="w"> </span><span class="n">failed</span>: <span class="err">`</span><span class="p">(</span><span class="n">left</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">right</span><span class="p">)</span><span class="err">`</span>
<span class="w">  </span><span class="n">left</span>: <span class="err">`</span><span class="mi">268435466</span><span class="err">`</span><span class="p">,</span>
<span class="w"> </span><span class="n">right</span>: <span class="err">`</span><span class="mi">0</span><span class="err">`</span>: <span class="nc">failed</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">set</span><span class="w"> </span><span class="n">thread</span><span class="w"> </span><span class="n">exception</span><span class="w"> </span><span class="n">port</span><span class="o">'</span><span class="p">,</span><span class="w"> </span><span class="n">crates</span><span class="o">/</span><span class="n">runtime</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">traphandlers</span><span class="o">/</span><span class="n">macos</span><span class="p">.</span><span class="n">rs</span>:<span class="mi">474</span>:<span class="mi">9</span>
</code></pre></div>
<p>This assertion systematically fails with Wasmtime 8.0.1 and 11.0.1 when Nginx is configured with <a href="https://nginx.org/en/docs/ngx_core_module.html#daemon">daemon on</a> (which ends <a href="https://github.com/nginx/nginx/blob/master/src/os/unix/ngx_daemon.c#L13">here</a> in Nginx forking into a background process). Not forking the master process (<code>daemon off</code>) seems to be working fine, even in forked (child) worker processes.</p>
<p>In the past we used to have a CI/CD pipeline with macos targets and Wasmtime used to work fine; but this CI/CD pipeline was taken down, and this bit us in the last few days. It seems like <a href="https://github.com/bytecodealliance/wasmtime/commit/5fecdfa49150e3304c1b949aab73bd4a0a02dbac#diff-af72c3bc843c88220e004d0703c683dee8306b270e8309e4bc26d4c7b59b2e52R436-R476">older macos work</a> on Wasmtime has something to do with it, but I know nothing of the macos system interface...</p>
<p>So far the root cause of this assertion failure has eluded us; could someone shed some light on what may be at cause here?</p>
<p>Thanks!</p>
</blockquote>



<a name="379925276"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%236785%20macos%3A%20%22failed%20to%20set%20thread%20excep.../near/379925276" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.236785.20macos.3A.20.22failed.20to.20set.20thread.20excep.2E.2E.2E.html#379925276">(Jul 30 2023 at 02:43)</a>:</h4>
<p><a href="https://github.com/thibaultcha">thibaultcha</a> added the bug label to <a href="https://github.com/bytecodealliance/wasmtime/issues/6785">Issue #6785</a>.</p>



<a name="379927004"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%236785%20macos%3A%20%22failed%20to%20set%20thread%20excep.../near/379927004" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.236785.20macos.3A.20.22failed.20to.20set.20thread.20excep.2E.2E.2E.html#379927004">(Jul 30 2023 at 03:02)</a>:</h4>
<p>thibaultcha edited <a href="https://github.com/bytecodealliance/wasmtime/issues/6785">issue #6785</a>:</p>
<blockquote>
<p>Hello,</p>
<p>Avid Wasmtime users in our <a href="https://github.com/Kong/ngx_wasm_module">Nginx embedding</a>, we are facing an assertion failure when running it with Wasmtime on macos (x86 and arm64):</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="n">thread</span><span class="w"> </span><span class="o">'&lt;</span><span class="n">unnamed</span><span class="o">&gt;'</span><span class="w"> </span><span class="n">panicked</span><span class="w"> </span><span class="n">at</span><span class="w"> </span><span class="o">'</span><span class="na">assertion</span><span class="w"> </span><span class="n">failed</span>: <span class="err">`</span><span class="p">(</span><span class="n">left</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">right</span><span class="p">)</span><span class="err">`</span>
<span class="w">  </span><span class="n">left</span>: <span class="err">`</span><span class="mi">268435466</span><span class="err">`</span><span class="p">,</span>
<span class="w"> </span><span class="n">right</span>: <span class="err">`</span><span class="mi">0</span><span class="err">`</span>: <span class="nc">failed</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">set</span><span class="w"> </span><span class="n">thread</span><span class="w"> </span><span class="n">exception</span><span class="w"> </span><span class="n">port</span><span class="o">'</span><span class="p">,</span><span class="w"> </span><span class="n">crates</span><span class="o">/</span><span class="n">runtime</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">traphandlers</span><span class="o">/</span><span class="n">macos</span><span class="p">.</span><span class="n">rs</span>:<span class="mi">474</span>:<span class="mi">9</span>
</code></pre></div>
<p>This assertion systematically fails with Wasmtime 8.0.1 and 11.0.1 when Nginx is configured with <a href="https://nginx.org/en/docs/ngx_core_module.html#daemon">daemon on</a> (which ends <a href="https://github.com/nginx/nginx/blob/master/src/os/unix/ngx_daemon.c#L13">here</a> in Nginx forking into a background process). It seems it occurs in our call to <code>wasmtime_linker_instantiate</code> after having initialized an engine and a single store. Not forking the master process (<code>daemon off</code>) seems to be working fine, even in forked (child) worker processes; instances are create and behave as expected.</p>
<p>In the past we used to have a CI/CD pipeline with macos targets and Wasmtime used to work fine; but this CI/CD pipeline was taken down, and this bit us in the last few days. It seems like <a href="https://github.com/bytecodealliance/wasmtime/commit/5fecdfa49150e3304c1b949aab73bd4a0a02dbac#diff-af72c3bc843c88220e004d0703c683dee8306b270e8309e4bc26d4c7b59b2e52R436-R476">older macos work</a> on Wasmtime has something to do with it, but I know nothing of the macos system interface...</p>
<p>So far the root cause of this assertion failure has eluded us; could someone shed some light on what may be at cause here?</p>
<p>Thanks!</p>
</blockquote>



<a name="379927051"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%236785%20macos%3A%20%22failed%20to%20set%20thread%20excep.../near/379927051" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.236785.20macos.3A.20.22failed.20to.20set.20thread.20excep.2E.2E.2E.html#379927051">(Jul 30 2023 at 03:03)</a>:</h4>
<p>thibaultcha edited <a href="https://github.com/bytecodealliance/wasmtime/issues/6785">issue #6785</a>:</p>
<blockquote>
<p>Hello,</p>
<p>Avid Wasmtime users in our <a href="https://github.com/Kong/ngx_wasm_module">Nginx embedding</a>, we are facing an assertion failure when running it with Wasmtime on macos (x86 and arm64):</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="n">thread</span><span class="w"> </span><span class="o">'&lt;</span><span class="n">unnamed</span><span class="o">&gt;'</span><span class="w"> </span><span class="n">panicked</span><span class="w"> </span><span class="n">at</span><span class="w"> </span><span class="o">'</span><span class="na">assertion</span><span class="w"> </span><span class="n">failed</span>: <span class="err">`</span><span class="p">(</span><span class="n">left</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">right</span><span class="p">)</span><span class="err">`</span>
<span class="w">  </span><span class="n">left</span>: <span class="err">`</span><span class="mi">268435466</span><span class="err">`</span><span class="p">,</span>
<span class="w"> </span><span class="n">right</span>: <span class="err">`</span><span class="mi">0</span><span class="err">`</span>: <span class="nc">failed</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">set</span><span class="w"> </span><span class="n">thread</span><span class="w"> </span><span class="n">exception</span><span class="w"> </span><span class="n">port</span><span class="o">'</span><span class="p">,</span><span class="w"> </span><span class="n">crates</span><span class="o">/</span><span class="n">runtime</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">traphandlers</span><span class="o">/</span><span class="n">macos</span><span class="p">.</span><span class="n">rs</span>:<span class="mi">474</span>:<span class="mi">9</span>
</code></pre></div>
<p>This assertion systematically fails with Wasmtime 8.0.1 (and probably earlier) to 11.0.1 when Nginx is configured with <a href="https://nginx.org/en/docs/ngx_core_module.html#daemon">daemon on</a> (which ends <a href="https://github.com/nginx/nginx/blob/master/src/os/unix/ngx_daemon.c#L13">here</a> in Nginx forking into a background process). It seems it occurs in our call to <code>wasmtime_linker_instantiate</code> after having initialized an engine and a single store. Not forking the master process (<code>daemon off</code>) seems to be working fine, even in forked (child) worker processes; instances are create and behave as expected.</p>
<p>In the past we used to have a CI/CD pipeline with macos targets and Wasmtime used to work fine; but this CI/CD pipeline was taken down, and this bit us in the last few days. It seems like <a href="https://github.com/bytecodealliance/wasmtime/commit/5fecdfa49150e3304c1b949aab73bd4a0a02dbac#diff-af72c3bc843c88220e004d0703c683dee8306b270e8309e4bc26d4c7b59b2e52R436-R476">older macos work</a> on Wasmtime has something to do with it, but I know nothing of the macos system interface...</p>
<p>So far the root cause of this assertion failure has eluded us; could someone shed some light on what may be at cause here?</p>
<p>Thanks!</p>
</blockquote>



<a name="380068445"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%236785%20macos%3A%20%22failed%20to%20set%20thread%20excep.../near/380068445" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.236785.20macos.3A.20.22failed.20to.20set.20thread.20excep.2E.2E.2E.html#380068445">(Jul 30 2023 at 15:41)</a>:</h4>
<p>thibaultcha edited <a href="https://github.com/bytecodealliance/wasmtime/issues/6785">issue #6785</a>:</p>
<blockquote>
<p>Hello,</p>
<p>Avid Wasmtime users in our <a href="https://github.com/Kong/ngx_wasm_module">Nginx embedding</a>, we are facing an assertion failure when running it with Wasmtime on macos (x86 and arm64):</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="n">thread</span><span class="w"> </span><span class="o">'&lt;</span><span class="n">unnamed</span><span class="o">&gt;'</span><span class="w"> </span><span class="n">panicked</span><span class="w"> </span><span class="n">at</span><span class="w"> </span><span class="o">'</span><span class="na">assertion</span><span class="w"> </span><span class="n">failed</span>: <span class="err">`</span><span class="p">(</span><span class="n">left</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">right</span><span class="p">)</span><span class="err">`</span>
<span class="w">  </span><span class="n">left</span>: <span class="err">`</span><span class="mi">268435466</span><span class="err">`</span><span class="p">,</span>
<span class="w"> </span><span class="n">right</span>: <span class="err">`</span><span class="mi">0</span><span class="err">`</span>: <span class="nc">failed</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">set</span><span class="w"> </span><span class="n">thread</span><span class="w"> </span><span class="n">exception</span><span class="w"> </span><span class="n">port</span><span class="o">'</span><span class="p">,</span><span class="w"> </span><span class="n">crates</span><span class="o">/</span><span class="n">runtime</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">traphandlers</span><span class="o">/</span><span class="n">macos</span><span class="p">.</span><span class="n">rs</span>:<span class="mi">474</span>:<span class="mi">9</span>
</code></pre></div>
<p>This assertion systematically fails with Wasmtime 8.0.1 (and probably earlier) to 11.0.1 when Nginx is configured with <a href="https://nginx.org/en/docs/ngx_core_module.html#daemon">daemon on</a> (which ends <a href="https://github.com/nginx/nginx/blob/master/src/os/unix/ngx_daemon.c#L13">here</a> in Nginx forking into a background process). It seems it occurs in our call to <code>wasmtime_linker_instantiate</code> after having initialized an engine and a single store. Not forking the master process (<code>daemon off</code>) seems to be working fine, even in forked (child) worker processes; instances are create and behave as expected.</p>
<p>In the past we used to have a CI/CD pipeline with macos targets and Wasmtime used to work fine; but this CI/CD pipeline was taken down, and this bit us in the last few days. It seems like <a href="https://github.com/bytecodealliance/wasmtime/commit/5fecdfa49150e3304c1b949aab73bd4a0a02dbac#diff-af72c3bc843c88220e004d0703c683dee8306b270e8309e4bc26d4c7b59b2e52R436-R476">older macos work</a> on Wasmtime has something to do with it, but I know nothing of the macos system interface...</p>
<p>So far the root cause of this assertion failure has eluded us; probably threads that aren't being carried over to the forked process or something like this. Could someone shed some light on what may be at cause here?</p>
<p>Thanks!</p>
</blockquote>



<a name="380074433"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%236785%20macos%3A%20%22failed%20to%20set%20thread%20excep.../near/380074433" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.236785.20macos.3A.20.22failed.20to.20set.20thread.20excep.2E.2E.2E.html#380074433">(Jul 30 2023 at 16:04)</a>:</h4>
<p>thibaultcha edited <a href="https://github.com/bytecodealliance/wasmtime/issues/6785">issue #6785</a>:</p>
<blockquote>
<p>Hello,</p>
<p>Avid Wasmtime users in our <a href="https://github.com/Kong/ngx_wasm_module">Nginx embedding</a>, we are facing an assertion failure when running it with Wasmtime on macos (x86 and arm64):</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="n">thread</span><span class="w"> </span><span class="o">'&lt;</span><span class="n">unnamed</span><span class="o">&gt;'</span><span class="w"> </span><span class="n">panicked</span><span class="w"> </span><span class="n">at</span><span class="w"> </span><span class="o">'</span><span class="na">assertion</span><span class="w"> </span><span class="n">failed</span>: <span class="err">`</span><span class="p">(</span><span class="n">left</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">right</span><span class="p">)</span><span class="err">`</span>
<span class="w">  </span><span class="n">left</span>: <span class="err">`</span><span class="mi">268435466</span><span class="err">`</span><span class="p">,</span>
<span class="w"> </span><span class="n">right</span>: <span class="err">`</span><span class="mi">0</span><span class="err">`</span>: <span class="nc">failed</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">set</span><span class="w"> </span><span class="n">thread</span><span class="w"> </span><span class="n">exception</span><span class="w"> </span><span class="n">port</span><span class="o">'</span><span class="p">,</span><span class="w"> </span><span class="n">crates</span><span class="o">/</span><span class="n">runtime</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">traphandlers</span><span class="o">/</span><span class="n">macos</span><span class="p">.</span><span class="n">rs</span>:<span class="mi">474</span>:<span class="mi">9</span>
</code></pre></div>
<p>This assertion systematically fails with Wasmtime 8.0.1 (and probably earlier) to 11.0.1 when Nginx is configured with <a href="https://nginx.org/en/docs/ngx_core_module.html#daemon">daemon on</a> (which ends <a href="https://github.com/nginx/nginx/blob/master/src/os/unix/ngx_daemon.c#L13">here</a> in Nginx forking into a background process). It seems it occurs in our call to <code>wasmtime_linker_instantiate</code> after having initialized an engine and a single store. Not forking the master process (<code>daemon off</code>) seems to be working fine, even in forked worker processes (managed by the master process in foreground); instances are created and behave as expected in the Nginx worker processes. The assertion failure specifically occurs when the master process forks itself into a background process with <code>daemon on</code>.</p>
<p>In the past we used to have a CI/CD pipeline with macos targets and Wasmtime used to work fine; but this CI/CD pipeline was taken down, and this bit us in the last few days. It seems like <a href="https://github.com/bytecodealliance/wasmtime/commit/5fecdfa49150e3304c1b949aab73bd4a0a02dbac#diff-af72c3bc843c88220e004d0703c683dee8306b270e8309e4bc26d4c7b59b2e52R436-R476">older macos work</a> on Wasmtime has something to do with it, but I know nothing of the macos system interface...</p>
<p>So far the root cause of this assertion failure has eluded us; probably threads that aren't being carried over to the forked process or something like this. Could someone shed some light on what may be at cause here?</p>
<p>Thanks!</p>
</blockquote>



<a name="380074684"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%236785%20macos%3A%20%22failed%20to%20set%20thread%20excep.../near/380074684" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.236785.20macos.3A.20.22failed.20to.20set.20thread.20excep.2E.2E.2E.html#380074684">(Jul 30 2023 at 16:05)</a>:</h4>
<p>thibaultcha edited <a href="https://github.com/bytecodealliance/wasmtime/issues/6785">issue #6785</a>:</p>
<blockquote>
<p>Hello,</p>
<p>Avid Wasmtime users in our <a href="https://github.com/Kong/ngx_wasm_module">Nginx embedding</a>, we are facing an assertion failure when running it with Wasmtime on macos (x86 and arm64):</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="n">thread</span><span class="w"> </span><span class="o">'&lt;</span><span class="n">unnamed</span><span class="o">&gt;'</span><span class="w"> </span><span class="n">panicked</span><span class="w"> </span><span class="n">at</span><span class="w"> </span><span class="o">'</span><span class="na">assertion</span><span class="w"> </span><span class="n">failed</span>: <span class="err">`</span><span class="p">(</span><span class="n">left</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">right</span><span class="p">)</span><span class="err">`</span>
<span class="w">  </span><span class="n">left</span>: <span class="err">`</span><span class="mi">268435466</span><span class="err">`</span><span class="p">,</span>
<span class="w"> </span><span class="n">right</span>: <span class="err">`</span><span class="mi">0</span><span class="err">`</span>: <span class="nc">failed</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">set</span><span class="w"> </span><span class="n">thread</span><span class="w"> </span><span class="n">exception</span><span class="w"> </span><span class="n">port</span><span class="o">'</span><span class="p">,</span><span class="w"> </span><span class="n">crates</span><span class="o">/</span><span class="n">runtime</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">traphandlers</span><span class="o">/</span><span class="n">macos</span><span class="p">.</span><span class="n">rs</span>:<span class="mi">474</span>:<span class="mi">9</span>
</code></pre></div>
<p>This assertion systematically fails with Wasmtime 8.0.1 (and probably earlier) to 11.0.1 when Nginx is configured with <a href="https://nginx.org/en/docs/ngx_core_module.html#daemon">daemon on</a> (which ends <a href="https://github.com/nginx/nginx/blob/master/src/os/unix/ngx_daemon.c#L13">here</a> in Nginx forking into a background process). It seems it occurs in our call to <code>wasmtime_linker_instantiate</code> after having initialized an engine and a single store.</p>
<p>Not forking the master process (<code>daemon off</code>) seems to be working fine, even in forked worker processes (managed by the master process in foreground); instances are created and behave as expected in the Nginx worker processes.<br>
The assertion failure specifically occurs once the master process has forked itself into a background process with <code>daemon on</code>.</p>
<p>In the past we used to have a CI/CD pipeline with macos targets and Wasmtime used to work fine; but this CI/CD pipeline was taken down, and this bit us in the last few days. It seems like <a href="https://github.com/bytecodealliance/wasmtime/commit/5fecdfa49150e3304c1b949aab73bd4a0a02dbac#diff-af72c3bc843c88220e004d0703c683dee8306b270e8309e4bc26d4c7b59b2e52R436-R476">older macos work</a> on Wasmtime has something to do with it, but I know nothing of the macos system interface...</p>
<p>So far the root cause of this assertion failure has eluded us; probably threads that aren't being carried over to the forked process or something like this. Could someone shed some light on what may be at cause here?</p>
<p>Thanks!</p>
</blockquote>



<a name="380075581"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%236785%20macos%3A%20%22failed%20to%20set%20thread%20excep.../near/380075581" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.236785.20macos.3A.20.22failed.20to.20set.20thread.20excep.2E.2E.2E.html#380075581">(Jul 30 2023 at 16:08)</a>:</h4>
<p>thibaultcha edited <a href="https://github.com/bytecodealliance/wasmtime/issues/6785">issue #6785</a>:</p>
<blockquote>
<p>Hello,</p>
<p>Avid Wasmtime users in our <a href="https://github.com/Kong/ngx_wasm_module">Nginx embedding</a>, we are facing an assertion failure when running it with Wasmtime on macos (x86 and arm64):</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="n">thread</span><span class="w"> </span><span class="o">'&lt;</span><span class="n">unnamed</span><span class="o">&gt;'</span><span class="w"> </span><span class="n">panicked</span><span class="w"> </span><span class="n">at</span><span class="w"> </span><span class="o">'</span><span class="na">assertion</span><span class="w"> </span><span class="n">failed</span>: <span class="err">`</span><span class="p">(</span><span class="n">left</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">right</span><span class="p">)</span><span class="err">`</span>
<span class="w">  </span><span class="n">left</span>: <span class="err">`</span><span class="mi">268435466</span><span class="err">`</span><span class="p">,</span>
<span class="w"> </span><span class="n">right</span>: <span class="err">`</span><span class="mi">0</span><span class="err">`</span>: <span class="nc">failed</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">set</span><span class="w"> </span><span class="n">thread</span><span class="w"> </span><span class="n">exception</span><span class="w"> </span><span class="n">port</span><span class="o">'</span><span class="p">,</span><span class="w"> </span><span class="n">crates</span><span class="o">/</span><span class="n">runtime</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">traphandlers</span><span class="o">/</span><span class="n">macos</span><span class="p">.</span><span class="n">rs</span>:<span class="mi">474</span>:<span class="mi">9</span>
</code></pre></div>
<p>This assertion systematically fails with Wasmtime 8.0.1 (and probably earlier) to 11.0.1 when Nginx is configured with <a href="https://nginx.org/en/docs/ngx_core_module.html#daemon">daemon on</a> (which ends <a href="https://github.com/nginx/nginx/blob/master/src/os/unix/ngx_daemon.c#L13">here</a> in Nginx forking into a background process). It seems it occurs in our call to <code>wasmtime_linker_instantiate</code> after having initialized an engine and a single store.</p>
<p>Not forking the master process (<code>daemon off</code>) seems to be working fine, even in forked worker processes (managed by the master process in foreground); instances are created and behave as expected in the Nginx worker processes.<br>
The assertion failure specifically occurs once the master process has forked itself into a background process with <code>daemon on</code>.</p>
<p>In summary:</p>
<ul>
<li>Works with <code>daemon off</code>: master process (foreground) -&gt; <code>wasmtime_linker_instantiate</code> -&gt; fork() -&gt; worker processes</li>
<li>Fails with <code>daemon on</code>: master process (foreground) -&gt; fork() (background daemon) -&gt; <code>wasmtime_linker_instantiate</code> -&gt; assertion failure, not chance to fork() into worker processes.</li>
</ul>
<p>In the past we used to have a CI/CD pipeline with macos targets and Wasmtime used to work fine; but this CI/CD pipeline was taken down, and this bit us in the last few days. It seems like <a href="https://github.com/bytecodealliance/wasmtime/commit/5fecdfa49150e3304c1b949aab73bd4a0a02dbac#diff-af72c3bc843c88220e004d0703c683dee8306b270e8309e4bc26d4c7b59b2e52R436-R476">older macos work</a> on Wasmtime has something to do with it, but I know nothing of the macos system interface...</p>
<p>So far the root cause of this assertion failure has eluded us; probably threads that aren't being carried over to the forked process or something like this. Could someone shed some light on what may be at cause here?</p>
<p>Thanks!</p>
</blockquote>



<a name="380075787"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%236785%20macos%3A%20%22failed%20to%20set%20thread%20excep.../near/380075787" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.236785.20macos.3A.20.22failed.20to.20set.20thread.20excep.2E.2E.2E.html#380075787">(Jul 30 2023 at 16:09)</a>:</h4>
<p>thibaultcha edited <a href="https://github.com/bytecodealliance/wasmtime/issues/6785">issue #6785</a>:</p>
<blockquote>
<p>Hello,</p>
<p>Avid Wasmtime users in our <a href="https://github.com/Kong/ngx_wasm_module">Nginx embedding</a>, we are facing an assertion failure when running it with Wasmtime on macos (x86 and arm64):</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="n">thread</span><span class="w"> </span><span class="o">'&lt;</span><span class="n">unnamed</span><span class="o">&gt;'</span><span class="w"> </span><span class="n">panicked</span><span class="w"> </span><span class="n">at</span><span class="w"> </span><span class="o">'</span><span class="na">assertion</span><span class="w"> </span><span class="n">failed</span>: <span class="err">`</span><span class="p">(</span><span class="n">left</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">right</span><span class="p">)</span><span class="err">`</span>
<span class="w">  </span><span class="n">left</span>: <span class="err">`</span><span class="mi">268435466</span><span class="err">`</span><span class="p">,</span>
<span class="w"> </span><span class="n">right</span>: <span class="err">`</span><span class="mi">0</span><span class="err">`</span>: <span class="nc">failed</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">set</span><span class="w"> </span><span class="n">thread</span><span class="w"> </span><span class="n">exception</span><span class="w"> </span><span class="n">port</span><span class="o">'</span><span class="p">,</span><span class="w"> </span><span class="n">crates</span><span class="o">/</span><span class="n">runtime</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">traphandlers</span><span class="o">/</span><span class="n">macos</span><span class="p">.</span><span class="n">rs</span>:<span class="mi">474</span>:<span class="mi">9</span>
</code></pre></div>
<p>This assertion systematically fails with Wasmtime 8.0.1 (and probably earlier) to 11.0.1 when Nginx is configured with <a href="https://nginx.org/en/docs/ngx_core_module.html#daemon">daemon on</a> (which ends <a href="https://github.com/nginx/nginx/blob/master/src/os/unix/ngx_daemon.c#L13">here</a> in Nginx forking into a background process). It seems it occurs in our call to <code>wasmtime_linker_instantiate</code> after having initialized an engine and a single store.</p>
<p>Not forking the master process (<code>daemon off</code>) seems to be working fine, even in forked worker processes (managed by the master process in foreground); instances are created and behave as expected in the Nginx worker processes.<br>
The assertion failure specifically occurs once the master process has forked itself into a background process with <code>daemon on</code>.</p>
<p>In summary:</p>
<ul>
<li>Works with <code>daemon off</code>: master process (foreground) -&gt; <code>wasmtime_linker_instantiate</code> (temporary instance) -&gt; fork() -&gt; worker processes</li>
<li>Fails with <code>daemon on</code>: master process (foreground) -&gt; fork() (background daemon) -&gt; <code>wasmtime_linker_instantiate</code> (temporary instance) -&gt; assertion failure, no instance created, and no chance to fork() into worker processes.</li>
</ul>
<p>In the past we used to have a CI/CD pipeline with macos targets and Wasmtime used to work fine; but this CI/CD pipeline was taken down, and this bit us in the last few days. It seems like <a href="https://github.com/bytecodealliance/wasmtime/commit/5fecdfa49150e3304c1b949aab73bd4a0a02dbac#diff-af72c3bc843c88220e004d0703c683dee8306b270e8309e4bc26d4c7b59b2e52R436-R476">older macos work</a> on Wasmtime has something to do with it, but I know nothing of the macos system interface...</p>
<p>So far the root cause of this assertion failure has eluded us; probably threads that aren't being carried over to the forked process or something like this. Could someone shed some light on what may be at cause here?</p>
<p>Thanks!</p>
</blockquote>



<a name="380075933"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%236785%20macos%3A%20%22failed%20to%20set%20thread%20excep.../near/380075933" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.236785.20macos.3A.20.22failed.20to.20set.20thread.20excep.2E.2E.2E.html#380075933">(Jul 30 2023 at 16:09)</a>:</h4>
<p>thibaultcha edited <a href="https://github.com/bytecodealliance/wasmtime/issues/6785">issue #6785</a>:</p>
<blockquote>
<p>Hello,</p>
<p>Avid Wasmtime users in our <a href="https://github.com/Kong/ngx_wasm_module">Nginx embedding</a>, we are facing an assertion failure when running it with Wasmtime on macos (x86 and arm64):</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="n">thread</span><span class="w"> </span><span class="o">'&lt;</span><span class="n">unnamed</span><span class="o">&gt;'</span><span class="w"> </span><span class="n">panicked</span><span class="w"> </span><span class="n">at</span><span class="w"> </span><span class="o">'</span><span class="na">assertion</span><span class="w"> </span><span class="n">failed</span>: <span class="err">`</span><span class="p">(</span><span class="n">left</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">right</span><span class="p">)</span><span class="err">`</span>
<span class="w">  </span><span class="n">left</span>: <span class="err">`</span><span class="mi">268435466</span><span class="err">`</span><span class="p">,</span>
<span class="w"> </span><span class="n">right</span>: <span class="err">`</span><span class="mi">0</span><span class="err">`</span>: <span class="nc">failed</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">set</span><span class="w"> </span><span class="n">thread</span><span class="w"> </span><span class="n">exception</span><span class="w"> </span><span class="n">port</span><span class="o">'</span><span class="p">,</span><span class="w"> </span><span class="n">crates</span><span class="o">/</span><span class="n">runtime</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">traphandlers</span><span class="o">/</span><span class="n">macos</span><span class="p">.</span><span class="n">rs</span>:<span class="mi">474</span>:<span class="mi">9</span>
</code></pre></div>
<p>This assertion systematically fails with Wasmtime 8.0.1 (and probably earlier) to 11.0.1 when Nginx is configured with <a href="https://nginx.org/en/docs/ngx_core_module.html#daemon">daemon on</a> (which ends <a href="https://github.com/nginx/nginx/blob/master/src/os/unix/ngx_daemon.c#L13">here</a> in Nginx forking into a background process). It seems it occurs in our call to <code>wasmtime_linker_instantiate</code> after having initialized an engine and a single store.</p>
<p>Not forking the master process (<code>daemon off</code>) seems to be working fine, even in forked worker processes (managed by the master process in foreground); instances are created and behave as expected in the Nginx worker processes.<br>
The assertion failure specifically occurs once the master process has forked itself into a background process with <code>daemon on</code>.</p>
<p>In summary:</p>
<ul>
<li>Works with <code>daemon off</code>: master process (foreground) -&gt; <code>wasmtime_linker_instantiate</code> (temporary instance) -&gt; fork() -&gt; worker processes -&gt; <code>wasmtime_linker_instantiate</code> (worker instances processing requests).</li>
<li>Fails with <code>daemon on</code>: master process (foreground) -&gt; fork() (background daemon) -&gt; <code>wasmtime_linker_instantiate</code> (temporary instance) -&gt; assertion failure, no instance created, and no chance to fork() into worker processes.</li>
</ul>
<p>In the past we used to have a CI/CD pipeline with macos targets and Wasmtime used to work fine; but this CI/CD pipeline was taken down, and this bit us in the last few days. It seems like <a href="https://github.com/bytecodealliance/wasmtime/commit/5fecdfa49150e3304c1b949aab73bd4a0a02dbac#diff-af72c3bc843c88220e004d0703c683dee8306b270e8309e4bc26d4c7b59b2e52R436-R476">older macos work</a> on Wasmtime has something to do with it, but I know nothing of the macos system interface...</p>
<p>So far the root cause of this assertion failure has eluded us; probably threads that aren't being carried over to the forked process or something like this. Could someone shed some light on what may be at cause here?</p>
<p>Thanks!</p>
</blockquote>



<a name="380388650"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%236785%20macos%3A%20%22failed%20to%20set%20thread%20excep.../near/380388650" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.236785.20macos.3A.20.22failed.20to.20set.20thread.20excep.2E.2E.2E.html#380388650">(Jul 31 2023 at 15:25)</a>:</h4>
<p>thibaultcha edited <a href="https://github.com/bytecodealliance/wasmtime/issues/6785">issue #6785</a>:</p>
<blockquote>
<p>Hello,</p>
<p>Avid Wasmtime users in our <a href="https://github.com/Kong/ngx_wasm_module">Nginx embedding</a>, we are facing an assertion failure when running it with Wasmtime on macos (x86 and arm64):</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="n">thread</span><span class="w"> </span><span class="o">'&lt;</span><span class="n">unnamed</span><span class="o">&gt;'</span><span class="w"> </span><span class="n">panicked</span><span class="w"> </span><span class="n">at</span><span class="w"> </span><span class="o">'</span><span class="na">assertion</span><span class="w"> </span><span class="n">failed</span>: <span class="err">`</span><span class="p">(</span><span class="n">left</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">right</span><span class="p">)</span><span class="err">`</span>
<span class="w">  </span><span class="n">left</span>: <span class="err">`</span><span class="mi">268435466</span><span class="err">`</span><span class="p">,</span>
<span class="w"> </span><span class="n">right</span>: <span class="err">`</span><span class="mi">0</span><span class="err">`</span>: <span class="nc">failed</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">set</span><span class="w"> </span><span class="n">thread</span><span class="w"> </span><span class="n">exception</span><span class="w"> </span><span class="n">port</span><span class="o">'</span><span class="p">,</span><span class="w"> </span><span class="n">crates</span><span class="o">/</span><span class="n">runtime</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">traphandlers</span><span class="o">/</span><span class="n">macos</span><span class="p">.</span><span class="n">rs</span>:<span class="mi">474</span>:<span class="mi">9</span>
</code></pre></div>
<p>This assertion systematically fails with Wasmtime 8.0.1 (and probably earlier) to 11.0.1 when Nginx is configured with <a href="https://nginx.org/en/docs/ngx_core_module.html#daemon">daemon on</a> (which ends <a href="https://github.com/nginx/nginx/blob/master/src/os/unix/ngx_daemon.c#L13">here</a> in Nginx forking into a background process). It seems it occurs in our call to <code>wasmtime_linker_instantiate</code> after having initialized an engine and a single store.</p>
<p>Not forking the master process (<code>daemon off</code>) seems to be working fine, even in forked worker processes (managed by the master process in foreground); instances are created and behave as expected in the Nginx worker processes.<br>
The assertion failure specifically occurs once the master process has forked itself into a background process with <code>daemon on</code>.</p>
<p>In summary:</p>
<ul>
<li>Works with <code>daemon off</code>: master process (foreground) -&gt; <code>wasmtime_linker_instantiate</code> (temporary instance) -&gt; fork() -&gt; worker processes -&gt; <code>wasmtime_linker_instantiate</code> (worker instances processing requests).</li>
<li>Fails with <code>daemon on</code>: master process (foreground) -&gt; fork() (background daemon) -&gt; <code>wasmtime_linker_instantiate</code> (temporary instance) -&gt; assertion failure, no instance created, and no chance to fork() into worker processes.</li>
</ul>
<p>In the past we used to have a CI/CD pipeline with macos targets and Wasmtime used to work fine; but this CI/CD pipeline was taken down, and this bit us in the last few days. It seems like <a href="https://github.com/bytecodealliance/wasmtime/commit/5fecdfa49150e3304c1b949aab73bd4a0a02dbac#diff-af72c3bc843c88220e004d0703c683dee8306b270e8309e4bc26d4c7b59b2e52R436-R476">older macos work</a> on Wasmtime has something to do with it, but I know nothing of the macos system interface...</p>
<p>So far the root cause of this assertion failure has eluded us; probably state that aren't being carried over to the forked process or something like this. Could someone shed some light on what may be at cause here?</p>
<p>Thanks!</p>
</blockquote>



<a name="380410507"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%236785%20macos%3A%20%22failed%20to%20set%20thread%20excep.../near/380410507" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.236785.20macos.3A.20.22failed.20to.20set.20thread.20excep.2E.2E.2E.html#380410507">(Jul 31 2023 at 16:18)</a>:</h4>
<p>thibaultcha <a href="https://github.com/bytecodealliance/wasmtime/issues/6785#issuecomment-1658713398">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/6785">issue #6785</a>:</p>
<blockquote>
<p>@casimiro has a good example and complete stacktrace of the assertion in #6788. </p>
<p>One thing we have tried to mitigate this is to destroy the engine before forking, in the hope that it would remove all secondary state, so that the forked process could call <code>engine_new</code> again and start from a clean slate. Alas, it does not make the assertion pass either.</p>
</blockquote>



<a name="380431784"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%236785%20macos%3A%20%22failed%20to%20set%20thread%20excep.../near/380431784" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.236785.20macos.3A.20.22failed.20to.20set.20thread.20excep.2E.2E.2E.html#380431784">(Jul 31 2023 at 17:22)</a>:</h4>
<p>peterhuene <a href="https://github.com/bytecodealliance/wasmtime/issues/6785#issuecomment-1658830484">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/6785">issue #6785</a>:</p>
<blockquote>
<p>The error code is <code>MACH_SEND_INVALID_RIGHT</code> (the message body specified a port right which the caller didn't possess).</p>
<p>Wasmtime allocates a Mach port name (<code>WASMTIME_PORT</code>), for receiving exceptions from the kernel, upon the very first construction of an <code>Engine</code>.</p>
<p>The assertion failure is from the per-thread initialization that occurs to setup the thread exception port from threads that are running wasm code.</p>
<p>Without a fork, this works because all threads in a process see the same Mach port namespace. However, Mach port namespaces aren't inherited in a child process.</p>
<p>So I suspect we're going to run into an issue whenever an <code>Engine</code> is created prior to a <code>fork()</code>; I'm not sure exactly what our policy is on supporting fork as there's lots of complex, OS-specific initialization in the engine, but this code is clearly not intended to be fork-aware.</p>
<p>Note that there is a compile-time feature (<code>posix-signals-on-macos</code>) which will forego the Mach exception ports integration in favor of traditional signal handlers; it might be worth seeing if you can build the Wasmtime C API with this feature flag and see if it helps with this issue.</p>
</blockquote>



<a name="380435902"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%236785%20macos%3A%20%22failed%20to%20set%20thread%20excep.../near/380435902" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.236785.20macos.3A.20.22failed.20to.20set.20thread.20excep.2E.2E.2E.html#380435902">(Jul 31 2023 at 17:36)</a>:</h4>
<p>thibaultcha <a href="https://github.com/bytecodealliance/wasmtime/issues/6785#issuecomment-1658852987">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/6785">issue #6785</a>:</p>
<blockquote>
<p>Thanks @peterhuene; ok so just like we thought, our hypothesis was the same. Although we think that destroying the engine prior to the fork should remedy to this, it feels like an issue in Wasmtime itself that it doesn't.</p>
<p>I'd say it's also a bummer that this cannot be disabled at runtime (in engine configuration) as now our users will have to compile Wasmtime themselves so they can disable this feature, they cannot just download one of the releases... But at least it is a path forward.</p>
<p>Thanks again!</p>
</blockquote>



<a name="380437037"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%236785%20macos%3A%20%22failed%20to%20set%20thread%20excep.../near/380437037" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.236785.20macos.3A.20.22failed.20to.20set.20thread.20excep.2E.2E.2E.html#380437037">(Jul 31 2023 at 17:39)</a>:</h4>
<p>thibaultcha edited a <a href="https://github.com/bytecodealliance/wasmtime/issues/6785#issuecomment-1658852987">comment</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/6785">issue #6785</a>:</p>
<blockquote>
<p>Thanks @peterhuene; ok so just like we thought, our hypothesis was the same. Although we think that destroying the engine prior to the fork should remedy this, it feels like an issue in Wasmtime itself that it doesn't.</p>
<p>I'd say it's also a bummer that this cannot be disabled at runtime (in engine configuration) as now our users will have to compile Wasmtime themselves so they can disable this feature, they cannot just download one of the releases... But at least it is a path forward.</p>
<p>Thanks again!</p>
</blockquote>



<a name="380442171"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%236785%20macos%3A%20%22failed%20to%20set%20thread%20excep.../near/380442171" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.236785.20macos.3A.20.22failed.20to.20set.20thread.20excep.2E.2E.2E.html#380442171">(Jul 31 2023 at 17:56)</a>:</h4>
<p>peterhuene <a href="https://github.com/bytecodealliance/wasmtime/issues/6785#issuecomment-1658888852">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/6785">issue #6785</a>:</p>
<blockquote>
<p>I am not aware of a reason we couldn't "uninstall" the trap handlers or reset otherwise global state upon the destruction of the last <code>Engine</code> (i.e. to restore things the way they were prior to the construction of the first <code>Engine</code>).</p>
<p>I think it simply hasn't been a priority for us to do so as generally the majority use pattern for Wasmtime thus far has been to create a single <code>Engine</code> for the process and forego fork in favor of event queues.</p>
</blockquote>



<a name="380443169"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%236785%20macos%3A%20%22failed%20to%20set%20thread%20excep.../near/380443169" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.236785.20macos.3A.20.22failed.20to.20set.20thread.20excep.2E.2E.2E.html#380443169">(Jul 31 2023 at 18:00)</a>:</h4>
<p>peterhuene edited a <a href="https://github.com/bytecodealliance/wasmtime/issues/6785#issuecomment-1658888852">comment</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/6785">issue #6785</a>:</p>
<blockquote>
<p>I am not aware of a reason we couldn't "uninstall" the trap handlers or reset otherwise global state upon the destruction of the last <code>Engine</code> (i.e. to restore things the way they were prior to the construction of the first <code>Engine</code>).</p>
<p>I think it simply hasn't been a priority for us to do so as generally the majority use pattern for Wasmtime thus far has been to create a single <code>Engine</code> for the process and forego fork in favor of single-process event queues.</p>
</blockquote>



<a name="380443515"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%236785%20macos%3A%20%22failed%20to%20set%20thread%20excep.../near/380443515" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.236785.20macos.3A.20.22failed.20to.20set.20thread.20excep.2E.2E.2E.html#380443515">(Jul 31 2023 at 18:01)</a>:</h4>
<p>thibaultcha <a href="https://github.com/bytecodealliance/wasmtime/issues/6785#issuecomment-1658894695">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/6785">issue #6785</a>:</p>
<blockquote>
<blockquote>
<p>the majority use pattern for Wasmtime thus far has been to create a single Engine for the process and forego fork in favor of event queues.</p>
</blockquote>
<p>Note that all Nginx is doing is forking into a background process which isn't so uncommon, I suspect more embeddings of Wasmtime might run into this issue in the long run. </p>
</blockquote>



<a name="380444454"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%236785%20macos%3A%20%22failed%20to%20set%20thread%20excep.../near/380444454" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.236785.20macos.3A.20.22failed.20to.20set.20thread.20excep.2E.2E.2E.html#380444454">(Jul 31 2023 at 18:04)</a>:</h4>
<p>peterhuene <a href="https://github.com/bytecodealliance/wasmtime/issues/6785#issuecomment-1658898379">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/6785">issue #6785</a>:</p>
<blockquote>
<p>Is there a call to create the engine from within the initial process when the feature to fork the daemon is on?</p>
<p>If not, I can't really explain why that particular feature would be tripping things up if all it is doing is immediately forking.</p>
</blockquote>



<a name="380446382"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%236785%20macos%3A%20%22failed%20to%20set%20thread%20excep.../near/380446382" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.236785.20macos.3A.20.22failed.20to.20set.20thread.20excep.2E.2E.2E.html#380446382">(Jul 31 2023 at 18:11)</a>:</h4>
<p>thibaultcha <a href="https://github.com/bytecodealliance/wasmtime/issues/6785#issuecomment-1658907443">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/6785">issue #6785</a>:</p>
<blockquote>
<blockquote>
<p>Is there a call to create the engine from within the initial process when the feature to fork the daemon is on?</p>
</blockquote>
<p>Yes there is or else we would have moved it already. We must open an engine and validate the <code>.wasm</code> bytecode being loaded before the <code>fork()</code> in order to potentially <code>exit()</code> if it is invalid. If we wait until after the <code>fork()</code> to do so, it is too late to ask Nginx to not start (i.e. go into background &amp; fork() into worker processes).</p>
</blockquote>



<a name="380447504"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%236785%20macos%3A%20%22failed%20to%20set%20thread%20excep.../near/380447504" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.236785.20macos.3A.20.22failed.20to.20set.20thread.20excep.2E.2E.2E.html#380447504">(Jul 31 2023 at 18:15)</a>:</h4>
<p>thibaultcha edited a <a href="https://github.com/bytecodealliance/wasmtime/issues/6785#issuecomment-1658907443">comment</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/6785">issue #6785</a>:</p>
<blockquote>
<blockquote>
<p>Is there a call to create the engine from within the initial process when the feature to fork the daemon is on?</p>
</blockquote>
<p>Yes there is or else we would have moved it already. We must open an engine and validate the <code>.wasm</code> bytecode being loaded before the <code>fork()</code> in order to potentially <code>exit()</code> if it is invalid. If we wait until after the <code>fork()</code> to do so, it is too late to ask Nginx to not start (i.e. go into background &amp; fork() into worker processes).</p>
<p>It's ok though, for now we are looking into <code>posix-signals-on-macos</code> as you pointed out.</p>
</blockquote>



<a name="380447556"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%236785%20macos%3A%20%22failed%20to%20set%20thread%20excep.../near/380447556" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.236785.20macos.3A.20.22failed.20to.20set.20thread.20excep.2E.2E.2E.html#380447556">(Jul 31 2023 at 18:15)</a>:</h4>
<p>peterhuene <a href="https://github.com/bytecodealliance/wasmtime/issues/6785#issuecomment-1658912469">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/6785">issue #6785</a>:</p>
<blockquote>
<p>I see, thank you for the clarification.</p>
<p>I suspect even in the <code>daemon off</code> case, we've initialized the per-thread exception port successfully as it's before the fork() of the worker process, but the worker probably inherited the fact it was initialized so doesn't attempt to do so again; thus I would expect trap handling to be broken if the wasm traps in the worker process.</p>
</blockquote>



<a name="380447757"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%236785%20macos%3A%20%22failed%20to%20set%20thread%20excep.../near/380447757" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.236785.20macos.3A.20.22failed.20to.20set.20thread.20excep.2E.2E.2E.html#380447757">(Jul 31 2023 at 18:16)</a>:</h4>
<p>peterhuene edited a <a href="https://github.com/bytecodealliance/wasmtime/issues/6785#issuecomment-1658912469">comment</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/6785">issue #6785</a>:</p>
<blockquote>
<p>I see, thank you for the clarification.</p>
<p>I suspect even in the <code>daemon off</code> case, we've initialized the per-thread exception port successfully as it's before the fork() of the worker process, but the worker probably inherited the fact it was initialized so doesn't attempt to do so again (and hence bypasses the assertion failure); thus I would expect trap handling to be broken if the wasm traps in the worker process.</p>
</blockquote>



<a name="380450239"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%236785%20macos%3A%20%22failed%20to%20set%20thread%20excep.../near/380450239" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.236785.20macos.3A.20.22failed.20to.20set.20thread.20excep.2E.2E.2E.html#380450239">(Jul 31 2023 at 18:24)</a>:</h4>
<p>thibaultcha edited a <a href="https://github.com/bytecodealliance/wasmtime/issues/6785#issuecomment-1658907443">comment</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/6785">issue #6785</a>:</p>
<blockquote>
<blockquote>
<p>Is there a call to create the engine from within the initial process when the feature to fork the daemon is on?</p>
</blockquote>
<p>Yes there is or else we would have moved it already. We must open an engine and validate the <code>.wasm</code> bytecode being loaded before the <code>fork()</code> in order to potentially <code>exit()</code> if it is invalid. If we wait until after the <code>fork()</code> to do so, it is too late to ask Nginx not to start (i.e. go into background &amp; fork() into worker processes).</p>
<p>It's ok though, for now we are looking into <code>posix-signals-on-macos</code> as you pointed out.</p>
</blockquote>



<a name="380452506"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%236785%20macos%3A%20%22failed%20to%20set%20thread%20excep.../near/380452506" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.236785.20macos.3A.20.22failed.20to.20set.20thread.20excep.2E.2E.2E.html#380452506">(Jul 31 2023 at 18:32)</a>:</h4>
<p>zhongweiy <a href="https://github.com/bytecodealliance/wasmtime/issues/6785#issuecomment-1658936702">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/6785">issue #6785</a>:</p>
<blockquote>
<p>For the <code>posix-signals-on-macos</code> feature, I find some error like:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="n">cargo</span><span class="w"> </span><span class="n">build</span><span class="w"> </span><span class="o">--</span><span class="n">release</span><span class="w"> </span><span class="o">-</span><span class="n">p</span><span class="w"> </span><span class="n">wasmtime</span><span class="o">-</span><span class="n">c</span><span class="o">-</span><span class="n">api</span><span class="w"> </span><span class="o">--</span><span class="n">lib</span><span class="w"> </span><span class="o">--</span><span class="n">features</span><span class="w"> </span><span class="n">posix</span><span class="o">-</span><span class="n">signals</span><span class="o">-</span><span class="n">on</span><span class="o">-</span><span class="n">macos</span>
<span class="n">error</span>: <span class="nc">none</span><span class="w"> </span><span class="n">of</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">selected</span><span class="w"> </span><span class="n">packages</span><span class="w"> </span><span class="n">contains</span><span class="w"> </span><span class="n">these</span><span class="w"> </span><span class="n">features</span>: <span class="nc">posix</span><span class="o">-</span><span class="n">signals</span><span class="o">-</span><span class="n">on</span><span class="o">-</span><span class="n">macos</span>
</code></pre></div>
<p>And it can pass without <code>wasmtime-c-api</code>:<br>
<code>cargo build --release --lib --features posix-signals-on-macos</code></p>
<p>It seems the <code>wasmtime-c-api </code> package does not have this feature. Is it a bug?</p>
</blockquote>



<a name="380453030"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%236785%20macos%3A%20%22failed%20to%20set%20thread%20excep.../near/380453030" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.236785.20macos.3A.20.22failed.20to.20set.20thread.20excep.2E.2E.2E.html#380453030">(Jul 31 2023 at 18:34)</a>:</h4>
<p>peterhuene <a href="https://github.com/bytecodealliance/wasmtime/issues/6785#issuecomment-1658939392">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/6785">issue #6785</a>:</p>
<blockquote>
<p>Yeah, it appears to be missing from the <code>wasmtime-c-api</code> crate, just needs to forward the feature to the <code>wasmtime</code> crate:</p>
<p><code>crates/c-api/Cargo.toml</code>:</p>
<p><div class="codehilite" data-code-language="TOML"><pre><span></span><code><span class="k">[features]</span>
<span class="p">...</span>
<span class="n">posix-signals-on-macos</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span><span class="s">"wasmtime/posix-signals-on-macos"</span><span class="p">]</span>
</code></pre></div><br>
</p>
</blockquote>



<a name="380453746"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%236785%20macos%3A%20%22failed%20to%20set%20thread%20excep.../near/380453746" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.236785.20macos.3A.20.22failed.20to.20set.20thread.20excep.2E.2E.2E.html#380453746">(Jul 31 2023 at 18:36)</a>:</h4>
<p>bjorn3 <a href="https://github.com/bytecodealliance/wasmtime/issues/6785#issuecomment-1658942514">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/6785">issue #6785</a>:</p>
<blockquote>
<p>If you don't want to modify the source <code>--features wasmtime/posix-signals-on-macos</code> may also work.</p>
</blockquote>



<a name="380870796"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%236785%20macos%3A%20%22failed%20to%20set%20thread%20excep.../near/380870796" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.236785.20macos.3A.20.22failed.20to.20set.20thread.20excep.2E.2E.2E.html#380870796">(Aug 02 2023 at 00:40)</a>:</h4>
<p>thibaultcha <a href="https://github.com/bytecodealliance/wasmtime/issues/6785#issuecomment-1661292561">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/6785">issue #6785</a>:</p>
<blockquote>
<p>Thanks all for the tips;</p>
<p>With macOS x86, traps are properly handled with <code>posix-signals-on-macos</code>, but on macOS ARM64, we get this exception on a trap with Wasmtime v11.0.1:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="n">thread</span><span class="w"> </span><span class="o">'&lt;</span><span class="n">unnamed</span><span class="o">&gt;'</span><span class="w"> </span><span class="n">panicked</span><span class="w"> </span><span class="n">at</span><span class="w"> </span><span class="o">'</span><span class="na">misaligned</span><span class="w"> </span><span class="n">pointer</span><span class="w"> </span><span class="n">dereference</span>: <span class="nc">address</span><span class="w"> </span><span class="n">must</span><span class="w"> </span><span class="n">be</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="n">multiple</span><span class="w"> </span><span class="n">of</span><span class="w"> </span><span class="mh">0x10</span><span class="w"> </span><span class="n">but</span><span class="w"> </span><span class="n">is</span><span class="w"> </span><span class="mh">0x105327c18</span><span class="o">'</span><span class="p">,</span><span class="w"> </span><span class="n">crates</span><span class="o">/</span><span class="n">runtime</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">traphandlers</span><span class="o">/</span><span class="n">unix</span><span class="p">.</span><span class="n">rs</span>:<span class="mi">217</span>:<span class="mi">22</span>
<span class="n">stack</span><span class="w"> </span><span class="n">backtrace</span>:
   <span class="mi">0</span>: <span class="nc">rust_begin_unwind</span>
<span class="w">             </span><span class="n">at</span><span class="w"> </span><span class="o">/</span><span class="n">rustc</span><span class="o">/</span><span class="mi">8</span><span class="n">ede3aae28fe6e4d52b38157d7bfe0d3bceef225</span><span class="o">/</span><span class="n">library</span><span class="o">/</span><span class="n">std</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">panicking</span><span class="p">.</span><span class="n">rs</span>:<span class="mi">593</span>:<span class="mi">5</span>
<span class="w">   </span><span class="mi">1</span>: <span class="nc">core</span>::<span class="n">panicking</span>::<span class="n">panic_fmt</span>
<span class="w">             </span><span class="n">at</span><span class="w"> </span><span class="o">/</span><span class="n">rustc</span><span class="o">/</span><span class="mi">8</span><span class="n">ede3aae28fe6e4d52b38157d7bfe0d3bceef225</span><span class="o">/</span><span class="n">library</span><span class="o">/</span><span class="n">core</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">panicking</span><span class="p">.</span><span class="n">rs</span>:<span class="mi">67</span>:<span class="mi">14</span>
<span class="w">   </span><span class="mi">2</span>: <span class="nc">core</span>::<span class="n">panicking</span>::<span class="n">panic_misaligned_pointer_dereference</span>
<span class="w">             </span><span class="n">at</span><span class="w"> </span><span class="o">/</span><span class="n">rustc</span><span class="o">/</span><span class="mi">8</span><span class="n">ede3aae28fe6e4d52b38157d7bfe0d3bceef225</span><span class="o">/</span><span class="n">library</span><span class="o">/</span><span class="n">core</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">panicking</span><span class="p">.</span><span class="n">rs</span>:<span class="mi">174</span>:<span class="mi">5</span>
<span class="w">   </span><span class="mi">3</span>: <span class="nc">wasmtime_runtime</span>::<span class="n">traphandlers</span>::<span class="n">unix</span>::<span class="n">get_pc_and_fp</span>
<span class="w">             </span><span class="n">at</span><span class="w"> </span><span class="p">.</span><span class="o">/</span><span class="n">work</span><span class="o">/</span><span class="n">runtimes</span><span class="o">/</span><span class="n">libwasmtime</span><span class="o">/</span><span class="n">repos</span><span class="o">/</span><span class="n">wasmtime</span><span class="o">/</span><span class="n">crates</span><span class="o">/</span><span class="n">runtime</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">traphandlers</span><span class="o">/</span><span class="n">unix</span><span class="p">.</span><span class="n">rs</span>:<span class="mi">217</span>:<span class="mi">22</span>
<span class="w">   </span><span class="mi">4</span>: <span class="nc">wasmtime_runtime</span>::<span class="n">traphandlers</span>::<span class="n">unix</span>::<span class="n">trap_handler</span>::<span class="p">{{</span><span class="n">closure</span><span class="p">}}</span>
<span class="w">             </span><span class="n">at</span><span class="w"> </span><span class="p">.</span><span class="o">/</span><span class="n">work</span><span class="o">/</span><span class="n">runtimes</span><span class="o">/</span><span class="n">libwasmtime</span><span class="o">/</span><span class="n">repos</span><span class="o">/</span><span class="n">wasmtime</span><span class="o">/</span><span class="n">crates</span><span class="o">/</span><span class="n">runtime</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">traphandlers</span><span class="o">/</span><span class="n">unix</span><span class="p">.</span><span class="n">rs</span>:<span class="mi">94</span>:<span class="mi">24</span>
<span class="w">   </span><span class="mi">5</span>: <span class="nc">wasmtime_runtime</span>::<span class="n">traphandlers</span>::<span class="n">tls</span>::<span class="n">with</span>
<span class="w">             </span><span class="n">at</span><span class="w"> </span><span class="p">.</span><span class="o">/</span><span class="n">work</span><span class="o">/</span><span class="n">runtimes</span><span class="o">/</span><span class="n">libwasmtime</span><span class="o">/</span><span class="n">repos</span><span class="o">/</span><span class="n">wasmtime</span><span class="o">/</span><span class="n">crates</span><span class="o">/</span><span class="n">runtime</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">traphandlers</span><span class="p">.</span><span class="n">rs</span>:<span class="mi">747</span>:<span class="mi">18</span>
<span class="w">   </span><span class="mi">6</span>: <span class="nc">wasmtime_runtime</span>::<span class="n">traphandlers</span>::<span class="n">unix</span>::<span class="n">trap_handler</span>
<span class="w">             </span><span class="n">at</span><span class="w"> </span><span class="p">.</span><span class="o">/</span><span class="n">work</span><span class="o">/</span><span class="n">runtimes</span><span class="o">/</span><span class="n">libwasmtime</span><span class="o">/</span><span class="n">repos</span><span class="o">/</span><span class="n">wasmtime</span><span class="o">/</span><span class="n">crates</span><span class="o">/</span><span class="n">runtime</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">traphandlers</span><span class="o">/</span><span class="n">unix</span><span class="p">.</span><span class="n">rs</span>:<span class="mi">79</span>:<span class="mi">19</span>
<span class="w">   </span><span class="mi">7</span>: <span class="nc">__platform_memmove</span>
</code></pre></div>
<p>This seems to be coming from Wasmtime's interaction with the libc binding...</p>
</blockquote>



<a name="380943181"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%236785%20macos%3A%20%22failed%20to%20set%20thread%20excep.../near/380943181" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.236785.20macos.3A.20.22failed.20to.20set.20thread.20excep.2E.2E.2E.html#380943181">(Aug 02 2023 at 08:19)</a>:</h4>
<p>alexcrichton <a href="https://github.com/bytecodealliance/wasmtime/issues/6785#issuecomment-1661730132">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/6785">issue #6785</a>:</p>
<blockquote>
<p>That's a bug! I've posted a temporary fix for that at <a href="https://github.com/bytecodealliance/wasmtime/pull/6793">https://github.com/bytecodealliance/wasmtime/pull/6793</a></p>
</blockquote>



<a name="381224615"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%236785%20macos%3A%20%22failed%20to%20set%20thread%20excep.../near/381224615" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.236785.20macos.3A.20.22failed.20to.20set.20thread.20excep.2E.2E.2E.html#381224615">(Aug 02 2023 at 16:37)</a>:</h4>
<p>fitzgen closed <a href="https://github.com/bytecodealliance/wasmtime/issues/6785">issue #6785</a>:</p>
<blockquote>
<p>Hello,</p>
<p>Avid Wasmtime users in our <a href="https://github.com/Kong/ngx_wasm_module">Nginx embedding</a>, we are facing an assertion failure when running it with Wasmtime on macos (x86 and arm64):</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="n">thread</span><span class="w"> </span><span class="o">'&lt;</span><span class="n">unnamed</span><span class="o">&gt;'</span><span class="w"> </span><span class="n">panicked</span><span class="w"> </span><span class="n">at</span><span class="w"> </span><span class="o">'</span><span class="na">assertion</span><span class="w"> </span><span class="n">failed</span>: <span class="err">`</span><span class="p">(</span><span class="n">left</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">right</span><span class="p">)</span><span class="err">`</span>
<span class="w">  </span><span class="n">left</span>: <span class="err">`</span><span class="mi">268435466</span><span class="err">`</span><span class="p">,</span>
<span class="w"> </span><span class="n">right</span>: <span class="err">`</span><span class="mi">0</span><span class="err">`</span>: <span class="nc">failed</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">set</span><span class="w"> </span><span class="n">thread</span><span class="w"> </span><span class="n">exception</span><span class="w"> </span><span class="n">port</span><span class="o">'</span><span class="p">,</span><span class="w"> </span><span class="n">crates</span><span class="o">/</span><span class="n">runtime</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">traphandlers</span><span class="o">/</span><span class="n">macos</span><span class="p">.</span><span class="n">rs</span>:<span class="mi">474</span>:<span class="mi">9</span>
</code></pre></div>
<p>This assertion systematically fails with Wasmtime 8.0.1 (and probably earlier) to 11.0.1 when Nginx is configured with <a href="https://nginx.org/en/docs/ngx_core_module.html#daemon">daemon on</a> (which ends <a href="https://github.com/nginx/nginx/blob/master/src/os/unix/ngx_daemon.c#L13">here</a> in Nginx forking into a background process). It seems it occurs in our call to <code>wasmtime_linker_instantiate</code> after having initialized an engine and a single store.</p>
<p>Not forking the master process (<code>daemon off</code>) seems to be working fine, even in forked worker processes (managed by the master process in foreground); instances are created and behave as expected in the Nginx worker processes.<br>
The assertion failure specifically occurs once the master process has forked itself into a background process with <code>daemon on</code>.</p>
<p>In summary:</p>
<ul>
<li>Works with <code>daemon off</code>: master process (foreground) -&gt; <code>wasmtime_linker_instantiate</code> (temporary instance) -&gt; fork() -&gt; worker processes -&gt; <code>wasmtime_linker_instantiate</code> (worker instances processing requests).</li>
<li>Fails with <code>daemon on</code>: master process (foreground) -&gt; fork() (background daemon) -&gt; <code>wasmtime_linker_instantiate</code> (temporary instance) -&gt; assertion failure, no instance created, and no chance to fork() into worker processes.</li>
</ul>
<p>In the past we used to have a CI/CD pipeline with macos targets and Wasmtime used to work fine; but this CI/CD pipeline was taken down, and this bit us in the last few days. It seems like <a href="https://github.com/bytecodealliance/wasmtime/commit/5fecdfa49150e3304c1b949aab73bd4a0a02dbac#diff-af72c3bc843c88220e004d0703c683dee8306b270e8309e4bc26d4c7b59b2e52R436-R476">older macos work</a> on Wasmtime has something to do with it, but I know nothing of the macos system interface...</p>
<p>So far the root cause of this assertion failure has eluded us; probably state that aren't being carried over to the forked process or something like this. Could someone shed some light on what may be at cause here?</p>
<p>Thanks!</p>
</blockquote>



<a name="381227828"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%236785%20macos%3A%20%22failed%20to%20set%20thread%20excep.../near/381227828" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.236785.20macos.3A.20.22failed.20to.20set.20thread.20excep.2E.2E.2E.html#381227828">(Aug 02 2023 at 16:47)</a>:</h4>
<p>alexcrichton <a href="https://github.com/bytecodealliance/wasmtime/issues/6785#issuecomment-1662575274">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/6785">issue #6785</a>:</p>
<blockquote>
<p>Oops didn't mean to close this</p>
</blockquote>



<a name="381227830"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%236785%20macos%3A%20%22failed%20to%20set%20thread%20excep.../near/381227830" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.236785.20macos.3A.20.22failed.20to.20set.20thread.20excep.2E.2E.2E.html#381227830">(Aug 02 2023 at 16:47)</a>:</h4>
<p>alexcrichton reopened <a href="https://github.com/bytecodealliance/wasmtime/issues/6785">issue #6785</a>:</p>
<blockquote>
<p>Hello,</p>
<p>Avid Wasmtime users in our <a href="https://github.com/Kong/ngx_wasm_module">Nginx embedding</a>, we are facing an assertion failure when running it with Wasmtime on macos (x86 and arm64):</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="n">thread</span><span class="w"> </span><span class="o">'&lt;</span><span class="n">unnamed</span><span class="o">&gt;'</span><span class="w"> </span><span class="n">panicked</span><span class="w"> </span><span class="n">at</span><span class="w"> </span><span class="o">'</span><span class="na">assertion</span><span class="w"> </span><span class="n">failed</span>: <span class="err">`</span><span class="p">(</span><span class="n">left</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">right</span><span class="p">)</span><span class="err">`</span>
<span class="w">  </span><span class="n">left</span>: <span class="err">`</span><span class="mi">268435466</span><span class="err">`</span><span class="p">,</span>
<span class="w"> </span><span class="n">right</span>: <span class="err">`</span><span class="mi">0</span><span class="err">`</span>: <span class="nc">failed</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">set</span><span class="w"> </span><span class="n">thread</span><span class="w"> </span><span class="n">exception</span><span class="w"> </span><span class="n">port</span><span class="o">'</span><span class="p">,</span><span class="w"> </span><span class="n">crates</span><span class="o">/</span><span class="n">runtime</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">traphandlers</span><span class="o">/</span><span class="n">macos</span><span class="p">.</span><span class="n">rs</span>:<span class="mi">474</span>:<span class="mi">9</span>
</code></pre></div>
<p>This assertion systematically fails with Wasmtime 8.0.1 (and probably earlier) to 11.0.1 when Nginx is configured with <a href="https://nginx.org/en/docs/ngx_core_module.html#daemon">daemon on</a> (which ends <a href="https://github.com/nginx/nginx/blob/master/src/os/unix/ngx_daemon.c#L13">here</a> in Nginx forking into a background process). It seems it occurs in our call to <code>wasmtime_linker_instantiate</code> after having initialized an engine and a single store.</p>
<p>Not forking the master process (<code>daemon off</code>) seems to be working fine, even in forked worker processes (managed by the master process in foreground); instances are created and behave as expected in the Nginx worker processes.<br>
The assertion failure specifically occurs once the master process has forked itself into a background process with <code>daemon on</code>.</p>
<p>In summary:</p>
<ul>
<li>Works with <code>daemon off</code>: master process (foreground) -&gt; <code>wasmtime_linker_instantiate</code> (temporary instance) -&gt; fork() -&gt; worker processes -&gt; <code>wasmtime_linker_instantiate</code> (worker instances processing requests).</li>
<li>Fails with <code>daemon on</code>: master process (foreground) -&gt; fork() (background daemon) -&gt; <code>wasmtime_linker_instantiate</code> (temporary instance) -&gt; assertion failure, no instance created, and no chance to fork() into worker processes.</li>
</ul>
<p>In the past we used to have a CI/CD pipeline with macos targets and Wasmtime used to work fine; but this CI/CD pipeline was taken down, and this bit us in the last few days. It seems like <a href="https://github.com/bytecodealliance/wasmtime/commit/5fecdfa49150e3304c1b949aab73bd4a0a02dbac#diff-af72c3bc843c88220e004d0703c683dee8306b270e8309e4bc26d4c7b59b2e52R436-R476">older macos work</a> on Wasmtime has something to do with it, but I know nothing of the macos system interface...</p>
<p>So far the root cause of this assertion failure has eluded us; probably state that aren't being carried over to the forked process or something like this. Could someone shed some light on what may be at cause here?</p>
<p>Thanks!</p>
</blockquote>



<a name="381831773"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%236785%20macos%3A%20%22failed%20to%20set%20thread%20excep.../near/381831773" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.236785.20macos.3A.20.22failed.20to.20set.20thread.20excep.2E.2E.2E.html#381831773">(Aug 04 2023 at 12:49)</a>:</h4>
<p>alexcrichton <a href="https://github.com/bytecodealliance/wasmtime/issues/6785#issuecomment-1665557427">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/6785">issue #6785</a>:</p>
<blockquote>
<p>I investigated this a bit recently and I'm not actually certain that we'll want to fix this. I think that the best solution here might be to recommend that macOS users who want to leverage <code>fork</code> should use signals via the Cargo feature rather than the default mach ports. If this is common then one option we could support is to make this a runtime configuration option instead of a compile-time configuration option too.</p>
<p>Otherwise though the issues on macOS that I found difficult to handle are:</p>
<ul>
<li>Trap handling can't be Engine-local because the process's exception ports are, well, process-global. </li>
<li>It's technically possible to shut down the ports/handler thread when <code>Engine</code>s all go away, but that IMO is kind of spooky action-at-a-distance where you have to be certain that no <code>Engine</code> is in existence which you may not necessarily always have control over (although I realize it's reasonable for this use case)</li>
<li>One option is to use <code>pthread_atfork</code>, but the problem with that is that it's unclear if all forks are intended for this sort of use case where the process continues to live of if it's something ephemeral such as a fork-then-exec combo.</li>
</ul>
<p>I suppose that can all be mostly summarized as I think the only possibly-feasible thing to do here is to shut everything down when an <code>Engine</code> is destroyed, but I'm not personally all that comfortable doing that as it doesn't align with other platforms and I'm also not certain how robust we can make it.</p>
<p>Otherwise though @thibaultcha I'd ask you if having a custom build is difficult for y'all? If so we can move the signals-vs-ports to a runtime option instead. Additionally one other mitigation we could implement is to use <code>pthread_atfork</code> to force any wasm execution in the child to panic immediately rather than continue in a broken state, effectively having a more precise way of warning developers that "hey ports aren't compatible with fork please use this other thing to use signals instead"</p>
</blockquote>



<a name="381906530"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%236785%20macos%3A%20%22failed%20to%20set%20thread%20excep.../near/381906530" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.236785.20macos.3A.20.22failed.20to.20set.20thread.20excep.2E.2E.2E.html#381906530">(Aug 04 2023 at 16:09)</a>:</h4>
<p>thibaultcha <a href="https://github.com/bytecodealliance/wasmtime/issues/6785#issuecomment-1665859105">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/6785">issue #6785</a>:</p>
<blockquote>
<p>Hi @alexcrichton, thanks for having a look at this too! It is ok for us to have a custom build, although a runtime configuration option would be even better since it means users can download any of the upstream Wasmtime releases which imho is ideal for a friction-less experience. How much work do you foresee that be? Perhaps it could be something one of us could contribute (a difficulty is that none of us on my team has access to a Macbook, but maybe we can write the patch off a box if it isn't too big).</p>
<p>Although, I do hope relying on this feature in the long run won't be a hassle for us (e.g. if Wasmtime on macos focuses more efforts &amp; fixes on trap handling through ports at the detriment of signal dispositions); in which case having tighter control over the port handlers might be preferable, since we could shut it down before <code>fork()</code> and ensure all of our processes rely on the same mechanisms Wasmtime invests into... </p>
</blockquote>



<a name="381995885"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%236785%20macos%3A%20%22failed%20to%20set%20thread%20excep.../near/381995885" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.236785.20macos.3A.20.22failed.20to.20set.20thread.20excep.2E.2E.2E.html#381995885">(Aug 04 2023 at 23:54)</a>:</h4>
<p>alexcrichton <a href="https://github.com/bytecodealliance/wasmtime/issues/6785#issuecomment-1666287551">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/6785">issue #6785</a>:</p>
<blockquote>
<p>Ok sounds good! Not too much work but no worries I've done some initial bits in <a href="https://github.com/bytecodealliance/wasmtime/pull/6807">https://github.com/bytecodealliance/wasmtime/pull/6807</a> now. If you'd like though some help in implementing a corresponding option in the C API would be appreciated!</p>
<p>As for the long term you should be good. Unix signals are unlikely to be as battle-tested as Mach ports because they're off-by-default for macOS, but they're turn on-by-default for Linux for example which means they're not completely untested. Y'all aren't the first to want to use signals instead of mach ports as well so it's something that I'd at least personally like to see continued support for in Wasmtime. Basically that's to say that, yes, you may run into future issues. I think we'll be interested in fixing them promptly, though, if they arise.</p>
</blockquote>



<a name="388385934"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%236785%20macos%3A%20%22failed%20to%20set%20thread%20excep.../near/388385934" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.236785.20macos.3A.20.22failed.20to.20set.20thread.20excep.2E.2E.2E.html#388385934">(Aug 31 2023 at 18:41)</a>:</h4>
<p>alexcrichton <a href="https://github.com/bytecodealliance/wasmtime/issues/6785#issuecomment-1701575363">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/6785">issue #6785</a>:</p>
<blockquote>
<p>I think everything is now handled here with a combo of <a href="https://github.com/bytecodealliance/wasmtime/issues/6785#issuecomment-1665557427">what I mentioned above</a>:</p>
<ul>
<li>There's a <a href="https://docs.wasmtime.dev/api/wasmtime/struct.Config.html#method.macos_use_mach_ports">runtime configuration option</a> for mach ports vs signals</li>
<li>We use <a href="https://github.com/bytecodealliance/wasmtime/blob/6a5bddf02d9f136bb0f998d26a91f97dce9860bc/crates/runtime/src/traphandlers/macos.rs#L170-L178"><code>pthread_atfork</code></a> to fail-fast in child processes trying to do wasm things</li>
</ul>
<p>I'm going to close this now but @thibaultcha if there's anything else please comment here!</p>
</blockquote>



<a name="388385936"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%236785%20macos%3A%20%22failed%20to%20set%20thread%20excep.../near/388385936" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.236785.20macos.3A.20.22failed.20to.20set.20thread.20excep.2E.2E.2E.html#388385936">(Aug 31 2023 at 18:41)</a>:</h4>
<p>alexcrichton closed <a href="https://github.com/bytecodealliance/wasmtime/issues/6785">issue #6785</a>:</p>
<blockquote>
<p>Hello,</p>
<p>Avid Wasmtime users in our <a href="https://github.com/Kong/ngx_wasm_module">Nginx embedding</a>, we are facing an assertion failure when running it with Wasmtime on macos (x86 and arm64):</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="n">thread</span><span class="w"> </span><span class="o">'&lt;</span><span class="n">unnamed</span><span class="o">&gt;'</span><span class="w"> </span><span class="n">panicked</span><span class="w"> </span><span class="n">at</span><span class="w"> </span><span class="o">'</span><span class="na">assertion</span><span class="w"> </span><span class="n">failed</span>: <span class="err">`</span><span class="p">(</span><span class="n">left</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">right</span><span class="p">)</span><span class="err">`</span>
<span class="w">  </span><span class="n">left</span>: <span class="err">`</span><span class="mi">268435466</span><span class="err">`</span><span class="p">,</span>
<span class="w"> </span><span class="n">right</span>: <span class="err">`</span><span class="mi">0</span><span class="err">`</span>: <span class="nc">failed</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">set</span><span class="w"> </span><span class="n">thread</span><span class="w"> </span><span class="n">exception</span><span class="w"> </span><span class="n">port</span><span class="o">'</span><span class="p">,</span><span class="w"> </span><span class="n">crates</span><span class="o">/</span><span class="n">runtime</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">traphandlers</span><span class="o">/</span><span class="n">macos</span><span class="p">.</span><span class="n">rs</span>:<span class="mi">474</span>:<span class="mi">9</span>
</code></pre></div>
<p>This assertion systematically fails with Wasmtime 8.0.1 (and probably earlier) to 11.0.1 when Nginx is configured with <a href="https://nginx.org/en/docs/ngx_core_module.html#daemon">daemon on</a> (which ends <a href="https://github.com/nginx/nginx/blob/master/src/os/unix/ngx_daemon.c#L13">here</a> in Nginx forking into a background process). It seems it occurs in our call to <code>wasmtime_linker_instantiate</code> after having initialized an engine and a single store.</p>
<p>Not forking the master process (<code>daemon off</code>) seems to be working fine, even in forked worker processes (managed by the master process in foreground); instances are created and behave as expected in the Nginx worker processes.<br>
The assertion failure specifically occurs once the master process has forked itself into a background process with <code>daemon on</code>.</p>
<p>In summary:</p>
<ul>
<li>Works with <code>daemon off</code>: master process (foreground) -&gt; <code>wasmtime_linker_instantiate</code> (temporary instance) -&gt; fork() -&gt; worker processes -&gt; <code>wasmtime_linker_instantiate</code> (worker instances processing requests).</li>
<li>Fails with <code>daemon on</code>: master process (foreground) -&gt; fork() (background daemon) -&gt; <code>wasmtime_linker_instantiate</code> (temporary instance) -&gt; assertion failure, no instance created, and no chance to fork() into worker processes.</li>
</ul>
<p>In the past we used to have a CI/CD pipeline with macos targets and Wasmtime used to work fine; but this CI/CD pipeline was taken down, and this bit us in the last few days. It seems like <a href="https://github.com/bytecodealliance/wasmtime/commit/5fecdfa49150e3304c1b949aab73bd4a0a02dbac#diff-af72c3bc843c88220e004d0703c683dee8306b270e8309e4bc26d4c7b59b2e52R436-R476">older macos work</a> on Wasmtime has something to do with it, but I know nothing of the macos system interface...</p>
<p>So far the root cause of this assertion failure has eluded us; probably state that aren't being carried over to the forked process or something like this. Could someone shed some light on what may be at cause here?</p>
<p>Thanks!</p>
</blockquote>



<hr><p>Last updated: Jan 20 2025 at 06:04 UTC</p>
</html>