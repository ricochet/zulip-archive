<html>
<head><meta charset="utf-8"><title>wasmtime / issue #1032 Mitigating Spectre attacks · git-wasmtime · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/index.html">git-wasmtime</a></h2>
<h3>Topic: <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.231032.20Mitigating.20Spectre.20attacks.html">wasmtime / issue #1032 Mitigating Spectre attacks</a></h3>

<hr>

<base href="https://bytecodealliance.zulipchat.com">

<head><link href="https://bytecodealliance.github.io/zulip-archive/style.css" rel="stylesheet"></head>

<a name="281212877"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%231032%20Mitigating%20Spectre%20attacks/near/281212877" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.231032.20Mitigating.20Spectre.20attacks.html#281212877">(May 04 2022 at 20:09)</a>:</h4>
<p>cfallin <a href="https://github.com/bytecodealliance/wasmtime/issues/1032#issuecomment-1117845236">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/1032">issue #1032</a>:</p>
<blockquote>
<p>I'm doing some issue gardening here and I believe we have done <em>most</em> of the above by now: we have conditional move-based mitigations on heap accesses, table accesses, and branch table loads. We don't have any indirect predictor-specific mitigations yet, but we're working on incorporating hardware CFI techniques (see <a href="https://github.com/bytecodealliance/rfcs/issues/17">bytecodealliance/rfcs#17</a>).</p>
<p>I'll leave it up to our processor-vendor folks whether they think we have sufficient mitigations now, or with the CFI features, to mark this issue "resolved" -- @akirilov-arm, @abrown, @uweigand, others, what do you think?</p>
</blockquote>



<a name="281212899"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%231032%20Mitigating%20Spectre%20attacks/near/281212899" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.231032.20Mitigating.20Spectre.20attacks.html#281212899">(May 04 2022 at 20:09)</a>:</h4>
<p>cfallin labeled <a href="https://github.com/bytecodealliance/wasmtime/issues/1032">issue #1032</a>:</p>
<blockquote>
<p>Hello,</p>
<p>You are probably well aware, but some mainstream compilers are emitting <a href="https://support.google.com/faqs/answer/7625886">retpolines</a> to help mitigate <a href="https://spectreattack.com/spectre.pdf">Spectre variant 2 attacks</a>. Do you have any plans to add  a similar capability to the cretonne code generator (and/or do you think it makes sense for cretonne to do this sort of thing)?</p>
<p>Thanks,<br>
Jon</p>
<p>/cc @tyler @pchickey </p>
</blockquote>



<a name="281212939"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%231032%20Mitigating%20Spectre%20attacks/near/281212939" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.231032.20Mitigating.20Spectre.20attacks.html#281212939">(May 04 2022 at 20:09)</a>:</h4>
<p>cfallin labeled <a href="https://github.com/bytecodealliance/wasmtime/issues/1032">issue #1032</a>:</p>
<blockquote>
<p>Hello,</p>
<p>You are probably well aware, but some mainstream compilers are emitting <a href="https://support.google.com/faqs/answer/7625886">retpolines</a> to help mitigate <a href="https://spectreattack.com/spectre.pdf">Spectre variant 2 attacks</a>. Do you have any plans to add  a similar capability to the cretonne code generator (and/or do you think it makes sense for cretonne to do this sort of thing)?</p>
<p>Thanks,<br>
Jon</p>
<p>/cc @tyler @pchickey </p>
</blockquote>



<a name="281869565"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%231032%20Mitigating%20Spectre%20attacks/near/281869565" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.231032.20Mitigating.20Spectre.20attacks.html#281869565">(May 10 2022 at 18:54)</a>:</h4>
<p>akirilov-arm <a href="https://github.com/bytecodealliance/wasmtime/issues/1032#issuecomment-1122751761">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/1032">issue #1032</a>:</p>
<blockquote>
<p>Concerning the Arm architecture, Arm has published <a href="https://developer.arm.com/Arm%20Security%20Center/Speculative%20Processor%20Vulnerability">documentation</a> on the various speculative execution vulnerabilities. Unfortunately the hardware CFI techniques that are discussed by the RFC proposal mentioned above do not really help with speculative execution attacks that target indirect branch predictors - they rely on instructions that raise processor exceptions, which in most implementations does not happen while executing speculatively; that is somewhat similar to the straight-line speculation vulnerability covered by the documentation.</p>
<p>As for the attacks that apply to conditional direct branches, e.g. bounds checks, according to Arm's guidance the conditional moves should be followed by the <code>CSDB</code> <a href="https://armv8.arm.com/v8-A/A_profile/isa64/ISA_A64_xml_A_profile-2022-03/csdb.xml">instruction</a> in order to future-proof the mitigations (that barrier instruction executes as a no-op on processors that predate it).</p>
</blockquote>



<a name="291102979"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%231032%20Mitigating%20Spectre%20attacks/near/291102979" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.231032.20Mitigating.20Spectre.20attacks.html#291102979">(Jul 27 2022 at 20:03)</a>:</h4>
<p>akirilov-arm edited a <a href="https://github.com/bytecodealliance/wasmtime/issues/1032#issuecomment-1122751761">comment</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/1032">issue #1032</a>:</p>
<blockquote>
<p>Concerning the Arm architecture, Arm has published <a href="https://developer.arm.com/Arm%20Security%20Center/Speculative%20Processor%20Vulnerability">documentation</a> on the various speculative execution vulnerabilities. Unfortunately the hardware CFI techniques that are discussed by the RFC proposal mentioned above do not really help with speculative execution attacks that target indirect branch predictors - they rely on instructions that raise processor exceptions, which in most implementations does not happen while executing speculatively; that is somewhat similar to the straight-line speculation vulnerability covered by the documentation.</p>
<p>As for the attacks that apply to conditional direct branches, e.g. bounds checks, according to Arm's guidance the conditional moves should be followed by the <code>CSDB</code> <a href="https://developer.arm.com/documentation/ddi0602/2022-06/Base-Instructions/CSDB--Consumption-of-Speculative-Data-Barrier-?lang=en">instruction</a> in order to future-proof the mitigations (that barrier instruction executes as a no-op on processors that predate it).</p>
</blockquote>



<a name="299229573"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%231032%20Mitigating%20Spectre%20attacks/near/299229573" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.231032.20Mitigating.20Spectre.20attacks.html#299229573">(Sep 16 2022 at 19:37)</a>:</h4>
<p>akirilov-arm <a href="https://github.com/bytecodealliance/wasmtime/issues/1032#issuecomment-1249736886">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/1032">issue #1032</a>:</p>
<blockquote>
<p>Recently I have done a little bit of research on Spectre-V2, and my conclusion is that on AArch64 the only efficient mitigation (so I exclude techniques such as retpolines) is provided by the <code>FEAT_CSV2_2</code> extension to the Arm architecture. It specifies a system register, <code>SCXTNUM_EL0</code>, that can be used to associate a software-defined context number with branch prediction, and as a result branch predictions for one context are unable to influence speculative execution in another one. So, one implementation approach would be to reserve a context number, e.g. <code>0</code>, for the WebAssembly runtime, and then come up with a number for each Wasm context that the runtime manages. On a transition from the runtime implementation to a Wasm module, for example, it would be necessary to execute:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="n">msr</span><span class="w"> </span><span class="n">scxtnum_el0</span><span class="p">,</span><span class="w"> </span><span class="n">xn</span><span class="w"></span>
<span class="n">isb</span><span class="w"></span>
</code></pre></div>
<p>where <code>Xn</code> holds the context number associated with the Wasm module. Note that no changes to the code generated from WebAssembly are necessary. Depending on the threat model, it might also make sense for each Wasm module to get its own runtime context number (that is, the runtime is not always going to use <code>0</code>), or even a (pseudo)random value (the <code>PACGA</code> instruction provided by the pointer authentication extension is an efficient way to obtain one). The hardware itself does not assign a special meaning to any context number value.</p>
<p>The <code>FEAT_CSV2_2</code> extension is supported by recent processors such as Arm Cortex-A510, A710, A715, X2, and X3, and also Arm Neoverse N2. Unfortunately AFAIK the Linux kernel (as of version <code>6.0-rc5</code>) does not expose an interface such as <code>getauxval(AT_HWCAP2)</code> to query about the availability of that extension.</p>
<p>We also have a similar attack to contend with, <a href="https://developer.arm.com/Arm%20Security%20Center/Spectre-BHB">Spectre-BHB</a>. The mitigation against it is to execute a small loop that would be located right next to the operation setting <code>SCXTNUM_EL0</code> - the details are in <a href="https://developer.arm.com/documentation/102898/0107/?lang=en">the white paper</a> that Arm has published about the attack. Future processors may have even more efficient mitigations - the white paper covers those too.</p>
</blockquote>



<hr><p>Last updated: Jan 20 2025 at 06:04 UTC</p>
</html>