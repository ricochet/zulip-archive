<html>
<head><meta charset="utf-8"><title>wasmtime / issue #8821 Directory read bug. · git-wasmtime · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/index.html">git-wasmtime</a></h2>
<h3>Topic: <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.238821.20Directory.20read.20bug.2E.html">wasmtime / issue #8821 Directory read bug.</a></h3>

<hr>

<base href="https://bytecodealliance.zulipchat.com">

<head><link href="https://bytecodealliance.github.io/zulip-archive/style.css" rel="stylesheet"></head>

<a name="445121801"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%238821%20Directory%20read%20bug./near/445121801" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.238821.20Directory.20read.20bug.2E.html#445121801">(Jun 17 2024 at 12:33)</a>:</h4>
<p><a href="https://github.com/Userzxcvbvnm">Userzxcvbvnm</a> added the bug label to <a href="https://github.com/bytecodealliance/wasmtime/issues/8821">Issue #8821</a>.</p>



<a name="445121806"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%238821%20Directory%20read%20bug./near/445121806" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.238821.20Directory.20read.20bug.2E.html#445121806">(Jun 17 2024 at 12:33)</a>:</h4>
<p>Userzxcvbvnm opened <a href="https://github.com/bytecodealliance/wasmtime/issues/8821">issue #8821</a>:</p>
<blockquote>
<h3>Test Case</h3>
<p>The c test case is:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="p">#</span><span class="n">include</span><span class="w"> </span><span class="o">&lt;</span><span class="n">stdio</span><span class="p">.</span><span class="n">h</span><span class="o">&gt;</span>
<span class="p">#</span><span class="n">include</span><span class="w"> </span><span class="o">&lt;</span><span class="n">dirent</span><span class="p">.</span><span class="n">h</span><span class="o">&gt;</span>
<span class="p">#</span><span class="n">include</span><span class="w"> </span><span class="o">&lt;</span><span class="n">fcntl</span><span class="p">.</span><span class="n">h</span><span class="o">&gt;</span>
<span class="p">#</span><span class="n">include</span><span class="w"> </span><span class="o">&lt;</span><span class="n">unistd</span><span class="p">.</span><span class="n">h</span><span class="o">&gt;</span>


<span class="p">#</span><span class="n">include</span><span class="w"> </span><span class="o">&lt;</span><span class="n">errno</span><span class="p">.</span><span class="n">h</span><span class="o">&gt;</span>
<span class="p">#</span><span class="n">include</span><span class="w"> </span><span class="o">&lt;</span><span class="n">string</span><span class="p">.</span><span class="n">h</span><span class="o">&gt;</span>

<span class="n">void</span><span class="w"> </span><span class="n">fd_readdir_00001_sYQM0</span><span class="p">(</span><span class="n">int</span><span class="w"> </span><span class="n">fd</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">printf</span><span class="p">(</span><span class="s">"Enter function fd_readdir_00001_sYQM0</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>

<span class="w">    </span><span class="n">DIR</span><span class="w"> </span><span class="o">*</span><span class="n">directory</span><span class="p">;</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">dirent</span><span class="w"> </span><span class="o">*</span><span class="n">entry</span><span class="p">;</span>
<span class="w">    </span><span class="n">directory</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">fdopendir</span><span class="p">(</span><span class="n">fd</span><span class="p">);</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">directory</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">NULL</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">printf</span><span class="p">(</span><span class="s">"fdopendir failed.</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
<span class="w">        </span><span class="k">return</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="k">while</span><span class="w"> </span><span class="p">((</span><span class="n">entry</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">readdir</span><span class="p">(</span><span class="n">directory</span><span class="p">))</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">NULL</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">printf</span><span class="p">(</span><span class="s">"Get dir content:%s</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span><span class="w"> </span><span class="n">entry</span><span class="p">-&gt;</span><span class="nc">d_name</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="n">printf</span><span class="p">(</span><span class="s">"Print dir content finished.</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
<span class="p">}</span>

<span class="n">int</span><span class="w"> </span><span class="n">get_fd</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="n">filename</span><span class="p">,</span><span class="w"> </span><span class="n">int</span><span class="w"> </span><span class="n">flags</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">int</span><span class="w"> </span><span class="n">fd</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">open</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span><span class="w"> </span><span class="n">flags</span><span class="p">);</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">fd</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">printf</span><span class="p">(</span><span class="s">"Get file descriptor of file %s failed!</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span><span class="w"> </span><span class="n">filename</span><span class="p">);</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="o">-</span><span class="mi">1</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">printf</span><span class="p">(</span><span class="s">"Get file descriptor of file %s succeed!</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span><span class="w"> </span><span class="n">filename</span><span class="p">);</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">fd</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>

<span class="n">void</span><span class="w"> </span><span class="n">closebyfd</span><span class="p">(</span><span class="n">int</span><span class="w"> </span><span class="n">fd</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">close</span><span class="p">(</span><span class="n">fd</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">printf</span><span class="p">(</span><span class="s">"Close the file %d by descriptor failed!</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span><span class="w"> </span><span class="n">fd</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>

<span class="n">int</span><span class="w"> </span><span class="n">main</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">int</span><span class="w"> </span><span class="n">fd</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">get_fd</span><span class="p">(</span><span class="s">"subdir_2/subdir_5"</span><span class="p">,</span><span class="w"> </span><span class="n">O_RDONLY</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">O_DIRECTORY</span><span class="p">);</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">fd</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="n">fd_readdir_00001_sYQM0</span><span class="p">(</span><span class="n">fd</span><span class="p">);</span>

<span class="w">    </span><span class="n">closebyfd</span><span class="p">(</span><span class="n">fd</span><span class="p">);</span>

<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div>
<h3>Steps to Reproduce</h3>
<p>(1)compile to wasm:<code>./wasi-sdk-21.0/bin/clang --target=wasm32-unkown-wasi --sysroot=./wasi-sdk-21.0/share/wasi-sysroot test.c -o test.wasm</code></p>
<p>(2)Running wasm:<br>
(Before run the Wasm file, directory subdir_2/subdir_5 exists, and contains sub files subfile_1, subfile_2, subfile_3 in it.<br>
Before run the Wasm file, change the permission of subdir_2/subdir_5 into 0400(r--------) or 0600(rw-------). )<br>
<code>wasmtime run --dir=. test.wasm</code></p>
<h3>Expected Results</h3>
<p>Print:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="n">Get</span><span class="w"> </span><span class="n">file</span><span class="w"> </span><span class="n">descriptor</span><span class="w"> </span><span class="n">of</span><span class="w"> </span><span class="n">file</span><span class="w"> </span><span class="n">subdir_2</span><span class="o">/</span><span class="n">subdir_5</span><span class="w"> </span><span class="n">succeed</span><span class="o">!</span>
<span class="n">Enter</span><span class="w"> </span><span class="n">function</span><span class="w"> </span><span class="n">fd_readdir_00001_sYQM0</span>
<span class="n">Get</span><span class="w"> </span><span class="n">dir</span><span class="w"> </span><span class="n">content</span><span class="p">:</span><span class="nc">subfile_2</span>
<span class="n">Get</span><span class="w"> </span><span class="n">dir</span><span class="w"> </span><span class="n">content</span><span class="p">:</span><span class="nc">subfile_3</span>
<span class="n">Get</span><span class="w"> </span><span class="n">dir</span><span class="w"> </span><span class="n">content</span><span class="p">:.</span>
<span class="n">Get</span><span class="w"> </span><span class="n">dir</span><span class="w"> </span><span class="n">content</span><span class="p">:</span><span class="o">..</span>
<span class="n">Get</span><span class="w"> </span><span class="n">dir</span><span class="w"> </span><span class="n">content</span><span class="p">:</span><span class="nc">subfile_1</span>
<span class="n">Print</span><span class="w"> </span><span class="n">dir</span><span class="w"> </span><span class="n">content</span><span class="w"> </span><span class="n">finished</span><span class="p">.</span>
</code></pre></div>
<p>This is what WAMR and WasmEdge do.</p>
<h3>Actual Results</h3>
<p>wasmtime prints:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="n">Get</span><span class="w"> </span><span class="n">file</span><span class="w"> </span><span class="n">descriptor</span><span class="w"> </span><span class="n">of</span><span class="w"> </span><span class="n">file</span><span class="w"> </span><span class="n">subdir_2</span><span class="o">/</span><span class="n">subdir_5</span><span class="w"> </span><span class="n">succeed</span><span class="o">!</span>
<span class="n">Enter</span><span class="w"> </span><span class="n">function</span><span class="w"> </span><span class="n">fd_readdir_00001_sYQM0</span>
<span class="n">fdopendir</span><span class="w"> </span><span class="n">failed</span><span class="p">.</span>
</code></pre></div>
<p>wasmtime fails to read the file items in the directory although both permission 0400 and 0600 has the read permission.</p>
<h3>Versions and Environment</h3>
<p>Wasmtime version or commit: 19.0.2<br>
Operating system: Ubuntu 20.04<br>
Architecture: x86_64<br>
</p>
</blockquote>



<a name="445190729"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%238821%20Directory%20read%20bug./near/445190729" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.238821.20Directory.20read.20bug.2E.html#445190729">(Jun 17 2024 at 17:52)</a>:</h4>
<p>alexcrichton <a href="https://github.com/bytecodealliance/wasmtime/issues/8821#issuecomment-2173993673">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/8821">issue #8821</a>:</p>
<blockquote>
<p>This is an under-specified corner of this function in WASI. Right now Wasmtime will reopen the directory each time a directory iterator is requested to ensure that state on the file descriptor is not carried over from one read to the next. I don't know if other runtimes will have the same behavior if the same file descriptor is opened as a directory and read twice. This directory cannot be directly opened in this manner I believe because the execute permission bit is missing.</p>
<p>I think it would be best to open a bug with WASI to figure out the correct behavior here.</p>
</blockquote>



<a name="445259973"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%238821%20Directory%20read%20bug./near/445259973" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.238821.20Directory.20read.20bug.2E.html#445259973">(Jun 18 2024 at 02:44)</a>:</h4>
<p>Userzxcvbvnm <a href="https://github.com/bytecodealliance/wasmtime/issues/8821#issuecomment-2174850192">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/8821">issue #8821</a>:</p>
<blockquote>
<p>Thanks for your reply! I reproduce this with Linux native code (<code>gcc test.c -o test</code>, <code>./test</code>) and Linux native has the same behavior with WAMR and WasmEdge. I'm not sure whether wasmtime should behave like this.</p>
</blockquote>



<a name="445260008"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%238821%20Directory%20read%20bug./near/445260008" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.238821.20Directory.20read.20bug.2E.html#445260008">(Jun 18 2024 at 02:44)</a>:</h4>
<p>Userzxcvbvnm edited <a href="https://github.com/bytecodealliance/wasmtime/issues/8821">issue #8821</a>:</p>
<blockquote>
<h3>Test Case</h3>
<p>The c test case is:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="p">#</span><span class="n">include</span><span class="w"> </span><span class="o">&lt;</span><span class="n">stdio</span><span class="p">.</span><span class="n">h</span><span class="o">&gt;</span>
<span class="p">#</span><span class="n">include</span><span class="w"> </span><span class="o">&lt;</span><span class="n">dirent</span><span class="p">.</span><span class="n">h</span><span class="o">&gt;</span>
<span class="p">#</span><span class="n">include</span><span class="w"> </span><span class="o">&lt;</span><span class="n">fcntl</span><span class="p">.</span><span class="n">h</span><span class="o">&gt;</span>
<span class="p">#</span><span class="n">include</span><span class="w"> </span><span class="o">&lt;</span><span class="n">unistd</span><span class="p">.</span><span class="n">h</span><span class="o">&gt;</span>


<span class="p">#</span><span class="n">include</span><span class="w"> </span><span class="o">&lt;</span><span class="n">errno</span><span class="p">.</span><span class="n">h</span><span class="o">&gt;</span>
<span class="p">#</span><span class="n">include</span><span class="w"> </span><span class="o">&lt;</span><span class="n">string</span><span class="p">.</span><span class="n">h</span><span class="o">&gt;</span>

<span class="n">void</span><span class="w"> </span><span class="n">fd_readdir_00001_sYQM0</span><span class="p">(</span><span class="n">int</span><span class="w"> </span><span class="n">fd</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">printf</span><span class="p">(</span><span class="s">"Enter function fd_readdir_00001_sYQM0</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>

<span class="w">    </span><span class="n">DIR</span><span class="w"> </span><span class="o">*</span><span class="n">directory</span><span class="p">;</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">dirent</span><span class="w"> </span><span class="o">*</span><span class="n">entry</span><span class="p">;</span>
<span class="w">    </span><span class="n">directory</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">fdopendir</span><span class="p">(</span><span class="n">fd</span><span class="p">);</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">directory</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">NULL</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">printf</span><span class="p">(</span><span class="s">"fdopendir failed.</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
<span class="w">        </span><span class="k">return</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="k">while</span><span class="w"> </span><span class="p">((</span><span class="n">entry</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">readdir</span><span class="p">(</span><span class="n">directory</span><span class="p">))</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">NULL</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">printf</span><span class="p">(</span><span class="s">"Get dir content:%s</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span><span class="w"> </span><span class="n">entry</span><span class="p">-&gt;</span><span class="nc">d_name</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="n">printf</span><span class="p">(</span><span class="s">"Print dir content finished.</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
<span class="p">}</span>

<span class="n">int</span><span class="w"> </span><span class="n">get_fd</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="n">filename</span><span class="p">,</span><span class="w"> </span><span class="n">int</span><span class="w"> </span><span class="n">flags</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">int</span><span class="w"> </span><span class="n">fd</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">open</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span><span class="w"> </span><span class="n">flags</span><span class="p">);</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">fd</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">printf</span><span class="p">(</span><span class="s">"Get file descriptor of file %s failed!</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span><span class="w"> </span><span class="n">filename</span><span class="p">);</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="o">-</span><span class="mi">1</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">printf</span><span class="p">(</span><span class="s">"Get file descriptor of file %s succeed!</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span><span class="w"> </span><span class="n">filename</span><span class="p">);</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">fd</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>

<span class="n">void</span><span class="w"> </span><span class="n">closebyfd</span><span class="p">(</span><span class="n">int</span><span class="w"> </span><span class="n">fd</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">close</span><span class="p">(</span><span class="n">fd</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">printf</span><span class="p">(</span><span class="s">"Close the file %d by descriptor failed!</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span><span class="w"> </span><span class="n">fd</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>

<span class="n">int</span><span class="w"> </span><span class="n">main</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">int</span><span class="w"> </span><span class="n">fd</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">get_fd</span><span class="p">(</span><span class="s">"subdir_2/subdir_5"</span><span class="p">,</span><span class="w"> </span><span class="n">O_RDONLY</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">O_DIRECTORY</span><span class="p">);</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">fd</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="n">fd_readdir_00001_sYQM0</span><span class="p">(</span><span class="n">fd</span><span class="p">);</span>

<span class="w">    </span><span class="n">closebyfd</span><span class="p">(</span><span class="n">fd</span><span class="p">);</span>

<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div>
<h3>Steps to Reproduce</h3>
<p>(1)compile to wasm:<code>./wasi-sdk-21.0/bin/clang --target=wasm32-unkown-wasi --sysroot=./wasi-sdk-21.0/share/wasi-sysroot test.c -o test.wasm</code></p>
<p>(2)Running wasm:<br>
(Before run the Wasm file, directory subdir_2/subdir_5 exists, and contains sub files subfile_1, subfile_2, subfile_3 in it.<br>
Before run the Wasm file, change the permission of subdir_2/subdir_5 into 0400(r--------) or 0600(rw-------). )<br>
<code>wasmtime run --dir=. test.wasm</code></p>
<h3>Expected Results</h3>
<p>Print:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="n">Get</span><span class="w"> </span><span class="n">file</span><span class="w"> </span><span class="n">descriptor</span><span class="w"> </span><span class="n">of</span><span class="w"> </span><span class="n">file</span><span class="w"> </span><span class="n">subdir_2</span><span class="o">/</span><span class="n">subdir_5</span><span class="w"> </span><span class="n">succeed</span><span class="o">!</span>
<span class="n">Enter</span><span class="w"> </span><span class="n">function</span><span class="w"> </span><span class="n">fd_readdir_00001_sYQM0</span>
<span class="n">Get</span><span class="w"> </span><span class="n">dir</span><span class="w"> </span><span class="n">content</span><span class="p">:</span><span class="nc">subfile_2</span>
<span class="n">Get</span><span class="w"> </span><span class="n">dir</span><span class="w"> </span><span class="n">content</span><span class="p">:</span><span class="nc">subfile_3</span>
<span class="n">Get</span><span class="w"> </span><span class="n">dir</span><span class="w"> </span><span class="n">content</span><span class="p">:.</span>
<span class="n">Get</span><span class="w"> </span><span class="n">dir</span><span class="w"> </span><span class="n">content</span><span class="p">:</span><span class="o">..</span>
<span class="n">Get</span><span class="w"> </span><span class="n">dir</span><span class="w"> </span><span class="n">content</span><span class="p">:</span><span class="nc">subfile_1</span>
<span class="n">Print</span><span class="w"> </span><span class="n">dir</span><span class="w"> </span><span class="n">content</span><span class="w"> </span><span class="n">finished</span><span class="p">.</span>
</code></pre></div>
<p>This is what WAMR, WasmEdge  and Linux native code do.</p>
<h3>Actual Results</h3>
<p>wasmtime prints:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="n">Get</span><span class="w"> </span><span class="n">file</span><span class="w"> </span><span class="n">descriptor</span><span class="w"> </span><span class="n">of</span><span class="w"> </span><span class="n">file</span><span class="w"> </span><span class="n">subdir_2</span><span class="o">/</span><span class="n">subdir_5</span><span class="w"> </span><span class="n">succeed</span><span class="o">!</span>
<span class="n">Enter</span><span class="w"> </span><span class="n">function</span><span class="w"> </span><span class="n">fd_readdir_00001_sYQM0</span>
<span class="n">fdopendir</span><span class="w"> </span><span class="n">failed</span><span class="p">.</span>
</code></pre></div>
<p>wasmtime fails to read the file items in the directory although both permission 0400 and 0600 has the read permission.</p>
<h3>Versions and Environment</h3>
<p>Wasmtime version or commit: 19.0.2<br>
Operating system: Ubuntu 20.04<br>
Architecture: x86_64<br>
</p>
</blockquote>



<a name="445392157"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%238821%20Directory%20read%20bug./near/445392157" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.238821.20Directory.20read.20bug.2E.html#445392157">(Jun 18 2024 at 15:35)</a>:</h4>
<p>alexcrichton <a href="https://github.com/bytecodealliance/wasmtime/issues/8821#issuecomment-2176402439">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/8821">issue #8821</a>:</p>
<blockquote>
<p>Yes I understand that Linux enables this, but WASI isn't just a copy wholesale of Linux. This is specifically grappling with a concept not in WASI, namely file permissions. Given that I'm hesitant to commit any particular behavior in Wasmtime as it's not clear to me which is the way to go.</p>
<p>In general most of the cases you're running into are "holes" in the WASI specification, but WASI (in my opinion) is going to take a very long time if ever to completely and fully specify every possible interaction between filesystems. Given that we can try to patch things up as they come up but it's not really feasible to get 100% determinism across all possible runtimes across all possible platforms. For example I would be surprised if other runtimes has consistent behavior on <a href="https://github.com/bytecodealliance/wasmtime/issues/8817">https://github.com/bytecodealliance/wasmtime/issues/8817</a> across all platforms. Just because Linux does something doesn't mean that it's what should be codified in WASI.</p>
<p>I don't think that this issue has a solid resolution in WASI itself, but I still think it's worthwhile to open an issue there and get the discussion going. Either that or someone else can also chime in and say "no, Alex, behavior X is obviously the correct one to implement here" and Wasmtime can implement that.</p>
</blockquote>



<a name="445494959"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%238821%20Directory%20read%20bug./near/445494959" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.238821.20Directory.20read.20bug.2E.html#445494959">(Jun 19 2024 at 02:16)</a>:</h4>
<p>Userzxcvbvnm <a href="https://github.com/bytecodealliance/wasmtime/issues/8821#issuecomment-2177409225">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/8821">issue #8821</a>:</p>
<blockquote>
<p>Thanks for your reply! As you suggested, I'll open a bug with WASI to figure out the correct behavior.</p>
</blockquote>



<a name="446811667"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%238821%20Directory%20read%20bug./near/446811667" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.238821.20Directory.20read.20bug.2E.html#446811667">(Jun 25 2024 at 08:34)</a>:</h4>
<p>Userzxcvbvnm edited <a href="https://github.com/bytecodealliance/wasmtime/issues/8821">issue #8821</a>:</p>
<blockquote>
<h3>Test Case</h3>
<p>The c test case is:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="p">#</span><span class="n">include</span><span class="w"> </span><span class="o">&lt;</span><span class="n">stdio</span><span class="p">.</span><span class="n">h</span><span class="o">&gt;</span>
<span class="p">#</span><span class="n">include</span><span class="w"> </span><span class="o">&lt;</span><span class="n">dirent</span><span class="p">.</span><span class="n">h</span><span class="o">&gt;</span>
<span class="p">#</span><span class="n">include</span><span class="w"> </span><span class="o">&lt;</span><span class="n">fcntl</span><span class="p">.</span><span class="n">h</span><span class="o">&gt;</span>
<span class="p">#</span><span class="n">include</span><span class="w"> </span><span class="o">&lt;</span><span class="n">unistd</span><span class="p">.</span><span class="n">h</span><span class="o">&gt;</span>


<span class="p">#</span><span class="n">include</span><span class="w"> </span><span class="o">&lt;</span><span class="n">errno</span><span class="p">.</span><span class="n">h</span><span class="o">&gt;</span>
<span class="p">#</span><span class="n">include</span><span class="w"> </span><span class="o">&lt;</span><span class="n">string</span><span class="p">.</span><span class="n">h</span><span class="o">&gt;</span>

<span class="n">void</span><span class="w"> </span><span class="n">fd_readdir_00001_sYQM0</span><span class="p">(</span><span class="n">int</span><span class="w"> </span><span class="n">fd</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">printf</span><span class="p">(</span><span class="s">"Enter function fd_readdir_00001_sYQM0</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>

<span class="w">    </span><span class="n">DIR</span><span class="w"> </span><span class="o">*</span><span class="n">directory</span><span class="p">;</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">dirent</span><span class="w"> </span><span class="o">*</span><span class="n">entry</span><span class="p">;</span>
<span class="w">    </span><span class="n">directory</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">fdopendir</span><span class="p">(</span><span class="n">fd</span><span class="p">);</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">directory</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">NULL</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">printf</span><span class="p">(</span><span class="s">"fdopendir failed.</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
<span class="w">        </span><span class="k">return</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="k">while</span><span class="w"> </span><span class="p">((</span><span class="n">entry</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">readdir</span><span class="p">(</span><span class="n">directory</span><span class="p">))</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">NULL</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">printf</span><span class="p">(</span><span class="s">"Get dir content:%s</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span><span class="w"> </span><span class="n">entry</span><span class="p">-&gt;</span><span class="nc">d_name</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="n">printf</span><span class="p">(</span><span class="s">"Print dir content finished.</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
<span class="p">}</span>

<span class="n">int</span><span class="w"> </span><span class="n">get_fd</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="n">filename</span><span class="p">,</span><span class="w"> </span><span class="n">int</span><span class="w"> </span><span class="n">flags</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">int</span><span class="w"> </span><span class="n">fd</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">open</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span><span class="w"> </span><span class="n">flags</span><span class="p">);</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">fd</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">printf</span><span class="p">(</span><span class="s">"Get file descriptor of file %s failed!</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span><span class="w"> </span><span class="n">filename</span><span class="p">);</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="o">-</span><span class="mi">1</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">printf</span><span class="p">(</span><span class="s">"Get file descriptor of file %s succeed!</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span><span class="w"> </span><span class="n">filename</span><span class="p">);</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">fd</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>

<span class="n">void</span><span class="w"> </span><span class="n">closebyfd</span><span class="p">(</span><span class="n">int</span><span class="w"> </span><span class="n">fd</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">close</span><span class="p">(</span><span class="n">fd</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">printf</span><span class="p">(</span><span class="s">"Close the file %d by descriptor failed!</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span><span class="w"> </span><span class="n">fd</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>

<span class="n">int</span><span class="w"> </span><span class="n">main</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">int</span><span class="w"> </span><span class="n">fd</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">get_fd</span><span class="p">(</span><span class="s">"subdir_2/subdir_5"</span><span class="p">,</span><span class="w"> </span><span class="n">O_RDONLY</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">O_DIRECTORY</span><span class="p">);</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">fd</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="n">fd_readdir_00001_sYQM0</span><span class="p">(</span><span class="n">fd</span><span class="p">);</span>

<span class="w">    </span><span class="n">closebyfd</span><span class="p">(</span><span class="n">fd</span><span class="p">);</span>

<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div>
<h3>Steps to Reproduce</h3>
<p>(1)compile to wasm:<code>./wasi-sdk-21.0/bin/clang --target=wasm32-unkown-wasi --sysroot=./wasi-sdk-21.0/share/wasi-sysroot test.c -o test.wasm</code></p>
<p>(2)Running wasm:<br>
(Before run the Wasm file, directory subdir_2/subdir_5 exists, and contains sub files subfile_1, subfile_2, subfile_3 in it.<br>
Before run the Wasm file, change the permission of subdir_2/subdir_5 into 0400(r--------) or 0600(rw-------). )<br>
<code>wasmtime run --dir=. test.wasm</code></p>
<h3>Expected Results</h3>
<p>Print:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="n">Get</span><span class="w"> </span><span class="n">file</span><span class="w"> </span><span class="n">descriptor</span><span class="w"> </span><span class="n">of</span><span class="w"> </span><span class="n">file</span><span class="w"> </span><span class="n">subdir_2</span><span class="o">/</span><span class="n">subdir_5</span><span class="w"> </span><span class="n">succeed</span><span class="o">!</span>
<span class="n">Enter</span><span class="w"> </span><span class="n">function</span><span class="w"> </span><span class="n">fd_readdir_00001_sYQM0</span>
<span class="n">Get</span><span class="w"> </span><span class="n">dir</span><span class="w"> </span><span class="n">content</span><span class="p">:</span><span class="nc">subfile_2</span>
<span class="n">Get</span><span class="w"> </span><span class="n">dir</span><span class="w"> </span><span class="n">content</span><span class="p">:</span><span class="nc">subfile_3</span>
<span class="n">Get</span><span class="w"> </span><span class="n">dir</span><span class="w"> </span><span class="n">content</span><span class="p">:.</span>
<span class="n">Get</span><span class="w"> </span><span class="n">dir</span><span class="w"> </span><span class="n">content</span><span class="p">:</span><span class="o">..</span>
<span class="n">Get</span><span class="w"> </span><span class="n">dir</span><span class="w"> </span><span class="n">content</span><span class="p">:</span><span class="nc">subfile_1</span>
<span class="n">Print</span><span class="w"> </span><span class="n">dir</span><span class="w"> </span><span class="n">content</span><span class="w"> </span><span class="n">finished</span><span class="p">.</span>
</code></pre></div>
<p>This is what WAMR, WasmEdge  and Linux native code do.</p>
<h3>Actual Results</h3>
<p>wasmtime prints:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="n">Get</span><span class="w"> </span><span class="n">file</span><span class="w"> </span><span class="n">descriptor</span><span class="w"> </span><span class="n">of</span><span class="w"> </span><span class="n">file</span><span class="w"> </span><span class="n">subdir_2</span><span class="o">/</span><span class="n">subdir_5</span><span class="w"> </span><span class="n">succeed</span><span class="o">!</span>
<span class="n">Enter</span><span class="w"> </span><span class="n">function</span><span class="w"> </span><span class="n">fd_readdir_00001_sYQM0</span>
<span class="n">fdopendir</span><span class="w"> </span><span class="n">failed</span><span class="p">.</span>
</code></pre></div>
<p>wasmtime fails to read the file items in the directory although both permission 0400 and 0600 has the read permission.</p>
<h3>Versions and Environment</h3>
<p>Wasmtime version or commit: 19.0.2 and 13.0.1<br>
Operating system: Ubuntu 20.04<br>
Architecture: x86_64<br>
</p>
</blockquote>



<a name="468404354"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%238821%20Directory%20read%20bug./near/468404354" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.238821.20Directory.20read.20bug.2E.html#468404354">(Sep 07 2024 at 12:46)</a>:</h4>
<p>tschneidereit closed <a href="https://github.com/bytecodealliance/wasmtime/issues/8821">issue #8821</a>:</p>
<blockquote>
<h3>Test Case</h3>
<p>The c test case is:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="p">#</span><span class="n">include</span><span class="w"> </span><span class="o">&lt;</span><span class="n">stdio</span><span class="p">.</span><span class="n">h</span><span class="o">&gt;</span>
<span class="p">#</span><span class="n">include</span><span class="w"> </span><span class="o">&lt;</span><span class="n">dirent</span><span class="p">.</span><span class="n">h</span><span class="o">&gt;</span>
<span class="p">#</span><span class="n">include</span><span class="w"> </span><span class="o">&lt;</span><span class="n">fcntl</span><span class="p">.</span><span class="n">h</span><span class="o">&gt;</span>
<span class="p">#</span><span class="n">include</span><span class="w"> </span><span class="o">&lt;</span><span class="n">unistd</span><span class="p">.</span><span class="n">h</span><span class="o">&gt;</span>


<span class="p">#</span><span class="n">include</span><span class="w"> </span><span class="o">&lt;</span><span class="n">errno</span><span class="p">.</span><span class="n">h</span><span class="o">&gt;</span>
<span class="p">#</span><span class="n">include</span><span class="w"> </span><span class="o">&lt;</span><span class="n">string</span><span class="p">.</span><span class="n">h</span><span class="o">&gt;</span>

<span class="n">void</span><span class="w"> </span><span class="n">fd_readdir_00001_sYQM0</span><span class="p">(</span><span class="n">int</span><span class="w"> </span><span class="n">fd</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">printf</span><span class="p">(</span><span class="s">"Enter function fd_readdir_00001_sYQM0</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>

<span class="w">    </span><span class="n">DIR</span><span class="w"> </span><span class="o">*</span><span class="n">directory</span><span class="p">;</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">dirent</span><span class="w"> </span><span class="o">*</span><span class="n">entry</span><span class="p">;</span>
<span class="w">    </span><span class="n">directory</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">fdopendir</span><span class="p">(</span><span class="n">fd</span><span class="p">);</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">directory</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">NULL</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">printf</span><span class="p">(</span><span class="s">"fdopendir failed.</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
<span class="w">        </span><span class="k">return</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="k">while</span><span class="w"> </span><span class="p">((</span><span class="n">entry</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">readdir</span><span class="p">(</span><span class="n">directory</span><span class="p">))</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">NULL</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">printf</span><span class="p">(</span><span class="s">"Get dir content:%s</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span><span class="w"> </span><span class="n">entry</span><span class="p">-&gt;</span><span class="nc">d_name</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="n">printf</span><span class="p">(</span><span class="s">"Print dir content finished.</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
<span class="p">}</span>

<span class="n">int</span><span class="w"> </span><span class="n">get_fd</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="n">filename</span><span class="p">,</span><span class="w"> </span><span class="n">int</span><span class="w"> </span><span class="n">flags</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">int</span><span class="w"> </span><span class="n">fd</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">open</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span><span class="w"> </span><span class="n">flags</span><span class="p">);</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">fd</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">printf</span><span class="p">(</span><span class="s">"Get file descriptor of file %s failed!</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span><span class="w"> </span><span class="n">filename</span><span class="p">);</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="o">-</span><span class="mi">1</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">printf</span><span class="p">(</span><span class="s">"Get file descriptor of file %s succeed!</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span><span class="w"> </span><span class="n">filename</span><span class="p">);</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">fd</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>

<span class="n">void</span><span class="w"> </span><span class="n">closebyfd</span><span class="p">(</span><span class="n">int</span><span class="w"> </span><span class="n">fd</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">close</span><span class="p">(</span><span class="n">fd</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">printf</span><span class="p">(</span><span class="s">"Close the file %d by descriptor failed!</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span><span class="w"> </span><span class="n">fd</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>

<span class="n">int</span><span class="w"> </span><span class="n">main</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">int</span><span class="w"> </span><span class="n">fd</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">get_fd</span><span class="p">(</span><span class="s">"subdir_2/subdir_5"</span><span class="p">,</span><span class="w"> </span><span class="n">O_RDONLY</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">O_DIRECTORY</span><span class="p">);</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">fd</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="n">fd_readdir_00001_sYQM0</span><span class="p">(</span><span class="n">fd</span><span class="p">);</span>

<span class="w">    </span><span class="n">closebyfd</span><span class="p">(</span><span class="n">fd</span><span class="p">);</span>

<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div>
<h3>Steps to Reproduce</h3>
<p>(1)compile to wasm:<code>./wasi-sdk-21.0/bin/clang --target=wasm32-unkown-wasi --sysroot=./wasi-sdk-21.0/share/wasi-sysroot test.c -o test.wasm</code></p>
<p>(2)Running wasm:<br>
(Before run the Wasm file, directory subdir_2/subdir_5 exists, and contains sub files subfile_1, subfile_2, subfile_3 in it.<br>
Before run the Wasm file, change the permission of subdir_2/subdir_5 into 0400(r--------) or 0600(rw-------). )<br>
<code>wasmtime run --dir=. test.wasm</code></p>
<h3>Expected Results</h3>
<p>Print:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="n">Get</span><span class="w"> </span><span class="n">file</span><span class="w"> </span><span class="n">descriptor</span><span class="w"> </span><span class="n">of</span><span class="w"> </span><span class="n">file</span><span class="w"> </span><span class="n">subdir_2</span><span class="o">/</span><span class="n">subdir_5</span><span class="w"> </span><span class="n">succeed</span><span class="o">!</span>
<span class="n">Enter</span><span class="w"> </span><span class="n">function</span><span class="w"> </span><span class="n">fd_readdir_00001_sYQM0</span>
<span class="n">Get</span><span class="w"> </span><span class="n">dir</span><span class="w"> </span><span class="n">content</span><span class="p">:</span><span class="nc">subfile_2</span>
<span class="n">Get</span><span class="w"> </span><span class="n">dir</span><span class="w"> </span><span class="n">content</span><span class="p">:</span><span class="nc">subfile_3</span>
<span class="n">Get</span><span class="w"> </span><span class="n">dir</span><span class="w"> </span><span class="n">content</span><span class="p">:.</span>
<span class="n">Get</span><span class="w"> </span><span class="n">dir</span><span class="w"> </span><span class="n">content</span><span class="p">:</span><span class="o">..</span>
<span class="n">Get</span><span class="w"> </span><span class="n">dir</span><span class="w"> </span><span class="n">content</span><span class="p">:</span><span class="nc">subfile_1</span>
<span class="n">Print</span><span class="w"> </span><span class="n">dir</span><span class="w"> </span><span class="n">content</span><span class="w"> </span><span class="n">finished</span><span class="p">.</span>
</code></pre></div>
<p>This is what WAMR, WasmEdge  and Linux native code do.</p>
<h3>Actual Results</h3>
<p>wasmtime prints:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="n">Get</span><span class="w"> </span><span class="n">file</span><span class="w"> </span><span class="n">descriptor</span><span class="w"> </span><span class="n">of</span><span class="w"> </span><span class="n">file</span><span class="w"> </span><span class="n">subdir_2</span><span class="o">/</span><span class="n">subdir_5</span><span class="w"> </span><span class="n">succeed</span><span class="o">!</span>
<span class="n">Enter</span><span class="w"> </span><span class="n">function</span><span class="w"> </span><span class="n">fd_readdir_00001_sYQM0</span>
<span class="n">fdopendir</span><span class="w"> </span><span class="n">failed</span><span class="p">.</span>
</code></pre></div>
<p>wasmtime fails to read the file items in the directory although both permission 0400 and 0600 has the read permission.</p>
<h3>Versions and Environment</h3>
<p>Wasmtime version or commit: 19.0.2 and 13.0.1<br>
Operating system: Ubuntu 20.04<br>
Architecture: x86_64<br>
</p>
</blockquote>



<a name="468404359"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%238821%20Directory%20read%20bug./near/468404359" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.238821.20Directory.20read.20bug.2E.html#468404359">(Sep 07 2024 at 12:46)</a>:</h4>
<p>tschneidereit <a href="https://github.com/bytecodealliance/wasmtime/issues/8821#issuecomment-2335176695">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/8821">issue #8821</a>:</p>
<blockquote>
<p>Closing this as it's more of a WASI issue than a Wasmtime one—at least for now, as Wasmtime's behavior would have to change in case the spec is clarified in a way that makes the current behavior invalid. @Userzxcvbvnm if you ended up filing that issue, would you mind linking it here?</p>
</blockquote>



<hr><p>Last updated: Jan 20 2025 at 06:04 UTC</p>
</html>