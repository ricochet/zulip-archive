<html>
<head><meta charset="utf-8"><title>wasmtime / PR #7922 Remove the use of the union-find stru... · git-wasmtime · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/index.html">git-wasmtime</a></h2>
<h3>Topic: <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.237922.20Remove.20the.20use.20of.20the.20union-find.20stru.2E.2E.2E.html">wasmtime / PR #7922 Remove the use of the union-find stru...</a></h3>

<hr>

<base href="https://bytecodealliance.zulipchat.com">

<head><link href="https://bytecodealliance.github.io/zulip-archive/style.css" rel="stylesheet"></head>

<a name="421147388"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%237922%20Remove%20the%20use%20of%20the%20union-find%20stru.../near/421147388" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.237922.20Remove.20the.20use.20of.20the.20union-find.20stru.2E.2E.2E.html#421147388">(Feb 12 2024 at 23:12)</a>:</h4>
<p>elliottt opened <a href="https://github.com/bytecodealliance/wasmtime/pull/7922">PR #7922</a> from <code>elliottt:trevor/remove-union-find-from-elaborator</code> to <code>bytecodealliance:main</code>:</p>
<blockquote>
<p>Remove the UnionFind argument to <code>Elaborator::new</code>, and from the <code>Elaborator</code> structure, relying instead on the <code>value_to_best_value</code> table when computing canonical values.</p>
<p>Co-authored-by: Jamey Sharp &lt;<a href="mailto:jsharp@fastly.com">jsharp@fastly.com</a>&gt;<br>
Co-authored-by: L. Pereira &lt;<a href="mailto:lpereira@fastly.com">lpereira@fastly.com</a>&gt;</p>
<p>&lt;!--<br>
Please make sure you include the following information:</p>
<ul>
<li>
<p>If this work has been discussed elsewhere, please include a link to that<br>
  conversation. If it was discussed in an issue, just mention "issue #...".</p>
</li>
<li>
<p>Explain why this change is needed. If the details are in an issue already,<br>
  this can be brief.</p>
</li>
</ul>
<p>Our development process is documented in the Wasmtime book:<br>
<a href="https://docs.wasmtime.dev/contributing-development-process.html">https://docs.wasmtime.dev/contributing-development-process.html</a></p>
<p>Please ensure all communication follows the code of conduct:<br>
<a href="https://github.com/bytecodealliance/wasmtime/blob/main/CODE_OF_CONDUCT.md">https://github.com/bytecodealliance/wasmtime/blob/main/CODE_OF_CONDUCT.md</a><br>
--&gt;</p>
</blockquote>



<a name="421151163"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%237922%20Remove%20the%20use%20of%20the%20union-find%20stru.../near/421151163" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.237922.20Remove.20the.20use.20of.20the.20union-find.20stru.2E.2E.2E.html#421151163">(Feb 12 2024 at 23:46)</a>:</h4>
<p>elliottt edited <a href="https://github.com/bytecodealliance/wasmtime/pull/7922">PR #7922</a>:</p>
<blockquote>
<p>Remove the UnionFind argument to <code>Elaborator::new</code>, and from the <code>Elaborator</code> structure, relying instead on the <code>value_to_best_value</code> table when computing canonical values. Running sightglass on the spideromonkey benchmark showed no difference in performance between main and this branch (compile time or run time).</p>
<p>&lt;!--<br>
Please make sure you include the following information:</p>
<ul>
<li>
<p>If this work has been discussed elsewhere, please include a link to that<br>
  conversation. If it was discussed in an issue, just mention "issue #...".</p>
</li>
<li>
<p>Explain why this change is needed. If the details are in an issue already,<br>
  this can be brief.</p>
</li>
</ul>
<p>Our development process is documented in the Wasmtime book:<br>
<a href="https://docs.wasmtime.dev/contributing-development-process.html">https://docs.wasmtime.dev/contributing-development-process.html</a></p>
<p>Please ensure all communication follows the code of conduct:<br>
<a href="https://github.com/bytecodealliance/wasmtime/blob/main/CODE_OF_CONDUCT.md">https://github.com/bytecodealliance/wasmtime/blob/main/CODE_OF_CONDUCT.md</a><br>
--&gt;</p>
</blockquote>



<a name="421151197"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%237922%20Remove%20the%20use%20of%20the%20union-find%20stru.../near/421151197" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.237922.20Remove.20the.20use.20of.20the.20union-find.20stru.2E.2E.2E.html#421151197">(Feb 12 2024 at 23:46)</a>:</h4>
<p>elliottt edited <a href="https://github.com/bytecodealliance/wasmtime/pull/7922">PR #7922</a>:</p>
<blockquote>
<p>Remove the <code>UnionFind</code> argument to <code>Elaborator::new</code>, and from the <code>Elaborator</code> structure, relying instead on the <code>value_to_best_value</code> table when computing canonical values. Running sightglass on the spideromonkey benchmark showed no difference in performance between main and this branch (compile time or run time).</p>
<p>&lt;!--<br>
Please make sure you include the following information:</p>
<ul>
<li>
<p>If this work has been discussed elsewhere, please include a link to that<br>
  conversation. If it was discussed in an issue, just mention "issue #...".</p>
</li>
<li>
<p>Explain why this change is needed. If the details are in an issue already,<br>
  this can be brief.</p>
</li>
</ul>
<p>Our development process is documented in the Wasmtime book:<br>
<a href="https://docs.wasmtime.dev/contributing-development-process.html">https://docs.wasmtime.dev/contributing-development-process.html</a></p>
<p>Please ensure all communication follows the code of conduct:<br>
<a href="https://github.com/bytecodealliance/wasmtime/blob/main/CODE_OF_CONDUCT.md">https://github.com/bytecodealliance/wasmtime/blob/main/CODE_OF_CONDUCT.md</a><br>
--&gt;</p>
</blockquote>



<a name="421151224"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%237922%20Remove%20the%20use%20of%20the%20union-find%20stru.../near/421151224" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.237922.20Remove.20the.20use.20of.20the.20union-find.20stru.2E.2E.2E.html#421151224">(Feb 12 2024 at 23:46)</a>:</h4>
<p><strong>elliottt</strong> has marked <a href="https://github.com/bytecodealliance/wasmtime/pull/7922">PR #7922</a> as ready for review.</p>



<a name="421151225"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%237922%20Remove%20the%20use%20of%20the%20union-find%20stru.../near/421151225" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.237922.20Remove.20the.20use.20of.20the.20union-find.20stru.2E.2E.2E.html#421151225">(Feb 12 2024 at 23:46)</a>:</h4>
<p><strong>elliottt</strong> requested <a href="https://github.com/cfallin">cfallin</a> for a review on <a href="https://github.com/bytecodealliance/wasmtime/pull/7922">PR #7922</a>.</p>



<a name="421151227"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%237922%20Remove%20the%20use%20of%20the%20union-find%20stru.../near/421151227" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.237922.20Remove.20the.20use.20of.20the.20union-find.20stru.2E.2E.2E.html#421151227">(Feb 12 2024 at 23:46)</a>:</h4>
<p><strong>elliottt</strong> requested <a href="https://github.com/orgs/bytecodealliance/teams/wasmtime-compiler-reviewers">wasmtime-compiler-reviewers</a> for a review on <a href="https://github.com/bytecodealliance/wasmtime/pull/7922">PR #7922</a>.</p>



<a name="421151808"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%237922%20Remove%20the%20use%20of%20the%20union-find%20stru.../near/421151808" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.237922.20Remove.20the.20use.20of.20the.20union-find.20stru.2E.2E.2E.html#421151808">(Feb 12 2024 at 23:52)</a>:</h4>
<p>elliottt edited <a href="https://github.com/bytecodealliance/wasmtime/pull/7922">PR #7922</a>:</p>
<blockquote>
<p>Remove the <code>UnionFind</code> argument to <code>Elaborator::new</code>, and from the <code>Elaborator</code> structure, relying instead on the <code>value_to_best_value</code> table when computing canonical values. Running sightglass on the spideromonkey benchmark showed no difference in performance between main and this branch (compile time or run time).</p>
<p>Additionally, we compared the assembly produced with and without this change, and found the difference in generated code to be mostly negligible (<code>lea</code> instead of <code>add</code>, or a move between registers added or removed). The difference in the length of the disassembled output was only +15 lines, which out of <code>2212651</code> is pretty good.</p>
<p>&lt;!--<br>
Please make sure you include the following information:</p>
<ul>
<li>
<p>If this work has been discussed elsewhere, please include a link to that<br>
  conversation. If it was discussed in an issue, just mention "issue #...".</p>
</li>
<li>
<p>Explain why this change is needed. If the details are in an issue already,<br>
  this can be brief.</p>
</li>
</ul>
<p>Our development process is documented in the Wasmtime book:<br>
<a href="https://docs.wasmtime.dev/contributing-development-process.html">https://docs.wasmtime.dev/contributing-development-process.html</a></p>
<p>Please ensure all communication follows the code of conduct:<br>
<a href="https://github.com/bytecodealliance/wasmtime/blob/main/CODE_OF_CONDUCT.md">https://github.com/bytecodealliance/wasmtime/blob/main/CODE_OF_CONDUCT.md</a><br>
--&gt;</p>
</blockquote>



<a name="421153931"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%237922%20Remove%20the%20use%20of%20the%20union-find%20stru.../near/421153931" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.237922.20Remove.20the.20use.20of.20the.20union-find.20stru.2E.2E.2E.html#421153931">(Feb 13 2024 at 00:13)</a>:</h4>
<p>cfallin submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/7922#pullrequestreview-1876599791">PR review</a>:</p>
<blockquote>
<p>Thanks for taking this on!</p>
<p>It's reassuring to see no changes to the compile-tests' outputs. I remembered one bit of the original thinking after our discussion earlier: IIRC, we had wanted to track elaborated values by canonical-value (union-find result) because otherwise, elaborating a use of an "early" node in the class will not necessarily see a later node that was union'd into the class -- it will result in redundant elaboration.</p>
<p>I suspect this mostly doesn't show up in practice because eager rewriting means that all subsequent uses are of the latest (highest-numbered) rewrite, if any rewrites occurred, so the best-value propagation can give the best for the whole class at that node. But it'd be good to verify that is what you all had been thinking as well, and add a comment describing this somewhere. What do you think?</p>
</blockquote>



<a name="421153978"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%237922%20Remove%20the%20use%20of%20the%20union-find%20stru.../near/421153978" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.237922.20Remove.20the.20use.20of.20the.20union-find.20stru.2E.2E.2E.html#421153978">(Feb 13 2024 at 00:13)</a>:</h4>
<p>cfallin submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/7922#pullrequestreview-1876599791">PR review</a>:</p>
<blockquote>
<p>Thanks for taking this on!</p>
<p>It's reassuring to see no changes to the compile-tests' outputs (EDIT: and so little in real code). I remembered one bit of the original thinking after our discussion earlier: IIRC, we had wanted to track elaborated values by canonical-value (union-find result) because otherwise, elaborating a use of an "early" node in the class will not necessarily see a later node that was union'd into the class -- it will result in redundant elaboration.</p>
<p>I suspect this mostly doesn't show up in practice because eager rewriting means that all subsequent uses are of the latest (highest-numbered) rewrite, if any rewrites occurred, so the best-value propagation can give the best for the whole class at that node. But it'd be good to verify that is what you all had been thinking as well, and add a comment describing this somewhere. What do you think?</p>
</blockquote>



<a name="421155780"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%237922%20Remove%20the%20use%20of%20the%20union-find%20stru.../near/421155780" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.237922.20Remove.20the.20use.20of.20the.20union-find.20stru.2E.2E.2E.html#421155780">(Feb 13 2024 at 00:32)</a>:</h4>
<p>elliottt <a href="https://github.com/bytecodealliance/wasmtime/pull/7922#issuecomment-1939872497">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/7922">PR #7922</a>:</p>
<blockquote>
<p>The goal that we had in removing the use of the union find structure was to enforce the assumption that it was valid to refer to an inner node of the union tree as a subset of an eclass. Using the union find results from the rewriting pass over the whole function during elaboration may end up merging results from different branches in the dominator tree into the same eclass, which would mean that we might canonicalize to a node higher in the union tree than we originally intended. If that situation occurred, we would be at the mercy of the cost function for correctness. I think that with the changes you proposed to how we manage access to the gvn map as well, we'll be able to relax the new guideline we introduced for using subsume when the RHS forgets values from the LHS in egraph rules.</p>
<p>As to where we would add a comment, I'm not sure the best place to document this. Do we already document our use of sub-trees of the union tree to name subsets of the eclass? I think that's a super elegant implementation detail that's worth documenting, and we could call out careful management of eclasses in the same place.</p>
</blockquote>



<a name="421157461"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%237922%20Remove%20the%20use%20of%20the%20union-find%20stru.../near/421157461" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.237922.20Remove.20the.20use.20of.20the.20union-find.20stru.2E.2E.2E.html#421157461">(Feb 13 2024 at 00:52)</a>:</h4>
<p>cfallin <a href="https://github.com/bytecodealliance/wasmtime/pull/7922#issuecomment-1939946079">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/7922">PR #7922</a>:</p>
<blockquote>
<p>OK, yeah, this is confirming to me why we didn't see the scoping issue originally: I think I had been imagining the canonical value to be the "first" and hence dominate all others in the eclass, but, indeed, you're correct that out-of-order canonical values can cause references that require the cost function (or the domtree-range scoping described in #7891) to handle. Thanks for "elaborating" on that!</p>
<p>Perhaps we could add to the comment on <code>value_to_elaborated_value</code>?</p>
<p>Incidentally, this gives me another thought: if we could somehow canonicalize toward dominating values (up the domtree), this problem would also go away. I'm not sure how to do that efficiently though, so I think this plus domtree-range scoping (to avoid delicate subsume rules) feels like the right way to make all this fully robust.</p>
</blockquote>



<a name="421307838"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%237922%20Remove%20the%20use%20of%20the%20union-find%20stru.../near/421307838" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.237922.20Remove.20the.20use.20of.20the.20union-find.20stru.2E.2E.2E.html#421307838">(Feb 13 2024 at 19:05)</a>:</h4>
<p>elliottt updated <a href="https://github.com/bytecodealliance/wasmtime/pull/7922">PR #7922</a>.</p>



<a name="421315906"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%237922%20Remove%20the%20use%20of%20the%20union-find%20stru.../near/421315906" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.237922.20Remove.20the.20use.20of.20the.20union-find.20stru.2E.2E.2E.html#421315906">(Feb 13 2024 at 19:59)</a>:</h4>
<p>elliottt merged <a href="https://github.com/bytecodealliance/wasmtime/pull/7922">PR #7922</a>.</p>



<hr><p>Last updated: Jan 20 2025 at 06:04 UTC</p>
</html>