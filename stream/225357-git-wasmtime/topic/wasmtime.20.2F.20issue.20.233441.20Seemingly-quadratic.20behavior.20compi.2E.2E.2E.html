<html>
<head><meta charset="utf-8"><title>wasmtime / issue #3441 Seemingly-quadratic behavior compi... · git-wasmtime · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/index.html">git-wasmtime</a></h2>
<h3>Topic: <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.233441.20Seemingly-quadratic.20behavior.20compi.2E.2E.2E.html">wasmtime / issue #3441 Seemingly-quadratic behavior compi...</a></h3>

<hr>

<base href="https://bytecodealliance.zulipchat.com">

<head><link href="https://bytecodealliance.github.io/zulip-archive/style.css" rel="stylesheet"></head>

<a name="257091056"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%233441%20Seemingly-quadratic%20behavior%20compi.../near/257091056" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.233441.20Seemingly-quadratic.20behavior.20compi.2E.2E.2E.html#257091056">(Oct 11 2021 at 16:59)</a>:</h4>
<p>alexcrichton opened <a href="https://github.com/bytecodealliance/wasmtime/issues/3441">issue #3441</a>:</p>
<blockquote>
<p>A <a href="https://github.com/bytecodealliance/wasmtime/files/7324154/foo.wasm.gz">fuzz-generated test</a> recently found times out during compilation. This single-function module looks like:</p>
<div class="codehilite" data-code-language="wasm"><pre><span></span><code>(module
  (func
    loop end
    loop end
    loop end
    ;; ... ~20k more times
    loop end
    loop end))
</code></pre></div>
<p>Compiling this module yields:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="w"> </span><span class="n">DEBUG</span><span class="w"> </span><span class="n">wasmtime_cranelift</span>::<span class="n">compiler</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="n">FuncIndex</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="n">translated</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="mf">1.248188995</span><span class="n">s</span><span class="w"></span>
<span class="w"> </span><span class="n">TRACE</span><span class="w"> </span><span class="n">wasmtime_cranelift</span>::<span class="n">compiler</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="n">FuncIndex</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="n">timing</span><span class="w"> </span><span class="n">info</span><span class="w"></span>
<span class="o">========</span><span class="w"> </span><span class="o">========</span><span class="w">  </span><span class="o">==================================</span><span class="w"></span>
<span class="w">   </span><span class="n">Total</span><span class="w">     </span><span class="bp">Self</span><span class="w">  </span><span class="n">Pass</span><span class="w"></span>
<span class="o">--------</span><span class="w"> </span><span class="o">--------</span><span class="w">  </span><span class="o">----------------------------------</span><span class="w"></span>
<span class="w">   </span><span class="mf">0.006</span><span class="w">    </span><span class="mf">0.006</span><span class="w">  </span><span class="n">Translate</span><span class="w"> </span><span class="n">WASM</span><span class="w"> </span><span class="n">function</span><span class="w"></span>
<span class="w">   </span><span class="mf">0.624</span><span class="w">    </span><span class="mf">0.007</span><span class="w">  </span><span class="n">Compilation</span><span class="w"> </span><span class="n">passes</span><span class="w"></span>
<span class="w">   </span><span class="mf">0.003</span><span class="w">    </span><span class="mf">0.003</span><span class="w">  </span><span class="n">Control</span><span class="w"> </span><span class="n">flow</span><span class="w"> </span><span class="n">graph</span><span class="w"></span>
<span class="w">   </span><span class="mf">0.003</span><span class="w">    </span><span class="mf">0.003</span><span class="w">  </span><span class="n">Dominator</span><span class="w"> </span><span class="n">tree</span><span class="w"></span>
<span class="w">   </span><span class="mf">0.000</span><span class="w">    </span><span class="mf">0.000</span><span class="w">  </span><span class="n">Loop</span><span class="w"> </span><span class="n">analysis</span><span class="w"></span>
<span class="w">   </span><span class="mf">0.000</span><span class="w">    </span><span class="mf">0.000</span><span class="w">  </span><span class="n">Pre</span><span class="o">-</span><span class="n">legalization</span><span class="w"> </span><span class="n">rewriting</span><span class="w"></span>
<span class="w">   </span><span class="mf">0.000</span><span class="w">    </span><span class="mf">0.000</span><span class="w">  </span><span class="n">Dead</span><span class="w"> </span><span class="n">code</span><span class="w"> </span><span class="n">elimination</span><span class="w"></span>
<span class="w">   </span><span class="mf">0.001</span><span class="w">    </span><span class="mf">0.001</span><span class="w">  </span><span class="n">Global</span><span class="w"> </span><span class="n">value</span><span class="w"> </span><span class="n">numbering</span><span class="w"></span>
<span class="w">   </span><span class="mf">0.002</span><span class="w">    </span><span class="mf">0.000</span><span class="w">  </span><span class="n">Loop</span><span class="w"> </span><span class="n">invariant</span><span class="w"> </span><span class="n">code</span><span class="w"> </span><span class="n">motion</span><span class="w"></span>
<span class="w">   </span><span class="mf">0.000</span><span class="w">    </span><span class="mf">0.000</span><span class="w">  </span><span class="n">Remove</span><span class="w"> </span><span class="n">unreachable</span><span class="w"> </span><span class="n">blocks</span><span class="w"></span>
<span class="w">   </span><span class="mf">0.001</span><span class="w">    </span><span class="mf">0.001</span><span class="w">  </span><span class="n">Remove</span><span class="w"> </span><span class="n">constant</span><span class="w"> </span><span class="n">phi</span><span class="o">-</span><span class="n">nodes</span><span class="w"></span>
<span class="w">   </span><span class="mf">0.005</span><span class="w">    </span><span class="mf">0.005</span><span class="w">  </span><span class="n">VCode</span><span class="w"> </span><span class="n">lowering</span><span class="w"></span>
<span class="w">   </span><span class="mf">0.000</span><span class="w">    </span><span class="mf">0.000</span><span class="w">  </span><span class="n">VCode</span><span class="w"> </span><span class="n">post</span><span class="o">-</span><span class="n">register</span><span class="w"> </span><span class="n">allocation</span><span class="w"> </span><span class="n">finalization</span><span class="w"></span>
<span class="w">   </span><span class="mf">0.270</span><span class="w">    </span><span class="mf">0.270</span><span class="w">  </span><span class="n">VCode</span><span class="w"> </span><span class="n">emission</span><span class="w"></span>
<span class="w">   </span><span class="mf">0.000</span><span class="w">    </span><span class="mf">0.000</span><span class="w">  </span><span class="n">VCode</span><span class="w"> </span><span class="n">emission</span><span class="w"> </span><span class="n">finalization</span><span class="w"></span>
<span class="w">   </span><span class="mf">0.333</span><span class="w">    </span><span class="mf">0.333</span><span class="w">  </span><span class="n">Register</span><span class="w"> </span><span class="n">allocation</span><span class="w"></span>
<span class="w">   </span><span class="mf">0.000</span><span class="w">    </span><span class="mf">0.000</span><span class="w">  </span><span class="n">Binary</span><span class="w"> </span><span class="n">machine</span><span class="w"> </span><span class="n">code</span><span class="w"> </span><span class="n">emission</span><span class="w"></span>
<span class="o">========</span><span class="w"> </span><span class="o">========</span><span class="w">  </span><span class="o">==================================</span><span class="w"></span>
</code></pre></div>
<p>Something here seems accidentally quadratic perhaps? Whatever the reason this function probably shouldn't take upwards of a second to compile.</p>
</blockquote>



<a name="258264738"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%233441%20Seemingly-quadratic%20behavior%20compi.../near/258264738" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.233441.20Seemingly-quadratic.20behavior.20compi.2E.2E.2E.html#258264738">(Oct 19 2021 at 20:17)</a>:</h4>
<p>adamrk <a href="https://github.com/bytecodealliance/wasmtime/issues/3441#issuecomment-947072360">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/3441">issue #3441</a>:</p>
<blockquote>
<p>Took a look at this and it seems like there is quadratic behavior coming from <code>regalloc</code> <a href="https://github.com/bytecodealliance/regalloc.rs/blob/5d2c7393d7313a162f334da9ebdad9f0484862f2/lib/src/analysis_control_flow.rs#L520">here</a>. When calculating the loop depth it's iterating over each block and then traversing the entire dominance tree each time. Opened this <a href="https://github.com/bytecodealliance/regalloc.rs/pull/128">PR</a> which I think fixes that issue.</p>
<p>Here are the results I see from that.<br>
Baseline:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="w"> </span><span class="n">DEBUG</span><span class="w"> </span><span class="n">wasmtime_cranelift</span>::<span class="n">compiler</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="n">FuncIndex</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="n">translated</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="mf">1.950180269</span><span class="n">s</span><span class="w"></span>
<span class="w"> </span><span class="n">TRACE</span><span class="w"> </span><span class="n">wasmtime_cranelift</span>::<span class="n">compiler</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="n">FuncIndex</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="n">timing</span><span class="w"> </span><span class="n">info</span><span class="w"></span>
<span class="o">========</span><span class="w"> </span><span class="o">========</span><span class="w">  </span><span class="o">==================================</span><span class="w"></span>
<span class="w">   </span><span class="n">Total</span><span class="w">     </span><span class="bp">Self</span><span class="w">  </span><span class="n">Pass</span><span class="w"></span>
<span class="o">--------</span><span class="w"> </span><span class="o">--------</span><span class="w">  </span><span class="o">----------------------------------</span><span class="w"></span>
<span class="w">   </span><span class="mf">0.014</span><span class="w">    </span><span class="mf">0.014</span><span class="w">  </span><span class="n">Translate</span><span class="w"> </span><span class="n">WASM</span><span class="w"> </span><span class="n">function</span><span class="w"></span>
<span class="w">   </span><span class="mf">1.936</span><span class="w">    </span><span class="mf">0.017</span><span class="w">  </span><span class="n">Compilation</span><span class="w"> </span><span class="n">passes</span><span class="w"></span>
<span class="w">   </span><span class="mf">0.008</span><span class="w">    </span><span class="mf">0.008</span><span class="w">  </span><span class="n">Control</span><span class="w"> </span><span class="n">flow</span><span class="w"> </span><span class="n">graph</span><span class="w"></span>
<span class="w">   </span><span class="mf">0.007</span><span class="w">    </span><span class="mf">0.007</span><span class="w">  </span><span class="n">Dominator</span><span class="w"> </span><span class="n">tree</span><span class="w"></span>
<span class="w">   </span><span class="mf">0.001</span><span class="w">    </span><span class="mf">0.001</span><span class="w">  </span><span class="n">Loop</span><span class="w"> </span><span class="n">analysis</span><span class="w"></span>
<span class="w">   </span><span class="mf">0.001</span><span class="w">    </span><span class="mf">0.001</span><span class="w">  </span><span class="n">Pre</span><span class="o">-</span><span class="n">legalization</span><span class="w"> </span><span class="n">rewriting</span><span class="w"></span>
<span class="w">   </span><span class="mf">0.000</span><span class="w">    </span><span class="mf">0.000</span><span class="w">  </span><span class="n">Dead</span><span class="w"> </span><span class="n">code</span><span class="w"> </span><span class="n">elimination</span><span class="w"></span>
<span class="w">   </span><span class="mf">0.001</span><span class="w">    </span><span class="mf">0.001</span><span class="w">  </span><span class="n">Global</span><span class="w"> </span><span class="n">value</span><span class="w"> </span><span class="n">numbering</span><span class="w"></span>
<span class="w">   </span><span class="mf">0.004</span><span class="w">    </span><span class="mf">0.000</span><span class="w">  </span><span class="n">Loop</span><span class="w"> </span><span class="n">invariant</span><span class="w"> </span><span class="n">code</span><span class="w"> </span><span class="n">motion</span><span class="w"></span>
<span class="w">   </span><span class="mf">0.000</span><span class="w">    </span><span class="mf">0.000</span><span class="w">  </span><span class="n">Remove</span><span class="w"> </span><span class="n">unreachable</span><span class="w"> </span><span class="n">blocks</span><span class="w"></span>
<span class="w">   </span><span class="mf">0.001</span><span class="w">    </span><span class="mf">0.001</span><span class="w">  </span><span class="n">Remove</span><span class="w"> </span><span class="n">constant</span><span class="w"> </span><span class="n">phi</span><span class="o">-</span><span class="n">nodes</span><span class="w"></span>
<span class="w">   </span><span class="mf">0.014</span><span class="w">    </span><span class="mf">0.014</span><span class="w">  </span><span class="n">VCode</span><span class="w"> </span><span class="n">lowering</span><span class="w"></span>
<span class="w">   </span><span class="mf">0.002</span><span class="w">    </span><span class="mf">0.002</span><span class="w">  </span><span class="n">VCode</span><span class="w"> </span><span class="n">post</span><span class="o">-</span><span class="n">register</span><span class="w"> </span><span class="n">allocation</span><span class="w"> </span><span class="n">finalization</span><span class="w"></span>
<span class="w">   </span><span class="mf">0.621</span><span class="w">    </span><span class="mf">0.621</span><span class="w">  </span><span class="n">VCode</span><span class="w"> </span><span class="n">emission</span><span class="w"></span>
<span class="w">   </span><span class="mf">0.000</span><span class="w">    </span><span class="mf">0.000</span><span class="w">  </span><span class="n">VCode</span><span class="w"> </span><span class="n">emission</span><span class="w"> </span><span class="n">finalization</span><span class="w"></span>
<span class="w">   </span><span class="mf">1.264</span><span class="w">    </span><span class="mf">1.264</span><span class="w">  </span><span class="n">Register</span><span class="w"> </span><span class="n">allocation</span><span class="w"></span>
<span class="w">   </span><span class="mf">0.000</span><span class="w">    </span><span class="mf">0.000</span><span class="w">  </span><span class="n">Binary</span><span class="w"> </span><span class="n">machine</span><span class="w"> </span><span class="n">code</span><span class="w"> </span><span class="n">emission</span><span class="w"></span>
<span class="o">========</span><span class="w"> </span><span class="o">========</span><span class="w">  </span><span class="o">==================================</span><span class="w"></span>
</code></pre></div>
<p>With the change:</p>
<p><div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="w"> </span><span class="n">DEBUG</span><span class="w"> </span><span class="n">wasmtime_cranelift</span>::<span class="n">compiler</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="n">FuncIndex</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="n">translated</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="mf">632.089765</span><span class="n">ms</span><span class="w"></span>
<span class="w"> </span><span class="n">TRACE</span><span class="w"> </span><span class="n">wasmtime_cranelift</span>::<span class="n">compiler</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="n">FuncIndex</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="n">timing</span><span class="w"> </span><span class="n">info</span><span class="w"></span>
<span class="o">========</span><span class="w"> </span><span class="o">========</span><span class="w">  </span><span class="o">==================================</span><span class="w"></span>
<span class="w">   </span><span class="n">Total</span><span class="w">     </span><span class="bp">Self</span><span class="w">  </span><span class="n">Pass</span><span class="w"></span>
<span class="o">--------</span><span class="w"> </span><span class="o">--------</span><span class="w">  </span><span class="o">----------------------------------</span><span class="w"></span>
<span class="w">   </span><span class="mf">0.013</span><span class="w">    </span><span class="mf">0.013</span><span class="w">  </span><span class="n">Translate</span><span class="w"> </span><span class="n">WASM</span><span class="w"> </span><span class="n">function</span><span class="w"></span>
<span class="w">   </span><span class="mf">0.619</span><span class="w">    </span><span class="mf">0.015</span><span class="w">  </span><span class="n">Compilation</span><span class="w"> </span><span class="n">passes</span><span class="w"></span>
<span class="w">   </span><span class="mf">0.007</span><span class="w">    </span><span class="mf">0.007</span><span class="w">  </span><span class="n">Control</span><span class="w"> </span><span class="n">flow</span><span class="w"> </span><span class="n">graph</span><span class="w"></span>
<span class="w">   </span><span class="mf">0.008</span><span class="w">    </span><span class="mf">0.008</span><span class="w">  </span><span class="n">Dominator</span><span class="w"> </span><span class="n">tree</span><span class="w"></span>
<span class="w">   </span><span class="mf">0.001</span><span class="w">    </span><span class="mf">0.001</span><span class="w">  </span><span class="n">Loop</span><span class="w"> </span><span class="n">analysis</span><span class="w"></span>
<span class="w">   </span><span class="mf">0.001</span><span class="w">    </span><span class="mf">0.001</span><span class="w">  </span><span class="n">Pre</span><span class="o">-</span><span class="n">legalization</span><span class="w"> </span><span class="n">rewriting</span><span class="w"></span>
<span class="w">   </span><span class="mf">0.000</span><span class="w">    </span><span class="mf">0.000</span><span class="w">  </span><span class="n">Dead</span><span class="w"> </span><span class="n">code</span><span class="w"> </span><span class="n">elimination</span><span class="w"></span>
<span class="w">   </span><span class="mf">0.001</span><span class="w">    </span><span class="mf">0.001</span><span class="w">  </span><span class="n">Global</span><span class="w"> </span><span class="n">value</span><span class="w"> </span><span class="n">numbering</span><span class="w"></span>
<span class="w">   </span><span class="mf">0.005</span><span class="w">    </span><span class="mf">0.000</span><span class="w">  </span><span class="n">Loop</span><span class="w"> </span><span class="n">invariant</span><span class="w"> </span><span class="n">code</span><span class="w"> </span><span class="n">motion</span><span class="w"></span>
<span class="w">   </span><span class="mf">0.000</span><span class="w">    </span><span class="mf">0.000</span><span class="w">  </span><span class="n">Remove</span><span class="w"> </span><span class="n">unreachable</span><span class="w"> </span><span class="n">blocks</span><span class="w"></span>
<span class="w">   </span><span class="mf">0.001</span><span class="w">    </span><span class="mf">0.001</span><span class="w">  </span><span class="n">Remove</span><span class="w"> </span><span class="n">constant</span><span class="w"> </span><span class="n">phi</span><span class="o">-</span><span class="n">nodes</span><span class="w"></span>
<span class="w">   </span><span class="mf">0.011</span><span class="w">    </span><span class="mf">0.011</span><span class="w">  </span><span class="n">VCode</span><span class="w"> </span><span class="n">lowering</span><span class="w"></span>
<span class="w">   </span><span class="mf">0.002</span><span class="w">    </span><span class="mf">0.002</span><span class="w">  </span><span class="n">VCode</span><span class="w"> </span><span class="n">post</span><span class="o">-</span><span class="n">register</span><span class="w"> </span><span class="n">allocation</span><span class="w"> </span><span class="n">finalization</span><span class="w"></span>
<span class="w">   </span><span class="mf">0.554</span><span class="w">    </span><span class="mf">0.554</span><span class="w">  </span><span class="n">VCode</span><span class="w"> </span><span class="n">emission</span><span class="w"></span>
<span class="w">   </span><span class="mf">0.000</span><span class="w">    </span><span class="mf">0.000</span><span class="w">  </span><span class="n">VCode</span><span class="w"> </span><span class="n">emission</span><span class="w"> </span><span class="n">finalization</span><span class="w"></span>
<span class="w">   </span><span class="mf">0.018</span><span class="w">    </span><span class="mf">0.018</span><span class="w">  </span><span class="n">Register</span><span class="w"> </span><span class="n">allocation</span><span class="w"></span>
<span class="w">   </span><span class="mf">0.000</span><span class="w">    </span><span class="mf">0.000</span><span class="w">  </span><span class="n">Binary</span><span class="w"> </span><span class="n">machine</span><span class="w"> </span><span class="n">code</span><span class="w"> </span><span class="n">emission</span><span class="w"></span>
<span class="o">========</span><span class="w"> </span><span class="o">========</span><span class="w">  </span><span class="o">==================================</span><span class="w"></span>
</code></pre></div><br>
</p>
</blockquote>



<a name="258450724"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%233441%20Seemingly-quadratic%20behavior%20compi.../near/258450724" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.233441.20Seemingly-quadratic.20behavior.20compi.2E.2E.2E.html#258450724">(Oct 20 2021 at 21:56)</a>:</h4>
<p>cfallin closed <a href="https://github.com/bytecodealliance/wasmtime/issues/3441">issue #3441</a>:</p>
<blockquote>
<p>A <a href="https://github.com/bytecodealliance/wasmtime/files/7324154/foo.wasm.gz">fuzz-generated test</a> recently found times out during compilation. This single-function module looks like:</p>
<div class="codehilite" data-code-language="wasm"><pre><span></span><code>(module
  (func
    loop end
    loop end
    loop end
    ;; ... ~20k more times
    loop end
    loop end))
</code></pre></div>
<p>Compiling this module yields:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="w"> </span><span class="n">DEBUG</span><span class="w"> </span><span class="n">wasmtime_cranelift</span>::<span class="n">compiler</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="n">FuncIndex</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="n">translated</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="mf">1.248188995</span><span class="n">s</span><span class="w"></span>
<span class="w"> </span><span class="n">TRACE</span><span class="w"> </span><span class="n">wasmtime_cranelift</span>::<span class="n">compiler</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="n">FuncIndex</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="n">timing</span><span class="w"> </span><span class="n">info</span><span class="w"></span>
<span class="o">========</span><span class="w"> </span><span class="o">========</span><span class="w">  </span><span class="o">==================================</span><span class="w"></span>
<span class="w">   </span><span class="n">Total</span><span class="w">     </span><span class="bp">Self</span><span class="w">  </span><span class="n">Pass</span><span class="w"></span>
<span class="o">--------</span><span class="w"> </span><span class="o">--------</span><span class="w">  </span><span class="o">----------------------------------</span><span class="w"></span>
<span class="w">   </span><span class="mf">0.006</span><span class="w">    </span><span class="mf">0.006</span><span class="w">  </span><span class="n">Translate</span><span class="w"> </span><span class="n">WASM</span><span class="w"> </span><span class="n">function</span><span class="w"></span>
<span class="w">   </span><span class="mf">0.624</span><span class="w">    </span><span class="mf">0.007</span><span class="w">  </span><span class="n">Compilation</span><span class="w"> </span><span class="n">passes</span><span class="w"></span>
<span class="w">   </span><span class="mf">0.003</span><span class="w">    </span><span class="mf">0.003</span><span class="w">  </span><span class="n">Control</span><span class="w"> </span><span class="n">flow</span><span class="w"> </span><span class="n">graph</span><span class="w"></span>
<span class="w">   </span><span class="mf">0.003</span><span class="w">    </span><span class="mf">0.003</span><span class="w">  </span><span class="n">Dominator</span><span class="w"> </span><span class="n">tree</span><span class="w"></span>
<span class="w">   </span><span class="mf">0.000</span><span class="w">    </span><span class="mf">0.000</span><span class="w">  </span><span class="n">Loop</span><span class="w"> </span><span class="n">analysis</span><span class="w"></span>
<span class="w">   </span><span class="mf">0.000</span><span class="w">    </span><span class="mf">0.000</span><span class="w">  </span><span class="n">Pre</span><span class="o">-</span><span class="n">legalization</span><span class="w"> </span><span class="n">rewriting</span><span class="w"></span>
<span class="w">   </span><span class="mf">0.000</span><span class="w">    </span><span class="mf">0.000</span><span class="w">  </span><span class="n">Dead</span><span class="w"> </span><span class="n">code</span><span class="w"> </span><span class="n">elimination</span><span class="w"></span>
<span class="w">   </span><span class="mf">0.001</span><span class="w">    </span><span class="mf">0.001</span><span class="w">  </span><span class="n">Global</span><span class="w"> </span><span class="n">value</span><span class="w"> </span><span class="n">numbering</span><span class="w"></span>
<span class="w">   </span><span class="mf">0.002</span><span class="w">    </span><span class="mf">0.000</span><span class="w">  </span><span class="n">Loop</span><span class="w"> </span><span class="n">invariant</span><span class="w"> </span><span class="n">code</span><span class="w"> </span><span class="n">motion</span><span class="w"></span>
<span class="w">   </span><span class="mf">0.000</span><span class="w">    </span><span class="mf">0.000</span><span class="w">  </span><span class="n">Remove</span><span class="w"> </span><span class="n">unreachable</span><span class="w"> </span><span class="n">blocks</span><span class="w"></span>
<span class="w">   </span><span class="mf">0.001</span><span class="w">    </span><span class="mf">0.001</span><span class="w">  </span><span class="n">Remove</span><span class="w"> </span><span class="n">constant</span><span class="w"> </span><span class="n">phi</span><span class="o">-</span><span class="n">nodes</span><span class="w"></span>
<span class="w">   </span><span class="mf">0.005</span><span class="w">    </span><span class="mf">0.005</span><span class="w">  </span><span class="n">VCode</span><span class="w"> </span><span class="n">lowering</span><span class="w"></span>
<span class="w">   </span><span class="mf">0.000</span><span class="w">    </span><span class="mf">0.000</span><span class="w">  </span><span class="n">VCode</span><span class="w"> </span><span class="n">post</span><span class="o">-</span><span class="n">register</span><span class="w"> </span><span class="n">allocation</span><span class="w"> </span><span class="n">finalization</span><span class="w"></span>
<span class="w">   </span><span class="mf">0.270</span><span class="w">    </span><span class="mf">0.270</span><span class="w">  </span><span class="n">VCode</span><span class="w"> </span><span class="n">emission</span><span class="w"></span>
<span class="w">   </span><span class="mf">0.000</span><span class="w">    </span><span class="mf">0.000</span><span class="w">  </span><span class="n">VCode</span><span class="w"> </span><span class="n">emission</span><span class="w"> </span><span class="n">finalization</span><span class="w"></span>
<span class="w">   </span><span class="mf">0.333</span><span class="w">    </span><span class="mf">0.333</span><span class="w">  </span><span class="n">Register</span><span class="w"> </span><span class="n">allocation</span><span class="w"></span>
<span class="w">   </span><span class="mf">0.000</span><span class="w">    </span><span class="mf">0.000</span><span class="w">  </span><span class="n">Binary</span><span class="w"> </span><span class="n">machine</span><span class="w"> </span><span class="n">code</span><span class="w"> </span><span class="n">emission</span><span class="w"></span>
<span class="o">========</span><span class="w"> </span><span class="o">========</span><span class="w">  </span><span class="o">==================================</span><span class="w"></span>
</code></pre></div>
<p>Something here seems accidentally quadratic perhaps? Whatever the reason this function probably shouldn't take upwards of a second to compile.</p>
</blockquote>



<a name="258450839"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%233441%20Seemingly-quadratic%20behavior%20compi.../near/258450839" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.233441.20Seemingly-quadratic.20behavior.20compi.2E.2E.2E.html#258450839">(Oct 20 2021 at 21:57)</a>:</h4>
<p>cfallin <a href="https://github.com/bytecodealliance/wasmtime/issues/3441#issuecomment-948068574">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/3441">issue #3441</a>:</p>
<blockquote>
<p>Ah, GitHub interpreted my "fixes ..." over on the <a href="http://regalloc.rs">regalloc.rs</a> side over-optimistically; this isn't actually fixed in Cranelift until we update to <a href="http://regalloc.rs">regalloc.rs</a> 0.0.32, so I'll reopen this.</p>
</blockquote>



<a name="258450840"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%233441%20Seemingly-quadratic%20behavior%20compi.../near/258450840" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.233441.20Seemingly-quadratic.20behavior.20compi.2E.2E.2E.html#258450840">(Oct 20 2021 at 21:57)</a>:</h4>
<p>cfallin reopened <a href="https://github.com/bytecodealliance/wasmtime/issues/3441">issue #3441</a>:</p>
<blockquote>
<p>A <a href="https://github.com/bytecodealliance/wasmtime/files/7324154/foo.wasm.gz">fuzz-generated test</a> recently found times out during compilation. This single-function module looks like:</p>
<div class="codehilite" data-code-language="wasm"><pre><span></span><code>(module
  (func
    loop end
    loop end
    loop end
    ;; ... ~20k more times
    loop end
    loop end))
</code></pre></div>
<p>Compiling this module yields:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="w"> </span><span class="n">DEBUG</span><span class="w"> </span><span class="n">wasmtime_cranelift</span>::<span class="n">compiler</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="n">FuncIndex</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="n">translated</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="mf">1.248188995</span><span class="n">s</span><span class="w"></span>
<span class="w"> </span><span class="n">TRACE</span><span class="w"> </span><span class="n">wasmtime_cranelift</span>::<span class="n">compiler</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="n">FuncIndex</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="n">timing</span><span class="w"> </span><span class="n">info</span><span class="w"></span>
<span class="o">========</span><span class="w"> </span><span class="o">========</span><span class="w">  </span><span class="o">==================================</span><span class="w"></span>
<span class="w">   </span><span class="n">Total</span><span class="w">     </span><span class="bp">Self</span><span class="w">  </span><span class="n">Pass</span><span class="w"></span>
<span class="o">--------</span><span class="w"> </span><span class="o">--------</span><span class="w">  </span><span class="o">----------------------------------</span><span class="w"></span>
<span class="w">   </span><span class="mf">0.006</span><span class="w">    </span><span class="mf">0.006</span><span class="w">  </span><span class="n">Translate</span><span class="w"> </span><span class="n">WASM</span><span class="w"> </span><span class="n">function</span><span class="w"></span>
<span class="w">   </span><span class="mf">0.624</span><span class="w">    </span><span class="mf">0.007</span><span class="w">  </span><span class="n">Compilation</span><span class="w"> </span><span class="n">passes</span><span class="w"></span>
<span class="w">   </span><span class="mf">0.003</span><span class="w">    </span><span class="mf">0.003</span><span class="w">  </span><span class="n">Control</span><span class="w"> </span><span class="n">flow</span><span class="w"> </span><span class="n">graph</span><span class="w"></span>
<span class="w">   </span><span class="mf">0.003</span><span class="w">    </span><span class="mf">0.003</span><span class="w">  </span><span class="n">Dominator</span><span class="w"> </span><span class="n">tree</span><span class="w"></span>
<span class="w">   </span><span class="mf">0.000</span><span class="w">    </span><span class="mf">0.000</span><span class="w">  </span><span class="n">Loop</span><span class="w"> </span><span class="n">analysis</span><span class="w"></span>
<span class="w">   </span><span class="mf">0.000</span><span class="w">    </span><span class="mf">0.000</span><span class="w">  </span><span class="n">Pre</span><span class="o">-</span><span class="n">legalization</span><span class="w"> </span><span class="n">rewriting</span><span class="w"></span>
<span class="w">   </span><span class="mf">0.000</span><span class="w">    </span><span class="mf">0.000</span><span class="w">  </span><span class="n">Dead</span><span class="w"> </span><span class="n">code</span><span class="w"> </span><span class="n">elimination</span><span class="w"></span>
<span class="w">   </span><span class="mf">0.001</span><span class="w">    </span><span class="mf">0.001</span><span class="w">  </span><span class="n">Global</span><span class="w"> </span><span class="n">value</span><span class="w"> </span><span class="n">numbering</span><span class="w"></span>
<span class="w">   </span><span class="mf">0.002</span><span class="w">    </span><span class="mf">0.000</span><span class="w">  </span><span class="n">Loop</span><span class="w"> </span><span class="n">invariant</span><span class="w"> </span><span class="n">code</span><span class="w"> </span><span class="n">motion</span><span class="w"></span>
<span class="w">   </span><span class="mf">0.000</span><span class="w">    </span><span class="mf">0.000</span><span class="w">  </span><span class="n">Remove</span><span class="w"> </span><span class="n">unreachable</span><span class="w"> </span><span class="n">blocks</span><span class="w"></span>
<span class="w">   </span><span class="mf">0.001</span><span class="w">    </span><span class="mf">0.001</span><span class="w">  </span><span class="n">Remove</span><span class="w"> </span><span class="n">constant</span><span class="w"> </span><span class="n">phi</span><span class="o">-</span><span class="n">nodes</span><span class="w"></span>
<span class="w">   </span><span class="mf">0.005</span><span class="w">    </span><span class="mf">0.005</span><span class="w">  </span><span class="n">VCode</span><span class="w"> </span><span class="n">lowering</span><span class="w"></span>
<span class="w">   </span><span class="mf">0.000</span><span class="w">    </span><span class="mf">0.000</span><span class="w">  </span><span class="n">VCode</span><span class="w"> </span><span class="n">post</span><span class="o">-</span><span class="n">register</span><span class="w"> </span><span class="n">allocation</span><span class="w"> </span><span class="n">finalization</span><span class="w"></span>
<span class="w">   </span><span class="mf">0.270</span><span class="w">    </span><span class="mf">0.270</span><span class="w">  </span><span class="n">VCode</span><span class="w"> </span><span class="n">emission</span><span class="w"></span>
<span class="w">   </span><span class="mf">0.000</span><span class="w">    </span><span class="mf">0.000</span><span class="w">  </span><span class="n">VCode</span><span class="w"> </span><span class="n">emission</span><span class="w"> </span><span class="n">finalization</span><span class="w"></span>
<span class="w">   </span><span class="mf">0.333</span><span class="w">    </span><span class="mf">0.333</span><span class="w">  </span><span class="n">Register</span><span class="w"> </span><span class="n">allocation</span><span class="w"></span>
<span class="w">   </span><span class="mf">0.000</span><span class="w">    </span><span class="mf">0.000</span><span class="w">  </span><span class="n">Binary</span><span class="w"> </span><span class="n">machine</span><span class="w"> </span><span class="n">code</span><span class="w"> </span><span class="n">emission</span><span class="w"></span>
<span class="o">========</span><span class="w"> </span><span class="o">========</span><span class="w">  </span><span class="o">==================================</span><span class="w"></span>
</code></pre></div>
<p>Something here seems accidentally quadratic perhaps? Whatever the reason this function probably shouldn't take upwards of a second to compile.</p>
</blockquote>



<a name="258458524"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%233441%20Seemingly-quadratic%20behavior%20compi.../near/258458524" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.233441.20Seemingly-quadratic.20behavior.20compi.2E.2E.2E.html#258458524">(Oct 20 2021 at 23:07)</a>:</h4>
<p>cfallin closed <a href="https://github.com/bytecodealliance/wasmtime/issues/3441">issue #3441</a>:</p>
<blockquote>
<p>A <a href="https://github.com/bytecodealliance/wasmtime/files/7324154/foo.wasm.gz">fuzz-generated test</a> recently found times out during compilation. This single-function module looks like:</p>
<div class="codehilite" data-code-language="wasm"><pre><span></span><code>(module
  (func
    loop end
    loop end
    loop end
    ;; ... ~20k more times
    loop end
    loop end))
</code></pre></div>
<p>Compiling this module yields:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="w"> </span><span class="n">DEBUG</span><span class="w"> </span><span class="n">wasmtime_cranelift</span>::<span class="n">compiler</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="n">FuncIndex</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="n">translated</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="mf">1.248188995</span><span class="n">s</span><span class="w"></span>
<span class="w"> </span><span class="n">TRACE</span><span class="w"> </span><span class="n">wasmtime_cranelift</span>::<span class="n">compiler</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="n">FuncIndex</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="n">timing</span><span class="w"> </span><span class="n">info</span><span class="w"></span>
<span class="o">========</span><span class="w"> </span><span class="o">========</span><span class="w">  </span><span class="o">==================================</span><span class="w"></span>
<span class="w">   </span><span class="n">Total</span><span class="w">     </span><span class="bp">Self</span><span class="w">  </span><span class="n">Pass</span><span class="w"></span>
<span class="o">--------</span><span class="w"> </span><span class="o">--------</span><span class="w">  </span><span class="o">----------------------------------</span><span class="w"></span>
<span class="w">   </span><span class="mf">0.006</span><span class="w">    </span><span class="mf">0.006</span><span class="w">  </span><span class="n">Translate</span><span class="w"> </span><span class="n">WASM</span><span class="w"> </span><span class="n">function</span><span class="w"></span>
<span class="w">   </span><span class="mf">0.624</span><span class="w">    </span><span class="mf">0.007</span><span class="w">  </span><span class="n">Compilation</span><span class="w"> </span><span class="n">passes</span><span class="w"></span>
<span class="w">   </span><span class="mf">0.003</span><span class="w">    </span><span class="mf">0.003</span><span class="w">  </span><span class="n">Control</span><span class="w"> </span><span class="n">flow</span><span class="w"> </span><span class="n">graph</span><span class="w"></span>
<span class="w">   </span><span class="mf">0.003</span><span class="w">    </span><span class="mf">0.003</span><span class="w">  </span><span class="n">Dominator</span><span class="w"> </span><span class="n">tree</span><span class="w"></span>
<span class="w">   </span><span class="mf">0.000</span><span class="w">    </span><span class="mf">0.000</span><span class="w">  </span><span class="n">Loop</span><span class="w"> </span><span class="n">analysis</span><span class="w"></span>
<span class="w">   </span><span class="mf">0.000</span><span class="w">    </span><span class="mf">0.000</span><span class="w">  </span><span class="n">Pre</span><span class="o">-</span><span class="n">legalization</span><span class="w"> </span><span class="n">rewriting</span><span class="w"></span>
<span class="w">   </span><span class="mf">0.000</span><span class="w">    </span><span class="mf">0.000</span><span class="w">  </span><span class="n">Dead</span><span class="w"> </span><span class="n">code</span><span class="w"> </span><span class="n">elimination</span><span class="w"></span>
<span class="w">   </span><span class="mf">0.001</span><span class="w">    </span><span class="mf">0.001</span><span class="w">  </span><span class="n">Global</span><span class="w"> </span><span class="n">value</span><span class="w"> </span><span class="n">numbering</span><span class="w"></span>
<span class="w">   </span><span class="mf">0.002</span><span class="w">    </span><span class="mf">0.000</span><span class="w">  </span><span class="n">Loop</span><span class="w"> </span><span class="n">invariant</span><span class="w"> </span><span class="n">code</span><span class="w"> </span><span class="n">motion</span><span class="w"></span>
<span class="w">   </span><span class="mf">0.000</span><span class="w">    </span><span class="mf">0.000</span><span class="w">  </span><span class="n">Remove</span><span class="w"> </span><span class="n">unreachable</span><span class="w"> </span><span class="n">blocks</span><span class="w"></span>
<span class="w">   </span><span class="mf">0.001</span><span class="w">    </span><span class="mf">0.001</span><span class="w">  </span><span class="n">Remove</span><span class="w"> </span><span class="n">constant</span><span class="w"> </span><span class="n">phi</span><span class="o">-</span><span class="n">nodes</span><span class="w"></span>
<span class="w">   </span><span class="mf">0.005</span><span class="w">    </span><span class="mf">0.005</span><span class="w">  </span><span class="n">VCode</span><span class="w"> </span><span class="n">lowering</span><span class="w"></span>
<span class="w">   </span><span class="mf">0.000</span><span class="w">    </span><span class="mf">0.000</span><span class="w">  </span><span class="n">VCode</span><span class="w"> </span><span class="n">post</span><span class="o">-</span><span class="n">register</span><span class="w"> </span><span class="n">allocation</span><span class="w"> </span><span class="n">finalization</span><span class="w"></span>
<span class="w">   </span><span class="mf">0.270</span><span class="w">    </span><span class="mf">0.270</span><span class="w">  </span><span class="n">VCode</span><span class="w"> </span><span class="n">emission</span><span class="w"></span>
<span class="w">   </span><span class="mf">0.000</span><span class="w">    </span><span class="mf">0.000</span><span class="w">  </span><span class="n">VCode</span><span class="w"> </span><span class="n">emission</span><span class="w"> </span><span class="n">finalization</span><span class="w"></span>
<span class="w">   </span><span class="mf">0.333</span><span class="w">    </span><span class="mf">0.333</span><span class="w">  </span><span class="n">Register</span><span class="w"> </span><span class="n">allocation</span><span class="w"></span>
<span class="w">   </span><span class="mf">0.000</span><span class="w">    </span><span class="mf">0.000</span><span class="w">  </span><span class="n">Binary</span><span class="w"> </span><span class="n">machine</span><span class="w"> </span><span class="n">code</span><span class="w"> </span><span class="n">emission</span><span class="w"></span>
<span class="o">========</span><span class="w"> </span><span class="o">========</span><span class="w">  </span><span class="o">==================================</span><span class="w"></span>
</code></pre></div>
<p>Something here seems accidentally quadratic perhaps? Whatever the reason this function probably shouldn't take upwards of a second to compile.</p>
</blockquote>



<a name="258552105"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%233441%20Seemingly-quadratic%20behavior%20compi.../near/258552105" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.233441.20Seemingly-quadratic.20behavior.20compi.2E.2E.2E.html#258552105">(Oct 21 2021 at 14:11)</a>:</h4>
<p>alexcrichton <a href="https://github.com/bytecodealliance/wasmtime/issues/3441#issuecomment-948658640">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/3441">issue #3441</a>:</p>
<blockquote>
<p>Thanks @adamrk for the fix here!</p>
<p>@cfallin I was also slightly worried on this that vcode emission is a pretty big time sink of 600ms in <a href="https://github.com/bytecodealliance/wasmtime/issues/3441#issuecomment-947072360">these timings</a> compared to 13ms creation of the clif, do you think that's also worth looking into and/or opening a separate issue for?</p>
</blockquote>



<a name="258597591"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%233441%20Seemingly-quadratic%20behavior%20compi.../near/258597591" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.233441.20Seemingly-quadratic.20behavior.20compi.2E.2E.2E.html#258597591">(Oct 21 2021 at 18:47)</a>:</h4>
<p>cfallin <a href="https://github.com/bytecodealliance/wasmtime/issues/3441#issuecomment-948905308">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/3441">issue #3441</a>:</p>
<blockquote>
<p>@alexcrichton I spent some time profiling this and it appears that there is indeed some suboptimal behavior in the branch simplification; specifically all the empty loops cause thousands of labels to alias and this wreaks havoc on things. I'll create an issue and see if I can add a limiter of some sort.</p>
</blockquote>



<hr><p>Last updated: Jan 20 2025 at 06:04 UTC</p>
</html>