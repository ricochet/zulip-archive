<html>
<head><meta charset="utf-8"><title>wasmtime / issue #5922 Cranelift: Segfault with unaligned... · git-wasmtime · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/index.html">git-wasmtime</a></h2>
<h3>Topic: <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.235922.20Cranelift.3A.20Segfault.20with.20unaligned.2E.2E.2E.html">wasmtime / issue #5922 Cranelift: Segfault with unaligned...</a></h3>

<hr>

<base href="https://bytecodealliance.zulipchat.com">

<head><link href="https://bytecodealliance.github.io/zulip-archive/style.css" rel="stylesheet"></head>

<a name="339399802"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%235922%20Cranelift%3A%20Segfault%20with%20unaligned.../near/339399802" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.235922.20Cranelift.3A.20Segfault.20with.20unaligned.2E.2E.2E.html#339399802">(Mar 03 2023 at 17:08)</a>:</h4>
<p>afonso360 opened <a href="https://github.com/bytecodealliance/wasmtime/issues/5922">issue #5922</a>:</p>
<blockquote>
<p><span aria-label="wave" class="emoji emoji-1f44b" role="img" title="wave">:wave:</span> Hey,</p>
<p>Me and @alexcrichton were discussing this via Zulip. The <code>stack_load</code> gets <a href="https://github.com/bytecodealliance/wasmtime/blob/3ff3994a128e900dfe7a465c7f36fc5a074d07ef/cranelift/codegen/src/legalizer/mod.rs#L85-L87">translated into</a> a <code>load.f64x2 notrap aligned v34</code>, and that's why we do the load sinking in the backend.</p>
<p>Is <code>stack_load</code> required to be sufficiently aligned? Reading the <a href="https://docs.rs/cranelift-codegen/latest/cranelift_codegen/ir/trait.InstBuilder.html#method.stack_load">docs</a>, they don't mention anything. So it might just be a case of lets update the docs and the fuzzer.</p>
<h3><code>.clif</code> Test Case</h3>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="n">test</span><span class="w"> </span><span class="n">run</span>
<span class="n">target</span><span class="w"> </span><span class="n">x86_64</span>
<span class="n">target</span><span class="w"> </span><span class="n">aarch64</span>
<span class="n">target</span><span class="w"> </span><span class="n">s390x</span>

<span class="n">function</span><span class="w"> </span><span class="o">%</span><span class="n">a</span><span class="p">()</span><span class="w"> </span>-&gt; <span class="kt">f64</span> <span class="nc">system_v</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">ss0</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">explicit_slot</span><span class="w"> </span><span class="mi">69</span>

<span class="n">block0</span>:
    <span class="nc">v0</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">iconst</span><span class="p">.</span><span class="kt">i64</span><span class="w"> </span><span class="mi">0</span>
<span class="w">    </span><span class="n">stack_store</span><span class="p">.</span><span class="kt">i64</span><span class="w"> </span><span class="n">v0</span><span class="p">,</span><span class="w"> </span><span class="n">ss0</span><span class="o">+</span><span class="mi">20</span>
<span class="w">    </span><span class="n">stack_store</span><span class="p">.</span><span class="kt">i64</span><span class="w"> </span><span class="n">v0</span><span class="p">,</span><span class="w"> </span><span class="n">ss0</span><span class="o">+</span><span class="mi">28</span>
<span class="w">    </span><span class="n">stack_store</span><span class="p">.</span><span class="kt">i64</span><span class="w"> </span><span class="n">v0</span><span class="p">,</span><span class="w"> </span><span class="n">ss0</span><span class="o">+</span><span class="mi">36</span>

<span class="w">    </span><span class="n">v29</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">stack_load</span><span class="p">.</span><span class="n">f64x2</span><span class="w"> </span><span class="n">ss0</span><span class="o">+</span><span class="mi">23</span>
<span class="w">    </span><span class="n">v30</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">extractlane</span><span class="w"> </span><span class="n">v29</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">v30</span>
<span class="p">}</span>

<span class="p">;</span><span class="w"> </span><span class="n">run</span>: <span class="o">%</span><span class="n">a</span><span class="p">()</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mf">0.0</span>
</code></pre></div>
<h3>Steps to Reproduce</h3>
<ul>
<li><code>clif-util test ./the-above.clif</code></li>
</ul>
<h3>Expected Results</h3>
<p>The test to pass</p>
<h3>Actual Results</h3>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="w">    </span><span class="n">Finished</span><span class="w"> </span><span class="n">dev</span><span class="w"> </span><span class="p">[</span><span class="n">unoptimized</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">debuginfo</span><span class="p">]</span><span class="w"> </span><span class="n">target</span><span class="p">(</span><span class="n">s</span><span class="p">)</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="mf">0.25</span><span class="n">s</span>
<span class="w">     </span><span class="n">Running</span><span class="w"> </span><span class="err">`</span><span class="o">/</span><span class="n">home</span><span class="o">/</span><span class="n">afonso</span><span class="o">/</span><span class="n">git</span><span class="o">/</span><span class="n">wasmtime</span><span class="o">/</span><span class="n">target</span><span class="o">/</span><span class="n">debug</span><span class="o">/</span><span class="n">clif</span><span class="o">-</span><span class="n">util</span><span class="w"> </span><span class="n">test</span><span class="w"> </span><span class="p">.</span><span class="o">/</span><span class="n">lmao</span><span class="p">.</span><span class="n">clif</span><span class="err">`</span>
<span class="n">Segmentation</span><span class="w"> </span><span class="n">fault</span>
</code></pre></div>
<p>This passes on AArch64 and S390x.</p>
<h3>Versions and Environment</h3>
<p>Cranelift version or commit: main</p>
<p>Operating system: Linux</p>
<p>Architecture: x64</p>
<h3>Extra Info</h3>
<p>&lt;details&gt;<br>
&lt;summary&gt;Generated assembly:&lt;/summary&gt;</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="n">Disassembly</span><span class="w"> </span><span class="n">of</span><span class="w"> </span><span class="mi">60</span><span class="w"> </span><span class="n">bytes</span>:
   <span class="mi">0</span>:   <span class="mi">55</span><span class="w">                      </span><span class="n">pushq</span><span class="w">   </span><span class="o">%</span><span class="n">rbp</span>
<span class="w">   </span><span class="mi">1</span>:   <span class="mi">48</span><span class="w"> </span><span class="mi">89</span><span class="w"> </span><span class="n">e5</span><span class="w">                </span><span class="n">movq</span><span class="w">    </span><span class="o">%</span><span class="n">rsp</span><span class="p">,</span><span class="w"> </span><span class="o">%</span><span class="n">rbp</span>
<span class="w">   </span><span class="mi">4</span>:   <span class="mi">48</span><span class="w"> </span><span class="mi">83</span><span class="w"> </span><span class="n">ec</span><span class="w"> </span><span class="mi">50</span><span class="w">             </span><span class="n">subq</span><span class="w">    </span><span class="cp">$</span><span class="mh">0x50</span><span class="p">,</span><span class="w"> </span><span class="o">%</span><span class="n">rsp</span>
<span class="w">   </span><span class="mi">8</span>:   <span class="mi">4</span><span class="n">c</span><span class="w"> </span><span class="mi">8</span><span class="n">d</span><span class="w"> </span><span class="mi">54</span><span class="w"> </span><span class="mi">24</span><span class="w"> </span><span class="mi">14</span><span class="w">          </span><span class="n">leaq</span><span class="w">    </span><span class="mh">0x14</span><span class="p">(</span><span class="o">%</span><span class="n">rsp</span><span class="p">),</span><span class="w"> </span><span class="o">%</span><span class="n">r10</span>
<span class="w">   </span><span class="n">d</span>:   <span class="mi">4</span><span class="n">d</span><span class="w"> </span><span class="mi">31</span><span class="w"> </span><span class="n">db</span><span class="w">                </span><span class="n">xorq</span><span class="w">    </span><span class="o">%</span><span class="n">r11</span><span class="p">,</span><span class="w"> </span><span class="o">%</span><span class="n">r11</span>
<span class="w">  </span><span class="mi">10</span>:   <span class="mi">4</span><span class="n">d</span><span class="w"> </span><span class="mi">89</span><span class="w"> </span><span class="mi">1</span><span class="n">a</span><span class="w">                </span><span class="n">movq</span><span class="w">    </span><span class="o">%</span><span class="n">r11</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="o">%</span><span class="n">r10</span><span class="p">)</span>
<span class="w">  </span><span class="mi">13</span>:   <span class="mi">4</span><span class="n">c</span><span class="w"> </span><span class="mi">8</span><span class="n">d</span><span class="w"> </span><span class="mi">5</span><span class="n">c</span><span class="w"> </span><span class="mi">24</span><span class="w"> </span><span class="mi">1</span><span class="n">c</span><span class="w">          </span><span class="n">leaq</span><span class="w">    </span><span class="mh">0x1c</span><span class="p">(</span><span class="o">%</span><span class="n">rsp</span><span class="p">),</span><span class="w"> </span><span class="o">%</span><span class="n">r11</span>
<span class="w">  </span><span class="mi">18</span>:   <span class="mi">48</span><span class="w"> </span><span class="mi">31</span><span class="w"> </span><span class="n">f6</span><span class="w">                </span><span class="n">xorq</span><span class="w">    </span><span class="o">%</span><span class="n">rsi</span><span class="p">,</span><span class="w"> </span><span class="o">%</span><span class="n">rsi</span>
<span class="w">  </span><span class="mi">1</span><span class="n">b</span>:   <span class="mi">49</span><span class="w"> </span><span class="mi">89</span><span class="w"> </span><span class="mi">33</span><span class="w">                </span><span class="n">movq</span><span class="w">    </span><span class="o">%</span><span class="n">rsi</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="o">%</span><span class="n">r11</span><span class="p">)</span>
<span class="w">  </span><span class="mi">1</span><span class="n">e</span>:   <span class="mi">48</span><span class="w"> </span><span class="mi">8</span><span class="n">d</span><span class="w"> </span><span class="mi">74</span><span class="w"> </span><span class="mi">24</span><span class="w"> </span><span class="mi">24</span><span class="w">          </span><span class="n">leaq</span><span class="w">    </span><span class="mh">0x24</span><span class="p">(</span><span class="o">%</span><span class="n">rsp</span><span class="p">),</span><span class="w"> </span><span class="o">%</span><span class="n">rsi</span>
<span class="w">  </span><span class="mi">23</span>:   <span class="mi">48</span><span class="w"> </span><span class="mi">31</span><span class="w"> </span><span class="n">ff</span><span class="w">                </span><span class="n">xorq</span><span class="w">    </span><span class="o">%</span><span class="n">rdi</span><span class="p">,</span><span class="w"> </span><span class="o">%</span><span class="n">rdi</span>
<span class="w">  </span><span class="mi">26</span>:   <span class="mi">48</span><span class="w"> </span><span class="mi">89</span><span class="w"> </span><span class="mi">3</span><span class="n">e</span><span class="w">                </span><span class="n">movq</span><span class="w">    </span><span class="o">%</span><span class="n">rdi</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="o">%</span><span class="n">rsi</span><span class="p">)</span>
<span class="w">  </span><span class="mi">29</span>:   <span class="mi">48</span><span class="w"> </span><span class="mi">8</span><span class="n">d</span><span class="w"> </span><span class="mi">7</span><span class="n">c</span><span class="w"> </span><span class="mi">24</span><span class="w"> </span><span class="mi">17</span><span class="w">          </span><span class="n">leaq</span><span class="w">    </span><span class="mh">0x17</span><span class="p">(</span><span class="o">%</span><span class="n">rsp</span><span class="p">),</span><span class="w"> </span><span class="o">%</span><span class="n">rdi</span>
<span class="w">  </span><span class="mi">2</span><span class="n">e</span>:   <span class="mi">66</span><span class="w"> </span><span class="mi">0</span><span class="n">f</span><span class="w"> </span><span class="mi">70</span><span class="w"> </span><span class="mi">07</span><span class="w"> </span><span class="n">ee</span><span class="w">          </span><span class="n">pshufd</span><span class="w">  </span><span class="cp">$</span><span class="mh">0xee</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="o">%</span><span class="n">rdi</span><span class="p">),</span><span class="w"> </span><span class="o">%</span><span class="n">xmm0</span>
<span class="w">  </span><span class="mi">33</span>:   <span class="mi">48</span><span class="w"> </span><span class="mi">83</span><span class="w"> </span><span class="n">c4</span><span class="w"> </span><span class="mi">50</span><span class="w">             </span><span class="n">addq</span><span class="w">    </span><span class="cp">$</span><span class="mh">0x50</span><span class="p">,</span><span class="w"> </span><span class="o">%</span><span class="n">rsp</span>
<span class="w">  </span><span class="mi">37</span>:   <span class="mi">48</span><span class="w"> </span><span class="mi">89</span><span class="w"> </span><span class="n">ec</span><span class="w">                </span><span class="n">movq</span><span class="w">    </span><span class="o">%</span><span class="n">rbp</span><span class="p">,</span><span class="w"> </span><span class="o">%</span><span class="n">rsp</span>
<span class="w">  </span><span class="mi">3</span><span class="n">a</span>:   <span class="mi">5</span><span class="n">d</span><span class="w">                      </span><span class="n">popq</span><span class="w">    </span><span class="o">%</span><span class="n">rbp</span>
<span class="w">  </span><span class="mi">3</span><span class="n">b</span>:   <span class="nc">c3</span><span class="w">                      </span><span class="n">retq</span>
</code></pre></div>
<p>&lt;/details&gt;<br>
</p>
</blockquote>



<a name="339399803"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%235922%20Cranelift%3A%20Segfault%20with%20unaligned.../near/339399803" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.235922.20Cranelift.3A.20Segfault.20with.20unaligned.2E.2E.2E.html#339399803">(Mar 03 2023 at 17:08)</a>:</h4>
<p>afonso360 labeled <a href="https://github.com/bytecodealliance/wasmtime/issues/5922">issue #5922</a>:</p>
<blockquote>
<p><span aria-label="wave" class="emoji emoji-1f44b" role="img" title="wave">:wave:</span> Hey,</p>
<p>Me and @alexcrichton were discussing this via Zulip. The <code>stack_load</code> gets <a href="https://github.com/bytecodealliance/wasmtime/blob/3ff3994a128e900dfe7a465c7f36fc5a074d07ef/cranelift/codegen/src/legalizer/mod.rs#L85-L87">translated into</a> a <code>load.f64x2 notrap aligned v34</code>, and that's why we do the load sinking in the backend.</p>
<p>Is <code>stack_load</code> required to be sufficiently aligned? Reading the <a href="https://docs.rs/cranelift-codegen/latest/cranelift_codegen/ir/trait.InstBuilder.html#method.stack_load">docs</a>, they don't mention anything. So it might just be a case of lets update the docs and the fuzzer.</p>
<h3><code>.clif</code> Test Case</h3>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="n">test</span><span class="w"> </span><span class="n">run</span>
<span class="n">target</span><span class="w"> </span><span class="n">x86_64</span>
<span class="n">target</span><span class="w"> </span><span class="n">aarch64</span>
<span class="n">target</span><span class="w"> </span><span class="n">s390x</span>

<span class="n">function</span><span class="w"> </span><span class="o">%</span><span class="n">a</span><span class="p">()</span><span class="w"> </span>-&gt; <span class="kt">f64</span> <span class="nc">system_v</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">ss0</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">explicit_slot</span><span class="w"> </span><span class="mi">69</span>

<span class="n">block0</span>:
    <span class="nc">v0</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">iconst</span><span class="p">.</span><span class="kt">i64</span><span class="w"> </span><span class="mi">0</span>
<span class="w">    </span><span class="n">stack_store</span><span class="p">.</span><span class="kt">i64</span><span class="w"> </span><span class="n">v0</span><span class="p">,</span><span class="w"> </span><span class="n">ss0</span><span class="o">+</span><span class="mi">20</span>
<span class="w">    </span><span class="n">stack_store</span><span class="p">.</span><span class="kt">i64</span><span class="w"> </span><span class="n">v0</span><span class="p">,</span><span class="w"> </span><span class="n">ss0</span><span class="o">+</span><span class="mi">28</span>
<span class="w">    </span><span class="n">stack_store</span><span class="p">.</span><span class="kt">i64</span><span class="w"> </span><span class="n">v0</span><span class="p">,</span><span class="w"> </span><span class="n">ss0</span><span class="o">+</span><span class="mi">36</span>

<span class="w">    </span><span class="n">v29</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">stack_load</span><span class="p">.</span><span class="n">f64x2</span><span class="w"> </span><span class="n">ss0</span><span class="o">+</span><span class="mi">23</span>
<span class="w">    </span><span class="n">v30</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">extractlane</span><span class="w"> </span><span class="n">v29</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">v30</span>
<span class="p">}</span>

<span class="p">;</span><span class="w"> </span><span class="n">run</span>: <span class="o">%</span><span class="n">a</span><span class="p">()</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mf">0.0</span>
</code></pre></div>
<h3>Steps to Reproduce</h3>
<ul>
<li><code>clif-util test ./the-above.clif</code></li>
</ul>
<h3>Expected Results</h3>
<p>The test to pass</p>
<h3>Actual Results</h3>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="w">    </span><span class="n">Finished</span><span class="w"> </span><span class="n">dev</span><span class="w"> </span><span class="p">[</span><span class="n">unoptimized</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">debuginfo</span><span class="p">]</span><span class="w"> </span><span class="n">target</span><span class="p">(</span><span class="n">s</span><span class="p">)</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="mf">0.25</span><span class="n">s</span>
<span class="w">     </span><span class="n">Running</span><span class="w"> </span><span class="err">`</span><span class="o">/</span><span class="n">home</span><span class="o">/</span><span class="n">afonso</span><span class="o">/</span><span class="n">git</span><span class="o">/</span><span class="n">wasmtime</span><span class="o">/</span><span class="n">target</span><span class="o">/</span><span class="n">debug</span><span class="o">/</span><span class="n">clif</span><span class="o">-</span><span class="n">util</span><span class="w"> </span><span class="n">test</span><span class="w"> </span><span class="p">.</span><span class="o">/</span><span class="n">lmao</span><span class="p">.</span><span class="n">clif</span><span class="err">`</span>
<span class="n">Segmentation</span><span class="w"> </span><span class="n">fault</span>
</code></pre></div>
<p>This passes on AArch64 and S390x.</p>
<h3>Versions and Environment</h3>
<p>Cranelift version or commit: main</p>
<p>Operating system: Linux</p>
<p>Architecture: x64</p>
<h3>Extra Info</h3>
<p>&lt;details&gt;<br>
&lt;summary&gt;Generated assembly:&lt;/summary&gt;</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="n">Disassembly</span><span class="w"> </span><span class="n">of</span><span class="w"> </span><span class="mi">60</span><span class="w"> </span><span class="n">bytes</span>:
   <span class="mi">0</span>:   <span class="mi">55</span><span class="w">                      </span><span class="n">pushq</span><span class="w">   </span><span class="o">%</span><span class="n">rbp</span>
<span class="w">   </span><span class="mi">1</span>:   <span class="mi">48</span><span class="w"> </span><span class="mi">89</span><span class="w"> </span><span class="n">e5</span><span class="w">                </span><span class="n">movq</span><span class="w">    </span><span class="o">%</span><span class="n">rsp</span><span class="p">,</span><span class="w"> </span><span class="o">%</span><span class="n">rbp</span>
<span class="w">   </span><span class="mi">4</span>:   <span class="mi">48</span><span class="w"> </span><span class="mi">83</span><span class="w"> </span><span class="n">ec</span><span class="w"> </span><span class="mi">50</span><span class="w">             </span><span class="n">subq</span><span class="w">    </span><span class="cp">$</span><span class="mh">0x50</span><span class="p">,</span><span class="w"> </span><span class="o">%</span><span class="n">rsp</span>
<span class="w">   </span><span class="mi">8</span>:   <span class="mi">4</span><span class="n">c</span><span class="w"> </span><span class="mi">8</span><span class="n">d</span><span class="w"> </span><span class="mi">54</span><span class="w"> </span><span class="mi">24</span><span class="w"> </span><span class="mi">14</span><span class="w">          </span><span class="n">leaq</span><span class="w">    </span><span class="mh">0x14</span><span class="p">(</span><span class="o">%</span><span class="n">rsp</span><span class="p">),</span><span class="w"> </span><span class="o">%</span><span class="n">r10</span>
<span class="w">   </span><span class="n">d</span>:   <span class="mi">4</span><span class="n">d</span><span class="w"> </span><span class="mi">31</span><span class="w"> </span><span class="n">db</span><span class="w">                </span><span class="n">xorq</span><span class="w">    </span><span class="o">%</span><span class="n">r11</span><span class="p">,</span><span class="w"> </span><span class="o">%</span><span class="n">r11</span>
<span class="w">  </span><span class="mi">10</span>:   <span class="mi">4</span><span class="n">d</span><span class="w"> </span><span class="mi">89</span><span class="w"> </span><span class="mi">1</span><span class="n">a</span><span class="w">                </span><span class="n">movq</span><span class="w">    </span><span class="o">%</span><span class="n">r11</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="o">%</span><span class="n">r10</span><span class="p">)</span>
<span class="w">  </span><span class="mi">13</span>:   <span class="mi">4</span><span class="n">c</span><span class="w"> </span><span class="mi">8</span><span class="n">d</span><span class="w"> </span><span class="mi">5</span><span class="n">c</span><span class="w"> </span><span class="mi">24</span><span class="w"> </span><span class="mi">1</span><span class="n">c</span><span class="w">          </span><span class="n">leaq</span><span class="w">    </span><span class="mh">0x1c</span><span class="p">(</span><span class="o">%</span><span class="n">rsp</span><span class="p">),</span><span class="w"> </span><span class="o">%</span><span class="n">r11</span>
<span class="w">  </span><span class="mi">18</span>:   <span class="mi">48</span><span class="w"> </span><span class="mi">31</span><span class="w"> </span><span class="n">f6</span><span class="w">                </span><span class="n">xorq</span><span class="w">    </span><span class="o">%</span><span class="n">rsi</span><span class="p">,</span><span class="w"> </span><span class="o">%</span><span class="n">rsi</span>
<span class="w">  </span><span class="mi">1</span><span class="n">b</span>:   <span class="mi">49</span><span class="w"> </span><span class="mi">89</span><span class="w"> </span><span class="mi">33</span><span class="w">                </span><span class="n">movq</span><span class="w">    </span><span class="o">%</span><span class="n">rsi</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="o">%</span><span class="n">r11</span><span class="p">)</span>
<span class="w">  </span><span class="mi">1</span><span class="n">e</span>:   <span class="mi">48</span><span class="w"> </span><span class="mi">8</span><span class="n">d</span><span class="w"> </span><span class="mi">74</span><span class="w"> </span><span class="mi">24</span><span class="w"> </span><span class="mi">24</span><span class="w">          </span><span class="n">leaq</span><span class="w">    </span><span class="mh">0x24</span><span class="p">(</span><span class="o">%</span><span class="n">rsp</span><span class="p">),</span><span class="w"> </span><span class="o">%</span><span class="n">rsi</span>
<span class="w">  </span><span class="mi">23</span>:   <span class="mi">48</span><span class="w"> </span><span class="mi">31</span><span class="w"> </span><span class="n">ff</span><span class="w">                </span><span class="n">xorq</span><span class="w">    </span><span class="o">%</span><span class="n">rdi</span><span class="p">,</span><span class="w"> </span><span class="o">%</span><span class="n">rdi</span>
<span class="w">  </span><span class="mi">26</span>:   <span class="mi">48</span><span class="w"> </span><span class="mi">89</span><span class="w"> </span><span class="mi">3</span><span class="n">e</span><span class="w">                </span><span class="n">movq</span><span class="w">    </span><span class="o">%</span><span class="n">rdi</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="o">%</span><span class="n">rsi</span><span class="p">)</span>
<span class="w">  </span><span class="mi">29</span>:   <span class="mi">48</span><span class="w"> </span><span class="mi">8</span><span class="n">d</span><span class="w"> </span><span class="mi">7</span><span class="n">c</span><span class="w"> </span><span class="mi">24</span><span class="w"> </span><span class="mi">17</span><span class="w">          </span><span class="n">leaq</span><span class="w">    </span><span class="mh">0x17</span><span class="p">(</span><span class="o">%</span><span class="n">rsp</span><span class="p">),</span><span class="w"> </span><span class="o">%</span><span class="n">rdi</span>
<span class="w">  </span><span class="mi">2</span><span class="n">e</span>:   <span class="mi">66</span><span class="w"> </span><span class="mi">0</span><span class="n">f</span><span class="w"> </span><span class="mi">70</span><span class="w"> </span><span class="mi">07</span><span class="w"> </span><span class="n">ee</span><span class="w">          </span><span class="n">pshufd</span><span class="w">  </span><span class="cp">$</span><span class="mh">0xee</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="o">%</span><span class="n">rdi</span><span class="p">),</span><span class="w"> </span><span class="o">%</span><span class="n">xmm0</span>
<span class="w">  </span><span class="mi">33</span>:   <span class="mi">48</span><span class="w"> </span><span class="mi">83</span><span class="w"> </span><span class="n">c4</span><span class="w"> </span><span class="mi">50</span><span class="w">             </span><span class="n">addq</span><span class="w">    </span><span class="cp">$</span><span class="mh">0x50</span><span class="p">,</span><span class="w"> </span><span class="o">%</span><span class="n">rsp</span>
<span class="w">  </span><span class="mi">37</span>:   <span class="mi">48</span><span class="w"> </span><span class="mi">89</span><span class="w"> </span><span class="n">ec</span><span class="w">                </span><span class="n">movq</span><span class="w">    </span><span class="o">%</span><span class="n">rbp</span><span class="p">,</span><span class="w"> </span><span class="o">%</span><span class="n">rsp</span>
<span class="w">  </span><span class="mi">3</span><span class="n">a</span>:   <span class="mi">5</span><span class="n">d</span><span class="w">                      </span><span class="n">popq</span><span class="w">    </span><span class="o">%</span><span class="n">rbp</span>
<span class="w">  </span><span class="mi">3</span><span class="n">b</span>:   <span class="nc">c3</span><span class="w">                      </span><span class="n">retq</span>
</code></pre></div>
<p>&lt;/details&gt;<br>
</p>
</blockquote>



<a name="339399805"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%235922%20Cranelift%3A%20Segfault%20with%20unaligned.../near/339399805" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.235922.20Cranelift.3A.20Segfault.20with.20unaligned.2E.2E.2E.html#339399805">(Mar 03 2023 at 17:08)</a>:</h4>
<p>afonso360 labeled <a href="https://github.com/bytecodealliance/wasmtime/issues/5922">issue #5922</a>:</p>
<blockquote>
<p><span aria-label="wave" class="emoji emoji-1f44b" role="img" title="wave">:wave:</span> Hey,</p>
<p>Me and @alexcrichton were discussing this via Zulip. The <code>stack_load</code> gets <a href="https://github.com/bytecodealliance/wasmtime/blob/3ff3994a128e900dfe7a465c7f36fc5a074d07ef/cranelift/codegen/src/legalizer/mod.rs#L85-L87">translated into</a> a <code>load.f64x2 notrap aligned v34</code>, and that's why we do the load sinking in the backend.</p>
<p>Is <code>stack_load</code> required to be sufficiently aligned? Reading the <a href="https://docs.rs/cranelift-codegen/latest/cranelift_codegen/ir/trait.InstBuilder.html#method.stack_load">docs</a>, they don't mention anything. So it might just be a case of lets update the docs and the fuzzer.</p>
<h3><code>.clif</code> Test Case</h3>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="n">test</span><span class="w"> </span><span class="n">run</span>
<span class="n">target</span><span class="w"> </span><span class="n">x86_64</span>
<span class="n">target</span><span class="w"> </span><span class="n">aarch64</span>
<span class="n">target</span><span class="w"> </span><span class="n">s390x</span>

<span class="n">function</span><span class="w"> </span><span class="o">%</span><span class="n">a</span><span class="p">()</span><span class="w"> </span>-&gt; <span class="kt">f64</span> <span class="nc">system_v</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">ss0</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">explicit_slot</span><span class="w"> </span><span class="mi">69</span>

<span class="n">block0</span>:
    <span class="nc">v0</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">iconst</span><span class="p">.</span><span class="kt">i64</span><span class="w"> </span><span class="mi">0</span>
<span class="w">    </span><span class="n">stack_store</span><span class="p">.</span><span class="kt">i64</span><span class="w"> </span><span class="n">v0</span><span class="p">,</span><span class="w"> </span><span class="n">ss0</span><span class="o">+</span><span class="mi">20</span>
<span class="w">    </span><span class="n">stack_store</span><span class="p">.</span><span class="kt">i64</span><span class="w"> </span><span class="n">v0</span><span class="p">,</span><span class="w"> </span><span class="n">ss0</span><span class="o">+</span><span class="mi">28</span>
<span class="w">    </span><span class="n">stack_store</span><span class="p">.</span><span class="kt">i64</span><span class="w"> </span><span class="n">v0</span><span class="p">,</span><span class="w"> </span><span class="n">ss0</span><span class="o">+</span><span class="mi">36</span>

<span class="w">    </span><span class="n">v29</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">stack_load</span><span class="p">.</span><span class="n">f64x2</span><span class="w"> </span><span class="n">ss0</span><span class="o">+</span><span class="mi">23</span>
<span class="w">    </span><span class="n">v30</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">extractlane</span><span class="w"> </span><span class="n">v29</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">v30</span>
<span class="p">}</span>

<span class="p">;</span><span class="w"> </span><span class="n">run</span>: <span class="o">%</span><span class="n">a</span><span class="p">()</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mf">0.0</span>
</code></pre></div>
<h3>Steps to Reproduce</h3>
<ul>
<li><code>clif-util test ./the-above.clif</code></li>
</ul>
<h3>Expected Results</h3>
<p>The test to pass</p>
<h3>Actual Results</h3>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="w">    </span><span class="n">Finished</span><span class="w"> </span><span class="n">dev</span><span class="w"> </span><span class="p">[</span><span class="n">unoptimized</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">debuginfo</span><span class="p">]</span><span class="w"> </span><span class="n">target</span><span class="p">(</span><span class="n">s</span><span class="p">)</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="mf">0.25</span><span class="n">s</span>
<span class="w">     </span><span class="n">Running</span><span class="w"> </span><span class="err">`</span><span class="o">/</span><span class="n">home</span><span class="o">/</span><span class="n">afonso</span><span class="o">/</span><span class="n">git</span><span class="o">/</span><span class="n">wasmtime</span><span class="o">/</span><span class="n">target</span><span class="o">/</span><span class="n">debug</span><span class="o">/</span><span class="n">clif</span><span class="o">-</span><span class="n">util</span><span class="w"> </span><span class="n">test</span><span class="w"> </span><span class="p">.</span><span class="o">/</span><span class="n">lmao</span><span class="p">.</span><span class="n">clif</span><span class="err">`</span>
<span class="n">Segmentation</span><span class="w"> </span><span class="n">fault</span>
</code></pre></div>
<p>This passes on AArch64 and S390x.</p>
<h3>Versions and Environment</h3>
<p>Cranelift version or commit: main</p>
<p>Operating system: Linux</p>
<p>Architecture: x64</p>
<h3>Extra Info</h3>
<p>&lt;details&gt;<br>
&lt;summary&gt;Generated assembly:&lt;/summary&gt;</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="n">Disassembly</span><span class="w"> </span><span class="n">of</span><span class="w"> </span><span class="mi">60</span><span class="w"> </span><span class="n">bytes</span>:
   <span class="mi">0</span>:   <span class="mi">55</span><span class="w">                      </span><span class="n">pushq</span><span class="w">   </span><span class="o">%</span><span class="n">rbp</span>
<span class="w">   </span><span class="mi">1</span>:   <span class="mi">48</span><span class="w"> </span><span class="mi">89</span><span class="w"> </span><span class="n">e5</span><span class="w">                </span><span class="n">movq</span><span class="w">    </span><span class="o">%</span><span class="n">rsp</span><span class="p">,</span><span class="w"> </span><span class="o">%</span><span class="n">rbp</span>
<span class="w">   </span><span class="mi">4</span>:   <span class="mi">48</span><span class="w"> </span><span class="mi">83</span><span class="w"> </span><span class="n">ec</span><span class="w"> </span><span class="mi">50</span><span class="w">             </span><span class="n">subq</span><span class="w">    </span><span class="cp">$</span><span class="mh">0x50</span><span class="p">,</span><span class="w"> </span><span class="o">%</span><span class="n">rsp</span>
<span class="w">   </span><span class="mi">8</span>:   <span class="mi">4</span><span class="n">c</span><span class="w"> </span><span class="mi">8</span><span class="n">d</span><span class="w"> </span><span class="mi">54</span><span class="w"> </span><span class="mi">24</span><span class="w"> </span><span class="mi">14</span><span class="w">          </span><span class="n">leaq</span><span class="w">    </span><span class="mh">0x14</span><span class="p">(</span><span class="o">%</span><span class="n">rsp</span><span class="p">),</span><span class="w"> </span><span class="o">%</span><span class="n">r10</span>
<span class="w">   </span><span class="n">d</span>:   <span class="mi">4</span><span class="n">d</span><span class="w"> </span><span class="mi">31</span><span class="w"> </span><span class="n">db</span><span class="w">                </span><span class="n">xorq</span><span class="w">    </span><span class="o">%</span><span class="n">r11</span><span class="p">,</span><span class="w"> </span><span class="o">%</span><span class="n">r11</span>
<span class="w">  </span><span class="mi">10</span>:   <span class="mi">4</span><span class="n">d</span><span class="w"> </span><span class="mi">89</span><span class="w"> </span><span class="mi">1</span><span class="n">a</span><span class="w">                </span><span class="n">movq</span><span class="w">    </span><span class="o">%</span><span class="n">r11</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="o">%</span><span class="n">r10</span><span class="p">)</span>
<span class="w">  </span><span class="mi">13</span>:   <span class="mi">4</span><span class="n">c</span><span class="w"> </span><span class="mi">8</span><span class="n">d</span><span class="w"> </span><span class="mi">5</span><span class="n">c</span><span class="w"> </span><span class="mi">24</span><span class="w"> </span><span class="mi">1</span><span class="n">c</span><span class="w">          </span><span class="n">leaq</span><span class="w">    </span><span class="mh">0x1c</span><span class="p">(</span><span class="o">%</span><span class="n">rsp</span><span class="p">),</span><span class="w"> </span><span class="o">%</span><span class="n">r11</span>
<span class="w">  </span><span class="mi">18</span>:   <span class="mi">48</span><span class="w"> </span><span class="mi">31</span><span class="w"> </span><span class="n">f6</span><span class="w">                </span><span class="n">xorq</span><span class="w">    </span><span class="o">%</span><span class="n">rsi</span><span class="p">,</span><span class="w"> </span><span class="o">%</span><span class="n">rsi</span>
<span class="w">  </span><span class="mi">1</span><span class="n">b</span>:   <span class="mi">49</span><span class="w"> </span><span class="mi">89</span><span class="w"> </span><span class="mi">33</span><span class="w">                </span><span class="n">movq</span><span class="w">    </span><span class="o">%</span><span class="n">rsi</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="o">%</span><span class="n">r11</span><span class="p">)</span>
<span class="w">  </span><span class="mi">1</span><span class="n">e</span>:   <span class="mi">48</span><span class="w"> </span><span class="mi">8</span><span class="n">d</span><span class="w"> </span><span class="mi">74</span><span class="w"> </span><span class="mi">24</span><span class="w"> </span><span class="mi">24</span><span class="w">          </span><span class="n">leaq</span><span class="w">    </span><span class="mh">0x24</span><span class="p">(</span><span class="o">%</span><span class="n">rsp</span><span class="p">),</span><span class="w"> </span><span class="o">%</span><span class="n">rsi</span>
<span class="w">  </span><span class="mi">23</span>:   <span class="mi">48</span><span class="w"> </span><span class="mi">31</span><span class="w"> </span><span class="n">ff</span><span class="w">                </span><span class="n">xorq</span><span class="w">    </span><span class="o">%</span><span class="n">rdi</span><span class="p">,</span><span class="w"> </span><span class="o">%</span><span class="n">rdi</span>
<span class="w">  </span><span class="mi">26</span>:   <span class="mi">48</span><span class="w"> </span><span class="mi">89</span><span class="w"> </span><span class="mi">3</span><span class="n">e</span><span class="w">                </span><span class="n">movq</span><span class="w">    </span><span class="o">%</span><span class="n">rdi</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="o">%</span><span class="n">rsi</span><span class="p">)</span>
<span class="w">  </span><span class="mi">29</span>:   <span class="mi">48</span><span class="w"> </span><span class="mi">8</span><span class="n">d</span><span class="w"> </span><span class="mi">7</span><span class="n">c</span><span class="w"> </span><span class="mi">24</span><span class="w"> </span><span class="mi">17</span><span class="w">          </span><span class="n">leaq</span><span class="w">    </span><span class="mh">0x17</span><span class="p">(</span><span class="o">%</span><span class="n">rsp</span><span class="p">),</span><span class="w"> </span><span class="o">%</span><span class="n">rdi</span>
<span class="w">  </span><span class="mi">2</span><span class="n">e</span>:   <span class="mi">66</span><span class="w"> </span><span class="mi">0</span><span class="n">f</span><span class="w"> </span><span class="mi">70</span><span class="w"> </span><span class="mi">07</span><span class="w"> </span><span class="n">ee</span><span class="w">          </span><span class="n">pshufd</span><span class="w">  </span><span class="cp">$</span><span class="mh">0xee</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="o">%</span><span class="n">rdi</span><span class="p">),</span><span class="w"> </span><span class="o">%</span><span class="n">xmm0</span>
<span class="w">  </span><span class="mi">33</span>:   <span class="mi">48</span><span class="w"> </span><span class="mi">83</span><span class="w"> </span><span class="n">c4</span><span class="w"> </span><span class="mi">50</span><span class="w">             </span><span class="n">addq</span><span class="w">    </span><span class="cp">$</span><span class="mh">0x50</span><span class="p">,</span><span class="w"> </span><span class="o">%</span><span class="n">rsp</span>
<span class="w">  </span><span class="mi">37</span>:   <span class="mi">48</span><span class="w"> </span><span class="mi">89</span><span class="w"> </span><span class="n">ec</span><span class="w">                </span><span class="n">movq</span><span class="w">    </span><span class="o">%</span><span class="n">rbp</span><span class="p">,</span><span class="w"> </span><span class="o">%</span><span class="n">rsp</span>
<span class="w">  </span><span class="mi">3</span><span class="n">a</span>:   <span class="mi">5</span><span class="n">d</span><span class="w">                      </span><span class="n">popq</span><span class="w">    </span><span class="o">%</span><span class="n">rbp</span>
<span class="w">  </span><span class="mi">3</span><span class="n">b</span>:   <span class="nc">c3</span><span class="w">                      </span><span class="n">retq</span>
</code></pre></div>
<p>&lt;/details&gt;<br>
</p>
</blockquote>



<a name="339399807"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%235922%20Cranelift%3A%20Segfault%20with%20unaligned.../near/339399807" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.235922.20Cranelift.3A.20Segfault.20with.20unaligned.2E.2E.2E.html#339399807">(Mar 03 2023 at 17:08)</a>:</h4>
<p>afonso360 labeled <a href="https://github.com/bytecodealliance/wasmtime/issues/5922">issue #5922</a>:</p>
<blockquote>
<p><span aria-label="wave" class="emoji emoji-1f44b" role="img" title="wave">:wave:</span> Hey,</p>
<p>Me and @alexcrichton were discussing this via Zulip. The <code>stack_load</code> gets <a href="https://github.com/bytecodealliance/wasmtime/blob/3ff3994a128e900dfe7a465c7f36fc5a074d07ef/cranelift/codegen/src/legalizer/mod.rs#L85-L87">translated into</a> a <code>load.f64x2 notrap aligned v34</code>, and that's why we do the load sinking in the backend.</p>
<p>Is <code>stack_load</code> required to be sufficiently aligned? Reading the <a href="https://docs.rs/cranelift-codegen/latest/cranelift_codegen/ir/trait.InstBuilder.html#method.stack_load">docs</a>, they don't mention anything. So it might just be a case of lets update the docs and the fuzzer.</p>
<h3><code>.clif</code> Test Case</h3>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="n">test</span><span class="w"> </span><span class="n">run</span>
<span class="n">target</span><span class="w"> </span><span class="n">x86_64</span>
<span class="n">target</span><span class="w"> </span><span class="n">aarch64</span>
<span class="n">target</span><span class="w"> </span><span class="n">s390x</span>

<span class="n">function</span><span class="w"> </span><span class="o">%</span><span class="n">a</span><span class="p">()</span><span class="w"> </span>-&gt; <span class="kt">f64</span> <span class="nc">system_v</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">ss0</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">explicit_slot</span><span class="w"> </span><span class="mi">69</span>

<span class="n">block0</span>:
    <span class="nc">v0</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">iconst</span><span class="p">.</span><span class="kt">i64</span><span class="w"> </span><span class="mi">0</span>
<span class="w">    </span><span class="n">stack_store</span><span class="p">.</span><span class="kt">i64</span><span class="w"> </span><span class="n">v0</span><span class="p">,</span><span class="w"> </span><span class="n">ss0</span><span class="o">+</span><span class="mi">20</span>
<span class="w">    </span><span class="n">stack_store</span><span class="p">.</span><span class="kt">i64</span><span class="w"> </span><span class="n">v0</span><span class="p">,</span><span class="w"> </span><span class="n">ss0</span><span class="o">+</span><span class="mi">28</span>
<span class="w">    </span><span class="n">stack_store</span><span class="p">.</span><span class="kt">i64</span><span class="w"> </span><span class="n">v0</span><span class="p">,</span><span class="w"> </span><span class="n">ss0</span><span class="o">+</span><span class="mi">36</span>

<span class="w">    </span><span class="n">v29</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">stack_load</span><span class="p">.</span><span class="n">f64x2</span><span class="w"> </span><span class="n">ss0</span><span class="o">+</span><span class="mi">23</span>
<span class="w">    </span><span class="n">v30</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">extractlane</span><span class="w"> </span><span class="n">v29</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">v30</span>
<span class="p">}</span>

<span class="p">;</span><span class="w"> </span><span class="n">run</span>: <span class="o">%</span><span class="n">a</span><span class="p">()</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mf">0.0</span>
</code></pre></div>
<h3>Steps to Reproduce</h3>
<ul>
<li><code>clif-util test ./the-above.clif</code></li>
</ul>
<h3>Expected Results</h3>
<p>The test to pass</p>
<h3>Actual Results</h3>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="w">    </span><span class="n">Finished</span><span class="w"> </span><span class="n">dev</span><span class="w"> </span><span class="p">[</span><span class="n">unoptimized</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">debuginfo</span><span class="p">]</span><span class="w"> </span><span class="n">target</span><span class="p">(</span><span class="n">s</span><span class="p">)</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="mf">0.25</span><span class="n">s</span>
<span class="w">     </span><span class="n">Running</span><span class="w"> </span><span class="err">`</span><span class="o">/</span><span class="n">home</span><span class="o">/</span><span class="n">afonso</span><span class="o">/</span><span class="n">git</span><span class="o">/</span><span class="n">wasmtime</span><span class="o">/</span><span class="n">target</span><span class="o">/</span><span class="n">debug</span><span class="o">/</span><span class="n">clif</span><span class="o">-</span><span class="n">util</span><span class="w"> </span><span class="n">test</span><span class="w"> </span><span class="p">.</span><span class="o">/</span><span class="n">lmao</span><span class="p">.</span><span class="n">clif</span><span class="err">`</span>
<span class="n">Segmentation</span><span class="w"> </span><span class="n">fault</span>
</code></pre></div>
<p>This passes on AArch64 and S390x.</p>
<h3>Versions and Environment</h3>
<p>Cranelift version or commit: main</p>
<p>Operating system: Linux</p>
<p>Architecture: x64</p>
<h3>Extra Info</h3>
<p>&lt;details&gt;<br>
&lt;summary&gt;Generated assembly:&lt;/summary&gt;</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="n">Disassembly</span><span class="w"> </span><span class="n">of</span><span class="w"> </span><span class="mi">60</span><span class="w"> </span><span class="n">bytes</span>:
   <span class="mi">0</span>:   <span class="mi">55</span><span class="w">                      </span><span class="n">pushq</span><span class="w">   </span><span class="o">%</span><span class="n">rbp</span>
<span class="w">   </span><span class="mi">1</span>:   <span class="mi">48</span><span class="w"> </span><span class="mi">89</span><span class="w"> </span><span class="n">e5</span><span class="w">                </span><span class="n">movq</span><span class="w">    </span><span class="o">%</span><span class="n">rsp</span><span class="p">,</span><span class="w"> </span><span class="o">%</span><span class="n">rbp</span>
<span class="w">   </span><span class="mi">4</span>:   <span class="mi">48</span><span class="w"> </span><span class="mi">83</span><span class="w"> </span><span class="n">ec</span><span class="w"> </span><span class="mi">50</span><span class="w">             </span><span class="n">subq</span><span class="w">    </span><span class="cp">$</span><span class="mh">0x50</span><span class="p">,</span><span class="w"> </span><span class="o">%</span><span class="n">rsp</span>
<span class="w">   </span><span class="mi">8</span>:   <span class="mi">4</span><span class="n">c</span><span class="w"> </span><span class="mi">8</span><span class="n">d</span><span class="w"> </span><span class="mi">54</span><span class="w"> </span><span class="mi">24</span><span class="w"> </span><span class="mi">14</span><span class="w">          </span><span class="n">leaq</span><span class="w">    </span><span class="mh">0x14</span><span class="p">(</span><span class="o">%</span><span class="n">rsp</span><span class="p">),</span><span class="w"> </span><span class="o">%</span><span class="n">r10</span>
<span class="w">   </span><span class="n">d</span>:   <span class="mi">4</span><span class="n">d</span><span class="w"> </span><span class="mi">31</span><span class="w"> </span><span class="n">db</span><span class="w">                </span><span class="n">xorq</span><span class="w">    </span><span class="o">%</span><span class="n">r11</span><span class="p">,</span><span class="w"> </span><span class="o">%</span><span class="n">r11</span>
<span class="w">  </span><span class="mi">10</span>:   <span class="mi">4</span><span class="n">d</span><span class="w"> </span><span class="mi">89</span><span class="w"> </span><span class="mi">1</span><span class="n">a</span><span class="w">                </span><span class="n">movq</span><span class="w">    </span><span class="o">%</span><span class="n">r11</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="o">%</span><span class="n">r10</span><span class="p">)</span>
<span class="w">  </span><span class="mi">13</span>:   <span class="mi">4</span><span class="n">c</span><span class="w"> </span><span class="mi">8</span><span class="n">d</span><span class="w"> </span><span class="mi">5</span><span class="n">c</span><span class="w"> </span><span class="mi">24</span><span class="w"> </span><span class="mi">1</span><span class="n">c</span><span class="w">          </span><span class="n">leaq</span><span class="w">    </span><span class="mh">0x1c</span><span class="p">(</span><span class="o">%</span><span class="n">rsp</span><span class="p">),</span><span class="w"> </span><span class="o">%</span><span class="n">r11</span>
<span class="w">  </span><span class="mi">18</span>:   <span class="mi">48</span><span class="w"> </span><span class="mi">31</span><span class="w"> </span><span class="n">f6</span><span class="w">                </span><span class="n">xorq</span><span class="w">    </span><span class="o">%</span><span class="n">rsi</span><span class="p">,</span><span class="w"> </span><span class="o">%</span><span class="n">rsi</span>
<span class="w">  </span><span class="mi">1</span><span class="n">b</span>:   <span class="mi">49</span><span class="w"> </span><span class="mi">89</span><span class="w"> </span><span class="mi">33</span><span class="w">                </span><span class="n">movq</span><span class="w">    </span><span class="o">%</span><span class="n">rsi</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="o">%</span><span class="n">r11</span><span class="p">)</span>
<span class="w">  </span><span class="mi">1</span><span class="n">e</span>:   <span class="mi">48</span><span class="w"> </span><span class="mi">8</span><span class="n">d</span><span class="w"> </span><span class="mi">74</span><span class="w"> </span><span class="mi">24</span><span class="w"> </span><span class="mi">24</span><span class="w">          </span><span class="n">leaq</span><span class="w">    </span><span class="mh">0x24</span><span class="p">(</span><span class="o">%</span><span class="n">rsp</span><span class="p">),</span><span class="w"> </span><span class="o">%</span><span class="n">rsi</span>
<span class="w">  </span><span class="mi">23</span>:   <span class="mi">48</span><span class="w"> </span><span class="mi">31</span><span class="w"> </span><span class="n">ff</span><span class="w">                </span><span class="n">xorq</span><span class="w">    </span><span class="o">%</span><span class="n">rdi</span><span class="p">,</span><span class="w"> </span><span class="o">%</span><span class="n">rdi</span>
<span class="w">  </span><span class="mi">26</span>:   <span class="mi">48</span><span class="w"> </span><span class="mi">89</span><span class="w"> </span><span class="mi">3</span><span class="n">e</span><span class="w">                </span><span class="n">movq</span><span class="w">    </span><span class="o">%</span><span class="n">rdi</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="o">%</span><span class="n">rsi</span><span class="p">)</span>
<span class="w">  </span><span class="mi">29</span>:   <span class="mi">48</span><span class="w"> </span><span class="mi">8</span><span class="n">d</span><span class="w"> </span><span class="mi">7</span><span class="n">c</span><span class="w"> </span><span class="mi">24</span><span class="w"> </span><span class="mi">17</span><span class="w">          </span><span class="n">leaq</span><span class="w">    </span><span class="mh">0x17</span><span class="p">(</span><span class="o">%</span><span class="n">rsp</span><span class="p">),</span><span class="w"> </span><span class="o">%</span><span class="n">rdi</span>
<span class="w">  </span><span class="mi">2</span><span class="n">e</span>:   <span class="mi">66</span><span class="w"> </span><span class="mi">0</span><span class="n">f</span><span class="w"> </span><span class="mi">70</span><span class="w"> </span><span class="mi">07</span><span class="w"> </span><span class="n">ee</span><span class="w">          </span><span class="n">pshufd</span><span class="w">  </span><span class="cp">$</span><span class="mh">0xee</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="o">%</span><span class="n">rdi</span><span class="p">),</span><span class="w"> </span><span class="o">%</span><span class="n">xmm0</span>
<span class="w">  </span><span class="mi">33</span>:   <span class="mi">48</span><span class="w"> </span><span class="mi">83</span><span class="w"> </span><span class="n">c4</span><span class="w"> </span><span class="mi">50</span><span class="w">             </span><span class="n">addq</span><span class="w">    </span><span class="cp">$</span><span class="mh">0x50</span><span class="p">,</span><span class="w"> </span><span class="o">%</span><span class="n">rsp</span>
<span class="w">  </span><span class="mi">37</span>:   <span class="mi">48</span><span class="w"> </span><span class="mi">89</span><span class="w"> </span><span class="n">ec</span><span class="w">                </span><span class="n">movq</span><span class="w">    </span><span class="o">%</span><span class="n">rbp</span><span class="p">,</span><span class="w"> </span><span class="o">%</span><span class="n">rsp</span>
<span class="w">  </span><span class="mi">3</span><span class="n">a</span>:   <span class="mi">5</span><span class="n">d</span><span class="w">                      </span><span class="n">popq</span><span class="w">    </span><span class="o">%</span><span class="n">rbp</span>
<span class="w">  </span><span class="mi">3</span><span class="n">b</span>:   <span class="nc">c3</span><span class="w">                      </span><span class="n">retq</span>
</code></pre></div>
<p>&lt;/details&gt;<br>
</p>
</blockquote>



<a name="339411618"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%235922%20Cranelift%3A%20Segfault%20with%20unaligned.../near/339411618" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.235922.20Cranelift.3A.20Segfault.20with.20unaligned.2E.2E.2E.html#339411618">(Mar 03 2023 at 18:03)</a>:</h4>
<p>bjorn3 <a href="https://github.com/bytecodealliance/wasmtime/issues/5922#issuecomment-1453900455">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/5922">issue #5922</a>:</p>
<blockquote>
<p>I think cg_clif can emit unaligned stack_load and stack_store instructions. I can change it if the consensus is that unaligned accesses are not allowed.</p>
</blockquote>



<a name="339991808"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%235922%20Cranelift%3A%20Segfault%20with%20unaligned.../near/339991808" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.235922.20Cranelift.3A.20Segfault.20with.20unaligned.2E.2E.2E.html#339991808">(Mar 07 2023 at 00:04)</a>:</h4>
<p>jameysharp <a href="https://github.com/bytecodealliance/wasmtime/issues/5922#issuecomment-1457242467">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/5922">issue #5922</a>:</p>
<blockquote>
<p>As far as I can tell, Wasmtime doesn't use Cranelift's explicit stack support. So I think cg_clif gets to have a particularly large say on this question.</p>
<p>My personal opinion is the StackLoad and StackStore formats ought to have a MemFlags so the frontend can decide this question for itself. I think there's room in both formats without making <code>InstructionData</code> any larger.</p>
<p>If not that, I think at least that legalization should stop generating the <code>aligned</code> flag: since these instructions allow arbitrary offsets, it makes sense to me that someone might ask for unaligned offsets. I think the <code>notrap</code> flag is okay though?</p>
</blockquote>



<a name="340038054"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%235922%20Cranelift%3A%20Segfault%20with%20unaligned.../near/340038054" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.235922.20Cranelift.3A.20Segfault.20with.20unaligned.2E.2E.2E.html#340038054">(Mar 07 2023 at 07:45)</a>:</h4>
<p>bjorn3 <a href="https://github.com/bytecodealliance/wasmtime/issues/5922#issuecomment-1457699985">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/5922">issue #5922</a>:</p>
<blockquote>
<blockquote>
<p>I think the notrap flag is okay though?</p>
</blockquote>
<p>I agree. The stack should never be unmapped. For stack overflow there is stack probing.</p>
<blockquote>
<p>If not that, I think at least that legalization should stop generating the aligned flag: since these instructions allow arbitrary offsets, it makes sense to me that someone might ask for unaligned offsets.</p>
</blockquote>
<p>It will need to be possible to specify the alignment of a stack slot. Currently they are 1 aligned, except if you ensure that every stack slot is a multiple of 16, you get 16 aligned stack slots on all current backends. As such I do this in cg_clif as workaround for the lack of alignment specification support. If alignment specification is added to stack slots, Cranelift could infer if a <code>stack_load</code> or <code>stack_store</code> is aligned based on the stack slot alignment and the offset within the stack slot.</p>
</blockquote>



<a name="340070444"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%235922%20Cranelift%3A%20Segfault%20with%20unaligned.../near/340070444" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.235922.20Cranelift.3A.20Segfault.20with.20unaligned.2E.2E.2E.html#340070444">(Mar 07 2023 at 10:29)</a>:</h4>
<p>afonso360 <a href="https://github.com/bytecodealliance/wasmtime/issues/5922#issuecomment-1457926624">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/5922">issue #5922</a>:</p>
<blockquote>
<blockquote>
<p>My personal opinion is the StackLoad and StackStore formats ought to have a MemFlags so the frontend can decide this question for itself. I think there's room in both formats without making InstructionData any larger.</p>
</blockquote>
<p>This is also nice for cross endian <code>stack_{load,store}</code>s. They currently have to be manually emitted as <code>stack_addr</code>+<code>{load,store}</code> since we always pick the native endianness. And it removes one source of the native endianness flags.</p>
<p>Also, can we do something like #4721 to these instructions? Instead of having them magically translated in Cranelift, just build them as regular loads/stores in the frontend. One less Instruction Format to deal with!</p>
<blockquote>
<p>It will need to be possible to specify the alignment of a stack slot. Currently they are 1 aligned, except if you ensure that every stack slot is a multiple of 16, you get 16 aligned stack slots on all current backends. As such I do this in cg_clif as workaround for the lack of alignment specification support. If alignment specification is added to stack slots, Cranelift could infer if a stack_load or stack_store is aligned based on the stack slot alignment and the offset within the stack slot.</p>
</blockquote>
<p>Another issue that the fuzzer found  is that even with a load without an offset if the stack slot is unaligned it can fault. Since we always align stack slots to 8 bytes, that is not enough for SSE, we get a crash there.</p>
<p>Adding an alignment field to stack slots seems like a great idea to me! I think I might have to do that before finishing up the work on the SIMD part of the fuzzer. Otherwise I'll have to start tracking the alignment of the whole stack which I don't really want to do.</p>
</blockquote>



<a name="340085624"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%235922%20Cranelift%3A%20Segfault%20with%20unaligned.../near/340085624" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.235922.20Cranelift.3A.20Segfault.20with.20unaligned.2E.2E.2E.html#340085624">(Mar 07 2023 at 11:40)</a>:</h4>
<p>afonso360 edited a <a href="https://github.com/bytecodealliance/wasmtime/issues/5922#issuecomment-1457926624">comment</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/5922">issue #5922</a>:</p>
<blockquote>
<blockquote>
<p>My personal opinion is the StackLoad and StackStore formats ought to have a MemFlags so the frontend can decide this question for itself. I think there's room in both formats without making InstructionData any larger.</p>
</blockquote>
<p>This is also nice for cross endian <code>stack_{load,store}</code>s. They currently have to be manually emitted as <code>stack_addr</code>+<code>{load,store}</code> since we always pick the native endianness. And it removes one source of the native endianness flags.</p>
<p>Also, can we do something like #4721 to these instructions? Instead of having them magically translated in Cranelift, just build them as regular loads/stores in the frontend. One less Instruction Format to deal with!</p>
<blockquote>
<p>It will need to be possible to specify the alignment of a stack slot. Currently they are 1 aligned, except if you ensure that every stack slot is a multiple of 16, you get 16 aligned stack slots on all current backends. As such I do this in cg_clif as workaround for the lack of alignment specification support. If alignment specification is added to stack slots, Cranelift could infer if a stack_load or stack_store is aligned based on the stack slot alignment and the offset within the stack slot.</p>
</blockquote>
<p>Another issue that the fuzzer found  is that even with a load without an offset if the stack slot is unaligned it can fault. Since we always align stack slots to 8 bytes, that is not enough for SSE, we get a crash there.</p>
<p>Adding an alignment field to stack slots seems like a great idea to me! I think I might have to do that before finishing up the work on the SIMD part of the fuzzer (though that has a bunch of issues as well). Otherwise I'll have to start tracking the alignment of the whole stack which I don't really want to do.</p>
</blockquote>



<a name="340088560"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%235922%20Cranelift%3A%20Segfault%20with%20unaligned.../near/340088560" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.235922.20Cranelift.3A.20Segfault.20with.20unaligned.2E.2E.2E.html#340088560">(Mar 07 2023 at 11:53)</a>:</h4>
<p>afonso360 edited a <a href="https://github.com/bytecodealliance/wasmtime/issues/5922#issuecomment-1457926624">comment</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/5922">issue #5922</a>:</p>
<blockquote>
<blockquote>
<p>My personal opinion is the StackLoad and StackStore formats ought to have a MemFlags so the frontend can decide this question for itself. I think there's room in both formats without making InstructionData any larger.</p>
</blockquote>
<p>This is also nice for cross endian <code>stack_{load,store}</code>s. They currently have to be manually emitted as <code>stack_addr</code>+<code>{load,store}</code> since we always pick the native endianness. And it removes one source of the native endianness flags.</p>
<p>Also, can we do something like #4721 to these instructions? Instead of having them magically translated in Cranelift, just build them as regular loads/stores in the frontend. One less Instruction Format to deal with!</p>
<blockquote>
<p>It will need to be possible to specify the alignment of a stack slot. Currently they are 1 aligned, except if you ensure that every stack slot is a multiple of 16, you get 16 aligned stack slots on all current backends. As such I do this in cg_clif as workaround for the lack of alignment specification support. If alignment specification is added to stack slots, Cranelift could infer if a stack_load or stack_store is aligned based on the stack slot alignment and the offset within the stack slot.</p>
</blockquote>
<p>Another issue that the fuzzer found  is that even with a load without an offset if the stack slot is unaligned it can fault. Since we always align stack slots to 8 bytes, that is not enough for SSE, we get a crash there.</p>
<p>Adding an alignment field to stack slots seems like a great idea to me (though that has a bunch of issues as well)! I think I might have to do that before finishing up the work on the SIMD part of the fuzzer. Otherwise I'll have to start tracking the alignment of the whole stack which I don't really want to do.</p>
</blockquote>



<a name="340167496"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%235922%20Cranelift%3A%20Segfault%20with%20unaligned.../near/340167496" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.235922.20Cranelift.3A.20Segfault.20with.20unaligned.2E.2E.2E.html#340167496">(Mar 07 2023 at 17:23)</a>:</h4>
<p>jameysharp <a href="https://github.com/bytecodealliance/wasmtime/issues/5922#issuecomment-1458551778">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/5922">issue #5922</a>:</p>
<blockquote>
<p>I like the idea of removing the <code>stack_load</code> and <code>stack_store</code> instructions, and instead always pairing <code>stack_addr</code> with a regular <code>load</code> or <code>store</code>, for most of the same reasons as #5386. It nicely resolves the question of whether these instructions need a <code>MemFlags</code> operand, and was already necessary anyway if you wanted to use the narrowing stores or widening loads.</p>
<p>I think cranelift-fuzzgen might need to start remembering which variables hold addresses, along with metadata like whether it's a <code>func_addr</code> or <code>stack_addr</code> and, in the stack case, what minimum alignment and maximum offset it has. I haven't thought through the details. I hope there's a simpler approach than I've thought of so far.</p>
<p>I spent a moment thinking about whether <code>stack_addr</code> should be removed too before remembering that, unlike wasm heaps and tables, Cranelift really is responsible for the stack.</p>
<p>And yeah, adding alignment specifiers to stack slots makes sense to me. As a later memory-usage optimization maybe we can sort the stack slots (both explicit and spill) by alignment to minimize padding.</p>
</blockquote>



<a name="342138925"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%235922%20Cranelift%3A%20Segfault%20with%20unaligned.../near/342138925" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.235922.20Cranelift.3A.20Segfault.20with.20unaligned.2E.2E.2E.html#342138925">(Mar 15 2023 at 18:39)</a>:</h4>
<p>afonso360 closed <a href="https://github.com/bytecodealliance/wasmtime/issues/5922">issue #5922</a>:</p>
<blockquote>
<p><span aria-label="wave" class="emoji emoji-1f44b" role="img" title="wave">:wave:</span> Hey,</p>
<p>Me and @alexcrichton were discussing this via Zulip. The <code>stack_load</code> gets <a href="https://github.com/bytecodealliance/wasmtime/blob/3ff3994a128e900dfe7a465c7f36fc5a074d07ef/cranelift/codegen/src/legalizer/mod.rs#L85-L87">translated into</a> a <code>load.f64x2 notrap aligned v34</code>, and that's why we do the load sinking in the backend.</p>
<p>Is <code>stack_load</code> required to be sufficiently aligned? Reading the <a href="https://docs.rs/cranelift-codegen/latest/cranelift_codegen/ir/trait.InstBuilder.html#method.stack_load">docs</a>, they don't mention anything. So it might just be a case of lets update the docs and the fuzzer.</p>
<h3><code>.clif</code> Test Case</h3>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="n">test</span><span class="w"> </span><span class="n">run</span>
<span class="n">target</span><span class="w"> </span><span class="n">x86_64</span>
<span class="n">target</span><span class="w"> </span><span class="n">aarch64</span>
<span class="n">target</span><span class="w"> </span><span class="n">s390x</span>

<span class="n">function</span><span class="w"> </span><span class="o">%</span><span class="n">a</span><span class="p">()</span><span class="w"> </span>-&gt; <span class="kt">f64</span> <span class="nc">system_v</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">ss0</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">explicit_slot</span><span class="w"> </span><span class="mi">69</span>

<span class="n">block0</span>:
    <span class="nc">v0</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">iconst</span><span class="p">.</span><span class="kt">i64</span><span class="w"> </span><span class="mi">0</span>
<span class="w">    </span><span class="n">stack_store</span><span class="p">.</span><span class="kt">i64</span><span class="w"> </span><span class="n">v0</span><span class="p">,</span><span class="w"> </span><span class="n">ss0</span><span class="o">+</span><span class="mi">20</span>
<span class="w">    </span><span class="n">stack_store</span><span class="p">.</span><span class="kt">i64</span><span class="w"> </span><span class="n">v0</span><span class="p">,</span><span class="w"> </span><span class="n">ss0</span><span class="o">+</span><span class="mi">28</span>
<span class="w">    </span><span class="n">stack_store</span><span class="p">.</span><span class="kt">i64</span><span class="w"> </span><span class="n">v0</span><span class="p">,</span><span class="w"> </span><span class="n">ss0</span><span class="o">+</span><span class="mi">36</span>

<span class="w">    </span><span class="n">v29</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">stack_load</span><span class="p">.</span><span class="n">f64x2</span><span class="w"> </span><span class="n">ss0</span><span class="o">+</span><span class="mi">23</span>
<span class="w">    </span><span class="n">v30</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">extractlane</span><span class="w"> </span><span class="n">v29</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">v30</span>
<span class="p">}</span>

<span class="p">;</span><span class="w"> </span><span class="n">run</span>: <span class="o">%</span><span class="n">a</span><span class="p">()</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mf">0.0</span>
</code></pre></div>
<h3>Steps to Reproduce</h3>
<ul>
<li><code>clif-util test ./the-above.clif</code></li>
</ul>
<h3>Expected Results</h3>
<p>The test to pass</p>
<h3>Actual Results</h3>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="w">    </span><span class="n">Finished</span><span class="w"> </span><span class="n">dev</span><span class="w"> </span><span class="p">[</span><span class="n">unoptimized</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">debuginfo</span><span class="p">]</span><span class="w"> </span><span class="n">target</span><span class="p">(</span><span class="n">s</span><span class="p">)</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="mf">0.25</span><span class="n">s</span>
<span class="w">     </span><span class="n">Running</span><span class="w"> </span><span class="err">`</span><span class="o">/</span><span class="n">home</span><span class="o">/</span><span class="n">afonso</span><span class="o">/</span><span class="n">git</span><span class="o">/</span><span class="n">wasmtime</span><span class="o">/</span><span class="n">target</span><span class="o">/</span><span class="n">debug</span><span class="o">/</span><span class="n">clif</span><span class="o">-</span><span class="n">util</span><span class="w"> </span><span class="n">test</span><span class="w"> </span><span class="p">.</span><span class="o">/</span><span class="n">lmao</span><span class="p">.</span><span class="n">clif</span><span class="err">`</span>
<span class="n">Segmentation</span><span class="w"> </span><span class="n">fault</span>
</code></pre></div>
<p>This passes on AArch64 and S390x.</p>
<h3>Versions and Environment</h3>
<p>Cranelift version or commit: main</p>
<p>Operating system: Linux</p>
<p>Architecture: x64</p>
<h3>Extra Info</h3>
<p>&lt;details&gt;<br>
&lt;summary&gt;Generated assembly:&lt;/summary&gt;</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="n">Disassembly</span><span class="w"> </span><span class="n">of</span><span class="w"> </span><span class="mi">60</span><span class="w"> </span><span class="n">bytes</span>:
   <span class="mi">0</span>:   <span class="mi">55</span><span class="w">                      </span><span class="n">pushq</span><span class="w">   </span><span class="o">%</span><span class="n">rbp</span>
<span class="w">   </span><span class="mi">1</span>:   <span class="mi">48</span><span class="w"> </span><span class="mi">89</span><span class="w"> </span><span class="n">e5</span><span class="w">                </span><span class="n">movq</span><span class="w">    </span><span class="o">%</span><span class="n">rsp</span><span class="p">,</span><span class="w"> </span><span class="o">%</span><span class="n">rbp</span>
<span class="w">   </span><span class="mi">4</span>:   <span class="mi">48</span><span class="w"> </span><span class="mi">83</span><span class="w"> </span><span class="n">ec</span><span class="w"> </span><span class="mi">50</span><span class="w">             </span><span class="n">subq</span><span class="w">    </span><span class="cp">$</span><span class="mh">0x50</span><span class="p">,</span><span class="w"> </span><span class="o">%</span><span class="n">rsp</span>
<span class="w">   </span><span class="mi">8</span>:   <span class="mi">4</span><span class="n">c</span><span class="w"> </span><span class="mi">8</span><span class="n">d</span><span class="w"> </span><span class="mi">54</span><span class="w"> </span><span class="mi">24</span><span class="w"> </span><span class="mi">14</span><span class="w">          </span><span class="n">leaq</span><span class="w">    </span><span class="mh">0x14</span><span class="p">(</span><span class="o">%</span><span class="n">rsp</span><span class="p">),</span><span class="w"> </span><span class="o">%</span><span class="n">r10</span>
<span class="w">   </span><span class="n">d</span>:   <span class="mi">4</span><span class="n">d</span><span class="w"> </span><span class="mi">31</span><span class="w"> </span><span class="n">db</span><span class="w">                </span><span class="n">xorq</span><span class="w">    </span><span class="o">%</span><span class="n">r11</span><span class="p">,</span><span class="w"> </span><span class="o">%</span><span class="n">r11</span>
<span class="w">  </span><span class="mi">10</span>:   <span class="mi">4</span><span class="n">d</span><span class="w"> </span><span class="mi">89</span><span class="w"> </span><span class="mi">1</span><span class="n">a</span><span class="w">                </span><span class="n">movq</span><span class="w">    </span><span class="o">%</span><span class="n">r11</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="o">%</span><span class="n">r10</span><span class="p">)</span>
<span class="w">  </span><span class="mi">13</span>:   <span class="mi">4</span><span class="n">c</span><span class="w"> </span><span class="mi">8</span><span class="n">d</span><span class="w"> </span><span class="mi">5</span><span class="n">c</span><span class="w"> </span><span class="mi">24</span><span class="w"> </span><span class="mi">1</span><span class="n">c</span><span class="w">          </span><span class="n">leaq</span><span class="w">    </span><span class="mh">0x1c</span><span class="p">(</span><span class="o">%</span><span class="n">rsp</span><span class="p">),</span><span class="w"> </span><span class="o">%</span><span class="n">r11</span>
<span class="w">  </span><span class="mi">18</span>:   <span class="mi">48</span><span class="w"> </span><span class="mi">31</span><span class="w"> </span><span class="n">f6</span><span class="w">                </span><span class="n">xorq</span><span class="w">    </span><span class="o">%</span><span class="n">rsi</span><span class="p">,</span><span class="w"> </span><span class="o">%</span><span class="n">rsi</span>
<span class="w">  </span><span class="mi">1</span><span class="n">b</span>:   <span class="mi">49</span><span class="w"> </span><span class="mi">89</span><span class="w"> </span><span class="mi">33</span><span class="w">                </span><span class="n">movq</span><span class="w">    </span><span class="o">%</span><span class="n">rsi</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="o">%</span><span class="n">r11</span><span class="p">)</span>
<span class="w">  </span><span class="mi">1</span><span class="n">e</span>:   <span class="mi">48</span><span class="w"> </span><span class="mi">8</span><span class="n">d</span><span class="w"> </span><span class="mi">74</span><span class="w"> </span><span class="mi">24</span><span class="w"> </span><span class="mi">24</span><span class="w">          </span><span class="n">leaq</span><span class="w">    </span><span class="mh">0x24</span><span class="p">(</span><span class="o">%</span><span class="n">rsp</span><span class="p">),</span><span class="w"> </span><span class="o">%</span><span class="n">rsi</span>
<span class="w">  </span><span class="mi">23</span>:   <span class="mi">48</span><span class="w"> </span><span class="mi">31</span><span class="w"> </span><span class="n">ff</span><span class="w">                </span><span class="n">xorq</span><span class="w">    </span><span class="o">%</span><span class="n">rdi</span><span class="p">,</span><span class="w"> </span><span class="o">%</span><span class="n">rdi</span>
<span class="w">  </span><span class="mi">26</span>:   <span class="mi">48</span><span class="w"> </span><span class="mi">89</span><span class="w"> </span><span class="mi">3</span><span class="n">e</span><span class="w">                </span><span class="n">movq</span><span class="w">    </span><span class="o">%</span><span class="n">rdi</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="o">%</span><span class="n">rsi</span><span class="p">)</span>
<span class="w">  </span><span class="mi">29</span>:   <span class="mi">48</span><span class="w"> </span><span class="mi">8</span><span class="n">d</span><span class="w"> </span><span class="mi">7</span><span class="n">c</span><span class="w"> </span><span class="mi">24</span><span class="w"> </span><span class="mi">17</span><span class="w">          </span><span class="n">leaq</span><span class="w">    </span><span class="mh">0x17</span><span class="p">(</span><span class="o">%</span><span class="n">rsp</span><span class="p">),</span><span class="w"> </span><span class="o">%</span><span class="n">rdi</span>
<span class="w">  </span><span class="mi">2</span><span class="n">e</span>:   <span class="mi">66</span><span class="w"> </span><span class="mi">0</span><span class="n">f</span><span class="w"> </span><span class="mi">70</span><span class="w"> </span><span class="mi">07</span><span class="w"> </span><span class="n">ee</span><span class="w">          </span><span class="n">pshufd</span><span class="w">  </span><span class="cp">$</span><span class="mh">0xee</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="o">%</span><span class="n">rdi</span><span class="p">),</span><span class="w"> </span><span class="o">%</span><span class="n">xmm0</span>
<span class="w">  </span><span class="mi">33</span>:   <span class="mi">48</span><span class="w"> </span><span class="mi">83</span><span class="w"> </span><span class="n">c4</span><span class="w"> </span><span class="mi">50</span><span class="w">             </span><span class="n">addq</span><span class="w">    </span><span class="cp">$</span><span class="mh">0x50</span><span class="p">,</span><span class="w"> </span><span class="o">%</span><span class="n">rsp</span>
<span class="w">  </span><span class="mi">37</span>:   <span class="mi">48</span><span class="w"> </span><span class="mi">89</span><span class="w"> </span><span class="n">ec</span><span class="w">                </span><span class="n">movq</span><span class="w">    </span><span class="o">%</span><span class="n">rbp</span><span class="p">,</span><span class="w"> </span><span class="o">%</span><span class="n">rsp</span>
<span class="w">  </span><span class="mi">3</span><span class="n">a</span>:   <span class="mi">5</span><span class="n">d</span><span class="w">                      </span><span class="n">popq</span><span class="w">    </span><span class="o">%</span><span class="n">rbp</span>
<span class="w">  </span><span class="mi">3</span><span class="n">b</span>:   <span class="nc">c3</span><span class="w">                      </span><span class="n">retq</span>
</code></pre></div>
<p>&lt;/details&gt;<br>
</p>
</blockquote>



<hr><p>Last updated: Jan 20 2025 at 06:04 UTC</p>
</html>