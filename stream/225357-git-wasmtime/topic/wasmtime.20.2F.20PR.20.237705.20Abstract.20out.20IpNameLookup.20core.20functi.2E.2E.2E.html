<html>
<head><meta charset="utf-8"><title>wasmtime / PR #7705 Abstract out IpNameLookup core functi... · git-wasmtime · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/index.html">git-wasmtime</a></h2>
<h3>Topic: <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.237705.20Abstract.20out.20IpNameLookup.20core.20functi.2E.2E.2E.html">wasmtime / PR #7705 Abstract out IpNameLookup core functi...</a></h3>

<hr>

<base href="https://bytecodealliance.zulipchat.com">

<head><link href="https://bytecodealliance.github.io/zulip-archive/style.css" rel="stylesheet"></head>

<a name="408960844"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%237705%20Abstract%20out%20IpNameLookup%20core%20functi.../near/408960844" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.237705.20Abstract.20out.20IpNameLookup.20core.20functi.2E.2E.2E.html#408960844">(Dec 19 2023 at 15:48)</a>:</h4>
<p>rylev opened <a href="https://github.com/bytecodealliance/wasmtime/pull/7705">PR #7705</a> from <code>rylev:lookup-override</code> to <code>bytecodealliance:main</code>:</p>
<blockquote>
<p>This follows the design outlined in <a href="https://github.com/bytecodealliance/wasmtime/issues/7681">bytecodealliance/wasmtime#7681</a> for IpNameLookup.</p>
<p>A new trait <code>IpNameLookup</code> is introduced that factors out the conversion from a <code>String</code> to a list of IP addresses. Another trait, <code>WasiIpNameLookupView</code> is used to configure which concrete type that implements <code>IpNameLookup</code> will be used in the actual IpNameLookup host implementation. Lastly. the <code>SystemIpNameLookup</code> is provided as a default implementation.</p>
<p>Some questions that might guide tweaks:</p>
<ul>
<li>Users are now forced to implement <code>WasiIpNameLookupView</code> - it would be nice if there was a to default to the built in <code>SystemIpNameLookup</code>. If there were default associated types for traits, we could get rid of <code>WasiIpNameLookupView</code> and make <code>ip_name_lookup</code> a function on <code>WasiView</code> that defaults to the the <code>SystemIpNameLookup</code>.  But alas that's not available to us.</li>
</ul>
</blockquote>



<a name="408960845"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%237705%20Abstract%20out%20IpNameLookup%20core%20functi.../near/408960845" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.237705.20Abstract.20out.20IpNameLookup.20core.20functi.2E.2E.2E.html#408960845">(Dec 19 2023 at 15:48)</a>:</h4>
<p><strong>rylev</strong> requested <a href="https://github.com/alexcrichton">alexcrichton</a> for a review on <a href="https://github.com/bytecodealliance/wasmtime/pull/7705">PR #7705</a>.</p>



<a name="408960846"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%237705%20Abstract%20out%20IpNameLookup%20core%20functi.../near/408960846" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.237705.20Abstract.20out.20IpNameLookup.20core.20functi.2E.2E.2E.html#408960846">(Dec 19 2023 at 15:48)</a>:</h4>
<p><strong>rylev</strong> requested <a href="https://github.com/orgs/bytecodealliance/teams/wasmtime-core-reviewers">wasmtime-core-reviewers</a> for a review on <a href="https://github.com/bytecodealliance/wasmtime/pull/7705">PR #7705</a>.</p>



<a name="408960899"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%237705%20Abstract%20out%20IpNameLookup%20core%20functi.../near/408960899" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.237705.20Abstract.20out.20IpNameLookup.20core.20functi.2E.2E.2E.html#408960899">(Dec 19 2023 at 15:49)</a>:</h4>
<p>rylev edited <a href="https://github.com/bytecodealliance/wasmtime/pull/7705">PR #7705</a>:</p>
<blockquote>
<p>This follows the design outlined in <a href="https://github.com/bytecodealliance/wasmtime/issues/7681">bytecodealliance/wasmtime#7681</a> for IpNameLookup.</p>
<p>A new trait <code>IpNameLookup</code> is introduced that factors out the conversion from a <code>String</code> to a list of IP addresses. Another trait, <code>WasiIpNameLookupView</code> is used to configure which concrete type that implements <code>IpNameLookup</code> will be used in the actual IpNameLookup host implementation. Lastly. the <code>SystemIpNameLookup</code> is provided as a default implementation.</p>
<p>Some questions that might guide tweaks:</p>
<ul>
<li>Users are now forced to implement <code>WasiIpNameLookupView</code> - it would be nice if there was a to default to the built in <code>SystemIpNameLookup</code>. If there were default associated types for traits, we could get rid of <code>WasiIpNameLookupView</code> and make <code>ip_name_lookup</code> a function on <code>WasiView</code> that defaults to the the <code>SystemIpNameLookup</code>.  But alas that's not available to us.</li>
</ul>
<p>r? @badeend </p>
</blockquote>



<a name="408963123"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%237705%20Abstract%20out%20IpNameLookup%20core%20functi.../near/408963123" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.237705.20Abstract.20out.20IpNameLookup.20core.20functi.2E.2E.2E.html#408963123">(Dec 19 2023 at 16:00)</a>:</h4>
<p>badeend submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/7705#pullrequestreview-1789211337">PR review</a>.</p>



<a name="408963125"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%237705%20Abstract%20out%20IpNameLookup%20core%20functi.../near/408963125" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.237705.20Abstract.20out.20IpNameLookup.20core.20functi.2E.2E.2E.html#408963125">(Dec 19 2023 at 16:00)</a>:</h4>
<p>badeend created <a href="https://github.com/bytecodealliance/wasmtime/pull/7705#discussion_r1431617259">PR review comment</a>:</p>
<blockquote>
<p>With these changes, can <code>network.allow_ip_name_lookup</code> now be removed?</p>
</blockquote>



<a name="408964031"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%237705%20Abstract%20out%20IpNameLookup%20core%20functi.../near/408964031" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.237705.20Abstract.20out.20IpNameLookup.20core.20functi.2E.2E.2E.html#408964031">(Dec 19 2023 at 16:04)</a>:</h4>
<p>badeend submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/7705#pullrequestreview-1789219350">PR review</a>.</p>



<a name="408964032"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%237705%20Abstract%20out%20IpNameLookup%20core%20functi.../near/408964032" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.237705.20Abstract.20out.20IpNameLookup.20core.20functi.2E.2E.2E.html#408964032">(Dec 19 2023 at 16:04)</a>:</h4>
<p>badeend created <a href="https://github.com/bytecodealliance/wasmtime/pull/7705#discussion_r1431623299">PR review comment</a>:</p>
<blockquote>
<p>I'm curious; why isn't <code>resolve_addresses</code> placed directly  on <code>WasiIpNameLookupView</code>? Is there something the extra indirection buys us?</p>
</blockquote>



<a name="408964955"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%237705%20Abstract%20out%20IpNameLookup%20core%20functi.../near/408964955" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.237705.20Abstract.20out.20IpNameLookup.20core.20functi.2E.2E.2E.html#408964955">(Dec 19 2023 at 16:08)</a>:</h4>
<p>rylev submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/7705#pullrequestreview-1789231387">PR review</a>.</p>



<a name="408964956"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%237705%20Abstract%20out%20IpNameLookup%20core%20functi.../near/408964956" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.237705.20Abstract.20out.20IpNameLookup.20core.20functi.2E.2E.2E.html#408964956">(Dec 19 2023 at 16:08)</a>:</h4>
<p>rylev created <a href="https://github.com/bytecodealliance/wasmtime/pull/7705#discussion_r1431631597">PR review comment</a>:</p>
<blockquote>
<p>It could be potentially. Right now the default is to not allow ip name lookups, so if we remove this, the default will flip. Additionally, the new way to turn off name lookups would be through a trait implementation (i.e., <code>impl IpNameLookup for BlockedIpNameLookup</code> or similar) and not through <code>WasiCtx</code>/<code>WasiCtxBuilder</code>.</p>
<p>Though it's probably somewhat confusing to implement <code>WasiIpNameLookupView</code> and then not have name lookups work because you forgot to flip the bit on <code>WasiCtx</code>.</p>
<p>Perhaps we remove the <code>allow_ip_name_lookup</code> and provide an additional implementation of <code>IpNameLookup</code>: <code>BlockedIpNameLookup</code> so that users can easily turn off IP name lookup if they like. Thoughts?</p>
</blockquote>



<a name="408965220"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%237705%20Abstract%20out%20IpNameLookup%20core%20functi.../near/408965220" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.237705.20Abstract.20out.20IpNameLookup.20core.20functi.2E.2E.2E.html#408965220">(Dec 19 2023 at 16:10)</a>:</h4>
<p>rylev submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/7705#pullrequestreview-1789233847">PR review</a>.</p>



<a name="408965222"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%237705%20Abstract%20out%20IpNameLookup%20core%20functi.../near/408965222" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.237705.20Abstract.20out.20IpNameLookup.20core.20functi.2E.2E.2E.html#408965222">(Dec 19 2023 at 16:10)</a>:</h4>
<p>rylev created <a href="https://github.com/bytecodealliance/wasmtime/pull/7705#discussion_r1431633230">PR review comment</a>:</p>
<blockquote>
<p>I'm not sure it gives a ton given that we initialize the type that implements <code>IpNameLookup</code> right before we call <code>resolve_addresses</code>. The reason I initially went this direction is that it mirrors how the UDP and TCP implementations will work. I can remove it though. Shall I?</p>
</blockquote>



<a name="408966293"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%237705%20Abstract%20out%20IpNameLookup%20core%20functi.../near/408966293" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.237705.20Abstract.20out.20IpNameLookup.20core.20functi.2E.2E.2E.html#408966293">(Dec 19 2023 at 16:15)</a>:</h4>
<p>rylev updated <a href="https://github.com/bytecodealliance/wasmtime/pull/7705">PR #7705</a>.</p>



<a name="408970411"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%237705%20Abstract%20out%20IpNameLookup%20core%20functi.../near/408970411" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.237705.20Abstract.20out.20IpNameLookup.20core.20functi.2E.2E.2E.html#408970411">(Dec 19 2023 at 16:38)</a>:</h4>
<p>badeend submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/7705#pullrequestreview-1789294758">PR review</a>.</p>



<a name="408970412"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%237705%20Abstract%20out%20IpNameLookup%20core%20functi.../near/408970412" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.237705.20Abstract.20out.20IpNameLookup.20core.20functi.2E.2E.2E.html#408970412">(Dec 19 2023 at 16:38)</a>:</h4>
<p>badeend created <a href="https://github.com/bytecodealliance/wasmtime/pull/7705#discussion_r1431672946">PR review comment</a>:</p>
<blockquote>
<p>Hmm. Interesting.<br>
I think the WASI translation layer (<code>preview2/ip_name_lookup.rs</code> in this case) should only depend on a single source of truth: <code>WasiIpNameLookupView</code>. It should not _also_ go peeking into <code>network.allow_ip_name_lookup</code> on its own.</p>
<p>It might be an idea to provide an additional implementation of <code>IpNameLookup</code> based on <code>WasiCtx</code>, that dynamically checks <code>allowed_network_uses</code>. This could supersede the <code>BlockedIpNameLookup</code> you suggested<br>
</p>
</blockquote>



<a name="408975468"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%237705%20Abstract%20out%20IpNameLookup%20core%20functi.../near/408975468" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.237705.20Abstract.20out.20IpNameLookup.20core.20functi.2E.2E.2E.html#408975468">(Dec 19 2023 at 16:50)</a>:</h4>
<p>badeend submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/7705#pullrequestreview-1789319344">PR review</a>.</p>



<a name="408975470"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%237705%20Abstract%20out%20IpNameLookup%20core%20functi.../near/408975470" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.237705.20Abstract.20out.20IpNameLookup.20core.20functi.2E.2E.2E.html#408975470">(Dec 19 2023 at 16:50)</a>:</h4>
<p>badeend created <a href="https://github.com/bytecodealliance/wasmtime/pull/7705#discussion_r1431687644">PR review comment</a>:</p>
<blockquote>
<p>Alright. Was just curious.<br>
No strong preference</p>
</blockquote>



<a name="408984083"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%237705%20Abstract%20out%20IpNameLookup%20core%20functi.../near/408984083" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.237705.20Abstract.20out.20IpNameLookup.20core.20functi.2E.2E.2E.html#408984083">(Dec 19 2023 at 17:28)</a>:</h4>
<p>rylev submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/7705#pullrequestreview-1789387990">PR review</a>.</p>



<a name="408984085"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%237705%20Abstract%20out%20IpNameLookup%20core%20functi.../near/408984085" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.237705.20Abstract.20out.20IpNameLookup.20core.20functi.2E.2E.2E.html#408984085">(Dec 19 2023 at 17:28)</a>:</h4>
<p>rylev created <a href="https://github.com/bytecodealliance/wasmtime/pull/7705#discussion_r1431731216">PR review comment</a>:</p>
<blockquote>
<p>This does have the downside that the WasiCtx setting can be ignored by users. If their implementation of <code>IpNameLookup</code> doesn't check for <code>allowed_network_uses</code>, that option will simply be ignored. I guess it seems fine that the user can ignore that option (they're the ones setting it anyway), but it does seem somewhat error prone.  </p>
</blockquote>



<a name="408984165"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%237705%20Abstract%20out%20IpNameLookup%20core%20functi.../near/408984165" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.237705.20Abstract.20out.20IpNameLookup.20core.20functi.2E.2E.2E.html#408984165">(Dec 19 2023 at 17:28)</a>:</h4>
<p>rylev edited <a href="https://github.com/bytecodealliance/wasmtime/pull/7705#discussion_r1431731216">PR review comment</a>.</p>



<a name="408984189"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%237705%20Abstract%20out%20IpNameLookup%20core%20functi.../near/408984189" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.237705.20Abstract.20out.20IpNameLookup.20core.20functi.2E.2E.2E.html#408984189">(Dec 19 2023 at 17:28)</a>:</h4>
<p>rylev updated <a href="https://github.com/bytecodealliance/wasmtime/pull/7705">PR #7705</a>.</p>



<a name="408991576"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%237705%20Abstract%20out%20IpNameLookup%20core%20functi.../near/408991576" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.237705.20Abstract.20out.20IpNameLookup.20core.20functi.2E.2E.2E.html#408991576">(Dec 19 2023 at 18:16)</a>:</h4>
<p>badeend <a href="https://github.com/bytecodealliance/wasmtime/pull/7705#issuecomment-1863265128">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/7705">PR #7705</a>:</p>
<blockquote>
<p>All in all, looks good to me <span aria-label="rocket" class="emoji emoji-1f680" role="img" title="rocket">:rocket:</span> </p>
</blockquote>



<a name="409001285"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%237705%20Abstract%20out%20IpNameLookup%20core%20functi.../near/409001285" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.237705.20Abstract.20out.20IpNameLookup.20core.20functi.2E.2E.2E.html#409001285">(Dec 19 2023 at 19:20)</a>:</h4>
<p>rylev updated <a href="https://github.com/bytecodealliance/wasmtime/pull/7705">PR #7705</a>.</p>



<a name="411189741"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%237705%20Abstract%20out%20IpNameLookup%20core%20functi.../near/411189741" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.237705.20Abstract.20out.20IpNameLookup.20core.20functi.2E.2E.2E.html#411189741">(Jan 04 2024 at 13:32)</a>:</h4>
<p>rylev updated <a href="https://github.com/bytecodealliance/wasmtime/pull/7705">PR #7705</a>.</p>



<a name="411192252"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%237705%20Abstract%20out%20IpNameLookup%20core%20functi.../near/411192252" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.237705.20Abstract.20out.20IpNameLookup.20core.20functi.2E.2E.2E.html#411192252">(Jan 04 2024 at 13:51)</a>:</h4>
<p>rylev <a href="https://github.com/bytecodealliance/wasmtime/pull/7705#issuecomment-1877127068">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/7705">PR #7705</a>:</p>
<blockquote>
<p>@badeend @alexcrichton </p>
<p>I've moved the implementation towards having a single <code>WasiNetworkView</code> trait where all network based overrides will be implemented. I'm happier with this solution than the previous <code>IpNameLookupView</code> version, but I'm still not convinced we've arrived at a good solution. </p>
<p>The current solution has the following charactertistics:</p>
<ul>
<li>Two new methods on <code>WasiView</code>: <code>network_view</code> and <code>network_view_mut</code> which return references to a <code>dyn WasiNetworkView</code><ul>
<li>This prevents all the methods necessarily being on <code>WasiView</code> which might get crowded over time. It also makes it easy for users who want to use an off-the-shelf solution to get implement 2 methods instead of the N methods <code>WasiNetworkView</code> will have.</li>
<li>The use of dynamic dispatch is new to WasiView but seems appropriate here.</li>
</ul>
</li>
<li>The various implementors in Wasmtime of <code>WasiView</code> gain a new field with <code>SystemNetwork</code> (the default implementation of  <code>WasiNetworkView</code>)</li>
</ul>
<p>I would said, we move forward with this for now and we can adjust as we add TCP and UDP support (and of course continue to evolve over time). Thoughts?</p>
</blockquote>



<a name="411225595"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%237705%20Abstract%20out%20IpNameLookup%20core%20functi.../near/411225595" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.237705.20Abstract.20out.20IpNameLookup.20core.20functi.2E.2E.2E.html#411225595">(Jan 04 2024 at 16:53)</a>:</h4>
<p>alexcrichton submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/7705#pullrequestreview-1804605051">PR review</a>.</p>



<a name="411225596"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%237705%20Abstract%20out%20IpNameLookup%20core%20functi.../near/411225596" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.237705.20Abstract.20out.20IpNameLookup.20core.20functi.2E.2E.2E.html#411225596">(Jan 04 2024 at 16:53)</a>:</h4>
<p>alexcrichton submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/7705#pullrequestreview-1804605051">PR review</a>.</p>



<a name="411225597"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%237705%20Abstract%20out%20IpNameLookup%20core%20functi.../near/411225597" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.237705.20Abstract.20out.20IpNameLookup.20core.20functi.2E.2E.2E.html#411225597">(Jan 04 2024 at 16:53)</a>:</h4>
<p>alexcrichton created <a href="https://github.com/bytecodealliance/wasmtime/pull/7705#discussion_r1442025675">PR review comment</a>:</p>
<blockquote>
<p>This might be best to model as an <code>async</code> function rather than returning an <code>AbortOnDropJoinHandle</code>?</p>
</blockquote>



<a name="411225598"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%237705%20Abstract%20out%20IpNameLookup%20core%20functi.../near/411225598" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.237705.20Abstract.20out.20IpNameLookup.20core.20functi.2E.2E.2E.html#411225598">(Jan 04 2024 at 16:53)</a>:</h4>
<p>alexcrichton created <a href="https://github.com/bytecodealliance/wasmtime/pull/7705#discussion_r1442026887">PR review comment</a>:</p>
<blockquote>
<p>(then it might be neat to have default implementations of <code>fn network_view</code> perhaps?)</p>
</blockquote>



<a name="411225599"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%237705%20Abstract%20out%20IpNameLookup%20core%20functi.../near/411225599" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.237705.20Abstract.20out.20IpNameLookup.20core.20functi.2E.2E.2E.html#411225599">(Jan 04 2024 at 16:53)</a>:</h4>
<p>alexcrichton created <a href="https://github.com/bytecodealliance/wasmtime/pull/7705#discussion_r1442026522">PR review comment</a>:</p>
<blockquote>
<p>Could this perhaps manifest as a <code>impl WasiNetworkView for WasiCtx</code> to avoid a second type?</p>
</blockquote>



<a name="411233190"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%237705%20Abstract%20out%20IpNameLookup%20core%20functi.../near/411233190" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.237705.20Abstract.20out.20IpNameLookup.20core.20functi.2E.2E.2E.html#411233190">(Jan 04 2024 at 17:42)</a>:</h4>
<p>rylev submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/7705#pullrequestreview-1804689412">PR review</a>.</p>



<a name="411233191"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%237705%20Abstract%20out%20IpNameLookup%20core%20functi.../near/411233191" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.237705.20Abstract.20out.20IpNameLookup.20core.20functi.2E.2E.2E.html#411233191">(Jan 04 2024 at 17:42)</a>:</h4>
<p>rylev created <a href="https://github.com/bytecodealliance/wasmtime/pull/7705#discussion_r1442077093">PR review comment</a>:</p>
<blockquote>
<p>This is indeed very annoying... The value returned from <code>resolve_address</code> must be <code>Send + Sync</code> as it is used in <code>ResolveAddressStream</code> which impls <code>Subscribe</code> which requires the type implementing it to be <code>Send + Sync</code>.</p>
<p>The <code>#[async_trait]</code> macro puts a <code>Send</code> bound on the return type but not <code>Sync</code> and there is no way to instruct it to do so. We could move to using <code>Box&lt;dyn Future&gt;</code> but that means we loose the developer experience of <code>async_trait</code>. We could potentially move to using <code>impl Future</code> but that requires the latest version of Rust, and I'm not sure if that's ok.</p>
</blockquote>



<a name="411234948"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%237705%20Abstract%20out%20IpNameLookup%20core%20functi.../near/411234948" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.237705.20Abstract.20out.20IpNameLookup.20core.20functi.2E.2E.2E.html#411234948">(Jan 04 2024 at 17:55)</a>:</h4>
<p>rylev updated <a href="https://github.com/bytecodealliance/wasmtime/pull/7705">PR #7705</a>.</p>



<a name="411234985"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%237705%20Abstract%20out%20IpNameLookup%20core%20functi.../near/411234985" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.237705.20Abstract.20out.20IpNameLookup.20core.20functi.2E.2E.2E.html#411234985">(Jan 04 2024 at 17:55)</a>:</h4>
<p>rylev submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/7705#pullrequestreview-1804708783">PR review</a>.</p>



<a name="411234987"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%237705%20Abstract%20out%20IpNameLookup%20core%20functi.../near/411234987" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.237705.20Abstract.20out.20IpNameLookup.20core.20functi.2E.2E.2E.html#411234987">(Jan 04 2024 at 17:55)</a>:</h4>
<p>rylev created <a href="https://github.com/bytecodealliance/wasmtime/pull/7705#discussion_r1442088533">PR review comment</a>:</p>
<blockquote>
<p>Great idea!</p>
</blockquote>



<a name="411239047"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%237705%20Abstract%20out%20IpNameLookup%20core%20functi.../near/411239047" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.237705.20Abstract.20out.20IpNameLookup.20core.20functi.2E.2E.2E.html#411239047">(Jan 04 2024 at 18:23)</a>:</h4>
<p>rylev updated <a href="https://github.com/bytecodealliance/wasmtime/pull/7705">PR #7705</a>.</p>



<a name="411256614"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%237705%20Abstract%20out%20IpNameLookup%20core%20functi.../near/411256614" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.237705.20Abstract.20out.20IpNameLookup.20core.20functi.2E.2E.2E.html#411256614">(Jan 04 2024 at 20:28)</a>:</h4>
<p>alexcrichton submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/7705#pullrequestreview-1804917202">PR review</a>.</p>



<a name="411256615"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%237705%20Abstract%20out%20IpNameLookup%20core%20functi.../near/411256615" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.237705.20Abstract.20out.20IpNameLookup.20core.20functi.2E.2E.2E.html#411256615">(Jan 04 2024 at 20:28)</a>:</h4>
<p>alexcrichton submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/7705#pullrequestreview-1804917202">PR review</a>.</p>



<a name="411256616"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%237705%20Abstract%20out%20IpNameLookup%20core%20functi.../near/411256616" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.237705.20Abstract.20out.20IpNameLookup.20core.20functi.2E.2E.2E.html#411256616">(Jan 04 2024 at 20:28)</a>:</h4>
<p>alexcrichton created <a href="https://github.com/bytecodealliance/wasmtime/pull/7705#discussion_r1442216672">PR review comment</a>:</p>
<blockquote>
<p>Could this be removed in lieu of implementing <code>WasiNetworkView for WasiCtx</code> itself? (given that <code>WasiCtx</code> is needed to create this structure anyway it may not buy a whole lot)</p>
</blockquote>



<a name="411256617"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%237705%20Abstract%20out%20IpNameLookup%20core%20functi.../near/411256617" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.237705.20Abstract.20out.20IpNameLookup.20core.20functi.2E.2E.2E.html#411256617">(Jan 04 2024 at 20:28)</a>:</h4>
<p>alexcrichton created <a href="https://github.com/bytecodealliance/wasmtime/pull/7705#discussion_r1442222783">PR review comment</a>:</p>
<blockquote>
<p>Hm that's true, and yeah I see how there's no great way to manage this right now.</p>
<p>I suppose this can stay for now, but I'm still worried that this will inevitably cause some pain down the road. The best alternative I can think of is to return a <code>oneshot::Receiver&lt;T&gt;</code> instead but that's still pretty cumbersome to work with and wouldn't work great here.</p>
</blockquote>



<a name="411351483"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%237705%20Abstract%20out%20IpNameLookup%20core%20functi.../near/411351483" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.237705.20Abstract.20out.20IpNameLookup.20core.20functi.2E.2E.2E.html#411351483">(Jan 05 2024 at 11:18)</a>:</h4>
<p>rylev submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/7705#pullrequestreview-1805768647">PR review</a>.</p>



<a name="411351484"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%237705%20Abstract%20out%20IpNameLookup%20core%20functi.../near/411351484" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.237705.20Abstract.20out.20IpNameLookup.20core.20functi.2E.2E.2E.html#411351484">(Jan 05 2024 at 11:18)</a>:</h4>
<p>rylev created <a href="https://github.com/bytecodealliance/wasmtime/pull/7705#discussion_r1442758209">PR review comment</a>:</p>
<blockquote>
<p>We could take a page out of <code>WasiHttpView</code>'s playbook and have the function return a <code>wasmtime::Result&lt;Resource&lt;ResolveAddressStream&gt;&gt;</code> just like <code>WasiHttpView::send_request</code> returns a <code>wasmtime::Result&lt;Resource&lt;HostFutureIncomingResponse&gt;&gt;</code>. I don't really love this either, but at least it's consistent?</p>
</blockquote>



<a name="411351870"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%237705%20Abstract%20out%20IpNameLookup%20core%20functi.../near/411351870" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.237705.20Abstract.20out.20IpNameLookup.20core.20functi.2E.2E.2E.html#411351870">(Jan 05 2024 at 11:21)</a>:</h4>
<p>rylev submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/7705#pullrequestreview-1805772400">PR review</a>.</p>



<a name="411351871"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%237705%20Abstract%20out%20IpNameLookup%20core%20functi.../near/411351871" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.237705.20Abstract.20out.20IpNameLookup.20core.20functi.2E.2E.2E.html#411351871">(Jan 05 2024 at 11:21)</a>:</h4>
<p>rylev created <a href="https://github.com/bytecodealliance/wasmtime/pull/7705#discussion_r1442760647">PR review comment</a>:</p>
<blockquote>
<p>If a user wants to have some logic where they conditionally switch between either their own network implementation and <code>SystemNetwork</code>, they need some way of constructing the <code>SystemNetwork</code>. Without this constructor, they would not be able to do so. We could do the following: </p>
<ul>
<li>make all fields of <code>SystemNetwork</code> public</li>
<li>Make the constructor just take a simple <code>bool</code> instead of a <code>WasiCtx</code></li>
<li>Leave it as is</li>
</ul>
<p>I think I'd be most in favor of the last two options.</p>
</blockquote>



<a name="411505844"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%237705%20Abstract%20out%20IpNameLookup%20core%20functi.../near/411505844" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.237705.20Abstract.20out.20IpNameLookup.20core.20functi.2E.2E.2E.html#411505844">(Jan 06 2024 at 12:53)</a>:</h4>
<p>badeend <a href="https://github.com/bytecodealliance/wasmtime/pull/7705#issuecomment-1879673755">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/7705">PR #7705</a>:</p>
<blockquote>
<p>Having thought about it some more I would like to offer one more suggestion. See code below.<br>
This touches multiple discussions above, so tagging @alexcrichton.</p>
<p>The main difference is that this setup doesn't modify WasiView at all, but instead dispatches through WasiCtx::network</p>
<hr>
<blockquote>
<p>@rylev: This does have the downside that the WasiCtx setting can be ignored by users.</p>
</blockquote>
<p>In setup below that can't happen.</p>
<hr>
<p>The strict separation between the "System<em>" and "Default</em>" structs below might be overkill for this PR because of the relative trivial "System<em>" and "Default</em>" implementations. However, for TCP/UDP sockets the implementation won't be so trivial anymore.</p>
<p><div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="sd">/// Trait for any WASI-compliant network implementation.</span>
<span class="k">trait</span><span class="w"> </span><span class="n">Network</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">fn</span> <span class="nf">resolve_addresses</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="bp">self</span><span class="p">,</span><span class="w"> </span><span class="p">)</span><span class="w"> </span>-&gt; <span class="o">..</span><span class="p">.;</span>

<span class="w">    </span><span class="c1">// fn new_tcp_socket(family) -&gt; ...</span>
<span class="w">    </span><span class="c1">// fn new_udp_socket(family) -&gt; ...</span>
<span class="p">}</span>




<span class="sd">/// A WASI-compliant "base" implementation.</span>
<span class="sd">/// Without any opinions on how to do filtering, permission checks or whatever.</span>
<span class="k">struct</span> <span class="nc">SystemNetwork</span><span class="w"> </span><span class="p">{}</span>
<span class="k">impl</span><span class="w"> </span><span class="n">SystemNetwork</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">fn</span> <span class="nf">new</span><span class="p">()</span><span class="w"> </span>-&gt; <span class="nc">Self</span><span class="w"> </span><span class="p">{}</span><span class="w"> </span><span class="c1">// Probably no parameters</span>
<span class="p">}</span>
<span class="k">impl</span><span class="w"> </span><span class="n">Network</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">SystemNetwork</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">fn</span> <span class="nf">resolve_addresses</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="bp">self</span><span class="p">,</span><span class="w"> </span><span class="p">)</span><span class="w"> </span>-&gt; <span class="p">{</span>
<span class="w">        </span><span class="c1">// Perform the syscalls without any additional permission checks</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>




<span class="sd">/// A "good enough" default implementation for Wasmtime users, _with_ permission checks.</span>
<span class="k">struct</span> <span class="nc">DefaultNetwork</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">sys</span>: <span class="nc">SystemNetwork</span><span class="p">,</span>
<span class="w">    </span><span class="n">allowed</span>: <span class="kt">bool</span>
<span class="p">}</span>
<span class="k">impl</span><span class="w"> </span><span class="n">DefaultNetwork</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="sd">/// Whatever parameters we want.</span>
<span class="w">    </span><span class="sd">/// Currently just a simple boolean, but could be extended to any</span>
<span class="w">    </span><span class="k">fn</span> <span class="nf">new</span><span class="p">(</span><span class="n">allowed</span>: <span class="kt">bool</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nc">Self</span><span class="w"> </span><span class="p">{}</span>
<span class="p">}</span>
<span class="k">impl</span><span class="w"> </span><span class="n">Network</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">DefaultNetwork</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">fn</span> <span class="nf">resolve_addresses</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="bp">self</span><span class="p">,</span><span class="w"> </span><span class="p">)</span><span class="w"> </span>-&gt; <span class="p">{</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="bp">self</span><span class="p">.</span><span class="n">allowed</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="bp">self</span><span class="p">.</span><span class="n">sys</span><span class="p">.</span><span class="n">resolve_addresses</span><span class="p">()</span>
<span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="nb">Err</span><span class="p">(</span><span class="n">PermissionDenied</span><span class="p">)</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>



<span class="k">pub</span><span class="w"> </span><span class="k">struct</span> <span class="nc">WasiCtx</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">pub</span><span class="p">(</span><span class="k">crate</span><span class="p">)</span><span class="w"> </span><span class="n">random</span>: <span class="nb">Box</span><span class="o">&lt;</span><span class="k">dyn</span><span class="w"> </span><span class="n">RngCore</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nb">Send</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nb">Sync</span><span class="o">&gt;</span><span class="p">,</span>
<span class="w">    </span><span class="k">pub</span><span class="p">(</span><span class="k">crate</span><span class="p">)</span><span class="w"> </span><span class="n">insecure_random</span>: <span class="nb">Box</span><span class="o">&lt;</span><span class="k">dyn</span><span class="w"> </span><span class="n">RngCore</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nb">Send</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nb">Sync</span><span class="o">&gt;</span><span class="p">,</span>
<span class="w">    </span><span class="k">pub</span><span class="p">(</span><span class="k">crate</span><span class="p">)</span><span class="w"> </span><span class="n">insecure_random_seed</span>: <span class="kt">u128</span><span class="p">,</span>
<span class="w">    </span><span class="k">pub</span><span class="p">(</span><span class="k">crate</span><span class="p">)</span><span class="w"> </span><span class="n">wall_clock</span>: <span class="nb">Box</span><span class="o">&lt;</span><span class="k">dyn</span><span class="w"> </span><span class="n">HostWallClock</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nb">Send</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nb">Sync</span><span class="o">&gt;</span><span class="p">,</span>
<span class="w">    </span><span class="k">pub</span><span class="p">(</span><span class="k">crate</span><span class="p">)</span><span class="w"> </span><span class="n">monotonic_clock</span>: <span class="nb">Box</span><span class="o">&lt;</span><span class="k">dyn</span><span class="w"> </span><span class="n">HostMonotonicClock</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nb">Send</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nb">Sync</span><span class="o">&gt;</span><span class="p">,</span>
<span class="w">    </span><span class="k">pub</span><span class="p">(</span><span class="k">crate</span><span class="p">)</span><span class="w"> </span><span class="n">env</span>: <span class="nb">Vec</span><span class="o">&lt;</span><span class="p">(</span><span class="nb">String</span><span class="p">,</span><span class="w"> </span><span class="nb">String</span><span class="p">)</span><span class="o">&gt;</span><span class="p">,</span>
<span class="w">    </span><span class="k">pub</span><span class="p">(</span><span class="k">crate</span><span class="p">)</span><span class="w"> </span><span class="n">args</span>: <span class="nb">Vec</span><span class="o">&lt;</span><span class="nb">String</span><span class="o">&gt;</span><span class="p">,</span>
<span class="w">    </span><span class="k">pub</span><span class="p">(</span><span class="k">crate</span><span class="p">)</span><span class="w"> </span><span class="n">preopens</span>: <span class="nb">Vec</span><span class="o">&lt;</span><span class="p">(</span><span class="n">Dir</span><span class="p">,</span><span class="w"> </span><span class="nb">String</span><span class="p">)</span><span class="o">&gt;</span><span class="p">,</span>
<span class="w">    </span><span class="k">pub</span><span class="p">(</span><span class="k">crate</span><span class="p">)</span><span class="w"> </span><span class="n">stdin</span>: <span class="nb">Box</span><span class="o">&lt;</span><span class="k">dyn</span><span class="w"> </span><span class="n">StdinStream</span><span class="o">&gt;</span><span class="p">,</span>
<span class="w">    </span><span class="k">pub</span><span class="p">(</span><span class="k">crate</span><span class="p">)</span><span class="w"> </span><span class="n">stdout</span>: <span class="nb">Box</span><span class="o">&lt;</span><span class="k">dyn</span><span class="w"> </span><span class="n">StdoutStream</span><span class="o">&gt;</span><span class="p">,</span>
<span class="w">    </span><span class="k">pub</span><span class="p">(</span><span class="k">crate</span><span class="p">)</span><span class="w"> </span><span class="n">stderr</span>: <span class="nb">Box</span><span class="o">&lt;</span><span class="k">dyn</span><span class="w"> </span><span class="n">StdoutStream</span><span class="o">&gt;</span><span class="p">,</span>

<span class="w">    </span><span class="c1">// Remove `socket_addr_check`</span>
<span class="w">    </span><span class="c1">// Remove `allowed_network_uses`</span>

<span class="w">    </span><span class="c1">// Add:</span>
<span class="w">    </span><span class="k">pub</span><span class="p">(</span><span class="k">crate</span><span class="p">)</span><span class="w"> </span><span class="n">network</span>: <span class="nb">Box</span><span class="o">&lt;</span><span class="k">dyn</span><span class="w"> </span><span class="n">Network</span><span class="o">&gt;</span><span class="p">,</span>
<span class="p">}</span>





<span class="k">pub</span><span class="w"> </span><span class="k">struct</span> <span class="nc">WasiCtxBuilder</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="c1">// (...)</span>

<span class="w">    </span><span class="n">network</span>: <span class="nb">Box</span><span class="o">&lt;</span><span class="k">dyn</span><span class="w"> </span><span class="n">Network</span><span class="o">&gt;</span><span class="p">,</span>
<span class="p">}</span>
<span class="k">impl</span><span class="w"> </span><span class="n">WasiCtxBuilder</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="k">fn</span> <span class="nf">new</span><span class="p">()</span><span class="w"> </span>-&gt; <span class="nc">Self</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="bp">Self</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="c1">// (...)</span>
<span class="w">            </span><span class="n">network</span>: <span class="nc">DefaultNetwork</span>::<span class="n">new</span><span class="p">(</span><span class="cm">/*allowed: */</span><span class="kc">false</span><span class="p">),</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="k">fn</span> <span class="nf">allow_network</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="bp">self</span><span class="p">,</span><span class="w"> </span><span class="n">enable</span>: <span class="kt">bool</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="kp">&amp;</span><span class="nc">mut</span><span class="w"> </span><span class="bp">Self</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="bp">self</span><span class="p">.</span><span class="n">network</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">DefaultNetwork</span>::<span class="n">new</span><span class="p">(</span><span class="n">enable</span><span class="p">);</span>
<span class="w">        </span><span class="bp">self</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="k">fn</span> <span class="nf">custom_network</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="bp">self</span><span class="p">,</span><span class="w"> </span><span class="n">net</span>: <span class="nb">Box</span><span class="o">&lt;</span><span class="k">dyn</span><span class="w"> </span><span class="n">Network</span><span class="o">&gt;</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="kp">&amp;</span><span class="nc">mut</span><span class="w"> </span><span class="bp">Self</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="bp">self</span><span class="p">.</span><span class="n">network</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">net</span><span class="p">;</span>
<span class="w">        </span><span class="bp">self</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div><br>
</p>
</blockquote>



<a name="411517707"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%237705%20Abstract%20out%20IpNameLookup%20core%20functi.../near/411517707" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.237705.20Abstract.20out.20IpNameLookup.20core.20functi.2E.2E.2E.html#411517707">(Jan 06 2024 at 16:02)</a>:</h4>
<p>badeend submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/7705#pullrequestreview-1807498021">PR review</a>.</p>



<a name="411517708"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%237705%20Abstract%20out%20IpNameLookup%20core%20functi.../near/411517708" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.237705.20Abstract.20out.20IpNameLookup.20core.20functi.2E.2E.2E.html#411517708">(Jan 06 2024 at 16:02)</a>:</h4>
<p>badeend created <a href="https://github.com/bytecodealliance/wasmtime/pull/7705#discussion_r1443792308">PR review comment</a>:</p>
<blockquote>
<p>Of all the options mentioned so far, the <code>Box&lt;dyn Future&gt;</code> route seems the least worst to me.</p>
<p>The fact that we currently use a quick&amp;dirty implementation using spawn_blocking should be an implementation detail of <code>SystemNetwork</code></p>
</blockquote>



<a name="411766411"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%237705%20Abstract%20out%20IpNameLookup%20core%20functi.../near/411766411" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.237705.20Abstract.20out.20IpNameLookup.20core.20functi.2E.2E.2E.html#411766411">(Jan 08 2024 at 15:55)</a>:</h4>
<p>alexcrichton submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/7705#pullrequestreview-1809458214">PR review</a>.</p>



<a name="411766413"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%237705%20Abstract%20out%20IpNameLookup%20core%20functi.../near/411766413" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.237705.20Abstract.20out.20IpNameLookup.20core.20functi.2E.2E.2E.html#411766413">(Jan 08 2024 at 15:55)</a>:</h4>
<p>alexcrichton created <a href="https://github.com/bytecodealliance/wasmtime/pull/7705#discussion_r1444888757">PR review comment</a>:</p>
<blockquote>
<p>Returning a <code>Resource&lt;ResolveAddressStream&gt;</code> would be nice yeah but it seems like that would have all the same design questions around "how do you actually create one of those". </p>
<p>Although as I say that we could perhaps get around <code>async trait</code> by having something like <code>fn from_future&lt;T: Future + Send + Sync + 'static&gt; (...)</code> on the <code>ResolveAddressStream</code> type. That way you could pass an <code>async</code> block which would have bounds generated correctly and additioanlly the handle from <code>spawn_blocking</code> could also be passed in? That way we might be able to avoid async traits altogether and rely entirely on that.</p>
</blockquote>



<a name="411766859"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%237705%20Abstract%20out%20IpNameLookup%20core%20functi.../near/411766859" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.237705.20Abstract.20out.20IpNameLookup.20core.20functi.2E.2E.2E.html#411766859">(Jan 08 2024 at 15:57)</a>:</h4>
<p>alexcrichton submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/7705#pullrequestreview-1809466247">PR review</a>.</p>



<a name="411766861"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%237705%20Abstract%20out%20IpNameLookup%20core%20functi.../near/411766861" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.237705.20Abstract.20out.20IpNameLookup.20core.20functi.2E.2E.2E.html#411766861">(Jan 08 2024 at 15:57)</a>:</h4>
<p>alexcrichton created <a href="https://github.com/bytecodealliance/wasmtime/pull/7705#discussion_r1444893080">PR review comment</a>:</p>
<blockquote>
<p>Hm I'm not sure I understand? Given <code>impl WasiNetworkView for WasiCtx</code> then if users are themselves implementing <code>WasiNetworkView</code> for their own custom type then conditionally using the default behavior would be calling <code>self.ctx.the_method_name()</code> so I'm not sure where the need for having this separate <code>SystemNetwork</code> structure arises?</p>
</blockquote>



<a name="411768054"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%237705%20Abstract%20out%20IpNameLookup%20core%20functi.../near/411768054" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.237705.20Abstract.20out.20IpNameLookup.20core.20functi.2E.2E.2E.html#411768054">(Jan 08 2024 at 16:02)</a>:</h4>
<p>alexcrichton <a href="https://github.com/bytecodealliance/wasmtime/pull/7705#issuecomment-1881361254">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/7705">PR #7705</a>:</p>
<blockquote>
<p>@badeend your sketch makes sense yeah, but my thoughts at <a href="https://github.com/bytecodealliance/wasmtime/issues/7694#issuecomment-1858351478">https://github.com/bytecodealliance/wasmtime/issues/7694#issuecomment-1858351478</a> showcase how something like that breaks down unless all callbacks about configuration go through <code>trait Network</code>, so for example we'd also need to route IP address checks through that trait as well. (not a problem of course, just pointing out that once things are behind a trait everything needs to be behind that trait to share state between callbacks).</p>
<p>Otherwise though I think it'd be reasonable to configure a trait object on <code>WasiCtx</code> vs returning a <code>&amp;mut dyn Trait</code> from <code>WasiView</code> (although it having a default impl returning <code>self.ctx_mut()</code> I think is pretty nifty and makes it almost hidden.</p>
</blockquote>



<a name="411770665"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%237705%20Abstract%20out%20IpNameLookup%20core%20functi.../near/411770665" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.237705.20Abstract.20out.20IpNameLookup.20core.20functi.2E.2E.2E.html#411770665">(Jan 08 2024 at 16:17)</a>:</h4>
<p>rylev submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/7705#pullrequestreview-1809520776">PR review</a>.</p>



<a name="411770666"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%237705%20Abstract%20out%20IpNameLookup%20core%20functi.../near/411770666" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.237705.20Abstract.20out.20IpNameLookup.20core.20functi.2E.2E.2E.html#411770666">(Jan 08 2024 at 16:17)</a>:</h4>
<p>rylev created <a href="https://github.com/bytecodealliance/wasmtime/pull/7705#discussion_r1444938415">PR review comment</a>:</p>
<blockquote>
<p>Thinking about this more, returning <code>Resource&lt;ResolveAddressStream&gt;</code> would mean that the implementor would have to also implement <code>WasiCtx</code> or otherwise have multiple access to the <code>ResourceTable</code>. Right now we don't require that from the implementor of <code>WasiNetworkView</code>, and I'm not sure we want to.</p>
</blockquote>



<a name="411772253"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%237705%20Abstract%20out%20IpNameLookup%20core%20functi.../near/411772253" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.237705.20Abstract.20out.20IpNameLookup.20core.20functi.2E.2E.2E.html#411772253">(Jan 08 2024 at 16:25)</a>:</h4>
<p>rylev submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/7705#pullrequestreview-1809543737">PR review</a>.</p>



<a name="411772256"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%237705%20Abstract%20out%20IpNameLookup%20core%20functi.../near/411772256" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.237705.20Abstract.20out.20IpNameLookup.20core.20functi.2E.2E.2E.html#411772256">(Jan 08 2024 at 16:25)</a>:</h4>
<p>rylev created <a href="https://github.com/bytecodealliance/wasmtime/pull/7705#discussion_r1444957672">PR review comment</a>:</p>
<blockquote>
<p>You're right that <code>SystemNetwork</code> isn't strictly necessary. It felt nice to have a distinct type that lives in the <code>ip_name_lookup</code> module that can handle name lookups, but you're right that we can just implement that logic directly on <code>WasiCtx</code>. It does make the code a wee bit simpler.</p>
</blockquote>



<a name="411774107"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%237705%20Abstract%20out%20IpNameLookup%20core%20functi.../near/411774107" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.237705.20Abstract.20out.20IpNameLookup.20core.20functi.2E.2E.2E.html#411774107">(Jan 08 2024 at 16:35)</a>:</h4>
<p>alexcrichton submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/7705#pullrequestreview-1809568320">PR review</a>.</p>



<a name="411774109"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%237705%20Abstract%20out%20IpNameLookup%20core%20functi.../near/411774109" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.237705.20Abstract.20out.20IpNameLookup.20core.20functi.2E.2E.2E.html#411774109">(Jan 08 2024 at 16:35)</a>:</h4>
<p>alexcrichton created <a href="https://github.com/bytecodealliance/wasmtime/pull/7705#discussion_r1444975284">PR review comment</a>:</p>
<blockquote>
<p><code>ResolveAddressStream</code> itself could be returned though leaving the table management bits to the glue?</p>
</blockquote>



<a name="411783397"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%237705%20Abstract%20out%20IpNameLookup%20core%20functi.../near/411783397" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.237705.20Abstract.20out.20IpNameLookup.20core.20functi.2E.2E.2E.html#411783397">(Jan 08 2024 at 17:20)</a>:</h4>
<p>rylev <a href="https://github.com/bytecodealliance/wasmtime/pull/7705#issuecomment-1881513252">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/7705">PR #7705</a>:</p>
<blockquote>
<p>I like @badeend's suggestion. I initially shared the same concern that @alexcrichton pointed out, but I think it should be relatively easy for users to implement the <code>Network</code> trait by delegating all the parts they don't care about to <code>SystemNetwork</code> or <code>DefaultNetwork</code> and only changing what they do care about. The only issue I can see with this is that if the <code>Network</code> trait grows large (which I think we anticipate it will), then there will be a large amount of boiler plate of delegating <code>Network</code> methods to the <code>SystemNetwork</code> or <code>DefaultNetwork</code>. This could be really annoying. </p>
</blockquote>



<a name="411787306"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%237705%20Abstract%20out%20IpNameLookup%20core%20functi.../near/411787306" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.237705.20Abstract.20out.20IpNameLookup.20core.20functi.2E.2E.2E.html#411787306">(Jan 08 2024 at 17:38)</a>:</h4>
<p>rylev updated <a href="https://github.com/bytecodealliance/wasmtime/pull/7705">PR #7705</a>.</p>



<a name="411787543"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%237705%20Abstract%20out%20IpNameLookup%20core%20functi.../near/411787543" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.237705.20Abstract.20out.20IpNameLookup.20core.20functi.2E.2E.2E.html#411787543">(Jan 08 2024 at 17:40)</a>:</h4>
<p>rylev <a href="https://github.com/bytecodealliance/wasmtime/pull/7705#issuecomment-1881544128">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/7705">PR #7705</a>:</p>
<blockquote>
<p>@alexcrichton @badeend I've pushed a new change that moves more towards @badeend's design as well as changing the return type of <code>resolve_addresses</code> to be a <code>ResolveAddressStream</code>. </p>
<p>I think the only way for us to be sure about this design is to keep going and implement UDP and TCP on top of it. With that in mind, I think we should merge this PR and continue the design exploration in a follow up. Thoughts?</p>
</blockquote>



<a name="411807472"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%237705%20Abstract%20out%20IpNameLookup%20core%20functi.../near/411807472" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.237705.20Abstract.20out.20IpNameLookup.20core.20functi.2E.2E.2E.html#411807472">(Jan 08 2024 at 20:02)</a>:</h4>
<p>badeend <a href="https://github.com/bytecodealliance/wasmtime/pull/7705#issuecomment-1881739646">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/7705">PR #7705</a>:</p>
<blockquote>
<blockquote>
<p>something like that breaks down unless all callbacks about configuration go through trait Network, so for example we'd also need to route IP address checks through that trait as well.</p>
</blockquote>
<p>Correct. In my mind that was exactly the goal of this (and upcoming) PRs. <code>socket_addr_check</code> &amp; <code>allowed_network_uses</code> would most likely be moved to <code>DefaultNetwork</code></p>
<blockquote>
<p>I think the only way for us to be sure about this design is to keep going and implement UDP and TCP on top of it.</p>
</blockquote>
<p>Agree.</p>
<blockquote>
<p>With that in mind, I think we should merge this PR and continue the design exploration in a follow up. Thoughts?</p>
</blockquote>
<p>I'm not familiar with wasmtime's release process, but if a release gets cut partway through these changes it could be weird for consumers when e.g. IP lookup &amp; TCP use the Network trait but UDP still uses an old &amp; completely different customization mechanism. I'll leave this up for @alexcrichton <br>
</p>
</blockquote>



<a name="411957664"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%237705%20Abstract%20out%20IpNameLookup%20core%20functi.../near/411957664" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.237705.20Abstract.20out.20IpNameLookup.20core.20functi.2E.2E.2E.html#411957664">(Jan 09 2024 at 15:27)</a>:</h4>
<p>alexcrichton submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/7705#pullrequestreview-1811396829">PR review</a>:</p>
<blockquote>
<p>Looks reasonable to me!</p>
<p>Unless this is particularly urgent though I would personally agree with @badeend in that I'd prefer to see a more complete picture before landing if possible. If this is needed to unblock work I think it's ok to land, but if you're ok working with a fork for now though I think it'd be best to sketch out the other checks you're thinking of implementing to be able to see them altogether at once.</p>
</blockquote>



<a name="411957665"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%237705%20Abstract%20out%20IpNameLookup%20core%20functi.../near/411957665" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.237705.20Abstract.20out.20IpNameLookup.20core.20functi.2E.2E.2E.html#411957665">(Jan 09 2024 at 15:27)</a>:</h4>
<p>alexcrichton submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/7705#pullrequestreview-1811396829">PR review</a>:</p>
<blockquote>
<p>Looks reasonable to me!</p>
<p>Unless this is particularly urgent though I would personally agree with @badeend in that I'd prefer to see a more complete picture before landing if possible. If this is needed to unblock work I think it's ok to land, but if you're ok working with a fork for now though I think it'd be best to sketch out the other checks you're thinking of implementing to be able to see them altogether at once.</p>
</blockquote>



<a name="411957667"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%237705%20Abstract%20out%20IpNameLookup%20core%20functi.../near/411957667" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.237705.20Abstract.20out.20IpNameLookup.20core.20functi.2E.2E.2E.html#411957667">(Jan 09 2024 at 15:27)</a>:</h4>
<p>alexcrichton created <a href="https://github.com/bytecodealliance/wasmtime/pull/7705#discussion_r1446237092">PR review comment</a>:</p>
<blockquote>
<p>I think the <code>+ Sized</code> may not be necessary here?</p>
</blockquote>



<a name="411975746"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%237705%20Abstract%20out%20IpNameLookup%20core%20functi.../near/411975746" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.237705.20Abstract.20out.20IpNameLookup.20core.20functi.2E.2E.2E.html#411975746">(Jan 09 2024 at 17:00)</a>:</h4>
<p>rylev <a href="https://github.com/bytecodealliance/wasmtime/pull/7705#issuecomment-1883435908">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/7705">PR #7705</a>:</p>
<blockquote>
<p>I'm fine with not landing this on main. I just think we need to decide which fork/branch is the integration point so that if @badeend and I continue the work, we can bring that all together into one unified branch that will ultimately be merged into main. </p>
</blockquote>



<a name="413106791"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%237705%20Abstract%20out%20IpNameLookup%20core%20functi.../near/413106791" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.237705.20Abstract.20out.20IpNameLookup.20core.20functi.2E.2E.2E.html#413106791">(Jan 16 2024 at 08:54)</a>:</h4>
<p>rylev updated <a href="https://github.com/bytecodealliance/wasmtime/pull/7705">PR #7705</a>.</p>



<hr><p>Last updated: Jan 20 2025 at 06:04 UTC</p>
</html>