<html>
<head><meta charset="utf-8"><title>wasmtime / PR #9697 cranelift-entity: Add optional suppor... · git-wasmtime · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/index.html">git-wasmtime</a></h2>
<h3>Topic: <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.239697.20cranelift-entity.3A.20Add.20optional.20suppor.2E.2E.2E.html">wasmtime / PR #9697 cranelift-entity: Add optional suppor...</a></h3>

<hr>

<base href="https://bytecodealliance.zulipchat.com">

<head><link href="https://bytecodealliance.github.io/zulip-archive/style.css" rel="stylesheet"></head>

<a name="485429938"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%239697%20cranelift-entity%3A%20Add%20optional%20suppor.../near/485429938" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.239697.20cranelift-entity.3A.20Add.20optional.20suppor.2E.2E.2E.html#485429938">(Nov 30 2024 at 23:44)</a>:</h4>
<p>caelunshun opened <a href="https://github.com/bytecodealliance/wasmtime/pull/9697">PR #9697</a> from <code>caelunshun:cranelift-entity-bytemuck</code> to <code>bytecodealliance:main</code>:</p>
<blockquote>
<p>Adds optional implementations of <code>Pod</code> and <code>Zeroable</code> for <code>EntityList</code> and <code>PackedOption</code>.</p>
<p>This helps avoid some unsafe code in my downstream crates. </p>
</blockquote>



<a name="485429939"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%239697%20cranelift-entity%3A%20Add%20optional%20suppor.../near/485429939" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.239697.20cranelift-entity.3A.20Add.20optional.20suppor.2E.2E.2E.html#485429939">(Nov 30 2024 at 23:44)</a>:</h4>
<p><strong>caelunshun</strong> requested <a href="https://github.com/abrown">abrown</a> for a review on <a href="https://github.com/bytecodealliance/wasmtime/pull/9697">PR #9697</a>.</p>



<a name="485429940"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%239697%20cranelift-entity%3A%20Add%20optional%20suppor.../near/485429940" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.239697.20cranelift-entity.3A.20Add.20optional.20suppor.2E.2E.2E.html#485429940">(Nov 30 2024 at 23:44)</a>:</h4>
<p><strong>caelunshun</strong> requested <a href="https://github.com/orgs/bytecodealliance/teams/wasmtime-compiler-reviewers">wasmtime-compiler-reviewers</a> for a review on <a href="https://github.com/bytecodealliance/wasmtime/pull/9697">PR #9697</a>.</p>



<a name="485429941"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%239697%20cranelift-entity%3A%20Add%20optional%20suppor.../near/485429941" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.239697.20cranelift-entity.3A.20Add.20optional.20suppor.2E.2E.2E.html#485429941">(Nov 30 2024 at 23:44)</a>:</h4>
<p><strong>caelunshun</strong> requested <a href="https://github.com/orgs/bytecodealliance/teams/wasmtime-default-reviewers">wasmtime-default-reviewers</a> for a review on <a href="https://github.com/bytecodealliance/wasmtime/pull/9697">PR #9697</a>.</p>



<a name="485430236"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%239697%20cranelift-entity%3A%20Add%20optional%20suppor.../near/485430236" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.239697.20cranelift-entity.3A.20Add.20optional.20suppor.2E.2E.2E.html#485430236">(Nov 30 2024 at 23:49)</a>:</h4>
<p>caelunshun updated <a href="https://github.com/bytecodealliance/wasmtime/pull/9697">PR #9697</a>.</p>



<a name="485682857"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%239697%20cranelift-entity%3A%20Add%20optional%20suppor.../near/485682857" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.239697.20cranelift-entity.3A.20Add.20optional.20suppor.2E.2E.2E.html#485682857">(Dec 02 2024 at 18:15)</a>:</h4>
<p>abrown <a href="https://github.com/bytecodealliance/wasmtime/pull/9697#issuecomment-2512333800">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/9697">PR #9697</a>:</p>
<blockquote>
<p>@cfallin, you want to take this review?</p>
</blockquote>



<a name="485683407"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%239697%20cranelift-entity%3A%20Add%20optional%20suppor.../near/485683407" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.239697.20cranelift-entity.3A.20Add.20optional.20suppor.2E.2E.2E.html#485683407">(Dec 02 2024 at 18:19)</a>:</h4>
<p><strong>cfallin</strong> requested <a href="https://github.com/cfallin">cfallin</a> for a review on <a href="https://github.com/bytecodealliance/wasmtime/pull/9697">PR #9697</a>.</p>



<a name="485683423"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%239697%20cranelift-entity%3A%20Add%20optional%20suppor.../near/485683423" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.239697.20cranelift-entity.3A.20Add.20optional.20suppor.2E.2E.2E.html#485683423">(Dec 02 2024 at 18:19)</a>:</h4>
<p>cfallin <a href="https://github.com/bytecodealliance/wasmtime/pull/9697#issuecomment-2512341380">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/9697">PR #9697</a>:</p>
<blockquote>
<p>@abrown Will do!</p>
</blockquote>



<a name="485728134"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%239697%20cranelift-entity%3A%20Add%20optional%20suppor.../near/485728134" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.239697.20cranelift-entity.3A.20Add.20optional.20suppor.2E.2E.2E.html#485728134">(Dec 02 2024 at 23:53)</a>:</h4>
<p>cfallin submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/9697#pullrequestreview-2474172890">PR review</a>:</p>
<blockquote>
<p>Thanks for the PR, @caelunshun!</p>
<p>I have a specific comment below, but also a higher-level thought: in general we try to avoid taking on dependencies, even optional ones, because it adds to our vetting overhead (you can see the <code>cargo vet</code> failure in CI here; one of us would have to go and read the <code>bytemuck</code> sources to vet it) and just in general adds complexity. In particular here I'm somewhat concerned that this crate permits unsafe low-level casting and is claiming additional properties about our data structures; they may be true today, or may not (see comment), but we're also taking on additional burden reasoning about and upholding these properties going forward.</p>
<p>For your particular use-case, would it be a possible alternative for you to wrap whatever types need these trait impls in your own types, and impl them locally? That way you could carry the maintenance task of ensuring the properties still hold, and of vetting dependencies, without adding those overheads here. Curious what you think.</p>
</blockquote>



<a name="485728135"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%239697%20cranelift-entity%3A%20Add%20optional%20suppor.../near/485728135" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.239697.20cranelift-entity.3A.20Add.20optional.20suppor.2E.2E.2E.html#485728135">(Dec 02 2024 at 23:53)</a>:</h4>
<p>cfallin created <a href="https://github.com/bytecodealliance/wasmtime/pull/9697#discussion_r1866775825">PR review comment</a>:</p>
<blockquote>
<p>This is a valid argument for the soundness of <code>Pod</code>, but not of <code>Zeroable</code>, as far as I can tell, right? In fact an all-zero-bits <code>EntityList</code> is not guaranteed to be valid at all, and we don't otherwise allow the existence of <code>EntityList</code> values that are "dangling"...</p>
</blockquote>



<a name="485748649"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%239697%20cranelift-entity%3A%20Add%20optional%20suppor.../near/485748649" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.239697.20cranelift-entity.3A.20Add.20optional.20suppor.2E.2E.2E.html#485748649">(Dec 03 2024 at 04:00)</a>:</h4>
<p>caelunshun created <a href="https://github.com/bytecodealliance/wasmtime/pull/9697#discussion_r1866993866">PR review comment</a>:</p>
<blockquote>
<p>For this specific comment, an all-zero-bits <code>EntityList</code> is sound to create; in fact the existing <code>Default</code> implementation already does so (the docs there say it creates an empty list). </p>
</blockquote>



<a name="485748650"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%239697%20cranelift-entity%3A%20Add%20optional%20suppor.../near/485748650" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.239697.20cranelift-entity.3A.20Add.20optional.20suppor.2E.2E.2E.html#485748650">(Dec 03 2024 at 04:00)</a>:</h4>
<p>caelunshun submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/9697#pullrequestreview-2474491339">PR review</a>:</p>
<blockquote>
<p>Thanks for the review. Yes, not wanting to take on extra dependencies makes sense; I wasn't aware of the vetting policy.</p>
<p>From my impression <code>bytemuck</code> is a fairly central ecosystem crate, seeing use in security-conscious projects like Servo and wgpu, and is also <a href="https://github.com/google/rust-crate-audits/blob/93e07327e17465f183d18a825639880f876227fc/manual-sources/google3-audits.toml#L270">vetted for use in Google's projects</a>. And given <code>cranelift-entity</code>'s applications outside of Wasmtime, integrating with the broader ecosystem would make sense to me. But it's not a big deal to me one way or the other.</p>
<p>As for your comment about guaranteeing a particular representation, the docs already do so implicitly, with <code>EntityList</code> being described as a single <code>u32</code> and <code>PackedOption&lt;T&gt;</code> being a trivial wrapper around <code>T</code>. So implementing these traits in <code>cranelift-entity</code> just allows downstream crates to take advantage of this layout without unsafe code that could silently break with a version bump.</p>
<p>The reason I couldn't write a newtype around <code>cranelift-entity</code> types and implement <code>Pod</code> is because their layout is not currently guaranteed; the upstream types would need to be <code>repr(C)</code> or <code>repr(transparent)</code> (as changed in this PR) for that to be sound. I could change the PR to simply add these <code>repr</code> annotations and not the <code>bytemuck</code> dependency if you like. </p>
</blockquote>



<a name="485771667"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%239697%20cranelift-entity%3A%20Add%20optional%20suppor.../near/485771667" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.239697.20cranelift-entity.3A.20Add.20optional.20suppor.2E.2E.2E.html#485771667">(Dec 03 2024 at 07:12)</a>:</h4>
<p>cfallin submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/9697#pullrequestreview-2474757226">PR review</a>.</p>



<a name="485771668"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%239697%20cranelift-entity%3A%20Add%20optional%20suppor.../near/485771668" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.239697.20cranelift-entity.3A.20Add.20optional.20suppor.2E.2E.2E.html#485771668">(Dec 03 2024 at 07:12)</a>:</h4>
<p>cfallin created <a href="https://github.com/bytecodealliance/wasmtime/pull/9697#discussion_r1867161519">PR review comment</a>:</p>
<blockquote>
<p>Ah, yes, you're right; I had forgotten that we use zero as an empty-list sentinel here. Thanks!</p>
</blockquote>



<a name="485772099"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%239697%20cranelift-entity%3A%20Add%20optional%20suppor.../near/485772099" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.239697.20cranelift-entity.3A.20Add.20optional.20suppor.2E.2E.2E.html#485772099">(Dec 03 2024 at 07:15)</a>:</h4>
<p>cfallin <a href="https://github.com/bytecodealliance/wasmtime/pull/9697#issuecomment-2513731589">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/9697">PR #9697</a>:</p>
<blockquote>
<p>Thanks for the additional detail! Given all that, I think the deciding factor for me is the vetting overhead: we apparently don't pull in that Google vet (or it's not sufficient for our required level?) and I don't have cycles to go read all of <code>bytemuck</code> and convince myself of its correctness right now, so I think I'd prefer to see this be a minimal PR that adds the necessary <code>repr</code> directives to structs instead and documents invariants (zero-valued sentinels, etc) appropriately. I'd be happy to approve and merge such a PR.</p>
</blockquote>



<a name="485999667"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%239697%20cranelift-entity%3A%20Add%20optional%20suppor.../near/485999667" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.239697.20cranelift-entity.3A.20Add.20optional.20suppor.2E.2E.2E.html#485999667">(Dec 04 2024 at 02:46)</a>:</h4>
<p>caelunshun updated <a href="https://github.com/bytecodealliance/wasmtime/pull/9697">PR #9697</a>.</p>



<a name="485999878"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%239697%20cranelift-entity%3A%20Add%20optional%20suppor.../near/485999878" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.239697.20cranelift-entity.3A.20Add.20optional.20suppor.2E.2E.2E.html#485999878">(Dec 04 2024 at 02:48)</a>:</h4>
<p>caelunshun updated <a href="https://github.com/bytecodealliance/wasmtime/pull/9697">PR #9697</a>.</p>



<hr><p>Last updated: Jan 20 2025 at 06:04 UTC</p>
</html>