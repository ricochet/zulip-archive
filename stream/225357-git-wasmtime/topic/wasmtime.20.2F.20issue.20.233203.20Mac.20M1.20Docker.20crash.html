<html>
<head><meta charset="utf-8"><title>wasmtime / issue #3203 Mac M1 Docker crash · git-wasmtime · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/index.html">git-wasmtime</a></h2>
<h3>Topic: <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.233203.20Mac.20M1.20Docker.20crash.html">wasmtime / issue #3203 Mac M1 Docker crash</a></h3>

<hr>

<base href="https://bytecodealliance.zulipchat.com">

<head><link href="https://bytecodealliance.github.io/zulip-archive/style.css" rel="stylesheet"></head>

<a name="249876516"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%233203%20Mac%20M1%20Docker%20crash/near/249876516" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.233203.20Mac.20M1.20Docker.20crash.html#249876516">(Aug 18 2021 at 16:37)</a>:</h4>
<p>otaviopace labeled <a href="https://github.com/bytecodealliance/wasmtime/issues/3203">issue #3203</a>:</p>
<blockquote>
<h3>Test Case</h3>
<p>I've created a repo just for this: <a href="https://github.com/otaviopace/mac-m1-wasmtime-docker">https://github.com/otaviopace/mac-m1-wasmtime-docker</a>.</p>
<p>To reproduce the error, one should build the docker image in a linux computer, than try to run it on a Mac M1 computer.</p>
<p>For moving the image from one computer to the other, Docker Hub can be used, but <a href="https://stackoverflow.com/questions/24482822/how-to-share-my-docker-image-without-using-the-docker-hub/48856787#48856787">this</a> works the same.</p>
<h3>Steps to Reproduce</h3>
<ul>
<li>Build docker image on Linux computer</li>
<li>Load/pull built image on a Mac M1 computer</li>
<li>Run the container</li>
</ul>
<h3>Expected Results</h3>
<p><code>wasmtime</code> shouldn't crash from running amd64 on a Mac M1 computer.</p>
<h3>Actual Results</h3>
<p><code>wasmtime</code> crashes on the traphandlers file, like this:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="n">thread</span><span class="w"> </span><span class="o">'</span><span class="na">cool</span><span class="w"> </span><span class="n">thread</span><span class="w"> </span><span class="n">name</span><span class="o">'</span><span class="w"> </span><span class="n">panicked</span><span class="w"> </span><span class="n">at</span><span class="w"> </span><span class="o">'</span><span class="na">assertion</span><span class="w"> </span><span class="n">failed</span>: <span class="err">`</span><span class="p">(</span><span class="n">left</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">right</span><span class="p">)</span><span class="err">`</span><span class="w"></span>
<span class="w">  </span><span class="n">left</span>: <span class="err">`</span><span class="o">-</span><span class="mi">1</span><span class="err">`</span><span class="p">,</span><span class="w"></span>
<span class="w"> </span><span class="n">right</span>: <span class="err">`</span><span class="mi">0</span><span class="err">`</span>: <span class="nc">registering</span><span class="w"> </span><span class="n">new</span><span class="w"> </span><span class="n">sigaltstack</span><span class="w"> </span><span class="n">failed</span><span class="o">'</span><span class="p">,</span><span class="w"> </span><span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">local</span><span class="o">/</span><span class="n">cargo</span><span class="o">/</span><span class="n">registry</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">github</span><span class="p">.</span><span class="n">com</span><span class="o">-</span><span class="mi">1</span><span class="n">ecc6299db9ec823</span><span class="o">/</span><span class="n">wasmtime</span><span class="o">-</span><span class="n">runtime</span><span class="o">-</span><span class="mf">0.27.0</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">traphandlers</span><span class="o">/</span><span class="n">unix</span><span class="p">.</span><span class="n">rs</span>:<span class="mi">238</span>:<span class="mi">9</span><span class="w"></span>
</code></pre></div>
<h3>Versions and Environment</h3>
<p>Wasmtime version or commit: 0.27.0</p>
<p>Operating system: Mac M1</p>
<p>Architecture: arm64</p>
<h3>Extra Info</h3>
<p>This issue has been created because we're having this problem on <code>graph-node</code>: <a href="https://github.com/graphprotocol/graph-node/issues/2325">https://github.com/graphprotocol/graph-node/issues/2325</a>.</p>
<p>The weird thing is that we had no issues on the M1 running a Docker image built in Linux with <code>wasmtime</code> before. We have an automated process to generate the images for <code>graph-node</code>, and at some point in time, new images started to break without us changing this Docker automation, <code>wasmtime</code> version, or Docker for Mac version.</p>
<p>To isolate the problem, I've created a repository that has a simple example with the same issue.</p>
</blockquote>



<a name="249876517"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%233203%20Mac%20M1%20Docker%20crash/near/249876517" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.233203.20Mac.20M1.20Docker.20crash.html#249876517">(Aug 18 2021 at 16:37)</a>:</h4>
<p>otaviopace opened <a href="https://github.com/bytecodealliance/wasmtime/issues/3203">issue #3203</a>:</p>
<blockquote>
<h3>Test Case</h3>
<p>I've created a repo just for this: <a href="https://github.com/otaviopace/mac-m1-wasmtime-docker">https://github.com/otaviopace/mac-m1-wasmtime-docker</a>.</p>
<p>To reproduce the error, one should build the docker image in a linux computer, than try to run it on a Mac M1 computer.</p>
<p>For moving the image from one computer to the other, Docker Hub can be used, but <a href="https://stackoverflow.com/questions/24482822/how-to-share-my-docker-image-without-using-the-docker-hub/48856787#48856787">this</a> works the same.</p>
<h3>Steps to Reproduce</h3>
<ul>
<li>Build docker image on Linux computer</li>
<li>Load/pull built image on a Mac M1 computer</li>
<li>Run the container</li>
</ul>
<h3>Expected Results</h3>
<p><code>wasmtime</code> shouldn't crash from running amd64 on a Mac M1 computer.</p>
<h3>Actual Results</h3>
<p><code>wasmtime</code> crashes on the traphandlers file, like this:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="n">thread</span><span class="w"> </span><span class="o">'</span><span class="na">cool</span><span class="w"> </span><span class="n">thread</span><span class="w"> </span><span class="n">name</span><span class="o">'</span><span class="w"> </span><span class="n">panicked</span><span class="w"> </span><span class="n">at</span><span class="w"> </span><span class="o">'</span><span class="na">assertion</span><span class="w"> </span><span class="n">failed</span>: <span class="err">`</span><span class="p">(</span><span class="n">left</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">right</span><span class="p">)</span><span class="err">`</span><span class="w"></span>
<span class="w">  </span><span class="n">left</span>: <span class="err">`</span><span class="o">-</span><span class="mi">1</span><span class="err">`</span><span class="p">,</span><span class="w"></span>
<span class="w"> </span><span class="n">right</span>: <span class="err">`</span><span class="mi">0</span><span class="err">`</span>: <span class="nc">registering</span><span class="w"> </span><span class="n">new</span><span class="w"> </span><span class="n">sigaltstack</span><span class="w"> </span><span class="n">failed</span><span class="o">'</span><span class="p">,</span><span class="w"> </span><span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">local</span><span class="o">/</span><span class="n">cargo</span><span class="o">/</span><span class="n">registry</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">github</span><span class="p">.</span><span class="n">com</span><span class="o">-</span><span class="mi">1</span><span class="n">ecc6299db9ec823</span><span class="o">/</span><span class="n">wasmtime</span><span class="o">-</span><span class="n">runtime</span><span class="o">-</span><span class="mf">0.27.0</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">traphandlers</span><span class="o">/</span><span class="n">unix</span><span class="p">.</span><span class="n">rs</span>:<span class="mi">238</span>:<span class="mi">9</span><span class="w"></span>
</code></pre></div>
<h3>Versions and Environment</h3>
<p>Wasmtime version or commit: 0.27.0</p>
<p>Operating system: Mac M1</p>
<p>Architecture: arm64</p>
<h3>Extra Info</h3>
<p>This issue has been created because we're having this problem on <code>graph-node</code>: <a href="https://github.com/graphprotocol/graph-node/issues/2325">https://github.com/graphprotocol/graph-node/issues/2325</a>.</p>
<p>The weird thing is that we had no issues on the M1 running a Docker image built in Linux with <code>wasmtime</code> before. We have an automated process to generate the images for <code>graph-node</code>, and at some point in time, new images started to break without us changing this Docker automation, <code>wasmtime</code> version, or Docker for Mac version.</p>
<p>To isolate the problem, I've created a repository that has a simple example with the same issue.</p>
</blockquote>



<a name="249878399"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%233203%20Mac%20M1%20Docker%20crash/near/249878399" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.233203.20Mac.20M1.20Docker.20crash.html#249878399">(Aug 18 2021 at 16:51)</a>:</h4>
<p>cfallin <a href="https://github.com/bytecodealliance/wasmtime/issues/3203#issuecomment-901270705">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/3203">issue #3203</a>:</p>
<blockquote>
<p>Interesting -- it looks like this is an x86-64 binary running (via Rosetta 2) on M1 hardware? Does Docker on M1 run an x86-64 Linux kernel in a VM (as I think it works on Intel Mac hardware) or something else?</p>
<p>@bnjbvr is our resident has-M1-hardware-and-knows-how-to-use-it person for M1 issues -- Ben, what do you think?</p>
</blockquote>



<a name="249879084"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%233203%20Mac%20M1%20Docker%20crash/near/249879084" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.233203.20Mac.20M1.20Docker.20crash.html#249879084">(Aug 18 2021 at 16:55)</a>:</h4>
<p>alexcrichton <a href="https://github.com/bytecodealliance/wasmtime/issues/3203#issuecomment-901273708">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/3203">issue #3203</a>:</p>
<blockquote>
<p>If you can test out a custom build, <a href="https://github.com/bytecodealliance/wasmtime/pull/3204">https://github.com/bytecodealliance/wasmtime/pull/3204</a> may help by providing the error code that <code>sigaltstack</code> is failing with (although I don't think it will help too much here in determining a cause...)</p>
</blockquote>



<a name="249881436"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%233203%20Mac%20M1%20Docker%20crash/near/249881436" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.233203.20Mac.20M1.20Docker.20crash.html#249881436">(Aug 18 2021 at 17:11)</a>:</h4>
<p>otaviopace <a href="https://github.com/bytecodealliance/wasmtime/issues/3203#issuecomment-901284937">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/3203">issue #3203</a>:</p>
<blockquote>
<p>@cfallin on the questions you've pointed out</p>
<blockquote>
<p>it looks like this is an x86-64 binary running (via Rosetta 2) on M1 hardware?</p>
</blockquote>
<p>Yes, it the problem seems to be related to Rosetta 2 translation.</p>
<blockquote>
<p>Does Docker on M1 run an x86-64 Linux kernel in a VM (as I think it works on Intel Mac hardware) or something else?</p>
</blockquote>
<p>I don't think Docker runs a VM for linux, I think it probably just uses Rosetta for the translation, but I'm not completly sure.</p>
<p>@alexcrichton Thank you so much for the debug build, I'll try it and post the results here <span aria-label="smile" class="emoji emoji-1f642" role="img" title="smile">:smile:</span> </p>
</blockquote>



<a name="249882005"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%233203%20Mac%20M1%20Docker%20crash/near/249882005" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.233203.20Mac.20M1.20Docker.20crash.html#249882005">(Aug 18 2021 at 17:15)</a>:</h4>
<p>otaviopace edited a <a href="https://github.com/bytecodealliance/wasmtime/issues/3203#issuecomment-901284937">comment</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/3203">issue #3203</a>:</p>
<blockquote>
<p>@cfallin on the questions you've pointed out:</p>
<blockquote>
<p>it looks like this is an x86-64 binary running (via Rosetta 2) on M1 hardware?</p>
</blockquote>
<p>Yes, the problem seems to be related to Rosetta 2 translation.</p>
<blockquote>
<p>Does Docker on M1 run an x86-64 Linux kernel in a VM (as I think it works on Intel Mac hardware) or something else?</p>
</blockquote>
<p>I don't think Docker runs a VM for Linux, I think it probably just uses Rosetta for the translation, but I'm not completly sure.</p>
<p>@alexcrichton Thank you so much for the debug build, I'll try it and post the results here <span aria-label="smile" class="emoji emoji-1f642" role="img" title="smile">:smile:</span> </p>
</blockquote>



<a name="249893962"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%233203%20Mac%20M1%20Docker%20crash/near/249893962" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.233203.20Mac.20M1.20Docker.20crash.html#249893962">(Aug 18 2021 at 18:42)</a>:</h4>
<p>peterhuene <a href="https://github.com/bytecodealliance/wasmtime/issues/3203#issuecomment-901344355">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/3203">issue #3203</a>:</p>
<blockquote>
<p>From Docker:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="n">If</span><span class="w"> </span><span class="n">you</span><span class="w"> </span><span class="n">are</span><span class="w"> </span><span class="n">trying</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">run</span><span class="w"> </span><span class="n">Intel</span><span class="o">-</span><span class="n">based</span><span class="w"> </span><span class="n">containers</span><span class="w"> </span><span class="n">on</span><span class="w"> </span><span class="n">an</span><span class="w"> </span><span class="n">M1</span><span class="w"> </span><span class="n">machine</span><span class="p">,</span><span class="w"> </span><span class="n">they</span><span class="w"> </span><span class="n">can</span><span class="w"> </span><span class="n">sometimes</span><span class="w"> </span><span class="n">crash</span><span class="p">.</span><span class="w"></span>
<span class="n">We</span><span class="w"> </span><span class="n">are</span><span class="w"> </span><span class="n">using</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="n">piece</span><span class="w"> </span><span class="n">of</span><span class="w"> </span><span class="n">software</span><span class="w"> </span><span class="n">called</span><span class="w"> </span><span class="n">qemu</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">emulate</span><span class="w"> </span><span class="n">Intel</span><span class="w"> </span><span class="n">chips</span><span class="w"> </span><span class="n">on</span><span class="w"> </span><span class="n">M1</span><span class="w"> </span><span class="n">but</span><span class="w"> </span><span class="n">it</span><span class="w"> </span><span class="n">occasionally</span><span class="w"></span>
<span class="n">fails</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">run</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">container</span><span class="p">.</span><span class="w"> </span><span class="n">Where</span><span class="w"> </span><span class="n">possible</span><span class="w"> </span><span class="n">we</span><span class="w"> </span><span class="n">recommend</span><span class="w"> </span><span class="n">sticking</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">arm64</span><span class="w"> </span><span class="n">containers</span><span class="w"> </span><span class="n">on</span><span class="w"> </span><span class="n">M1</span><span class="w"></span>
<span class="n">machines</span><span class="p">;</span><span class="w"> </span><span class="n">they</span><span class="w"> </span><span class="n">will</span><span class="w"> </span><span class="n">also</span><span class="w"> </span><span class="n">be</span><span class="w"> </span><span class="n">faster</span><span class="p">.</span><span class="w"></span>
</code></pre></div>
<p>From some Google searches, it seems that QEMU might have issues with <code>signaltstack</code> on M1 for x86-64 containers (seeing references to <code>EINVAL</code> for other projects).</p>
<p>I think this might not be a Wasmtime issue currently.</p>
</blockquote>



<a name="249897207"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%233203%20Mac%20M1%20Docker%20crash/near/249897207" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.233203.20Mac.20M1.20Docker.20crash.html#249897207">(Aug 18 2021 at 19:03)</a>:</h4>
<p>peterhuene edited a <a href="https://github.com/bytecodealliance/wasmtime/issues/3203#issuecomment-901344355">comment</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/3203">issue #3203</a>:</p>
<blockquote>
<p>From Docker:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="n">If</span><span class="w"> </span><span class="n">you</span><span class="w"> </span><span class="n">are</span><span class="w"> </span><span class="n">trying</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">run</span><span class="w"> </span><span class="n">Intel</span><span class="o">-</span><span class="n">based</span><span class="w"> </span><span class="n">containers</span><span class="w"> </span><span class="n">on</span><span class="w"> </span><span class="n">an</span><span class="w"> </span><span class="n">M1</span><span class="w"> </span><span class="n">machine</span><span class="p">,</span><span class="w"> </span><span class="n">they</span><span class="w"> </span><span class="n">can</span><span class="w"> </span><span class="n">sometimes</span><span class="w"> </span><span class="n">crash</span><span class="p">.</span><span class="w"></span>
<span class="n">We</span><span class="w"> </span><span class="n">are</span><span class="w"> </span><span class="n">using</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="n">piece</span><span class="w"> </span><span class="n">of</span><span class="w"> </span><span class="n">software</span><span class="w"> </span><span class="n">called</span><span class="w"> </span><span class="n">qemu</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">emulate</span><span class="w"> </span><span class="n">Intel</span><span class="w"> </span><span class="n">chips</span><span class="w"> </span><span class="n">on</span><span class="w"> </span><span class="n">M1</span><span class="w"> </span><span class="n">but</span><span class="w"> </span><span class="n">it</span><span class="w"> </span><span class="n">occasionally</span><span class="w"></span>
<span class="n">fails</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">run</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">container</span><span class="p">.</span><span class="w"> </span><span class="n">Where</span><span class="w"> </span><span class="n">possible</span><span class="w"> </span><span class="n">we</span><span class="w"> </span><span class="n">recommend</span><span class="w"> </span><span class="n">sticking</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">arm64</span><span class="w"> </span><span class="n">containers</span><span class="w"> </span><span class="n">on</span><span class="w"> </span><span class="n">M1</span><span class="w"></span>
<span class="n">machines</span><span class="p">;</span><span class="w"> </span><span class="n">they</span><span class="w"> </span><span class="n">will</span><span class="w"> </span><span class="n">also</span><span class="w"> </span><span class="n">be</span><span class="w"> </span><span class="n">faster</span><span class="p">.</span><span class="w"></span>
</code></pre></div>
<p>and</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="n">However</span><span class="p">,</span><span class="w"> </span><span class="n">attempts</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">run</span><span class="w"> </span><span class="n">Intel</span><span class="o">-</span><span class="n">based</span><span class="w"> </span><span class="n">containers</span><span class="w"> </span><span class="n">on</span><span class="w"> </span><span class="n">Apple</span><span class="w"> </span><span class="n">Silicon</span><span class="w"> </span><span class="n">machines</span><span class="w"> </span><span class="n">under</span><span class="w"> </span><span class="n">emulation</span><span class="w"> </span><span class="n">can</span><span class="w"></span>
<span class="n">crash</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">qemu</span><span class="w"> </span><span class="n">sometimes</span><span class="w"> </span><span class="n">fails</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">run</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">container</span><span class="p">.</span><span class="w"> </span><span class="n">In</span><span class="w"> </span><span class="n">addition</span><span class="p">,</span><span class="w"> </span><span class="n">filesystem</span><span class="w"> </span><span class="n">change</span><span class="w"> </span><span class="n">notification</span><span class="w"> </span><span class="n">APIs</span><span class="w"></span>
<span class="p">(</span><span class="n">inotify</span><span class="p">)</span><span class="w"> </span><span class="kr">do</span><span class="w"> </span><span class="n">not</span><span class="w"> </span><span class="n">work</span><span class="w"> </span><span class="n">under</span><span class="w"> </span><span class="n">qemu</span><span class="w"> </span><span class="n">emulation</span><span class="p">.</span><span class="w"> </span><span class="n">Even</span><span class="w"> </span><span class="n">when</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">containers</span><span class="w"> </span><span class="kr">do</span><span class="w"> </span><span class="n">run</span><span class="w"> </span><span class="n">correctly</span><span class="w"> </span><span class="n">under</span><span class="w"></span>
<span class="n">emulation</span><span class="p">,</span><span class="w"> </span><span class="n">they</span><span class="w"> </span><span class="n">will</span><span class="w"> </span><span class="n">be</span><span class="w"> </span><span class="n">slower</span><span class="w"> </span><span class="n">and</span><span class="w"> </span><span class="k">use</span><span class="w"> </span><span class="n">more</span><span class="w"> </span><span class="n">memory</span><span class="w"> </span><span class="n">than</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">native</span><span class="w"> </span><span class="n">equivalent</span><span class="p">.</span><span class="w"></span>

<span class="n">In</span><span class="w"> </span><span class="n">summary</span><span class="p">,</span><span class="w"> </span><span class="n">running</span><span class="w"> </span><span class="n">Intel</span><span class="o">-</span><span class="n">based</span><span class="w"> </span><span class="n">containers</span><span class="w"> </span><span class="n">on</span><span class="w"> </span><span class="n">Arm</span><span class="o">-</span><span class="n">based</span><span class="w"> </span><span class="n">machines</span><span class="w"> </span><span class="n">should</span><span class="w"> </span><span class="n">be</span><span class="w"> </span><span class="n">regarded</span><span class="w"> </span><span class="k">as</span><span class="w"></span>
<span class="err">“</span><span class="n">best</span><span class="w"> </span><span class="n">effort</span><span class="err">”</span><span class="w"> </span><span class="n">only</span><span class="p">.</span><span class="w"> </span><span class="n">We</span><span class="w"> </span><span class="n">recommend</span><span class="w"> </span><span class="n">running</span><span class="w"> </span><span class="n">arm64</span><span class="w"> </span><span class="n">containers</span><span class="w"> </span><span class="n">on</span><span class="w"> </span><span class="n">Apple</span><span class="w"> </span><span class="n">Silicon</span><span class="w"> </span><span class="n">machines</span><span class="w"> </span><span class="n">whenever</span><span class="w"></span>
<span class="n">possible</span><span class="p">,</span><span class="w"> </span><span class="n">and</span><span class="w"> </span><span class="n">encouraging</span><span class="w"> </span><span class="n">container</span><span class="w"> </span><span class="n">authors</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">produce</span><span class="w"> </span><span class="n">arm64</span><span class="p">,</span><span class="w"> </span><span class="n">or</span><span class="w"> </span><span class="n">multi</span><span class="o">-</span><span class="n">arch</span><span class="p">,</span><span class="w"> </span><span class="n">versions</span><span class="w"> </span><span class="n">of</span><span class="w"> </span><span class="n">their</span><span class="w"></span>
<span class="n">containers</span><span class="p">.</span><span class="w"> </span><span class="n">We</span><span class="w"> </span><span class="n">expect</span><span class="w"> </span><span class="n">this</span><span class="w"> </span><span class="n">issue</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="kr">become</span><span class="w"> </span><span class="n">less</span><span class="w"> </span><span class="n">common</span><span class="w"> </span><span class="n">over</span><span class="w"> </span><span class="n">time</span><span class="p">,</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">more</span><span class="w"> </span><span class="n">and</span><span class="w"> </span><span class="n">more</span><span class="w"> </span><span class="n">images</span><span class="w"> </span><span class="n">are</span><span class="w"></span>
<span class="n">rebuilt</span><span class="w"> </span><span class="n">supporting</span><span class="w"> </span><span class="n">multiple</span><span class="w"> </span><span class="n">architectures</span><span class="p">.</span><span class="w"></span>
</code></pre></div>
<p>From some Google searches, it seems that QEMU might have issues with <code>signaltstack</code> on M1 for x86-64 containers (seeing references to <code>EINVAL</code> for other projects, e.g. running Chrome in an amd64 container).</p>
<p>I think this might not be an actionable Wasmtime issue; we should see if an arm64 container has similar problems.</p>
</blockquote>



<a name="249897630"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%233203%20Mac%20M1%20Docker%20crash/near/249897630" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.233203.20Mac.20M1.20Docker.20crash.html#249897630">(Aug 18 2021 at 19:06)</a>:</h4>
<p>peterhuene edited a <a href="https://github.com/bytecodealliance/wasmtime/issues/3203#issuecomment-901344355">comment</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/3203">issue #3203</a>:</p>
<blockquote>
<p>From Docker:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="n">If</span><span class="w"> </span><span class="n">you</span><span class="w"> </span><span class="n">are</span><span class="w"> </span><span class="n">trying</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">run</span><span class="w"> </span><span class="n">Intel</span><span class="o">-</span><span class="n">based</span><span class="w"> </span><span class="n">containers</span><span class="w"> </span><span class="n">on</span><span class="w"> </span><span class="n">an</span><span class="w"> </span><span class="n">M1</span><span class="w"> </span><span class="n">machine</span><span class="p">,</span><span class="w"> </span><span class="n">they</span><span class="w"> </span><span class="n">can</span><span class="w"> </span><span class="n">sometimes</span><span class="w"> </span><span class="n">crash</span><span class="p">.</span><span class="w"></span>
<span class="n">We</span><span class="w"> </span><span class="n">are</span><span class="w"> </span><span class="n">using</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="n">piece</span><span class="w"> </span><span class="n">of</span><span class="w"> </span><span class="n">software</span><span class="w"> </span><span class="n">called</span><span class="w"> </span><span class="n">qemu</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">emulate</span><span class="w"> </span><span class="n">Intel</span><span class="w"> </span><span class="n">chips</span><span class="w"> </span><span class="n">on</span><span class="w"> </span><span class="n">M1</span><span class="w"> </span><span class="n">but</span><span class="w"> </span><span class="n">it</span><span class="w"> </span><span class="n">occasionally</span><span class="w"></span>
<span class="n">fails</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">run</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">container</span><span class="p">.</span><span class="w"> </span><span class="n">Where</span><span class="w"> </span><span class="n">possible</span><span class="w"> </span><span class="n">we</span><span class="w"> </span><span class="n">recommend</span><span class="w"> </span><span class="n">sticking</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">arm64</span><span class="w"> </span><span class="n">containers</span><span class="w"> </span><span class="n">on</span><span class="w"> </span><span class="n">M1</span><span class="w"></span>
<span class="n">machines</span><span class="p">;</span><span class="w"> </span><span class="n">they</span><span class="w"> </span><span class="n">will</span><span class="w"> </span><span class="n">also</span><span class="w"> </span><span class="n">be</span><span class="w"> </span><span class="n">faster</span><span class="p">.</span><span class="w"></span>
</code></pre></div>
<p>and</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="n">However</span><span class="p">,</span><span class="w"> </span><span class="n">attempts</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">run</span><span class="w"> </span><span class="n">Intel</span><span class="o">-</span><span class="n">based</span><span class="w"> </span><span class="n">containers</span><span class="w"> </span><span class="n">on</span><span class="w"> </span><span class="n">Apple</span><span class="w"> </span><span class="n">Silicon</span><span class="w"> </span><span class="n">machines</span><span class="w"> </span><span class="n">under</span><span class="w"> </span><span class="n">emulation</span><span class="w"> </span><span class="n">can</span><span class="w"></span>
<span class="n">crash</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">qemu</span><span class="w"> </span><span class="n">sometimes</span><span class="w"> </span><span class="n">fails</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">run</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">container</span><span class="p">.</span><span class="w"> </span><span class="n">In</span><span class="w"> </span><span class="n">addition</span><span class="p">,</span><span class="w"> </span><span class="n">filesystem</span><span class="w"> </span><span class="n">change</span><span class="w"> </span><span class="n">notification</span><span class="w"> </span><span class="n">APIs</span><span class="w"></span>
<span class="p">(</span><span class="n">inotify</span><span class="p">)</span><span class="w"> </span><span class="kr">do</span><span class="w"> </span><span class="n">not</span><span class="w"> </span><span class="n">work</span><span class="w"> </span><span class="n">under</span><span class="w"> </span><span class="n">qemu</span><span class="w"> </span><span class="n">emulation</span><span class="p">.</span><span class="w"> </span><span class="n">Even</span><span class="w"> </span><span class="n">when</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">containers</span><span class="w"> </span><span class="kr">do</span><span class="w"> </span><span class="n">run</span><span class="w"> </span><span class="n">correctly</span><span class="w"> </span><span class="n">under</span><span class="w"></span>
<span class="n">emulation</span><span class="p">,</span><span class="w"> </span><span class="n">they</span><span class="w"> </span><span class="n">will</span><span class="w"> </span><span class="n">be</span><span class="w"> </span><span class="n">slower</span><span class="w"> </span><span class="n">and</span><span class="w"> </span><span class="k">use</span><span class="w"> </span><span class="n">more</span><span class="w"> </span><span class="n">memory</span><span class="w"> </span><span class="n">than</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">native</span><span class="w"> </span><span class="n">equivalent</span><span class="p">.</span><span class="w"></span>

<span class="n">In</span><span class="w"> </span><span class="n">summary</span><span class="p">,</span><span class="w"> </span><span class="n">running</span><span class="w"> </span><span class="n">Intel</span><span class="o">-</span><span class="n">based</span><span class="w"> </span><span class="n">containers</span><span class="w"> </span><span class="n">on</span><span class="w"> </span><span class="n">Arm</span><span class="o">-</span><span class="n">based</span><span class="w"> </span><span class="n">machines</span><span class="w"> </span><span class="n">should</span><span class="w"> </span><span class="n">be</span><span class="w"> </span><span class="n">regarded</span><span class="w"> </span><span class="k">as</span><span class="w"></span>
<span class="err">“</span><span class="n">best</span><span class="w"> </span><span class="n">effort</span><span class="err">”</span><span class="w"> </span><span class="n">only</span><span class="p">.</span><span class="w"> </span><span class="n">We</span><span class="w"> </span><span class="n">recommend</span><span class="w"> </span><span class="n">running</span><span class="w"> </span><span class="n">arm64</span><span class="w"> </span><span class="n">containers</span><span class="w"> </span><span class="n">on</span><span class="w"> </span><span class="n">Apple</span><span class="w"> </span><span class="n">Silicon</span><span class="w"> </span><span class="n">machines</span><span class="w"> </span><span class="n">whenever</span><span class="w"></span>
<span class="n">possible</span><span class="p">,</span><span class="w"> </span><span class="n">and</span><span class="w"> </span><span class="n">encouraging</span><span class="w"> </span><span class="n">container</span><span class="w"> </span><span class="n">authors</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">produce</span><span class="w"> </span><span class="n">arm64</span><span class="p">,</span><span class="w"> </span><span class="n">or</span><span class="w"> </span><span class="n">multi</span><span class="o">-</span><span class="n">arch</span><span class="p">,</span><span class="w"> </span><span class="n">versions</span><span class="w"> </span><span class="n">of</span><span class="w"> </span><span class="n">their</span><span class="w"></span>
<span class="n">containers</span><span class="p">.</span><span class="w"> </span><span class="n">We</span><span class="w"> </span><span class="n">expect</span><span class="w"> </span><span class="n">this</span><span class="w"> </span><span class="n">issue</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="kr">become</span><span class="w"> </span><span class="n">less</span><span class="w"> </span><span class="n">common</span><span class="w"> </span><span class="n">over</span><span class="w"> </span><span class="n">time</span><span class="p">,</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">more</span><span class="w"> </span><span class="n">and</span><span class="w"> </span><span class="n">more</span><span class="w"> </span><span class="n">images</span><span class="w"> </span><span class="n">are</span><span class="w"></span>
<span class="n">rebuilt</span><span class="w"> </span><span class="n">supporting</span><span class="w"> </span><span class="n">multiple</span><span class="w"> </span><span class="n">architectures</span><span class="p">.</span><span class="w"></span>
</code></pre></div>
<p>From some Google searches, it seems that QEMU might have issues with <code>sigaltstack</code> on M1 for x86-64 containers (seeing references to <code>EINVAL</code> for other projects, e.g. running Chrome in an amd64 container).</p>
<p>I think this might not be an actionable Wasmtime issue; we should see if an arm64 container has similar problems.</p>
</blockquote>



<a name="249897822"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%233203%20Mac%20M1%20Docker%20crash/near/249897822" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.233203.20Mac.20M1.20Docker.20crash.html#249897822">(Aug 18 2021 at 19:08)</a>:</h4>
<p>peterhuene edited a <a href="https://github.com/bytecodealliance/wasmtime/issues/3203#issuecomment-901344355">comment</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/3203">issue #3203</a>:</p>
<blockquote>
<p>From Docker:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="n">If</span><span class="w"> </span><span class="n">you</span><span class="w"> </span><span class="n">are</span><span class="w"> </span><span class="n">trying</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">run</span><span class="w"> </span><span class="n">Intel</span><span class="o">-</span><span class="n">based</span><span class="w"> </span><span class="n">containers</span><span class="w"> </span><span class="n">on</span><span class="w"> </span><span class="n">an</span><span class="w"> </span><span class="n">M1</span><span class="w"> </span><span class="n">machine</span><span class="p">,</span><span class="w"> </span><span class="n">they</span><span class="w"> </span><span class="n">can</span><span class="w"> </span><span class="n">sometimes</span><span class="w"> </span><span class="n">crash</span><span class="p">.</span><span class="w"></span>
<span class="n">We</span><span class="w"> </span><span class="n">are</span><span class="w"> </span><span class="n">using</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="n">piece</span><span class="w"> </span><span class="n">of</span><span class="w"> </span><span class="n">software</span><span class="w"> </span><span class="n">called</span><span class="w"> </span><span class="n">qemu</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">emulate</span><span class="w"> </span><span class="n">Intel</span><span class="w"> </span><span class="n">chips</span><span class="w"> </span><span class="n">on</span><span class="w"> </span><span class="n">M1</span><span class="w"> </span><span class="n">but</span><span class="w"> </span><span class="n">it</span><span class="w"> </span><span class="n">occasionally</span><span class="w"></span>
<span class="n">fails</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">run</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">container</span><span class="p">.</span><span class="w"> </span><span class="n">Where</span><span class="w"> </span><span class="n">possible</span><span class="w"> </span><span class="n">we</span><span class="w"> </span><span class="n">recommend</span><span class="w"> </span><span class="n">sticking</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">arm64</span><span class="w"> </span><span class="n">containers</span><span class="w"> </span><span class="n">on</span><span class="w"> </span><span class="n">M1</span><span class="w"></span>
<span class="n">machines</span><span class="p">;</span><span class="w"> </span><span class="n">they</span><span class="w"> </span><span class="n">will</span><span class="w"> </span><span class="n">also</span><span class="w"> </span><span class="n">be</span><span class="w"> </span><span class="n">faster</span><span class="p">.</span><span class="w"></span>
</code></pre></div>
<p>and</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="n">However</span><span class="p">,</span><span class="w"> </span><span class="n">attempts</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">run</span><span class="w"> </span><span class="n">Intel</span><span class="o">-</span><span class="n">based</span><span class="w"> </span><span class="n">containers</span><span class="w"> </span><span class="n">on</span><span class="w"> </span><span class="n">Apple</span><span class="w"> </span><span class="n">Silicon</span><span class="w"> </span><span class="n">machines</span><span class="w"> </span><span class="n">under</span><span class="w"> </span><span class="n">emulation</span><span class="w"> </span><span class="n">can</span><span class="w"></span>
<span class="n">crash</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">qemu</span><span class="w"> </span><span class="n">sometimes</span><span class="w"> </span><span class="n">fails</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">run</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">container</span><span class="p">.</span><span class="w"> </span><span class="n">In</span><span class="w"> </span><span class="n">addition</span><span class="p">,</span><span class="w"> </span><span class="n">filesystem</span><span class="w"> </span><span class="n">change</span><span class="w"> </span><span class="n">notification</span><span class="w"> </span><span class="n">APIs</span><span class="w"></span>
<span class="p">(</span><span class="n">inotify</span><span class="p">)</span><span class="w"> </span><span class="kr">do</span><span class="w"> </span><span class="n">not</span><span class="w"> </span><span class="n">work</span><span class="w"> </span><span class="n">under</span><span class="w"> </span><span class="n">qemu</span><span class="w"> </span><span class="n">emulation</span><span class="p">.</span><span class="w"> </span><span class="n">Even</span><span class="w"> </span><span class="n">when</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">containers</span><span class="w"> </span><span class="kr">do</span><span class="w"> </span><span class="n">run</span><span class="w"> </span><span class="n">correctly</span><span class="w"> </span><span class="n">under</span><span class="w"></span>
<span class="n">emulation</span><span class="p">,</span><span class="w"> </span><span class="n">they</span><span class="w"> </span><span class="n">will</span><span class="w"> </span><span class="n">be</span><span class="w"> </span><span class="n">slower</span><span class="w"> </span><span class="n">and</span><span class="w"> </span><span class="k">use</span><span class="w"> </span><span class="n">more</span><span class="w"> </span><span class="n">memory</span><span class="w"> </span><span class="n">than</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">native</span><span class="w"> </span><span class="n">equivalent</span><span class="p">.</span><span class="w"></span>

<span class="n">In</span><span class="w"> </span><span class="n">summary</span><span class="p">,</span><span class="w"> </span><span class="n">running</span><span class="w"> </span><span class="n">Intel</span><span class="o">-</span><span class="n">based</span><span class="w"> </span><span class="n">containers</span><span class="w"> </span><span class="n">on</span><span class="w"> </span><span class="n">Arm</span><span class="o">-</span><span class="n">based</span><span class="w"> </span><span class="n">machines</span><span class="w"> </span><span class="n">should</span><span class="w"> </span><span class="n">be</span><span class="w"> </span><span class="n">regarded</span><span class="w"> </span><span class="k">as</span><span class="w"></span>
<span class="err">“</span><span class="n">best</span><span class="w"> </span><span class="n">effort</span><span class="err">”</span><span class="w"> </span><span class="n">only</span><span class="p">.</span><span class="w"> </span><span class="n">We</span><span class="w"> </span><span class="n">recommend</span><span class="w"> </span><span class="n">running</span><span class="w"> </span><span class="n">arm64</span><span class="w"> </span><span class="n">containers</span><span class="w"> </span><span class="n">on</span><span class="w"> </span><span class="n">Apple</span><span class="w"> </span><span class="n">Silicon</span><span class="w"> </span><span class="n">machines</span><span class="w"> </span><span class="n">whenever</span><span class="w"></span>
<span class="n">possible</span><span class="p">,</span><span class="w"> </span><span class="n">and</span><span class="w"> </span><span class="n">encouraging</span><span class="w"> </span><span class="n">container</span><span class="w"> </span><span class="n">authors</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">produce</span><span class="w"> </span><span class="n">arm64</span><span class="p">,</span><span class="w"> </span><span class="n">or</span><span class="w"> </span><span class="n">multi</span><span class="o">-</span><span class="n">arch</span><span class="p">,</span><span class="w"> </span><span class="n">versions</span><span class="w"> </span><span class="n">of</span><span class="w"> </span><span class="n">their</span><span class="w"></span>
<span class="n">containers</span><span class="p">.</span><span class="w"> </span><span class="n">We</span><span class="w"> </span><span class="n">expect</span><span class="w"> </span><span class="n">this</span><span class="w"> </span><span class="n">issue</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="kr">become</span><span class="w"> </span><span class="n">less</span><span class="w"> </span><span class="n">common</span><span class="w"> </span><span class="n">over</span><span class="w"> </span><span class="n">time</span><span class="p">,</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">more</span><span class="w"> </span><span class="n">and</span><span class="w"> </span><span class="n">more</span><span class="w"> </span><span class="n">images</span><span class="w"> </span><span class="n">are</span><span class="w"></span>
<span class="n">rebuilt</span><span class="w"> </span><span class="n">supporting</span><span class="w"> </span><span class="n">multiple</span><span class="w"> </span><span class="n">architectures</span><span class="p">.</span><span class="w"></span>
</code></pre></div>
<p>From some Google searches, it seems that QEMU might have issues with <code>sigaltstack</code> on M1 for x86-64 containers (seeing references to <code>EINVAL</code> for other projects, e.g. running <a href="https://github.com/docker/for-mac/issues/5766">Chrome in an amd64 container</a> or <a href="https://github.com/bitnami/bitnami-docker-rabbitmq/issues/147">Rabbit MQ</a>).</p>
<p>I think this might not be an actionable Wasmtime issue; we should see if an arm64 container has similar problems.</p>
</blockquote>



<a name="249900750"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%233203%20Mac%20M1%20Docker%20crash/near/249900750" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.233203.20Mac.20M1.20Docker.20crash.html#249900750">(Aug 18 2021 at 19:32)</a>:</h4>
<p>otaviopace <a href="https://github.com/bytecodealliance/wasmtime/issues/3203#issuecomment-901375128">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/3203">issue #3203</a>:</p>
<blockquote>
<p>@alexcrichton , with your debug change the log went from:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="n">registering</span><span class="w"> </span><span class="n">new</span><span class="w"> </span><span class="n">sigaltstack</span><span class="w"> </span><span class="n">failed</span><span class="w"></span>
</code></pre></div>
<p>to this:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="n">registering</span><span class="w"> </span><span class="n">new</span><span class="w"> </span><span class="n">sigaltstack</span><span class="w"> </span><span class="n">failed</span>: <span class="nc">Invalid</span><span class="w"> </span><span class="n">argument</span><span class="w"> </span><span class="p">(</span><span class="n">os</span><span class="w"> </span><span class="n">error</span><span class="w"> </span><span class="mi">22</span><span class="p">)</span><span class="w"></span>
</code></pre></div>
<p>Does this mean the Rosetta 2 translation expects a different argument for <code>sigalstack</code>?</p>
</blockquote>



<a name="249900994"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%233203%20Mac%20M1%20Docker%20crash/near/249900994" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.233203.20Mac.20M1.20Docker.20crash.html#249900994">(Aug 18 2021 at 19:34)</a>:</h4>
<p>otaviopace edited a <a href="https://github.com/bytecodealliance/wasmtime/issues/3203#issuecomment-901375128">comment</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/3203">issue #3203</a>:</p>
<blockquote>
<p>@alexcrichton , with your debug change the log went from:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="n">registering</span><span class="w"> </span><span class="n">new</span><span class="w"> </span><span class="n">sigaltstack</span><span class="w"> </span><span class="n">failed</span><span class="w"></span>
</code></pre></div>
<p>to this:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="n">registering</span><span class="w"> </span><span class="n">new</span><span class="w"> </span><span class="n">sigaltstack</span><span class="w"> </span><span class="n">failed</span>: <span class="nc">Invalid</span><span class="w"> </span><span class="n">argument</span><span class="w"> </span><span class="p">(</span><span class="n">os</span><span class="w"> </span><span class="n">error</span><span class="w"> </span><span class="mi">22</span><span class="p">)</span><span class="w"></span>
</code></pre></div>
<p>Does this mean the Rosetta 2 translation expects a different argument for <code>sigalstack</code>?</p>
<p>Edit: Just looked into similar issues @peterhuene linked and they get the same <code>Invalid argument (22)</code> result <span aria-label="disappointed" class="emoji emoji-1f61e" role="img" title="disappointed">:disappointed:</span> </p>
</blockquote>



<a name="249901218"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%233203%20Mac%20M1%20Docker%20crash/near/249901218" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.233203.20Mac.20M1.20Docker.20crash.html#249901218">(Aug 18 2021 at 19:36)</a>:</h4>
<p>otaviopace <a href="https://github.com/bytecodealliance/wasmtime/issues/3203#issuecomment-901377590">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/3203">issue #3203</a>:</p>
<blockquote>
<p>Unfortunetally this really isn't a problem with <code>wasmtime</code> itself, I'll close this for now, thanks a lot for the help <span aria-label="heart" class="emoji emoji-2764" role="img" title="heart">:heart:</span>️ </p>
</blockquote>



<a name="249901219"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%233203%20Mac%20M1%20Docker%20crash/near/249901219" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.233203.20Mac.20M1.20Docker.20crash.html#249901219">(Aug 18 2021 at 19:36)</a>:</h4>
<p>otaviopace closed <a href="https://github.com/bytecodealliance/wasmtime/issues/3203">issue #3203</a>:</p>
<blockquote>
<h3>Test Case</h3>
<p>I've created a repo just for this: <a href="https://github.com/otaviopace/mac-m1-wasmtime-docker">https://github.com/otaviopace/mac-m1-wasmtime-docker</a>.</p>
<p>To reproduce the error, one should build the docker image in a linux computer, than try to run it on a Mac M1 computer.</p>
<p>For moving the image from one computer to the other, Docker Hub can be used, but <a href="https://stackoverflow.com/questions/24482822/how-to-share-my-docker-image-without-using-the-docker-hub/48856787#48856787">this</a> works the same.</p>
<h3>Steps to Reproduce</h3>
<ul>
<li>Build docker image on Linux computer</li>
<li>Load/pull built image on a Mac M1 computer</li>
<li>Run the container</li>
</ul>
<h3>Expected Results</h3>
<p><code>wasmtime</code> shouldn't crash from running amd64 on a Mac M1 computer.</p>
<h3>Actual Results</h3>
<p><code>wasmtime</code> crashes on the traphandlers file, like this:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="n">thread</span><span class="w"> </span><span class="o">'</span><span class="na">cool</span><span class="w"> </span><span class="n">thread</span><span class="w"> </span><span class="n">name</span><span class="o">'</span><span class="w"> </span><span class="n">panicked</span><span class="w"> </span><span class="n">at</span><span class="w"> </span><span class="o">'</span><span class="na">assertion</span><span class="w"> </span><span class="n">failed</span>: <span class="err">`</span><span class="p">(</span><span class="n">left</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">right</span><span class="p">)</span><span class="err">`</span><span class="w"></span>
<span class="w">  </span><span class="n">left</span>: <span class="err">`</span><span class="o">-</span><span class="mi">1</span><span class="err">`</span><span class="p">,</span><span class="w"></span>
<span class="w"> </span><span class="n">right</span>: <span class="err">`</span><span class="mi">0</span><span class="err">`</span>: <span class="nc">registering</span><span class="w"> </span><span class="n">new</span><span class="w"> </span><span class="n">sigaltstack</span><span class="w"> </span><span class="n">failed</span><span class="o">'</span><span class="p">,</span><span class="w"> </span><span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">local</span><span class="o">/</span><span class="n">cargo</span><span class="o">/</span><span class="n">registry</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">github</span><span class="p">.</span><span class="n">com</span><span class="o">-</span><span class="mi">1</span><span class="n">ecc6299db9ec823</span><span class="o">/</span><span class="n">wasmtime</span><span class="o">-</span><span class="n">runtime</span><span class="o">-</span><span class="mf">0.27.0</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">traphandlers</span><span class="o">/</span><span class="n">unix</span><span class="p">.</span><span class="n">rs</span>:<span class="mi">238</span>:<span class="mi">9</span><span class="w"></span>
</code></pre></div>
<h3>Versions and Environment</h3>
<p>Wasmtime version or commit: 0.27.0</p>
<p>Operating system: Mac M1</p>
<p>Architecture: arm64</p>
<h3>Extra Info</h3>
<p>This issue has been created because we're having this problem on <code>graph-node</code>: <a href="https://github.com/graphprotocol/graph-node/issues/2325">https://github.com/graphprotocol/graph-node/issues/2325</a>.</p>
<p>The weird thing is that we had no issues on the M1 running a Docker image built in Linux with <code>wasmtime</code> before. We have an automated process to generate the images for <code>graph-node</code>, and at some point in time, new images started to break without us changing this Docker automation, <code>wasmtime</code> version, or Docker for Mac version.</p>
<p>To isolate the problem, I've created a repository that has a simple example with the same issue.</p>
</blockquote>



<a name="249901244"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%233203%20Mac%20M1%20Docker%20crash/near/249901244" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.233203.20Mac.20M1.20Docker.20crash.html#249901244">(Aug 18 2021 at 19:37)</a>:</h4>
<p>peterhuene <a href="https://github.com/bytecodealliance/wasmtime/issues/3203#issuecomment-901377799">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/3203">issue #3203</a>:</p>
<blockquote>
<p>22 is <code>EINVAL</code>.</p>
<p>My gut tells me that the bug fixed by this [QEMU commit](<br>
I also found <a href="https://github.com/qemu/qemu/commit/ce437484fced8292d90497d7b740335428fffed6">this QEMU commit</a> seems relevant as something that could lead to misinterpretation of a field like <code>ss_flags</code>.</p>
<p>That fix went into QEMU 5.2; Docker For Mac seems to package QEMU 5.0.1.</p>
</blockquote>



<a name="249901281"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%233203%20Mac%20M1%20Docker%20crash/near/249901281" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.233203.20Mac.20M1.20Docker.20crash.html#249901281">(Aug 18 2021 at 19:37)</a>:</h4>
<p>peterhuene edited a <a href="https://github.com/bytecodealliance/wasmtime/issues/3203#issuecomment-901377799">comment</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/3203">issue #3203</a>:</p>
<blockquote>
<p>22 is <code>EINVAL</code>.</p>
<p>My gut tells me that the bug fixed by this <a href="https://github.com/qemu/qemu/commit/ce437484fced8292d90497d7b740335428fffed6">QEMU commit</a> seems relevant as something that could lead to misinterpretation of a field like <code>ss_flags</code>.</p>
<p>That fix went into QEMU 5.2; Docker For Mac seems to package QEMU 5.0.1.</p>
</blockquote>



<a name="249901329"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%233203%20Mac%20M1%20Docker%20crash/near/249901329" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.233203.20Mac.20M1.20Docker.20crash.html#249901329">(Aug 18 2021 at 19:37)</a>:</h4>
<p>otaviopace edited a <a href="https://github.com/bytecodealliance/wasmtime/issues/3203#issuecomment-901377590">comment</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/3203">issue #3203</a>:</p>
<blockquote>
<p>Unfortunetelly this really isn't a problem with <code>wasmtime</code> itself, I'll close this for now, thanks a lot for the help <span aria-label="heart" class="emoji emoji-2764" role="img" title="heart">:heart:</span>️ </p>
</blockquote>



<a name="249901343"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%233203%20Mac%20M1%20Docker%20crash/near/249901343" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.233203.20Mac.20M1.20Docker.20crash.html#249901343">(Aug 18 2021 at 19:37)</a>:</h4>
<p>otaviopace edited a <a href="https://github.com/bytecodealliance/wasmtime/issues/3203#issuecomment-901377590">comment</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/3203">issue #3203</a>:</p>
<blockquote>
<p>Unfortunetely this really isn't a problem with <code>wasmtime</code> itself, I'll close this for now, thanks a lot for the help <span aria-label="heart" class="emoji emoji-2764" role="img" title="heart">:heart:</span>️ </p>
</blockquote>



<a name="249901650"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%233203%20Mac%20M1%20Docker%20crash/near/249901650" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.233203.20Mac.20M1.20Docker.20crash.html#249901650">(Aug 18 2021 at 19:40)</a>:</h4>
<p>otaviopace <a href="https://github.com/bytecodealliance/wasmtime/issues/3203#issuecomment-901379654">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/3203">issue #3203</a>:</p>
<blockquote>
<p>How do you know which version of QEMU does Docker for Mac use?</p>
<p>I would like to keep an eye where I can know this version bump happened.</p>
</blockquote>



<a name="249901702"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%233203%20Mac%20M1%20Docker%20crash/near/249901702" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.233203.20Mac.20M1.20Docker.20crash.html#249901702">(Aug 18 2021 at 19:40)</a>:</h4>
<p>otaviopace edited a <a href="https://github.com/bytecodealliance/wasmtime/issues/3203#issuecomment-901379654">comment</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/3203">issue #3203</a>:</p>
<blockquote>
<p>How do you know which version of QEMU does Docker for Mac use?</p>
<p>I would like to keep an eye for when this version bump happens.</p>
</blockquote>



<a name="249901778"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%233203%20Mac%20M1%20Docker%20crash/near/249901778" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.233203.20Mac.20M1.20Docker.20crash.html#249901778">(Aug 18 2021 at 19:41)</a>:</h4>
<p>peterhuene <a href="https://github.com/bytecodealliance/wasmtime/issues/3203#issuecomment-901380407">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/3203">issue #3203</a>:</p>
<blockquote>
<p>I pulled it from the <a href="https://docs.docker.com/desktop/mac/release-notes">Docker for Mac's release notes</a>, last upgrade mentioning QEMU was 3.2.0, so I assume it hasn't been bumped since.</p>
</blockquote>



<a name="249959832"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%233203%20Mac%20M1%20Docker%20crash/near/249959832" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.233203.20Mac.20M1.20Docker.20crash.html#249959832">(Aug 19 2021 at 09:04)</a>:</h4>
<p>bnjbvr <a href="https://github.com/bytecodealliance/wasmtime/issues/3203#issuecomment-901740722">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/3203">issue #3203</a>:</p>
<blockquote>
<p>(Glad I could help! thanks for the ping @cfallin, I'm happy to investigate any Mac M1 specific failures.)</p>
</blockquote>



<a name="249978682"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%233203%20Mac%20M1%20Docker%20crash/near/249978682" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.233203.20Mac.20M1.20Docker.20crash.html#249978682">(Aug 19 2021 at 12:29)</a>:</h4>
<p>otaviopace <a href="https://github.com/bytecodealliance/wasmtime/issues/3203#issuecomment-901874296">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/3203">issue #3203</a>:</p>
<blockquote>
<p>I've created an issue in Docker for Mac to know if they plan or not to do this version bump soon (of QEMU).</p>
<p>So if anyone wants to keep an eye/track this, here it is: <a href="https://github.com/docker/for-mac/issues/5919">https://github.com/docker/for-mac/issues/5919</a></p>
</blockquote>



<hr><p>Last updated: Jan 20 2025 at 06:04 UTC</p>
</html>