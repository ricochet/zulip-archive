<html>
<head><meta charset="utf-8"><title>wasmtime / PR #3254 Use relative `call` instructions betw... · git-wasmtime · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/index.html">git-wasmtime</a></h2>
<h3>Topic: <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.233254.20Use.20relative.20.60call.60.20instructions.20betw.2E.2E.2E.html">wasmtime / PR #3254 Use relative `call` instructions betw...</a></h3>

<hr>

<base href="https://bytecodealliance.zulipchat.com">

<head><link href="https://bytecodealliance.github.io/zulip-archive/style.css" rel="stylesheet"></head>

<a name="250848600"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%233254%20Use%20relative%20%60call%60%20instructions%20betw.../near/250848600" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.233254.20Use.20relative.20.60call.60.20instructions.20betw.2E.2E.2E.html#250848600">(Aug 26 2021 at 22:12)</a>:</h4>
<p>alexcrichton opened <a href="https://github.com/bytecodealliance/wasmtime/pull/3254">PR #3254</a> from <code>call-relative</code> to <code>main</code>:</p>
<blockquote>
<p>This commit is a relatively major change to the way that Wasmtime<br>
generates code for Wasm modules and how functions call each other.<br>
Prior to this commit all function calls between functions, even if they<br>
were defined in the same module, were done indirectly through a<br>
register. To implement this the backend would emit an absolute 8-byte<br>
relocation near all function calls, load that address into a register,<br>
and then call it. While this technique is simple to implement and easy<br>
to get right, it has two primary downsides associated with it:</p>
<ul>
<li>
<p>Function calls are always indirect which means they are more difficult<br>
  to predict, resulting in worse performance.</p>
</li>
<li>
<p>Generating a relocation-per-function call requires expensive<br>
  relocation resolution at module-load time, which can be a large<br>
  contributing factor to how long it takes to load a precompiled module.</p>
</li>
</ul>
<p>To fix these issues, while also compromising on the previously simple<br>
implementation technique, this commit switches wasm calls within a<br>
module to using the <code>colocated</code> flag enabled in Cranelift-speak, which<br>
basically means that a relative call instruction is used with a<br>
relocation that's resolved relative to the pc of the call instruction<br>
itself.</p>
<p>When switching the <code>colocated</code> flag to <code>true</code> this commit is also then<br>
able to move much of the relocation resolution from <code>wasmtime_jit::link</code><br>
into <code>wasmtime_cranelift::obj</code> during object-construction time. This<br>
frontloads all relocation work which means that there's actually no<br>
relocations related to function calls in the final image, solving both<br>
of our points above.</p>
<p>The main gotcha in implementing this technique is that there are<br>
hardware limitations to relative function calls which mean we can't<br>
simply blindly use them. AArch64, for example, can only go +/- 64 MB<br>
from the <code>bl</code> instruction to the target, which means that if the<br>
function we're calling is a greater distance away then we would fail to<br>
resolve that relocation. On x86_64 the limits are +/- 2GB which are much<br>
larger, but theoretically still feasible to hit. Consequently the main<br>
increase in implementation complexity is fixing this issue.</p>
<p>This issue is actually already present in Cranelift itself, and is<br>
internally one of the invariants handled by the <code>MachBuffer</code> type. When<br>
generating a function relative jumps between basic blocks have similar<br>
restrictions. At this time, however, I decided to not try to reuse<br>
<code>MachBuffer</code> for inter-function relocations. The main reason for this is<br>
that <code>MachBuffer</code> doesn't actually handle any of the cases that<br>
inter-function relocations need to handle, namely the 26-bit relocation<br>
and 32-bit relocations of AArch64 and x86_64. If a 26-bit relocation<br>
isn't resolvable because a function gets too large then <code>MachBuffer</code><br>
will simply panic. I also opted to not use <code>MachBuffer</code> for now, though,<br>
because it doesn't quite have the infrastructure already set up where<br>
when inserting an island for a smaller jump sequence the result should<br>
be a relocation to fill in later. Today it simply promotes a 19-bit<br>
branch on AArch64 to a 26-bit branch, assuming the 26 bits is enough.<br>
All-in-all I felt that at this time <code>MachBuffer</code> wasn't reusable enough<br>
and would need enough work that it was probably more worthwhile to do<br>
this in <code>wasmtime-cranelift</code> first and looking to unify the strategies<br>
in the future.</p>
<p>For these reasons the <code>wasmtime_cranelift::obj</code> module has grown in<br>
complexity quite a bit. This now entirely handles relative relocations<br>
between functions, automatically inserting "jump veneers" to resolve<br>
calls between functions that are too far away. The general strategy is<br>
similar to <code>MachBuffer</code>, but different in the final tracking of<br>
relocations. The current assumption is that each <code>TargetIsa</code> has the<br>
ability to generate a fixed "jump veneer" which internally has an 8-byte<br>
immediate value that is added to its own address to reach the<br>
destination of an indirect call. This relative jump, even in the veneer,<br>
means that when veneers are used we still don't need absolute<br>
relocations since the code is still all implemented as relative jumps.<br>
The veneer jumps, however, are larger in code size because they don't<br>
fit into the native versions.</p>
<p>I've added some simple testing of this for now. A synthetic compiler<br>
option was create to simply add padded 0s between functions and test<br>
cases implement various forms of calls that at least need veneers. A<br>
test is also included for x86_64, but it is unfortunately pretty slow<br>
because it requires generating 2GB of output. I'm hoping for now it's<br>
not too bad, but we can disable the test if it's prohibitive and<br>
otherwise just comment the necessary portions to be sure to run the<br>
ignored test if these parts of the code have changed.</p>
<p>The final end-result of this commit is that for a large module I'm<br>
working with the number of relocations dropped to zero, meaning that<br>
nothing actually needs to be done to the text section when it's loaded<br>
into memory (yay!). I haven't run final benchmarks yet but this is the<br>
last remaining source of significant slowdown when loading modules,<br>
after I land a number of other PRs both active and ones that I only have<br>
locally for now.</p>
<p>&lt;!--</p>
<p>Please ensure that the following steps are all taken care of before submitting<br>
the PR.</p>
<ul>
<li>
<p>[ ] This has been discussed in issue #..., or if not, please tell us why<br>
  here.</p>
</li>
<li>
<p>[ ] A short description of what this does, why it is needed; if the<br>
  description becomes long, the matter should probably be discussed in an issue<br>
  first.</p>
</li>
<li>
<p>[ ] This PR contains test cases, if meaningful.</p>
</li>
<li>[ ] A reviewer from the core maintainer team has been assigned for this PR.<br>
  If you don't know who could review this, please indicate so. The list of<br>
  suggested reviewers on the right can help you.</li>
</ul>
<p>Please ensure all communication adheres to the <a href="https://github.com/bytecodealliance/wasmtime/blob/master/CODE_OF_CONDUCT.md">code of
conduct</a>.<br>
--&gt;<br>
</p>
</blockquote>



<a name="250848624"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%233254%20Use%20relative%20%60call%60%20instructions%20betw.../near/250848624" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.233254.20Use.20relative.20.60call.60.20instructions.20betw.2E.2E.2E.html#250848624">(Aug 26 2021 at 22:12)</a>:</h4>
<p><strong>alexcrichton</strong> requested <a href="https://github.com/cfallin">cfallin</a> for a review on <a href="https://github.com/bytecodealliance/wasmtime/pull/3254">PR #3254</a>.</p>



<a name="250854493"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%233254%20Use%20relative%20%60call%60%20instructions%20betw.../near/250854493" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.233254.20Use.20relative.20.60call.60.20instructions.20betw.2E.2E.2E.html#250854493">(Aug 26 2021 at 23:03)</a>:</h4>
<p>akirilov-arm submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/3254#pullrequestreview-739985895">PR review</a>.</p>



<a name="250854494"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%233254%20Use%20relative%20%60call%60%20instructions%20betw.../near/250854494" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.233254.20Use.20relative.20.60call.60.20instructions.20betw.2E.2E.2E.html#250854494">(Aug 26 2021 at 23:03)</a>:</h4>
<p>akirilov-arm submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/3254#pullrequestreview-739985895">PR review</a>.</p>



<a name="250854495"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%233254%20Use%20relative%20%60call%60%20instructions%20betw.../near/250854495" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.233254.20Use.20relative.20.60call.60.20instructions.20betw.2E.2E.2E.html#250854495">(Aug 26 2021 at 23:03)</a>:</h4>
<p>akirilov-arm created <a href="https://github.com/bytecodealliance/wasmtime/pull/3254#discussion_r697019616">PR review comment</a>:</p>
<blockquote>
<p>This should be a load literal instruction, i.e. <code>ldr x16, 16</code>, and you should schedule it before the <code>adr</code> (whose offset would also be adjusted).</p>
</blockquote>



<a name="250854496"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%233254%20Use%20relative%20%60call%60%20instructions%20betw.../near/250854496" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.233254.20Use.20relative.20.60call.60.20instructions.20betw.2E.2E.2E.html#250854496">(Aug 26 2021 at 23:03)</a>:</h4>
<p>akirilov-arm created <a href="https://github.com/bytecodealliance/wasmtime/pull/3254#discussion_r697017444">PR review comment</a>:</p>
<blockquote>
<p>Typo - <code>generates</code>.</p>
</blockquote>



<a name="250854502"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%233254%20Use%20relative%20%60call%60%20instructions%20betw.../near/250854502" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.233254.20Use.20relative.20.60call.60.20instructions.20betw.2E.2E.2E.html#250854502">(Aug 26 2021 at 23:03)</a>:</h4>
<p>akirilov-arm created <a href="https://github.com/bytecodealliance/wasmtime/pull/3254#discussion_r697017597">PR review comment</a>:</p>
<blockquote>
<p><code>x16</code> should be <code>x17</code>, shouldn't it?</p>
</blockquote>



<a name="250859189"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%233254%20Use%20relative%20%60call%60%20instructions%20betw.../near/250859189" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.233254.20Use.20relative.20.60call.60.20instructions.20betw.2E.2E.2E.html#250859189">(Aug 27 2021 at 00:00)</a>:</h4>
<p>alexcrichton updated <a href="https://github.com/bytecodealliance/wasmtime/pull/3254">PR #3254</a> from <code>call-relative</code> to <code>main</code>.</p>



<a name="250864444"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%233254%20Use%20relative%20%60call%60%20instructions%20betw.../near/250864444" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.233254.20Use.20relative.20.60call.60.20instructions.20betw.2E.2E.2E.html#250864444">(Aug 27 2021 at 01:16)</a>:</h4>
<p>akirilov-arm submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/3254#pullrequestreview-740056483">PR review</a>.</p>



<a name="250864445"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%233254%20Use%20relative%20%60call%60%20instructions%20betw.../near/250864445" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.233254.20Use.20relative.20.60call.60.20instructions.20betw.2E.2E.2E.html#250864445">(Aug 27 2021 at 01:16)</a>:</h4>
<p>akirilov-arm submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/3254#pullrequestreview-740056483">PR review</a>.</p>



<a name="250864446"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%233254%20Use%20relative%20%60call%60%20instructions%20betw.../near/250864446" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.233254.20Use.20relative.20.60call.60.20instructions.20betw.2E.2E.2E.html#250864446">(Aug 27 2021 at 01:16)</a>:</h4>
<p>akirilov-arm created <a href="https://github.com/bytecodealliance/wasmtime/pull/3254#discussion_r697078992">PR review comment</a>:</p>
<blockquote>
<p>Ditto.</p>
</blockquote>



<a name="250864447"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%233254%20Use%20relative%20%60call%60%20instructions%20betw.../near/250864447" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.233254.20Use.20relative.20.60call.60.20instructions.20betw.2E.2E.2E.html#250864447">(Aug 27 2021 at 01:16)</a>:</h4>
<p>akirilov-arm created <a href="https://github.com/bytecodealliance/wasmtime/pull/3254#discussion_r697079062">PR review comment</a>:</p>
<blockquote>
<p><code>adr x17, 12</code></p>
</blockquote>



<a name="250864448"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%233254%20Use%20relative%20%60call%60%20instructions%20betw.../near/250864448" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.233254.20Use.20relative.20.60call.60.20instructions.20betw.2E.2E.2E.html#250864448">(Aug 27 2021 at 01:16)</a>:</h4>
<p>akirilov-arm created <a href="https://github.com/bytecodealliance/wasmtime/pull/3254#discussion_r697078938">PR review comment</a>:</p>
<blockquote>
<p>Has this been added by mistake?</p>
</blockquote>



<a name="250915690"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%233254%20Use%20relative%20%60call%60%20instructions%20betw.../near/250915690" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.233254.20Use.20relative.20.60call.60.20instructions.20betw.2E.2E.2E.html#250915690">(Aug 27 2021 at 11:11)</a>:</h4>
<p>bjorn3 submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/3254#pullrequestreview-740409991">PR review</a>.</p>



<a name="250915692"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%233254%20Use%20relative%20%60call%60%20instructions%20betw.../near/250915692" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.233254.20Use.20relative.20.60call.60.20instructions.20betw.2E.2E.2E.html#250915692">(Aug 27 2021 at 11:11)</a>:</h4>
<p>bjorn3 created <a href="https://github.com/bytecodealliance/wasmtime/pull/3254#discussion_r697357849">PR review comment</a>:</p>
<blockquote>
<p>Using a markdown code block like done here makes sense to me.</p>
</blockquote>



<a name="250915862"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%233254%20Use%20relative%20%60call%60%20instructions%20betw.../near/250915862" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.233254.20Use.20relative.20.60call.60.20instructions.20betw.2E.2E.2E.html#250915862">(Aug 27 2021 at 11:12)</a>:</h4>
<p>bjorn3 submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/3254#pullrequestreview-740411182">PR review</a>.</p>



<a name="250915863"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%233254%20Use%20relative%20%60call%60%20instructions%20betw.../near/250915863" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.233254.20Use.20relative.20.60call.60.20instructions.20betw.2E.2E.2E.html#250915863">(Aug 27 2021 at 11:12)</a>:</h4>
<p>bjorn3 created <a href="https://github.com/bytecodealliance/wasmtime/pull/3254#discussion_r697358745">PR review comment</a>:</p>
<blockquote>
<p><div class="codehilite" data-code-language="suggestion"><pre><span></span><code>/// This generates:
</code></pre></div><br>
</p>
</blockquote>



<a name="250916436"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%233254%20Use%20relative%20%60call%60%20instructions%20betw.../near/250916436" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.233254.20Use.20relative.20.60call.60.20instructions.20betw.2E.2E.2E.html#250916436">(Aug 27 2021 at 11:19)</a>:</h4>
<p>bjorn3 submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/3254#pullrequestreview-740415371">PR review</a>.</p>



<a name="250916438"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%233254%20Use%20relative%20%60call%60%20instructions%20betw.../near/250916438" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.233254.20Use.20relative.20.60call.60.20instructions.20betw.2E.2E.2E.html#250916438">(Aug 27 2021 at 11:19)</a>:</h4>
<p>bjorn3 created <a href="https://github.com/bytecodealliance/wasmtime/pull/3254#discussion_r697361974">PR review comment</a>:</p>
<blockquote>
<p><div class="codehilite" data-code-language="suggestion"><pre><span></span><code>        if name == "wasmtime_linkopt_padding_between_functions" {
            self.linkopts.padding_between_functions = value.parse()?;
            return Ok(());
        }
        if name == "wasmtime_linkopt_force_jump_veneer" {
</code></pre></div><br>
</p>
</blockquote>



<a name="250916511"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%233254%20Use%20relative%20%60call%60%20instructions%20betw.../near/250916511" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.233254.20Use.20relative.20.60call.60.20instructions.20betw.2E.2E.2E.html#250916511">(Aug 27 2021 at 11:19)</a>:</h4>
<p>bjorn3 submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/3254#pullrequestreview-740415972">PR review</a>.</p>



<a name="250916512"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%233254%20Use%20relative%20%60call%60%20instructions%20betw.../near/250916512" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.233254.20Use.20relative.20.60call.60.20instructions.20betw.2E.2E.2E.html#250916512">(Aug 27 2021 at 11:19)</a>:</h4>
<p>bjorn3 created <a href="https://github.com/bytecodealliance/wasmtime/pull/3254#discussion_r697362407">PR review comment</a>:</p>
<blockquote>
<div class="codehilite" data-code-language="suggestion"><pre><span></span><code>            self.linkopts.force_jump_veneers = value.parse().unwrap();
</code></pre></div>
<p>to prevent silently ignoring invalid values.</p>
</blockquote>



<a name="250916529"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%233254%20Use%20relative%20%60call%60%20instructions%20betw.../near/250916529" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.233254.20Use.20relative.20.60call.60.20instructions.20betw.2E.2E.2E.html#250916529">(Aug 27 2021 at 11:19)</a>:</h4>
<p>bjorn3 edited <a href="https://github.com/bytecodealliance/wasmtime/pull/3254#discussion_r697362407">PR review comment</a>.</p>



<a name="250916749"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%233254%20Use%20relative%20%60call%60%20instructions%20betw.../near/250916749" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.233254.20Use.20relative.20.60call.60.20instructions.20betw.2E.2E.2E.html#250916749">(Aug 27 2021 at 11:21)</a>:</h4>
<p>bjorn3 created <a href="https://github.com/bytecodealliance/wasmtime/pull/3254#discussion_r697363461">PR review comment</a>:</p>
<blockquote>
<p><div class="codehilite" data-code-language="suggestion"><pre><span></span><code>    /// Packed form of windows unwind tables which, if present, will get emited
</code></pre></div><br>
</p>
</blockquote>



<a name="250916750"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%233254%20Use%20relative%20%60call%60%20instructions%20betw.../near/250916750" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.233254.20Use.20relative.20.60call.60.20instructions.20betw.2E.2E.2E.html#250916750">(Aug 27 2021 at 11:21)</a>:</h4>
<p>bjorn3 submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/3254#pullrequestreview-740417380">PR review</a>.</p>



<a name="250917381"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%233254%20Use%20relative%20%60call%60%20instructions%20betw.../near/250917381" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.233254.20Use.20relative.20.60call.60.20instructions.20betw.2E.2E.2E.html#250917381">(Aug 27 2021 at 11:27)</a>:</h4>
<p>bjorn3 created <a href="https://github.com/bytecodealliance/wasmtime/pull/3254#discussion_r697366287">PR review comment</a>:</p>
<blockquote>
<p>Maybe make this <code>ud2</code> on x86?</p>
</blockquote>



<a name="250917382"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%233254%20Use%20relative%20%60call%60%20instructions%20betw.../near/250917382" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.233254.20Use.20relative.20.60call.60.20instructions.20betw.2E.2E.2E.html#250917382">(Aug 27 2021 at 11:27)</a>:</h4>
<p>bjorn3 submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/3254#pullrequestreview-740421248">PR review</a>.</p>



<a name="250950014"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%233254%20Use%20relative%20%60call%60%20instructions%20betw.../near/250950014" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.233254.20Use.20relative.20.60call.60.20instructions.20betw.2E.2E.2E.html#250950014">(Aug 27 2021 at 15:37)</a>:</h4>
<p>alexcrichton edited <a href="https://github.com/bytecodealliance/wasmtime/pull/3254">PR #3254</a> from <code>call-relative</code> to <code>main</code>:</p>
<blockquote>
<p>This commit is a relatively major change to the way that Wasmtime<br>
generates code for Wasm modules and how functions call each other.<br>
Prior to this commit all function calls between functions, even if they<br>
were defined in the same module, were done indirectly through a<br>
register. To implement this the backend would emit an absolute 8-byte<br>
relocation near all function calls, load that address into a register,<br>
and then call it. While this technique is simple to implement and easy<br>
to get right, it has two primary downsides associated with it:</p>
<ul>
<li>
<p>Function calls are always indirect which means they are more difficult<br>
  to predict, resulting in worse performance.</p>
</li>
<li>
<p>Generating a relocation-per-function call requires expensive<br>
  relocation resolution at module-load time, which can be a large<br>
  contributing factor to how long it takes to load a precompiled module.</p>
</li>
</ul>
<p>To fix these issues, while also compromising on the previously simple<br>
implementation technique, this commit switches wasm calls within a<br>
module to using the <code>colocated</code> flag enabled in Cranelift-speak, which<br>
basically means that a relative call instruction is used with a<br>
relocation that's resolved relative to the pc of the call instruction<br>
itself.</p>
<p>When switching the <code>colocated</code> flag to <code>true</code> this commit is also then<br>
able to move much of the relocation resolution from <code>wasmtime_jit::link</code><br>
into <code>wasmtime_cranelift::obj</code> during object-construction time. This<br>
frontloads all relocation work which means that there's actually no<br>
relocations related to function calls in the final image, solving both<br>
of our points above.</p>
<p>The main gotcha in implementing this technique is that there are<br>
hardware limitations to relative function calls which mean we can't<br>
simply blindly use them. AArch64, for example, can only go +/- 64 MB<br>
from the <code>bl</code> instruction to the target, which means that if the<br>
function we're calling is a greater distance away then we would fail to<br>
resolve that relocation. On x86_64 the limits are +/- 2GB which are much<br>
larger, but theoretically still feasible to hit. Consequently the main<br>
increase in implementation complexity is fixing this issue.</p>
<p>This issue is actually already present in Cranelift itself, and is<br>
internally one of the invariants handled by the <code>MachBuffer</code> type. When<br>
generating a function relative jumps between basic blocks have similar<br>
restrictions. At this time, however, I decided to not try to reuse<br>
<code>MachBuffer</code> for inter-function relocations. The main reason for this is<br>
that <code>MachBuffer</code> doesn't actually handle any of the cases that<br>
inter-function relocations need to handle, namely the 26-bit relocation<br>
and 32-bit relocations of AArch64 and x86_64. If a 26-bit relocation<br>
isn't resolvable because a function gets too large then <code>MachBuffer</code><br>
will simply panic. I also opted to not use <code>MachBuffer</code> for now, though,<br>
because it doesn't quite have the infrastructure already set up where<br>
when inserting an island for a smaller jump sequence the result should<br>
be a relocation to fill in later. Today it simply promotes a 19-bit<br>
branch on AArch64 to a 26-bit branch, assuming the 26 bits is enough.<br>
All-in-all I felt that at this time <code>MachBuffer</code> wasn't reusable enough<br>
and would need enough work that it was probably more worthwhile to do<br>
this in <code>wasmtime-cranelift</code> first and looking to unify the strategies<br>
in the future.</p>
<p>For these reasons the <code>wasmtime_cranelift::obj</code> module has grown in<br>
complexity quite a bit. This now entirely handles relative relocations<br>
between functions, automatically inserting "jump veneers" to resolve<br>
calls between functions that are too far away. The general strategy is<br>
similar to <code>MachBuffer</code>, but different in the final tracking of<br>
relocations. The current assumption is that each <code>TargetIsa</code> has the<br>
ability to generate a fixed "jump veneer" which internally has an 8-byte<br>
immediate value that is added to its own address to reach the<br>
destination of an indirect call. This relative jump, even in the veneer,<br>
means that when veneers are used we still don't need absolute<br>
relocations since the code is still all implemented as relative jumps.<br>
The veneer jumps, however, are larger in code size because they don't<br>
fit into the native versions.</p>
<p>I've added some simple testing of this for now. A synthetic compiler<br>
option was create to simply add padded 0s between functions and test<br>
cases implement various forms of calls that at least need veneers. A<br>
test is also included for x86_64, but it is unfortunately pretty slow<br>
because it requires generating 2GB of output. I'm hoping for now it's<br>
not too bad, but we can disable the test if it's prohibitive and<br>
otherwise just comment the necessary portions to be sure to run the<br>
ignored test if these parts of the code have changed.</p>
<p>The final end-result of this commit is that for a large module I'm<br>
working with the number of relocations dropped to zero, meaning that<br>
nothing actually needs to be done to the text section when it's loaded<br>
into memory (yay!). I haven't run final benchmarks yet but this is the<br>
last remaining source of significant slowdown when loading modules,<br>
after I land a number of other PRs both active and ones that I only have<br>
locally for now.</p>
<p>cc #3230<br>
</p>
</blockquote>



<a name="250955920"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%233254%20Use%20relative%20%60call%60%20instructions%20betw.../near/250955920" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.233254.20Use.20relative.20.60call.60.20instructions.20betw.2E.2E.2E.html#250955920">(Aug 27 2021 at 16:20)</a>:</h4>
<p>alexcrichton updated <a href="https://github.com/bytecodealliance/wasmtime/pull/3254">PR #3254</a> from <code>call-relative</code> to <code>main</code>.</p>



<a name="250956022"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%233254%20Use%20relative%20%60call%60%20instructions%20betw.../near/250956022" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.233254.20Use.20relative.20.60call.60.20instructions.20betw.2E.2E.2E.html#250956022">(Aug 27 2021 at 16:20)</a>:</h4>
<p>alexcrichton submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/3254#pullrequestreview-740691430">PR review</a>.</p>



<a name="250956023"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%233254%20Use%20relative%20%60call%60%20instructions%20betw.../near/250956023" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.233254.20Use.20relative.20.60call.60.20instructions.20betw.2E.2E.2E.html#250956023">(Aug 27 2021 at 16:20)</a>:</h4>
<p>alexcrichton created <a href="https://github.com/bytecodealliance/wasmtime/pull/3254#discussion_r697566395">PR review comment</a>:</p>
<blockquote>
<p>Nah this is because rustdoc tries to test all code blocks as Rust code so I needed to add an annotation that it's not actually Rust code.</p>
</blockquote>



<a name="250964476"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%233254%20Use%20relative%20%60call%60%20instructions%20betw.../near/250964476" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.233254.20Use.20relative.20.60call.60.20instructions.20betw.2E.2E.2E.html#250964476">(Aug 27 2021 at 17:21)</a>:</h4>
<p>alexcrichton updated <a href="https://github.com/bytecodealliance/wasmtime/pull/3254">PR #3254</a> from <code>call-relative</code> to <code>main</code>.</p>



<a name="250978797"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%233254%20Use%20relative%20%60call%60%20instructions%20betw.../near/250978797" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.233254.20Use.20relative.20.60call.60.20instructions.20betw.2E.2E.2E.html#250978797">(Aug 27 2021 at 18:58)</a>:</h4>
<p>alexcrichton updated <a href="https://github.com/bytecodealliance/wasmtime/pull/3254">PR #3254</a> from <code>call-relative</code> to <code>main</code>.</p>



<a name="250979224"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%233254%20Use%20relative%20%60call%60%20instructions%20betw.../near/250979224" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.233254.20Use.20relative.20.60call.60.20instructions.20betw.2E.2E.2E.html#250979224">(Aug 27 2021 at 19:01)</a>:</h4>
<p>alexcrichton updated <a href="https://github.com/bytecodealliance/wasmtime/pull/3254">PR #3254</a> from <code>call-relative</code> to <code>main</code>.</p>



<a name="250980862"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%233254%20Use%20relative%20%60call%60%20instructions%20betw.../near/250980862" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.233254.20Use.20relative.20.60call.60.20instructions.20betw.2E.2E.2E.html#250980862">(Aug 27 2021 at 19:12)</a>:</h4>
<p>alexcrichton updated <a href="https://github.com/bytecodealliance/wasmtime/pull/3254">PR #3254</a> from <code>call-relative</code> to <code>main</code>.</p>



<a name="250990869"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%233254%20Use%20relative%20%60call%60%20instructions%20betw.../near/250990869" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.233254.20Use.20relative.20.60call.60.20instructions.20betw.2E.2E.2E.html#250990869">(Aug 27 2021 at 20:28)</a>:</h4>
<p>alexcrichton updated <a href="https://github.com/bytecodealliance/wasmtime/pull/3254">PR #3254</a> from <code>call-relative</code> to <code>main</code>.</p>



<a name="250997408"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%233254%20Use%20relative%20%60call%60%20instructions%20betw.../near/250997408" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.233254.20Use.20relative.20.60call.60.20instructions.20betw.2E.2E.2E.html#250997408">(Aug 27 2021 at 21:21)</a>:</h4>
<p>alexcrichton updated <a href="https://github.com/bytecodealliance/wasmtime/pull/3254">PR #3254</a> from <code>call-relative</code> to <code>main</code>.</p>



<a name="250999692"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%233254%20Use%20relative%20%60call%60%20instructions%20betw.../near/250999692" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.233254.20Use.20relative.20.60call.60.20instructions.20betw.2E.2E.2E.html#250999692">(Aug 27 2021 at 21:41)</a>:</h4>
<p>alexcrichton updated <a href="https://github.com/bytecodealliance/wasmtime/pull/3254">PR #3254</a> from <code>call-relative</code> to <code>main</code>.</p>



<a name="251008162"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%233254%20Use%20relative%20%60call%60%20instructions%20betw.../near/251008162" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.233254.20Use.20relative.20.60call.60.20instructions.20betw.2E.2E.2E.html#251008162">(Aug 27 2021 at 23:12)</a>:</h4>
<p>alexcrichton updated <a href="https://github.com/bytecodealliance/wasmtime/pull/3254">PR #3254</a> from <code>call-relative</code> to <code>main</code>.</p>



<a name="251015448"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%233254%20Use%20relative%20%60call%60%20instructions%20betw.../near/251015448" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.233254.20Use.20relative.20.60call.60.20instructions.20betw.2E.2E.2E.html#251015448">(Aug 28 2021 at 00:59)</a>:</h4>
<p>alexcrichton updated <a href="https://github.com/bytecodealliance/wasmtime/pull/3254">PR #3254</a> from <code>call-relative</code> to <code>main</code>.</p>



<a name="251269416"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%233254%20Use%20relative%20%60call%60%20instructions%20betw.../near/251269416" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.233254.20Use.20relative.20.60call.60.20instructions.20betw.2E.2E.2E.html#251269416">(Aug 30 2021 at 18:07)</a>:</h4>
<p>cfallin submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/3254#pullrequestreview-741900007">PR review</a>.</p>



<a name="251269417"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%233254%20Use%20relative%20%60call%60%20instructions%20betw.../near/251269417" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.233254.20Use.20relative.20.60call.60.20instructions.20betw.2E.2E.2E.html#251269417">(Aug 30 2021 at 18:07)</a>:</h4>
<p>cfallin submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/3254#pullrequestreview-741900007">PR review</a>.</p>



<a name="251269418"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%233254%20Use%20relative%20%60call%60%20instructions%20betw.../near/251269418" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.233254.20Use.20relative.20.60call.60.20instructions.20betw.2E.2E.2E.html#251269418">(Aug 30 2021 at 18:07)</a>:</h4>
<p>cfallin created <a href="https://github.com/bytecodealliance/wasmtime/pull/3254#discussion_r698678011">PR review comment</a>:</p>
<blockquote>
<p>Two thoughts on this new addition to the backend trait:</p>
<ul>
<li>
<p>I think there might be an opportunity to merge this per-backend behavior into the <code>LabelUse</code> trait already defined by each backend. The generated trampoline code is playing almost the same role -- extending the range of a branch and allowing a shorter-range reloc to be converted to a longer-range one -- except that, unlike intra-function veneers, it also assumes the use of various registers.</p>
<p>That last bit is a key difference. In the aarch64 case <code>x16</code> and <code>x17</code> are used internally to instruction-lowering sequences but never across basic blocks, so this is fine; but <code>r10</code> and <code>r11</code> on x86-64 will potentially be used by regalloc, so we wouldn't want to blindly insert this as another type of veneer in the existing trait. So we'd want to add some parameters to the <code>supports_veneer</code>, <code>veneer_size</code> and <code>generate_veneer</code> functions to indicate what kind of veneer ("next step up in range" or "absolute" maybe) and whether the use of regs as per ABI for inter-function transfers is allowed.</p>
<p>Whatever we do, it strikes me that the duplication here ("veneers" in two places, with similar APIs) is likely to confuse others so we should somehow merge them or distinguish them better. Furthermore if we're going to have low-level understanding of branches (e.g. embedded machine-code bits in a sequence to emit) we should have that in as few places as possible.</p>
</li>
<li>
<p>I am wondering if there is a better name than "veneer", if we don't merge; maybe "trampoline" or "linkage stub"?</p>
</li>
</ul>
</blockquote>



<a name="251269419"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%233254%20Use%20relative%20%60call%60%20instructions%20betw.../near/251269419" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.233254.20Use.20relative.20.60call.60.20instructions.20betw.2E.2E.2E.html#251269419">(Aug 30 2021 at 18:07)</a>:</h4>
<p>cfallin created <a href="https://github.com/bytecodealliance/wasmtime/pull/3254#discussion_r698678705">PR review comment</a>:</p>
<blockquote>
<p>Do we still need this if we have the option below (force veneers) as well?</p>
</blockquote>



<a name="251269421"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%233254%20Use%20relative%20%60call%60%20instructions%20betw.../near/251269421" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.233254.20Use.20relative.20.60call.60.20instructions.20betw.2E.2E.2E.html#251269421">(Aug 30 2021 at 18:07)</a>:</h4>
<p>cfallin created <a href="https://github.com/bytecodealliance/wasmtime/pull/3254#discussion_r698683792">PR review comment</a>:</p>
<blockquote>
<p>For maps from one index space to another I like the <code>X_to_Y</code> naming idiom to make it clear what the index and value are; maybe <code>text_offset_to_text_contents_index</code>? Verbose I know but getting index spaces crossed is a potent footgun...</p>
</blockquote>



<a name="251269422"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%233254%20Use%20relative%20%60call%60%20instructions%20betw.../near/251269422" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.233254.20Use.20relative.20.60call.60.20instructions.20betw.2E.2E.2E.html#251269422">(Aug 30 2021 at 18:07)</a>:</h4>
<p>cfallin created <a href="https://github.com/bytecodealliance/wasmtime/pull/3254#discussion_r698684227">PR review comment</a>:</p>
<blockquote>
<p>resolved before the...? (don't leave me hanging, I need to know how this story ends!)</p>
</blockquote>



<a name="251269423"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%233254%20Use%20relative%20%60call%60%20instructions%20betw.../near/251269423" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.233254.20Use.20relative.20.60call.60.20instructions.20betw.2E.2E.2E.html#251269423">(Aug 30 2021 at 18:07)</a>:</h4>
<p>cfallin created <a href="https://github.com/bytecodealliance/wasmtime/pull/3254#discussion_r698688956">PR review comment</a>:</p>
<blockquote>
<p>Can you add a reference to the <code>MachBuffer</code> code that does this too? The cases are the same (known/in-bounds, known, out-of-bounds, unknown) and it'd be helpful to cross-reference where else this logic is used :-)</p>
</blockquote>



<a name="251269424"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%233254%20Use%20relative%20%60call%60%20instructions%20betw.../near/251269424" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.233254.20Use.20relative.20.60call.60.20instructions.20betw.2E.2E.2E.html#251269424">(Aug 30 2021 at 18:07)</a>:</h4>
<p>cfallin created <a href="https://github.com/bytecodealliance/wasmtime/pull/3254#discussion_r698687293">PR review comment</a>:</p>
<blockquote>
<p>can you add a TODO here referencing one of the remove-old-backends issues/PRs (<a href="https://github.com/bytecodealliance/rfcs/issues/12">bytecodealliance/rfcs#12</a> maybe) so we can grep this when the time comes?</p>
</blockquote>



<a name="251269425"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%233254%20Use%20relative%20%60call%60%20instructions%20betw.../near/251269425" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.233254.20Use.20relative.20.60call.60.20instructions.20betw.2E.2E.2E.html#251269425">(Aug 30 2021 at 18:07)</a>:</h4>
<p>cfallin created <a href="https://github.com/bytecodealliance/wasmtime/pull/3254#discussion_r698685664">PR review comment</a>:</p>
<blockquote>
<p>Maybe at least a <code>checked_add</code> here, if not some clamping? A hypothetical machine with a 64-bit branch that can do a relative jump anywhere would overflow otherwise.</p>
</blockquote>



<a name="251269426"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%233254%20Use%20relative%20%60call%60%20instructions%20betw.../near/251269426" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.233254.20Use.20relative.20.60call.60.20instructions.20betw.2E.2E.2E.html#251269426">(Aug 30 2021 at 18:07)</a>:</h4>
<p>cfallin created <a href="https://github.com/bytecodealliance/wasmtime/pull/3254#discussion_r698690030">PR review comment</a>:</p>
<blockquote>
<p>"cache loads" is ambiguous here (my computer-architect mind thinks this means a normal memory load); maybe "to make loading compiled modules from disk more efficient"?</p>
</blockquote>



<a name="251269427"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%233254%20Use%20relative%20%60call%60%20instructions%20betw.../near/251269427" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.233254.20Use.20relative.20.60call.60.20instructions.20betw.2E.2E.2E.html#251269427">(Aug 30 2021 at 18:07)</a>:</h4>
<p>cfallin created <a href="https://github.com/bytecodealliance/wasmtime/pull/3254#discussion_r698681199">PR review comment</a>:</p>
<blockquote>
<p>I see here why you had to add methods to the <code>TargetIsa</code> to get at the veneer-generation implementation; above comments re: making use of <code>LabelUse</code> still apply and then maybe we could bounce through the <code>TargetIsa</code> to use those.</p>
</blockquote>



<a name="251269428"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%233254%20Use%20relative%20%60call%60%20instructions%20betw.../near/251269428" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.233254.20Use.20relative.20.60call.60.20instructions.20betw.2E.2E.2E.html#251269428">(Aug 30 2021 at 18:07)</a>:</h4>
<p>cfallin created <a href="https://github.com/bytecodealliance/wasmtime/pull/3254#discussion_r698682573">PR review comment</a>:</p>
<blockquote>
<p>Readability request: a little struct in place of this tuple, so we can write e.g. <code>TextSegmentFunction { body_bytes, alignment }</code> or something like that?</p>
</blockquote>



<a name="251269429"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%233254%20Use%20relative%20%60call%60%20instructions%20betw.../near/251269429" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.233254.20Use.20relative.20.60call.60.20instructions.20betw.2E.2E.2E.html#251269429">(Aug 30 2021 at 18:07)</a>:</h4>
<p>cfallin created <a href="https://github.com/bytecodealliance/wasmtime/pull/3254#discussion_r698690504">PR review comment</a>:</p>
<blockquote>
<p>There is some code in the runtime that applies relocations as well; can we consolidate the two implementations?</p>
</blockquote>



<a name="251274207"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%233254%20Use%20relative%20%60call%60%20instructions%20betw.../near/251274207" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.233254.20Use.20relative.20.60call.60.20instructions.20betw.2E.2E.2E.html#251274207">(Aug 30 2021 at 18:39)</a>:</h4>
<p>bjorn3 submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/3254#pullrequestreview-741952820">PR review</a>.</p>



<a name="251274209"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%233254%20Use%20relative%20%60call%60%20instructions%20betw.../near/251274209" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.233254.20Use.20relative.20.60call.60.20instructions.20betw.2E.2E.2E.html#251274209">(Aug 30 2021 at 18:39)</a>:</h4>
<p>bjorn3 created <a href="https://github.com/bytecodealliance/wasmtime/pull/3254#discussion_r698718229">PR review comment</a>:</p>
<blockquote>
<p>This function could be useful for cranelift-jit too. It also needs a version that loads the address from memory at a specific location like ELF PLT's. Currently it only has a x86_64 version for the latter function.</p>
</blockquote>



<a name="251458224"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%233254%20Use%20relative%20%60call%60%20instructions%20betw.../near/251458224" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.233254.20Use.20relative.20.60call.60.20instructions.20betw.2E.2E.2E.html#251458224">(Aug 31 2021 at 20:56)</a>:</h4>
<p>alexcrichton closed without merge <a href="https://github.com/bytecodealliance/wasmtime/pull/3254">PR #3254</a>.</p>



<a name="251459908"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%233254%20Use%20relative%20%60call%60%20instructions%20betw.../near/251459908" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.233254.20Use.20relative.20.60call.60.20instructions.20betw.2E.2E.2E.html#251459908">(Aug 31 2021 at 21:06)</a>:</h4>
<p>alexcrichton submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/3254#pullrequestreview-743195192">PR review</a>.</p>



<a name="251459909"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%233254%20Use%20relative%20%60call%60%20instructions%20betw.../near/251459909" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.233254.20Use.20relative.20.60call.60.20instructions.20betw.2E.2E.2E.html#251459909">(Aug 31 2021 at 21:06)</a>:</h4>
<p>alexcrichton created <a href="https://github.com/bytecodealliance/wasmtime/pull/3254#discussion_r699673784">PR review comment</a>:</p>
<blockquote>
<p>I'm going to leave this in for now because I think it's useful to exercise the veneers in real-world situations where they're actually needed. Otherwise I'd be worried that the logic for actually inserting veneers was only correct when the forcing was turned on. This way there's some exercising of the actual "ok yes we need that veneer" logic as well. (it's also relatively easy to support).</p>
</blockquote>



<a name="251465043"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%233254%20Use%20relative%20%60call%60%20instructions%20betw.../near/251465043" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.233254.20Use.20relative.20.60call.60.20instructions.20betw.2E.2E.2E.html#251465043">(Aug 31 2021 at 21:42)</a>:</h4>
<p>cfallin submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/3254#pullrequestreview-743220327">PR review</a>.</p>



<a name="251465044"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%233254%20Use%20relative%20%60call%60%20instructions%20betw.../near/251465044" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.233254.20Use.20relative.20.60call.60.20instructions.20betw.2E.2E.2E.html#251465044">(Aug 31 2021 at 21:42)</a>:</h4>
<p>cfallin created <a href="https://github.com/bytecodealliance/wasmtime/pull/3254#discussion_r699693645">PR review comment</a>:</p>
<blockquote>
<p>Makes sense!</p>
<p>Would it make sense to use it only in tests with the aarch64 backend (could be instantiated explicitly, doesn't need to run on aarch64 host), where the threshold for inserting an island is much lower, so we don't have the overhead of 2GiB object files in tests on x86?</p>
</blockquote>



<hr><p>Last updated: Jan 20 2025 at 06:04 UTC</p>
</html>