<html>
<head><meta charset="utf-8"><title>wasmtime / PR #8473 Isle sets and hash · git-wasmtime · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/index.html">git-wasmtime</a></h2>
<h3>Topic: <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.238473.20Isle.20sets.20and.20hash.html">wasmtime / PR #8473 Isle sets and hash</a></h3>

<hr>

<base href="https://bytecodealliance.zulipchat.com">

<head><link href="https://bytecodealliance.github.io/zulip-archive/style.css" rel="stylesheet"></head>

<a name="435380820"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%238473%20Isle%20sets%20and%20hash/near/435380820" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.238473.20Isle.20sets.20and.20hash.html#435380820">(Apr 25 2024 at 12:44)</a>:</h4>
<p>KGrewal1 opened <a href="https://github.com/bytecodealliance/wasmtime/pull/8473">PR #8473</a> from <code>KGrewal1:isle-sets_and_hash</code> to <code>bytecodealliance:main</code>:</p>
<blockquote>
<p>Main aim of this change was to change the behaviour of DisjointSet to early return as opposed to panic when passed <code>x==y</code> and to somewhat gain familiarity myself with the code<br>
</p>
</blockquote>



<a name="435380821"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%238473%20Isle%20sets%20and%20hash/near/435380821" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.238473.20Isle.20sets.20and.20hash.html#435380821">(Apr 25 2024 at 12:44)</a>:</h4>
<p><strong>KGrewal1</strong> requested <a href="https://github.com/abrown">abrown</a> for a review on <a href="https://github.com/bytecodealliance/wasmtime/pull/8473">PR #8473</a>.</p>



<a name="435380822"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%238473%20Isle%20sets%20and%20hash/near/435380822" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.238473.20Isle.20sets.20and.20hash.html#435380822">(Apr 25 2024 at 12:44)</a>:</h4>
<p><strong>KGrewal1</strong> requested <a href="https://github.com/orgs/bytecodealliance/teams/wasmtime-compiler-reviewers">wasmtime-compiler-reviewers</a> for a review on <a href="https://github.com/bytecodealliance/wasmtime/pull/8473">PR #8473</a>.</p>



<a name="435406708"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%238473%20Isle%20sets%20and%20hash/near/435406708" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.238473.20Isle.20sets.20and.20hash.html#435406708">(Apr 25 2024 at 14:45)</a>:</h4>
<p>github-actions[bot] <a href="https://github.com/bytecodealliance/wasmtime/pull/8473#issuecomment-2077402762">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/8473">PR #8473</a>:</p>
<blockquote>
<h4>Subscribe to Label Action</h4>
<p>cc @cfallin, @fitzgen</p>
<p>&lt;details&gt;<br>
This issue or pull request has been labeled: "cranelift", "isle"</p>
<p>Thus the following users have been cc'd because of the following labels:</p>
<ul>
<li>cfallin: isle</li>
<li>fitzgen: isle</li>
</ul>
<p>To subscribe or unsubscribe from this label, edit the &lt;code&gt;.github/subscribe-to-label.json&lt;/code&gt; configuration file.</p>
<p><a href="https://github.com/bytecodealliance/subscribe-to-label-action">Learn more.</a><br>
&lt;/details&gt;</p>
</blockquote>



<a name="435471104"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%238473%20Isle%20sets%20and%20hash/near/435471104" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.238473.20Isle.20sets.20and.20hash.html#435471104">(Apr 25 2024 at 21:31)</a>:</h4>
<p>abrown submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/8473#pullrequestreview-2023627328">PR review</a>:</p>
<blockquote>
<p>Overall this change makes sense to me (minus the dropped assertion) but I will defer to @jameysharp who's more recently touched this code.</p>
</blockquote>



<a name="435471105"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%238473%20Isle%20sets%20and%20hash/near/435471105" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.238473.20Isle.20sets.20and.20hash.html#435471105">(Apr 25 2024 at 21:31)</a>:</h4>
<p>abrown submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/8473#pullrequestreview-2023627328">PR review</a>:</p>
<blockquote>
<p>Overall this change makes sense to me (minus the dropped assertion) but I will defer to @jameysharp who's more recently touched this code.</p>
</blockquote>



<a name="435471108"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%238473%20Isle%20sets%20and%20hash/near/435471108" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.238473.20Isle.20sets.20and.20hash.html#435471108">(Apr 25 2024 at 21:31)</a>:</h4>
<p>abrown created <a href="https://github.com/bytecodealliance/wasmtime/pull/8473#discussion_r1580157339">PR review comment</a>:</p>
<blockquote>
<p>Not sure about this...</p>
</blockquote>



<a name="435476701"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%238473%20Isle%20sets%20and%20hash/near/435476701" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.238473.20Isle.20sets.20and.20hash.html#435476701">(Apr 25 2024 at 22:24)</a>:</h4>
<p>jameysharp <a href="https://github.com/bytecodealliance/wasmtime/pull/8473#issuecomment-2078271067">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/8473">PR #8473</a>:</p>
<blockquote>
<p>I want to say first of all that this shows that you've dug into the ISLE implementation pretty deeply and that's awesome. Thanks for working to understand it!</p>
<p>I think these changes are interesting, and although I'm leaning toward not taking these changes, I think the reasons for that are also interesting.</p>
<p>The two changes to use <code>StableMap</code> instead of <code>HashMap</code> both require peeking under the covers to get at the underlying <code>HashMap</code> to iterate over it, which of course is the one thing that <code>StableMap</code> is not supposed to allow. In both cases, the reason we're okay with the unstable iteration order is that we sort the results immediately afterward, making the result deterministic.</p>
<p>In <code>RuleSet::build</code>, the <code>HashMap</code> is used very briefly so it's easy to see that the result is deterministic, and there's a big comment pointing this out. I'm inclined to let that continue to just use a raw <code>HashMap</code>.</p>
<p>In <code>DisjointSets</code>, the <code>HashMap</code> is used a lot of different ways, so yes, it might be nice to use <code>StableMap</code> instead to make it clear that the results can't depend on order. But it's not easy to design a map API that is efficient, stable, and meets the needs of <code>DisjointSets</code>: for example, we could provide a <code>StableMap::keys</code> method that returns a sorted <code>Vec</code> of keys, but that takes time <code>O(n log n)</code> in the total size of the map, which I'd prefer to avoid. So I'm inclined to require instead that <code>DisjointSets</code> must produce deterministic results but it can continue to use non-deterministic implementations internally. It's not very big, so checking this isn't hard.</p>
<p>Finally: replacing <code>assert_ne!(x, y)</code> with an early-return clearly won't change any current behavior, since the early return would only happen when we currently panic, and we're not seeing ISLE panic there. So in that sense it's okay to make that change. It's also okay in the sense that it doesn't violate any data structure invariants. It preserves the current property that there are no singleton sets, which is useful for <code>trie_again</code>.</p>
<p>However, I would be surprised if there were a situation where it was convenient to silently ignore attempts to merge a binding with itself. If you find such a situation, let's talk about it! Otherwise I'd prefer to be explicit where <code>merge</code> is called, like in <code>add_match_equal</code> where there's an <code>if</code> statement checking this and a comment explaining what it means if it happens.</p>
<p>I see one thing this PRs highlights that you could help with, though: The <code>StableMap</code> and <code>DisjointSets</code> guarantees don't mean much if everything else can just reach into their private fields and bypass their carefully-constructed APIs. We should move these types into new modules so that Rust's visibility rules will ensure that the rest of the ISLE compiler can't use them incorrectly. Would you like to do that?</p>
</blockquote>



<a name="435539536"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%238473%20Isle%20sets%20and%20hash/near/435539536" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.238473.20Isle.20sets.20and.20hash.html#435539536">(Apr 26 2024 at 08:25)</a>:</h4>
<p>KGrewal1 <a href="https://github.com/bytecodealliance/wasmtime/pull/8473#issuecomment-2078892984">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/8473">PR #8473</a>:</p>
<blockquote>
<p>Thanks for looking through this: I will try looking at moving stable map and stable set to different modules so the inner maps are made private by the compiler!</p>
</blockquote>



<a name="435539550"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%238473%20Isle%20sets%20and%20hash/near/435539550" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.238473.20Isle.20sets.20and.20hash.html#435539550">(Apr 26 2024 at 08:25)</a>:</h4>
<p>KGrewal1 closed without merge <a href="https://github.com/bytecodealliance/wasmtime/pull/8473">PR #8473</a>.</p>



<hr><p>Last updated: Jan 20 2025 at 06:04 UTC</p>
</html>