<html>
<head><meta charset="utf-8"><title>wasmtime / issue #3733 Implement lazy funcref table and a... · git-wasmtime · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/index.html">git-wasmtime</a></h2>
<h3>Topic: <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.233733.20Implement.20lazy.20funcref.20table.20and.20a.2E.2E.2E.html">wasmtime / issue #3733 Implement lazy funcref table and a...</a></h3>

<hr>

<base href="https://bytecodealliance.zulipchat.com">

<head><link href="https://bytecodealliance.github.io/zulip-archive/style.css" rel="stylesheet"></head>

<a name="270511645"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%233733%20Implement%20lazy%20funcref%20table%20and%20a.../near/270511645" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.233733.20Implement.20lazy.20funcref.20table.20and.20a.2E.2E.2E.html#270511645">(Feb 03 2022 at 07:58)</a>:</h4>
<p>cfallin <a href="https://github.com/bytecodealliance/wasmtime/pull/3733#issuecomment-1028698903">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/3733">issue #3733</a>:</p>
<blockquote>
<p>I've implemented lazy table initialization now (mostly; there's one odd test failure with linking I need to resolve). It could probably be cleaned up somewhat, but here's one initial datapoint, with spidermonkey.wasm:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="p">(</span><span class="n">before</span><span class="p">)</span><span class="w"></span>

<span class="n">sequential</span><span class="o">/</span><span class="n">default</span><span class="o">/</span><span class="n">spidermonkey</span><span class="p">.</span><span class="n">wasm</span><span class="w"></span>
<span class="w">                        </span><span class="n">time</span>:   <span class="p">[</span><span class="mf">71.886</span><span class="w"> </span><span class="n">us</span><span class="w"> </span><span class="mf">72.012</span><span class="w"> </span><span class="n">us</span><span class="w"> </span><span class="mf">72.133</span><span class="w"> </span><span class="n">us</span><span class="p">]</span><span class="w"></span>

<span class="p">(</span><span class="n">after</span><span class="p">)</span><span class="w"></span>

<span class="n">sequential</span><span class="o">/</span><span class="n">default</span><span class="o">/</span><span class="n">spidermonkey</span><span class="p">.</span><span class="n">wasm</span><span class="w"></span>
<span class="w">                        </span><span class="n">time</span>:   <span class="p">[</span><span class="mf">22.243</span><span class="w"> </span><span class="n">us</span><span class="w"> </span><span class="mf">22.256</span><span class="w"> </span><span class="n">us</span><span class="w"> </span><span class="mf">22.270</span><span class="w"> </span><span class="n">us</span><span class="p">]</span><span class="w"></span>
<span class="w">                        </span><span class="n">change</span>: <span class="p">[</span><span class="o">-</span><span class="mf">69.117</span><span class="o">%</span><span class="w"> </span><span class="o">-</span><span class="mf">69.060</span><span class="o">%</span><span class="w"> </span><span class="o">-</span><span class="mf">69.000</span><span class="o">%</span><span class="p">]</span><span class="w"> </span><span class="p">(</span><span class="n">p</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.00</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mf">0.05</span><span class="p">)</span><span class="w"></span>
<span class="w">                        </span><span class="n">Performance</span><span class="w"> </span><span class="n">has</span><span class="w"> </span><span class="n">improved</span><span class="p">.</span><span class="w"></span>
</code></pre></div>
<p>So, 72µs to 22µs, or a 69% reduction.</p>
</blockquote>



<a name="270589241"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%233733%20Implement%20lazy%20funcref%20table%20and%20a.../near/270589241" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.233733.20Implement.20lazy.20funcref.20table.20and.20a.2E.2E.2E.html#270589241">(Feb 03 2022 at 17:45)</a>:</h4>
<p>cfallin <a href="https://github.com/bytecodealliance/wasmtime/pull/3733#issuecomment-1029241236">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/3733">issue #3733</a>:</p>
<blockquote>
<p>@alexcrichton (and anyone else watching) argh, sorry about that, I pushed my changes prior to last night's measurements to a private save-the-work-in-progress fork that I keep, but not here; just pushed now. Regardless the review comments are useful and I'll keep refining this!</p>
</blockquote>



<a name="270661376"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%233733%20Implement%20lazy%20funcref%20table%20and%20a.../near/270661376" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.233733.20Implement.20lazy.20funcref.20table.20and.20a.2E.2E.2E.html#270661376">(Feb 04 2022 at 02:56)</a>:</h4>
<p>cfallin <a href="https://github.com/bytecodealliance/wasmtime/pull/3733#issuecomment-1029591982">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/3733">issue #3733</a>:</p>
<blockquote>
<p>Should pass all tests now, and rebased on latest; I'll refactor as suggested above and get this ready for review tomorrow!</p>
</blockquote>



<a name="270795903"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%233733%20Implement%20lazy%20funcref%20table%20and%20a.../near/270795903" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.233733.20Implement.20lazy.20funcref.20table.20and.20a.2E.2E.2E.html#270795903">(Feb 05 2022 at 01:34)</a>:</h4>
<p>cfallin <a href="https://github.com/bytecodealliance/wasmtime/pull/3733#issuecomment-1030490561">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/3733">issue #3733</a>:</p>
<blockquote>
<p>@alexcrichton I've refactored roughly along the lines of what you suggested -- a single <code>Arc</code> to encapsulate all of the per-<code>Module</code> computed state that the runtime needs (memfds, lazy table backing, etc). I'm currently fighting some weird test failure (likely something stupid but I seemed to have broken trampolines), and haven't addressed a few of your more minor comments above; will continue to work on that, but this should give a preview of the basic direction.</p>
</blockquote>



<a name="270799727"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%233733%20Implement%20lazy%20funcref%20table%20and%20a.../near/270799727" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.233733.20Implement.20lazy.20funcref.20table.20and.20a.2E.2E.2E.html#270799727">(Feb 05 2022 at 02:49)</a>:</h4>
<p>cfallin edited a <a href="https://github.com/bytecodealliance/wasmtime/pull/3733#issuecomment-1030490561">comment</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/3733">issue #3733</a>:</p>
<blockquote>
<p>@alexcrichton I've refactored roughly along the lines of what you suggested -- a single <code>Arc</code> to encapsulate all of the per-<code>Module</code> computed state that the runtime needs (memfds, lazy table backing, etc). &lt;strike&gt;I'm currently fighting some weird test failure (likely something stupid but I seemed to have broken trampolines), and&lt;/strike&gt; haven't addressed a few of your more minor comments above; will continue to work on that, but this should give a preview of the basic direction.</p>
</blockquote>



<a name="270802716"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%233733%20Implement%20lazy%20funcref%20table%20and%20a.../near/270802716" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.233733.20Implement.20lazy.20funcref.20table.20and.20a.2E.2E.2E.html#270802716">(Feb 05 2022 at 03:57)</a>:</h4>
<p>cfallin <a href="https://github.com/bytecodealliance/wasmtime/pull/3733#issuecomment-1030516271">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/3733">issue #3733</a>:</p>
<blockquote>
<p>One test failure resulted in discovering the issue in #3769; I split that off as a separate PR and can rebase this on top once it merges.</p>
</blockquote>



<a name="271031384"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%233733%20Implement%20lazy%20funcref%20table%20and%20a.../near/271031384" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.233733.20Implement.20lazy.20funcref.20table.20and.20a.2E.2E.2E.html#271031384">(Feb 07 2022 at 19:41)</a>:</h4>
<p>cfallin <a href="https://github.com/bytecodealliance/wasmtime/pull/3733#issuecomment-1031847760">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/3733">issue #3733</a>:</p>
<blockquote>
<p>Here's a benchmark result of explicit-zeroing-of-VMContext (including anyfunc) vs using madvise -- using a tweaked version of the in-tree <code>instantiation</code> benchmark, with <code>empty.wat</code> and <code>spidermonkey.wasm</code> as two extreme endpoints of the module-size spectrum. (No <code>empty.wat</code> in the 16-thread version yet because the parallel part of the bench is written around one module but I can hack that in next if we need):</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="n">explicit</span><span class="w"> </span><span class="n">memset</span>:

<span class="nc">sequential</span><span class="o">/</span><span class="n">pooling</span><span class="o">/</span><span class="n">empty</span><span class="p">.</span><span class="n">wat</span><span class="w"></span>
<span class="w">                        </span><span class="n">time</span>:   <span class="p">[</span><span class="mf">1.3086</span><span class="w"> </span><span class="n">us</span><span class="w"> </span><span class="mf">1.3187</span><span class="w"> </span><span class="n">us</span><span class="w"> </span><span class="mf">1.3296</span><span class="w"> </span><span class="n">us</span><span class="p">]</span><span class="w"></span>
<span class="n">sequential</span><span class="o">/</span><span class="n">pooling</span><span class="o">/</span><span class="n">spidermonkey</span><span class="p">.</span><span class="n">wasm</span><span class="w"></span>
<span class="w">                        </span><span class="n">time</span>:   <span class="p">[</span><span class="mf">15.703</span><span class="w"> </span><span class="n">us</span><span class="w"> </span><span class="mf">15.824</span><span class="w"> </span><span class="n">us</span><span class="w"> </span><span class="mf">15.950</span><span class="w"> </span><span class="n">us</span><span class="p">]</span><span class="w"></span>
<span class="n">parallel</span><span class="o">/</span><span class="n">pooling</span><span class="o">/</span><span class="mi">1000</span><span class="w"> </span><span class="n">instances</span><span class="w"> </span><span class="n">with</span><span class="w"> </span><span class="mi">16</span><span class="w"> </span><span class="n">threads</span><span class="w"> </span><span class="p">[</span><span class="n">spidermonkey</span><span class="p">.</span><span class="n">wasm</span><span class="p">]</span><span class="w"></span>
<span class="w">                        </span><span class="n">time</span>:   <span class="p">[</span><span class="mf">17.817</span><span class="w"> </span><span class="n">ms</span><span class="w"> </span><span class="mf">17.955</span><span class="w"> </span><span class="n">ms</span><span class="w"> </span><span class="mf">18.094</span><span class="w"> </span><span class="n">ms</span><span class="p">]</span><span class="w"></span>

<span class="n">with</span><span class="w"> </span><span class="err">`</span><span class="n">instance_decommit_pages</span><span class="p">()</span><span class="err">`</span><span class="w"> </span><span class="p">(</span><span class="n">madvise</span><span class="p">)</span>:

<span class="nc">sequential</span><span class="o">/</span><span class="n">pooling</span><span class="o">/</span><span class="n">empty</span><span class="p">.</span><span class="n">wat</span><span class="w"></span>
<span class="w">                        </span><span class="n">time</span>:   <span class="p">[</span><span class="mf">2.5290</span><span class="w"> </span><span class="n">us</span><span class="w"> </span><span class="mf">2.5315</span><span class="w"> </span><span class="n">us</span><span class="w"> </span><span class="mf">2.5349</span><span class="w"> </span><span class="n">us</span><span class="p">]</span><span class="w"></span>
<span class="w">                        </span><span class="n">change</span>: <span class="p">[</span><span class="o">+</span><span class="mf">85.334</span><span class="o">%</span><span class="w"> </span><span class="o">+</span><span class="mf">86.995</span><span class="o">%</span><span class="w"> </span><span class="o">+</span><span class="mf">88.607</span><span class="o">%</span><span class="p">]</span><span class="w"> </span><span class="p">(</span><span class="n">p</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.00</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mf">0.05</span><span class="p">)</span><span class="w"></span>
<span class="w">                        </span><span class="n">Performance</span><span class="w"> </span><span class="n">has</span><span class="w"> </span><span class="n">regressed</span><span class="p">.</span><span class="w"></span>

<span class="n">sequential</span><span class="o">/</span><span class="n">pooling</span><span class="o">/</span><span class="n">spidermonkey</span><span class="p">.</span><span class="n">wasm</span><span class="w"></span>
<span class="w">                        </span><span class="n">time</span>:   <span class="p">[</span><span class="mf">9.7999</span><span class="w"> </span><span class="n">us</span><span class="w"> </span><span class="mf">9.8139</span><span class="w"> </span><span class="n">us</span><span class="w"> </span><span class="mf">9.8288</span><span class="w"> </span><span class="n">us</span><span class="p">]</span><span class="w"></span>
<span class="w">                        </span><span class="n">change</span>: <span class="p">[</span><span class="o">-</span><span class="mf">38.201</span><span class="o">%</span><span class="w"> </span><span class="o">-</span><span class="mf">37.882</span><span class="o">%</span><span class="w"> </span><span class="o">-</span><span class="mf">37.557</span><span class="o">%</span><span class="p">]</span><span class="w"> </span><span class="p">(</span><span class="n">p</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.00</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mf">0.05</span><span class="p">)</span><span class="w"></span>
<span class="w">                        </span><span class="n">Performance</span><span class="w"> </span><span class="n">has</span><span class="w"> </span><span class="n">improved</span><span class="p">.</span><span class="w"></span>

<span class="n">parallel</span><span class="o">/</span><span class="n">pooling</span><span class="o">/</span><span class="mi">1000</span><span class="w"> </span><span class="n">instances</span><span class="w"> </span><span class="n">with</span><span class="w"> </span><span class="mi">16</span><span class="w"> </span><span class="n">threads</span><span class="w"> </span><span class="p">[</span><span class="n">spidermonkey</span><span class="p">.</span><span class="n">wasm</span><span class="p">]</span><span class="w"></span>
<span class="w">                        </span><span class="n">time</span>:   <span class="p">[</span><span class="mf">4.2498</span><span class="w"> </span><span class="n">ms</span><span class="w"> </span><span class="mf">4.2551</span><span class="w"> </span><span class="n">ms</span><span class="w"> </span><span class="mf">4.2606</span><span class="w"> </span><span class="n">ms</span><span class="p">]</span><span class="w"></span>
<span class="w">                        </span><span class="n">change</span>: <span class="p">[</span><span class="o">-</span><span class="mf">76.488</span><span class="o">%</span><span class="w"> </span><span class="o">-</span><span class="mf">76.302</span><span class="o">%</span><span class="w"> </span><span class="o">-</span><span class="mf">76.116</span><span class="o">%</span><span class="p">]</span><span class="w"> </span><span class="p">(</span><span class="n">p</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.00</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mf">0.05</span><span class="p">)</span><span class="w"></span>
<span class="w">                        </span><span class="n">Performance</span><span class="w"> </span><span class="n">has</span><span class="w"> </span><span class="n">improved</span><span class="p">.</span><span class="w"></span>
</code></pre></div>
<p>So tl;dr is that empty instantiation gets a bit slower, as we'd expect -- extra madvise vs a tiny memset -- but for a "realistic large-class" module like SpiderMonkey, this is a ~4x speed improvement in total instantiation time. To me this suggests we should take this approach, and then perhaps refine with the single-madvise-for-whole-slot when we can for the small module case, but: thoughts?</p>
</blockquote>



<a name="271046851"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%233733%20Implement%20lazy%20funcref%20table%20and%20a.../near/271046851" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.233733.20Implement.20lazy.20funcref.20table.20and.20a.2E.2E.2E.html#271046851">(Feb 07 2022 at 21:47)</a>:</h4>
<p>alexcrichton <a href="https://github.com/bytecodealliance/wasmtime/pull/3733#issuecomment-1031963562">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/3733">issue #3733</a>:</p>
<blockquote>
<p>For the benchmark numbers I posted <a href="https://github.com/bytecodealliance/wasmtime/pull/3775">https://github.com/bytecodealliance/wasmtime/pull/3775</a> which I think will tweak the benchmark to better serve measuring this. Running that locally for a large module I'm seeing the expected exponential slowdown for the pooling allocator, and also as expected the mmap allocator is behaving better here due to fewer ipis needed (as it's all contended on the vma lock)</p>
<p>Could you try benchmarking with that?</p>
</blockquote>



<a name="271059174"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%233733%20Implement%20lazy%20funcref%20table%20and%20a.../near/271059174" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.233733.20Implement.20lazy.20funcref.20table.20and.20a.2E.2E.2E.html#271059174">(Feb 07 2022 at 23:32)</a>:</h4>
<p>cfallin <a href="https://github.com/bytecodealliance/wasmtime/pull/3733#issuecomment-1032045629">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/3733">issue #3733</a>:</p>
<blockquote>
<p>Sure; here's a benchmarking run using your updated <code>instantiation</code> benchmark. I include baselines for <code>default</code> and <code>pooling</code>, but my local changes don't affect <code>default</code> (the mmap allocator) -- in <code>pooling.rs</code>, I remove the call to <code>decommit_instance_pages</code> and pass <code>false</code> to <code>prezeroed</code> on <code>initialize_vmcontext</code> instead, and that's it.</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="o">================================================================================</span><span class="w"></span>
<span class="n">With</span><span class="w"> </span><span class="n">madvise</span><span class="p">()</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">flash</span><span class="o">-</span><span class="n">zero</span><span class="w"> </span><span class="n">Instance</span><span class="o">/</span><span class="n">VMContext</span>:
<span class="o">================================================================================</span><span class="w"></span>

<span class="n">sequential</span><span class="o">/</span><span class="n">default</span><span class="o">/</span><span class="n">empty</span><span class="p">.</span><span class="n">wat</span><span class="w"></span>
<span class="w">                        </span><span class="n">time</span>:   <span class="p">[</span><span class="mf">1.1723</span><span class="w"> </span><span class="n">us</span><span class="w"> </span><span class="mf">1.1752</span><span class="w"> </span><span class="n">us</span><span class="w"> </span><span class="mf">1.1778</span><span class="w"> </span><span class="n">us</span><span class="p">]</span><span class="w"></span>
<span class="n">sequential</span><span class="o">/</span><span class="n">pooling</span><span class="o">/</span><span class="n">empty</span><span class="p">.</span><span class="n">wat</span><span class="w"></span>
<span class="w">                        </span><span class="n">time</span>:   <span class="p">[</span><span class="mf">2.4567</span><span class="w"> </span><span class="n">us</span><span class="w"> </span><span class="mf">2.4608</span><span class="w"> </span><span class="n">us</span><span class="w"> </span><span class="mf">2.4652</span><span class="w"> </span><span class="n">us</span><span class="p">]</span><span class="w"></span>

<span class="n">parallel</span><span class="o">/</span><span class="n">default</span><span class="o">/</span><span class="n">empty</span><span class="p">.</span><span class="n">wat</span>: <span class="nc">with</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="n">background</span><span class="w"> </span><span class="n">thread</span><span class="w"></span>
<span class="w">                        </span><span class="n">time</span>:   <span class="p">[</span><span class="mf">1.1596</span><span class="w"> </span><span class="n">us</span><span class="w"> </span><span class="mf">1.1628</span><span class="w"> </span><span class="n">us</span><span class="w"> </span><span class="mf">1.1666</span><span class="w"> </span><span class="n">us</span><span class="p">]</span><span class="w"></span>
<span class="n">parallel</span><span class="o">/</span><span class="n">default</span><span class="o">/</span><span class="n">empty</span><span class="p">.</span><span class="n">wat</span>: <span class="nc">with</span><span class="w"> </span><span class="mi">16</span><span class="w"> </span><span class="n">background</span><span class="w"> </span><span class="n">threads</span><span class="w"></span>
<span class="w">                        </span><span class="n">time</span>:   <span class="p">[</span><span class="mf">20.918</span><span class="w"> </span><span class="n">us</span><span class="w"> </span><span class="mf">21.125</span><span class="w"> </span><span class="n">us</span><span class="w"> </span><span class="mf">21.307</span><span class="w"> </span><span class="n">us</span><span class="p">]</span><span class="w"></span>
<span class="n">parallel</span><span class="o">/</span><span class="n">pooling</span><span class="o">/</span><span class="n">empty</span><span class="p">.</span><span class="n">wat</span>: <span class="nc">with</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="n">background</span><span class="w"> </span><span class="n">thread</span><span class="w"></span>
<span class="w">                        </span><span class="n">time</span>:   <span class="p">[</span><span class="mf">2.4203</span><span class="w"> </span><span class="n">us</span><span class="w"> </span><span class="mf">2.4224</span><span class="w"> </span><span class="n">us</span><span class="w"> </span><span class="mf">2.4249</span><span class="w"> </span><span class="n">us</span><span class="p">]</span><span class="w"></span>
<span class="n">parallel</span><span class="o">/</span><span class="n">pooling</span><span class="o">/</span><span class="n">empty</span><span class="p">.</span><span class="n">wat</span>: <span class="nc">with</span><span class="w"> </span><span class="mi">16</span><span class="w"> </span><span class="n">background</span><span class="w"> </span><span class="n">threads</span><span class="w"></span>
<span class="w">                        </span><span class="n">time</span>:   <span class="p">[</span><span class="mf">25.422</span><span class="w"> </span><span class="n">us</span><span class="w"> </span><span class="mf">25.860</span><span class="w"> </span><span class="n">us</span><span class="w"> </span><span class="mf">26.295</span><span class="w"> </span><span class="n">us</span><span class="p">]</span><span class="w"></span>

<span class="n">sequential</span><span class="o">/</span><span class="n">default</span><span class="o">/</span><span class="n">small_memory</span><span class="p">.</span><span class="n">wat</span><span class="w"></span>
<span class="w">                        </span><span class="n">time</span>:   <span class="p">[</span><span class="mf">5.5100</span><span class="w"> </span><span class="n">us</span><span class="w"> </span><span class="mf">5.5230</span><span class="w"> </span><span class="n">us</span><span class="w"> </span><span class="mf">5.5361</span><span class="w"> </span><span class="n">us</span><span class="p">]</span><span class="w"></span>
<span class="n">sequential</span><span class="o">/</span><span class="n">pooling</span><span class="o">/</span><span class="n">small_memory</span><span class="p">.</span><span class="n">wat</span><span class="w"></span>
<span class="w">                        </span><span class="n">time</span>:   <span class="p">[</span><span class="mf">3.0336</span><span class="w"> </span><span class="n">us</span><span class="w"> </span><span class="mf">3.0356</span><span class="w"> </span><span class="n">us</span><span class="w"> </span><span class="mf">3.0376</span><span class="w"> </span><span class="n">us</span><span class="p">]</span><span class="w"></span>

<span class="n">parallel</span><span class="o">/</span><span class="n">default</span><span class="o">/</span><span class="n">small_memory</span><span class="p">.</span><span class="n">wat</span>: <span class="nc">with</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="n">background</span><span class="w"> </span><span class="n">thread</span><span class="w"></span>
<span class="w">                        </span><span class="n">time</span>:   <span class="p">[</span><span class="mf">5.3376</span><span class="w"> </span><span class="n">us</span><span class="w"> </span><span class="mf">5.3488</span><span class="w"> </span><span class="n">us</span><span class="w"> </span><span class="mf">5.3614</span><span class="w"> </span><span class="n">us</span><span class="p">]</span><span class="w"></span>
<span class="n">parallel</span><span class="o">/</span><span class="n">default</span><span class="o">/</span><span class="n">small_memory</span><span class="p">.</span><span class="n">wat</span>: <span class="nc">with</span><span class="w"> </span><span class="mi">16</span><span class="w"> </span><span class="n">background</span><span class="w"> </span><span class="n">threads</span><span class="w"></span>
<span class="w">                        </span><span class="n">time</span>:   <span class="p">[</span><span class="mf">95.562</span><span class="w"> </span><span class="n">us</span><span class="w"> </span><span class="mf">96.023</span><span class="w"> </span><span class="n">us</span><span class="w"> </span><span class="mf">96.485</span><span class="w"> </span><span class="n">us</span><span class="p">]</span><span class="w"></span>
<span class="n">parallel</span><span class="o">/</span><span class="n">pooling</span><span class="o">/</span><span class="n">small_memory</span><span class="p">.</span><span class="n">wat</span>: <span class="nc">with</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="n">background</span><span class="w"> </span><span class="n">thread</span><span class="w"></span>
<span class="w">                        </span><span class="n">time</span>:   <span class="p">[</span><span class="mf">3.0222</span><span class="w"> </span><span class="n">us</span><span class="w"> </span><span class="mf">3.0270</span><span class="w"> </span><span class="n">us</span><span class="w"> </span><span class="mf">3.0316</span><span class="w"> </span><span class="n">us</span><span class="p">]</span><span class="w"></span>
<span class="n">parallel</span><span class="o">/</span><span class="n">pooling</span><span class="o">/</span><span class="n">small_memory</span><span class="p">.</span><span class="n">wat</span>: <span class="nc">with</span><span class="w"> </span><span class="mi">16</span><span class="w"> </span><span class="n">background</span><span class="w"> </span><span class="n">threads</span><span class="w"></span>
<span class="w">                        </span><span class="n">time</span>:   <span class="p">[</span><span class="mf">172.62</span><span class="w"> </span><span class="n">us</span><span class="w"> </span><span class="mf">175.12</span><span class="w"> </span><span class="n">us</span><span class="w"> </span><span class="mf">177.54</span><span class="w"> </span><span class="n">us</span><span class="p">]</span><span class="w"></span>

<span class="n">sequential</span><span class="o">/</span><span class="n">default</span><span class="o">/</span><span class="n">data_segments</span><span class="p">.</span><span class="n">wat</span><span class="w"></span>
<span class="w">                        </span><span class="n">time</span>:   <span class="p">[</span><span class="mf">6.3065</span><span class="w"> </span><span class="n">us</span><span class="w"> </span><span class="mf">6.3094</span><span class="w"> </span><span class="n">us</span><span class="w"> </span><span class="mf">6.3120</span><span class="w"> </span><span class="n">us</span><span class="p">]</span><span class="w"></span>
<span class="n">sequential</span><span class="o">/</span><span class="n">pooling</span><span class="o">/</span><span class="n">data_segments</span><span class="p">.</span><span class="n">wat</span><span class="w"></span>
<span class="w">                        </span><span class="n">time</span>:   <span class="p">[</span><span class="mf">2.8083</span><span class="w"> </span><span class="n">us</span><span class="w"> </span><span class="mf">2.8116</span><span class="w"> </span><span class="n">us</span><span class="w"> </span><span class="mf">2.8147</span><span class="w"> </span><span class="n">us</span><span class="p">]</span><span class="w"></span>

<span class="n">parallel</span><span class="o">/</span><span class="n">default</span><span class="o">/</span><span class="n">data_segments</span><span class="p">.</span><span class="n">wat</span>: <span class="nc">with</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="n">background</span><span class="w"> </span><span class="n">thread</span><span class="w"></span>
<span class="w">                        </span><span class="n">time</span>:   <span class="p">[</span><span class="mf">6.0155</span><span class="w"> </span><span class="n">us</span><span class="w"> </span><span class="mf">6.0290</span><span class="w"> </span><span class="n">us</span><span class="w"> </span><span class="mf">6.0407</span><span class="w"> </span><span class="n">us</span><span class="p">]</span><span class="w"></span>
<span class="n">parallel</span><span class="o">/</span><span class="n">default</span><span class="o">/</span><span class="n">data_segments</span><span class="p">.</span><span class="n">wat</span>: <span class="nc">with</span><span class="w"> </span><span class="mi">16</span><span class="w"> </span><span class="n">background</span><span class="w"> </span><span class="n">threads</span><span class="w"></span>
<span class="w">                        </span><span class="n">time</span>:   <span class="p">[</span><span class="mf">141.99</span><span class="w"> </span><span class="n">us</span><span class="w"> </span><span class="mf">142.58</span><span class="w"> </span><span class="n">us</span><span class="w"> </span><span class="mf">143.27</span><span class="w"> </span><span class="n">us</span><span class="p">]</span><span class="w"></span>
<span class="n">parallel</span><span class="o">/</span><span class="n">pooling</span><span class="o">/</span><span class="n">data_segments</span><span class="p">.</span><span class="n">wat</span>: <span class="nc">with</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="n">background</span><span class="w"> </span><span class="n">thread</span><span class="w"></span>
<span class="w">                        </span><span class="n">time</span>:   <span class="p">[</span><span class="mf">2.7353</span><span class="w"> </span><span class="n">us</span><span class="w"> </span><span class="mf">2.7533</span><span class="w"> </span><span class="n">us</span><span class="w"> </span><span class="mf">2.7687</span><span class="w"> </span><span class="n">us</span><span class="p">]</span><span class="w"></span>
<span class="n">parallel</span><span class="o">/</span><span class="n">pooling</span><span class="o">/</span><span class="n">data_segments</span><span class="p">.</span><span class="n">wat</span>: <span class="nc">with</span><span class="w"> </span><span class="mi">16</span><span class="w"> </span><span class="n">background</span><span class="w"> </span><span class="n">threads</span><span class="w"></span>
<span class="w">                        </span><span class="n">time</span>:   <span class="p">[</span><span class="mf">40.435</span><span class="w"> </span><span class="n">us</span><span class="w"> </span><span class="mf">41.035</span><span class="w"> </span><span class="n">us</span><span class="w"> </span><span class="mf">41.644</span><span class="w"> </span><span class="n">us</span><span class="p">]</span><span class="w"></span>

<span class="n">sequential</span><span class="o">/</span><span class="n">default</span><span class="o">/</span><span class="n">wasi</span><span class="p">.</span><span class="n">wasm</span><span class="w"></span>
<span class="w">                        </span><span class="n">time</span>:   <span class="p">[</span><span class="mf">6.6997</span><span class="w"> </span><span class="n">us</span><span class="w"> </span><span class="mf">6.7118</span><span class="w"> </span><span class="n">us</span><span class="w"> </span><span class="mf">6.7264</span><span class="w"> </span><span class="n">us</span><span class="p">]</span><span class="w"></span>
<span class="n">sequential</span><span class="o">/</span><span class="n">pooling</span><span class="o">/</span><span class="n">wasi</span><span class="p">.</span><span class="n">wasm</span><span class="w"></span>
<span class="w">                        </span><span class="n">time</span>:   <span class="p">[</span><span class="mf">3.7074</span><span class="w"> </span><span class="n">us</span><span class="w"> </span><span class="mf">3.7099</span><span class="w"> </span><span class="n">us</span><span class="w"> </span><span class="mf">3.7129</span><span class="w"> </span><span class="n">us</span><span class="p">]</span><span class="w"></span>

<span class="n">parallel</span><span class="o">/</span><span class="n">default</span><span class="o">/</span><span class="n">wasi</span><span class="p">.</span><span class="n">wasm</span>: <span class="nc">with</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="n">background</span><span class="w"> </span><span class="n">thread</span><span class="w"></span>
<span class="w">                        </span><span class="n">time</span>:   <span class="p">[</span><span class="mf">6.7795</span><span class="w"> </span><span class="n">us</span><span class="w"> </span><span class="mf">6.7964</span><span class="w"> </span><span class="n">us</span><span class="w"> </span><span class="mf">6.8131</span><span class="w"> </span><span class="n">us</span><span class="p">]</span><span class="w"></span>
<span class="n">parallel</span><span class="o">/</span><span class="n">default</span><span class="o">/</span><span class="n">wasi</span><span class="p">.</span><span class="n">wasm</span>: <span class="nc">with</span><span class="w"> </span><span class="mi">16</span><span class="w"> </span><span class="n">background</span><span class="w"> </span><span class="n">threads</span><span class="w"></span>
<span class="w">                        </span><span class="n">time</span>:   <span class="p">[</span><span class="mf">154.73</span><span class="w"> </span><span class="n">us</span><span class="w"> </span><span class="mf">155.36</span><span class="w"> </span><span class="n">us</span><span class="w"> </span><span class="mf">156.03</span><span class="w"> </span><span class="n">us</span><span class="p">]</span><span class="w"></span>
<span class="n">parallel</span><span class="o">/</span><span class="n">pooling</span><span class="o">/</span><span class="n">wasi</span><span class="p">.</span><span class="n">wasm</span>: <span class="nc">with</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="n">background</span><span class="w"> </span><span class="n">thread</span><span class="w"></span>
<span class="w">                        </span><span class="n">time</span>:   <span class="p">[</span><span class="mf">3.8161</span><span class="w"> </span><span class="n">us</span><span class="w"> </span><span class="mf">3.8195</span><span class="w"> </span><span class="n">us</span><span class="w"> </span><span class="mf">3.8231</span><span class="w"> </span><span class="n">us</span><span class="p">]</span><span class="w"></span>
<span class="n">parallel</span><span class="o">/</span><span class="n">pooling</span><span class="o">/</span><span class="n">wasi</span><span class="p">.</span><span class="n">wasm</span>: <span class="nc">with</span><span class="w"> </span><span class="mi">16</span><span class="w"> </span><span class="n">background</span><span class="w"> </span><span class="n">threads</span><span class="w"></span>
<span class="w">                        </span><span class="n">time</span>:   <span class="p">[</span><span class="mf">60.806</span><span class="w"> </span><span class="n">us</span><span class="w"> </span><span class="mf">61.850</span><span class="w"> </span><span class="n">us</span><span class="w"> </span><span class="mf">62.927</span><span class="w"> </span><span class="n">us</span><span class="p">]</span><span class="w"></span>

<span class="n">sequential</span><span class="o">/</span><span class="n">default</span><span class="o">/</span><span class="n">spidermonkey</span><span class="p">.</span><span class="n">wasm</span><span class="w"></span>
<span class="w">                        </span><span class="n">time</span>:   <span class="p">[</span><span class="mf">15.974</span><span class="w"> </span><span class="n">us</span><span class="w"> </span><span class="mf">15.983</span><span class="w"> </span><span class="n">us</span><span class="w"> </span><span class="mf">15.993</span><span class="w"> </span><span class="n">us</span><span class="p">]</span><span class="w"></span>
<span class="n">sequential</span><span class="o">/</span><span class="n">pooling</span><span class="o">/</span><span class="n">spidermonkey</span><span class="p">.</span><span class="n">wasm</span><span class="w"></span>
<span class="w">                        </span><span class="n">time</span>:   <span class="p">[</span><span class="mf">6.0185</span><span class="w"> </span><span class="n">us</span><span class="w"> </span><span class="mf">6.0215</span><span class="w"> </span><span class="n">us</span><span class="w"> </span><span class="mf">6.0248</span><span class="w"> </span><span class="n">us</span><span class="p">]</span><span class="w"></span>

<span class="n">parallel</span><span class="o">/</span><span class="n">default</span><span class="o">/</span><span class="n">spidermonkey</span><span class="p">.</span><span class="n">wasm</span>: <span class="nc">with</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="n">background</span><span class="w"> </span><span class="n">thread</span><span class="w"></span>
<span class="w">                        </span><span class="n">time</span>:   <span class="p">[</span><span class="mf">16.189</span><span class="w"> </span><span class="n">us</span><span class="w"> </span><span class="mf">16.201</span><span class="w"> </span><span class="n">us</span><span class="w"> </span><span class="mf">16.215</span><span class="w"> </span><span class="n">us</span><span class="p">]</span><span class="w"></span>
<span class="n">parallel</span><span class="o">/</span><span class="n">default</span><span class="o">/</span><span class="n">spidermonkey</span><span class="p">.</span><span class="n">wasm</span>: <span class="nc">with</span><span class="w"> </span><span class="mi">16</span><span class="w"> </span><span class="n">background</span><span class="w"> </span><span class="n">threads</span><span class="w"></span>
<span class="w">                        </span><span class="n">time</span>:   <span class="p">[</span><span class="mf">165.91</span><span class="w"> </span><span class="n">us</span><span class="w"> </span><span class="mf">167.16</span><span class="w"> </span><span class="n">us</span><span class="w"> </span><span class="mf">168.51</span><span class="w"> </span><span class="n">us</span><span class="p">]</span><span class="w"></span>
<span class="n">parallel</span><span class="o">/</span><span class="n">pooling</span><span class="o">/</span><span class="n">spidermonkey</span><span class="p">.</span><span class="n">wasm</span>: <span class="nc">with</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="n">background</span><span class="w"> </span><span class="n">thread</span><span class="w"></span>
<span class="w">                        </span><span class="n">time</span>:   <span class="p">[</span><span class="mf">5.9293</span><span class="w"> </span><span class="n">us</span><span class="w"> </span><span class="mf">5.9348</span><span class="w"> </span><span class="n">us</span><span class="w"> </span><span class="mf">5.9403</span><span class="w"> </span><span class="n">us</span><span class="p">]</span><span class="w"></span>
<span class="n">parallel</span><span class="o">/</span><span class="n">pooling</span><span class="o">/</span><span class="n">spidermonkey</span><span class="p">.</span><span class="n">wasm</span>: <span class="nc">with</span><span class="w"> </span><span class="mi">16</span><span class="w"> </span><span class="n">background</span><span class="w"> </span><span class="n">threads</span><span class="w"></span>
<span class="w">                        </span><span class="n">time</span>:   <span class="p">[</span><span class="mf">55.862</span><span class="w"> </span><span class="n">us</span><span class="w"> </span><span class="mf">57.049</span><span class="w"> </span><span class="n">us</span><span class="w"> </span><span class="mf">58.373</span><span class="w"> </span><span class="n">us</span><span class="p">]</span><span class="w"></span>

<span class="o">================================================================================</span><span class="w"></span>
<span class="n">With</span><span class="w"> </span><span class="n">explicit</span><span class="w"> </span><span class="n">memset</span>:
  <span class="p">(</span><span class="s">"default"</span><span class="o">-</span><span class="n">policy</span><span class="w"> </span><span class="n">was</span><span class="w"> </span><span class="n">not</span><span class="w"> </span><span class="n">changed</span><span class="p">,</span><span class="w"> </span><span class="n">so</span><span class="w"> </span><span class="n">excluding</span><span class="p">)</span><span class="w"></span>
<span class="o">================================================================================</span><span class="w"></span>

<span class="n">sequential</span><span class="o">/</span><span class="n">pooling</span><span class="o">/</span><span class="n">empty</span><span class="p">.</span><span class="n">wat</span><span class="w"></span>
<span class="w">                        </span><span class="n">time</span>:   <span class="p">[</span><span class="mf">1.2088</span><span class="w"> </span><span class="n">us</span><span class="w"> </span><span class="mf">1.2111</span><span class="w"> </span><span class="n">us</span><span class="w"> </span><span class="mf">1.2136</span><span class="w"> </span><span class="n">us</span><span class="p">]</span><span class="w"></span>
<span class="w">                        </span><span class="n">change</span>: <span class="p">[</span><span class="o">-</span><span class="mf">51.445</span><span class="o">%</span><span class="w"> </span><span class="o">-</span><span class="mf">51.270</span><span class="o">%</span><span class="w"> </span><span class="o">-</span><span class="mf">51.113</span><span class="o">%</span><span class="p">]</span><span class="w"> </span><span class="p">(</span><span class="n">p</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.00</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mf">0.05</span><span class="p">)</span><span class="w"></span>
<span class="w">                        </span><span class="n">Performance</span><span class="w"> </span><span class="n">has</span><span class="w"> </span><span class="n">improved</span><span class="p">.</span><span class="w"></span>

<span class="n">parallel</span><span class="o">/</span><span class="n">pooling</span><span class="o">/</span><span class="n">empty</span><span class="p">.</span><span class="n">wat</span>: <span class="nc">with</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="n">background</span><span class="w"> </span><span class="n">thread</span><span class="w"></span>
<span class="w">                        </span><span class="n">time</span>:   <span class="p">[</span><span class="mf">1.1838</span><span class="w"> </span><span class="n">us</span><span class="w"> </span><span class="mf">1.1853</span><span class="w"> </span><span class="n">us</span><span class="w"> </span><span class="mf">1.1869</span><span class="w"> </span><span class="n">us</span><span class="p">]</span><span class="w"></span>
<span class="w">                        </span><span class="n">change</span>: <span class="p">[</span><span class="o">-</span><span class="mf">50.952</span><span class="o">%</span><span class="w"> </span><span class="o">-</span><span class="mf">50.778</span><span class="o">%</span><span class="w"> </span><span class="o">-</span><span class="mf">50.613</span><span class="o">%</span><span class="p">]</span><span class="w"> </span><span class="p">(</span><span class="n">p</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.00</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mf">0.05</span><span class="p">)</span><span class="w"></span>
<span class="w">                        </span><span class="n">Performance</span><span class="w"> </span><span class="n">has</span><span class="w"> </span><span class="n">improved</span><span class="p">.</span><span class="w"></span>
<span class="n">parallel</span><span class="o">/</span><span class="n">pooling</span><span class="o">/</span><span class="n">empty</span><span class="p">.</span><span class="n">wat</span>: <span class="nc">with</span><span class="w"> </span><span class="mi">16</span><span class="w"> </span><span class="n">background</span><span class="w"> </span><span class="n">threads</span><span class="w"></span>
<span class="w">                        </span><span class="n">time</span>:   <span class="p">[</span><span class="mf">21.178</span><span class="w"> </span><span class="n">us</span><span class="w"> </span><span class="mf">21.353</span><span class="w"> </span><span class="n">us</span><span class="w"> </span><span class="mf">21.515</span><span class="w"> </span><span class="n">us</span><span class="p">]</span><span class="w"></span>
<span class="w">                        </span><span class="n">change</span>: <span class="p">[</span><span class="o">-</span><span class="mf">18.533</span><span class="o">%</span><span class="w"> </span><span class="o">-</span><span class="mf">17.405</span><span class="o">%</span><span class="w"> </span><span class="o">-</span><span class="mf">16.183</span><span class="o">%</span><span class="p">]</span><span class="w"> </span><span class="p">(</span><span class="n">p</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.00</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mf">0.05</span><span class="p">)</span><span class="w"></span>
<span class="w">                        </span><span class="n">Performance</span><span class="w"> </span><span class="n">has</span><span class="w"> </span><span class="n">improved</span><span class="p">.</span><span class="w"></span>

<span class="n">sequential</span><span class="o">/</span><span class="n">pooling</span><span class="o">/</span><span class="n">small_memory</span><span class="p">.</span><span class="n">wat</span><span class="w"></span>
<span class="w">                        </span><span class="n">time</span>:   <span class="p">[</span><span class="mf">1.7699</span><span class="w"> </span><span class="n">us</span><span class="w"> </span><span class="mf">1.7719</span><span class="w"> </span><span class="n">us</span><span class="w"> </span><span class="mf">1.7740</span><span class="w"> </span><span class="n">us</span><span class="p">]</span><span class="w"></span>
<span class="w">                        </span><span class="n">change</span>: <span class="p">[</span><span class="o">-</span><span class="mf">41.479</span><span class="o">%</span><span class="w"> </span><span class="o">-</span><span class="mf">41.392</span><span class="o">%</span><span class="w"> </span><span class="o">-</span><span class="mf">41.293</span><span class="o">%</span><span class="p">]</span><span class="w"> </span><span class="p">(</span><span class="n">p</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.00</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mf">0.05</span><span class="p">)</span><span class="w"></span>
<span class="w">                        </span><span class="n">Performance</span><span class="w"> </span><span class="n">has</span><span class="w"> </span><span class="n">improved</span><span class="p">.</span><span class="w"></span>

<span class="n">parallel</span><span class="o">/</span><span class="n">pooling</span><span class="o">/</span><span class="n">small_memory</span><span class="p">.</span><span class="n">wat</span>: <span class="nc">with</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="n">background</span><span class="w"> </span><span class="n">thread</span><span class="w"></span>
<span class="w">                        </span><span class="n">time</span>:   <span class="p">[</span><span class="mf">1.7915</span><span class="w"> </span><span class="n">us</span><span class="w"> </span><span class="mf">1.7930</span><span class="w"> </span><span class="n">us</span><span class="w"> </span><span class="mf">1.7945</span><span class="w"> </span><span class="n">us</span><span class="p">]</span><span class="w"></span>
<span class="w">                        </span><span class="n">change</span>: <span class="p">[</span><span class="o">-</span><span class="mf">40.593</span><span class="o">%</span><span class="w"> </span><span class="o">-</span><span class="mf">40.487</span><span class="o">%</span><span class="w"> </span><span class="o">-</span><span class="mf">40.383</span><span class="o">%</span><span class="p">]</span><span class="w"> </span><span class="p">(</span><span class="n">p</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.00</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mf">0.05</span><span class="p">)</span><span class="w"></span>
<span class="w">                        </span><span class="n">Performance</span><span class="w"> </span><span class="n">has</span><span class="w"> </span><span class="n">improved</span><span class="p">.</span><span class="w"></span>
<span class="n">parallel</span><span class="o">/</span><span class="n">pooling</span><span class="o">/</span><span class="n">small_memory</span><span class="p">.</span><span class="n">wat</span>: <span class="nc">with</span><span class="w"> </span><span class="mi">16</span><span class="w"> </span><span class="n">background</span><span class="w"> </span><span class="n">threads</span><span class="w"></span>
<span class="w">                        </span><span class="n">time</span>:   <span class="p">[</span><span class="mf">65.378</span><span class="w"> </span><span class="n">us</span><span class="w"> </span><span class="mf">66.775</span><span class="w"> </span><span class="n">us</span><span class="w"> </span><span class="mf">68.080</span><span class="w"> </span><span class="n">us</span><span class="p">]</span><span class="w"></span>
<span class="w">                        </span><span class="n">change</span>: <span class="p">[</span><span class="o">-</span><span class="mf">62.639</span><span class="o">%</span><span class="w"> </span><span class="o">-</span><span class="mf">61.536</span><span class="o">%</span><span class="w"> </span><span class="o">-</span><span class="mf">60.394</span><span class="o">%</span><span class="p">]</span><span class="w"> </span><span class="p">(</span><span class="n">p</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.00</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mf">0.05</span><span class="p">)</span><span class="w"></span>
<span class="w">                        </span><span class="n">Performance</span><span class="w"> </span><span class="n">has</span><span class="w"> </span><span class="n">improved</span><span class="p">.</span><span class="w"></span>

<span class="n">sequential</span><span class="o">/</span><span class="n">pooling</span><span class="o">/</span><span class="n">data_segments</span><span class="p">.</span><span class="n">wat</span><span class="w"></span>
<span class="w">                        </span><span class="n">time</span>:   <span class="p">[</span><span class="mf">1.5276</span><span class="w"> </span><span class="n">us</span><span class="w"> </span><span class="mf">1.5288</span><span class="w"> </span><span class="n">us</span><span class="w"> </span><span class="mf">1.5301</span><span class="w"> </span><span class="n">us</span><span class="p">]</span><span class="w"></span>
<span class="w">                        </span><span class="n">change</span>: <span class="p">[</span><span class="o">-</span><span class="mf">45.622</span><span class="o">%</span><span class="w"> </span><span class="o">-</span><span class="mf">45.551</span><span class="o">%</span><span class="w"> </span><span class="o">-</span><span class="mf">45.475</span><span class="o">%</span><span class="p">]</span><span class="w"> </span><span class="p">(</span><span class="n">p</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.00</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mf">0.05</span><span class="p">)</span><span class="w"></span>
<span class="w">                        </span><span class="n">Performance</span><span class="w"> </span><span class="n">has</span><span class="w"> </span><span class="n">improved</span><span class="p">.</span><span class="w"></span>

<span class="n">parallel</span><span class="o">/</span><span class="n">pooling</span><span class="o">/</span><span class="n">data_segments</span><span class="p">.</span><span class="n">wat</span>: <span class="nc">with</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="n">background</span><span class="w"> </span><span class="n">thread</span><span class="w"></span>
<span class="w">                        </span><span class="n">time</span>:   <span class="p">[</span><span class="mf">1.5664</span><span class="w"> </span><span class="n">us</span><span class="w"> </span><span class="mf">1.5716</span><span class="w"> </span><span class="n">us</span><span class="w"> </span><span class="mf">1.5776</span><span class="w"> </span><span class="n">us</span><span class="p">]</span><span class="w"></span>
<span class="w">                        </span><span class="n">change</span>: <span class="p">[</span><span class="o">-</span><span class="mf">42.192</span><span class="o">%</span><span class="w"> </span><span class="o">-</span><span class="mf">41.806</span><span class="o">%</span><span class="w"> </span><span class="o">-</span><span class="mf">41.407</span><span class="o">%</span><span class="p">]</span><span class="w"> </span><span class="p">(</span><span class="n">p</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.00</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mf">0.05</span><span class="p">)</span><span class="w"></span>
<span class="w">                        </span><span class="n">Performance</span><span class="w"> </span><span class="n">has</span><span class="w"> </span><span class="n">improved</span><span class="p">.</span><span class="w"></span>
<span class="n">parallel</span><span class="o">/</span><span class="n">pooling</span><span class="o">/</span><span class="n">data_segments</span><span class="p">.</span><span class="n">wat</span>: <span class="nc">with</span><span class="w"> </span><span class="mi">16</span><span class="w"> </span><span class="n">background</span><span class="w"> </span><span class="n">threads</span><span class="w"></span>
<span class="w">                        </span><span class="n">time</span>:   <span class="p">[</span><span class="mf">30.378</span><span class="w"> </span><span class="n">us</span><span class="w"> </span><span class="mf">30.951</span><span class="w"> </span><span class="n">us</span><span class="w"> </span><span class="mf">31.554</span><span class="w"> </span><span class="n">us</span><span class="p">]</span><span class="w"></span>
<span class="w">                        </span><span class="n">change</span>: <span class="p">[</span><span class="o">-</span><span class="mf">24.975</span><span class="o">%</span><span class="w"> </span><span class="o">-</span><span class="mf">23.479</span><span class="o">%</span><span class="w"> </span><span class="o">-</span><span class="mf">21.963</span><span class="o">%</span><span class="p">]</span><span class="w"> </span><span class="p">(</span><span class="n">p</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.00</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mf">0.05</span><span class="p">)</span><span class="w"></span>
<span class="w">                        </span><span class="n">Performance</span><span class="w"> </span><span class="n">has</span><span class="w"> </span><span class="n">improved</span><span class="p">.</span><span class="w"></span>

<span class="n">sequential</span><span class="o">/</span><span class="n">pooling</span><span class="o">/</span><span class="n">wasi</span><span class="p">.</span><span class="n">wasm</span><span class="w"></span>
<span class="w">                        </span><span class="n">time</span>:   <span class="p">[</span><span class="mf">2.0274</span><span class="w"> </span><span class="n">us</span><span class="w"> </span><span class="mf">2.0401</span><span class="w"> </span><span class="n">us</span><span class="w"> </span><span class="mf">2.0519</span><span class="w"> </span><span class="n">us</span><span class="p">]</span><span class="w"></span>
<span class="w">                        </span><span class="n">change</span>: <span class="p">[</span><span class="o">-</span><span class="mf">46.488</span><span class="o">%</span><span class="w"> </span><span class="o">-</span><span class="mf">46.206</span><span class="o">%</span><span class="w"> </span><span class="o">-</span><span class="mf">45.904</span><span class="o">%</span><span class="p">]</span><span class="w"> </span><span class="p">(</span><span class="n">p</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.00</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mf">0.05</span><span class="p">)</span><span class="w"></span>
<span class="w">                        </span><span class="n">Performance</span><span class="w"> </span><span class="n">has</span><span class="w"> </span><span class="n">improved</span><span class="p">.</span><span class="w"></span>

<span class="n">parallel</span><span class="o">/</span><span class="n">pooling</span><span class="o">/</span><span class="n">wasi</span><span class="p">.</span><span class="n">wasm</span>: <span class="nc">with</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="n">background</span><span class="w"> </span><span class="n">thread</span><span class="w"></span>
<span class="w">                        </span><span class="n">time</span>:   <span class="p">[</span><span class="mf">1.9543</span><span class="w"> </span><span class="n">us</span><span class="w"> </span><span class="mf">1.9559</span><span class="w"> </span><span class="n">us</span><span class="w"> </span><span class="mf">1.9579</span><span class="w"> </span><span class="n">us</span><span class="p">]</span><span class="w"></span>
<span class="w">                        </span><span class="n">change</span>: <span class="p">[</span><span class="o">-</span><span class="mf">48.881</span><span class="o">%</span><span class="w"> </span><span class="o">-</span><span class="mf">48.790</span><span class="o">%</span><span class="w"> </span><span class="o">-</span><span class="mf">48.700</span><span class="o">%</span><span class="p">]</span><span class="w"> </span><span class="p">(</span><span class="n">p</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.00</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mf">0.05</span><span class="p">)</span><span class="w"></span>
<span class="w">                        </span><span class="n">Performance</span><span class="w"> </span><span class="n">has</span><span class="w"> </span><span class="n">improved</span><span class="p">.</span><span class="w"></span>
<span class="n">parallel</span><span class="o">/</span><span class="n">pooling</span><span class="o">/</span><span class="n">wasi</span><span class="p">.</span><span class="n">wasm</span>: <span class="nc">with</span><span class="w"> </span><span class="mi">16</span><span class="w"> </span><span class="n">background</span><span class="w"> </span><span class="n">threads</span><span class="w"></span>
<span class="w">                        </span><span class="n">time</span>:   <span class="p">[</span><span class="mf">49.629</span><span class="w"> </span><span class="n">us</span><span class="w"> </span><span class="mf">50.532</span><span class="w"> </span><span class="n">us</span><span class="w"> </span><span class="mf">51.431</span><span class="w"> </span><span class="n">us</span><span class="p">]</span><span class="w"></span>
<span class="w">                        </span><span class="n">change</span>: <span class="p">[</span><span class="o">-</span><span class="mf">21.128</span><span class="o">%</span><span class="w"> </span><span class="o">-</span><span class="mf">19.627</span><span class="o">%</span><span class="w"> </span><span class="o">-</span><span class="mf">18.124</span><span class="o">%</span><span class="p">]</span><span class="w"> </span><span class="p">(</span><span class="n">p</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.00</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mf">0.05</span><span class="p">)</span><span class="w"></span>
<span class="w">                        </span><span class="n">Performance</span><span class="w"> </span><span class="n">has</span><span class="w"> </span><span class="n">improved</span><span class="p">.</span><span class="w"></span>

<span class="n">sequential</span><span class="o">/</span><span class="n">pooling</span><span class="o">/</span><span class="n">spidermonkey</span><span class="p">.</span><span class="n">wasm</span><span class="w"></span>
<span class="w">                        </span><span class="n">time</span>:   <span class="p">[</span><span class="mf">12.469</span><span class="w"> </span><span class="n">us</span><span class="w"> </span><span class="mf">12.556</span><span class="w"> </span><span class="n">us</span><span class="w"> </span><span class="mf">12.635</span><span class="w"> </span><span class="n">us</span><span class="p">]</span><span class="w"></span>
<span class="w">                        </span><span class="n">change</span>: <span class="p">[</span><span class="o">+</span><span class="mf">108.02</span><span class="o">%</span><span class="w"> </span><span class="o">+</span><span class="mf">109.03</span><span class="o">%</span><span class="w"> </span><span class="o">+</span><span class="mf">110.10</span><span class="o">%</span><span class="p">]</span><span class="w"> </span><span class="p">(</span><span class="n">p</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.00</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mf">0.05</span><span class="p">)</span><span class="w"></span>
<span class="w">                        </span><span class="n">Performance</span><span class="w"> </span><span class="n">has</span><span class="w"> </span><span class="n">regressed</span><span class="p">.</span><span class="w"></span>

<span class="n">parallel</span><span class="o">/</span><span class="n">pooling</span><span class="o">/</span><span class="n">spidermonkey</span><span class="p">.</span><span class="n">wasm</span>: <span class="nc">with</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="n">background</span><span class="w"> </span><span class="n">thread</span><span class="w"></span>
<span class="w">                        </span><span class="n">time</span>:   <span class="p">[</span><span class="mf">12.523</span><span class="w"> </span><span class="n">us</span><span class="w"> </span><span class="mf">12.562</span><span class="w"> </span><span class="n">us</span><span class="w"> </span><span class="mf">12.595</span><span class="w"> </span><span class="n">us</span><span class="p">]</span><span class="w"></span>
<span class="w">                        </span><span class="n">change</span>: <span class="p">[</span><span class="o">+</span><span class="mf">109.29</span><span class="o">%</span><span class="w"> </span><span class="o">+</span><span class="mf">110.20</span><span class="o">%</span><span class="w"> </span><span class="o">+</span><span class="mf">111.03</span><span class="o">%</span><span class="p">]</span><span class="w"> </span><span class="p">(</span><span class="n">p</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.00</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mf">0.05</span><span class="p">)</span><span class="w"></span>
<span class="w">                        </span><span class="n">Performance</span><span class="w"> </span><span class="n">has</span><span class="w"> </span><span class="n">regressed</span><span class="p">.</span><span class="w"></span>
<span class="n">parallel</span><span class="o">/</span><span class="n">pooling</span><span class="o">/</span><span class="n">spidermonkey</span><span class="p">.</span><span class="n">wasm</span>: <span class="nc">with</span><span class="w"> </span><span class="mi">16</span><span class="w"> </span><span class="n">background</span><span class="w"> </span><span class="n">threads</span><span class="w"></span>
<span class="w">                        </span><span class="n">time</span>:   <span class="p">[</span><span class="mf">254.13</span><span class="w"> </span><span class="n">us</span><span class="w"> </span><span class="mf">277.81</span><span class="w"> </span><span class="n">us</span><span class="w"> </span><span class="mf">304.77</span><span class="w"> </span><span class="n">us</span><span class="p">]</span><span class="w"></span>
<span class="w">                        </span><span class="n">change</span>: <span class="p">[</span><span class="o">+</span><span class="mf">410.73</span><span class="o">%</span><span class="w"> </span><span class="o">+</span><span class="mf">449.63</span><span class="o">%</span><span class="w"> </span><span class="o">+</span><span class="mf">496.28</span><span class="o">%</span><span class="p">]</span><span class="w"> </span><span class="p">(</span><span class="n">p</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.00</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mf">0.05</span><span class="p">)</span><span class="w"></span>
<span class="w">                        </span><span class="n">Performance</span><span class="w"> </span><span class="n">has</span><span class="w"> </span><span class="n">regressed</span><span class="p">.</span><span class="w"></span>
</code></pre></div>
<p>So, switching to an explicit memset, we see performance improvements in all cases except the large SpiderMonkey module (31k functions in my local build), where using explicit memset is 5.49x slower (+449%).</p>
<p>Either way, it's clear to me that we'll feel some pain on the low end (madvise) or high end (memset), so the ultimate design probably has to be to incorporate this flash-clearing into an madvise we're already doing (single-madvise idea). I can implement that as soon as we confirm that we want to remove uffd. I guess the question is just which we settle on in the meantime :-)</p>
</blockquote>



<a name="271061235"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%233733%20Implement%20lazy%20funcref%20table%20and%20a.../near/271061235" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.233733.20Implement.20lazy.20funcref.20table.20and.20a.2E.2E.2E.html#271061235">(Feb 07 2022 at 23:54)</a>:</h4>
<p>cfallin <a href="https://github.com/bytecodealliance/wasmtime/pull/3733#issuecomment-1032059720">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/3733">issue #3733</a>:</p>
<blockquote>
<p>Hmm, actually, the other option is to bring back the bitmap approach from the first versions of this PR above. I think the atomics scared everyone off but by now I've propagated <code>&amp;mut self</code> everywhere it needs to be, so this should be pretty straightforward. Then we can always memset the bitmap, but that's relatively small and should always be cheaper than an madvise, even on SpiderMonkey...</p>
</blockquote>



<a name="271067251"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%233733%20Implement%20lazy%20funcref%20table%20and%20a.../near/271067251" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.233733.20Implement.20lazy.20funcref.20table.20and.20a.2E.2E.2E.html#271067251">(Feb 08 2022 at 01:04)</a>:</h4>
<p>alexcrichton <a href="https://github.com/bytecodealliance/wasmtime/pull/3733#issuecomment-1032105813">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/3733">issue #3733</a>:</p>
<blockquote>
<p>I'm a bit perplexed with the numbers I'm seeing locally. Using <a href="https://gist.github.com/alexcrichton/0742ccae21b417f5d5b4e51b2507055d">this small program</a> I measured that the difference in memset-vs-madvise to clear 16 pages of memory is:</p>
<table>
<thead>
<tr>
<th>threads</th>
<th>memset</th>
<th>madvise</th>
</tr>
</thead>
<tbody>
<tr>
<td>1</td>
<td>691ns</td>
<td>234ns</td>
</tr>
<tr>
<td>4</td>
<td>752ns</td>
<td>7995ns</td>
</tr>
<tr>
<td>8</td>
<td>766ns</td>
<td>15991ns</td>
</tr>
</tbody>
</table>
<p>This is what I'd expect which is that memset has a relatively constant cost where <code>madvise</code> gets worse as you add more threads since there's more IPIs. I don't understand why memset gets slightly worse when you add more threads, however. (these are all threads operating on disjoint pages of memory).</p>
<p>So it doesn't really make sense to me that using <code>memset</code> in your benchmarks actually makes things slower rather than faster.</p>
<p>I don't have the <code>spidermonkey.wasm</code> you're testing with but a random "big module" that I had on hand was <a href="https://github.com/bytecodealliance/wasmtime/files/8019779/rustpython.wasm.gz">rustpython.wasm</a>. This has ~12k functions as a ~6k element table. I ran the <code>instantiation</code> benchmark with this PR as-is via:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="cp">$</span><span class="w"> </span><span class="n">cargo</span><span class="w"> </span><span class="n">bench</span><span class="w"> </span><span class="o">--</span><span class="n">features</span><span class="w"> </span><span class="n">memfd</span><span class="w"> </span><span class="o">--</span><span class="n">bench</span><span class="w"> </span><span class="n">instantiation</span><span class="w"> </span><span class="o">'</span><span class="na">parallel</span><span class="p">.</span><span class="o">*</span><span class="n">pool</span><span class="p">.</span><span class="o">*</span><span class="n">rustpy</span><span class="o">'</span><span class="w"></span>
</code></pre></div>
<p>After I applied <a href="https://gist.github.com/alexcrichton/e981b340c2ec6afa67da6023743ac1ab">this patch</a> which I believe avoids madvise for instance pages entirely and uses memset. Using the same benchmarking command the timings I got for the two approaches are:</p>
<table>
<thead>
<tr>
<th>threads</th>
<th>madvise</th>
<th>memset</th>
</tr>
</thead>
<tbody>
<tr>
<td>1</td>
<td>16us</td>
<td>8us</td>
</tr>
<tr>
<td>2</td>
<td>113us</td>
<td>15us</td>
</tr>
<tr>
<td>3</td>
<td>174us</td>
<td>40us</td>
</tr>
<tr>
<td>4</td>
<td>234us</td>
<td>44us</td>
</tr>
</tbody>
</table>
<p>This is more in line with what I am expecting. We're seeing that madvise is atrocious for concurrent performance, so I'm highly surprised that you're seeing madvise as faster and I'm seeing memset as faster. I'm working on the arm64 server that we have but I don't think x86_64 vs aarch64 would explain this difference.</p>
<p>I've confirmed with <code>perf</code> that the hottest symbol in the <code>madvise</code> build is <code>tlb_flush_mmu</code> (as expected), and the hottest symbol in the <code>memset</code> build is <code>memset</code> (also as expected).</p>
<p>Can you try to reproduce these results locally? If not I think we need to figure out what the difference is?</p>
</blockquote>



<a name="271078683"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%233733%20Implement%20lazy%20funcref%20table%20and%20a.../near/271078683" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.233733.20Implement.20lazy.20funcref.20table.20and.20a.2E.2E.2E.html#271078683">(Feb 08 2022 at 04:04)</a>:</h4>
<p>cfallin <a href="https://github.com/bytecodealliance/wasmtime/pull/3733#issuecomment-1032191692">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/3733">issue #3733</a>:</p>
<blockquote>
<blockquote>
<p>I'm working on the arm64 server that we have but I don't think x86_64 vs aarch64 would explain this difference.</p>
</blockquote>
<p>Ah, I think it would actually, or more precisely the server specs will: the aarch64 machine we have is 128 cores, so an "IPI to every core" is <em>exceedingly</em> expensive. For reference I'm doing tests on my Ryzen 3900X, 12 cores; big but not "never do a broadcast to all cores or you will suffer" big.</p>
<p>It seems to me that past a certain tradeoff point, which varies based on the system, madvise is faster to flash-zero sparsely accessed memory. (In the limit, the IPI is a fixed cost, flushing the whole TLB is a fixed cost, and actually zeroing the page tables is faster than zeroing whole pages.) Perhaps on arm2-ci that point is where we're zeroing 1MB, or 10MB, or 100MB; it would be interesting to sweep your experiment in that axis.</p>
<p>In any case, the numbers are the numbers; I suspect if I ssh'd to the arm64 machine and ran with your wasm module, I'd replicate yours, and if you ssh'd to my workstation and ran with my wasm module, you'd replicate mine. The interesting bits are the differences in platform configuration and workload I think.</p>
<p>For reference, my spidermonkey.wasm (<a href="https://cfallin.org/assets/spidermonkey.wasm.gz">gzipped</a>) has 31894 functions, so the anyfunc array is <em>765 kilobytes</em> that need to be zeroed. Three-quarters of a megabyte! We can definitely do better than that I think. (Possibly-exported functions, as you've suggested before -- I still need to build this -- comes to 7420 functions, or 178 KB; better but still too much.)</p>
<p>Given all of that, I do have a proposed direction that I think will solve all of the above issues: I believe that an initialization-bitmap can help us here. If we keep a bitmap to indicate when an anyfunc is not initialized, we need only 3992 bytes (499 <code>u64</code>s) for spidermonkey.wasm. This seems unambiguously better with no downsides, but please do let me know if you disagree :-) I'd be happy to split that part off into a separate PR with its own speedup measurements, leaving this PR with a memset-only approach (which should not be the final word for anyone running SpiderMonkey).</p>
</blockquote>



<a name="271080918"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%233733%20Implement%20lazy%20funcref%20table%20and%20a.../near/271080918" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.233733.20Implement.20lazy.20funcref.20table.20and.20a.2E.2E.2E.html#271080918">(Feb 08 2022 at 04:48)</a>:</h4>
<p>cfallin <a href="https://github.com/bytecodealliance/wasmtime/pull/3733#issuecomment-1032211993">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/3733">issue #3733</a>:</p>
<blockquote>
<p>I was curious to quantify the difference between our systems a bit more so:</p>
<blockquote>
<p>Using <a href="https://gist.github.com/alexcrichton/0742ccae21b417f5d5b4e51b2507055d">this small program</a> I measured that the difference in memset-vs-madvise to clear 16 pages of memory is:</p>
</blockquote>
<p>On a 12-core system I get:</p>
<h3>64KiB zeroing:</h3>
<table>
<thead>
<tr>
<th>threads</th>
<th>madvise</th>
<th>memset</th>
</tr>
</thead>
<tbody>
<tr>
<td>1</td>
<td>136ns</td>
<td>470ns</td>
</tr>
<tr>
<td>2</td>
<td>1.16µs</td>
<td>582ns</td>
</tr>
<tr>
<td>4</td>
<td>3.79µs</td>
<td>625ns</td>
</tr>
<tr>
<td>8</td>
<td>6µs</td>
<td>646ns</td>
</tr>
</tbody>
</table>
<h3>1 MiB zeroing:</h3>
<table>
<thead>
<tr>
<th>threads</th>
<th>madvise</th>
<th>memset</th>
</tr>
</thead>
<tbody>
<tr>
<td>1</td>
<td>363ns</td>
<td>10.635µs</td>
</tr>
<tr>
<td>2</td>
<td>1.724µs</td>
<td>11.438µs</td>
</tr>
<tr>
<td>4</td>
<td>3.857µs</td>
<td>11.694µs</td>
</tr>
<tr>
<td>8</td>
<td>5.554µs</td>
<td>12.308µs</td>
</tr>
</tbody>
</table>
<p>So on my system at least, madvise is a clear loss at. 64KiB, but is a win in all cases for 1 MiB. (Wildly enough, it becomes <em>more</em> of a win at higher thread counts, because the total cache footprint of all threads touching their memory exceeds my LLC size.) I haven't bisected the breakeven point between those two.</p>
<p>I'm also kind of flabbergasted at the cost of madvise on arm2-ci; for 64KIB, 8 threads,  you see 16 µs while I see 646 ns, about 25 times faster (!).</p>
<p>So given that my canonical "big module" requires close to a megabyte of VMContext zeroing, and given that we're testing on systems with wildly different TLB-shootdown cost, I'm not surprised at all that we've been led to different conclusions! The variance of workloads and systems "in the field" is all the more reason to not have to zero data at all, IMHO, by using a bitmap :-)</p>
</blockquote>



<a name="271091651"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%233733%20Implement%20lazy%20funcref%20table%20and%20a.../near/271091651" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.233733.20Implement.20lazy.20funcref.20table.20and.20a.2E.2E.2E.html#271091651">(Feb 08 2022 at 07:52)</a>:</h4>
<p>cfallin edited a <a href="https://github.com/bytecodealliance/wasmtime/pull/3733#issuecomment-1032211993">comment</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/3733">issue #3733</a>:</p>
<blockquote>
<p>I was curious to quantify the difference between our systems a bit more so:</p>
<blockquote>
<p>Using <a href="https://gist.github.com/alexcrichton/0742ccae21b417f5d5b4e51b2507055d">this small program</a> I measured that the difference in memset-vs-madvise to clear 16 pages of memory is:</p>
</blockquote>
<p>On a 12-core system I get:</p>
<h3>64KiB zeroing:</h3>
<table>
<thead>
<tr>
<th>threads</th>
<th>madvise</th>
<th>memset</th>
</tr>
</thead>
<tbody>
<tr>
<td>1</td>
<td>136ns</td>
<td>470ns</td>
</tr>
<tr>
<td>2</td>
<td>1.16µs</td>
<td>582ns</td>
</tr>
<tr>
<td>4</td>
<td>3.79µs</td>
<td>625ns</td>
</tr>
<tr>
<td>8</td>
<td>6µs</td>
<td>646ns</td>
</tr>
</tbody>
</table>
<h3>1 MiB zeroing:</h3>
<table>
<thead>
<tr>
<th>threads</th>
<th>madvise</th>
<th>memset</th>
</tr>
</thead>
<tbody>
<tr>
<td>1</td>
<td>363ns</td>
<td>10.635µs</td>
</tr>
<tr>
<td>2</td>
<td>1.724µs</td>
<td>11.438µs</td>
</tr>
<tr>
<td>4</td>
<td>3.857µs</td>
<td>11.694µs</td>
</tr>
<tr>
<td>8</td>
<td>5.554µs</td>
<td>12.308µs</td>
</tr>
</tbody>
</table>
<p>So on my system at least, madvise is a clear loss at. 64KiB, but is a win in all cases for 1 MiB. (Wildly enough, it becomes <em>more</em> of a win at higher thread counts, because the total cache footprint of all threads touching their memory exceeds my LLC size.) I haven't bisected the breakeven point between those two.</p>
<p>I'm also kind of flabbergasted at the cost of madvise on arm2-ci; for 64KIB, 8 threads,  you see 16 µs while I see &lt;strike&gt;646 ns, about 25 times faster (!).&lt;/strike&gt; EDIT: 6 µs, about 2.6x faster (table columns are hard sorry).</p>
<p>So given that my canonical "big module" requires close to a megabyte of VMContext zeroing, and given that we're testing on systems with wildly different TLB-shootdown cost, I'm not surprised at all that we've been led to different conclusions! The variance of workloads and systems "in the field" is all the more reason to not have to zero data at all, IMHO, by using a bitmap :-)</p>
</blockquote>



<a name="271145224"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%233733%20Implement%20lazy%20funcref%20table%20and%20a.../near/271145224" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.233733.20Implement.20lazy.20funcref.20table.20and.20a.2E.2E.2E.html#271145224">(Feb 08 2022 at 15:34)</a>:</h4>
<p>alexcrichton <a href="https://github.com/bytecodealliance/wasmtime/pull/3733#issuecomment-1032740347">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/3733">issue #3733</a>:</p>
<blockquote>
<p>Hm there's still more I'd like to dig into performance-wise here, but I don't want to over-rotate and dedicate this whole thread to a few lines of code that are pretty inconsequential. Additionally I was thinking last night and concluded "why even zero at all?" For the anyfunc array I don't think there's actually any need to zero since it's not accessed in a loop really right now. For example table elements are sort of a next layer of cache so if you hammer on table elements any computation to create the anyfunc is cached at that layer. Otherwise the only other uses of anyfuncs are exports (cached inherently as you typically pull out the export and don't pull it out again-and-again) and as <code>ref.func</code> which isn't really used by modules today. "Always compute anyfunc constructors" may make <code>ref.func</code> slower one day but it seems like we could cross that bridge when we get there.</p>
<p>Effectively I think we could get away with doing nothing to the anyfunc array on instantiation. When an anyfunc is asked for, and every time it's asked for, we construct the anyfunc into the appropriate slot and return it. These aren't ever used concurrently, as we've seen, so there's no need to worry about concurrent writes and it's fine to pave over what's previously there with the same content. </p>
<p>In the future when we have the instance/table/memory all adjacent in the pooling allocator we may as well zero out the memory with one <code>madvise</code> since it's pretty easy to do (and we're already require to do it for memories/tables). For now though until that happens it should be fine to leave the contents undefined until it's used. We could also implement a sort of "hardening" at some point to use <code>calloc</code> to alloc a <code>VMContext</code> in the on-demand allocator one day, but that doesn't need to be how it's done for now either.</p>
<p>If that seems reasonable then I think it's fine to shelve performance things for later since there's no longer a question of how to zero since we wouldn't need to zero at all.</p>
</blockquote>



<a name="271157583"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%233733%20Implement%20lazy%20funcref%20table%20and%20a.../near/271157583" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.233733.20Implement.20lazy.20funcref.20table.20and.20a.2E.2E.2E.html#271157583">(Feb 08 2022 at 16:59)</a>:</h4>
<p>cfallin <a href="https://github.com/bytecodealliance/wasmtime/pull/3733#issuecomment-1032844455">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/3733">issue #3733</a>:</p>
<blockquote>
<blockquote>
<p>I was thinking last night and concluded "why even zero at all?" For the anyfunc array I don't think there's actually any need to zero since it's not accessed in a loop really right now. For example table elements are sort of a next layer of cache so if you hammer on table elements any computation to create the anyfunc is cached at that layer. Otherwise the only other uses of anyfuncs are exports (cached inherently as you typically pull out the export and don't pull it out again-and-again) and as <code>ref.func</code> which isn't really used by modules today. "Always compute anyfunc constructors" may make <code>ref.func</code> slower one day but it seems like we could cross that bridge when we get there.</p>
</blockquote>
<p>Huh, that is a really interesting idea; I very much like the simplicity of it! Thanks!</p>
<p>I can do this, then file an issue to record the "maybe an is-initialized bitmap, or maybe madvise-zero anyfuncs along with the other bits" ideas when if/when we do eventually come across <code>ref.func</code> used in the wild in a hotpath.</p>
</blockquote>



<a name="271217816"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%233733%20Implement%20lazy%20funcref%20table%20and%20a.../near/271217816" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.233733.20Implement.20lazy.20funcref.20table.20and.20a.2E.2E.2E.html#271217816">(Feb 09 2022 at 01:13)</a>:</h4>
<p>cfallin <a href="https://github.com/bytecodealliance/wasmtime/pull/3733#issuecomment-1033227447">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/3733">issue #3733</a>:</p>
<blockquote>
<p>@alexcrichton I've done all of the refactors you suggested (<code>wasmtime::ModuleInner</code> implementing runtime trait directly, no separate Arc-held thing; and moving table init precomputation to compilation in <code>wasmtime_environ</code>) -- things are a lot cleaner now, thanks!</p>
<p>Tomorrow I'll squash this down and look at the complete diff with fresh eyes, and clean it up -- undoubtedly some small diffs have snuck in from attempting and undoing bits that I'll want to remove. I'll do a final round of before/after benchmarking as well so provide a good top-level summary of this PR's effects.</p>
</blockquote>



<a name="271234464"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%233733%20Implement%20lazy%20funcref%20table%20and%20a.../near/271234464" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.233733.20Implement.20lazy.20funcref.20table.20and.20a.2E.2E.2E.html#271234464">(Feb 09 2022 at 05:59)</a>:</h4>
<p>cfallin <a href="https://github.com/bytecodealliance/wasmtime/pull/3733#issuecomment-1033381970">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/3733">issue #3733</a>:</p>
<blockquote>
<p>OK, I think this is ready for the next (hopefully final? happy to keep going of course) round of review.</p>
<p>Here's a benchmark (in-tree benches/instantiation.rs, using above spidermonkey.wasm, memfd enabled, {1, 16} threads):</p>
<p>&lt;details&gt;</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="n">BEFORE</span>:

<span class="nc">sequential</span><span class="o">/</span><span class="n">default</span><span class="o">/</span><span class="n">spidermonkey</span><span class="p">.</span><span class="n">wasm</span><span class="w"></span>
<span class="w">                        </span><span class="n">time</span>:   <span class="p">[</span><span class="mf">68.569</span><span class="w"> </span><span class="n">us</span><span class="w"> </span><span class="mf">68.696</span><span class="w"> </span><span class="n">us</span><span class="w"> </span><span class="mf">68.856</span><span class="w"> </span><span class="n">us</span><span class="p">]</span><span class="w"></span>
<span class="n">sequential</span><span class="o">/</span><span class="n">pooling</span><span class="o">/</span><span class="n">spidermonkey</span><span class="p">.</span><span class="n">wasm</span><span class="w"></span>
<span class="w">                        </span><span class="n">time</span>:   <span class="p">[</span><span class="mf">69.406</span><span class="w"> </span><span class="n">us</span><span class="w"> </span><span class="mf">69.435</span><span class="w"> </span><span class="n">us</span><span class="w"> </span><span class="mf">69.465</span><span class="w"> </span><span class="n">us</span><span class="p">]</span><span class="w"></span>

<span class="n">parallel</span><span class="o">/</span><span class="n">default</span><span class="o">/</span><span class="n">spidermonkey</span><span class="p">.</span><span class="n">wasm</span>: <span class="nc">with</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="n">background</span><span class="w"> </span><span class="n">thread</span><span class="w"></span>
<span class="w">                        </span><span class="n">time</span>:   <span class="p">[</span><span class="mf">69.444</span><span class="w"> </span><span class="n">us</span><span class="w"> </span><span class="mf">69.470</span><span class="w"> </span><span class="n">us</span><span class="w"> </span><span class="mf">69.497</span><span class="w"> </span><span class="n">us</span><span class="p">]</span><span class="w"></span>
<span class="n">parallel</span><span class="o">/</span><span class="n">default</span><span class="o">/</span><span class="n">spidermonkey</span><span class="p">.</span><span class="n">wasm</span>: <span class="nc">with</span><span class="w"> </span><span class="mi">16</span><span class="w"> </span><span class="n">background</span><span class="w"> </span><span class="n">threads</span><span class="w"></span>
<span class="w">                        </span><span class="n">time</span>:   <span class="p">[</span><span class="mf">183.72</span><span class="w"> </span><span class="n">us</span><span class="w"> </span><span class="mf">184.31</span><span class="w"> </span><span class="n">us</span><span class="w"> </span><span class="mf">184.89</span><span class="w"> </span><span class="n">us</span><span class="p">]</span><span class="w"></span>
<span class="n">parallel</span><span class="o">/</span><span class="n">pooling</span><span class="o">/</span><span class="n">spidermonkey</span><span class="p">.</span><span class="n">wasm</span>: <span class="nc">with</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="n">background</span><span class="w"> </span><span class="n">thread</span><span class="w"></span>
<span class="w">                        </span><span class="n">time</span>:   <span class="p">[</span><span class="mf">69.018</span><span class="w"> </span><span class="n">us</span><span class="w"> </span><span class="mf">69.070</span><span class="w"> </span><span class="n">us</span><span class="w"> </span><span class="mf">69.136</span><span class="w"> </span><span class="n">us</span><span class="p">]</span><span class="w"></span>
<span class="n">parallel</span><span class="o">/</span><span class="n">pooling</span><span class="o">/</span><span class="n">spidermonkey</span><span class="p">.</span><span class="n">wasm</span>: <span class="nc">with</span><span class="w"> </span><span class="mi">16</span><span class="w"> </span><span class="n">background</span><span class="w"> </span><span class="n">threads</span><span class="w"></span>
<span class="w">                        </span><span class="n">time</span>:   <span class="p">[</span><span class="mf">326.81</span><span class="w"> </span><span class="n">us</span><span class="w"> </span><span class="mf">337.32</span><span class="w"> </span><span class="n">us</span><span class="w"> </span><span class="mf">347.01</span><span class="w"> </span><span class="n">us</span><span class="p">]</span><span class="w"></span>

<span class="n">WITH</span><span class="w"> </span><span class="n">THIS</span><span class="w"> </span><span class="n">PR</span>:

<span class="nc">sequential</span><span class="o">/</span><span class="n">default</span><span class="o">/</span><span class="n">spidermonkey</span><span class="p">.</span><span class="n">wasm</span><span class="w"></span>
<span class="w">                        </span><span class="n">time</span>:   <span class="p">[</span><span class="mf">6.7821</span><span class="w"> </span><span class="n">us</span><span class="w"> </span><span class="mf">6.8096</span><span class="w"> </span><span class="n">us</span><span class="w"> </span><span class="mf">6.8397</span><span class="w"> </span><span class="n">us</span><span class="p">]</span><span class="w"></span>
<span class="w">                        </span><span class="n">change</span>: <span class="p">[</span><span class="o">-</span><span class="mf">90.245</span><span class="o">%</span><span class="w"> </span><span class="o">-</span><span class="mf">90.193</span><span class="o">%</span><span class="w"> </span><span class="o">-</span><span class="mf">90.142</span><span class="o">%</span><span class="p">]</span><span class="w"> </span><span class="p">(</span><span class="n">p</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.00</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mf">0.05</span><span class="p">)</span><span class="w"></span>
<span class="w">                        </span><span class="n">Performance</span><span class="w"> </span><span class="n">has</span><span class="w"> </span><span class="n">improved</span><span class="p">.</span><span class="w"></span>
<span class="n">sequential</span><span class="o">/</span><span class="n">pooling</span><span class="o">/</span><span class="n">spidermonkey</span><span class="p">.</span><span class="n">wasm</span><span class="w"></span>
<span class="w">                        </span><span class="n">time</span>:   <span class="p">[</span><span class="mf">3.0410</span><span class="w"> </span><span class="n">us</span><span class="w"> </span><span class="mf">3.0558</span><span class="w"> </span><span class="n">us</span><span class="w"> </span><span class="mf">3.0724</span><span class="w"> </span><span class="n">us</span><span class="p">]</span><span class="w"></span>
<span class="w">                        </span><span class="n">change</span>: <span class="p">[</span><span class="o">-</span><span class="mf">95.566</span><span class="o">%</span><span class="w"> </span><span class="o">-</span><span class="mf">95.552</span><span class="o">%</span><span class="w"> </span><span class="o">-</span><span class="mf">95.537</span><span class="o">%</span><span class="p">]</span><span class="w"> </span><span class="p">(</span><span class="n">p</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.00</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mf">0.05</span><span class="p">)</span><span class="w"></span>
<span class="w">                        </span><span class="n">Performance</span><span class="w"> </span><span class="n">has</span><span class="w"> </span><span class="n">improved</span><span class="p">.</span><span class="w"></span>

<span class="n">parallel</span><span class="o">/</span><span class="n">default</span><span class="o">/</span><span class="n">spidermonkey</span><span class="p">.</span><span class="n">wasm</span>: <span class="nc">with</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="n">background</span><span class="w"> </span><span class="n">thread</span><span class="w"></span>
<span class="w">                        </span><span class="n">time</span>:   <span class="p">[</span><span class="mf">7.2643</span><span class="w"> </span><span class="n">us</span><span class="w"> </span><span class="mf">7.2689</span><span class="w"> </span><span class="n">us</span><span class="w"> </span><span class="mf">7.2735</span><span class="w"> </span><span class="n">us</span><span class="p">]</span><span class="w"></span>
<span class="w">                        </span><span class="n">change</span>: <span class="p">[</span><span class="o">-</span><span class="mf">89.541</span><span class="o">%</span><span class="w"> </span><span class="o">-</span><span class="mf">89.533</span><span class="o">%</span><span class="w"> </span><span class="o">-</span><span class="mf">89.525</span><span class="o">%</span><span class="p">]</span><span class="w"> </span><span class="p">(</span><span class="n">p</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.00</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mf">0.05</span><span class="p">)</span><span class="w"></span>
<span class="w">                        </span><span class="n">Performance</span><span class="w"> </span><span class="n">has</span><span class="w"> </span><span class="n">improved</span><span class="p">.</span><span class="w"></span>
<span class="n">parallel</span><span class="o">/</span><span class="n">default</span><span class="o">/</span><span class="n">spidermonkey</span><span class="p">.</span><span class="n">wasm</span>: <span class="nc">with</span><span class="w"> </span><span class="mi">16</span><span class="w"> </span><span class="n">background</span><span class="w"> </span><span class="n">threads</span><span class="w"></span>
<span class="w">                        </span><span class="n">time</span>:   <span class="p">[</span><span class="mf">147.36</span><span class="w"> </span><span class="n">us</span><span class="w"> </span><span class="mf">148.99</span><span class="w"> </span><span class="n">us</span><span class="w"> </span><span class="mf">150.74</span><span class="w"> </span><span class="n">us</span><span class="p">]</span><span class="w"></span>
<span class="w">                        </span><span class="n">change</span>: <span class="p">[</span><span class="o">-</span><span class="mf">18.997</span><span class="o">%</span><span class="w"> </span><span class="o">-</span><span class="mf">18.081</span><span class="o">%</span><span class="w"> </span><span class="o">-</span><span class="mf">17.285</span><span class="o">%</span><span class="p">]</span><span class="w"> </span><span class="p">(</span><span class="n">p</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.00</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mf">0.05</span><span class="p">)</span><span class="w"></span>
<span class="w">                        </span><span class="n">Performance</span><span class="w"> </span><span class="n">has</span><span class="w"> </span><span class="n">improved</span><span class="p">.</span><span class="w"></span>
<span class="n">parallel</span><span class="o">/</span><span class="n">pooling</span><span class="o">/</span><span class="n">spidermonkey</span><span class="p">.</span><span class="n">wasm</span>: <span class="nc">with</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="n">background</span><span class="w"> </span><span class="n">thread</span><span class="w"></span>
<span class="w">                        </span><span class="n">time</span>:   <span class="p">[</span><span class="mf">3.1009</span><span class="w"> </span><span class="n">us</span><span class="w"> </span><span class="mf">3.1021</span><span class="w"> </span><span class="n">us</span><span class="w"> </span><span class="mf">3.1033</span><span class="w"> </span><span class="n">us</span><span class="p">]</span><span class="w"></span>
<span class="w">                        </span><span class="n">change</span>: <span class="p">[</span><span class="o">-</span><span class="mf">95.517</span><span class="o">%</span><span class="w"> </span><span class="o">-</span><span class="mf">95.511</span><span class="o">%</span><span class="w"> </span><span class="o">-</span><span class="mf">95.506</span><span class="o">%</span><span class="p">]</span><span class="w"> </span><span class="p">(</span><span class="n">p</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.00</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mf">0.05</span><span class="p">)</span><span class="w"></span>
<span class="w">                        </span><span class="n">Performance</span><span class="w"> </span><span class="n">has</span><span class="w"> </span><span class="n">improved</span><span class="p">.</span><span class="w"></span>
<span class="n">parallel</span><span class="o">/</span><span class="n">pooling</span><span class="o">/</span><span class="n">spidermonkey</span><span class="p">.</span><span class="n">wasm</span>: <span class="nc">with</span><span class="w"> </span><span class="mi">16</span><span class="w"> </span><span class="n">background</span><span class="w"> </span><span class="n">threads</span><span class="w"></span>
<span class="w">                        </span><span class="n">time</span>:   <span class="p">[</span><span class="mf">49.449</span><span class="w"> </span><span class="n">us</span><span class="w"> </span><span class="mf">50.475</span><span class="w"> </span><span class="n">us</span><span class="w"> </span><span class="mf">51.540</span><span class="w"> </span><span class="n">us</span><span class="p">]</span><span class="w"></span>
<span class="w">                        </span><span class="n">change</span>: <span class="p">[</span><span class="o">-</span><span class="mf">85.423</span><span class="o">%</span><span class="w"> </span><span class="o">-</span><span class="mf">84.964</span><span class="o">%</span><span class="w"> </span><span class="o">-</span><span class="mf">84.465</span><span class="o">%</span><span class="p">]</span><span class="w"> </span><span class="p">(</span><span class="n">p</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.00</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mf">0.05</span><span class="p">)</span><span class="w"></span>
<span class="w">                        </span><span class="n">Performance</span><span class="w"> </span><span class="n">has</span><span class="w"> </span><span class="n">improved</span><span class="p">.</span><span class="w"></span>
</code></pre></div>
<p>&lt;/details&gt;</p>
<p>tl;dr: 80-95% faster, or 69µs -&gt; 7µs (1-threaded, on-demand) / 337µs -&gt; 50µs (16-threaded, pooling).</p>
</blockquote>



<a name="271353148"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%233733%20Implement%20lazy%20funcref%20table%20and%20a.../near/271353148" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.233733.20Implement.20lazy.20funcref.20table.20and.20a.2E.2E.2E.html#271353148">(Feb 09 2022 at 21:56)</a>:</h4>
<p>cfallin <a href="https://github.com/bytecodealliance/wasmtime/pull/3733#issuecomment-1034229861">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/3733">issue #3733</a>:</p>
<blockquote>
<p>Alright, everything addressed and CI green -- time to land this. Thanks again @alexcrichton for all the feedback!</p>
</blockquote>



<hr><p>Last updated: Jan 20 2025 at 06:04 UTC</p>
</html>