<html>
<head><meta charset="utf-8"><title>wasmtime / PR #6384 aarch64: Fix Ldr19 relocations being ... · git-wasmtime · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/index.html">git-wasmtime</a></h2>
<h3>Topic: <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.236384.20aarch64.3A.20Fix.20Ldr19.20relocations.20being.20.2E.2E.2E.html">wasmtime / PR #6384 aarch64: Fix Ldr19 relocations being ...</a></h3>

<hr>

<base href="https://bytecodealliance.zulipchat.com">

<head><link href="https://bytecodealliance.github.io/zulip-archive/style.css" rel="stylesheet"></head>

<a name="358605779"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%236384%20aarch64%3A%20Fix%20Ldr19%20relocations%20being%20.../near/358605779" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.236384.20aarch64.3A.20Fix.20Ldr19.20relocations.20being.20.2E.2E.2E.html#358605779">(May 16 2023 at 01:29)</a>:</h4>
<p>alexcrichton opened <a href="https://github.com/bytecodealliance/wasmtime/pull/6384">PR #6384</a> from <code>alexcrichton:fix-ldr19-out-of-bounds</code> to <code>bytecodealliance:main</code>:</p>
<blockquote>
<p>This commit is a suite of fixes and support to fix a bug on the AArch64 backend, and others. Before this commit constants were unconditionally placed at the end of a function which means that if the function was too large then references from the beginning of the function may be too far away. The fix here is a bit subtle but is generally to emit all previously referenced constants when an island is emitted, resetting constants to get emitted on the next island. This means that constants may be emitted multiple times throughout function emission, which solves both a reference being too far in front of you and behind you.</p>
<p>I've done testing of this with a new Cranelift setting that automatically inserts padding between basic blocks. This setting is additionally hooked up to the fuzzer to help uncover issues like this on OSS-Fuzz.</p>
</blockquote>



<a name="358605780"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%236384%20aarch64%3A%20Fix%20Ldr19%20relocations%20being%20.../near/358605780" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.236384.20aarch64.3A.20Fix.20Ldr19.20relocations.20being.20.2E.2E.2E.html#358605780">(May 16 2023 at 01:29)</a>:</h4>
<p><strong>alexcrichton</strong> requested <a href="https://github.com/jameysharp">jameysharp</a> for a review on <a href="https://github.com/bytecodealliance/wasmtime/pull/6384">PR #6384</a>.</p>



<a name="358605781"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%236384%20aarch64%3A%20Fix%20Ldr19%20relocations%20being%20.../near/358605781" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.236384.20aarch64.3A.20Fix.20Ldr19.20relocations.20being.20.2E.2E.2E.html#358605781">(May 16 2023 at 01:29)</a>:</h4>
<p><strong>alexcrichton</strong> requested <a href="https://github.com/orgs/bytecodealliance/teams/wasmtime-compiler-reviewers">wasmtime-compiler-reviewers</a> for a review on <a href="https://github.com/bytecodealliance/wasmtime/pull/6384">PR #6384</a>.</p>



<a name="358605782"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%236384%20aarch64%3A%20Fix%20Ldr19%20relocations%20being%20.../near/358605782" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.236384.20aarch64.3A.20Fix.20Ldr19.20relocations.20being.20.2E.2E.2E.html#358605782">(May 16 2023 at 01:29)</a>:</h4>
<p><strong>alexcrichton</strong> requested <a href="https://github.com/orgs/bytecodealliance/teams/wasmtime-core-reviewers">wasmtime-core-reviewers</a> for a review on <a href="https://github.com/bytecodealliance/wasmtime/pull/6384">PR #6384</a>.</p>



<a name="358607026"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%236384%20aarch64%3A%20Fix%20Ldr19%20relocations%20being%20.../near/358607026" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.236384.20aarch64.3A.20Fix.20Ldr19.20relocations.20being.20.2E.2E.2E.html#358607026">(May 16 2023 at 01:43)</a>:</h4>
<p>cfallin assigned <a href="https://github.com/bytecodealliance/wasmtime/pull/6384">PR #6384</a> to cfallin.</p>



<a name="358608328"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%236384%20aarch64%3A%20Fix%20Ldr19%20relocations%20being%20.../near/358608328" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.236384.20aarch64.3A.20Fix.20Ldr19.20relocations.20being.20.2E.2E.2E.html#358608328">(May 16 2023 at 02:01)</a>:</h4>
<p>cfallin submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/6384#pullrequestreview-1427576634">PR review</a>:</p>
<blockquote>
<p>This looks generally great -- thanks for tackling this! A few comments below mostly about cosmetics/docs but otherwise LGTM.</p>
</blockquote>



<a name="358608329"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%236384%20aarch64%3A%20Fix%20Ldr19%20relocations%20being%20.../near/358608329" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.236384.20aarch64.3A.20Fix.20Ldr19.20relocations.20being.20.2E.2E.2E.html#358608329">(May 16 2023 at 02:01)</a>:</h4>
<p>cfallin submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/6384#pullrequestreview-1427576634">PR review</a>:</p>
<blockquote>
<p>This looks generally great -- thanks for tackling this! A few comments below mostly about cosmetics/docs but otherwise LGTM.</p>
</blockquote>



<a name="358608330"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%236384%20aarch64%3A%20Fix%20Ldr19%20relocations%20being%20.../near/358608330" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.236384.20aarch64.3A.20Fix.20Ldr19.20relocations.20being.20.2E.2E.2E.html#358608330">(May 16 2023 at 02:01)</a>:</h4>
<p>cfallin created <a href="https://github.com/bytecodealliance/wasmtime/pull/6384#discussion_r1194512694">PR review comment</a>:</p>
<blockquote>
<p>Not too important here but FWIW a pattern I've used before for this kind of setting is "log2 - 1", which allows the zero baseline and still gives all powers of two.</p>
</blockquote>



<a name="358608331"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%236384%20aarch64%3A%20Fix%20Ldr19%20relocations%20being%20.../near/358608331" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.236384.20aarch64.3A.20Fix.20Ldr19.20relocations.20being.20.2E.2E.2E.html#358608331">(May 16 2023 at 02:01)</a>:</h4>
<p>cfallin created <a href="https://github.com/bytecodealliance/wasmtime/pull/6384#discussion_r1194518869">PR review comment</a>:</p>
<blockquote>
<p>A little more precise wording than "change over time" maybe: "this function may return a different label for the same constant at different points in time. The label is valid to use only from the current location; the MachBuffer takes care to emit the same constant multiple times if needed so the constant is always in range."</p>
</blockquote>



<a name="358608332"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%236384%20aarch64%3A%20Fix%20Ldr19%20relocations%20being%20.../near/358608332" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.236384.20aarch64.3A.20Fix.20Ldr19.20relocations.20being.20.2E.2E.2E.html#358608332">(May 16 2023 at 02:01)</a>:</h4>
<p>cfallin created <a href="https://github.com/bytecodealliance/wasmtime/pull/6384#discussion_r1194516540">PR review comment</a>:</p>
<blockquote>
<p>FWIW, I wonder if it isn't better to directly plumb the settings through to where <code>VCode</code> is created (or <code>VCodeBuilder::new</code> or similar); or else to <code>emit()</code> directly; the <code>EmitInfo</code> is part of the "assembler layer", and we want to keep this as loosely coupled as possible I think. (Not least for Winch's sake, but also just to avoid unnecessary entangling.)</p>
</blockquote>



<a name="358608333"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%236384%20aarch64%3A%20Fix%20Ldr19%20relocations%20being%20.../near/358608333" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.236384.20aarch64.3A.20Fix.20Ldr19.20relocations.20being.20.2E.2E.2E.html#358608333">(May 16 2023 at 02:01)</a>:</h4>
<p>cfallin created <a href="https://github.com/bytecodealliance/wasmtime/pull/6384#discussion_r1194519146">PR review comment</a>:</p>
<blockquote>
<p>The "undefined" bit I think can be left out here (or pushed into the body if you want to keep it): it's not supposed to be visible to the user of MachBuffer whether a label is defined yet or not, and we don't want to make it part of the contract.</p>
</blockquote>



<a name="358698848"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%236384%20aarch64%3A%20Fix%20Ldr19%20relocations%20being%20.../near/358698848" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.236384.20aarch64.3A.20Fix.20Ldr19.20relocations.20being.20.2E.2E.2E.html#358698848">(May 16 2023 at 11:27)</a>:</h4>
<p>afonso360 created <a href="https://github.com/bytecodealliance/wasmtime/pull/6384#discussion_r1195019487">PR review comment</a>:</p>
<blockquote>
<p><div class="codehilite" data-code-language="suggestion"><pre><span></span><code>target riscv64 has_v
</code></pre></div><br>
</p>
</blockquote>



<a name="358745220"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%236384%20aarch64%3A%20Fix%20Ldr19%20relocations%20being%20.../near/358745220" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.236384.20aarch64.3A.20Fix.20Ldr19.20relocations.20being.20.2E.2E.2E.html#358745220">(May 16 2023 at 14:11)</a>:</h4>
<p>alexcrichton updated <a href="https://github.com/bytecodealliance/wasmtime/pull/6384">PR #6384</a> (assigned to cfallin).</p>



<a name="358747572"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%236384%20aarch64%3A%20Fix%20Ldr19%20relocations%20being%20.../near/358747572" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.236384.20aarch64.3A.20Fix.20Ldr19.20relocations.20being.20.2E.2E.2E.html#358747572">(May 16 2023 at 14:18)</a>:</h4>
<p>alexcrichton updated <a href="https://github.com/bytecodealliance/wasmtime/pull/6384">PR #6384</a> (assigned to cfallin).</p>



<a name="358749179"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%236384%20aarch64%3A%20Fix%20Ldr19%20relocations%20being%20.../near/358749179" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.236384.20aarch64.3A.20Fix.20Ldr19.20relocations.20being.20.2E.2E.2E.html#358749179">(May 16 2023 at 14:24)</a>:</h4>
<p>alexcrichton updated <a href="https://github.com/bytecodealliance/wasmtime/pull/6384">PR #6384</a> (assigned to cfallin).</p>



<a name="358749350"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%236384%20aarch64%3A%20Fix%20Ldr19%20relocations%20being%20.../near/358749350" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.236384.20aarch64.3A.20Fix.20Ldr19.20relocations.20being.20.2E.2E.2E.html#358749350">(May 16 2023 at 14:24)</a>:</h4>
<p>alexcrichton created <a href="https://github.com/bytecodealliance/wasmtime/pull/6384#discussion_r1195251146">PR review comment</a>:</p>
<blockquote>
<p>Oh I apparently missed that vcode was already taking a flag from <code>settings::Flags</code> so all I had to do was pass in the struct rather than the single flag -- much easier!</p>
</blockquote>



<a name="358751890"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%236384%20aarch64%3A%20Fix%20Ldr19%20relocations%20being%20.../near/358751890" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.236384.20aarch64.3A.20Fix.20Ldr19.20relocations.20being.20.2E.2E.2E.html#358751890">(May 16 2023 at 14:32)</a>:</h4>
<p>alexcrichton updated <a href="https://github.com/bytecodealliance/wasmtime/pull/6384">PR #6384</a> (assigned to cfallin).</p>



<a name="358761295"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%236384%20aarch64%3A%20Fix%20Ldr19%20relocations%20being%20.../near/358761295" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.236384.20aarch64.3A.20Fix.20Ldr19.20relocations.20being.20.2E.2E.2E.html#358761295">(May 16 2023 at 15:02)</a>:</h4>
<p>alexcrichton updated <a href="https://github.com/bytecodealliance/wasmtime/pull/6384">PR #6384</a> (assigned to cfallin).</p>



<a name="358762909"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%236384%20aarch64%3A%20Fix%20Ldr19%20relocations%20being%20.../near/358762909" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.236384.20aarch64.3A.20Fix.20Ldr19.20relocations.20being.20.2E.2E.2E.html#358762909">(May 16 2023 at 15:07)</a>:</h4>
<p>alexcrichton has enabled auto merge for <a href="https://github.com/bytecodealliance/wasmtime/pull/6384">PR #6384</a>.</p>



<a name="358787442"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%236384%20aarch64%3A%20Fix%20Ldr19%20relocations%20being%20.../near/358787442" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.236384.20aarch64.3A.20Fix.20Ldr19.20relocations.20being.20.2E.2E.2E.html#358787442">(May 16 2023 at 16:34)</a>:</h4>
<p>alexcrichton merged <a href="https://github.com/bytecodealliance/wasmtime/pull/6384">PR #6384</a>.</p>



<hr><p>Last updated: Jan 20 2025 at 06:04 UTC</p>
</html>