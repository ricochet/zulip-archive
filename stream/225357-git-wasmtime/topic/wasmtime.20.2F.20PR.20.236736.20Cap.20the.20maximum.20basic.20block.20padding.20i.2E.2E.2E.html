<html>
<head><meta charset="utf-8"><title>wasmtime / PR #6736 Cap the maximum basic block padding i... · git-wasmtime · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/index.html">git-wasmtime</a></h2>
<h3>Topic: <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.236736.20Cap.20the.20maximum.20basic.20block.20padding.20i.2E.2E.2E.html">wasmtime / PR #6736 Cap the maximum basic block padding i...</a></h3>

<hr>

<base href="https://bytecodealliance.zulipchat.com">

<head><link href="https://bytecodealliance.github.io/zulip-archive/style.css" rel="stylesheet"></head>

<a name="376053015"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%236736%20Cap%20the%20maximum%20basic%20block%20padding%20i.../near/376053015" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.236736.20Cap.20the.20maximum.20basic.20block.20padding.20i.2E.2E.2E.html#376053015">(Jul 17 2023 at 14:50)</a>:</h4>
<p>alexcrichton opened <a href="https://github.com/bytecodealliance/wasmtime/pull/6736">PR #6736</a> from <code>alexcrichton:fix-fuzz-oom</code> to <code>bytecodealliance:main</code>:</p>
<blockquote>
<p>This commit is a fix for a fuzz failure that came in the other day where a module took more than 2GB of memory to compile, triggering the fuzzer to fail. Investigating locally it looks like the problem lies in the basic-block padding added recently. Turning on that option increases the memory usage of Cranelift from ~70M to ~2.5G. The setting in the test was to add <code>1&lt;&lt;14</code> bytes of padding between all basic blocks, and with a lot of basic blocks that can add up quite quickly.</p>
<p>The solution implemented here is to implement a per-function limit of the amount of padding that can be injected. I've set it to 1MB for now which is hopefully enough to continue to stress the various bits of the <code>MachBuffer</code> while not blowing limits accidentally while fuzzing.</p>
<p>After this commit the fuzz test case in question jumps from 70M to 470M with basic block padding enabled, which while still large is a bit more modest and sticks within the limits of the fuzzer.</p>
<p>&lt;!--<br>
Please make sure you include the following information:</p>
<ul>
<li>
<p>If this work has been discussed elsewhere, please include a link to that<br>
  conversation. If it was discussed in an issue, just mention "issue #...".</p>
</li>
<li>
<p>Explain why this change is needed. If the details are in an issue already,<br>
  this can be brief.</p>
</li>
</ul>
<p>Our development process is documented in the Wasmtime book:<br>
<a href="https://docs.wasmtime.dev/contributing-development-process.html">https://docs.wasmtime.dev/contributing-development-process.html</a></p>
<p>Please ensure all communication follows the code of conduct:<br>
<a href="https://github.com/bytecodealliance/wasmtime/blob/main/CODE_OF_CONDUCT.md">https://github.com/bytecodealliance/wasmtime/blob/main/CODE_OF_CONDUCT.md</a><br>
--&gt;</p>
</blockquote>



<a name="376053018"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%236736%20Cap%20the%20maximum%20basic%20block%20padding%20i.../near/376053018" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.236736.20Cap.20the.20maximum.20basic.20block.20padding.20i.2E.2E.2E.html#376053018">(Jul 17 2023 at 14:50)</a>:</h4>
<p><strong>alexcrichton</strong> requested <a href="https://github.com/orgs/bytecodealliance/teams/wasmtime-compiler-reviewers">wasmtime-compiler-reviewers</a> for a review on <a href="https://github.com/bytecodealliance/wasmtime/pull/6736">PR #6736</a>.</p>



<a name="376053019"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%236736%20Cap%20the%20maximum%20basic%20block%20padding%20i.../near/376053019" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.236736.20Cap.20the.20maximum.20basic.20block.20padding.20i.2E.2E.2E.html#376053019">(Jul 17 2023 at 14:50)</a>:</h4>
<p><strong>alexcrichton</strong> requested <a href="https://github.com/abrown">abrown</a> for a review on <a href="https://github.com/bytecodealliance/wasmtime/pull/6736">PR #6736</a>.</p>



<a name="376060319"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%236736%20Cap%20the%20maximum%20basic%20block%20padding%20i.../near/376060319" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.236736.20Cap.20the.20maximum.20basic.20block.20padding.20i.2E.2E.2E.html#376060319">(Jul 17 2023 at 15:08)</a>:</h4>
<p>bjorn3 submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/6736#pullrequestreview-1533037839">PR review</a>.</p>



<a name="376060321"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%236736%20Cap%20the%20maximum%20basic%20block%20padding%20i.../near/376060321" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.236736.20Cap.20the.20maximum.20basic.20block.20padding.20i.2E.2E.2E.html#376060321">(Jul 17 2023 at 15:08)</a>:</h4>
<p>bjorn3 created <a href="https://github.com/bytecodealliance/wasmtime/pull/6736#discussion_r1265515327">PR review comment</a>:</p>
<blockquote>
<p>I think this would limit it to a single conditional branch where the branch destination doesn't fit and thus a veneer needs to be inserted on AArch64. Maybe bump it to 1 &lt;&lt; 21?</p>
</blockquote>



<a name="376093348"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%236736%20Cap%20the%20maximum%20basic%20block%20padding%20i.../near/376093348" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.236736.20Cap.20the.20maximum.20basic.20block.20padding.20i.2E.2E.2E.html#376093348">(Jul 17 2023 at 16:19)</a>:</h4>
<p><strong>alexcrichton</strong> requested <a href="https://github.com/pchickey">pchickey</a> for a review on <a href="https://github.com/bytecodealliance/wasmtime/pull/6736">PR #6736</a>.</p>



<a name="376093349"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%236736%20Cap%20the%20maximum%20basic%20block%20padding%20i.../near/376093349" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.236736.20Cap.20the.20maximum.20basic.20block.20padding.20i.2E.2E.2E.html#376093349">(Jul 17 2023 at 16:19)</a>:</h4>
<p>alexcrichton updated <a href="https://github.com/bytecodealliance/wasmtime/pull/6736">PR #6736</a>.</p>



<a name="376093350"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%236736%20Cap%20the%20maximum%20basic%20block%20padding%20i.../near/376093350" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.236736.20Cap.20the.20maximum.20basic.20block.20padding.20i.2E.2E.2E.html#376093350">(Jul 17 2023 at 16:19)</a>:</h4>
<p><strong>alexcrichton</strong> requested <a href="https://github.com/orgs/bytecodealliance/teams/wasmtime-core-reviewers">wasmtime-core-reviewers</a> for a review on <a href="https://github.com/bytecodealliance/wasmtime/pull/6736">PR #6736</a>.</p>



<a name="376094108"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%236736%20Cap%20the%20maximum%20basic%20block%20padding%20i.../near/376094108" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.236736.20Cap.20the.20maximum.20basic.20block.20padding.20i.2E.2E.2E.html#376094108">(Jul 17 2023 at 16:21)</a>:</h4>
<p>alexcrichton submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/6736#pullrequestreview-1533175030">PR review</a>.</p>



<a name="376094109"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%236736%20Cap%20the%20maximum%20basic%20block%20padding%20i.../near/376094109" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.236736.20Cap.20the.20maximum.20basic.20block.20padding.20i.2E.2E.2E.html#376094109">(Jul 17 2023 at 16:21)</a>:</h4>
<p>alexcrichton created <a href="https://github.com/bytecodealliance/wasmtime/pull/6736#discussion_r1265603935">PR review comment</a>:</p>
<blockquote>
<p>That's a good point yeah and was something I was worried about as well. I'm a bit worried though that bumping this to 21 (predictably) doubles the memory usage.</p>
<p>I've instead opted for a different strategy now:</p>
<ul>
<li>Each function gets at most 64M of padding</li>
<li>Padding is only enabled for fuzz test cases with &lt;10 functions</li>
</ul>
<p>That should help continue to explore interesting cases while avoiding the large memory increases seen prior I think</p>
</blockquote>



<a name="376166627"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%236736%20Cap%20the%20maximum%20basic%20block%20padding%20i.../near/376166627" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.236736.20Cap.20the.20maximum.20basic.20block.20padding.20i.2E.2E.2E.html#376166627">(Jul 17 2023 at 21:25)</a>:</h4>
<p>bjorn3 submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/6736#pullrequestreview-1533724547">PR review</a>.</p>



<a name="376166629"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%236736%20Cap%20the%20maximum%20basic%20block%20padding%20i.../near/376166629" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.236736.20Cap.20the.20maximum.20basic.20block.20padding.20i.2E.2E.2E.html#376166629">(Jul 17 2023 at 21:25)</a>:</h4>
<p>bjorn3 created <a href="https://github.com/bytecodealliance/wasmtime/pull/6736#discussion_r1265919521">PR review comment</a>:</p>
<blockquote>
<p>*doesn't</p>
</blockquote>



<a name="376367861"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%236736%20Cap%20the%20maximum%20basic%20block%20padding%20i.../near/376367861" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.236736.20Cap.20the.20maximum.20basic.20block.20padding.20i.2E.2E.2E.html#376367861">(Jul 18 2023 at 14:18)</a>:</h4>
<p>alexcrichton updated <a href="https://github.com/bytecodealliance/wasmtime/pull/6736">PR #6736</a>.</p>



<a name="376491178"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%236736%20Cap%20the%20maximum%20basic%20block%20padding%20i.../near/376491178" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.236736.20Cap.20the.20maximum.20basic.20block.20padding.20i.2E.2E.2E.html#376491178">(Jul 18 2023 at 23:09)</a>:</h4>
<p>abrown submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/6736#pullrequestreview-1536014232">PR review</a>:</p>
<blockquote>
<p>I'm fine with this but wonder if @cfallin might have an opinion: limiting the Cranelift functions to a padded 64MB makes it possible that some of the larger islands never get fuzzed? IIRC, don't we have 2GB islands on x86?</p>
</blockquote>



<a name="376685473"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%236736%20Cap%20the%20maximum%20basic%20block%20padding%20i.../near/376685473" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.236736.20Cap.20the.20maximum.20basic.20block.20padding.20i.2E.2E.2E.html#376685473">(Jul 19 2023 at 14:23)</a>:</h4>
<p>alexcrichton updated <a href="https://github.com/bytecodealliance/wasmtime/pull/6736">PR #6736</a>.</p>



<a name="376685782"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%236736%20Cap%20the%20maximum%20basic%20block%20padding%20i.../near/376685782" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.236736.20Cap.20the.20maximum.20basic.20block.20padding.20i.2E.2E.2E.html#376685782">(Jul 19 2023 at 14:24)</a>:</h4>
<p>alexcrichton has enabled auto merge for <a href="https://github.com/bytecodealliance/wasmtime/pull/6736">PR #6736</a>.</p>



<a name="376712668"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%236736%20Cap%20the%20maximum%20basic%20block%20padding%20i.../near/376712668" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.236736.20Cap.20the.20maximum.20basic.20block.20padding.20i.2E.2E.2E.html#376712668">(Jul 19 2023 at 15:44)</a>:</h4>
<p>alexcrichton merged <a href="https://github.com/bytecodealliance/wasmtime/pull/6736">PR #6736</a>.</p>



<hr><p>Last updated: Jan 20 2025 at 06:04 UTC</p>
</html>