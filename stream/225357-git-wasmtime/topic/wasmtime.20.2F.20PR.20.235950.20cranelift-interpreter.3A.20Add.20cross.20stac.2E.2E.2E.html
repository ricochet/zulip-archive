<html>
<head><meta charset="utf-8"><title>wasmtime / PR #5950 cranelift-interpreter: Add cross stac... · git-wasmtime · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/index.html">git-wasmtime</a></h2>
<h3>Topic: <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.235950.20cranelift-interpreter.3A.20Add.20cross.20stac.2E.2E.2E.html">wasmtime / PR #5950 cranelift-interpreter: Add cross stac...</a></h3>

<hr>

<base href="https://bytecodealliance.zulipchat.com">

<head><link href="https://bytecodealliance.github.io/zulip-archive/style.css" rel="stylesheet"></head>

<a name="340058593"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%235950%20cranelift-interpreter%3A%20Add%20cross%20stac.../near/340058593" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.235950.20cranelift-interpreter.3A.20Add.20cross.20stac.2E.2E.2E.html#340058593">(Mar 07 2023 at 09:35)</a>:</h4>
<p>jan-justin opened <a href="https://github.com/bytecodealliance/wasmtime/pull/5950">PR #5950</a> from <code>cranelift-interpreter-trap-xss-access</code> to <code>main</code>:</p>
<blockquote>
<p>This PR adds a check and trap on <code>InterpreterState::checked_{load,store}</code> across stack slots, which should be prevented since stack slots may be re-ordered.</p>
<p>The relevant details of the bug can be found over at #5927.</p>
<p>&lt;!--</p>
<p>Please ensure that the following steps are all taken care of before submitting<br>
the PR.</p>
<ul>
<li>
<p>[ ] This has been discussed in issue #..., or if not, please tell us why<br>
  here.</p>
</li>
<li>
<p>[ ] A short description of what this does, why it is needed; if the<br>
  description becomes long, the matter should probably be discussed in an issue<br>
  first.</p>
</li>
<li>
<p>[ ] This PR contains test cases, if meaningful.</p>
</li>
<li>[ ] A reviewer from the core maintainer team has been assigned for this PR.<br>
  If you don't know who could review this, please indicate so. The list of<br>
  suggested reviewers on the right can help you.</li>
</ul>
<p>Please ensure all communication adheres to the <a href="https://github.com/bytecodealliance/wasmtime/blob/master/CODE_OF_CONDUCT.md">code of
conduct</a>.<br>
--&gt;<br>
</p>
</blockquote>



<a name="340059643"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%235950%20cranelift-interpreter%3A%20Add%20cross%20stac.../near/340059643" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.235950.20cranelift-interpreter.3A.20Add.20cross.20stac.2E.2E.2E.html#340059643">(Mar 07 2023 at 09:40)</a>:</h4>
<p>jan-justin submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/5950#pullrequestreview-1327994946">PR review</a>.</p>



<a name="340059644"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%235950%20cranelift-interpreter%3A%20Add%20cross%20stac.../near/340059644" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.235950.20cranelift-interpreter.3A.20Add.20cross.20stac.2E.2E.2E.html#340059644">(Mar 07 2023 at 09:40)</a>:</h4>
<p>jan-justin created <a href="https://github.com/bytecodealliance/wasmtime/pull/5950#discussion_r1127597311">PR review comment</a>:</p>
<blockquote>
<p>I saw that <a href="https://github.com/bytecodealliance/wasmtime/blob/3ff3994a128e900dfe7a465c7f36fc5a074d07ef/cranelift/interpreter/src/interpreter.rs#L296"><code>InterpreterState::stack_address</code></a> utilises <code>sized_stack_slots</code> and as far as I can tell the stack slot order is preserved by <code>PrimaryMap</code>.</p>
<p>However, I am not sure how to account for padding between the slots at this point in time.</p>
</blockquote>



<a name="340152418"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%235950%20cranelift-interpreter%3A%20Add%20cross%20stac.../near/340152418" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.235950.20cranelift-interpreter.3A.20Add.20cross.20stac.2E.2E.2E.html#340152418">(Mar 07 2023 at 16:18)</a>:</h4>
<p>afonso360 submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/5950#pullrequestreview-1328962828">PR review</a>.</p>



<a name="340152421"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%235950%20cranelift-interpreter%3A%20Add%20cross%20stac.../near/340152421" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.235950.20cranelift-interpreter.3A.20Add.20cross.20stac.2E.2E.2E.html#340152421">(Mar 07 2023 at 16:18)</a>:</h4>
<p>afonso360 created <a href="https://github.com/bytecodealliance/wasmtime/pull/5950#discussion_r1128139562">PR review comment</a>:</p>
<blockquote>
<p>We shouldn't have to worry about padding between slots since the interpreter doesn't do anything like that. And yeah, we always insert them in order, so we should be ok there too.</p>
</blockquote>



<a name="340165351"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%235950%20cranelift-interpreter%3A%20Add%20cross%20stac.../near/340165351" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.235950.20cranelift-interpreter.3A.20Add.20cross.20stac.2E.2E.2E.html#340165351">(Mar 07 2023 at 17:14)</a>:</h4>
<p>afonso360 edited <a href="https://github.com/bytecodealliance/wasmtime/pull/5950#discussion_r1128139562">PR review comment</a>.</p>



<a name="340182561"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%235950%20cranelift-interpreter%3A%20Add%20cross%20stac.../near/340182561" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.235950.20cranelift-interpreter.3A.20Add.20cross.20stac.2E.2E.2E.html#340182561">(Mar 07 2023 at 18:29)</a>:</h4>
<p>afonso360 submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/5950#pullrequestreview-1329248392">PR review</a>.</p>



<a name="340182562"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%235950%20cranelift-interpreter%3A%20Add%20cross%20stac.../near/340182562" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.235950.20cranelift-interpreter.3A.20Add.20cross.20stac.2E.2E.2E.html#340182562">(Mar 07 2023 at 18:29)</a>:</h4>
<p>afonso360 submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/5950#pullrequestreview-1329248392">PR review</a>.</p>



<a name="340182566"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%235950%20cranelift-interpreter%3A%20Add%20cross%20stac.../near/340182566" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.235950.20cranelift-interpreter.3A.20Add.20cross.20stac.2E.2E.2E.html#340182566">(Mar 07 2023 at 18:29)</a>:</h4>
<p>afonso360 created <a href="https://github.com/bytecodealliance/wasmtime/pull/5950#discussion_r1128352807">PR review comment</a>:</p>
<blockquote>
<p>We probably don't want to panic here. We can reach this condition by doing something like:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="n">v0</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">stack_addr</span><span class="w"> </span><span class="n">ss0</span>
<span class="n">v1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">iadd_imm</span><span class="w"> </span><span class="n">v0</span><span class="p">,</span><span class="w"> </span><span class="mh">0xFFFFFF</span>
</code></pre></div>
<p>Which would normally generate a OutOfBoundsLoad / Store instead of panicking</p>
</blockquote>



<a name="340190749"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%235950%20cranelift-interpreter%3A%20Add%20cross%20stac.../near/340190749" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.235950.20cranelift-interpreter.3A.20Add.20cross.20stac.2E.2E.2E.html#340190749">(Mar 07 2023 at 19:06)</a>:</h4>
<p>jan-justin submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/5950#pullrequestreview-1329331579">PR review</a>.</p>



<a name="340190751"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%235950%20cranelift-interpreter%3A%20Add%20cross%20stac.../near/340190751" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.235950.20cranelift-interpreter.3A.20Add.20cross.20stac.2E.2E.2E.html#340190751">(Mar 07 2023 at 19:06)</a>:</h4>
<p>jan-justin created <a href="https://github.com/bytecodealliance/wasmtime/pull/5950#discussion_r1128421154">PR review comment</a>:</p>
<blockquote>
<p>I see. Thanks for the clarification!</p>
</blockquote>



<a name="340193441"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%235950%20cranelift-interpreter%3A%20Add%20cross%20stac.../near/340193441" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.235950.20cranelift-interpreter.3A.20Add.20cross.20stac.2E.2E.2E.html#340193441">(Mar 07 2023 at 19:19)</a>:</h4>
<p>jan-justin submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/5950#pullrequestreview-1329350169">PR review</a>.</p>



<a name="340193442"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%235950%20cranelift-interpreter%3A%20Add%20cross%20stac.../near/340193442" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.235950.20cranelift-interpreter.3A.20Add.20cross.20stac.2E.2E.2E.html#340193442">(Mar 07 2023 at 19:19)</a>:</h4>
<p>jan-justin created <a href="https://github.com/bytecodealliance/wasmtime/pull/5950#discussion_r1128438973">PR review comment</a>:</p>
<blockquote>
<p>I originally thought that since the check that precedes this is the check for storing/loading beyond the stack, it would be caught. However, in hindsight it does not appear to be sufficient. I will gladly change it.</p>
</blockquote>



<a name="340197291"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%235950%20cranelift-interpreter%3A%20Add%20cross%20stac.../near/340197291" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.235950.20cranelift-interpreter.3A.20Add.20cross.20stac.2E.2E.2E.html#340197291">(Mar 07 2023 at 19:36)</a>:</h4>
<p>jan-justin updated <a href="https://github.com/bytecodealliance/wasmtime/pull/5950">PR #5950</a> from <code>cranelift-interpreter-trap-xss-access</code> to <code>main</code>.</p>



<a name="340198233"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%235950%20cranelift-interpreter%3A%20Add%20cross%20stac.../near/340198233" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.235950.20cranelift-interpreter.3A.20Add.20cross.20stac.2E.2E.2E.html#340198233">(Mar 07 2023 at 19:41)</a>:</h4>
<p>jan-justin updated <a href="https://github.com/bytecodealliance/wasmtime/pull/5950">PR #5950</a> from <code>cranelift-interpreter-trap-xss-access</code> to <code>main</code>.</p>



<a name="345473104"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%235950%20cranelift-interpreter%3A%20Add%20cross%20stac.../near/345473104" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.235950.20cranelift-interpreter.3A.20Add.20cross.20stac.2E.2E.2E.html#345473104">(Mar 29 2023 at 17:36)</a>:</h4>
<p>jameysharp closed without merge <a href="https://github.com/bytecodealliance/wasmtime/pull/5950">PR #5950</a>.</p>



<hr><p>Last updated: Jan 20 2025 at 06:04 UTC</p>
</html>