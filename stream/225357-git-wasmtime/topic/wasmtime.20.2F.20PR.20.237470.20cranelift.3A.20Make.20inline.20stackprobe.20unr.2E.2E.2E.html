<html>
<head><meta charset="utf-8"><title>wasmtime / PR #7470 cranelift: Make inline stackprobe unr... · git-wasmtime · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/index.html">git-wasmtime</a></h2>
<h3>Topic: <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.237470.20cranelift.3A.20Make.20inline.20stackprobe.20unr.2E.2E.2E.html">wasmtime / PR #7470 cranelift: Make inline stackprobe unr...</a></h3>

<hr>

<base href="https://bytecodealliance.zulipchat.com">

<head><link href="https://bytecodealliance.github.io/zulip-archive/style.css" rel="stylesheet"></head>

<a name="400129061"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%237470%20cranelift%3A%20Make%20inline%20stackprobe%20unr.../near/400129061" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.237470.20cranelift.3A.20Make.20inline.20stackprobe.20unr.2E.2E.2E.html#400129061">(Nov 03 2023 at 12:59)</a>:</h4>
<p>afonso360 opened <a href="https://github.com/bytecodealliance/wasmtime/pull/7470">PR #7470</a> from <code>afonso360:unroll-valgrind</code> to <code>bytecodealliance:main</code>:</p>
<blockquote>
<p><span aria-label="wave" class="emoji emoji-1f44b" role="img" title="wave">:wave:</span> Hey,</p>
<p>This PR alters our stackprobe unroll sequences to move the stackpointer before writing to the stack. I don't think there was anything wrong with what we were doing before but it makes valgrind really unhappy. (See #7454)</p>
<p>I've tested this with cg_clif on x86, and it now cleanly passes valgrind for the original reported testcase.</p>
<p>Fixes: #7454<br>
prtest:full</p>
</blockquote>



<a name="400129065"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%237470%20cranelift%3A%20Make%20inline%20stackprobe%20unr.../near/400129065" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.237470.20cranelift.3A.20Make.20inline.20stackprobe.20unr.2E.2E.2E.html#400129065">(Nov 03 2023 at 12:59)</a>:</h4>
<p><strong>afonso360</strong> requested <a href="https://github.com/fitzgen">fitzgen</a> for a review on <a href="https://github.com/bytecodealliance/wasmtime/pull/7470">PR #7470</a>.</p>



<a name="400129066"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%237470%20cranelift%3A%20Make%20inline%20stackprobe%20unr.../near/400129066" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.237470.20cranelift.3A.20Make.20inline.20stackprobe.20unr.2E.2E.2E.html#400129066">(Nov 03 2023 at 12:59)</a>:</h4>
<p><strong>afonso360</strong> requested <a href="https://github.com/orgs/bytecodealliance/teams/wasmtime-compiler-reviewers">wasmtime-compiler-reviewers</a> for a review on <a href="https://github.com/bytecodealliance/wasmtime/pull/7470">PR #7470</a>.</p>



<a name="400167860"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%237470%20cranelift%3A%20Make%20inline%20stackprobe%20unr.../near/400167860" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.237470.20cranelift.3A.20Make.20inline.20stackprobe.20unr.2E.2E.2E.html#400167860">(Nov 03 2023 at 16:29)</a>:</h4>
<p>fitzgen submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/7470#pullrequestreview-1713106134">PR review</a>:</p>
<blockquote>
<p>Thanks!</p>
</blockquote>



<a name="400167862"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%237470%20cranelift%3A%20Make%20inline%20stackprobe%20unr.../near/400167862" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.237470.20cranelift.3A.20Make.20inline.20stackprobe.20unr.2E.2E.2E.html#400167862">(Nov 03 2023 at 16:29)</a>:</h4>
<p>fitzgen submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/7470#pullrequestreview-1713106134">PR review</a>:</p>
<blockquote>
<p>Thanks!</p>
</blockquote>



<a name="400167863"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%237470%20cranelift%3A%20Make%20inline%20stackprobe%20unr.../near/400167863" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.237470.20cranelift.3A.20Make.20inline.20stackprobe.20unr.2E.2E.2E.html#400167863">(Nov 03 2023 at 16:29)</a>:</h4>
<p>fitzgen created <a href="https://github.com/bytecodealliance/wasmtime/pull/7470#discussion_r1381947953">PR review comment</a>:</p>
<blockquote>
<p>Out of curiosity / unrelated to this PR: do you know why it is necessary to probe via storing to the stack rather than loading from the stack? It seems like either would accomplish the task AFAICT, and loads should be cheaper than stores.</p>
</blockquote>



<a name="400168510"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%237470%20cranelift%3A%20Make%20inline%20stackprobe%20unr.../near/400168510" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.237470.20cranelift.3A.20Make.20inline.20stackprobe.20unr.2E.2E.2E.html#400168510">(Nov 03 2023 at 16:33)</a>:</h4>
<p>cfallin submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/7470#pullrequestreview-1713119705">PR review</a>.</p>



<a name="400168511"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%237470%20cranelift%3A%20Make%20inline%20stackprobe%20unr.../near/400168511" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.237470.20cranelift.3A.20Make.20inline.20stackprobe.20unr.2E.2E.2E.html#400168511">(Nov 03 2023 at 16:33)</a>:</h4>
<p>cfallin created <a href="https://github.com/bytecodealliance/wasmtime/pull/7470#discussion_r1381956872">PR review comment</a>:</p>
<blockquote>
<p>From the point of view of global cost, stores might actually be better, I suspect: if it faults in a new page, a load would cause a read-only mapping to the global zero page to be created, and the first write would then cause another page fault (at least if the stack is an ordinary <code>MAP_ANON</code> region). Or at least, we've seen elsewhere that it's better for first touch to be write when TLB contention is high...</p>
</blockquote>



<a name="400175849"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%237470%20cranelift%3A%20Make%20inline%20stackprobe%20unr.../near/400175849" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.237470.20cranelift.3A.20Make.20inline.20stackprobe.20unr.2E.2E.2E.html#400175849">(Nov 03 2023 at 17:13)</a>:</h4>
<p>fitzgen submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/7470#pullrequestreview-1713185155">PR review</a>.</p>



<a name="400175850"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%237470%20cranelift%3A%20Make%20inline%20stackprobe%20unr.../near/400175850" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.237470.20cranelift.3A.20Make.20inline.20stackprobe.20unr.2E.2E.2E.html#400175850">(Nov 03 2023 at 17:13)</a>:</h4>
<p>fitzgen created <a href="https://github.com/bytecodealliance/wasmtime/pull/7470#discussion_r1381997761">PR review comment</a>:</p>
<blockquote>
<p>Ah okay that makes sense. Thanks!</p>
</blockquote>



<a name="400204302"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%237470%20cranelift%3A%20Make%20inline%20stackprobe%20unr.../near/400204302" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.237470.20cranelift.3A.20Make.20inline.20stackprobe.20unr.2E.2E.2E.html#400204302">(Nov 03 2023 at 20:59)</a>:</h4>
<p>afonso360 merged <a href="https://github.com/bytecodealliance/wasmtime/pull/7470">PR #7470</a>.</p>



<hr><p>Last updated: Jan 20 2025 at 06:04 UTC</p>
</html>