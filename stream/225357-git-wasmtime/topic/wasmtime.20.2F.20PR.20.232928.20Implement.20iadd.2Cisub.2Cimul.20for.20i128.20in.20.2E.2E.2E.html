<html>
<head><meta charset="utf-8"><title>wasmtime / PR #2928 Implement iadd,isub,imul for i128 in ... · git-wasmtime · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/index.html">git-wasmtime</a></h2>
<h3>Topic: <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232928.20Implement.20iadd.2Cisub.2Cimul.20for.20i128.20in.20.2E.2E.2E.html">wasmtime / PR #2928 Implement iadd,isub,imul for i128 in ...</a></h3>

<hr>

<base href="https://bytecodealliance.zulipchat.com">

<head><link href="https://bytecodealliance.github.io/zulip-archive/style.css" rel="stylesheet"></head>

<a name="239967159"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232928%20Implement%20iadd%2Cisub%2Cimul%20for%20i128%20in%20.../near/239967159" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232928.20Implement.20iadd.2Cisub.2Cimul.20for.20i128.20in.20.2E.2E.2E.html#239967159">(May 23 2021 at 17:51)</a>:</h4>
<p>afonso360 opened <a href="https://github.com/bytecodealliance/wasmtime/pull/2928">PR #2928</a> from <code>aarch64-i128-ops</code> to <code>main</code>:</p>
<blockquote>
<p>This PR implements some basic operations (add, sub, mul) for i128 types on AArch64</p>
</blockquote>



<a name="239985152"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232928%20Implement%20iadd%2Cisub%2Cimul%20for%20i128%20in%20.../near/239985152" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232928.20Implement.20iadd.2Cisub.2Cimul.20for.20i128.20in.20.2E.2E.2E.html#239985152">(May 23 2021 at 23:15)</a>:</h4>
<p>cfallin created <a href="https://github.com/bytecodealliance/wasmtime/pull/2928#discussion_r637614587">PR review comment</a>:</p>
<blockquote>
<p>Could we include this test in a separate PR for the iconst issue? Or alternately just update the iconst implementation here (it should only be a few lines of code, I think!).</p>
</blockquote>



<a name="239985153"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232928%20Implement%20iadd%2Cisub%2Cimul%20for%20i128%20in%20.../near/239985153" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232928.20Implement.20iadd.2Cisub.2Cimul.20for.20i128.20in.20.2E.2E.2E.html#239985153">(May 23 2021 at 23:15)</a>:</h4>
<p>cfallin submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/2928#pullrequestreview-666313398">PR review</a>.</p>



<a name="239985154"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232928%20Implement%20iadd%2Cisub%2Cimul%20for%20i128%20in%20.../near/239985154" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232928.20Implement.20iadd.2Cisub.2Cimul.20for.20i128.20in.20.2E.2E.2E.html#239985154">(May 23 2021 at 23:15)</a>:</h4>
<p>cfallin created <a href="https://github.com/bytecodealliance/wasmtime/pull/2928#discussion_r637614570">PR review comment</a>:</p>
<blockquote>
<p>A few more test vectors would be good to have here, I think -- e.g. the upper 64 bits of the first operand are always zero here. Want to make sure that all four of the half-product quadrants are computed properly :-)</p>
</blockquote>



<a name="239985155"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232928%20Implement%20iadd%2Cisub%2Cimul%20for%20i128%20in%20.../near/239985155" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232928.20Implement.20iadd.2Cisub.2Cimul.20for.20i128.20in.20.2E.2E.2E.html#239985155">(May 23 2021 at 23:15)</a>:</h4>
<p>cfallin submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/2928#pullrequestreview-666313398">PR review</a>.</p>



<a name="239985156"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232928%20Implement%20iadd%2Cisub%2Cimul%20for%20i128%20in%20.../near/239985156" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232928.20Implement.20iadd.2Cisub.2Cimul.20for.20i128.20in.20.2E.2E.2E.html#239985156">(May 23 2021 at 23:15)</a>:</h4>
<p>cfallin created <a href="https://github.com/bytecodealliance/wasmtime/pull/2928#discussion_r637613573">PR review comment</a>:</p>
<blockquote>
<p>I think we could get away with not using a <code>tmp</code> here, no? We could <code>umulh</code> directly into <code>dst_hi</code> and then use <code>madd</code> to add the other terms; that's slightly better from an allocate-fewer-vregs (compiler performance) perspective.</p>
</blockquote>



<a name="240051406"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232928%20Implement%20iadd%2Cisub%2Cimul%20for%20i128%20in%20.../near/240051406" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232928.20Implement.20iadd.2Cisub.2Cimul.20for.20i128.20in.20.2E.2E.2E.html#240051406">(May 24 2021 at 13:33)</a>:</h4>
<p>akirilov-arm created <a href="https://github.com/bytecodealliance/wasmtime/pull/2928#discussion_r637947635">PR review comment</a>:</p>
<blockquote>
<p>This should be the second instruction in the sequence, since it can execute in parallel with <code>UMULH</code>.</p>
</blockquote>



<a name="240051407"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232928%20Implement%20iadd%2Cisub%2Cimul%20for%20i128%20in%20.../near/240051407" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232928.20Implement.20iadd.2Cisub.2Cimul.20for.20i128.20in.20.2E.2E.2E.html#240051407">(May 24 2021 at 13:33)</a>:</h4>
<p>akirilov-arm submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/2928#pullrequestreview-666740109">PR review</a>.</p>



<a name="240067937"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232928%20Implement%20iadd%2Cisub%2Cimul%20for%20i128%20in%20.../near/240067937" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232928.20Implement.20iadd.2Cisub.2Cimul.20for.20i128.20in.20.2E.2E.2E.html#240067937">(May 24 2021 at 15:34)</a>:</h4>
<p>afonso360 submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/2928#pullrequestreview-666883749">PR review</a>.</p>



<a name="240067938"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232928%20Implement%20iadd%2Cisub%2Cimul%20for%20i128%20in%20.../near/240067938" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232928.20Implement.20iadd.2Cisub.2Cimul.20for.20i128.20in.20.2E.2E.2E.html#240067938">(May 24 2021 at 15:34)</a>:</h4>
<p>afonso360 created <a href="https://github.com/bytecodealliance/wasmtime/pull/2928#discussion_r638056577">PR review comment</a>:</p>
<blockquote>
<p>Yeah, I think I prefer including this in the PR for the iconst.</p>
<p>I think changing it here involves changing a bit more than just the emission for Iconst.  <a href="https://github.com/bytecodealliance/wasmtime/blob/76c6b83f6a21a12a11d4f890490f8acb6329a600/cranelift/codegen/src/machinst/lower.rs#L110"><code>get_constant</code></a> only returns a u64 and <a href="https://github.com/bytecodealliance/wasmtime/blob/76c6b83f6a21a12a11d4f890490f8acb6329a600/cranelift/codegen/src/data_value.rs#L15"><code>get_immediate</code></a> doesn't support 128bit values yet.</p>
</blockquote>



<a name="240072929"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232928%20Implement%20iadd%2Cisub%2Cimul%20for%20i128%20in%20.../near/240072929" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232928.20Implement.20iadd.2Cisub.2Cimul.20for.20i128.20in.20.2E.2E.2E.html#240072929">(May 24 2021 at 16:10)</a>:</h4>
<p>cfallin submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/2928#pullrequestreview-666932379">PR review</a>.</p>



<a name="240072930"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232928%20Implement%20iadd%2Cisub%2Cimul%20for%20i128%20in%20.../near/240072930" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232928.20Implement.20iadd.2Cisub.2Cimul.20for.20i128.20in.20.2E.2E.2E.html#240072930">(May 24 2021 at 16:10)</a>:</h4>
<p>cfallin created <a href="https://github.com/bytecodealliance/wasmtime/pull/2928#discussion_r638083353">PR review comment</a>:</p>
<blockquote>
<p>Ah, yes, you're right, we need more infrastructure for that; sorry! Happy to have this whole test deferred then.</p>
</blockquote>



<a name="240082989"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232928%20Implement%20iadd%2Cisub%2Cimul%20for%20i128%20in%20.../near/240082989" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232928.20Implement.20iadd.2Cisub.2Cimul.20for.20i128.20in.20.2E.2E.2E.html#240082989">(May 24 2021 at 17:25)</a>:</h4>
<p>afonso360 updated <a href="https://github.com/bytecodealliance/wasmtime/pull/2928">PR #2928</a> from <code>aarch64-i128-ops</code> to <code>main</code>.</p>



<a name="240083212"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232928%20Implement%20iadd%2Cisub%2Cimul%20for%20i128%20in%20.../near/240083212" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232928.20Implement.20iadd.2Cisub.2Cimul.20for.20i128.20in.20.2E.2E.2E.html#240083212">(May 24 2021 at 17:27)</a>:</h4>
<p>afonso360 created <a href="https://github.com/bytecodealliance/wasmtime/pull/2928#discussion_r638139782">PR review comment</a>:</p>
<blockquote>
<p>I added a few more tests to all three functions, but if you have any particular test case in mind, let me know.</p>
</blockquote>



<a name="240083213"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232928%20Implement%20iadd%2Cisub%2Cimul%20for%20i128%20in%20.../near/240083213" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232928.20Implement.20iadd.2Cisub.2Cimul.20for.20i128.20in.20.2E.2E.2E.html#240083213">(May 24 2021 at 17:27)</a>:</h4>
<p>afonso360 submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/2928#pullrequestreview-666996382">PR review</a>.</p>



<a name="240084331"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232928%20Implement%20iadd%2Cisub%2Cimul%20for%20i128%20in%20.../near/240084331" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232928.20Implement.20iadd.2Cisub.2Cimul.20for.20i128.20in.20.2E.2E.2E.html#240084331">(May 24 2021 at 17:36)</a>:</h4>
<p>afonso360 submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/2928#pullrequestreview-667002717">PR review</a>.</p>



<a name="240084335"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232928%20Implement%20iadd%2Cisub%2Cimul%20for%20i128%20in%20.../near/240084335" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232928.20Implement.20iadd.2Cisub.2Cimul.20for.20i128.20in.20.2E.2E.2E.html#240084335">(May 24 2021 at 17:36)</a>:</h4>
<p>afonso360 created <a href="https://github.com/bytecodealliance/wasmtime/pull/2928#discussion_r638144769">PR review comment</a>:</p>
<blockquote>
<p>It looks like when we do this, we do get a few extra mov's in the emitted code.</p>
<p>When placing the <code>mul</code> as the first or second instruction in the sequence we get the following code:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="n">umulh</span><span class="w"> </span><span class="n">x5</span><span class="p">,</span><span class="w"> </span><span class="n">x0</span><span class="p">,</span><span class="w"> </span><span class="n">x2</span><span class="w"></span>
<span class="n">madd</span><span class="w"> </span><span class="n">x4</span><span class="p">,</span><span class="w"> </span><span class="n">x0</span><span class="p">,</span><span class="w"> </span><span class="n">x2</span><span class="p">,</span><span class="w"> </span><span class="n">xzr</span><span class="w"></span>
<span class="n">madd</span><span class="w"> </span><span class="n">x0</span><span class="p">,</span><span class="w"> </span><span class="n">x0</span><span class="p">,</span><span class="w"> </span><span class="n">x3</span><span class="p">,</span><span class="w"> </span><span class="n">x5</span><span class="w"></span>
<span class="n">madd</span><span class="w"> </span><span class="n">x0</span><span class="p">,</span><span class="w"> </span><span class="n">x1</span><span class="p">,</span><span class="w"> </span><span class="n">x2</span><span class="p">,</span><span class="w"> </span><span class="n">x0</span><span class="w"></span>
<span class="n">mov</span><span class="w"> </span><span class="n">x1</span><span class="p">,</span><span class="w"> </span><span class="n">x0</span><span class="w"></span>
<span class="n">mov</span><span class="w"> </span><span class="n">x0</span><span class="p">,</span><span class="w"> </span><span class="n">x4</span><span class="w"></span>
</code></pre></div>
<p>Which makes sense, since we need x0 (lhs_lo) for the 2nd <code>madd</code>. I don't know if this is preferred to the 4 instruction codegen? It may be faster, but is longer?</p>
<p>Adding it after the second <code>madd</code> (as the third instruction in the sequence) gets us back to a 4 instruction result. But I'm not sure if <code>madd</code> executes in parallel with <code>mul</code>, I had a quick look at the Software Optimization guide for a few different cores and it doesn't look like it.</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="n">umulh</span><span class="w"> </span><span class="n">x4</span><span class="p">,</span><span class="w"> </span><span class="n">x0</span><span class="p">,</span><span class="w"> </span><span class="n">x2</span><span class="w"></span>
<span class="n">madd</span><span class="w"> </span><span class="n">x3</span><span class="p">,</span><span class="w"> </span><span class="n">x0</span><span class="p">,</span><span class="w"> </span><span class="n">x3</span><span class="p">,</span><span class="w"> </span><span class="n">x4</span><span class="w"></span>
<span class="n">madd</span><span class="w"> </span><span class="n">x0</span><span class="p">,</span><span class="w"> </span><span class="n">x0</span><span class="p">,</span><span class="w"> </span><span class="n">x2</span><span class="p">,</span><span class="w"> </span><span class="n">xzr</span><span class="w"></span>
<span class="n">madd</span><span class="w"> </span><span class="n">x1</span><span class="p">,</span><span class="w"> </span><span class="n">x1</span><span class="p">,</span><span class="w"> </span><span class="n">x2</span><span class="p">,</span><span class="w"> </span><span class="n">x3</span><span class="w"></span>
</code></pre></div>
<p>Let me know which one you prefer</p>
</blockquote>



<a name="240084478"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232928%20Implement%20iadd%2Cisub%2Cimul%20for%20i128%20in%20.../near/240084478" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232928.20Implement.20iadd.2Cisub.2Cimul.20for.20i128.20in.20.2E.2E.2E.html#240084478">(May 24 2021 at 17:37)</a>:</h4>
<p>afonso360 edited <a href="https://github.com/bytecodealliance/wasmtime/pull/2928#discussion_r638144769">PR review comment</a>.</p>



<a name="240084991"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232928%20Implement%20iadd%2Cisub%2Cimul%20for%20i128%20in%20.../near/240084991" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232928.20Implement.20iadd.2Cisub.2Cimul.20for.20i128.20in.20.2E.2E.2E.html#240084991">(May 24 2021 at 17:40)</a>:</h4>
<p><strong>afonso360</strong> requested <a href="https://github.com/cfallin">cfallin</a> for a review on <a href="https://github.com/bytecodealliance/wasmtime/pull/2928">PR #2928</a>.</p>



<a name="240086317"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232928%20Implement%20iadd%2Cisub%2Cimul%20for%20i128%20in%20.../near/240086317" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232928.20Implement.20iadd.2Cisub.2Cimul.20for.20i128.20in.20.2E.2E.2E.html#240086317">(May 24 2021 at 17:50)</a>:</h4>
<p>cfallin submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/2928#pullrequestreview-667013619">PR review</a>.</p>



<a name="240086318"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232928%20Implement%20iadd%2Cisub%2Cimul%20for%20i128%20in%20.../near/240086318" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232928.20Implement.20iadd.2Cisub.2Cimul.20for.20i128.20in.20.2E.2E.2E.html#240086318">(May 24 2021 at 17:50)</a>:</h4>
<p>cfallin created <a href="https://github.com/bytecodealliance/wasmtime/pull/2928#discussion_r638153468">PR review comment</a>:</p>
<blockquote>
<p>the <code>C0FFEE</code> -&gt; <code>DECAF</code> test vector is excellent; thanks :-)</p>
</blockquote>



<a name="240086746"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232928%20Implement%20iadd%2Cisub%2Cimul%20for%20i128%20in%20.../near/240086746" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232928.20Implement.20iadd.2Cisub.2Cimul.20for.20i128.20in.20.2E.2E.2E.html#240086746">(May 24 2021 at 17:54)</a>:</h4>
<p>cfallin submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/2928#pullrequestreview-667016081">PR review</a>.</p>



<a name="240086749"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232928%20Implement%20iadd%2Cisub%2Cimul%20for%20i128%20in%20.../near/240086749" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232928.20Implement.20iadd.2Cisub.2Cimul.20for.20i128.20in.20.2E.2E.2E.html#240086749">(May 24 2021 at 17:54)</a>:</h4>
<p>cfallin created <a href="https://github.com/bytecodealliance/wasmtime/pull/2928#discussion_r638155478">PR review comment</a>:</p>
<blockquote>
<p>IMHO we should prefer code that keeps the regalloc happy and reduces moves (those can have a measurable impact as code-fetch bandwidth can be a limiting factor in some cases) to small reorderings, at least on modern out-of-order cores that can reason about dependencies and issue the <code>mul</code> as soon as possible. I'll defer to @akirilov-arm as to whether it makes sense to try harder here for older in-order microarchitectures though!</p>
</blockquote>



<a name="240086966"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232928%20Implement%20iadd%2Cisub%2Cimul%20for%20i128%20in%20.../near/240086966" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232928.20Implement.20iadd.2Cisub.2Cimul.20for.20i128.20in.20.2E.2E.2E.html#240086966">(May 24 2021 at 17:55)</a>:</h4>
<p>cfallin submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/2928#pullrequestreview-667017384">PR review</a>.</p>



<a name="240088308"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232928%20Implement%20iadd%2Cisub%2Cimul%20for%20i128%20in%20.../near/240088308" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232928.20Implement.20iadd.2Cisub.2Cimul.20for.20i128.20in.20.2E.2E.2E.html#240088308">(May 24 2021 at 18:05)</a>:</h4>
<p>akirilov-arm submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/2928#pullrequestreview-667024333">PR review</a>.</p>



<a name="240088310"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232928%20Implement%20iadd%2Cisub%2Cimul%20for%20i128%20in%20.../near/240088310" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232928.20Implement.20iadd.2Cisub.2Cimul.20for.20i128.20in.20.2E.2E.2E.html#240088310">(May 24 2021 at 18:05)</a>:</h4>
<p>akirilov-arm created <a href="https://github.com/bytecodealliance/wasmtime/pull/2928#discussion_r638161665">PR review comment</a>:</p>
<blockquote>
<p>Are you testing with a simple function that just does the multiplication and returns the product? If yes, I wouldn't be too bothered by the additional moves because that's an overly simplified test case (and yes, the longer version might still be faster on an in-order core like the Cortex-A55 that I have in mind with my comments), but you can also try another experiment - reverse the order of the last 2 instructions and see what you get.</p>
</blockquote>



<a name="240090104"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232928%20Implement%20iadd%2Cisub%2Cimul%20for%20i128%20in%20.../near/240090104" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232928.20Implement.20iadd.2Cisub.2Cimul.20for.20i128.20in.20.2E.2E.2E.html#240090104">(May 24 2021 at 18:19)</a>:</h4>
<p>afonso360 submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/2928#pullrequestreview-667033712">PR review</a>.</p>



<a name="240090105"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232928%20Implement%20iadd%2Cisub%2Cimul%20for%20i128%20in%20.../near/240090105" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232928.20Implement.20iadd.2Cisub.2Cimul.20for.20i128.20in.20.2E.2E.2E.html#240090105">(May 24 2021 at 18:19)</a>:</h4>
<p>afonso360 created <a href="https://github.com/bytecodealliance/wasmtime/pull/2928#discussion_r638168574">PR review comment</a>:</p>
<blockquote>
<p>Yeah, these are all for the function that is in tests:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="n">function</span><span class="w"> </span><span class="o">%</span><span class="n">mul_i128</span><span class="p">(</span><span class="kt">i128</span><span class="p">,</span><span class="w"> </span><span class="kt">i128</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="kt">i128</span> <span class="p">{</span><span class="w"></span>
<span class="n">block0</span><span class="p">(</span><span class="n">v0</span>: <span class="kt">i128</span><span class="p">,</span><span class="w"> </span><span class="n">v1</span>: <span class="kt">i128</span><span class="p">)</span>:
    <span class="nc">v2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">imul</span><span class="w"> </span><span class="n">v0</span><span class="p">,</span><span class="w"> </span><span class="n">v1</span><span class="w"></span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">v2</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>
<blockquote>
<p>but you can also try another experiment - reverse the order of the last 2 instructions and see what you get.</p>
</blockquote>
<p>Do you mean the last <code>mul</code> and <code>madd</code>? </p>
<p>For the version with <code>mul</code> as the last instruction we get:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="n">umulh</span><span class="w"> </span><span class="n">x4</span><span class="p">,</span><span class="w"> </span><span class="n">x0</span><span class="p">,</span><span class="w"> </span><span class="n">x2</span><span class="w"></span>
<span class="n">madd</span><span class="w"> </span><span class="n">x3</span><span class="p">,</span><span class="w"> </span><span class="n">x0</span><span class="p">,</span><span class="w"> </span><span class="n">x3</span><span class="p">,</span><span class="w"> </span><span class="n">x4</span><span class="w"></span>
<span class="n">madd</span><span class="w"> </span><span class="n">x1</span><span class="p">,</span><span class="w"> </span><span class="n">x1</span><span class="p">,</span><span class="w"> </span><span class="n">x2</span><span class="p">,</span><span class="w"> </span><span class="n">x3</span><span class="w"></span>
<span class="n">madd</span><span class="w"> </span><span class="n">x0</span><span class="p">,</span><span class="w"> </span><span class="n">x0</span><span class="p">,</span><span class="w"> </span><span class="n">x2</span><span class="p">,</span><span class="w"> </span><span class="n">xzr</span><span class="w"></span>
</code></pre></div>
<p>For the version with the last <code>madd</code> as the last instruction, we get this:</p>
<p><div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="n">umulh</span><span class="w"> </span><span class="n">x4</span><span class="p">,</span><span class="w"> </span><span class="n">x0</span><span class="p">,</span><span class="w"> </span><span class="n">x2</span><span class="w"></span>
<span class="n">madd</span><span class="w"> </span><span class="n">x3</span><span class="p">,</span><span class="w"> </span><span class="n">x0</span><span class="p">,</span><span class="w"> </span><span class="n">x3</span><span class="p">,</span><span class="w"> </span><span class="n">x4</span><span class="w"></span>
<span class="n">madd</span><span class="w"> </span><span class="n">x0</span><span class="p">,</span><span class="w"> </span><span class="n">x0</span><span class="p">,</span><span class="w"> </span><span class="n">x2</span><span class="p">,</span><span class="w"> </span><span class="n">xzr</span><span class="w"></span>
<span class="n">madd</span><span class="w"> </span><span class="n">x1</span><span class="p">,</span><span class="w"> </span><span class="n">x1</span><span class="p">,</span><span class="w"> </span><span class="n">x2</span><span class="p">,</span><span class="w"> </span><span class="n">x3</span><span class="w"></span>
</code></pre></div><br>
</p>
</blockquote>



<a name="240090695"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232928%20Implement%20iadd%2Cisub%2Cimul%20for%20i128%20in%20.../near/240090695" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232928.20Implement.20iadd.2Cisub.2Cimul.20for.20i128.20in.20.2E.2E.2E.html#240090695">(May 24 2021 at 18:23)</a>:</h4>
<p>akirilov-arm edited <a href="https://github.com/bytecodealliance/wasmtime/pull/2928#discussion_r638161665">PR review comment</a>.</p>



<a name="240091744"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232928%20Implement%20iadd%2Cisub%2Cimul%20for%20i128%20in%20.../near/240091744" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232928.20Implement.20iadd.2Cisub.2Cimul.20for.20i128.20in.20.2E.2E.2E.html#240091744">(May 24 2021 at 18:31)</a>:</h4>
<p>afonso360 edited <a href="https://github.com/bytecodealliance/wasmtime/pull/2928#discussion_r638168574">PR review comment</a>.</p>



<a name="240098275"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232928%20Implement%20iadd%2Cisub%2Cimul%20for%20i128%20in%20.../near/240098275" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232928.20Implement.20iadd.2Cisub.2Cimul.20for.20i128.20in.20.2E.2E.2E.html#240098275">(May 24 2021 at 19:17)</a>:</h4>
<p>akirilov-arm submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/2928#pullrequestreview-667093268">PR review</a>.</p>



<a name="240098276"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232928%20Implement%20iadd%2Cisub%2Cimul%20for%20i128%20in%20.../near/240098276" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232928.20Implement.20iadd.2Cisub.2Cimul.20for.20i128.20in.20.2E.2E.2E.html#240098276">(May 24 2021 at 19:17)</a>:</h4>
<p>akirilov-arm submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/2928#pullrequestreview-667093268">PR review</a>.</p>



<a name="240098277"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232928%20Implement%20iadd%2Cisub%2Cimul%20for%20i128%20in%20.../near/240098277" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232928.20Implement.20iadd.2Cisub.2Cimul.20for.20i128.20in.20.2E.2E.2E.html#240098277">(May 24 2021 at 19:17)</a>:</h4>
<p>akirilov-arm created <a href="https://github.com/bytecodealliance/wasmtime/pull/2928#discussion_r638212330">PR review comment</a>:</p>
<blockquote>
<p>Yes, I meant precisely your last experiment and the result is disappointing (the first move is unnecessary at the very least). Anyway, let's go with the current version, i.e. <code>MUL</code> in the last position (which still makes it possible to use the dedicated forwarding path between the pair of <code>MADD</code>s and to dual-issue), and I (or someone else) can check later what the real performance impact is and if there is some way to avoid the moves.</p>
</blockquote>



<a name="240107179"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232928%20Implement%20iadd%2Cisub%2Cimul%20for%20i128%20in%20.../near/240107179" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232928.20Implement.20iadd.2Cisub.2Cimul.20for.20i128.20in.20.2E.2E.2E.html#240107179">(May 24 2021 at 20:27)</a>:</h4>
<p>cfallin merged <a href="https://github.com/bytecodealliance/wasmtime/pull/2928">PR #2928</a>.</p>



<a name="240213521"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232928%20Implement%20iadd%2Cisub%2Cimul%20for%20i128%20in%20.../near/240213521" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232928.20Implement.20iadd.2Cisub.2Cimul.20for.20i128.20in.20.2E.2E.2E.html#240213521">(May 25 2021 at 16:23)</a>:</h4>
<p>akirilov-arm submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/2928#pullrequestreview-668053521">PR review</a>.</p>



<a name="240213522"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232928%20Implement%20iadd%2Cisub%2Cimul%20for%20i128%20in%20.../near/240213522" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232928.20Implement.20iadd.2Cisub.2Cimul.20for.20i128.20in.20.2E.2E.2E.html#240213522">(May 25 2021 at 16:23)</a>:</h4>
<p>akirilov-arm created <a href="https://github.com/bytecodealliance/wasmtime/pull/2928#discussion_r638962235">PR review comment</a>:</p>
<blockquote>
<p>@cfallin Just a quick note - now that the announcement is <a href="https://community.arm.com/developer/ip-products/processors/b/processors-ip-blog/posts/first-armv9-cpu-cores">public</a>, I can actually say that not only current generation, but also some of the next generation cores (i.e. Cortex-A510) are also going to be in-order.</p>
</blockquote>



<hr><p>Last updated: Jan 20 2025 at 06:04 UTC</p>
</html>