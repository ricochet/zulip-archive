<html>
<head><meta charset="utf-8"><title>wasmtime / issue #8857 Problems with leveraging `cargo co... · git-wasmtime · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/index.html">git-wasmtime</a></h2>
<h3>Topic: <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.238857.20Problems.20with.20leveraging.20.60cargo.20co.2E.2E.2E.html">wasmtime / issue #8857 Problems with leveraging `cargo co...</a></h3>

<hr>

<base href="https://bytecodealliance.zulipchat.com">

<head><link href="https://bytecodealliance.github.io/zulip-archive/style.css" rel="stylesheet"></head>

<a name="446016502"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%238857%20Problems%20with%20leveraging%20%60cargo%20co.../near/446016502" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.238857.20Problems.20with.20leveraging.20.60cargo.20co.2E.2E.2E.html#446016502">(Jun 21 2024 at 06:46)</a>:</h4>
<p>Froidoh opened <a href="https://github.com/bytecodealliance/wasmtime/issues/8857">issue #8857</a>:</p>
<blockquote>
<p>Okay, so I am a total noob with <code>wasm(time)</code> and my mistake is totally a layer 8 problem. But after digging I couldn't find the solution, so here I am, opening an issue (sorry for that!)</p>
<p>What I want:</p>
<p>I want to leverage <code>cargo component</code> and <code>wasmtime</code> to create a simple plugin system experiment.</p>
<p>So I created a new (binary) webassembly component via: <code>cargo component new test-plugin</code>.</p>
<div class="codehilite" data-code-language="TOML"><pre><span></span><code><span class="k">[package]</span>
<span class="n">name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"test-plugin"</span>
<span class="n">version</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"0.1.0"</span>
<span class="n">edition</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"2021"</span>

<span class="k">[dependencies]</span>
<span class="n">wit-bindgen-rt</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">version</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="s2">"0.26.0"</span><span class="p">,</span><span class="w"> </span><span class="n">features</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="p">[</span><span class="s2">"bitflags"</span><span class="p">]</span><span class="w"> </span><span class="p">}</span>

<span class="k">[profile.release]</span>
<span class="n">codegen-units</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span>
<span class="n">opt-level</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"s"</span>
<span class="n">debug</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">false</span>
<span class="n">strip</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">true</span>
<span class="n">lto</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">true</span>

<span class="c1"># [package.metadata.component]</span>
<span class="c1"># package = "component:test-plugin"</span>

<span class="k">[package.metadata.component.target]</span>
<span class="n">path</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"wit"</span>
<span class="n">world</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"test-plugin"</span>

<span class="k">[package.metadata.component.dependencies]</span>
</code></pre></div>
<div class="codehilite" data-code-language="wit"><pre><span></span><code>package justatest:testplugin@0.1.0;

interface greetings {
  hello: func(s: string) -&gt; string;
}

world test-plugin {
  export greetings;
}
</code></pre></div>
<p>And my <code>src/main.rs</code></p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="cp">#[allow(warnings)]</span>
<span class="k">mod</span><span class="w"> </span><span class="nn">bindings</span><span class="p">;</span>

<span class="k">use</span><span class="w"> </span><span class="n">bindings</span><span class="p">::</span><span class="n">exports</span><span class="p">::</span><span class="n">justatest</span><span class="p">::</span><span class="n">testplugin</span><span class="p">::</span><span class="n">greetings</span><span class="p">::</span><span class="n">Guest</span><span class="p">;</span>

<span class="k">struct</span><span class="w"> </span><span class="nc">Component</span><span class="p">;</span>

<span class="k">impl</span><span class="w"> </span><span class="n">Guest</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">Component</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">fn</span><span class="w"> </span><span class="nf">hello</span><span class="p">(</span><span class="n">s</span><span class="p">:</span><span class="w"> </span><span class="nb">String</span><span class="p">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w"> </span><span class="nb">String</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="fm">format!</span><span class="p">(</span><span class="s">"Hello {s}"</span><span class="p">)</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>

<span class="n">bindings</span><span class="p">::</span><span class="n">export</span><span class="o">!</span><span class="p">(</span><span class="n">Component</span><span class="w"> </span><span class="n">with_types_in</span><span class="w"> </span><span class="n">bindings</span><span class="p">);</span>

<span class="k">fn</span><span class="w"> </span><span class="nf">main</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="fm">println!</span><span class="p">(</span><span class="s">"Hello from test-plugin!"</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div>
<p>I then generated the binary via <code>cargo component build --release</code> and let it run via:</p>
<blockquote>
<p>wasmtime target/wasm32-wasi/release/test-plugin.wasm <br>
Hello from test-plugin!</p>
</blockquote>
<p>As expected. Via the <code>wasmtime</code> cli I cannot <code>--invoke</code> any functions on a <code>wasm32-wasi</code> webassembly module (at least that's what the cli tells me)...</p>
<p>So then I created a <code>simple-host</code> as a "normal", "native" rust project, compiled via <code>llvm</code>:</p>
<p>Cargo.toml:</p>
<div class="codehilite" data-code-language="TOML"><pre><span></span><code><span class="k">[package]</span>
<span class="n">name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"simple-host"</span>
<span class="n">version</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"0.1.0"</span>
<span class="n">edition</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"2021"</span>

<span class="k">[dependencies]</span>
<span class="n">anyhow</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"1.0.86"</span>
<span class="n">wasmtime</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"22.0.0"</span>
<span class="n">wasmtime-wasi</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"22.0.0"</span>
<span class="c1">#wit-component = "0.211.1"</span>
</code></pre></div>
<p><a href="http://main.rs">main.rs</a></p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="k">use</span><span class="w"> </span><span class="n">wasmtime</span><span class="p">::{</span>
<span class="w">    </span><span class="n">component</span><span class="p">::{</span><span class="n">Component</span><span class="p">,</span><span class="w"> </span><span class="n">Linker</span><span class="p">,</span><span class="w"> </span><span class="n">Val</span><span class="p">},</span>
<span class="w">    </span><span class="n">Config</span><span class="p">,</span><span class="w"> </span><span class="n">Engine</span><span class="p">,</span>
<span class="p">};</span>
<span class="k">use</span><span class="w"> </span><span class="n">wasmtime_wasi</span><span class="p">::{</span><span class="n">WasiCtxBuilder</span><span class="p">,</span><span class="w"> </span><span class="n">WasiView</span><span class="p">};</span>

<span class="cm">/*</span>
<span class="cm">fn convert_to_component(path: impl AsRef&lt;Path&gt;) -&gt; wasmtime::Result&lt;Vec&lt;u8&gt;&gt; {</span>

<span class="cm">    let bytes = &amp;std::fs::read(&amp;path).context("failed to read input file")?;</span>
<span class="cm">    wit_component::ComponentEncoder::default()</span>
<span class="cm">        .module(&amp;bytes)?</span>
<span class="cm">        .encode()</span>
<span class="cm">}</span>
<span class="cm">*/</span>

<span class="k">struct</span><span class="w"> </span><span class="nc">Host</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">ctx</span><span class="p">:</span><span class="w"> </span><span class="nc">wasmtime_wasi</span><span class="p">::</span><span class="n">WasiCtx</span><span class="p">,</span>
<span class="w">    </span><span class="n">table</span><span class="p">:</span><span class="w"> </span><span class="nc">wasmtime_wasi</span><span class="p">::</span><span class="n">ResourceTable</span><span class="p">,</span>
<span class="p">}</span>

<span class="k">impl</span><span class="w"> </span><span class="n">WasiView</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">Host</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">fn</span><span class="w"> </span><span class="nf">table</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="bp">self</span><span class="p">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w"> </span><span class="kp">&amp;</span><span class="nc">mut</span><span class="w"> </span><span class="n">wasmtime_wasi</span><span class="p">::</span><span class="n">ResourceTable</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="bp">self</span><span class="p">.</span><span class="n">table</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="k">fn</span><span class="w"> </span><span class="nf">ctx</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="bp">self</span><span class="p">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w"> </span><span class="kp">&amp;</span><span class="nc">mut</span><span class="w"> </span><span class="n">wasmtime_wasi</span><span class="p">::</span><span class="n">WasiCtx</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="bp">self</span><span class="p">.</span><span class="n">ctx</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>

<span class="k">fn</span><span class="w"> </span><span class="nf">main</span><span class="p">()</span><span class="w"> </span><span class="p">-&gt;</span><span class="w"> </span><span class="nc">wasmtime</span><span class="p">::</span><span class="nb">Result</span><span class="o">&lt;</span><span class="p">()</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">config</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Config</span><span class="p">::</span><span class="n">new</span><span class="p">();</span>
<span class="w">    </span><span class="n">config</span><span class="p">.</span><span class="n">wasm_component_model</span><span class="p">(</span><span class="kc">true</span><span class="p">);</span>
<span class="w">    </span><span class="c1">//config.async_support(true);</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">engine</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Engine</span><span class="p">::</span><span class="n">new</span><span class="p">(</span><span class="o">&amp;</span><span class="n">config</span><span class="p">)</span><span class="o">?</span><span class="p">;</span>
<span class="w">    </span><span class="c1">// Load the component from disk</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">component</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">std</span><span class="p">::</span><span class="n">fs</span><span class="p">::</span><span class="n">read</span><span class="p">(</span><span class="s">"../test-plugin/target/wasm32-wasi/release/test-plugin.wasm"</span><span class="p">)</span><span class="o">?</span><span class="p">;</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">component</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Component</span><span class="p">::</span><span class="n">from_binary</span><span class="p">(</span><span class="o">&amp;</span><span class="n">engine</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">component</span><span class="p">)</span><span class="o">?</span><span class="p">;</span>
<span class="w">    </span><span class="c1">//println!("bytes: {bytes:?}");</span>

<span class="w">    </span><span class="c1">// As `cargo component` by default builds as `wasm32-wasi` webassembly module, we need to also include `wasmtime-wasi` and provide certain native functionality (in my own words)</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">wasi</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">WasiCtxBuilder</span><span class="p">::</span><span class="n">new</span><span class="p">();</span>
<span class="w">    </span><span class="n">wasi</span><span class="p">.</span><span class="n">arg</span><span class="p">(</span><span class="s">"--help"</span><span class="p">);</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">host</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Host</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">ctx</span><span class="p">:</span><span class="w"> </span><span class="nc">wasi</span><span class="p">.</span><span class="n">build</span><span class="p">(),</span>
<span class="w">        </span><span class="n">table</span><span class="p">:</span><span class="w"> </span><span class="nc">wasmtime_wasi</span><span class="p">::</span><span class="n">ResourceTable</span><span class="p">::</span><span class="n">new</span><span class="p">(),</span>
<span class="w">    </span><span class="p">};</span>

<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">store</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">wasmtime</span><span class="p">::</span><span class="n">Store</span><span class="p">::</span><span class="n">new</span><span class="p">(</span><span class="o">&amp;</span><span class="n">engine</span><span class="p">,</span><span class="w"> </span><span class="n">host</span><span class="p">);</span>
<span class="w">    </span><span class="c1">// Configure the linker</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">linker</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Linker</span><span class="p">::</span><span class="n">new</span><span class="p">(</span><span class="o">&amp;</span><span class="n">engine</span><span class="p">);</span>
<span class="w">    </span><span class="n">wasmtime_wasi</span><span class="p">::</span><span class="n">add_to_linker_sync</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="n">linker</span><span class="p">)</span><span class="o">?</span><span class="p">;</span>
<span class="w">    </span><span class="c1">// The component expects one import `name` that</span>
<span class="w">    </span><span class="c1">// takes no params and returns a string</span>

<span class="w">    </span><span class="n">linker</span>
<span class="w">            </span><span class="p">.</span><span class="n">root</span><span class="p">()</span>
<span class="w">            </span><span class="c1">//.func_wrap("name", |_store, _params: ()| Ok((String::from("Alice"),)))?</span>
<span class="w">        </span><span class="p">;</span>

<span class="w">    </span><span class="fm">println!</span><span class="p">(</span><span class="s">"have linker"</span><span class="p">);</span>
<span class="w">    </span><span class="c1">// Instantiate the component</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">instance</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">linker</span><span class="p">.</span><span class="n">instantiate</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="n">store</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">component</span><span class="p">)</span><span class="o">?</span><span class="p">;</span>
<span class="w">    </span><span class="c1">// TODO: find out whethere there is a way to programmatically "explore" an instance,</span>
<span class="w">    </span><span class="c1">// to see it's "API" so to speak.</span>
<span class="w">    </span><span class="c1">// Could be useful for generating some docs or whatnot</span>
<span class="w">    </span><span class="cm">/*</span>
<span class="cm">    let mut exports = instance.exports(&amp;mut store);</span>
<span class="cm">    let root = exports.instance("greetings").expect("greetings to exist");</span>
<span class="cm">    let modules = root.modules();</span>
<span class="cm">    for (name, module) in modules {</span>
<span class="cm">        println!("module: {module:?}")</span>
<span class="cm">    }</span>
<span class="cm">    println!("no modules?!");</span>
<span class="cm">    */</span>

<span class="w">    </span><span class="fm">println!</span><span class="p">(</span><span class="s">"have instance"</span><span class="p">);</span>

<span class="w">    </span><span class="cm">/*</span>
<span class="cm">    // TODO: I definitely misunderstood modules, because "greetings" does not exist</span>
<span class="cm">    let module = instance</span>
<span class="cm">        .get_module(&amp;mut store, "greetings")</span>
<span class="cm">        .expect("module not found");</span>
<span class="cm">    */</span>

<span class="w">    </span><span class="c1">// Call the `greet` function</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">func</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">instance</span>
<span class="w">        </span><span class="p">.</span><span class="n">get_func</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="n">store</span><span class="p">,</span><span class="w"> </span><span class="s">"hello"</span><span class="p">)</span>
<span class="w">        </span><span class="p">.</span><span class="n">expect</span><span class="p">(</span><span class="s">"hello export not found"</span><span class="p">);</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">result</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span><span class="n">wasmtime</span><span class="p">::</span><span class="n">component</span><span class="p">::</span><span class="n">Val</span><span class="p">::</span><span class="nb">String</span><span class="p">(</span><span class="s">""</span><span class="p">.</span><span class="n">into</span><span class="p">())];</span>
<span class="w">    </span><span class="n">func</span><span class="p">.</span><span class="n">call</span><span class="p">(</span>
<span class="w">        </span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="n">store</span><span class="p">,</span>
<span class="w">        </span><span class="o">&amp;</span><span class="p">[</span><span class="n">Val</span><span class="p">::</span><span class="nb">String</span><span class="p">(</span><span class="s">"freund nachtigall"</span><span class="p">.</span><span class="n">to_string</span><span class="p">())],</span>
<span class="w">        </span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="n">result</span><span class="p">,</span>
<span class="w">    </span><span class="p">)</span><span class="o">?</span><span class="p">;</span>

<span class="w">    </span><span class="fm">println!</span><span class="p">(</span><span class="s">"Greeting: {:?}"</span><span class="p">,</span><span class="w"> </span><span class="n">result</span><span class="p">);</span>

<span class="w">    </span><span class="nb">Ok</span><span class="p">(())</span>
<span class="p">}</span>
</code></pre></div>
<p>When I run this I get a <code>panic</code> for <code>hello export not found</code>.</p>
<p>What am I doing wrong?</p>
<p>On the other hand, if I create a library component via <code>cargo component new test-plugin-lib --lib</code> which creates a default wit file and impl for it:</p>
<div class="codehilite" data-code-language="wit"><pre><span></span><code>package component:test-plugin-lib;

/// An example world for the component to target.
world example {
    export hello-world: func() -&gt; string;
}
</code></pre></div>
<p>and then load this and call it like so:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">func</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">instance</span>
<span class="w">        </span><span class="p">.</span><span class="n">get_func</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="n">store</span><span class="p">,</span><span class="w"> </span><span class="s">"hello-world"</span><span class="p">)</span>
<span class="w">        </span><span class="p">.</span><span class="n">expect</span><span class="p">(</span><span class="s">"hello export not found"</span><span class="p">);</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">result</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span><span class="n">wasmtime</span><span class="p">::</span><span class="n">component</span><span class="p">::</span><span class="n">Val</span><span class="p">::</span><span class="nb">String</span><span class="p">(</span><span class="s">""</span><span class="p">.</span><span class="n">into</span><span class="p">())];</span>
<span class="w">    </span><span class="n">func</span><span class="p">.</span><span class="n">call</span><span class="p">(</span>
<span class="w">        </span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="n">store</span><span class="p">,</span>
<span class="w">        </span><span class="o">&amp;</span><span class="p">[],</span>
<span class="w">        </span><span class="c1">//&amp;[Val::String("freund nachtigall".to_string())],</span>
<span class="w">        </span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="n">result</span><span class="p">,</span>
<span class="w">    </span><span class="p">)</span><span class="o">?</span><span class="p">;</span>

<span class="w">    </span><span class="fm">println!</span><span class="p">(</span><span class="s">"Greeting: {:?}"</span><span class="p">,</span><span class="w"> </span><span class="n">result</span><span class="p">);</span>
</code></pre></div>
<p>it works like a charm.</p>
<p>So I guess my problem boils down to one or two things:</p>
<p>1) How do I get a function in a "namespace" programmatically like <code>hello</code> if the wit file looks like:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="n">package</span><span class="w"> </span><span class="n">justatest</span><span class="p">:</span><span class="nc">testplugin</span><span class="o">@</span><span class="mf">0.1.0</span><span class="p">;</span>

<span class="n">interface</span><span class="w"> </span><span class="n">greetings</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="n">hello</span><span class="p">:</span><span class="w"> </span><span class="nc">func</span><span class="p">(</span><span class="n">s</span><span class="p">:</span><span class="w"> </span><span class="nc">string</span><span class="p">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w"> </span><span class="nc">string</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">world</span><span class="w"> </span><span class="n">test</span><span class="o">-</span><span class="n">plugin</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="n">export</span><span class="w"> </span><span class="n">greetings</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div>
<p>2) Maybe it's different when it's a "<code>binary</code>" webassembly component in contrast to a lib?</p>
</blockquote>



<a name="446016722"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%238857%20Problems%20with%20leveraging%20%60cargo%20co.../near/446016722" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.238857.20Problems.20with.20leveraging.20.60cargo.20co.2E.2E.2E.html#446016722">(Jun 21 2024 at 06:48)</a>:</h4>
<p>Froidoh edited <a href="https://github.com/bytecodealliance/wasmtime/issues/8857">issue #8857</a>:</p>
<blockquote>
<p>Okay, so I am a total noob with <code>wasm(time)</code> and my mistake is totally a layer 8 problem. But after digging I couldn't find the solution, so here I am, opening an issue (sorry for that!)</p>
<p>What I want:</p>
<p>I want to leverage <code>cargo component</code> and <code>wasmtime</code> to create a simple plugin system experiment.</p>
<p>So I created a new (binary) webassembly component via: <code>cargo component new test-plugin</code>.</p>
<div class="codehilite" data-code-language="TOML"><pre><span></span><code><span class="k">[package]</span>
<span class="n">name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"test-plugin"</span>
<span class="n">version</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"0.1.0"</span>
<span class="n">edition</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"2021"</span>

<span class="k">[dependencies]</span>
<span class="n">wit-bindgen-rt</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">version</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="s2">"0.26.0"</span><span class="p">,</span><span class="w"> </span><span class="n">features</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="p">[</span><span class="s2">"bitflags"</span><span class="p">]</span><span class="w"> </span><span class="p">}</span>

<span class="k">[profile.release]</span>
<span class="n">codegen-units</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span>
<span class="n">opt-level</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"s"</span>
<span class="n">debug</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">false</span>
<span class="n">strip</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">true</span>
<span class="n">lto</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">true</span>

<span class="c1"># [package.metadata.component]</span>
<span class="c1"># package = "component:test-plugin"</span>

<span class="k">[package.metadata.component.target]</span>
<span class="n">path</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"wit"</span>
<span class="n">world</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"test-plugin"</span>

<span class="k">[package.metadata.component.dependencies]</span>
</code></pre></div>
<div class="codehilite" data-code-language="wit"><pre><span></span><code>package justatest:testplugin@0.1.0;

interface greetings {
  hello: func(s: string) -&gt; string;
}

world test-plugin {
  export greetings;
}
</code></pre></div>
<p>And my <code>src/main.rs</code></p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="cp">#[allow(warnings)]</span>
<span class="k">mod</span><span class="w"> </span><span class="nn">bindings</span><span class="p">;</span>

<span class="k">use</span><span class="w"> </span><span class="n">bindings</span><span class="p">::</span><span class="n">exports</span><span class="p">::</span><span class="n">justatest</span><span class="p">::</span><span class="n">testplugin</span><span class="p">::</span><span class="n">greetings</span><span class="p">::</span><span class="n">Guest</span><span class="p">;</span>

<span class="k">struct</span><span class="w"> </span><span class="nc">Component</span><span class="p">;</span>

<span class="k">impl</span><span class="w"> </span><span class="n">Guest</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">Component</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">fn</span><span class="w"> </span><span class="nf">hello</span><span class="p">(</span><span class="n">s</span><span class="p">:</span><span class="w"> </span><span class="nb">String</span><span class="p">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w"> </span><span class="nb">String</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="fm">format!</span><span class="p">(</span><span class="s">"Hello {s}"</span><span class="p">)</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>

<span class="n">bindings</span><span class="p">::</span><span class="n">export</span><span class="o">!</span><span class="p">(</span><span class="n">Component</span><span class="w"> </span><span class="n">with_types_in</span><span class="w"> </span><span class="n">bindings</span><span class="p">);</span>

<span class="k">fn</span><span class="w"> </span><span class="nf">main</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="fm">println!</span><span class="p">(</span><span class="s">"Hello from test-plugin!"</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div>
<p>I then generated the binary via <code>cargo component build --release</code> and let it run via:</p>
<blockquote>
<p>wasmtime target/wasm32-wasi/release/test-plugin.wasm <br>
Hello from test-plugin!</p>
</blockquote>
<p>As expected. Via the <code>wasmtime</code> cli I cannot <code>--invoke</code> any functions on a <code>wasm32-wasi</code> webassembly module (at least that's what the cli tells me)...</p>
<p>So then I created a <code>simple-host</code> as a "normal", "native" rust project, compiled via <code>llvm</code>:</p>
<p>Cargo.toml:</p>
<div class="codehilite" data-code-language="TOML"><pre><span></span><code><span class="k">[package]</span>
<span class="n">name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"simple-host"</span>
<span class="n">version</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"0.1.0"</span>
<span class="n">edition</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"2021"</span>

<span class="k">[dependencies]</span>
<span class="n">anyhow</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"1.0.86"</span>
<span class="n">wasmtime</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"22.0.0"</span>
<span class="n">wasmtime-wasi</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"22.0.0"</span>
<span class="c1">#wit-component = "0.211.1"</span>
</code></pre></div>
<p><a href="http://main.rs">main.rs</a></p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="k">use</span><span class="w"> </span><span class="n">wasmtime</span><span class="p">::{</span>
<span class="w">    </span><span class="n">component</span><span class="p">::{</span><span class="n">Component</span><span class="p">,</span><span class="w"> </span><span class="n">Linker</span><span class="p">,</span><span class="w"> </span><span class="n">Val</span><span class="p">},</span>
<span class="w">    </span><span class="n">Config</span><span class="p">,</span><span class="w"> </span><span class="n">Engine</span><span class="p">,</span>
<span class="p">};</span>
<span class="k">use</span><span class="w"> </span><span class="n">wasmtime_wasi</span><span class="p">::{</span><span class="n">WasiCtxBuilder</span><span class="p">,</span><span class="w"> </span><span class="n">WasiView</span><span class="p">};</span>

<span class="cm">/*</span>
<span class="cm">fn convert_to_component(path: impl AsRef&lt;Path&gt;) -&gt; wasmtime::Result&lt;Vec&lt;u8&gt;&gt; {</span>

<span class="cm">    let bytes = &amp;std::fs::read(&amp;path).context("failed to read input file")?;</span>
<span class="cm">    wit_component::ComponentEncoder::default()</span>
<span class="cm">        .module(&amp;bytes)?</span>
<span class="cm">        .encode()</span>
<span class="cm">}</span>
<span class="cm">*/</span>

<span class="k">struct</span><span class="w"> </span><span class="nc">Host</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">ctx</span><span class="p">:</span><span class="w"> </span><span class="nc">wasmtime_wasi</span><span class="p">::</span><span class="n">WasiCtx</span><span class="p">,</span>
<span class="w">    </span><span class="n">table</span><span class="p">:</span><span class="w"> </span><span class="nc">wasmtime_wasi</span><span class="p">::</span><span class="n">ResourceTable</span><span class="p">,</span>
<span class="p">}</span>

<span class="k">impl</span><span class="w"> </span><span class="n">WasiView</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">Host</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">fn</span><span class="w"> </span><span class="nf">table</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="bp">self</span><span class="p">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w"> </span><span class="kp">&amp;</span><span class="nc">mut</span><span class="w"> </span><span class="n">wasmtime_wasi</span><span class="p">::</span><span class="n">ResourceTable</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="bp">self</span><span class="p">.</span><span class="n">table</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="k">fn</span><span class="w"> </span><span class="nf">ctx</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="bp">self</span><span class="p">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w"> </span><span class="kp">&amp;</span><span class="nc">mut</span><span class="w"> </span><span class="n">wasmtime_wasi</span><span class="p">::</span><span class="n">WasiCtx</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="bp">self</span><span class="p">.</span><span class="n">ctx</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>

<span class="k">fn</span><span class="w"> </span><span class="nf">main</span><span class="p">()</span><span class="w"> </span><span class="p">-&gt;</span><span class="w"> </span><span class="nc">wasmtime</span><span class="p">::</span><span class="nb">Result</span><span class="o">&lt;</span><span class="p">()</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">config</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Config</span><span class="p">::</span><span class="n">new</span><span class="p">();</span>
<span class="w">    </span><span class="n">config</span><span class="p">.</span><span class="n">wasm_component_model</span><span class="p">(</span><span class="kc">true</span><span class="p">);</span>
<span class="w">    </span><span class="c1">//config.async_support(true);</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">engine</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Engine</span><span class="p">::</span><span class="n">new</span><span class="p">(</span><span class="o">&amp;</span><span class="n">config</span><span class="p">)</span><span class="o">?</span><span class="p">;</span>
<span class="w">    </span><span class="c1">// Load the component from disk</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">component</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">std</span><span class="p">::</span><span class="n">fs</span><span class="p">::</span><span class="n">read</span><span class="p">(</span><span class="s">"../test-plugin/target/wasm32-wasi/release/test-plugin.wasm"</span><span class="p">)</span><span class="o">?</span><span class="p">;</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">component</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Component</span><span class="p">::</span><span class="n">from_binary</span><span class="p">(</span><span class="o">&amp;</span><span class="n">engine</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">component</span><span class="p">)</span><span class="o">?</span><span class="p">;</span>
<span class="w">    </span><span class="c1">//println!("bytes: {bytes:?}");</span>

<span class="w">    </span><span class="c1">// As `cargo component` by default builds as `wasm32-wasi` webassembly module, we need to also include `wasmtime-wasi` and provide certain native functionality (in my own words)</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">wasi</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">WasiCtxBuilder</span><span class="p">::</span><span class="n">new</span><span class="p">();</span>
<span class="w">    </span><span class="n">wasi</span><span class="p">.</span><span class="n">arg</span><span class="p">(</span><span class="s">"--help"</span><span class="p">);</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">host</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Host</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">ctx</span><span class="p">:</span><span class="w"> </span><span class="nc">wasi</span><span class="p">.</span><span class="n">build</span><span class="p">(),</span>
<span class="w">        </span><span class="n">table</span><span class="p">:</span><span class="w"> </span><span class="nc">wasmtime_wasi</span><span class="p">::</span><span class="n">ResourceTable</span><span class="p">::</span><span class="n">new</span><span class="p">(),</span>
<span class="w">    </span><span class="p">};</span>

<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">store</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">wasmtime</span><span class="p">::</span><span class="n">Store</span><span class="p">::</span><span class="n">new</span><span class="p">(</span><span class="o">&amp;</span><span class="n">engine</span><span class="p">,</span><span class="w"> </span><span class="n">host</span><span class="p">);</span>
<span class="w">    </span><span class="c1">// Configure the linker</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">linker</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Linker</span><span class="p">::</span><span class="n">new</span><span class="p">(</span><span class="o">&amp;</span><span class="n">engine</span><span class="p">);</span>
<span class="w">    </span><span class="n">wasmtime_wasi</span><span class="p">::</span><span class="n">add_to_linker_sync</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="n">linker</span><span class="p">)</span><span class="o">?</span><span class="p">;</span>
<span class="w">    </span><span class="c1">// The component expects one import `name` that</span>
<span class="w">    </span><span class="c1">// takes no params and returns a string</span>

<span class="w">    </span><span class="n">linker</span>
<span class="w">            </span><span class="p">.</span><span class="n">root</span><span class="p">()</span>
<span class="w">            </span><span class="c1">//.func_wrap("name", |_store, _params: ()| Ok((String::from("Alice"),)))?</span>
<span class="w">        </span><span class="p">;</span>

<span class="w">    </span><span class="fm">println!</span><span class="p">(</span><span class="s">"have linker"</span><span class="p">);</span>
<span class="w">    </span><span class="c1">// Instantiate the component</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">instance</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">linker</span><span class="p">.</span><span class="n">instantiate</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="n">store</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">component</span><span class="p">)</span><span class="o">?</span><span class="p">;</span>
<span class="w">    </span><span class="c1">// TODO: find out whethere there is a way to programmatically "explore" an instance,</span>
<span class="w">    </span><span class="c1">// to see it's "API" so to speak.</span>
<span class="w">    </span><span class="c1">// Could be useful for generating some docs or whatnot</span>
<span class="w">    </span><span class="cm">/*</span>
<span class="cm">    let mut exports = instance.exports(&amp;mut store);</span>
<span class="cm">    let root = exports.instance("greetings").expect("greetings to exist");</span>
<span class="cm">    let modules = root.modules();</span>
<span class="cm">    for (name, module) in modules {</span>
<span class="cm">        println!("module: {module:?}")</span>
<span class="cm">    }</span>
<span class="cm">    println!("no modules?!");</span>
<span class="cm">    */</span>

<span class="w">    </span><span class="fm">println!</span><span class="p">(</span><span class="s">"have instance"</span><span class="p">);</span>

<span class="w">    </span><span class="cm">/*</span>
<span class="cm">    // TODO: I definitely misunderstood modules, because "greetings" does not exist</span>
<span class="cm">    let module = instance</span>
<span class="cm">        .get_module(&amp;mut store, "greetings")</span>
<span class="cm">        .expect("module not found");</span>
<span class="cm">    */</span>

<span class="w">    </span><span class="c1">// Call the `greet` function</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">func</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">instance</span>
<span class="w">        </span><span class="p">.</span><span class="n">get_func</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="n">store</span><span class="p">,</span><span class="w"> </span><span class="s">"hello"</span><span class="p">)</span>
<span class="w">        </span><span class="p">.</span><span class="n">expect</span><span class="p">(</span><span class="s">"hello export not found"</span><span class="p">);</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">result</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span><span class="n">wasmtime</span><span class="p">::</span><span class="n">component</span><span class="p">::</span><span class="n">Val</span><span class="p">::</span><span class="nb">String</span><span class="p">(</span><span class="s">""</span><span class="p">.</span><span class="n">into</span><span class="p">())];</span>
<span class="w">    </span><span class="n">func</span><span class="p">.</span><span class="n">call</span><span class="p">(</span>
<span class="w">        </span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="n">store</span><span class="p">,</span>
<span class="w">        </span><span class="o">&amp;</span><span class="p">[</span><span class="n">Val</span><span class="p">::</span><span class="nb">String</span><span class="p">(</span><span class="s">"freund nachtigall"</span><span class="p">.</span><span class="n">to_string</span><span class="p">())],</span>
<span class="w">        </span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="n">result</span><span class="p">,</span>
<span class="w">    </span><span class="p">)</span><span class="o">?</span><span class="p">;</span>

<span class="w">    </span><span class="fm">println!</span><span class="p">(</span><span class="s">"Greeting: {:?}"</span><span class="p">,</span><span class="w"> </span><span class="n">result</span><span class="p">);</span>

<span class="w">    </span><span class="nb">Ok</span><span class="p">(())</span>
<span class="p">}</span>
</code></pre></div>
<p>When I run this I get a <code>panic</code> for <code>hello export not found</code>.</p>
<p>What am I doing wrong? I also tried with: <code>greetings.hello</code> and <code>greetings:hello</code> for <code>get_func</code> but to no avail.</p>
<p>On the other hand, if I create a library component via <code>cargo component new test-plugin-lib --lib</code> which creates a default wit file and impl for it:</p>
<div class="codehilite" data-code-language="wit"><pre><span></span><code>package component:test-plugin-lib;

/// An example world for the component to target.
world example {
    export hello-world: func() -&gt; string;
}
</code></pre></div>
<p>and then load this and call it like so:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">func</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">instance</span>
<span class="w">        </span><span class="p">.</span><span class="n">get_func</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="n">store</span><span class="p">,</span><span class="w"> </span><span class="s">"hello-world"</span><span class="p">)</span>
<span class="w">        </span><span class="p">.</span><span class="n">expect</span><span class="p">(</span><span class="s">"hello export not found"</span><span class="p">);</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">result</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span><span class="n">wasmtime</span><span class="p">::</span><span class="n">component</span><span class="p">::</span><span class="n">Val</span><span class="p">::</span><span class="nb">String</span><span class="p">(</span><span class="s">""</span><span class="p">.</span><span class="n">into</span><span class="p">())];</span>
<span class="w">    </span><span class="n">func</span><span class="p">.</span><span class="n">call</span><span class="p">(</span>
<span class="w">        </span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="n">store</span><span class="p">,</span>
<span class="w">        </span><span class="o">&amp;</span><span class="p">[],</span>
<span class="w">        </span><span class="c1">//&amp;[Val::String("freund nachtigall".to_string())],</span>
<span class="w">        </span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="n">result</span><span class="p">,</span>
<span class="w">    </span><span class="p">)</span><span class="o">?</span><span class="p">;</span>

<span class="w">    </span><span class="fm">println!</span><span class="p">(</span><span class="s">"Greeting: {:?}"</span><span class="p">,</span><span class="w"> </span><span class="n">result</span><span class="p">);</span>
</code></pre></div>
<p>it works like a charm.</p>
<p>So I guess my problem boils down to one or two things:</p>
<p>1) How do I get a function in a "namespace" programmatically like <code>hello</code> if the wit file looks like:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="n">package</span><span class="w"> </span><span class="n">justatest</span><span class="p">:</span><span class="nc">testplugin</span><span class="o">@</span><span class="mf">0.1.0</span><span class="p">;</span>

<span class="n">interface</span><span class="w"> </span><span class="n">greetings</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="n">hello</span><span class="p">:</span><span class="w"> </span><span class="nc">func</span><span class="p">(</span><span class="n">s</span><span class="p">:</span><span class="w"> </span><span class="nc">string</span><span class="p">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w"> </span><span class="nc">string</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">world</span><span class="w"> </span><span class="n">test</span><span class="o">-</span><span class="n">plugin</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="n">export</span><span class="w"> </span><span class="n">greetings</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div>
<p>2) Maybe it's different when it's a "<code>binary</code>" webassembly component in contrast to a lib?</p>
</blockquote>



<a name="446017503"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%238857%20Problems%20with%20leveraging%20%60cargo%20co.../near/446017503" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.238857.20Problems.20with.20leveraging.20.60cargo.20co.2E.2E.2E.html#446017503">(Jun 21 2024 at 06:54)</a>:</h4>
<p>Froidoh edited <a href="https://github.com/bytecodealliance/wasmtime/issues/8857">issue #8857</a>:</p>
<blockquote>
<p>Okay, so I am a total noob with <code>wasm(time)</code> and my mistake is totally a layer 8 problem. But after digging I couldn't find the solution, so here I am, opening an issue (sorry for that!)</p>
<p>What I want:</p>
<p>I want to leverage <code>cargo component</code> and <code>wasmtime</code> to create a simple plugin system experiment.</p>
<p>So I created a new (binary) webassembly component via: <code>cargo component new test-plugin</code>.</p>
<div class="codehilite" data-code-language="TOML"><pre><span></span><code><span class="k">[package]</span>
<span class="n">name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"test-plugin"</span>
<span class="n">version</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"0.1.0"</span>
<span class="n">edition</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"2021"</span>

<span class="k">[dependencies]</span>
<span class="n">wit-bindgen-rt</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">version</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="s2">"0.26.0"</span><span class="p">,</span><span class="w"> </span><span class="n">features</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="p">[</span><span class="s2">"bitflags"</span><span class="p">]</span><span class="w"> </span><span class="p">}</span>

<span class="k">[profile.release]</span>
<span class="n">codegen-units</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span>
<span class="n">opt-level</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"s"</span>
<span class="n">debug</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">false</span>
<span class="n">strip</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">true</span>
<span class="n">lto</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">true</span>

<span class="c1"># [package.metadata.component]</span>
<span class="c1"># package = "component:test-plugin"</span>

<span class="k">[package.metadata.component.target]</span>
<span class="n">path</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"wit"</span>
<span class="n">world</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"test-plugin"</span>

<span class="k">[package.metadata.component.dependencies]</span>
</code></pre></div>
<div class="codehilite" data-code-language="wit"><pre><span></span><code>package justatest:testplugin@0.1.0;

interface greetings {
  hello: func(s: string) -&gt; string;
}

world test-plugin {
  export greetings;
}
</code></pre></div>
<p>And my <code>src/main.rs</code></p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="cp">#[allow(warnings)]</span>
<span class="k">mod</span><span class="w"> </span><span class="nn">bindings</span><span class="p">;</span>

<span class="k">use</span><span class="w"> </span><span class="n">bindings</span><span class="p">::</span><span class="n">exports</span><span class="p">::</span><span class="n">justatest</span><span class="p">::</span><span class="n">testplugin</span><span class="p">::</span><span class="n">greetings</span><span class="p">::</span><span class="n">Guest</span><span class="p">;</span>

<span class="k">struct</span><span class="w"> </span><span class="nc">Component</span><span class="p">;</span>

<span class="k">impl</span><span class="w"> </span><span class="n">Guest</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">Component</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">fn</span><span class="w"> </span><span class="nf">hello</span><span class="p">(</span><span class="n">s</span><span class="p">:</span><span class="w"> </span><span class="nb">String</span><span class="p">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w"> </span><span class="nb">String</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="fm">format!</span><span class="p">(</span><span class="s">"Hello {s}"</span><span class="p">)</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>

<span class="n">bindings</span><span class="p">::</span><span class="n">export</span><span class="o">!</span><span class="p">(</span><span class="n">Component</span><span class="w"> </span><span class="n">with_types_in</span><span class="w"> </span><span class="n">bindings</span><span class="p">);</span>

<span class="k">fn</span><span class="w"> </span><span class="nf">main</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="fm">println!</span><span class="p">(</span><span class="s">"Hello from test-plugin!"</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div>
<p>I then generated the binary via <code>cargo component build --release</code> and let it run via:</p>
<blockquote>
<p>wasmtime target/wasm32-wasi/release/test-plugin.wasm <br>
Hello from test-plugin!</p>
</blockquote>
<p>As expected. Via the <code>wasmtime</code> cli I cannot <code>--invoke</code> any functions on a <code>wasm32-wasi</code> webassembly module (at least that's what the cli tells me)...</p>
<p>So then I created a <code>simple-host</code> as a "normal", "native" rust project, compiled via <code>llvm</code>:</p>
<p>Cargo.toml:</p>
<div class="codehilite" data-code-language="TOML"><pre><span></span><code><span class="k">[package]</span>
<span class="n">name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"simple-host"</span>
<span class="n">version</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"0.1.0"</span>
<span class="n">edition</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"2021"</span>

<span class="k">[dependencies]</span>
<span class="n">anyhow</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"1.0.86"</span>
<span class="n">wasmtime</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"22.0.0"</span>
<span class="n">wasmtime-wasi</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"22.0.0"</span>
<span class="c1">#wit-component = "0.211.1"</span>
</code></pre></div>
<p><a href="http://main.rs">main.rs</a></p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="k">use</span><span class="w"> </span><span class="n">wasmtime</span><span class="p">::{</span>
<span class="w">    </span><span class="n">component</span><span class="p">::{</span><span class="n">Component</span><span class="p">,</span><span class="w"> </span><span class="n">Linker</span><span class="p">,</span><span class="w"> </span><span class="n">Val</span><span class="p">},</span>
<span class="w">    </span><span class="n">Config</span><span class="p">,</span><span class="w"> </span><span class="n">Engine</span><span class="p">,</span>
<span class="p">};</span>
<span class="k">use</span><span class="w"> </span><span class="n">wasmtime_wasi</span><span class="p">::{</span><span class="n">WasiCtxBuilder</span><span class="p">,</span><span class="w"> </span><span class="n">WasiView</span><span class="p">};</span>

<span class="cm">/*</span>
<span class="cm">fn convert_to_component(path: impl AsRef&lt;Path&gt;) -&gt; wasmtime::Result&lt;Vec&lt;u8&gt;&gt; {</span>

<span class="cm">    let bytes = &amp;std::fs::read(&amp;path).context("failed to read input file")?;</span>
<span class="cm">    wit_component::ComponentEncoder::default()</span>
<span class="cm">        .module(&amp;bytes)?</span>
<span class="cm">        .encode()</span>
<span class="cm">}</span>
<span class="cm">*/</span>

<span class="k">struct</span><span class="w"> </span><span class="nc">Host</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">ctx</span><span class="p">:</span><span class="w"> </span><span class="nc">wasmtime_wasi</span><span class="p">::</span><span class="n">WasiCtx</span><span class="p">,</span>
<span class="w">    </span><span class="n">table</span><span class="p">:</span><span class="w"> </span><span class="nc">wasmtime_wasi</span><span class="p">::</span><span class="n">ResourceTable</span><span class="p">,</span>
<span class="p">}</span>

<span class="k">impl</span><span class="w"> </span><span class="n">WasiView</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">Host</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">fn</span><span class="w"> </span><span class="nf">table</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="bp">self</span><span class="p">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w"> </span><span class="kp">&amp;</span><span class="nc">mut</span><span class="w"> </span><span class="n">wasmtime_wasi</span><span class="p">::</span><span class="n">ResourceTable</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="bp">self</span><span class="p">.</span><span class="n">table</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="k">fn</span><span class="w"> </span><span class="nf">ctx</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="bp">self</span><span class="p">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w"> </span><span class="kp">&amp;</span><span class="nc">mut</span><span class="w"> </span><span class="n">wasmtime_wasi</span><span class="p">::</span><span class="n">WasiCtx</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="bp">self</span><span class="p">.</span><span class="n">ctx</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>

<span class="k">fn</span><span class="w"> </span><span class="nf">main</span><span class="p">()</span><span class="w"> </span><span class="p">-&gt;</span><span class="w"> </span><span class="nc">wasmtime</span><span class="p">::</span><span class="nb">Result</span><span class="o">&lt;</span><span class="p">()</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">config</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Config</span><span class="p">::</span><span class="n">new</span><span class="p">();</span>
<span class="w">    </span><span class="n">config</span><span class="p">.</span><span class="n">wasm_component_model</span><span class="p">(</span><span class="kc">true</span><span class="p">);</span>
<span class="w">    </span><span class="c1">//config.async_support(true);</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">engine</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Engine</span><span class="p">::</span><span class="n">new</span><span class="p">(</span><span class="o">&amp;</span><span class="n">config</span><span class="p">)</span><span class="o">?</span><span class="p">;</span>
<span class="w">    </span><span class="c1">// Load the component from disk</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">component</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">std</span><span class="p">::</span><span class="n">fs</span><span class="p">::</span><span class="n">read</span><span class="p">(</span><span class="s">"../test-plugin/target/wasm32-wasi/release/test-plugin.wasm"</span><span class="p">)</span><span class="o">?</span><span class="p">;</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">component</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Component</span><span class="p">::</span><span class="n">from_binary</span><span class="p">(</span><span class="o">&amp;</span><span class="n">engine</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">component</span><span class="p">)</span><span class="o">?</span><span class="p">;</span>
<span class="w">    </span><span class="c1">//println!("bytes: {bytes:?}");</span>

<span class="w">    </span><span class="c1">// As `cargo component` by default builds as `wasm32-wasi` webassembly module, we need to also include `wasmtime-wasi` and provide certain native functionality (in my own words)</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">wasi</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">WasiCtxBuilder</span><span class="p">::</span><span class="n">new</span><span class="p">();</span>
<span class="w">    </span><span class="n">wasi</span><span class="p">.</span><span class="n">arg</span><span class="p">(</span><span class="s">"--help"</span><span class="p">);</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">host</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Host</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">ctx</span><span class="p">:</span><span class="w"> </span><span class="nc">wasi</span><span class="p">.</span><span class="n">build</span><span class="p">(),</span>
<span class="w">        </span><span class="n">table</span><span class="p">:</span><span class="w"> </span><span class="nc">wasmtime_wasi</span><span class="p">::</span><span class="n">ResourceTable</span><span class="p">::</span><span class="n">new</span><span class="p">(),</span>
<span class="w">    </span><span class="p">};</span>

<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">store</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">wasmtime</span><span class="p">::</span><span class="n">Store</span><span class="p">::</span><span class="n">new</span><span class="p">(</span><span class="o">&amp;</span><span class="n">engine</span><span class="p">,</span><span class="w"> </span><span class="n">host</span><span class="p">);</span>
<span class="w">    </span><span class="c1">// Configure the linker</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">linker</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Linker</span><span class="p">::</span><span class="n">new</span><span class="p">(</span><span class="o">&amp;</span><span class="n">engine</span><span class="p">);</span>
<span class="w">    </span><span class="n">wasmtime_wasi</span><span class="p">::</span><span class="n">add_to_linker_sync</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="n">linker</span><span class="p">)</span><span class="o">?</span><span class="p">;</span>
<span class="w">    </span><span class="c1">// The component expects one import `name` that</span>
<span class="w">    </span><span class="c1">// takes no params and returns a string</span>

<span class="w">    </span><span class="n">linker</span>
<span class="w">            </span><span class="p">.</span><span class="n">root</span><span class="p">()</span>
<span class="w">            </span><span class="c1">//.func_wrap("name", |_store, _params: ()| Ok((String::from("Alice"),)))?</span>
<span class="w">        </span><span class="p">;</span>

<span class="w">    </span><span class="fm">println!</span><span class="p">(</span><span class="s">"have linker"</span><span class="p">);</span>
<span class="w">    </span><span class="c1">// Instantiate the component</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">instance</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">linker</span><span class="p">.</span><span class="n">instantiate</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="n">store</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">component</span><span class="p">)</span><span class="o">?</span><span class="p">;</span>
<span class="w">    </span><span class="c1">// TODO: find out whethere there is a way to programmatically "explore" an instance,</span>
<span class="w">    </span><span class="c1">// to see it's "API" so to speak.</span>
<span class="w">    </span><span class="c1">// Could be useful for generating some docs or whatnot</span>
<span class="w">    </span><span class="cm">/*</span>
<span class="cm">    let mut exports = instance.exports(&amp;mut store);</span>
<span class="cm">    let root = exports.instance("greetings").expect("greetings to exist");</span>
<span class="cm">    let modules = root.modules();</span>
<span class="cm">    for (name, module) in modules {</span>
<span class="cm">        println!("module: {module:?}")</span>
<span class="cm">    }</span>
<span class="cm">    println!("no modules?!");</span>
<span class="cm">    */</span>

<span class="w">    </span><span class="fm">println!</span><span class="p">(</span><span class="s">"have instance"</span><span class="p">);</span>

<span class="w">    </span><span class="cm">/*</span>
<span class="cm">    // TODO: I definitely misunderstood modules, because "greetings" does not exist</span>
<span class="cm">    let module = instance</span>
<span class="cm">        .get_module(&amp;mut store, "greetings")</span>
<span class="cm">        .expect("module not found");</span>
<span class="cm">    */</span>

<span class="w">    </span><span class="c1">// Call the `greet` function</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">func</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">instance</span>
<span class="w">        </span><span class="p">.</span><span class="n">get_func</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="n">store</span><span class="p">,</span><span class="w"> </span><span class="s">"hello"</span><span class="p">)</span>
<span class="w">        </span><span class="p">.</span><span class="n">expect</span><span class="p">(</span><span class="s">"hello export not found"</span><span class="p">);</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">result</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span><span class="n">wasmtime</span><span class="p">::</span><span class="n">component</span><span class="p">::</span><span class="n">Val</span><span class="p">::</span><span class="nb">String</span><span class="p">(</span><span class="s">""</span><span class="p">.</span><span class="n">into</span><span class="p">())];</span>
<span class="w">    </span><span class="n">func</span><span class="p">.</span><span class="n">call</span><span class="p">(</span>
<span class="w">        </span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="n">store</span><span class="p">,</span>
<span class="w">        </span><span class="o">&amp;</span><span class="p">[</span><span class="n">Val</span><span class="p">::</span><span class="nb">String</span><span class="p">(</span><span class="s">"freund nachtigall"</span><span class="p">.</span><span class="n">to_string</span><span class="p">())],</span>
<span class="w">        </span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="n">result</span><span class="p">,</span>
<span class="w">    </span><span class="p">)</span><span class="o">?</span><span class="p">;</span>

<span class="w">    </span><span class="fm">println!</span><span class="p">(</span><span class="s">"Greeting: {:?}"</span><span class="p">,</span><span class="w"> </span><span class="n">result</span><span class="p">);</span>

<span class="w">    </span><span class="nb">Ok</span><span class="p">(())</span>
<span class="p">}</span>
</code></pre></div>
<p>When I run this I get a <code>panic</code> for <code>hello export not found</code>.</p>
<p>What am I doing wrong? I also tried with: <code>greetings.hello</code> and <code>greetings:hello</code> for <code>get_func</code> but to no avail.</p>
<p>On the other hand, if I create a library component via <code>cargo component new test-plugin-lib --lib</code> which creates a default wit file and impl for it:</p>
<div class="codehilite" data-code-language="wit"><pre><span></span><code>package component:test-plugin-lib;

/// An example world for the component to target.
world example {
    export hello-world: func() -&gt; string;
}
</code></pre></div>
<p>and then load this and call it like so:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">func</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">instance</span>
<span class="w">        </span><span class="p">.</span><span class="n">get_func</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="n">store</span><span class="p">,</span><span class="w"> </span><span class="s">"hello-world"</span><span class="p">)</span>
<span class="w">        </span><span class="p">.</span><span class="n">expect</span><span class="p">(</span><span class="s">"hello export not found"</span><span class="p">);</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">result</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span><span class="n">wasmtime</span><span class="p">::</span><span class="n">component</span><span class="p">::</span><span class="n">Val</span><span class="p">::</span><span class="nb">String</span><span class="p">(</span><span class="s">""</span><span class="p">.</span><span class="n">into</span><span class="p">())];</span>
<span class="w">    </span><span class="n">func</span><span class="p">.</span><span class="n">call</span><span class="p">(</span>
<span class="w">        </span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="n">store</span><span class="p">,</span>
<span class="w">        </span><span class="o">&amp;</span><span class="p">[],</span>
<span class="w">        </span><span class="c1">//&amp;[Val::String("freund nachtigall".to_string())],</span>
<span class="w">        </span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="n">result</span><span class="p">,</span>
<span class="w">    </span><span class="p">)</span><span class="o">?</span><span class="p">;</span>

<span class="w">    </span><span class="fm">println!</span><span class="p">(</span><span class="s">"Greeting: {:?}"</span><span class="p">,</span><span class="w"> </span><span class="n">result</span><span class="p">);</span>
</code></pre></div>
<p>it works like a charm.</p>
<p>So I guess my problem boils down to one or two things:</p>
<p>1) How do I get a function in an <code>interface</code> programmatically like <code>hello</code> if the wit file looks like:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="n">package</span><span class="w"> </span><span class="n">justatest</span><span class="p">:</span><span class="nc">testplugin</span><span class="o">@</span><span class="mf">0.1.0</span><span class="p">;</span>

<span class="n">interface</span><span class="w"> </span><span class="n">greetings</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="n">hello</span><span class="p">:</span><span class="w"> </span><span class="nc">func</span><span class="p">(</span><span class="n">s</span><span class="p">:</span><span class="w"> </span><span class="nc">string</span><span class="p">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w"> </span><span class="nc">string</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">world</span><span class="w"> </span><span class="n">test</span><span class="o">-</span><span class="n">plugin</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="n">export</span><span class="w"> </span><span class="n">greetings</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div>
<p>2) Maybe it's different when it's a "<code>binary</code>" webassembly component in contrast to a lib?</p>
</blockquote>



<a name="446018596"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%238857%20Problems%20with%20leveraging%20%60cargo%20co.../near/446018596" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.238857.20Problems.20with.20leveraging.20.60cargo.20co.2E.2E.2E.html#446018596">(Jun 21 2024 at 07:02)</a>:</h4>
<p>Froidoh edited <a href="https://github.com/bytecodealliance/wasmtime/issues/8857">issue #8857</a>:</p>
<blockquote>
<p>Okay, so I am a total noob with <code>wasm(time)</code> and my mistake is totally a layer 8 problem. But after digging I couldn't find the solution, so here I am, opening an issue (sorry for that!)</p>
<p>What I want:</p>
<p>I want to leverage <code>cargo component</code> and <code>wasmtime</code> to create a simple plugin system experiment.</p>
<p>So I created a new (binary) webassembly component via: <code>cargo component new test-plugin</code>.</p>
<div class="codehilite" data-code-language="TOML"><pre><span></span><code><span class="k">[package]</span>
<span class="n">name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"test-plugin"</span>
<span class="n">version</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"0.1.0"</span>
<span class="n">edition</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"2021"</span>

<span class="k">[dependencies]</span>
<span class="n">wit-bindgen-rt</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">version</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="s2">"0.26.0"</span><span class="p">,</span><span class="w"> </span><span class="n">features</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="p">[</span><span class="s2">"bitflags"</span><span class="p">]</span><span class="w"> </span><span class="p">}</span>

<span class="k">[profile.release]</span>
<span class="n">codegen-units</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span>
<span class="n">opt-level</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"s"</span>
<span class="n">debug</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">false</span>
<span class="n">strip</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">true</span>
<span class="n">lto</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">true</span>

<span class="c1"># [package.metadata.component]</span>
<span class="c1"># package = "component:test-plugin"</span>

<span class="k">[package.metadata.component.target]</span>
<span class="n">path</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"wit"</span>
<span class="n">world</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"test-plugin"</span>

<span class="k">[package.metadata.component.dependencies]</span>
</code></pre></div>
<div class="codehilite" data-code-language="wit"><pre><span></span><code>package justatest:testplugin@0.1.0;

interface greetings {
  hello: func(s: string) -&gt; string;
}

world test-plugin {
  export greetings;
}
</code></pre></div>
<p>And my <code>src/main.rs</code></p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="cp">#[allow(warnings)]</span>
<span class="k">mod</span><span class="w"> </span><span class="nn">bindings</span><span class="p">;</span>

<span class="k">use</span><span class="w"> </span><span class="n">bindings</span><span class="p">::</span><span class="n">exports</span><span class="p">::</span><span class="n">justatest</span><span class="p">::</span><span class="n">testplugin</span><span class="p">::</span><span class="n">greetings</span><span class="p">::</span><span class="n">Guest</span><span class="p">;</span>

<span class="k">struct</span><span class="w"> </span><span class="nc">Component</span><span class="p">;</span>

<span class="k">impl</span><span class="w"> </span><span class="n">Guest</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">Component</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">fn</span><span class="w"> </span><span class="nf">hello</span><span class="p">(</span><span class="n">s</span><span class="p">:</span><span class="w"> </span><span class="nb">String</span><span class="p">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w"> </span><span class="nb">String</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="fm">format!</span><span class="p">(</span><span class="s">"Hello {s}"</span><span class="p">)</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>

<span class="n">bindings</span><span class="p">::</span><span class="n">export</span><span class="o">!</span><span class="p">(</span><span class="n">Component</span><span class="w"> </span><span class="n">with_types_in</span><span class="w"> </span><span class="n">bindings</span><span class="p">);</span>

<span class="k">fn</span><span class="w"> </span><span class="nf">main</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="fm">println!</span><span class="p">(</span><span class="s">"Hello from test-plugin!"</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div>
<p>I then generated the binary via <code>cargo component build --release</code> and let it run via:</p>
<blockquote>
<p>wasmtime target/wasm32-wasi/release/test-plugin.wasm <br>
Hello from test-plugin!</p>
</blockquote>
<p>As expected. Via the <code>wasmtime</code> cli I cannot <code>--invoke</code> any functions on a <code>wasm32-wasi</code> webassembly module (at least that's what the cli tells me)...</p>
<p>So then I created a <code>simple-host</code> as a "normal", "native" rust project, compiled via <code>llvm</code>:</p>
<p>Cargo.toml:</p>
<div class="codehilite" data-code-language="TOML"><pre><span></span><code><span class="k">[package]</span>
<span class="n">name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"simple-host"</span>
<span class="n">version</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"0.1.0"</span>
<span class="n">edition</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"2021"</span>

<span class="k">[dependencies]</span>
<span class="n">anyhow</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"1.0.86"</span>
<span class="n">wasmtime</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"22.0.0"</span>
<span class="n">wasmtime-wasi</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"22.0.0"</span>
<span class="c1">#wit-component = "0.211.1"</span>
</code></pre></div>
<p><a href="http://main.rs">main.rs</a></p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="k">use</span><span class="w"> </span><span class="n">wasmtime</span><span class="p">::{</span>
<span class="w">    </span><span class="n">component</span><span class="p">::{</span><span class="n">Component</span><span class="p">,</span><span class="w"> </span><span class="n">Linker</span><span class="p">,</span><span class="w"> </span><span class="n">Val</span><span class="p">},</span>
<span class="w">    </span><span class="n">Config</span><span class="p">,</span><span class="w"> </span><span class="n">Engine</span><span class="p">,</span>
<span class="p">};</span>
<span class="k">use</span><span class="w"> </span><span class="n">wasmtime_wasi</span><span class="p">::{</span><span class="n">WasiCtxBuilder</span><span class="p">,</span><span class="w"> </span><span class="n">WasiView</span><span class="p">};</span>

<span class="cm">/*</span>
<span class="cm">fn convert_to_component(path: impl AsRef&lt;Path&gt;) -&gt; wasmtime::Result&lt;Vec&lt;u8&gt;&gt; {</span>

<span class="cm">    let bytes = &amp;std::fs::read(&amp;path).context("failed to read input file")?;</span>
<span class="cm">    wit_component::ComponentEncoder::default()</span>
<span class="cm">        .module(&amp;bytes)?</span>
<span class="cm">        .encode()</span>
<span class="cm">}</span>
<span class="cm">*/</span>

<span class="k">struct</span><span class="w"> </span><span class="nc">Host</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">ctx</span><span class="p">:</span><span class="w"> </span><span class="nc">wasmtime_wasi</span><span class="p">::</span><span class="n">WasiCtx</span><span class="p">,</span>
<span class="w">    </span><span class="n">table</span><span class="p">:</span><span class="w"> </span><span class="nc">wasmtime_wasi</span><span class="p">::</span><span class="n">ResourceTable</span><span class="p">,</span>
<span class="p">}</span>

<span class="k">impl</span><span class="w"> </span><span class="n">WasiView</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">Host</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">fn</span><span class="w"> </span><span class="nf">table</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="bp">self</span><span class="p">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w"> </span><span class="kp">&amp;</span><span class="nc">mut</span><span class="w"> </span><span class="n">wasmtime_wasi</span><span class="p">::</span><span class="n">ResourceTable</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="bp">self</span><span class="p">.</span><span class="n">table</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="k">fn</span><span class="w"> </span><span class="nf">ctx</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="bp">self</span><span class="p">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w"> </span><span class="kp">&amp;</span><span class="nc">mut</span><span class="w"> </span><span class="n">wasmtime_wasi</span><span class="p">::</span><span class="n">WasiCtx</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="bp">self</span><span class="p">.</span><span class="n">ctx</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>

<span class="k">fn</span><span class="w"> </span><span class="nf">main</span><span class="p">()</span><span class="w"> </span><span class="p">-&gt;</span><span class="w"> </span><span class="nc">wasmtime</span><span class="p">::</span><span class="nb">Result</span><span class="o">&lt;</span><span class="p">()</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">config</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Config</span><span class="p">::</span><span class="n">new</span><span class="p">();</span>
<span class="w">    </span><span class="n">config</span><span class="p">.</span><span class="n">wasm_component_model</span><span class="p">(</span><span class="kc">true</span><span class="p">);</span>
<span class="w">    </span><span class="c1">//config.async_support(true);</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">engine</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Engine</span><span class="p">::</span><span class="n">new</span><span class="p">(</span><span class="o">&amp;</span><span class="n">config</span><span class="p">)</span><span class="o">?</span><span class="p">;</span>
<span class="w">    </span><span class="c1">// Load the component from disk</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">component</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">std</span><span class="p">::</span><span class="n">fs</span><span class="p">::</span><span class="n">read</span><span class="p">(</span><span class="s">"../test-plugin/target/wasm32-wasi/release/test-plugin.wasm"</span><span class="p">)</span><span class="o">?</span><span class="p">;</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">component</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Component</span><span class="p">::</span><span class="n">from_binary</span><span class="p">(</span><span class="o">&amp;</span><span class="n">engine</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">component</span><span class="p">)</span><span class="o">?</span><span class="p">;</span>
<span class="w">    </span><span class="c1">//println!("bytes: {bytes:?}");</span>

<span class="w">    </span><span class="c1">// As `cargo component` by default builds as `wasm32-wasi` webassembly module, we need to also include `wasmtime-wasi` and provide certain native functionality (in my own words)</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">wasi</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">WasiCtxBuilder</span><span class="p">::</span><span class="n">new</span><span class="p">();</span>
<span class="w">    </span><span class="n">wasi</span><span class="p">.</span><span class="n">arg</span><span class="p">(</span><span class="s">"--help"</span><span class="p">);</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">host</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Host</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">ctx</span><span class="p">:</span><span class="w"> </span><span class="nc">wasi</span><span class="p">.</span><span class="n">build</span><span class="p">(),</span>
<span class="w">        </span><span class="n">table</span><span class="p">:</span><span class="w"> </span><span class="nc">wasmtime_wasi</span><span class="p">::</span><span class="n">ResourceTable</span><span class="p">::</span><span class="n">new</span><span class="p">(),</span>
<span class="w">    </span><span class="p">};</span>

<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">store</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">wasmtime</span><span class="p">::</span><span class="n">Store</span><span class="p">::</span><span class="n">new</span><span class="p">(</span><span class="o">&amp;</span><span class="n">engine</span><span class="p">,</span><span class="w"> </span><span class="n">host</span><span class="p">);</span>
<span class="w">    </span><span class="c1">// Configure the linker</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">linker</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Linker</span><span class="p">::</span><span class="n">new</span><span class="p">(</span><span class="o">&amp;</span><span class="n">engine</span><span class="p">);</span>
<span class="w">    </span><span class="n">wasmtime_wasi</span><span class="p">::</span><span class="n">add_to_linker_sync</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="n">linker</span><span class="p">)</span><span class="o">?</span><span class="p">;</span>
<span class="w">    </span><span class="c1">// The component expects one import `name` that</span>
<span class="w">    </span><span class="c1">// takes no params and returns a string</span>

<span class="w">    </span><span class="n">linker</span>
<span class="w">            </span><span class="p">.</span><span class="n">root</span><span class="p">()</span>
<span class="w">            </span><span class="c1">//.func_wrap("name", |_store, _params: ()| Ok((String::from("Alice"),)))?</span>
<span class="w">        </span><span class="p">;</span>

<span class="w">    </span><span class="fm">println!</span><span class="p">(</span><span class="s">"have linker"</span><span class="p">);</span>
<span class="w">    </span><span class="c1">// Instantiate the component</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">instance</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">linker</span><span class="p">.</span><span class="n">instantiate</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="n">store</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">component</span><span class="p">)</span><span class="o">?</span><span class="p">;</span>
<span class="w">    </span><span class="c1">// TODO: find out whethere there is a way to programmatically "explore" an instance,</span>
<span class="w">    </span><span class="c1">// to see it's "API" so to speak.</span>
<span class="w">    </span><span class="c1">// Could be useful for generating some docs or whatnot</span>
<span class="w">    </span><span class="cm">/*</span>
<span class="cm">    let mut exports = instance.exports(&amp;mut store);</span>
<span class="cm">    let root = exports.instance("greetings").expect("greetings to exist");</span>
<span class="cm">    let modules = root.modules();</span>
<span class="cm">    for (name, module) in modules {</span>
<span class="cm">        println!("module: {module:?}")</span>
<span class="cm">    }</span>
<span class="cm">    println!("no modules?!");</span>
<span class="cm">    */</span>

<span class="w">    </span><span class="fm">println!</span><span class="p">(</span><span class="s">"have instance"</span><span class="p">);</span>

<span class="w">    </span><span class="cm">/*</span>
<span class="cm">    // TODO: I definitely misunderstood modules, because "greetings" does not exist</span>
<span class="cm">    let module = instance</span>
<span class="cm">        .get_module(&amp;mut store, "greetings")</span>
<span class="cm">        .expect("module not found");</span>
<span class="cm">    */</span>

<span class="w">    </span><span class="c1">// Call the `greet` function</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">func</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">instance</span>
<span class="w">        </span><span class="p">.</span><span class="n">get_func</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="n">store</span><span class="p">,</span><span class="w"> </span><span class="s">"hello"</span><span class="p">)</span>
<span class="w">        </span><span class="p">.</span><span class="n">expect</span><span class="p">(</span><span class="s">"hello export not found"</span><span class="p">);</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">result</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span><span class="n">wasmtime</span><span class="p">::</span><span class="n">component</span><span class="p">::</span><span class="n">Val</span><span class="p">::</span><span class="nb">String</span><span class="p">(</span><span class="s">""</span><span class="p">.</span><span class="n">into</span><span class="p">())];</span>
<span class="w">    </span><span class="n">func</span><span class="p">.</span><span class="n">call</span><span class="p">(</span>
<span class="w">        </span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="n">store</span><span class="p">,</span>
<span class="w">        </span><span class="o">&amp;</span><span class="p">[</span><span class="n">Val</span><span class="p">::</span><span class="nb">String</span><span class="p">(</span><span class="s">"freund nachtigall"</span><span class="p">.</span><span class="n">to_string</span><span class="p">())],</span>
<span class="w">        </span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="n">result</span><span class="p">,</span>
<span class="w">    </span><span class="p">)</span><span class="o">?</span><span class="p">;</span>

<span class="w">    </span><span class="fm">println!</span><span class="p">(</span><span class="s">"Greeting: {:?}"</span><span class="p">,</span><span class="w"> </span><span class="n">result</span><span class="p">);</span>

<span class="w">    </span><span class="nb">Ok</span><span class="p">(())</span>
<span class="p">}</span>
</code></pre></div>
<p>When I run this I get a <code>panic</code> for <code>hello export not found</code>.</p>
<p>What am I doing wrong? I also tried with: <code>greetings.hello</code> and <code>greetings:hello</code> for <code>get_func</code> but to no avail.</p>
<p>On the other hand, if I create a library component via <code>cargo component new test-plugin-lib --lib</code> which creates a default wit file and impl for it:</p>
<div class="codehilite" data-code-language="wit"><pre><span></span><code>package component:test-plugin-lib;

/// An example world for the component to target.
world example {
    export hello-world: func() -&gt; string;
}
</code></pre></div>
<p>and then load this and call it like so:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">func</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">instance</span>
<span class="w">        </span><span class="p">.</span><span class="n">get_func</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="n">store</span><span class="p">,</span><span class="w"> </span><span class="s">"hello-world"</span><span class="p">)</span>
<span class="w">        </span><span class="p">.</span><span class="n">expect</span><span class="p">(</span><span class="s">"hello export not found"</span><span class="p">);</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">result</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span><span class="n">wasmtime</span><span class="p">::</span><span class="n">component</span><span class="p">::</span><span class="n">Val</span><span class="p">::</span><span class="nb">String</span><span class="p">(</span><span class="s">""</span><span class="p">.</span><span class="n">into</span><span class="p">())];</span>
<span class="w">    </span><span class="n">func</span><span class="p">.</span><span class="n">call</span><span class="p">(</span>
<span class="w">        </span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="n">store</span><span class="p">,</span>
<span class="w">        </span><span class="o">&amp;</span><span class="p">[],</span>
<span class="w">        </span><span class="c1">//&amp;[Val::String("freund nachtigall".to_string())],</span>
<span class="w">        </span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="n">result</span><span class="p">,</span>
<span class="w">    </span><span class="p">)</span><span class="o">?</span><span class="p">;</span>

<span class="w">    </span><span class="fm">println!</span><span class="p">(</span><span class="s">"Greeting: {:?}"</span><span class="p">,</span><span class="w"> </span><span class="n">result</span><span class="p">);</span>
</code></pre></div>
<p>it works like a charm.</p>
<p>So I guess my problem boils down to one or two things:</p>
<p>1) How do I get a function in an <code>interface</code> programmatically like <code>hello</code> if the wit file looks like:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="n">package</span><span class="w"> </span><span class="n">justatest</span><span class="p">:</span><span class="nc">testplugin</span><span class="o">@</span><span class="mf">0.1.0</span><span class="p">;</span>

<span class="n">interface</span><span class="w"> </span><span class="n">greetings</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="n">hello</span><span class="p">:</span><span class="w"> </span><span class="nc">func</span><span class="p">(</span><span class="n">s</span><span class="p">:</span><span class="w"> </span><span class="nc">string</span><span class="p">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w"> </span><span class="nc">string</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">world</span><span class="w"> </span><span class="n">test</span><span class="o">-</span><span class="n">plugin</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="n">export</span><span class="w"> </span><span class="n">greetings</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div>
<p>~2) Maybe it's different when it's a "<code>binary</code>" webassembly component in contrast to a lib?~</p>
<p>I can answer that one: It's not!</p>
<p>If I add a <code>helloto</code> function like to:</p>
<div class="codehilite" data-code-language="wit"><pre><span></span><code>package justatest:testplugin@0.1.0;

interface greetings {
  hello: func(s: string) -&gt; string;
}

world test-plugin {
  export greetings;
  export helloto: func(name: string) -&gt; string;
}
</code></pre></div>
<p>and implement it like so:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="cp">#[allow(warnings)]</span>
<span class="k">mod</span><span class="w"> </span><span class="nn">bindings</span><span class="p">;</span>

<span class="k">use</span><span class="w"> </span><span class="n">bindings</span><span class="p">::</span><span class="n">exports</span><span class="p">::</span><span class="n">justatest</span><span class="p">::</span><span class="n">testplugin</span><span class="p">::</span><span class="n">greetings</span><span class="p">::</span><span class="n">Guest</span><span class="p">;</span>
<span class="k">use</span><span class="w"> </span><span class="n">bindings</span><span class="p">::</span><span class="n">Guest</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">WorldGuest</span><span class="p">;</span>

<span class="k">struct</span><span class="w"> </span><span class="nc">Component</span><span class="p">;</span>

<span class="k">impl</span><span class="w"> </span><span class="n">Guest</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">Component</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">fn</span><span class="w"> </span><span class="nf">hello</span><span class="p">(</span><span class="n">s</span><span class="p">:</span><span class="w"> </span><span class="nb">String</span><span class="p">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w"> </span><span class="nb">String</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="fm">format!</span><span class="p">(</span><span class="s">"Hello {s}"</span><span class="p">)</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>

<span class="k">impl</span><span class="w"> </span><span class="n">WorldGuest</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">Component</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">fn</span><span class="w"> </span><span class="nf">helloto</span><span class="p">(</span><span class="n">name</span><span class="p">:</span><span class="w"> </span><span class="nb">String</span><span class="p">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w"> </span><span class="nb">String</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="fm">format!</span><span class="p">(</span><span class="s">"Bonjour {name}"</span><span class="p">)</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>

<span class="n">bindings</span><span class="p">::</span><span class="n">export</span><span class="o">!</span><span class="p">(</span><span class="n">Component</span><span class="w"> </span><span class="n">with_types_in</span><span class="w"> </span><span class="n">bindings</span><span class="p">);</span>

<span class="k">fn</span><span class="w"> </span><span class="nf">main</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="fm">println!</span><span class="p">(</span><span class="s">"Hello from test-plugin!"</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div>
<p>then I can invoke <code>helloto</code> just fine :)</p>
<p>So it all boils down to: &gt; how can I invoke a function on an interface?!</p>
</blockquote>



<a name="446018690"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%238857%20Problems%20with%20leveraging%20%60cargo%20co.../near/446018690" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.238857.20Problems.20with.20leveraging.20.60cargo.20co.2E.2E.2E.html#446018690">(Jun 21 2024 at 07:03)</a>:</h4>
<p>Froidoh edited <a href="https://github.com/bytecodealliance/wasmtime/issues/8857">issue #8857</a>:</p>
<blockquote>
<p>EDIT:</p>
<p>So it all boils down to: </p>
<blockquote>
<p>how can I invoke a function on an interface?!</p>
</blockquote>
<p>ORIGINAL:</p>
<p>Okay, so I am a total noob with <code>wasm(time)</code> and my mistake is totally a layer 8 problem. But after digging I couldn't find the solution, so here I am, opening an issue (sorry for that!)</p>
<p>What I want:</p>
<p>I want to leverage <code>cargo component</code> and <code>wasmtime</code> to create a simple plugin system experiment.</p>
<p>So I created a new (binary) webassembly component via: <code>cargo component new test-plugin</code>.</p>
<div class="codehilite" data-code-language="TOML"><pre><span></span><code><span class="k">[package]</span>
<span class="n">name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"test-plugin"</span>
<span class="n">version</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"0.1.0"</span>
<span class="n">edition</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"2021"</span>

<span class="k">[dependencies]</span>
<span class="n">wit-bindgen-rt</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">version</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="s2">"0.26.0"</span><span class="p">,</span><span class="w"> </span><span class="n">features</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="p">[</span><span class="s2">"bitflags"</span><span class="p">]</span><span class="w"> </span><span class="p">}</span>

<span class="k">[profile.release]</span>
<span class="n">codegen-units</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span>
<span class="n">opt-level</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"s"</span>
<span class="n">debug</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">false</span>
<span class="n">strip</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">true</span>
<span class="n">lto</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">true</span>

<span class="c1"># [package.metadata.component]</span>
<span class="c1"># package = "component:test-plugin"</span>

<span class="k">[package.metadata.component.target]</span>
<span class="n">path</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"wit"</span>
<span class="n">world</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"test-plugin"</span>

<span class="k">[package.metadata.component.dependencies]</span>
</code></pre></div>
<div class="codehilite" data-code-language="wit"><pre><span></span><code>package justatest:testplugin@0.1.0;

interface greetings {
  hello: func(s: string) -&gt; string;
}

world test-plugin {
  export greetings;
}
</code></pre></div>
<p>And my <code>src/main.rs</code></p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="cp">#[allow(warnings)]</span>
<span class="k">mod</span><span class="w"> </span><span class="nn">bindings</span><span class="p">;</span>

<span class="k">use</span><span class="w"> </span><span class="n">bindings</span><span class="p">::</span><span class="n">exports</span><span class="p">::</span><span class="n">justatest</span><span class="p">::</span><span class="n">testplugin</span><span class="p">::</span><span class="n">greetings</span><span class="p">::</span><span class="n">Guest</span><span class="p">;</span>

<span class="k">struct</span><span class="w"> </span><span class="nc">Component</span><span class="p">;</span>

<span class="k">impl</span><span class="w"> </span><span class="n">Guest</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">Component</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">fn</span><span class="w"> </span><span class="nf">hello</span><span class="p">(</span><span class="n">s</span><span class="p">:</span><span class="w"> </span><span class="nb">String</span><span class="p">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w"> </span><span class="nb">String</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="fm">format!</span><span class="p">(</span><span class="s">"Hello {s}"</span><span class="p">)</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>

<span class="n">bindings</span><span class="p">::</span><span class="n">export</span><span class="o">!</span><span class="p">(</span><span class="n">Component</span><span class="w"> </span><span class="n">with_types_in</span><span class="w"> </span><span class="n">bindings</span><span class="p">);</span>

<span class="k">fn</span><span class="w"> </span><span class="nf">main</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="fm">println!</span><span class="p">(</span><span class="s">"Hello from test-plugin!"</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div>
<p>I then generated the binary via <code>cargo component build --release</code> and let it run via:</p>
<blockquote>
<p>wasmtime target/wasm32-wasi/release/test-plugin.wasm <br>
Hello from test-plugin!</p>
</blockquote>
<p>As expected. Via the <code>wasmtime</code> cli I cannot <code>--invoke</code> any functions on a <code>wasm32-wasi</code> webassembly module (at least that's what the cli tells me)...</p>
<p>So then I created a <code>simple-host</code> as a "normal", "native" rust project, compiled via <code>llvm</code>:</p>
<p>Cargo.toml:</p>
<div class="codehilite" data-code-language="TOML"><pre><span></span><code><span class="k">[package]</span>
<span class="n">name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"simple-host"</span>
<span class="n">version</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"0.1.0"</span>
<span class="n">edition</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"2021"</span>

<span class="k">[dependencies]</span>
<span class="n">anyhow</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"1.0.86"</span>
<span class="n">wasmtime</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"22.0.0"</span>
<span class="n">wasmtime-wasi</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"22.0.0"</span>
<span class="c1">#wit-component = "0.211.1"</span>
</code></pre></div>
<p><a href="http://main.rs">main.rs</a></p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="k">use</span><span class="w"> </span><span class="n">wasmtime</span><span class="p">::{</span>
<span class="w">    </span><span class="n">component</span><span class="p">::{</span><span class="n">Component</span><span class="p">,</span><span class="w"> </span><span class="n">Linker</span><span class="p">,</span><span class="w"> </span><span class="n">Val</span><span class="p">},</span>
<span class="w">    </span><span class="n">Config</span><span class="p">,</span><span class="w"> </span><span class="n">Engine</span><span class="p">,</span>
<span class="p">};</span>
<span class="k">use</span><span class="w"> </span><span class="n">wasmtime_wasi</span><span class="p">::{</span><span class="n">WasiCtxBuilder</span><span class="p">,</span><span class="w"> </span><span class="n">WasiView</span><span class="p">};</span>

<span class="cm">/*</span>
<span class="cm">fn convert_to_component(path: impl AsRef&lt;Path&gt;) -&gt; wasmtime::Result&lt;Vec&lt;u8&gt;&gt; {</span>

<span class="cm">    let bytes = &amp;std::fs::read(&amp;path).context("failed to read input file")?;</span>
<span class="cm">    wit_component::ComponentEncoder::default()</span>
<span class="cm">        .module(&amp;bytes)?</span>
<span class="cm">        .encode()</span>
<span class="cm">}</span>
<span class="cm">*/</span>

<span class="k">struct</span><span class="w"> </span><span class="nc">Host</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">ctx</span><span class="p">:</span><span class="w"> </span><span class="nc">wasmtime_wasi</span><span class="p">::</span><span class="n">WasiCtx</span><span class="p">,</span>
<span class="w">    </span><span class="n">table</span><span class="p">:</span><span class="w"> </span><span class="nc">wasmtime_wasi</span><span class="p">::</span><span class="n">ResourceTable</span><span class="p">,</span>
<span class="p">}</span>

<span class="k">impl</span><span class="w"> </span><span class="n">WasiView</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">Host</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">fn</span><span class="w"> </span><span class="nf">table</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="bp">self</span><span class="p">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w"> </span><span class="kp">&amp;</span><span class="nc">mut</span><span class="w"> </span><span class="n">wasmtime_wasi</span><span class="p">::</span><span class="n">ResourceTable</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="bp">self</span><span class="p">.</span><span class="n">table</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="k">fn</span><span class="w"> </span><span class="nf">ctx</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="bp">self</span><span class="p">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w"> </span><span class="kp">&amp;</span><span class="nc">mut</span><span class="w"> </span><span class="n">wasmtime_wasi</span><span class="p">::</span><span class="n">WasiCtx</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="bp">self</span><span class="p">.</span><span class="n">ctx</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>

<span class="k">fn</span><span class="w"> </span><span class="nf">main</span><span class="p">()</span><span class="w"> </span><span class="p">-&gt;</span><span class="w"> </span><span class="nc">wasmtime</span><span class="p">::</span><span class="nb">Result</span><span class="o">&lt;</span><span class="p">()</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">config</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Config</span><span class="p">::</span><span class="n">new</span><span class="p">();</span>
<span class="w">    </span><span class="n">config</span><span class="p">.</span><span class="n">wasm_component_model</span><span class="p">(</span><span class="kc">true</span><span class="p">);</span>
<span class="w">    </span><span class="c1">//config.async_support(true);</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">engine</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Engine</span><span class="p">::</span><span class="n">new</span><span class="p">(</span><span class="o">&amp;</span><span class="n">config</span><span class="p">)</span><span class="o">?</span><span class="p">;</span>
<span class="w">    </span><span class="c1">// Load the component from disk</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">component</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">std</span><span class="p">::</span><span class="n">fs</span><span class="p">::</span><span class="n">read</span><span class="p">(</span><span class="s">"../test-plugin/target/wasm32-wasi/release/test-plugin.wasm"</span><span class="p">)</span><span class="o">?</span><span class="p">;</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">component</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Component</span><span class="p">::</span><span class="n">from_binary</span><span class="p">(</span><span class="o">&amp;</span><span class="n">engine</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">component</span><span class="p">)</span><span class="o">?</span><span class="p">;</span>
<span class="w">    </span><span class="c1">//println!("bytes: {bytes:?}");</span>

<span class="w">    </span><span class="c1">// As `cargo component` by default builds as `wasm32-wasi` webassembly module, we need to also include `wasmtime-wasi` and provide certain native functionality (in my own words)</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">wasi</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">WasiCtxBuilder</span><span class="p">::</span><span class="n">new</span><span class="p">();</span>
<span class="w">    </span><span class="n">wasi</span><span class="p">.</span><span class="n">arg</span><span class="p">(</span><span class="s">"--help"</span><span class="p">);</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">host</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Host</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">ctx</span><span class="p">:</span><span class="w"> </span><span class="nc">wasi</span><span class="p">.</span><span class="n">build</span><span class="p">(),</span>
<span class="w">        </span><span class="n">table</span><span class="p">:</span><span class="w"> </span><span class="nc">wasmtime_wasi</span><span class="p">::</span><span class="n">ResourceTable</span><span class="p">::</span><span class="n">new</span><span class="p">(),</span>
<span class="w">    </span><span class="p">};</span>

<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">store</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">wasmtime</span><span class="p">::</span><span class="n">Store</span><span class="p">::</span><span class="n">new</span><span class="p">(</span><span class="o">&amp;</span><span class="n">engine</span><span class="p">,</span><span class="w"> </span><span class="n">host</span><span class="p">);</span>
<span class="w">    </span><span class="c1">// Configure the linker</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">linker</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Linker</span><span class="p">::</span><span class="n">new</span><span class="p">(</span><span class="o">&amp;</span><span class="n">engine</span><span class="p">);</span>
<span class="w">    </span><span class="n">wasmtime_wasi</span><span class="p">::</span><span class="n">add_to_linker_sync</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="n">linker</span><span class="p">)</span><span class="o">?</span><span class="p">;</span>
<span class="w">    </span><span class="c1">// The component expects one import `name` that</span>
<span class="w">    </span><span class="c1">// takes no params and returns a string</span>

<span class="w">    </span><span class="n">linker</span>
<span class="w">            </span><span class="p">.</span><span class="n">root</span><span class="p">()</span>
<span class="w">            </span><span class="c1">//.func_wrap("name", |_store, _params: ()| Ok((String::from("Alice"),)))?</span>
<span class="w">        </span><span class="p">;</span>

<span class="w">    </span><span class="fm">println!</span><span class="p">(</span><span class="s">"have linker"</span><span class="p">);</span>
<span class="w">    </span><span class="c1">// Instantiate the component</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">instance</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">linker</span><span class="p">.</span><span class="n">instantiate</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="n">store</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">component</span><span class="p">)</span><span class="o">?</span><span class="p">;</span>
<span class="w">    </span><span class="c1">// TODO: find out whethere there is a way to programmatically "explore" an instance,</span>
<span class="w">    </span><span class="c1">// to see it's "API" so to speak.</span>
<span class="w">    </span><span class="c1">// Could be useful for generating some docs or whatnot</span>
<span class="w">    </span><span class="cm">/*</span>
<span class="cm">    let mut exports = instance.exports(&amp;mut store);</span>
<span class="cm">    let root = exports.instance("greetings").expect("greetings to exist");</span>
<span class="cm">    let modules = root.modules();</span>
<span class="cm">    for (name, module) in modules {</span>
<span class="cm">        println!("module: {module:?}")</span>
<span class="cm">    }</span>
<span class="cm">    println!("no modules?!");</span>
<span class="cm">    */</span>

<span class="w">    </span><span class="fm">println!</span><span class="p">(</span><span class="s">"have instance"</span><span class="p">);</span>

<span class="w">    </span><span class="cm">/*</span>
<span class="cm">    // TODO: I definitely misunderstood modules, because "greetings" does not exist</span>
<span class="cm">    let module = instance</span>
<span class="cm">        .get_module(&amp;mut store, "greetings")</span>
<span class="cm">        .expect("module not found");</span>
<span class="cm">    */</span>

<span class="w">    </span><span class="c1">// Call the `greet` function</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">func</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">instance</span>
<span class="w">        </span><span class="p">.</span><span class="n">get_func</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="n">store</span><span class="p">,</span><span class="w"> </span><span class="s">"hello"</span><span class="p">)</span>
<span class="w">        </span><span class="p">.</span><span class="n">expect</span><span class="p">(</span><span class="s">"hello export not found"</span><span class="p">);</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">result</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span><span class="n">wasmtime</span><span class="p">::</span><span class="n">component</span><span class="p">::</span><span class="n">Val</span><span class="p">::</span><span class="nb">String</span><span class="p">(</span><span class="s">""</span><span class="p">.</span><span class="n">into</span><span class="p">())];</span>
<span class="w">    </span><span class="n">func</span><span class="p">.</span><span class="n">call</span><span class="p">(</span>
<span class="w">        </span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="n">store</span><span class="p">,</span>
<span class="w">        </span><span class="o">&amp;</span><span class="p">[</span><span class="n">Val</span><span class="p">::</span><span class="nb">String</span><span class="p">(</span><span class="s">"freund nachtigall"</span><span class="p">.</span><span class="n">to_string</span><span class="p">())],</span>
<span class="w">        </span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="n">result</span><span class="p">,</span>
<span class="w">    </span><span class="p">)</span><span class="o">?</span><span class="p">;</span>

<span class="w">    </span><span class="fm">println!</span><span class="p">(</span><span class="s">"Greeting: {:?}"</span><span class="p">,</span><span class="w"> </span><span class="n">result</span><span class="p">);</span>

<span class="w">    </span><span class="nb">Ok</span><span class="p">(())</span>
<span class="p">}</span>
</code></pre></div>
<p>When I run this I get a <code>panic</code> for <code>hello export not found</code>.</p>
<p>What am I doing wrong? I also tried with: <code>greetings.hello</code> and <code>greetings:hello</code> for <code>get_func</code> but to no avail.</p>
<p>On the other hand, if I create a library component via <code>cargo component new test-plugin-lib --lib</code> which creates a default wit file and impl for it:</p>
<div class="codehilite" data-code-language="wit"><pre><span></span><code>package component:test-plugin-lib;

/// An example world for the component to target.
world example {
    export hello-world: func() -&gt; string;
}
</code></pre></div>
<p>and then load this and call it like so:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">func</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">instance</span>
<span class="w">        </span><span class="p">.</span><span class="n">get_func</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="n">store</span><span class="p">,</span><span class="w"> </span><span class="s">"hello-world"</span><span class="p">)</span>
<span class="w">        </span><span class="p">.</span><span class="n">expect</span><span class="p">(</span><span class="s">"hello export not found"</span><span class="p">);</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">result</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span><span class="n">wasmtime</span><span class="p">::</span><span class="n">component</span><span class="p">::</span><span class="n">Val</span><span class="p">::</span><span class="nb">String</span><span class="p">(</span><span class="s">""</span><span class="p">.</span><span class="n">into</span><span class="p">())];</span>
<span class="w">    </span><span class="n">func</span><span class="p">.</span><span class="n">call</span><span class="p">(</span>
<span class="w">        </span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="n">store</span><span class="p">,</span>
<span class="w">        </span><span class="o">&amp;</span><span class="p">[],</span>
<span class="w">        </span><span class="c1">//&amp;[Val::String("freund nachtigall".to_string())],</span>
<span class="w">        </span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="n">result</span><span class="p">,</span>
<span class="w">    </span><span class="p">)</span><span class="o">?</span><span class="p">;</span>

<span class="w">    </span><span class="fm">println!</span><span class="p">(</span><span class="s">"Greeting: {:?}"</span><span class="p">,</span><span class="w"> </span><span class="n">result</span><span class="p">);</span>
</code></pre></div>
<p>it works like a charm.</p>
<p>So I guess my problem boils down to one or two things:</p>
<p>1) How do I get a function in an <code>interface</code> programmatically like <code>hello</code> if the wit file looks like:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="n">package</span><span class="w"> </span><span class="n">justatest</span><span class="p">:</span><span class="nc">testplugin</span><span class="o">@</span><span class="mf">0.1.0</span><span class="p">;</span>

<span class="n">interface</span><span class="w"> </span><span class="n">greetings</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="n">hello</span><span class="p">:</span><span class="w"> </span><span class="nc">func</span><span class="p">(</span><span class="n">s</span><span class="p">:</span><span class="w"> </span><span class="nc">string</span><span class="p">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w"> </span><span class="nc">string</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">world</span><span class="w"> </span><span class="n">test</span><span class="o">-</span><span class="n">plugin</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="n">export</span><span class="w"> </span><span class="n">greetings</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div>
<p>~2) Maybe it's different when it's a "<code>binary</code>" webassembly component in contrast to a lib?~</p>
<p>I can answer that one: It's not!</p>
<p>If I add a <code>helloto</code> function like to:</p>
<div class="codehilite" data-code-language="wit"><pre><span></span><code>package justatest:testplugin@0.1.0;

interface greetings {
  hello: func(s: string) -&gt; string;
}

world test-plugin {
  export greetings;
  export helloto: func(name: string) -&gt; string;
}
</code></pre></div>
<p>and implement it like so:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="cp">#[allow(warnings)]</span>
<span class="k">mod</span><span class="w"> </span><span class="nn">bindings</span><span class="p">;</span>

<span class="k">use</span><span class="w"> </span><span class="n">bindings</span><span class="p">::</span><span class="n">exports</span><span class="p">::</span><span class="n">justatest</span><span class="p">::</span><span class="n">testplugin</span><span class="p">::</span><span class="n">greetings</span><span class="p">::</span><span class="n">Guest</span><span class="p">;</span>
<span class="k">use</span><span class="w"> </span><span class="n">bindings</span><span class="p">::</span><span class="n">Guest</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">WorldGuest</span><span class="p">;</span>

<span class="k">struct</span><span class="w"> </span><span class="nc">Component</span><span class="p">;</span>

<span class="k">impl</span><span class="w"> </span><span class="n">Guest</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">Component</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">fn</span><span class="w"> </span><span class="nf">hello</span><span class="p">(</span><span class="n">s</span><span class="p">:</span><span class="w"> </span><span class="nb">String</span><span class="p">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w"> </span><span class="nb">String</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="fm">format!</span><span class="p">(</span><span class="s">"Hello {s}"</span><span class="p">)</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>

<span class="k">impl</span><span class="w"> </span><span class="n">WorldGuest</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">Component</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">fn</span><span class="w"> </span><span class="nf">helloto</span><span class="p">(</span><span class="n">name</span><span class="p">:</span><span class="w"> </span><span class="nb">String</span><span class="p">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w"> </span><span class="nb">String</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="fm">format!</span><span class="p">(</span><span class="s">"Bonjour {name}"</span><span class="p">)</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>

<span class="n">bindings</span><span class="p">::</span><span class="n">export</span><span class="o">!</span><span class="p">(</span><span class="n">Component</span><span class="w"> </span><span class="n">with_types_in</span><span class="w"> </span><span class="n">bindings</span><span class="p">);</span>

<span class="k">fn</span><span class="w"> </span><span class="nf">main</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="fm">println!</span><span class="p">(</span><span class="s">"Hello from test-plugin!"</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div>
<p>then I can invoke <code>helloto</code> just fine :)</p>
<p>So it all boils down to: </p>
<blockquote>
<p>how can I invoke a function on an interface?!</p>
</blockquote>
</blockquote>



<hr><p>Last updated: Jan 20 2025 at 06:04 UTC</p>
</html>