<html>
<head><meta charset="utf-8"><title>wasmtime / PR #2149 This patch fills in the missing piece... · git-wasmtime · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/index.html">git-wasmtime</a></h2>
<h3>Topic: <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232149.20This.20patch.20fills.20in.20the.20missing.20piece.2E.2E.2E.html">wasmtime / PR #2149 This patch fills in the missing piece...</a></h3>

<hr>

<base href="https://bytecodealliance.zulipchat.com">

<head><link href="https://bytecodealliance.github.io/zulip-archive/style.css" rel="stylesheet"></head>

<a name="207490541"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232149%20This%20patch%20fills%20in%20the%20missing%20piece.../near/207490541" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232149.20This.20patch.20fills.20in.20the.20missing.20piece.2E.2E.2E.html#207490541">(Aug 20 2020 at 05:40)</a>:</h4>
<p>julian-seward1 opened <a href="https://github.com/bytecodealliance/wasmtime/pull/2149">PR #2149</a> from <code>atomics-x64-CL</code> to <code>main</code>:</p>
<blockquote>
<p>… on newBE/x64.  It does</p>
<p>this by providing an implementation of the CLIF instructions <code>AtomicRmw</code>, <code>AtomicCas</code>,<br>
<code>AtomicLoad</code>, <code>AtomicStore</code> and <code>Fence</code>.</p>
<p>The translation is straightforward.  <code>AtomicCas</code> is translated into x64 <code>cmpxchg</code>, <code>AtomicLoad</code><br>
becomes a normal load because x64-TSO provides adequate sequencing, <code>AtomicStore</code> becomes a<br>
normal store followed by <code>mfence</code>, and <code>Fence</code> becomes <code>mfence</code>.  <code>AtomicRmw</code> is the only<br>
complex case: it becomes a normal load, followed by a loop which computes an updated value,<br>
tries to <code>cmpxchg</code> it back to memory, and repeats if necessary.</p>
<p>This is a minimum-effort initial implementation.  <code>AtomicRmw</code> could be implemented more<br>
efficiently using LOCK-prefixed integer read-modify-write instructions in the case where the old<br>
value in memory is not required.  Subsequent work could add that, if required.</p>
<p>The x64 emitter has been updated to emit the new instructions, obviously.  The <code>LegacyPrefix</code><br>
mechanism has been revised to handle multiple prefix bytes, not just one, since it is now<br>
sometimes necessary to emit both 0x66 (Operand Size Override) and F0 (Lock).</p>
<p>In the aarch64 implementation of atomics, there has been some minor renaming for the sake of<br>
clarity, and for consistency with this x64 implementation.</p>
<p>&lt;!--</p>
<p>Please ensure that the following steps are all taken care of before submitting<br>
the PR.</p>
<ul>
<li>
<p>[ ] This has been discussed in issue #..., or if not, please tell us why<br>
  here.</p>
</li>
<li>
<p>[ ] A short description of what this does, why it is needed; if the<br>
  description becomes long, the matter should probably be discussed in an issue<br>
  first.</p>
</li>
<li>
<p>[ ] This PR contains test cases, if meaningful.</p>
</li>
<li>[ ] A reviewer from the core maintainer team has been assigned for this PR.<br>
  If you don't know who could review this, please indicate so. The list of<br>
  suggested reviewers on the right can help you.</li>
</ul>
<p>Please ensure all communication adheres to the <a href="https://github.com/bytecodealliance/wasmtime/blob/master/CODE_OF_CONDUCT.md">code of
conduct</a>.<br>
--&gt;</p>
</blockquote>



<a name="207508827"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232149%20This%20patch%20fills%20in%20the%20missing%20piece.../near/207508827" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232149.20This.20patch.20fills.20in.20the.20missing.20piece.2E.2E.2E.html#207508827">(Aug 20 2020 at 10:36)</a>:</h4>
<p>julian-seward1 updated <a href="https://github.com/bytecodealliance/wasmtime/pull/2149">PR #2149</a> from <code>atomics-x64-CL</code> to <code>main</code>:</p>
<blockquote>
<p>… on newBE/x64.  It does</p>
<p>this by providing an implementation of the CLIF instructions <code>AtomicRmw</code>, <code>AtomicCas</code>,<br>
<code>AtomicLoad</code>, <code>AtomicStore</code> and <code>Fence</code>.</p>
<p>The translation is straightforward.  <code>AtomicCas</code> is translated into x64 <code>cmpxchg</code>, <code>AtomicLoad</code><br>
becomes a normal load because x64-TSO provides adequate sequencing, <code>AtomicStore</code> becomes a<br>
normal store followed by <code>mfence</code>, and <code>Fence</code> becomes <code>mfence</code>.  <code>AtomicRmw</code> is the only<br>
complex case: it becomes a normal load, followed by a loop which computes an updated value,<br>
tries to <code>cmpxchg</code> it back to memory, and repeats if necessary.</p>
<p>This is a minimum-effort initial implementation.  <code>AtomicRmw</code> could be implemented more<br>
efficiently using LOCK-prefixed integer read-modify-write instructions in the case where the old<br>
value in memory is not required.  Subsequent work could add that, if required.</p>
<p>The x64 emitter has been updated to emit the new instructions, obviously.  The <code>LegacyPrefix</code><br>
mechanism has been revised to handle multiple prefix bytes, not just one, since it is now<br>
sometimes necessary to emit both 0x66 (Operand Size Override) and F0 (Lock).</p>
<p>In the aarch64 implementation of atomics, there has been some minor renaming for the sake of<br>
clarity, and for consistency with this x64 implementation.</p>
<p>&lt;!--</p>
<p>Please ensure that the following steps are all taken care of before submitting<br>
the PR.</p>
<ul>
<li>
<p>[ ] This has been discussed in issue #..., or if not, please tell us why<br>
  here.</p>
</li>
<li>
<p>[ ] A short description of what this does, why it is needed; if the<br>
  description becomes long, the matter should probably be discussed in an issue<br>
  first.</p>
</li>
<li>
<p>[ ] This PR contains test cases, if meaningful.</p>
</li>
<li>[ ] A reviewer from the core maintainer team has been assigned for this PR.<br>
  If you don't know who could review this, please indicate so. The list of<br>
  suggested reviewers on the right can help you.</li>
</ul>
<p>Please ensure all communication adheres to the <a href="https://github.com/bytecodealliance/wasmtime/blob/master/CODE_OF_CONDUCT.md">code of
conduct</a>.<br>
--&gt;</p>
</blockquote>



<a name="207510953"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232149%20This%20patch%20fills%20in%20the%20missing%20piece.../near/207510953" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232149.20This.20patch.20fills.20in.20the.20missing.20piece.2E.2E.2E.html#207510953">(Aug 20 2020 at 11:08)</a>:</h4>
<p>julian-seward1 updated <a href="https://github.com/bytecodealliance/wasmtime/pull/2149">PR #2149</a> from <code>atomics-x64-CL</code> to <code>main</code>:</p>
<blockquote>
<p>… on newBE/x64.  It does</p>
<p>this by providing an implementation of the CLIF instructions <code>AtomicRmw</code>, <code>AtomicCas</code>,<br>
<code>AtomicLoad</code>, <code>AtomicStore</code> and <code>Fence</code>.</p>
<p>The translation is straightforward.  <code>AtomicCas</code> is translated into x64 <code>cmpxchg</code>, <code>AtomicLoad</code><br>
becomes a normal load because x64-TSO provides adequate sequencing, <code>AtomicStore</code> becomes a<br>
normal store followed by <code>mfence</code>, and <code>Fence</code> becomes <code>mfence</code>.  <code>AtomicRmw</code> is the only<br>
complex case: it becomes a normal load, followed by a loop which computes an updated value,<br>
tries to <code>cmpxchg</code> it back to memory, and repeats if necessary.</p>
<p>This is a minimum-effort initial implementation.  <code>AtomicRmw</code> could be implemented more<br>
efficiently using LOCK-prefixed integer read-modify-write instructions in the case where the old<br>
value in memory is not required.  Subsequent work could add that, if required.</p>
<p>The x64 emitter has been updated to emit the new instructions, obviously.  The <code>LegacyPrefix</code><br>
mechanism has been revised to handle multiple prefix bytes, not just one, since it is now<br>
sometimes necessary to emit both 0x66 (Operand Size Override) and F0 (Lock).</p>
<p>In the aarch64 implementation of atomics, there has been some minor renaming for the sake of<br>
clarity, and for consistency with this x64 implementation.</p>
<p>&lt;!--</p>
<p>Please ensure that the following steps are all taken care of before submitting<br>
the PR.</p>
<ul>
<li>
<p>[ ] This has been discussed in issue #..., or if not, please tell us why<br>
  here.</p>
</li>
<li>
<p>[ ] A short description of what this does, why it is needed; if the<br>
  description becomes long, the matter should probably be discussed in an issue<br>
  first.</p>
</li>
<li>
<p>[ ] This PR contains test cases, if meaningful.</p>
</li>
<li>[ ] A reviewer from the core maintainer team has been assigned for this PR.<br>
  If you don't know who could review this, please indicate so. The list of<br>
  suggested reviewers on the right can help you.</li>
</ul>
<p>Please ensure all communication adheres to the <a href="https://github.com/bytecodealliance/wasmtime/blob/master/CODE_OF_CONDUCT.md">code of
conduct</a>.<br>
--&gt;</p>
</blockquote>



<a name="207511890"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232149%20This%20patch%20fills%20in%20the%20missing%20piece.../near/207511890" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232149.20This.20patch.20fills.20in.20the.20missing.20piece.2E.2E.2E.html#207511890">(Aug 20 2020 at 11:23)</a>:</h4>
<p><strong>julian-seward1</strong> requested <a href="https://github.com/bnjbvr">bnjbvr</a> for a review on <a href="https://github.com/bytecodealliance/wasmtime/pull/2149">PR #2149</a>.</p>



<a name="207536389"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232149%20This%20patch%20fills%20in%20the%20missing%20piece.../near/207536389" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232149.20This.20patch.20fills.20in.20the.20missing.20piece.2E.2E.2E.html#207536389">(Aug 20 2020 at 15:33)</a>:</h4>
<p>bnjbvr submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/2149#pullrequestreview-471714803">PR Review</a>.</p>



<a name="207536390"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232149%20This%20patch%20fills%20in%20the%20missing%20piece.../near/207536390" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232149.20This.20patch.20fills.20in.20the.20missing.20piece.2E.2E.2E.html#207536390">(Aug 20 2020 at 15:33)</a>:</h4>
<p>bnjbvr submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/2149#pullrequestreview-471714803">PR Review</a>.</p>



<a name="207536391"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232149%20This%20patch%20fills%20in%20the%20missing%20piece.../near/207536391" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232149.20This.20patch.20fills.20in.20the.20missing.20piece.2E.2E.2E.html#207536391">(Aug 20 2020 at 15:33)</a>:</h4>
<p>bnjbvr created <a href="https://github.com/bytecodealliance/wasmtime/pull/2149#discussion_r474059044">PR Review Comment</a>:</p>
<blockquote>
<p>Can you expand the names here, or at least add comments? I have no clues what M/L/S mean.</p>
</blockquote>



<a name="207536392"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232149%20This%20patch%20fills%20in%20the%20missing%20piece.../near/207536392" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232149.20This.20patch.20fills.20in.20the.20missing.20piece.2E.2E.2E.html#207536392">(Aug 20 2020 at 15:33)</a>:</h4>
<p>bnjbvr created <a href="https://github.com/bytecodealliance/wasmtime/pull/2149#discussion_r474061577">PR Review Comment</a>:</p>
<blockquote>
<p>Maybe hoist the aarch64 version then, and hoist it in the <code>machinst</code> code or a new <code>isa/common</code> directory?</p>
</blockquote>



<a name="207536394"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232149%20This%20patch%20fills%20in%20the%20missing%20piece.../near/207536394" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232149.20This.20patch.20fills.20in.20the.20missing.20piece.2E.2E.2E.html#207536394">(Aug 20 2020 at 15:33)</a>:</h4>
<p>bnjbvr created <a href="https://github.com/bytecodealliance/wasmtime/pull/2149#discussion_r474062124">PR Review Comment</a>:</p>
<blockquote>
<p>nit: here and below, can you use doc comments instead, so they show up in LSP hovers/docs.rs, etc?</p>
</blockquote>



<a name="207536395"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232149%20This%20patch%20fills%20in%20the%20missing%20piece.../near/207536395" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232149.20This.20patch.20fills.20in.20the.20missing.20piece.2E.2E.2E.html#207536395">(Aug 20 2020 at 15:33)</a>:</h4>
<p>bnjbvr created <a href="https://github.com/bytecodealliance/wasmtime/pull/2149#discussion_r474063233">PR Review Comment</a>:</p>
<blockquote>
<p>nit: we do not use <code>/*</code> comments in general, can you use <code>//</code> instead?</p>
</blockquote>



<a name="207536396"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232149%20This%20patch%20fills%20in%20the%20missing%20piece.../near/207536396" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232149.20This.20patch.20fills.20in.20the.20missing.20piece.2E.2E.2E.html#207536396">(Aug 20 2020 at 15:33)</a>:</h4>
<p>bnjbvr created <a href="https://github.com/bytecodealliance/wasmtime/pull/2149#discussion_r474064139">PR Review Comment</a>:</p>
<blockquote>
<p>With the new <code>load</code> helper introduced in the SIMD PR (that should land soonish, probably), you might be able to just use <code>Inst::load</code> here.</p>
</blockquote>



<a name="207536397"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232149%20This%20patch%20fills%20in%20the%20missing%20piece.../near/207536397" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232149.20This.20patch.20fills.20in.20the.20missing.20piece.2E.2E.2E.html#207536397">(Aug 20 2020 at 15:33)</a>:</h4>
<p>bnjbvr created <a href="https://github.com/bytecodealliance/wasmtime/pull/2149#discussion_r474065662">PR Review Comment</a>:</p>
<blockquote>
<p>nit: can you expand <code>insn</code> + precise that the second really means second in the loop?</p>
</blockquote>



<a name="207536398"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232149%20This%20patch%20fills%20in%20the%20missing%20piece.../near/207536398" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232149.20This.20patch.20fills.20in.20the.20missing.20piece.2E.2E.2E.html#207536398">(Aug 20 2020 at 15:33)</a>:</h4>
<p>bnjbvr created <a href="https://github.com/bytecodealliance/wasmtime/pull/2149#discussion_r474066133">PR Review Comment</a>:</p>
<blockquote>
<p>Can you commonize all these match arms together? <code>=&gt; Inst::alu_rmi_r(true, AluRmiROpcode::from(op), r10_rmi, r11_w)</code> to avoid code duplication</p>
</blockquote>



<a name="207536399"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232149%20This%20patch%20fills%20in%20the%20missing%20piece.../near/207536399" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232149.20This.20patch.20fills.20in.20the.20missing.20piece.2E.2E.2E.html#207536399">(Aug 20 2020 at 15:33)</a>:</h4>
<p>bnjbvr created <a href="https://github.com/bytecodealliance/wasmtime/pull/2149#discussion_r474068910">PR Review Comment</a>:</p>
<blockquote>
<p>nit: here too, please don't use shorthands for read/write</p>
</blockquote>



<a name="207536400"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232149%20This%20patch%20fills%20in%20the%20missing%20piece.../near/207536400" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232149.20This.20patch.20fills.20in.20the.20missing.20piece.2E.2E.2E.html#207536400">(Aug 20 2020 at 15:33)</a>:</h4>
<p>bnjbvr created <a href="https://github.com/bytecodealliance/wasmtime/pull/2149#discussion_r474067295">PR Review Comment</a>:</p>
<blockquote>
<p>nit (twice): what does <code>rd</code> mean?</p>
</blockquote>



<a name="207536401"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232149%20This%20patch%20fills%20in%20the%20missing%20piece.../near/207536401" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232149.20This.20patch.20fills.20in.20the.20missing.20piece.2E.2E.2E.html#207536401">(Aug 20 2020 at 15:33)</a>:</h4>
<p>bnjbvr created <a href="https://github.com/bytecodealliance/wasmtime/pull/2149#discussion_r474068348">PR Review Comment</a>:</p>
<blockquote>
<p>nit: please expand <code>CAS</code> at least once, with acronym in parenthesis.</p>
</blockquote>



<a name="207536402"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232149%20This%20patch%20fills%20in%20the%20missing%20piece.../near/207536402" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232149.20This.20patch.20fills.20in.20the.20missing.20piece.2E.2E.2E.html#207536402">(Aug 20 2020 at 15:33)</a>:</h4>
<p>bnjbvr created <a href="https://github.com/bytecodealliance/wasmtime/pull/2149#discussion_r474070939">PR Review Comment</a>:</p>
<blockquote>
<p>Can you open an issue for the improvements, please, and refer to it with a <code>TODO</code> comment mentioning the issue number?</p>
</blockquote>



<a name="207536403"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232149%20This%20patch%20fills%20in%20the%20missing%20piece.../near/207536403" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232149.20This.20patch.20fills.20in.20the.20missing.20piece.2E.2E.2E.html#207536403">(Aug 20 2020 at 15:33)</a>:</h4>
<p>bnjbvr created <a href="https://github.com/bytecodealliance/wasmtime/pull/2149#discussion_r474071388">PR Review Comment</a>:</p>
<blockquote>
<p>ditto insn</p>
</blockquote>



<a name="207536404"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232149%20This%20patch%20fills%20in%20the%20missing%20piece.../near/207536404" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232149.20This.20patch.20fills.20in.20the.20missing.20piece.2E.2E.2E.html#207536404">(Aug 20 2020 at 15:33)</a>:</h4>
<p>bnjbvr created <a href="https://github.com/bytecodealliance/wasmtime/pull/2149#discussion_r474073987">PR Review Comment</a>:</p>
<blockquote>
<p>Could we remove this comment? It's a bit weird to read this here, since there's a sequence of vcode insts, and the vcode inst actually trashing this register already mentions it does that by the code in <code>get_regs</code>.</p>
</blockquote>



<a name="207536405"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232149%20This%20patch%20fills%20in%20the%20missing%20piece.../near/207536405" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232149.20This.20patch.20fills.20in.20the.20missing.20piece.2E.2E.2E.html#207536405">(Aug 20 2020 at 15:33)</a>:</h4>
<p>bnjbvr created <a href="https://github.com/bytecodealliance/wasmtime/pull/2149#discussion_r474072814">PR Review Comment</a>:</p>
<blockquote>
<p>Can you remove the <code>r_</code> prefixes, for consistency with the rest of this file?</p>
</blockquote>



<a name="207536406"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232149%20This%20patch%20fills%20in%20the%20missing%20piece.../near/207536406" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232149.20This.20patch.20fills.20in.20the.20missing.20piece.2E.2E.2E.html#207536406">(Aug 20 2020 at 15:33)</a>:</h4>
<p>bnjbvr created <a href="https://github.com/bytecodealliance/wasmtime/pull/2149#discussion_r474067947">PR Review Comment</a>:</p>
<blockquote>
<p>I've tried to keep "Seq" in the name for synthetic sequences of instruction, can you put it as a suffix here please?</p>
</blockquote>



<a name="207536409"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232149%20This%20patch%20fills%20in%20the%20missing%20piece.../near/207536409" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232149.20This.20patch.20fills.20in.20the.20missing.20piece.2E.2E.2E.html#207536409">(Aug 20 2020 at 15:33)</a>:</h4>
<p>bnjbvr created <a href="https://github.com/bytecodealliance/wasmtime/pull/2149#discussion_r474069280">PR Review Comment</a>:</p>
<blockquote>
<p>nit: here and below, <code>"mfence".to_string()</code></p>
</blockquote>



<a name="207536410"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232149%20This%20patch%20fills%20in%20the%20missing%20piece.../near/207536410" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232149.20This.20patch.20fills.20in.20the.20missing.20piece.2E.2E.2E.html#207536410">(Aug 20 2020 at 15:33)</a>:</h4>
<p>bnjbvr created <a href="https://github.com/bytecodealliance/wasmtime/pull/2149#discussion_r474070634">PR Review Comment</a>:</p>
<blockquote>
<p>nit: expand insn</p>
</blockquote>



<a name="207536412"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232149%20This%20patch%20fills%20in%20the%20missing%20piece.../near/207536412" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232149.20This.20patch.20fills.20in.20the.20missing.20piece.2E.2E.2E.html#207536412">(Aug 20 2020 at 15:33)</a>:</h4>
<p>bnjbvr created <a href="https://github.com/bytecodealliance/wasmtime/pull/2149#discussion_r474067477">PR Review Comment</a>:</p>
<blockquote>
<p>nit: can you expand <code>mod</code> too?</p>
</blockquote>



<a name="207536413"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232149%20This%20patch%20fills%20in%20the%20missing%20piece.../near/207536413" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232149.20This.20patch.20fills.20in.20the.20missing.20piece.2E.2E.2E.html#207536413">(Aug 20 2020 at 15:33)</a>:</h4>
<p>bnjbvr created <a href="https://github.com/bytecodealliance/wasmtime/pull/2149#discussion_r474068782">PR Review Comment</a>:</p>
<blockquote>
<p>nit: expand instruction</p>
</blockquote>



<a name="207537372"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232149%20This%20patch%20fills%20in%20the%20missing%20piece.../near/207537372" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232149.20This.20patch.20fills.20in.20the.20missing.20piece.2E.2E.2E.html#207537372">(Aug 20 2020 at 15:41)</a>:</h4>
<p>julian-seward1 submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/2149#pullrequestreview-471746361">PR Review</a>.</p>



<a name="207537373"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232149%20This%20patch%20fills%20in%20the%20missing%20piece.../near/207537373" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232149.20This.20patch.20fills.20in.20the.20missing.20piece.2E.2E.2E.html#207537373">(Aug 20 2020 at 15:41)</a>:</h4>
<p>julian-seward1 created <a href="https://github.com/bytecodealliance/wasmtime/pull/2149#discussion_r474082991">PR Review Comment</a>:</p>
<blockquote>
<p>Well those names are what Intel calls them: <code>mfence</code>, <code>sfence</code> and <code>lfence</code>.  I could expand them to what Intel describes them as: Memory Fence, Store Fence and Load Fence respectively.  Or maybe I should just add comments on the enum?</p>
</blockquote>



<a name="207537470"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232149%20This%20patch%20fills%20in%20the%20missing%20piece.../near/207537470" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232149.20This.20patch.20fills.20in.20the.20missing.20piece.2E.2E.2E.html#207537470">(Aug 20 2020 at 15:42)</a>:</h4>
<p>julian-seward1 submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/2149#pullrequestreview-471746948">PR Review</a>.</p>



<a name="207537471"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232149%20This%20patch%20fills%20in%20the%20missing%20piece.../near/207537471" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232149.20This.20patch.20fills.20in.20the.20missing.20piece.2E.2E.2E.html#207537471">(Aug 20 2020 at 15:42)</a>:</h4>
<p>julian-seward1 created <a href="https://github.com/bytecodealliance/wasmtime/pull/2149#discussion_r474083444">PR Review Comment</a>:</p>
<blockquote>
<p>Yeah, I just spotted that.</p>
</blockquote>



<a name="207583906"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232149%20This%20patch%20fills%20in%20the%20missing%20piece.../near/207583906" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232149.20This.20patch.20fills.20in.20the.20missing.20piece.2E.2E.2E.html#207583906">(Aug 20 2020 at 22:54)</a>:</h4>
<p>abrown submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/2149#pullrequestreview-472037979">PR Review</a>.</p>



<a name="207583907"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232149%20This%20patch%20fills%20in%20the%20missing%20piece.../near/207583907" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232149.20This.20patch.20fills.20in.20the.20missing.20piece.2E.2E.2E.html#207583907">(Aug 20 2020 at 22:54)</a>:</h4>
<p>abrown created <a href="https://github.com/bytecodealliance/wasmtime/pull/2149#discussion_r474315303">PR Review Comment</a>:</p>
<blockquote>
<p>Should be in <code>main</code> now.</p>
</blockquote>



<a name="207611738"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232149%20This%20patch%20fills%20in%20the%20missing%20piece.../near/207611738" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232149.20This.20patch.20fills.20in.20the.20missing.20piece.2E.2E.2E.html#207611738">(Aug 21 2020 at 08:48)</a>:</h4>
<p>julian-seward1 submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/2149#pullrequestreview-472315539">PR Review</a>.</p>



<a name="207611739"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232149%20This%20patch%20fills%20in%20the%20missing%20piece.../near/207611739" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232149.20This.20patch.20fills.20in.20the.20missing.20piece.2E.2E.2E.html#207611739">(Aug 21 2020 at 08:48)</a>:</h4>
<p>julian-seward1 created <a href="https://github.com/bytecodealliance/wasmtime/pull/2149#discussion_r474537969">PR Review Comment</a>:</p>
<blockquote>
<p>Done.  Although the result is actually longer:</p>
<div class="codehilite"><pre><span></span><code><span class="w">            </span><span class="kd">let</span><span class="w"> </span><span class="n">i3</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="n">op</span><span class="w"> </span><span class="o">==</span><span class="w">  </span><span class="n">AtomicRMWOp</span>::<span class="n">Xchg</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">                </span><span class="n">AtomicRMWOp</span>::<span class="n">Xchg</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="n">Inst</span>::<span class="n">mov_r_r</span><span class="p">(</span><span class="kc">true</span><span class="p">,</span><span class="w"> </span><span class="n">r10</span><span class="p">,</span><span class="w"> </span><span class="n">r11_w</span><span class="p">),</span><span class="w"></span>
<span class="w">            </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">                </span><span class="kd">let</span><span class="w"> </span><span class="n">alu_op</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">match</span><span class="w"> </span><span class="n">op</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">                    </span><span class="n">AtomicRMWOp</span>::<span class="n">Add</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="n">AluRmiROpcode</span>::<span class="n">Add</span><span class="p">,</span><span class="w"></span>
<span class="w">                    </span><span class="n">AtomicRMWOp</span>::<span class="n">Sub</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="n">AluRmiROpcode</span>::<span class="n">Sub</span><span class="p">,</span><span class="w"></span>
<span class="w">                    </span><span class="n">AtomicRMWOp</span>::<span class="n">And</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="n">AluRmiROpcode</span>::<span class="n">And</span><span class="p">,</span><span class="w"></span>
<span class="w">                    </span><span class="n">AtomicRMWOp</span>::<span class="n">Or</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="n">AluRmiROpcode</span>::<span class="n">Or</span><span class="p">,</span><span class="w"></span>
<span class="w">                    </span><span class="n">AtomicRMWOp</span>::<span class="n">Xor</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="n">AluRmiROpcode</span>::<span class="n">Xor</span><span class="p">,</span><span class="w"></span>
<span class="w">                    </span><span class="n">AtomicRMWOp</span>::<span class="n">Xchg</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="n">unreachable</span><span class="o">!</span><span class="p">(),</span><span class="w"></span>
<span class="w">                </span><span class="p">}</span><span class="w"></span>
<span class="w">                </span><span class="n">Inst</span>::<span class="n">alu_rmi_r</span><span class="p">(</span><span class="kc">true</span><span class="p">,</span><span class="w"> </span><span class="n">alu_op</span><span class="p">,</span><span class="w"> </span><span class="n">r10_rmi</span><span class="p">,</span><span class="w"> </span><span class="n">r11_w</span><span class="p">)</span><span class="w"></span>
<span class="w">            </span><span class="p">};</span><span class="w"></span>
</code></pre></div>


<p>I tend to assume that rustc/LLVM will do tail-merging and hence cause all the duplication to disappear in the final machine code.  I don't know that that's true, though.</p>
</blockquote>



<a name="207611886"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232149%20This%20patch%20fills%20in%20the%20missing%20piece.../near/207611886" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232149.20This.20patch.20fills.20in.20the.20missing.20piece.2E.2E.2E.html#207611886">(Aug 21 2020 at 08:51)</a>:</h4>
<p>julian-seward1 created <a href="https://github.com/bytecodealliance/wasmtime/pull/2149#discussion_r474540442">PR Review Comment</a>:</p>
<blockquote>
<p>Read; I fixed all of these, and the wr and mod too.</p>
</blockquote>



<a name="207611887"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232149%20This%20patch%20fills%20in%20the%20missing%20piece.../near/207611887" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232149.20This.20patch.20fills.20in.20the.20missing.20piece.2E.2E.2E.html#207611887">(Aug 21 2020 at 08:51)</a>:</h4>
<p>julian-seward1 submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/2149#pullrequestreview-472317772">PR Review</a>.</p>



<a name="207613107"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232149%20This%20patch%20fills%20in%20the%20missing%20piece.../near/207613107" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232149.20This.20patch.20fills.20in.20the.20missing.20piece.2E.2E.2E.html#207613107">(Aug 21 2020 at 09:06)</a>:</h4>
<p>julian-seward1 edited <a href="https://github.com/bytecodealliance/wasmtime/pull/2149#discussion_r474537969">PR Review Comment</a>.</p>



<a name="207614513"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232149%20This%20patch%20fills%20in%20the%20missing%20piece.../near/207614513" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232149.20This.20patch.20fills.20in.20the.20missing.20piece.2E.2E.2E.html#207614513">(Aug 21 2020 at 09:27)</a>:</h4>
<p>julian-seward1 submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/2149#pullrequestreview-472341962">PR Review</a>.</p>



<a name="207614514"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232149%20This%20patch%20fills%20in%20the%20missing%20piece.../near/207614514" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232149.20This.20patch.20fills.20in.20the.20missing.20piece.2E.2E.2E.html#207614514">(Aug 21 2020 at 09:27)</a>:</h4>
<p>julian-seward1 created <a href="https://github.com/bytecodealliance/wasmtime/pull/2149#discussion_r474573321">PR Review Comment</a>:</p>
<blockquote>
<p>Filed as PR #2153.</p>
</blockquote>



<a name="207618207"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232149%20This%20patch%20fills%20in%20the%20missing%20piece.../near/207618207" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232149.20This.20patch.20fills.20in.20the.20missing.20piece.2E.2E.2E.html#207618207">(Aug 21 2020 at 10:07)</a>:</h4>
<p>julian-seward1 submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/2149#pullrequestreview-472368832">PR Review</a>.</p>



<a name="207618208"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232149%20This%20patch%20fills%20in%20the%20missing%20piece.../near/207618208" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232149.20This.20patch.20fills.20in.20the.20missing.20piece.2E.2E.2E.html#207618208">(Aug 21 2020 at 10:07)</a>:</h4>
<p>julian-seward1 created <a href="https://github.com/bytecodealliance/wasmtime/pull/2149#discussion_r474603941">PR Review Comment</a>:</p>
<blockquote>
<p>I moved it into a new file <code>src/machinst/inst_common.rs</code>.</p>
</blockquote>



<a name="207619196"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232149%20This%20patch%20fills%20in%20the%20missing%20piece.../near/207619196" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232149.20This.20patch.20fills.20in.20the.20missing.20piece.2E.2E.2E.html#207619196">(Aug 21 2020 at 10:20)</a>:</h4>
<p>julian-seward1 updated <a href="https://github.com/bytecodealliance/wasmtime/pull/2149">PR #2149</a> from <code>atomics-x64-CL</code> to <code>main</code>:</p>
<blockquote>
<p>… on newBE/x64.  It does</p>
<p>this by providing an implementation of the CLIF instructions <code>AtomicRmw</code>, <code>AtomicCas</code>,<br>
<code>AtomicLoad</code>, <code>AtomicStore</code> and <code>Fence</code>.</p>
<p>The translation is straightforward.  <code>AtomicCas</code> is translated into x64 <code>cmpxchg</code>, <code>AtomicLoad</code><br>
becomes a normal load because x64-TSO provides adequate sequencing, <code>AtomicStore</code> becomes a<br>
normal store followed by <code>mfence</code>, and <code>Fence</code> becomes <code>mfence</code>.  <code>AtomicRmw</code> is the only<br>
complex case: it becomes a normal load, followed by a loop which computes an updated value,<br>
tries to <code>cmpxchg</code> it back to memory, and repeats if necessary.</p>
<p>This is a minimum-effort initial implementation.  <code>AtomicRmw</code> could be implemented more<br>
efficiently using LOCK-prefixed integer read-modify-write instructions in the case where the old<br>
value in memory is not required.  Subsequent work could add that, if required.</p>
<p>The x64 emitter has been updated to emit the new instructions, obviously.  The <code>LegacyPrefix</code><br>
mechanism has been revised to handle multiple prefix bytes, not just one, since it is now<br>
sometimes necessary to emit both 0x66 (Operand Size Override) and F0 (Lock).</p>
<p>In the aarch64 implementation of atomics, there has been some minor renaming for the sake of<br>
clarity, and for consistency with this x64 implementation.</p>
<p>&lt;!--</p>
<p>Please ensure that the following steps are all taken care of before submitting<br>
the PR.</p>
<ul>
<li>
<p>[ ] This has been discussed in issue #..., or if not, please tell us why<br>
  here.</p>
</li>
<li>
<p>[ ] A short description of what this does, why it is needed; if the<br>
  description becomes long, the matter should probably be discussed in an issue<br>
  first.</p>
</li>
<li>
<p>[ ] This PR contains test cases, if meaningful.</p>
</li>
<li>[ ] A reviewer from the core maintainer team has been assigned for this PR.<br>
  If you don't know who could review this, please indicate so. The list of<br>
  suggested reviewers on the right can help you.</li>
</ul>
<p>Please ensure all communication adheres to the <a href="https://github.com/bytecodealliance/wasmtime/blob/master/CODE_OF_CONDUCT.md">code of
conduct</a>.<br>
--&gt;</p>
</blockquote>



<a name="207619347"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232149%20This%20patch%20fills%20in%20the%20missing%20piece.../near/207619347" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232149.20This.20patch.20fills.20in.20the.20missing.20piece.2E.2E.2E.html#207619347">(Aug 21 2020 at 10:23)</a>:</h4>
<p>julian-seward1 updated <a href="https://github.com/bytecodealliance/wasmtime/pull/2149">PR #2149</a> from <code>atomics-x64-CL</code> to <code>main</code>:</p>
<blockquote>
<p>… on newBE/x64.  It does</p>
<p>this by providing an implementation of the CLIF instructions <code>AtomicRmw</code>, <code>AtomicCas</code>,<br>
<code>AtomicLoad</code>, <code>AtomicStore</code> and <code>Fence</code>.</p>
<p>The translation is straightforward.  <code>AtomicCas</code> is translated into x64 <code>cmpxchg</code>, <code>AtomicLoad</code><br>
becomes a normal load because x64-TSO provides adequate sequencing, <code>AtomicStore</code> becomes a<br>
normal store followed by <code>mfence</code>, and <code>Fence</code> becomes <code>mfence</code>.  <code>AtomicRmw</code> is the only<br>
complex case: it becomes a normal load, followed by a loop which computes an updated value,<br>
tries to <code>cmpxchg</code> it back to memory, and repeats if necessary.</p>
<p>This is a minimum-effort initial implementation.  <code>AtomicRmw</code> could be implemented more<br>
efficiently using LOCK-prefixed integer read-modify-write instructions in the case where the old<br>
value in memory is not required.  Subsequent work could add that, if required.</p>
<p>The x64 emitter has been updated to emit the new instructions, obviously.  The <code>LegacyPrefix</code><br>
mechanism has been revised to handle multiple prefix bytes, not just one, since it is now<br>
sometimes necessary to emit both 0x66 (Operand Size Override) and F0 (Lock).</p>
<p>In the aarch64 implementation of atomics, there has been some minor renaming for the sake of<br>
clarity, and for consistency with this x64 implementation.</p>
<p>&lt;!--</p>
<p>Please ensure that the following steps are all taken care of before submitting<br>
the PR.</p>
<ul>
<li>
<p>[ ] This has been discussed in issue #..., or if not, please tell us why<br>
  here.</p>
</li>
<li>
<p>[ ] A short description of what this does, why it is needed; if the<br>
  description becomes long, the matter should probably be discussed in an issue<br>
  first.</p>
</li>
<li>
<p>[ ] This PR contains test cases, if meaningful.</p>
</li>
<li>[ ] A reviewer from the core maintainer team has been assigned for this PR.<br>
  If you don't know who could review this, please indicate so. The list of<br>
  suggested reviewers on the right can help you.</li>
</ul>
<p>Please ensure all communication adheres to the <a href="https://github.com/bytecodealliance/wasmtime/blob/master/CODE_OF_CONDUCT.md">code of
conduct</a>.<br>
--&gt;</p>
</blockquote>



<a name="207621022"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232149%20This%20patch%20fills%20in%20the%20missing%20piece.../near/207621022" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232149.20This.20patch.20fills.20in.20the.20missing.20piece.2E.2E.2E.html#207621022">(Aug 21 2020 at 10:48)</a>:</h4>
<p>julian-seward1 submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/2149#pullrequestreview-472392362">PR Review</a>.</p>



<a name="207621023"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232149%20This%20patch%20fills%20in%20the%20missing%20piece.../near/207621023" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232149.20This.20patch.20fills.20in.20the.20missing.20piece.2E.2E.2E.html#207621023">(Aug 21 2020 at 10:48)</a>:</h4>
<p>julian-seward1 created <a href="https://github.com/bytecodealliance/wasmtime/pull/2149#discussion_r474622411">PR Review Comment</a>:</p>
<blockquote>
<p>Done.</p>
</blockquote>



<a name="207621154"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232149%20This%20patch%20fills%20in%20the%20missing%20piece.../near/207621154" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232149.20This.20patch.20fills.20in.20the.20missing.20piece.2E.2E.2E.html#207621154">(Aug 21 2020 at 10:50)</a>:</h4>
<p>julian-seward1 updated <a href="https://github.com/bytecodealliance/wasmtime/pull/2149">PR #2149</a> from <code>atomics-x64-CL</code> to <code>main</code>:</p>
<blockquote>
<p>… on newBE/x64.  It does</p>
<p>this by providing an implementation of the CLIF instructions <code>AtomicRmw</code>, <code>AtomicCas</code>,<br>
<code>AtomicLoad</code>, <code>AtomicStore</code> and <code>Fence</code>.</p>
<p>The translation is straightforward.  <code>AtomicCas</code> is translated into x64 <code>cmpxchg</code>, <code>AtomicLoad</code><br>
becomes a normal load because x64-TSO provides adequate sequencing, <code>AtomicStore</code> becomes a<br>
normal store followed by <code>mfence</code>, and <code>Fence</code> becomes <code>mfence</code>.  <code>AtomicRmw</code> is the only<br>
complex case: it becomes a normal load, followed by a loop which computes an updated value,<br>
tries to <code>cmpxchg</code> it back to memory, and repeats if necessary.</p>
<p>This is a minimum-effort initial implementation.  <code>AtomicRmw</code> could be implemented more<br>
efficiently using LOCK-prefixed integer read-modify-write instructions in the case where the old<br>
value in memory is not required.  Subsequent work could add that, if required.</p>
<p>The x64 emitter has been updated to emit the new instructions, obviously.  The <code>LegacyPrefix</code><br>
mechanism has been revised to handle multiple prefix bytes, not just one, since it is now<br>
sometimes necessary to emit both 0x66 (Operand Size Override) and F0 (Lock).</p>
<p>In the aarch64 implementation of atomics, there has been some minor renaming for the sake of<br>
clarity, and for consistency with this x64 implementation.</p>
<p>&lt;!--</p>
<p>Please ensure that the following steps are all taken care of before submitting<br>
the PR.</p>
<ul>
<li>
<p>[ ] This has been discussed in issue #..., or if not, please tell us why<br>
  here.</p>
</li>
<li>
<p>[ ] A short description of what this does, why it is needed; if the<br>
  description becomes long, the matter should probably be discussed in an issue<br>
  first.</p>
</li>
<li>
<p>[ ] This PR contains test cases, if meaningful.</p>
</li>
<li>[ ] A reviewer from the core maintainer team has been assigned for this PR.<br>
  If you don't know who could review this, please indicate so. The list of<br>
  suggested reviewers on the right can help you.</li>
</ul>
<p>Please ensure all communication adheres to the <a href="https://github.com/bytecodealliance/wasmtime/blob/master/CODE_OF_CONDUCT.md">code of
conduct</a>.<br>
--&gt;</p>
</blockquote>



<a name="207621857"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232149%20This%20patch%20fills%20in%20the%20missing%20piece.../near/207621857" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232149.20This.20patch.20fills.20in.20the.20missing.20piece.2E.2E.2E.html#207621857">(Aug 21 2020 at 11:00)</a>:</h4>
<p>julian-seward1 updated <a href="https://github.com/bytecodealliance/wasmtime/pull/2149">PR #2149</a> from <code>atomics-x64-CL</code> to <code>main</code>:</p>
<blockquote>
<p>… on newBE/x64.  It does</p>
<p>this by providing an implementation of the CLIF instructions <code>AtomicRmw</code>, <code>AtomicCas</code>,<br>
<code>AtomicLoad</code>, <code>AtomicStore</code> and <code>Fence</code>.</p>
<p>The translation is straightforward.  <code>AtomicCas</code> is translated into x64 <code>cmpxchg</code>, <code>AtomicLoad</code><br>
becomes a normal load because x64-TSO provides adequate sequencing, <code>AtomicStore</code> becomes a<br>
normal store followed by <code>mfence</code>, and <code>Fence</code> becomes <code>mfence</code>.  <code>AtomicRmw</code> is the only<br>
complex case: it becomes a normal load, followed by a loop which computes an updated value,<br>
tries to <code>cmpxchg</code> it back to memory, and repeats if necessary.</p>
<p>This is a minimum-effort initial implementation.  <code>AtomicRmw</code> could be implemented more<br>
efficiently using LOCK-prefixed integer read-modify-write instructions in the case where the old<br>
value in memory is not required.  Subsequent work could add that, if required.</p>
<p>The x64 emitter has been updated to emit the new instructions, obviously.  The <code>LegacyPrefix</code><br>
mechanism has been revised to handle multiple prefix bytes, not just one, since it is now<br>
sometimes necessary to emit both 0x66 (Operand Size Override) and F0 (Lock).</p>
<p>In the aarch64 implementation of atomics, there has been some minor renaming for the sake of<br>
clarity, and for consistency with this x64 implementation.</p>
<p>&lt;!--</p>
<p>Please ensure that the following steps are all taken care of before submitting<br>
the PR.</p>
<ul>
<li>
<p>[ ] This has been discussed in issue #..., or if not, please tell us why<br>
  here.</p>
</li>
<li>
<p>[ ] A short description of what this does, why it is needed; if the<br>
  description becomes long, the matter should probably be discussed in an issue<br>
  first.</p>
</li>
<li>
<p>[ ] This PR contains test cases, if meaningful.</p>
</li>
<li>[ ] A reviewer from the core maintainer team has been assigned for this PR.<br>
  If you don't know who could review this, please indicate so. The list of<br>
  suggested reviewers on the right can help you.</li>
</ul>
<p>Please ensure all communication adheres to the <a href="https://github.com/bytecodealliance/wasmtime/blob/master/CODE_OF_CONDUCT.md">code of
conduct</a>.<br>
--&gt;</p>
</blockquote>



<a name="207625830"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232149%20This%20patch%20fills%20in%20the%20missing%20piece.../near/207625830" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232149.20This.20patch.20fills.20in.20the.20missing.20piece.2E.2E.2E.html#207625830">(Aug 21 2020 at 12:00)</a>:</h4>
<p><strong>julian-seward1</strong> requested <a href="https://github.com/bnjbvr">bnjbvr</a> for a review on <a href="https://github.com/bytecodealliance/wasmtime/pull/2149">PR #2149</a>.</p>



<a name="207642595"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232149%20This%20patch%20fills%20in%20the%20missing%20piece.../near/207642595" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232149.20This.20patch.20fills.20in.20the.20missing.20piece.2E.2E.2E.html#207642595">(Aug 21 2020 at 14:46)</a>:</h4>
<p>bnjbvr submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/2149#pullrequestreview-472528857">PR Review</a>.</p>



<a name="207642596"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232149%20This%20patch%20fills%20in%20the%20missing%20piece.../near/207642596" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232149.20This.20patch.20fills.20in.20the.20missing.20piece.2E.2E.2E.html#207642596">(Aug 21 2020 at 14:46)</a>:</h4>
<p>bnjbvr submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/2149#pullrequestreview-472528857">PR Review</a>.</p>



<a name="207642597"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232149%20This%20patch%20fills%20in%20the%20missing%20piece.../near/207642597" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232149.20This.20patch.20fills.20in.20the.20missing.20piece.2E.2E.2E.html#207642597">(Aug 21 2020 at 14:46)</a>:</h4>
<p>bnjbvr created <a href="https://github.com/bytecodealliance/wasmtime/pull/2149#discussion_r474736622">PR Review Comment</a>:</p>
<blockquote>
<p>With the approach suggested above for Xchg, we could spare the r10 register here, alleviating register pressure.</p>
</blockquote>



<a name="207642598"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232149%20This%20patch%20fills%20in%20the%20missing%20piece.../near/207642598" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232149.20This.20patch.20fills.20in.20the.20missing.20piece.2E.2E.2E.html#207642598">(Aug 21 2020 at 14:46)</a>:</h4>
<p>bnjbvr created <a href="https://github.com/bytecodealliance/wasmtime/pull/2149#discussion_r474727147">PR Review Comment</a>:</p>
<blockquote>
<p>nit: please make this a doc comment <code>///</code></p>
</blockquote>



<a name="207642599"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232149%20This%20patch%20fills%20in%20the%20missing%20piece.../near/207642599" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232149.20This.20patch.20fills.20in.20the.20missing.20piece.2E.2E.2E.html#207642599">(Aug 21 2020 at 14:46)</a>:</h4>
<p>bnjbvr created <a href="https://github.com/bytecodealliance/wasmtime/pull/2149#discussion_r474731961">PR Review Comment</a>:</p>
<blockquote>
<p>Could we not emit it when the opcode is Xchg? (That is, push it down within the <code>else</code> branch below)<br>
Or even better, it seems all the moves could be avoided in the case of Xchg, since <code>r10</code> could be passed as the read-only input of the <code>cmpxchg</code> instruction? (I know x86 chips eats moves for dinner, but seems better to not do any useless decoding work if we can avoid it!)</p>
</blockquote>



<a name="207642600"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232149%20This%20patch%20fills%20in%20the%20missing%20piece.../near/207642600" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232149.20This.20patch.20fills.20in.20the.20missing.20piece.2E.2E.2E.html#207642600">(Aug 21 2020 at 14:46)</a>:</h4>
<p>bnjbvr created <a href="https://github.com/bytecodealliance/wasmtime/pull/2149#discussion_r474740493">PR Review Comment</a>:</p>
<blockquote>
<p>Just an idea: if it's generating the same thing as a load, could the lowering be commonized with the rest of the <code>Load</code>-related instructions?</p>
</blockquote>



<a name="207642601"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232149%20This%20patch%20fills%20in%20the%20missing%20piece.../near/207642601" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232149.20This.20patch.20fills.20in.20the.20missing.20piece.2E.2E.2E.html#207642601">(Aug 21 2020 at 14:46)</a>:</h4>
<p>bnjbvr created <a href="https://github.com/bytecodealliance/wasmtime/pull/2149#discussion_r474737453">PR Review Comment</a>:</p>
<blockquote>
<p>I sympathize with the need to fix this comment, but I think this one is a bit imprecise too: can you write <code>any virtual regs</code> instead of just <code>any regs</code>?</p>
</blockquote>



<a name="207642602"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232149%20This%20patch%20fills%20in%20the%20missing%20piece.../near/207642602" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232149.20This.20patch.20fills.20in.20the.20missing.20piece.2E.2E.2E.html#207642602">(Aug 21 2020 at 14:46)</a>:</h4>
<p>bnjbvr created <a href="https://github.com/bytecodealliance/wasmtime/pull/2149#discussion_r474740927">PR Review Comment</a>:</p>
<blockquote>
<p>Here, you can use <code>let rm = input_to_reg_mem(ctx, inputs[0]);</code> here, and remove the comment about using 0(addr).</p>
</blockquote>



<a name="207642603"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232149%20This%20patch%20fills%20in%20the%20missing%20piece.../near/207642603" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232149.20This.20patch.20fills.20in.20the.20missing.20piece.2E.2E.2E.html#207642603">(Aug 21 2020 at 14:46)</a>:</h4>
<p>bnjbvr created <a href="https://github.com/bytecodealliance/wasmtime/pull/2149#discussion_r474741304">PR Review Comment</a>:</p>
<blockquote>
<p>I think you'll be able to use <code>lower_to_amode</code> once #2146 lands; if you happen to land before this, can you add a TODO in my PR please?</p>
</blockquote>



<a name="207642604"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232149%20This%20patch%20fills%20in%20the%20missing%20piece.../near/207642604" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232149.20This.20patch.20fills.20in.20the.20missing.20piece.2E.2E.2E.html#207642604">(Aug 21 2020 at 14:46)</a>:</h4>
<p>bnjbvr created <a href="https://github.com/bytecodealliance/wasmtime/pull/2149#discussion_r474742003">PR Review Comment</a>:</p>
<blockquote>
<p>ditto for <code>lower_to_amode</code></p>
</blockquote>



<a name="207642605"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232149%20This%20patch%20fills%20in%20the%20missing%20piece.../near/207642605" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232149.20This.20patch.20fills.20in.20the.20missing.20piece.2E.2E.2E.html#207642605">(Aug 21 2020 at 14:46)</a>:</h4>
<p>bnjbvr created <a href="https://github.com/bytecodealliance/wasmtime/pull/2149#discussion_r474744328">PR Review Comment</a>:</p>
<blockquote>
<p>nit: can you use the usual rust camelCasing: <code>AtomicRmwOp</code> please?</p>
</blockquote>



<a name="207814892"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232149%20This%20patch%20fills%20in%20the%20missing%20piece.../near/207814892" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232149.20This.20patch.20fills.20in.20the.20missing.20piece.2E.2E.2E.html#207814892">(Aug 24 2020 at 07:41)</a>:</h4>
<p>julian-seward1 submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/2149#pullrequestreview-473190230">PR Review</a>.</p>



<a name="207814893"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232149%20This%20patch%20fills%20in%20the%20missing%20piece.../near/207814893" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232149.20This.20patch.20fills.20in.20the.20missing.20piece.2E.2E.2E.html#207814893">(Aug 24 2020 at 07:41)</a>:</h4>
<p>julian-seward1 created <a href="https://github.com/bytecodealliance/wasmtime/pull/2149#discussion_r475400244">PR Review Comment</a>:</p>
<blockquote>
<p>Well, probably yes; but I'd prefer to keep it separate as it logically belongs to the atomics group.  Also there is an atomics-specific assertion and atomics-specific comments there.</p>
</blockquote>



<a name="207815031"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232149%20This%20patch%20fills%20in%20the%20missing%20piece.../near/207815031" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232149.20This.20patch.20fills.20in.20the.20missing.20piece.2E.2E.2E.html#207815031">(Aug 24 2020 at 07:43)</a>:</h4>
<p>julian-seward1 submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/2149#pullrequestreview-473191616">PR Review</a>.</p>



<a name="207815032"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232149%20This%20patch%20fills%20in%20the%20missing%20piece.../near/207815032" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232149.20This.20patch.20fills.20in.20the.20missing.20piece.2E.2E.2E.html#207815032">(Aug 24 2020 at 07:43)</a>:</h4>
<p>julian-seward1 created <a href="https://github.com/bytecodealliance/wasmtime/pull/2149#discussion_r475401312">PR Review Comment</a>:</p>
<blockquote>
<p>We could do that.  I'd prefer to leave such improvements to the followup PR #2153 though.  Also, it could be possibly fixed even better, by using <code>lock xchg ..</code> in this case.  That's definitely PR #2153 territory, though.</p>
</blockquote>



<a name="207815653"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232149%20This%20patch%20fills%20in%20the%20missing%20piece.../near/207815653" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232149.20This.20patch.20fills.20in.20the.20missing.20piece.2E.2E.2E.html#207815653">(Aug 24 2020 at 07:53)</a>:</h4>
<p>julian-seward1 created <a href="https://github.com/bytecodealliance/wasmtime/pull/2149#discussion_r475406679">PR Review Comment</a>:</p>
<blockquote>
<p>That doesn't work.  It produces <code>movzbq  %v5Jb, %v6J</code>, but the original was <code>movzbq 0(%v5J), %v6J</code>.</p>
</blockquote>



<a name="207815654"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232149%20This%20patch%20fills%20in%20the%20missing%20piece.../near/207815654" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232149.20This.20patch.20fills.20in.20the.20missing.20piece.2E.2E.2E.html#207815654">(Aug 24 2020 at 07:53)</a>:</h4>
<p>julian-seward1 submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/2149#pullrequestreview-473198177">PR Review</a>.</p>



<a name="207816006"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232149%20This%20patch%20fills%20in%20the%20missing%20piece.../near/207816006" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232149.20This.20patch.20fills.20in.20the.20missing.20piece.2E.2E.2E.html#207816006">(Aug 24 2020 at 07:58)</a>:</h4>
<p>bjorn3 submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/2149#pullrequestreview-473201715">PR Review</a>.</p>



<a name="207816007"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232149%20This%20patch%20fills%20in%20the%20missing%20piece.../near/207816007" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232149.20This.20patch.20fills.20in.20the.20missing.20piece.2E.2E.2E.html#207816007">(Aug 24 2020 at 07:58)</a>:</h4>
<p>bjorn3 created <a href="https://github.com/bytecodealliance/wasmtime/pull/2149#discussion_r475409627">PR Review Comment</a>:</p>
<blockquote>
<p><code>lock xchg</code> is equivalent to <code>xchg</code>: <a href="https://stackoverflow.com/questions/3144335/on-a-multicore-x86-is-a-lock-necessary-as-a-prefix-to-xchg">https://stackoverflow.com/questions/3144335/on-a-multicore-x86-is-a-lock-necessary-as-a-prefix-to-xchg</a></p>
</blockquote>



<a name="207821137"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232149%20This%20patch%20fills%20in%20the%20missing%20piece.../near/207821137" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232149.20This.20patch.20fills.20in.20the.20missing.20piece.2E.2E.2E.html#207821137">(Aug 24 2020 at 09:02)</a>:</h4>
<p>julian-seward1 updated <a href="https://github.com/bytecodealliance/wasmtime/pull/2149">PR #2149</a> from <code>atomics-x64-CL</code> to <code>main</code>:</p>
<blockquote>
<p>… on newBE/x64.  It does</p>
<p>this by providing an implementation of the CLIF instructions <code>AtomicRmw</code>, <code>AtomicCas</code>,<br>
<code>AtomicLoad</code>, <code>AtomicStore</code> and <code>Fence</code>.</p>
<p>The translation is straightforward.  <code>AtomicCas</code> is translated into x64 <code>cmpxchg</code>, <code>AtomicLoad</code><br>
becomes a normal load because x64-TSO provides adequate sequencing, <code>AtomicStore</code> becomes a<br>
normal store followed by <code>mfence</code>, and <code>Fence</code> becomes <code>mfence</code>.  <code>AtomicRmw</code> is the only<br>
complex case: it becomes a normal load, followed by a loop which computes an updated value,<br>
tries to <code>cmpxchg</code> it back to memory, and repeats if necessary.</p>
<p>This is a minimum-effort initial implementation.  <code>AtomicRmw</code> could be implemented more<br>
efficiently using LOCK-prefixed integer read-modify-write instructions in the case where the old<br>
value in memory is not required.  Subsequent work could add that, if required.</p>
<p>The x64 emitter has been updated to emit the new instructions, obviously.  The <code>LegacyPrefix</code><br>
mechanism has been revised to handle multiple prefix bytes, not just one, since it is now<br>
sometimes necessary to emit both 0x66 (Operand Size Override) and F0 (Lock).</p>
<p>In the aarch64 implementation of atomics, there has been some minor renaming for the sake of<br>
clarity, and for consistency with this x64 implementation.</p>
<p>&lt;!--</p>
<p>Please ensure that the following steps are all taken care of before submitting<br>
the PR.</p>
<ul>
<li>
<p>[ ] This has been discussed in issue #..., or if not, please tell us why<br>
  here.</p>
</li>
<li>
<p>[ ] A short description of what this does, why it is needed; if the<br>
  description becomes long, the matter should probably be discussed in an issue<br>
  first.</p>
</li>
<li>
<p>[ ] This PR contains test cases, if meaningful.</p>
</li>
<li>[ ] A reviewer from the core maintainer team has been assigned for this PR.<br>
  If you don't know who could review this, please indicate so. The list of<br>
  suggested reviewers on the right can help you.</li>
</ul>
<p>Please ensure all communication adheres to the <a href="https://github.com/bytecodealliance/wasmtime/blob/master/CODE_OF_CONDUCT.md">code of
conduct</a>.<br>
--&gt;</p>
</blockquote>



<a name="207825019"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232149%20This%20patch%20fills%20in%20the%20missing%20piece.../near/207825019" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232149.20This.20patch.20fills.20in.20the.20missing.20piece.2E.2E.2E.html#207825019">(Aug 24 2020 at 09:50)</a>:</h4>
<p>julian-seward1 merged <a href="https://github.com/bytecodealliance/wasmtime/pull/2149">PR #2149</a>.</p>



<hr><p>Last updated: Jan 20 2025 at 06:04 UTC</p>
</html>