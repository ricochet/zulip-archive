<html>
<head><meta charset="utf-8"><title>wasmtime / Issue #2022 peepmatic: Add bnot operation + op... · git-wasmtime · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/index.html">git-wasmtime</a></h2>
<h3>Topic: <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20Issue.20.232022.20peepmatic.3A.20Add.20bnot.20operation.20.2B.20op.2E.2E.2E.html">wasmtime / Issue #2022 peepmatic: Add bnot operation + op...</a></h3>

<hr>

<base href="https://bytecodealliance.zulipchat.com">

<head><link href="https://bytecodealliance.github.io/zulip-archive/style.css" rel="stylesheet"></head>

<a name="203942119"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20Issue%20%232022%20peepmatic%3A%20Add%20bnot%20operation%20%2B%20op.../near/203942119" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20Issue.20.232022.20peepmatic.3A.20Add.20bnot.20operation.20.2B.20op.2E.2E.2E.html#203942119">(Jul 15 2020 at 11:18)</a>:</h4>
<p>github-actions[bot] <a href="https://github.com/bytecodealliance/wasmtime/pull/2022#issuecomment-658710005">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/2022">Issue #2022</a>:</p>
<blockquote>
<h4>Subscribe to Label Action</h4>
<p>cc @bnjbvr, @fitzgen</p>
<p>&lt;details&gt;<br>
This issue or pull request has been labeled: "cranelift", "cranelift:area:peepmatic"</p>
<p>Thus the following users have been cc'd because of the following labels:</p>
<ul>
<li>bnjbvr: cranelift</li>
<li>fitzgen: cranelift:area:peepmatic</li>
</ul>
<p>To subscribe or unsubscribe from this label, edit the &lt;code&gt;.github/subscribe-to-label.json&lt;/code&gt; configuration file.</p>
<p><a href="https://github.com/bytecodealliance/subscribe-to-label-action">Learn more.</a><br>
&lt;/details&gt;</p>
</blockquote>



<a name="204023863"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20Issue%20%232022%20peepmatic%3A%20Add%20bnot%20operation%20%2B%20op.../near/204023863" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20Issue.20.232022.20peepmatic.3A.20Add.20bnot.20operation.20.2B.20op.2E.2E.2E.html#204023863">(Jul 15 2020 at 23:04)</a>:</h4>
<p>MaxGraey <a href="https://github.com/bytecodealliance/wasmtime/pull/2022#issuecomment-659058872">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/2022">Issue #2022</a>:</p>
<blockquote>
<blockquote>
<p>I do think that Peepmatic support for bnot instructions is useful, so if you<br>
would be interested in separating out just the changes required to support<br>
bnot, then I would be happy to merge them.</p>
</blockquote>
<p>What if I just add support same transform also for <code>simple_preopt.rs</code> for parity?</p>
</blockquote>



<a name="204023880"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20Issue%20%232022%20peepmatic%3A%20Add%20bnot%20operation%20%2B%20op.../near/204023880" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20Issue.20.232022.20peepmatic.3A.20Add.20bnot.20operation.20.2B.20op.2E.2E.2E.html#204023880">(Jul 15 2020 at 23:04)</a>:</h4>
<p>MaxGraey edited a <a href="https://github.com/bytecodealliance/wasmtime/pull/2022#issuecomment-659058872">comment</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/2022">Issue #2022</a>:</p>
<blockquote>
<blockquote>
<p>I do think that Peepmatic support for bnot instructions is useful, so if you<br>
would be interested in separating out just the changes required to support<br>
bnot, then I would be happy to merge them.</p>
</blockquote>
<p>What if I just add support same transform also for <code>simple_preopt.rs</code> for parity in this PR?</p>
</blockquote>



<a name="204030254"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20Issue%20%232022%20peepmatic%3A%20Add%20bnot%20operation%20%2B%20op.../near/204030254" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20Issue.20.232022.20peepmatic.3A.20Add.20bnot.20operation.20.2B.20op.2E.2E.2E.html#204030254">(Jul 16 2020 at 00:21)</a>:</h4>
<p>fitzgen <a href="https://github.com/bytecodealliance/wasmtime/pull/2022#issuecomment-659082383">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/2022">Issue #2022</a>:</p>
<blockquote>
<blockquote>
<p>What if I just add support same transform also for <code>simple_preopt.rs</code> for parity in this PR?</p>
</blockquote>
<p><code>simple_preopt.rs</code> optimizations need to be careful to carry their weight (which is part of what peepmatic is trying to improve upon) and I'm not sure what the exact calculus is that makes an optimization worth it or not. Perhaps @sunfishcode or @bnjbvr could comment on whether this would be a welcome addition to <code>simple_preopt.rs</code>.</p>
<p>If so, then yes let's add it  <code>preopt.peepmatic</code> as well!</p>
</blockquote>



<a name="204062196"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20Issue%20%232022%20peepmatic%3A%20Add%20bnot%20operation%20%2B%20op.../near/204062196" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20Issue.20.232022.20peepmatic.3A.20Add.20bnot.20operation.20.2B.20op.2E.2E.2E.html#204062196">(Jul 16 2020 at 09:27)</a>:</h4>
<p>bnjbvr <a href="https://github.com/bytecodealliance/wasmtime/pull/2022#issuecomment-659292717">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/2022">Issue #2022</a>:</p>
<blockquote>
<p>Thanks for working on this!</p>
<blockquote>
<p><a href="http://simple_preopt.rs">simple_preopt.rs</a> optimizations need to be careful to carry their weight (which is part of what peepmatic is trying to improve upon) and I'm not sure what the exact calculus is that makes an optimization worth it or not. Perhaps @sunfishcode or @bnjbvr could comment on whether this would be a welcome addition to <a href="http://simple_preopt.rs">simple_preopt.rs</a>.</p>
</blockquote>
<p>The simple preopt pass was designed to catch frequent patterns that lead to better code generation and that were not directly produced by the wasm producer. We expect most of these optimizations to have already happened in e.g. LLVM. But the IR translation makes it so that some new pattern-matching opportunities on the CLIR arise. Most of simple preopt phase was mostly acting as an helper for instruction selection (legalization) that happened later in the pipeline, by selecting the <code>_imm</code> variants so that legalization would use machine instructions with immediates; the "pre" in preopt refers to the fact that it runs before legalization. However, instruction selection happens in a totally different place now, with the new target backends, so this part is becoming less useful.</p>
<p>Integer transforms like could be valuable at the <code>speed</code> optimization level; there's some overhead for pattern-matching every single instruction, so we try to be careful to not put every optimization we can think of. Usually our line of thinking has been:</p>
<ul>
<li>is it reasonable that the CLIF producer already performed such an optimization? If yes, do no replicate it in Cranelift.</li>
<li>data-driven approach: for large CLIF inputs (from large wasm programs), how many times is the optimization effective? if it's very frequent (there's no "official" threshold, so common sense is required here), then do it in Cranelift.</li>
</ul>
<p>For instance, constant propagation doesn't quite happen in Cranelift, because we really expect the producer to have done it. For other producers which don't have advanced optimization passes like this, there's an external crate for <code>cranelift-preopt</code> that does exactly this.</p>
<p>So considering the answers to the two questions above, it might be worth putting it in simple_preopt, or implementing it in the <code>preopt</code> crate?</p>
</blockquote>



<a name="204062959"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20Issue%20%232022%20peepmatic%3A%20Add%20bnot%20operation%20%2B%20op.../near/204062959" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20Issue.20.232022.20peepmatic.3A.20Add.20bnot.20operation.20.2B.20op.2E.2E.2E.html#204062959">(Jul 16 2020 at 09:36)</a>:</h4>
<p>MaxGraey <a href="https://github.com/bytecodealliance/wasmtime/pull/2022#issuecomment-659297213">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/2022">Issue #2022</a>:</p>
<blockquote>
<p>@bnjbvr thanks for explanation!<br>
Main goal of this PR is speedup code produced by webassembly. As you know wasm doesn't have <code>not</code> operation and emulate it via <code>x ^ -1</code>. Also perhaps it could be useful even for LLVM code built with <a href="https://godbolt.org/z/1z9r16"><code>-O0</code> for some reasons</a>.</p>
</blockquote>



<a name="204066193"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20Issue%20%232022%20peepmatic%3A%20Add%20bnot%20operation%20%2B%20op.../near/204066193" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20Issue.20.232022.20peepmatic.3A.20Add.20bnot.20operation.20.2B.20op.2E.2E.2E.html#204066193">(Jul 16 2020 at 10:18)</a>:</h4>
<p>julian-seward1 <a href="https://github.com/bytecodealliance/wasmtime/pull/2022#issuecomment-659318415">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/2022">Issue #2022</a>:</p>
<blockquote>
<p>Also, for something as simple as <code>x ^ -1</code>, the new backend(s) that are under development, could easily enough match that in their instruction selectors and directly emit a <code>not</code> insn as appropriate.  There's no requirement for any more heavyweight machinery to handle this particular case.</p>
</blockquote>



<a name="204070098"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20Issue%20%232022%20peepmatic%3A%20Add%20bnot%20operation%20%2B%20op.../near/204070098" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20Issue.20.232022.20peepmatic.3A.20Add.20bnot.20operation.20.2B.20op.2E.2E.2E.html#204070098">(Jul 16 2020 at 11:10)</a>:</h4>
<p>MaxGraey <a href="https://github.com/bytecodealliance/wasmtime/pull/2022#issuecomment-659342074">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/2022">Issue #2022</a>:</p>
<blockquote>
<p>Hmm, could you explain which kind of rules are preferable for peepmatic DSL? It would really help me.</p>
</blockquote>



<hr><p>Last updated: Jan 20 2025 at 06:04 UTC</p>
</html>