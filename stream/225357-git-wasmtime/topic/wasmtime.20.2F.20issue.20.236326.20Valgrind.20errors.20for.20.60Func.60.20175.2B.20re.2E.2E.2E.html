<html>
<head><meta charset="utf-8"><title>wasmtime / issue #6326 Valgrind errors for `Func` 175+ re... · git-wasmtime · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/index.html">git-wasmtime</a></h2>
<h3>Topic: <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.236326.20Valgrind.20errors.20for.20.60Func.60.20175.2B.20re.2E.2E.2E.html">wasmtime / issue #6326 Valgrind errors for `Func` 175+ re...</a></h3>

<hr>

<base href="https://bytecodealliance.zulipchat.com">

<head><link href="https://bytecodealliance.github.io/zulip-archive/style.css" rel="stylesheet"></head>

<a name="355164026"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%236326%20Valgrind%20errors%20for%20%60Func%60%20175%2B%20re.../near/355164026" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.236326.20Valgrind.20errors.20for.20.60Func.60.20175.2B.20re.2E.2E.2E.html#355164026">(May 02 2023 at 14:13)</a>:</h4>
<p>jbourassa opened <a href="https://github.com/bytecodealliance/wasmtime/issues/6326">issue #6326</a>:</p>
<blockquote>
<h3>Test Case</h3>
<p>This repo: <a href="https://github.com/jbourassa/wasmtime-results-valgrind-report">https://github.com/jbourassa/wasmtime-results-valgrind-report</a></p>
<p>The repro case is a host-defined <code>wasmtime::Func</code> that returns 200 results:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="k">use</span><span class="w"> </span><span class="n">wasmtime</span>::<span class="p">{</span><span class="n">AsContextMut</span><span class="p">,</span><span class="w"> </span><span class="n">Engine</span><span class="p">,</span><span class="w"> </span><span class="n">Func</span><span class="p">,</span><span class="w"> </span><span class="n">Store</span><span class="p">};</span>
<span class="k">const</span><span class="w"> </span><span class="n">RESULTS_COUNT</span>: <span class="kt">i32</span> <span class="o">=</span><span class="w"> </span><span class="mi">200</span><span class="p">;</span>

<span class="k">fn</span> <span class="nf">main</span><span class="p">()</span><span class="w"> </span>-&gt; <span class="nc">wasmtime</span>::<span class="nb">Result</span><span class="o">&lt;</span><span class="p">()</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">engine</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Engine</span>::<span class="n">default</span><span class="p">();</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">store</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Store</span>::<span class="n">new</span><span class="p">(</span><span class="o">&amp;</span><span class="n">engine</span><span class="p">,</span><span class="w"> </span><span class="p">());</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">result_type</span>: <span class="nb">Vec</span><span class="o">&lt;</span><span class="n">_</span><span class="o">&gt;</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="mi">0</span><span class="o">..</span><span class="n">RESULTS_COUNT</span><span class="p">).</span><span class="n">map</span><span class="p">(</span><span class="o">|</span><span class="n">_</span><span class="o">|</span><span class="w"> </span><span class="n">wasmtime</span>::<span class="n">ValType</span>::<span class="n">I32</span><span class="p">).</span><span class="n">collect</span><span class="p">();</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">func_type</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">wasmtime</span>::<span class="n">FuncType</span>::<span class="n">new</span><span class="p">([],</span><span class="w"> </span><span class="n">result_type</span><span class="p">);</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">func</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Func</span>::<span class="n">new</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="n">store</span><span class="p">,</span><span class="w"> </span><span class="n">func_type</span><span class="p">.</span><span class="n">clone</span><span class="p">(),</span><span class="w"> </span><span class="o">|</span><span class="n">_</span><span class="p">,</span><span class="w"> </span><span class="n">_</span><span class="p">,</span><span class="w"> </span><span class="n">results</span><span class="o">|</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">results</span>
<span class="w">            </span><span class="p">.</span><span class="n">iter_mut</span><span class="p">()</span>
<span class="w">            </span><span class="p">.</span><span class="n">for_each</span><span class="p">(</span><span class="o">|</span><span class="n">val</span><span class="o">|</span><span class="w"> </span><span class="o">*</span><span class="n">val</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">wasmtime</span>::<span class="n">Val</span>::<span class="n">I32</span><span class="p">(</span><span class="mi">1</span><span class="p">));</span>
<span class="w">        </span><span class="nb">Ok</span><span class="p">(())</span>
<span class="w">    </span><span class="p">});</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">results</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="fm">vec!</span><span class="p">[</span><span class="n">wasmtime</span>::<span class="n">Val</span>::<span class="n">null</span><span class="p">();</span><span class="w"> </span><span class="n">func_type</span><span class="p">.</span><span class="n">results</span><span class="p">().</span><span class="n">len</span><span class="p">()];</span>
<span class="w">    </span><span class="n">func</span><span class="p">.</span><span class="n">call</span><span class="p">(</span><span class="n">store</span><span class="p">.</span><span class="n">as_context_mut</span><span class="p">(),</span><span class="w"> </span><span class="o">&amp;</span><span class="p">[],</span><span class="w"> </span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="n">results</span><span class="p">)</span><span class="o">?</span><span class="p">;</span>
<span class="w">    </span><span class="nb">Ok</span><span class="p">(())</span>
<span class="p">}</span>
</code></pre></div>
<h3>Steps to Reproduce</h3>
<ol>
<li>Clone the <a href="https://github.com/jbourassa/wasmtime-results-valgrind-report">repo</a></li>
<li>Run the executable with valgrind: <code>cargo build &amp;&amp; valgrind target/debug/many-results</code></li>
</ol>
<h3>Result, Version, Environment</h3>
<p>Wasmtime version: v8.0.1 (but also appeared in 7.0 and likely earlier versions)</p>
<p>Valgrind version: 3.21.0 (latest, but also reproducible with 3.18.1)</p>
<p>On aarch64 (Linux running on an ARM-based Mac), Ubuntu 22.10, the valgrind report is:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="n">ARM64</span><span class="w"> </span><span class="n">front</span><span class="w"> </span><span class="n">end</span>: <span class="nc">load_store</span>
<span class="n">disInstr</span><span class="p">(</span><span class="n">arm64</span><span class="p">)</span>: <span class="nc">unhandled</span><span class="w"> </span><span class="n">instruction</span><span class="w"> </span><span class="mh">0xB830EBFF</span>
<span class="n">disInstr</span><span class="p">(</span><span class="n">arm64</span><span class="p">)</span>: <span class="mi">1011</span><span class="o">'</span><span class="mi">1000</span><span class="w"> </span><span class="mi">0011</span><span class="o">'</span><span class="mi">0000</span><span class="w"> </span><span class="mi">1110</span><span class="o">'</span><span class="mi">1011</span><span class="w"> </span><span class="mi">1111</span><span class="o">'</span><span class="mi">1111</span>
<span class="o">==</span><span class="mi">25125</span><span class="o">==</span><span class="w"> </span><span class="n">valgrind</span>: <span class="nc">Unrecognised</span><span class="w"> </span><span class="n">instruction</span><span class="w"> </span><span class="n">at</span><span class="w"> </span><span class="n">address</span><span class="w"> </span><span class="mh">0x4f6fc2c</span><span class="p">.</span>
<span class="o">==</span><span class="mi">25125</span><span class="o">==</span><span class="w">    </span><span class="n">at</span><span class="w"> </span><span class="mh">0x4F6FC2C</span>: <span class="o">???</span>
<span class="o">==</span><span class="mi">25125</span><span class="o">==</span><span class="w"> </span><span class="n">Your</span><span class="w"> </span><span class="n">program</span><span class="w"> </span><span class="n">just</span><span class="w"> </span><span class="n">tried</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">execute</span><span class="w"> </span><span class="n">an</span><span class="w"> </span><span class="n">instruction</span><span class="w"> </span><span class="n">that</span><span class="w"> </span><span class="n">Valgrind</span>
<span class="o">==</span><span class="mi">25125</span><span class="o">==</span><span class="w"> </span><span class="n">did</span><span class="w"> </span><span class="n">not</span><span class="w"> </span><span class="n">recognise</span><span class="p">.</span><span class="w">  </span><span class="n">There</span><span class="w"> </span><span class="n">are</span><span class="w"> </span><span class="n">two</span><span class="w"> </span><span class="n">possible</span><span class="w"> </span><span class="n">reasons</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">this</span><span class="p">.</span>
<span class="o">==</span><span class="mi">25125</span><span class="o">==</span><span class="w"> </span><span class="mf">1.</span><span class="w"> </span><span class="n">Your</span><span class="w"> </span><span class="n">program</span><span class="w"> </span><span class="n">has</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="n">bug</span><span class="w"> </span><span class="n">and</span><span class="w"> </span><span class="n">erroneously</span><span class="w"> </span><span class="n">jumped</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="n">non</span><span class="o">-</span><span class="n">code</span>
<span class="o">==</span><span class="mi">25125</span><span class="o">==</span><span class="w">    </span><span class="n">location</span><span class="p">.</span><span class="w">  </span><span class="n">If</span><span class="w"> </span><span class="n">you</span><span class="w"> </span><span class="n">are</span><span class="w"> </span><span class="n">running</span><span class="w"> </span><span class="n">Memcheck</span><span class="w"> </span><span class="n">and</span><span class="w"> </span><span class="n">you</span><span class="w"> </span><span class="n">just</span><span class="w"> </span><span class="n">saw</span><span class="w"> </span><span class="n">a</span>
<span class="o">==</span><span class="mi">25125</span><span class="o">==</span><span class="w">    </span><span class="n">warning</span><span class="w"> </span><span class="n">about</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="n">bad</span><span class="w"> </span><span class="n">jump</span><span class="p">,</span><span class="w"> </span><span class="n">it</span><span class="o">'</span><span class="na">s</span><span class="w"> </span><span class="n">probably</span><span class="w"> </span><span class="n">your</span><span class="w"> </span><span class="n">program</span><span class="o">'</span><span class="na">s</span><span class="w"> </span><span class="n">fault</span><span class="p">.</span>
<span class="o">==</span><span class="mi">25125</span><span class="o">==</span><span class="w"> </span><span class="mf">2.</span><span class="w"> </span><span class="n">The</span><span class="w"> </span><span class="n">instruction</span><span class="w"> </span><span class="n">is</span><span class="w"> </span><span class="n">legitimate</span><span class="w"> </span><span class="n">but</span><span class="w"> </span><span class="n">Valgrind</span><span class="w"> </span><span class="n">doesn</span><span class="o">'</span><span class="na">t</span><span class="w"> </span><span class="n">handle</span><span class="w"> </span><span class="n">it</span><span class="p">,</span>
<span class="o">==</span><span class="mi">25125</span><span class="o">==</span><span class="w">    </span><span class="n">i</span><span class="p">.</span><span class="n">e</span><span class="p">.</span><span class="w"> </span><span class="n">it</span><span class="o">'</span><span class="na">s</span><span class="w"> </span><span class="n">Valgrind</span><span class="o">'</span><span class="na">s</span><span class="w"> </span><span class="n">fault</span><span class="p">.</span><span class="w">  </span><span class="n">If</span><span class="w"> </span><span class="n">you</span><span class="w"> </span><span class="n">think</span><span class="w"> </span><span class="n">this</span><span class="w"> </span><span class="n">is</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">case</span><span class="w"> </span><span class="n">or</span>
<span class="o">==</span><span class="mi">25125</span><span class="o">==</span><span class="w">    </span><span class="n">you</span><span class="w"> </span><span class="n">are</span><span class="w"> </span><span class="n">not</span><span class="w"> </span><span class="n">sure</span><span class="p">,</span><span class="w"> </span><span class="n">please</span><span class="w"> </span><span class="kd">let</span><span class="w"> </span><span class="n">us</span><span class="w"> </span><span class="n">know</span><span class="w"> </span><span class="n">and</span><span class="w"> </span><span class="n">we</span><span class="o">'</span><span class="na">ll</span><span class="w"> </span><span class="kr">try</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">fix</span><span class="w"> </span><span class="n">it</span><span class="p">.</span>
<span class="o">==</span><span class="mi">25125</span><span class="o">==</span><span class="w"> </span><span class="n">Either</span><span class="w"> </span><span class="n">way</span><span class="p">,</span><span class="w"> </span><span class="n">Valgrind</span><span class="w"> </span><span class="n">will</span><span class="w"> </span><span class="n">now</span><span class="w"> </span><span class="n">raise</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="n">SIGILL</span><span class="w"> </span><span class="n">signal</span><span class="w"> </span><span class="n">which</span><span class="w"> </span><span class="n">will</span>
<span class="o">==</span><span class="mi">25125</span><span class="o">==</span><span class="w"> </span><span class="n">probably</span><span class="w"> </span><span class="n">kill</span><span class="w"> </span><span class="n">your</span><span class="w"> </span><span class="n">program</span><span class="p">.</span>
</code></pre></div>
<p>On x86, Ubuntu 22.04.2 LTS, the valgrind report is:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="o">=</span><span class="mi">58680</span><span class="o">==</span><span class="w"> </span><span class="n">Invalid</span><span class="w"> </span><span class="n">write</span><span class="w"> </span><span class="n">of</span><span class="w"> </span><span class="n">size</span><span class="w"> </span><span class="mi">4</span>
<span class="o">==</span><span class="mi">58680</span><span class="o">==</span><span class="w">    </span><span class="n">at</span><span class="w"> </span><span class="mh">0x4F973B4</span>: <span class="o">???</span>
<span class="o">==</span><span class="mi">58680</span><span class="o">==</span><span class="w">    </span><span class="n">by</span><span class="w"> </span><span class="mh">0x4F96047</span>: <span class="o">???</span>
<span class="o">==</span><span class="mi">58680</span><span class="o">==</span><span class="w">    </span><span class="n">by</span><span class="w"> </span><span class="mh">0x2032D3</span>: <span class="nc">wasmtime</span>::<span class="n">func</span>::<span class="n">Func</span>::<span class="n">call_unchecked_raw</span>::<span class="p">{{</span><span class="n">closure</span><span class="p">}}</span><span class="w"> </span><span class="p">(</span><span class="n">func</span><span class="p">.</span><span class="n">rs</span>:<span class="mi">900</span><span class="p">)</span>
<span class="o">==</span><span class="mi">58680</span><span class="o">==</span><span class="w">    </span><span class="n">by</span><span class="w"> </span><span class="mh">0x20B0BA</span>: <span class="nc">wasmtime_runtime</span>::<span class="n">traphandlers</span>::<span class="n">catch_traps</span>::<span class="n">call_closure</span><span class="w"> </span><span class="p">(</span><span class="n">traphandlers</span><span class="p">.</span><span class="n">rs</span>:<span class="mi">243</span><span class="p">)</span>
<span class="o">==</span><span class="mi">58680</span><span class="o">==</span><span class="w">    </span><span class="n">by</span><span class="w"> </span><span class="mh">0xAA669F</span>: <span class="nc">wasmtime_setjmp</span><span class="w"> </span><span class="p">(</span><span class="n">helpers</span><span class="p">.</span><span class="n">c</span>:<span class="mi">55</span><span class="p">)</span>
<span class="o">==</span><span class="mi">58680</span><span class="o">==</span><span class="w">    </span><span class="n">by</span><span class="w"> </span><span class="mh">0x20B415</span>: <span class="nc">wasmtime_runtime</span>::<span class="n">traphandlers</span>::<span class="n">catch_traps</span>::<span class="p">{{</span><span class="n">closure</span><span class="p">}}</span><span class="w"> </span><span class="p">(</span><span class="n">traphandlers</span><span class="p">.</span><span class="n">rs</span>:<span class="mi">225</span><span class="p">)</span>
<span class="o">==</span><span class="mi">58680</span><span class="o">==</span><span class="w">    </span><span class="n">by</span><span class="w"> </span><span class="mh">0x20B441</span>: <span class="nc">wasmtime_runtime</span>::<span class="n">traphandlers</span>::<span class="o">&lt;</span><span class="k">impl</span><span class="w"> </span><span class="n">wasmtime_runtime</span>::<span class="n">traphandlers</span>::<span class="n">call_thread_state</span>::<span class="n">CallThreadState</span><span class="o">&gt;</span>::<span class="n">with</span>::<span class="p">{{</span><span class="n">closure</span><span class="p">}}</span><span class="w"> </span><span class="p">(</span><span class="n">traphandlers</span><span class="p">.</span><span class="n">rs</span>:<span class="mi">409</span><span class="p">)</span>
<span class="o">==</span><span class="mi">58680</span><span class="o">==</span><span class="w">    </span><span class="n">by</span><span class="w"> </span><span class="mh">0x208462</span>: <span class="nc">wasmtime_runtime</span>::<span class="n">traphandlers</span>::<span class="n">tls</span>::<span class="n">set</span><span class="w"> </span><span class="p">(</span><span class="n">traphandlers</span><span class="p">.</span><span class="n">rs</span>:<span class="mi">684</span><span class="p">)</span>
<span class="o">==</span><span class="mi">58680</span><span class="o">==</span><span class="w">    </span><span class="n">by</span><span class="w"> </span><span class="mh">0x214F1D</span>: <span class="nc">wasmtime_runtime</span>::<span class="n">traphandlers</span>::<span class="o">&lt;</span><span class="k">impl</span><span class="w"> </span><span class="n">wasmtime_runtime</span>::<span class="n">traphandlers</span>::<span class="n">call_thread_state</span>::<span class="n">CallThreadState</span><span class="o">&gt;</span>::<span class="n">with</span><span class="w"> </span><span class="p">(</span><span class="n">traphandlers</span><span class="p">.</span><span class="n">rs</span>:<span class="mi">409</span><span class="p">)</span>
<span class="o">==</span><span class="mi">58680</span><span class="o">==</span><span class="w">    </span><span class="n">by</span><span class="w"> </span><span class="mh">0x20B1BB</span>: <span class="nc">wasmtime_runtime</span>::<span class="n">traphandlers</span>::<span class="n">catch_traps</span><span class="w"> </span><span class="p">(</span><span class="n">traphandlers</span><span class="p">.</span><span class="n">rs</span>:<span class="mi">224</span><span class="p">)</span>
<span class="o">==</span><span class="mi">58680</span><span class="o">==</span><span class="w">    </span><span class="n">by</span><span class="w"> </span><span class="mh">0x202C5E</span>: <span class="nc">wasmtime</span>::<span class="n">func</span>::<span class="n">invoke_wasm_and_catch_traps</span><span class="w"> </span><span class="p">(</span><span class="n">func</span><span class="p">.</span><span class="n">rs</span>:<span class="mi">1306</span><span class="p">)</span>
<span class="o">==</span><span class="mi">58680</span><span class="o">==</span><span class="w">    </span><span class="n">by</span><span class="w"> </span><span class="mh">0x20324C</span>: <span class="nc">wasmtime</span>::<span class="n">func</span>::<span class="n">Func</span>::<span class="n">call_unchecked_raw</span><span class="w"> </span><span class="p">(</span><span class="n">func</span><span class="p">.</span><span class="n">rs</span>:<span class="mi">898</span><span class="p">)</span>
<span class="o">==</span><span class="mi">58680</span><span class="o">==</span><span class="w">  </span><span class="n">Address</span><span class="w"> </span><span class="mh">0x1ffeffc580</span><span class="w"> </span><span class="n">is</span><span class="w"> </span><span class="n">on</span><span class="w"> </span><span class="n">thread</span><span class="w"> </span><span class="mi">1</span><span class="o">'</span><span class="na">s</span><span class="w"> </span><span class="n">stack</span>
<span class="o">==</span><span class="mi">58680</span><span class="o">==</span><span class="w">  </span><span class="mi">4096</span><span class="w"> </span><span class="n">bytes</span><span class="w"> </span><span class="n">below</span><span class="w"> </span><span class="n">stack</span><span class="w"> </span><span class="n">pointer</span>
<span class="o">==</span><span class="mi">58680</span><span class="o">==</span>
<span class="o">==</span><span class="mi">58680</span><span class="o">==</span><span class="w"> </span><span class="n">Invalid</span><span class="w"> </span><span class="n">write</span><span class="w"> </span><span class="n">of</span><span class="w"> </span><span class="n">size</span><span class="w"> </span><span class="mi">4</span>
<span class="o">==</span><span class="mi">58680</span><span class="o">==</span><span class="w">    </span><span class="n">at</span><span class="w"> </span><span class="mh">0x4F973BB</span>: <span class="o">???</span>
<span class="o">==</span><span class="mi">58680</span><span class="o">==</span><span class="w">    </span><span class="n">by</span><span class="w"> </span><span class="mh">0x4F96047</span>: <span class="o">???</span>
<span class="o">==</span><span class="mi">58680</span><span class="o">==</span><span class="w">    </span><span class="n">by</span><span class="w"> </span><span class="mh">0x2032D3</span>: <span class="nc">wasmtime</span>::<span class="n">func</span>::<span class="n">Func</span>::<span class="n">call_unchecked_raw</span>::<span class="p">{{</span><span class="n">closure</span><span class="p">}}</span><span class="w"> </span><span class="p">(</span><span class="n">func</span><span class="p">.</span><span class="n">rs</span>:<span class="mi">900</span><span class="p">)</span>
<span class="o">==</span><span class="mi">58680</span><span class="o">==</span><span class="w">    </span><span class="n">by</span><span class="w"> </span><span class="mh">0x20B0BA</span>: <span class="nc">wasmtime_runtime</span>::<span class="n">traphandlers</span>::<span class="n">catch_traps</span>::<span class="n">call_closure</span><span class="w"> </span><span class="p">(</span><span class="n">traphandlers</span><span class="p">.</span><span class="n">rs</span>:<span class="mi">243</span><span class="p">)</span>
<span class="o">==</span><span class="mi">58680</span><span class="o">==</span><span class="w">    </span><span class="n">by</span><span class="w"> </span><span class="mh">0xAA669F</span>: <span class="nc">wasmtime_setjmp</span><span class="w"> </span><span class="p">(</span><span class="n">helpers</span><span class="p">.</span><span class="n">c</span>:<span class="mi">55</span><span class="p">)</span>
<span class="o">==</span><span class="mi">58680</span><span class="o">==</span><span class="w">    </span><span class="n">by</span><span class="w"> </span><span class="mh">0x20B415</span>: <span class="nc">wasmtime_runtime</span>::<span class="n">traphandlers</span>::<span class="n">catch_traps</span>::<span class="p">{{</span><span class="n">closure</span><span class="p">}}</span><span class="w"> </span><span class="p">(</span><span class="n">traphandlers</span><span class="p">.</span><span class="n">rs</span>:<span class="mi">225</span><span class="p">)</span>
<span class="o">==</span><span class="mi">58680</span><span class="o">==</span><span class="w">    </span><span class="n">by</span><span class="w"> </span><span class="mh">0x20B441</span>: <span class="nc">wasmtime_runtime</span>::<span class="n">traphandlers</span>::<span class="o">&lt;</span><span class="k">impl</span><span class="w"> </span><span class="n">wasmtime_runtime</span>::<span class="n">traphandlers</span>::<span class="n">call_thread_state</span>::<span class="n">CallThreadState</span><span class="o">&gt;</span>::<span class="n">with</span>::<span class="p">{{</span><span class="n">closure</span><span class="p">}}</span><span class="w"> </span><span class="p">(</span><span class="n">traphandlers</span><span class="p">.</span><span class="n">rs</span>:<span class="mi">409</span><span class="p">)</span>
<span class="o">==</span><span class="mi">58680</span><span class="o">==</span><span class="w">    </span><span class="n">by</span><span class="w"> </span><span class="mh">0x208462</span>: <span class="nc">wasmtime_runtime</span>::<span class="n">traphandlers</span>::<span class="n">tls</span>::<span class="n">set</span><span class="w"> </span><span class="p">(</span><span class="n">traphandlers</span><span class="p">.</span><span class="n">rs</span>:<span class="mi">684</span><span class="p">)</span>
<span class="o">==</span><span class="mi">58680</span><span class="o">==</span><span class="w">    </span><span class="n">by</span><span class="w"> </span><span class="mh">0x214F1D</span>: <span class="nc">wasmtime_runtime</span>::<span class="n">traphandlers</span>::<span class="o">&lt;</span><span class="k">impl</span><span class="w"> </span><span class="n">wasmtime_runtime</span>::<span class="n">traphandlers</span>::<span class="n">call_thread_state</span>::<span class="n">CallThreadState</span><span class="o">&gt;</span>::<span class="n">with</span><span class="w"> </span><span class="p">(</span><span class="n">traphandlers</span><span class="p">.</span><span class="n">rs</span>:<span class="mi">409</span><span class="p">)</span>
<span class="o">==</span><span class="mi">58680</span><span class="o">==</span><span class="w">    </span><span class="n">by</span><span class="w"> </span><span class="mh">0x20B1BB</span>: <span class="nc">wasmtime_runtime</span>::<span class="n">traphandlers</span>::<span class="n">catch_traps</span><span class="w"> </span><span class="p">(</span><span class="n">traphandlers</span><span class="p">.</span><span class="n">rs</span>:<span class="mi">224</span><span class="p">)</span>
<span class="o">==</span><span class="mi">58680</span><span class="o">==</span><span class="w">    </span><span class="n">by</span><span class="w"> </span><span class="mh">0x202C5E</span>: <span class="nc">wasmtime</span>::<span class="n">func</span>::<span class="n">invoke_wasm_and_catch_traps</span><span class="w"> </span><span class="p">(</span><span class="n">func</span><span class="p">.</span><span class="n">rs</span>:<span class="mi">1306</span><span class="p">)</span>
<span class="o">==</span><span class="mi">58680</span><span class="o">==</span><span class="w">    </span><span class="n">by</span><span class="w"> </span><span class="mh">0x20324C</span>: <span class="nc">wasmtime</span>::<span class="n">func</span>::<span class="n">Func</span>::<span class="n">call_unchecked_raw</span><span class="w"> </span><span class="p">(</span><span class="n">func</span><span class="p">.</span><span class="n">rs</span>:<span class="mi">898</span><span class="p">)</span>
<span class="o">==</span><span class="mi">58680</span><span class="o">==</span><span class="w">  </span><span class="n">Address</span><span class="w"> </span><span class="mh">0x1ffeffb580</span><span class="w"> </span><span class="n">is</span><span class="w"> </span><span class="n">on</span><span class="w"> </span><span class="n">thread</span><span class="w"> </span><span class="mi">1</span><span class="o">'</span><span class="na">s</span><span class="w"> </span><span class="n">stack</span>
<span class="o">==</span><span class="mi">58680</span><span class="o">==</span><span class="w">  </span><span class="mi">8192</span><span class="w"> </span><span class="n">bytes</span><span class="w"> </span><span class="n">below</span><span class="w"> </span><span class="n">stack</span><span class="w"> </span><span class="n">pointer</span>
</code></pre></div>
<h3>Extra Info</h3>
<p>I don't know if it's an actual bug, but figured I should report it. Feel free to close it if it's a false-positive.<br>
</p>
</blockquote>



<a name="355164028"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%236326%20Valgrind%20errors%20for%20%60Func%60%20175%2B%20re.../near/355164028" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.236326.20Valgrind.20errors.20for.20.60Func.60.20175.2B.20re.2E.2E.2E.html#355164028">(May 02 2023 at 14:13)</a>:</h4>
<p>jbourassa labeled <a href="https://github.com/bytecodealliance/wasmtime/issues/6326">issue #6326</a>:</p>
<blockquote>
<h3>Test Case</h3>
<p>This repo: <a href="https://github.com/jbourassa/wasmtime-results-valgrind-report">https://github.com/jbourassa/wasmtime-results-valgrind-report</a></p>
<p>The repro case is a host-defined <code>wasmtime::Func</code> that returns 200 results:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="k">use</span><span class="w"> </span><span class="n">wasmtime</span>::<span class="p">{</span><span class="n">AsContextMut</span><span class="p">,</span><span class="w"> </span><span class="n">Engine</span><span class="p">,</span><span class="w"> </span><span class="n">Func</span><span class="p">,</span><span class="w"> </span><span class="n">Store</span><span class="p">};</span>
<span class="k">const</span><span class="w"> </span><span class="n">RESULTS_COUNT</span>: <span class="kt">i32</span> <span class="o">=</span><span class="w"> </span><span class="mi">200</span><span class="p">;</span>

<span class="k">fn</span> <span class="nf">main</span><span class="p">()</span><span class="w"> </span>-&gt; <span class="nc">wasmtime</span>::<span class="nb">Result</span><span class="o">&lt;</span><span class="p">()</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">engine</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Engine</span>::<span class="n">default</span><span class="p">();</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">store</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Store</span>::<span class="n">new</span><span class="p">(</span><span class="o">&amp;</span><span class="n">engine</span><span class="p">,</span><span class="w"> </span><span class="p">());</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">result_type</span>: <span class="nb">Vec</span><span class="o">&lt;</span><span class="n">_</span><span class="o">&gt;</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="mi">0</span><span class="o">..</span><span class="n">RESULTS_COUNT</span><span class="p">).</span><span class="n">map</span><span class="p">(</span><span class="o">|</span><span class="n">_</span><span class="o">|</span><span class="w"> </span><span class="n">wasmtime</span>::<span class="n">ValType</span>::<span class="n">I32</span><span class="p">).</span><span class="n">collect</span><span class="p">();</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">func_type</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">wasmtime</span>::<span class="n">FuncType</span>::<span class="n">new</span><span class="p">([],</span><span class="w"> </span><span class="n">result_type</span><span class="p">);</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">func</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Func</span>::<span class="n">new</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="n">store</span><span class="p">,</span><span class="w"> </span><span class="n">func_type</span><span class="p">.</span><span class="n">clone</span><span class="p">(),</span><span class="w"> </span><span class="o">|</span><span class="n">_</span><span class="p">,</span><span class="w"> </span><span class="n">_</span><span class="p">,</span><span class="w"> </span><span class="n">results</span><span class="o">|</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">results</span>
<span class="w">            </span><span class="p">.</span><span class="n">iter_mut</span><span class="p">()</span>
<span class="w">            </span><span class="p">.</span><span class="n">for_each</span><span class="p">(</span><span class="o">|</span><span class="n">val</span><span class="o">|</span><span class="w"> </span><span class="o">*</span><span class="n">val</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">wasmtime</span>::<span class="n">Val</span>::<span class="n">I32</span><span class="p">(</span><span class="mi">1</span><span class="p">));</span>
<span class="w">        </span><span class="nb">Ok</span><span class="p">(())</span>
<span class="w">    </span><span class="p">});</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">results</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="fm">vec!</span><span class="p">[</span><span class="n">wasmtime</span>::<span class="n">Val</span>::<span class="n">null</span><span class="p">();</span><span class="w"> </span><span class="n">func_type</span><span class="p">.</span><span class="n">results</span><span class="p">().</span><span class="n">len</span><span class="p">()];</span>
<span class="w">    </span><span class="n">func</span><span class="p">.</span><span class="n">call</span><span class="p">(</span><span class="n">store</span><span class="p">.</span><span class="n">as_context_mut</span><span class="p">(),</span><span class="w"> </span><span class="o">&amp;</span><span class="p">[],</span><span class="w"> </span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="n">results</span><span class="p">)</span><span class="o">?</span><span class="p">;</span>
<span class="w">    </span><span class="nb">Ok</span><span class="p">(())</span>
<span class="p">}</span>
</code></pre></div>
<h3>Steps to Reproduce</h3>
<ol>
<li>Clone the <a href="https://github.com/jbourassa/wasmtime-results-valgrind-report">repo</a></li>
<li>Run the executable with valgrind: <code>cargo build &amp;&amp; valgrind target/debug/many-results</code></li>
</ol>
<h3>Result, Version, Environment</h3>
<p>Wasmtime version: v8.0.1 (but also appeared in 7.0 and likely earlier versions)</p>
<p>Valgrind version: 3.21.0 (latest, but also reproducible with 3.18.1)</p>
<p>On aarch64 (Linux running on an ARM-based Mac), Ubuntu 22.10, the valgrind report is:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="n">ARM64</span><span class="w"> </span><span class="n">front</span><span class="w"> </span><span class="n">end</span>: <span class="nc">load_store</span>
<span class="n">disInstr</span><span class="p">(</span><span class="n">arm64</span><span class="p">)</span>: <span class="nc">unhandled</span><span class="w"> </span><span class="n">instruction</span><span class="w"> </span><span class="mh">0xB830EBFF</span>
<span class="n">disInstr</span><span class="p">(</span><span class="n">arm64</span><span class="p">)</span>: <span class="mi">1011</span><span class="o">'</span><span class="mi">1000</span><span class="w"> </span><span class="mi">0011</span><span class="o">'</span><span class="mi">0000</span><span class="w"> </span><span class="mi">1110</span><span class="o">'</span><span class="mi">1011</span><span class="w"> </span><span class="mi">1111</span><span class="o">'</span><span class="mi">1111</span>
<span class="o">==</span><span class="mi">25125</span><span class="o">==</span><span class="w"> </span><span class="n">valgrind</span>: <span class="nc">Unrecognised</span><span class="w"> </span><span class="n">instruction</span><span class="w"> </span><span class="n">at</span><span class="w"> </span><span class="n">address</span><span class="w"> </span><span class="mh">0x4f6fc2c</span><span class="p">.</span>
<span class="o">==</span><span class="mi">25125</span><span class="o">==</span><span class="w">    </span><span class="n">at</span><span class="w"> </span><span class="mh">0x4F6FC2C</span>: <span class="o">???</span>
<span class="o">==</span><span class="mi">25125</span><span class="o">==</span><span class="w"> </span><span class="n">Your</span><span class="w"> </span><span class="n">program</span><span class="w"> </span><span class="n">just</span><span class="w"> </span><span class="n">tried</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">execute</span><span class="w"> </span><span class="n">an</span><span class="w"> </span><span class="n">instruction</span><span class="w"> </span><span class="n">that</span><span class="w"> </span><span class="n">Valgrind</span>
<span class="o">==</span><span class="mi">25125</span><span class="o">==</span><span class="w"> </span><span class="n">did</span><span class="w"> </span><span class="n">not</span><span class="w"> </span><span class="n">recognise</span><span class="p">.</span><span class="w">  </span><span class="n">There</span><span class="w"> </span><span class="n">are</span><span class="w"> </span><span class="n">two</span><span class="w"> </span><span class="n">possible</span><span class="w"> </span><span class="n">reasons</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">this</span><span class="p">.</span>
<span class="o">==</span><span class="mi">25125</span><span class="o">==</span><span class="w"> </span><span class="mf">1.</span><span class="w"> </span><span class="n">Your</span><span class="w"> </span><span class="n">program</span><span class="w"> </span><span class="n">has</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="n">bug</span><span class="w"> </span><span class="n">and</span><span class="w"> </span><span class="n">erroneously</span><span class="w"> </span><span class="n">jumped</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="n">non</span><span class="o">-</span><span class="n">code</span>
<span class="o">==</span><span class="mi">25125</span><span class="o">==</span><span class="w">    </span><span class="n">location</span><span class="p">.</span><span class="w">  </span><span class="n">If</span><span class="w"> </span><span class="n">you</span><span class="w"> </span><span class="n">are</span><span class="w"> </span><span class="n">running</span><span class="w"> </span><span class="n">Memcheck</span><span class="w"> </span><span class="n">and</span><span class="w"> </span><span class="n">you</span><span class="w"> </span><span class="n">just</span><span class="w"> </span><span class="n">saw</span><span class="w"> </span><span class="n">a</span>
<span class="o">==</span><span class="mi">25125</span><span class="o">==</span><span class="w">    </span><span class="n">warning</span><span class="w"> </span><span class="n">about</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="n">bad</span><span class="w"> </span><span class="n">jump</span><span class="p">,</span><span class="w"> </span><span class="n">it</span><span class="o">'</span><span class="na">s</span><span class="w"> </span><span class="n">probably</span><span class="w"> </span><span class="n">your</span><span class="w"> </span><span class="n">program</span><span class="o">'</span><span class="na">s</span><span class="w"> </span><span class="n">fault</span><span class="p">.</span>
<span class="o">==</span><span class="mi">25125</span><span class="o">==</span><span class="w"> </span><span class="mf">2.</span><span class="w"> </span><span class="n">The</span><span class="w"> </span><span class="n">instruction</span><span class="w"> </span><span class="n">is</span><span class="w"> </span><span class="n">legitimate</span><span class="w"> </span><span class="n">but</span><span class="w"> </span><span class="n">Valgrind</span><span class="w"> </span><span class="n">doesn</span><span class="o">'</span><span class="na">t</span><span class="w"> </span><span class="n">handle</span><span class="w"> </span><span class="n">it</span><span class="p">,</span>
<span class="o">==</span><span class="mi">25125</span><span class="o">==</span><span class="w">    </span><span class="n">i</span><span class="p">.</span><span class="n">e</span><span class="p">.</span><span class="w"> </span><span class="n">it</span><span class="o">'</span><span class="na">s</span><span class="w"> </span><span class="n">Valgrind</span><span class="o">'</span><span class="na">s</span><span class="w"> </span><span class="n">fault</span><span class="p">.</span><span class="w">  </span><span class="n">If</span><span class="w"> </span><span class="n">you</span><span class="w"> </span><span class="n">think</span><span class="w"> </span><span class="n">this</span><span class="w"> </span><span class="n">is</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">case</span><span class="w"> </span><span class="n">or</span>
<span class="o">==</span><span class="mi">25125</span><span class="o">==</span><span class="w">    </span><span class="n">you</span><span class="w"> </span><span class="n">are</span><span class="w"> </span><span class="n">not</span><span class="w"> </span><span class="n">sure</span><span class="p">,</span><span class="w"> </span><span class="n">please</span><span class="w"> </span><span class="kd">let</span><span class="w"> </span><span class="n">us</span><span class="w"> </span><span class="n">know</span><span class="w"> </span><span class="n">and</span><span class="w"> </span><span class="n">we</span><span class="o">'</span><span class="na">ll</span><span class="w"> </span><span class="kr">try</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">fix</span><span class="w"> </span><span class="n">it</span><span class="p">.</span>
<span class="o">==</span><span class="mi">25125</span><span class="o">==</span><span class="w"> </span><span class="n">Either</span><span class="w"> </span><span class="n">way</span><span class="p">,</span><span class="w"> </span><span class="n">Valgrind</span><span class="w"> </span><span class="n">will</span><span class="w"> </span><span class="n">now</span><span class="w"> </span><span class="n">raise</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="n">SIGILL</span><span class="w"> </span><span class="n">signal</span><span class="w"> </span><span class="n">which</span><span class="w"> </span><span class="n">will</span>
<span class="o">==</span><span class="mi">25125</span><span class="o">==</span><span class="w"> </span><span class="n">probably</span><span class="w"> </span><span class="n">kill</span><span class="w"> </span><span class="n">your</span><span class="w"> </span><span class="n">program</span><span class="p">.</span>
</code></pre></div>
<p>On x86, Ubuntu 22.04.2 LTS, the valgrind report is:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="o">=</span><span class="mi">58680</span><span class="o">==</span><span class="w"> </span><span class="n">Invalid</span><span class="w"> </span><span class="n">write</span><span class="w"> </span><span class="n">of</span><span class="w"> </span><span class="n">size</span><span class="w"> </span><span class="mi">4</span>
<span class="o">==</span><span class="mi">58680</span><span class="o">==</span><span class="w">    </span><span class="n">at</span><span class="w"> </span><span class="mh">0x4F973B4</span>: <span class="o">???</span>
<span class="o">==</span><span class="mi">58680</span><span class="o">==</span><span class="w">    </span><span class="n">by</span><span class="w"> </span><span class="mh">0x4F96047</span>: <span class="o">???</span>
<span class="o">==</span><span class="mi">58680</span><span class="o">==</span><span class="w">    </span><span class="n">by</span><span class="w"> </span><span class="mh">0x2032D3</span>: <span class="nc">wasmtime</span>::<span class="n">func</span>::<span class="n">Func</span>::<span class="n">call_unchecked_raw</span>::<span class="p">{{</span><span class="n">closure</span><span class="p">}}</span><span class="w"> </span><span class="p">(</span><span class="n">func</span><span class="p">.</span><span class="n">rs</span>:<span class="mi">900</span><span class="p">)</span>
<span class="o">==</span><span class="mi">58680</span><span class="o">==</span><span class="w">    </span><span class="n">by</span><span class="w"> </span><span class="mh">0x20B0BA</span>: <span class="nc">wasmtime_runtime</span>::<span class="n">traphandlers</span>::<span class="n">catch_traps</span>::<span class="n">call_closure</span><span class="w"> </span><span class="p">(</span><span class="n">traphandlers</span><span class="p">.</span><span class="n">rs</span>:<span class="mi">243</span><span class="p">)</span>
<span class="o">==</span><span class="mi">58680</span><span class="o">==</span><span class="w">    </span><span class="n">by</span><span class="w"> </span><span class="mh">0xAA669F</span>: <span class="nc">wasmtime_setjmp</span><span class="w"> </span><span class="p">(</span><span class="n">helpers</span><span class="p">.</span><span class="n">c</span>:<span class="mi">55</span><span class="p">)</span>
<span class="o">==</span><span class="mi">58680</span><span class="o">==</span><span class="w">    </span><span class="n">by</span><span class="w"> </span><span class="mh">0x20B415</span>: <span class="nc">wasmtime_runtime</span>::<span class="n">traphandlers</span>::<span class="n">catch_traps</span>::<span class="p">{{</span><span class="n">closure</span><span class="p">}}</span><span class="w"> </span><span class="p">(</span><span class="n">traphandlers</span><span class="p">.</span><span class="n">rs</span>:<span class="mi">225</span><span class="p">)</span>
<span class="o">==</span><span class="mi">58680</span><span class="o">==</span><span class="w">    </span><span class="n">by</span><span class="w"> </span><span class="mh">0x20B441</span>: <span class="nc">wasmtime_runtime</span>::<span class="n">traphandlers</span>::<span class="o">&lt;</span><span class="k">impl</span><span class="w"> </span><span class="n">wasmtime_runtime</span>::<span class="n">traphandlers</span>::<span class="n">call_thread_state</span>::<span class="n">CallThreadState</span><span class="o">&gt;</span>::<span class="n">with</span>::<span class="p">{{</span><span class="n">closure</span><span class="p">}}</span><span class="w"> </span><span class="p">(</span><span class="n">traphandlers</span><span class="p">.</span><span class="n">rs</span>:<span class="mi">409</span><span class="p">)</span>
<span class="o">==</span><span class="mi">58680</span><span class="o">==</span><span class="w">    </span><span class="n">by</span><span class="w"> </span><span class="mh">0x208462</span>: <span class="nc">wasmtime_runtime</span>::<span class="n">traphandlers</span>::<span class="n">tls</span>::<span class="n">set</span><span class="w"> </span><span class="p">(</span><span class="n">traphandlers</span><span class="p">.</span><span class="n">rs</span>:<span class="mi">684</span><span class="p">)</span>
<span class="o">==</span><span class="mi">58680</span><span class="o">==</span><span class="w">    </span><span class="n">by</span><span class="w"> </span><span class="mh">0x214F1D</span>: <span class="nc">wasmtime_runtime</span>::<span class="n">traphandlers</span>::<span class="o">&lt;</span><span class="k">impl</span><span class="w"> </span><span class="n">wasmtime_runtime</span>::<span class="n">traphandlers</span>::<span class="n">call_thread_state</span>::<span class="n">CallThreadState</span><span class="o">&gt;</span>::<span class="n">with</span><span class="w"> </span><span class="p">(</span><span class="n">traphandlers</span><span class="p">.</span><span class="n">rs</span>:<span class="mi">409</span><span class="p">)</span>
<span class="o">==</span><span class="mi">58680</span><span class="o">==</span><span class="w">    </span><span class="n">by</span><span class="w"> </span><span class="mh">0x20B1BB</span>: <span class="nc">wasmtime_runtime</span>::<span class="n">traphandlers</span>::<span class="n">catch_traps</span><span class="w"> </span><span class="p">(</span><span class="n">traphandlers</span><span class="p">.</span><span class="n">rs</span>:<span class="mi">224</span><span class="p">)</span>
<span class="o">==</span><span class="mi">58680</span><span class="o">==</span><span class="w">    </span><span class="n">by</span><span class="w"> </span><span class="mh">0x202C5E</span>: <span class="nc">wasmtime</span>::<span class="n">func</span>::<span class="n">invoke_wasm_and_catch_traps</span><span class="w"> </span><span class="p">(</span><span class="n">func</span><span class="p">.</span><span class="n">rs</span>:<span class="mi">1306</span><span class="p">)</span>
<span class="o">==</span><span class="mi">58680</span><span class="o">==</span><span class="w">    </span><span class="n">by</span><span class="w"> </span><span class="mh">0x20324C</span>: <span class="nc">wasmtime</span>::<span class="n">func</span>::<span class="n">Func</span>::<span class="n">call_unchecked_raw</span><span class="w"> </span><span class="p">(</span><span class="n">func</span><span class="p">.</span><span class="n">rs</span>:<span class="mi">898</span><span class="p">)</span>
<span class="o">==</span><span class="mi">58680</span><span class="o">==</span><span class="w">  </span><span class="n">Address</span><span class="w"> </span><span class="mh">0x1ffeffc580</span><span class="w"> </span><span class="n">is</span><span class="w"> </span><span class="n">on</span><span class="w"> </span><span class="n">thread</span><span class="w"> </span><span class="mi">1</span><span class="o">'</span><span class="na">s</span><span class="w"> </span><span class="n">stack</span>
<span class="o">==</span><span class="mi">58680</span><span class="o">==</span><span class="w">  </span><span class="mi">4096</span><span class="w"> </span><span class="n">bytes</span><span class="w"> </span><span class="n">below</span><span class="w"> </span><span class="n">stack</span><span class="w"> </span><span class="n">pointer</span>
<span class="o">==</span><span class="mi">58680</span><span class="o">==</span>
<span class="o">==</span><span class="mi">58680</span><span class="o">==</span><span class="w"> </span><span class="n">Invalid</span><span class="w"> </span><span class="n">write</span><span class="w"> </span><span class="n">of</span><span class="w"> </span><span class="n">size</span><span class="w"> </span><span class="mi">4</span>
<span class="o">==</span><span class="mi">58680</span><span class="o">==</span><span class="w">    </span><span class="n">at</span><span class="w"> </span><span class="mh">0x4F973BB</span>: <span class="o">???</span>
<span class="o">==</span><span class="mi">58680</span><span class="o">==</span><span class="w">    </span><span class="n">by</span><span class="w"> </span><span class="mh">0x4F96047</span>: <span class="o">???</span>
<span class="o">==</span><span class="mi">58680</span><span class="o">==</span><span class="w">    </span><span class="n">by</span><span class="w"> </span><span class="mh">0x2032D3</span>: <span class="nc">wasmtime</span>::<span class="n">func</span>::<span class="n">Func</span>::<span class="n">call_unchecked_raw</span>::<span class="p">{{</span><span class="n">closure</span><span class="p">}}</span><span class="w"> </span><span class="p">(</span><span class="n">func</span><span class="p">.</span><span class="n">rs</span>:<span class="mi">900</span><span class="p">)</span>
<span class="o">==</span><span class="mi">58680</span><span class="o">==</span><span class="w">    </span><span class="n">by</span><span class="w"> </span><span class="mh">0x20B0BA</span>: <span class="nc">wasmtime_runtime</span>::<span class="n">traphandlers</span>::<span class="n">catch_traps</span>::<span class="n">call_closure</span><span class="w"> </span><span class="p">(</span><span class="n">traphandlers</span><span class="p">.</span><span class="n">rs</span>:<span class="mi">243</span><span class="p">)</span>
<span class="o">==</span><span class="mi">58680</span><span class="o">==</span><span class="w">    </span><span class="n">by</span><span class="w"> </span><span class="mh">0xAA669F</span>: <span class="nc">wasmtime_setjmp</span><span class="w"> </span><span class="p">(</span><span class="n">helpers</span><span class="p">.</span><span class="n">c</span>:<span class="mi">55</span><span class="p">)</span>
<span class="o">==</span><span class="mi">58680</span><span class="o">==</span><span class="w">    </span><span class="n">by</span><span class="w"> </span><span class="mh">0x20B415</span>: <span class="nc">wasmtime_runtime</span>::<span class="n">traphandlers</span>::<span class="n">catch_traps</span>::<span class="p">{{</span><span class="n">closure</span><span class="p">}}</span><span class="w"> </span><span class="p">(</span><span class="n">traphandlers</span><span class="p">.</span><span class="n">rs</span>:<span class="mi">225</span><span class="p">)</span>
<span class="o">==</span><span class="mi">58680</span><span class="o">==</span><span class="w">    </span><span class="n">by</span><span class="w"> </span><span class="mh">0x20B441</span>: <span class="nc">wasmtime_runtime</span>::<span class="n">traphandlers</span>::<span class="o">&lt;</span><span class="k">impl</span><span class="w"> </span><span class="n">wasmtime_runtime</span>::<span class="n">traphandlers</span>::<span class="n">call_thread_state</span>::<span class="n">CallThreadState</span><span class="o">&gt;</span>::<span class="n">with</span>::<span class="p">{{</span><span class="n">closure</span><span class="p">}}</span><span class="w"> </span><span class="p">(</span><span class="n">traphandlers</span><span class="p">.</span><span class="n">rs</span>:<span class="mi">409</span><span class="p">)</span>
<span class="o">==</span><span class="mi">58680</span><span class="o">==</span><span class="w">    </span><span class="n">by</span><span class="w"> </span><span class="mh">0x208462</span>: <span class="nc">wasmtime_runtime</span>::<span class="n">traphandlers</span>::<span class="n">tls</span>::<span class="n">set</span><span class="w"> </span><span class="p">(</span><span class="n">traphandlers</span><span class="p">.</span><span class="n">rs</span>:<span class="mi">684</span><span class="p">)</span>
<span class="o">==</span><span class="mi">58680</span><span class="o">==</span><span class="w">    </span><span class="n">by</span><span class="w"> </span><span class="mh">0x214F1D</span>: <span class="nc">wasmtime_runtime</span>::<span class="n">traphandlers</span>::<span class="o">&lt;</span><span class="k">impl</span><span class="w"> </span><span class="n">wasmtime_runtime</span>::<span class="n">traphandlers</span>::<span class="n">call_thread_state</span>::<span class="n">CallThreadState</span><span class="o">&gt;</span>::<span class="n">with</span><span class="w"> </span><span class="p">(</span><span class="n">traphandlers</span><span class="p">.</span><span class="n">rs</span>:<span class="mi">409</span><span class="p">)</span>
<span class="o">==</span><span class="mi">58680</span><span class="o">==</span><span class="w">    </span><span class="n">by</span><span class="w"> </span><span class="mh">0x20B1BB</span>: <span class="nc">wasmtime_runtime</span>::<span class="n">traphandlers</span>::<span class="n">catch_traps</span><span class="w"> </span><span class="p">(</span><span class="n">traphandlers</span><span class="p">.</span><span class="n">rs</span>:<span class="mi">224</span><span class="p">)</span>
<span class="o">==</span><span class="mi">58680</span><span class="o">==</span><span class="w">    </span><span class="n">by</span><span class="w"> </span><span class="mh">0x202C5E</span>: <span class="nc">wasmtime</span>::<span class="n">func</span>::<span class="n">invoke_wasm_and_catch_traps</span><span class="w"> </span><span class="p">(</span><span class="n">func</span><span class="p">.</span><span class="n">rs</span>:<span class="mi">1306</span><span class="p">)</span>
<span class="o">==</span><span class="mi">58680</span><span class="o">==</span><span class="w">    </span><span class="n">by</span><span class="w"> </span><span class="mh">0x20324C</span>: <span class="nc">wasmtime</span>::<span class="n">func</span>::<span class="n">Func</span>::<span class="n">call_unchecked_raw</span><span class="w"> </span><span class="p">(</span><span class="n">func</span><span class="p">.</span><span class="n">rs</span>:<span class="mi">898</span><span class="p">)</span>
<span class="o">==</span><span class="mi">58680</span><span class="o">==</span><span class="w">  </span><span class="n">Address</span><span class="w"> </span><span class="mh">0x1ffeffb580</span><span class="w"> </span><span class="n">is</span><span class="w"> </span><span class="n">on</span><span class="w"> </span><span class="n">thread</span><span class="w"> </span><span class="mi">1</span><span class="o">'</span><span class="na">s</span><span class="w"> </span><span class="n">stack</span>
<span class="o">==</span><span class="mi">58680</span><span class="o">==</span><span class="w">  </span><span class="mi">8192</span><span class="w"> </span><span class="n">bytes</span><span class="w"> </span><span class="n">below</span><span class="w"> </span><span class="n">stack</span><span class="w"> </span><span class="n">pointer</span>
</code></pre></div>
<h3>Extra Info</h3>
<p>I don't know if it's an actual bug, but figured I should report it. Feel free to close it if it's a false-positive.<br>
</p>
</blockquote>



<a name="355253524"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%236326%20Valgrind%20errors%20for%20%60Func%60%20175%2B%20re.../near/355253524" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.236326.20Valgrind.20errors.20for.20.60Func.60.20175.2B.20re.2E.2E.2E.html#355253524">(May 02 2023 at 19:58)</a>:</h4>
<p>jameysharp <a href="https://github.com/bytecodealliance/wasmtime/issues/6326#issuecomment-1532068098">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/6326">issue #6326</a>:</p>
<blockquote>
<p>Here's a quick first look at this issue, not the final word on anything.</p>
<p>I'm guessing the issue on aarch64 is that we're using a real instruction that is unimplemented in that version of valgrind, which would mean that one is not our bug. But I haven't verified that and could certainly be wrong.</p>
<p>As for the invalid writes on x86, that could be our bug, but I'm not sure. The relevant code changed a lot last week in #6262, after the 8.0 release, so I'm curious if it's still reproducible on current git <code>main</code>. Do you have time to give that a try?</p>
</blockquote>



<a name="355265408"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%236326%20Valgrind%20errors%20for%20%60Func%60%20175%2B%20re.../near/355265408" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.236326.20Valgrind.20errors.20for.20.60Func.60.20175.2B.20re.2E.2E.2E.html#355265408">(May 02 2023 at 21:05)</a>:</h4>
<p>jbourassa <a href="https://github.com/bytecodealliance/wasmtime/issues/6326#issuecomment-1532151027">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/6326">issue #6326</a>:</p>
<blockquote>
<blockquote>
<p>Do you have time to give that a try?</p>
</blockquote>
<p>valgrind reports are gone on <code>main</code>, both for aarch64 and x86 <span aria-label="tada" class="emoji emoji-1f389" role="img" title="tada">:tada:</span>. I guess we can close this issue.</p>
<p>Thanks Jamey!<br>
</p>
</blockquote>



<a name="355265409"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%236326%20Valgrind%20errors%20for%20%60Func%60%20175%2B%20re.../near/355265409" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.236326.20Valgrind.20errors.20for.20.60Func.60.20175.2B.20re.2E.2E.2E.html#355265409">(May 02 2023 at 21:05)</a>:</h4>
<p>jbourassa closed <a href="https://github.com/bytecodealliance/wasmtime/issues/6326">issue #6326</a>:</p>
<blockquote>
<h3>Test Case</h3>
<p>This repo: <a href="https://github.com/jbourassa/wasmtime-results-valgrind-report">https://github.com/jbourassa/wasmtime-results-valgrind-report</a></p>
<p>The repro case is a host-defined <code>wasmtime::Func</code> that returns 200 results:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="k">use</span><span class="w"> </span><span class="n">wasmtime</span>::<span class="p">{</span><span class="n">AsContextMut</span><span class="p">,</span><span class="w"> </span><span class="n">Engine</span><span class="p">,</span><span class="w"> </span><span class="n">Func</span><span class="p">,</span><span class="w"> </span><span class="n">Store</span><span class="p">};</span>
<span class="k">const</span><span class="w"> </span><span class="n">RESULTS_COUNT</span>: <span class="kt">i32</span> <span class="o">=</span><span class="w"> </span><span class="mi">200</span><span class="p">;</span>

<span class="k">fn</span> <span class="nf">main</span><span class="p">()</span><span class="w"> </span>-&gt; <span class="nc">wasmtime</span>::<span class="nb">Result</span><span class="o">&lt;</span><span class="p">()</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">engine</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Engine</span>::<span class="n">default</span><span class="p">();</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">store</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Store</span>::<span class="n">new</span><span class="p">(</span><span class="o">&amp;</span><span class="n">engine</span><span class="p">,</span><span class="w"> </span><span class="p">());</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">result_type</span>: <span class="nb">Vec</span><span class="o">&lt;</span><span class="n">_</span><span class="o">&gt;</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="mi">0</span><span class="o">..</span><span class="n">RESULTS_COUNT</span><span class="p">).</span><span class="n">map</span><span class="p">(</span><span class="o">|</span><span class="n">_</span><span class="o">|</span><span class="w"> </span><span class="n">wasmtime</span>::<span class="n">ValType</span>::<span class="n">I32</span><span class="p">).</span><span class="n">collect</span><span class="p">();</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">func_type</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">wasmtime</span>::<span class="n">FuncType</span>::<span class="n">new</span><span class="p">([],</span><span class="w"> </span><span class="n">result_type</span><span class="p">);</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">func</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Func</span>::<span class="n">new</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="n">store</span><span class="p">,</span><span class="w"> </span><span class="n">func_type</span><span class="p">.</span><span class="n">clone</span><span class="p">(),</span><span class="w"> </span><span class="o">|</span><span class="n">_</span><span class="p">,</span><span class="w"> </span><span class="n">_</span><span class="p">,</span><span class="w"> </span><span class="n">results</span><span class="o">|</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">results</span>
<span class="w">            </span><span class="p">.</span><span class="n">iter_mut</span><span class="p">()</span>
<span class="w">            </span><span class="p">.</span><span class="n">for_each</span><span class="p">(</span><span class="o">|</span><span class="n">val</span><span class="o">|</span><span class="w"> </span><span class="o">*</span><span class="n">val</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">wasmtime</span>::<span class="n">Val</span>::<span class="n">I32</span><span class="p">(</span><span class="mi">1</span><span class="p">));</span>
<span class="w">        </span><span class="nb">Ok</span><span class="p">(())</span>
<span class="w">    </span><span class="p">});</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">results</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="fm">vec!</span><span class="p">[</span><span class="n">wasmtime</span>::<span class="n">Val</span>::<span class="n">null</span><span class="p">();</span><span class="w"> </span><span class="n">func_type</span><span class="p">.</span><span class="n">results</span><span class="p">().</span><span class="n">len</span><span class="p">()];</span>
<span class="w">    </span><span class="n">func</span><span class="p">.</span><span class="n">call</span><span class="p">(</span><span class="n">store</span><span class="p">.</span><span class="n">as_context_mut</span><span class="p">(),</span><span class="w"> </span><span class="o">&amp;</span><span class="p">[],</span><span class="w"> </span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="n">results</span><span class="p">)</span><span class="o">?</span><span class="p">;</span>
<span class="w">    </span><span class="nb">Ok</span><span class="p">(())</span>
<span class="p">}</span>
</code></pre></div>
<h3>Steps to Reproduce</h3>
<ol>
<li>Clone the <a href="https://github.com/jbourassa/wasmtime-results-valgrind-report">repo</a></li>
<li>Run the executable with valgrind: <code>cargo build &amp;&amp; valgrind target/debug/many-results</code></li>
</ol>
<h3>Result, Version, Environment</h3>
<p>Wasmtime version: v8.0.1 (but also appeared in 7.0 and likely earlier versions)</p>
<p>Valgrind version: 3.21.0 (latest, but also reproducible with 3.18.1)</p>
<p>On aarch64 (Linux running on an ARM-based Mac), Ubuntu 22.10, the valgrind report is:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="n">ARM64</span><span class="w"> </span><span class="n">front</span><span class="w"> </span><span class="n">end</span>: <span class="nc">load_store</span>
<span class="n">disInstr</span><span class="p">(</span><span class="n">arm64</span><span class="p">)</span>: <span class="nc">unhandled</span><span class="w"> </span><span class="n">instruction</span><span class="w"> </span><span class="mh">0xB830EBFF</span>
<span class="n">disInstr</span><span class="p">(</span><span class="n">arm64</span><span class="p">)</span>: <span class="mi">1011</span><span class="o">'</span><span class="mi">1000</span><span class="w"> </span><span class="mi">0011</span><span class="o">'</span><span class="mi">0000</span><span class="w"> </span><span class="mi">1110</span><span class="o">'</span><span class="mi">1011</span><span class="w"> </span><span class="mi">1111</span><span class="o">'</span><span class="mi">1111</span>
<span class="o">==</span><span class="mi">25125</span><span class="o">==</span><span class="w"> </span><span class="n">valgrind</span>: <span class="nc">Unrecognised</span><span class="w"> </span><span class="n">instruction</span><span class="w"> </span><span class="n">at</span><span class="w"> </span><span class="n">address</span><span class="w"> </span><span class="mh">0x4f6fc2c</span><span class="p">.</span>
<span class="o">==</span><span class="mi">25125</span><span class="o">==</span><span class="w">    </span><span class="n">at</span><span class="w"> </span><span class="mh">0x4F6FC2C</span>: <span class="o">???</span>
<span class="o">==</span><span class="mi">25125</span><span class="o">==</span><span class="w"> </span><span class="n">Your</span><span class="w"> </span><span class="n">program</span><span class="w"> </span><span class="n">just</span><span class="w"> </span><span class="n">tried</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">execute</span><span class="w"> </span><span class="n">an</span><span class="w"> </span><span class="n">instruction</span><span class="w"> </span><span class="n">that</span><span class="w"> </span><span class="n">Valgrind</span>
<span class="o">==</span><span class="mi">25125</span><span class="o">==</span><span class="w"> </span><span class="n">did</span><span class="w"> </span><span class="n">not</span><span class="w"> </span><span class="n">recognise</span><span class="p">.</span><span class="w">  </span><span class="n">There</span><span class="w"> </span><span class="n">are</span><span class="w"> </span><span class="n">two</span><span class="w"> </span><span class="n">possible</span><span class="w"> </span><span class="n">reasons</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">this</span><span class="p">.</span>
<span class="o">==</span><span class="mi">25125</span><span class="o">==</span><span class="w"> </span><span class="mf">1.</span><span class="w"> </span><span class="n">Your</span><span class="w"> </span><span class="n">program</span><span class="w"> </span><span class="n">has</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="n">bug</span><span class="w"> </span><span class="n">and</span><span class="w"> </span><span class="n">erroneously</span><span class="w"> </span><span class="n">jumped</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="n">non</span><span class="o">-</span><span class="n">code</span>
<span class="o">==</span><span class="mi">25125</span><span class="o">==</span><span class="w">    </span><span class="n">location</span><span class="p">.</span><span class="w">  </span><span class="n">If</span><span class="w"> </span><span class="n">you</span><span class="w"> </span><span class="n">are</span><span class="w"> </span><span class="n">running</span><span class="w"> </span><span class="n">Memcheck</span><span class="w"> </span><span class="n">and</span><span class="w"> </span><span class="n">you</span><span class="w"> </span><span class="n">just</span><span class="w"> </span><span class="n">saw</span><span class="w"> </span><span class="n">a</span>
<span class="o">==</span><span class="mi">25125</span><span class="o">==</span><span class="w">    </span><span class="n">warning</span><span class="w"> </span><span class="n">about</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="n">bad</span><span class="w"> </span><span class="n">jump</span><span class="p">,</span><span class="w"> </span><span class="n">it</span><span class="o">'</span><span class="na">s</span><span class="w"> </span><span class="n">probably</span><span class="w"> </span><span class="n">your</span><span class="w"> </span><span class="n">program</span><span class="o">'</span><span class="na">s</span><span class="w"> </span><span class="n">fault</span><span class="p">.</span>
<span class="o">==</span><span class="mi">25125</span><span class="o">==</span><span class="w"> </span><span class="mf">2.</span><span class="w"> </span><span class="n">The</span><span class="w"> </span><span class="n">instruction</span><span class="w"> </span><span class="n">is</span><span class="w"> </span><span class="n">legitimate</span><span class="w"> </span><span class="n">but</span><span class="w"> </span><span class="n">Valgrind</span><span class="w"> </span><span class="n">doesn</span><span class="o">'</span><span class="na">t</span><span class="w"> </span><span class="n">handle</span><span class="w"> </span><span class="n">it</span><span class="p">,</span>
<span class="o">==</span><span class="mi">25125</span><span class="o">==</span><span class="w">    </span><span class="n">i</span><span class="p">.</span><span class="n">e</span><span class="p">.</span><span class="w"> </span><span class="n">it</span><span class="o">'</span><span class="na">s</span><span class="w"> </span><span class="n">Valgrind</span><span class="o">'</span><span class="na">s</span><span class="w"> </span><span class="n">fault</span><span class="p">.</span><span class="w">  </span><span class="n">If</span><span class="w"> </span><span class="n">you</span><span class="w"> </span><span class="n">think</span><span class="w"> </span><span class="n">this</span><span class="w"> </span><span class="n">is</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">case</span><span class="w"> </span><span class="n">or</span>
<span class="o">==</span><span class="mi">25125</span><span class="o">==</span><span class="w">    </span><span class="n">you</span><span class="w"> </span><span class="n">are</span><span class="w"> </span><span class="n">not</span><span class="w"> </span><span class="n">sure</span><span class="p">,</span><span class="w"> </span><span class="n">please</span><span class="w"> </span><span class="kd">let</span><span class="w"> </span><span class="n">us</span><span class="w"> </span><span class="n">know</span><span class="w"> </span><span class="n">and</span><span class="w"> </span><span class="n">we</span><span class="o">'</span><span class="na">ll</span><span class="w"> </span><span class="kr">try</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">fix</span><span class="w"> </span><span class="n">it</span><span class="p">.</span>
<span class="o">==</span><span class="mi">25125</span><span class="o">==</span><span class="w"> </span><span class="n">Either</span><span class="w"> </span><span class="n">way</span><span class="p">,</span><span class="w"> </span><span class="n">Valgrind</span><span class="w"> </span><span class="n">will</span><span class="w"> </span><span class="n">now</span><span class="w"> </span><span class="n">raise</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="n">SIGILL</span><span class="w"> </span><span class="n">signal</span><span class="w"> </span><span class="n">which</span><span class="w"> </span><span class="n">will</span>
<span class="o">==</span><span class="mi">25125</span><span class="o">==</span><span class="w"> </span><span class="n">probably</span><span class="w"> </span><span class="n">kill</span><span class="w"> </span><span class="n">your</span><span class="w"> </span><span class="n">program</span><span class="p">.</span>
</code></pre></div>
<p>On x86, Ubuntu 22.04.2 LTS, the valgrind report is:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="o">=</span><span class="mi">58680</span><span class="o">==</span><span class="w"> </span><span class="n">Invalid</span><span class="w"> </span><span class="n">write</span><span class="w"> </span><span class="n">of</span><span class="w"> </span><span class="n">size</span><span class="w"> </span><span class="mi">4</span>
<span class="o">==</span><span class="mi">58680</span><span class="o">==</span><span class="w">    </span><span class="n">at</span><span class="w"> </span><span class="mh">0x4F973B4</span>: <span class="o">???</span>
<span class="o">==</span><span class="mi">58680</span><span class="o">==</span><span class="w">    </span><span class="n">by</span><span class="w"> </span><span class="mh">0x4F96047</span>: <span class="o">???</span>
<span class="o">==</span><span class="mi">58680</span><span class="o">==</span><span class="w">    </span><span class="n">by</span><span class="w"> </span><span class="mh">0x2032D3</span>: <span class="nc">wasmtime</span>::<span class="n">func</span>::<span class="n">Func</span>::<span class="n">call_unchecked_raw</span>::<span class="p">{{</span><span class="n">closure</span><span class="p">}}</span><span class="w"> </span><span class="p">(</span><span class="n">func</span><span class="p">.</span><span class="n">rs</span>:<span class="mi">900</span><span class="p">)</span>
<span class="o">==</span><span class="mi">58680</span><span class="o">==</span><span class="w">    </span><span class="n">by</span><span class="w"> </span><span class="mh">0x20B0BA</span>: <span class="nc">wasmtime_runtime</span>::<span class="n">traphandlers</span>::<span class="n">catch_traps</span>::<span class="n">call_closure</span><span class="w"> </span><span class="p">(</span><span class="n">traphandlers</span><span class="p">.</span><span class="n">rs</span>:<span class="mi">243</span><span class="p">)</span>
<span class="o">==</span><span class="mi">58680</span><span class="o">==</span><span class="w">    </span><span class="n">by</span><span class="w"> </span><span class="mh">0xAA669F</span>: <span class="nc">wasmtime_setjmp</span><span class="w"> </span><span class="p">(</span><span class="n">helpers</span><span class="p">.</span><span class="n">c</span>:<span class="mi">55</span><span class="p">)</span>
<span class="o">==</span><span class="mi">58680</span><span class="o">==</span><span class="w">    </span><span class="n">by</span><span class="w"> </span><span class="mh">0x20B415</span>: <span class="nc">wasmtime_runtime</span>::<span class="n">traphandlers</span>::<span class="n">catch_traps</span>::<span class="p">{{</span><span class="n">closure</span><span class="p">}}</span><span class="w"> </span><span class="p">(</span><span class="n">traphandlers</span><span class="p">.</span><span class="n">rs</span>:<span class="mi">225</span><span class="p">)</span>
<span class="o">==</span><span class="mi">58680</span><span class="o">==</span><span class="w">    </span><span class="n">by</span><span class="w"> </span><span class="mh">0x20B441</span>: <span class="nc">wasmtime_runtime</span>::<span class="n">traphandlers</span>::<span class="o">&lt;</span><span class="k">impl</span><span class="w"> </span><span class="n">wasmtime_runtime</span>::<span class="n">traphandlers</span>::<span class="n">call_thread_state</span>::<span class="n">CallThreadState</span><span class="o">&gt;</span>::<span class="n">with</span>::<span class="p">{{</span><span class="n">closure</span><span class="p">}}</span><span class="w"> </span><span class="p">(</span><span class="n">traphandlers</span><span class="p">.</span><span class="n">rs</span>:<span class="mi">409</span><span class="p">)</span>
<span class="o">==</span><span class="mi">58680</span><span class="o">==</span><span class="w">    </span><span class="n">by</span><span class="w"> </span><span class="mh">0x208462</span>: <span class="nc">wasmtime_runtime</span>::<span class="n">traphandlers</span>::<span class="n">tls</span>::<span class="n">set</span><span class="w"> </span><span class="p">(</span><span class="n">traphandlers</span><span class="p">.</span><span class="n">rs</span>:<span class="mi">684</span><span class="p">)</span>
<span class="o">==</span><span class="mi">58680</span><span class="o">==</span><span class="w">    </span><span class="n">by</span><span class="w"> </span><span class="mh">0x214F1D</span>: <span class="nc">wasmtime_runtime</span>::<span class="n">traphandlers</span>::<span class="o">&lt;</span><span class="k">impl</span><span class="w"> </span><span class="n">wasmtime_runtime</span>::<span class="n">traphandlers</span>::<span class="n">call_thread_state</span>::<span class="n">CallThreadState</span><span class="o">&gt;</span>::<span class="n">with</span><span class="w"> </span><span class="p">(</span><span class="n">traphandlers</span><span class="p">.</span><span class="n">rs</span>:<span class="mi">409</span><span class="p">)</span>
<span class="o">==</span><span class="mi">58680</span><span class="o">==</span><span class="w">    </span><span class="n">by</span><span class="w"> </span><span class="mh">0x20B1BB</span>: <span class="nc">wasmtime_runtime</span>::<span class="n">traphandlers</span>::<span class="n">catch_traps</span><span class="w"> </span><span class="p">(</span><span class="n">traphandlers</span><span class="p">.</span><span class="n">rs</span>:<span class="mi">224</span><span class="p">)</span>
<span class="o">==</span><span class="mi">58680</span><span class="o">==</span><span class="w">    </span><span class="n">by</span><span class="w"> </span><span class="mh">0x202C5E</span>: <span class="nc">wasmtime</span>::<span class="n">func</span>::<span class="n">invoke_wasm_and_catch_traps</span><span class="w"> </span><span class="p">(</span><span class="n">func</span><span class="p">.</span><span class="n">rs</span>:<span class="mi">1306</span><span class="p">)</span>
<span class="o">==</span><span class="mi">58680</span><span class="o">==</span><span class="w">    </span><span class="n">by</span><span class="w"> </span><span class="mh">0x20324C</span>: <span class="nc">wasmtime</span>::<span class="n">func</span>::<span class="n">Func</span>::<span class="n">call_unchecked_raw</span><span class="w"> </span><span class="p">(</span><span class="n">func</span><span class="p">.</span><span class="n">rs</span>:<span class="mi">898</span><span class="p">)</span>
<span class="o">==</span><span class="mi">58680</span><span class="o">==</span><span class="w">  </span><span class="n">Address</span><span class="w"> </span><span class="mh">0x1ffeffc580</span><span class="w"> </span><span class="n">is</span><span class="w"> </span><span class="n">on</span><span class="w"> </span><span class="n">thread</span><span class="w"> </span><span class="mi">1</span><span class="o">'</span><span class="na">s</span><span class="w"> </span><span class="n">stack</span>
<span class="o">==</span><span class="mi">58680</span><span class="o">==</span><span class="w">  </span><span class="mi">4096</span><span class="w"> </span><span class="n">bytes</span><span class="w"> </span><span class="n">below</span><span class="w"> </span><span class="n">stack</span><span class="w"> </span><span class="n">pointer</span>
<span class="o">==</span><span class="mi">58680</span><span class="o">==</span>
<span class="o">==</span><span class="mi">58680</span><span class="o">==</span><span class="w"> </span><span class="n">Invalid</span><span class="w"> </span><span class="n">write</span><span class="w"> </span><span class="n">of</span><span class="w"> </span><span class="n">size</span><span class="w"> </span><span class="mi">4</span>
<span class="o">==</span><span class="mi">58680</span><span class="o">==</span><span class="w">    </span><span class="n">at</span><span class="w"> </span><span class="mh">0x4F973BB</span>: <span class="o">???</span>
<span class="o">==</span><span class="mi">58680</span><span class="o">==</span><span class="w">    </span><span class="n">by</span><span class="w"> </span><span class="mh">0x4F96047</span>: <span class="o">???</span>
<span class="o">==</span><span class="mi">58680</span><span class="o">==</span><span class="w">    </span><span class="n">by</span><span class="w"> </span><span class="mh">0x2032D3</span>: <span class="nc">wasmtime</span>::<span class="n">func</span>::<span class="n">Func</span>::<span class="n">call_unchecked_raw</span>::<span class="p">{{</span><span class="n">closure</span><span class="p">}}</span><span class="w"> </span><span class="p">(</span><span class="n">func</span><span class="p">.</span><span class="n">rs</span>:<span class="mi">900</span><span class="p">)</span>
<span class="o">==</span><span class="mi">58680</span><span class="o">==</span><span class="w">    </span><span class="n">by</span><span class="w"> </span><span class="mh">0x20B0BA</span>: <span class="nc">wasmtime_runtime</span>::<span class="n">traphandlers</span>::<span class="n">catch_traps</span>::<span class="n">call_closure</span><span class="w"> </span><span class="p">(</span><span class="n">traphandlers</span><span class="p">.</span><span class="n">rs</span>:<span class="mi">243</span><span class="p">)</span>
<span class="o">==</span><span class="mi">58680</span><span class="o">==</span><span class="w">    </span><span class="n">by</span><span class="w"> </span><span class="mh">0xAA669F</span>: <span class="nc">wasmtime_setjmp</span><span class="w"> </span><span class="p">(</span><span class="n">helpers</span><span class="p">.</span><span class="n">c</span>:<span class="mi">55</span><span class="p">)</span>
<span class="o">==</span><span class="mi">58680</span><span class="o">==</span><span class="w">    </span><span class="n">by</span><span class="w"> </span><span class="mh">0x20B415</span>: <span class="nc">wasmtime_runtime</span>::<span class="n">traphandlers</span>::<span class="n">catch_traps</span>::<span class="p">{{</span><span class="n">closure</span><span class="p">}}</span><span class="w"> </span><span class="p">(</span><span class="n">traphandlers</span><span class="p">.</span><span class="n">rs</span>:<span class="mi">225</span><span class="p">)</span>
<span class="o">==</span><span class="mi">58680</span><span class="o">==</span><span class="w">    </span><span class="n">by</span><span class="w"> </span><span class="mh">0x20B441</span>: <span class="nc">wasmtime_runtime</span>::<span class="n">traphandlers</span>::<span class="o">&lt;</span><span class="k">impl</span><span class="w"> </span><span class="n">wasmtime_runtime</span>::<span class="n">traphandlers</span>::<span class="n">call_thread_state</span>::<span class="n">CallThreadState</span><span class="o">&gt;</span>::<span class="n">with</span>::<span class="p">{{</span><span class="n">closure</span><span class="p">}}</span><span class="w"> </span><span class="p">(</span><span class="n">traphandlers</span><span class="p">.</span><span class="n">rs</span>:<span class="mi">409</span><span class="p">)</span>
<span class="o">==</span><span class="mi">58680</span><span class="o">==</span><span class="w">    </span><span class="n">by</span><span class="w"> </span><span class="mh">0x208462</span>: <span class="nc">wasmtime_runtime</span>::<span class="n">traphandlers</span>::<span class="n">tls</span>::<span class="n">set</span><span class="w"> </span><span class="p">(</span><span class="n">traphandlers</span><span class="p">.</span><span class="n">rs</span>:<span class="mi">684</span><span class="p">)</span>
<span class="o">==</span><span class="mi">58680</span><span class="o">==</span><span class="w">    </span><span class="n">by</span><span class="w"> </span><span class="mh">0x214F1D</span>: <span class="nc">wasmtime_runtime</span>::<span class="n">traphandlers</span>::<span class="o">&lt;</span><span class="k">impl</span><span class="w"> </span><span class="n">wasmtime_runtime</span>::<span class="n">traphandlers</span>::<span class="n">call_thread_state</span>::<span class="n">CallThreadState</span><span class="o">&gt;</span>::<span class="n">with</span><span class="w"> </span><span class="p">(</span><span class="n">traphandlers</span><span class="p">.</span><span class="n">rs</span>:<span class="mi">409</span><span class="p">)</span>
<span class="o">==</span><span class="mi">58680</span><span class="o">==</span><span class="w">    </span><span class="n">by</span><span class="w"> </span><span class="mh">0x20B1BB</span>: <span class="nc">wasmtime_runtime</span>::<span class="n">traphandlers</span>::<span class="n">catch_traps</span><span class="w"> </span><span class="p">(</span><span class="n">traphandlers</span><span class="p">.</span><span class="n">rs</span>:<span class="mi">224</span><span class="p">)</span>
<span class="o">==</span><span class="mi">58680</span><span class="o">==</span><span class="w">    </span><span class="n">by</span><span class="w"> </span><span class="mh">0x202C5E</span>: <span class="nc">wasmtime</span>::<span class="n">func</span>::<span class="n">invoke_wasm_and_catch_traps</span><span class="w"> </span><span class="p">(</span><span class="n">func</span><span class="p">.</span><span class="n">rs</span>:<span class="mi">1306</span><span class="p">)</span>
<span class="o">==</span><span class="mi">58680</span><span class="o">==</span><span class="w">    </span><span class="n">by</span><span class="w"> </span><span class="mh">0x20324C</span>: <span class="nc">wasmtime</span>::<span class="n">func</span>::<span class="n">Func</span>::<span class="n">call_unchecked_raw</span><span class="w"> </span><span class="p">(</span><span class="n">func</span><span class="p">.</span><span class="n">rs</span>:<span class="mi">898</span><span class="p">)</span>
<span class="o">==</span><span class="mi">58680</span><span class="o">==</span><span class="w">  </span><span class="n">Address</span><span class="w"> </span><span class="mh">0x1ffeffb580</span><span class="w"> </span><span class="n">is</span><span class="w"> </span><span class="n">on</span><span class="w"> </span><span class="n">thread</span><span class="w"> </span><span class="mi">1</span><span class="o">'</span><span class="na">s</span><span class="w"> </span><span class="n">stack</span>
<span class="o">==</span><span class="mi">58680</span><span class="o">==</span><span class="w">  </span><span class="mi">8192</span><span class="w"> </span><span class="n">bytes</span><span class="w"> </span><span class="n">below</span><span class="w"> </span><span class="n">stack</span><span class="w"> </span><span class="n">pointer</span>
</code></pre></div>
<h3>Extra Info</h3>
<p>I don't know if it's an actual bug, but figured I should report it. Feel free to close it if it's a false-positive.<br>
</p>
</blockquote>



<hr><p>Last updated: Jan 20 2025 at 06:04 UTC</p>
</html>