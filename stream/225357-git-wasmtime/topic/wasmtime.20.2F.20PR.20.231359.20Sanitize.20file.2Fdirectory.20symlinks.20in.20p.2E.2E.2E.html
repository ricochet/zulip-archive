<html>
<head><meta charset="utf-8"><title>wasmtime / PR #1359 Sanitize file/directory symlinks in p... · git-wasmtime · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/index.html">git-wasmtime</a></h2>
<h3>Topic: <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231359.20Sanitize.20file.2Fdirectory.20symlinks.20in.20p.2E.2E.2E.html">wasmtime / PR #1359 Sanitize file/directory symlinks in p...</a></h3>

<hr>

<base href="https://bytecodealliance.zulipchat.com">

<head><link href="https://bytecodealliance.github.io/zulip-archive/style.css" rel="stylesheet"></head>

<a name="191033583"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231359%20Sanitize%20file/directory%20symlinks%20in%20p.../near/191033583" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231359.20Sanitize.20file.2Fdirectory.20symlinks.20in.20p.2E.2E.2E.html#191033583">(Mar 18 2020 at 19:55)</a>:</h4>
<p><strong>marmistrz</strong> requested <a href="https://github.com/peterhuene" target="_blank" title="https://github.com/peterhuene">peterhuene</a>, <a href="https://github.com/kubkon" target="_blank" title="https://github.com/kubkon">kubkon</a>, and <a href="https://github.com/sunfishcode" target="_blank" title="https://github.com/sunfishcode">sunfishcode</a> for a review on <a href="https://github.com/bytecodealliance/wasmtime/pull/1359" target="_blank" title="https://github.com/bytecodealliance/wasmtime/pull/1359">PR #1359</a>.</p>



<a name="191033584"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231359%20Sanitize%20file/directory%20symlinks%20in%20p.../near/191033584" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231359.20Sanitize.20file.2Fdirectory.20symlinks.20in.20p.2E.2E.2E.html#191033584">(Mar 18 2020 at 19:55)</a>:</h4>
<p><strong>marmistrz</strong> requested <a href="https://github.com/peterhuene" target="_blank" title="https://github.com/peterhuene">peterhuene</a>, <a href="https://github.com/kubkon" target="_blank" title="https://github.com/kubkon">kubkon</a>, and <a href="https://github.com/sunfishcode" target="_blank" title="https://github.com/sunfishcode">sunfishcode</a> for a review on <a href="https://github.com/bytecodealliance/wasmtime/pull/1359" target="_blank" title="https://github.com/bytecodealliance/wasmtime/pull/1359">PR #1359</a>.</p>



<a name="191033585"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231359%20Sanitize%20file/directory%20symlinks%20in%20p.../near/191033585" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231359.20Sanitize.20file.2Fdirectory.20symlinks.20in.20p.2E.2E.2E.html#191033585">(Mar 18 2020 at 19:55)</a>:</h4>
<p><strong>marmistrz</strong> requested <a href="https://github.com/peterhuene" target="_blank" title="https://github.com/peterhuene">peterhuene</a>, <a href="https://github.com/kubkon" target="_blank" title="https://github.com/kubkon">kubkon</a>, and <a href="https://github.com/sunfishcode" target="_blank" title="https://github.com/sunfishcode">sunfishcode</a> for a review on <a href="https://github.com/bytecodealliance/wasmtime/pull/1359" target="_blank" title="https://github.com/bytecodealliance/wasmtime/pull/1359">PR #1359</a>.</p>



<a name="191033586"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231359%20Sanitize%20file/directory%20symlinks%20in%20p.../near/191033586" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231359.20Sanitize.20file.2Fdirectory.20symlinks.20in.20p.2E.2E.2E.html#191033586">(Mar 18 2020 at 19:55)</a>:</h4>
<p>marmistrz opened <a href="https://github.com/bytecodealliance/wasmtime/pull/1359" target="_blank" title="https://github.com/bytecodealliance/wasmtime/pull/1359">PR #1359</a> from <code>dir_symlink</code> to <code>master</code>:</p>
<blockquote>
<p>Based from my experience, <code>symlink_file</code> will not return an error if we try to create a file symlink to a directory. I used the following Rust program to verify it:</p>
<div class="codehilite"><pre><span></span>use std::env;
use std::io::Result;
use std::os::windows::fs::symlink_file;

pub(crate) fn path_symlink(src: &amp;str, dst: &amp;str) -&gt; Result&lt;()&gt; {
    // try creating a file symlink
    symlink_file(src, dst).map_err(|e| {
        println!(&quot;ERROR: {}&quot;, e);
        e
    })
}

fn main() {
    let args: Vec&lt;_&gt; = env::args().collect();
    path_symlink(&amp;args[1], &amp;args[2]).expect(&quot;path_symlink failed&quot;);
}
</pre></div>


<p>If <code>dir</code> is an existing directory, and the binary as executed with <code>cargo run dir target</code>, the program will succeed and create a file symlink.</p>
<p>For details on file vs. directory symlinks on Windows see #1358.</p>
<p>@kubkon: I'm also unsure about the correctness of the following error mappings:<br>
<a href="https://github.com/marmistrz/wasmtime/blob/1c61210025c00f0d397be86d752717ab20642f53/crates/wasi-common/src/sys/windows/hostcalls_impl/fs.rs#L527-L536" target="_blank" title="https://github.com/marmistrz/wasmtime/blob/1c61210025c00f0d397be86d752717ab20642f53/crates/wasi-common/src/sys/windows/hostcalls_impl/fs.rs#L527-L536">https://github.com/marmistrz/wasmtime/blob/1c61210025c00f0d397be86d752717ab20642f53/crates/wasi-common/src/sys/windows/hostcalls_impl/fs.rs#L527-L536</a><br>
In which cases are they expected to be encountered? What's the scenario they're there for?</p>
</blockquote>



<a name="191052668"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231359%20Sanitize%20file/directory%20symlinks%20in%20p.../near/191052668" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231359.20Sanitize.20file.2Fdirectory.20symlinks.20in.20p.2E.2E.2E.html#191052668">(Mar 18 2020 at 22:49)</a>:</h4>
<p>peterhuene submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/1359#pullrequestreview-377290483" target="_blank" title="https://github.com/bytecodealliance/wasmtime/pull/1359#pullrequestreview-377290483">PR Review</a>.</p>



<a name="191604276"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231359%20Sanitize%20file/directory%20symlinks%20in%20p.../near/191604276" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231359.20Sanitize.20file.2Fdirectory.20symlinks.20in.20p.2E.2E.2E.html#191604276">(Mar 24 2020 at 12:53)</a>:</h4>
<p>marmistrz updated <a href="https://github.com/bytecodealliance/wasmtime/pull/1359" target="_blank" title="https://github.com/bytecodealliance/wasmtime/pull/1359">PR #1359</a> from <code>dir_symlink</code> to <code>master</code>:</p>
<blockquote>
<p>Based from my experience, <code>symlink_file</code> will not return an error if we try to create a file symlink to a directory. I used the following Rust program to verify it:</p>
<div class="codehilite"><pre><span></span>use std::env;
use std::io::Result;
use std::os::windows::fs::symlink_file;

pub(crate) fn path_symlink(src: &amp;str, dst: &amp;str) -&gt; Result&lt;()&gt; {
    // try creating a file symlink
    symlink_file(src, dst).map_err(|e| {
        println!(&quot;ERROR: {}&quot;, e);
        e
    })
}

fn main() {
    let args: Vec&lt;_&gt; = env::args().collect();
    path_symlink(&amp;args[1], &amp;args[2]).expect(&quot;path_symlink failed&quot;);
}
</pre></div>


<p>If <code>dir</code> is an existing directory, and the binary as executed with <code>cargo run dir target</code>, the program will succeed and create a file symlink.</p>
<p>For details on file vs. directory symlinks on Windows see #1358.</p>
<p>@kubkon: I'm also unsure about the correctness of the following error mappings:<br>
<a href="https://github.com/marmistrz/wasmtime/blob/1c61210025c00f0d397be86d752717ab20642f53/crates/wasi-common/src/sys/windows/hostcalls_impl/fs.rs#L527-L536" target="_blank" title="https://github.com/marmistrz/wasmtime/blob/1c61210025c00f0d397be86d752717ab20642f53/crates/wasi-common/src/sys/windows/hostcalls_impl/fs.rs#L527-L536">https://github.com/marmistrz/wasmtime/blob/1c61210025c00f0d397be86d752717ab20642f53/crates/wasi-common/src/sys/windows/hostcalls_impl/fs.rs#L527-L536</a><br>
In which cases are they expected to be encountered? What's the scenario they're there for?</p>
</blockquote>



<a name="191604708"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231359%20Sanitize%20file/directory%20symlinks%20in%20p.../near/191604708" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231359.20Sanitize.20file.2Fdirectory.20symlinks.20in.20p.2E.2E.2E.html#191604708">(Mar 24 2020 at 12:56)</a>:</h4>
<p>kubkon created <a href="https://github.com/bytecodealliance/wasmtime/pull/1359#discussion_r397130461" target="_blank" title="https://github.com/bytecodealliance/wasmtime/pull/1359#discussion_r397130461">PR Review Comment</a>:</p>
<blockquote>
<p>Is this change only targeting the old snapshot?</p>
</blockquote>



<a name="191604709"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231359%20Sanitize%20file/directory%20symlinks%20in%20p.../near/191604709" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231359.20Sanitize.20file.2Fdirectory.20symlinks.20in.20p.2E.2E.2E.html#191604709">(Mar 24 2020 at 12:56)</a>:</h4>
<p>kubkon submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/1359#pullrequestreview-380280178" target="_blank" title="https://github.com/bytecodealliance/wasmtime/pull/1359#pullrequestreview-380280178">PR Review</a>.</p>



<a name="191605494"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231359%20Sanitize%20file/directory%20symlinks%20in%20p.../near/191605494" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231359.20Sanitize.20file.2Fdirectory.20symlinks.20in.20p.2E.2E.2E.html#191605494">(Mar 24 2020 at 13:03)</a>:</h4>
<p>marmistrz updated <a href="https://github.com/bytecodealliance/wasmtime/pull/1359" target="_blank" title="https://github.com/bytecodealliance/wasmtime/pull/1359">PR #1359</a> from <code>dir_symlink</code> to <code>master</code>:</p>
<blockquote>
<p>Based from my experience, <code>symlink_file</code> will not return an error if we try to create a file symlink to a directory. I used the following Rust program to verify it:</p>
<div class="codehilite"><pre><span></span>use std::env;
use std::io::Result;
use std::os::windows::fs::symlink_file;

pub(crate) fn path_symlink(src: &amp;str, dst: &amp;str) -&gt; Result&lt;()&gt; {
    // try creating a file symlink
    symlink_file(src, dst).map_err(|e| {
        println!(&quot;ERROR: {}&quot;, e);
        e
    })
}

fn main() {
    let args: Vec&lt;_&gt; = env::args().collect();
    path_symlink(&amp;args[1], &amp;args[2]).expect(&quot;path_symlink failed&quot;);
}
</pre></div>


<p>If <code>dir</code> is an existing directory, and the binary as executed with <code>cargo run dir target</code>, the program will succeed and create a file symlink.</p>
<p>For details on file vs. directory symlinks on Windows see #1358.</p>
<p>@kubkon: I'm also unsure about the correctness of the following error mappings:<br>
<a href="https://github.com/marmistrz/wasmtime/blob/1c61210025c00f0d397be86d752717ab20642f53/crates/wasi-common/src/sys/windows/hostcalls_impl/fs.rs#L527-L536" target="_blank" title="https://github.com/marmistrz/wasmtime/blob/1c61210025c00f0d397be86d752717ab20642f53/crates/wasi-common/src/sys/windows/hostcalls_impl/fs.rs#L527-L536">https://github.com/marmistrz/wasmtime/blob/1c61210025c00f0d397be86d752717ab20642f53/crates/wasi-common/src/sys/windows/hostcalls_impl/fs.rs#L527-L536</a><br>
In which cases are they expected to be encountered? What's the scenario they're there for?</p>
</blockquote>



<a name="191605557"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231359%20Sanitize%20file/directory%20symlinks%20in%20p.../near/191605557" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231359.20Sanitize.20file.2Fdirectory.20symlinks.20in.20p.2E.2E.2E.html#191605557">(Mar 24 2020 at 13:03)</a>:</h4>
<p>marmistrz submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/1359#pullrequestreview-380285746" target="_blank" title="https://github.com/bytecodealliance/wasmtime/pull/1359#pullrequestreview-380285746">PR Review</a>.</p>



<a name="191605559"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231359%20Sanitize%20file/directory%20symlinks%20in%20p.../near/191605559" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231359.20Sanitize.20file.2Fdirectory.20symlinks.20in.20p.2E.2E.2E.html#191605559">(Mar 24 2020 at 13:03)</a>:</h4>
<p>marmistrz created <a href="https://github.com/bytecodealliance/wasmtime/pull/1359#discussion_r397134719" target="_blank" title="https://github.com/bytecodealliance/wasmtime/pull/1359#discussion_r397134719">PR Review Comment</a>:</p>
<blockquote>
<p>Whoops, <code>git rebase</code> went wrong. It should be fine now.</p>
</blockquote>



<a name="191605673"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231359%20Sanitize%20file/directory%20symlinks%20in%20p.../near/191605673" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231359.20Sanitize.20file.2Fdirectory.20symlinks.20in.20p.2E.2E.2E.html#191605673">(Mar 24 2020 at 13:04)</a>:</h4>
<p>marmistrz edited <a href="https://github.com/bytecodealliance/wasmtime/pull/1359#discussion_r397134719" target="_blank" title="https://github.com/bytecodealliance/wasmtime/pull/1359#discussion_r397134719">PR Review Comment</a>.</p>



<a name="191611177"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231359%20Sanitize%20file/directory%20symlinks%20in%20p.../near/191611177" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231359.20Sanitize.20file.2Fdirectory.20symlinks.20in.20p.2E.2E.2E.html#191611177">(Mar 24 2020 at 13:47)</a>:</h4>
<p>marmistrz updated <a href="https://github.com/bytecodealliance/wasmtime/pull/1359" target="_blank" title="https://github.com/bytecodealliance/wasmtime/pull/1359">PR #1359</a> from <code>dir_symlink</code> to <code>master</code>:</p>
<blockquote>
<p>Based from my experience, <code>symlink_file</code> will not return an error if we try to create a file symlink to a directory. I used the following Rust program to verify it:</p>
<div class="codehilite"><pre><span></span>use std::env;
use std::io::Result;
use std::os::windows::fs::symlink_file;

pub(crate) fn path_symlink(src: &amp;str, dst: &amp;str) -&gt; Result&lt;()&gt; {
    // try creating a file symlink
    symlink_file(src, dst).map_err(|e| {
        println!(&quot;ERROR: {}&quot;, e);
        e
    })
}

fn main() {
    let args: Vec&lt;_&gt; = env::args().collect();
    path_symlink(&amp;args[1], &amp;args[2]).expect(&quot;path_symlink failed&quot;);
}
</pre></div>


<p>If <code>dir</code> is an existing directory, and the binary as executed with <code>cargo run dir target</code>, the program will succeed and create a file symlink.</p>
<p>For details on file vs. directory symlinks on Windows see #1358.</p>
<p>@kubkon: I'm also unsure about the correctness of the following error mappings:<br>
<a href="https://github.com/marmistrz/wasmtime/blob/1c61210025c00f0d397be86d752717ab20642f53/crates/wasi-common/src/sys/windows/hostcalls_impl/fs.rs#L527-L536" target="_blank" title="https://github.com/marmistrz/wasmtime/blob/1c61210025c00f0d397be86d752717ab20642f53/crates/wasi-common/src/sys/windows/hostcalls_impl/fs.rs#L527-L536">https://github.com/marmistrz/wasmtime/blob/1c61210025c00f0d397be86d752717ab20642f53/crates/wasi-common/src/sys/windows/hostcalls_impl/fs.rs#L527-L536</a><br>
In which cases are they expected to be encountered? What's the scenario they're there for?</p>
</blockquote>



<a name="191613093"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231359%20Sanitize%20file/directory%20symlinks%20in%20p.../near/191613093" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231359.20Sanitize.20file.2Fdirectory.20symlinks.20in.20p.2E.2E.2E.html#191613093">(Mar 24 2020 at 14:00)</a>:</h4>
<p>kubkon submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/1359#pullrequestreview-380336438" target="_blank" title="https://github.com/bytecodealliance/wasmtime/pull/1359#pullrequestreview-380336438">PR Review</a>.</p>



<a name="191613094"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231359%20Sanitize%20file/directory%20symlinks%20in%20p.../near/191613094" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231359.20Sanitize.20file.2Fdirectory.20symlinks.20in.20p.2E.2E.2E.html#191613094">(Mar 24 2020 at 14:00)</a>:</h4>
<p>kubkon created <a href="https://github.com/bytecodealliance/wasmtime/pull/1359#discussion_r397174039" target="_blank" title="https://github.com/bytecodealliance/wasmtime/pull/1359#discussion_r397174039">PR Review Comment</a>:</p>
<blockquote>
<p>Hmm, I'm somewhat confused here. Why do we need this check? Or put it another way, if we're doing this check already here, is creating a dir symlink on error <code>ERROR_NOT_A_REPARSE_POINT</code> still needed? Is the current approach of try and fail and try something else not working?</p>
<p>Some context on why we've originally had <code>symlink_dir</code> call after a failing <code>symlink_file</code> call. As @sunfishcode explained a long time ago, from atomicity point of view, it seems virtually always better to try and fail and then correct, rather than invoke another syscall (in this case via <code>fs::metadata</code>) which would check what the resource (in this case the symlink) is since in between the check and actual call to <code>symlink_file</code> etc. the path might change, or whatnot.</p>
</blockquote>



<a name="191637585"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231359%20Sanitize%20file/directory%20symlinks%20in%20p.../near/191637585" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231359.20Sanitize.20file.2Fdirectory.20symlinks.20in.20p.2E.2E.2E.html#191637585">(Mar 24 2020 at 16:33)</a>:</h4>
<p>marmistrz created <a href="https://github.com/bytecodealliance/wasmtime/pull/1359#discussion_r397294731" target="_blank" title="https://github.com/bytecodealliance/wasmtime/pull/1359#discussion_r397294731">PR Review Comment</a>:</p>
<blockquote>
<p>I was unable to encounter <code>ERROR_NOT_A_REPARSE_POINT</code> while using <code>symlink_file</code> with the symlink target being a directory. As far as I have tested, the current approach of try and fail doesn't work and a file symlink will always be created.</p>
<p>I agree that try and fail would be preferable, but it appears that <code>CreateSymbolicLinkA</code> doesn't check if the symlink target is a file or directory. I don't know if <code>ERROR_NOT_A_REPARSE_POINT</code> may be returned by <code>CreateSymbolicLinkA</code> at all.</p>
</blockquote>



<a name="191637586"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231359%20Sanitize%20file/directory%20symlinks%20in%20p.../near/191637586" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231359.20Sanitize.20file.2Fdirectory.20symlinks.20in.20p.2E.2E.2E.html#191637586">(Mar 24 2020 at 16:33)</a>:</h4>
<p>marmistrz submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/1359#pullrequestreview-380490087" target="_blank" title="https://github.com/bytecodealliance/wasmtime/pull/1359#pullrequestreview-380490087">PR Review</a>.</p>



<a name="191644261"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231359%20Sanitize%20file/directory%20symlinks%20in%20p.../near/191644261" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231359.20Sanitize.20file.2Fdirectory.20symlinks.20in.20p.2E.2E.2E.html#191644261">(Mar 24 2020 at 17:20)</a>:</h4>
<p>kubkon submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/1359#pullrequestreview-380532645" target="_blank" title="https://github.com/bytecodealliance/wasmtime/pull/1359#pullrequestreview-380532645">PR Review</a>.</p>



<a name="191644262"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231359%20Sanitize%20file/directory%20symlinks%20in%20p.../near/191644262" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231359.20Sanitize.20file.2Fdirectory.20symlinks.20in.20p.2E.2E.2E.html#191644262">(Mar 24 2020 at 17:20)</a>:</h4>
<p>kubkon created <a href="https://github.com/bytecodealliance/wasmtime/pull/1359#discussion_r397328688" target="_blank" title="https://github.com/bytecodealliance/wasmtime/pull/1359#discussion_r397328688">PR Review Comment</a>:</p>
<blockquote>
<p>Hmm, sounds like a bug then. I thought that <code>ERROR_NOT_A_REPARSE_POINT</code> played some role in this, but alas I cannot remember the exact test conditions now. Anyhow, I thought it was covered by our test programs, but from what I understand, you've proved that they were not properly testing this behaviour on Windows? Would the test work fine if we got rid <code>ERROR_NOT_A_REPARSE_POINT</code> match altogether? And would they still work without both the match and your upfront check?</p>
</blockquote>



<a name="191644473"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231359%20Sanitize%20file/directory%20symlinks%20in%20p.../near/191644473" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231359.20Sanitize.20file.2Fdirectory.20symlinks.20in.20p.2E.2E.2E.html#191644473">(Mar 24 2020 at 17:21)</a>:</h4>
<p>kubkon created <a href="https://github.com/bytecodealliance/wasmtime/pull/1359#discussion_r397329895" target="_blank" title="https://github.com/bytecodealliance/wasmtime/pull/1359#discussion_r397329895">PR Review Comment</a>:</p>
<blockquote>
<p>Oh, and here's another thought. What would happen if we reversed the order of ops, i.e., started with <code>symlink_dir</code>, and if failed, tried <code>symlink_file</code>. Would that make it possible to apply the "try-catch" approach rather than an upfront check?</p>
</blockquote>



<a name="191644474"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231359%20Sanitize%20file/directory%20symlinks%20in%20p.../near/191644474" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231359.20Sanitize.20file.2Fdirectory.20symlinks.20in.20p.2E.2E.2E.html#191644474">(Mar 24 2020 at 17:21)</a>:</h4>
<p>kubkon submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/1359#pullrequestreview-380534108" target="_blank" title="https://github.com/bytecodealliance/wasmtime/pull/1359#pullrequestreview-380534108">PR Review</a>.</p>



<a name="191749646"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231359%20Sanitize%20file/directory%20symlinks%20in%20p.../near/191749646" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231359.20Sanitize.20file.2Fdirectory.20symlinks.20in.20p.2E.2E.2E.html#191749646">(Mar 25 2020 at 14:07)</a>:</h4>
<p>marmistrz created <a href="https://github.com/bytecodealliance/wasmtime/pull/1359#discussion_r397880989" title="https://github.com/bytecodealliance/wasmtime/pull/1359#discussion_r397880989">PR Review Comment</a>:</p>
<blockquote>
<p>Trying to create a symlink to a file using <code>symlink_dir</code> succeeds too.</p>
</blockquote>



<a name="191749647"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231359%20Sanitize%20file/directory%20symlinks%20in%20p.../near/191749647" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231359.20Sanitize.20file.2Fdirectory.20symlinks.20in.20p.2E.2E.2E.html#191749647">(Mar 25 2020 at 14:07)</a>:</h4>
<p>marmistrz submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/1359#pullrequestreview-381180196" title="https://github.com/bytecodealliance/wasmtime/pull/1359#pullrequestreview-381180196">PR Review</a>.</p>



<a name="191750091"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231359%20Sanitize%20file/directory%20symlinks%20in%20p.../near/191750091" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231359.20Sanitize.20file.2Fdirectory.20symlinks.20in.20p.2E.2E.2E.html#191750091">(Mar 25 2020 at 14:09)</a>:</h4>
<p>kubkon created <a href="https://github.com/bytecodealliance/wasmtime/pull/1359#discussion_r397883156" title="https://github.com/bytecodealliance/wasmtime/pull/1359#discussion_r397883156">PR Review Comment</a>:</p>
<blockquote>
<p>Interesting, but then the symlinks are obviously invalid if the user would try to act on them in say Windows Explorer or whatnot?</p>
</blockquote>



<a name="191750092"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231359%20Sanitize%20file/directory%20symlinks%20in%20p.../near/191750092" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231359.20Sanitize.20file.2Fdirectory.20symlinks.20in.20p.2E.2E.2E.html#191750092">(Mar 25 2020 at 14:09)</a>:</h4>
<p>kubkon submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/1359#pullrequestreview-381182953" title="https://github.com/bytecodealliance/wasmtime/pull/1359#pullrequestreview-381182953">PR Review</a>.</p>



<a name="191752854"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231359%20Sanitize%20file/directory%20symlinks%20in%20p.../near/191752854" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231359.20Sanitize.20file.2Fdirectory.20symlinks.20in.20p.2E.2E.2E.html#191752854">(Mar 25 2020 at 14:28)</a>:</h4>
<p>marmistrz submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/1359#pullrequestreview-381201392" title="https://github.com/bytecodealliance/wasmtime/pull/1359#pullrequestreview-381201392">PR Review</a>.</p>



<a name="191752856"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231359%20Sanitize%20file/directory%20symlinks%20in%20p.../near/191752856" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231359.20Sanitize.20file.2Fdirectory.20symlinks.20in.20p.2E.2E.2E.html#191752856">(Mar 25 2020 at 14:28)</a>:</h4>
<p>marmistrz created <a href="https://github.com/bytecodealliance/wasmtime/pull/1359#discussion_r397897855" title="https://github.com/bytecodealliance/wasmtime/pull/1359#discussion_r397897855">PR Review Comment</a>:</p>
<blockquote>
<p>Yes, Windows Explorer will show an error, claiming that the directory is invalid.</p>
</blockquote>



<a name="192161144"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231359%20Sanitize%20file/directory%20symlinks%20in%20p.../near/192161144" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231359.20Sanitize.20file.2Fdirectory.20symlinks.20in.20p.2E.2E.2E.html#192161144">(Mar 29 2020 at 07:32)</a>:</h4>
<p>marmistrz updated <a href="https://github.com/bytecodealliance/wasmtime/pull/1359" title="https://github.com/bytecodealliance/wasmtime/pull/1359">PR #1359</a> from <code>dir_symlink</code> to <code>master</code>:</p>
<blockquote>
<p>Based from my experience, <code>symlink_file</code> will not return an error if we try to create a file symlink to a directory. I used the following Rust program to verify it:</p>
<div class="codehilite"><pre><span></span>use std::env;
use std::io::Result;
use std::os::windows::fs::symlink_file;

pub(crate) fn path_symlink(src: &amp;str, dst: &amp;str) -&gt; Result&lt;()&gt; {
    // try creating a file symlink
    symlink_file(src, dst).map_err(|e| {
        println!(&quot;ERROR: {}&quot;, e);
        e
    })
}

fn main() {
    let args: Vec&lt;_&gt; = env::args().collect();
    path_symlink(&amp;args[1], &amp;args[2]).expect(&quot;path_symlink failed&quot;);
}
</pre></div>


<p>If <code>dir</code> is an existing directory, and the binary as executed with <code>cargo run dir target</code>, the program will succeed and create a file symlink.</p>
<p>For details on file vs. directory symlinks on Windows see #1358.</p>
<p>@kubkon: I'm also unsure about the correctness of the following error mappings:<br>
<a href="https://github.com/marmistrz/wasmtime/blob/1c61210025c00f0d397be86d752717ab20642f53/crates/wasi-common/src/sys/windows/hostcalls_impl/fs.rs#L527-L536" title="https://github.com/marmistrz/wasmtime/blob/1c61210025c00f0d397be86d752717ab20642f53/crates/wasi-common/src/sys/windows/hostcalls_impl/fs.rs#L527-L536">https://github.com/marmistrz/wasmtime/blob/1c61210025c00f0d397be86d752717ab20642f53/crates/wasi-common/src/sys/windows/hostcalls_impl/fs.rs#L527-L536</a><br>
In which cases are they expected to be encountered? What's the scenario they're there for?</p>
</blockquote>



<a name="192489237"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231359%20Sanitize%20file/directory%20symlinks%20in%20p.../near/192489237" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231359.20Sanitize.20file.2Fdirectory.20symlinks.20in.20p.2E.2E.2E.html#192489237">(Apr 01 2020 at 06:55)</a>:</h4>
<p>kubkon merged <a href="https://github.com/bytecodealliance/wasmtime/pull/1359" title="https://github.com/bytecodealliance/wasmtime/pull/1359">PR #1359</a>.</p>



<hr><p>Last updated: Jan 20 2025 at 06:04 UTC</p>
</html>