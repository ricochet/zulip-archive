<html>
<head><meta charset="utf-8"><title>wasmtime / issue #6914 Problems with file system calls fr... · git-wasmtime · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/index.html">git-wasmtime</a></h2>
<h3>Topic: <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.236914.20Problems.20with.20file.20system.20calls.20fr.2E.2E.2E.html">wasmtime / issue #6914 Problems with file system calls fr...</a></h3>

<hr>

<base href="https://bytecodealliance.zulipchat.com">

<head><link href="https://bytecodealliance.github.io/zulip-archive/style.css" rel="stylesheet"></head>

<a name="387424904"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%236914%20Problems%20with%20file%20system%20calls%20fr.../near/387424904" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.236914.20Problems.20with.20file.20system.20calls.20fr.2E.2E.2E.html#387424904">(Aug 26 2023 at 13:04)</a>:</h4>
<p>rbackhouse opened <a href="https://github.com/bytecodealliance/wasmtime/issues/6914">issue #6914</a>:</p>
<blockquote>
<p>I am unable to get file system calls to work from a tinygo based WASM component. All calls return "errno 76" "capabilities insufficient".</p>
<p>This originally started as a discussion on Zulip with Pat Hickey.<br>
<a href="#narrow/stream/217126-wasmtime/topic/Problem.20with.20WasiCtxBuilder.2Epush_preopened_dir.20for.20component">https://bytecodealliance.zulipchat.com/#narrow/stream/217126-wasmtime/topic/Problem.20with.20WasiCtxBuilder.2Epush_preopened_dir.20for.20component</a></p>
<h3>Test Case</h3>
<p>I've created a test case available at</p>
<p><a href="https://github.com/rbackhouse/component-go-fs-test">https://github.com/rbackhouse/component-go-fs-test</a></p>
<p>The README details the prereqs and how to build and run.</p>
<p>Here are the wasm files built<br>
<a href="https://github.com/bytecodealliance/wasmtime/files/12445390/testfswasm.zip">testfswasm.zip</a></p>
<h3>Steps to Reproduce</h3>
<p>See README from <a href="https://github.com/rbackhouse/component-go-fs-test">https://github.com/rbackhouse/component-go-fs-test</a></p>
<h3>Expected Results</h3>
<p>stdout should show </p>
<p>""test.log created"</p>
<h3>Actual Results</h3>
<p>stdout shows<br>
"Failed to open file open test.log: errno 76"</p>
<h3>Versions and Environment</h3>
<p>Wasmtime version or commit: 12.0.1</p>
<p>Operating system: MacOS</p>
<p>Architecture: M1</p>
<h3>Extra Info</h3>
</blockquote>



<a name="387424905"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%236914%20Problems%20with%20file%20system%20calls%20fr.../near/387424905" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.236914.20Problems.20with.20file.20system.20calls.20fr.2E.2E.2E.html#387424905">(Aug 26 2023 at 13:04)</a>:</h4>
<p><a href="https://github.com/rbackhouse">rbackhouse</a> added the bug label to <a href="https://github.com/bytecodealliance/wasmtime/issues/6914">Issue #6914</a>.</p>



<a name="387464286"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%236914%20Problems%20with%20file%20system%20calls%20fr.../near/387464286" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.236914.20Problems.20with.20file.20system.20calls.20fr.2E.2E.2E.html#387464286">(Aug 26 2023 at 22:49)</a>:</h4>
<p>pchickey assigned <a href="https://github.com/bytecodealliance/wasmtime/issues/6914">issue #6914</a> to pchickey.</p>



<a name="387693985"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%236914%20Problems%20with%20file%20system%20calls%20fr.../near/387693985" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.236914.20Problems.20with.20file.20system.20calls.20fr.2E.2E.2E.html#387693985">(Aug 28 2023 at 15:32)</a>:</h4>
<p>alexcrichton <a href="https://github.com/bytecodealliance/wasmtime/issues/6914#issuecomment-1695907532">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/6914">issue #6914</a>:</p>
<blockquote>
<p>I poked around this a bit just now and I think there's a few things in play perhaps. I believe the "root cause" of this is that the entry point <code>openfile</code> generated doesn't initialize the Go runtime or wasi-libc. The tinygo tag you linked is using a was-libc from 2022 which requires explicit initialization to work for preopens, and by skipping this initialization by going straight to <code>openfile</code> that's why things aren't working. I've attempted to confirm this by having the adapter call <code>_start</code> then call <code>openfile</code> and that appears to get this working.</p>
<p>This means that I don't think the issue is in Wasmtime, but is instead on the tinygo side of things. One option would be to update wasi-libc since today's version doesn't require explicit initialization. Another option though would be to ensure that the exports generated by wit-bindgen initialize the Go runtime. I'm not sure what other Go details are involved for entering the runtime in a non-<code>main</code> situation.</p>
<p>In any case though I wasn't able to find any issues with Wasmtime itself or the adapter, so I'm going to close this as it's on the Wasmtime repo, but if you/others would prefer to keep discussion here while it's being fixed elsewhere I'm happy to reopen too.</p>
</blockquote>



<a name="387693986"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%236914%20Problems%20with%20file%20system%20calls%20fr.../near/387693986" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.236914.20Problems.20with.20file.20system.20calls.20fr.2E.2E.2E.html#387693986">(Aug 28 2023 at 15:32)</a>:</h4>
<p>alexcrichton closed <a href="https://github.com/bytecodealliance/wasmtime/issues/6914">issue #6914</a>:</p>
<blockquote>
<p>I am unable to get file system calls to work from a tinygo based WASM component. All calls return "errno 76" "capabilities insufficient".</p>
<p>This originally started as a discussion on Zulip with Pat Hickey.<br>
<a href="#narrow/stream/217126-wasmtime/topic/Problem.20with.20WasiCtxBuilder.2Epush_preopened_dir.20for.20component">https://bytecodealliance.zulipchat.com/#narrow/stream/217126-wasmtime/topic/Problem.20with.20WasiCtxBuilder.2Epush_preopened_dir.20for.20component</a></p>
<h3>Test Case</h3>
<p>I've created a test case available at</p>
<p><a href="https://github.com/rbackhouse/component-go-fs-test">https://github.com/rbackhouse/component-go-fs-test</a></p>
<p>The README details the prereqs and how to build and run.</p>
<p>Here are the wasm files built<br>
<a href="https://github.com/bytecodealliance/wasmtime/files/12445390/testfswasm.zip">testfswasm.zip</a></p>
<h3>Steps to Reproduce</h3>
<p>See README from <a href="https://github.com/rbackhouse/component-go-fs-test">https://github.com/rbackhouse/component-go-fs-test</a></p>
<h3>Expected Results</h3>
<p>stdout should show </p>
<p>""test.log created"</p>
<h3>Actual Results</h3>
<p>stdout shows<br>
"Failed to open file open test.log: errno 76"</p>
<h3>Versions and Environment</h3>
<p>Wasmtime version or commit: 12.0.1</p>
<p>Operating system: MacOS</p>
<p>Architecture: M1</p>
<h3>Extra Info</h3>
</blockquote>



<a name="387696126"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%236914%20Problems%20with%20file%20system%20calls%20fr.../near/387696126" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.236914.20Problems.20with.20file.20system.20calls.20fr.2E.2E.2E.html#387696126">(Aug 28 2023 at 15:41)</a>:</h4>
<p>rbackhouse <a href="https://github.com/bytecodealliance/wasmtime/issues/6914#issuecomment-1695920926">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/6914">issue #6914</a>:</p>
<blockquote>
<p>Thanks Alex, I'll look into using an updated wasi-libc to see if that helps. I can continue the conversation on Zulip</p>
</blockquote>



<hr><p>Last updated: Jan 20 2025 at 06:04 UTC</p>
</html>