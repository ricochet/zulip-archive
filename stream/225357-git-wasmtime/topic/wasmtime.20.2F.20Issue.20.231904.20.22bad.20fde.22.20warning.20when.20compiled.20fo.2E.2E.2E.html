<html>
<head><meta charset="utf-8"><title>wasmtime / Issue #1904 &quot;bad fde&quot; warning when compiled fo... · git-wasmtime · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/index.html">git-wasmtime</a></h2>
<h3>Topic: <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20Issue.20.231904.20.22bad.20fde.22.20warning.20when.20compiled.20fo.2E.2E.2E.html">wasmtime / Issue #1904 &quot;bad fde&quot; warning when compiled fo...</a></h3>

<hr>

<base href="https://bytecodealliance.zulipchat.com">

<head><link href="https://bytecodealliance.github.io/zulip-archive/style.css" rel="stylesheet"></head>

<a name="201393531"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20Issue%20%231904%20%22bad%20fde%22%20warning%20when%20compiled%20fo.../near/201393531" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20Issue.20.231904.20.22bad.20fde.22.20warning.20when.20compiled.20fo.2E.2E.2E.html#201393531">(Jun 19 2020 at 13:59)</a>:</h4>
<p>ueno opened <a href="https://github.com/bytecodealliance/wasmtime/issues/1904">Issue #1904</a>:</p>
<blockquote>
<p>When wasmtime is compiled with <code>cargo build --target x86_64-unknown-linux-musl</code>, it produces a runtime warning as below:</p>
<div class="codehilite"><pre><span></span><code><span class="gp">$</span> ./target/x86_64-unknown-linux-musl/debug/wasmtime tests/wasm/hello_wasi_snapshot1.wat
<span class="go">libunwind: __unw_add_dynamic_fde: bad fde: FDE is really a CIE</span>
<span class="go">libunwind: __unw_add_dynamic_fde: bad fde: FDE is really a CIE</span>
<span class="go">Hello, world!</span>
</code></pre></div>


<ul>
<li>
<p>What are the steps to reproduce the issue?<br>
See above.</p>
</li>
<li>
<p>What do you expect to happen? What does actually happen? Does it panic, and<br>
  if so, with which assertion?<br>
I am actually not sure about the impact, but it looks like the FDE record is corrupted in the generated code.</p>
</li>
<li>
<p>Which Wasmtime version / commit hash / branch are you using?<br>
git master (f4e3e4efde28ac90be9fd68dcbda2943b3851155)</p>
</li>
<li>
<p>If relevant, can you include some extra information about your environment?<br>
  (Rust version, operating system, architecture...)</p>
<ul>
<li>rustc 1.43.0 (4fb7144ed 2020-04-20)</li>
<li>Fedora 32 (x86_64)</li>
</ul>
</li>
</ul>
</blockquote>



<a name="201393533"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20Issue%20%231904%20%22bad%20fde%22%20warning%20when%20compiled%20fo.../near/201393533" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20Issue.20.231904.20.22bad.20fde.22.20warning.20when.20compiled.20fo.2E.2E.2E.html#201393533">(Jun 19 2020 at 13:59)</a>:</h4>
<p>ueno labeled <a href="https://github.com/bytecodealliance/wasmtime/issues/1904">Issue #1904</a>:</p>
<blockquote>
<p>When wasmtime is compiled with <code>cargo build --target x86_64-unknown-linux-musl</code>, it produces a runtime warning as below:</p>
<div class="codehilite"><pre><span></span><code><span class="gp">$</span> ./target/x86_64-unknown-linux-musl/debug/wasmtime tests/wasm/hello_wasi_snapshot1.wat
<span class="go">libunwind: __unw_add_dynamic_fde: bad fde: FDE is really a CIE</span>
<span class="go">libunwind: __unw_add_dynamic_fde: bad fde: FDE is really a CIE</span>
<span class="go">Hello, world!</span>
</code></pre></div>


<ul>
<li>
<p>What are the steps to reproduce the issue?<br>
See above.</p>
</li>
<li>
<p>What do you expect to happen? What does actually happen? Does it panic, and<br>
  if so, with which assertion?<br>
I am actually not sure about the impact, but it looks like the FDE record is corrupted in the generated code.</p>
</li>
<li>
<p>Which Wasmtime version / commit hash / branch are you using?<br>
git master (f4e3e4efde28ac90be9fd68dcbda2943b3851155)</p>
</li>
<li>
<p>If relevant, can you include some extra information about your environment?<br>
  (Rust version, operating system, architecture...)</p>
<ul>
<li>rustc 1.43.0 (4fb7144ed 2020-04-20)</li>
<li>Fedora 32 (x86_64)</li>
</ul>
</li>
</ul>
</blockquote>



<a name="201765375"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20Issue%20%231904%20%22bad%20fde%22%20warning%20when%20compiled%20fo.../near/201765375" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20Issue.20.231904.20.22bad.20fde.22.20warning.20when.20compiled.20fo.2E.2E.2E.html#201765375">(Jun 23 2020 at 18:43)</a>:</h4>
<p>peterhuene assigned <a href="https://github.com/bytecodealliance/wasmtime/issues/1904">Issue #1904</a>:</p>
<blockquote>
<p>When wasmtime is compiled with <code>cargo build --target x86_64-unknown-linux-musl</code>, it produces a runtime warning as below:</p>
<div class="codehilite"><pre><span></span><code><span class="gp">$</span> ./target/x86_64-unknown-linux-musl/debug/wasmtime tests/wasm/hello_wasi_snapshot1.wat
<span class="go">libunwind: __unw_add_dynamic_fde: bad fde: FDE is really a CIE</span>
<span class="go">libunwind: __unw_add_dynamic_fde: bad fde: FDE is really a CIE</span>
<span class="go">Hello, world!</span>
</code></pre></div>


<ul>
<li>
<p>What are the steps to reproduce the issue?<br>
See above.</p>
</li>
<li>
<p>What do you expect to happen? What does actually happen? Does it panic, and<br>
  if so, with which assertion?<br>
I am actually not sure about the impact, but it looks like the FDE record is corrupted in the generated code.</p>
</li>
<li>
<p>Which Wasmtime version / commit hash / branch are you using?<br>
git master (f4e3e4efde28ac90be9fd68dcbda2943b3851155)</p>
</li>
<li>
<p>If relevant, can you include some extra information about your environment?<br>
  (Rust version, operating system, architecture...)</p>
<ul>
<li>rustc 1.43.0 (4fb7144ed 2020-04-20)</li>
<li>Fedora 32 (x86_64)</li>
</ul>
</li>
</ul>
</blockquote>



<a name="201765405"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20Issue%20%231904%20%22bad%20fde%22%20warning%20when%20compiled%20fo.../near/201765405" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20Issue.20.231904.20.22bad.20fde.22.20warning.20when.20compiled.20fo.2E.2E.2E.html#201765405">(Jun 23 2020 at 18:43)</a>:</h4>
<p>peterhuene <a href="https://github.com/bytecodealliance/wasmtime/issues/1904#issuecomment-648345935">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/1904">Issue #1904</a>:</p>
<blockquote>
<p>I'm able to reproduce this and I'll investigate.</p>
</blockquote>



<a name="201772347"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20Issue%20%231904%20%22bad%20fde%22%20warning%20when%20compiled%20fo.../near/201772347" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20Issue.20.231904.20.22bad.20fde.22.20warning.20when.20compiled.20fo.2E.2E.2E.html#201772347">(Jun 23 2020 at 19:40)</a>:</h4>
<p>peterhuene <a href="https://github.com/bytecodealliance/wasmtime/issues/1904#issuecomment-648377334">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/1904">Issue #1904</a>:</p>
<blockquote>
<p>There are two warnings because two frame tables are being registered (each with two FDEs), one for the the wasm functions and one for the trampolines.</p>
<p>Here's one of the decoded table being passed to <code>__unw_add_dynamic_fde</code>:</p>
<div class="codehilite"><pre><span></span><code>[
    20,
    0,
    0,
    0,      // CIE length: 20 bytes

    0,
    0,
    0,
    0,      // CIE ID: 0

    1,      // Version: 1

    0,      // Agumentation (none)

    1,      // Code alignment factor

    120,    // Data alignment factor (-8)

    16,     // Return register: RAX

    12,     // Start of initial instructions
    7,
    8,
    144,
    1,
    0,
    0,
    0,
    0,
    0,
    0,      // End of initial instructions

    36,
    0,
    0,
    0,      // FDE length: 36 bytes

    28,
    0,
    0,
    0,      // CIE offset: 4 (FDE length) + 24 (CIE record + length) = 28

    0,
    0,
    221,
    247,
    255,
    127,
    0,
    0,      // Function address: 0x00007ffff7dd0000

    28,
    0,
    0,
    0,
    0,
    0,
    0,
    0,      // Function length: 28 bytes

    66,     // Start of call frame instructions
    14,
    16,
    134,
    2,
    67,
    13,
    6,
    86,
    12,
    7,
    8,
    0,
    0,
    0,
    0,      // End of call frame instructions

    36,
    0,
    0,
    0,      // FDE length: 36 bytes

    68,
    0,
    0,
    0,      // CIE offset: 4 (this FDE length) + 40 (first FDE record + length) +  24 (CIE record + length) = 68

    28,
    0,
    221,
    247,
    255,
    127,
    0,
    0,      // Function address: 0x00007FFFF7DD001C

    11,
    0,
    0,
    0,
    0,
    0,
    0,
    0,      // Function length: 11 bytes

    66,     // Start of call frame instructions
    14,
    16,
    134,
    2,
    67,
    13,
    6,
    69,
    12,
    7,
    8,
    0,
    0,
    0,
    0,      // End of call frame instructions

    0,
    0,
    0,
    0,      // FDE with length 0 (end of records marker)
]
</code></pre></div>


<p>This table appears correct.</p>
<p>There appears to be a <a href="https://github.com/libunwind/libunwind/issues/138">libunwind issue</a> unrelated to wasmtime that hasn't been investigated.</p>
<p>I'll see if I can debug into libunwind and see what's tripping it up.</p>
</blockquote>



<a name="201772373"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20Issue%20%231904%20%22bad%20fde%22%20warning%20when%20compiled%20fo.../near/201772373" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20Issue.20.231904.20.22bad.20fde.22.20warning.20when.20compiled.20fo.2E.2E.2E.html#201772373">(Jun 23 2020 at 19:40)</a>:</h4>
<p>peterhuene edited a <a href="https://github.com/bytecodealliance/wasmtime/issues/1904#issuecomment-648377334">comment</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/1904">Issue #1904</a>:</p>
<blockquote>
<p>There are two warnings because two frame tables are being registered (each with two FDEs), one for the the wasm functions and one for the trampolines.</p>
<p>Here's one of the decoded frame tables being passed to <code>__unw_add_dynamic_fde</code>:</p>
<div class="codehilite"><pre><span></span><code>[
    20,
    0,
    0,
    0,      // CIE length: 20 bytes

    0,
    0,
    0,
    0,      // CIE ID: 0

    1,      // Version: 1

    0,      // Agumentation (none)

    1,      // Code alignment factor

    120,    // Data alignment factor (-8)

    16,     // Return register: RAX

    12,     // Start of initial instructions
    7,
    8,
    144,
    1,
    0,
    0,
    0,
    0,
    0,
    0,      // End of initial instructions

    36,
    0,
    0,
    0,      // FDE length: 36 bytes

    28,
    0,
    0,
    0,      // CIE offset: 4 (FDE length) + 24 (CIE record + length) = 28

    0,
    0,
    221,
    247,
    255,
    127,
    0,
    0,      // Function address: 0x00007ffff7dd0000

    28,
    0,
    0,
    0,
    0,
    0,
    0,
    0,      // Function length: 28 bytes

    66,     // Start of call frame instructions
    14,
    16,
    134,
    2,
    67,
    13,
    6,
    86,
    12,
    7,
    8,
    0,
    0,
    0,
    0,      // End of call frame instructions

    36,
    0,
    0,
    0,      // FDE length: 36 bytes

    68,
    0,
    0,
    0,      // CIE offset: 4 (this FDE length) + 40 (first FDE record + length) +  24 (CIE record + length) = 68

    28,
    0,
    221,
    247,
    255,
    127,
    0,
    0,      // Function address: 0x00007FFFF7DD001C

    11,
    0,
    0,
    0,
    0,
    0,
    0,
    0,      // Function length: 11 bytes

    66,     // Start of call frame instructions
    14,
    16,
    134,
    2,
    67,
    13,
    6,
    69,
    12,
    7,
    8,
    0,
    0,
    0,
    0,      // End of call frame instructions

    0,
    0,
    0,
    0,      // FDE with length 0 (end of records marker)
]
</code></pre></div>


<p>This table appears correct.</p>
<p>There appears to be a <a href="https://github.com/libunwind/libunwind/issues/138">libunwind issue</a> unrelated to wasmtime that hasn't been investigated.</p>
<p>I'll see if I can debug into libunwind and see what's tripping it up.</p>
</blockquote>



<a name="201772669"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20Issue%20%231904%20%22bad%20fde%22%20warning%20when%20compiled%20fo.../near/201772669" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20Issue.20.231904.20.22bad.20fde.22.20warning.20when.20compiled.20fo.2E.2E.2E.html#201772669">(Jun 23 2020 at 19:42)</a>:</h4>
<p>peterhuene edited a <a href="https://github.com/bytecodealliance/wasmtime/issues/1904#issuecomment-648377334">comment</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/1904">Issue #1904</a>:</p>
<blockquote>
<p>There are two warnings because two frame tables are being registered (each with two FDEs), one for the the wasm functions and one for the trampolines.</p>
<p>Here's one of the decoded frame tables being passed to <code>__unw_add_dynamic_fde</code>:</p>
<div class="codehilite"><pre><span></span><code>[
    20,
    0,
    0,
    0,      // CIE length: 20 bytes

    0,
    0,
    0,
    0,      // CIE ID: 0

    1,      // Version: 1

    0,      // Agumentation (none)

    1,      // Code alignment factor

    120,    // Data alignment factor (-8)

    16,     // Return register: RAX

    12,     // Start of initial instructions
    7,
    8,
    144,
    1,
    0,
    0,
    0,
    0,
    0,
    0,      // End of initial instructions

    36,
    0,
    0,
    0,      // FDE length: 36 bytes

    28,
    0,
    0,
    0,      // CIE offset: 4 (FDE length) + 24 (CIE record + length) = 28

    0,
    0,
    221,
    247,
    255,
    127,
    0,
    0,      // Function address: 0x00007ffff7dd0000

    28,
    0,
    0,
    0,
    0,
    0,
    0,
    0,      // Function length: 28 bytes

    66,     // Start of call frame instructions
    14,
    16,
    134,
    2,
    67,
    13,
    6,
    86,
    12,
    7,
    8,
    0,
    0,
    0,
    0,      // End of call frame instructions

    36,
    0,
    0,
    0,      // FDE length: 36 bytes

    68,
    0,
    0,
    0,      // CIE offset: 4 (this FDE length) + 40 (first FDE record + length) + 24 (CIE record + length) = 68

    28,
    0,
    221,
    247,
    255,
    127,
    0,
    0,      // Function address: 0x00007FFFF7DD001C

    11,
    0,
    0,
    0,
    0,
    0,
    0,
    0,      // Function length: 11 bytes

    66,     // Start of call frame instructions
    14,
    16,
    134,
    2,
    67,
    13,
    6,
    69,
    12,
    7,
    8,
    0,
    0,
    0,
    0,      // End of call frame instructions

    0,
    0,
    0,
    0,      // FDE with length 0 (end of records marker)
]
</code></pre></div>


<p>This table appears correct.</p>
<p>There appears to be a <a href="https://github.com/libunwind/libunwind/issues/138">libunwind issue</a> unrelated to wasmtime that hasn't been investigated.</p>
<p>I'll see if I can debug into libunwind and see what's tripping it up.</p>
</blockquote>



<a name="201774774"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20Issue%20%231904%20%22bad%20fde%22%20warning%20when%20compiled%20fo.../near/201774774" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20Issue.20.231904.20.22bad.20fde.22.20warning.20when.20compiled.20fo.2E.2E.2E.html#201774774">(Jun 23 2020 at 19:59)</a>:</h4>
<p>peterhuene edited a <a href="https://github.com/bytecodealliance/wasmtime/issues/1904#issuecomment-648377334">comment</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/1904">Issue #1904</a>:</p>
<blockquote>
<p>There are two warnings because two frame tables are being registered (each with two FDEs), one for the the wasm functions and one for the trampolines.</p>
<p>Here's one of the decoded frame tables being passed to <code>__unw_add_dynamic_fde</code>:</p>
<div class="codehilite"><pre><span></span><code>[
    20,
    0,
    0,
    0,      // CIE length: 20 bytes

    0,
    0,
    0,
    0,      // CIE ID: 0

    1,      // Version: 1

    0,      // Agumentation (none)

    1,      // Code alignment factor

    120,    // Data alignment factor (-8)

    16,     // Return register: RAX

    12,     // Start of initial instructions
    7,
    8,
    144,
    1,
    0,
    0,
    0,
    0,
    0,
    0,      // End of initial instructions

    36,
    0,
    0,
    0,      // FDE length: 36 bytes

    28,
    0,
    0,
    0,      // CIE offset: 4 (FDE length) + 24 (CIE record + length) = 28

    0,
    0,
    221,
    247,
    255,
    127,
    0,
    0,      // Function address: 0x00007ffff7dd0000

    28,
    0,
    0,
    0,
    0,
    0,
    0,
    0,      // Function length: 28 bytes

    66,     // Start of call frame instructions
    14,
    16,
    134,
    2,
    67,
    13,
    6,
    86,
    12,
    7,
    8,
    0,
    0,
    0,
    0,      // End of call frame instructions

    36,
    0,
    0,
    0,      // FDE length: 36 bytes

    68,
    0,
    0,
    0,      // CIE offset: 4 (this FDE length) + 40 (first FDE record + length) + 24 (CIE record + length) = 68

    28,
    0,
    221,
    247,
    255,
    127,
    0,
    0,      // Function address: 0x00007FFFF7DD001C

    11,
    0,
    0,
    0,
    0,
    0,
    0,
    0,      // Function length: 11 bytes

    66,     // Start of call frame instructions
    14,
    16,
    134,
    2,
    67,
    13,
    6,
    69,
    12,
    7,
    8,
    0,
    0,
    0,
    0,      // End of call frame instructions

    0,
    0,
    0,
    0,      // FDE with length 0 (end of records marker)
]
</code></pre></div>


<p>This table appears correct.</p>
<p>There appears to be a <a href="https://github.com/libunwind/libunwind/issues/138">libunwind issue</a> unrelated to wasmtime that hasn't been investigated, although I'm not sure if that one is musl-related or not.</p>
<p>I'll see if I can debug into libunwind and see what's tripping it up.</p>
</blockquote>



<a name="201778863"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20Issue%20%231904%20%22bad%20fde%22%20warning%20when%20compiled%20fo.../near/201778863" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20Issue.20.231904.20.22bad.20fde.22.20warning.20when.20compiled.20fo.2E.2E.2E.html#201778863">(Jun 23 2020 at 20:33)</a>:</h4>
<p>peterhuene <a href="https://github.com/bytecodealliance/wasmtime/issues/1904#issuecomment-648402231">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/1904">Issue #1904</a>:</p>
<blockquote>
<p>This bug is due to Wasmtime expecting <code>__register_frame</code> (aliased to <code>__unw_add_dynamic_fde</code> in libunwind) to take a whole table like it does with libgcc, but musl, like the macOS implementation, expects a single FDE.</p>
<p>We need to update the <code>UnwindRegistry</code> to iterate the FDEs like we do for macOS.</p>
</blockquote>



<a name="201780757"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20Issue%20%231904%20%22bad%20fde%22%20warning%20when%20compiled%20fo.../near/201780757" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20Issue.20.231904.20.22bad.20fde.22.20warning.20when.20compiled.20fo.2E.2E.2E.html#201780757">(Jun 23 2020 at 20:48)</a>:</h4>
<p>peterhuene edited a <a href="https://github.com/bytecodealliance/wasmtime/issues/1904#issuecomment-648377334">comment</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/1904">Issue #1904</a>:</p>
<blockquote>
<p>There are two warnings because two frame tables are being registered, one for the the wasm functions and one for the trampolines.</p>
<p>Here's one of the decoded frame tables being passed to <code>__unw_add_dynamic_fde</code>:</p>
<div class="codehilite"><pre><span></span><code>[
    20,
    0,
    0,
    0,      // CIE length: 20 bytes

    0,
    0,
    0,
    0,      // CIE ID: 0

    1,      // Version: 1

    0,      // Agumentation (none)

    1,      // Code alignment factor

    120,    // Data alignment factor (-8)

    16,     // Return register: RAX

    12,     // Start of initial instructions
    7,
    8,
    144,
    1,
    0,
    0,
    0,
    0,
    0,
    0,      // End of initial instructions

    36,
    0,
    0,
    0,      // FDE length: 36 bytes

    28,
    0,
    0,
    0,      // CIE offset: 4 (FDE length) + 24 (CIE record + length) = 28

    0,
    0,
    221,
    247,
    255,
    127,
    0,
    0,      // Function address: 0x00007ffff7dd0000

    28,
    0,
    0,
    0,
    0,
    0,
    0,
    0,      // Function length: 28 bytes

    66,     // Start of call frame instructions
    14,
    16,
    134,
    2,
    67,
    13,
    6,
    86,
    12,
    7,
    8,
    0,
    0,
    0,
    0,      // End of call frame instructions

    36,
    0,
    0,
    0,      // FDE length: 36 bytes

    68,
    0,
    0,
    0,      // CIE offset: 4 (this FDE length) + 40 (first FDE record + length) + 24 (CIE record + length) = 68

    28,
    0,
    221,
    247,
    255,
    127,
    0,
    0,      // Function address: 0x00007FFFF7DD001C

    11,
    0,
    0,
    0,
    0,
    0,
    0,
    0,      // Function length: 11 bytes

    66,     // Start of call frame instructions
    14,
    16,
    134,
    2,
    67,
    13,
    6,
    69,
    12,
    7,
    8,
    0,
    0,
    0,
    0,      // End of call frame instructions

    0,
    0,
    0,
    0,      // FDE with length 0 (end of records marker)
]
</code></pre></div>


<p>This table appears correct.</p>
<p>There appears to be a <a href="https://github.com/libunwind/libunwind/issues/138">libunwind issue</a> unrelated to wasmtime that hasn't been investigated, although I'm not sure if that one is musl-related or not.</p>
<p>I'll see if I can debug into libunwind and see what's tripping it up.</p>
</blockquote>



<a name="202017650"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20Issue%20%231904%20%22bad%20fde%22%20warning%20when%20compiled%20fo.../near/202017650" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20Issue.20.231904.20.22bad.20fde.22.20warning.20when.20compiled.20fo.2E.2E.2E.html#202017650">(Jun 25 2020 at 20:02)</a>:</h4>
<p>peterhuene closed <a href="https://github.com/bytecodealliance/wasmtime/issues/1904">Issue #1904</a> (assigned to peterhuene):</p>
<blockquote>
<p>When wasmtime is compiled with <code>cargo build --target x86_64-unknown-linux-musl</code>, it produces a runtime warning as below:</p>
<div class="codehilite"><pre><span></span><code><span class="gp">$</span> ./target/x86_64-unknown-linux-musl/debug/wasmtime tests/wasm/hello_wasi_snapshot1.wat
<span class="go">libunwind: __unw_add_dynamic_fde: bad fde: FDE is really a CIE</span>
<span class="go">libunwind: __unw_add_dynamic_fde: bad fde: FDE is really a CIE</span>
<span class="go">Hello, world!</span>
</code></pre></div>


<ul>
<li>
<p>What are the steps to reproduce the issue?<br>
See above.</p>
</li>
<li>
<p>What do you expect to happen? What does actually happen? Does it panic, and<br>
  if so, with which assertion?<br>
I am actually not sure about the impact, but it looks like the FDE record is corrupted in the generated code.</p>
</li>
<li>
<p>Which Wasmtime version / commit hash / branch are you using?<br>
git master (f4e3e4efde28ac90be9fd68dcbda2943b3851155)</p>
</li>
<li>
<p>If relevant, can you include some extra information about your environment?<br>
  (Rust version, operating system, architecture...)</p>
<ul>
<li>rustc 1.43.0 (4fb7144ed 2020-04-20)</li>
<li>Fedora 32 (x86_64)</li>
</ul>
</li>
</ul>
</blockquote>



<a name="202018199"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20Issue%20%231904%20%22bad%20fde%22%20warning%20when%20compiled%20fo.../near/202018199" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20Issue.20.231904.20.22bad.20fde.22.20warning.20when.20compiled.20fo.2E.2E.2E.html#202018199">(Jun 25 2020 at 20:07)</a>:</h4>
<p>peterhuene <a href="https://github.com/bytecodealliance/wasmtime/issues/1904#issuecomment-649790718">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/1904">Issue #1904</a>:</p>
<blockquote>
<p>So #1914 fixes these warnings and Wasmtime now correctly registers the JIT unwind information for musl builds of Wasmtime.</p>
<p>Unfortunately, we discovered that musl-targeted LLVM's libunwind is unable to walk stacks properly from signal handlers (see discussion in #1914), which is what Wasmtime needs to capture trap backtraces.  As a result, musl-targeted Wasmtime won't show any backtraces for traps.</p>
<p>We have a related issue to this where foreign frames that don't have unwind information (#1845) also trip this up.  We may stop using the system-provided unwinder for walking the stack in the future and this will likely fix this issue for musl builds as well.</p>
</blockquote>



<hr><p>Last updated: Jan 20 2025 at 06:04 UTC</p>
</html>