<html>
<head><meta charset="utf-8"><title>wasmtime / issue #4564 Cranelift: error &quot;unimplemented re... · git-wasmtime · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/index.html">git-wasmtime</a></h2>
<h3>Topic: <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.234564.20Cranelift.3A.20error.20.22unimplemented.20re.2E.2E.2E.html">wasmtime / issue #4564 Cranelift: error &quot;unimplemented re...</a></h3>

<hr>

<base href="https://bytecodealliance.zulipchat.com">

<head><link href="https://bytecodealliance.github.io/zulip-archive/style.css" rel="stylesheet"></head>

<a name="291423810"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%234564%20Cranelift%3A%20error%20%22unimplemented%20re.../near/291423810" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.234564.20Cranelift.3A.20error.20.22unimplemented.20re.2E.2E.2E.html#291423810">(Jul 30 2022 at 11:28)</a>:</h4>
<p>teymour-aldridge opened <a href="https://github.com/bytecodealliance/wasmtime/issues/4564">issue #4564</a>:</p>
<blockquote>
<p>Thanks for filing an issue! Please fill out the TODOs below.</p>
<h3><code>.clif</code> Test Case</h3>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="n">function</span><span class="w"> </span><span class="n">u0</span>:<span class="mi">0</span><span class="p">()</span><span class="w"> </span>-&gt; <span class="kt">i64</span> <span class="nc">apple_aarch64</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">sig0</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="kt">i64</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="kt">i64</span> <span class="nc">apple_aarch64</span><span class="w"></span>
<span class="w">    </span><span class="n">sig1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="kt">i64</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="kt">i64</span> <span class="nc">apple_aarch64</span><span class="w"></span>
<span class="w">    </span><span class="n">fn0</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">u0</span>:<span class="mi">1</span><span class="w"> </span><span class="n">sig0</span><span class="w"></span>
<span class="w">    </span><span class="n">fn1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">u0</span>:<span class="mi">2</span><span class="w"> </span><span class="n">sig1</span><span class="w"></span>

<span class="n">block0</span>:
    <span class="nc">v0</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">iconst</span><span class="p">.</span><span class="kt">i64</span><span class="w"> </span><span class="mi">13</span><span class="w"></span>
<span class="w">    </span><span class="n">v1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">call</span><span class="w"> </span><span class="n">fn1</span><span class="p">(</span><span class="n">v0</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="n">v2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">call</span><span class="w"> </span><span class="n">fn0</span><span class="p">(</span><span class="n">v1</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="n">v3</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">iconst</span><span class="p">.</span><span class="kt">i64</span><span class="w"> </span><span class="mi">0</span><span class="w"></span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">v3</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="n">function</span><span class="w"> </span><span class="n">u0</span>:<span class="mi">1</span><span class="p">(</span><span class="kt">i64</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="kt">i64</span> <span class="nc">apple_aarch64</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">sig0</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="kt">i64</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="kt">i64</span> <span class="nc">apple_aarch64</span><span class="w"></span>
<span class="w">    </span><span class="n">sig1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="kt">i64</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="kt">i64</span> <span class="nc">apple_aarch64</span><span class="w"></span>
<span class="w">    </span><span class="n">fn0</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">colocated</span><span class="w"> </span><span class="n">u0</span>:<span class="mi">2</span><span class="w"> </span><span class="n">sig0</span><span class="w"></span>
<span class="w">    </span><span class="n">fn1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">colocated</span><span class="w"> </span><span class="n">u0</span>:<span class="mi">2</span><span class="w"> </span><span class="n">sig1</span><span class="w"></span>

<span class="n">block0</span><span class="p">(</span><span class="n">v0</span>: <span class="kt">i64</span><span class="p">)</span>:
    <span class="nc">v1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">iconst</span><span class="p">.</span><span class="kt">i64</span><span class="w"> </span><span class="mi">0</span><span class="w"></span>
<span class="w">    </span><span class="n">v2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">icmp</span><span class="w"> </span><span class="n">eq</span><span class="w"> </span><span class="n">v0</span><span class="p">,</span><span class="w"> </span><span class="n">v1</span><span class="w"></span>
<span class="w">    </span><span class="n">brz</span><span class="w"> </span><span class="n">v2</span><span class="p">,</span><span class="w"> </span><span class="n">block2</span><span class="w"></span>
<span class="w">    </span><span class="n">jump</span><span class="w"> </span><span class="n">block1</span><span class="w"></span>

<span class="n">block1</span>:
    <span class="nc">v3</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">iconst</span><span class="p">.</span><span class="kt">i64</span><span class="w"> </span><span class="mi">0</span><span class="w"></span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">v3</span><span class="w"></span>

<span class="n">block2</span>:
    <span class="nc">v4</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">iconst</span><span class="p">.</span><span class="kt">i64</span><span class="w"> </span><span class="mi">1</span><span class="w"></span>
<span class="w">    </span><span class="n">v5</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">icmp</span><span class="p">.</span><span class="kt">i64</span><span class="w"> </span><span class="n">eq</span><span class="w"> </span><span class="n">v0</span><span class="p">,</span><span class="w"> </span><span class="n">v4</span><span class="w"></span>
<span class="w">    </span><span class="n">brz</span><span class="w"> </span><span class="n">v5</span><span class="p">,</span><span class="w"> </span><span class="n">block4</span><span class="w"></span>
<span class="w">    </span><span class="n">jump</span><span class="w"> </span><span class="n">block3</span><span class="w"></span>

<span class="n">block3</span>:
    <span class="nc">v6</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">iconst</span><span class="p">.</span><span class="kt">i64</span><span class="w"> </span><span class="mi">1</span><span class="w"></span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">v6</span><span class="w"></span>

<span class="n">block4</span>:
    <span class="nc">v7</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">iconst</span><span class="p">.</span><span class="kt">i64</span><span class="w"> </span><span class="mi">1</span><span class="w"></span>
<span class="w">    </span><span class="n">v8</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">isub</span><span class="p">.</span><span class="kt">i64</span><span class="w"> </span><span class="n">v0</span><span class="p">,</span><span class="w"> </span><span class="n">v7</span><span class="w"></span>
<span class="w">    </span><span class="n">v9</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">call</span><span class="w"> </span><span class="n">fn0</span><span class="p">(</span><span class="n">v8</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="n">v10</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">iconst</span><span class="p">.</span><span class="kt">i64</span><span class="w"> </span><span class="mi">2</span><span class="w"></span>
<span class="w">    </span><span class="n">v11</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">isub</span><span class="p">.</span><span class="kt">i64</span><span class="w"> </span><span class="n">v0</span><span class="p">,</span><span class="w"> </span><span class="n">v10</span><span class="w"></span>
<span class="w">    </span><span class="n">v12</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">call</span><span class="w"> </span><span class="n">fn1</span><span class="p">(</span><span class="n">v11</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="n">v13</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">iadd</span><span class="w"> </span><span class="n">v9</span><span class="p">,</span><span class="w"> </span><span class="n">v12</span><span class="w"></span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">v13</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>
<h3>Steps to Reproduce</h3>
<ol>
<li>Run on an Apple M1 chip</li>
</ol>
<h3>Expected Results</h3>
<ul>
<li>The program should compile</li>
</ul>
<h3>Actual Results</h3>
<p>The program paniced:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="n">thread</span><span class="w"> </span><span class="o">'</span><span class="na">main</span><span class="o">'</span><span class="w"> </span><span class="n">panicked</span><span class="w"> </span><span class="n">at</span><span class="w"> </span><span class="o">'</span><span class="na">called</span><span class="w"> </span><span class="err">`</span><span class="nb">Result</span>::<span class="n">unwrap</span><span class="p">()</span><span class="err">`</span><span class="w"> </span><span class="n">on</span><span class="w"> </span><span class="n">an</span><span class="w"> </span><span class="err">`</span><span class="nb">Err</span><span class="err">`</span><span class="w"> </span><span class="n">value</span>: <span class="nc">Error</span><span class="p">(</span><span class="s">"unimplemented relocation addend Relocation { offset: 104, size: 26, kind: Relative, encoding: AArch64Call, symbol: SymbolId(3), addend: -4 }"</span><span class="p">)</span><span class="o">'</span><span class="p">,</span><span class="w"> </span><span class="o">&lt;</span><span class="n">some</span><span class="w"> </span><span class="n">path</span><span class="o">&gt;/</span><span class="p">.</span><span class="n">cargo</span><span class="o">/</span><span class="n">registry</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">github</span><span class="p">.</span><span class="n">com</span><span class="o">-</span><span class="mi">1</span><span class="n">ecc6299db9ec823</span><span class="o">/</span><span class="n">cranelift</span><span class="o">-</span><span class="n">object</span><span class="o">-</span><span class="mf">0.86.1</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">backend</span><span class="p">.</span><span class="n">rs</span>:<span class="mi">500</span>:<span class="mi">22</span><span class="w"></span>
</code></pre></div>
<h3>Versions and Environment</h3>
<p>Cranelift version or commit: <code>0.86.1</code></p>
<p>Operating system: MacOS</p>
<p>Architecture: M1</p>
<h3>Extra Info</h3>
<p>This works for me on aarch64-unknown-gnu (see <a href="https://cirrus-ci.com/task/6079482023903232">https://cirrus-ci.com/task/6079482023903232</a> - it runs a lot of additional things, but near the bottom of the "test" task it compiles the Fibonacci function fine), but not aarch64-apple-darwin</p>
</blockquote>



<a name="291423811"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%234564%20Cranelift%3A%20error%20%22unimplemented%20re.../near/291423811" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.234564.20Cranelift.3A.20error.20.22unimplemented.20re.2E.2E.2E.html#291423811">(Jul 30 2022 at 11:28)</a>:</h4>
<p>teymour-aldridge labeled <a href="https://github.com/bytecodealliance/wasmtime/issues/4564">issue #4564</a>:</p>
<blockquote>
<p>Thanks for filing an issue! Please fill out the TODOs below.</p>
<h3><code>.clif</code> Test Case</h3>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="n">function</span><span class="w"> </span><span class="n">u0</span>:<span class="mi">0</span><span class="p">()</span><span class="w"> </span>-&gt; <span class="kt">i64</span> <span class="nc">apple_aarch64</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">sig0</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="kt">i64</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="kt">i64</span> <span class="nc">apple_aarch64</span><span class="w"></span>
<span class="w">    </span><span class="n">sig1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="kt">i64</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="kt">i64</span> <span class="nc">apple_aarch64</span><span class="w"></span>
<span class="w">    </span><span class="n">fn0</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">u0</span>:<span class="mi">1</span><span class="w"> </span><span class="n">sig0</span><span class="w"></span>
<span class="w">    </span><span class="n">fn1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">u0</span>:<span class="mi">2</span><span class="w"> </span><span class="n">sig1</span><span class="w"></span>

<span class="n">block0</span>:
    <span class="nc">v0</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">iconst</span><span class="p">.</span><span class="kt">i64</span><span class="w"> </span><span class="mi">13</span><span class="w"></span>
<span class="w">    </span><span class="n">v1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">call</span><span class="w"> </span><span class="n">fn1</span><span class="p">(</span><span class="n">v0</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="n">v2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">call</span><span class="w"> </span><span class="n">fn0</span><span class="p">(</span><span class="n">v1</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="n">v3</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">iconst</span><span class="p">.</span><span class="kt">i64</span><span class="w"> </span><span class="mi">0</span><span class="w"></span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">v3</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="n">function</span><span class="w"> </span><span class="n">u0</span>:<span class="mi">1</span><span class="p">(</span><span class="kt">i64</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="kt">i64</span> <span class="nc">apple_aarch64</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">sig0</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="kt">i64</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="kt">i64</span> <span class="nc">apple_aarch64</span><span class="w"></span>
<span class="w">    </span><span class="n">sig1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="kt">i64</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="kt">i64</span> <span class="nc">apple_aarch64</span><span class="w"></span>
<span class="w">    </span><span class="n">fn0</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">colocated</span><span class="w"> </span><span class="n">u0</span>:<span class="mi">2</span><span class="w"> </span><span class="n">sig0</span><span class="w"></span>
<span class="w">    </span><span class="n">fn1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">colocated</span><span class="w"> </span><span class="n">u0</span>:<span class="mi">2</span><span class="w"> </span><span class="n">sig1</span><span class="w"></span>

<span class="n">block0</span><span class="p">(</span><span class="n">v0</span>: <span class="kt">i64</span><span class="p">)</span>:
    <span class="nc">v1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">iconst</span><span class="p">.</span><span class="kt">i64</span><span class="w"> </span><span class="mi">0</span><span class="w"></span>
<span class="w">    </span><span class="n">v2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">icmp</span><span class="w"> </span><span class="n">eq</span><span class="w"> </span><span class="n">v0</span><span class="p">,</span><span class="w"> </span><span class="n">v1</span><span class="w"></span>
<span class="w">    </span><span class="n">brz</span><span class="w"> </span><span class="n">v2</span><span class="p">,</span><span class="w"> </span><span class="n">block2</span><span class="w"></span>
<span class="w">    </span><span class="n">jump</span><span class="w"> </span><span class="n">block1</span><span class="w"></span>

<span class="n">block1</span>:
    <span class="nc">v3</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">iconst</span><span class="p">.</span><span class="kt">i64</span><span class="w"> </span><span class="mi">0</span><span class="w"></span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">v3</span><span class="w"></span>

<span class="n">block2</span>:
    <span class="nc">v4</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">iconst</span><span class="p">.</span><span class="kt">i64</span><span class="w"> </span><span class="mi">1</span><span class="w"></span>
<span class="w">    </span><span class="n">v5</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">icmp</span><span class="p">.</span><span class="kt">i64</span><span class="w"> </span><span class="n">eq</span><span class="w"> </span><span class="n">v0</span><span class="p">,</span><span class="w"> </span><span class="n">v4</span><span class="w"></span>
<span class="w">    </span><span class="n">brz</span><span class="w"> </span><span class="n">v5</span><span class="p">,</span><span class="w"> </span><span class="n">block4</span><span class="w"></span>
<span class="w">    </span><span class="n">jump</span><span class="w"> </span><span class="n">block3</span><span class="w"></span>

<span class="n">block3</span>:
    <span class="nc">v6</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">iconst</span><span class="p">.</span><span class="kt">i64</span><span class="w"> </span><span class="mi">1</span><span class="w"></span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">v6</span><span class="w"></span>

<span class="n">block4</span>:
    <span class="nc">v7</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">iconst</span><span class="p">.</span><span class="kt">i64</span><span class="w"> </span><span class="mi">1</span><span class="w"></span>
<span class="w">    </span><span class="n">v8</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">isub</span><span class="p">.</span><span class="kt">i64</span><span class="w"> </span><span class="n">v0</span><span class="p">,</span><span class="w"> </span><span class="n">v7</span><span class="w"></span>
<span class="w">    </span><span class="n">v9</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">call</span><span class="w"> </span><span class="n">fn0</span><span class="p">(</span><span class="n">v8</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="n">v10</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">iconst</span><span class="p">.</span><span class="kt">i64</span><span class="w"> </span><span class="mi">2</span><span class="w"></span>
<span class="w">    </span><span class="n">v11</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">isub</span><span class="p">.</span><span class="kt">i64</span><span class="w"> </span><span class="n">v0</span><span class="p">,</span><span class="w"> </span><span class="n">v10</span><span class="w"></span>
<span class="w">    </span><span class="n">v12</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">call</span><span class="w"> </span><span class="n">fn1</span><span class="p">(</span><span class="n">v11</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="n">v13</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">iadd</span><span class="w"> </span><span class="n">v9</span><span class="p">,</span><span class="w"> </span><span class="n">v12</span><span class="w"></span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">v13</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>
<h3>Steps to Reproduce</h3>
<ol>
<li>Run on an Apple M1 chip</li>
</ol>
<h3>Expected Results</h3>
<ul>
<li>The program should compile</li>
</ul>
<h3>Actual Results</h3>
<p>The program paniced:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="n">thread</span><span class="w"> </span><span class="o">'</span><span class="na">main</span><span class="o">'</span><span class="w"> </span><span class="n">panicked</span><span class="w"> </span><span class="n">at</span><span class="w"> </span><span class="o">'</span><span class="na">called</span><span class="w"> </span><span class="err">`</span><span class="nb">Result</span>::<span class="n">unwrap</span><span class="p">()</span><span class="err">`</span><span class="w"> </span><span class="n">on</span><span class="w"> </span><span class="n">an</span><span class="w"> </span><span class="err">`</span><span class="nb">Err</span><span class="err">`</span><span class="w"> </span><span class="n">value</span>: <span class="nc">Error</span><span class="p">(</span><span class="s">"unimplemented relocation addend Relocation { offset: 104, size: 26, kind: Relative, encoding: AArch64Call, symbol: SymbolId(3), addend: -4 }"</span><span class="p">)</span><span class="o">'</span><span class="p">,</span><span class="w"> </span><span class="o">&lt;</span><span class="n">some</span><span class="w"> </span><span class="n">path</span><span class="o">&gt;/</span><span class="p">.</span><span class="n">cargo</span><span class="o">/</span><span class="n">registry</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">github</span><span class="p">.</span><span class="n">com</span><span class="o">-</span><span class="mi">1</span><span class="n">ecc6299db9ec823</span><span class="o">/</span><span class="n">cranelift</span><span class="o">-</span><span class="n">object</span><span class="o">-</span><span class="mf">0.86.1</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">backend</span><span class="p">.</span><span class="n">rs</span>:<span class="mi">500</span>:<span class="mi">22</span><span class="w"></span>
</code></pre></div>
<h3>Versions and Environment</h3>
<p>Cranelift version or commit: <code>0.86.1</code></p>
<p>Operating system: MacOS</p>
<p>Architecture: M1</p>
<h3>Extra Info</h3>
<p>This works for me on aarch64-unknown-gnu (see <a href="https://cirrus-ci.com/task/6079482023903232">https://cirrus-ci.com/task/6079482023903232</a> - it runs a lot of additional things, but near the bottom of the "test" task it compiles the Fibonacci function fine), but not aarch64-apple-darwin</p>
</blockquote>



<a name="291423812"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%234564%20Cranelift%3A%20error%20%22unimplemented%20re.../near/291423812" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.234564.20Cranelift.3A.20error.20.22unimplemented.20re.2E.2E.2E.html#291423812">(Jul 30 2022 at 11:28)</a>:</h4>
<p>teymour-aldridge labeled <a href="https://github.com/bytecodealliance/wasmtime/issues/4564">issue #4564</a>:</p>
<blockquote>
<p>Thanks for filing an issue! Please fill out the TODOs below.</p>
<h3><code>.clif</code> Test Case</h3>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="n">function</span><span class="w"> </span><span class="n">u0</span>:<span class="mi">0</span><span class="p">()</span><span class="w"> </span>-&gt; <span class="kt">i64</span> <span class="nc">apple_aarch64</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">sig0</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="kt">i64</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="kt">i64</span> <span class="nc">apple_aarch64</span><span class="w"></span>
<span class="w">    </span><span class="n">sig1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="kt">i64</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="kt">i64</span> <span class="nc">apple_aarch64</span><span class="w"></span>
<span class="w">    </span><span class="n">fn0</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">u0</span>:<span class="mi">1</span><span class="w"> </span><span class="n">sig0</span><span class="w"></span>
<span class="w">    </span><span class="n">fn1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">u0</span>:<span class="mi">2</span><span class="w"> </span><span class="n">sig1</span><span class="w"></span>

<span class="n">block0</span>:
    <span class="nc">v0</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">iconst</span><span class="p">.</span><span class="kt">i64</span><span class="w"> </span><span class="mi">13</span><span class="w"></span>
<span class="w">    </span><span class="n">v1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">call</span><span class="w"> </span><span class="n">fn1</span><span class="p">(</span><span class="n">v0</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="n">v2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">call</span><span class="w"> </span><span class="n">fn0</span><span class="p">(</span><span class="n">v1</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="n">v3</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">iconst</span><span class="p">.</span><span class="kt">i64</span><span class="w"> </span><span class="mi">0</span><span class="w"></span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">v3</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="n">function</span><span class="w"> </span><span class="n">u0</span>:<span class="mi">1</span><span class="p">(</span><span class="kt">i64</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="kt">i64</span> <span class="nc">apple_aarch64</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">sig0</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="kt">i64</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="kt">i64</span> <span class="nc">apple_aarch64</span><span class="w"></span>
<span class="w">    </span><span class="n">sig1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="kt">i64</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="kt">i64</span> <span class="nc">apple_aarch64</span><span class="w"></span>
<span class="w">    </span><span class="n">fn0</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">colocated</span><span class="w"> </span><span class="n">u0</span>:<span class="mi">2</span><span class="w"> </span><span class="n">sig0</span><span class="w"></span>
<span class="w">    </span><span class="n">fn1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">colocated</span><span class="w"> </span><span class="n">u0</span>:<span class="mi">2</span><span class="w"> </span><span class="n">sig1</span><span class="w"></span>

<span class="n">block0</span><span class="p">(</span><span class="n">v0</span>: <span class="kt">i64</span><span class="p">)</span>:
    <span class="nc">v1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">iconst</span><span class="p">.</span><span class="kt">i64</span><span class="w"> </span><span class="mi">0</span><span class="w"></span>
<span class="w">    </span><span class="n">v2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">icmp</span><span class="w"> </span><span class="n">eq</span><span class="w"> </span><span class="n">v0</span><span class="p">,</span><span class="w"> </span><span class="n">v1</span><span class="w"></span>
<span class="w">    </span><span class="n">brz</span><span class="w"> </span><span class="n">v2</span><span class="p">,</span><span class="w"> </span><span class="n">block2</span><span class="w"></span>
<span class="w">    </span><span class="n">jump</span><span class="w"> </span><span class="n">block1</span><span class="w"></span>

<span class="n">block1</span>:
    <span class="nc">v3</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">iconst</span><span class="p">.</span><span class="kt">i64</span><span class="w"> </span><span class="mi">0</span><span class="w"></span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">v3</span><span class="w"></span>

<span class="n">block2</span>:
    <span class="nc">v4</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">iconst</span><span class="p">.</span><span class="kt">i64</span><span class="w"> </span><span class="mi">1</span><span class="w"></span>
<span class="w">    </span><span class="n">v5</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">icmp</span><span class="p">.</span><span class="kt">i64</span><span class="w"> </span><span class="n">eq</span><span class="w"> </span><span class="n">v0</span><span class="p">,</span><span class="w"> </span><span class="n">v4</span><span class="w"></span>
<span class="w">    </span><span class="n">brz</span><span class="w"> </span><span class="n">v5</span><span class="p">,</span><span class="w"> </span><span class="n">block4</span><span class="w"></span>
<span class="w">    </span><span class="n">jump</span><span class="w"> </span><span class="n">block3</span><span class="w"></span>

<span class="n">block3</span>:
    <span class="nc">v6</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">iconst</span><span class="p">.</span><span class="kt">i64</span><span class="w"> </span><span class="mi">1</span><span class="w"></span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">v6</span><span class="w"></span>

<span class="n">block4</span>:
    <span class="nc">v7</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">iconst</span><span class="p">.</span><span class="kt">i64</span><span class="w"> </span><span class="mi">1</span><span class="w"></span>
<span class="w">    </span><span class="n">v8</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">isub</span><span class="p">.</span><span class="kt">i64</span><span class="w"> </span><span class="n">v0</span><span class="p">,</span><span class="w"> </span><span class="n">v7</span><span class="w"></span>
<span class="w">    </span><span class="n">v9</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">call</span><span class="w"> </span><span class="n">fn0</span><span class="p">(</span><span class="n">v8</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="n">v10</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">iconst</span><span class="p">.</span><span class="kt">i64</span><span class="w"> </span><span class="mi">2</span><span class="w"></span>
<span class="w">    </span><span class="n">v11</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">isub</span><span class="p">.</span><span class="kt">i64</span><span class="w"> </span><span class="n">v0</span><span class="p">,</span><span class="w"> </span><span class="n">v10</span><span class="w"></span>
<span class="w">    </span><span class="n">v12</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">call</span><span class="w"> </span><span class="n">fn1</span><span class="p">(</span><span class="n">v11</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="n">v13</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">iadd</span><span class="w"> </span><span class="n">v9</span><span class="p">,</span><span class="w"> </span><span class="n">v12</span><span class="w"></span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">v13</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>
<h3>Steps to Reproduce</h3>
<ol>
<li>Run on an Apple M1 chip</li>
</ol>
<h3>Expected Results</h3>
<ul>
<li>The program should compile</li>
</ul>
<h3>Actual Results</h3>
<p>The program paniced:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="n">thread</span><span class="w"> </span><span class="o">'</span><span class="na">main</span><span class="o">'</span><span class="w"> </span><span class="n">panicked</span><span class="w"> </span><span class="n">at</span><span class="w"> </span><span class="o">'</span><span class="na">called</span><span class="w"> </span><span class="err">`</span><span class="nb">Result</span>::<span class="n">unwrap</span><span class="p">()</span><span class="err">`</span><span class="w"> </span><span class="n">on</span><span class="w"> </span><span class="n">an</span><span class="w"> </span><span class="err">`</span><span class="nb">Err</span><span class="err">`</span><span class="w"> </span><span class="n">value</span>: <span class="nc">Error</span><span class="p">(</span><span class="s">"unimplemented relocation addend Relocation { offset: 104, size: 26, kind: Relative, encoding: AArch64Call, symbol: SymbolId(3), addend: -4 }"</span><span class="p">)</span><span class="o">'</span><span class="p">,</span><span class="w"> </span><span class="o">&lt;</span><span class="n">some</span><span class="w"> </span><span class="n">path</span><span class="o">&gt;/</span><span class="p">.</span><span class="n">cargo</span><span class="o">/</span><span class="n">registry</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">github</span><span class="p">.</span><span class="n">com</span><span class="o">-</span><span class="mi">1</span><span class="n">ecc6299db9ec823</span><span class="o">/</span><span class="n">cranelift</span><span class="o">-</span><span class="n">object</span><span class="o">-</span><span class="mf">0.86.1</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">backend</span><span class="p">.</span><span class="n">rs</span>:<span class="mi">500</span>:<span class="mi">22</span><span class="w"></span>
</code></pre></div>
<h3>Versions and Environment</h3>
<p>Cranelift version or commit: <code>0.86.1</code></p>
<p>Operating system: MacOS</p>
<p>Architecture: M1</p>
<h3>Extra Info</h3>
<p>This works for me on aarch64-unknown-gnu (see <a href="https://cirrus-ci.com/task/6079482023903232">https://cirrus-ci.com/task/6079482023903232</a> - it runs a lot of additional things, but near the bottom of the "test" task it compiles the Fibonacci function fine), but not aarch64-apple-darwin</p>
</blockquote>



<a name="291423827"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%234564%20Cranelift%3A%20error%20%22unimplemented%20re.../near/291423827" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.234564.20Cranelift.3A.20error.20.22unimplemented.20re.2E.2E.2E.html#291423827">(Jul 30 2022 at 11:28)</a>:</h4>
<p>teymour-aldridge edited <a href="https://github.com/bytecodealliance/wasmtime/issues/4564">issue #4564</a>:</p>
<blockquote>
<p>Thanks for filing an issue! Please fill out the TODOs below.</p>
<h3><code>.clif</code> Test Case</h3>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="n">function</span><span class="w"> </span><span class="n">u0</span>:<span class="mi">0</span><span class="p">()</span><span class="w"> </span>-&gt; <span class="kt">i64</span> <span class="nc">apple_aarch64</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">sig0</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="kt">i64</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="kt">i64</span> <span class="nc">apple_aarch64</span><span class="w"></span>
<span class="w">    </span><span class="n">sig1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="kt">i64</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="kt">i64</span> <span class="nc">apple_aarch64</span><span class="w"></span>
<span class="w">    </span><span class="n">fn0</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">u0</span>:<span class="mi">1</span><span class="w"> </span><span class="n">sig0</span><span class="w"></span>
<span class="w">    </span><span class="n">fn1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">u0</span>:<span class="mi">2</span><span class="w"> </span><span class="n">sig1</span><span class="w"></span>

<span class="n">block0</span>:
    <span class="nc">v0</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">iconst</span><span class="p">.</span><span class="kt">i64</span><span class="w"> </span><span class="mi">13</span><span class="w"></span>
<span class="w">    </span><span class="n">v1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">call</span><span class="w"> </span><span class="n">fn1</span><span class="p">(</span><span class="n">v0</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="n">v2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">call</span><span class="w"> </span><span class="n">fn0</span><span class="p">(</span><span class="n">v1</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="n">v3</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">iconst</span><span class="p">.</span><span class="kt">i64</span><span class="w"> </span><span class="mi">0</span><span class="w"></span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">v3</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="n">function</span><span class="w"> </span><span class="n">u0</span>:<span class="mi">1</span><span class="p">(</span><span class="kt">i64</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="kt">i64</span> <span class="nc">apple_aarch64</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">sig0</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="kt">i64</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="kt">i64</span> <span class="nc">apple_aarch64</span><span class="w"></span>
<span class="w">    </span><span class="n">sig1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="kt">i64</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="kt">i64</span> <span class="nc">apple_aarch64</span><span class="w"></span>
<span class="w">    </span><span class="n">fn0</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">colocated</span><span class="w"> </span><span class="n">u0</span>:<span class="mi">2</span><span class="w"> </span><span class="n">sig0</span><span class="w"></span>
<span class="w">    </span><span class="n">fn1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">colocated</span><span class="w"> </span><span class="n">u0</span>:<span class="mi">2</span><span class="w"> </span><span class="n">sig1</span><span class="w"></span>

<span class="n">block0</span><span class="p">(</span><span class="n">v0</span>: <span class="kt">i64</span><span class="p">)</span>:
    <span class="nc">v1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">iconst</span><span class="p">.</span><span class="kt">i64</span><span class="w"> </span><span class="mi">0</span><span class="w"></span>
<span class="w">    </span><span class="n">v2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">icmp</span><span class="w"> </span><span class="n">eq</span><span class="w"> </span><span class="n">v0</span><span class="p">,</span><span class="w"> </span><span class="n">v1</span><span class="w"></span>
<span class="w">    </span><span class="n">brz</span><span class="w"> </span><span class="n">v2</span><span class="p">,</span><span class="w"> </span><span class="n">block2</span><span class="w"></span>
<span class="w">    </span><span class="n">jump</span><span class="w"> </span><span class="n">block1</span><span class="w"></span>

<span class="n">block1</span>:
    <span class="nc">v3</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">iconst</span><span class="p">.</span><span class="kt">i64</span><span class="w"> </span><span class="mi">0</span><span class="w"></span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">v3</span><span class="w"></span>

<span class="n">block2</span>:
    <span class="nc">v4</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">iconst</span><span class="p">.</span><span class="kt">i64</span><span class="w"> </span><span class="mi">1</span><span class="w"></span>
<span class="w">    </span><span class="n">v5</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">icmp</span><span class="p">.</span><span class="kt">i64</span><span class="w"> </span><span class="n">eq</span><span class="w"> </span><span class="n">v0</span><span class="p">,</span><span class="w"> </span><span class="n">v4</span><span class="w"></span>
<span class="w">    </span><span class="n">brz</span><span class="w"> </span><span class="n">v5</span><span class="p">,</span><span class="w"> </span><span class="n">block4</span><span class="w"></span>
<span class="w">    </span><span class="n">jump</span><span class="w"> </span><span class="n">block3</span><span class="w"></span>

<span class="n">block3</span>:
    <span class="nc">v6</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">iconst</span><span class="p">.</span><span class="kt">i64</span><span class="w"> </span><span class="mi">1</span><span class="w"></span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">v6</span><span class="w"></span>

<span class="n">block4</span>:
    <span class="nc">v7</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">iconst</span><span class="p">.</span><span class="kt">i64</span><span class="w"> </span><span class="mi">1</span><span class="w"></span>
<span class="w">    </span><span class="n">v8</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">isub</span><span class="p">.</span><span class="kt">i64</span><span class="w"> </span><span class="n">v0</span><span class="p">,</span><span class="w"> </span><span class="n">v7</span><span class="w"></span>
<span class="w">    </span><span class="n">v9</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">call</span><span class="w"> </span><span class="n">fn0</span><span class="p">(</span><span class="n">v8</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="n">v10</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">iconst</span><span class="p">.</span><span class="kt">i64</span><span class="w"> </span><span class="mi">2</span><span class="w"></span>
<span class="w">    </span><span class="n">v11</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">isub</span><span class="p">.</span><span class="kt">i64</span><span class="w"> </span><span class="n">v0</span><span class="p">,</span><span class="w"> </span><span class="n">v10</span><span class="w"></span>
<span class="w">    </span><span class="n">v12</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">call</span><span class="w"> </span><span class="n">fn1</span><span class="p">(</span><span class="n">v11</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="n">v13</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">iadd</span><span class="w"> </span><span class="n">v9</span><span class="p">,</span><span class="w"> </span><span class="n">v12</span><span class="w"></span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">v13</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>
<h3>Steps to Reproduce</h3>
<ol>
<li>Run on an Apple M1 chip</li>
</ol>
<h3>Expected Results</h3>
<ul>
<li>The program should compile</li>
</ul>
<h3>Actual Results</h3>
<p>The program paniced:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="n">thread</span><span class="w"> </span><span class="o">'</span><span class="na">main</span><span class="o">'</span><span class="w"> </span><span class="n">panicked</span><span class="w"> </span><span class="n">at</span><span class="w"> </span><span class="o">'</span><span class="na">called</span><span class="w"> </span><span class="err">`</span><span class="nb">Result</span>::<span class="n">unwrap</span><span class="p">()</span><span class="err">`</span><span class="w"> </span><span class="n">on</span><span class="w"> </span><span class="n">an</span><span class="w"> </span><span class="err">`</span><span class="nb">Err</span><span class="err">`</span><span class="w"> </span><span class="n">value</span>: <span class="nc">Error</span><span class="p">(</span><span class="s">"unimplemented relocation addend Relocation { offset: 104, size: 26, kind: Relative, encoding: AArch64Call, symbol: SymbolId(3), addend: -4 }"</span><span class="p">)</span><span class="o">'</span><span class="p">,</span><span class="w"> </span><span class="o">&lt;</span><span class="n">some</span><span class="w"> </span><span class="n">path</span><span class="o">&gt;/</span><span class="p">.</span><span class="n">cargo</span><span class="o">/</span><span class="n">registry</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">github</span><span class="p">.</span><span class="n">com</span><span class="o">-</span><span class="mi">1</span><span class="n">ecc6299db9ec823</span><span class="o">/</span><span class="n">cranelift</span><span class="o">-</span><span class="n">object</span><span class="o">-</span><span class="mf">0.86.1</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">backend</span><span class="p">.</span><span class="n">rs</span>:<span class="mi">500</span>:<span class="mi">22</span><span class="w"></span>
</code></pre></div>
<h3>Versions and Environment</h3>
<p>Cranelift version or commit: <code>0.86.1</code></p>
<p>Operating system: MacOS</p>
<p>Architecture: M1</p>
<h3>Extra Info</h3>
<p>This works for me on aarch64-unknown-gnu (see <a href="https://cirrus-ci.com/task/6079482023903232">https://cirrus-ci.com/task/6079482023903232</a> - it runs a lot of additional things, but near the bottom of the "test" task it compiles the Fibonacci function fine), but not aarch64-apple-darwin. It also works on x86_64-apple-darwin.</p>
</blockquote>



<a name="291607281"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%234564%20Cranelift%3A%20error%20%22unimplemented%20re.../near/291607281" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.234564.20Cranelift.3A.20error.20.22unimplemented.20re.2E.2E.2E.html#291607281">(Aug 01 2022 at 17:27)</a>:</h4>
<p>cfallin <a href="https://github.com/bytecodealliance/wasmtime/issues/4564#issuecomment-1201499087">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/4564">issue #4564</a>:</p>
<blockquote>
<p>Thanks for the report. Did this CLIF come from Wasmtime or some other frontend? (I ask because we try to support Wasmtime's use of Cranelift on aarch64-apple-darwin but the use of Cranelift with other frontends is much less well-tested. That doesn't mean we don't <em>want</em> to support it, I'm just trying to judge the severity.) It sounds like we need to implement another relocation case here. If you're willing to dig into it further, I'd be happy to review a PR.</p>
</blockquote>



<a name="291660486"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%234564%20Cranelift%3A%20error%20%22unimplemented%20re.../near/291660486" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.234564.20Cranelift.3A.20error.20.22unimplemented.20re.2E.2E.2E.html#291660486">(Aug 02 2022 at 03:28)</a>:</h4>
<p>teymour-aldridge <a href="https://github.com/bytecodealliance/wasmtime/issues/4564#issuecomment-1201973250">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/4564">issue #4564</a>:</p>
<blockquote>
<blockquote>
<p>Did this CLIF come from Wasmtime or some other frontend?</p>
</blockquote>
<p>It came from a different frontend (a small compiler I'm writing). The problem seems to be with<code>cranelift-object</code>, because I can run the same program without error by using <code>cranelift-jit</code> (which I have adopted as a stopgap solution).</p>
<blockquote>
<p>If you're willing to dig into it further, I'd be happy to review a PR.</p>
</blockquote>
<p>I'd be happy to, but I'm not sure what a relocation is :)</p>
</blockquote>



<a name="292101075"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%234564%20Cranelift%3A%20error%20%22unimplemented%20re.../near/292101075" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.234564.20Cranelift.3A.20error.20.22unimplemented.20re.2E.2E.2E.html#292101075">(Aug 05 2022 at 02:51)</a>:</h4>
<p>teymour-aldridge edited <a href="https://github.com/bytecodealliance/wasmtime/issues/4564">issue #4564</a>:</p>
<blockquote>
<p>Thanks for filing an issue! Please fill out the TODOs below.</p>
<h3><code>.clif</code> Test Case</h3>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="n">function</span><span class="w"> </span><span class="n">u0</span>:<span class="mi">0</span><span class="p">()</span><span class="w"> </span>-&gt; <span class="kt">i64</span> <span class="nc">apple_aarch64</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">sig0</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="kt">i64</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="kt">i64</span> <span class="nc">apple_aarch64</span><span class="w"></span>
<span class="w">    </span><span class="n">sig1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="kt">i64</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="kt">i64</span> <span class="nc">apple_aarch64</span><span class="w"></span>
<span class="w">    </span><span class="n">fn0</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">u0</span>:<span class="mi">1</span><span class="w"> </span><span class="n">sig0</span><span class="w"></span>
<span class="w">    </span><span class="n">fn1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">u0</span>:<span class="mi">2</span><span class="w"> </span><span class="n">sig1</span><span class="w"></span>

<span class="n">block0</span>:
    <span class="nc">v0</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">iconst</span><span class="p">.</span><span class="kt">i64</span><span class="w"> </span><span class="mi">13</span><span class="w"></span>
<span class="w">    </span><span class="n">v1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">call</span><span class="w"> </span><span class="n">fn1</span><span class="p">(</span><span class="n">v0</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="n">v2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">call</span><span class="w"> </span><span class="n">fn0</span><span class="p">(</span><span class="n">v1</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="n">v3</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">iconst</span><span class="p">.</span><span class="kt">i64</span><span class="w"> </span><span class="mi">0</span><span class="w"></span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">v3</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="n">function</span><span class="w"> </span><span class="n">u0</span>:<span class="mi">1</span><span class="p">(</span><span class="kt">i64</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="kt">i64</span> <span class="nc">apple_aarch64</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">sig0</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="kt">i64</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="kt">i64</span> <span class="nc">apple_aarch64</span><span class="w"></span>
<span class="w">    </span><span class="n">sig1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="kt">i64</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="kt">i64</span> <span class="nc">apple_aarch64</span><span class="w"></span>
<span class="w">    </span><span class="n">fn0</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">colocated</span><span class="w"> </span><span class="n">u0</span>:<span class="mi">2</span><span class="w"> </span><span class="n">sig0</span><span class="w"></span>
<span class="w">    </span><span class="n">fn1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">colocated</span><span class="w"> </span><span class="n">u0</span>:<span class="mi">2</span><span class="w"> </span><span class="n">sig1</span><span class="w"></span>

<span class="n">block0</span><span class="p">(</span><span class="n">v0</span>: <span class="kt">i64</span><span class="p">)</span>:
    <span class="nc">v1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">iconst</span><span class="p">.</span><span class="kt">i64</span><span class="w"> </span><span class="mi">0</span><span class="w"></span>
<span class="w">    </span><span class="n">v2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">icmp</span><span class="w"> </span><span class="n">eq</span><span class="w"> </span><span class="n">v0</span><span class="p">,</span><span class="w"> </span><span class="n">v1</span><span class="w"></span>
<span class="w">    </span><span class="n">brz</span><span class="w"> </span><span class="n">v2</span><span class="p">,</span><span class="w"> </span><span class="n">block2</span><span class="w"></span>
<span class="w">    </span><span class="n">jump</span><span class="w"> </span><span class="n">block1</span><span class="w"></span>

<span class="n">block1</span>:
    <span class="nc">v3</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">iconst</span><span class="p">.</span><span class="kt">i64</span><span class="w"> </span><span class="mi">0</span><span class="w"></span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">v3</span><span class="w"></span>

<span class="n">block2</span>:
    <span class="nc">v4</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">iconst</span><span class="p">.</span><span class="kt">i64</span><span class="w"> </span><span class="mi">1</span><span class="w"></span>
<span class="w">    </span><span class="n">v5</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">icmp</span><span class="p">.</span><span class="kt">i64</span><span class="w"> </span><span class="n">eq</span><span class="w"> </span><span class="n">v0</span><span class="p">,</span><span class="w"> </span><span class="n">v4</span><span class="w"></span>
<span class="w">    </span><span class="n">brz</span><span class="w"> </span><span class="n">v5</span><span class="p">,</span><span class="w"> </span><span class="n">block4</span><span class="w"></span>
<span class="w">    </span><span class="n">jump</span><span class="w"> </span><span class="n">block3</span><span class="w"></span>

<span class="n">block3</span>:
    <span class="nc">v6</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">iconst</span><span class="p">.</span><span class="kt">i64</span><span class="w"> </span><span class="mi">1</span><span class="w"></span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">v6</span><span class="w"></span>

<span class="n">block4</span>:
    <span class="nc">v7</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">iconst</span><span class="p">.</span><span class="kt">i64</span><span class="w"> </span><span class="mi">1</span><span class="w"></span>
<span class="w">    </span><span class="n">v8</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">isub</span><span class="p">.</span><span class="kt">i64</span><span class="w"> </span><span class="n">v0</span><span class="p">,</span><span class="w"> </span><span class="n">v7</span><span class="w"></span>
<span class="w">    </span><span class="n">v9</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">call</span><span class="w"> </span><span class="n">fn0</span><span class="p">(</span><span class="n">v8</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="n">v10</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">iconst</span><span class="p">.</span><span class="kt">i64</span><span class="w"> </span><span class="mi">2</span><span class="w"></span>
<span class="w">    </span><span class="n">v11</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">isub</span><span class="p">.</span><span class="kt">i64</span><span class="w"> </span><span class="n">v0</span><span class="p">,</span><span class="w"> </span><span class="n">v10</span><span class="w"></span>
<span class="w">    </span><span class="n">v12</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">call</span><span class="w"> </span><span class="n">fn1</span><span class="p">(</span><span class="n">v11</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="n">v13</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">iadd</span><span class="w"> </span><span class="n">v9</span><span class="p">,</span><span class="w"> </span><span class="n">v12</span><span class="w"></span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">v13</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>
<h3>Steps to Reproduce</h3>
<ol>
<li>Run on an Apple M1 chip</li>
</ol>
<h3>Expected Results</h3>
<ul>
<li>The program should compile</li>
</ul>
<h3>Actual Results</h3>
<p>The program paniced:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="n">thread</span><span class="w"> </span><span class="o">'</span><span class="na">main</span><span class="o">'</span><span class="w"> </span><span class="n">panicked</span><span class="w"> </span><span class="n">at</span><span class="w"> </span><span class="o">'</span><span class="na">called</span><span class="w"> </span><span class="err">`</span><span class="nb">Result</span>::<span class="n">unwrap</span><span class="p">()</span><span class="err">`</span><span class="w"> </span><span class="n">on</span><span class="w"> </span><span class="n">an</span><span class="w"> </span><span class="err">`</span><span class="nb">Err</span><span class="err">`</span><span class="w"> </span><span class="n">value</span>: <span class="nc">Error</span><span class="p">(</span><span class="s">"unimplemented relocation addend Relocation { offset: 104, size: 26, kind: Relative, encoding: AArch64Call, symbol: SymbolId(3), addend: -4 }"</span><span class="p">)</span><span class="o">'</span><span class="p">,</span><span class="w"> </span><span class="o">&lt;</span><span class="n">some</span><span class="w"> </span><span class="n">path</span><span class="o">&gt;/</span><span class="p">.</span><span class="n">cargo</span><span class="o">/</span><span class="n">registry</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">github</span><span class="p">.</span><span class="n">com</span><span class="o">-</span><span class="mi">1</span><span class="n">ecc6299db9ec823</span><span class="o">/</span><span class="n">cranelift</span><span class="o">-</span><span class="n">object</span><span class="o">-</span><span class="mf">0.86.1</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">backend</span><span class="p">.</span><span class="n">rs</span>:<span class="mi">500</span>:<span class="mi">22</span><span class="w"></span>
</code></pre></div>
<h3>Versions and Environment</h3>
<p>Cranelift version or commit: <code>0.86.1</code></p>
<p>Operating system: MacOS</p>
<p>Architecture: M1</p>
<h3>Extra Info</h3>
<p>This works for me on aarch64-unknown-gnu (see <a href="https://cirrus-ci.com/task/6079482023903232">https://cirrus-ci.com/task/6079482023903232</a> - it runs a lot of additional things, but near the bottom of the "test" task it compiles the Fibonacci function fine), but not aarch64-apple-darwin. It also works on x86_64-apple-darwin.</p>
</blockquote>



<a name="303382679"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%234564%20Cranelift%3A%20error%20%22unimplemented%20re.../near/303382679" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.234564.20Cranelift.3A.20error.20.22unimplemented.20re.2E.2E.2E.html#303382679">(Oct 11 2022 at 08:39)</a>:</h4>
<p>teymour-aldridge <a href="https://github.com/bytecodealliance/wasmtime/issues/4564#issuecomment-1274318401">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/4564">issue #4564</a>:</p>
<blockquote>
<p>On 02/08/2022 01:27, Chris Fallin wrote:</p>
<blockquote>
<p>Did this CLIF come from Wasmtime or some other frontend?</p>
</blockquote>
<p>It came from a different frontend (a small compiler I'm writing). The <br>
problem seems to be with<code>cranelift-object</code>, because I can run the same <br>
program without error by using <code>cranelift-jit</code>.</p>
<blockquote>
<p>If you're willing to dig into it further, I'd be happy to review a PR.</p>
</blockquote>
<p>I'd be happy to, but I'm not sure what a relocation is :)</p>
</blockquote>



<a name="303382804"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%234564%20Cranelift%3A%20error%20%22unimplemented%20re.../near/303382804" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.234564.20Cranelift.3A.20error.20.22unimplemented.20re.2E.2E.2E.html#303382804">(Oct 11 2022 at 08:40)</a>:</h4>
<p>teymour-aldridge deleted a <a href="https://github.com/bytecodealliance/wasmtime/issues/4564#issuecomment-1274318401">comment</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/4564">issue #4564</a>:</p>
<blockquote>
<p>On 02/08/2022 01:27, Chris Fallin wrote:</p>
<blockquote>
<p>Did this CLIF come from Wasmtime or some other frontend?</p>
</blockquote>
<p>It came from a different frontend (a small compiler I'm writing). The <br>
problem seems to be with<code>cranelift-object</code>, because I can run the same <br>
program without error by using <code>cranelift-jit</code>.</p>
<blockquote>
<p>If you're willing to dig into it further, I'd be happy to review a PR.</p>
</blockquote>
<p>I'd be happy to, but I'm not sure what a relocation is :)</p>
</blockquote>



<a name="303447930"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%234564%20Cranelift%3A%20error%20%22unimplemented%20re.../near/303447930" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.234564.20Cranelift.3A.20error.20.22unimplemented.20re.2E.2E.2E.html#303447930">(Oct 11 2022 at 14:17)</a>:</h4>
<p>afonso360 <a href="https://github.com/bytecodealliance/wasmtime/issues/4564#issuecomment-1274766208">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/4564">issue #4564</a>:</p>
<blockquote>
<p>I think this might already be fixed upstream in <a href="https://github.com/gimli-rs/object/pull/465">https://github.com/gimli-rs/object/pull/465</a>, so it might be a case of just updating the object crate whenever they do their next release.</p>
</blockquote>



<a name="320107518"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%234564%20Cranelift%3A%20error%20%22unimplemented%20re.../near/320107518" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.234564.20Cranelift.3A.20error.20.22unimplemented.20re.2E.2E.2E.html#320107518">(Jan 08 2023 at 18:48)</a>:</h4>
<p>afonso360 <a href="https://github.com/bytecodealliance/wasmtime/issues/4564#issuecomment-1374901610">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/4564">issue #4564</a>:</p>
<blockquote>
<p><span aria-label="wave" class="emoji emoji-1f44b" role="img" title="wave">:wave:</span> Hey,</p>
<p>Would you be able to test this code using PR #5434? It includes the updated version of object, and I suspect it might fix your issue.</p>
</blockquote>



<hr><p>Last updated: Jan 20 2025 at 06:04 UTC</p>
</html>