<html>
<head><meta charset="utf-8"><title>wasmtime / issue #5535 Treat `wasmtime::component::Val::F... · git-wasmtime · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/index.html">git-wasmtime</a></h2>
<h3>Topic: <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.235535.20Treat.20.60wasmtime.3A.3Acomponent.3A.3AVal.3A.3AF.2E.2E.2E.html">wasmtime / issue #5535 Treat `wasmtime::component::Val::F...</a></h3>

<hr>

<base href="https://bytecodealliance.zulipchat.com">

<head><link href="https://bytecodealliance.github.io/zulip-archive/style.css" rel="stylesheet"></head>

<a name="319679814"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%235535%20Treat%20%60wasmtime%3A%3Acomponent%3A%3AVal%3A%3AF.../near/319679814" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.235535.20Treat.20.60wasmtime.3A.3Acomponent.3A.3AVal.3A.3AF.2E.2E.2E.html#319679814">(Jan 05 2023 at 21:57)</a>:</h4>
<p>lann <a href="https://github.com/bytecodealliance/wasmtime/pull/5535#issuecomment-1372830003">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/5535">issue #5535</a>:</p>
<blockquote>
<p>As requested by @alexcrichton in <a href="https://github.com/bytecodealliance/wasmtime/pull/5510#issuecomment-1372719177">https://github.com/bytecodealliance/wasmtime/pull/5510#issuecomment-1372719177</a></p>
</blockquote>



<a name="319680525"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%235535%20Treat%20%60wasmtime%3A%3Acomponent%3A%3AVal%3A%3AF.../near/319680525" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.235535.20Treat.20.60wasmtime.3A.3Acomponent.3A.3AVal.3A.3AF.2E.2E.2E.html#319680525">(Jan 05 2023 at 22:01)</a>:</h4>
<p>github-actions[bot] <a href="https://github.com/bytecodealliance/wasmtime/pull/5535#issuecomment-1372834493">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/5535">issue #5535</a>:</p>
<blockquote>
<h4>Subscribe to Label Action</h4>
<p>cc @peterhuene</p>
<p>&lt;details&gt;<br>
This issue or pull request has been labeled: "wasmtime:api"</p>
<p>Thus the following users have been cc'd because of the following labels:</p>
<ul>
<li>peterhuene: wasmtime:api</li>
</ul>
<p>To subscribe or unsubscribe from this label, edit the &lt;code&gt;.github/subscribe-to-label.json&lt;/code&gt; configuration file.</p>
<p><a href="https://github.com/bytecodealliance/subscribe-to-label-action">Learn more.</a><br>
&lt;/details&gt;</p>
</blockquote>



<a name="319683843"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%235535%20Treat%20%60wasmtime%3A%3Acomponent%3A%3AVal%3A%3AF.../near/319683843" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.235535.20Treat.20.60wasmtime.3A.3Acomponent.3A.3AVal.3A.3AF.2E.2E.2E.html#319683843">(Jan 05 2023 at 22:26)</a>:</h4>
<p>jameysharp <a href="https://github.com/bytecodealliance/wasmtime/pull/5535#issuecomment-1372871927">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/5535">issue #5535</a>:</p>
<blockquote>
<p>When we had a similar concern in Cranelift we ended up introducing a separate function that can just special-case floats and use a derived implementation of <code>PartialEq</code> otherwise: <a href="https://github.com/bytecodealliance/wasmtime/blob/32a7593/cranelift/codegen/src/data_value.rs#L169-L187">bitwise_eq</a>.</p>
<p>Although you don't want bitwise equality here, the same pattern should work. It avoids the need to list every enum variant, and the possibility of bugs when new variants are added.</p>
<p>Another way to avoid bugs is to have two cases for each variant, like the implementation of <a href="https://github.com/bytecodealliance/wasmtime/blob/32a7593/cranelift/codegen/src/data_value.rs#L31-L65">PartialEq for DataValue</a>. But I think here it's fine to use <code>assert!</code> instead of <code>assert_eq!</code> in the fuzz target and call a specialized function to do the right check.</p>
</blockquote>



<a name="319684718"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%235535%20Treat%20%60wasmtime%3A%3Acomponent%3A%3AVal%3A%3AF.../near/319684718" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.235535.20Treat.20.60wasmtime.3A.3Acomponent.3A.3AVal.3A.3AF.2E.2E.2E.html#319684718">(Jan 05 2023 at 22:33)</a>:</h4>
<p>lann <a href="https://github.com/bytecodealliance/wasmtime/pull/5535#issuecomment-1372877679">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/5535">issue #5535</a>:</p>
<blockquote>
<blockquote>
<p>a separate function that can just special-case floats</p>
</blockquote>
<p>That certainly could work, but it is significantly more code because of the component model's composite and parameterized types.</p>
</blockquote>



<a name="319687019"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%235535%20Treat%20%60wasmtime%3A%3Acomponent%3A%3AVal%3A%3AF.../near/319687019" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.235535.20Treat.20.60wasmtime.3A.3Acomponent.3A.3AVal.3A.3AF.2E.2E.2E.html#319687019">(Jan 05 2023 at 22:49)</a>:</h4>
<p>jameysharp <a href="https://github.com/bytecodealliance/wasmtime/pull/5535#issuecomment-1372891301">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/5535">issue #5535</a>:</p>
<blockquote>
<blockquote>
<p>That certainly could work, but it is significantly more code because of the component model's composite and parameterized types.</p>
</blockquote>
<p>Huh, I don't see why. I'm suggesting putting back the <code>derive(PartialEq)</code> for <code>Val</code>, and then writing something like this:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="k">impl</span><span class="w"> </span><span class="n">Val</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="k">fn</span> <span class="nf">funny_eq</span><span class="p">(</span><span class="o">&amp;</span><span class="bp">self</span><span class="p">,</span><span class="w"> </span><span class="n">other</span>: <span class="kp">&amp;</span><span class="nc">Val</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="kt">bool</span> <span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="k">match</span><span class="w"> </span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="w"> </span><span class="n">other</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">            </span><span class="c1">// This breaks conformance with IEEE-754 equality to simplify testing logic.</span>
<span class="w">            </span><span class="p">(</span><span class="bp">Self</span>::<span class="n">Float32</span><span class="p">(</span><span class="n">l</span><span class="p">),</span><span class="w"> </span><span class="bp">Self</span>::<span class="n">Float32</span><span class="p">(</span><span class="n">r</span><span class="p">))</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="n">l</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">r</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="p">(</span><span class="n">l</span><span class="p">.</span><span class="n">is_nan</span><span class="p">()</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">r</span><span class="p">.</span><span class="n">is_nan</span><span class="p">()),</span><span class="w"></span>
<span class="w">            </span><span class="p">(</span><span class="bp">Self</span>::<span class="n">Float64</span><span class="p">(</span><span class="n">l</span><span class="p">),</span><span class="w"> </span><span class="bp">Self</span>::<span class="n">Float64</span><span class="p">(</span><span class="n">r</span><span class="p">))</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="n">l</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">r</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="p">(</span><span class="n">l</span><span class="p">.</span><span class="n">is_nan</span><span class="p">()</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">r</span><span class="p">.</span><span class="n">is_nan</span><span class="p">()),</span><span class="w"></span>
<span class="w">            </span><span class="n">_</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="bp">self</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">other</span><span class="p">,</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>
<p>Or, if it's only intended to be used in one place, just put this match there.</p>
</blockquote>



<a name="319687320"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%235535%20Treat%20%60wasmtime%3A%3Acomponent%3A%3AVal%3A%3AF.../near/319687320" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.235535.20Treat.20.60wasmtime.3A.3Acomponent.3A.3AVal.3A.3AF.2E.2E.2E.html#319687320">(Jan 05 2023 at 22:51)</a>:</h4>
<p>jameysharp <a href="https://github.com/bytecodealliance/wasmtime/pull/5535#issuecomment-1372892895">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/5535">issue #5535</a>:</p>
<blockquote>
<p>I saw why immediately after I posted that comment. I forgot the derived implementations wouldn't be calling this. I take it all back!</p>
<p>So this PR seems about as good as it can be, except I'd still propose the second pattern I mentioned to ensure that the compiler will catch the error if new variants are added to <code>Val</code> without updating the implementation of <code>PartialEq</code>.</p>
</blockquote>



<a name="319788498"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%235535%20Treat%20%60wasmtime%3A%3Acomponent%3A%3AVal%3A%3AF.../near/319788498" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.235535.20Treat.20.60wasmtime.3A.3Acomponent.3A.3AVal.3A.3AF.2E.2E.2E.html#319788498">(Jan 06 2023 at 14:11)</a>:</h4>
<p>lann <a href="https://github.com/bytecodealliance/wasmtime/pull/5535#issuecomment-1373694413">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/5535">issue #5535</a>:</p>
<blockquote>
<blockquote>
<p>Another way to avoid bugs is to have two cases for each variant, like the implementation of <a href="https://github.com/bytecodealliance/wasmtime/blob/32a7593/cranelift/codegen/src/data_value.rs#L31-L65">PartialEq for DataValue</a>.</p>
</blockquote>
<p>Done.</p>
</blockquote>



<a name="319798016"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%235535%20Treat%20%60wasmtime%3A%3Acomponent%3A%3AVal%3A%3AF.../near/319798016" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.235535.20Treat.20.60wasmtime.3A.3Acomponent.3A.3AVal.3A.3AF.2E.2E.2E.html#319798016">(Jan 06 2023 at 14:59)</a>:</h4>
<p>sunfishcode <a href="https://github.com/bytecodealliance/wasmtime/pull/5535#issuecomment-1373739278">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/5535">issue #5535</a>:</p>
<blockquote>
<p>I don't have full context here, but I wanted to make sure it's considered that floating-point equality considers <code>-0</code> and <code>0</code> to be equal, while most testing and fuzzing use cases should treat them as inequal.</p>
</blockquote>



<a name="319798743"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%235535%20Treat%20%60wasmtime%3A%3Acomponent%3A%3AVal%3A%3AF.../near/319798743" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.235535.20Treat.20.60wasmtime.3A.3Acomponent.3A.3AVal.3A.3AF.2E.2E.2E.html#319798743">(Jan 06 2023 at 15:01)</a>:</h4>
<p>lann <a href="https://github.com/bytecodealliance/wasmtime/pull/5535#issuecomment-1373742546">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/5535">issue #5535</a>:</p>
<blockquote>
<blockquote>
<p>I don't have full context here, but I wanted to make sure it's considered that floating-point equality considers <code>-0</code> and <code>0</code> to be equal, while most testing and fuzzing use cases should treat them as inequal.</p>
</blockquote>
<p>I _think_ the issue is just NaN inequality, but I don't entirely understand <a href="https://github.com/bytecodealliance/wasmtime/blob/36e5bdfd0ec207bbfb1da79725ac37c7cbc331d0/crates/fuzzing/src/oracles.rs#L829">the fuzzing code in question</a>.</p>
</blockquote>



<a name="319817248"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%235535%20Treat%20%60wasmtime%3A%3Acomponent%3A%3AVal%3A%3AF.../near/319817248" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.235535.20Treat.20.60wasmtime.3A.3Acomponent.3A.3AVal.3A.3AF.2E.2E.2E.html#319817248">(Jan 06 2023 at 16:40)</a>:</h4>
<p>alexcrichton <a href="https://github.com/bytecodealliance/wasmtime/pull/5535#issuecomment-1373876965">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/5535">issue #5535</a>:</p>
<blockquote>
<p>I'm going to go ahead and merge this since it fixes the fuzz issues that have cropped up, but I think it'd be reasonable to have a follow-up for +/- 0 handling as well.</p>
</blockquote>



<hr><p>Last updated: Jan 20 2025 at 06:04 UTC</p>
</html>