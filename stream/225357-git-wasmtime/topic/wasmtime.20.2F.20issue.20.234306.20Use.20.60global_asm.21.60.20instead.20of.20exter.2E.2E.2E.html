<html>
<head><meta charset="utf-8"><title>wasmtime / issue #4306 Use `global_asm!` instead of exter... · git-wasmtime · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/index.html">git-wasmtime</a></h2>
<h3>Topic: <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.234306.20Use.20.60global_asm.21.60.20instead.20of.20exter.2E.2E.2E.html">wasmtime / issue #4306 Use `global_asm!` instead of exter...</a></h3>

<hr>

<base href="https://bytecodealliance.zulipchat.com">

<head><link href="https://bytecodealliance.github.io/zulip-archive/style.css" rel="stylesheet"></head>

<a name="287258733"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%234306%20Use%20%60global_asm%21%60%20instead%20of%20exter.../near/287258733" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.234306.20Use.20.60global_asm.21.60.20instead.20of.20exter.2E.2E.2E.html#287258733">(Jun 23 2022 at 21:08)</a>:</h4>
<p>alexcrichton <a href="https://github.com/bytecodealliance/wasmtime/pull/4306#issuecomment-1164875082">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/4306">issue #4306</a>:</p>
<blockquote>
<p>I just went down a _really_ long rabbit hole to justify the addition of <a href="https://github.com/bytecodealliance/wasmtime/pull/4306/commits/6a02949a246558d9a4169b7c7e2d06da729ef27e">https://github.com/bytecodealliance/wasmtime/pull/4306/commits/6a02949a246558d9a4169b7c7e2d06da729ef27e</a> here, namely adding <code>.cfi_def_cfa_offset 0</code> to all the <code>wasmtime_fiber_start</code> functions. Long story short this assembly file:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="n">my_function</span>:
        <span class="p">.</span><span class="n">cfi_startproc</span><span class="w"> </span><span class="n">simple</span><span class="w"></span>
<span class="w">        </span><span class="p">.</span><span class="n">cfi_rel_offset</span><span class="w"> </span><span class="n">w29</span><span class="p">,</span><span class="w"> </span><span class="o">-</span><span class="mi">16</span><span class="w"></span>
<span class="w">        </span><span class="n">ret</span><span class="w"></span>
<span class="w">        </span><span class="p">.</span><span class="n">cfi_endproc</span><span class="w"></span>

<span class="n">foo</span>:
        <span class="p">.</span><span class="n">cfi_startproc</span><span class="w"></span>
<span class="w">        </span><span class="p">.</span><span class="n">cfi_def_cfa_offset</span><span class="w"> </span><span class="mi">16</span><span class="w"></span>
<span class="w">        </span><span class="n">ret</span><span class="w"></span>
<span class="w">        </span><span class="p">.</span><span class="n">cfi_endproc</span><span class="w"></span>
</code></pre></div>
<p>is a massive simplification of the <code>wasmtime_fiber</code> crate. The <code>my_function</code> here is equivalent to <code>wasmtime_fiber_start</code>. When compiling this with clang and looking at the unwind tables though:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="cp">$</span><span class="w"> </span><span class="n">clang</span><span class="w"> </span><span class="o">-</span><span class="n">c</span><span class="w"> </span><span class="n">bad</span><span class="p">.</span><span class="n">s</span><span class="w"> </span><span class="o">-</span><span class="n">o</span><span class="w"> </span><span class="n">bad</span><span class="p">.</span><span class="n">o2</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">objdump</span><span class="w"> </span><span class="o">-</span><span class="n">W</span><span class="w"> </span><span class="n">bad</span><span class="p">.</span><span class="n">o2</span><span class="w"></span>
<span class="o">..</span><span class="p">.</span><span class="w"></span>
<span class="mi">0000003</span><span class="n">c</span><span class="w"> </span><span class="mi">0000000000000010</span><span class="w"> </span><span class="mi">00000018</span><span class="w"> </span><span class="n">FDE</span><span class="w"> </span><span class="n">cie</span><span class="o">=</span><span class="mi">00000028</span><span class="w"> </span><span class="n">pc</span><span class="o">=</span><span class="mi">0000000000000000</span><span class="o">..</span><span class="mi">0000000000000004</span><span class="w"></span>
<span class="w">  </span><span class="n">DW_CFA_offset</span>: <span class="nc">r29</span><span class="w"> </span><span class="p">(</span><span class="n">x29</span><span class="p">)</span><span class="w"> </span><span class="n">at</span><span class="w"> </span><span class="n">cfa</span><span class="o">-</span><span class="mi">32</span><span class="w"></span>
<span class="w">  </span><span class="n">DW_CFA_nop</span><span class="w"></span>
</code></pre></div>
<p>Here the <code>cfa-32</code> is unexpected, that's supposed to be <code>-16</code>. This appears to be affected by the <code>.cfi_def_cfa_offset 16</code> directive in the <code>foo</code> function. The reason this only showed up on CI is because oddly enough the bug only arose when incremental compliation was turned off. This shuffled around CGUs such that the global asm bits added here ended up getting shoved into a CGU with another function, which internally in LLVM had this <code>.cfi_def_cfa_offset</code> directive. </p>
<p>Overall I don't know why there's this "global state" here or what this offset is. I suppose the word "global" in "global_asm" should have tipped me off. Anyway my hope here was that with the addition of <code>.cfi_def_cfa_offset 0</code> directives we can work around this to "reset" the directive at the start of the function. Afterwards things appear to work.</p>
<p>This is probably a bug in LLVM though. The same assembly file above going through gcc yields:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="cp">$</span><span class="w"> </span><span class="n">gcc</span><span class="w"> </span><span class="o">-</span><span class="n">c</span><span class="w"> </span><span class="n">bad</span><span class="p">.</span><span class="n">s</span><span class="w"> </span><span class="o">-</span><span class="n">o</span><span class="w"> </span><span class="n">bad</span><span class="p">.</span><span class="n">o2</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">objdump</span><span class="w"> </span><span class="o">-</span><span class="n">W</span><span class="w"> </span><span class="n">bad</span><span class="p">.</span><span class="n">o2</span><span class="w"></span>

<span class="n">bad</span><span class="p">.</span><span class="n">o2</span>:     <span class="nc">file</span><span class="w"> </span><span class="n">format</span><span class="w"> </span><span class="n">elf64</span><span class="o">-</span><span class="n">littleaarch64</span><span class="w"></span>

<span class="n">Contents</span><span class="w"> </span><span class="n">of</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="p">.</span><span class="n">eh_frame</span><span class="w"> </span><span class="n">section</span>:


<span class="mi">00000000</span><span class="w"> </span><span class="mi">0000000000000010</span><span class="w"> </span><span class="mi">00000000</span><span class="w"> </span><span class="n">CIE</span><span class="w"></span>
<span class="w">  </span><span class="n">Version</span>:               <span class="mi">1</span><span class="w"></span>
<span class="w">  </span><span class="n">Augmentation</span>:          <span class="s">"zR"</span><span class="w"></span>
<span class="w">  </span><span class="n">Code</span><span class="w"> </span><span class="n">alignment</span><span class="w"> </span><span class="n">factor</span>: <span class="mi">4</span><span class="w"></span>
<span class="w">  </span><span class="n">Data</span><span class="w"> </span><span class="n">alignment</span><span class="w"> </span><span class="n">factor</span>: <span class="o">-</span><span class="mi">8</span><span class="w"></span>
<span class="w">  </span><span class="n">Return</span><span class="w"> </span><span class="n">address</span><span class="w"> </span><span class="n">column</span>: <span class="mi">30</span><span class="w"></span>
<span class="w">  </span><span class="n">Augmentation</span><span class="w"> </span><span class="n">data</span>:     <span class="mi">1</span><span class="n">b</span><span class="w"></span>
<span class="w">  </span><span class="n">DW_CFA_offset</span>: <span class="nc">r29</span><span class="w"> </span><span class="p">(</span><span class="n">x29</span><span class="p">)</span><span class="w"> </span><span class="n">at</span><span class="w"> </span><span class="n">cfa</span><span class="o">-</span><span class="mi">16</span><span class="w"></span>
<span class="w">  </span><span class="n">DW_CFA_nop</span><span class="w"></span>

<span class="mi">00000014</span><span class="w"> </span><span class="mi">0000000000000010</span><span class="w"> </span><span class="mi">00000018</span><span class="w"> </span><span class="n">FDE</span><span class="w"> </span><span class="n">cie</span><span class="o">=</span><span class="mi">00000000</span><span class="w"> </span><span class="n">pc</span><span class="o">=</span><span class="mi">0000000000000000</span><span class="o">..</span><span class="mi">0000000000000004</span><span class="w"></span>
<span class="w">  </span><span class="n">DW_CFA_nop</span><span class="w"></span>
<span class="w">  </span><span class="n">DW_CFA_nop</span><span class="w"></span>
<span class="w">  </span><span class="n">DW_CFA_nop</span><span class="w"></span>

<span class="o">..</span><span class="p">.</span><span class="w"></span>
</code></pre></div>
<p>Here it looks like gcc folded the FDE entry directly into the CIE because only one FDE references the CIE (I guess? unsure?). In any case the <code>cfa-16</code> is what we want, unlike the <code>cfa-32</code> which is what clang produces. I don't really have the energy though to file an issue on LLVM at this time though.</p>
</blockquote>



<a name="287650707"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%234306%20Use%20%60global_asm%21%60%20instead%20of%20exter.../near/287650707" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.234306.20Use.20.60global_asm.21.60.20instead.20of.20exter.2E.2E.2E.html#287650707">(Jun 27 2022 at 23:14)</a>:</h4>
<p>cfallin <a href="https://github.com/bytecodealliance/wasmtime/pull/4306#issuecomment-1168024353">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/4306">issue #4306</a>:</p>
<blockquote>
<p>This unfortunately seems to have broken compilation on macOS/aarch64 with latest stable Rust (1.61.0):</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="w">   </span><span class="n">Compiling</span><span class="w"> </span><span class="n">num</span><span class="o">-</span><span class="n">rational</span><span class="w"> </span><span class="n">v0</span><span class="p">.</span><span class="mf">2.4</span><span class="w"></span>
<span class="w">   </span><span class="n">Compiling</span><span class="w"> </span><span class="n">wasmtime</span><span class="o">-</span><span class="n">fiber</span><span class="w"> </span><span class="n">v0</span><span class="p">.</span><span class="mf">39.0</span><span class="w"> </span><span class="p">(</span><span class="o">/</span><span class="n">Users</span><span class="o">/</span><span class="n">cfallin</span><span class="o">/</span><span class="n">work</span><span class="o">/</span><span class="n">wasmtime2</span><span class="o">/</span><span class="n">crates</span><span class="o">/</span><span class="n">fiber</span><span class="p">)</span><span class="w"></span>
<span class="w">   </span><span class="n">Compiling</span><span class="w"> </span><span class="n">proptest</span><span class="w"> </span><span class="n">v1</span><span class="p">.</span><span class="mf">0.0</span><span class="w"></span>
<span class="w">   </span><span class="n">Compiling</span><span class="w"> </span><span class="n">egg</span><span class="w"> </span><span class="n">v0</span><span class="p">.</span><span class="mf">6.0</span><span class="w"></span>
<span class="w">   </span><span class="n">Compiling</span><span class="w"> </span><span class="n">capstone</span><span class="o">-</span><span class="n">sys</span><span class="w"> </span><span class="n">v0</span><span class="p">.</span><span class="mf">13.0</span><span class="w"></span>
<span class="w">   </span><span class="n">Compiling</span><span class="w"> </span><span class="n">shuffling</span><span class="o">-</span><span class="n">allocator</span><span class="w"> </span><span class="n">v1</span><span class="p">.</span><span class="mf">1.2</span><span class="w"></span>
<span class="w">   </span><span class="n">Compiling</span><span class="w"> </span><span class="n">cranelift</span><span class="o">-</span><span class="n">bforest</span><span class="w"> </span><span class="n">v0</span><span class="p">.</span><span class="mf">86.0</span><span class="w"> </span><span class="p">(</span><span class="o">/</span><span class="n">Users</span><span class="o">/</span><span class="n">cfallin</span><span class="o">/</span><span class="n">work</span><span class="o">/</span><span class="n">wasmtime2</span><span class="o">/</span><span class="n">cranelift</span><span class="o">/</span><span class="n">bforest</span><span class="p">)</span><span class="w"></span>
<span class="w">   </span><span class="n">Compiling</span><span class="w"> </span><span class="n">unicode</span><span class="o">-</span><span class="n">linebreak</span><span class="w"> </span><span class="n">v0</span><span class="p">.</span><span class="mf">1.2</span><span class="w"></span>
<span class="n">error</span>: <span class="nc">macro</span><span class="w"> </span><span class="n">expansion</span><span class="w"> </span><span class="n">ends</span><span class="w"> </span><span class="n">with</span><span class="w"> </span><span class="n">an</span><span class="w"> </span><span class="n">incomplete</span><span class="w"> </span><span class="n">expression</span>: <span class="nc">expected</span><span class="w"> </span><span class="n">expression</span><span class="w"></span>
<span class="w">  </span><span class="o">-</span>-&gt; <span class="nc">crates</span><span class="o">/</span><span class="n">fiber</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">unix</span><span class="o">/</span><span class="n">aarch64</span><span class="p">.</span><span class="n">rs</span>:<span class="mi">41</span>:<span class="mi">5</span><span class="w"></span>
<span class="w">   </span><span class="o">|</span><span class="w"></span>
<span class="mi">25</span><span class="w"> </span><span class="o">|</span><span class="w">         </span><span class="fm">macro_rules!</span><span class="w"> </span><span class="n">paciasp</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="p">();</span><span class="w"> </span><span class="p">}</span><span class="w"></span>
<span class="w">   </span><span class="o">|</span><span class="w">                                      </span><span class="o">--</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="n">this</span><span class="w"> </span><span class="kr">macro</span><span class="w"> </span><span class="n">arm</span><span class="w"></span>
<span class="o">..</span><span class="p">.</span><span class="w"></span>
<span class="mi">41</span><span class="w"> </span><span class="o">|</span><span class="w">     </span><span class="n">paciasp</span><span class="o">!</span><span class="p">(),</span><span class="w"></span>
<span class="w">   </span><span class="o">|</span><span class="w">     </span><span class="o">^^^^^^^^^^</span><span class="w"> </span><span class="n">expected</span><span class="w"> </span><span class="n">expression</span><span class="w"></span>
<span class="w">   </span><span class="o">|</span><span class="w"></span>
<span class="w">   </span><span class="o">=</span><span class="w"> </span><span class="n">note</span>: <span class="nc">the</span><span class="w"> </span><span class="kr">macro</span><span class="w"> </span><span class="n">call</span><span class="w"> </span><span class="n">doesn</span><span class="o">'</span><span class="na">t</span><span class="w"> </span><span class="n">expand</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">an</span><span class="w"> </span><span class="n">expression</span><span class="p">,</span><span class="w"> </span><span class="n">but</span><span class="w"> </span><span class="n">it</span><span class="w"> </span><span class="n">can</span><span class="w"> </span><span class="n">expand</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="n">statement</span><span class="w"></span>
<span class="n">help</span>: <span class="nc">add</span><span class="w"> </span><span class="err">`</span><span class="p">;</span><span class="err">`</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">interpret</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">expansion</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="n">statement</span><span class="w"></span>
<span class="w">   </span><span class="o">|</span><span class="w"></span>
<span class="mi">41</span><span class="w"> </span><span class="o">|</span><span class="w">     </span><span class="n">paciasp</span><span class="o">!</span><span class="p">();,</span><span class="w"></span>
<span class="w">   </span><span class="o">|</span><span class="w">               </span><span class="o">+</span><span class="w"></span>

<span class="n">error</span>: <span class="nc">macro</span><span class="w"> </span><span class="n">expansion</span><span class="w"> </span><span class="n">ends</span><span class="w"> </span><span class="n">with</span><span class="w"> </span><span class="n">an</span><span class="w"> </span><span class="n">incomplete</span><span class="w"> </span><span class="n">expression</span>: <span class="nc">expected</span><span class="w"> </span><span class="n">expression</span><span class="w"></span>
<span class="w">  </span><span class="o">-</span>-&gt; <span class="nc">crates</span><span class="o">/</span><span class="n">fiber</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">unix</span><span class="o">/</span><span class="n">aarch64</span><span class="p">.</span><span class="n">rs</span>:<span class="mi">42</span>:<span class="mi">5</span><span class="w"></span>
<span class="w">   </span><span class="o">|</span><span class="w"></span>
<span class="mi">23</span><span class="w"> </span><span class="o">|</span><span class="w">         </span><span class="fm">macro_rules!</span><span class="w"> </span><span class="n">cfi_window_save</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="p">();</span><span class="w"> </span><span class="p">}</span><span class="w"></span>
<span class="w">   </span><span class="o">|</span><span class="w">                                              </span><span class="o">--</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="n">this</span><span class="w"> </span><span class="kr">macro</span><span class="w"> </span><span class="n">arm</span><span class="w"></span>
<span class="o">..</span><span class="p">.</span><span class="w"></span>
<span class="mi">42</span><span class="w"> </span><span class="o">|</span><span class="w">     </span><span class="n">cfi_window_save</span><span class="o">!</span><span class="p">(),</span><span class="w"></span>
<span class="w">   </span><span class="o">|</span><span class="w">     </span><span class="o">^^^^^^^^^^^^^^^^^^</span><span class="w"> </span><span class="n">expected</span><span class="w"> </span><span class="n">expression</span><span class="w"></span>
<span class="w">   </span><span class="o">|</span><span class="w"></span>
<span class="w">   </span><span class="o">=</span><span class="w"> </span><span class="n">note</span>: <span class="nc">the</span><span class="w"> </span><span class="kr">macro</span><span class="w"> </span><span class="n">call</span><span class="w"> </span><span class="n">doesn</span><span class="o">'</span><span class="na">t</span><span class="w"> </span><span class="n">expand</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">an</span><span class="w"> </span><span class="n">expression</span><span class="p">,</span><span class="w"> </span><span class="n">but</span><span class="w"> </span><span class="n">it</span><span class="w"> </span><span class="n">can</span><span class="w"> </span><span class="n">expand</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="n">statement</span><span class="w"></span>
<span class="n">help</span>: <span class="nc">add</span><span class="w"> </span><span class="err">`</span><span class="p">;</span><span class="err">`</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">interpret</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">expansion</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="n">statement</span><span class="w"></span>
<span class="w">   </span><span class="o">|</span><span class="w"></span>
<span class="mi">42</span><span class="w"> </span><span class="o">|</span><span class="w">     </span><span class="n">cfi_window_save</span><span class="o">!</span><span class="p">();,</span><span class="w"></span>
<span class="w">   </span><span class="o">|</span><span class="w">                       </span><span class="o">+</span><span class="w"></span>

<span class="n">error</span>: <span class="nc">macro</span><span class="w"> </span><span class="n">expansion</span><span class="w"> </span><span class="n">ends</span><span class="w"> </span><span class="n">with</span><span class="w"> </span><span class="n">an</span><span class="w"> </span><span class="n">incomplete</span><span class="w"> </span><span class="n">expression</span>: <span class="nc">expected</span><span class="w"> </span><span class="n">expression</span><span class="w"></span>
<span class="w">  </span><span class="o">-</span>-&gt; <span class="nc">crates</span><span class="o">/</span><span class="n">fiber</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">unix</span><span class="o">/</span><span class="n">aarch64</span><span class="p">.</span><span class="n">rs</span>:<span class="mi">78</span>:<span class="mi">5</span><span class="w"></span>
<span class="w">   </span><span class="o">|</span><span class="w"></span>
<span class="mi">26</span><span class="w"> </span><span class="o">|</span><span class="w">         </span><span class="fm">macro_rules!</span><span class="w"> </span><span class="n">autiasp</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="p">();</span><span class="w"> </span><span class="p">}</span><span class="w"></span>
<span class="w">   </span><span class="o">|</span><span class="w">                                      </span><span class="o">--</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="n">this</span><span class="w"> </span><span class="kr">macro</span><span class="w"> </span><span class="n">arm</span><span class="w"></span>
<span class="o">..</span><span class="p">.</span><span class="w"></span>
<span class="mi">78</span><span class="w"> </span><span class="o">|</span><span class="w">     </span><span class="n">autiasp</span><span class="o">!</span><span class="p">(),</span><span class="w"></span>
<span class="w">   </span><span class="o">|</span><span class="w">     </span><span class="o">^^^^^^^^^^</span><span class="w"> </span><span class="n">expected</span><span class="w"> </span><span class="n">expression</span><span class="w"></span>
<span class="w">   </span><span class="o">|</span><span class="w"></span>
<span class="w">   </span><span class="o">=</span><span class="w"> </span><span class="n">note</span>: <span class="nc">the</span><span class="w"> </span><span class="kr">macro</span><span class="w"> </span><span class="n">call</span><span class="w"> </span><span class="n">doesn</span><span class="o">'</span><span class="na">t</span><span class="w"> </span><span class="n">expand</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">an</span><span class="w"> </span><span class="n">expression</span><span class="p">,</span><span class="w"> </span><span class="n">but</span><span class="w"> </span><span class="n">it</span><span class="w"> </span><span class="n">can</span><span class="w"> </span><span class="n">expand</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="n">statement</span><span class="w"></span>
<span class="n">help</span>: <span class="nc">add</span><span class="w"> </span><span class="err">`</span><span class="p">;</span><span class="err">`</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">interpret</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">expansion</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="n">statement</span><span class="w"></span>
<span class="w">   </span><span class="o">|</span><span class="w"></span>
<span class="mi">78</span><span class="w"> </span><span class="o">|</span><span class="w">     </span><span class="n">autiasp</span><span class="o">!</span><span class="p">();,</span><span class="w"></span>
<span class="w">   </span><span class="o">|</span><span class="w">               </span><span class="o">+</span><span class="w"></span>

<span class="n">error</span>: <span class="nc">macro</span><span class="w"> </span><span class="n">expansion</span><span class="w"> </span><span class="n">ends</span><span class="w"> </span><span class="n">with</span><span class="w"> </span><span class="n">an</span><span class="w"> </span><span class="n">incomplete</span><span class="w"> </span><span class="n">expression</span>: <span class="nc">expected</span><span class="w"> </span><span class="n">expression</span><span class="w"></span>
<span class="w">  </span><span class="o">-</span>-&gt; <span class="nc">crates</span><span class="o">/</span><span class="n">fiber</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">unix</span><span class="o">/</span><span class="n">aarch64</span><span class="p">.</span><span class="n">rs</span>:<span class="mi">79</span>:<span class="mi">5</span><span class="w"></span>
<span class="w">   </span><span class="o">|</span><span class="w"></span>
<span class="mi">23</span><span class="w"> </span><span class="o">|</span><span class="w">         </span><span class="fm">macro_rules!</span><span class="w"> </span><span class="n">cfi_window_save</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="p">();</span><span class="w"> </span><span class="p">}</span><span class="w"></span>
<span class="w">   </span><span class="o">|</span><span class="w">                                              </span><span class="o">--</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="n">this</span><span class="w"> </span><span class="kr">macro</span><span class="w"> </span><span class="n">arm</span><span class="w"></span>
<span class="o">..</span><span class="p">.</span><span class="w"></span>
<span class="mi">79</span><span class="w"> </span><span class="o">|</span><span class="w">     </span><span class="n">cfi_window_save</span><span class="o">!</span><span class="p">(),</span><span class="w"></span>
<span class="w">   </span><span class="o">|</span><span class="w">     </span><span class="o">^^^^^^^^^^^^^^^^^^</span><span class="w"> </span><span class="n">expected</span><span class="w"> </span><span class="n">expression</span><span class="w"></span>
<span class="w">   </span><span class="o">|</span><span class="w"></span>
<span class="w">   </span><span class="o">=</span><span class="w"> </span><span class="n">note</span>: <span class="nc">the</span><span class="w"> </span><span class="kr">macro</span><span class="w"> </span><span class="n">call</span><span class="w"> </span><span class="n">doesn</span><span class="o">'</span><span class="na">t</span><span class="w"> </span><span class="n">expand</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">an</span><span class="w"> </span><span class="n">expression</span><span class="p">,</span><span class="w"> </span><span class="n">but</span><span class="w"> </span><span class="n">it</span><span class="w"> </span><span class="n">can</span><span class="w"> </span><span class="n">expand</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="n">statement</span><span class="w"></span>
<span class="n">help</span>: <span class="nc">add</span><span class="w"> </span><span class="err">`</span><span class="p">;</span><span class="err">`</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">interpret</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">expansion</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="n">statement</span><span class="w"></span>
<span class="w">   </span><span class="o">|</span><span class="w"></span>
<span class="mi">79</span><span class="w"> </span><span class="o">|</span><span class="w">     </span><span class="n">cfi_window_save</span><span class="o">!</span><span class="p">();,</span><span class="w"></span>
<span class="w">   </span><span class="o">|</span><span class="w">                       </span><span class="o">+</span><span class="w"></span>

<span class="n">error</span>: <span class="nc">macro</span><span class="w"> </span><span class="n">expansion</span><span class="w"> </span><span class="n">ends</span><span class="w"> </span><span class="n">with</span><span class="w"> </span><span class="n">an</span><span class="w"> </span><span class="n">incomplete</span><span class="w"> </span><span class="n">expression</span>: <span class="nc">expected</span><span class="w"> </span><span class="n">expression</span><span class="w"></span>
<span class="w">   </span><span class="o">-</span>-&gt; <span class="nc">crates</span><span class="o">/</span><span class="n">fiber</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">unix</span><span class="o">/</span><span class="n">aarch64</span><span class="p">.</span><span class="n">rs</span>:<span class="mi">117</span>:<span class="mi">5</span><span class="w"></span>
<span class="w">    </span><span class="o">|</span><span class="w"></span>
<span class="mi">24</span><span class="w">  </span><span class="o">|</span><span class="w">         </span><span class="fm">macro_rules!</span><span class="w"> </span><span class="n">pacia1716</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="p">();</span><span class="w"> </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="o">|</span><span class="w">                                        </span><span class="o">--</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="n">this</span><span class="w"> </span><span class="kr">macro</span><span class="w"> </span><span class="n">arm</span><span class="w"></span>
<span class="o">..</span><span class="p">.</span><span class="w"></span>
<span class="mi">117</span><span class="w"> </span><span class="o">|</span><span class="w">     </span><span class="n">pacia1716</span><span class="o">!</span><span class="p">(),</span><span class="w"></span>
<span class="w">    </span><span class="o">|</span><span class="w">     </span><span class="o">^^^^^^^^^^^^</span><span class="w"> </span><span class="n">expected</span><span class="w"> </span><span class="n">expression</span><span class="w"></span>
<span class="w">    </span><span class="o">|</span><span class="w"></span>
<span class="w">    </span><span class="o">=</span><span class="w"> </span><span class="n">note</span>: <span class="nc">the</span><span class="w"> </span><span class="kr">macro</span><span class="w"> </span><span class="n">call</span><span class="w"> </span><span class="n">doesn</span><span class="o">'</span><span class="na">t</span><span class="w"> </span><span class="n">expand</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">an</span><span class="w"> </span><span class="n">expression</span><span class="p">,</span><span class="w"> </span><span class="n">but</span><span class="w"> </span><span class="n">it</span><span class="w"> </span><span class="n">can</span><span class="w"> </span><span class="n">expand</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="n">statement</span><span class="w"></span>
<span class="n">help</span>: <span class="nc">add</span><span class="w"> </span><span class="err">`</span><span class="p">;</span><span class="err">`</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">interpret</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">expansion</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="n">statement</span><span class="w"></span>
<span class="w">    </span><span class="o">|</span><span class="w"></span>
<span class="mi">117</span><span class="w"> </span><span class="o">|</span><span class="w">     </span><span class="n">pacia1716</span><span class="o">!</span><span class="p">();,</span><span class="w"></span>
<span class="w">    </span><span class="o">|</span><span class="w">                 </span><span class="o">+</span><span class="w"></span>

<span class="n">error</span>: <span class="nc">macro</span><span class="w"> </span><span class="n">expansion</span><span class="w"> </span><span class="n">ends</span><span class="w"> </span><span class="n">with</span><span class="w"> </span><span class="n">an</span><span class="w"> </span><span class="n">incomplete</span><span class="w"> </span><span class="n">expression</span>: <span class="nc">expected</span><span class="w"> </span><span class="n">expression</span><span class="w"></span>
<span class="w">   </span><span class="o">-</span>-&gt; <span class="nc">crates</span><span class="o">/</span><span class="n">fiber</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">unix</span><span class="o">/</span><span class="n">aarch64</span><span class="p">.</span><span class="n">rs</span>:<span class="mi">148</span>:<span class="mi">5</span><span class="w"></span>
<span class="w">    </span><span class="o">|</span><span class="w"></span>
<span class="mi">23</span><span class="w">  </span><span class="o">|</span><span class="w">         </span><span class="fm">macro_rules!</span><span class="w"> </span><span class="n">cfi_window_save</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="p">();</span><span class="w"> </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="o">|</span><span class="w">                                              </span><span class="o">--</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="n">this</span><span class="w"> </span><span class="kr">macro</span><span class="w"> </span><span class="n">arm</span><span class="w"></span>
<span class="o">..</span><span class="p">.</span><span class="w"></span>
<span class="mi">148</span><span class="w"> </span><span class="o">|</span><span class="w">     </span><span class="n">cfi_window_save</span><span class="o">!</span><span class="p">(),</span><span class="w"></span>
<span class="w">    </span><span class="o">|</span><span class="w">     </span><span class="o">^^^^^^^^^^^^^^^^^^</span><span class="w"> </span><span class="n">expected</span><span class="w"> </span><span class="n">expression</span><span class="w"></span>
<span class="w">    </span><span class="o">|</span><span class="w"></span>
<span class="w">    </span><span class="o">=</span><span class="w"> </span><span class="n">note</span>: <span class="nc">the</span><span class="w"> </span><span class="kr">macro</span><span class="w"> </span><span class="n">call</span><span class="w"> </span><span class="n">doesn</span><span class="o">'</span><span class="na">t</span><span class="w"> </span><span class="n">expand</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">an</span><span class="w"> </span><span class="n">expression</span><span class="p">,</span><span class="w"> </span><span class="n">but</span><span class="w"> </span><span class="n">it</span><span class="w"> </span><span class="n">can</span><span class="w"> </span><span class="n">expand</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="n">statement</span><span class="w"></span>
<span class="n">help</span>: <span class="nc">add</span><span class="w"> </span><span class="err">`</span><span class="p">;</span><span class="err">`</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">interpret</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">expansion</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="n">statement</span><span class="w"></span>
<span class="w">    </span><span class="o">|</span><span class="w"></span>
<span class="mi">148</span><span class="w"> </span><span class="o">|</span><span class="w">     </span><span class="n">cfi_window_save</span><span class="o">!</span><span class="p">();,</span><span class="w"></span>
<span class="w">    </span><span class="o">|</span><span class="w">                       </span><span class="o">+</span><span class="w"></span>

<span class="n">error</span>: <span class="nc">could</span><span class="w"> </span><span class="n">not</span><span class="w"> </span><span class="n">compile</span><span class="w"> </span><span class="err">`</span><span class="n">wasmtime</span><span class="o">-</span><span class="n">fiber</span><span class="err">`</span><span class="w"> </span><span class="n">due</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="mi">6</span><span class="w"> </span><span class="n">previous</span><span class="w"> </span><span class="n">errors</span><span class="w"></span>
<span class="n">warning</span>: <span class="nc">build</span><span class="w"> </span><span class="n">failed</span><span class="p">,</span><span class="w"> </span><span class="n">waiting</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">other</span><span class="w"> </span><span class="n">jobs</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">finish</span><span class="o">..</span><span class="p">.</span><span class="w"></span>
</code></pre></div>
<p>I haven't dug into this at all but I can play with it more or test changes tomorrow if needed to help...</p>
</blockquote>



<a name="287651291"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%234306%20Use%20%60global_asm%21%60%20instead%20of%20exter.../near/287651291" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.234306.20Use.20.60global_asm.21.60.20instead.20of.20exter.2E.2E.2E.html#287651291">(Jun 27 2022 at 23:20)</a>:</h4>
<p>cfallin <a href="https://github.com/bytecodealliance/wasmtime/pull/4306#issuecomment-1168028439">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/4306">issue #4306</a>:</p>
<blockquote>
<p>(N.B.: all errors from <code>./ci/run-tests.sh</code>; just <code>cargo build</code> for wasmtime-cli works fine still, I guess because it's not async?)</p>
<p>The following patch seems to push it further:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="n">diff</span><span class="w"> </span><span class="o">--</span><span class="n">git</span><span class="w"> </span><span class="n">a</span><span class="o">/</span><span class="n">crates</span><span class="o">/</span><span class="n">fiber</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">unix</span><span class="o">/</span><span class="n">aarch64</span><span class="p">.</span><span class="n">rs</span><span class="w"> </span><span class="n">b</span><span class="o">/</span><span class="n">crates</span><span class="o">/</span><span class="n">fiber</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">unix</span><span class="o">/</span><span class="n">aarch64</span><span class="p">.</span><span class="n">rs</span><span class="w"></span>
<span class="n">index</span><span class="w"> </span><span class="n">a0b4201b9</span><span class="o">..</span><span class="mi">28</span><span class="n">b257974</span><span class="w"> </span><span class="mi">100644</span><span class="w"></span>
<span class="o">---</span><span class="w"> </span><span class="n">a</span><span class="o">/</span><span class="n">crates</span><span class="o">/</span><span class="n">fiber</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">unix</span><span class="o">/</span><span class="n">aarch64</span><span class="p">.</span><span class="n">rs</span><span class="w"></span>
<span class="o">+++</span><span class="w"> </span><span class="n">b</span><span class="o">/</span><span class="n">crates</span><span class="o">/</span><span class="n">fiber</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">unix</span><span class="o">/</span><span class="n">aarch64</span><span class="p">.</span><span class="n">rs</span><span class="w"></span>
<span class="o">@@</span><span class="w"> </span><span class="o">-</span><span class="mi">20</span><span class="p">,</span><span class="mi">10</span><span class="w"> </span><span class="o">+</span><span class="mi">20</span><span class="p">,</span><span class="mi">10</span><span class="w"> </span><span class="o">@@</span><span class="w"></span>

<span class="w"> </span><span class="n">cfg_if</span>::<span class="n">cfg_if</span><span class="o">!</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">     </span><span class="k">if</span><span class="w"> </span><span class="cp">#[cfg(target_os = </span><span class="s">"macos"</span><span class="cp">)]</span><span class="w"> </span><span class="p">{</span><span class="w"></span>

<span class="o">-</span><span class="w">        </span><span class="fm">macro_rules!</span><span class="w"> </span><span class="n">cfi_window_save</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="p">();</span><span class="w"> </span><span class="p">}</span><span class="w"></span>
<span class="o">-</span><span class="w">        </span><span class="fm">macro_rules!</span><span class="w"> </span><span class="n">pacia1716</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="p">();</span><span class="w"> </span><span class="p">}</span><span class="w"></span>
<span class="o">-</span><span class="w">        </span><span class="fm">macro_rules!</span><span class="w"> </span><span class="n">paciasp</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="p">();</span><span class="w"> </span><span class="p">}</span><span class="w"></span>
<span class="o">-</span><span class="w">        </span><span class="fm">macro_rules!</span><span class="w"> </span><span class="n">autiasp</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="p">();</span><span class="w"> </span><span class="p">}</span><span class="w"></span>
<span class="o">+</span><span class="w">        </span><span class="fm">macro_rules!</span><span class="w"> </span><span class="n">cfi_window_save</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="p">(</span><span class="s">""</span><span class="p">);</span><span class="w"> </span><span class="p">}</span><span class="w"></span>
<span class="o">+</span><span class="w">        </span><span class="fm">macro_rules!</span><span class="w"> </span><span class="n">pacia1716</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="p">(</span><span class="s">""</span><span class="p">);</span><span class="w"> </span><span class="p">}</span><span class="w"></span>
<span class="o">+</span><span class="w">        </span><span class="fm">macro_rules!</span><span class="w"> </span><span class="n">paciasp</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="p">(</span><span class="s">""</span><span class="p">);</span><span class="w"> </span><span class="p">}</span><span class="w"></span>
<span class="o">+</span><span class="w">        </span><span class="fm">macro_rules!</span><span class="w"> </span><span class="n">autiasp</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="p">(</span><span class="s">""</span><span class="p">);</span><span class="w"> </span><span class="p">}</span><span class="w"></span>
<span class="w">     </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">         </span><span class="fm">macro_rules!</span><span class="w"> </span><span class="n">cfi_window_save</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="p">(</span><span class="s">".cfi_window_save</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span><span class="w"> </span><span class="p">}</span><span class="w"></span>
<span class="w">         </span><span class="fm">macro_rules!</span><span class="w"> </span><span class="n">pacia1716</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="p">(</span><span class="s">"pacia1716</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span><span class="w"> </span><span class="p">}</span><span class="w"></span>
</code></pre></div>
<p>unfortunately it then bottoms out at:</p>
<p><div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="n">error</span>: <span class="nc">unknown</span><span class="w"> </span><span class="n">AArch64</span><span class="w"> </span><span class="n">fixup</span><span class="w"> </span><span class="n">kind</span><span class="o">!</span><span class="w"></span>
<span class="w">   </span><span class="o">|</span><span class="w"></span>
<span class="n">note</span>: <span class="nc">instantiated</span><span class="w"> </span><span class="n">into</span><span class="w"> </span><span class="n">assembly</span><span class="w"> </span><span class="n">here</span><span class="w"></span>
<span class="w">  </span><span class="o">-</span>-&gt; <span class="o">&lt;</span><span class="n">inline</span><span class="w"> </span><span class="n">asm</span><span class="o">&gt;</span>:<span class="mi">53</span>:<span class="mi">9</span><span class="w"></span>
<span class="w">   </span><span class="o">|</span><span class="w"></span>
<span class="mi">53</span><span class="w"> </span><span class="o">|</span><span class="w">         </span><span class="n">adr</span><span class="w"> </span><span class="n">x17</span><span class="p">,</span><span class="w"> </span><span class="n">_wasmtime_fiber_start</span><span class="w"></span>
<span class="w">   </span><span class="o">|</span><span class="w"></span>
</code></pre></div><br>
</p>
</blockquote>



<a name="287651789"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%234306%20Use%20%60global_asm%21%60%20instead%20of%20exter.../near/287651789" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.234306.20Use.20.60global_asm.21.60.20instead.20of.20exter.2E.2E.2E.html#287651789">(Jun 27 2022 at 23:26)</a>:</h4>
<p>alexcrichton <a href="https://github.com/bytecodealliance/wasmtime/pull/4306#issuecomment-1168031852">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/4306">issue #4306</a>:</p>
<blockquote>
<p>Oh oops this reminds me that I meant to poke you before I merged this and see if it compiles on your mac and completely forgot. I'll dig in tomorrow but feel free to revert in the meantime.</p>
</blockquote>



<a name="287652565"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%234306%20Use%20%60global_asm%21%60%20instead%20of%20exter.../near/287652565" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.234306.20Use.20.60global_asm.21.60.20instead.20of.20exter.2E.2E.2E.html#287652565">(Jun 27 2022 at 23:35)</a>:</h4>
<p>cfallin <a href="https://github.com/bytecodealliance/wasmtime/pull/4306#issuecomment-1168036828">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/4306">issue #4306</a>:</p>
<blockquote>
<p>No worries, as long as we dig in (I'm happy to help test) I don't think there's a need to revert immediately. Hopefully something simple to fix...</p>
</blockquote>



<a name="287653384"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%234306%20Use%20%60global_asm%21%60%20instead%20of%20exter.../near/287653384" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.234306.20Use.20.60global_asm.21.60.20instead.20of.20exter.2E.2E.2E.html#287653384">(Jun 27 2022 at 23:46)</a>:</h4>
<p>cfallin <a href="https://github.com/bytecodealliance/wasmtime/pull/4306#issuecomment-1168042964">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/4306">issue #4306</a>:</p>
<blockquote>
<p>OK, the following is sufficient to get everything to build and pass tests again (conditionalizing this just for macOS left as exercise for the reader):</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="n">diff</span><span class="w"> </span><span class="o">--</span><span class="n">git</span><span class="w"> </span><span class="n">a</span><span class="o">/</span><span class="n">crates</span><span class="o">/</span><span class="n">fiber</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">unix</span><span class="o">/</span><span class="n">aarch64</span><span class="p">.</span><span class="n">rs</span><span class="w"> </span><span class="n">b</span><span class="o">/</span><span class="n">crates</span><span class="o">/</span><span class="n">fiber</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">unix</span><span class="o">/</span><span class="n">aarch64</span><span class="p">.</span><span class="n">rs</span><span class="w"></span>
<span class="n">index</span><span class="w"> </span><span class="n">a0b4201b9</span><span class="o">..</span><span class="n">f242a0bc1</span><span class="w"> </span><span class="mi">100644</span><span class="w"></span>
<span class="o">---</span><span class="w"> </span><span class="n">a</span><span class="o">/</span><span class="n">crates</span><span class="o">/</span><span class="n">fiber</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">unix</span><span class="o">/</span><span class="n">aarch64</span><span class="p">.</span><span class="n">rs</span><span class="w"></span>
<span class="o">+++</span><span class="w"> </span><span class="n">b</span><span class="o">/</span><span class="n">crates</span><span class="o">/</span><span class="n">fiber</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">unix</span><span class="o">/</span><span class="n">aarch64</span><span class="p">.</span><span class="n">rs</span><span class="w"></span>
<span class="o">@@</span><span class="w"> </span><span class="o">-</span><span class="mi">20</span><span class="p">,</span><span class="mi">10</span><span class="w"> </span><span class="o">+</span><span class="mi">20</span><span class="p">,</span><span class="mi">10</span><span class="w"> </span><span class="o">@@</span><span class="w"></span>

<span class="w"> </span><span class="n">cfg_if</span>::<span class="n">cfg_if</span><span class="o">!</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">     </span><span class="k">if</span><span class="w"> </span><span class="cp">#[cfg(target_os = </span><span class="s">"macos"</span><span class="cp">)]</span><span class="w"> </span><span class="p">{</span><span class="w"></span>

<span class="o">-</span><span class="w">        </span><span class="fm">macro_rules!</span><span class="w"> </span><span class="n">cfi_window_save</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="p">();</span><span class="w"> </span><span class="p">}</span><span class="w"></span>
<span class="o">-</span><span class="w">        </span><span class="fm">macro_rules!</span><span class="w"> </span><span class="n">pacia1716</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="p">();</span><span class="w"> </span><span class="p">}</span><span class="w"></span>
<span class="o">-</span><span class="w">        </span><span class="fm">macro_rules!</span><span class="w"> </span><span class="n">paciasp</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="p">();</span><span class="w"> </span><span class="p">}</span><span class="w"></span>
<span class="o">-</span><span class="w">        </span><span class="fm">macro_rules!</span><span class="w"> </span><span class="n">autiasp</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="p">();</span><span class="w"> </span><span class="p">}</span><span class="w"></span>
<span class="o">+</span><span class="w">        </span><span class="fm">macro_rules!</span><span class="w"> </span><span class="n">cfi_window_save</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="p">(</span><span class="s">""</span><span class="p">);</span><span class="w"> </span><span class="p">}</span><span class="w"></span>
<span class="o">+</span><span class="w">        </span><span class="fm">macro_rules!</span><span class="w"> </span><span class="n">pacia1716</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="p">(</span><span class="s">""</span><span class="p">);</span><span class="w"> </span><span class="p">}</span><span class="w"></span>
<span class="o">+</span><span class="w">        </span><span class="fm">macro_rules!</span><span class="w"> </span><span class="n">paciasp</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="p">(</span><span class="s">""</span><span class="p">);</span><span class="w"> </span><span class="p">}</span><span class="w"></span>
<span class="o">+</span><span class="w">        </span><span class="fm">macro_rules!</span><span class="w"> </span><span class="n">autiasp</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="p">(</span><span class="s">""</span><span class="p">);</span><span class="w"> </span><span class="p">}</span><span class="w"></span>
<span class="w">     </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">         </span><span class="fm">macro_rules!</span><span class="w"> </span><span class="n">cfi_window_save</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="p">(</span><span class="s">".cfi_window_save</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span><span class="w"> </span><span class="p">}</span><span class="w"></span>
<span class="w">         </span><span class="fm">macro_rules!</span><span class="w"> </span><span class="n">pacia1716</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="p">(</span><span class="s">"pacia1716</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span><span class="w"> </span><span class="p">}</span><span class="w"></span>
<span class="o">@@</span><span class="w"> </span><span class="o">-</span><span class="mi">112</span><span class="p">,</span><span class="mi">7</span><span class="w"> </span><span class="o">+</span><span class="mi">112</span><span class="p">,</span><span class="mi">8</span><span class="w"> </span><span class="o">@@</span><span class="w"> </span><span class="n">asm_func</span><span class="o">!</span><span class="p">(</span><span class="w"></span>
<span class="w">         </span><span class="p">.</span><span class="n">cfi_startproc</span><span class="w"></span>
<span class="w">         </span><span class="n">hint</span><span class="w"> </span>#<span class="mi">34</span><span class="w"> </span><span class="c1">// bti c</span>
<span class="w">         </span><span class="n">sub</span><span class="w"> </span><span class="n">x16</span><span class="p">,</span><span class="w"> </span><span class="n">x0</span><span class="p">,</span><span class="w"> </span>#<span class="mi">16</span><span class="w"></span>

<span class="o">-</span><span class="w">        </span><span class="n">adr</span><span class="w"> </span><span class="n">x17</span><span class="p">,</span><span class="w"> </span><span class="s">", asm_sym!("</span><span class="n">wasmtime_fiber_start</span><span class="s">"), "</span><span class="w"></span>
<span class="o">+</span><span class="w">        </span><span class="n">adrp</span><span class="w"> </span><span class="n">x17</span><span class="p">,</span><span class="w"> </span><span class="s">", asm_sym!("</span><span class="n">wasmtime_fiber_start</span><span class="s">"), "</span><span class="o">@</span><span class="n">PAGE</span><span class="w"></span>
<span class="o">+</span><span class="w">        </span><span class="n">add</span><span class="w"> </span><span class="n">x17</span><span class="p">,</span><span class="w"> </span><span class="n">x17</span><span class="p">,</span><span class="w"> </span><span class="s">", asm_sym!("</span><span class="n">wasmtime_fiber_start</span><span class="s">"), "</span><span class="o">@</span><span class="n">PAGEOFF</span><span class="w"></span>
<span class="w">     </span><span class="s">",</span>
<span class="s">     pacia1716!(),</span>
<span class="s">     "</span><span class="w"></span>
</code></pre></div>
<p>basically I figured that the linker is probably putting the functions in different sections now (whereas the <code>.S</code> file put everything contiguously in one section) so we can't rely on the 21-bit <code>adr</code> relocs now, we need the +/- 4GiB range of <code>adrp</code> + an imm12. I'd actually be surprised if this doesn't silently (or just in a delayed way) become an issue on aarch64-linux too, depending on the link order one happens to get...</p>
</blockquote>



<a name="287660539"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%234306%20Use%20%60global_asm%21%60%20instead%20of%20exter.../near/287660539" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.234306.20Use.20.60global_asm.21.60.20instead.20of.20exter.2E.2E.2E.html#287660539">(Jun 28 2022 at 01:34)</a>:</h4>
<p>alexcrichton <a href="https://github.com/bytecodealliance/wasmtime/pull/4306#issuecomment-1168110003">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/4306">issue #4306</a>:</p>
<blockquote>
<p>Ok I ended up cooking up <a href="https://github.com/bytecodealliance/wasmtime/pull/4341">https://github.com/bytecodealliance/wasmtime/pull/4341</a> which I'm hoping will work</p>
</blockquote>



<hr><p>Last updated: Jan 20 2025 at 06:04 UTC</p>
</html>