<html>
<head><meta charset="utf-8"><title>wasmtime / issue #6640 Cranelift: Wrong result on `tail` ... · git-wasmtime · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/index.html">git-wasmtime</a></h2>
<h3>Topic: <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.236640.20Cranelift.3A.20Wrong.20result.20on.20.60tail.60.20.2E.2E.2E.html">wasmtime / issue #6640 Cranelift: Wrong result on `tail` ...</a></h3>

<hr>

<base href="https://bytecodealliance.zulipchat.com">

<head><link href="https://bytecodealliance.github.io/zulip-archive/style.css" rel="stylesheet"></head>

<a name="369160481"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%236640%20Cranelift%3A%20Wrong%20result%20on%20%60tail%60%20.../near/369160481" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.236640.20Cranelift.3A.20Wrong.20result.20on.20.60tail.60.20.2E.2E.2E.html#369160481">(Jun 24 2023 at 11:51)</a>:</h4>
<p>afonso360 opened <a href="https://github.com/bytecodealliance/wasmtime/issues/6640">issue #6640</a>:</p>
<blockquote>
<p><span aria-label="wave" class="emoji emoji-1f44b" role="img" title="wave">:wave:</span> Hey,</p>
<p>Fuzzgen found this while I was working on something unrelated, but it reproduces on main.</p>
<p>The testcase passes if stack probing is disabled. Or if we remove the stack slots.</p>
<p>I've also tested on the other backends and they pass this test.</p>
<h3><code>.clif</code> Test Case</h3>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="n">test</span><span class="w"> </span><span class="n">interpret</span>
<span class="n">test</span><span class="w"> </span><span class="n">run</span>
<span class="n">set</span><span class="w"> </span><span class="n">enable_llvm_abi_extensions</span><span class="o">=</span><span class="kc">true</span>
<span class="n">set</span><span class="w"> </span><span class="n">probestack_size_log2</span><span class="o">=</span><span class="mi">6</span>
<span class="n">set</span><span class="w"> </span><span class="n">probestack_strategy</span><span class="o">=</span><span class="n">inline</span>
<span class="n">set</span><span class="w"> </span><span class="n">enable_probestack</span><span class="o">=</span><span class="kc">true</span>
<span class="n">target</span><span class="w"> </span><span class="n">x86_64</span>
<span class="n">target</span><span class="w"> </span><span class="n">aarch64</span>
<span class="n">target</span><span class="w"> </span><span class="n">riscv64gc</span><span class="w"> </span><span class="n">has_v</span>

<span class="n">function</span><span class="w"> </span><span class="o">%</span><span class="n">a</span><span class="p">(</span><span class="kt">i8</span><span class="p">,</span><span class="w"> </span><span class="kt">i8</span><span class="p">,</span><span class="w"> </span><span class="kt">i8</span><span class="p">,</span><span class="w"> </span><span class="kt">i8</span><span class="p">,</span><span class="w"> </span><span class="n">i16x8</span><span class="p">,</span><span class="w"> </span><span class="kt">i8</span><span class="p">,</span><span class="w"> </span><span class="n">i8x16</span><span class="p">,</span><span class="w"> </span><span class="kt">i64</span><span class="p">,</span><span class="w"> </span><span class="kt">i16</span><span class="p">,</span><span class="w"> </span><span class="kt">i32</span><span class="p">,</span><span class="w"> </span><span class="n">i16x8</span><span class="p">,</span><span class="w"> </span><span class="kt">f32</span><span class="p">,</span><span class="w"> </span><span class="n">i16x8</span><span class="p">,</span><span class="w"> </span><span class="n">i32x4</span><span class="p">,</span><span class="w"> </span><span class="n">i16x8</span><span class="p">,</span><span class="w"> </span><span class="kt">i128</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="kt">i8</span><span class="p">,</span><span class="w"> </span><span class="kt">i8</span><span class="p">,</span><span class="w"> </span><span class="kt">i64</span><span class="p">,</span><span class="w"> </span><span class="n">i16x8</span><span class="p">,</span><span class="w"> </span><span class="kt">i32</span><span class="p">,</span><span class="w"> </span><span class="kt">i128</span><span class="p">,</span><span class="w"> </span><span class="kt">i128</span><span class="p">,</span><span class="w"> </span><span class="kt">i128</span><span class="p">,</span><span class="w"> </span><span class="n">i8x16</span><span class="p">,</span><span class="w"> </span><span class="kt">f32</span><span class="p">,</span><span class="w"> </span><span class="kt">i128</span><span class="p">,</span><span class="w"> </span><span class="n">i32x4</span><span class="p">,</span><span class="w"> </span><span class="n">i32x4</span><span class="w"> </span><span class="n">tail</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">ss0</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">explicit_slot</span><span class="w"> </span><span class="mi">117</span>
<span class="w">    </span><span class="n">ss1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">explicit_slot</span><span class="w"> </span><span class="mi">49</span>
<span class="w">    </span><span class="n">ss2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">explicit_slot</span><span class="w"> </span><span class="mi">65</span>
<span class="w">    </span><span class="n">ss3</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">explicit_slot</span><span class="w"> </span><span class="mi">50</span>
<span class="w">    </span><span class="n">ss4</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">explicit_slot</span><span class="w"> </span><span class="mi">76</span>

<span class="n">block0</span><span class="p">(</span><span class="n">v0</span>: <span class="kt">i8</span><span class="p">,</span><span class="w"> </span><span class="n">v1</span>: <span class="kt">i8</span><span class="p">,</span><span class="w"> </span><span class="n">v2</span>: <span class="kt">i8</span><span class="p">,</span><span class="w"> </span><span class="n">v3</span>: <span class="kt">i8</span><span class="p">,</span><span class="w"> </span><span class="n">v4</span>: <span class="nc">i16x8</span><span class="p">,</span><span class="w"> </span><span class="n">v5</span>: <span class="kt">i8</span><span class="p">,</span><span class="w"> </span><span class="n">v6</span>: <span class="nc">i8x16</span><span class="p">,</span><span class="w"> </span><span class="n">v7</span>: <span class="kt">i64</span><span class="p">,</span><span class="w"> </span><span class="n">v8</span>: <span class="kt">i16</span><span class="p">,</span><span class="w"> </span><span class="n">v9</span>: <span class="kt">i32</span><span class="p">,</span><span class="w"> </span><span class="n">v10</span>: <span class="nc">i16x8</span><span class="p">,</span><span class="w"> </span><span class="n">v11</span>: <span class="kt">f32</span><span class="p">,</span><span class="w"> </span><span class="n">v12</span>: <span class="nc">i16x8</span><span class="p">,</span><span class="w"> </span><span class="n">v13</span>: <span class="nc">i32x4</span><span class="p">,</span><span class="w"> </span><span class="n">v14</span>: <span class="nc">i16x8</span><span class="p">,</span><span class="w"> </span><span class="n">v15</span>: <span class="kt">i128</span><span class="p">)</span>:
    <span class="nc">v32</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">bmask</span><span class="p">.</span><span class="kt">i16</span><span class="w"> </span><span class="n">v15</span>
<span class="w">    </span><span class="n">v33</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">uextend</span><span class="p">.</span><span class="kt">i32</span><span class="w"> </span><span class="n">v32</span>
<span class="w">    </span><span class="n">v40</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">bitrev</span><span class="w"> </span><span class="n">v7</span>
<span class="w">    </span><span class="n">v79</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">icmp</span><span class="w"> </span><span class="n">sge</span><span class="w"> </span><span class="n">v3</span><span class="p">,</span><span class="w"> </span><span class="n">v3</span>
<span class="w">    </span><span class="n">v84</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">bitrev</span><span class="w"> </span><span class="n">v40</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">v79</span><span class="p">,</span><span class="w"> </span><span class="n">v79</span><span class="p">,</span><span class="w"> </span><span class="n">v84</span><span class="p">,</span><span class="w"> </span><span class="n">v14</span><span class="p">,</span><span class="w"> </span><span class="n">v33</span><span class="p">,</span><span class="w"> </span><span class="n">v15</span><span class="p">,</span><span class="w"> </span><span class="n">v15</span><span class="p">,</span><span class="w"> </span><span class="n">v15</span><span class="p">,</span><span class="w"> </span><span class="n">v6</span><span class="p">,</span><span class="w"> </span><span class="n">v11</span><span class="p">,</span><span class="w"> </span><span class="n">v15</span><span class="p">,</span><span class="w"> </span><span class="n">v13</span><span class="p">,</span><span class="w"> </span><span class="n">v13</span>
<span class="p">}</span>

<span class="p">;</span><span class="w"> </span><span class="n">run</span>: <span class="o">%</span><span class="n">a</span><span class="p">(</span><span class="o">-</span><span class="mi">95</span><span class="p">,</span><span class="w"> </span><span class="o">-</span><span class="mi">95</span><span class="p">,</span><span class="w"> </span><span class="o">-</span><span class="mi">95</span><span class="p">,</span><span class="w"> </span><span class="o">-</span><span class="mi">95</span><span class="p">,</span><span class="w"> </span><span class="mh">0xa1a1a1a1a1a1a1a1a1a1a1a1a1a1a1a1</span><span class="p">,</span><span class="w"> </span><span class="o">-</span><span class="mi">95</span><span class="p">,</span><span class="w"> </span><span class="mh">0xa1a1a1a1a1a1a1a1a1a1a1a1a1a1a1a1</span><span class="p">,</span><span class="w"> </span><span class="o">-</span><span class="mi">6799976246779207263</span><span class="p">,</span><span class="w"> </span><span class="o">-</span><span class="mi">24159</span><span class="p">,</span><span class="w"> </span><span class="o">-</span><span class="mi">1583242847</span><span class="p">,</span><span class="w"> </span><span class="mh">0x7b7b7ba1a1a1a1a1a1a1a1a1a1a1a1a1</span><span class="p">,</span><span class="w"> </span><span class="mh">0x1</span><span class="p">.</span><span class="n">f6f6f6p119</span><span class="p">,</span><span class="w"> </span><span class="mh">0x4c4c7b7b7b7b7b7b7b7b7b7b7b7b7b7b</span><span class="p">,</span><span class="w"> </span><span class="mh">0xb0b06e00f1244c4c4c4c4c4c4c4c4c4c</span><span class="p">,</span><span class="w"> </span><span class="mh">0xe2a240000000b0b0b0b0b0b0b0b0b0b0</span><span class="p">,</span><span class="w"> </span><span class="o">-</span><span class="mi">113427455621981599237913610941852744401</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="o">-</span><span class="mi">6799976246779207263</span><span class="p">,</span><span class="w"> </span><span class="mh">0xe2a240000000b0b0b0b0b0b0b0b0b0b0</span><span class="p">,</span><span class="w"> </span><span class="mi">65535</span><span class="p">,</span><span class="w"> </span><span class="o">-</span><span class="mi">113427455621981599237913610941852744401</span><span class="p">,</span><span class="w"> </span><span class="o">-</span><span class="mi">113427455621981599237913610941852744401</span><span class="p">,</span><span class="w"> </span><span class="o">-</span><span class="mi">113427455621981599237913610941852744401</span><span class="p">,</span><span class="w"> </span><span class="mh">0xa1a1a1a1a1a1a1a1a1a1a1a1a1a1a1a1</span><span class="p">,</span><span class="w"> </span><span class="mh">0x1</span><span class="p">.</span><span class="n">f6f6f6p119</span><span class="p">,</span><span class="w"> </span><span class="o">-</span><span class="mi">113427455621981599237913610941852744401</span><span class="p">,</span><span class="w"> </span><span class="mh">0xb0b06e00f1244c4c4c4c4c4c4c4c4c4c</span><span class="p">,</span><span class="w"> </span><span class="mh">0xb0b06e00f1244c4c4c4c4c4c4c4c4c4c</span><span class="p">]</span>
</code></pre></div>
<h3>Steps to Reproduce</h3>
<ul>
<li><code>clif-util test ./the-above.clif</code> </li>
</ul>
<h3>Expected Results</h3>
<p>The test to pass.</p>
<h3>Actual Results</h3>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="w">     </span><span class="n">Running</span><span class="w"> </span><span class="err">`</span><span class="o">/</span><span class="n">home</span><span class="o">/</span><span class="n">afonso</span><span class="o">/</span><span class="n">git</span><span class="o">/</span><span class="n">wasmtime</span><span class="o">/</span><span class="n">target</span><span class="o">/</span><span class="n">debug</span><span class="o">/</span><span class="n">clif</span><span class="o">-</span><span class="n">util</span><span class="w"> </span><span class="n">test</span><span class="w"> </span><span class="p">.</span><span class="o">/</span><span class="n">lmao</span><span class="p">.</span><span class="n">clif</span><span class="err">`</span>
<span class="w"> </span><span class="n">ERROR</span><span class="w"> </span><span class="n">cranelift_filetests</span>::<span class="n">concurrent</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="n">FAIL</span>: <span class="nc">run</span>
<span class="n">FAIL</span><span class="w"> </span><span class="p">.</span><span class="o">/</span><span class="n">lmao</span><span class="p">.</span><span class="n">clif</span>: <span class="nc">run</span>

<span class="n">Caused</span><span class="w"> </span><span class="n">by</span>:
    <span class="nc">Failed</span><span class="w"> </span><span class="n">test</span>: <span class="nc">run</span>: <span class="o">%</span><span class="n">a</span><span class="p">(</span><span class="o">-</span><span class="mi">95</span><span class="p">,</span><span class="w"> </span><span class="o">-</span><span class="mi">95</span><span class="p">,</span><span class="w"> </span><span class="o">-</span><span class="mi">95</span><span class="p">,</span><span class="w"> </span><span class="o">-</span><span class="mi">95</span><span class="p">,</span><span class="w"> </span><span class="mh">0xa1a1a1a1a1a1a1a1a1a1a1a1a1a1a1a1</span><span class="p">,</span><span class="w"> </span><span class="o">-</span><span class="mi">95</span><span class="p">,</span><span class="w"> </span><span class="mh">0xa1a1a1a1a1a1a1a1a1a1a1a1a1a1a1a1</span><span class="p">,</span><span class="w"> </span><span class="o">-</span><span class="mi">6799976246779207263</span><span class="p">,</span><span class="w"> </span><span class="o">-</span><span class="mi">24159</span><span class="p">,</span><span class="w"> </span><span class="o">-</span><span class="mi">1583242847</span><span class="p">,</span><span class="w"> </span><span class="mh">0x7b7b7ba1a1a1a1a1a1a1a1a1a1a1a1a1</span><span class="p">,</span><span class="w"> </span><span class="mh">0x1</span><span class="p">.</span><span class="n">f6f6f6p119</span><span class="p">,</span><span class="w"> </span><span class="mh">0x4c4c7b7b7b7b7b7b7b7b7b7b7b7b7b7b</span><span class="p">,</span><span class="w"> </span><span class="mh">0xb0b06e00f1244c4c4c4c4c4c4c4c4c4c</span><span class="p">,</span><span class="w"> </span><span class="mh">0xe2a240000000b0b0b0b0b0b0b0b0b0b0</span><span class="p">,</span><span class="w"> </span><span class="o">-</span><span class="mi">113427455621981599237913610941852744401</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="o">-</span><span class="mi">6799976246779207263</span><span class="p">,</span><span class="w"> </span><span class="mh">0xe2a240000000b0b0b0b0b0b0b0b0b0b0</span><span class="p">,</span><span class="w"> </span><span class="mi">65535</span><span class="p">,</span><span class="w"> </span><span class="o">-</span><span class="mi">113427455621981599237913610941852744401</span><span class="p">,</span><span class="w"> </span><span class="o">-</span><span class="mi">113427455621981599237913610941852744401</span><span class="p">,</span><span class="w"> </span><span class="o">-</span><span class="mi">113427455621981599237913610941852744401</span><span class="p">,</span><span class="w"> </span><span class="mh">0xa1a1a1a1a1a1a1a1a1a1a1a1a1a1a1a1</span><span class="p">,</span><span class="w"> </span><span class="mh">0x1</span><span class="p">.</span><span class="n">f6f6f6p119</span><span class="p">,</span><span class="w"> </span><span class="o">-</span><span class="mi">113427455621981599237913610941852744401</span><span class="p">,</span><span class="w"> </span><span class="mh">0xb0b06e00f1244c4c4c4c4c4c4c4c4c4c</span><span class="p">,</span><span class="w"> </span><span class="mh">0xb0b06e00f1244c4c4c4c4c4c4c4c4c4c</span><span class="p">],</span><span class="w"> </span><span class="n">actual</span>: <span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="o">-</span><span class="mi">6799976246779207263</span><span class="p">,</span><span class="w"> </span><span class="mh">0xe2a240000000b0b0b0b0b0b0b0b0b0b0</span><span class="p">,</span><span class="w"> </span><span class="mi">65535</span><span class="p">,</span><span class="w"> </span><span class="mi">2583671442118339183427542988162351</span><span class="p">,</span><span class="w"> </span><span class="mi">2583671442118339183427542988162351</span><span class="p">,</span><span class="w"> </span><span class="mi">2583671442118339183427542988162351</span><span class="p">,</span><span class="w"> </span><span class="mh">0xa1a1a1a1a1a1a1a1a1a1a1a1a1a1a1a1</span><span class="p">,</span><span class="w"> </span><span class="mh">0x1</span><span class="p">.</span><span class="n">f6f6f6p119</span><span class="p">,</span><span class="w"> </span><span class="mi">2583671442118339183427542988162351</span><span class="p">,</span><span class="w"> </span><span class="mh">0xb0b06e00f1244c4c4c4c4c4c4c4c4c4c</span><span class="p">,</span><span class="w"> </span><span class="mh">0xb0b06e00f1244c4c4c4c4c4c4c4c4c4c</span><span class="p">]</span>
<span class="mi">1</span><span class="w"> </span><span class="n">tests</span>
<span class="n">Error</span>: <span class="mi">1</span><span class="w"> </span><span class="n">failure</span>
</code></pre></div>
<h3>Versions and Environment</h3>
<p>Cranelift version or commit: <code>main</code> (2d34b4657aa5290948da9a07cb31764a12c12994)<br>
Operating system: Linux<br>
Architecture: X86<br>
</p>
</blockquote>



<a name="369160482"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%236640%20Cranelift%3A%20Wrong%20result%20on%20%60tail%60%20.../near/369160482" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.236640.20Cranelift.3A.20Wrong.20result.20on.20.60tail.60.20.2E.2E.2E.html#369160482">(Jun 24 2023 at 11:51)</a>:</h4>
<p>afonso360 assigned <a href="https://github.com/bytecodealliance/wasmtime/issues/6640">issue #6640</a> to fitzgen.</p>



<a name="369160484"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%236640%20Cranelift%3A%20Wrong%20result%20on%20%60tail%60%20.../near/369160484" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.236640.20Cranelift.3A.20Wrong.20result.20on.20.60tail.60.20.2E.2E.2E.html#369160484">(Jun 24 2023 at 11:51)</a>:</h4>
<p>afonso360 labeled <a href="https://github.com/bytecodealliance/wasmtime/issues/6640">issue #6640</a>:</p>
<blockquote>
<p><span aria-label="wave" class="emoji emoji-1f44b" role="img" title="wave">:wave:</span> Hey,</p>
<p>Fuzzgen found this while I was working on something unrelated, but it reproduces on main.</p>
<p>The testcase passes if stack probing is disabled. Or if we remove the stack slots.</p>
<p>I've also tested on the other backends and they pass this test.</p>
<h3><code>.clif</code> Test Case</h3>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="n">test</span><span class="w"> </span><span class="n">interpret</span>
<span class="n">test</span><span class="w"> </span><span class="n">run</span>
<span class="n">set</span><span class="w"> </span><span class="n">enable_llvm_abi_extensions</span><span class="o">=</span><span class="kc">true</span>
<span class="n">set</span><span class="w"> </span><span class="n">probestack_size_log2</span><span class="o">=</span><span class="mi">6</span>
<span class="n">set</span><span class="w"> </span><span class="n">probestack_strategy</span><span class="o">=</span><span class="n">inline</span>
<span class="n">set</span><span class="w"> </span><span class="n">enable_probestack</span><span class="o">=</span><span class="kc">true</span>
<span class="n">target</span><span class="w"> </span><span class="n">x86_64</span>
<span class="n">target</span><span class="w"> </span><span class="n">aarch64</span>
<span class="n">target</span><span class="w"> </span><span class="n">riscv64gc</span><span class="w"> </span><span class="n">has_v</span>

<span class="n">function</span><span class="w"> </span><span class="o">%</span><span class="n">a</span><span class="p">(</span><span class="kt">i8</span><span class="p">,</span><span class="w"> </span><span class="kt">i8</span><span class="p">,</span><span class="w"> </span><span class="kt">i8</span><span class="p">,</span><span class="w"> </span><span class="kt">i8</span><span class="p">,</span><span class="w"> </span><span class="n">i16x8</span><span class="p">,</span><span class="w"> </span><span class="kt">i8</span><span class="p">,</span><span class="w"> </span><span class="n">i8x16</span><span class="p">,</span><span class="w"> </span><span class="kt">i64</span><span class="p">,</span><span class="w"> </span><span class="kt">i16</span><span class="p">,</span><span class="w"> </span><span class="kt">i32</span><span class="p">,</span><span class="w"> </span><span class="n">i16x8</span><span class="p">,</span><span class="w"> </span><span class="kt">f32</span><span class="p">,</span><span class="w"> </span><span class="n">i16x8</span><span class="p">,</span><span class="w"> </span><span class="n">i32x4</span><span class="p">,</span><span class="w"> </span><span class="n">i16x8</span><span class="p">,</span><span class="w"> </span><span class="kt">i128</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="kt">i8</span><span class="p">,</span><span class="w"> </span><span class="kt">i8</span><span class="p">,</span><span class="w"> </span><span class="kt">i64</span><span class="p">,</span><span class="w"> </span><span class="n">i16x8</span><span class="p">,</span><span class="w"> </span><span class="kt">i32</span><span class="p">,</span><span class="w"> </span><span class="kt">i128</span><span class="p">,</span><span class="w"> </span><span class="kt">i128</span><span class="p">,</span><span class="w"> </span><span class="kt">i128</span><span class="p">,</span><span class="w"> </span><span class="n">i8x16</span><span class="p">,</span><span class="w"> </span><span class="kt">f32</span><span class="p">,</span><span class="w"> </span><span class="kt">i128</span><span class="p">,</span><span class="w"> </span><span class="n">i32x4</span><span class="p">,</span><span class="w"> </span><span class="n">i32x4</span><span class="w"> </span><span class="n">tail</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">ss0</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">explicit_slot</span><span class="w"> </span><span class="mi">117</span>
<span class="w">    </span><span class="n">ss1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">explicit_slot</span><span class="w"> </span><span class="mi">49</span>
<span class="w">    </span><span class="n">ss2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">explicit_slot</span><span class="w"> </span><span class="mi">65</span>
<span class="w">    </span><span class="n">ss3</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">explicit_slot</span><span class="w"> </span><span class="mi">50</span>
<span class="w">    </span><span class="n">ss4</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">explicit_slot</span><span class="w"> </span><span class="mi">76</span>

<span class="n">block0</span><span class="p">(</span><span class="n">v0</span>: <span class="kt">i8</span><span class="p">,</span><span class="w"> </span><span class="n">v1</span>: <span class="kt">i8</span><span class="p">,</span><span class="w"> </span><span class="n">v2</span>: <span class="kt">i8</span><span class="p">,</span><span class="w"> </span><span class="n">v3</span>: <span class="kt">i8</span><span class="p">,</span><span class="w"> </span><span class="n">v4</span>: <span class="nc">i16x8</span><span class="p">,</span><span class="w"> </span><span class="n">v5</span>: <span class="kt">i8</span><span class="p">,</span><span class="w"> </span><span class="n">v6</span>: <span class="nc">i8x16</span><span class="p">,</span><span class="w"> </span><span class="n">v7</span>: <span class="kt">i64</span><span class="p">,</span><span class="w"> </span><span class="n">v8</span>: <span class="kt">i16</span><span class="p">,</span><span class="w"> </span><span class="n">v9</span>: <span class="kt">i32</span><span class="p">,</span><span class="w"> </span><span class="n">v10</span>: <span class="nc">i16x8</span><span class="p">,</span><span class="w"> </span><span class="n">v11</span>: <span class="kt">f32</span><span class="p">,</span><span class="w"> </span><span class="n">v12</span>: <span class="nc">i16x8</span><span class="p">,</span><span class="w"> </span><span class="n">v13</span>: <span class="nc">i32x4</span><span class="p">,</span><span class="w"> </span><span class="n">v14</span>: <span class="nc">i16x8</span><span class="p">,</span><span class="w"> </span><span class="n">v15</span>: <span class="kt">i128</span><span class="p">)</span>:
    <span class="nc">v32</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">bmask</span><span class="p">.</span><span class="kt">i16</span><span class="w"> </span><span class="n">v15</span>
<span class="w">    </span><span class="n">v33</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">uextend</span><span class="p">.</span><span class="kt">i32</span><span class="w"> </span><span class="n">v32</span>
<span class="w">    </span><span class="n">v40</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">bitrev</span><span class="w"> </span><span class="n">v7</span>
<span class="w">    </span><span class="n">v79</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">icmp</span><span class="w"> </span><span class="n">sge</span><span class="w"> </span><span class="n">v3</span><span class="p">,</span><span class="w"> </span><span class="n">v3</span>
<span class="w">    </span><span class="n">v84</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">bitrev</span><span class="w"> </span><span class="n">v40</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">v79</span><span class="p">,</span><span class="w"> </span><span class="n">v79</span><span class="p">,</span><span class="w"> </span><span class="n">v84</span><span class="p">,</span><span class="w"> </span><span class="n">v14</span><span class="p">,</span><span class="w"> </span><span class="n">v33</span><span class="p">,</span><span class="w"> </span><span class="n">v15</span><span class="p">,</span><span class="w"> </span><span class="n">v15</span><span class="p">,</span><span class="w"> </span><span class="n">v15</span><span class="p">,</span><span class="w"> </span><span class="n">v6</span><span class="p">,</span><span class="w"> </span><span class="n">v11</span><span class="p">,</span><span class="w"> </span><span class="n">v15</span><span class="p">,</span><span class="w"> </span><span class="n">v13</span><span class="p">,</span><span class="w"> </span><span class="n">v13</span>
<span class="p">}</span>

<span class="p">;</span><span class="w"> </span><span class="n">run</span>: <span class="o">%</span><span class="n">a</span><span class="p">(</span><span class="o">-</span><span class="mi">95</span><span class="p">,</span><span class="w"> </span><span class="o">-</span><span class="mi">95</span><span class="p">,</span><span class="w"> </span><span class="o">-</span><span class="mi">95</span><span class="p">,</span><span class="w"> </span><span class="o">-</span><span class="mi">95</span><span class="p">,</span><span class="w"> </span><span class="mh">0xa1a1a1a1a1a1a1a1a1a1a1a1a1a1a1a1</span><span class="p">,</span><span class="w"> </span><span class="o">-</span><span class="mi">95</span><span class="p">,</span><span class="w"> </span><span class="mh">0xa1a1a1a1a1a1a1a1a1a1a1a1a1a1a1a1</span><span class="p">,</span><span class="w"> </span><span class="o">-</span><span class="mi">6799976246779207263</span><span class="p">,</span><span class="w"> </span><span class="o">-</span><span class="mi">24159</span><span class="p">,</span><span class="w"> </span><span class="o">-</span><span class="mi">1583242847</span><span class="p">,</span><span class="w"> </span><span class="mh">0x7b7b7ba1a1a1a1a1a1a1a1a1a1a1a1a1</span><span class="p">,</span><span class="w"> </span><span class="mh">0x1</span><span class="p">.</span><span class="n">f6f6f6p119</span><span class="p">,</span><span class="w"> </span><span class="mh">0x4c4c7b7b7b7b7b7b7b7b7b7b7b7b7b7b</span><span class="p">,</span><span class="w"> </span><span class="mh">0xb0b06e00f1244c4c4c4c4c4c4c4c4c4c</span><span class="p">,</span><span class="w"> </span><span class="mh">0xe2a240000000b0b0b0b0b0b0b0b0b0b0</span><span class="p">,</span><span class="w"> </span><span class="o">-</span><span class="mi">113427455621981599237913610941852744401</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="o">-</span><span class="mi">6799976246779207263</span><span class="p">,</span><span class="w"> </span><span class="mh">0xe2a240000000b0b0b0b0b0b0b0b0b0b0</span><span class="p">,</span><span class="w"> </span><span class="mi">65535</span><span class="p">,</span><span class="w"> </span><span class="o">-</span><span class="mi">113427455621981599237913610941852744401</span><span class="p">,</span><span class="w"> </span><span class="o">-</span><span class="mi">113427455621981599237913610941852744401</span><span class="p">,</span><span class="w"> </span><span class="o">-</span><span class="mi">113427455621981599237913610941852744401</span><span class="p">,</span><span class="w"> </span><span class="mh">0xa1a1a1a1a1a1a1a1a1a1a1a1a1a1a1a1</span><span class="p">,</span><span class="w"> </span><span class="mh">0x1</span><span class="p">.</span><span class="n">f6f6f6p119</span><span class="p">,</span><span class="w"> </span><span class="o">-</span><span class="mi">113427455621981599237913610941852744401</span><span class="p">,</span><span class="w"> </span><span class="mh">0xb0b06e00f1244c4c4c4c4c4c4c4c4c4c</span><span class="p">,</span><span class="w"> </span><span class="mh">0xb0b06e00f1244c4c4c4c4c4c4c4c4c4c</span><span class="p">]</span>
</code></pre></div>
<h3>Steps to Reproduce</h3>
<ul>
<li><code>clif-util test ./the-above.clif</code> </li>
</ul>
<h3>Expected Results</h3>
<p>The test to pass.</p>
<h3>Actual Results</h3>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="w">     </span><span class="n">Running</span><span class="w"> </span><span class="err">`</span><span class="o">/</span><span class="n">home</span><span class="o">/</span><span class="n">afonso</span><span class="o">/</span><span class="n">git</span><span class="o">/</span><span class="n">wasmtime</span><span class="o">/</span><span class="n">target</span><span class="o">/</span><span class="n">debug</span><span class="o">/</span><span class="n">clif</span><span class="o">-</span><span class="n">util</span><span class="w"> </span><span class="n">test</span><span class="w"> </span><span class="p">.</span><span class="o">/</span><span class="n">lmao</span><span class="p">.</span><span class="n">clif</span><span class="err">`</span>
<span class="w"> </span><span class="n">ERROR</span><span class="w"> </span><span class="n">cranelift_filetests</span>::<span class="n">concurrent</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="n">FAIL</span>: <span class="nc">run</span>
<span class="n">FAIL</span><span class="w"> </span><span class="p">.</span><span class="o">/</span><span class="n">lmao</span><span class="p">.</span><span class="n">clif</span>: <span class="nc">run</span>

<span class="n">Caused</span><span class="w"> </span><span class="n">by</span>:
    <span class="nc">Failed</span><span class="w"> </span><span class="n">test</span>: <span class="nc">run</span>: <span class="o">%</span><span class="n">a</span><span class="p">(</span><span class="o">-</span><span class="mi">95</span><span class="p">,</span><span class="w"> </span><span class="o">-</span><span class="mi">95</span><span class="p">,</span><span class="w"> </span><span class="o">-</span><span class="mi">95</span><span class="p">,</span><span class="w"> </span><span class="o">-</span><span class="mi">95</span><span class="p">,</span><span class="w"> </span><span class="mh">0xa1a1a1a1a1a1a1a1a1a1a1a1a1a1a1a1</span><span class="p">,</span><span class="w"> </span><span class="o">-</span><span class="mi">95</span><span class="p">,</span><span class="w"> </span><span class="mh">0xa1a1a1a1a1a1a1a1a1a1a1a1a1a1a1a1</span><span class="p">,</span><span class="w"> </span><span class="o">-</span><span class="mi">6799976246779207263</span><span class="p">,</span><span class="w"> </span><span class="o">-</span><span class="mi">24159</span><span class="p">,</span><span class="w"> </span><span class="o">-</span><span class="mi">1583242847</span><span class="p">,</span><span class="w"> </span><span class="mh">0x7b7b7ba1a1a1a1a1a1a1a1a1a1a1a1a1</span><span class="p">,</span><span class="w"> </span><span class="mh">0x1</span><span class="p">.</span><span class="n">f6f6f6p119</span><span class="p">,</span><span class="w"> </span><span class="mh">0x4c4c7b7b7b7b7b7b7b7b7b7b7b7b7b7b</span><span class="p">,</span><span class="w"> </span><span class="mh">0xb0b06e00f1244c4c4c4c4c4c4c4c4c4c</span><span class="p">,</span><span class="w"> </span><span class="mh">0xe2a240000000b0b0b0b0b0b0b0b0b0b0</span><span class="p">,</span><span class="w"> </span><span class="o">-</span><span class="mi">113427455621981599237913610941852744401</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="o">-</span><span class="mi">6799976246779207263</span><span class="p">,</span><span class="w"> </span><span class="mh">0xe2a240000000b0b0b0b0b0b0b0b0b0b0</span><span class="p">,</span><span class="w"> </span><span class="mi">65535</span><span class="p">,</span><span class="w"> </span><span class="o">-</span><span class="mi">113427455621981599237913610941852744401</span><span class="p">,</span><span class="w"> </span><span class="o">-</span><span class="mi">113427455621981599237913610941852744401</span><span class="p">,</span><span class="w"> </span><span class="o">-</span><span class="mi">113427455621981599237913610941852744401</span><span class="p">,</span><span class="w"> </span><span class="mh">0xa1a1a1a1a1a1a1a1a1a1a1a1a1a1a1a1</span><span class="p">,</span><span class="w"> </span><span class="mh">0x1</span><span class="p">.</span><span class="n">f6f6f6p119</span><span class="p">,</span><span class="w"> </span><span class="o">-</span><span class="mi">113427455621981599237913610941852744401</span><span class="p">,</span><span class="w"> </span><span class="mh">0xb0b06e00f1244c4c4c4c4c4c4c4c4c4c</span><span class="p">,</span><span class="w"> </span><span class="mh">0xb0b06e00f1244c4c4c4c4c4c4c4c4c4c</span><span class="p">],</span><span class="w"> </span><span class="n">actual</span>: <span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="o">-</span><span class="mi">6799976246779207263</span><span class="p">,</span><span class="w"> </span><span class="mh">0xe2a240000000b0b0b0b0b0b0b0b0b0b0</span><span class="p">,</span><span class="w"> </span><span class="mi">65535</span><span class="p">,</span><span class="w"> </span><span class="mi">2583671442118339183427542988162351</span><span class="p">,</span><span class="w"> </span><span class="mi">2583671442118339183427542988162351</span><span class="p">,</span><span class="w"> </span><span class="mi">2583671442118339183427542988162351</span><span class="p">,</span><span class="w"> </span><span class="mh">0xa1a1a1a1a1a1a1a1a1a1a1a1a1a1a1a1</span><span class="p">,</span><span class="w"> </span><span class="mh">0x1</span><span class="p">.</span><span class="n">f6f6f6p119</span><span class="p">,</span><span class="w"> </span><span class="mi">2583671442118339183427542988162351</span><span class="p">,</span><span class="w"> </span><span class="mh">0xb0b06e00f1244c4c4c4c4c4c4c4c4c4c</span><span class="p">,</span><span class="w"> </span><span class="mh">0xb0b06e00f1244c4c4c4c4c4c4c4c4c4c</span><span class="p">]</span>
<span class="mi">1</span><span class="w"> </span><span class="n">tests</span>
<span class="n">Error</span>: <span class="mi">1</span><span class="w"> </span><span class="n">failure</span>
</code></pre></div>
<h3>Versions and Environment</h3>
<p>Cranelift version or commit: <code>main</code> (2d34b4657aa5290948da9a07cb31764a12c12994)<br>
Operating system: Linux<br>
Architecture: X86<br>
</p>
</blockquote>



<a name="369160485"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%236640%20Cranelift%3A%20Wrong%20result%20on%20%60tail%60%20.../near/369160485" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.236640.20Cranelift.3A.20Wrong.20result.20on.20.60tail.60.20.2E.2E.2E.html#369160485">(Jun 24 2023 at 11:51)</a>:</h4>
<p>afonso360 labeled <a href="https://github.com/bytecodealliance/wasmtime/issues/6640">issue #6640</a>:</p>
<blockquote>
<p><span aria-label="wave" class="emoji emoji-1f44b" role="img" title="wave">:wave:</span> Hey,</p>
<p>Fuzzgen found this while I was working on something unrelated, but it reproduces on main.</p>
<p>The testcase passes if stack probing is disabled. Or if we remove the stack slots.</p>
<p>I've also tested on the other backends and they pass this test.</p>
<h3><code>.clif</code> Test Case</h3>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="n">test</span><span class="w"> </span><span class="n">interpret</span>
<span class="n">test</span><span class="w"> </span><span class="n">run</span>
<span class="n">set</span><span class="w"> </span><span class="n">enable_llvm_abi_extensions</span><span class="o">=</span><span class="kc">true</span>
<span class="n">set</span><span class="w"> </span><span class="n">probestack_size_log2</span><span class="o">=</span><span class="mi">6</span>
<span class="n">set</span><span class="w"> </span><span class="n">probestack_strategy</span><span class="o">=</span><span class="n">inline</span>
<span class="n">set</span><span class="w"> </span><span class="n">enable_probestack</span><span class="o">=</span><span class="kc">true</span>
<span class="n">target</span><span class="w"> </span><span class="n">x86_64</span>
<span class="n">target</span><span class="w"> </span><span class="n">aarch64</span>
<span class="n">target</span><span class="w"> </span><span class="n">riscv64gc</span><span class="w"> </span><span class="n">has_v</span>

<span class="n">function</span><span class="w"> </span><span class="o">%</span><span class="n">a</span><span class="p">(</span><span class="kt">i8</span><span class="p">,</span><span class="w"> </span><span class="kt">i8</span><span class="p">,</span><span class="w"> </span><span class="kt">i8</span><span class="p">,</span><span class="w"> </span><span class="kt">i8</span><span class="p">,</span><span class="w"> </span><span class="n">i16x8</span><span class="p">,</span><span class="w"> </span><span class="kt">i8</span><span class="p">,</span><span class="w"> </span><span class="n">i8x16</span><span class="p">,</span><span class="w"> </span><span class="kt">i64</span><span class="p">,</span><span class="w"> </span><span class="kt">i16</span><span class="p">,</span><span class="w"> </span><span class="kt">i32</span><span class="p">,</span><span class="w"> </span><span class="n">i16x8</span><span class="p">,</span><span class="w"> </span><span class="kt">f32</span><span class="p">,</span><span class="w"> </span><span class="n">i16x8</span><span class="p">,</span><span class="w"> </span><span class="n">i32x4</span><span class="p">,</span><span class="w"> </span><span class="n">i16x8</span><span class="p">,</span><span class="w"> </span><span class="kt">i128</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="kt">i8</span><span class="p">,</span><span class="w"> </span><span class="kt">i8</span><span class="p">,</span><span class="w"> </span><span class="kt">i64</span><span class="p">,</span><span class="w"> </span><span class="n">i16x8</span><span class="p">,</span><span class="w"> </span><span class="kt">i32</span><span class="p">,</span><span class="w"> </span><span class="kt">i128</span><span class="p">,</span><span class="w"> </span><span class="kt">i128</span><span class="p">,</span><span class="w"> </span><span class="kt">i128</span><span class="p">,</span><span class="w"> </span><span class="n">i8x16</span><span class="p">,</span><span class="w"> </span><span class="kt">f32</span><span class="p">,</span><span class="w"> </span><span class="kt">i128</span><span class="p">,</span><span class="w"> </span><span class="n">i32x4</span><span class="p">,</span><span class="w"> </span><span class="n">i32x4</span><span class="w"> </span><span class="n">tail</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">ss0</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">explicit_slot</span><span class="w"> </span><span class="mi">117</span>
<span class="w">    </span><span class="n">ss1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">explicit_slot</span><span class="w"> </span><span class="mi">49</span>
<span class="w">    </span><span class="n">ss2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">explicit_slot</span><span class="w"> </span><span class="mi">65</span>
<span class="w">    </span><span class="n">ss3</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">explicit_slot</span><span class="w"> </span><span class="mi">50</span>
<span class="w">    </span><span class="n">ss4</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">explicit_slot</span><span class="w"> </span><span class="mi">76</span>

<span class="n">block0</span><span class="p">(</span><span class="n">v0</span>: <span class="kt">i8</span><span class="p">,</span><span class="w"> </span><span class="n">v1</span>: <span class="kt">i8</span><span class="p">,</span><span class="w"> </span><span class="n">v2</span>: <span class="kt">i8</span><span class="p">,</span><span class="w"> </span><span class="n">v3</span>: <span class="kt">i8</span><span class="p">,</span><span class="w"> </span><span class="n">v4</span>: <span class="nc">i16x8</span><span class="p">,</span><span class="w"> </span><span class="n">v5</span>: <span class="kt">i8</span><span class="p">,</span><span class="w"> </span><span class="n">v6</span>: <span class="nc">i8x16</span><span class="p">,</span><span class="w"> </span><span class="n">v7</span>: <span class="kt">i64</span><span class="p">,</span><span class="w"> </span><span class="n">v8</span>: <span class="kt">i16</span><span class="p">,</span><span class="w"> </span><span class="n">v9</span>: <span class="kt">i32</span><span class="p">,</span><span class="w"> </span><span class="n">v10</span>: <span class="nc">i16x8</span><span class="p">,</span><span class="w"> </span><span class="n">v11</span>: <span class="kt">f32</span><span class="p">,</span><span class="w"> </span><span class="n">v12</span>: <span class="nc">i16x8</span><span class="p">,</span><span class="w"> </span><span class="n">v13</span>: <span class="nc">i32x4</span><span class="p">,</span><span class="w"> </span><span class="n">v14</span>: <span class="nc">i16x8</span><span class="p">,</span><span class="w"> </span><span class="n">v15</span>: <span class="kt">i128</span><span class="p">)</span>:
    <span class="nc">v32</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">bmask</span><span class="p">.</span><span class="kt">i16</span><span class="w"> </span><span class="n">v15</span>
<span class="w">    </span><span class="n">v33</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">uextend</span><span class="p">.</span><span class="kt">i32</span><span class="w"> </span><span class="n">v32</span>
<span class="w">    </span><span class="n">v40</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">bitrev</span><span class="w"> </span><span class="n">v7</span>
<span class="w">    </span><span class="n">v79</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">icmp</span><span class="w"> </span><span class="n">sge</span><span class="w"> </span><span class="n">v3</span><span class="p">,</span><span class="w"> </span><span class="n">v3</span>
<span class="w">    </span><span class="n">v84</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">bitrev</span><span class="w"> </span><span class="n">v40</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">v79</span><span class="p">,</span><span class="w"> </span><span class="n">v79</span><span class="p">,</span><span class="w"> </span><span class="n">v84</span><span class="p">,</span><span class="w"> </span><span class="n">v14</span><span class="p">,</span><span class="w"> </span><span class="n">v33</span><span class="p">,</span><span class="w"> </span><span class="n">v15</span><span class="p">,</span><span class="w"> </span><span class="n">v15</span><span class="p">,</span><span class="w"> </span><span class="n">v15</span><span class="p">,</span><span class="w"> </span><span class="n">v6</span><span class="p">,</span><span class="w"> </span><span class="n">v11</span><span class="p">,</span><span class="w"> </span><span class="n">v15</span><span class="p">,</span><span class="w"> </span><span class="n">v13</span><span class="p">,</span><span class="w"> </span><span class="n">v13</span>
<span class="p">}</span>

<span class="p">;</span><span class="w"> </span><span class="n">run</span>: <span class="o">%</span><span class="n">a</span><span class="p">(</span><span class="o">-</span><span class="mi">95</span><span class="p">,</span><span class="w"> </span><span class="o">-</span><span class="mi">95</span><span class="p">,</span><span class="w"> </span><span class="o">-</span><span class="mi">95</span><span class="p">,</span><span class="w"> </span><span class="o">-</span><span class="mi">95</span><span class="p">,</span><span class="w"> </span><span class="mh">0xa1a1a1a1a1a1a1a1a1a1a1a1a1a1a1a1</span><span class="p">,</span><span class="w"> </span><span class="o">-</span><span class="mi">95</span><span class="p">,</span><span class="w"> </span><span class="mh">0xa1a1a1a1a1a1a1a1a1a1a1a1a1a1a1a1</span><span class="p">,</span><span class="w"> </span><span class="o">-</span><span class="mi">6799976246779207263</span><span class="p">,</span><span class="w"> </span><span class="o">-</span><span class="mi">24159</span><span class="p">,</span><span class="w"> </span><span class="o">-</span><span class="mi">1583242847</span><span class="p">,</span><span class="w"> </span><span class="mh">0x7b7b7ba1a1a1a1a1a1a1a1a1a1a1a1a1</span><span class="p">,</span><span class="w"> </span><span class="mh">0x1</span><span class="p">.</span><span class="n">f6f6f6p119</span><span class="p">,</span><span class="w"> </span><span class="mh">0x4c4c7b7b7b7b7b7b7b7b7b7b7b7b7b7b</span><span class="p">,</span><span class="w"> </span><span class="mh">0xb0b06e00f1244c4c4c4c4c4c4c4c4c4c</span><span class="p">,</span><span class="w"> </span><span class="mh">0xe2a240000000b0b0b0b0b0b0b0b0b0b0</span><span class="p">,</span><span class="w"> </span><span class="o">-</span><span class="mi">113427455621981599237913610941852744401</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="o">-</span><span class="mi">6799976246779207263</span><span class="p">,</span><span class="w"> </span><span class="mh">0xe2a240000000b0b0b0b0b0b0b0b0b0b0</span><span class="p">,</span><span class="w"> </span><span class="mi">65535</span><span class="p">,</span><span class="w"> </span><span class="o">-</span><span class="mi">113427455621981599237913610941852744401</span><span class="p">,</span><span class="w"> </span><span class="o">-</span><span class="mi">113427455621981599237913610941852744401</span><span class="p">,</span><span class="w"> </span><span class="o">-</span><span class="mi">113427455621981599237913610941852744401</span><span class="p">,</span><span class="w"> </span><span class="mh">0xa1a1a1a1a1a1a1a1a1a1a1a1a1a1a1a1</span><span class="p">,</span><span class="w"> </span><span class="mh">0x1</span><span class="p">.</span><span class="n">f6f6f6p119</span><span class="p">,</span><span class="w"> </span><span class="o">-</span><span class="mi">113427455621981599237913610941852744401</span><span class="p">,</span><span class="w"> </span><span class="mh">0xb0b06e00f1244c4c4c4c4c4c4c4c4c4c</span><span class="p">,</span><span class="w"> </span><span class="mh">0xb0b06e00f1244c4c4c4c4c4c4c4c4c4c</span><span class="p">]</span>
</code></pre></div>
<h3>Steps to Reproduce</h3>
<ul>
<li><code>clif-util test ./the-above.clif</code> </li>
</ul>
<h3>Expected Results</h3>
<p>The test to pass.</p>
<h3>Actual Results</h3>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="w">     </span><span class="n">Running</span><span class="w"> </span><span class="err">`</span><span class="o">/</span><span class="n">home</span><span class="o">/</span><span class="n">afonso</span><span class="o">/</span><span class="n">git</span><span class="o">/</span><span class="n">wasmtime</span><span class="o">/</span><span class="n">target</span><span class="o">/</span><span class="n">debug</span><span class="o">/</span><span class="n">clif</span><span class="o">-</span><span class="n">util</span><span class="w"> </span><span class="n">test</span><span class="w"> </span><span class="p">.</span><span class="o">/</span><span class="n">lmao</span><span class="p">.</span><span class="n">clif</span><span class="err">`</span>
<span class="w"> </span><span class="n">ERROR</span><span class="w"> </span><span class="n">cranelift_filetests</span>::<span class="n">concurrent</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="n">FAIL</span>: <span class="nc">run</span>
<span class="n">FAIL</span><span class="w"> </span><span class="p">.</span><span class="o">/</span><span class="n">lmao</span><span class="p">.</span><span class="n">clif</span>: <span class="nc">run</span>

<span class="n">Caused</span><span class="w"> </span><span class="n">by</span>:
    <span class="nc">Failed</span><span class="w"> </span><span class="n">test</span>: <span class="nc">run</span>: <span class="o">%</span><span class="n">a</span><span class="p">(</span><span class="o">-</span><span class="mi">95</span><span class="p">,</span><span class="w"> </span><span class="o">-</span><span class="mi">95</span><span class="p">,</span><span class="w"> </span><span class="o">-</span><span class="mi">95</span><span class="p">,</span><span class="w"> </span><span class="o">-</span><span class="mi">95</span><span class="p">,</span><span class="w"> </span><span class="mh">0xa1a1a1a1a1a1a1a1a1a1a1a1a1a1a1a1</span><span class="p">,</span><span class="w"> </span><span class="o">-</span><span class="mi">95</span><span class="p">,</span><span class="w"> </span><span class="mh">0xa1a1a1a1a1a1a1a1a1a1a1a1a1a1a1a1</span><span class="p">,</span><span class="w"> </span><span class="o">-</span><span class="mi">6799976246779207263</span><span class="p">,</span><span class="w"> </span><span class="o">-</span><span class="mi">24159</span><span class="p">,</span><span class="w"> </span><span class="o">-</span><span class="mi">1583242847</span><span class="p">,</span><span class="w"> </span><span class="mh">0x7b7b7ba1a1a1a1a1a1a1a1a1a1a1a1a1</span><span class="p">,</span><span class="w"> </span><span class="mh">0x1</span><span class="p">.</span><span class="n">f6f6f6p119</span><span class="p">,</span><span class="w"> </span><span class="mh">0x4c4c7b7b7b7b7b7b7b7b7b7b7b7b7b7b</span><span class="p">,</span><span class="w"> </span><span class="mh">0xb0b06e00f1244c4c4c4c4c4c4c4c4c4c</span><span class="p">,</span><span class="w"> </span><span class="mh">0xe2a240000000b0b0b0b0b0b0b0b0b0b0</span><span class="p">,</span><span class="w"> </span><span class="o">-</span><span class="mi">113427455621981599237913610941852744401</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="o">-</span><span class="mi">6799976246779207263</span><span class="p">,</span><span class="w"> </span><span class="mh">0xe2a240000000b0b0b0b0b0b0b0b0b0b0</span><span class="p">,</span><span class="w"> </span><span class="mi">65535</span><span class="p">,</span><span class="w"> </span><span class="o">-</span><span class="mi">113427455621981599237913610941852744401</span><span class="p">,</span><span class="w"> </span><span class="o">-</span><span class="mi">113427455621981599237913610941852744401</span><span class="p">,</span><span class="w"> </span><span class="o">-</span><span class="mi">113427455621981599237913610941852744401</span><span class="p">,</span><span class="w"> </span><span class="mh">0xa1a1a1a1a1a1a1a1a1a1a1a1a1a1a1a1</span><span class="p">,</span><span class="w"> </span><span class="mh">0x1</span><span class="p">.</span><span class="n">f6f6f6p119</span><span class="p">,</span><span class="w"> </span><span class="o">-</span><span class="mi">113427455621981599237913610941852744401</span><span class="p">,</span><span class="w"> </span><span class="mh">0xb0b06e00f1244c4c4c4c4c4c4c4c4c4c</span><span class="p">,</span><span class="w"> </span><span class="mh">0xb0b06e00f1244c4c4c4c4c4c4c4c4c4c</span><span class="p">],</span><span class="w"> </span><span class="n">actual</span>: <span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="o">-</span><span class="mi">6799976246779207263</span><span class="p">,</span><span class="w"> </span><span class="mh">0xe2a240000000b0b0b0b0b0b0b0b0b0b0</span><span class="p">,</span><span class="w"> </span><span class="mi">65535</span><span class="p">,</span><span class="w"> </span><span class="mi">2583671442118339183427542988162351</span><span class="p">,</span><span class="w"> </span><span class="mi">2583671442118339183427542988162351</span><span class="p">,</span><span class="w"> </span><span class="mi">2583671442118339183427542988162351</span><span class="p">,</span><span class="w"> </span><span class="mh">0xa1a1a1a1a1a1a1a1a1a1a1a1a1a1a1a1</span><span class="p">,</span><span class="w"> </span><span class="mh">0x1</span><span class="p">.</span><span class="n">f6f6f6p119</span><span class="p">,</span><span class="w"> </span><span class="mi">2583671442118339183427542988162351</span><span class="p">,</span><span class="w"> </span><span class="mh">0xb0b06e00f1244c4c4c4c4c4c4c4c4c4c</span><span class="p">,</span><span class="w"> </span><span class="mh">0xb0b06e00f1244c4c4c4c4c4c4c4c4c4c</span><span class="p">]</span>
<span class="mi">1</span><span class="w"> </span><span class="n">tests</span>
<span class="n">Error</span>: <span class="mi">1</span><span class="w"> </span><span class="n">failure</span>
</code></pre></div>
<h3>Versions and Environment</h3>
<p>Cranelift version or commit: <code>main</code> (2d34b4657aa5290948da9a07cb31764a12c12994)<br>
Operating system: Linux<br>
Architecture: X86<br>
</p>
</blockquote>



<a name="369160785"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%236640%20Cranelift%3A%20Wrong%20result%20on%20%60tail%60%20.../near/369160785" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.236640.20Cranelift.3A.20Wrong.20result.20on.20.60tail.60.20.2E.2E.2E.html#369160785">(Jun 24 2023 at 11:52)</a>:</h4>
<p>afonso360 edited <a href="https://github.com/bytecodealliance/wasmtime/issues/6640">issue #6640</a>:</p>
<blockquote>
<p><span aria-label="wave" class="emoji emoji-1f44b" role="img" title="wave">:wave:</span> Hey,</p>
<p>Fuzzgen found this while I was working on something unrelated, but it reproduces on main.</p>
<p>The testcase passes if stack probing is disabled or if we remove the stack slots. Setting <code>probestack_size_log2=7</code> also makes the test pass, but any value below that makes it fail.</p>
<p>I've also tested on the other backends and they pass this test.</p>
<h3><code>.clif</code> Test Case</h3>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="n">test</span><span class="w"> </span><span class="n">interpret</span>
<span class="n">test</span><span class="w"> </span><span class="n">run</span>
<span class="n">set</span><span class="w"> </span><span class="n">enable_llvm_abi_extensions</span><span class="o">=</span><span class="kc">true</span>
<span class="n">set</span><span class="w"> </span><span class="n">probestack_size_log2</span><span class="o">=</span><span class="mi">6</span>
<span class="n">set</span><span class="w"> </span><span class="n">probestack_strategy</span><span class="o">=</span><span class="n">inline</span>
<span class="n">set</span><span class="w"> </span><span class="n">enable_probestack</span><span class="o">=</span><span class="kc">true</span>
<span class="n">target</span><span class="w"> </span><span class="n">x86_64</span>
<span class="n">target</span><span class="w"> </span><span class="n">aarch64</span>
<span class="n">target</span><span class="w"> </span><span class="n">riscv64gc</span><span class="w"> </span><span class="n">has_v</span>

<span class="n">function</span><span class="w"> </span><span class="o">%</span><span class="n">a</span><span class="p">(</span><span class="kt">i8</span><span class="p">,</span><span class="w"> </span><span class="kt">i8</span><span class="p">,</span><span class="w"> </span><span class="kt">i8</span><span class="p">,</span><span class="w"> </span><span class="kt">i8</span><span class="p">,</span><span class="w"> </span><span class="n">i16x8</span><span class="p">,</span><span class="w"> </span><span class="kt">i8</span><span class="p">,</span><span class="w"> </span><span class="n">i8x16</span><span class="p">,</span><span class="w"> </span><span class="kt">i64</span><span class="p">,</span><span class="w"> </span><span class="kt">i16</span><span class="p">,</span><span class="w"> </span><span class="kt">i32</span><span class="p">,</span><span class="w"> </span><span class="n">i16x8</span><span class="p">,</span><span class="w"> </span><span class="kt">f32</span><span class="p">,</span><span class="w"> </span><span class="n">i16x8</span><span class="p">,</span><span class="w"> </span><span class="n">i32x4</span><span class="p">,</span><span class="w"> </span><span class="n">i16x8</span><span class="p">,</span><span class="w"> </span><span class="kt">i128</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="kt">i8</span><span class="p">,</span><span class="w"> </span><span class="kt">i8</span><span class="p">,</span><span class="w"> </span><span class="kt">i64</span><span class="p">,</span><span class="w"> </span><span class="n">i16x8</span><span class="p">,</span><span class="w"> </span><span class="kt">i32</span><span class="p">,</span><span class="w"> </span><span class="kt">i128</span><span class="p">,</span><span class="w"> </span><span class="kt">i128</span><span class="p">,</span><span class="w"> </span><span class="kt">i128</span><span class="p">,</span><span class="w"> </span><span class="n">i8x16</span><span class="p">,</span><span class="w"> </span><span class="kt">f32</span><span class="p">,</span><span class="w"> </span><span class="kt">i128</span><span class="p">,</span><span class="w"> </span><span class="n">i32x4</span><span class="p">,</span><span class="w"> </span><span class="n">i32x4</span><span class="w"> </span><span class="n">tail</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">ss0</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">explicit_slot</span><span class="w"> </span><span class="mi">117</span>
<span class="w">    </span><span class="n">ss1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">explicit_slot</span><span class="w"> </span><span class="mi">49</span>
<span class="w">    </span><span class="n">ss2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">explicit_slot</span><span class="w"> </span><span class="mi">65</span>
<span class="w">    </span><span class="n">ss3</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">explicit_slot</span><span class="w"> </span><span class="mi">50</span>
<span class="w">    </span><span class="n">ss4</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">explicit_slot</span><span class="w"> </span><span class="mi">76</span>

<span class="n">block0</span><span class="p">(</span><span class="n">v0</span>: <span class="kt">i8</span><span class="p">,</span><span class="w"> </span><span class="n">v1</span>: <span class="kt">i8</span><span class="p">,</span><span class="w"> </span><span class="n">v2</span>: <span class="kt">i8</span><span class="p">,</span><span class="w"> </span><span class="n">v3</span>: <span class="kt">i8</span><span class="p">,</span><span class="w"> </span><span class="n">v4</span>: <span class="nc">i16x8</span><span class="p">,</span><span class="w"> </span><span class="n">v5</span>: <span class="kt">i8</span><span class="p">,</span><span class="w"> </span><span class="n">v6</span>: <span class="nc">i8x16</span><span class="p">,</span><span class="w"> </span><span class="n">v7</span>: <span class="kt">i64</span><span class="p">,</span><span class="w"> </span><span class="n">v8</span>: <span class="kt">i16</span><span class="p">,</span><span class="w"> </span><span class="n">v9</span>: <span class="kt">i32</span><span class="p">,</span><span class="w"> </span><span class="n">v10</span>: <span class="nc">i16x8</span><span class="p">,</span><span class="w"> </span><span class="n">v11</span>: <span class="kt">f32</span><span class="p">,</span><span class="w"> </span><span class="n">v12</span>: <span class="nc">i16x8</span><span class="p">,</span><span class="w"> </span><span class="n">v13</span>: <span class="nc">i32x4</span><span class="p">,</span><span class="w"> </span><span class="n">v14</span>: <span class="nc">i16x8</span><span class="p">,</span><span class="w"> </span><span class="n">v15</span>: <span class="kt">i128</span><span class="p">)</span>:
    <span class="nc">v32</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">bmask</span><span class="p">.</span><span class="kt">i16</span><span class="w"> </span><span class="n">v15</span>
<span class="w">    </span><span class="n">v33</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">uextend</span><span class="p">.</span><span class="kt">i32</span><span class="w"> </span><span class="n">v32</span>
<span class="w">    </span><span class="n">v40</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">bitrev</span><span class="w"> </span><span class="n">v7</span>
<span class="w">    </span><span class="n">v79</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">icmp</span><span class="w"> </span><span class="n">sge</span><span class="w"> </span><span class="n">v3</span><span class="p">,</span><span class="w"> </span><span class="n">v3</span>
<span class="w">    </span><span class="n">v84</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">bitrev</span><span class="w"> </span><span class="n">v40</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">v79</span><span class="p">,</span><span class="w"> </span><span class="n">v79</span><span class="p">,</span><span class="w"> </span><span class="n">v84</span><span class="p">,</span><span class="w"> </span><span class="n">v14</span><span class="p">,</span><span class="w"> </span><span class="n">v33</span><span class="p">,</span><span class="w"> </span><span class="n">v15</span><span class="p">,</span><span class="w"> </span><span class="n">v15</span><span class="p">,</span><span class="w"> </span><span class="n">v15</span><span class="p">,</span><span class="w"> </span><span class="n">v6</span><span class="p">,</span><span class="w"> </span><span class="n">v11</span><span class="p">,</span><span class="w"> </span><span class="n">v15</span><span class="p">,</span><span class="w"> </span><span class="n">v13</span><span class="p">,</span><span class="w"> </span><span class="n">v13</span>
<span class="p">}</span>

<span class="p">;</span><span class="w"> </span><span class="n">run</span>: <span class="o">%</span><span class="n">a</span><span class="p">(</span><span class="o">-</span><span class="mi">95</span><span class="p">,</span><span class="w"> </span><span class="o">-</span><span class="mi">95</span><span class="p">,</span><span class="w"> </span><span class="o">-</span><span class="mi">95</span><span class="p">,</span><span class="w"> </span><span class="o">-</span><span class="mi">95</span><span class="p">,</span><span class="w"> </span><span class="mh">0xa1a1a1a1a1a1a1a1a1a1a1a1a1a1a1a1</span><span class="p">,</span><span class="w"> </span><span class="o">-</span><span class="mi">95</span><span class="p">,</span><span class="w"> </span><span class="mh">0xa1a1a1a1a1a1a1a1a1a1a1a1a1a1a1a1</span><span class="p">,</span><span class="w"> </span><span class="o">-</span><span class="mi">6799976246779207263</span><span class="p">,</span><span class="w"> </span><span class="o">-</span><span class="mi">24159</span><span class="p">,</span><span class="w"> </span><span class="o">-</span><span class="mi">1583242847</span><span class="p">,</span><span class="w"> </span><span class="mh">0x7b7b7ba1a1a1a1a1a1a1a1a1a1a1a1a1</span><span class="p">,</span><span class="w"> </span><span class="mh">0x1</span><span class="p">.</span><span class="n">f6f6f6p119</span><span class="p">,</span><span class="w"> </span><span class="mh">0x4c4c7b7b7b7b7b7b7b7b7b7b7b7b7b7b</span><span class="p">,</span><span class="w"> </span><span class="mh">0xb0b06e00f1244c4c4c4c4c4c4c4c4c4c</span><span class="p">,</span><span class="w"> </span><span class="mh">0xe2a240000000b0b0b0b0b0b0b0b0b0b0</span><span class="p">,</span><span class="w"> </span><span class="o">-</span><span class="mi">113427455621981599237913610941852744401</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="o">-</span><span class="mi">6799976246779207263</span><span class="p">,</span><span class="w"> </span><span class="mh">0xe2a240000000b0b0b0b0b0b0b0b0b0b0</span><span class="p">,</span><span class="w"> </span><span class="mi">65535</span><span class="p">,</span><span class="w"> </span><span class="o">-</span><span class="mi">113427455621981599237913610941852744401</span><span class="p">,</span><span class="w"> </span><span class="o">-</span><span class="mi">113427455621981599237913610941852744401</span><span class="p">,</span><span class="w"> </span><span class="o">-</span><span class="mi">113427455621981599237913610941852744401</span><span class="p">,</span><span class="w"> </span><span class="mh">0xa1a1a1a1a1a1a1a1a1a1a1a1a1a1a1a1</span><span class="p">,</span><span class="w"> </span><span class="mh">0x1</span><span class="p">.</span><span class="n">f6f6f6p119</span><span class="p">,</span><span class="w"> </span><span class="o">-</span><span class="mi">113427455621981599237913610941852744401</span><span class="p">,</span><span class="w"> </span><span class="mh">0xb0b06e00f1244c4c4c4c4c4c4c4c4c4c</span><span class="p">,</span><span class="w"> </span><span class="mh">0xb0b06e00f1244c4c4c4c4c4c4c4c4c4c</span><span class="p">]</span>
</code></pre></div>
<h3>Steps to Reproduce</h3>
<ul>
<li><code>clif-util test ./the-above.clif</code> </li>
</ul>
<h3>Expected Results</h3>
<p>The test to pass.</p>
<h3>Actual Results</h3>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="w">     </span><span class="n">Running</span><span class="w"> </span><span class="err">`</span><span class="o">/</span><span class="n">home</span><span class="o">/</span><span class="n">afonso</span><span class="o">/</span><span class="n">git</span><span class="o">/</span><span class="n">wasmtime</span><span class="o">/</span><span class="n">target</span><span class="o">/</span><span class="n">debug</span><span class="o">/</span><span class="n">clif</span><span class="o">-</span><span class="n">util</span><span class="w"> </span><span class="n">test</span><span class="w"> </span><span class="p">.</span><span class="o">/</span><span class="n">lmao</span><span class="p">.</span><span class="n">clif</span><span class="err">`</span>
<span class="w"> </span><span class="n">ERROR</span><span class="w"> </span><span class="n">cranelift_filetests</span>::<span class="n">concurrent</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="n">FAIL</span>: <span class="nc">run</span>
<span class="n">FAIL</span><span class="w"> </span><span class="p">.</span><span class="o">/</span><span class="n">lmao</span><span class="p">.</span><span class="n">clif</span>: <span class="nc">run</span>

<span class="n">Caused</span><span class="w"> </span><span class="n">by</span>:
    <span class="nc">Failed</span><span class="w"> </span><span class="n">test</span>: <span class="nc">run</span>: <span class="o">%</span><span class="n">a</span><span class="p">(</span><span class="o">-</span><span class="mi">95</span><span class="p">,</span><span class="w"> </span><span class="o">-</span><span class="mi">95</span><span class="p">,</span><span class="w"> </span><span class="o">-</span><span class="mi">95</span><span class="p">,</span><span class="w"> </span><span class="o">-</span><span class="mi">95</span><span class="p">,</span><span class="w"> </span><span class="mh">0xa1a1a1a1a1a1a1a1a1a1a1a1a1a1a1a1</span><span class="p">,</span><span class="w"> </span><span class="o">-</span><span class="mi">95</span><span class="p">,</span><span class="w"> </span><span class="mh">0xa1a1a1a1a1a1a1a1a1a1a1a1a1a1a1a1</span><span class="p">,</span><span class="w"> </span><span class="o">-</span><span class="mi">6799976246779207263</span><span class="p">,</span><span class="w"> </span><span class="o">-</span><span class="mi">24159</span><span class="p">,</span><span class="w"> </span><span class="o">-</span><span class="mi">1583242847</span><span class="p">,</span><span class="w"> </span><span class="mh">0x7b7b7ba1a1a1a1a1a1a1a1a1a1a1a1a1</span><span class="p">,</span><span class="w"> </span><span class="mh">0x1</span><span class="p">.</span><span class="n">f6f6f6p119</span><span class="p">,</span><span class="w"> </span><span class="mh">0x4c4c7b7b7b7b7b7b7b7b7b7b7b7b7b7b</span><span class="p">,</span><span class="w"> </span><span class="mh">0xb0b06e00f1244c4c4c4c4c4c4c4c4c4c</span><span class="p">,</span><span class="w"> </span><span class="mh">0xe2a240000000b0b0b0b0b0b0b0b0b0b0</span><span class="p">,</span><span class="w"> </span><span class="o">-</span><span class="mi">113427455621981599237913610941852744401</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="o">-</span><span class="mi">6799976246779207263</span><span class="p">,</span><span class="w"> </span><span class="mh">0xe2a240000000b0b0b0b0b0b0b0b0b0b0</span><span class="p">,</span><span class="w"> </span><span class="mi">65535</span><span class="p">,</span><span class="w"> </span><span class="o">-</span><span class="mi">113427455621981599237913610941852744401</span><span class="p">,</span><span class="w"> </span><span class="o">-</span><span class="mi">113427455621981599237913610941852744401</span><span class="p">,</span><span class="w"> </span><span class="o">-</span><span class="mi">113427455621981599237913610941852744401</span><span class="p">,</span><span class="w"> </span><span class="mh">0xa1a1a1a1a1a1a1a1a1a1a1a1a1a1a1a1</span><span class="p">,</span><span class="w"> </span><span class="mh">0x1</span><span class="p">.</span><span class="n">f6f6f6p119</span><span class="p">,</span><span class="w"> </span><span class="o">-</span><span class="mi">113427455621981599237913610941852744401</span><span class="p">,</span><span class="w"> </span><span class="mh">0xb0b06e00f1244c4c4c4c4c4c4c4c4c4c</span><span class="p">,</span><span class="w"> </span><span class="mh">0xb0b06e00f1244c4c4c4c4c4c4c4c4c4c</span><span class="p">],</span><span class="w"> </span><span class="n">actual</span>: <span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="o">-</span><span class="mi">6799976246779207263</span><span class="p">,</span><span class="w"> </span><span class="mh">0xe2a240000000b0b0b0b0b0b0b0b0b0b0</span><span class="p">,</span><span class="w"> </span><span class="mi">65535</span><span class="p">,</span><span class="w"> </span><span class="mi">2583671442118339183427542988162351</span><span class="p">,</span><span class="w"> </span><span class="mi">2583671442118339183427542988162351</span><span class="p">,</span><span class="w"> </span><span class="mi">2583671442118339183427542988162351</span><span class="p">,</span><span class="w"> </span><span class="mh">0xa1a1a1a1a1a1a1a1a1a1a1a1a1a1a1a1</span><span class="p">,</span><span class="w"> </span><span class="mh">0x1</span><span class="p">.</span><span class="n">f6f6f6p119</span><span class="p">,</span><span class="w"> </span><span class="mi">2583671442118339183427542988162351</span><span class="p">,</span><span class="w"> </span><span class="mh">0xb0b06e00f1244c4c4c4c4c4c4c4c4c4c</span><span class="p">,</span><span class="w"> </span><span class="mh">0xb0b06e00f1244c4c4c4c4c4c4c4c4c4c</span><span class="p">]</span>
<span class="mi">1</span><span class="w"> </span><span class="n">tests</span>
<span class="n">Error</span>: <span class="mi">1</span><span class="w"> </span><span class="n">failure</span>
</code></pre></div>
<h3>Versions and Environment</h3>
<p>Cranelift version or commit: <code>main</code> (2d34b4657aa5290948da9a07cb31764a12c12994)<br>
Operating system: Linux<br>
Architecture: X86<br>
</p>
</blockquote>



<a name="369162196"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%236640%20Cranelift%3A%20Wrong%20result%20on%20%60tail%60%20.../near/369162196" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.236640.20Cranelift.3A.20Wrong.20result.20on.20.60tail.60.20.2E.2E.2E.html#369162196">(Jun 24 2023 at 11:58)</a>:</h4>
<p>afonso360 labeled <a href="https://github.com/bytecodealliance/wasmtime/issues/6640">issue #6640</a>:</p>
<blockquote>
<p><span aria-label="wave" class="emoji emoji-1f44b" role="img" title="wave">:wave:</span> Hey,</p>
<p>Fuzzgen found this while I was working on something unrelated, but it reproduces on main.</p>
<p>The testcase passes if stack probing is disabled or if we remove the stack slots. Setting <code>probestack_size_log2=7</code> also makes the test pass, but any value below that makes it fail.</p>
<p>I've also tested on the other backends and they pass this test.</p>
<h3><code>.clif</code> Test Case</h3>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="n">test</span><span class="w"> </span><span class="n">interpret</span>
<span class="n">test</span><span class="w"> </span><span class="n">run</span>
<span class="n">set</span><span class="w"> </span><span class="n">enable_llvm_abi_extensions</span><span class="o">=</span><span class="kc">true</span>
<span class="n">set</span><span class="w"> </span><span class="n">probestack_size_log2</span><span class="o">=</span><span class="mi">6</span>
<span class="n">set</span><span class="w"> </span><span class="n">probestack_strategy</span><span class="o">=</span><span class="n">inline</span>
<span class="n">set</span><span class="w"> </span><span class="n">enable_probestack</span><span class="o">=</span><span class="kc">true</span>
<span class="n">target</span><span class="w"> </span><span class="n">x86_64</span>
<span class="n">target</span><span class="w"> </span><span class="n">aarch64</span>
<span class="n">target</span><span class="w"> </span><span class="n">riscv64gc</span><span class="w"> </span><span class="n">has_v</span>

<span class="n">function</span><span class="w"> </span><span class="o">%</span><span class="n">a</span><span class="p">(</span><span class="kt">i8</span><span class="p">,</span><span class="w"> </span><span class="kt">i8</span><span class="p">,</span><span class="w"> </span><span class="kt">i8</span><span class="p">,</span><span class="w"> </span><span class="kt">i8</span><span class="p">,</span><span class="w"> </span><span class="n">i16x8</span><span class="p">,</span><span class="w"> </span><span class="kt">i8</span><span class="p">,</span><span class="w"> </span><span class="n">i8x16</span><span class="p">,</span><span class="w"> </span><span class="kt">i64</span><span class="p">,</span><span class="w"> </span><span class="kt">i16</span><span class="p">,</span><span class="w"> </span><span class="kt">i32</span><span class="p">,</span><span class="w"> </span><span class="n">i16x8</span><span class="p">,</span><span class="w"> </span><span class="kt">f32</span><span class="p">,</span><span class="w"> </span><span class="n">i16x8</span><span class="p">,</span><span class="w"> </span><span class="n">i32x4</span><span class="p">,</span><span class="w"> </span><span class="n">i16x8</span><span class="p">,</span><span class="w"> </span><span class="kt">i128</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="kt">i8</span><span class="p">,</span><span class="w"> </span><span class="kt">i8</span><span class="p">,</span><span class="w"> </span><span class="kt">i64</span><span class="p">,</span><span class="w"> </span><span class="n">i16x8</span><span class="p">,</span><span class="w"> </span><span class="kt">i32</span><span class="p">,</span><span class="w"> </span><span class="kt">i128</span><span class="p">,</span><span class="w"> </span><span class="kt">i128</span><span class="p">,</span><span class="w"> </span><span class="kt">i128</span><span class="p">,</span><span class="w"> </span><span class="n">i8x16</span><span class="p">,</span><span class="w"> </span><span class="kt">f32</span><span class="p">,</span><span class="w"> </span><span class="kt">i128</span><span class="p">,</span><span class="w"> </span><span class="n">i32x4</span><span class="p">,</span><span class="w"> </span><span class="n">i32x4</span><span class="w"> </span><span class="n">tail</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">ss0</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">explicit_slot</span><span class="w"> </span><span class="mi">117</span>
<span class="w">    </span><span class="n">ss1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">explicit_slot</span><span class="w"> </span><span class="mi">49</span>
<span class="w">    </span><span class="n">ss2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">explicit_slot</span><span class="w"> </span><span class="mi">65</span>
<span class="w">    </span><span class="n">ss3</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">explicit_slot</span><span class="w"> </span><span class="mi">50</span>
<span class="w">    </span><span class="n">ss4</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">explicit_slot</span><span class="w"> </span><span class="mi">76</span>

<span class="n">block0</span><span class="p">(</span><span class="n">v0</span>: <span class="kt">i8</span><span class="p">,</span><span class="w"> </span><span class="n">v1</span>: <span class="kt">i8</span><span class="p">,</span><span class="w"> </span><span class="n">v2</span>: <span class="kt">i8</span><span class="p">,</span><span class="w"> </span><span class="n">v3</span>: <span class="kt">i8</span><span class="p">,</span><span class="w"> </span><span class="n">v4</span>: <span class="nc">i16x8</span><span class="p">,</span><span class="w"> </span><span class="n">v5</span>: <span class="kt">i8</span><span class="p">,</span><span class="w"> </span><span class="n">v6</span>: <span class="nc">i8x16</span><span class="p">,</span><span class="w"> </span><span class="n">v7</span>: <span class="kt">i64</span><span class="p">,</span><span class="w"> </span><span class="n">v8</span>: <span class="kt">i16</span><span class="p">,</span><span class="w"> </span><span class="n">v9</span>: <span class="kt">i32</span><span class="p">,</span><span class="w"> </span><span class="n">v10</span>: <span class="nc">i16x8</span><span class="p">,</span><span class="w"> </span><span class="n">v11</span>: <span class="kt">f32</span><span class="p">,</span><span class="w"> </span><span class="n">v12</span>: <span class="nc">i16x8</span><span class="p">,</span><span class="w"> </span><span class="n">v13</span>: <span class="nc">i32x4</span><span class="p">,</span><span class="w"> </span><span class="n">v14</span>: <span class="nc">i16x8</span><span class="p">,</span><span class="w"> </span><span class="n">v15</span>: <span class="kt">i128</span><span class="p">)</span>:
    <span class="nc">v32</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">bmask</span><span class="p">.</span><span class="kt">i16</span><span class="w"> </span><span class="n">v15</span>
<span class="w">    </span><span class="n">v33</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">uextend</span><span class="p">.</span><span class="kt">i32</span><span class="w"> </span><span class="n">v32</span>
<span class="w">    </span><span class="n">v40</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">bitrev</span><span class="w"> </span><span class="n">v7</span>
<span class="w">    </span><span class="n">v79</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">icmp</span><span class="w"> </span><span class="n">sge</span><span class="w"> </span><span class="n">v3</span><span class="p">,</span><span class="w"> </span><span class="n">v3</span>
<span class="w">    </span><span class="n">v84</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">bitrev</span><span class="w"> </span><span class="n">v40</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">v79</span><span class="p">,</span><span class="w"> </span><span class="n">v79</span><span class="p">,</span><span class="w"> </span><span class="n">v84</span><span class="p">,</span><span class="w"> </span><span class="n">v14</span><span class="p">,</span><span class="w"> </span><span class="n">v33</span><span class="p">,</span><span class="w"> </span><span class="n">v15</span><span class="p">,</span><span class="w"> </span><span class="n">v15</span><span class="p">,</span><span class="w"> </span><span class="n">v15</span><span class="p">,</span><span class="w"> </span><span class="n">v6</span><span class="p">,</span><span class="w"> </span><span class="n">v11</span><span class="p">,</span><span class="w"> </span><span class="n">v15</span><span class="p">,</span><span class="w"> </span><span class="n">v13</span><span class="p">,</span><span class="w"> </span><span class="n">v13</span>
<span class="p">}</span>

<span class="p">;</span><span class="w"> </span><span class="n">run</span>: <span class="o">%</span><span class="n">a</span><span class="p">(</span><span class="o">-</span><span class="mi">95</span><span class="p">,</span><span class="w"> </span><span class="o">-</span><span class="mi">95</span><span class="p">,</span><span class="w"> </span><span class="o">-</span><span class="mi">95</span><span class="p">,</span><span class="w"> </span><span class="o">-</span><span class="mi">95</span><span class="p">,</span><span class="w"> </span><span class="mh">0xa1a1a1a1a1a1a1a1a1a1a1a1a1a1a1a1</span><span class="p">,</span><span class="w"> </span><span class="o">-</span><span class="mi">95</span><span class="p">,</span><span class="w"> </span><span class="mh">0xa1a1a1a1a1a1a1a1a1a1a1a1a1a1a1a1</span><span class="p">,</span><span class="w"> </span><span class="o">-</span><span class="mi">6799976246779207263</span><span class="p">,</span><span class="w"> </span><span class="o">-</span><span class="mi">24159</span><span class="p">,</span><span class="w"> </span><span class="o">-</span><span class="mi">1583242847</span><span class="p">,</span><span class="w"> </span><span class="mh">0x7b7b7ba1a1a1a1a1a1a1a1a1a1a1a1a1</span><span class="p">,</span><span class="w"> </span><span class="mh">0x1</span><span class="p">.</span><span class="n">f6f6f6p119</span><span class="p">,</span><span class="w"> </span><span class="mh">0x4c4c7b7b7b7b7b7b7b7b7b7b7b7b7b7b</span><span class="p">,</span><span class="w"> </span><span class="mh">0xb0b06e00f1244c4c4c4c4c4c4c4c4c4c</span><span class="p">,</span><span class="w"> </span><span class="mh">0xe2a240000000b0b0b0b0b0b0b0b0b0b0</span><span class="p">,</span><span class="w"> </span><span class="o">-</span><span class="mi">113427455621981599237913610941852744401</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="o">-</span><span class="mi">6799976246779207263</span><span class="p">,</span><span class="w"> </span><span class="mh">0xe2a240000000b0b0b0b0b0b0b0b0b0b0</span><span class="p">,</span><span class="w"> </span><span class="mi">65535</span><span class="p">,</span><span class="w"> </span><span class="o">-</span><span class="mi">113427455621981599237913610941852744401</span><span class="p">,</span><span class="w"> </span><span class="o">-</span><span class="mi">113427455621981599237913610941852744401</span><span class="p">,</span><span class="w"> </span><span class="o">-</span><span class="mi">113427455621981599237913610941852744401</span><span class="p">,</span><span class="w"> </span><span class="mh">0xa1a1a1a1a1a1a1a1a1a1a1a1a1a1a1a1</span><span class="p">,</span><span class="w"> </span><span class="mh">0x1</span><span class="p">.</span><span class="n">f6f6f6p119</span><span class="p">,</span><span class="w"> </span><span class="o">-</span><span class="mi">113427455621981599237913610941852744401</span><span class="p">,</span><span class="w"> </span><span class="mh">0xb0b06e00f1244c4c4c4c4c4c4c4c4c4c</span><span class="p">,</span><span class="w"> </span><span class="mh">0xb0b06e00f1244c4c4c4c4c4c4c4c4c4c</span><span class="p">]</span>
</code></pre></div>
<h3>Steps to Reproduce</h3>
<ul>
<li><code>clif-util test ./the-above.clif</code> </li>
</ul>
<h3>Expected Results</h3>
<p>The test to pass.</p>
<h3>Actual Results</h3>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="w">     </span><span class="n">Running</span><span class="w"> </span><span class="err">`</span><span class="o">/</span><span class="n">home</span><span class="o">/</span><span class="n">afonso</span><span class="o">/</span><span class="n">git</span><span class="o">/</span><span class="n">wasmtime</span><span class="o">/</span><span class="n">target</span><span class="o">/</span><span class="n">debug</span><span class="o">/</span><span class="n">clif</span><span class="o">-</span><span class="n">util</span><span class="w"> </span><span class="n">test</span><span class="w"> </span><span class="p">.</span><span class="o">/</span><span class="n">lmao</span><span class="p">.</span><span class="n">clif</span><span class="err">`</span>
<span class="w"> </span><span class="n">ERROR</span><span class="w"> </span><span class="n">cranelift_filetests</span>::<span class="n">concurrent</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="n">FAIL</span>: <span class="nc">run</span>
<span class="n">FAIL</span><span class="w"> </span><span class="p">.</span><span class="o">/</span><span class="n">lmao</span><span class="p">.</span><span class="n">clif</span>: <span class="nc">run</span>

<span class="n">Caused</span><span class="w"> </span><span class="n">by</span>:
    <span class="nc">Failed</span><span class="w"> </span><span class="n">test</span>: <span class="nc">run</span>: <span class="o">%</span><span class="n">a</span><span class="p">(</span><span class="o">-</span><span class="mi">95</span><span class="p">,</span><span class="w"> </span><span class="o">-</span><span class="mi">95</span><span class="p">,</span><span class="w"> </span><span class="o">-</span><span class="mi">95</span><span class="p">,</span><span class="w"> </span><span class="o">-</span><span class="mi">95</span><span class="p">,</span><span class="w"> </span><span class="mh">0xa1a1a1a1a1a1a1a1a1a1a1a1a1a1a1a1</span><span class="p">,</span><span class="w"> </span><span class="o">-</span><span class="mi">95</span><span class="p">,</span><span class="w"> </span><span class="mh">0xa1a1a1a1a1a1a1a1a1a1a1a1a1a1a1a1</span><span class="p">,</span><span class="w"> </span><span class="o">-</span><span class="mi">6799976246779207263</span><span class="p">,</span><span class="w"> </span><span class="o">-</span><span class="mi">24159</span><span class="p">,</span><span class="w"> </span><span class="o">-</span><span class="mi">1583242847</span><span class="p">,</span><span class="w"> </span><span class="mh">0x7b7b7ba1a1a1a1a1a1a1a1a1a1a1a1a1</span><span class="p">,</span><span class="w"> </span><span class="mh">0x1</span><span class="p">.</span><span class="n">f6f6f6p119</span><span class="p">,</span><span class="w"> </span><span class="mh">0x4c4c7b7b7b7b7b7b7b7b7b7b7b7b7b7b</span><span class="p">,</span><span class="w"> </span><span class="mh">0xb0b06e00f1244c4c4c4c4c4c4c4c4c4c</span><span class="p">,</span><span class="w"> </span><span class="mh">0xe2a240000000b0b0b0b0b0b0b0b0b0b0</span><span class="p">,</span><span class="w"> </span><span class="o">-</span><span class="mi">113427455621981599237913610941852744401</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="o">-</span><span class="mi">6799976246779207263</span><span class="p">,</span><span class="w"> </span><span class="mh">0xe2a240000000b0b0b0b0b0b0b0b0b0b0</span><span class="p">,</span><span class="w"> </span><span class="mi">65535</span><span class="p">,</span><span class="w"> </span><span class="o">-</span><span class="mi">113427455621981599237913610941852744401</span><span class="p">,</span><span class="w"> </span><span class="o">-</span><span class="mi">113427455621981599237913610941852744401</span><span class="p">,</span><span class="w"> </span><span class="o">-</span><span class="mi">113427455621981599237913610941852744401</span><span class="p">,</span><span class="w"> </span><span class="mh">0xa1a1a1a1a1a1a1a1a1a1a1a1a1a1a1a1</span><span class="p">,</span><span class="w"> </span><span class="mh">0x1</span><span class="p">.</span><span class="n">f6f6f6p119</span><span class="p">,</span><span class="w"> </span><span class="o">-</span><span class="mi">113427455621981599237913610941852744401</span><span class="p">,</span><span class="w"> </span><span class="mh">0xb0b06e00f1244c4c4c4c4c4c4c4c4c4c</span><span class="p">,</span><span class="w"> </span><span class="mh">0xb0b06e00f1244c4c4c4c4c4c4c4c4c4c</span><span class="p">],</span><span class="w"> </span><span class="n">actual</span>: <span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="o">-</span><span class="mi">6799976246779207263</span><span class="p">,</span><span class="w"> </span><span class="mh">0xe2a240000000b0b0b0b0b0b0b0b0b0b0</span><span class="p">,</span><span class="w"> </span><span class="mi">65535</span><span class="p">,</span><span class="w"> </span><span class="mi">2583671442118339183427542988162351</span><span class="p">,</span><span class="w"> </span><span class="mi">2583671442118339183427542988162351</span><span class="p">,</span><span class="w"> </span><span class="mi">2583671442118339183427542988162351</span><span class="p">,</span><span class="w"> </span><span class="mh">0xa1a1a1a1a1a1a1a1a1a1a1a1a1a1a1a1</span><span class="p">,</span><span class="w"> </span><span class="mh">0x1</span><span class="p">.</span><span class="n">f6f6f6p119</span><span class="p">,</span><span class="w"> </span><span class="mi">2583671442118339183427542988162351</span><span class="p">,</span><span class="w"> </span><span class="mh">0xb0b06e00f1244c4c4c4c4c4c4c4c4c4c</span><span class="p">,</span><span class="w"> </span><span class="mh">0xb0b06e00f1244c4c4c4c4c4c4c4c4c4c</span><span class="p">]</span>
<span class="mi">1</span><span class="w"> </span><span class="n">tests</span>
<span class="n">Error</span>: <span class="mi">1</span><span class="w"> </span><span class="n">failure</span>
</code></pre></div>
<h3>Versions and Environment</h3>
<p>Cranelift version or commit: <code>main</code> (2d34b4657aa5290948da9a07cb31764a12c12994)<br>
Operating system: Linux<br>
Architecture: X86<br>
</p>
</blockquote>



<a name="369162507"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%236640%20Cranelift%3A%20Wrong%20result%20on%20%60tail%60%20.../near/369162507" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.236640.20Cranelift.3A.20Wrong.20result.20on.20.60tail.60.20.2E.2E.2E.html#369162507">(Jun 24 2023 at 11:59)</a>:</h4>
<p>afonso360 edited <a href="https://github.com/bytecodealliance/wasmtime/issues/6640">issue #6640</a>:</p>
<blockquote>
<p><span aria-label="wave" class="emoji emoji-1f44b" role="img" title="wave">:wave:</span> Hey,</p>
<p>Fuzzgen found this while I was working on something unrelated, but it reproduces on main.</p>
<p>The testcase passes if stack probing is disabled or if we remove the stack slots. Setting <code>probestack_size_log2=7</code> also makes the test pass, but any value below that makes it fail.</p>
<p>I've also tested on the other backends and they pass this test.</p>
<h3><code>.clif</code> Test Case</h3>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="n">test</span><span class="w"> </span><span class="n">interpret</span>
<span class="n">test</span><span class="w"> </span><span class="n">run</span>
<span class="n">set</span><span class="w"> </span><span class="n">enable_llvm_abi_extensions</span><span class="o">=</span><span class="kc">true</span>
<span class="n">set</span><span class="w"> </span><span class="n">probestack_size_log2</span><span class="o">=</span><span class="mi">6</span>
<span class="n">set</span><span class="w"> </span><span class="n">probestack_strategy</span><span class="o">=</span><span class="n">inline</span>
<span class="n">set</span><span class="w"> </span><span class="n">enable_probestack</span><span class="o">=</span><span class="kc">true</span>
<span class="n">target</span><span class="w"> </span><span class="n">x86_64</span>
<span class="n">target</span><span class="w"> </span><span class="n">aarch64</span>
<span class="n">target</span><span class="w"> </span><span class="n">riscv64gc</span><span class="w"> </span><span class="n">has_v</span>

<span class="n">function</span><span class="w"> </span><span class="o">%</span><span class="n">a</span><span class="p">(</span><span class="kt">i8</span><span class="p">,</span><span class="w"> </span><span class="kt">i8</span><span class="p">,</span><span class="w"> </span><span class="kt">i8</span><span class="p">,</span><span class="w"> </span><span class="kt">i8</span><span class="p">,</span><span class="w"> </span><span class="n">i16x8</span><span class="p">,</span><span class="w"> </span><span class="kt">i8</span><span class="p">,</span><span class="w"> </span><span class="n">i8x16</span><span class="p">,</span><span class="w"> </span><span class="kt">i64</span><span class="p">,</span><span class="w"> </span><span class="kt">i16</span><span class="p">,</span><span class="w"> </span><span class="kt">i32</span><span class="p">,</span><span class="w"> </span><span class="n">i16x8</span><span class="p">,</span><span class="w"> </span><span class="kt">f32</span><span class="p">,</span><span class="w"> </span><span class="n">i16x8</span><span class="p">,</span><span class="w"> </span><span class="n">i32x4</span><span class="p">,</span><span class="w"> </span><span class="n">i16x8</span><span class="p">,</span><span class="w"> </span><span class="kt">i128</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="kt">i8</span><span class="p">,</span><span class="w"> </span><span class="kt">i8</span><span class="p">,</span><span class="w"> </span><span class="kt">i64</span><span class="p">,</span><span class="w"> </span><span class="n">i16x8</span><span class="p">,</span><span class="w"> </span><span class="kt">i32</span><span class="p">,</span><span class="w"> </span><span class="kt">i128</span><span class="p">,</span><span class="w"> </span><span class="kt">i128</span><span class="p">,</span><span class="w"> </span><span class="kt">i128</span><span class="p">,</span><span class="w"> </span><span class="n">i8x16</span><span class="p">,</span><span class="w"> </span><span class="kt">f32</span><span class="p">,</span><span class="w"> </span><span class="kt">i128</span><span class="p">,</span><span class="w"> </span><span class="n">i32x4</span><span class="p">,</span><span class="w"> </span><span class="n">i32x4</span><span class="w"> </span><span class="n">tail</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">ss0</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">explicit_slot</span><span class="w"> </span><span class="mi">117</span>
<span class="w">    </span><span class="n">ss1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">explicit_slot</span><span class="w"> </span><span class="mi">49</span>
<span class="w">    </span><span class="n">ss2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">explicit_slot</span><span class="w"> </span><span class="mi">65</span>
<span class="w">    </span><span class="n">ss3</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">explicit_slot</span><span class="w"> </span><span class="mi">50</span>
<span class="w">    </span><span class="n">ss4</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">explicit_slot</span><span class="w"> </span><span class="mi">76</span>

<span class="n">block0</span><span class="p">(</span><span class="n">v0</span>: <span class="kt">i8</span><span class="p">,</span><span class="w"> </span><span class="n">v1</span>: <span class="kt">i8</span><span class="p">,</span><span class="w"> </span><span class="n">v2</span>: <span class="kt">i8</span><span class="p">,</span><span class="w"> </span><span class="n">v3</span>: <span class="kt">i8</span><span class="p">,</span><span class="w"> </span><span class="n">v4</span>: <span class="nc">i16x8</span><span class="p">,</span><span class="w"> </span><span class="n">v5</span>: <span class="kt">i8</span><span class="p">,</span><span class="w"> </span><span class="n">v6</span>: <span class="nc">i8x16</span><span class="p">,</span><span class="w"> </span><span class="n">v7</span>: <span class="kt">i64</span><span class="p">,</span><span class="w"> </span><span class="n">v8</span>: <span class="kt">i16</span><span class="p">,</span><span class="w"> </span><span class="n">v9</span>: <span class="kt">i32</span><span class="p">,</span><span class="w"> </span><span class="n">v10</span>: <span class="nc">i16x8</span><span class="p">,</span><span class="w"> </span><span class="n">v11</span>: <span class="kt">f32</span><span class="p">,</span><span class="w"> </span><span class="n">v12</span>: <span class="nc">i16x8</span><span class="p">,</span><span class="w"> </span><span class="n">v13</span>: <span class="nc">i32x4</span><span class="p">,</span><span class="w"> </span><span class="n">v14</span>: <span class="nc">i16x8</span><span class="p">,</span><span class="w"> </span><span class="n">v15</span>: <span class="kt">i128</span><span class="p">)</span>:
    <span class="nc">v32</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">bmask</span><span class="p">.</span><span class="kt">i16</span><span class="w"> </span><span class="n">v15</span>
<span class="w">    </span><span class="n">v33</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">uextend</span><span class="p">.</span><span class="kt">i32</span><span class="w"> </span><span class="n">v32</span>
<span class="w">    </span><span class="n">v40</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">bitrev</span><span class="w"> </span><span class="n">v7</span>
<span class="w">    </span><span class="n">v79</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">icmp</span><span class="w"> </span><span class="n">sge</span><span class="w"> </span><span class="n">v3</span><span class="p">,</span><span class="w"> </span><span class="n">v3</span>
<span class="w">    </span><span class="n">v84</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">bitrev</span><span class="w"> </span><span class="n">v40</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">v79</span><span class="p">,</span><span class="w"> </span><span class="n">v79</span><span class="p">,</span><span class="w"> </span><span class="n">v84</span><span class="p">,</span><span class="w"> </span><span class="n">v14</span><span class="p">,</span><span class="w"> </span><span class="n">v33</span><span class="p">,</span><span class="w"> </span><span class="n">v15</span><span class="p">,</span><span class="w"> </span><span class="n">v15</span><span class="p">,</span><span class="w"> </span><span class="n">v15</span><span class="p">,</span><span class="w"> </span><span class="n">v6</span><span class="p">,</span><span class="w"> </span><span class="n">v11</span><span class="p">,</span><span class="w"> </span><span class="n">v15</span><span class="p">,</span><span class="w"> </span><span class="n">v13</span><span class="p">,</span><span class="w"> </span><span class="n">v13</span>
<span class="p">}</span>

<span class="p">;</span><span class="w"> </span><span class="n">run</span>: <span class="o">%</span><span class="n">a</span><span class="p">(</span><span class="o">-</span><span class="mi">95</span><span class="p">,</span><span class="w"> </span><span class="o">-</span><span class="mi">95</span><span class="p">,</span><span class="w"> </span><span class="o">-</span><span class="mi">95</span><span class="p">,</span><span class="w"> </span><span class="o">-</span><span class="mi">95</span><span class="p">,</span><span class="w"> </span><span class="mh">0xa1a1a1a1a1a1a1a1a1a1a1a1a1a1a1a1</span><span class="p">,</span><span class="w"> </span><span class="o">-</span><span class="mi">95</span><span class="p">,</span><span class="w"> </span><span class="mh">0xa1a1a1a1a1a1a1a1a1a1a1a1a1a1a1a1</span><span class="p">,</span><span class="w"> </span><span class="o">-</span><span class="mi">6799976246779207263</span><span class="p">,</span><span class="w"> </span><span class="o">-</span><span class="mi">24159</span><span class="p">,</span><span class="w"> </span><span class="o">-</span><span class="mi">1583242847</span><span class="p">,</span><span class="w"> </span><span class="mh">0x7b7b7ba1a1a1a1a1a1a1a1a1a1a1a1a1</span><span class="p">,</span><span class="w"> </span><span class="mh">0x1</span><span class="p">.</span><span class="n">f6f6f6p119</span><span class="p">,</span><span class="w"> </span><span class="mh">0x4c4c7b7b7b7b7b7b7b7b7b7b7b7b7b7b</span><span class="p">,</span><span class="w"> </span><span class="mh">0xb0b06e00f1244c4c4c4c4c4c4c4c4c4c</span><span class="p">,</span><span class="w"> </span><span class="mh">0xe2a240000000b0b0b0b0b0b0b0b0b0b0</span><span class="p">,</span><span class="w"> </span><span class="o">-</span><span class="mi">113427455621981599237913610941852744401</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="o">-</span><span class="mi">6799976246779207263</span><span class="p">,</span><span class="w"> </span><span class="mh">0xe2a240000000b0b0b0b0b0b0b0b0b0b0</span><span class="p">,</span><span class="w"> </span><span class="mi">65535</span><span class="p">,</span><span class="w"> </span><span class="o">-</span><span class="mi">113427455621981599237913610941852744401</span><span class="p">,</span><span class="w"> </span><span class="o">-</span><span class="mi">113427455621981599237913610941852744401</span><span class="p">,</span><span class="w"> </span><span class="o">-</span><span class="mi">113427455621981599237913610941852744401</span><span class="p">,</span><span class="w"> </span><span class="mh">0xa1a1a1a1a1a1a1a1a1a1a1a1a1a1a1a1</span><span class="p">,</span><span class="w"> </span><span class="mh">0x1</span><span class="p">.</span><span class="n">f6f6f6p119</span><span class="p">,</span><span class="w"> </span><span class="o">-</span><span class="mi">113427455621981599237913610941852744401</span><span class="p">,</span><span class="w"> </span><span class="mh">0xb0b06e00f1244c4c4c4c4c4c4c4c4c4c</span><span class="p">,</span><span class="w"> </span><span class="mh">0xb0b06e00f1244c4c4c4c4c4c4c4c4c4c</span><span class="p">]</span>
</code></pre></div>
<h3>Steps to Reproduce</h3>
<ul>
<li><code>clif-util test ./the-above.clif</code> </li>
</ul>
<h3>Expected Results</h3>
<p>The test to pass.</p>
<h3>Actual Results</h3>
<p>The value that is wrong here is <code>v15</code></p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="w">     </span><span class="n">Running</span><span class="w"> </span><span class="err">`</span><span class="o">/</span><span class="n">home</span><span class="o">/</span><span class="n">afonso</span><span class="o">/</span><span class="n">git</span><span class="o">/</span><span class="n">wasmtime</span><span class="o">/</span><span class="n">target</span><span class="o">/</span><span class="n">debug</span><span class="o">/</span><span class="n">clif</span><span class="o">-</span><span class="n">util</span><span class="w"> </span><span class="n">test</span><span class="w"> </span><span class="p">.</span><span class="o">/</span><span class="n">lmao</span><span class="p">.</span><span class="n">clif</span><span class="err">`</span>
<span class="w"> </span><span class="n">ERROR</span><span class="w"> </span><span class="n">cranelift_filetests</span>::<span class="n">concurrent</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="n">FAIL</span>: <span class="nc">run</span>
<span class="n">FAIL</span><span class="w"> </span><span class="p">.</span><span class="o">/</span><span class="n">lmao</span><span class="p">.</span><span class="n">clif</span>: <span class="nc">run</span>

<span class="n">Caused</span><span class="w"> </span><span class="n">by</span>:
    <span class="nc">Failed</span><span class="w"> </span><span class="n">test</span>: <span class="nc">run</span>: <span class="o">%</span><span class="n">a</span><span class="p">(</span><span class="o">-</span><span class="mi">95</span><span class="p">,</span><span class="w"> </span><span class="o">-</span><span class="mi">95</span><span class="p">,</span><span class="w"> </span><span class="o">-</span><span class="mi">95</span><span class="p">,</span><span class="w"> </span><span class="o">-</span><span class="mi">95</span><span class="p">,</span><span class="w"> </span><span class="mh">0xa1a1a1a1a1a1a1a1a1a1a1a1a1a1a1a1</span><span class="p">,</span><span class="w"> </span><span class="o">-</span><span class="mi">95</span><span class="p">,</span><span class="w"> </span><span class="mh">0xa1a1a1a1a1a1a1a1a1a1a1a1a1a1a1a1</span><span class="p">,</span><span class="w"> </span><span class="o">-</span><span class="mi">6799976246779207263</span><span class="p">,</span><span class="w"> </span><span class="o">-</span><span class="mi">24159</span><span class="p">,</span><span class="w"> </span><span class="o">-</span><span class="mi">1583242847</span><span class="p">,</span><span class="w"> </span><span class="mh">0x7b7b7ba1a1a1a1a1a1a1a1a1a1a1a1a1</span><span class="p">,</span><span class="w"> </span><span class="mh">0x1</span><span class="p">.</span><span class="n">f6f6f6p119</span><span class="p">,</span><span class="w"> </span><span class="mh">0x4c4c7b7b7b7b7b7b7b7b7b7b7b7b7b7b</span><span class="p">,</span><span class="w"> </span><span class="mh">0xb0b06e00f1244c4c4c4c4c4c4c4c4c4c</span><span class="p">,</span><span class="w"> </span><span class="mh">0xe2a240000000b0b0b0b0b0b0b0b0b0b0</span><span class="p">,</span><span class="w"> </span><span class="o">-</span><span class="mi">113427455621981599237913610941852744401</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="o">-</span><span class="mi">6799976246779207263</span><span class="p">,</span><span class="w"> </span><span class="mh">0xe2a240000000b0b0b0b0b0b0b0b0b0b0</span><span class="p">,</span><span class="w"> </span><span class="mi">65535</span><span class="p">,</span><span class="w"> </span><span class="o">-</span><span class="mi">113427455621981599237913610941852744401</span><span class="p">,</span><span class="w"> </span><span class="o">-</span><span class="mi">113427455621981599237913610941852744401</span><span class="p">,</span><span class="w"> </span><span class="o">-</span><span class="mi">113427455621981599237913610941852744401</span><span class="p">,</span><span class="w"> </span><span class="mh">0xa1a1a1a1a1a1a1a1a1a1a1a1a1a1a1a1</span><span class="p">,</span><span class="w"> </span><span class="mh">0x1</span><span class="p">.</span><span class="n">f6f6f6p119</span><span class="p">,</span><span class="w"> </span><span class="o">-</span><span class="mi">113427455621981599237913610941852744401</span><span class="p">,</span><span class="w"> </span><span class="mh">0xb0b06e00f1244c4c4c4c4c4c4c4c4c4c</span><span class="p">,</span><span class="w"> </span><span class="mh">0xb0b06e00f1244c4c4c4c4c4c4c4c4c4c</span><span class="p">],</span><span class="w"> </span><span class="n">actual</span>: <span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="o">-</span><span class="mi">6799976246779207263</span><span class="p">,</span><span class="w"> </span><span class="mh">0xe2a240000000b0b0b0b0b0b0b0b0b0b0</span><span class="p">,</span><span class="w"> </span><span class="mi">65535</span><span class="p">,</span><span class="w"> </span><span class="mi">2583671442118339183427542988162351</span><span class="p">,</span><span class="w"> </span><span class="mi">2583671442118339183427542988162351</span><span class="p">,</span><span class="w"> </span><span class="mi">2583671442118339183427542988162351</span><span class="p">,</span><span class="w"> </span><span class="mh">0xa1a1a1a1a1a1a1a1a1a1a1a1a1a1a1a1</span><span class="p">,</span><span class="w"> </span><span class="mh">0x1</span><span class="p">.</span><span class="n">f6f6f6p119</span><span class="p">,</span><span class="w"> </span><span class="mi">2583671442118339183427542988162351</span><span class="p">,</span><span class="w"> </span><span class="mh">0xb0b06e00f1244c4c4c4c4c4c4c4c4c4c</span><span class="p">,</span><span class="w"> </span><span class="mh">0xb0b06e00f1244c4c4c4c4c4c4c4c4c4c</span><span class="p">]</span>
<span class="mi">1</span><span class="w"> </span><span class="n">tests</span>
<span class="n">Error</span>: <span class="mi">1</span><span class="w"> </span><span class="n">failure</span>
</code></pre></div>
<h3>Versions and Environment</h3>
<p>Cranelift version or commit: <code>main</code> (2d34b4657aa5290948da9a07cb31764a12c12994)<br>
Operating system: Linux<br>
Architecture: X86<br>
</p>
</blockquote>



<a name="369842013"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%236640%20Cranelift%3A%20Wrong%20result%20on%20%60tail%60%20.../near/369842013" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.236640.20Cranelift.3A.20Wrong.20result.20on.20.60tail.60.20.2E.2E.2E.html#369842013">(Jun 26 2023 at 21:49)</a>:</h4>
<p>fitzgen <a href="https://github.com/bytecodealliance/wasmtime/issues/6640#issuecomment-1608342705">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/6640">issue #6640</a>:</p>
<blockquote>
<p>Reduced a bit more:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="n">test</span><span class="w"> </span><span class="n">interpret</span>
<span class="n">test</span><span class="w"> </span><span class="n">run</span>
<span class="n">set</span><span class="w"> </span><span class="n">enable_llvm_abi_extensions</span><span class="o">=</span><span class="kc">true</span>
<span class="n">set</span><span class="w"> </span><span class="n">probestack_size_log2</span><span class="o">=</span><span class="mi">6</span>
<span class="n">set</span><span class="w"> </span><span class="n">probestack_strategy</span><span class="o">=</span><span class="n">inline</span>
<span class="n">set</span><span class="w"> </span><span class="n">enable_probestack</span><span class="o">=</span><span class="kc">true</span>
<span class="n">target</span><span class="w"> </span><span class="n">x86_64</span>
<span class="n">target</span><span class="w"> </span><span class="n">aarch64</span>
<span class="n">target</span><span class="w"> </span><span class="n">riscv64gc</span><span class="w"> </span><span class="n">has_v</span>

<span class="n">function</span><span class="w"> </span><span class="o">%</span><span class="n">a</span><span class="p">(</span><span class="kt">i8</span><span class="p">,</span><span class="w"> </span><span class="kt">i8</span><span class="p">,</span><span class="w"> </span><span class="kt">i8</span><span class="p">,</span><span class="w"> </span><span class="kt">i8</span><span class="p">,</span><span class="w"> </span><span class="n">i16x8</span><span class="p">,</span><span class="w"> </span><span class="kt">i8</span><span class="p">,</span><span class="w"> </span><span class="n">i8x16</span><span class="p">,</span><span class="w"> </span><span class="kt">i64</span><span class="p">,</span><span class="w"> </span><span class="kt">i16</span><span class="p">,</span><span class="w"> </span><span class="kt">i32</span><span class="p">,</span><span class="w"> </span><span class="n">i16x8</span><span class="p">,</span><span class="w"> </span><span class="kt">f32</span><span class="p">,</span><span class="w"> </span><span class="n">i16x8</span><span class="p">,</span><span class="w"> </span><span class="n">i32x4</span><span class="p">,</span><span class="w"> </span><span class="n">i16x8</span><span class="p">,</span><span class="w"> </span><span class="kt">i128</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="kt">i8</span><span class="p">,</span><span class="w"> </span><span class="kt">i8</span><span class="p">,</span><span class="w"> </span><span class="kt">i64</span><span class="p">,</span><span class="w"> </span><span class="n">i16x8</span><span class="p">,</span><span class="w"> </span><span class="kt">i32</span><span class="p">,</span><span class="w"> </span><span class="kt">i128</span><span class="p">,</span><span class="w"> </span><span class="kt">i128</span><span class="p">,</span><span class="w"> </span><span class="kt">i128</span><span class="p">,</span><span class="w"> </span><span class="n">i8x16</span><span class="p">,</span><span class="w"> </span><span class="kt">f32</span><span class="p">,</span><span class="w"> </span><span class="kt">i128</span><span class="p">,</span><span class="w"> </span><span class="n">i32x4</span><span class="p">,</span><span class="w"> </span><span class="n">i32x4</span><span class="w"> </span><span class="n">tail</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">ss0</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">explicit_slot</span><span class="w"> </span><span class="mi">321</span>

<span class="n">block0</span><span class="p">(</span><span class="n">v0</span>: <span class="kt">i8</span><span class="p">,</span><span class="w"> </span><span class="n">v1</span>: <span class="kt">i8</span><span class="p">,</span><span class="w"> </span><span class="n">v2</span>: <span class="kt">i8</span><span class="p">,</span><span class="w"> </span><span class="n">v3</span>: <span class="kt">i8</span><span class="p">,</span><span class="w"> </span><span class="n">v4</span>: <span class="nc">i16x8</span><span class="p">,</span><span class="w"> </span><span class="n">v5</span>: <span class="kt">i8</span><span class="p">,</span><span class="w"> </span><span class="n">v6</span>: <span class="nc">i8x16</span><span class="p">,</span><span class="w"> </span><span class="n">v7</span>: <span class="kt">i64</span><span class="p">,</span><span class="w"> </span><span class="n">v8</span>: <span class="kt">i16</span><span class="p">,</span><span class="w"> </span><span class="n">v9</span>: <span class="kt">i32</span><span class="p">,</span><span class="w"> </span><span class="n">v10</span>: <span class="nc">i16x8</span><span class="p">,</span><span class="w"> </span><span class="n">v11</span>: <span class="kt">f32</span><span class="p">,</span><span class="w"> </span><span class="n">v12</span>: <span class="nc">i16x8</span><span class="p">,</span><span class="w"> </span><span class="n">v13</span>: <span class="nc">i32x4</span><span class="p">,</span><span class="w"> </span><span class="n">v14</span>: <span class="nc">i16x8</span><span class="p">,</span><span class="w"> </span><span class="n">v15</span>: <span class="kt">i128</span><span class="p">)</span>:
    <span class="nc">return</span><span class="w"> </span><span class="n">v3</span><span class="p">,</span><span class="w"> </span><span class="n">v3</span><span class="p">,</span><span class="w"> </span><span class="n">v7</span><span class="p">,</span><span class="w"> </span><span class="n">v14</span><span class="p">,</span><span class="w"> </span><span class="n">v9</span><span class="p">,</span><span class="w"> </span><span class="n">v15</span><span class="p">,</span><span class="w"> </span><span class="n">v15</span><span class="p">,</span><span class="w"> </span><span class="n">v15</span><span class="p">,</span><span class="w"> </span><span class="n">v6</span><span class="p">,</span><span class="w"> </span><span class="n">v11</span><span class="p">,</span><span class="w"> </span><span class="n">v15</span><span class="p">,</span><span class="w"> </span><span class="n">v13</span><span class="p">,</span><span class="w"> </span><span class="n">v13</span>
<span class="p">}</span>

<span class="p">;</span><span class="w"> </span><span class="n">run</span>: <span class="o">%</span><span class="n">a</span><span class="p">(</span><span class="o">-</span><span class="mi">95</span><span class="p">,</span><span class="w"> </span><span class="o">-</span><span class="mi">95</span><span class="p">,</span><span class="w"> </span><span class="o">-</span><span class="mi">95</span><span class="p">,</span><span class="w"> </span><span class="o">-</span><span class="mi">95</span><span class="p">,</span><span class="w"> </span><span class="mh">0xa1</span><span class="p">,</span><span class="w"> </span><span class="o">-</span><span class="mi">95</span><span class="p">,</span><span class="w"> </span><span class="mh">0xa1</span><span class="p">,</span><span class="w"> </span><span class="o">-</span><span class="mi">6</span><span class="p">,</span><span class="w"> </span><span class="o">-</span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mh">0x7b</span><span class="p">,</span><span class="w"> </span><span class="mh">0x1</span><span class="p">.</span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mh">0x4c</span><span class="p">,</span><span class="w"> </span><span class="mh">0xb0</span><span class="p">,</span><span class="w"> </span><span class="mh">0xe2</span><span class="p">,</span><span class="w"> </span><span class="o">-</span><span class="mi">42</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="p">[</span><span class="o">-</span><span class="mi">95</span><span class="p">,</span><span class="w"> </span><span class="o">-</span><span class="mi">95</span><span class="p">,</span><span class="w"> </span><span class="o">-</span><span class="mi">6</span><span class="p">,</span><span class="w"> </span><span class="mh">0xe2</span><span class="p">,</span><span class="w"> </span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="o">-</span><span class="mi">42</span><span class="p">,</span><span class="w"> </span><span class="o">-</span><span class="mi">42</span><span class="p">,</span><span class="w"> </span><span class="o">-</span><span class="mi">42</span><span class="p">,</span><span class="w"> </span><span class="mh">0xa1</span><span class="p">,</span><span class="w"> </span><span class="mh">0x1</span><span class="p">.</span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="o">-</span><span class="mi">42</span><span class="p">,</span><span class="w"> </span><span class="mh">0xb0</span><span class="p">,</span><span class="w"> </span><span class="mh">0xb0</span><span class="p">]</span>
</code></pre></div>
<p>If I change the explicit stack slot size to <code>320</code> then the test passes.</p>
</blockquote>



<a name="369845484"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%236640%20Cranelift%3A%20Wrong%20result%20on%20%60tail%60%20.../near/369845484" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.236640.20Cranelift.3A.20Wrong.20result.20on.20.60tail.60.20.2E.2E.2E.html#369845484">(Jun 26 2023 at 22:16)</a>:</h4>
<p>fitzgen <a href="https://github.com/bytecodealliance/wasmtime/issues/6640#issuecomment-1608395065">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/6640">issue #6640</a>:</p>
<blockquote>
<p>Further reduced:</p>
<p><div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="n">test</span><span class="w"> </span><span class="n">interpret</span>
<span class="n">test</span><span class="w"> </span><span class="n">run</span>
<span class="n">set</span><span class="w"> </span><span class="n">enable_llvm_abi_extensions</span><span class="o">=</span><span class="kc">true</span>
<span class="n">set</span><span class="w"> </span><span class="n">probestack_size_log2</span><span class="o">=</span><span class="mi">6</span>
<span class="n">set</span><span class="w"> </span><span class="n">probestack_strategy</span><span class="o">=</span><span class="n">inline</span>
<span class="n">set</span><span class="w"> </span><span class="n">enable_probestack</span><span class="o">=</span><span class="kc">true</span>
<span class="n">target</span><span class="w"> </span><span class="n">x86_64</span>
<span class="n">target</span><span class="w"> </span><span class="n">aarch64</span>
<span class="n">target</span><span class="w"> </span><span class="n">riscv64gc</span><span class="w"> </span><span class="n">has_v</span>

<span class="n">function</span><span class="w"> </span><span class="o">%</span><span class="n">a</span><span class="p">(</span><span class="kt">i8</span><span class="p">,</span><span class="w"> </span><span class="kt">i8</span><span class="p">,</span><span class="w"> </span><span class="kt">i8</span><span class="p">,</span><span class="w"> </span><span class="kt">i8</span><span class="p">,</span><span class="w"> </span><span class="kt">i8</span><span class="p">,</span><span class="w"> </span><span class="kt">i64</span><span class="p">,</span><span class="w"> </span><span class="kt">i8</span><span class="p">,</span><span class="w"> </span><span class="kt">i8</span><span class="p">,</span><span class="w"> </span><span class="kt">i128</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="kt">i128</span> <span class="nc">tail</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">ss0</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">explicit_slot</span><span class="w"> </span><span class="mi">321</span>

<span class="n">block0</span><span class="p">(</span><span class="n">v0</span>: <span class="kt">i8</span><span class="p">,</span><span class="w"> </span><span class="n">v1</span>: <span class="kt">i8</span><span class="p">,</span><span class="w"> </span><span class="n">v2</span>: <span class="kt">i8</span><span class="p">,</span><span class="w"> </span><span class="n">v3</span>: <span class="kt">i8</span><span class="p">,</span><span class="w"> </span><span class="n">v4</span>: <span class="kt">i8</span><span class="p">,</span><span class="w"> </span><span class="n">v5</span>: <span class="kt">i64</span><span class="p">,</span><span class="w"> </span><span class="n">v6</span>: <span class="kt">i8</span><span class="p">,</span><span class="w"> </span><span class="n">v7</span>: <span class="kt">i8</span><span class="p">,</span><span class="w"> </span><span class="n">v8</span>: <span class="kt">i128</span><span class="p">)</span>:
    <span class="nc">return</span><span class="w"> </span><span class="n">v8</span>
<span class="p">}</span>

<span class="p">;</span><span class="w"> </span><span class="n">run</span>: <span class="o">%</span><span class="n">a</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="mi">3</span><span class="p">,</span><span class="w"> </span><span class="mi">4</span><span class="p">,</span><span class="w"> </span><span class="mi">5</span><span class="p">,</span><span class="w"> </span><span class="mi">6</span><span class="p">,</span><span class="w"> </span><span class="mi">7</span><span class="p">,</span><span class="w"> </span><span class="mi">8</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">8</span>
</code></pre></div><br>
</p>
</blockquote>



<a name="370152225"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%236640%20Cranelift%3A%20Wrong%20result%20on%20%60tail%60%20.../near/370152225" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.236640.20Cranelift.3A.20Wrong.20result.20on.20.60tail.60.20.2E.2E.2E.html#370152225">(Jun 27 2023 at 17:39)</a>:</h4>
<p>fitzgen <a href="https://github.com/bytecodealliance/wasmtime/issues/6640#issuecomment-1609955255">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/6640">issue #6640</a>:</p>
<blockquote>
<p>The bug is that the probestack code is somehow using a register that is an argument and overwriting the argument:</p>
<p><div class="codehilite" data-code-language="GAS"><pre><span></span><code><span class="c1">;;; Prologue.</span>
<span class="err">0:</span><span class="w">  </span><span class="err">55</span><span class="w">                      </span><span class="nf">pushq</span><span class="w">   </span><span class="nv">%rbp</span>
<span class="err">1:</span><span class="w">  </span><span class="err">48</span><span class="w"> </span><span class="err">89</span><span class="w"> </span><span class="nf">e5</span><span class="w">                </span><span class="no">movq</span><span class="w">    </span><span class="nv">%rsp</span><span class="p">,</span><span class="w"> </span><span class="nv">%rbp</span>

<span class="c1">;;; Begin inline probe stack.</span>
<span class="err">4:</span><span class="w">  </span><span class="err">49</span><span class="w"> </span><span class="err">89</span><span class="w"> </span><span class="nf">e3</span><span class="w">                </span><span class="no">movq</span><span class="w">    </span><span class="nv">%rsp</span><span class="p">,</span><span class="w"> </span><span class="nv">%r11</span>
<span class="w">    </span><span class="c1">;; r11 = rsp - 0x180</span>
<span class="w">    </span><span class="c1">;;</span>
<span class="w">    </span><span class="c1">;; THIS CLOBBERS AN ARGUMENT</span>
<span class="err">7:</span><span class="w">  </span><span class="err">49</span><span class="w"> </span><span class="err">81</span><span class="w"> </span><span class="nf">eb</span><span class="w"> </span><span class="mi">80</span><span class="w"> </span><span class="mi">01</span><span class="w"> </span><span class="mi">00</span><span class="w"> </span><span class="mi">00</span><span class="w">    </span><span class="no">subq</span><span class="w">    </span><span class="no">$0x180</span><span class="p">,</span><span class="w"> </span><span class="nv">%r11</span>
<span class="w">    </span><span class="c1">;; do { rsp -= 0x40; *rsp = esp; } while (r11 != rsp);</span>
<span class="nl">e:</span><span class="w">  </span><span class="err">48</span><span class="w"> </span><span class="err">83</span><span class="w"> </span><span class="nf">ec</span><span class="w"> </span><span class="mi">40</span><span class="w">             </span><span class="no">subq</span><span class="w">    </span><span class="no">$0x40</span><span class="p">,</span><span class="w"> </span><span class="nv">%rsp</span>
<span class="err">12:</span><span class="w"> </span><span class="err">89</span><span class="w"> </span><span class="err">24</span><span class="w"> </span><span class="err">24</span><span class="w">                </span><span class="nf">movl</span><span class="w">    </span><span class="nv">%esp</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="nv">%rsp</span><span class="p">)</span>
<span class="err">15:</span><span class="w"> </span><span class="err">49</span><span class="w"> </span><span class="err">39</span><span class="w"> </span><span class="nf">e3</span><span class="w">                </span><span class="no">cmpq</span><span class="w">    </span><span class="nv">%rsp</span><span class="p">,</span><span class="w"> </span><span class="nv">%r11</span>
<span class="err">18:</span><span class="w"> </span><span class="err">0</span><span class="nf">f</span><span class="w"> </span><span class="mi">85</span><span class="w"> </span><span class="no">f0</span><span class="w"> </span><span class="no">ff</span><span class="w"> </span><span class="no">ff</span><span class="w"> </span><span class="no">ff</span><span class="w">       </span><span class="no">jne</span><span class="w"> </span><span class="mi">0xe</span>
<span class="w">    </span><span class="c1">;; restore rsp to original value.</span>
<span class="err">1</span><span class="nl">e:</span><span class="w"> </span><span class="err">48</span><span class="w"> </span><span class="err">81</span><span class="w"> </span><span class="nf">c4</span><span class="w"> </span><span class="mi">80</span><span class="w"> </span><span class="mi">01</span><span class="w"> </span><span class="mi">00</span><span class="w"> </span><span class="mi">00</span><span class="w">    </span><span class="no">addq</span><span class="w">    </span><span class="no">$0x180</span><span class="p">,</span><span class="w"> </span><span class="nv">%rsp</span>
<span class="c1">;;; End inline probe stack.</span>

<span class="c1">;;; Allocate stack frame.</span>
<span class="err">25:</span><span class="w"> </span><span class="err">48</span><span class="w"> </span><span class="err">81</span><span class="w"> </span><span class="nf">ec</span><span class="w"> </span><span class="mi">50</span><span class="w"> </span><span class="mi">01</span><span class="w"> </span><span class="mi">00</span><span class="w"> </span><span class="mi">00</span><span class="w">    </span><span class="no">subq</span><span class="w">    </span><span class="no">$0x150</span><span class="p">,</span><span class="w"> </span><span class="nv">%rsp</span>
<span class="c1">;;; Move arguments (r10, r11) into their return value place.</span>
<span class="err">2</span><span class="nl">c:</span><span class="w"> </span><span class="err">4</span><span class="nf">c</span><span class="w"> </span><span class="mi">89</span><span class="w"> </span><span class="no">d0</span><span class="w">                </span><span class="no">movq</span><span class="w">    </span><span class="nv">%r10</span><span class="p">,</span><span class="w"> </span><span class="nv">%rax</span>
<span class="err">2</span><span class="nl">f:</span><span class="w"> </span><span class="err">4</span><span class="nf">c</span><span class="w"> </span><span class="mi">89</span><span class="w"> </span><span class="no">d9</span><span class="w">                </span><span class="no">movq</span><span class="w">    </span><span class="nv">%r11</span><span class="p">,</span><span class="w"> </span><span class="nv">%rcx</span>
<span class="c1">;;; Deallocate stack frame.</span>
<span class="err">32:</span><span class="w"> </span><span class="err">48</span><span class="w"> </span><span class="err">81</span><span class="w"> </span><span class="nf">c4</span><span class="w"> </span><span class="mi">50</span><span class="w"> </span><span class="mi">01</span><span class="w"> </span><span class="mi">00</span><span class="w"> </span><span class="mi">00</span><span class="w">    </span><span class="no">addq</span><span class="w">    </span><span class="no">$0x150</span><span class="p">,</span><span class="w"> </span><span class="nv">%rsp</span>
<span class="c1">;;; Epilogue.</span>
<span class="err">39:</span><span class="w"> </span><span class="err">48</span><span class="w"> </span><span class="err">89</span><span class="w"> </span><span class="nf">ec</span><span class="w">                </span><span class="no">movq</span><span class="w">    </span><span class="nv">%rbp</span><span class="p">,</span><span class="w"> </span><span class="nv">%rsp</span>
<span class="err">3</span><span class="nl">c:</span><span class="w"> </span><span class="err">5</span><span class="nf">d</span><span class="w">                      </span><span class="no">popq</span><span class="w">    </span><span class="nv">%rbp</span>
<span class="err">3</span><span class="nl">d:</span><span class="w"> </span><span class="nf">c3</span><span class="w">                      </span><span class="no">retq</span>
</code></pre></div><br>
</p>
</blockquote>



<a name="370194873"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%236640%20Cranelift%3A%20Wrong%20result%20on%20%60tail%60%20.../near/370194873" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.236640.20Cranelift.3A.20Wrong.20result.20on.20.60tail.60.20.2E.2E.2E.html#370194873">(Jun 27 2023 at 20:14)</a>:</h4>
<p>fitzgen closed <a href="https://github.com/bytecodealliance/wasmtime/issues/6640">issue #6640</a>:</p>
<blockquote>
<p><span aria-label="wave" class="emoji emoji-1f44b" role="img" title="wave">:wave:</span> Hey,</p>
<p>Fuzzgen found this while I was working on something unrelated, but it reproduces on main.</p>
<p>The testcase passes if stack probing is disabled or if we remove the stack slots. Setting <code>probestack_size_log2=7</code> also makes the test pass, but any value below that makes it fail.</p>
<p>I've also tested on the other backends and they pass this test.</p>
<h3><code>.clif</code> Test Case</h3>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="n">test</span><span class="w"> </span><span class="n">interpret</span>
<span class="n">test</span><span class="w"> </span><span class="n">run</span>
<span class="n">set</span><span class="w"> </span><span class="n">enable_llvm_abi_extensions</span><span class="o">=</span><span class="kc">true</span>
<span class="n">set</span><span class="w"> </span><span class="n">probestack_size_log2</span><span class="o">=</span><span class="mi">6</span>
<span class="n">set</span><span class="w"> </span><span class="n">probestack_strategy</span><span class="o">=</span><span class="n">inline</span>
<span class="n">set</span><span class="w"> </span><span class="n">enable_probestack</span><span class="o">=</span><span class="kc">true</span>
<span class="n">target</span><span class="w"> </span><span class="n">x86_64</span>
<span class="n">target</span><span class="w"> </span><span class="n">aarch64</span>
<span class="n">target</span><span class="w"> </span><span class="n">riscv64gc</span><span class="w"> </span><span class="n">has_v</span>

<span class="n">function</span><span class="w"> </span><span class="o">%</span><span class="n">a</span><span class="p">(</span><span class="kt">i8</span><span class="p">,</span><span class="w"> </span><span class="kt">i8</span><span class="p">,</span><span class="w"> </span><span class="kt">i8</span><span class="p">,</span><span class="w"> </span><span class="kt">i8</span><span class="p">,</span><span class="w"> </span><span class="n">i16x8</span><span class="p">,</span><span class="w"> </span><span class="kt">i8</span><span class="p">,</span><span class="w"> </span><span class="n">i8x16</span><span class="p">,</span><span class="w"> </span><span class="kt">i64</span><span class="p">,</span><span class="w"> </span><span class="kt">i16</span><span class="p">,</span><span class="w"> </span><span class="kt">i32</span><span class="p">,</span><span class="w"> </span><span class="n">i16x8</span><span class="p">,</span><span class="w"> </span><span class="kt">f32</span><span class="p">,</span><span class="w"> </span><span class="n">i16x8</span><span class="p">,</span><span class="w"> </span><span class="n">i32x4</span><span class="p">,</span><span class="w"> </span><span class="n">i16x8</span><span class="p">,</span><span class="w"> </span><span class="kt">i128</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="kt">i8</span><span class="p">,</span><span class="w"> </span><span class="kt">i8</span><span class="p">,</span><span class="w"> </span><span class="kt">i64</span><span class="p">,</span><span class="w"> </span><span class="n">i16x8</span><span class="p">,</span><span class="w"> </span><span class="kt">i32</span><span class="p">,</span><span class="w"> </span><span class="kt">i128</span><span class="p">,</span><span class="w"> </span><span class="kt">i128</span><span class="p">,</span><span class="w"> </span><span class="kt">i128</span><span class="p">,</span><span class="w"> </span><span class="n">i8x16</span><span class="p">,</span><span class="w"> </span><span class="kt">f32</span><span class="p">,</span><span class="w"> </span><span class="kt">i128</span><span class="p">,</span><span class="w"> </span><span class="n">i32x4</span><span class="p">,</span><span class="w"> </span><span class="n">i32x4</span><span class="w"> </span><span class="n">tail</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">ss0</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">explicit_slot</span><span class="w"> </span><span class="mi">117</span>
<span class="w">    </span><span class="n">ss1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">explicit_slot</span><span class="w"> </span><span class="mi">49</span>
<span class="w">    </span><span class="n">ss2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">explicit_slot</span><span class="w"> </span><span class="mi">65</span>
<span class="w">    </span><span class="n">ss3</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">explicit_slot</span><span class="w"> </span><span class="mi">50</span>
<span class="w">    </span><span class="n">ss4</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">explicit_slot</span><span class="w"> </span><span class="mi">76</span>

<span class="n">block0</span><span class="p">(</span><span class="n">v0</span>: <span class="kt">i8</span><span class="p">,</span><span class="w"> </span><span class="n">v1</span>: <span class="kt">i8</span><span class="p">,</span><span class="w"> </span><span class="n">v2</span>: <span class="kt">i8</span><span class="p">,</span><span class="w"> </span><span class="n">v3</span>: <span class="kt">i8</span><span class="p">,</span><span class="w"> </span><span class="n">v4</span>: <span class="nc">i16x8</span><span class="p">,</span><span class="w"> </span><span class="n">v5</span>: <span class="kt">i8</span><span class="p">,</span><span class="w"> </span><span class="n">v6</span>: <span class="nc">i8x16</span><span class="p">,</span><span class="w"> </span><span class="n">v7</span>: <span class="kt">i64</span><span class="p">,</span><span class="w"> </span><span class="n">v8</span>: <span class="kt">i16</span><span class="p">,</span><span class="w"> </span><span class="n">v9</span>: <span class="kt">i32</span><span class="p">,</span><span class="w"> </span><span class="n">v10</span>: <span class="nc">i16x8</span><span class="p">,</span><span class="w"> </span><span class="n">v11</span>: <span class="kt">f32</span><span class="p">,</span><span class="w"> </span><span class="n">v12</span>: <span class="nc">i16x8</span><span class="p">,</span><span class="w"> </span><span class="n">v13</span>: <span class="nc">i32x4</span><span class="p">,</span><span class="w"> </span><span class="n">v14</span>: <span class="nc">i16x8</span><span class="p">,</span><span class="w"> </span><span class="n">v15</span>: <span class="kt">i128</span><span class="p">)</span>:
    <span class="nc">v32</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">bmask</span><span class="p">.</span><span class="kt">i16</span><span class="w"> </span><span class="n">v15</span>
<span class="w">    </span><span class="n">v33</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">uextend</span><span class="p">.</span><span class="kt">i32</span><span class="w"> </span><span class="n">v32</span>
<span class="w">    </span><span class="n">v40</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">bitrev</span><span class="w"> </span><span class="n">v7</span>
<span class="w">    </span><span class="n">v79</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">icmp</span><span class="w"> </span><span class="n">sge</span><span class="w"> </span><span class="n">v3</span><span class="p">,</span><span class="w"> </span><span class="n">v3</span>
<span class="w">    </span><span class="n">v84</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">bitrev</span><span class="w"> </span><span class="n">v40</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">v79</span><span class="p">,</span><span class="w"> </span><span class="n">v79</span><span class="p">,</span><span class="w"> </span><span class="n">v84</span><span class="p">,</span><span class="w"> </span><span class="n">v14</span><span class="p">,</span><span class="w"> </span><span class="n">v33</span><span class="p">,</span><span class="w"> </span><span class="n">v15</span><span class="p">,</span><span class="w"> </span><span class="n">v15</span><span class="p">,</span><span class="w"> </span><span class="n">v15</span><span class="p">,</span><span class="w"> </span><span class="n">v6</span><span class="p">,</span><span class="w"> </span><span class="n">v11</span><span class="p">,</span><span class="w"> </span><span class="n">v15</span><span class="p">,</span><span class="w"> </span><span class="n">v13</span><span class="p">,</span><span class="w"> </span><span class="n">v13</span>
<span class="p">}</span>

<span class="p">;</span><span class="w"> </span><span class="n">run</span>: <span class="o">%</span><span class="n">a</span><span class="p">(</span><span class="o">-</span><span class="mi">95</span><span class="p">,</span><span class="w"> </span><span class="o">-</span><span class="mi">95</span><span class="p">,</span><span class="w"> </span><span class="o">-</span><span class="mi">95</span><span class="p">,</span><span class="w"> </span><span class="o">-</span><span class="mi">95</span><span class="p">,</span><span class="w"> </span><span class="mh">0xa1a1a1a1a1a1a1a1a1a1a1a1a1a1a1a1</span><span class="p">,</span><span class="w"> </span><span class="o">-</span><span class="mi">95</span><span class="p">,</span><span class="w"> </span><span class="mh">0xa1a1a1a1a1a1a1a1a1a1a1a1a1a1a1a1</span><span class="p">,</span><span class="w"> </span><span class="o">-</span><span class="mi">6799976246779207263</span><span class="p">,</span><span class="w"> </span><span class="o">-</span><span class="mi">24159</span><span class="p">,</span><span class="w"> </span><span class="o">-</span><span class="mi">1583242847</span><span class="p">,</span><span class="w"> </span><span class="mh">0x7b7b7ba1a1a1a1a1a1a1a1a1a1a1a1a1</span><span class="p">,</span><span class="w"> </span><span class="mh">0x1</span><span class="p">.</span><span class="n">f6f6f6p119</span><span class="p">,</span><span class="w"> </span><span class="mh">0x4c4c7b7b7b7b7b7b7b7b7b7b7b7b7b7b</span><span class="p">,</span><span class="w"> </span><span class="mh">0xb0b06e00f1244c4c4c4c4c4c4c4c4c4c</span><span class="p">,</span><span class="w"> </span><span class="mh">0xe2a240000000b0b0b0b0b0b0b0b0b0b0</span><span class="p">,</span><span class="w"> </span><span class="o">-</span><span class="mi">113427455621981599237913610941852744401</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="o">-</span><span class="mi">6799976246779207263</span><span class="p">,</span><span class="w"> </span><span class="mh">0xe2a240000000b0b0b0b0b0b0b0b0b0b0</span><span class="p">,</span><span class="w"> </span><span class="mi">65535</span><span class="p">,</span><span class="w"> </span><span class="o">-</span><span class="mi">113427455621981599237913610941852744401</span><span class="p">,</span><span class="w"> </span><span class="o">-</span><span class="mi">113427455621981599237913610941852744401</span><span class="p">,</span><span class="w"> </span><span class="o">-</span><span class="mi">113427455621981599237913610941852744401</span><span class="p">,</span><span class="w"> </span><span class="mh">0xa1a1a1a1a1a1a1a1a1a1a1a1a1a1a1a1</span><span class="p">,</span><span class="w"> </span><span class="mh">0x1</span><span class="p">.</span><span class="n">f6f6f6p119</span><span class="p">,</span><span class="w"> </span><span class="o">-</span><span class="mi">113427455621981599237913610941852744401</span><span class="p">,</span><span class="w"> </span><span class="mh">0xb0b06e00f1244c4c4c4c4c4c4c4c4c4c</span><span class="p">,</span><span class="w"> </span><span class="mh">0xb0b06e00f1244c4c4c4c4c4c4c4c4c4c</span><span class="p">]</span>
</code></pre></div>
<h3>Steps to Reproduce</h3>
<ul>
<li><code>clif-util test ./the-above.clif</code> </li>
</ul>
<h3>Expected Results</h3>
<p>The test to pass.</p>
<h3>Actual Results</h3>
<p>The value that is wrong here is <code>v15</code></p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="w">     </span><span class="n">Running</span><span class="w"> </span><span class="err">`</span><span class="o">/</span><span class="n">home</span><span class="o">/</span><span class="n">afonso</span><span class="o">/</span><span class="n">git</span><span class="o">/</span><span class="n">wasmtime</span><span class="o">/</span><span class="n">target</span><span class="o">/</span><span class="n">debug</span><span class="o">/</span><span class="n">clif</span><span class="o">-</span><span class="n">util</span><span class="w"> </span><span class="n">test</span><span class="w"> </span><span class="p">.</span><span class="o">/</span><span class="n">lmao</span><span class="p">.</span><span class="n">clif</span><span class="err">`</span>
<span class="w"> </span><span class="n">ERROR</span><span class="w"> </span><span class="n">cranelift_filetests</span>::<span class="n">concurrent</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="n">FAIL</span>: <span class="nc">run</span>
<span class="n">FAIL</span><span class="w"> </span><span class="p">.</span><span class="o">/</span><span class="n">lmao</span><span class="p">.</span><span class="n">clif</span>: <span class="nc">run</span>

<span class="n">Caused</span><span class="w"> </span><span class="n">by</span>:
    <span class="nc">Failed</span><span class="w"> </span><span class="n">test</span>: <span class="nc">run</span>: <span class="o">%</span><span class="n">a</span><span class="p">(</span><span class="o">-</span><span class="mi">95</span><span class="p">,</span><span class="w"> </span><span class="o">-</span><span class="mi">95</span><span class="p">,</span><span class="w"> </span><span class="o">-</span><span class="mi">95</span><span class="p">,</span><span class="w"> </span><span class="o">-</span><span class="mi">95</span><span class="p">,</span><span class="w"> </span><span class="mh">0xa1a1a1a1a1a1a1a1a1a1a1a1a1a1a1a1</span><span class="p">,</span><span class="w"> </span><span class="o">-</span><span class="mi">95</span><span class="p">,</span><span class="w"> </span><span class="mh">0xa1a1a1a1a1a1a1a1a1a1a1a1a1a1a1a1</span><span class="p">,</span><span class="w"> </span><span class="o">-</span><span class="mi">6799976246779207263</span><span class="p">,</span><span class="w"> </span><span class="o">-</span><span class="mi">24159</span><span class="p">,</span><span class="w"> </span><span class="o">-</span><span class="mi">1583242847</span><span class="p">,</span><span class="w"> </span><span class="mh">0x7b7b7ba1a1a1a1a1a1a1a1a1a1a1a1a1</span><span class="p">,</span><span class="w"> </span><span class="mh">0x1</span><span class="p">.</span><span class="n">f6f6f6p119</span><span class="p">,</span><span class="w"> </span><span class="mh">0x4c4c7b7b7b7b7b7b7b7b7b7b7b7b7b7b</span><span class="p">,</span><span class="w"> </span><span class="mh">0xb0b06e00f1244c4c4c4c4c4c4c4c4c4c</span><span class="p">,</span><span class="w"> </span><span class="mh">0xe2a240000000b0b0b0b0b0b0b0b0b0b0</span><span class="p">,</span><span class="w"> </span><span class="o">-</span><span class="mi">113427455621981599237913610941852744401</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="o">-</span><span class="mi">6799976246779207263</span><span class="p">,</span><span class="w"> </span><span class="mh">0xe2a240000000b0b0b0b0b0b0b0b0b0b0</span><span class="p">,</span><span class="w"> </span><span class="mi">65535</span><span class="p">,</span><span class="w"> </span><span class="o">-</span><span class="mi">113427455621981599237913610941852744401</span><span class="p">,</span><span class="w"> </span><span class="o">-</span><span class="mi">113427455621981599237913610941852744401</span><span class="p">,</span><span class="w"> </span><span class="o">-</span><span class="mi">113427455621981599237913610941852744401</span><span class="p">,</span><span class="w"> </span><span class="mh">0xa1a1a1a1a1a1a1a1a1a1a1a1a1a1a1a1</span><span class="p">,</span><span class="w"> </span><span class="mh">0x1</span><span class="p">.</span><span class="n">f6f6f6p119</span><span class="p">,</span><span class="w"> </span><span class="o">-</span><span class="mi">113427455621981599237913610941852744401</span><span class="p">,</span><span class="w"> </span><span class="mh">0xb0b06e00f1244c4c4c4c4c4c4c4c4c4c</span><span class="p">,</span><span class="w"> </span><span class="mh">0xb0b06e00f1244c4c4c4c4c4c4c4c4c4c</span><span class="p">],</span><span class="w"> </span><span class="n">actual</span>: <span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="o">-</span><span class="mi">6799976246779207263</span><span class="p">,</span><span class="w"> </span><span class="mh">0xe2a240000000b0b0b0b0b0b0b0b0b0b0</span><span class="p">,</span><span class="w"> </span><span class="mi">65535</span><span class="p">,</span><span class="w"> </span><span class="mi">2583671442118339183427542988162351</span><span class="p">,</span><span class="w"> </span><span class="mi">2583671442118339183427542988162351</span><span class="p">,</span><span class="w"> </span><span class="mi">2583671442118339183427542988162351</span><span class="p">,</span><span class="w"> </span><span class="mh">0xa1a1a1a1a1a1a1a1a1a1a1a1a1a1a1a1</span><span class="p">,</span><span class="w"> </span><span class="mh">0x1</span><span class="p">.</span><span class="n">f6f6f6p119</span><span class="p">,</span><span class="w"> </span><span class="mi">2583671442118339183427542988162351</span><span class="p">,</span><span class="w"> </span><span class="mh">0xb0b06e00f1244c4c4c4c4c4c4c4c4c4c</span><span class="p">,</span><span class="w"> </span><span class="mh">0xb0b06e00f1244c4c4c4c4c4c4c4c4c4c</span><span class="p">]</span>
<span class="mi">1</span><span class="w"> </span><span class="n">tests</span>
<span class="n">Error</span>: <span class="mi">1</span><span class="w"> </span><span class="n">failure</span>
</code></pre></div>
<h3>Versions and Environment</h3>
<p>Cranelift version or commit: <code>main</code> (2d34b4657aa5290948da9a07cb31764a12c12994)<br>
Operating system: Linux<br>
Architecture: X86<br>
</p>
</blockquote>



<hr><p>Last updated: Jan 20 2025 at 06:04 UTC</p>
</html>