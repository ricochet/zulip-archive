<html>
<head><meta charset="utf-8"><title>wasmtime / issue #4555 Cranelift AArch64: Harden the Spec... · git-wasmtime · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/index.html">git-wasmtime</a></h2>
<h3>Topic: <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.234555.20Cranelift.20AArch64.3A.20Harden.20the.20Spec.2E.2E.2E.html">wasmtime / issue #4555 Cranelift AArch64: Harden the Spec...</a></h3>

<hr>

<base href="https://bytecodealliance.zulipchat.com">

<head><link href="https://bytecodealliance.github.io/zulip-archive/style.css" rel="stylesheet"></head>

<a name="291351529"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%234555%20Cranelift%20AArch64%3A%20Harden%20the%20Spec.../near/291351529" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.234555.20Cranelift.20AArch64.3A.20Harden.20the.20Spec.2E.2E.2E.html#291351529">(Jul 29 2022 at 16:54)</a>:</h4>
<p>akirilov-arm <a href="https://github.com/bytecodealliance/wasmtime/pull/4555#issuecomment-1199741412">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/4555">issue #4555</a>:</p>
<blockquote>
<blockquote>
<p>... this should not result in a large pipeline bubble (hence large performance penalty) on current microarchitectures, is that right?</p>
</blockquote>
<p>Yes, microarchitectures that do not perform any value speculation should treat it as <code>NOP</code>.</p>
<blockquote>
<p>... would you be willing to run a quick test (any reasonably complex benchmark that uses the heap will do -- <code>bz2</code> or <code>spidermonkey</code> from Sightglass perhaps)?</p>
</blockquote>
<p>Sure, I can give it a try.</p>
<blockquote>
<p>... should there be a test that shows <code>csdb</code> appearing in br_table lowerings as well?</p>
</blockquote>
<p>Is the test I updated in <code>cranelift/codegen/src/isa/aarch64/mod.rs</code> insufficient?</p>
</blockquote>



<a name="291351631"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%234555%20Cranelift%20AArch64%3A%20Harden%20the%20Spec.../near/291351631" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.234555.20Cranelift.20AArch64.3A.20Harden.20the.20Spec.2E.2E.2E.html#291351631">(Jul 29 2022 at 16:55)</a>:</h4>
<p>akirilov-arm edited a <a href="https://github.com/bytecodealliance/wasmtime/pull/4555#issuecomment-1199741412">comment</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/4555">issue #4555</a>:</p>
<blockquote>
<blockquote>
<p>... this should not result in a large pipeline bubble (hence large performance penalty) on current microarchitectures, is that right?</p>
</blockquote>
<p>Yes, microarchitectures that do not perform any value speculation should treat it as <code>NOP</code> (hence the choice of a particular encoding).</p>
<blockquote>
<p>... would you be willing to run a quick test (any reasonably complex benchmark that uses the heap will do -- <code>bz2</code> or <code>spidermonkey</code> from Sightglass perhaps)?</p>
</blockquote>
<p>Sure, I can give it a try.</p>
<blockquote>
<p>... should there be a test that shows <code>csdb</code> appearing in br_table lowerings as well?</p>
</blockquote>
<p>Is the test I updated in <code>cranelift/codegen/src/isa/aarch64/mod.rs</code> insufficient?</p>
</blockquote>



<a name="291352302"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%234555%20Cranelift%20AArch64%3A%20Harden%20the%20Spec.../near/291352302" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.234555.20Cranelift.20AArch64.3A.20Harden.20the.20Spec.2E.2E.2E.html#291352302">(Jul 29 2022 at 17:01)</a>:</h4>
<p>akirilov-arm edited a <a href="https://github.com/bytecodealliance/wasmtime/pull/4555#issuecomment-1199741412">comment</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/4555">issue #4555</a>:</p>
<blockquote>
<blockquote>
<p>... this should not result in a large pipeline bubble (hence large performance penalty) on current microarchitectures, is that right?</p>
</blockquote>
<p>Yes, microarchitectures that do not perform any value speculation should treat it as <code>NOP</code> (hence the choice of a particular encoding).</p>
<blockquote>
<p>... would you be willing to run a quick test (any reasonably complex benchmark that uses the heap will do -- <code>bz2</code> or <code>spidermonkey</code> from Sightglass perhaps)?</p>
</blockquote>
<p>Sure, I can give it a try.</p>
<blockquote>
<p>... should there be a test that shows <code>csdb</code> appearing in br_table lowerings as well?</p>
</blockquote>
<p>Is the test I updated in <code>cranelift/codegen/src/isa/aarch64/mod.rs</code> insufficient? <strong>Edit</strong> - sorry, this sounds a bit rude, but I didn't mean it that way; I believe that test does the job.</p>
</blockquote>



<a name="291353885"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%234555%20Cranelift%20AArch64%3A%20Harden%20the%20Spec.../near/291353885" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.234555.20Cranelift.20AArch64.3A.20Harden.20the.20Spec.2E.2E.2E.html#291353885">(Jul 29 2022 at 17:14)</a>:</h4>
<p>cfallin <a href="https://github.com/bytecodealliance/wasmtime/pull/4555#issuecomment-1199770585">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/4555">issue #4555</a>:</p>
<blockquote>
<p>Ah, yes, the smoke test does technically cover <code>br_table</code>. I guess I was a bit surprised we don't have a filetest that exercises it that changed as a result of this; if you'd like to add one, that'd be great, as an opportunistic expansion of our test suite :-)</p>
</blockquote>



<a name="291359773"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%234555%20Cranelift%20AArch64%3A%20Harden%20the%20Spec.../near/291359773" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.234555.20Cranelift.20AArch64.3A.20Harden.20the.20Spec.2E.2E.2E.html#291359773">(Jul 29 2022 at 18:00)</a>:</h4>
<p>akirilov-arm <a href="https://github.com/bytecodealliance/wasmtime/pull/4555#issuecomment-1199808535">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/4555">issue #4555</a>:</p>
<blockquote>
<p>Hah, it turns out that there are in fact tests - <code>cranelift/filetests/filetests/isa/aarch64/jumptable.clif</code> and, unsurprisingly, the <code>cranelift/filetests/filetests/runtests/br_table.clif</code> runtest. I think the issue is that we don't emit the <code>Csdb</code> VCode instruction explicitly for <code>br_table</code>, but the <code>JTSequence</code> compound operation instead, so actually we can't use a CLIF test to verify end-to-end the precise machine code that has been generated. Note that the <code>JTSequence</code> pretty-printing logic hasn't been updated to include the <code>csel</code> instruction added by the initial Spectre mitigation either; I will remedy both issues.</p>
</blockquote>



<a name="291582018"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%234555%20Cranelift%20AArch64%3A%20Harden%20the%20Spec.../near/291582018" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.234555.20Cranelift.20AArch64.3A.20Harden.20the.20Spec.2E.2E.2E.html#291582018">(Aug 01 2022 at 14:22)</a>:</h4>
<p>akirilov-arm <a href="https://github.com/bytecodealliance/wasmtime/pull/4555#issuecomment-1201273368">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/4555">issue #4555</a>:</p>
<blockquote>
<p>Here are the Sightglass results on an Ampere Altra machine (<code>wasmtime/target/release/libwasmtime_bench_api.so</code> being the build that generates <code>CSDB</code>):</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="n">execution</span><span class="w"> </span>:: <span class="nc">cycles</span><span class="w"> </span>:: <span class="nc">benchmarks</span><span class="o">/</span><span class="n">spidermonkey</span><span class="o">/</span><span class="n">benchmark</span><span class="p">.</span><span class="n">wasm</span><span class="w"></span>

<span class="w">  </span><span class="err">Δ</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">442011.60</span><span class="w"> </span><span class="err">±</span><span class="w"> </span><span class="mf">101171.36</span><span class="w"> </span><span class="p">(</span><span class="n">confidence</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">99</span><span class="o">%</span><span class="p">)</span><span class="w"></span>

<span class="w">  </span><span class="n">libwasmtime_bench_api</span><span class="p">.</span><span class="n">so</span><span class="w"> </span><span class="n">is</span><span class="w"> </span><span class="mf">1.00</span><span class="n">x</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="mf">1.00</span><span class="n">x</span><span class="w"> </span><span class="n">faster</span><span class="w"> </span><span class="n">than</span><span class="w"> </span><span class="n">wasmtime</span><span class="o">/</span><span class="n">target</span><span class="o">/</span><span class="n">release</span><span class="o">/</span><span class="n">libwasmtime_bench_api</span><span class="p">.</span><span class="n">so</span><span class="o">!</span><span class="w"></span>
<span class="w">  </span><span class="n">wasmtime</span><span class="o">/</span><span class="n">target</span><span class="o">/</span><span class="n">release</span><span class="o">/</span><span class="n">libwasmtime_bench_api</span><span class="p">.</span><span class="n">so</span><span class="w"> </span><span class="n">is</span><span class="w"> </span><span class="mf">1.00</span><span class="n">x</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="mf">1.00</span><span class="n">x</span><span class="w"> </span><span class="n">faster</span><span class="w"> </span><span class="n">than</span><span class="w"> </span><span class="n">libwasmtime_bench_api</span><span class="p">.</span><span class="n">so</span><span class="o">!</span><span class="w"></span>

<span class="w">  </span><span class="p">[</span><span class="mi">115783264</span><span class="w"> </span><span class="mf">116247975.57</span><span class="w"> </span><span class="mi">116880177</span><span class="p">]</span><span class="w"> </span><span class="n">libwasmtime_bench_api</span><span class="p">.</span><span class="n">so</span><span class="w"></span>
<span class="w">  </span><span class="p">[</span><span class="mi">115445187</span><span class="w"> </span><span class="mf">115805963.97</span><span class="w"> </span><span class="mi">118081119</span><span class="p">]</span><span class="w"> </span><span class="n">wasmtime</span><span class="o">/</span><span class="n">target</span><span class="o">/</span><span class="n">release</span><span class="o">/</span><span class="n">libwasmtime_bench_api</span><span class="p">.</span><span class="n">so</span><span class="w"></span>

<span class="n">execution</span><span class="w"> </span>:: <span class="nc">nanoseconds</span><span class="w"> </span>:: <span class="nc">benchmarks</span><span class="o">/</span><span class="n">spidermonkey</span><span class="o">/</span><span class="n">benchmark</span><span class="p">.</span><span class="n">wasm</span><span class="w"></span>

<span class="w">  </span><span class="err">Δ</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">17636030.01</span><span class="w"> </span><span class="err">±</span><span class="w"> </span><span class="mf">4052032.02</span><span class="w"> </span><span class="p">(</span><span class="n">confidence</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">99</span><span class="o">%</span><span class="p">)</span><span class="w"></span>

<span class="w">  </span><span class="n">libwasmtime_bench_api</span><span class="p">.</span><span class="n">so</span><span class="w"> </span><span class="n">is</span><span class="w"> </span><span class="mf">1.00</span><span class="n">x</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="mf">1.00</span><span class="n">x</span><span class="w"> </span><span class="n">faster</span><span class="w"> </span><span class="n">than</span><span class="w"> </span><span class="n">wasmtime</span><span class="o">/</span><span class="n">target</span><span class="o">/</span><span class="n">release</span><span class="o">/</span><span class="n">libwasmtime_bench_api</span><span class="p">.</span><span class="n">so</span><span class="o">!</span><span class="w"></span>
<span class="w">  </span><span class="n">wasmtime</span><span class="o">/</span><span class="n">target</span><span class="o">/</span><span class="n">release</span><span class="o">/</span><span class="n">libwasmtime_bench_api</span><span class="p">.</span><span class="n">so</span><span class="w"> </span><span class="n">is</span><span class="w"> </span><span class="mf">1.00</span><span class="n">x</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="mf">1.00</span><span class="n">x</span><span class="w"> </span><span class="n">faster</span><span class="w"> </span><span class="n">than</span><span class="w"> </span><span class="n">libwasmtime_bench_api</span><span class="p">.</span><span class="n">so</span><span class="o">!</span><span class="w"></span>

<span class="w">  </span><span class="p">[</span><span class="mi">4631075480</span><span class="w"> </span><span class="mf">4649708462.75</span><span class="w"> </span><span class="mi">4675100300</span><span class="p">]</span><span class="w"> </span><span class="n">libwasmtime_bench_api</span><span class="p">.</span><span class="n">so</span><span class="w"></span>
<span class="w">  </span><span class="p">[</span><span class="mi">4617673936</span><span class="w"> </span><span class="mf">4632072432.74</span><span class="w"> </span><span class="mi">4723056593</span><span class="p">]</span><span class="w"> </span><span class="n">wasmtime</span><span class="o">/</span><span class="n">target</span><span class="o">/</span><span class="n">release</span><span class="o">/</span><span class="n">libwasmtime_bench_api</span><span class="p">.</span><span class="n">so</span><span class="w"></span>

<span class="p">[</span><span class="o">..</span><span class="p">.]</span><span class="w"></span>

<span class="n">execution</span><span class="w"> </span>:: <span class="nc">cycles</span><span class="w"> </span>:: <span class="nc">benchmarks</span><span class="o">/</span><span class="n">bz2</span><span class="o">/</span><span class="n">benchmark</span><span class="p">.</span><span class="n">wasm</span><span class="w"></span>

<span class="w">  </span><span class="n">No</span><span class="w"> </span><span class="n">difference</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="n">performance</span><span class="p">.</span><span class="w"></span>

<span class="w">  </span><span class="p">[</span><span class="mi">836103</span><span class="w"> </span><span class="mf">890682.87</span><span class="w"> </span><span class="mi">1035450</span><span class="p">]</span><span class="w"> </span><span class="n">libwasmtime_bench_api</span><span class="p">.</span><span class="n">so</span><span class="w"></span>
<span class="w">  </span><span class="p">[</span><span class="mi">839938</span><span class="w"> </span><span class="mf">903084.69</span><span class="w"> </span><span class="mi">1030489</span><span class="p">]</span><span class="w"> </span><span class="n">wasmtime</span><span class="o">/</span><span class="n">target</span><span class="o">/</span><span class="n">release</span><span class="o">/</span><span class="n">libwasmtime_bench_api</span><span class="p">.</span><span class="n">so</span><span class="w"></span>

<span class="n">execution</span><span class="w"> </span>:: <span class="nc">nanoseconds</span><span class="w"> </span>:: <span class="nc">benchmarks</span><span class="o">/</span><span class="n">bz2</span><span class="o">/</span><span class="n">benchmark</span><span class="p">.</span><span class="n">wasm</span><span class="w"></span>

<span class="w">  </span><span class="n">No</span><span class="w"> </span><span class="n">difference</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="n">performance</span><span class="p">.</span><span class="w"></span>

<span class="w">  </span><span class="p">[</span><span class="mi">33442481</span><span class="w"> </span><span class="mf">35625535.03</span><span class="w"> </span><span class="mi">41416669</span><span class="p">]</span><span class="w"> </span><span class="n">libwasmtime_bench_api</span><span class="p">.</span><span class="n">so</span><span class="w"></span>
<span class="w">  </span><span class="p">[</span><span class="mi">33595869</span><span class="w"> </span><span class="mf">36121314.02</span><span class="w"> </span><span class="mi">41218165</span><span class="p">]</span><span class="w"> </span><span class="n">wasmtime</span><span class="o">/</span><span class="n">target</span><span class="o">/</span><span class="n">release</span><span class="o">/</span><span class="n">libwasmtime_bench_api</span><span class="p">.</span><span class="n">so</span><span class="w"></span>
</code></pre></div>
<p>There is no real difference, as expected.</p>
</blockquote>



<hr><p>Last updated: Jan 20 2025 at 06:04 UTC</p>
</html>