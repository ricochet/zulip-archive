<html>
<head><meta charset="utf-8"><title>wasmtime / PR #5174 cranelift-isle: Factor out rule/patte... · git-wasmtime · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/index.html">git-wasmtime</a></h2>
<h3>Topic: <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.235174.20cranelift-isle.3A.20Factor.20out.20rule.2Fpatte.2E.2E.2E.html">wasmtime / PR #5174 cranelift-isle: Factor out rule/patte...</a></h3>

<hr>

<base href="https://bytecodealliance.zulipchat.com">

<head><link href="https://bytecodealliance.github.io/zulip-archive/style.css" rel="stylesheet"></head>

<a name="307437911"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%235174%20cranelift-isle%3A%20Factor%20out%20rule/patte.../near/307437911" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.235174.20cranelift-isle.3A.20Factor.20out.20rule.2Fpatte.2E.2E.2E.html#307437911">(Nov 02 2022 at 01:57)</a>:</h4>
<p><strong>jameysharp</strong> requested <a href="https://github.com/elliottt">elliottt</a> for a review on <a href="https://github.com/bytecodealliance/wasmtime/pull/5174">PR #5174</a>.</p>



<a name="307437913"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%235174%20cranelift-isle%3A%20Factor%20out%20rule/patte.../near/307437913" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.235174.20cranelift-isle.3A.20Factor.20out.20rule.2Fpatte.2E.2E.2E.html#307437913">(Nov 02 2022 at 01:57)</a>:</h4>
<p>jameysharp opened <a href="https://github.com/bytecodealliance/wasmtime/pull/5174">PR #5174</a> from <code>rule-visitor</code> to <code>main</code>:</p>
<blockquote>
<p>This shouldn't change behavior at all, but makes some rather tricky analysis available to other users besides the current IR.</p>
<p>&lt;!--</p>
<p>Please ensure that the following steps are all taken care of before submitting<br>
the PR.</p>
<ul>
<li>
<p>[ ] This has been discussed in issue #..., or if not, please tell us why<br>
  here.</p>
</li>
<li>
<p>[ ] A short description of what this does, why it is needed; if the<br>
  description becomes long, the matter should probably be discussed in an issue<br>
  first.</p>
</li>
<li>
<p>[ ] This PR contains test cases, if meaningful.</p>
</li>
<li>[ ] A reviewer from the core maintainer team has been assigned for this PR.<br>
  If you don't know who could review this, please indicate so. The list of<br>
  suggested reviewers on the right can help you.</li>
</ul>
<p>Please ensure all communication adheres to the <a href="https://github.com/bytecodealliance/wasmtime/blob/master/CODE_OF_CONDUCT.md">code of
conduct</a>.<br>
--&gt;<br>
</p>
</blockquote>



<a name="307601904"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%235174%20cranelift-isle%3A%20Factor%20out%20rule/patte.../near/307601904" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.235174.20cranelift-isle.3A.20Factor.20out.20rule.2Fpatte.2E.2E.2E.html#307601904">(Nov 02 2022 at 19:21)</a>:</h4>
<p>jameysharp updated <a href="https://github.com/bytecodealliance/wasmtime/pull/5174">PR #5174</a> from <code>rule-visitor</code> to <code>main</code>.</p>



<a name="307627254"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%235174%20cranelift-isle%3A%20Factor%20out%20rule/patte.../near/307627254" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.235174.20cranelift-isle.3A.20Factor.20out.20rule.2Fpatte.2E.2E.2E.html#307627254">(Nov 02 2022 at 22:14)</a>:</h4>
<p>elliottt submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/5174#pullrequestreview-1166068164">PR review</a>.</p>



<a name="307627255"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%235174%20cranelift-isle%3A%20Factor%20out%20rule/patte.../near/307627255" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.235174.20cranelift-isle.3A.20Factor.20out.20rule.2Fpatte.2E.2E.2E.html#307627255">(Nov 02 2022 at 22:14)</a>:</h4>
<p>elliottt created <a href="https://github.com/bytecodealliance/wasmtime/pull/5174#discussion_r1012337926">PR review comment</a>:</p>
<blockquote>
<p>Why have the <code>RuleVisitor</code> extend <code>PatternVisitor</code> but have a <code>ExprVisitor</code> associated type? Would it be reasonable to have a <code>PatternVisitor</code> associated type here instead?</p>
<p>Having both types be associated types would I think force the interface used in <code>lower_rule</code> to be a bit more consistent -- right now the expression sequence is returned while the pattern sequence is an in/out param.</p>
</blockquote>



<a name="307627256"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%235174%20cranelift-isle%3A%20Factor%20out%20rule/patte.../near/307627256" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.235174.20cranelift-isle.3A.20Factor.20out.20rule.2Fpatte.2E.2E.2E.html#307627256">(Nov 02 2022 at 22:14)</a>:</h4>
<p>elliottt submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/5174#pullrequestreview-1166068164">PR review</a>.</p>



<a name="307638040"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%235174%20cranelift-isle%3A%20Factor%20out%20rule/patte.../near/307638040" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.235174.20cranelift-isle.3A.20Factor.20out.20rule.2Fpatte.2E.2E.2E.html#307638040">(Nov 03 2022 at 00:05)</a>:</h4>
<p>jameysharp updated <a href="https://github.com/bytecodealliance/wasmtime/pull/5174">PR #5174</a> from <code>rule-visitor</code> to <code>main</code>.</p>



<a name="307638447"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%235174%20cranelift-isle%3A%20Factor%20out%20rule/patte.../near/307638447" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.235174.20cranelift-isle.3A.20Factor.20out.20rule.2Fpatte.2E.2E.2E.html#307638447">(Nov 03 2022 at 00:10)</a>:</h4>
<p>jameysharp submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/5174#pullrequestreview-1166148030">PR review</a>.</p>



<a name="307638448"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%235174%20cranelift-isle%3A%20Factor%20out%20rule/patte.../near/307638448" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.235174.20cranelift-isle.3A.20Factor.20out.20rule.2Fpatte.2E.2E.2E.html#307638448">(Nov 03 2022 at 00:10)</a>:</h4>
<p>jameysharp created <a href="https://github.com/bytecodealliance/wasmtime/pull/5174#discussion_r1012397182">PR review comment</a>:</p>
<blockquote>
<p>My simplest answer is "because I needed <code>ExprVisitor</code> to be a different type from <code>RuleVisitor</code> but I didn't need <code>PatternVisitor</code> to be a different type." In fact for the new IR I'm building that I want to use this in, all three types are the same, because expressions are de-duplicated across <code>if-let</code>s and even across separate rules in the same term.</p>
<p>That's a pretty weak justification though. There's certainly a nice symmetry argument for making both be associated types, and it could support more general usage. It also gives <code>RuleVisitor</code>s the opportunity to ignore patterns, like they currently could ignore expressions.</p>
<p>But making <code>PatternVisitor</code> an associated type doesn't change <code>lower_rule</code> at all, or <code>Rule::visit</code> significantly. The fundamental reason those look weird is because visiting a pattern returns nothing, while visiting an expression returns some result. I think that distinction is inherent. <code>PatternId</code>s name the inside of a pattern, top-down, so a <code>PatternVisitor</code> can record anything it might need as it goes. <code>ExprId</code>s name the outside of an expression, bottom-up, so there's a final result that the visitor might need to do something with.</p>
<p>It looks especially weird with the current IR because <code>PatternSequence::add_expr</code> returns ownership of an entire heap-allocated <code>ExprSequence</code>. My new IR just has to return an array index there, so I think that'll be a little less confusing.</p>
<p>Anyway, I've implemented this because the symmetry really is nice. It makes the <code>RuleVisitor</code> trait definition noisy with <code>&lt;Self::PatternVisitor as PatternVisitor&gt;::PatternId</code> but so it goes.</p>
</blockquote>



<a name="307638966"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%235174%20cranelift-isle%3A%20Factor%20out%20rule/patte.../near/307638966" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.235174.20cranelift-isle.3A.20Factor.20out.20rule.2Fpatte.2E.2E.2E.html#307638966">(Nov 03 2022 at 00:16)</a>:</h4>
<p>jameysharp has enabled auto merge for <a href="https://github.com/bytecodealliance/wasmtime/pull/5174">PR #5174</a>.</p>



<a name="307643371"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%235174%20cranelift-isle%3A%20Factor%20out%20rule/patte.../near/307643371" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.235174.20cranelift-isle.3A.20Factor.20out.20rule.2Fpatte.2E.2E.2E.html#307643371">(Nov 03 2022 at 01:18)</a>:</h4>
<p>jameysharp merged <a href="https://github.com/bytecodealliance/wasmtime/pull/5174">PR #5174</a>.</p>



<hr><p>Last updated: Jan 20 2025 at 06:04 UTC</p>
</html>