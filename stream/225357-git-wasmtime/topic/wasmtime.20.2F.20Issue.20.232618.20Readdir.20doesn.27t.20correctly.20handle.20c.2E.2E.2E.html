<html>
<head><meta charset="utf-8"><title>wasmtime / Issue #2618 Readdir doesn&#x27;t correctly handle c... · git-wasmtime · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/index.html">git-wasmtime</a></h2>
<h3>Topic: <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20Issue.20.232618.20Readdir.20doesn.27t.20correctly.20handle.20c.2E.2E.2E.html">wasmtime / Issue #2618 Readdir doesn&#x27;t correctly handle c...</a></h3>

<hr>

<base href="https://bytecodealliance.zulipchat.com">

<head><link href="https://bytecodealliance.github.io/zulip-archive/style.css" rel="stylesheet"></head>

<a name="224369072"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20Issue%20%232618%20Readdir%20doesn%27t%20correctly%20handle%20c.../near/224369072" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20Issue.20.232618.20Readdir.20doesn.27t.20correctly.20handle.20c.2E.2E.2E.html#224369072">(Jan 28 2021 at 18:15)</a>:</h4>
<p>RReverser opened <a href="https://github.com/bytecodealliance/wasmtime/issues/2618">Issue #2618</a>:</p>
<blockquote>
<p>Try to compile this sample code to WASI:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="k">fn</span> <span class="nf">main</span><span class="p">()</span><span class="w"> </span>-&gt; <span class="nc">std</span>::<span class="n">io</span>::<span class="nb">Result</span><span class="o">&lt;</span><span class="p">()</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="n">entry</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="n">std</span>::<span class="n">fs</span>::<span class="n">read_dir</span><span class="p">(</span><span class="s">"/"</span><span class="p">)</span><span class="o">?</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="fm">println!</span><span class="p">(</span><span class="s">"{}"</span><span class="p">,</span><span class="w"> </span><span class="n">entry</span><span class="o">?</span><span class="p">.</span><span class="n">path</span><span class="p">().</span><span class="n">display</span><span class="p">());</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="nb">Ok</span><span class="p">(())</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>
<p>Then, choose a large-ish folder - e.g. I created a temporary directory with 50 files named 0...49.</p>
<p>Run the produced Wasm with Wasmtime with that directory mapped to <code>/</code>:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="cp">$</span><span class="w"> </span><span class="n">wasmtime</span><span class="w"> </span><span class="n">temp</span><span class="p">.</span><span class="n">wasm</span><span class="w"> </span><span class="o">--</span><span class="n">mapdir</span><span class="w"> </span><span class="o">/</span>::<span class="cp">$PWD</span><span class="o">/</span><span class="n">temp</span><span class="o">-</span><span class="n">dir</span><span class="w"></span>
<span class="o">/</span><span class="mi">1</span><span class="w"></span>
<span class="o">/</span><span class="mi">2</span><span class="w"></span>
<span class="o">/</span><span class="mi">49</span><span class="w"></span>
<span class="n">thread</span><span class="w"> </span><span class="o">'</span><span class="na">main</span><span class="o">'</span><span class="w"> </span><span class="n">panicked</span><span class="w"> </span><span class="n">at</span><span class="w"> </span><span class="o">'</span><span class="na">range</span><span class="w"> </span><span class="n">end</span><span class="w"> </span><span class="n">index</span><span class="w"> </span><span class="mi">1214</span><span class="w"> </span><span class="n">out</span><span class="w"> </span><span class="n">of</span><span class="w"> </span><span class="n">range</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">slice</span><span class="w"> </span><span class="n">of</span><span class="w"> </span><span class="n">length</span><span class="w"> </span><span class="mi">128</span><span class="o">'</span><span class="p">,</span><span class="w"> </span><span class="n">library</span><span class="o">/</span><span class="n">std</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">sys</span><span class="o">/</span><span class="n">wasi</span><span class="o">/</span><span class="n">fs</span><span class="p">.</span><span class="n">rs</span>:<span class="mi">164</span>:<span class="mi">25</span><span class="w"></span>
<span class="n">note</span>: <span class="nc">run</span><span class="w"> </span><span class="n">with</span><span class="w"> </span><span class="err">`</span><span class="n">RUST_BACKTRACE</span><span class="o">=</span><span class="mi">1</span><span class="err">`</span><span class="w"> </span><span class="n">environment</span><span class="w"> </span><span class="n">variable</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">display</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="n">backtrace</span><span class="w"></span>
<span class="n">Error</span>: <span class="nc">failed</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">run</span><span class="w"> </span><span class="n">main</span><span class="w"> </span><span class="n">module</span><span class="w"> </span><span class="err">`</span><span class="n">temp</span><span class="p">.</span><span class="n">wasm</span><span class="err">`</span><span class="w"></span>

<span class="n">Caused</span><span class="w"> </span><span class="n">by</span>:
    <span class="mi">0</span>: <span class="nc">failed</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">invoke</span><span class="w"> </span><span class="n">command</span><span class="w"> </span><span class="n">default</span><span class="w"></span>
<span class="w">    </span><span class="mi">1</span>: <span class="nc">wasm</span><span class="w"> </span><span class="n">trap</span>: <span class="nc">unreachable</span><span class="w"></span>
<span class="w">       </span><span class="n">wasm</span><span class="w"> </span><span class="n">backtrace</span>:
           <span class="mi">0</span>: <span class="mh">0xd581</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="o">&lt;</span><span class="n">unknown</span><span class="o">&gt;!</span><span class="n">__rust_start_panic</span><span class="w"></span>
<span class="w">           </span><span class="mi">1</span>: <span class="mh">0xd223</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="o">&lt;</span><span class="n">unknown</span><span class="o">&gt;!</span><span class="n">rust_panic</span><span class="w"></span>
<span class="w">           </span><span class="mi">2</span>: <span class="mh">0xcdfb</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="o">&lt;</span><span class="n">unknown</span><span class="o">&gt;!</span><span class="n">std</span>::<span class="n">panicking</span>::<span class="n">rust_panic_with_hook</span>::<span class="n">h7412819944345424</span><span class="w"></span>
<span class="w">           </span><span class="mi">3</span>: <span class="mh">0xc36e</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="o">&lt;</span><span class="n">unknown</span><span class="o">&gt;!</span><span class="n">std</span>::<span class="n">panicking</span>::<span class="n">begin_panic_handler</span>::<span class="p">{{</span><span class="n">closure</span><span class="p">}}</span>::<span class="n">h4738c0049ce98322</span><span class="w"></span>
<span class="w">           </span><span class="mi">4</span>: <span class="mh">0xc2af</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="o">&lt;</span><span class="n">unknown</span><span class="o">&gt;!</span><span class="n">std</span>::<span class="n">sys_common</span>::<span class="n">backtrace</span>::<span class="n">__rust_end_short_backtrace</span>::<span class="n">h8bb6e3f06234953f</span><span class="w"></span>
<span class="w">           </span><span class="mi">5</span>: <span class="mh">0xcc9f</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="o">&lt;</span><span class="n">unknown</span><span class="o">&gt;!</span><span class="n">rust_begin_unwind</span><span class="w"></span>
<span class="w">           </span><span class="mi">6</span>: <span class="mh">0x12d4e</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="o">&lt;</span><span class="n">unknown</span><span class="o">&gt;!</span><span class="n">core</span>::<span class="n">panicking</span>::<span class="n">panic_fmt</span>::<span class="n">h904ce09f3cb14707</span><span class="w"></span>
<span class="w">           </span><span class="mi">7</span>: <span class="mh">0x12432</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="o">&lt;</span><span class="n">unknown</span><span class="o">&gt;!</span><span class="n">core</span>::<span class="n">slice</span>::<span class="n">index</span>::<span class="n">slice_end_index_len_fail</span>::<span class="n">hcdd59b2bc02fd78c</span><span class="w"></span>
<span class="w">           </span><span class="mi">8</span>: <span class="mh">0x9bd9</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="o">&lt;</span><span class="n">unknown</span><span class="o">&gt;!&lt;</span><span class="n">std</span>::<span class="n">sys</span>::<span class="n">wasi</span>::<span class="n">fs</span>::<span class="n">ReadDir</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">core</span>::<span class="n">iter</span>::<span class="n">traits</span>::<span class="n">iterator</span>::<span class="nb">Iterator</span><span class="o">&gt;</span>::<span class="n">next</span>::<span class="n">h53073ad4dd8c7879</span><span class="w"></span>
<span class="w">           </span><span class="mi">9</span>: <span class="mh">0x96ff</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="o">&lt;</span><span class="n">unknown</span><span class="o">&gt;!&lt;</span><span class="n">std</span>::<span class="n">fs</span>::<span class="n">ReadDir</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">core</span>::<span class="n">iter</span>::<span class="n">traits</span>::<span class="n">iterator</span>::<span class="nb">Iterator</span><span class="o">&gt;</span>::<span class="n">next</span>::<span class="n">h35e43cb49f6132cb</span><span class="w"></span>
<span class="w">          </span><span class="mi">10</span>:  <span class="mh">0x9de</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="o">&lt;</span><span class="n">unknown</span><span class="o">&gt;!</span><span class="n">temp</span>::<span class="n">main</span>::<span class="n">h0ae35bb072c9f0ef</span><span class="w"></span>
<span class="w">          </span><span class="mi">11</span>: <span class="mh">0x1c90</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="o">&lt;</span><span class="n">unknown</span><span class="o">&gt;!</span><span class="n">core</span>::<span class="n">ops</span>::<span class="n">function</span>::<span class="nb">FnOnce</span>::<span class="n">call_once</span>::<span class="n">hf1fda840e003cdf0</span><span class="w"></span>
<span class="w">          </span><span class="mi">12</span>: <span class="mh">0x2820</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="o">&lt;</span><span class="n">unknown</span><span class="o">&gt;!</span><span class="n">std</span>::<span class="n">sys_common</span>::<span class="n">backtrace</span>::<span class="n">__rust_begin_short_backtrace</span>::<span class="n">hf0b5aa48499a3256</span><span class="w"></span>
<span class="w">          </span><span class="mi">13</span>: <span class="mh">0x3e5b</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="o">&lt;</span><span class="n">unknown</span><span class="o">&gt;!</span><span class="n">std</span>::<span class="n">rt</span>::<span class="n">lang_start</span>::<span class="p">{{</span><span class="n">closure</span><span class="p">}}</span>::<span class="n">h6eaa3cdacd789dba</span><span class="w"></span>
<span class="w">          </span><span class="mi">14</span>: <span class="mh">0xd334</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="o">&lt;</span><span class="n">unknown</span><span class="o">&gt;!</span><span class="n">std</span>::<span class="n">rt</span>::<span class="n">lang_start_internal</span>::<span class="n">h0e1571f3e9f07dad</span><span class="w"></span>
<span class="w">          </span><span class="mi">15</span>: <span class="mh">0x3dfc</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="o">&lt;</span><span class="n">unknown</span><span class="o">&gt;!</span><span class="n">std</span>::<span class="n">rt</span>::<span class="n">lang_start</span>::<span class="n">h382cc3264c9b1456</span><span class="w"></span>
<span class="w">          </span><span class="mi">16</span>: <span class="mh">0x1483</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="o">&lt;</span><span class="n">unknown</span><span class="o">&gt;!</span><span class="n">__original_main</span><span class="w"></span>
<span class="w">          </span><span class="mi">17</span>:  <span class="mh">0x527</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="o">&lt;</span><span class="n">unknown</span><span class="o">&gt;!</span><span class="n">_start</span><span class="w"></span>
<span class="w">       </span><span class="n">note</span>: <span class="nc">run</span><span class="w"> </span><span class="n">with</span><span class="w"> </span><span class="err">`</span><span class="n">WASMTIME_BACKTRACE_DETAILS</span><span class="o">=</span><span class="mi">1</span><span class="err">`</span><span class="w"> </span><span class="n">environment</span><span class="w"> </span><span class="n">variable</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">display</span><span class="w"> </span><span class="n">more</span><span class="w"> </span><span class="n">information</span><span class="w"></span>
</code></pre></div>
<p>Same code against the same folder works fine with Wasmer, suggesting it's an environment issue not Rust stdlib issue:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="o">/</span><span class="mi">0</span><span class="w"></span>
<span class="o">/</span><span class="mi">1</span><span class="w"></span>
<span class="o">/</span><span class="mi">10</span><span class="w"></span>
<span class="o">/</span><span class="mi">11</span><span class="w"></span>
<span class="o">/</span><span class="mi">12</span><span class="w"></span>
<span class="o">/</span><span class="mi">13</span><span class="w"></span>
<span class="o">/</span><span class="mi">14</span><span class="w"></span>
<span class="o">/</span><span class="mi">15</span><span class="w"></span>
<span class="o">/</span><span class="mi">16</span><span class="w"></span>
<span class="o">/</span><span class="mi">17</span><span class="w"></span>
<span class="o">/</span><span class="mi">18</span><span class="w"></span>
<span class="o">/</span><span class="mi">19</span><span class="w"></span>
<span class="o">/</span><span class="mi">2</span><span class="w"></span>
<span class="o">/</span><span class="mi">20</span><span class="w"></span>
<span class="o">/</span><span class="mi">21</span><span class="w"></span>
<span class="o">/</span><span class="mi">22</span><span class="w"></span>
<span class="o">/</span><span class="mi">23</span><span class="w"></span>
<span class="o">/</span><span class="mi">24</span><span class="w"></span>
<span class="o">/</span><span class="mi">25</span><span class="w"></span>
<span class="o">/</span><span class="mi">26</span><span class="w"></span>
<span class="o">/</span><span class="mi">27</span><span class="w"></span>
<span class="o">/</span><span class="mi">28</span><span class="w"></span>
<span class="o">/</span><span class="mi">29</span><span class="w"></span>
<span class="o">/</span><span class="mi">3</span><span class="w"></span>
<span class="o">/</span><span class="mi">30</span><span class="w"></span>
<span class="o">/</span><span class="mi">31</span><span class="w"></span>
<span class="o">/</span><span class="mi">32</span><span class="w"></span>
<span class="o">/</span><span class="mi">33</span><span class="w"></span>
<span class="o">/</span><span class="mi">34</span><span class="w"></span>
<span class="o">/</span><span class="mi">35</span><span class="w"></span>
<span class="o">/</span><span class="mi">36</span><span class="w"></span>
<span class="o">/</span><span class="mi">37</span><span class="w"></span>
<span class="o">/</span><span class="mi">38</span><span class="w"></span>
<span class="o">/</span><span class="mi">39</span><span class="w"></span>
<span class="o">/</span><span class="mi">4</span><span class="w"></span>
<span class="o">/</span><span class="mi">40</span><span class="w"></span>
<span class="o">/</span><span class="mi">41</span><span class="w"></span>
<span class="o">/</span><span class="mi">42</span><span class="w"></span>
<span class="o">/</span><span class="mi">43</span><span class="w"></span>
<span class="o">/</span><span class="mi">44</span><span class="w"></span>
<span class="o">/</span><span class="mi">45</span><span class="w"></span>
<span class="o">/</span><span class="mi">46</span><span class="w"></span>
<span class="o">/</span><span class="mi">47</span><span class="w"></span>
<span class="o">/</span><span class="mi">48</span><span class="w"></span>
<span class="o">/</span><span class="mi">49</span><span class="w"></span>
<span class="o">/</span><span class="mi">5</span><span class="w"></span>
<span class="o">/</span><span class="mi">6</span><span class="w"></span>
<span class="o">/</span><span class="mi">7</span><span class="w"></span>
<span class="o">/</span><span class="mi">8</span><span class="w"></span>
<span class="o">/</span><span class="mi">9</span><span class="w"></span>
</code></pre></div>
<p>The relevant code on the Rust side also hasn't been updated in 2 years, also confirming it's likely a runtime environment issue: <a href="https://github.com/rust-lang/rust/blob/643a79af3d5a31fa87c8a4c9d7f8bc4ebe2add4b/library/std/src/sys/wasi/fs.rs#L164">https://github.com/rust-lang/rust/blob/643a79af3d5a31fa87c8a4c9d7f8bc4ebe2add4b/library/std/src/sys/wasi/fs.rs#L164</a></p>
</blockquote>



<a name="224369074"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20Issue%20%232618%20Readdir%20doesn%27t%20correctly%20handle%20c.../near/224369074" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20Issue.20.232618.20Readdir.20doesn.27t.20correctly.20handle.20c.2E.2E.2E.html#224369074">(Jan 28 2021 at 18:15)</a>:</h4>
<p>RReverser labeled <a href="https://github.com/bytecodealliance/wasmtime/issues/2618">Issue #2618</a>:</p>
<blockquote>
<p>Try to compile this sample code to WASI:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="k">fn</span> <span class="nf">main</span><span class="p">()</span><span class="w"> </span>-&gt; <span class="nc">std</span>::<span class="n">io</span>::<span class="nb">Result</span><span class="o">&lt;</span><span class="p">()</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="n">entry</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="n">std</span>::<span class="n">fs</span>::<span class="n">read_dir</span><span class="p">(</span><span class="s">"/"</span><span class="p">)</span><span class="o">?</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="fm">println!</span><span class="p">(</span><span class="s">"{}"</span><span class="p">,</span><span class="w"> </span><span class="n">entry</span><span class="o">?</span><span class="p">.</span><span class="n">path</span><span class="p">().</span><span class="n">display</span><span class="p">());</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="nb">Ok</span><span class="p">(())</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>
<p>Then, choose a large-ish folder - e.g. I created a temporary directory with 50 files named 0...49.</p>
<p>Run the produced Wasm with Wasmtime with that directory mapped to <code>/</code>:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="cp">$</span><span class="w"> </span><span class="n">wasmtime</span><span class="w"> </span><span class="n">temp</span><span class="p">.</span><span class="n">wasm</span><span class="w"> </span><span class="o">--</span><span class="n">mapdir</span><span class="w"> </span><span class="o">/</span>::<span class="cp">$PWD</span><span class="o">/</span><span class="n">temp</span><span class="o">-</span><span class="n">dir</span><span class="w"></span>
<span class="o">/</span><span class="mi">1</span><span class="w"></span>
<span class="o">/</span><span class="mi">2</span><span class="w"></span>
<span class="o">/</span><span class="mi">49</span><span class="w"></span>
<span class="n">thread</span><span class="w"> </span><span class="o">'</span><span class="na">main</span><span class="o">'</span><span class="w"> </span><span class="n">panicked</span><span class="w"> </span><span class="n">at</span><span class="w"> </span><span class="o">'</span><span class="na">range</span><span class="w"> </span><span class="n">end</span><span class="w"> </span><span class="n">index</span><span class="w"> </span><span class="mi">1214</span><span class="w"> </span><span class="n">out</span><span class="w"> </span><span class="n">of</span><span class="w"> </span><span class="n">range</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">slice</span><span class="w"> </span><span class="n">of</span><span class="w"> </span><span class="n">length</span><span class="w"> </span><span class="mi">128</span><span class="o">'</span><span class="p">,</span><span class="w"> </span><span class="n">library</span><span class="o">/</span><span class="n">std</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">sys</span><span class="o">/</span><span class="n">wasi</span><span class="o">/</span><span class="n">fs</span><span class="p">.</span><span class="n">rs</span>:<span class="mi">164</span>:<span class="mi">25</span><span class="w"></span>
<span class="n">note</span>: <span class="nc">run</span><span class="w"> </span><span class="n">with</span><span class="w"> </span><span class="err">`</span><span class="n">RUST_BACKTRACE</span><span class="o">=</span><span class="mi">1</span><span class="err">`</span><span class="w"> </span><span class="n">environment</span><span class="w"> </span><span class="n">variable</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">display</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="n">backtrace</span><span class="w"></span>
<span class="n">Error</span>: <span class="nc">failed</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">run</span><span class="w"> </span><span class="n">main</span><span class="w"> </span><span class="n">module</span><span class="w"> </span><span class="err">`</span><span class="n">temp</span><span class="p">.</span><span class="n">wasm</span><span class="err">`</span><span class="w"></span>

<span class="n">Caused</span><span class="w"> </span><span class="n">by</span>:
    <span class="mi">0</span>: <span class="nc">failed</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">invoke</span><span class="w"> </span><span class="n">command</span><span class="w"> </span><span class="n">default</span><span class="w"></span>
<span class="w">    </span><span class="mi">1</span>: <span class="nc">wasm</span><span class="w"> </span><span class="n">trap</span>: <span class="nc">unreachable</span><span class="w"></span>
<span class="w">       </span><span class="n">wasm</span><span class="w"> </span><span class="n">backtrace</span>:
           <span class="mi">0</span>: <span class="mh">0xd581</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="o">&lt;</span><span class="n">unknown</span><span class="o">&gt;!</span><span class="n">__rust_start_panic</span><span class="w"></span>
<span class="w">           </span><span class="mi">1</span>: <span class="mh">0xd223</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="o">&lt;</span><span class="n">unknown</span><span class="o">&gt;!</span><span class="n">rust_panic</span><span class="w"></span>
<span class="w">           </span><span class="mi">2</span>: <span class="mh">0xcdfb</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="o">&lt;</span><span class="n">unknown</span><span class="o">&gt;!</span><span class="n">std</span>::<span class="n">panicking</span>::<span class="n">rust_panic_with_hook</span>::<span class="n">h7412819944345424</span><span class="w"></span>
<span class="w">           </span><span class="mi">3</span>: <span class="mh">0xc36e</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="o">&lt;</span><span class="n">unknown</span><span class="o">&gt;!</span><span class="n">std</span>::<span class="n">panicking</span>::<span class="n">begin_panic_handler</span>::<span class="p">{{</span><span class="n">closure</span><span class="p">}}</span>::<span class="n">h4738c0049ce98322</span><span class="w"></span>
<span class="w">           </span><span class="mi">4</span>: <span class="mh">0xc2af</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="o">&lt;</span><span class="n">unknown</span><span class="o">&gt;!</span><span class="n">std</span>::<span class="n">sys_common</span>::<span class="n">backtrace</span>::<span class="n">__rust_end_short_backtrace</span>::<span class="n">h8bb6e3f06234953f</span><span class="w"></span>
<span class="w">           </span><span class="mi">5</span>: <span class="mh">0xcc9f</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="o">&lt;</span><span class="n">unknown</span><span class="o">&gt;!</span><span class="n">rust_begin_unwind</span><span class="w"></span>
<span class="w">           </span><span class="mi">6</span>: <span class="mh">0x12d4e</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="o">&lt;</span><span class="n">unknown</span><span class="o">&gt;!</span><span class="n">core</span>::<span class="n">panicking</span>::<span class="n">panic_fmt</span>::<span class="n">h904ce09f3cb14707</span><span class="w"></span>
<span class="w">           </span><span class="mi">7</span>: <span class="mh">0x12432</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="o">&lt;</span><span class="n">unknown</span><span class="o">&gt;!</span><span class="n">core</span>::<span class="n">slice</span>::<span class="n">index</span>::<span class="n">slice_end_index_len_fail</span>::<span class="n">hcdd59b2bc02fd78c</span><span class="w"></span>
<span class="w">           </span><span class="mi">8</span>: <span class="mh">0x9bd9</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="o">&lt;</span><span class="n">unknown</span><span class="o">&gt;!&lt;</span><span class="n">std</span>::<span class="n">sys</span>::<span class="n">wasi</span>::<span class="n">fs</span>::<span class="n">ReadDir</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">core</span>::<span class="n">iter</span>::<span class="n">traits</span>::<span class="n">iterator</span>::<span class="nb">Iterator</span><span class="o">&gt;</span>::<span class="n">next</span>::<span class="n">h53073ad4dd8c7879</span><span class="w"></span>
<span class="w">           </span><span class="mi">9</span>: <span class="mh">0x96ff</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="o">&lt;</span><span class="n">unknown</span><span class="o">&gt;!&lt;</span><span class="n">std</span>::<span class="n">fs</span>::<span class="n">ReadDir</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">core</span>::<span class="n">iter</span>::<span class="n">traits</span>::<span class="n">iterator</span>::<span class="nb">Iterator</span><span class="o">&gt;</span>::<span class="n">next</span>::<span class="n">h35e43cb49f6132cb</span><span class="w"></span>
<span class="w">          </span><span class="mi">10</span>:  <span class="mh">0x9de</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="o">&lt;</span><span class="n">unknown</span><span class="o">&gt;!</span><span class="n">temp</span>::<span class="n">main</span>::<span class="n">h0ae35bb072c9f0ef</span><span class="w"></span>
<span class="w">          </span><span class="mi">11</span>: <span class="mh">0x1c90</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="o">&lt;</span><span class="n">unknown</span><span class="o">&gt;!</span><span class="n">core</span>::<span class="n">ops</span>::<span class="n">function</span>::<span class="nb">FnOnce</span>::<span class="n">call_once</span>::<span class="n">hf1fda840e003cdf0</span><span class="w"></span>
<span class="w">          </span><span class="mi">12</span>: <span class="mh">0x2820</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="o">&lt;</span><span class="n">unknown</span><span class="o">&gt;!</span><span class="n">std</span>::<span class="n">sys_common</span>::<span class="n">backtrace</span>::<span class="n">__rust_begin_short_backtrace</span>::<span class="n">hf0b5aa48499a3256</span><span class="w"></span>
<span class="w">          </span><span class="mi">13</span>: <span class="mh">0x3e5b</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="o">&lt;</span><span class="n">unknown</span><span class="o">&gt;!</span><span class="n">std</span>::<span class="n">rt</span>::<span class="n">lang_start</span>::<span class="p">{{</span><span class="n">closure</span><span class="p">}}</span>::<span class="n">h6eaa3cdacd789dba</span><span class="w"></span>
<span class="w">          </span><span class="mi">14</span>: <span class="mh">0xd334</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="o">&lt;</span><span class="n">unknown</span><span class="o">&gt;!</span><span class="n">std</span>::<span class="n">rt</span>::<span class="n">lang_start_internal</span>::<span class="n">h0e1571f3e9f07dad</span><span class="w"></span>
<span class="w">          </span><span class="mi">15</span>: <span class="mh">0x3dfc</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="o">&lt;</span><span class="n">unknown</span><span class="o">&gt;!</span><span class="n">std</span>::<span class="n">rt</span>::<span class="n">lang_start</span>::<span class="n">h382cc3264c9b1456</span><span class="w"></span>
<span class="w">          </span><span class="mi">16</span>: <span class="mh">0x1483</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="o">&lt;</span><span class="n">unknown</span><span class="o">&gt;!</span><span class="n">__original_main</span><span class="w"></span>
<span class="w">          </span><span class="mi">17</span>:  <span class="mh">0x527</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="o">&lt;</span><span class="n">unknown</span><span class="o">&gt;!</span><span class="n">_start</span><span class="w"></span>
<span class="w">       </span><span class="n">note</span>: <span class="nc">run</span><span class="w"> </span><span class="n">with</span><span class="w"> </span><span class="err">`</span><span class="n">WASMTIME_BACKTRACE_DETAILS</span><span class="o">=</span><span class="mi">1</span><span class="err">`</span><span class="w"> </span><span class="n">environment</span><span class="w"> </span><span class="n">variable</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">display</span><span class="w"> </span><span class="n">more</span><span class="w"> </span><span class="n">information</span><span class="w"></span>
</code></pre></div>
<p>Same code against the same folder works fine with Wasmer, suggesting it's an environment issue not Rust stdlib issue:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="o">/</span><span class="mi">0</span><span class="w"></span>
<span class="o">/</span><span class="mi">1</span><span class="w"></span>
<span class="o">/</span><span class="mi">10</span><span class="w"></span>
<span class="o">/</span><span class="mi">11</span><span class="w"></span>
<span class="o">/</span><span class="mi">12</span><span class="w"></span>
<span class="o">/</span><span class="mi">13</span><span class="w"></span>
<span class="o">/</span><span class="mi">14</span><span class="w"></span>
<span class="o">/</span><span class="mi">15</span><span class="w"></span>
<span class="o">/</span><span class="mi">16</span><span class="w"></span>
<span class="o">/</span><span class="mi">17</span><span class="w"></span>
<span class="o">/</span><span class="mi">18</span><span class="w"></span>
<span class="o">/</span><span class="mi">19</span><span class="w"></span>
<span class="o">/</span><span class="mi">2</span><span class="w"></span>
<span class="o">/</span><span class="mi">20</span><span class="w"></span>
<span class="o">/</span><span class="mi">21</span><span class="w"></span>
<span class="o">/</span><span class="mi">22</span><span class="w"></span>
<span class="o">/</span><span class="mi">23</span><span class="w"></span>
<span class="o">/</span><span class="mi">24</span><span class="w"></span>
<span class="o">/</span><span class="mi">25</span><span class="w"></span>
<span class="o">/</span><span class="mi">26</span><span class="w"></span>
<span class="o">/</span><span class="mi">27</span><span class="w"></span>
<span class="o">/</span><span class="mi">28</span><span class="w"></span>
<span class="o">/</span><span class="mi">29</span><span class="w"></span>
<span class="o">/</span><span class="mi">3</span><span class="w"></span>
<span class="o">/</span><span class="mi">30</span><span class="w"></span>
<span class="o">/</span><span class="mi">31</span><span class="w"></span>
<span class="o">/</span><span class="mi">32</span><span class="w"></span>
<span class="o">/</span><span class="mi">33</span><span class="w"></span>
<span class="o">/</span><span class="mi">34</span><span class="w"></span>
<span class="o">/</span><span class="mi">35</span><span class="w"></span>
<span class="o">/</span><span class="mi">36</span><span class="w"></span>
<span class="o">/</span><span class="mi">37</span><span class="w"></span>
<span class="o">/</span><span class="mi">38</span><span class="w"></span>
<span class="o">/</span><span class="mi">39</span><span class="w"></span>
<span class="o">/</span><span class="mi">4</span><span class="w"></span>
<span class="o">/</span><span class="mi">40</span><span class="w"></span>
<span class="o">/</span><span class="mi">41</span><span class="w"></span>
<span class="o">/</span><span class="mi">42</span><span class="w"></span>
<span class="o">/</span><span class="mi">43</span><span class="w"></span>
<span class="o">/</span><span class="mi">44</span><span class="w"></span>
<span class="o">/</span><span class="mi">45</span><span class="w"></span>
<span class="o">/</span><span class="mi">46</span><span class="w"></span>
<span class="o">/</span><span class="mi">47</span><span class="w"></span>
<span class="o">/</span><span class="mi">48</span><span class="w"></span>
<span class="o">/</span><span class="mi">49</span><span class="w"></span>
<span class="o">/</span><span class="mi">5</span><span class="w"></span>
<span class="o">/</span><span class="mi">6</span><span class="w"></span>
<span class="o">/</span><span class="mi">7</span><span class="w"></span>
<span class="o">/</span><span class="mi">8</span><span class="w"></span>
<span class="o">/</span><span class="mi">9</span><span class="w"></span>
</code></pre></div>
<p>The relevant code on the Rust side also hasn't been updated in 2 years, also confirming it's likely a runtime environment issue: <a href="https://github.com/rust-lang/rust/blob/643a79af3d5a31fa87c8a4c9d7f8bc4ebe2add4b/library/std/src/sys/wasi/fs.rs#L164">https://github.com/rust-lang/rust/blob/643a79af3d5a31fa87c8a4c9d7f8bc4ebe2add4b/library/std/src/sys/wasi/fs.rs#L164</a></p>
</blockquote>



<a name="224383657"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20Issue%20%232618%20Readdir%20doesn%27t%20correctly%20handle%20c.../near/224383657" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20Issue.20.232618.20Readdir.20doesn.27t.20correctly.20handle.20c.2E.2E.2E.html#224383657">(Jan 28 2021 at 19:54)</a>:</h4>
<p>peterhuene labeled <a href="https://github.com/bytecodealliance/wasmtime/issues/2618">Issue #2618</a>:</p>
<blockquote>
<p>Try to compile this sample code to WASI:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="k">fn</span> <span class="nf">main</span><span class="p">()</span><span class="w"> </span>-&gt; <span class="nc">std</span>::<span class="n">io</span>::<span class="nb">Result</span><span class="o">&lt;</span><span class="p">()</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="n">entry</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="n">std</span>::<span class="n">fs</span>::<span class="n">read_dir</span><span class="p">(</span><span class="s">"/"</span><span class="p">)</span><span class="o">?</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="fm">println!</span><span class="p">(</span><span class="s">"{}"</span><span class="p">,</span><span class="w"> </span><span class="n">entry</span><span class="o">?</span><span class="p">.</span><span class="n">path</span><span class="p">().</span><span class="n">display</span><span class="p">());</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="nb">Ok</span><span class="p">(())</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>
<p>Then, choose a large-ish folder - e.g. I created a temporary directory with 50 files named 0...49.</p>
<p>Run the produced Wasm with Wasmtime with that directory mapped to <code>/</code>:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="cp">$</span><span class="w"> </span><span class="n">wasmtime</span><span class="w"> </span><span class="n">temp</span><span class="p">.</span><span class="n">wasm</span><span class="w"> </span><span class="o">--</span><span class="n">mapdir</span><span class="w"> </span><span class="o">/</span>::<span class="cp">$PWD</span><span class="o">/</span><span class="n">temp</span><span class="o">-</span><span class="n">dir</span><span class="w"></span>
<span class="o">/</span><span class="mi">1</span><span class="w"></span>
<span class="o">/</span><span class="mi">2</span><span class="w"></span>
<span class="o">/</span><span class="mi">49</span><span class="w"></span>
<span class="n">thread</span><span class="w"> </span><span class="o">'</span><span class="na">main</span><span class="o">'</span><span class="w"> </span><span class="n">panicked</span><span class="w"> </span><span class="n">at</span><span class="w"> </span><span class="o">'</span><span class="na">range</span><span class="w"> </span><span class="n">end</span><span class="w"> </span><span class="n">index</span><span class="w"> </span><span class="mi">1214</span><span class="w"> </span><span class="n">out</span><span class="w"> </span><span class="n">of</span><span class="w"> </span><span class="n">range</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">slice</span><span class="w"> </span><span class="n">of</span><span class="w"> </span><span class="n">length</span><span class="w"> </span><span class="mi">128</span><span class="o">'</span><span class="p">,</span><span class="w"> </span><span class="n">library</span><span class="o">/</span><span class="n">std</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">sys</span><span class="o">/</span><span class="n">wasi</span><span class="o">/</span><span class="n">fs</span><span class="p">.</span><span class="n">rs</span>:<span class="mi">164</span>:<span class="mi">25</span><span class="w"></span>
<span class="n">note</span>: <span class="nc">run</span><span class="w"> </span><span class="n">with</span><span class="w"> </span><span class="err">`</span><span class="n">RUST_BACKTRACE</span><span class="o">=</span><span class="mi">1</span><span class="err">`</span><span class="w"> </span><span class="n">environment</span><span class="w"> </span><span class="n">variable</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">display</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="n">backtrace</span><span class="w"></span>
<span class="n">Error</span>: <span class="nc">failed</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">run</span><span class="w"> </span><span class="n">main</span><span class="w"> </span><span class="n">module</span><span class="w"> </span><span class="err">`</span><span class="n">temp</span><span class="p">.</span><span class="n">wasm</span><span class="err">`</span><span class="w"></span>

<span class="n">Caused</span><span class="w"> </span><span class="n">by</span>:
    <span class="mi">0</span>: <span class="nc">failed</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">invoke</span><span class="w"> </span><span class="n">command</span><span class="w"> </span><span class="n">default</span><span class="w"></span>
<span class="w">    </span><span class="mi">1</span>: <span class="nc">wasm</span><span class="w"> </span><span class="n">trap</span>: <span class="nc">unreachable</span><span class="w"></span>
<span class="w">       </span><span class="n">wasm</span><span class="w"> </span><span class="n">backtrace</span>:
           <span class="mi">0</span>: <span class="mh">0xd581</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="o">&lt;</span><span class="n">unknown</span><span class="o">&gt;!</span><span class="n">__rust_start_panic</span><span class="w"></span>
<span class="w">           </span><span class="mi">1</span>: <span class="mh">0xd223</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="o">&lt;</span><span class="n">unknown</span><span class="o">&gt;!</span><span class="n">rust_panic</span><span class="w"></span>
<span class="w">           </span><span class="mi">2</span>: <span class="mh">0xcdfb</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="o">&lt;</span><span class="n">unknown</span><span class="o">&gt;!</span><span class="n">std</span>::<span class="n">panicking</span>::<span class="n">rust_panic_with_hook</span>::<span class="n">h7412819944345424</span><span class="w"></span>
<span class="w">           </span><span class="mi">3</span>: <span class="mh">0xc36e</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="o">&lt;</span><span class="n">unknown</span><span class="o">&gt;!</span><span class="n">std</span>::<span class="n">panicking</span>::<span class="n">begin_panic_handler</span>::<span class="p">{{</span><span class="n">closure</span><span class="p">}}</span>::<span class="n">h4738c0049ce98322</span><span class="w"></span>
<span class="w">           </span><span class="mi">4</span>: <span class="mh">0xc2af</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="o">&lt;</span><span class="n">unknown</span><span class="o">&gt;!</span><span class="n">std</span>::<span class="n">sys_common</span>::<span class="n">backtrace</span>::<span class="n">__rust_end_short_backtrace</span>::<span class="n">h8bb6e3f06234953f</span><span class="w"></span>
<span class="w">           </span><span class="mi">5</span>: <span class="mh">0xcc9f</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="o">&lt;</span><span class="n">unknown</span><span class="o">&gt;!</span><span class="n">rust_begin_unwind</span><span class="w"></span>
<span class="w">           </span><span class="mi">6</span>: <span class="mh">0x12d4e</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="o">&lt;</span><span class="n">unknown</span><span class="o">&gt;!</span><span class="n">core</span>::<span class="n">panicking</span>::<span class="n">panic_fmt</span>::<span class="n">h904ce09f3cb14707</span><span class="w"></span>
<span class="w">           </span><span class="mi">7</span>: <span class="mh">0x12432</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="o">&lt;</span><span class="n">unknown</span><span class="o">&gt;!</span><span class="n">core</span>::<span class="n">slice</span>::<span class="n">index</span>::<span class="n">slice_end_index_len_fail</span>::<span class="n">hcdd59b2bc02fd78c</span><span class="w"></span>
<span class="w">           </span><span class="mi">8</span>: <span class="mh">0x9bd9</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="o">&lt;</span><span class="n">unknown</span><span class="o">&gt;!&lt;</span><span class="n">std</span>::<span class="n">sys</span>::<span class="n">wasi</span>::<span class="n">fs</span>::<span class="n">ReadDir</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">core</span>::<span class="n">iter</span>::<span class="n">traits</span>::<span class="n">iterator</span>::<span class="nb">Iterator</span><span class="o">&gt;</span>::<span class="n">next</span>::<span class="n">h53073ad4dd8c7879</span><span class="w"></span>
<span class="w">           </span><span class="mi">9</span>: <span class="mh">0x96ff</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="o">&lt;</span><span class="n">unknown</span><span class="o">&gt;!&lt;</span><span class="n">std</span>::<span class="n">fs</span>::<span class="n">ReadDir</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">core</span>::<span class="n">iter</span>::<span class="n">traits</span>::<span class="n">iterator</span>::<span class="nb">Iterator</span><span class="o">&gt;</span>::<span class="n">next</span>::<span class="n">h35e43cb49f6132cb</span><span class="w"></span>
<span class="w">          </span><span class="mi">10</span>:  <span class="mh">0x9de</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="o">&lt;</span><span class="n">unknown</span><span class="o">&gt;!</span><span class="n">temp</span>::<span class="n">main</span>::<span class="n">h0ae35bb072c9f0ef</span><span class="w"></span>
<span class="w">          </span><span class="mi">11</span>: <span class="mh">0x1c90</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="o">&lt;</span><span class="n">unknown</span><span class="o">&gt;!</span><span class="n">core</span>::<span class="n">ops</span>::<span class="n">function</span>::<span class="nb">FnOnce</span>::<span class="n">call_once</span>::<span class="n">hf1fda840e003cdf0</span><span class="w"></span>
<span class="w">          </span><span class="mi">12</span>: <span class="mh">0x2820</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="o">&lt;</span><span class="n">unknown</span><span class="o">&gt;!</span><span class="n">std</span>::<span class="n">sys_common</span>::<span class="n">backtrace</span>::<span class="n">__rust_begin_short_backtrace</span>::<span class="n">hf0b5aa48499a3256</span><span class="w"></span>
<span class="w">          </span><span class="mi">13</span>: <span class="mh">0x3e5b</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="o">&lt;</span><span class="n">unknown</span><span class="o">&gt;!</span><span class="n">std</span>::<span class="n">rt</span>::<span class="n">lang_start</span>::<span class="p">{{</span><span class="n">closure</span><span class="p">}}</span>::<span class="n">h6eaa3cdacd789dba</span><span class="w"></span>
<span class="w">          </span><span class="mi">14</span>: <span class="mh">0xd334</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="o">&lt;</span><span class="n">unknown</span><span class="o">&gt;!</span><span class="n">std</span>::<span class="n">rt</span>::<span class="n">lang_start_internal</span>::<span class="n">h0e1571f3e9f07dad</span><span class="w"></span>
<span class="w">          </span><span class="mi">15</span>: <span class="mh">0x3dfc</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="o">&lt;</span><span class="n">unknown</span><span class="o">&gt;!</span><span class="n">std</span>::<span class="n">rt</span>::<span class="n">lang_start</span>::<span class="n">h382cc3264c9b1456</span><span class="w"></span>
<span class="w">          </span><span class="mi">16</span>: <span class="mh">0x1483</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="o">&lt;</span><span class="n">unknown</span><span class="o">&gt;!</span><span class="n">__original_main</span><span class="w"></span>
<span class="w">          </span><span class="mi">17</span>:  <span class="mh">0x527</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="o">&lt;</span><span class="n">unknown</span><span class="o">&gt;!</span><span class="n">_start</span><span class="w"></span>
<span class="w">       </span><span class="n">note</span>: <span class="nc">run</span><span class="w"> </span><span class="n">with</span><span class="w"> </span><span class="err">`</span><span class="n">WASMTIME_BACKTRACE_DETAILS</span><span class="o">=</span><span class="mi">1</span><span class="err">`</span><span class="w"> </span><span class="n">environment</span><span class="w"> </span><span class="n">variable</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">display</span><span class="w"> </span><span class="n">more</span><span class="w"> </span><span class="n">information</span><span class="w"></span>
</code></pre></div>
<p>Same code against the same folder works fine with Wasmer, suggesting it's an environment issue not Rust stdlib issue:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="o">/</span><span class="mi">0</span><span class="w"></span>
<span class="o">/</span><span class="mi">1</span><span class="w"></span>
<span class="o">/</span><span class="mi">10</span><span class="w"></span>
<span class="o">/</span><span class="mi">11</span><span class="w"></span>
<span class="o">/</span><span class="mi">12</span><span class="w"></span>
<span class="o">/</span><span class="mi">13</span><span class="w"></span>
<span class="o">/</span><span class="mi">14</span><span class="w"></span>
<span class="o">/</span><span class="mi">15</span><span class="w"></span>
<span class="o">/</span><span class="mi">16</span><span class="w"></span>
<span class="o">/</span><span class="mi">17</span><span class="w"></span>
<span class="o">/</span><span class="mi">18</span><span class="w"></span>
<span class="o">/</span><span class="mi">19</span><span class="w"></span>
<span class="o">/</span><span class="mi">2</span><span class="w"></span>
<span class="o">/</span><span class="mi">20</span><span class="w"></span>
<span class="o">/</span><span class="mi">21</span><span class="w"></span>
<span class="o">/</span><span class="mi">22</span><span class="w"></span>
<span class="o">/</span><span class="mi">23</span><span class="w"></span>
<span class="o">/</span><span class="mi">24</span><span class="w"></span>
<span class="o">/</span><span class="mi">25</span><span class="w"></span>
<span class="o">/</span><span class="mi">26</span><span class="w"></span>
<span class="o">/</span><span class="mi">27</span><span class="w"></span>
<span class="o">/</span><span class="mi">28</span><span class="w"></span>
<span class="o">/</span><span class="mi">29</span><span class="w"></span>
<span class="o">/</span><span class="mi">3</span><span class="w"></span>
<span class="o">/</span><span class="mi">30</span><span class="w"></span>
<span class="o">/</span><span class="mi">31</span><span class="w"></span>
<span class="o">/</span><span class="mi">32</span><span class="w"></span>
<span class="o">/</span><span class="mi">33</span><span class="w"></span>
<span class="o">/</span><span class="mi">34</span><span class="w"></span>
<span class="o">/</span><span class="mi">35</span><span class="w"></span>
<span class="o">/</span><span class="mi">36</span><span class="w"></span>
<span class="o">/</span><span class="mi">37</span><span class="w"></span>
<span class="o">/</span><span class="mi">38</span><span class="w"></span>
<span class="o">/</span><span class="mi">39</span><span class="w"></span>
<span class="o">/</span><span class="mi">4</span><span class="w"></span>
<span class="o">/</span><span class="mi">40</span><span class="w"></span>
<span class="o">/</span><span class="mi">41</span><span class="w"></span>
<span class="o">/</span><span class="mi">42</span><span class="w"></span>
<span class="o">/</span><span class="mi">43</span><span class="w"></span>
<span class="o">/</span><span class="mi">44</span><span class="w"></span>
<span class="o">/</span><span class="mi">45</span><span class="w"></span>
<span class="o">/</span><span class="mi">46</span><span class="w"></span>
<span class="o">/</span><span class="mi">47</span><span class="w"></span>
<span class="o">/</span><span class="mi">48</span><span class="w"></span>
<span class="o">/</span><span class="mi">49</span><span class="w"></span>
<span class="o">/</span><span class="mi">5</span><span class="w"></span>
<span class="o">/</span><span class="mi">6</span><span class="w"></span>
<span class="o">/</span><span class="mi">7</span><span class="w"></span>
<span class="o">/</span><span class="mi">8</span><span class="w"></span>
<span class="o">/</span><span class="mi">9</span><span class="w"></span>
</code></pre></div>
<p>The relevant code on the Rust side also hasn't been updated in 2 years, also confirming it's likely a runtime environment issue: <a href="https://github.com/rust-lang/rust/blob/643a79af3d5a31fa87c8a4c9d7f8bc4ebe2add4b/library/std/src/sys/wasi/fs.rs#L164">https://github.com/rust-lang/rust/blob/643a79af3d5a31fa87c8a4c9d7f8bc4ebe2add4b/library/std/src/sys/wasi/fs.rs#L164</a></p>
</blockquote>



<a name="224383689"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20Issue%20%232618%20Readdir%20doesn%27t%20correctly%20handle%20c.../near/224383689" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20Issue.20.232618.20Readdir.20doesn.27t.20correctly.20handle.20c.2E.2E.2E.html#224383689">(Jan 28 2021 at 19:54)</a>:</h4>
<p>peterhuene labeled <a href="https://github.com/bytecodealliance/wasmtime/issues/2618">Issue #2618</a>:</p>
<blockquote>
<p>Try to compile this sample code to WASI:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="k">fn</span> <span class="nf">main</span><span class="p">()</span><span class="w"> </span>-&gt; <span class="nc">std</span>::<span class="n">io</span>::<span class="nb">Result</span><span class="o">&lt;</span><span class="p">()</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="n">entry</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="n">std</span>::<span class="n">fs</span>::<span class="n">read_dir</span><span class="p">(</span><span class="s">"/"</span><span class="p">)</span><span class="o">?</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="fm">println!</span><span class="p">(</span><span class="s">"{}"</span><span class="p">,</span><span class="w"> </span><span class="n">entry</span><span class="o">?</span><span class="p">.</span><span class="n">path</span><span class="p">().</span><span class="n">display</span><span class="p">());</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="nb">Ok</span><span class="p">(())</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>
<p>Then, choose a large-ish folder - e.g. I created a temporary directory with 50 files named 0...49.</p>
<p>Run the produced Wasm with Wasmtime with that directory mapped to <code>/</code>:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="cp">$</span><span class="w"> </span><span class="n">wasmtime</span><span class="w"> </span><span class="n">temp</span><span class="p">.</span><span class="n">wasm</span><span class="w"> </span><span class="o">--</span><span class="n">mapdir</span><span class="w"> </span><span class="o">/</span>::<span class="cp">$PWD</span><span class="o">/</span><span class="n">temp</span><span class="o">-</span><span class="n">dir</span><span class="w"></span>
<span class="o">/</span><span class="mi">1</span><span class="w"></span>
<span class="o">/</span><span class="mi">2</span><span class="w"></span>
<span class="o">/</span><span class="mi">49</span><span class="w"></span>
<span class="n">thread</span><span class="w"> </span><span class="o">'</span><span class="na">main</span><span class="o">'</span><span class="w"> </span><span class="n">panicked</span><span class="w"> </span><span class="n">at</span><span class="w"> </span><span class="o">'</span><span class="na">range</span><span class="w"> </span><span class="n">end</span><span class="w"> </span><span class="n">index</span><span class="w"> </span><span class="mi">1214</span><span class="w"> </span><span class="n">out</span><span class="w"> </span><span class="n">of</span><span class="w"> </span><span class="n">range</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">slice</span><span class="w"> </span><span class="n">of</span><span class="w"> </span><span class="n">length</span><span class="w"> </span><span class="mi">128</span><span class="o">'</span><span class="p">,</span><span class="w"> </span><span class="n">library</span><span class="o">/</span><span class="n">std</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">sys</span><span class="o">/</span><span class="n">wasi</span><span class="o">/</span><span class="n">fs</span><span class="p">.</span><span class="n">rs</span>:<span class="mi">164</span>:<span class="mi">25</span><span class="w"></span>
<span class="n">note</span>: <span class="nc">run</span><span class="w"> </span><span class="n">with</span><span class="w"> </span><span class="err">`</span><span class="n">RUST_BACKTRACE</span><span class="o">=</span><span class="mi">1</span><span class="err">`</span><span class="w"> </span><span class="n">environment</span><span class="w"> </span><span class="n">variable</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">display</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="n">backtrace</span><span class="w"></span>
<span class="n">Error</span>: <span class="nc">failed</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">run</span><span class="w"> </span><span class="n">main</span><span class="w"> </span><span class="n">module</span><span class="w"> </span><span class="err">`</span><span class="n">temp</span><span class="p">.</span><span class="n">wasm</span><span class="err">`</span><span class="w"></span>

<span class="n">Caused</span><span class="w"> </span><span class="n">by</span>:
    <span class="mi">0</span>: <span class="nc">failed</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">invoke</span><span class="w"> </span><span class="n">command</span><span class="w"> </span><span class="n">default</span><span class="w"></span>
<span class="w">    </span><span class="mi">1</span>: <span class="nc">wasm</span><span class="w"> </span><span class="n">trap</span>: <span class="nc">unreachable</span><span class="w"></span>
<span class="w">       </span><span class="n">wasm</span><span class="w"> </span><span class="n">backtrace</span>:
           <span class="mi">0</span>: <span class="mh">0xd581</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="o">&lt;</span><span class="n">unknown</span><span class="o">&gt;!</span><span class="n">__rust_start_panic</span><span class="w"></span>
<span class="w">           </span><span class="mi">1</span>: <span class="mh">0xd223</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="o">&lt;</span><span class="n">unknown</span><span class="o">&gt;!</span><span class="n">rust_panic</span><span class="w"></span>
<span class="w">           </span><span class="mi">2</span>: <span class="mh">0xcdfb</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="o">&lt;</span><span class="n">unknown</span><span class="o">&gt;!</span><span class="n">std</span>::<span class="n">panicking</span>::<span class="n">rust_panic_with_hook</span>::<span class="n">h7412819944345424</span><span class="w"></span>
<span class="w">           </span><span class="mi">3</span>: <span class="mh">0xc36e</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="o">&lt;</span><span class="n">unknown</span><span class="o">&gt;!</span><span class="n">std</span>::<span class="n">panicking</span>::<span class="n">begin_panic_handler</span>::<span class="p">{{</span><span class="n">closure</span><span class="p">}}</span>::<span class="n">h4738c0049ce98322</span><span class="w"></span>
<span class="w">           </span><span class="mi">4</span>: <span class="mh">0xc2af</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="o">&lt;</span><span class="n">unknown</span><span class="o">&gt;!</span><span class="n">std</span>::<span class="n">sys_common</span>::<span class="n">backtrace</span>::<span class="n">__rust_end_short_backtrace</span>::<span class="n">h8bb6e3f06234953f</span><span class="w"></span>
<span class="w">           </span><span class="mi">5</span>: <span class="mh">0xcc9f</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="o">&lt;</span><span class="n">unknown</span><span class="o">&gt;!</span><span class="n">rust_begin_unwind</span><span class="w"></span>
<span class="w">           </span><span class="mi">6</span>: <span class="mh">0x12d4e</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="o">&lt;</span><span class="n">unknown</span><span class="o">&gt;!</span><span class="n">core</span>::<span class="n">panicking</span>::<span class="n">panic_fmt</span>::<span class="n">h904ce09f3cb14707</span><span class="w"></span>
<span class="w">           </span><span class="mi">7</span>: <span class="mh">0x12432</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="o">&lt;</span><span class="n">unknown</span><span class="o">&gt;!</span><span class="n">core</span>::<span class="n">slice</span>::<span class="n">index</span>::<span class="n">slice_end_index_len_fail</span>::<span class="n">hcdd59b2bc02fd78c</span><span class="w"></span>
<span class="w">           </span><span class="mi">8</span>: <span class="mh">0x9bd9</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="o">&lt;</span><span class="n">unknown</span><span class="o">&gt;!&lt;</span><span class="n">std</span>::<span class="n">sys</span>::<span class="n">wasi</span>::<span class="n">fs</span>::<span class="n">ReadDir</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">core</span>::<span class="n">iter</span>::<span class="n">traits</span>::<span class="n">iterator</span>::<span class="nb">Iterator</span><span class="o">&gt;</span>::<span class="n">next</span>::<span class="n">h53073ad4dd8c7879</span><span class="w"></span>
<span class="w">           </span><span class="mi">9</span>: <span class="mh">0x96ff</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="o">&lt;</span><span class="n">unknown</span><span class="o">&gt;!&lt;</span><span class="n">std</span>::<span class="n">fs</span>::<span class="n">ReadDir</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">core</span>::<span class="n">iter</span>::<span class="n">traits</span>::<span class="n">iterator</span>::<span class="nb">Iterator</span><span class="o">&gt;</span>::<span class="n">next</span>::<span class="n">h35e43cb49f6132cb</span><span class="w"></span>
<span class="w">          </span><span class="mi">10</span>:  <span class="mh">0x9de</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="o">&lt;</span><span class="n">unknown</span><span class="o">&gt;!</span><span class="n">temp</span>::<span class="n">main</span>::<span class="n">h0ae35bb072c9f0ef</span><span class="w"></span>
<span class="w">          </span><span class="mi">11</span>: <span class="mh">0x1c90</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="o">&lt;</span><span class="n">unknown</span><span class="o">&gt;!</span><span class="n">core</span>::<span class="n">ops</span>::<span class="n">function</span>::<span class="nb">FnOnce</span>::<span class="n">call_once</span>::<span class="n">hf1fda840e003cdf0</span><span class="w"></span>
<span class="w">          </span><span class="mi">12</span>: <span class="mh">0x2820</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="o">&lt;</span><span class="n">unknown</span><span class="o">&gt;!</span><span class="n">std</span>::<span class="n">sys_common</span>::<span class="n">backtrace</span>::<span class="n">__rust_begin_short_backtrace</span>::<span class="n">hf0b5aa48499a3256</span><span class="w"></span>
<span class="w">          </span><span class="mi">13</span>: <span class="mh">0x3e5b</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="o">&lt;</span><span class="n">unknown</span><span class="o">&gt;!</span><span class="n">std</span>::<span class="n">rt</span>::<span class="n">lang_start</span>::<span class="p">{{</span><span class="n">closure</span><span class="p">}}</span>::<span class="n">h6eaa3cdacd789dba</span><span class="w"></span>
<span class="w">          </span><span class="mi">14</span>: <span class="mh">0xd334</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="o">&lt;</span><span class="n">unknown</span><span class="o">&gt;!</span><span class="n">std</span>::<span class="n">rt</span>::<span class="n">lang_start_internal</span>::<span class="n">h0e1571f3e9f07dad</span><span class="w"></span>
<span class="w">          </span><span class="mi">15</span>: <span class="mh">0x3dfc</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="o">&lt;</span><span class="n">unknown</span><span class="o">&gt;!</span><span class="n">std</span>::<span class="n">rt</span>::<span class="n">lang_start</span>::<span class="n">h382cc3264c9b1456</span><span class="w"></span>
<span class="w">          </span><span class="mi">16</span>: <span class="mh">0x1483</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="o">&lt;</span><span class="n">unknown</span><span class="o">&gt;!</span><span class="n">__original_main</span><span class="w"></span>
<span class="w">          </span><span class="mi">17</span>:  <span class="mh">0x527</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="o">&lt;</span><span class="n">unknown</span><span class="o">&gt;!</span><span class="n">_start</span><span class="w"></span>
<span class="w">       </span><span class="n">note</span>: <span class="nc">run</span><span class="w"> </span><span class="n">with</span><span class="w"> </span><span class="err">`</span><span class="n">WASMTIME_BACKTRACE_DETAILS</span><span class="o">=</span><span class="mi">1</span><span class="err">`</span><span class="w"> </span><span class="n">environment</span><span class="w"> </span><span class="n">variable</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">display</span><span class="w"> </span><span class="n">more</span><span class="w"> </span><span class="n">information</span><span class="w"></span>
</code></pre></div>
<p>Same code against the same folder works fine with Wasmer, suggesting it's an environment issue not Rust stdlib issue:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="o">/</span><span class="mi">0</span><span class="w"></span>
<span class="o">/</span><span class="mi">1</span><span class="w"></span>
<span class="o">/</span><span class="mi">10</span><span class="w"></span>
<span class="o">/</span><span class="mi">11</span><span class="w"></span>
<span class="o">/</span><span class="mi">12</span><span class="w"></span>
<span class="o">/</span><span class="mi">13</span><span class="w"></span>
<span class="o">/</span><span class="mi">14</span><span class="w"></span>
<span class="o">/</span><span class="mi">15</span><span class="w"></span>
<span class="o">/</span><span class="mi">16</span><span class="w"></span>
<span class="o">/</span><span class="mi">17</span><span class="w"></span>
<span class="o">/</span><span class="mi">18</span><span class="w"></span>
<span class="o">/</span><span class="mi">19</span><span class="w"></span>
<span class="o">/</span><span class="mi">2</span><span class="w"></span>
<span class="o">/</span><span class="mi">20</span><span class="w"></span>
<span class="o">/</span><span class="mi">21</span><span class="w"></span>
<span class="o">/</span><span class="mi">22</span><span class="w"></span>
<span class="o">/</span><span class="mi">23</span><span class="w"></span>
<span class="o">/</span><span class="mi">24</span><span class="w"></span>
<span class="o">/</span><span class="mi">25</span><span class="w"></span>
<span class="o">/</span><span class="mi">26</span><span class="w"></span>
<span class="o">/</span><span class="mi">27</span><span class="w"></span>
<span class="o">/</span><span class="mi">28</span><span class="w"></span>
<span class="o">/</span><span class="mi">29</span><span class="w"></span>
<span class="o">/</span><span class="mi">3</span><span class="w"></span>
<span class="o">/</span><span class="mi">30</span><span class="w"></span>
<span class="o">/</span><span class="mi">31</span><span class="w"></span>
<span class="o">/</span><span class="mi">32</span><span class="w"></span>
<span class="o">/</span><span class="mi">33</span><span class="w"></span>
<span class="o">/</span><span class="mi">34</span><span class="w"></span>
<span class="o">/</span><span class="mi">35</span><span class="w"></span>
<span class="o">/</span><span class="mi">36</span><span class="w"></span>
<span class="o">/</span><span class="mi">37</span><span class="w"></span>
<span class="o">/</span><span class="mi">38</span><span class="w"></span>
<span class="o">/</span><span class="mi">39</span><span class="w"></span>
<span class="o">/</span><span class="mi">4</span><span class="w"></span>
<span class="o">/</span><span class="mi">40</span><span class="w"></span>
<span class="o">/</span><span class="mi">41</span><span class="w"></span>
<span class="o">/</span><span class="mi">42</span><span class="w"></span>
<span class="o">/</span><span class="mi">43</span><span class="w"></span>
<span class="o">/</span><span class="mi">44</span><span class="w"></span>
<span class="o">/</span><span class="mi">45</span><span class="w"></span>
<span class="o">/</span><span class="mi">46</span><span class="w"></span>
<span class="o">/</span><span class="mi">47</span><span class="w"></span>
<span class="o">/</span><span class="mi">48</span><span class="w"></span>
<span class="o">/</span><span class="mi">49</span><span class="w"></span>
<span class="o">/</span><span class="mi">5</span><span class="w"></span>
<span class="o">/</span><span class="mi">6</span><span class="w"></span>
<span class="o">/</span><span class="mi">7</span><span class="w"></span>
<span class="o">/</span><span class="mi">8</span><span class="w"></span>
<span class="o">/</span><span class="mi">9</span><span class="w"></span>
</code></pre></div>
<p>The relevant code on the Rust side also hasn't been updated in 2 years, also confirming it's likely a runtime environment issue: <a href="https://github.com/rust-lang/rust/blob/643a79af3d5a31fa87c8a4c9d7f8bc4ebe2add4b/library/std/src/sys/wasi/fs.rs#L164">https://github.com/rust-lang/rust/blob/643a79af3d5a31fa87c8a4c9d7f8bc4ebe2add4b/library/std/src/sys/wasi/fs.rs#L164</a></p>
</blockquote>



<a name="224383721"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20Issue%20%232618%20Readdir%20doesn%27t%20correctly%20handle%20c.../near/224383721" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20Issue.20.232618.20Readdir.20doesn.27t.20correctly.20handle.20c.2E.2E.2E.html#224383721">(Jan 28 2021 at 19:55)</a>:</h4>
<p>github-actions[bot] <a href="https://github.com/bytecodealliance/wasmtime/issues/2618#issuecomment-769338441">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/2618">Issue #2618</a>:</p>
<blockquote>
<h4>Subscribe to Label Action</h4>
<p>cc @kubkon</p>
<p>&lt;details&gt;<br>
This issue or pull request has been labeled: "wasi"</p>
<p>Thus the following users have been cc'd because of the following labels:</p>
<ul>
<li>kubkon: wasi</li>
</ul>
<p>To subscribe or unsubscribe from this label, edit the &lt;code&gt;.github/subscribe-to-label.json&lt;/code&gt; configuration file.</p>
<p><a href="https://github.com/bytecodealliance/subscribe-to-label-action">Learn more.</a><br>
&lt;/details&gt;</p>
</blockquote>



<a name="224388192"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20Issue%20%232618%20Readdir%20doesn%27t%20correctly%20handle%20c.../near/224388192" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20Issue.20.232618.20Readdir.20doesn.27t.20correctly.20handle.20c.2E.2E.2E.html#224388192">(Jan 28 2021 at 20:31)</a>:</h4>
<p>peterhuene <a href="https://github.com/bytecodealliance/wasmtime/issues/2618#issuecomment-769367277">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/2618">Issue #2618</a>:</p>
<blockquote>
<p>The bug is indeed in Wasmtime's WASI implementation.</p>
<p>Our <code>fd_readdir</code> implementation is returning more bytes used than capacity of the given buffer.  This is because it incorrectly fails to truncate the length of the entry name as it does not take into account the space taken by the <code>dirent</code> structure when calculating how many bytes of the name it can write to the buffer.</p>
<p>I have a fix.</p>
</blockquote>



<a name="224388209"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20Issue%20%232618%20Readdir%20doesn%27t%20correctly%20handle%20c.../near/224388209" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20Issue.20.232618.20Readdir.20doesn.27t.20correctly.20handle.20c.2E.2E.2E.html#224388209">(Jan 28 2021 at 20:31)</a>:</h4>
<p>peterhuene assigned <a href="https://github.com/bytecodealliance/wasmtime/issues/2618">Issue #2618</a> (assigned to peterhuene):</p>
<blockquote>
<p>Try to compile this sample code to WASI:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="k">fn</span> <span class="nf">main</span><span class="p">()</span><span class="w"> </span>-&gt; <span class="nc">std</span>::<span class="n">io</span>::<span class="nb">Result</span><span class="o">&lt;</span><span class="p">()</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="n">entry</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="n">std</span>::<span class="n">fs</span>::<span class="n">read_dir</span><span class="p">(</span><span class="s">"/"</span><span class="p">)</span><span class="o">?</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="fm">println!</span><span class="p">(</span><span class="s">"{}"</span><span class="p">,</span><span class="w"> </span><span class="n">entry</span><span class="o">?</span><span class="p">.</span><span class="n">path</span><span class="p">().</span><span class="n">display</span><span class="p">());</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="nb">Ok</span><span class="p">(())</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>
<p>Then, choose a large-ish folder - e.g. I created a temporary directory with 50 files named 0...49.</p>
<p>Run the produced Wasm with Wasmtime with that directory mapped to <code>/</code>:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="cp">$</span><span class="w"> </span><span class="n">wasmtime</span><span class="w"> </span><span class="n">temp</span><span class="p">.</span><span class="n">wasm</span><span class="w"> </span><span class="o">--</span><span class="n">mapdir</span><span class="w"> </span><span class="o">/</span>::<span class="cp">$PWD</span><span class="o">/</span><span class="n">temp</span><span class="o">-</span><span class="n">dir</span><span class="w"></span>
<span class="o">/</span><span class="mi">1</span><span class="w"></span>
<span class="o">/</span><span class="mi">2</span><span class="w"></span>
<span class="o">/</span><span class="mi">49</span><span class="w"></span>
<span class="n">thread</span><span class="w"> </span><span class="o">'</span><span class="na">main</span><span class="o">'</span><span class="w"> </span><span class="n">panicked</span><span class="w"> </span><span class="n">at</span><span class="w"> </span><span class="o">'</span><span class="na">range</span><span class="w"> </span><span class="n">end</span><span class="w"> </span><span class="n">index</span><span class="w"> </span><span class="mi">1214</span><span class="w"> </span><span class="n">out</span><span class="w"> </span><span class="n">of</span><span class="w"> </span><span class="n">range</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">slice</span><span class="w"> </span><span class="n">of</span><span class="w"> </span><span class="n">length</span><span class="w"> </span><span class="mi">128</span><span class="o">'</span><span class="p">,</span><span class="w"> </span><span class="n">library</span><span class="o">/</span><span class="n">std</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">sys</span><span class="o">/</span><span class="n">wasi</span><span class="o">/</span><span class="n">fs</span><span class="p">.</span><span class="n">rs</span>:<span class="mi">164</span>:<span class="mi">25</span><span class="w"></span>
<span class="n">note</span>: <span class="nc">run</span><span class="w"> </span><span class="n">with</span><span class="w"> </span><span class="err">`</span><span class="n">RUST_BACKTRACE</span><span class="o">=</span><span class="mi">1</span><span class="err">`</span><span class="w"> </span><span class="n">environment</span><span class="w"> </span><span class="n">variable</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">display</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="n">backtrace</span><span class="w"></span>
<span class="n">Error</span>: <span class="nc">failed</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">run</span><span class="w"> </span><span class="n">main</span><span class="w"> </span><span class="n">module</span><span class="w"> </span><span class="err">`</span><span class="n">temp</span><span class="p">.</span><span class="n">wasm</span><span class="err">`</span><span class="w"></span>

<span class="n">Caused</span><span class="w"> </span><span class="n">by</span>:
    <span class="mi">0</span>: <span class="nc">failed</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">invoke</span><span class="w"> </span><span class="n">command</span><span class="w"> </span><span class="n">default</span><span class="w"></span>
<span class="w">    </span><span class="mi">1</span>: <span class="nc">wasm</span><span class="w"> </span><span class="n">trap</span>: <span class="nc">unreachable</span><span class="w"></span>
<span class="w">       </span><span class="n">wasm</span><span class="w"> </span><span class="n">backtrace</span>:
           <span class="mi">0</span>: <span class="mh">0xd581</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="o">&lt;</span><span class="n">unknown</span><span class="o">&gt;!</span><span class="n">__rust_start_panic</span><span class="w"></span>
<span class="w">           </span><span class="mi">1</span>: <span class="mh">0xd223</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="o">&lt;</span><span class="n">unknown</span><span class="o">&gt;!</span><span class="n">rust_panic</span><span class="w"></span>
<span class="w">           </span><span class="mi">2</span>: <span class="mh">0xcdfb</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="o">&lt;</span><span class="n">unknown</span><span class="o">&gt;!</span><span class="n">std</span>::<span class="n">panicking</span>::<span class="n">rust_panic_with_hook</span>::<span class="n">h7412819944345424</span><span class="w"></span>
<span class="w">           </span><span class="mi">3</span>: <span class="mh">0xc36e</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="o">&lt;</span><span class="n">unknown</span><span class="o">&gt;!</span><span class="n">std</span>::<span class="n">panicking</span>::<span class="n">begin_panic_handler</span>::<span class="p">{{</span><span class="n">closure</span><span class="p">}}</span>::<span class="n">h4738c0049ce98322</span><span class="w"></span>
<span class="w">           </span><span class="mi">4</span>: <span class="mh">0xc2af</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="o">&lt;</span><span class="n">unknown</span><span class="o">&gt;!</span><span class="n">std</span>::<span class="n">sys_common</span>::<span class="n">backtrace</span>::<span class="n">__rust_end_short_backtrace</span>::<span class="n">h8bb6e3f06234953f</span><span class="w"></span>
<span class="w">           </span><span class="mi">5</span>: <span class="mh">0xcc9f</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="o">&lt;</span><span class="n">unknown</span><span class="o">&gt;!</span><span class="n">rust_begin_unwind</span><span class="w"></span>
<span class="w">           </span><span class="mi">6</span>: <span class="mh">0x12d4e</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="o">&lt;</span><span class="n">unknown</span><span class="o">&gt;!</span><span class="n">core</span>::<span class="n">panicking</span>::<span class="n">panic_fmt</span>::<span class="n">h904ce09f3cb14707</span><span class="w"></span>
<span class="w">           </span><span class="mi">7</span>: <span class="mh">0x12432</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="o">&lt;</span><span class="n">unknown</span><span class="o">&gt;!</span><span class="n">core</span>::<span class="n">slice</span>::<span class="n">index</span>::<span class="n">slice_end_index_len_fail</span>::<span class="n">hcdd59b2bc02fd78c</span><span class="w"></span>
<span class="w">           </span><span class="mi">8</span>: <span class="mh">0x9bd9</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="o">&lt;</span><span class="n">unknown</span><span class="o">&gt;!&lt;</span><span class="n">std</span>::<span class="n">sys</span>::<span class="n">wasi</span>::<span class="n">fs</span>::<span class="n">ReadDir</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">core</span>::<span class="n">iter</span>::<span class="n">traits</span>::<span class="n">iterator</span>::<span class="nb">Iterator</span><span class="o">&gt;</span>::<span class="n">next</span>::<span class="n">h53073ad4dd8c7879</span><span class="w"></span>
<span class="w">           </span><span class="mi">9</span>: <span class="mh">0x96ff</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="o">&lt;</span><span class="n">unknown</span><span class="o">&gt;!&lt;</span><span class="n">std</span>::<span class="n">fs</span>::<span class="n">ReadDir</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">core</span>::<span class="n">iter</span>::<span class="n">traits</span>::<span class="n">iterator</span>::<span class="nb">Iterator</span><span class="o">&gt;</span>::<span class="n">next</span>::<span class="n">h35e43cb49f6132cb</span><span class="w"></span>
<span class="w">          </span><span class="mi">10</span>:  <span class="mh">0x9de</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="o">&lt;</span><span class="n">unknown</span><span class="o">&gt;!</span><span class="n">temp</span>::<span class="n">main</span>::<span class="n">h0ae35bb072c9f0ef</span><span class="w"></span>
<span class="w">          </span><span class="mi">11</span>: <span class="mh">0x1c90</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="o">&lt;</span><span class="n">unknown</span><span class="o">&gt;!</span><span class="n">core</span>::<span class="n">ops</span>::<span class="n">function</span>::<span class="nb">FnOnce</span>::<span class="n">call_once</span>::<span class="n">hf1fda840e003cdf0</span><span class="w"></span>
<span class="w">          </span><span class="mi">12</span>: <span class="mh">0x2820</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="o">&lt;</span><span class="n">unknown</span><span class="o">&gt;!</span><span class="n">std</span>::<span class="n">sys_common</span>::<span class="n">backtrace</span>::<span class="n">__rust_begin_short_backtrace</span>::<span class="n">hf0b5aa48499a3256</span><span class="w"></span>
<span class="w">          </span><span class="mi">13</span>: <span class="mh">0x3e5b</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="o">&lt;</span><span class="n">unknown</span><span class="o">&gt;!</span><span class="n">std</span>::<span class="n">rt</span>::<span class="n">lang_start</span>::<span class="p">{{</span><span class="n">closure</span><span class="p">}}</span>::<span class="n">h6eaa3cdacd789dba</span><span class="w"></span>
<span class="w">          </span><span class="mi">14</span>: <span class="mh">0xd334</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="o">&lt;</span><span class="n">unknown</span><span class="o">&gt;!</span><span class="n">std</span>::<span class="n">rt</span>::<span class="n">lang_start_internal</span>::<span class="n">h0e1571f3e9f07dad</span><span class="w"></span>
<span class="w">          </span><span class="mi">15</span>: <span class="mh">0x3dfc</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="o">&lt;</span><span class="n">unknown</span><span class="o">&gt;!</span><span class="n">std</span>::<span class="n">rt</span>::<span class="n">lang_start</span>::<span class="n">h382cc3264c9b1456</span><span class="w"></span>
<span class="w">          </span><span class="mi">16</span>: <span class="mh">0x1483</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="o">&lt;</span><span class="n">unknown</span><span class="o">&gt;!</span><span class="n">__original_main</span><span class="w"></span>
<span class="w">          </span><span class="mi">17</span>:  <span class="mh">0x527</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="o">&lt;</span><span class="n">unknown</span><span class="o">&gt;!</span><span class="n">_start</span><span class="w"></span>
<span class="w">       </span><span class="n">note</span>: <span class="nc">run</span><span class="w"> </span><span class="n">with</span><span class="w"> </span><span class="err">`</span><span class="n">WASMTIME_BACKTRACE_DETAILS</span><span class="o">=</span><span class="mi">1</span><span class="err">`</span><span class="w"> </span><span class="n">environment</span><span class="w"> </span><span class="n">variable</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">display</span><span class="w"> </span><span class="n">more</span><span class="w"> </span><span class="n">information</span><span class="w"></span>
</code></pre></div>
<p>Same code against the same folder works fine with Wasmer, suggesting it's an environment issue not Rust stdlib issue:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="o">/</span><span class="mi">0</span><span class="w"></span>
<span class="o">/</span><span class="mi">1</span><span class="w"></span>
<span class="o">/</span><span class="mi">10</span><span class="w"></span>
<span class="o">/</span><span class="mi">11</span><span class="w"></span>
<span class="o">/</span><span class="mi">12</span><span class="w"></span>
<span class="o">/</span><span class="mi">13</span><span class="w"></span>
<span class="o">/</span><span class="mi">14</span><span class="w"></span>
<span class="o">/</span><span class="mi">15</span><span class="w"></span>
<span class="o">/</span><span class="mi">16</span><span class="w"></span>
<span class="o">/</span><span class="mi">17</span><span class="w"></span>
<span class="o">/</span><span class="mi">18</span><span class="w"></span>
<span class="o">/</span><span class="mi">19</span><span class="w"></span>
<span class="o">/</span><span class="mi">2</span><span class="w"></span>
<span class="o">/</span><span class="mi">20</span><span class="w"></span>
<span class="o">/</span><span class="mi">21</span><span class="w"></span>
<span class="o">/</span><span class="mi">22</span><span class="w"></span>
<span class="o">/</span><span class="mi">23</span><span class="w"></span>
<span class="o">/</span><span class="mi">24</span><span class="w"></span>
<span class="o">/</span><span class="mi">25</span><span class="w"></span>
<span class="o">/</span><span class="mi">26</span><span class="w"></span>
<span class="o">/</span><span class="mi">27</span><span class="w"></span>
<span class="o">/</span><span class="mi">28</span><span class="w"></span>
<span class="o">/</span><span class="mi">29</span><span class="w"></span>
<span class="o">/</span><span class="mi">3</span><span class="w"></span>
<span class="o">/</span><span class="mi">30</span><span class="w"></span>
<span class="o">/</span><span class="mi">31</span><span class="w"></span>
<span class="o">/</span><span class="mi">32</span><span class="w"></span>
<span class="o">/</span><span class="mi">33</span><span class="w"></span>
<span class="o">/</span><span class="mi">34</span><span class="w"></span>
<span class="o">/</span><span class="mi">35</span><span class="w"></span>
<span class="o">/</span><span class="mi">36</span><span class="w"></span>
<span class="o">/</span><span class="mi">37</span><span class="w"></span>
<span class="o">/</span><span class="mi">38</span><span class="w"></span>
<span class="o">/</span><span class="mi">39</span><span class="w"></span>
<span class="o">/</span><span class="mi">4</span><span class="w"></span>
<span class="o">/</span><span class="mi">40</span><span class="w"></span>
<span class="o">/</span><span class="mi">41</span><span class="w"></span>
<span class="o">/</span><span class="mi">42</span><span class="w"></span>
<span class="o">/</span><span class="mi">43</span><span class="w"></span>
<span class="o">/</span><span class="mi">44</span><span class="w"></span>
<span class="o">/</span><span class="mi">45</span><span class="w"></span>
<span class="o">/</span><span class="mi">46</span><span class="w"></span>
<span class="o">/</span><span class="mi">47</span><span class="w"></span>
<span class="o">/</span><span class="mi">48</span><span class="w"></span>
<span class="o">/</span><span class="mi">49</span><span class="w"></span>
<span class="o">/</span><span class="mi">5</span><span class="w"></span>
<span class="o">/</span><span class="mi">6</span><span class="w"></span>
<span class="o">/</span><span class="mi">7</span><span class="w"></span>
<span class="o">/</span><span class="mi">8</span><span class="w"></span>
<span class="o">/</span><span class="mi">9</span><span class="w"></span>
</code></pre></div>
<p>The relevant code on the Rust side also hasn't been updated in 2 years, also confirming it's likely a runtime environment issue: <a href="https://github.com/rust-lang/rust/blob/643a79af3d5a31fa87c8a4c9d7f8bc4ebe2add4b/library/std/src/sys/wasi/fs.rs#L164">https://github.com/rust-lang/rust/blob/643a79af3d5a31fa87c8a4c9d7f8bc4ebe2add4b/library/std/src/sys/wasi/fs.rs#L164</a></p>
</blockquote>



<a name="224388243"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20Issue%20%232618%20Readdir%20doesn%27t%20correctly%20handle%20c.../near/224388243" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20Issue.20.232618.20Readdir.20doesn.27t.20correctly.20handle.20c.2E.2E.2E.html#224388243">(Jan 28 2021 at 20:31)</a>:</h4>
<p>peterhuene edited a <a href="https://github.com/bytecodealliance/wasmtime/issues/2618#issuecomment-769367277">comment</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/2618">Issue #2618</a>:</p>
<blockquote>
<p>The bug is indeed in Wasmtime's WASI implementation.</p>
<p>Our <code>fd_readdir</code> implementation is returning more bytes used than capacity of the given buffer in this case.  This is because it incorrectly fails to truncate the length of the entry name as it does not take into account the space taken by the <code>dirent</code> structure when calculating how many bytes of the name it can write to the buffer.</p>
<p>I have a fix.</p>
</blockquote>



<a name="224390291"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20Issue%20%232618%20Readdir%20doesn%27t%20correctly%20handle%20c.../near/224390291" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20Issue.20.232618.20Readdir.20doesn.27t.20correctly.20handle.20c.2E.2E.2E.html#224390291">(Jan 28 2021 at 20:46)</a>:</h4>
<p>peterhuene <a href="https://github.com/bytecodealliance/wasmtime/issues/2618#issuecomment-769378757">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/2618">Issue #2618</a>:</p>
<blockquote>
<p>@RReverser would you mind trying the fix in #2620 and verify it addresses this issue?  Thanks!</p>
</blockquote>



<a name="224396996"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20Issue%20%232618%20Readdir%20doesn%27t%20correctly%20handle%20c.../near/224396996" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20Issue.20.232618.20Readdir.20doesn.27t.20correctly.20handle.20c.2E.2E.2E.html#224396996">(Jan 28 2021 at 21:46)</a>:</h4>
<p>RReverser <a href="https://github.com/bytecodealliance/wasmtime/issues/2618#issuecomment-769420480">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/2618">Issue #2618</a>:</p>
<blockquote>
<p>As long as the sample above works, I trust it's fine. </p>
</blockquote>



<a name="224397046"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20Issue%20%232618%20Readdir%20doesn%27t%20correctly%20handle%20c.../near/224397046" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20Issue.20.232618.20Readdir.20doesn.27t.20correctly.20handle.20c.2E.2E.2E.html#224397046">(Jan 28 2021 at 21:47)</a>:</h4>
<p>RReverser <a href="https://github.com/bytecodealliance/wasmtime/issues/2618#issuecomment-769421042">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/2618">Issue #2618</a>:</p>
<blockquote>
<p>I'd suggest to add it as a regression test to the PR though. </p>
</blockquote>



<a name="224400571"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20Issue%20%232618%20Readdir%20doesn%27t%20correctly%20handle%20c.../near/224400571" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20Issue.20.232618.20Readdir.20doesn.27t.20correctly.20handle.20c.2E.2E.2E.html#224400571">(Jan 28 2021 at 22:09)</a>:</h4>
<p>peterhuene <a href="https://github.com/bytecodealliance/wasmtime/issues/2618#issuecomment-769431859">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/2618">Issue #2618</a>:</p>
<blockquote>
<p>Agreed that there should be a regression test here, but it is a little difficult to mock up currently as it isn't directly related to the number of directory entries, just that the (unstable order of) entries being returned doesn't neatly fit in the buffer given to <code>fd_readdir</code>.</p>
<p>The WASI test programs use a real file system underneath, so we might be able to create a repro test relying on filesystem-specific behavior, perhaps.</p>
<p>The reason I wanted to confirm it addresses what you're seeing is that <code>1214</code> (from your panic above) is a much larger offset than what I'd expect returned when your file names are all really short.</p>
</blockquote>



<a name="224401694"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20Issue%20%232618%20Readdir%20doesn%27t%20correctly%20handle%20c.../near/224401694" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20Issue.20.232618.20Readdir.20doesn.27t.20correctly.20handle.20c.2E.2E.2E.html#224401694">(Jan 28 2021 at 22:14)</a>:</h4>
<p>peterhuene edited a <a href="https://github.com/bytecodealliance/wasmtime/issues/2618#issuecomment-769431859">comment</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/2618">Issue #2618</a>:</p>
<blockquote>
<p>Agreed that there should be a regression test here, but it is a little difficult to mock up currently as it isn't directly related to the number of directory entries, just that the (unstable order of) entries being returned doesn't neatly fit in the buffer given to <code>fd_readdir</code>.</p>
<p>The WASI test programs use a real file system underneath, so we might be able to create a repro test relying on filesystem-specific behavior, perhaps.</p>
<p>The reason I wanted to confirm it addresses what you're seeing is that <code>1214</code> (from your panic above) is a much larger offset than what I'd expect returned when your file names are all really short, but that might be explained by the stdlib impl not expecting a "length used" returned from <code>fd_readdir</code> to be greater than the size of the buffer that was given.</p>
</blockquote>



<a name="224402953"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20Issue%20%232618%20Readdir%20doesn%27t%20correctly%20handle%20c.../near/224402953" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20Issue.20.232618.20Readdir.20doesn.27t.20correctly.20handle.20c.2E.2E.2E.html#224402953">(Jan 28 2021 at 22:22)</a>:</h4>
<p>peterhuene <a href="https://github.com/bytecodealliance/wasmtime/issues/2618#issuecomment-769438402">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/2618">Issue #2618</a>:</p>
<blockquote>
<p>Actually, there's some virtualized filesystem support in the WASI test-programs I'm completely unfamiliar with.  I'll see if we can use this to properly test this for regression.</p>
</blockquote>



<a name="224403476"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20Issue%20%232618%20Readdir%20doesn%27t%20correctly%20handle%20c.../near/224403476" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20Issue.20.232618.20Readdir.20doesn.27t.20correctly.20handle.20c.2E.2E.2E.html#224403476">(Jan 28 2021 at 22:27)</a>:</h4>
<p>peterhuene <a href="https://github.com/bytecodealliance/wasmtime/issues/2618#issuecomment-769440728">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/2618">Issue #2618</a>:</p>
<blockquote>
<p>Hmm, it appears that <code>fd_readdir</code> WASI test program might have a workaround for the bug:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="kd">let</span><span class="w"> </span><span class="n">sl</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">slice</span>::<span class="n">from_raw_parts</span><span class="p">(</span><span class="n">buf</span><span class="p">.</span><span class="n">as_ptr</span><span class="p">(),</span><span class="w"> </span><span class="n">min</span><span class="p">(</span><span class="n">BUF_LEN</span><span class="p">,</span><span class="w"> </span><span class="n">bufused</span><span class="p">));</span><span class="w"></span>
</code></pre></div>
<p>It should be asserting that <code>bufused &lt;= BUF_LEN</code>.</p>
</blockquote>



<a name="224420649"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20Issue%20%232618%20Readdir%20doesn%27t%20correctly%20handle%20c.../near/224420649" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20Issue.20.232618.20Readdir.20doesn.27t.20correctly.20handle.20c.2E.2E.2E.html#224420649">(Jan 29 2021 at 01:30)</a>:</h4>
<p>pchickey <a href="https://github.com/bytecodealliance/wasmtime/issues/2618#issuecomment-769511529">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/2618">Issue #2618</a>:</p>
<blockquote>
<p>The virtualized filesystem support currently only works for files, not directories.</p>
<p>I'm nearly ready to land @sunfishcode's and my lengthy rewrite of wasi-common, and will need to backport the fix for this into my branch. The virtualized filesystem support in the rewrite is much better and we should be able to synthesize this test, or even fuzz this interface, since we keep on getting it wrong!</p>
</blockquote>



<a name="224495756"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20Issue%20%232618%20Readdir%20doesn%27t%20correctly%20handle%20c.../near/224495756" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20Issue.20.232618.20Readdir.20doesn.27t.20correctly.20handle.20c.2E.2E.2E.html#224495756">(Jan 29 2021 at 16:21)</a>:</h4>
<p>RReverser <a href="https://github.com/bytecodealliance/wasmtime/issues/2618#issuecomment-769903568">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/2618">Issue #2618</a>:</p>
<blockquote>
<p>I might also suggest checking out <a href="https://github.com/WebAssembly/WASI/issues/9#issuecomment-760365864">https://github.com/WebAssembly/WASI/issues/9#issuecomment-760365864</a> thread where @caspervonb has been working on a shared WASI testsuite. It seems like Wasmtime might benefit from running the same tests, and, OTOH, the testsuite could include examples like this one with large-ish directories (should be just a matter of adding more files to the <code>fixtures</code> folder).</p>
</blockquote>



<a name="224513905"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20Issue%20%232618%20Readdir%20doesn%27t%20correctly%20handle%20c.../near/224513905" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20Issue.20.232618.20Readdir.20doesn.27t.20correctly.20handle.20c.2E.2E.2E.html#224513905">(Jan 29 2021 at 18:24)</a>:</h4>
<p>pchickey <a href="https://github.com/bytecodealliance/wasmtime/issues/2618#issuecomment-769971146">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/2618">Issue #2618</a>:</p>
<blockquote>
<p>Agreed, we'll be contributing the wasmtime tests to that suite and getting the rest of it run as part of wasmtime's CI soon :)</p>
</blockquote>



<a name="224786189"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20Issue%20%232618%20Readdir%20doesn%27t%20correctly%20handle%20c.../near/224786189" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20Issue.20.232618.20Readdir.20doesn.27t.20correctly.20handle.20c.2E.2E.2E.html#224786189">(Feb 01 2021 at 20:29)</a>:</h4>
<p>peterhuene closed <a href="https://github.com/bytecodealliance/wasmtime/issues/2618">Issue #2618</a> (assigned to peterhuene):</p>
<blockquote>
<p>Try to compile this sample code to WASI:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="k">fn</span> <span class="nf">main</span><span class="p">()</span><span class="w"> </span>-&gt; <span class="nc">std</span>::<span class="n">io</span>::<span class="nb">Result</span><span class="o">&lt;</span><span class="p">()</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="n">entry</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="n">std</span>::<span class="n">fs</span>::<span class="n">read_dir</span><span class="p">(</span><span class="s">"/"</span><span class="p">)</span><span class="o">?</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="fm">println!</span><span class="p">(</span><span class="s">"{}"</span><span class="p">,</span><span class="w"> </span><span class="n">entry</span><span class="o">?</span><span class="p">.</span><span class="n">path</span><span class="p">().</span><span class="n">display</span><span class="p">());</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="nb">Ok</span><span class="p">(())</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>
<p>Then, choose a large-ish folder - e.g. I created a temporary directory with 50 files named 0...49.</p>
<p>Run the produced Wasm with Wasmtime with that directory mapped to <code>/</code>:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="cp">$</span><span class="w"> </span><span class="n">wasmtime</span><span class="w"> </span><span class="n">temp</span><span class="p">.</span><span class="n">wasm</span><span class="w"> </span><span class="o">--</span><span class="n">mapdir</span><span class="w"> </span><span class="o">/</span>::<span class="cp">$PWD</span><span class="o">/</span><span class="n">temp</span><span class="o">-</span><span class="n">dir</span><span class="w"></span>
<span class="o">/</span><span class="mi">1</span><span class="w"></span>
<span class="o">/</span><span class="mi">2</span><span class="w"></span>
<span class="o">/</span><span class="mi">49</span><span class="w"></span>
<span class="n">thread</span><span class="w"> </span><span class="o">'</span><span class="na">main</span><span class="o">'</span><span class="w"> </span><span class="n">panicked</span><span class="w"> </span><span class="n">at</span><span class="w"> </span><span class="o">'</span><span class="na">range</span><span class="w"> </span><span class="n">end</span><span class="w"> </span><span class="n">index</span><span class="w"> </span><span class="mi">1214</span><span class="w"> </span><span class="n">out</span><span class="w"> </span><span class="n">of</span><span class="w"> </span><span class="n">range</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">slice</span><span class="w"> </span><span class="n">of</span><span class="w"> </span><span class="n">length</span><span class="w"> </span><span class="mi">128</span><span class="o">'</span><span class="p">,</span><span class="w"> </span><span class="n">library</span><span class="o">/</span><span class="n">std</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">sys</span><span class="o">/</span><span class="n">wasi</span><span class="o">/</span><span class="n">fs</span><span class="p">.</span><span class="n">rs</span>:<span class="mi">164</span>:<span class="mi">25</span><span class="w"></span>
<span class="n">note</span>: <span class="nc">run</span><span class="w"> </span><span class="n">with</span><span class="w"> </span><span class="err">`</span><span class="n">RUST_BACKTRACE</span><span class="o">=</span><span class="mi">1</span><span class="err">`</span><span class="w"> </span><span class="n">environment</span><span class="w"> </span><span class="n">variable</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">display</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="n">backtrace</span><span class="w"></span>
<span class="n">Error</span>: <span class="nc">failed</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">run</span><span class="w"> </span><span class="n">main</span><span class="w"> </span><span class="n">module</span><span class="w"> </span><span class="err">`</span><span class="n">temp</span><span class="p">.</span><span class="n">wasm</span><span class="err">`</span><span class="w"></span>

<span class="n">Caused</span><span class="w"> </span><span class="n">by</span>:
    <span class="mi">0</span>: <span class="nc">failed</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">invoke</span><span class="w"> </span><span class="n">command</span><span class="w"> </span><span class="n">default</span><span class="w"></span>
<span class="w">    </span><span class="mi">1</span>: <span class="nc">wasm</span><span class="w"> </span><span class="n">trap</span>: <span class="nc">unreachable</span><span class="w"></span>
<span class="w">       </span><span class="n">wasm</span><span class="w"> </span><span class="n">backtrace</span>:
           <span class="mi">0</span>: <span class="mh">0xd581</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="o">&lt;</span><span class="n">unknown</span><span class="o">&gt;!</span><span class="n">__rust_start_panic</span><span class="w"></span>
<span class="w">           </span><span class="mi">1</span>: <span class="mh">0xd223</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="o">&lt;</span><span class="n">unknown</span><span class="o">&gt;!</span><span class="n">rust_panic</span><span class="w"></span>
<span class="w">           </span><span class="mi">2</span>: <span class="mh">0xcdfb</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="o">&lt;</span><span class="n">unknown</span><span class="o">&gt;!</span><span class="n">std</span>::<span class="n">panicking</span>::<span class="n">rust_panic_with_hook</span>::<span class="n">h7412819944345424</span><span class="w"></span>
<span class="w">           </span><span class="mi">3</span>: <span class="mh">0xc36e</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="o">&lt;</span><span class="n">unknown</span><span class="o">&gt;!</span><span class="n">std</span>::<span class="n">panicking</span>::<span class="n">begin_panic_handler</span>::<span class="p">{{</span><span class="n">closure</span><span class="p">}}</span>::<span class="n">h4738c0049ce98322</span><span class="w"></span>
<span class="w">           </span><span class="mi">4</span>: <span class="mh">0xc2af</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="o">&lt;</span><span class="n">unknown</span><span class="o">&gt;!</span><span class="n">std</span>::<span class="n">sys_common</span>::<span class="n">backtrace</span>::<span class="n">__rust_end_short_backtrace</span>::<span class="n">h8bb6e3f06234953f</span><span class="w"></span>
<span class="w">           </span><span class="mi">5</span>: <span class="mh">0xcc9f</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="o">&lt;</span><span class="n">unknown</span><span class="o">&gt;!</span><span class="n">rust_begin_unwind</span><span class="w"></span>
<span class="w">           </span><span class="mi">6</span>: <span class="mh">0x12d4e</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="o">&lt;</span><span class="n">unknown</span><span class="o">&gt;!</span><span class="n">core</span>::<span class="n">panicking</span>::<span class="n">panic_fmt</span>::<span class="n">h904ce09f3cb14707</span><span class="w"></span>
<span class="w">           </span><span class="mi">7</span>: <span class="mh">0x12432</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="o">&lt;</span><span class="n">unknown</span><span class="o">&gt;!</span><span class="n">core</span>::<span class="n">slice</span>::<span class="n">index</span>::<span class="n">slice_end_index_len_fail</span>::<span class="n">hcdd59b2bc02fd78c</span><span class="w"></span>
<span class="w">           </span><span class="mi">8</span>: <span class="mh">0x9bd9</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="o">&lt;</span><span class="n">unknown</span><span class="o">&gt;!&lt;</span><span class="n">std</span>::<span class="n">sys</span>::<span class="n">wasi</span>::<span class="n">fs</span>::<span class="n">ReadDir</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">core</span>::<span class="n">iter</span>::<span class="n">traits</span>::<span class="n">iterator</span>::<span class="nb">Iterator</span><span class="o">&gt;</span>::<span class="n">next</span>::<span class="n">h53073ad4dd8c7879</span><span class="w"></span>
<span class="w">           </span><span class="mi">9</span>: <span class="mh">0x96ff</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="o">&lt;</span><span class="n">unknown</span><span class="o">&gt;!&lt;</span><span class="n">std</span>::<span class="n">fs</span>::<span class="n">ReadDir</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">core</span>::<span class="n">iter</span>::<span class="n">traits</span>::<span class="n">iterator</span>::<span class="nb">Iterator</span><span class="o">&gt;</span>::<span class="n">next</span>::<span class="n">h35e43cb49f6132cb</span><span class="w"></span>
<span class="w">          </span><span class="mi">10</span>:  <span class="mh">0x9de</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="o">&lt;</span><span class="n">unknown</span><span class="o">&gt;!</span><span class="n">temp</span>::<span class="n">main</span>::<span class="n">h0ae35bb072c9f0ef</span><span class="w"></span>
<span class="w">          </span><span class="mi">11</span>: <span class="mh">0x1c90</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="o">&lt;</span><span class="n">unknown</span><span class="o">&gt;!</span><span class="n">core</span>::<span class="n">ops</span>::<span class="n">function</span>::<span class="nb">FnOnce</span>::<span class="n">call_once</span>::<span class="n">hf1fda840e003cdf0</span><span class="w"></span>
<span class="w">          </span><span class="mi">12</span>: <span class="mh">0x2820</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="o">&lt;</span><span class="n">unknown</span><span class="o">&gt;!</span><span class="n">std</span>::<span class="n">sys_common</span>::<span class="n">backtrace</span>::<span class="n">__rust_begin_short_backtrace</span>::<span class="n">hf0b5aa48499a3256</span><span class="w"></span>
<span class="w">          </span><span class="mi">13</span>: <span class="mh">0x3e5b</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="o">&lt;</span><span class="n">unknown</span><span class="o">&gt;!</span><span class="n">std</span>::<span class="n">rt</span>::<span class="n">lang_start</span>::<span class="p">{{</span><span class="n">closure</span><span class="p">}}</span>::<span class="n">h6eaa3cdacd789dba</span><span class="w"></span>
<span class="w">          </span><span class="mi">14</span>: <span class="mh">0xd334</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="o">&lt;</span><span class="n">unknown</span><span class="o">&gt;!</span><span class="n">std</span>::<span class="n">rt</span>::<span class="n">lang_start_internal</span>::<span class="n">h0e1571f3e9f07dad</span><span class="w"></span>
<span class="w">          </span><span class="mi">15</span>: <span class="mh">0x3dfc</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="o">&lt;</span><span class="n">unknown</span><span class="o">&gt;!</span><span class="n">std</span>::<span class="n">rt</span>::<span class="n">lang_start</span>::<span class="n">h382cc3264c9b1456</span><span class="w"></span>
<span class="w">          </span><span class="mi">16</span>: <span class="mh">0x1483</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="o">&lt;</span><span class="n">unknown</span><span class="o">&gt;!</span><span class="n">__original_main</span><span class="w"></span>
<span class="w">          </span><span class="mi">17</span>:  <span class="mh">0x527</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="o">&lt;</span><span class="n">unknown</span><span class="o">&gt;!</span><span class="n">_start</span><span class="w"></span>
<span class="w">       </span><span class="n">note</span>: <span class="nc">run</span><span class="w"> </span><span class="n">with</span><span class="w"> </span><span class="err">`</span><span class="n">WASMTIME_BACKTRACE_DETAILS</span><span class="o">=</span><span class="mi">1</span><span class="err">`</span><span class="w"> </span><span class="n">environment</span><span class="w"> </span><span class="n">variable</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">display</span><span class="w"> </span><span class="n">more</span><span class="w"> </span><span class="n">information</span><span class="w"></span>
</code></pre></div>
<p>Same code against the same folder works fine with Wasmer, suggesting it's an environment issue not Rust stdlib issue:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="o">/</span><span class="mi">0</span><span class="w"></span>
<span class="o">/</span><span class="mi">1</span><span class="w"></span>
<span class="o">/</span><span class="mi">10</span><span class="w"></span>
<span class="o">/</span><span class="mi">11</span><span class="w"></span>
<span class="o">/</span><span class="mi">12</span><span class="w"></span>
<span class="o">/</span><span class="mi">13</span><span class="w"></span>
<span class="o">/</span><span class="mi">14</span><span class="w"></span>
<span class="o">/</span><span class="mi">15</span><span class="w"></span>
<span class="o">/</span><span class="mi">16</span><span class="w"></span>
<span class="o">/</span><span class="mi">17</span><span class="w"></span>
<span class="o">/</span><span class="mi">18</span><span class="w"></span>
<span class="o">/</span><span class="mi">19</span><span class="w"></span>
<span class="o">/</span><span class="mi">2</span><span class="w"></span>
<span class="o">/</span><span class="mi">20</span><span class="w"></span>
<span class="o">/</span><span class="mi">21</span><span class="w"></span>
<span class="o">/</span><span class="mi">22</span><span class="w"></span>
<span class="o">/</span><span class="mi">23</span><span class="w"></span>
<span class="o">/</span><span class="mi">24</span><span class="w"></span>
<span class="o">/</span><span class="mi">25</span><span class="w"></span>
<span class="o">/</span><span class="mi">26</span><span class="w"></span>
<span class="o">/</span><span class="mi">27</span><span class="w"></span>
<span class="o">/</span><span class="mi">28</span><span class="w"></span>
<span class="o">/</span><span class="mi">29</span><span class="w"></span>
<span class="o">/</span><span class="mi">3</span><span class="w"></span>
<span class="o">/</span><span class="mi">30</span><span class="w"></span>
<span class="o">/</span><span class="mi">31</span><span class="w"></span>
<span class="o">/</span><span class="mi">32</span><span class="w"></span>
<span class="o">/</span><span class="mi">33</span><span class="w"></span>
<span class="o">/</span><span class="mi">34</span><span class="w"></span>
<span class="o">/</span><span class="mi">35</span><span class="w"></span>
<span class="o">/</span><span class="mi">36</span><span class="w"></span>
<span class="o">/</span><span class="mi">37</span><span class="w"></span>
<span class="o">/</span><span class="mi">38</span><span class="w"></span>
<span class="o">/</span><span class="mi">39</span><span class="w"></span>
<span class="o">/</span><span class="mi">4</span><span class="w"></span>
<span class="o">/</span><span class="mi">40</span><span class="w"></span>
<span class="o">/</span><span class="mi">41</span><span class="w"></span>
<span class="o">/</span><span class="mi">42</span><span class="w"></span>
<span class="o">/</span><span class="mi">43</span><span class="w"></span>
<span class="o">/</span><span class="mi">44</span><span class="w"></span>
<span class="o">/</span><span class="mi">45</span><span class="w"></span>
<span class="o">/</span><span class="mi">46</span><span class="w"></span>
<span class="o">/</span><span class="mi">47</span><span class="w"></span>
<span class="o">/</span><span class="mi">48</span><span class="w"></span>
<span class="o">/</span><span class="mi">49</span><span class="w"></span>
<span class="o">/</span><span class="mi">5</span><span class="w"></span>
<span class="o">/</span><span class="mi">6</span><span class="w"></span>
<span class="o">/</span><span class="mi">7</span><span class="w"></span>
<span class="o">/</span><span class="mi">8</span><span class="w"></span>
<span class="o">/</span><span class="mi">9</span><span class="w"></span>
</code></pre></div>
<p>The relevant code on the Rust side also hasn't been updated in 2 years, also confirming it's likely a runtime environment issue: <a href="https://github.com/rust-lang/rust/blob/643a79af3d5a31fa87c8a4c9d7f8bc4ebe2add4b/library/std/src/sys/wasi/fs.rs#L164">https://github.com/rust-lang/rust/blob/643a79af3d5a31fa87c8a4c9d7f8bc4ebe2add4b/library/std/src/sys/wasi/fs.rs#L164</a></p>
</blockquote>



<hr><p>Last updated: Jan 20 2025 at 06:04 UTC</p>
</html>