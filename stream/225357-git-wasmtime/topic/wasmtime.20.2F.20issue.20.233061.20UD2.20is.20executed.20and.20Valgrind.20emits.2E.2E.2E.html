<html>
<head><meta charset="utf-8"><title>wasmtime / issue #3061 UD2 is executed and Valgrind emits... · git-wasmtime · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/index.html">git-wasmtime</a></h2>
<h3>Topic: <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.233061.20UD2.20is.20executed.20and.20Valgrind.20emits.2E.2E.2E.html">wasmtime / issue #3061 UD2 is executed and Valgrind emits...</a></h3>

<hr>

<base href="https://bytecodealliance.zulipchat.com">

<head><link href="https://bytecodealliance.github.io/zulip-archive/style.css" rel="stylesheet"></head>

<a name="244866758"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%233061%20UD2%20is%20executed%20and%20Valgrind%20emits.../near/244866758" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.233061.20UD2.20is.20executed.20and.20Valgrind.20emits.2E.2E.2E.html#244866758">(Jul 04 2021 at 16:27)</a>:</h4>
<p>Encrylize edited <a href="https://github.com/bytecodealliance/wasmtime/issues/3061">issue #3061</a>:</p>
<blockquote>
<h3>Test Case</h3>
<p><code>trap.c</code>:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code>#<span class="n">include</span><span class="w"> </span><span class="o">&lt;</span><span class="n">wasm</span><span class="p">.</span><span class="n">h</span><span class="o">&gt;</span><span class="w"></span>
#<span class="n">include</span><span class="w"> </span><span class="o">&lt;</span><span class="n">wasmtime</span><span class="p">.</span><span class="n">h</span><span class="o">&gt;</span><span class="w"></span>

<span class="n">int</span><span class="w"> </span><span class="n">main</span><span class="p">(</span><span class="n">void</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">wasm_engine_t</span><span class="o">*</span><span class="w"> </span><span class="n">engine</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">wasm_engine_new</span><span class="p">();</span><span class="w"></span>
<span class="w">    </span><span class="n">wasm_store_t</span><span class="o">*</span><span class="w"> </span><span class="n">store</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">wasm_store_new</span><span class="p">(</span><span class="n">engine</span><span class="p">);</span><span class="w"></span>

<span class="w">    </span><span class="n">wasm_byte_vec_t</span><span class="w"> </span><span class="n">binary</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="k">const</span><span class="w"> </span><span class="kt">char</span><span class="o">*</span><span class="w"> </span><span class="n">wat</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">"(module (func (export </span><span class="se">\"</span><span class="s">trap</span><span class="se">\"</span><span class="s">) (unreachable)))"</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="n">wasmtime_wat2wasm</span><span class="p">(</span><span class="n">wat</span><span class="p">,</span><span class="w"> </span><span class="n">strlen</span><span class="p">(</span><span class="n">wat</span><span class="p">),</span><span class="w"> </span><span class="o">&amp;</span><span class="n">binary</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="n">wasm_module_t</span><span class="o">*</span><span class="w"> </span><span class="n">module</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">wasm_module_new</span><span class="p">(</span><span class="n">store</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">binary</span><span class="p">);</span><span class="w"></span>

<span class="w">    </span><span class="n">wasm_byte_vec_delete</span><span class="p">(</span><span class="o">&amp;</span><span class="n">binary</span><span class="p">);</span><span class="w"></span>

<span class="w">    </span><span class="n">wasm_extern_vec_t</span><span class="w"> </span><span class="n">imports</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">WASM_EMPTY_VEC</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="n">wasm_instance_t</span><span class="o">*</span><span class="w"> </span><span class="n">instance</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">wasm_instance_new</span><span class="p">(</span><span class="n">store</span><span class="p">,</span><span class="w"> </span><span class="n">module</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">imports</span><span class="p">,</span><span class="w"> </span><span class="n">NULL</span><span class="p">);</span><span class="w"></span>

<span class="w">    </span><span class="n">wasm_extern_vec_t</span><span class="w"> </span><span class="n">exports</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="n">wasm_instance_exports</span><span class="p">(</span><span class="n">instance</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">exports</span><span class="p">);</span><span class="w"></span>

<span class="w">    </span><span class="k">const</span><span class="w"> </span><span class="n">wasm_func_t</span><span class="o">*</span><span class="w"> </span><span class="n">func</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">wasm_extern_as_func</span><span class="p">(</span><span class="n">exports</span><span class="p">.</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span><span class="w"></span>

<span class="w">    </span><span class="k">const</span><span class="w"> </span><span class="n">wasm_val_vec_t</span><span class="w"> </span><span class="n">args</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">WASM_EMPTY_VEC</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="n">wasm_val_vec_t</span><span class="w"> </span><span class="n">results</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">WASM_EMPTY_VEC</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="n">wasm_trap_t</span><span class="o">*</span><span class="w"> </span><span class="n">trap</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">wasm_func_call</span><span class="p">(</span><span class="n">func</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">args</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">results</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="n">wasm_trap_delete</span><span class="p">(</span><span class="n">trap</span><span class="p">);</span><span class="w"></span>

<span class="w">    </span><span class="n">wasm_extern_vec_delete</span><span class="p">(</span><span class="o">&amp;</span><span class="n">exports</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="n">wasm_module_delete</span><span class="p">(</span><span class="n">module</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="n">wasm_instance_delete</span><span class="p">(</span><span class="n">instance</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="n">wasm_store_delete</span><span class="p">(</span><span class="n">store</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="n">wasm_engine_delete</span><span class="p">(</span><span class="n">engine</span><span class="p">);</span><span class="w"></span>

<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>
<h3>Steps to Reproduce</h3>
<ul>
<li>Compile program: <code>gcc trap.c -lwasmtime -o trap</code></li>
<li>Execute program using LLDB: <code>lldb ./trap</code></li>
<li>Execute program using Valgrind: <code>valgrind ./trap</code></li>
</ul>
<h3>Expected Results</h3>
<p>The <code>UD2</code> instruction should not be executed and no warnings should be emitted by Valgrind.</p>
<h3>Actual Results</h3>
<p>The <code>UD2</code> instruction is executed as shown by LLDB:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="cp">$</span><span class="w"> </span><span class="n">lldb</span><span class="w"> </span><span class="p">.</span><span class="o">/</span><span class="n">trap</span><span class="w"></span>
<span class="p">(</span><span class="n">lldb</span><span class="p">)</span><span class="w"> </span><span class="n">target</span><span class="w"> </span><span class="n">create</span><span class="w"> </span><span class="s">"./trap"</span><span class="w"></span>
<span class="n">Current</span><span class="w"> </span><span class="n">executable</span><span class="w"> </span><span class="n">set</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="o">'/</span><span class="n">home</span><span class="o">/</span><span class="n">jfb</span><span class="o">/</span><span class="n">projects</span><span class="o">/</span><span class="n">wasm</span><span class="o">/</span><span class="n">trap</span><span class="o">'</span><span class="w"> </span><span class="p">(</span><span class="n">x86_64</span><span class="p">).</span><span class="w"></span>
<span class="p">(</span><span class="n">lldb</span><span class="p">)</span><span class="w"> </span><span class="n">r</span><span class="w"></span>
<span class="n">Process</span><span class="w"> </span><span class="mi">301185</span><span class="w"> </span><span class="n">launched</span>: <span class="o">'/</span><span class="n">home</span><span class="o">/</span><span class="n">jfb</span><span class="o">/</span><span class="n">projects</span><span class="o">/</span><span class="n">wasm</span><span class="o">/</span><span class="n">trap</span><span class="o">'</span><span class="w"> </span><span class="p">(</span><span class="n">x86_64</span><span class="p">)</span><span class="w"></span>
<span class="n">Process</span><span class="w"> </span><span class="mi">301185</span><span class="w"> </span><span class="n">stopped</span><span class="w"></span>
<span class="o">*</span><span class="w"> </span><span class="n">thread</span><span class="w"> </span>#<span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">'</span><span class="na">trap</span><span class="o">'</span><span class="p">,</span><span class="w"> </span><span class="n">stop</span><span class="w"> </span><span class="n">reason</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">signal</span><span class="w"> </span><span class="n">SIGILL</span>: <span class="nc">illegal</span><span class="w"> </span><span class="n">instruction</span><span class="w"> </span><span class="n">operand</span><span class="w"></span>
<span class="w">    </span><span class="n">frame</span><span class="w"> </span>#<span class="mi">0</span>: <span class="mh">0x00007ffff7fb7004</span><span class="w"></span>
-&gt;  <span class="mh">0x7ffff7fb7004</span>: <span class="nc">ud2</span><span class="w"></span>
<span class="w">    </span><span class="mh">0x7ffff7fb7006</span>: <span class="nc">pushq</span><span class="w">  </span><span class="o">%</span><span class="n">rbp</span><span class="w"></span>
<span class="w">    </span><span class="mh">0x7ffff7fb7007</span>: <span class="nc">movq</span><span class="w">   </span><span class="o">%</span><span class="n">rsp</span><span class="p">,</span><span class="w"> </span><span class="o">%</span><span class="n">rbp</span><span class="w"></span>
<span class="w">    </span><span class="mh">0x7ffff7fb700a</span>: <span class="nc">callq</span><span class="w">  </span><span class="o">*%</span><span class="n">rdx</span><span class="w"></span>
<span class="p">(</span><span class="n">lldb</span><span class="p">)</span><span class="w"> </span><span class="n">c</span><span class="w"></span>
<span class="n">Process</span><span class="w"> </span><span class="mi">301185</span><span class="w"> </span><span class="n">resuming</span><span class="w"></span>
<span class="n">Process</span><span class="w"> </span><span class="mi">301185</span><span class="w"> </span><span class="n">exited</span><span class="w"> </span><span class="n">with</span><span class="w"> </span><span class="n">status</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="p">(</span><span class="mh">0x00000000</span><span class="p">)</span><span class="w"></span>
<span class="p">(</span><span class="n">lldb</span><span class="p">)</span><span class="w"> </span><span class="n">exit</span><span class="w"></span>
</code></pre></div>
<p>Valgrind emits a warning about the client switching stacks:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="cp">$</span><span class="w"> </span><span class="n">valgrind</span><span class="w"> </span><span class="p">.</span><span class="o">/</span><span class="n">trap</span><span class="w"></span>
<span class="o">==</span><span class="mi">302700</span><span class="o">==</span><span class="w"> </span><span class="n">Memcheck</span><span class="p">,</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="n">memory</span><span class="w"> </span><span class="n">error</span><span class="w"> </span><span class="n">detector</span><span class="w"></span>
<span class="o">==</span><span class="mi">302700</span><span class="o">==</span><span class="w"> </span><span class="n">Copyright</span><span class="w"> </span><span class="p">(</span><span class="n">C</span><span class="p">)</span><span class="w"> </span><span class="mi">2002</span><span class="o">-</span><span class="mi">2017</span><span class="p">,</span><span class="w"> </span><span class="n">and</span><span class="w"> </span><span class="n">GNU</span><span class="w"> </span><span class="n">GPL</span><span class="o">'</span><span class="na">d</span><span class="p">,</span><span class="w"> </span><span class="n">by</span><span class="w"> </span><span class="n">Julian</span><span class="w"> </span><span class="n">Seward</span><span class="w"> </span><span class="n">et</span><span class="w"> </span><span class="n">al</span><span class="p">.</span><span class="w"></span>
<span class="o">==</span><span class="mi">302700</span><span class="o">==</span><span class="w"> </span><span class="n">Using</span><span class="w"> </span><span class="n">Valgrind</span><span class="o">-</span><span class="mf">3.17.0</span><span class="w"> </span><span class="n">and</span><span class="w"> </span><span class="n">LibVEX</span><span class="p">;</span><span class="w"> </span><span class="n">rerun</span><span class="w"> </span><span class="n">with</span><span class="w"> </span><span class="o">-</span><span class="n">h</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">copyright</span><span class="w"> </span><span class="n">info</span><span class="w"></span>
<span class="o">==</span><span class="mi">302700</span><span class="o">==</span><span class="w"> </span><span class="n">Command</span>: <span class="p">.</span><span class="o">/</span><span class="n">trap</span><span class="w"></span>
<span class="o">==</span><span class="mi">302700</span><span class="o">==</span><span class="w"></span>
<span class="o">==</span><span class="mi">302700</span><span class="o">==</span><span class="w"> </span><span class="n">valgrind</span>: <span class="nc">Unrecognised</span><span class="w"> </span><span class="n">instruction</span><span class="w"> </span><span class="n">at</span><span class="w"> </span><span class="n">address</span><span class="w"> </span><span class="mh">0x4850004</span><span class="p">.</span><span class="w"></span>
<span class="o">==</span><span class="mi">302700</span><span class="o">==</span><span class="w">    </span><span class="n">at</span><span class="w"> </span><span class="mh">0x4850004</span>: <span class="o">???</span><span class="w"></span>
<span class="o">==</span><span class="mi">302700</span><span class="o">==</span><span class="w">    </span><span class="n">by</span><span class="w"> </span><span class="mh">0x485000B</span>: <span class="o">???</span><span class="w"></span>
<span class="o">==</span><span class="mi">302700</span><span class="o">==</span><span class="w">    </span><span class="n">by</span><span class="w"> </span><span class="mh">0x4E2548F</span>: <span class="nc">wasmtime_setjmp</span><span class="w"> </span><span class="p">(</span><span class="k">in</span><span class="w"> </span><span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">libwasmtime</span><span class="p">.</span><span class="n">so</span><span class="p">)</span><span class="w"></span>
<span class="o">==</span><span class="mi">302700</span><span class="o">==</span><span class="w">    </span><span class="n">by</span><span class="w"> </span><span class="mh">0x4980838</span>: <span class="nc">wasmtime_runtime</span>::<span class="n">traphandlers</span>::<span class="n">catch_traps</span><span class="w"> </span><span class="p">(</span><span class="k">in</span><span class="w"> </span><span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">libwasmtime</span><span class="p">.</span><span class="n">so</span><span class="p">)</span><span class="w"></span>
<span class="o">==</span><span class="mi">302700</span><span class="o">==</span><span class="w">    </span><span class="n">by</span><span class="w"> </span><span class="mh">0x496DE16</span>: <span class="nc">wasmtime</span>::<span class="n">func</span>::<span class="n">Func</span>::<span class="n">call</span><span class="w"> </span><span class="p">(</span><span class="k">in</span><span class="w"> </span><span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">libwasmtime</span><span class="p">.</span><span class="n">so</span><span class="p">)</span><span class="w"></span>
<span class="o">==</span><span class="mi">302700</span><span class="o">==</span><span class="w">    </span><span class="n">by</span><span class="w"> </span><span class="mh">0x4A22DE3</span>: <span class="nc">wasm_func_call</span><span class="w"> </span><span class="p">(</span><span class="k">in</span><span class="w"> </span><span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">libwasmtime</span><span class="p">.</span><span class="n">so</span><span class="p">)</span><span class="w"></span>
<span class="o">==</span><span class="mi">302700</span><span class="o">==</span><span class="w">    </span><span class="n">by</span><span class="w"> </span><span class="mh">0x10935D</span>: <span class="nc">main</span><span class="w"> </span><span class="p">(</span><span class="k">in</span><span class="w"> </span><span class="o">/</span><span class="n">home</span><span class="o">/</span><span class="n">jfb</span><span class="o">/</span><span class="n">projects</span><span class="o">/</span><span class="n">wasm</span><span class="o">/</span><span class="n">trap</span><span class="p">)</span><span class="w"></span>
<span class="o">==</span><span class="mi">302700</span><span class="o">==</span><span class="w"> </span><span class="n">Your</span><span class="w"> </span><span class="n">program</span><span class="w"> </span><span class="n">just</span><span class="w"> </span><span class="n">tried</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">execute</span><span class="w"> </span><span class="n">an</span><span class="w"> </span><span class="n">instruction</span><span class="w"> </span><span class="n">that</span><span class="w"> </span><span class="n">Valgrind</span><span class="w"></span>
<span class="o">==</span><span class="mi">302700</span><span class="o">==</span><span class="w"> </span><span class="n">did</span><span class="w"> </span><span class="n">not</span><span class="w"> </span><span class="n">recognise</span><span class="p">.</span><span class="w">  </span><span class="n">There</span><span class="w"> </span><span class="n">are</span><span class="w"> </span><span class="n">two</span><span class="w"> </span><span class="n">possible</span><span class="w"> </span><span class="n">reasons</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">this</span><span class="p">.</span><span class="w"></span>
<span class="o">==</span><span class="mi">302700</span><span class="o">==</span><span class="w"> </span><span class="mf">1.</span><span class="w"> </span><span class="n">Your</span><span class="w"> </span><span class="n">program</span><span class="w"> </span><span class="n">has</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="n">bug</span><span class="w"> </span><span class="n">and</span><span class="w"> </span><span class="n">erroneously</span><span class="w"> </span><span class="n">jumped</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="n">non</span><span class="o">-</span><span class="n">code</span><span class="w"></span>
<span class="o">==</span><span class="mi">302700</span><span class="o">==</span><span class="w">    </span><span class="n">location</span><span class="p">.</span><span class="w">  </span><span class="n">If</span><span class="w"> </span><span class="n">you</span><span class="w"> </span><span class="n">are</span><span class="w"> </span><span class="n">running</span><span class="w"> </span><span class="n">Memcheck</span><span class="w"> </span><span class="n">and</span><span class="w"> </span><span class="n">you</span><span class="w"> </span><span class="n">just</span><span class="w"> </span><span class="n">saw</span><span class="w"> </span><span class="n">a</span><span class="w"></span>
<span class="o">==</span><span class="mi">302700</span><span class="o">==</span><span class="w">    </span><span class="n">warning</span><span class="w"> </span><span class="n">about</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="n">bad</span><span class="w"> </span><span class="n">jump</span><span class="p">,</span><span class="w"> </span><span class="n">it</span><span class="o">'</span><span class="na">s</span><span class="w"> </span><span class="n">probably</span><span class="w"> </span><span class="n">your</span><span class="w"> </span><span class="n">program</span><span class="o">'</span><span class="na">s</span><span class="w"> </span><span class="n">fault</span><span class="p">.</span><span class="w"></span>
<span class="o">==</span><span class="mi">302700</span><span class="o">==</span><span class="w"> </span><span class="mf">2.</span><span class="w"> </span><span class="n">The</span><span class="w"> </span><span class="n">instruction</span><span class="w"> </span><span class="n">is</span><span class="w"> </span><span class="n">legitimate</span><span class="w"> </span><span class="n">but</span><span class="w"> </span><span class="n">Valgrind</span><span class="w"> </span><span class="n">doesn</span><span class="o">'</span><span class="na">t</span><span class="w"> </span><span class="n">handle</span><span class="w"> </span><span class="n">it</span><span class="p">,</span><span class="w"></span>
<span class="o">==</span><span class="mi">302700</span><span class="o">==</span><span class="w">    </span><span class="n">i</span><span class="p">.</span><span class="n">e</span><span class="p">.</span><span class="w"> </span><span class="n">it</span><span class="o">'</span><span class="na">s</span><span class="w"> </span><span class="n">Valgrind</span><span class="o">'</span><span class="na">s</span><span class="w"> </span><span class="n">fault</span><span class="p">.</span><span class="w">  </span><span class="n">If</span><span class="w"> </span><span class="n">you</span><span class="w"> </span><span class="n">think</span><span class="w"> </span><span class="n">this</span><span class="w"> </span><span class="n">is</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">case</span><span class="w"> </span><span class="n">or</span><span class="w"></span>
<span class="o">==</span><span class="mi">302700</span><span class="o">==</span><span class="w">    </span><span class="n">you</span><span class="w"> </span><span class="n">are</span><span class="w"> </span><span class="n">not</span><span class="w"> </span><span class="n">sure</span><span class="p">,</span><span class="w"> </span><span class="n">please</span><span class="w"> </span><span class="kd">let</span><span class="w"> </span><span class="n">us</span><span class="w"> </span><span class="n">know</span><span class="w"> </span><span class="n">and</span><span class="w"> </span><span class="n">we</span><span class="o">'</span><span class="na">ll</span><span class="w"> </span><span class="kr">try</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">fix</span><span class="w"> </span><span class="n">it</span><span class="p">.</span><span class="w"></span>
<span class="o">==</span><span class="mi">302700</span><span class="o">==</span><span class="w"> </span><span class="n">Either</span><span class="w"> </span><span class="n">way</span><span class="p">,</span><span class="w"> </span><span class="n">Valgrind</span><span class="w"> </span><span class="n">will</span><span class="w"> </span><span class="n">now</span><span class="w"> </span><span class="n">raise</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="n">SIGILL</span><span class="w"> </span><span class="n">signal</span><span class="w"> </span><span class="n">which</span><span class="w"> </span><span class="n">will</span><span class="w"></span>
<span class="o">==</span><span class="mi">302700</span><span class="o">==</span><span class="w"> </span><span class="n">probably</span><span class="w"> </span><span class="n">kill</span><span class="w"> </span><span class="n">your</span><span class="w"> </span><span class="n">program</span><span class="p">.</span><span class="w"></span>
<span class="o">==</span><span class="mi">302700</span><span class="o">==</span><span class="w"> </span><span class="n">Warning</span>: <span class="nc">client</span><span class="w"> </span><span class="n">switching</span><span class="w"> </span><span class="n">stacks</span><span class="o">?</span><span class="w">  </span><span class="n">SP</span><span class="w"> </span><span class="n">change</span>: <span class="mh">0x5aaa068</span><span class="w"> </span><span class="o">-</span>-&gt; <span class="mh">0x1ffefffd00</span><span class="w"></span>
<span class="o">==</span><span class="mi">302700</span><span class="o">==</span><span class="w">          </span><span class="n">to</span><span class="w"> </span><span class="n">suppress</span><span class="p">,</span><span class="w"> </span><span class="k">use</span>: <span class="o">--</span><span class="n">max</span><span class="o">-</span><span class="n">stackframe</span><span class="o">=</span><span class="mi">137327107224</span><span class="w"> </span><span class="n">or</span><span class="w"> </span><span class="n">greater</span><span class="w"></span>
<span class="o">==</span><span class="mi">302700</span><span class="o">==</span><span class="w"></span>
<span class="o">==</span><span class="mi">302700</span><span class="o">==</span><span class="w"> </span><span class="n">HEAP</span><span class="w"> </span><span class="n">SUMMARY</span>:
<span class="o">==</span><span class="mi">302700</span><span class="o">==</span><span class="w">     </span><span class="k">in</span><span class="w"> </span><span class="k">use</span><span class="w"> </span><span class="n">at</span><span class="w"> </span><span class="n">exit</span>: <span class="mi">920</span><span class="w"> </span><span class="n">bytes</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="mi">7</span><span class="w"> </span><span class="n">blocks</span><span class="w"></span>
<span class="o">==</span><span class="mi">302700</span><span class="o">==</span><span class="w">   </span><span class="n">total</span><span class="w"> </span><span class="n">heap</span><span class="w"> </span><span class="n">usage</span>: <span class="mi">659</span><span class="w"> </span><span class="n">allocs</span><span class="p">,</span><span class="w"> </span><span class="mi">652</span><span class="w"> </span><span class="n">frees</span><span class="p">,</span><span class="w"> </span><span class="mi">152</span><span class="p">,</span><span class="mi">738</span><span class="w"> </span><span class="n">bytes</span><span class="w"> </span><span class="n">allocated</span><span class="w"></span>
<span class="o">==</span><span class="mi">302700</span><span class="o">==</span><span class="w"></span>
<span class="o">==</span><span class="mi">302700</span><span class="o">==</span><span class="w"> </span><span class="n">LEAK</span><span class="w"> </span><span class="n">SUMMARY</span>:
<span class="o">==</span><span class="mi">302700</span><span class="o">==</span><span class="w">    </span><span class="n">definitely</span><span class="w"> </span><span class="n">lost</span>: <span class="mi">0</span><span class="w"> </span><span class="n">bytes</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="n">blocks</span><span class="w"></span>
<span class="o">==</span><span class="mi">302700</span><span class="o">==</span><span class="w">    </span><span class="n">indirectly</span><span class="w"> </span><span class="n">lost</span>: <span class="mi">0</span><span class="w"> </span><span class="n">bytes</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="n">blocks</span><span class="w"></span>
<span class="o">==</span><span class="mi">302700</span><span class="o">==</span><span class="w">      </span><span class="n">possibly</span><span class="w"> </span><span class="n">lost</span>: <span class="mi">0</span><span class="w"> </span><span class="n">bytes</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="n">blocks</span><span class="w"></span>
<span class="o">==</span><span class="mi">302700</span><span class="o">==</span><span class="w">    </span><span class="n">still</span><span class="w"> </span><span class="n">reachable</span>: <span class="mi">920</span><span class="w"> </span><span class="n">bytes</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="mi">7</span><span class="w"> </span><span class="n">blocks</span><span class="w"></span>
<span class="o">==</span><span class="mi">302700</span><span class="o">==</span><span class="w">         </span><span class="n">suppressed</span>: <span class="mi">0</span><span class="w"> </span><span class="n">bytes</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="n">blocks</span><span class="w"></span>
<span class="o">==</span><span class="mi">302700</span><span class="o">==</span><span class="w"> </span><span class="n">Rerun</span><span class="w"> </span><span class="n">with</span><span class="w"> </span><span class="o">--</span><span class="n">leak</span><span class="o">-</span><span class="n">check</span><span class="o">=</span><span class="n">full</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">see</span><span class="w"> </span><span class="n">details</span><span class="w"> </span><span class="n">of</span><span class="w"> </span><span class="n">leaked</span><span class="w"> </span><span class="n">memory</span><span class="w"></span>
<span class="o">==</span><span class="mi">302700</span><span class="o">==</span><span class="w"></span>
<span class="o">==</span><span class="mi">302700</span><span class="o">==</span><span class="w"> </span><span class="n">For</span><span class="w"> </span><span class="n">lists</span><span class="w"> </span><span class="n">of</span><span class="w"> </span><span class="n">detected</span><span class="w"> </span><span class="n">and</span><span class="w"> </span><span class="n">suppressed</span><span class="w"> </span><span class="n">errors</span><span class="p">,</span><span class="w"> </span><span class="n">rerun</span><span class="w"> </span><span class="n">with</span>: <span class="o">-</span><span class="n">s</span><span class="w"></span>
<span class="o">==</span><span class="mi">302700</span><span class="o">==</span><span class="w"> </span><span class="n">ERROR</span><span class="w"> </span><span class="n">SUMMARY</span>: <span class="mi">0</span><span class="w"> </span><span class="n">errors</span><span class="w"> </span><span class="n">from</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="n">contexts</span><span class="w"> </span><span class="p">(</span><span class="n">suppressed</span>: <span class="mi">0</span><span class="w"> </span><span class="n">from</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"></span>
</code></pre></div>
<h3>Versions and Environment</h3>
<p>Wasmtime version or commit: Commit <code>c71ad9490</code></p>
<p>Operating system: Arch Linux</p>
<p>Architecture: x86_64</p>
</blockquote>



<a name="244878105"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%233061%20UD2%20is%20executed%20and%20Valgrind%20emits.../near/244878105" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.233061.20UD2.20is.20executed.20and.20Valgrind.20emits.2E.2E.2E.html#244878105">(Jul 04 2021 at 21:19)</a>:</h4>
<p>cfallin <a href="https://github.com/bytecodealliance/wasmtime/issues/3061#issuecomment-873664615">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/3061">issue #3061</a>:</p>
<blockquote>
<p>Hi @Encrylize,</p>
<p>The undefined instruction (<code>ud2</code> on x86-64) is how wasmtime transfers control to its trap handlers; executing this instruction is the intended behavior when a trap occurs.</p>
<p>Normally, wasmtime will install a signal handler for <code>SIGILL</code> (or the equivalent mechanism with Mach ports on macOS or Win32 APIs on Windows), catch the signal, and longjmp back to the top-level entry point, at which point it can return the trap error-code to the caller.</p>
<p>However, if you are running under a debugger or under Valgrind, it's possible that this tool will catch the signal before wasmtime does. There is nothing that we can really do about this, as far as I know: the tools have complete control over inspecting the process (gdb/lldb via the <code>ptrace()</code> syscall, Valgrind because it actually emulates execution with a JIT layer), and have full visibility of signals.</p>
<p>I know that at least Valgrind has the concept of "suppressions", and gdb allows setting the default action for a signal (such as <code>SIGILL</code>) to "ignore"; perhaps one of these mechanisms would help in your case?</p>
<p>In any case, using signals to catch traps is standard practice for JIT engines and other runtimes, and is a fully correct and supported use of the signal-handler mechanism, so this is not a bug that we can resolve, I think. Thank you for filing the report regardless!</p>
</blockquote>



<a name="244878149"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%233061%20UD2%20is%20executed%20and%20Valgrind%20emits.../near/244878149" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.233061.20UD2.20is.20executed.20and.20Valgrind.20emits.2E.2E.2E.html#244878149">(Jul 04 2021 at 21:20)</a>:</h4>
<p>cfallin closed <a href="https://github.com/bytecodealliance/wasmtime/issues/3061">issue #3061</a>:</p>
<blockquote>
<h3>Test Case</h3>
<p><code>trap.c</code>:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code>#<span class="n">include</span><span class="w"> </span><span class="o">&lt;</span><span class="n">wasm</span><span class="p">.</span><span class="n">h</span><span class="o">&gt;</span><span class="w"></span>
#<span class="n">include</span><span class="w"> </span><span class="o">&lt;</span><span class="n">wasmtime</span><span class="p">.</span><span class="n">h</span><span class="o">&gt;</span><span class="w"></span>

<span class="n">int</span><span class="w"> </span><span class="n">main</span><span class="p">(</span><span class="n">void</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">wasm_engine_t</span><span class="o">*</span><span class="w"> </span><span class="n">engine</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">wasm_engine_new</span><span class="p">();</span><span class="w"></span>
<span class="w">    </span><span class="n">wasm_store_t</span><span class="o">*</span><span class="w"> </span><span class="n">store</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">wasm_store_new</span><span class="p">(</span><span class="n">engine</span><span class="p">);</span><span class="w"></span>

<span class="w">    </span><span class="n">wasm_byte_vec_t</span><span class="w"> </span><span class="n">binary</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="k">const</span><span class="w"> </span><span class="kt">char</span><span class="o">*</span><span class="w"> </span><span class="n">wat</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">"(module (func (export </span><span class="se">\"</span><span class="s">trap</span><span class="se">\"</span><span class="s">) (unreachable)))"</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="n">wasmtime_wat2wasm</span><span class="p">(</span><span class="n">wat</span><span class="p">,</span><span class="w"> </span><span class="n">strlen</span><span class="p">(</span><span class="n">wat</span><span class="p">),</span><span class="w"> </span><span class="o">&amp;</span><span class="n">binary</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="n">wasm_module_t</span><span class="o">*</span><span class="w"> </span><span class="n">module</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">wasm_module_new</span><span class="p">(</span><span class="n">store</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">binary</span><span class="p">);</span><span class="w"></span>

<span class="w">    </span><span class="n">wasm_byte_vec_delete</span><span class="p">(</span><span class="o">&amp;</span><span class="n">binary</span><span class="p">);</span><span class="w"></span>

<span class="w">    </span><span class="n">wasm_extern_vec_t</span><span class="w"> </span><span class="n">imports</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">WASM_EMPTY_VEC</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="n">wasm_instance_t</span><span class="o">*</span><span class="w"> </span><span class="n">instance</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">wasm_instance_new</span><span class="p">(</span><span class="n">store</span><span class="p">,</span><span class="w"> </span><span class="n">module</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">imports</span><span class="p">,</span><span class="w"> </span><span class="n">NULL</span><span class="p">);</span><span class="w"></span>

<span class="w">    </span><span class="n">wasm_extern_vec_t</span><span class="w"> </span><span class="n">exports</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="n">wasm_instance_exports</span><span class="p">(</span><span class="n">instance</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">exports</span><span class="p">);</span><span class="w"></span>

<span class="w">    </span><span class="k">const</span><span class="w"> </span><span class="n">wasm_func_t</span><span class="o">*</span><span class="w"> </span><span class="n">func</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">wasm_extern_as_func</span><span class="p">(</span><span class="n">exports</span><span class="p">.</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span><span class="w"></span>

<span class="w">    </span><span class="k">const</span><span class="w"> </span><span class="n">wasm_val_vec_t</span><span class="w"> </span><span class="n">args</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">WASM_EMPTY_VEC</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="n">wasm_val_vec_t</span><span class="w"> </span><span class="n">results</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">WASM_EMPTY_VEC</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="n">wasm_trap_t</span><span class="o">*</span><span class="w"> </span><span class="n">trap</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">wasm_func_call</span><span class="p">(</span><span class="n">func</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">args</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">results</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="n">wasm_trap_delete</span><span class="p">(</span><span class="n">trap</span><span class="p">);</span><span class="w"></span>

<span class="w">    </span><span class="n">wasm_extern_vec_delete</span><span class="p">(</span><span class="o">&amp;</span><span class="n">exports</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="n">wasm_module_delete</span><span class="p">(</span><span class="n">module</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="n">wasm_instance_delete</span><span class="p">(</span><span class="n">instance</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="n">wasm_store_delete</span><span class="p">(</span><span class="n">store</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="n">wasm_engine_delete</span><span class="p">(</span><span class="n">engine</span><span class="p">);</span><span class="w"></span>

<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>
<h3>Steps to Reproduce</h3>
<ul>
<li>Compile program: <code>gcc trap.c -lwasmtime -o trap</code></li>
<li>Execute program using LLDB: <code>lldb ./trap</code></li>
<li>Execute program using Valgrind: <code>valgrind ./trap</code></li>
</ul>
<h3>Expected Results</h3>
<p>The <code>UD2</code> instruction should not be executed and no warnings should be emitted by Valgrind.</p>
<h3>Actual Results</h3>
<p>The <code>UD2</code> instruction is executed as shown by LLDB:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="cp">$</span><span class="w"> </span><span class="n">lldb</span><span class="w"> </span><span class="p">.</span><span class="o">/</span><span class="n">trap</span><span class="w"></span>
<span class="p">(</span><span class="n">lldb</span><span class="p">)</span><span class="w"> </span><span class="n">target</span><span class="w"> </span><span class="n">create</span><span class="w"> </span><span class="s">"./trap"</span><span class="w"></span>
<span class="n">Current</span><span class="w"> </span><span class="n">executable</span><span class="w"> </span><span class="n">set</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="o">'/</span><span class="n">home</span><span class="o">/</span><span class="n">jfb</span><span class="o">/</span><span class="n">projects</span><span class="o">/</span><span class="n">wasm</span><span class="o">/</span><span class="n">trap</span><span class="o">'</span><span class="w"> </span><span class="p">(</span><span class="n">x86_64</span><span class="p">).</span><span class="w"></span>
<span class="p">(</span><span class="n">lldb</span><span class="p">)</span><span class="w"> </span><span class="n">r</span><span class="w"></span>
<span class="n">Process</span><span class="w"> </span><span class="mi">301185</span><span class="w"> </span><span class="n">launched</span>: <span class="o">'/</span><span class="n">home</span><span class="o">/</span><span class="n">jfb</span><span class="o">/</span><span class="n">projects</span><span class="o">/</span><span class="n">wasm</span><span class="o">/</span><span class="n">trap</span><span class="o">'</span><span class="w"> </span><span class="p">(</span><span class="n">x86_64</span><span class="p">)</span><span class="w"></span>
<span class="n">Process</span><span class="w"> </span><span class="mi">301185</span><span class="w"> </span><span class="n">stopped</span><span class="w"></span>
<span class="o">*</span><span class="w"> </span><span class="n">thread</span><span class="w"> </span>#<span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">'</span><span class="na">trap</span><span class="o">'</span><span class="p">,</span><span class="w"> </span><span class="n">stop</span><span class="w"> </span><span class="n">reason</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">signal</span><span class="w"> </span><span class="n">SIGILL</span>: <span class="nc">illegal</span><span class="w"> </span><span class="n">instruction</span><span class="w"> </span><span class="n">operand</span><span class="w"></span>
<span class="w">    </span><span class="n">frame</span><span class="w"> </span>#<span class="mi">0</span>: <span class="mh">0x00007ffff7fb7004</span><span class="w"></span>
-&gt;  <span class="mh">0x7ffff7fb7004</span>: <span class="nc">ud2</span><span class="w"></span>
<span class="w">    </span><span class="mh">0x7ffff7fb7006</span>: <span class="nc">pushq</span><span class="w">  </span><span class="o">%</span><span class="n">rbp</span><span class="w"></span>
<span class="w">    </span><span class="mh">0x7ffff7fb7007</span>: <span class="nc">movq</span><span class="w">   </span><span class="o">%</span><span class="n">rsp</span><span class="p">,</span><span class="w"> </span><span class="o">%</span><span class="n">rbp</span><span class="w"></span>
<span class="w">    </span><span class="mh">0x7ffff7fb700a</span>: <span class="nc">callq</span><span class="w">  </span><span class="o">*%</span><span class="n">rdx</span><span class="w"></span>
<span class="p">(</span><span class="n">lldb</span><span class="p">)</span><span class="w"> </span><span class="n">c</span><span class="w"></span>
<span class="n">Process</span><span class="w"> </span><span class="mi">301185</span><span class="w"> </span><span class="n">resuming</span><span class="w"></span>
<span class="n">Process</span><span class="w"> </span><span class="mi">301185</span><span class="w"> </span><span class="n">exited</span><span class="w"> </span><span class="n">with</span><span class="w"> </span><span class="n">status</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="p">(</span><span class="mh">0x00000000</span><span class="p">)</span><span class="w"></span>
<span class="p">(</span><span class="n">lldb</span><span class="p">)</span><span class="w"> </span><span class="n">exit</span><span class="w"></span>
</code></pre></div>
<p>Valgrind emits a warning about the client switching stacks:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="cp">$</span><span class="w"> </span><span class="n">valgrind</span><span class="w"> </span><span class="p">.</span><span class="o">/</span><span class="n">trap</span><span class="w"></span>
<span class="o">==</span><span class="mi">302700</span><span class="o">==</span><span class="w"> </span><span class="n">Memcheck</span><span class="p">,</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="n">memory</span><span class="w"> </span><span class="n">error</span><span class="w"> </span><span class="n">detector</span><span class="w"></span>
<span class="o">==</span><span class="mi">302700</span><span class="o">==</span><span class="w"> </span><span class="n">Copyright</span><span class="w"> </span><span class="p">(</span><span class="n">C</span><span class="p">)</span><span class="w"> </span><span class="mi">2002</span><span class="o">-</span><span class="mi">2017</span><span class="p">,</span><span class="w"> </span><span class="n">and</span><span class="w"> </span><span class="n">GNU</span><span class="w"> </span><span class="n">GPL</span><span class="o">'</span><span class="na">d</span><span class="p">,</span><span class="w"> </span><span class="n">by</span><span class="w"> </span><span class="n">Julian</span><span class="w"> </span><span class="n">Seward</span><span class="w"> </span><span class="n">et</span><span class="w"> </span><span class="n">al</span><span class="p">.</span><span class="w"></span>
<span class="o">==</span><span class="mi">302700</span><span class="o">==</span><span class="w"> </span><span class="n">Using</span><span class="w"> </span><span class="n">Valgrind</span><span class="o">-</span><span class="mf">3.17.0</span><span class="w"> </span><span class="n">and</span><span class="w"> </span><span class="n">LibVEX</span><span class="p">;</span><span class="w"> </span><span class="n">rerun</span><span class="w"> </span><span class="n">with</span><span class="w"> </span><span class="o">-</span><span class="n">h</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">copyright</span><span class="w"> </span><span class="n">info</span><span class="w"></span>
<span class="o">==</span><span class="mi">302700</span><span class="o">==</span><span class="w"> </span><span class="n">Command</span>: <span class="p">.</span><span class="o">/</span><span class="n">trap</span><span class="w"></span>
<span class="o">==</span><span class="mi">302700</span><span class="o">==</span><span class="w"></span>
<span class="o">==</span><span class="mi">302700</span><span class="o">==</span><span class="w"> </span><span class="n">valgrind</span>: <span class="nc">Unrecognised</span><span class="w"> </span><span class="n">instruction</span><span class="w"> </span><span class="n">at</span><span class="w"> </span><span class="n">address</span><span class="w"> </span><span class="mh">0x4850004</span><span class="p">.</span><span class="w"></span>
<span class="o">==</span><span class="mi">302700</span><span class="o">==</span><span class="w">    </span><span class="n">at</span><span class="w"> </span><span class="mh">0x4850004</span>: <span class="o">???</span><span class="w"></span>
<span class="o">==</span><span class="mi">302700</span><span class="o">==</span><span class="w">    </span><span class="n">by</span><span class="w"> </span><span class="mh">0x485000B</span>: <span class="o">???</span><span class="w"></span>
<span class="o">==</span><span class="mi">302700</span><span class="o">==</span><span class="w">    </span><span class="n">by</span><span class="w"> </span><span class="mh">0x4E2548F</span>: <span class="nc">wasmtime_setjmp</span><span class="w"> </span><span class="p">(</span><span class="k">in</span><span class="w"> </span><span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">libwasmtime</span><span class="p">.</span><span class="n">so</span><span class="p">)</span><span class="w"></span>
<span class="o">==</span><span class="mi">302700</span><span class="o">==</span><span class="w">    </span><span class="n">by</span><span class="w"> </span><span class="mh">0x4980838</span>: <span class="nc">wasmtime_runtime</span>::<span class="n">traphandlers</span>::<span class="n">catch_traps</span><span class="w"> </span><span class="p">(</span><span class="k">in</span><span class="w"> </span><span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">libwasmtime</span><span class="p">.</span><span class="n">so</span><span class="p">)</span><span class="w"></span>
<span class="o">==</span><span class="mi">302700</span><span class="o">==</span><span class="w">    </span><span class="n">by</span><span class="w"> </span><span class="mh">0x496DE16</span>: <span class="nc">wasmtime</span>::<span class="n">func</span>::<span class="n">Func</span>::<span class="n">call</span><span class="w"> </span><span class="p">(</span><span class="k">in</span><span class="w"> </span><span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">libwasmtime</span><span class="p">.</span><span class="n">so</span><span class="p">)</span><span class="w"></span>
<span class="o">==</span><span class="mi">302700</span><span class="o">==</span><span class="w">    </span><span class="n">by</span><span class="w"> </span><span class="mh">0x4A22DE3</span>: <span class="nc">wasm_func_call</span><span class="w"> </span><span class="p">(</span><span class="k">in</span><span class="w"> </span><span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">libwasmtime</span><span class="p">.</span><span class="n">so</span><span class="p">)</span><span class="w"></span>
<span class="o">==</span><span class="mi">302700</span><span class="o">==</span><span class="w">    </span><span class="n">by</span><span class="w"> </span><span class="mh">0x10935D</span>: <span class="nc">main</span><span class="w"> </span><span class="p">(</span><span class="k">in</span><span class="w"> </span><span class="o">/</span><span class="n">home</span><span class="o">/</span><span class="n">jfb</span><span class="o">/</span><span class="n">projects</span><span class="o">/</span><span class="n">wasm</span><span class="o">/</span><span class="n">trap</span><span class="p">)</span><span class="w"></span>
<span class="o">==</span><span class="mi">302700</span><span class="o">==</span><span class="w"> </span><span class="n">Your</span><span class="w"> </span><span class="n">program</span><span class="w"> </span><span class="n">just</span><span class="w"> </span><span class="n">tried</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">execute</span><span class="w"> </span><span class="n">an</span><span class="w"> </span><span class="n">instruction</span><span class="w"> </span><span class="n">that</span><span class="w"> </span><span class="n">Valgrind</span><span class="w"></span>
<span class="o">==</span><span class="mi">302700</span><span class="o">==</span><span class="w"> </span><span class="n">did</span><span class="w"> </span><span class="n">not</span><span class="w"> </span><span class="n">recognise</span><span class="p">.</span><span class="w">  </span><span class="n">There</span><span class="w"> </span><span class="n">are</span><span class="w"> </span><span class="n">two</span><span class="w"> </span><span class="n">possible</span><span class="w"> </span><span class="n">reasons</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">this</span><span class="p">.</span><span class="w"></span>
<span class="o">==</span><span class="mi">302700</span><span class="o">==</span><span class="w"> </span><span class="mf">1.</span><span class="w"> </span><span class="n">Your</span><span class="w"> </span><span class="n">program</span><span class="w"> </span><span class="n">has</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="n">bug</span><span class="w"> </span><span class="n">and</span><span class="w"> </span><span class="n">erroneously</span><span class="w"> </span><span class="n">jumped</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="n">non</span><span class="o">-</span><span class="n">code</span><span class="w"></span>
<span class="o">==</span><span class="mi">302700</span><span class="o">==</span><span class="w">    </span><span class="n">location</span><span class="p">.</span><span class="w">  </span><span class="n">If</span><span class="w"> </span><span class="n">you</span><span class="w"> </span><span class="n">are</span><span class="w"> </span><span class="n">running</span><span class="w"> </span><span class="n">Memcheck</span><span class="w"> </span><span class="n">and</span><span class="w"> </span><span class="n">you</span><span class="w"> </span><span class="n">just</span><span class="w"> </span><span class="n">saw</span><span class="w"> </span><span class="n">a</span><span class="w"></span>
<span class="o">==</span><span class="mi">302700</span><span class="o">==</span><span class="w">    </span><span class="n">warning</span><span class="w"> </span><span class="n">about</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="n">bad</span><span class="w"> </span><span class="n">jump</span><span class="p">,</span><span class="w"> </span><span class="n">it</span><span class="o">'</span><span class="na">s</span><span class="w"> </span><span class="n">probably</span><span class="w"> </span><span class="n">your</span><span class="w"> </span><span class="n">program</span><span class="o">'</span><span class="na">s</span><span class="w"> </span><span class="n">fault</span><span class="p">.</span><span class="w"></span>
<span class="o">==</span><span class="mi">302700</span><span class="o">==</span><span class="w"> </span><span class="mf">2.</span><span class="w"> </span><span class="n">The</span><span class="w"> </span><span class="n">instruction</span><span class="w"> </span><span class="n">is</span><span class="w"> </span><span class="n">legitimate</span><span class="w"> </span><span class="n">but</span><span class="w"> </span><span class="n">Valgrind</span><span class="w"> </span><span class="n">doesn</span><span class="o">'</span><span class="na">t</span><span class="w"> </span><span class="n">handle</span><span class="w"> </span><span class="n">it</span><span class="p">,</span><span class="w"></span>
<span class="o">==</span><span class="mi">302700</span><span class="o">==</span><span class="w">    </span><span class="n">i</span><span class="p">.</span><span class="n">e</span><span class="p">.</span><span class="w"> </span><span class="n">it</span><span class="o">'</span><span class="na">s</span><span class="w"> </span><span class="n">Valgrind</span><span class="o">'</span><span class="na">s</span><span class="w"> </span><span class="n">fault</span><span class="p">.</span><span class="w">  </span><span class="n">If</span><span class="w"> </span><span class="n">you</span><span class="w"> </span><span class="n">think</span><span class="w"> </span><span class="n">this</span><span class="w"> </span><span class="n">is</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">case</span><span class="w"> </span><span class="n">or</span><span class="w"></span>
<span class="o">==</span><span class="mi">302700</span><span class="o">==</span><span class="w">    </span><span class="n">you</span><span class="w"> </span><span class="n">are</span><span class="w"> </span><span class="n">not</span><span class="w"> </span><span class="n">sure</span><span class="p">,</span><span class="w"> </span><span class="n">please</span><span class="w"> </span><span class="kd">let</span><span class="w"> </span><span class="n">us</span><span class="w"> </span><span class="n">know</span><span class="w"> </span><span class="n">and</span><span class="w"> </span><span class="n">we</span><span class="o">'</span><span class="na">ll</span><span class="w"> </span><span class="kr">try</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">fix</span><span class="w"> </span><span class="n">it</span><span class="p">.</span><span class="w"></span>
<span class="o">==</span><span class="mi">302700</span><span class="o">==</span><span class="w"> </span><span class="n">Either</span><span class="w"> </span><span class="n">way</span><span class="p">,</span><span class="w"> </span><span class="n">Valgrind</span><span class="w"> </span><span class="n">will</span><span class="w"> </span><span class="n">now</span><span class="w"> </span><span class="n">raise</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="n">SIGILL</span><span class="w"> </span><span class="n">signal</span><span class="w"> </span><span class="n">which</span><span class="w"> </span><span class="n">will</span><span class="w"></span>
<span class="o">==</span><span class="mi">302700</span><span class="o">==</span><span class="w"> </span><span class="n">probably</span><span class="w"> </span><span class="n">kill</span><span class="w"> </span><span class="n">your</span><span class="w"> </span><span class="n">program</span><span class="p">.</span><span class="w"></span>
<span class="o">==</span><span class="mi">302700</span><span class="o">==</span><span class="w"> </span><span class="n">Warning</span>: <span class="nc">client</span><span class="w"> </span><span class="n">switching</span><span class="w"> </span><span class="n">stacks</span><span class="o">?</span><span class="w">  </span><span class="n">SP</span><span class="w"> </span><span class="n">change</span>: <span class="mh">0x5aaa068</span><span class="w"> </span><span class="o">-</span>-&gt; <span class="mh">0x1ffefffd00</span><span class="w"></span>
<span class="o">==</span><span class="mi">302700</span><span class="o">==</span><span class="w">          </span><span class="n">to</span><span class="w"> </span><span class="n">suppress</span><span class="p">,</span><span class="w"> </span><span class="k">use</span>: <span class="o">--</span><span class="n">max</span><span class="o">-</span><span class="n">stackframe</span><span class="o">=</span><span class="mi">137327107224</span><span class="w"> </span><span class="n">or</span><span class="w"> </span><span class="n">greater</span><span class="w"></span>
<span class="o">==</span><span class="mi">302700</span><span class="o">==</span><span class="w"></span>
<span class="o">==</span><span class="mi">302700</span><span class="o">==</span><span class="w"> </span><span class="n">HEAP</span><span class="w"> </span><span class="n">SUMMARY</span>:
<span class="o">==</span><span class="mi">302700</span><span class="o">==</span><span class="w">     </span><span class="k">in</span><span class="w"> </span><span class="k">use</span><span class="w"> </span><span class="n">at</span><span class="w"> </span><span class="n">exit</span>: <span class="mi">920</span><span class="w"> </span><span class="n">bytes</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="mi">7</span><span class="w"> </span><span class="n">blocks</span><span class="w"></span>
<span class="o">==</span><span class="mi">302700</span><span class="o">==</span><span class="w">   </span><span class="n">total</span><span class="w"> </span><span class="n">heap</span><span class="w"> </span><span class="n">usage</span>: <span class="mi">659</span><span class="w"> </span><span class="n">allocs</span><span class="p">,</span><span class="w"> </span><span class="mi">652</span><span class="w"> </span><span class="n">frees</span><span class="p">,</span><span class="w"> </span><span class="mi">152</span><span class="p">,</span><span class="mi">738</span><span class="w"> </span><span class="n">bytes</span><span class="w"> </span><span class="n">allocated</span><span class="w"></span>
<span class="o">==</span><span class="mi">302700</span><span class="o">==</span><span class="w"></span>
<span class="o">==</span><span class="mi">302700</span><span class="o">==</span><span class="w"> </span><span class="n">LEAK</span><span class="w"> </span><span class="n">SUMMARY</span>:
<span class="o">==</span><span class="mi">302700</span><span class="o">==</span><span class="w">    </span><span class="n">definitely</span><span class="w"> </span><span class="n">lost</span>: <span class="mi">0</span><span class="w"> </span><span class="n">bytes</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="n">blocks</span><span class="w"></span>
<span class="o">==</span><span class="mi">302700</span><span class="o">==</span><span class="w">    </span><span class="n">indirectly</span><span class="w"> </span><span class="n">lost</span>: <span class="mi">0</span><span class="w"> </span><span class="n">bytes</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="n">blocks</span><span class="w"></span>
<span class="o">==</span><span class="mi">302700</span><span class="o">==</span><span class="w">      </span><span class="n">possibly</span><span class="w"> </span><span class="n">lost</span>: <span class="mi">0</span><span class="w"> </span><span class="n">bytes</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="n">blocks</span><span class="w"></span>
<span class="o">==</span><span class="mi">302700</span><span class="o">==</span><span class="w">    </span><span class="n">still</span><span class="w"> </span><span class="n">reachable</span>: <span class="mi">920</span><span class="w"> </span><span class="n">bytes</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="mi">7</span><span class="w"> </span><span class="n">blocks</span><span class="w"></span>
<span class="o">==</span><span class="mi">302700</span><span class="o">==</span><span class="w">         </span><span class="n">suppressed</span>: <span class="mi">0</span><span class="w"> </span><span class="n">bytes</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="n">blocks</span><span class="w"></span>
<span class="o">==</span><span class="mi">302700</span><span class="o">==</span><span class="w"> </span><span class="n">Rerun</span><span class="w"> </span><span class="n">with</span><span class="w"> </span><span class="o">--</span><span class="n">leak</span><span class="o">-</span><span class="n">check</span><span class="o">=</span><span class="n">full</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">see</span><span class="w"> </span><span class="n">details</span><span class="w"> </span><span class="n">of</span><span class="w"> </span><span class="n">leaked</span><span class="w"> </span><span class="n">memory</span><span class="w"></span>
<span class="o">==</span><span class="mi">302700</span><span class="o">==</span><span class="w"></span>
<span class="o">==</span><span class="mi">302700</span><span class="o">==</span><span class="w"> </span><span class="n">For</span><span class="w"> </span><span class="n">lists</span><span class="w"> </span><span class="n">of</span><span class="w"> </span><span class="n">detected</span><span class="w"> </span><span class="n">and</span><span class="w"> </span><span class="n">suppressed</span><span class="w"> </span><span class="n">errors</span><span class="p">,</span><span class="w"> </span><span class="n">rerun</span><span class="w"> </span><span class="n">with</span>: <span class="o">-</span><span class="n">s</span><span class="w"></span>
<span class="o">==</span><span class="mi">302700</span><span class="o">==</span><span class="w"> </span><span class="n">ERROR</span><span class="w"> </span><span class="n">SUMMARY</span>: <span class="mi">0</span><span class="w"> </span><span class="n">errors</span><span class="w"> </span><span class="n">from</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="n">contexts</span><span class="w"> </span><span class="p">(</span><span class="n">suppressed</span>: <span class="mi">0</span><span class="w"> </span><span class="n">from</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"></span>
</code></pre></div>
<h3>Versions and Environment</h3>
<p>Wasmtime version or commit: Commit <code>c71ad9490</code></p>
<p>Operating system: Arch Linux</p>
<p>Architecture: x86_64</p>
</blockquote>



<hr><p>Last updated: Jan 20 2025 at 06:04 UTC</p>
</html>