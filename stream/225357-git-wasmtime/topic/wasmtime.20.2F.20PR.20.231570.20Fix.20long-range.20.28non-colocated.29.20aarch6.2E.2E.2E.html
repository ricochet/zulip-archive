<html>
<head><meta charset="utf-8"><title>wasmtime / PR #1570 Fix long-range (non-colocated) aarch6... · git-wasmtime · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/index.html">git-wasmtime</a></h2>
<h3>Topic: <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231570.20Fix.20long-range.20.28non-colocated.29.20aarch6.2E.2E.2E.html">wasmtime / PR #1570 Fix long-range (non-colocated) aarch6...</a></h3>

<hr>

<base href="https://bytecodealliance.zulipchat.com">

<head><link href="https://bytecodealliance.github.io/zulip-archive/style.css" rel="stylesheet"></head>

<a name="194850801"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231570%20Fix%20long-range%20%28non-colocated%29%20aarch6.../near/194850801" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231570.20Fix.20long-range.20.28non-colocated.29.20aarch6.2E.2E.2E.html#194850801">(Apr 21 2020 at 19:32)</a>:</h4>
<p><strong>cfallin</strong> requested <a href="https://github.com/bnjbvr" title="https://github.com/bnjbvr">bnjbvr</a> and <a href="https://github.com/julian-seward1" title="https://github.com/julian-seward1">julian-seward1</a> for a review on <a href="https://github.com/bytecodealliance/wasmtime/pull/1570" title="https://github.com/bytecodealliance/wasmtime/pull/1570">PR #1570</a>.</p>



<a name="194850803"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231570%20Fix%20long-range%20%28non-colocated%29%20aarch6.../near/194850803" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231570.20Fix.20long-range.20.28non-colocated.29.20aarch6.2E.2E.2E.html#194850803">(Apr 21 2020 at 19:32)</a>:</h4>
<p>cfallin opened <a href="https://github.com/bytecodealliance/wasmtime/pull/1570" title="https://github.com/bytecodealliance/wasmtime/pull/1570">PR #1570</a> from <code>fix-long-range-aarch64-call</code> to <code>master</code>:</p>
<blockquote>
<p>Previously, every call was lowered on AArch64 to a <code>call</code> instruction, which<br>
takes a signed 26-bit PC-relative offset. Including the 2-bit left shift, this<br>
gives a range of +/- 128 MB. Longer-distance offsets would cause an impossible<br>
relocation record to be emitted (or rather, a record that a more sophisticated<br>
linker would fix up by inserting a shim/veneer).</p>
<p>This commit adds a notion of "relocation distance" in the MachInst backends,<br>
and provides this information for every call target and symbol reference. The<br>
intent is that backends on architectures like AArch64, where there are different<br>
offset sizes / addressing strategies to choose from, can either emit a regular<br>
call or a load-64-bit-constant / call-indirect sequence, as necessary. This<br>
avoids the need to implement complex linking behavior.</p>
<p>The MachInst driver code provides this information based on the "colocated" bit<br>
in the CLIF symbol references, which appears to have been designed for this<br>
purpose, or at least a similar one. Combined with the <code>use_colocated_libcalls</code><br>
setting, this allows client code to ensure that library calls can link to<br>
library code at any location in the address space.</p>
<p>Separately, the <code>simplejit</code> example did not handle <code>Arm64Call</code>; rather than doing<br>
so, it appears all that is necessary to get its tests to pass is to set the<br>
<code>use_colocated_libcalls</code> flag to false, to make use of the above change. This<br>
fixes the <code>libcall_function</code> unit-test in this crate.</p>
<p>&lt;!--</p>
<p>Please ensure that the following steps are all taken care of before submitting<br>
the PR.</p>
<ul>
<li>
<p>[ ] This has been discussed in issue #..., or if not, please tell us why<br>
  here.</p>
</li>
<li>
<p>[ ] A short description of what this does, why it is needed; if the<br>
  description becomes long, the matter should probably be discussed in an issue<br>
  first.</p>
</li>
<li>
<p>[ ] This PR contains test cases, if meaningful.</p>
</li>
<li>[ ] A reviewer from the core maintainer team has been assigned for this PR.<br>
  If you don't know who could review this, please indicate so. The list of<br>
  suggested reviewers on the right can help you.</li>
</ul>
<p>Please ensure all communication adheres to the <a href="https://github.com/bytecodealliance/wasmtime/blob/master/CODE_OF_CONDUCT.md" title="https://github.com/bytecodealliance/wasmtime/blob/master/CODE_OF_CONDUCT.md">code of
conduct</a>.<br>
--&gt;</p>
</blockquote>



<a name="194850805"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231570%20Fix%20long-range%20%28non-colocated%29%20aarch6.../near/194850805" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231570.20Fix.20long-range.20.28non-colocated.29.20aarch6.2E.2E.2E.html#194850805">(Apr 21 2020 at 19:32)</a>:</h4>
<p><strong>cfallin</strong> requested <a href="https://github.com/bnjbvr" title="https://github.com/bnjbvr">bnjbvr</a> and <a href="https://github.com/julian-seward1" title="https://github.com/julian-seward1">julian-seward1</a> for a review on <a href="https://github.com/bytecodealliance/wasmtime/pull/1570" title="https://github.com/bytecodealliance/wasmtime/pull/1570">PR #1570</a>.</p>



<a name="194851004"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231570%20Fix%20long-range%20%28non-colocated%29%20aarch6.../near/194851004" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231570.20Fix.20long-range.20.28non-colocated.29.20aarch6.2E.2E.2E.html#194851004">(Apr 21 2020 at 19:34)</a>:</h4>
<p>cfallin updated <a href="https://github.com/bytecodealliance/wasmtime/pull/1570" title="https://github.com/bytecodealliance/wasmtime/pull/1570">PR #1570</a> from <code>fix-long-range-aarch64-call</code> to <code>master</code>:</p>
<blockquote>
<p>Previously, every call was lowered on AArch64 to a <code>call</code> instruction, which<br>
takes a signed 26-bit PC-relative offset. Including the 2-bit left shift, this<br>
gives a range of +/- 128 MB. Longer-distance offsets would cause an impossible<br>
relocation record to be emitted (or rather, a record that a more sophisticated<br>
linker would fix up by inserting a shim/veneer).</p>
<p>This commit adds a notion of "relocation distance" in the MachInst backends,<br>
and provides this information for every call target and symbol reference. The<br>
intent is that backends on architectures like AArch64, where there are different<br>
offset sizes / addressing strategies to choose from, can either emit a regular<br>
call or a load-64-bit-constant / call-indirect sequence, as necessary. This<br>
avoids the need to implement complex linking behavior.</p>
<p>The MachInst driver code provides this information based on the "colocated" bit<br>
in the CLIF symbol references, which appears to have been designed for this<br>
purpose, or at least a similar one. Combined with the <code>use_colocated_libcalls</code><br>
setting, this allows client code to ensure that library calls can link to<br>
library code at any location in the address space.</p>
<p>Separately, the <code>simplejit</code> example did not handle <code>Arm64Call</code>; rather than doing<br>
so, it appears all that is necessary to get its tests to pass is to set the<br>
<code>use_colocated_libcalls</code> flag to false, to make use of the above change. This<br>
fixes the <code>libcall_function</code> unit-test in this crate.</p>
<p>&lt;!--</p>
<p>Please ensure that the following steps are all taken care of before submitting<br>
the PR.</p>
<ul>
<li>
<p>[ ] This has been discussed in issue #..., or if not, please tell us why<br>
  here.</p>
</li>
<li>
<p>[ ] A short description of what this does, why it is needed; if the<br>
  description becomes long, the matter should probably be discussed in an issue<br>
  first.</p>
</li>
<li>
<p>[ ] This PR contains test cases, if meaningful.</p>
</li>
<li>[ ] A reviewer from the core maintainer team has been assigned for this PR.<br>
  If you don't know who could review this, please indicate so. The list of<br>
  suggested reviewers on the right can help you.</li>
</ul>
<p>Please ensure all communication adheres to the <a href="https://github.com/bytecodealliance/wasmtime/blob/master/CODE_OF_CONDUCT.md" title="https://github.com/bytecodealliance/wasmtime/blob/master/CODE_OF_CONDUCT.md">code of
conduct</a>.<br>
--&gt;</p>
</blockquote>



<a name="194851638"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231570%20Fix%20long-range%20%28non-colocated%29%20aarch6.../near/194851638" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231570.20Fix.20long-range.20.28non-colocated.29.20aarch6.2E.2E.2E.html#194851638">(Apr 21 2020 at 19:40)</a>:</h4>
<p>cfallin updated <a href="https://github.com/bytecodealliance/wasmtime/pull/1570" title="https://github.com/bytecodealliance/wasmtime/pull/1570">PR #1570</a> from <code>fix-long-range-aarch64-call</code> to <code>master</code>:</p>
<blockquote>
<p>Previously, every call was lowered on AArch64 to a <code>call</code> instruction, which<br>
takes a signed 26-bit PC-relative offset. Including the 2-bit left shift, this<br>
gives a range of +/- 128 MB. Longer-distance offsets would cause an impossible<br>
relocation record to be emitted (or rather, a record that a more sophisticated<br>
linker would fix up by inserting a shim/veneer).</p>
<p>This commit adds a notion of "relocation distance" in the MachInst backends,<br>
and provides this information for every call target and symbol reference. The<br>
intent is that backends on architectures like AArch64, where there are different<br>
offset sizes / addressing strategies to choose from, can either emit a regular<br>
call or a load-64-bit-constant / call-indirect sequence, as necessary. This<br>
avoids the need to implement complex linking behavior.</p>
<p>The MachInst driver code provides this information based on the "colocated" bit<br>
in the CLIF symbol references, which appears to have been designed for this<br>
purpose, or at least a similar one. Combined with the <code>use_colocated_libcalls</code><br>
setting, this allows client code to ensure that library calls can link to<br>
library code at any location in the address space.</p>
<p>Separately, the <code>simplejit</code> example did not handle <code>Arm64Call</code>; rather than doing<br>
so, it appears all that is necessary to get its tests to pass is to set the<br>
<code>use_colocated_libcalls</code> flag to false, to make use of the above change. This<br>
fixes the <code>libcall_function</code> unit-test in this crate.</p>
<p>&lt;!--</p>
<p>Please ensure that the following steps are all taken care of before submitting<br>
the PR.</p>
<ul>
<li>
<p>[ ] This has been discussed in issue #..., or if not, please tell us why<br>
  here.</p>
</li>
<li>
<p>[ ] A short description of what this does, why it is needed; if the<br>
  description becomes long, the matter should probably be discussed in an issue<br>
  first.</p>
</li>
<li>
<p>[ ] This PR contains test cases, if meaningful.</p>
</li>
<li>[ ] A reviewer from the core maintainer team has been assigned for this PR.<br>
  If you don't know who could review this, please indicate so. The list of<br>
  suggested reviewers on the right can help you.</li>
</ul>
<p>Please ensure all communication adheres to the <a href="https://github.com/bytecodealliance/wasmtime/blob/master/CODE_OF_CONDUCT.md" title="https://github.com/bytecodealliance/wasmtime/blob/master/CODE_OF_CONDUCT.md">code of
conduct</a>.<br>
--&gt;</p>
</blockquote>



<a name="194936028"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231570%20Fix%20long-range%20%28non-colocated%29%20aarch6.../near/194936028" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231570.20Fix.20long-range.20.28non-colocated.29.20aarch6.2E.2E.2E.html#194936028">(Apr 22 2020 at 14:09)</a>:</h4>
<p>bnjbvr submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/1570#pullrequestreview-398215140" title="https://github.com/bytecodealliance/wasmtime/pull/1570#pullrequestreview-398215140">PR Review</a>.</p>



<a name="194936029"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231570%20Fix%20long-range%20%28non-colocated%29%20aarch6.../near/194936029" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231570.20Fix.20long-range.20.28non-colocated.29.20aarch6.2E.2E.2E.html#194936029">(Apr 22 2020 at 14:09)</a>:</h4>
<p>bnjbvr submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/1570#pullrequestreview-398215140" title="https://github.com/bytecodealliance/wasmtime/pull/1570#pullrequestreview-398215140">PR Review</a>.</p>



<a name="194936031"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231570%20Fix%20long-range%20%28non-colocated%29%20aarch6.../near/194936031" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231570.20Fix.20long-range.20.28non-colocated.29.20aarch6.2E.2E.2E.html#194936031">(Apr 22 2020 at 14:09)</a>:</h4>
<p>bnjbvr created <a href="https://github.com/bytecodealliance/wasmtime/pull/1570#discussion_r413003431" title="https://github.com/bytecodealliance/wasmtime/pull/1570#discussion_r413003431">PR Review Comment</a>:</p>
<blockquote>
<p>Is the clone necessary, since it happens above already?</p>
</blockquote>



<a name="194936032"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231570%20Fix%20long-range%20%28non-colocated%29%20aarch6.../near/194936032" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231570.20Fix.20long-range.20.28non-colocated.29.20aarch6.2E.2E.2E.html#194936032">(Apr 22 2020 at 14:09)</a>:</h4>
<p>bnjbvr created <a href="https://github.com/bytecodealliance/wasmtime/pull/1570#discussion_r413015737" title="https://github.com/bytecodealliance/wasmtime/pull/1570#discussion_r413015737">PR Review Comment</a>:</p>
<blockquote>
<p>I think this comment ought to complete the documentation of <code>colocated</code> in the <code>ExtFuncData</code> data structure, because it's more likely CL users will look at <code>ExtFuncData</code> rather than <code>RelocDistance</code>.</p>
</blockquote>



<a name="194936033"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231570%20Fix%20long-range%20%28non-colocated%29%20aarch6.../near/194936033" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231570.20Fix.20long-range.20.28non-colocated.29.20aarch6.2E.2E.2E.html#194936033">(Apr 22 2020 at 14:09)</a>:</h4>
<p>bnjbvr created <a href="https://github.com/bytecodealliance/wasmtime/pull/1570#discussion_r413010527" title="https://github.com/bytecodealliance/wasmtime/pull/1570#discussion_r413010527">PR Review Comment</a>:</p>
<blockquote>
<p>Could this be a getter on <code>ExtFuncData</code> and on <code>GlobalValueData</code> instead?</p>
</blockquote>



<a name="194936143"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231570%20Fix%20long-range%20%28non-colocated%29%20aarch6.../near/194936143" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231570.20Fix.20long-range.20.28non-colocated.29.20aarch6.2E.2E.2E.html#194936143">(Apr 22 2020 at 14:10)</a>:</h4>
<p>bnjbvr submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/1570#pullrequestreview-398231255" title="https://github.com/bytecodealliance/wasmtime/pull/1570#pullrequestreview-398231255">PR Review</a>.</p>



<a name="194936144"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231570%20Fix%20long-range%20%28non-colocated%29%20aarch6.../near/194936144" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231570.20Fix.20long-range.20.28non-colocated.29.20aarch6.2E.2E.2E.html#194936144">(Apr 22 2020 at 14:10)</a>:</h4>
<p>bnjbvr created <a href="https://github.com/bytecodealliance/wasmtime/pull/1570#discussion_r413016736" title="https://github.com/bytecodealliance/wasmtime/pull/1570#discussion_r413016736">PR Review Comment</a>:</p>
<blockquote>
<p>Actually not sure how I feel about putting it on <code>GlobalValueData</code>, since it should only be for <code>GlobalVataData::Symbol</code>, really...</p>
</blockquote>



<a name="194995338"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231570%20Fix%20long-range%20%28non-colocated%29%20aarch6.../near/194995338" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231570.20Fix.20long-range.20.28non-colocated.29.20aarch6.2E.2E.2E.html#194995338">(Apr 22 2020 at 21:47)</a>:</h4>
<p>cfallin submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/1570#pullrequestreview-398613805" title="https://github.com/bytecodealliance/wasmtime/pull/1570#pullrequestreview-398613805">PR Review</a>.</p>



<a name="194995339"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231570%20Fix%20long-range%20%28non-colocated%29%20aarch6.../near/194995339" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231570.20Fix.20long-range.20.28non-colocated.29.20aarch6.2E.2E.2E.html#194995339">(Apr 22 2020 at 21:47)</a>:</h4>
<p>cfallin created <a href="https://github.com/bytecodealliance/wasmtime/pull/1570#discussion_r413355771" title="https://github.com/bytecodealliance/wasmtime/pull/1570#discussion_r413355771">PR Review Comment</a>:</p>
<blockquote>
<p>Ah -- the earlier clone was just cloning a tuple with a borrow (<code>call_target()</code> returns a borrow of the <code>ExternalName</code>), which is a no-op as it's already <code>Copy</code>; the new <code>clone</code> was to get around a conflicting borrow issue with <code>ctx.emit</code> taking a mut <code>self</code>. Removed first clone. The joys of proper Rust usage :-)</p>
</blockquote>



<a name="194996252"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231570%20Fix%20long-range%20%28non-colocated%29%20aarch6.../near/194996252" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231570.20Fix.20long-range.20.28non-colocated.29.20aarch6.2E.2E.2E.html#194996252">(Apr 22 2020 at 21:57)</a>:</h4>
<p>cfallin updated <a href="https://github.com/bytecodealliance/wasmtime/pull/1570" title="https://github.com/bytecodealliance/wasmtime/pull/1570">PR #1570</a> from <code>fix-long-range-aarch64-call</code> to <code>master</code>:</p>
<blockquote>
<p>Previously, every call was lowered on AArch64 to a <code>call</code> instruction, which<br>
takes a signed 26-bit PC-relative offset. Including the 2-bit left shift, this<br>
gives a range of +/- 128 MB. Longer-distance offsets would cause an impossible<br>
relocation record to be emitted (or rather, a record that a more sophisticated<br>
linker would fix up by inserting a shim/veneer).</p>
<p>This commit adds a notion of "relocation distance" in the MachInst backends,<br>
and provides this information for every call target and symbol reference. The<br>
intent is that backends on architectures like AArch64, where there are different<br>
offset sizes / addressing strategies to choose from, can either emit a regular<br>
call or a load-64-bit-constant / call-indirect sequence, as necessary. This<br>
avoids the need to implement complex linking behavior.</p>
<p>The MachInst driver code provides this information based on the "colocated" bit<br>
in the CLIF symbol references, which appears to have been designed for this<br>
purpose, or at least a similar one. Combined with the <code>use_colocated_libcalls</code><br>
setting, this allows client code to ensure that library calls can link to<br>
library code at any location in the address space.</p>
<p>Separately, the <code>simplejit</code> example did not handle <code>Arm64Call</code>; rather than doing<br>
so, it appears all that is necessary to get its tests to pass is to set the<br>
<code>use_colocated_libcalls</code> flag to false, to make use of the above change. This<br>
fixes the <code>libcall_function</code> unit-test in this crate.</p>
<p>&lt;!--</p>
<p>Please ensure that the following steps are all taken care of before submitting<br>
the PR.</p>
<ul>
<li>
<p>[ ] This has been discussed in issue #..., or if not, please tell us why<br>
  here.</p>
</li>
<li>
<p>[ ] A short description of what this does, why it is needed; if the<br>
  description becomes long, the matter should probably be discussed in an issue<br>
  first.</p>
</li>
<li>
<p>[ ] This PR contains test cases, if meaningful.</p>
</li>
<li>[ ] A reviewer from the core maintainer team has been assigned for this PR.<br>
  If you don't know who could review this, please indicate so. The list of<br>
  suggested reviewers on the right can help you.</li>
</ul>
<p>Please ensure all communication adheres to the <a href="https://github.com/bytecodealliance/wasmtime/blob/master/CODE_OF_CONDUCT.md" title="https://github.com/bytecodealliance/wasmtime/blob/master/CODE_OF_CONDUCT.md">code of
conduct</a>.<br>
--&gt;</p>
</blockquote>



<a name="194996281"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231570%20Fix%20long-range%20%28non-colocated%29%20aarch6.../near/194996281" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231570.20Fix.20long-range.20.28non-colocated.29.20aarch6.2E.2E.2E.html#194996281">(Apr 22 2020 at 21:57)</a>:</h4>
<p>cfallin submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/1570#pullrequestreview-398619425" title="https://github.com/bytecodealliance/wasmtime/pull/1570#pullrequestreview-398619425">PR Review</a>.</p>



<a name="194996282"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231570%20Fix%20long-range%20%28non-colocated%29%20aarch6.../near/194996282" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231570.20Fix.20long-range.20.28non-colocated.29.20aarch6.2E.2E.2E.html#194996282">(Apr 22 2020 at 21:57)</a>:</h4>
<p>cfallin created <a href="https://github.com/bytecodealliance/wasmtime/pull/1570#discussion_r413361115" title="https://github.com/bytecodealliance/wasmtime/pull/1570#discussion_r413361115">PR Review Comment</a>:</p>
<blockquote>
<p>Done -- added an additional note to both <code>colocated</code> flags, in both <code>ExtFuncData</code> and <code>GlobalValueData::Symbol</code>.</p>
</blockquote>



<a name="194996347"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231570%20Fix%20long-range%20%28non-colocated%29%20aarch6.../near/194996347" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231570.20Fix.20long-range.20.28non-colocated.29.20aarch6.2E.2E.2E.html#194996347">(Apr 22 2020 at 21:58)</a>:</h4>
<p>cfallin created <a href="https://github.com/bytecodealliance/wasmtime/pull/1570#discussion_r413361387" title="https://github.com/bytecodealliance/wasmtime/pull/1570#discussion_r413361387">PR Review Comment</a>:</p>
<blockquote>
<p>Good idea -- done (made the <code>GlobalValueData</code> getter return an <code>Option</code>, only <code>Some</code> for the <code>Symbol</code> case).</p>
</blockquote>



<a name="194996348"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231570%20Fix%20long-range%20%28non-colocated%29%20aarch6.../near/194996348" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231570.20Fix.20long-range.20.28non-colocated.29.20aarch6.2E.2E.2E.html#194996348">(Apr 22 2020 at 21:58)</a>:</h4>
<p>cfallin submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/1570#pullrequestreview-398619692" title="https://github.com/bytecodealliance/wasmtime/pull/1570#pullrequestreview-398619692">PR Review</a>.</p>



<a name="195114619"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231570%20Fix%20long-range%20%28non-colocated%29%20aarch6.../near/195114619" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231570.20Fix.20long-range.20.28non-colocated.29.20aarch6.2E.2E.2E.html#195114619">(Apr 23 2020 at 20:23)</a>:</h4>
<p>cfallin updated <a href="https://github.com/bytecodealliance/wasmtime/pull/1570" title="https://github.com/bytecodealliance/wasmtime/pull/1570">PR #1570</a> from <code>fix-long-range-aarch64-call</code> to <code>master</code>:</p>
<blockquote>
<p>Previously, every call was lowered on AArch64 to a <code>call</code> instruction, which<br>
takes a signed 26-bit PC-relative offset. Including the 2-bit left shift, this<br>
gives a range of +/- 128 MB. Longer-distance offsets would cause an impossible<br>
relocation record to be emitted (or rather, a record that a more sophisticated<br>
linker would fix up by inserting a shim/veneer).</p>
<p>This commit adds a notion of "relocation distance" in the MachInst backends,<br>
and provides this information for every call target and symbol reference. The<br>
intent is that backends on architectures like AArch64, where there are different<br>
offset sizes / addressing strategies to choose from, can either emit a regular<br>
call or a load-64-bit-constant / call-indirect sequence, as necessary. This<br>
avoids the need to implement complex linking behavior.</p>
<p>The MachInst driver code provides this information based on the "colocated" bit<br>
in the CLIF symbol references, which appears to have been designed for this<br>
purpose, or at least a similar one. Combined with the <code>use_colocated_libcalls</code><br>
setting, this allows client code to ensure that library calls can link to<br>
library code at any location in the address space.</p>
<p>Separately, the <code>simplejit</code> example did not handle <code>Arm64Call</code>; rather than doing<br>
so, it appears all that is necessary to get its tests to pass is to set the<br>
<code>use_colocated_libcalls</code> flag to false, to make use of the above change. This<br>
fixes the <code>libcall_function</code> unit-test in this crate.</p>
<p>&lt;!--</p>
<p>Please ensure that the following steps are all taken care of before submitting<br>
the PR.</p>
<ul>
<li>
<p>[ ] This has been discussed in issue #..., or if not, please tell us why<br>
  here.</p>
</li>
<li>
<p>[ ] A short description of what this does, why it is needed; if the<br>
  description becomes long, the matter should probably be discussed in an issue<br>
  first.</p>
</li>
<li>
<p>[ ] This PR contains test cases, if meaningful.</p>
</li>
<li>[ ] A reviewer from the core maintainer team has been assigned for this PR.<br>
  If you don't know who could review this, please indicate so. The list of<br>
  suggested reviewers on the right can help you.</li>
</ul>
<p>Please ensure all communication adheres to the <a href="https://github.com/bytecodealliance/wasmtime/blob/master/CODE_OF_CONDUCT.md" title="https://github.com/bytecodealliance/wasmtime/blob/master/CODE_OF_CONDUCT.md">code of
conduct</a>.<br>
--&gt;</p>
</blockquote>



<a name="196256399"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231570%20Fix%20long-range%20%28non-colocated%29%20aarch6.../near/196256399" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231570.20Fix.20long-range.20.28non-colocated.29.20aarch6.2E.2E.2E.html#196256399">(May 05 2020 at 00:29)</a>:</h4>
<p>cfallin updated <a href="https://github.com/bytecodealliance/wasmtime/pull/1570" title="https://github.com/bytecodealliance/wasmtime/pull/1570">PR #1570</a> from <code>fix-long-range-aarch64-call</code> to <code>master</code>:</p>
<blockquote>
<p>Previously, every call was lowered on AArch64 to a <code>call</code> instruction, which<br>
takes a signed 26-bit PC-relative offset. Including the 2-bit left shift, this<br>
gives a range of +/- 128 MB. Longer-distance offsets would cause an impossible<br>
relocation record to be emitted (or rather, a record that a more sophisticated<br>
linker would fix up by inserting a shim/veneer).</p>
<p>This commit adds a notion of "relocation distance" in the MachInst backends,<br>
and provides this information for every call target and symbol reference. The<br>
intent is that backends on architectures like AArch64, where there are different<br>
offset sizes / addressing strategies to choose from, can either emit a regular<br>
call or a load-64-bit-constant / call-indirect sequence, as necessary. This<br>
avoids the need to implement complex linking behavior.</p>
<p>The MachInst driver code provides this information based on the "colocated" bit<br>
in the CLIF symbol references, which appears to have been designed for this<br>
purpose, or at least a similar one. Combined with the <code>use_colocated_libcalls</code><br>
setting, this allows client code to ensure that library calls can link to<br>
library code at any location in the address space.</p>
<p>Separately, the <code>simplejit</code> example did not handle <code>Arm64Call</code>; rather than doing<br>
so, it appears all that is necessary to get its tests to pass is to set the<br>
<code>use_colocated_libcalls</code> flag to false, to make use of the above change. This<br>
fixes the <code>libcall_function</code> unit-test in this crate.</p>
<p>&lt;!--</p>
<p>Please ensure that the following steps are all taken care of before submitting<br>
the PR.</p>
<ul>
<li>
<p>[ ] This has been discussed in issue #..., or if not, please tell us why<br>
  here.</p>
</li>
<li>
<p>[ ] A short description of what this does, why it is needed; if the<br>
  description becomes long, the matter should probably be discussed in an issue<br>
  first.</p>
</li>
<li>
<p>[ ] This PR contains test cases, if meaningful.</p>
</li>
<li>[ ] A reviewer from the core maintainer team has been assigned for this PR.<br>
  If you don't know who could review this, please indicate so. The list of<br>
  suggested reviewers on the right can help you.</li>
</ul>
<p>Please ensure all communication adheres to the <a href="https://github.com/bytecodealliance/wasmtime/blob/master/CODE_OF_CONDUCT.md" title="https://github.com/bytecodealliance/wasmtime/blob/master/CODE_OF_CONDUCT.md">code of
conduct</a>.<br>
--&gt;</p>
</blockquote>



<a name="196257443"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231570%20Fix%20long-range%20%28non-colocated%29%20aarch6.../near/196257443" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231570.20Fix.20long-range.20.28non-colocated.29.20aarch6.2E.2E.2E.html#196257443">(May 05 2020 at 00:47)</a>:</h4>
<p>cfallin updated <a href="https://github.com/bytecodealliance/wasmtime/pull/1570" title="https://github.com/bytecodealliance/wasmtime/pull/1570">PR #1570</a> from <code>fix-long-range-aarch64-call</code> to <code>master</code>:</p>
<blockquote>
<p>Previously, every call was lowered on AArch64 to a <code>call</code> instruction, which<br>
takes a signed 26-bit PC-relative offset. Including the 2-bit left shift, this<br>
gives a range of +/- 128 MB. Longer-distance offsets would cause an impossible<br>
relocation record to be emitted (or rather, a record that a more sophisticated<br>
linker would fix up by inserting a shim/veneer).</p>
<p>This commit adds a notion of "relocation distance" in the MachInst backends,<br>
and provides this information for every call target and symbol reference. The<br>
intent is that backends on architectures like AArch64, where there are different<br>
offset sizes / addressing strategies to choose from, can either emit a regular<br>
call or a load-64-bit-constant / call-indirect sequence, as necessary. This<br>
avoids the need to implement complex linking behavior.</p>
<p>The MachInst driver code provides this information based on the "colocated" bit<br>
in the CLIF symbol references, which appears to have been designed for this<br>
purpose, or at least a similar one. Combined with the <code>use_colocated_libcalls</code><br>
setting, this allows client code to ensure that library calls can link to<br>
library code at any location in the address space.</p>
<p>Separately, the <code>simplejit</code> example did not handle <code>Arm64Call</code>; rather than doing<br>
so, it appears all that is necessary to get its tests to pass is to set the<br>
<code>use_colocated_libcalls</code> flag to false, to make use of the above change. This<br>
fixes the <code>libcall_function</code> unit-test in this crate.</p>
<p>&lt;!--</p>
<p>Please ensure that the following steps are all taken care of before submitting<br>
the PR.</p>
<ul>
<li>
<p>[ ] This has been discussed in issue #..., or if not, please tell us why<br>
  here.</p>
</li>
<li>
<p>[ ] A short description of what this does, why it is needed; if the<br>
  description becomes long, the matter should probably be discussed in an issue<br>
  first.</p>
</li>
<li>
<p>[ ] This PR contains test cases, if meaningful.</p>
</li>
<li>[ ] A reviewer from the core maintainer team has been assigned for this PR.<br>
  If you don't know who could review this, please indicate so. The list of<br>
  suggested reviewers on the right can help you.</li>
</ul>
<p>Please ensure all communication adheres to the <a href="https://github.com/bytecodealliance/wasmtime/blob/master/CODE_OF_CONDUCT.md" title="https://github.com/bytecodealliance/wasmtime/blob/master/CODE_OF_CONDUCT.md">code of
conduct</a>.<br>
--&gt;</p>
</blockquote>



<a name="196281154"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231570%20Fix%20long-range%20%28non-colocated%29%20aarch6.../near/196281154" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231570.20Fix.20long-range.20.28non-colocated.29.20aarch6.2E.2E.2E.html#196281154">(May 05 2020 at 08:42)</a>:</h4>
<p>bnjbvr submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/1570#pullrequestreview-405593822" title="https://github.com/bytecodealliance/wasmtime/pull/1570#pullrequestreview-405593822">PR Review</a>.</p>



<a name="196281155"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231570%20Fix%20long-range%20%28non-colocated%29%20aarch6.../near/196281155" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231570.20Fix.20long-range.20.28non-colocated.29.20aarch6.2E.2E.2E.html#196281155">(May 05 2020 at 08:42)</a>:</h4>
<p>bnjbvr created <a href="https://github.com/bytecodealliance/wasmtime/pull/1570#discussion_r419950473" title="https://github.com/bytecodealliance/wasmtime/pull/1570#discussion_r419950473">PR Review Comment</a>:</p>
<blockquote>
<p>nit: <code>If</code></p>
</blockquote>



<a name="196281156"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231570%20Fix%20long-range%20%28non-colocated%29%20aarch6.../near/196281156" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231570.20Fix.20long-range.20.28non-colocated.29.20aarch6.2E.2E.2E.html#196281156">(May 05 2020 at 08:42)</a>:</h4>
<p>bnjbvr submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/1570#pullrequestreview-405593822" title="https://github.com/bytecodealliance/wasmtime/pull/1570#pullrequestreview-405593822">PR Review</a>.</p>



<a name="196314464"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231570%20Fix%20long-range%20%28non-colocated%29%20aarch6.../near/196314464" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231570.20Fix.20long-range.20.28non-colocated.29.20aarch6.2E.2E.2E.html#196314464">(May 05 2020 at 14:23)</a>:</h4>
<p>cfallin updated <a href="https://github.com/bytecodealliance/wasmtime/pull/1570" title="https://github.com/bytecodealliance/wasmtime/pull/1570">PR #1570</a> from <code>fix-long-range-aarch64-call</code> to <code>master</code>:</p>
<blockquote>
<p>Previously, every call was lowered on AArch64 to a <code>call</code> instruction, which<br>
takes a signed 26-bit PC-relative offset. Including the 2-bit left shift, this<br>
gives a range of +/- 128 MB. Longer-distance offsets would cause an impossible<br>
relocation record to be emitted (or rather, a record that a more sophisticated<br>
linker would fix up by inserting a shim/veneer).</p>
<p>This commit adds a notion of "relocation distance" in the MachInst backends,<br>
and provides this information for every call target and symbol reference. The<br>
intent is that backends on architectures like AArch64, where there are different<br>
offset sizes / addressing strategies to choose from, can either emit a regular<br>
call or a load-64-bit-constant / call-indirect sequence, as necessary. This<br>
avoids the need to implement complex linking behavior.</p>
<p>The MachInst driver code provides this information based on the "colocated" bit<br>
in the CLIF symbol references, which appears to have been designed for this<br>
purpose, or at least a similar one. Combined with the <code>use_colocated_libcalls</code><br>
setting, this allows client code to ensure that library calls can link to<br>
library code at any location in the address space.</p>
<p>Separately, the <code>simplejit</code> example did not handle <code>Arm64Call</code>; rather than doing<br>
so, it appears all that is necessary to get its tests to pass is to set the<br>
<code>use_colocated_libcalls</code> flag to false, to make use of the above change. This<br>
fixes the <code>libcall_function</code> unit-test in this crate.</p>
<p>&lt;!--</p>
<p>Please ensure that the following steps are all taken care of before submitting<br>
the PR.</p>
<ul>
<li>
<p>[ ] This has been discussed in issue #..., or if not, please tell us why<br>
  here.</p>
</li>
<li>
<p>[ ] A short description of what this does, why it is needed; if the<br>
  description becomes long, the matter should probably be discussed in an issue<br>
  first.</p>
</li>
<li>
<p>[ ] This PR contains test cases, if meaningful.</p>
</li>
<li>[ ] A reviewer from the core maintainer team has been assigned for this PR.<br>
  If you don't know who could review this, please indicate so. The list of<br>
  suggested reviewers on the right can help you.</li>
</ul>
<p>Please ensure all communication adheres to the <a href="https://github.com/bytecodealliance/wasmtime/blob/master/CODE_OF_CONDUCT.md" title="https://github.com/bytecodealliance/wasmtime/blob/master/CODE_OF_CONDUCT.md">code of
conduct</a>.<br>
--&gt;</p>
</blockquote>



<a name="196314475"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231570%20Fix%20long-range%20%28non-colocated%29%20aarch6.../near/196314475" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231570.20Fix.20long-range.20.28non-colocated.29.20aarch6.2E.2E.2E.html#196314475">(May 05 2020 at 14:24)</a>:</h4>
<p>cfallin created <a href="https://github.com/bytecodealliance/wasmtime/pull/1570#discussion_r420149825" title="https://github.com/bytecodealliance/wasmtime/pull/1570#discussion_r420149825">PR Review Comment</a>:</p>
<blockquote>
<p>Fixed, thanks!</p>
</blockquote>



<a name="196314476"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231570%20Fix%20long-range%20%28non-colocated%29%20aarch6.../near/196314476" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231570.20Fix.20long-range.20.28non-colocated.29.20aarch6.2E.2E.2E.html#196314476">(May 05 2020 at 14:24)</a>:</h4>
<p>cfallin submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/1570#pullrequestreview-405839885" title="https://github.com/bytecodealliance/wasmtime/pull/1570#pullrequestreview-405839885">PR Review</a>.</p>



<a name="196335000"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231570%20Fix%20long-range%20%28non-colocated%29%20aarch6.../near/196335000" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231570.20Fix.20long-range.20.28non-colocated.29.20aarch6.2E.2E.2E.html#196335000">(May 05 2020 at 16:55)</a>:</h4>
<p>cfallin updated <a href="https://github.com/bytecodealliance/wasmtime/pull/1570" title="https://github.com/bytecodealliance/wasmtime/pull/1570">PR #1570</a> from <code>fix-long-range-aarch64-call</code> to <code>master</code>:</p>
<blockquote>
<p>Previously, every call was lowered on AArch64 to a <code>call</code> instruction, which<br>
takes a signed 26-bit PC-relative offset. Including the 2-bit left shift, this<br>
gives a range of +/- 128 MB. Longer-distance offsets would cause an impossible<br>
relocation record to be emitted (or rather, a record that a more sophisticated<br>
linker would fix up by inserting a shim/veneer).</p>
<p>This commit adds a notion of "relocation distance" in the MachInst backends,<br>
and provides this information for every call target and symbol reference. The<br>
intent is that backends on architectures like AArch64, where there are different<br>
offset sizes / addressing strategies to choose from, can either emit a regular<br>
call or a load-64-bit-constant / call-indirect sequence, as necessary. This<br>
avoids the need to implement complex linking behavior.</p>
<p>The MachInst driver code provides this information based on the "colocated" bit<br>
in the CLIF symbol references, which appears to have been designed for this<br>
purpose, or at least a similar one. Combined with the <code>use_colocated_libcalls</code><br>
setting, this allows client code to ensure that library calls can link to<br>
library code at any location in the address space.</p>
<p>Separately, the <code>simplejit</code> example did not handle <code>Arm64Call</code>; rather than doing<br>
so, it appears all that is necessary to get its tests to pass is to set the<br>
<code>use_colocated_libcalls</code> flag to false, to make use of the above change. This<br>
fixes the <code>libcall_function</code> unit-test in this crate.</p>
<p>&lt;!--</p>
<p>Please ensure that the following steps are all taken care of before submitting<br>
the PR.</p>
<ul>
<li>
<p>[ ] This has been discussed in issue #..., or if not, please tell us why<br>
  here.</p>
</li>
<li>
<p>[ ] A short description of what this does, why it is needed; if the<br>
  description becomes long, the matter should probably be discussed in an issue<br>
  first.</p>
</li>
<li>
<p>[ ] This PR contains test cases, if meaningful.</p>
</li>
<li>[ ] A reviewer from the core maintainer team has been assigned for this PR.<br>
  If you don't know who could review this, please indicate so. The list of<br>
  suggested reviewers on the right can help you.</li>
</ul>
<p>Please ensure all communication adheres to the <a href="https://github.com/bytecodealliance/wasmtime/blob/master/CODE_OF_CONDUCT.md" title="https://github.com/bytecodealliance/wasmtime/blob/master/CODE_OF_CONDUCT.md">code of
conduct</a>.<br>
--&gt;</p>
</blockquote>



<a name="196341520"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231570%20Fix%20long-range%20%28non-colocated%29%20aarch6.../near/196341520" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231570.20Fix.20long-range.20.28non-colocated.29.20aarch6.2E.2E.2E.html#196341520">(May 05 2020 at 17:45)</a>:</h4>
<p>cfallin merged <a href="https://github.com/bytecodealliance/wasmtime/pull/1570" title="https://github.com/bytecodealliance/wasmtime/pull/1570">PR #1570</a>.</p>



<hr><p>Last updated: Jan 20 2025 at 06:04 UTC</p>
</html>