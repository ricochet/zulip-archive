<html>
<head><meta charset="utf-8"><title>wasmtime / PR #9867 Remove async-trait in bindgen · git-wasmtime · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/index.html">git-wasmtime</a></h2>
<h3>Topic: <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.239867.20Remove.20async-trait.20in.20bindgen.html">wasmtime / PR #9867 Remove async-trait in bindgen</a></h3>

<hr>

<base href="https://bytecodealliance.zulipchat.com">

<head><link href="https://bytecodealliance.github.io/zulip-archive/style.css" rel="stylesheet"></head>

<a name="490016733"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%239867%20Remove%20async-trait%20in%20bindgen/near/490016733" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.239867.20Remove.20async-trait.20in.20bindgen.html#490016733">(Dec 19 2024 at 17:32)</a>:</h4>
<p>ifsheldon opened <a href="https://github.com/bytecodealliance/wasmtime/pull/9867">PR #9867</a> from <code>ifsheldon:remove-async-trait-in-bindgen</code> to <code>bytecodealliance:main</code>:</p>
<blockquote>
<p>Closes #9823 </p>
<p>I ran <code>cargo test -p wasmtime-wasi</code> and all tests passed, so now I'd like to go through the whole CI.</p>
<p>There are only 2 cases remaining unresolved due to the use of dyn objects, i.e., <code>wasmtime::runtime::store::CallHookHandler</code> and <code>wasmtime::runtime::limits::ResourceLimiterAsync</code>, but they are related to the runtime, so I don't think they are very relevant to the issue and I left them unchanged.<br>
</p>
</blockquote>



<a name="490016737"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%239867%20Remove%20async-trait%20in%20bindgen/near/490016737" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.239867.20Remove.20async-trait.20in.20bindgen.html#490016737">(Dec 19 2024 at 17:32)</a>:</h4>
<p><strong>ifsheldon</strong> requested <a href="https://github.com/dicej">dicej</a> for a review on <a href="https://github.com/bytecodealliance/wasmtime/pull/9867">PR #9867</a>.</p>



<a name="490016739"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%239867%20Remove%20async-trait%20in%20bindgen/near/490016739" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.239867.20Remove.20async-trait.20in.20bindgen.html#490016739">(Dec 19 2024 at 17:32)</a>:</h4>
<p><strong>ifsheldon</strong> requested <a href="https://github.com/orgs/bytecodealliance/teams/wasmtime-core-reviewers">wasmtime-core-reviewers</a> for a review on <a href="https://github.com/bytecodealliance/wasmtime/pull/9867">PR #9867</a>.</p>



<a name="490016740"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%239867%20Remove%20async-trait%20in%20bindgen/near/490016740" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.239867.20Remove.20async-trait.20in.20bindgen.html#490016740">(Dec 19 2024 at 17:32)</a>:</h4>
<p><strong>ifsheldon</strong> requested <a href="https://github.com/orgs/bytecodealliance/teams/wasmtime-default-reviewers">wasmtime-default-reviewers</a> for a review on <a href="https://github.com/bytecodealliance/wasmtime/pull/9867">PR #9867</a>.</p>



<a name="490043863"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%239867%20Remove%20async-trait%20in%20bindgen/near/490043863" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.239867.20Remove.20async-trait.20in.20bindgen.html#490043863">(Dec 19 2024 at 20:25)</a>:</h4>
<p>dicej submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/9867#pullrequestreview-2516101633">PR review</a>:</p>
<blockquote>
<p>Thanks for this!</p>
<p>LGTM overall, but see my inline comment about avoiding the <code>trait-variant</code> dependency, which would address the <code>cargo vet</code> CI failure.</p>
<p>The other CI failure should be easy to fix: just run <code>BINDGEN_TEST_BLESS=1 cargo test -p wasmtime-component-macro --test expanded</code>.</p>
</blockquote>



<a name="490043865"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%239867%20Remove%20async-trait%20in%20bindgen/near/490043865" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.239867.20Remove.20async-trait.20in.20bindgen.html#490043865">(Dec 19 2024 at 20:25)</a>:</h4>
<p>dicej created <a href="https://github.com/bytecodealliance/wasmtime/pull/9867#discussion_r1893089618">PR review comment</a>:</p>
<blockquote>
<p>Per <a href="https://docs.wasmtime.dev/contributing-coding-guidelines.html?highlight=vet#cargo-vet-for-contributors">this section</a> of the contributing docs, the bar for adding new dependencies to Wasmtime is a bit higher than for other projects (hence the <code>cargo vet</code> CI failure), so we need to make sure this one is worth including.</p>
<p>From what I can tell, it's only being used to annotate <code>wasmtime-wit-bindgen</code>-generated traits.  Given that we're generating those traits anyway, I wonder if we should modify the generator to emit a <code>-&gt; impl Future&lt;Output = T&gt; + Send</code> return type directly rather than rely on <code>trait-variant</code> to transform the code it just generated.  That would avoid the extra dependency and remove a layer of abstraction.  What do you think?</p>
</blockquote>



<a name="490098693"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%239867%20Remove%20async-trait%20in%20bindgen/near/490098693" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.239867.20Remove.20async-trait.20in.20bindgen.html#490098693">(Dec 20 2024 at 05:59)</a>:</h4>
<p>ifsheldon submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/9867#pullrequestreview-2516834702">PR review</a>.</p>



<a name="490098694"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%239867%20Remove%20async-trait%20in%20bindgen/near/490098694" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.239867.20Remove.20async-trait.20in.20bindgen.html#490098694">(Dec 20 2024 at 05:59)</a>:</h4>
<p>ifsheldon created <a href="https://github.com/bytecodealliance/wasmtime/pull/9867#discussion_r1893508384">PR review comment</a>:</p>
<blockquote>
<p>I would strongly recommend adding <code>trait-variant</code> because:</p>
<ol>
<li>it is maintained officially by the Rust project, so the code quality is reassured.</li>
<li>this is the recommended way to add <code>Send</code> bound by the <a href="https://blog.rust-lang.org/2023/12/21/async-fn-rpit-in-traits.html">Rust announcement about async fn in traits</a></li>
<li>in the announcement, it's said future version of <code>trait-variant</code> will support dyn trait object. Using <code>trait-variant</code> will enable dyn object support in the future without the need to modify <code>bindgen</code></li>
<li>compared to writing <code>-&gt; impl Future&lt;Output = T&gt; + Send</code> ourselves, it's better to leave <code>async fn</code> signatures for users to debug when users have IDEs like RustRover that can expand proc_macro layer by layer. So when they want to debug, they actually see <code>#[trait_variant::make]</code> and <code>async fn</code> instead of  <code>fn ... -&gt; impl Future&lt;Output = T&gt; + Send</code></li>
<li>from my perspective, the use of <code>#[trait_variant::make]</code> is sort of a marker indicating better support of async fn in traits is needed, which may benefit contributions.</li>
</ol>
<p>In general, I think <code>trait-variant</code> is a better solution than <code>async-trait</code> when we take the future evolution of Rust into account.</p>
<p>PS: replacing <code>async-trait</code> with <code>trait-variant</code> is a breaking change because:</p>
<ul>
<li>traits by <code>async-trait</code> support dyn trait object while traits with <code>trait-variant</code> for now do not</li>
<li>when implementing async traits, users need to remove <code>#[async_trait::async_trait]</code> on the impl blocks</li>
</ul>
</blockquote>



<a name="490183539"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%239867%20Remove%20async-trait%20in%20bindgen/near/490183539" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.239867.20Remove.20async-trait.20in.20bindgen.html#490183539">(Dec 20 2024 at 15:31)</a>:</h4>
<p>dicej submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/9867#pullrequestreview-2517795677">PR review</a>.</p>



<a name="490183542"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%239867%20Remove%20async-trait%20in%20bindgen/near/490183542" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.239867.20Remove.20async-trait.20in.20bindgen.html#490183542">(Dec 20 2024 at 15:31)</a>:</h4>
<p>dicej created <a href="https://github.com/bytecodealliance/wasmtime/pull/9867#discussion_r1894077336">PR review comment</a>:</p>
<blockquote>
<p>Thanks for explaining!  I hadn't realized <code>trait-variant</code> was a <code>rust-lang</code> project and that it has official status.  I'll add a commit to tell <code>cargo vet</code> to trust that crate.</p>
<p>And yes, I realize the removal of <code>async-trait</code> will be a breaking change in any case.</p>
</blockquote>



<a name="490184551"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%239867%20Remove%20async-trait%20in%20bindgen/near/490184551" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.239867.20Remove.20async-trait.20in.20bindgen.html#490184551">(Dec 20 2024 at 15:36)</a>:</h4>
<p>dicej updated <a href="https://github.com/bytecodealliance/wasmtime/pull/9867">PR #9867</a>.</p>



<a name="490187620"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%239867%20Remove%20async-trait%20in%20bindgen/near/490187620" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.239867.20Remove.20async-trait.20in.20bindgen.html#490187620">(Dec 20 2024 at 15:53)</a>:</h4>
<p>dicej updated <a href="https://github.com/bytecodealliance/wasmtime/pull/9867">PR #9867</a>.</p>



<a name="490191269"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%239867%20Remove%20async-trait%20in%20bindgen/near/490191269" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.239867.20Remove.20async-trait.20in.20bindgen.html#490191269">(Dec 20 2024 at 16:13)</a>:</h4>
<p>dicej submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/9867#pullrequestreview-2517873055">PR review</a>.</p>



<a name="490200984"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%239867%20Remove%20async-trait%20in%20bindgen/near/490200984" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.239867.20Remove.20async-trait.20in.20bindgen.html#490200984">(Dec 20 2024 at 17:12)</a>:</h4>
<p>alexcrichton merged <a href="https://github.com/bytecodealliance/wasmtime/pull/9867">PR #9867</a>.</p>



<hr><p>Last updated: Jan 20 2025 at 06:04 UTC</p>
</html>