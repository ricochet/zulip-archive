<html>
<head><meta charset="utf-8"><title>wasmtime / issue #4515 [fuzz] Add a meta-differential fuz... · git-wasmtime · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/index.html">git-wasmtime</a></h2>
<h3>Topic: <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.234515.20.5Bfuzz.5D.20Add.20a.20meta-differential.20fuz.2E.2E.2E.html">wasmtime / issue #4515 [fuzz] Add a meta-differential fuz...</a></h3>

<hr>

<base href="https://bytecodealliance.zulipchat.com">

<head><link href="https://bytecodealliance.github.io/zulip-archive/style.css" rel="stylesheet"></head>

<a name="290581394"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%234515%20%5Bfuzz%5D%20Add%20a%20meta-differential%20fuz.../near/290581394" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.234515.20.5Bfuzz.5D.20Add.20a.20meta-differential.20fuz.2E.2E.2E.html#290581394">(Jul 23 2022 at 00:18)</a>:</h4>
<p>jameysharp <a href="https://github.com/bytecodealliance/wasmtime/pull/4515#issuecomment-1193017997">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/4515">issue #4515</a>:</p>
<blockquote>
<p>Ooh, I am eager to look at this on Monday!</p>
</blockquote>



<a name="290582140"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%234515%20%5Bfuzz%5D%20Add%20a%20meta-differential%20fuz.../near/290582140" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.234515.20.5Bfuzz.5D.20Add.20a.20meta-differential.20fuz.2E.2E.2E.html#290582140">(Jul 23 2022 at 00:33)</a>:</h4>
<p>github-actions[bot] <a href="https://github.com/bytecodealliance/wasmtime/pull/4515#issuecomment-1193021468">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/4515">issue #4515</a>:</p>
<blockquote>
<h4>Subscribe to Label Action</h4>
<p>cc @fitzgen</p>
<p>&lt;details&gt;<br>
This issue or pull request has been labeled: "fuzzing"</p>
<p>Thus the following users have been cc'd because of the following labels:</p>
<ul>
<li>fitzgen: fuzzing</li>
</ul>
<p>To subscribe or unsubscribe from this label, edit the &lt;code&gt;.github/subscribe-to-label.json&lt;/code&gt; configuration file.</p>
<p><a href="https://github.com/bytecodealliance/subscribe-to-label-action">Learn more.</a><br>
&lt;/details&gt;</p>
</blockquote>



<a name="291255713"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%234515%20%5Bfuzz%5D%20Add%20a%20meta-differential%20fuz.../near/291255713" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.234515.20.5Bfuzz.5D.20Add.20a.20meta-differential.20fuz.2E.2E.2E.html#291255713">(Jul 28 2022 at 21:41)</a>:</h4>
<p>jameysharp <a href="https://github.com/bytecodealliance/wasmtime/pull/4515#issuecomment-1198660918">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/4515">issue #4515</a>:</p>
<blockquote>
<p>It's been suggested (by a couple different people, I think, but I've lost track of who) that when we have a wasm program we want to try running, we should run it with every engine we have, not just a pair of engines.</p>
<p>I don't think that needs to happen in this PR. I just wanted to note that if we do want that, I think the changes I see here already cover most of the work that would be needed. So that's great!</p>
<p>One of my teammates also suggested that we should check that different engines agree on whether a random sequence of bytes is a valid wasm binary. That seems like another relatively small extension of this work, that somebody could build after this lands.</p>
</blockquote>



<a name="291260357"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%234515%20%5Bfuzz%5D%20Add%20a%20meta-differential%20fuz.../near/291260357" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.234515.20.5Bfuzz.5D.20Add.20a.20meta-differential.20fuz.2E.2E.2E.html#291260357">(Jul 28 2022 at 22:24)</a>:</h4>
<p>alexcrichton <a href="https://github.com/bytecodealliance/wasmtime/pull/4515#issuecomment-1198688787">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/4515">issue #4515</a>:</p>
<blockquote>
<p>One worry I have about running against all engines is that we run the risk of really hurting executions per second during fuzzing. When something fails I think it might be good to run in other engines to figure out which answer is probably correct, or otherwise being able to run in multiple engines easily locally would be good. While fuzzing though I think it's best to stick to just 2 engines with one guaranteed as Wasmtime</p>
</blockquote>



<a name="293006130"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%234515%20%5Bfuzz%5D%20Add%20a%20meta-differential%20fuz.../near/293006130" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.234515.20.5Bfuzz.5D.20Add.20a.20meta-differential.20fuz.2E.2E.2E.html#293006130">(Aug 11 2022 at 20:45)</a>:</h4>
<p>abrown <a href="https://github.com/bytecodealliance/wasmtime/pull/4515#issuecomment-1212475678">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/4515">issue #4515</a>:</p>
<blockquote>
<p>All right, I'm marking this ready for review with some caveats that I think should be addressed in subsequent PRs. At this point, the PR provides a new interface for evaluating various engines against Wasmtime but for now is only is using single-instruction modules to do so. After resolving a bunch of issues that this identified (all related to fuzz infrastructure issues, IIRC), I was able to run the target for ~3 million test cases without crashing:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code>#<span class="mi">2963550</span><span class="w">        </span><span class="n">REDUCE</span><span class="w"> </span><span class="n">cov</span>: <span class="mi">30985</span><span class="w"> </span><span class="n">ft</span>: <span class="mi">87395</span><span class="w"> </span><span class="n">corp</span>: <span class="mi">1762</span><span class="o">/</span><span class="mi">219</span><span class="n">Kb</span><span class="w"> </span><span class="n">lim</span>: <span class="mi">4096</span><span class="w"> </span><span class="n">exec</span><span class="o">/</span><span class="n">s</span>: <span class="mi">394</span><span class="w"> </span><span class="n">rss</span>: <span class="mi">676</span><span class="n">Mb</span><span class="w"> </span><span class="n">L</span>: <span class="mi">140</span><span class="o">/</span><span class="mi">521</span><span class="w"> </span><span class="n">MS</span>: <span class="mi">1</span><span class="w"> </span><span class="n">EraseBytes</span><span class="o">-</span><span class="w"></span>
<span class="n">ignoring</span><span class="w"> </span><span class="n">error</span>: <span class="nc">this</span><span class="w"> </span><span class="n">error</span><span class="w"> </span><span class="n">should</span><span class="w"> </span><span class="n">be</span><span class="w"> </span><span class="n">ignored</span><span class="w"> </span><span class="n">by</span><span class="w"> </span><span class="n">fuzzing</span>: <span class="nc">unable</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">compile</span><span class="w"> </span><span class="n">module</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="n">wasmtime</span><span class="w"></span>
<span class="n">ignoring</span><span class="w"> </span><span class="n">error</span>: <span class="nc">this</span><span class="w"> </span><span class="n">error</span><span class="w"> </span><span class="n">should</span><span class="w"> </span><span class="n">be</span><span class="w"> </span><span class="n">ignored</span><span class="w"> </span><span class="n">by</span><span class="w"> </span><span class="n">fuzzing</span>: <span class="nc">unable</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">compile</span><span class="w"> </span><span class="n">module</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="n">wasmtime</span><span class="w"></span>
<span class="n">ignoring</span><span class="w"> </span><span class="n">error</span>: <span class="nc">this</span><span class="w"> </span><span class="n">error</span><span class="w"> </span><span class="n">should</span><span class="w"> </span><span class="n">be</span><span class="w"> </span><span class="n">ignored</span><span class="w"> </span><span class="n">by</span><span class="w"> </span><span class="n">fuzzing</span>: <span class="nc">unable</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">compile</span><span class="w"> </span><span class="n">module</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="n">wasmtime</span><span class="w"></span>
<span class="n">ignoring</span><span class="w"> </span><span class="n">error</span>: <span class="nc">this</span><span class="w"> </span><span class="n">error</span><span class="w"> </span><span class="n">should</span><span class="w"> </span><span class="n">be</span><span class="w"> </span><span class="n">ignored</span><span class="w"> </span><span class="n">by</span><span class="w"> </span><span class="n">fuzzing</span>: <span class="nc">Unknown</span><span class="w"> </span><span class="n">opcode</span><span class="w"> </span><span class="mi">195</span><span class="w"></span>
<span class="n">ignoring</span><span class="w"> </span><span class="n">error</span>: <span class="nc">this</span><span class="w"> </span><span class="n">error</span><span class="w"> </span><span class="n">should</span><span class="w"> </span><span class="n">be</span><span class="w"> </span><span class="n">ignored</span><span class="w"> </span><span class="n">by</span><span class="w"> </span><span class="n">fuzzing</span>: <span class="nc">Unknown</span><span class="w"> </span><span class="n">opcode</span><span class="w"> </span><span class="mi">195</span><span class="w"></span>
<span class="n">ignoring</span><span class="w"> </span><span class="n">error</span>: <span class="nc">this</span><span class="w"> </span><span class="n">error</span><span class="w"> </span><span class="n">should</span><span class="w"> </span><span class="n">be</span><span class="w"> </span><span class="n">ignored</span><span class="w"> </span><span class="n">by</span><span class="w"> </span><span class="n">fuzzing</span>: <span class="nc">Unknown</span><span class="w"> </span><span class="n">opcode</span><span class="w"> </span><span class="mi">195</span><span class="w"></span>
<span class="n">ignoring</span><span class="w"> </span><span class="n">error</span>: <span class="nc">this</span><span class="w"> </span><span class="n">error</span><span class="w"> </span><span class="n">should</span><span class="w"> </span><span class="n">be</span><span class="w"> </span><span class="n">ignored</span><span class="w"> </span><span class="n">by</span><span class="w"> </span><span class="n">fuzzing</span>: <span class="nc">Unknown</span><span class="w"> </span><span class="n">opcode</span><span class="w"> </span><span class="mi">195</span><span class="w"></span>
<span class="n">ignoring</span><span class="w"> </span><span class="n">error</span>: <span class="nc">this</span><span class="w"> </span><span class="n">error</span><span class="w"> </span><span class="n">should</span><span class="w"> </span><span class="n">be</span><span class="w"> </span><span class="n">ignored</span><span class="w"> </span><span class="n">by</span><span class="w"> </span><span class="n">fuzzing</span>: <span class="nc">unable</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">compile</span><span class="w"> </span><span class="n">module</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="n">wasmtime</span><span class="w"></span>
<span class="n">ignoring</span><span class="w"> </span><span class="n">error</span>: <span class="nc">this</span><span class="w"> </span><span class="n">error</span><span class="w"> </span><span class="n">should</span><span class="w"> </span><span class="n">be</span><span class="w"> </span><span class="n">ignored</span><span class="w"> </span><span class="n">by</span><span class="w"> </span><span class="n">fuzzing</span>: <span class="nc">unable</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">compile</span><span class="w"> </span><span class="n">module</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="n">wasmtime</span><span class="w"></span>
<span class="n">ignoring</span><span class="w"> </span><span class="n">error</span>: <span class="nc">this</span><span class="w"> </span><span class="n">error</span><span class="w"> </span><span class="n">should</span><span class="w"> </span><span class="n">be</span><span class="w"> </span><span class="n">ignored</span><span class="w"> </span><span class="n">by</span><span class="w"> </span><span class="n">fuzzing</span>: <span class="nc">unable</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">compile</span><span class="w"> </span><span class="n">module</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="n">wasmtime</span><span class="w"></span>
<span class="n">ignoring</span><span class="w"> </span><span class="n">error</span>: <span class="nc">this</span><span class="w"> </span><span class="n">error</span><span class="w"> </span><span class="n">should</span><span class="w"> </span><span class="n">be</span><span class="w"> </span><span class="n">ignored</span><span class="w"> </span><span class="n">by</span><span class="w"> </span><span class="n">fuzzing</span>: <span class="nc">unable</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">compile</span><span class="w"> </span><span class="n">module</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="n">wasmtime</span><span class="w"></span>
<span class="n">ignoring</span><span class="w"> </span><span class="n">error</span>: <span class="nc">this</span><span class="w"> </span><span class="n">error</span><span class="w"> </span><span class="n">should</span><span class="w"> </span><span class="n">be</span><span class="w"> </span><span class="n">ignored</span><span class="w"> </span><span class="n">by</span><span class="w"> </span><span class="n">fuzzing</span>: <span class="nc">unable</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">compile</span><span class="w"> </span><span class="n">module</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="n">wasmtime</span><span class="w"></span>
<span class="n">ignoring</span><span class="w"> </span><span class="n">error</span>: <span class="nc">this</span><span class="w"> </span><span class="n">error</span><span class="w"> </span><span class="n">should</span><span class="w"> </span><span class="n">be</span><span class="w"> </span><span class="n">ignored</span><span class="w"> </span><span class="n">by</span><span class="w"> </span><span class="n">fuzzing</span>: <span class="nc">unable</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">compile</span><span class="w"> </span><span class="n">module</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="n">wasmtime</span><span class="w"></span>
<span class="n">ignoring</span><span class="w"> </span><span class="n">error</span>: <span class="nc">this</span><span class="w"> </span><span class="n">error</span><span class="w"> </span><span class="n">should</span><span class="w"> </span><span class="n">be</span><span class="w"> </span><span class="n">ignored</span><span class="w"> </span><span class="n">by</span><span class="w"> </span><span class="n">fuzzing</span>: <span class="nc">unable</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">compile</span><span class="w"> </span><span class="n">module</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="n">wasmtime</span><span class="w"></span>
#<span class="mi">2964099</span><span class="w">        </span><span class="n">REDUCE</span><span class="w"> </span><span class="n">cov</span>: <span class="mi">30985</span><span class="w"> </span><span class="n">ft</span>: <span class="mi">87395</span><span class="w"> </span><span class="n">corp</span>: <span class="mi">1762</span><span class="o">/</span><span class="mi">219</span><span class="n">Kb</span><span class="w"> </span><span class="n">lim</span>: <span class="mi">4096</span><span class="w"> </span><span class="n">exec</span><span class="o">/</span><span class="n">s</span>: <span class="mi">394</span><span class="w"> </span><span class="n">rss</span>: <span class="mi">676</span><span class="n">Mb</span><span class="w"> </span><span class="n">L</span>: <span class="mi">131</span><span class="o">/</span><span class="mi">521</span><span class="w"> </span><span class="n">MS</span>: <span class="mi">4</span><span class="w"></span>
<span class="n">PersAutoDict</span><span class="o">-</span><span class="n">ShuffleBytes</span><span class="o">-</span><span class="n">ShuffleBytes</span><span class="o">-</span><span class="n">EraseBytes</span><span class="o">-</span><span class="w"> </span><span class="n">DE</span>: <span class="s">"</span><span class="se">\x17\x00\x00\x00\x00\x00\x00\x00</span><span class="s">"</span><span class="o">-</span><span class="w"></span>
<span class="n">ignoring</span><span class="w"> </span><span class="n">error</span>: <span class="nc">this</span><span class="w"> </span><span class="n">error</span><span class="w"> </span><span class="n">should</span><span class="w"> </span><span class="n">be</span><span class="w"> </span><span class="n">ignored</span><span class="w"> </span><span class="n">by</span><span class="w"> </span><span class="n">fuzzing</span>: <span class="nc">unable</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">compile</span><span class="w"> </span><span class="n">module</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="n">wasmtime</span><span class="w"></span>
</code></pre></div>
<p>Note how ignored errors are printed but don't cause a crash: <code>wasmi</code> doesn't understand all of the opcodes (which probably means we need to make the single-inst modules smarter to report when they use float-to-int conversions, e.g.) and Wasmtime frequently crashes when the pooling allocator picks sizes that are too small.</p>
<p>When run with <code>RUST_LOG=wasmtime_fuzzing=debug cargo +nightly fuzz run differential_meta</code>, the log output shows something like:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="p">[</span><span class="mi">2022</span><span class="o">-</span><span class="mi">08</span><span class="o">-</span><span class="mi">11</span><span class="n">T20</span>:<span class="mi">36</span>:<span class="mi">44</span><span class="n">Z</span><span class="w"> </span><span class="n">DEBUG</span><span class="w"> </span><span class="n">wasmtime_fuzzing</span>::<span class="n">oracles</span><span class="p">]</span><span class="w"> </span><span class="n">wrote</span><span class="w"> </span><span class="n">wasm</span><span class="w"> </span><span class="n">file</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="err">`</span><span class="n">testcase14</span><span class="p">.</span><span class="n">wasm</span><span class="err">`</span><span class="w"></span>
<span class="p">[</span><span class="mi">2022</span><span class="o">-</span><span class="mi">08</span><span class="o">-</span><span class="mi">11</span><span class="n">T20</span>:<span class="mi">36</span>:<span class="mi">44</span><span class="n">Z</span><span class="w"> </span><span class="n">DEBUG</span><span class="w"> </span><span class="n">wasmtime_fuzzing</span>::<span class="n">oracles</span><span class="p">]</span><span class="w"> </span><span class="n">Evaluating</span>: <span class="nc">test</span><span class="p">([</span><span class="n">F32</span><span class="p">(</span><span class="mi">198</span><span class="p">)])</span><span class="w"></span>
<span class="p">[</span><span class="mi">2022</span><span class="o">-</span><span class="mi">08</span><span class="o">-</span><span class="mi">11</span><span class="n">T20</span>:<span class="mi">36</span>:<span class="mi">44</span><span class="n">Z</span><span class="w"> </span><span class="n">DEBUG</span><span class="w"> </span><span class="n">wasmtime_fuzzing</span>::<span class="n">oracles</span><span class="p">]</span><span class="w">  </span>-&gt; <span class="nc">results</span><span class="w"> </span><span class="n">on</span><span class="w"> </span><span class="n">wasmi</span>: <span class="nb">Ok</span><span class="p">([</span><span class="n">F32</span><span class="p">(</span><span class="mi">0</span><span class="p">)])</span><span class="w"></span>
<span class="p">[</span><span class="mi">2022</span><span class="o">-</span><span class="mi">08</span><span class="o">-</span><span class="mi">11</span><span class="n">T20</span>:<span class="mi">36</span>:<span class="mi">44</span><span class="n">Z</span><span class="w"> </span><span class="n">DEBUG</span><span class="w"> </span><span class="n">wasmtime_fuzzing</span>::<span class="n">oracles</span><span class="p">]</span><span class="w">  </span>-&gt; <span class="nc">results</span><span class="w"> </span><span class="n">on</span><span class="w"> </span><span class="n">wasmtime</span>: <span class="nb">Ok</span><span class="p">([</span><span class="n">F32</span><span class="p">(</span><span class="mi">0</span><span class="p">)])</span><span class="w"></span>
<span class="p">[</span><span class="mi">2022</span><span class="o">-</span><span class="mi">08</span><span class="o">-</span><span class="mi">11</span><span class="n">T20</span>:<span class="mi">36</span>:<span class="mi">44</span><span class="n">Z</span><span class="w"> </span><span class="n">DEBUG</span><span class="w"> </span><span class="n">wasmtime_fuzzing</span>::<span class="n">oracles</span><span class="p">]</span><span class="w"> </span><span class="n">Hashing</span><span class="w"> </span><span class="n">instances</span>:
<span class="p">[</span><span class="mi">2022</span><span class="o">-</span><span class="mi">08</span><span class="o">-</span><span class="mi">11</span><span class="n">T20</span>:<span class="mi">36</span>:<span class="mi">44</span><span class="n">Z</span><span class="w"> </span><span class="n">DEBUG</span><span class="w"> </span><span class="n">wasmtime_fuzzing</span>::<span class="n">oracles</span><span class="p">]</span><span class="w">  </span>-&gt; <span class="nc">hash</span><span class="w"> </span><span class="n">of</span><span class="w"> </span><span class="n">wasmi</span>: <span class="mi">15130871412783076140</span><span class="w"></span>
<span class="p">[</span><span class="mi">2022</span><span class="o">-</span><span class="mi">08</span><span class="o">-</span><span class="mi">11</span><span class="n">T20</span>:<span class="mi">36</span>:<span class="mi">44</span><span class="n">Z</span><span class="w"> </span><span class="n">DEBUG</span><span class="w"> </span><span class="n">wasmtime_fuzzing</span>::<span class="n">oracles</span><span class="p">]</span><span class="w">  </span>-&gt; <span class="nc">hash</span><span class="w"> </span><span class="n">of</span><span class="w"> </span><span class="n">wasmtime</span>: <span class="mi">15130871412783076140</span><span class="w"></span>
</code></pre></div>
<p>I expect that once the following big items are finished we could remove all other differential targets and just use this one. For now, though, I would like to get this work merged so I can stop rebasing. This is work that I think could go in different PRs (but I am certainly open for discussion on that):</p>
<ul>
<li>[ ] adapt V8 to the <code>DiffEngine</code>/<code>DiffInstance</code> interface (@alexcrichton volunteered to look into this; the lifetime issues made this a bridge too far for this PR)</li>
<li>[ ] start fuzzing with the <code>wasm-smith</code>-generated modules (<code>BigModule</code>) instead of just single-instruction modules; this is complicated by the fact that <code>wasm-smith</code> will eat up all remaining unstructured data, leaving none for choosing engines and function arguments</li>
<li>[ ] figure out whether to fully commit to <code>ModuleFeatures</code> and report what Wasm feature a single-instruction uses (see comments above about this)</li>
<li>[ ] refactor how we ignore errors: I currently do this by wrapping the error message in <code>DiffIgnoreError</code> and downcasting the <code>anyhow</code> error to see if it is one of these; @alexcrichton mentioned that he preferred <code>Result&lt;Option&lt;...&gt;&gt;</code> to indicate the various states but this would involve some refactoring</li>
<li>[ ] add more instructions to the single-instruction module generator; e.g., my next feature to add would be SIMD instructions, which would likely find some bugs and require some additional infrastructure (e.g., V128 relaxed NaN comparison)<br>
</li>
</ul>
</blockquote>



<a name="293006168"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%234515%20%5Bfuzz%5D%20Add%20a%20meta-differential%20fuz.../near/293006168" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.234515.20.5Bfuzz.5D.20Add.20a.20meta-differential.20fuz.2E.2E.2E.html#293006168">(Aug 11 2022 at 20:45)</a>:</h4>
<p>abrown edited a <a href="https://github.com/bytecodealliance/wasmtime/pull/4515#issuecomment-1212475678">comment</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/4515">issue #4515</a>:</p>
<blockquote>
<p>All right, I'm marking this ready for review with some caveats that I think should be addressed in subsequent PRs. At this point, the PR provides a new interface for evaluating various engines against Wasmtime but for now is only is using single-instruction modules to do so. After resolving a bunch of issues that this identified (all related to fuzz infrastructure issues, IIRC), I was able to run the target for ~3 million test cases without crashing:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code>#<span class="mi">2963550</span><span class="w">        </span><span class="n">REDUCE</span><span class="w"> </span><span class="n">cov</span>: <span class="mi">30985</span><span class="w"> </span><span class="n">ft</span>: <span class="mi">87395</span><span class="w"> </span><span class="n">corp</span>: <span class="mi">1762</span><span class="o">/</span><span class="mi">219</span><span class="n">Kb</span><span class="w"> </span><span class="n">lim</span>: <span class="mi">4096</span><span class="w"> </span><span class="n">exec</span><span class="o">/</span><span class="n">s</span>: <span class="mi">394</span><span class="w"> </span><span class="n">rss</span>: <span class="mi">676</span><span class="n">Mb</span><span class="w"> </span><span class="n">L</span>: <span class="mi">140</span><span class="o">/</span><span class="mi">521</span><span class="w"> </span><span class="n">MS</span>: <span class="mi">1</span><span class="w"> </span><span class="n">EraseBytes</span><span class="o">-</span><span class="w"></span>
<span class="n">ignoring</span><span class="w"> </span><span class="n">error</span>: <span class="nc">this</span><span class="w"> </span><span class="n">error</span><span class="w"> </span><span class="n">should</span><span class="w"> </span><span class="n">be</span><span class="w"> </span><span class="n">ignored</span><span class="w"> </span><span class="n">by</span><span class="w"> </span><span class="n">fuzzing</span>: <span class="nc">unable</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">compile</span><span class="w"> </span><span class="n">module</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="n">wasmtime</span><span class="w"></span>
<span class="n">ignoring</span><span class="w"> </span><span class="n">error</span>: <span class="nc">this</span><span class="w"> </span><span class="n">error</span><span class="w"> </span><span class="n">should</span><span class="w"> </span><span class="n">be</span><span class="w"> </span><span class="n">ignored</span><span class="w"> </span><span class="n">by</span><span class="w"> </span><span class="n">fuzzing</span>: <span class="nc">unable</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">compile</span><span class="w"> </span><span class="n">module</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="n">wasmtime</span><span class="w"></span>
<span class="n">ignoring</span><span class="w"> </span><span class="n">error</span>: <span class="nc">this</span><span class="w"> </span><span class="n">error</span><span class="w"> </span><span class="n">should</span><span class="w"> </span><span class="n">be</span><span class="w"> </span><span class="n">ignored</span><span class="w"> </span><span class="n">by</span><span class="w"> </span><span class="n">fuzzing</span>: <span class="nc">unable</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">compile</span><span class="w"> </span><span class="n">module</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="n">wasmtime</span><span class="w"></span>
<span class="n">ignoring</span><span class="w"> </span><span class="n">error</span>: <span class="nc">this</span><span class="w"> </span><span class="n">error</span><span class="w"> </span><span class="n">should</span><span class="w"> </span><span class="n">be</span><span class="w"> </span><span class="n">ignored</span><span class="w"> </span><span class="n">by</span><span class="w"> </span><span class="n">fuzzing</span>: <span class="nc">Unknown</span><span class="w"> </span><span class="n">opcode</span><span class="w"> </span><span class="mi">195</span><span class="w"></span>
<span class="n">ignoring</span><span class="w"> </span><span class="n">error</span>: <span class="nc">this</span><span class="w"> </span><span class="n">error</span><span class="w"> </span><span class="n">should</span><span class="w"> </span><span class="n">be</span><span class="w"> </span><span class="n">ignored</span><span class="w"> </span><span class="n">by</span><span class="w"> </span><span class="n">fuzzing</span>: <span class="nc">Unknown</span><span class="w"> </span><span class="n">opcode</span><span class="w"> </span><span class="mi">195</span><span class="w"></span>
<span class="n">ignoring</span><span class="w"> </span><span class="n">error</span>: <span class="nc">this</span><span class="w"> </span><span class="n">error</span><span class="w"> </span><span class="n">should</span><span class="w"> </span><span class="n">be</span><span class="w"> </span><span class="n">ignored</span><span class="w"> </span><span class="n">by</span><span class="w"> </span><span class="n">fuzzing</span>: <span class="nc">Unknown</span><span class="w"> </span><span class="n">opcode</span><span class="w"> </span><span class="mi">195</span><span class="w"></span>
<span class="n">ignoring</span><span class="w"> </span><span class="n">error</span>: <span class="nc">this</span><span class="w"> </span><span class="n">error</span><span class="w"> </span><span class="n">should</span><span class="w"> </span><span class="n">be</span><span class="w"> </span><span class="n">ignored</span><span class="w"> </span><span class="n">by</span><span class="w"> </span><span class="n">fuzzing</span>: <span class="nc">Unknown</span><span class="w"> </span><span class="n">opcode</span><span class="w"> </span><span class="mi">195</span><span class="w"></span>
<span class="n">ignoring</span><span class="w"> </span><span class="n">error</span>: <span class="nc">this</span><span class="w"> </span><span class="n">error</span><span class="w"> </span><span class="n">should</span><span class="w"> </span><span class="n">be</span><span class="w"> </span><span class="n">ignored</span><span class="w"> </span><span class="n">by</span><span class="w"> </span><span class="n">fuzzing</span>: <span class="nc">unable</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">compile</span><span class="w"> </span><span class="n">module</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="n">wasmtime</span><span class="w"></span>
<span class="n">ignoring</span><span class="w"> </span><span class="n">error</span>: <span class="nc">this</span><span class="w"> </span><span class="n">error</span><span class="w"> </span><span class="n">should</span><span class="w"> </span><span class="n">be</span><span class="w"> </span><span class="n">ignored</span><span class="w"> </span><span class="n">by</span><span class="w"> </span><span class="n">fuzzing</span>: <span class="nc">unable</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">compile</span><span class="w"> </span><span class="n">module</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="n">wasmtime</span><span class="w"></span>
<span class="n">ignoring</span><span class="w"> </span><span class="n">error</span>: <span class="nc">this</span><span class="w"> </span><span class="n">error</span><span class="w"> </span><span class="n">should</span><span class="w"> </span><span class="n">be</span><span class="w"> </span><span class="n">ignored</span><span class="w"> </span><span class="n">by</span><span class="w"> </span><span class="n">fuzzing</span>: <span class="nc">unable</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">compile</span><span class="w"> </span><span class="n">module</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="n">wasmtime</span><span class="w"></span>
<span class="n">ignoring</span><span class="w"> </span><span class="n">error</span>: <span class="nc">this</span><span class="w"> </span><span class="n">error</span><span class="w"> </span><span class="n">should</span><span class="w"> </span><span class="n">be</span><span class="w"> </span><span class="n">ignored</span><span class="w"> </span><span class="n">by</span><span class="w"> </span><span class="n">fuzzing</span>: <span class="nc">unable</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">compile</span><span class="w"> </span><span class="n">module</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="n">wasmtime</span><span class="w"></span>
<span class="n">ignoring</span><span class="w"> </span><span class="n">error</span>: <span class="nc">this</span><span class="w"> </span><span class="n">error</span><span class="w"> </span><span class="n">should</span><span class="w"> </span><span class="n">be</span><span class="w"> </span><span class="n">ignored</span><span class="w"> </span><span class="n">by</span><span class="w"> </span><span class="n">fuzzing</span>: <span class="nc">unable</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">compile</span><span class="w"> </span><span class="n">module</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="n">wasmtime</span><span class="w"></span>
<span class="n">ignoring</span><span class="w"> </span><span class="n">error</span>: <span class="nc">this</span><span class="w"> </span><span class="n">error</span><span class="w"> </span><span class="n">should</span><span class="w"> </span><span class="n">be</span><span class="w"> </span><span class="n">ignored</span><span class="w"> </span><span class="n">by</span><span class="w"> </span><span class="n">fuzzing</span>: <span class="nc">unable</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">compile</span><span class="w"> </span><span class="n">module</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="n">wasmtime</span><span class="w"></span>
<span class="n">ignoring</span><span class="w"> </span><span class="n">error</span>: <span class="nc">this</span><span class="w"> </span><span class="n">error</span><span class="w"> </span><span class="n">should</span><span class="w"> </span><span class="n">be</span><span class="w"> </span><span class="n">ignored</span><span class="w"> </span><span class="n">by</span><span class="w"> </span><span class="n">fuzzing</span>: <span class="nc">unable</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">compile</span><span class="w"> </span><span class="n">module</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="n">wasmtime</span><span class="w"></span>
#<span class="mi">2964099</span><span class="w">        </span><span class="n">REDUCE</span><span class="w"> </span><span class="n">cov</span>: <span class="mi">30985</span><span class="w"> </span><span class="n">ft</span>: <span class="mi">87395</span><span class="w"> </span><span class="n">corp</span>: <span class="mi">1762</span><span class="o">/</span><span class="mi">219</span><span class="n">Kb</span><span class="w"> </span><span class="n">lim</span>: <span class="mi">4096</span><span class="w"> </span><span class="n">exec</span><span class="o">/</span><span class="n">s</span>: <span class="mi">394</span><span class="w"> </span><span class="n">rss</span>: <span class="mi">676</span><span class="n">Mb</span><span class="w"> </span><span class="n">L</span>: <span class="mi">131</span><span class="o">/</span><span class="mi">521</span><span class="w"> </span><span class="n">MS</span>: <span class="mi">4</span><span class="w"></span>
<span class="n">PersAutoDict</span><span class="o">-</span><span class="n">ShuffleBytes</span><span class="o">-</span><span class="n">ShuffleBytes</span><span class="o">-</span><span class="n">EraseBytes</span><span class="o">-</span><span class="w"> </span><span class="n">DE</span>: <span class="s">"</span><span class="se">\x17\x00\x00\x00\x00\x00\x00\x00</span><span class="s">"</span><span class="o">-</span><span class="w"></span>
<span class="n">ignoring</span><span class="w"> </span><span class="n">error</span>: <span class="nc">this</span><span class="w"> </span><span class="n">error</span><span class="w"> </span><span class="n">should</span><span class="w"> </span><span class="n">be</span><span class="w"> </span><span class="n">ignored</span><span class="w"> </span><span class="n">by</span><span class="w"> </span><span class="n">fuzzing</span>: <span class="nc">unable</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">compile</span><span class="w"> </span><span class="n">module</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="n">wasmtime</span><span class="w"></span>
</code></pre></div>
<p>Note how ignored errors are printed but don't cause a crash: <code>wasmi</code> doesn't understand all of the opcodes (which probably means we need to make the single-inst modules smarter to report when they use float-to-int conversions, e.g.) and Wasmtime frequently crashes when the pooling allocator picks sizes that are too small.</p>
<p>When run with <code>RUST_LOG=wasmtime_fuzzing=debug cargo +nightly fuzz run differential_meta</code>, the log output shows something like:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="p">[</span><span class="mi">2022</span><span class="o">-</span><span class="mi">08</span><span class="o">-</span><span class="mi">11</span><span class="n">T20</span>:<span class="mi">36</span>:<span class="mi">44</span><span class="n">Z</span><span class="w"> </span><span class="n">DEBUG</span><span class="w"> </span><span class="n">wasmtime_fuzzing</span>::<span class="n">oracles</span><span class="p">]</span><span class="w"> </span><span class="n">wrote</span><span class="w"> </span><span class="n">wasm</span><span class="w"> </span><span class="n">file</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="err">`</span><span class="n">testcase14</span><span class="p">.</span><span class="n">wasm</span><span class="err">`</span><span class="w"></span>
<span class="p">[</span><span class="mi">2022</span><span class="o">-</span><span class="mi">08</span><span class="o">-</span><span class="mi">11</span><span class="n">T20</span>:<span class="mi">36</span>:<span class="mi">44</span><span class="n">Z</span><span class="w"> </span><span class="n">DEBUG</span><span class="w"> </span><span class="n">wasmtime_fuzzing</span>::<span class="n">oracles</span><span class="p">]</span><span class="w"> </span><span class="n">Evaluating</span>: <span class="nc">test</span><span class="p">([</span><span class="n">F32</span><span class="p">(</span><span class="mi">198</span><span class="p">)])</span><span class="w"></span>
<span class="p">[</span><span class="mi">2022</span><span class="o">-</span><span class="mi">08</span><span class="o">-</span><span class="mi">11</span><span class="n">T20</span>:<span class="mi">36</span>:<span class="mi">44</span><span class="n">Z</span><span class="w"> </span><span class="n">DEBUG</span><span class="w"> </span><span class="n">wasmtime_fuzzing</span>::<span class="n">oracles</span><span class="p">]</span><span class="w">  </span>-&gt; <span class="nc">results</span><span class="w"> </span><span class="n">on</span><span class="w"> </span><span class="n">wasmi</span>: <span class="nb">Ok</span><span class="p">([</span><span class="n">F32</span><span class="p">(</span><span class="mi">0</span><span class="p">)])</span><span class="w"></span>
<span class="p">[</span><span class="mi">2022</span><span class="o">-</span><span class="mi">08</span><span class="o">-</span><span class="mi">11</span><span class="n">T20</span>:<span class="mi">36</span>:<span class="mi">44</span><span class="n">Z</span><span class="w"> </span><span class="n">DEBUG</span><span class="w"> </span><span class="n">wasmtime_fuzzing</span>::<span class="n">oracles</span><span class="p">]</span><span class="w">  </span>-&gt; <span class="nc">results</span><span class="w"> </span><span class="n">on</span><span class="w"> </span><span class="n">wasmtime</span>: <span class="nb">Ok</span><span class="p">([</span><span class="n">F32</span><span class="p">(</span><span class="mi">0</span><span class="p">)])</span><span class="w"></span>
<span class="p">[</span><span class="mi">2022</span><span class="o">-</span><span class="mi">08</span><span class="o">-</span><span class="mi">11</span><span class="n">T20</span>:<span class="mi">36</span>:<span class="mi">44</span><span class="n">Z</span><span class="w"> </span><span class="n">DEBUG</span><span class="w"> </span><span class="n">wasmtime_fuzzing</span>::<span class="n">oracles</span><span class="p">]</span><span class="w"> </span><span class="n">Hashing</span><span class="w"> </span><span class="n">instances</span>:
<span class="p">[</span><span class="mi">2022</span><span class="o">-</span><span class="mi">08</span><span class="o">-</span><span class="mi">11</span><span class="n">T20</span>:<span class="mi">36</span>:<span class="mi">44</span><span class="n">Z</span><span class="w"> </span><span class="n">DEBUG</span><span class="w"> </span><span class="n">wasmtime_fuzzing</span>::<span class="n">oracles</span><span class="p">]</span><span class="w">  </span>-&gt; <span class="nc">hash</span><span class="w"> </span><span class="n">of</span><span class="w"> </span><span class="n">wasmi</span>: <span class="mi">15130871412783076140</span><span class="w"></span>
<span class="p">[</span><span class="mi">2022</span><span class="o">-</span><span class="mi">08</span><span class="o">-</span><span class="mi">11</span><span class="n">T20</span>:<span class="mi">36</span>:<span class="mi">44</span><span class="n">Z</span><span class="w"> </span><span class="n">DEBUG</span><span class="w"> </span><span class="n">wasmtime_fuzzing</span>::<span class="n">oracles</span><span class="p">]</span><span class="w">  </span>-&gt; <span class="nc">hash</span><span class="w"> </span><span class="n">of</span><span class="w"> </span><span class="n">wasmtime</span>: <span class="mi">15130871412783076140</span><span class="w"></span>
</code></pre></div>
<p>I expect that once the following big items are finished we could remove all other differential targets and just use this one. For now, though, I would like to get this work merged so I can stop rebasing. This is work that I think could go in different PRs (but I am certainly open for discussion on that):</p>
<ul>
<li>[ ] adapt V8 to the <code>DiffEngine</code>/<code>DiffInstance</code> interface (@alexcrichton volunteered to look into this; the lifetime issues made this a bridge too far for this PR)</li>
<li>[ ] start fuzzing with the <code>wasm-smith</code>-generated modules (<code>BigModule</code>) instead of just single-instruction modules; this is complicated by the fact that <code>wasm-smith</code> will eat up all remaining unstructured data, leaving none for choosing engines and function arguments</li>
<li>[ ] figure out whether to fully commit to <code>ModuleFeatures</code> and report what Wasm feature a single-instruction uses (see comments above about this)</li>
<li>[ ] refactor how we ignore errors: I currently do this by wrapping the error message in <code>DiffIgnoreError</code> and downcasting the <code>anyhow</code> error to see if it is one of these; @alexcrichton mentioned that he preferred <code>Result&lt;Option&lt;...&gt;&gt;</code> to indicate the various states but this would involve some refactoring</li>
<li>[ ] add more instructions to the single-instruction module generator; e.g., my next feature to add would be SIMD instructions, which would likely find some bugs and require some additional infrastructure (e.g., V128 relaxed NaN comparison)</li>
</ul>
<p>cc: @jameysharp, @alexcrichton, @fitzgen </p>
</blockquote>



<a name="293008024"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%234515%20%5Bfuzz%5D%20Add%20a%20meta-differential%20fuz.../near/293008024" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.234515.20.5Bfuzz.5D.20Add.20a.20meta-differential.20fuz.2E.2E.2E.html#293008024">(Aug 11 2022 at 20:58)</a>:</h4>
<p>abrown <a href="https://github.com/bytecodealliance/wasmtime/pull/4515#issuecomment-1212486350">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/4515">issue #4515</a>:</p>
<blockquote>
<p>Oh, one other point: I have gone back and forth a few times about how to design the interface and today, at least, I'm leaning towards merging the <code>DiffEngine</code> and <code>DiffInstance</code> traits. Initially I separated them because logically that's how we're used to thinking about these and it is nice to be able filter out engines that won't work with a certain module. I feel like there is a way to just use the <code>DiffInstance::instantiate</code> function to do all of this. This refactoring change doesn't change the essence of the PR above, though. On a related note, the hashing interface could also change: I've been thinking through how hashing could work in the OCaml spec interpreter and, once I figure out the OCaml-Rust bindings issues, it may be that the interface ends up looking like what @alexcrichton <a href="https://github.com/bytecodealliance/wasmtime/pull/4515#discussion_r928968551">suggested above</a>.</p>
</blockquote>



<a name="294179401"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%234515%20%5Bfuzz%5D%20Add%20a%20meta-differential%20fuz.../near/294179401" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.234515.20.5Bfuzz.5D.20Add.20a.20meta-differential.20fuz.2E.2E.2E.html#294179401">(Aug 18 2022 at 22:25)</a>:</h4>
<p>abrown edited a <a href="https://github.com/bytecodealliance/wasmtime/pull/4515#issuecomment-1212475678">comment</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/4515">issue #4515</a>:</p>
<blockquote>
<p>All right, I'm marking this ready for review with some caveats that I think should be addressed in subsequent PRs. At this point, the PR provides a new interface for evaluating various engines against Wasmtime but for now is only is using single-instruction modules to do so. After resolving a bunch of issues that this identified (all related to fuzz infrastructure issues, IIRC), I was able to run the target for ~3 million test cases without crashing:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code>#<span class="mi">2963550</span><span class="w">        </span><span class="n">REDUCE</span><span class="w"> </span><span class="n">cov</span>: <span class="mi">30985</span><span class="w"> </span><span class="n">ft</span>: <span class="mi">87395</span><span class="w"> </span><span class="n">corp</span>: <span class="mi">1762</span><span class="o">/</span><span class="mi">219</span><span class="n">Kb</span><span class="w"> </span><span class="n">lim</span>: <span class="mi">4096</span><span class="w"> </span><span class="n">exec</span><span class="o">/</span><span class="n">s</span>: <span class="mi">394</span><span class="w"> </span><span class="n">rss</span>: <span class="mi">676</span><span class="n">Mb</span><span class="w"> </span><span class="n">L</span>: <span class="mi">140</span><span class="o">/</span><span class="mi">521</span><span class="w"> </span><span class="n">MS</span>: <span class="mi">1</span><span class="w"> </span><span class="n">EraseBytes</span><span class="o">-</span><span class="w"></span>
<span class="n">ignoring</span><span class="w"> </span><span class="n">error</span>: <span class="nc">this</span><span class="w"> </span><span class="n">error</span><span class="w"> </span><span class="n">should</span><span class="w"> </span><span class="n">be</span><span class="w"> </span><span class="n">ignored</span><span class="w"> </span><span class="n">by</span><span class="w"> </span><span class="n">fuzzing</span>: <span class="nc">unable</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">compile</span><span class="w"> </span><span class="n">module</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="n">wasmtime</span><span class="w"></span>
<span class="n">ignoring</span><span class="w"> </span><span class="n">error</span>: <span class="nc">this</span><span class="w"> </span><span class="n">error</span><span class="w"> </span><span class="n">should</span><span class="w"> </span><span class="n">be</span><span class="w"> </span><span class="n">ignored</span><span class="w"> </span><span class="n">by</span><span class="w"> </span><span class="n">fuzzing</span>: <span class="nc">unable</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">compile</span><span class="w"> </span><span class="n">module</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="n">wasmtime</span><span class="w"></span>
<span class="n">ignoring</span><span class="w"> </span><span class="n">error</span>: <span class="nc">this</span><span class="w"> </span><span class="n">error</span><span class="w"> </span><span class="n">should</span><span class="w"> </span><span class="n">be</span><span class="w"> </span><span class="n">ignored</span><span class="w"> </span><span class="n">by</span><span class="w"> </span><span class="n">fuzzing</span>: <span class="nc">unable</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">compile</span><span class="w"> </span><span class="n">module</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="n">wasmtime</span><span class="w"></span>
<span class="n">ignoring</span><span class="w"> </span><span class="n">error</span>: <span class="nc">this</span><span class="w"> </span><span class="n">error</span><span class="w"> </span><span class="n">should</span><span class="w"> </span><span class="n">be</span><span class="w"> </span><span class="n">ignored</span><span class="w"> </span><span class="n">by</span><span class="w"> </span><span class="n">fuzzing</span>: <span class="nc">Unknown</span><span class="w"> </span><span class="n">opcode</span><span class="w"> </span><span class="mi">195</span><span class="w"></span>
<span class="n">ignoring</span><span class="w"> </span><span class="n">error</span>: <span class="nc">this</span><span class="w"> </span><span class="n">error</span><span class="w"> </span><span class="n">should</span><span class="w"> </span><span class="n">be</span><span class="w"> </span><span class="n">ignored</span><span class="w"> </span><span class="n">by</span><span class="w"> </span><span class="n">fuzzing</span>: <span class="nc">Unknown</span><span class="w"> </span><span class="n">opcode</span><span class="w"> </span><span class="mi">195</span><span class="w"></span>
<span class="n">ignoring</span><span class="w"> </span><span class="n">error</span>: <span class="nc">this</span><span class="w"> </span><span class="n">error</span><span class="w"> </span><span class="n">should</span><span class="w"> </span><span class="n">be</span><span class="w"> </span><span class="n">ignored</span><span class="w"> </span><span class="n">by</span><span class="w"> </span><span class="n">fuzzing</span>: <span class="nc">Unknown</span><span class="w"> </span><span class="n">opcode</span><span class="w"> </span><span class="mi">195</span><span class="w"></span>
<span class="n">ignoring</span><span class="w"> </span><span class="n">error</span>: <span class="nc">this</span><span class="w"> </span><span class="n">error</span><span class="w"> </span><span class="n">should</span><span class="w"> </span><span class="n">be</span><span class="w"> </span><span class="n">ignored</span><span class="w"> </span><span class="n">by</span><span class="w"> </span><span class="n">fuzzing</span>: <span class="nc">Unknown</span><span class="w"> </span><span class="n">opcode</span><span class="w"> </span><span class="mi">195</span><span class="w"></span>
<span class="n">ignoring</span><span class="w"> </span><span class="n">error</span>: <span class="nc">this</span><span class="w"> </span><span class="n">error</span><span class="w"> </span><span class="n">should</span><span class="w"> </span><span class="n">be</span><span class="w"> </span><span class="n">ignored</span><span class="w"> </span><span class="n">by</span><span class="w"> </span><span class="n">fuzzing</span>: <span class="nc">unable</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">compile</span><span class="w"> </span><span class="n">module</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="n">wasmtime</span><span class="w"></span>
<span class="n">ignoring</span><span class="w"> </span><span class="n">error</span>: <span class="nc">this</span><span class="w"> </span><span class="n">error</span><span class="w"> </span><span class="n">should</span><span class="w"> </span><span class="n">be</span><span class="w"> </span><span class="n">ignored</span><span class="w"> </span><span class="n">by</span><span class="w"> </span><span class="n">fuzzing</span>: <span class="nc">unable</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">compile</span><span class="w"> </span><span class="n">module</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="n">wasmtime</span><span class="w"></span>
<span class="n">ignoring</span><span class="w"> </span><span class="n">error</span>: <span class="nc">this</span><span class="w"> </span><span class="n">error</span><span class="w"> </span><span class="n">should</span><span class="w"> </span><span class="n">be</span><span class="w"> </span><span class="n">ignored</span><span class="w"> </span><span class="n">by</span><span class="w"> </span><span class="n">fuzzing</span>: <span class="nc">unable</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">compile</span><span class="w"> </span><span class="n">module</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="n">wasmtime</span><span class="w"></span>
<span class="n">ignoring</span><span class="w"> </span><span class="n">error</span>: <span class="nc">this</span><span class="w"> </span><span class="n">error</span><span class="w"> </span><span class="n">should</span><span class="w"> </span><span class="n">be</span><span class="w"> </span><span class="n">ignored</span><span class="w"> </span><span class="n">by</span><span class="w"> </span><span class="n">fuzzing</span>: <span class="nc">unable</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">compile</span><span class="w"> </span><span class="n">module</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="n">wasmtime</span><span class="w"></span>
<span class="n">ignoring</span><span class="w"> </span><span class="n">error</span>: <span class="nc">this</span><span class="w"> </span><span class="n">error</span><span class="w"> </span><span class="n">should</span><span class="w"> </span><span class="n">be</span><span class="w"> </span><span class="n">ignored</span><span class="w"> </span><span class="n">by</span><span class="w"> </span><span class="n">fuzzing</span>: <span class="nc">unable</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">compile</span><span class="w"> </span><span class="n">module</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="n">wasmtime</span><span class="w"></span>
<span class="n">ignoring</span><span class="w"> </span><span class="n">error</span>: <span class="nc">this</span><span class="w"> </span><span class="n">error</span><span class="w"> </span><span class="n">should</span><span class="w"> </span><span class="n">be</span><span class="w"> </span><span class="n">ignored</span><span class="w"> </span><span class="n">by</span><span class="w"> </span><span class="n">fuzzing</span>: <span class="nc">unable</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">compile</span><span class="w"> </span><span class="n">module</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="n">wasmtime</span><span class="w"></span>
<span class="n">ignoring</span><span class="w"> </span><span class="n">error</span>: <span class="nc">this</span><span class="w"> </span><span class="n">error</span><span class="w"> </span><span class="n">should</span><span class="w"> </span><span class="n">be</span><span class="w"> </span><span class="n">ignored</span><span class="w"> </span><span class="n">by</span><span class="w"> </span><span class="n">fuzzing</span>: <span class="nc">unable</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">compile</span><span class="w"> </span><span class="n">module</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="n">wasmtime</span><span class="w"></span>
#<span class="mi">2964099</span><span class="w">        </span><span class="n">REDUCE</span><span class="w"> </span><span class="n">cov</span>: <span class="mi">30985</span><span class="w"> </span><span class="n">ft</span>: <span class="mi">87395</span><span class="w"> </span><span class="n">corp</span>: <span class="mi">1762</span><span class="o">/</span><span class="mi">219</span><span class="n">Kb</span><span class="w"> </span><span class="n">lim</span>: <span class="mi">4096</span><span class="w"> </span><span class="n">exec</span><span class="o">/</span><span class="n">s</span>: <span class="mi">394</span><span class="w"> </span><span class="n">rss</span>: <span class="mi">676</span><span class="n">Mb</span><span class="w"> </span><span class="n">L</span>: <span class="mi">131</span><span class="o">/</span><span class="mi">521</span><span class="w"> </span><span class="n">MS</span>: <span class="mi">4</span><span class="w"></span>
<span class="n">PersAutoDict</span><span class="o">-</span><span class="n">ShuffleBytes</span><span class="o">-</span><span class="n">ShuffleBytes</span><span class="o">-</span><span class="n">EraseBytes</span><span class="o">-</span><span class="w"> </span><span class="n">DE</span>: <span class="s">"</span><span class="se">\x17\x00\x00\x00\x00\x00\x00\x00</span><span class="s">"</span><span class="o">-</span><span class="w"></span>
<span class="n">ignoring</span><span class="w"> </span><span class="n">error</span>: <span class="nc">this</span><span class="w"> </span><span class="n">error</span><span class="w"> </span><span class="n">should</span><span class="w"> </span><span class="n">be</span><span class="w"> </span><span class="n">ignored</span><span class="w"> </span><span class="n">by</span><span class="w"> </span><span class="n">fuzzing</span>: <span class="nc">unable</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">compile</span><span class="w"> </span><span class="n">module</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="n">wasmtime</span><span class="w"></span>
</code></pre></div>
<p>Note how ignored errors are printed but don't cause a crash: <code>wasmi</code> doesn't understand all of the opcodes (which probably means we need to make the single-inst modules smarter to report when they use float-to-int conversions, e.g.) and Wasmtime frequently crashes when the pooling allocator picks sizes that are too small.</p>
<p>When run with <code>RUST_LOG=wasmtime_fuzzing=debug cargo +nightly fuzz run differential_meta</code>, the log output shows something like:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="p">[</span><span class="mi">2022</span><span class="o">-</span><span class="mi">08</span><span class="o">-</span><span class="mi">11</span><span class="n">T20</span>:<span class="mi">36</span>:<span class="mi">44</span><span class="n">Z</span><span class="w"> </span><span class="n">DEBUG</span><span class="w"> </span><span class="n">wasmtime_fuzzing</span>::<span class="n">oracles</span><span class="p">]</span><span class="w"> </span><span class="n">wrote</span><span class="w"> </span><span class="n">wasm</span><span class="w"> </span><span class="n">file</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="err">`</span><span class="n">testcase14</span><span class="p">.</span><span class="n">wasm</span><span class="err">`</span><span class="w"></span>
<span class="p">[</span><span class="mi">2022</span><span class="o">-</span><span class="mi">08</span><span class="o">-</span><span class="mi">11</span><span class="n">T20</span>:<span class="mi">36</span>:<span class="mi">44</span><span class="n">Z</span><span class="w"> </span><span class="n">DEBUG</span><span class="w"> </span><span class="n">wasmtime_fuzzing</span>::<span class="n">oracles</span><span class="p">]</span><span class="w"> </span><span class="n">Evaluating</span>: <span class="nc">test</span><span class="p">([</span><span class="n">F32</span><span class="p">(</span><span class="mi">198</span><span class="p">)])</span><span class="w"></span>
<span class="p">[</span><span class="mi">2022</span><span class="o">-</span><span class="mi">08</span><span class="o">-</span><span class="mi">11</span><span class="n">T20</span>:<span class="mi">36</span>:<span class="mi">44</span><span class="n">Z</span><span class="w"> </span><span class="n">DEBUG</span><span class="w"> </span><span class="n">wasmtime_fuzzing</span>::<span class="n">oracles</span><span class="p">]</span><span class="w">  </span>-&gt; <span class="nc">results</span><span class="w"> </span><span class="n">on</span><span class="w"> </span><span class="n">wasmi</span>: <span class="nb">Ok</span><span class="p">([</span><span class="n">F32</span><span class="p">(</span><span class="mi">0</span><span class="p">)])</span><span class="w"></span>
<span class="p">[</span><span class="mi">2022</span><span class="o">-</span><span class="mi">08</span><span class="o">-</span><span class="mi">11</span><span class="n">T20</span>:<span class="mi">36</span>:<span class="mi">44</span><span class="n">Z</span><span class="w"> </span><span class="n">DEBUG</span><span class="w"> </span><span class="n">wasmtime_fuzzing</span>::<span class="n">oracles</span><span class="p">]</span><span class="w">  </span>-&gt; <span class="nc">results</span><span class="w"> </span><span class="n">on</span><span class="w"> </span><span class="n">wasmtime</span>: <span class="nb">Ok</span><span class="p">([</span><span class="n">F32</span><span class="p">(</span><span class="mi">0</span><span class="p">)])</span><span class="w"></span>
<span class="p">[</span><span class="mi">2022</span><span class="o">-</span><span class="mi">08</span><span class="o">-</span><span class="mi">11</span><span class="n">T20</span>:<span class="mi">36</span>:<span class="mi">44</span><span class="n">Z</span><span class="w"> </span><span class="n">DEBUG</span><span class="w"> </span><span class="n">wasmtime_fuzzing</span>::<span class="n">oracles</span><span class="p">]</span><span class="w"> </span><span class="n">Hashing</span><span class="w"> </span><span class="n">instances</span>:
<span class="p">[</span><span class="mi">2022</span><span class="o">-</span><span class="mi">08</span><span class="o">-</span><span class="mi">11</span><span class="n">T20</span>:<span class="mi">36</span>:<span class="mi">44</span><span class="n">Z</span><span class="w"> </span><span class="n">DEBUG</span><span class="w"> </span><span class="n">wasmtime_fuzzing</span>::<span class="n">oracles</span><span class="p">]</span><span class="w">  </span>-&gt; <span class="nc">hash</span><span class="w"> </span><span class="n">of</span><span class="w"> </span><span class="n">wasmi</span>: <span class="mi">15130871412783076140</span><span class="w"></span>
<span class="p">[</span><span class="mi">2022</span><span class="o">-</span><span class="mi">08</span><span class="o">-</span><span class="mi">11</span><span class="n">T20</span>:<span class="mi">36</span>:<span class="mi">44</span><span class="n">Z</span><span class="w"> </span><span class="n">DEBUG</span><span class="w"> </span><span class="n">wasmtime_fuzzing</span>::<span class="n">oracles</span><span class="p">]</span><span class="w">  </span>-&gt; <span class="nc">hash</span><span class="w"> </span><span class="n">of</span><span class="w"> </span><span class="n">wasmtime</span>: <span class="mi">15130871412783076140</span><span class="w"></span>
</code></pre></div>
<p>I expect that once the following big items are finished we could remove all other differential targets and just use this one. For now, though, I would like to get this work merged so I can stop rebasing. This is work that I think could go in different PRs (but I am certainly open for discussion on that):</p>
<ul>
<li>[ ] adapt V8 to the <code>DiffEngine</code>/<code>DiffInstance</code> interface (@alexcrichton volunteered to look into this; the lifetime issues made this a bridge too far for this PR)</li>
<li>[x] start fuzzing with the <code>wasm-smith</code>-generated modules (<code>BigModule</code>) instead of just single-instruction modules; this is complicated by the fact that <code>wasm-smith</code> will eat up all remaining unstructured data, leaving none for choosing engines and function arguments</li>
<li>[ ] figure out whether to fully commit to <code>ModuleFeatures</code> and report what Wasm feature a single-instruction uses (see comments above about this)</li>
<li>[ ] refactor how we ignore errors: I currently do this by wrapping the error message in <code>DiffIgnoreError</code> and downcasting the <code>anyhow</code> error to see if it is one of these; @alexcrichton mentioned that he preferred <code>Result&lt;Option&lt;...&gt;&gt;</code> to indicate the various states but this would involve some refactoring</li>
<li>[ ] add more instructions to the single-instruction module generator; e.g., my next feature to add would be SIMD instructions, which would likely find some bugs and require some additional infrastructure (e.g., V128 relaxed NaN comparison)</li>
</ul>
<p>cc: @jameysharp, @alexcrichton, @fitzgen </p>
</blockquote>



<a name="294179404"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%234515%20%5Bfuzz%5D%20Add%20a%20meta-differential%20fuz.../near/294179404" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.234515.20.5Bfuzz.5D.20Add.20a.20meta-differential.20fuz.2E.2E.2E.html#294179404">(Aug 18 2022 at 22:25)</a>:</h4>
<p>abrown edited a <a href="https://github.com/bytecodealliance/wasmtime/pull/4515#issuecomment-1212475678">comment</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/4515">issue #4515</a>:</p>
<blockquote>
<p>All right, I'm marking this ready for review with some caveats that I think should be addressed in subsequent PRs. At this point, the PR provides a new interface for evaluating various engines against Wasmtime but for now is only is using single-instruction modules to do so. After resolving a bunch of issues that this identified (all related to fuzz infrastructure issues, IIRC), I was able to run the target for ~3 million test cases without crashing:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code>#<span class="mi">2963550</span><span class="w">        </span><span class="n">REDUCE</span><span class="w"> </span><span class="n">cov</span>: <span class="mi">30985</span><span class="w"> </span><span class="n">ft</span>: <span class="mi">87395</span><span class="w"> </span><span class="n">corp</span>: <span class="mi">1762</span><span class="o">/</span><span class="mi">219</span><span class="n">Kb</span><span class="w"> </span><span class="n">lim</span>: <span class="mi">4096</span><span class="w"> </span><span class="n">exec</span><span class="o">/</span><span class="n">s</span>: <span class="mi">394</span><span class="w"> </span><span class="n">rss</span>: <span class="mi">676</span><span class="n">Mb</span><span class="w"> </span><span class="n">L</span>: <span class="mi">140</span><span class="o">/</span><span class="mi">521</span><span class="w"> </span><span class="n">MS</span>: <span class="mi">1</span><span class="w"> </span><span class="n">EraseBytes</span><span class="o">-</span><span class="w"></span>
<span class="n">ignoring</span><span class="w"> </span><span class="n">error</span>: <span class="nc">this</span><span class="w"> </span><span class="n">error</span><span class="w"> </span><span class="n">should</span><span class="w"> </span><span class="n">be</span><span class="w"> </span><span class="n">ignored</span><span class="w"> </span><span class="n">by</span><span class="w"> </span><span class="n">fuzzing</span>: <span class="nc">unable</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">compile</span><span class="w"> </span><span class="n">module</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="n">wasmtime</span><span class="w"></span>
<span class="n">ignoring</span><span class="w"> </span><span class="n">error</span>: <span class="nc">this</span><span class="w"> </span><span class="n">error</span><span class="w"> </span><span class="n">should</span><span class="w"> </span><span class="n">be</span><span class="w"> </span><span class="n">ignored</span><span class="w"> </span><span class="n">by</span><span class="w"> </span><span class="n">fuzzing</span>: <span class="nc">unable</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">compile</span><span class="w"> </span><span class="n">module</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="n">wasmtime</span><span class="w"></span>
<span class="n">ignoring</span><span class="w"> </span><span class="n">error</span>: <span class="nc">this</span><span class="w"> </span><span class="n">error</span><span class="w"> </span><span class="n">should</span><span class="w"> </span><span class="n">be</span><span class="w"> </span><span class="n">ignored</span><span class="w"> </span><span class="n">by</span><span class="w"> </span><span class="n">fuzzing</span>: <span class="nc">unable</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">compile</span><span class="w"> </span><span class="n">module</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="n">wasmtime</span><span class="w"></span>
<span class="n">ignoring</span><span class="w"> </span><span class="n">error</span>: <span class="nc">this</span><span class="w"> </span><span class="n">error</span><span class="w"> </span><span class="n">should</span><span class="w"> </span><span class="n">be</span><span class="w"> </span><span class="n">ignored</span><span class="w"> </span><span class="n">by</span><span class="w"> </span><span class="n">fuzzing</span>: <span class="nc">Unknown</span><span class="w"> </span><span class="n">opcode</span><span class="w"> </span><span class="mi">195</span><span class="w"></span>
<span class="n">ignoring</span><span class="w"> </span><span class="n">error</span>: <span class="nc">this</span><span class="w"> </span><span class="n">error</span><span class="w"> </span><span class="n">should</span><span class="w"> </span><span class="n">be</span><span class="w"> </span><span class="n">ignored</span><span class="w"> </span><span class="n">by</span><span class="w"> </span><span class="n">fuzzing</span>: <span class="nc">Unknown</span><span class="w"> </span><span class="n">opcode</span><span class="w"> </span><span class="mi">195</span><span class="w"></span>
<span class="n">ignoring</span><span class="w"> </span><span class="n">error</span>: <span class="nc">this</span><span class="w"> </span><span class="n">error</span><span class="w"> </span><span class="n">should</span><span class="w"> </span><span class="n">be</span><span class="w"> </span><span class="n">ignored</span><span class="w"> </span><span class="n">by</span><span class="w"> </span><span class="n">fuzzing</span>: <span class="nc">Unknown</span><span class="w"> </span><span class="n">opcode</span><span class="w"> </span><span class="mi">195</span><span class="w"></span>
<span class="n">ignoring</span><span class="w"> </span><span class="n">error</span>: <span class="nc">this</span><span class="w"> </span><span class="n">error</span><span class="w"> </span><span class="n">should</span><span class="w"> </span><span class="n">be</span><span class="w"> </span><span class="n">ignored</span><span class="w"> </span><span class="n">by</span><span class="w"> </span><span class="n">fuzzing</span>: <span class="nc">Unknown</span><span class="w"> </span><span class="n">opcode</span><span class="w"> </span><span class="mi">195</span><span class="w"></span>
<span class="n">ignoring</span><span class="w"> </span><span class="n">error</span>: <span class="nc">this</span><span class="w"> </span><span class="n">error</span><span class="w"> </span><span class="n">should</span><span class="w"> </span><span class="n">be</span><span class="w"> </span><span class="n">ignored</span><span class="w"> </span><span class="n">by</span><span class="w"> </span><span class="n">fuzzing</span>: <span class="nc">unable</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">compile</span><span class="w"> </span><span class="n">module</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="n">wasmtime</span><span class="w"></span>
<span class="n">ignoring</span><span class="w"> </span><span class="n">error</span>: <span class="nc">this</span><span class="w"> </span><span class="n">error</span><span class="w"> </span><span class="n">should</span><span class="w"> </span><span class="n">be</span><span class="w"> </span><span class="n">ignored</span><span class="w"> </span><span class="n">by</span><span class="w"> </span><span class="n">fuzzing</span>: <span class="nc">unable</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">compile</span><span class="w"> </span><span class="n">module</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="n">wasmtime</span><span class="w"></span>
<span class="n">ignoring</span><span class="w"> </span><span class="n">error</span>: <span class="nc">this</span><span class="w"> </span><span class="n">error</span><span class="w"> </span><span class="n">should</span><span class="w"> </span><span class="n">be</span><span class="w"> </span><span class="n">ignored</span><span class="w"> </span><span class="n">by</span><span class="w"> </span><span class="n">fuzzing</span>: <span class="nc">unable</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">compile</span><span class="w"> </span><span class="n">module</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="n">wasmtime</span><span class="w"></span>
<span class="n">ignoring</span><span class="w"> </span><span class="n">error</span>: <span class="nc">this</span><span class="w"> </span><span class="n">error</span><span class="w"> </span><span class="n">should</span><span class="w"> </span><span class="n">be</span><span class="w"> </span><span class="n">ignored</span><span class="w"> </span><span class="n">by</span><span class="w"> </span><span class="n">fuzzing</span>: <span class="nc">unable</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">compile</span><span class="w"> </span><span class="n">module</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="n">wasmtime</span><span class="w"></span>
<span class="n">ignoring</span><span class="w"> </span><span class="n">error</span>: <span class="nc">this</span><span class="w"> </span><span class="n">error</span><span class="w"> </span><span class="n">should</span><span class="w"> </span><span class="n">be</span><span class="w"> </span><span class="n">ignored</span><span class="w"> </span><span class="n">by</span><span class="w"> </span><span class="n">fuzzing</span>: <span class="nc">unable</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">compile</span><span class="w"> </span><span class="n">module</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="n">wasmtime</span><span class="w"></span>
<span class="n">ignoring</span><span class="w"> </span><span class="n">error</span>: <span class="nc">this</span><span class="w"> </span><span class="n">error</span><span class="w"> </span><span class="n">should</span><span class="w"> </span><span class="n">be</span><span class="w"> </span><span class="n">ignored</span><span class="w"> </span><span class="n">by</span><span class="w"> </span><span class="n">fuzzing</span>: <span class="nc">unable</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">compile</span><span class="w"> </span><span class="n">module</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="n">wasmtime</span><span class="w"></span>
<span class="n">ignoring</span><span class="w"> </span><span class="n">error</span>: <span class="nc">this</span><span class="w"> </span><span class="n">error</span><span class="w"> </span><span class="n">should</span><span class="w"> </span><span class="n">be</span><span class="w"> </span><span class="n">ignored</span><span class="w"> </span><span class="n">by</span><span class="w"> </span><span class="n">fuzzing</span>: <span class="nc">unable</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">compile</span><span class="w"> </span><span class="n">module</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="n">wasmtime</span><span class="w"></span>
#<span class="mi">2964099</span><span class="w">        </span><span class="n">REDUCE</span><span class="w"> </span><span class="n">cov</span>: <span class="mi">30985</span><span class="w"> </span><span class="n">ft</span>: <span class="mi">87395</span><span class="w"> </span><span class="n">corp</span>: <span class="mi">1762</span><span class="o">/</span><span class="mi">219</span><span class="n">Kb</span><span class="w"> </span><span class="n">lim</span>: <span class="mi">4096</span><span class="w"> </span><span class="n">exec</span><span class="o">/</span><span class="n">s</span>: <span class="mi">394</span><span class="w"> </span><span class="n">rss</span>: <span class="mi">676</span><span class="n">Mb</span><span class="w"> </span><span class="n">L</span>: <span class="mi">131</span><span class="o">/</span><span class="mi">521</span><span class="w"> </span><span class="n">MS</span>: <span class="mi">4</span><span class="w"></span>
<span class="n">PersAutoDict</span><span class="o">-</span><span class="n">ShuffleBytes</span><span class="o">-</span><span class="n">ShuffleBytes</span><span class="o">-</span><span class="n">EraseBytes</span><span class="o">-</span><span class="w"> </span><span class="n">DE</span>: <span class="s">"</span><span class="se">\x17\x00\x00\x00\x00\x00\x00\x00</span><span class="s">"</span><span class="o">-</span><span class="w"></span>
<span class="n">ignoring</span><span class="w"> </span><span class="n">error</span>: <span class="nc">this</span><span class="w"> </span><span class="n">error</span><span class="w"> </span><span class="n">should</span><span class="w"> </span><span class="n">be</span><span class="w"> </span><span class="n">ignored</span><span class="w"> </span><span class="n">by</span><span class="w"> </span><span class="n">fuzzing</span>: <span class="nc">unable</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">compile</span><span class="w"> </span><span class="n">module</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="n">wasmtime</span><span class="w"></span>
</code></pre></div>
<p>Note how ignored errors are printed but don't cause a crash: <code>wasmi</code> doesn't understand all of the opcodes (which probably means we need to make the single-inst modules smarter to report when they use float-to-int conversions, e.g.) and Wasmtime frequently crashes when the pooling allocator picks sizes that are too small.</p>
<p>When run with <code>RUST_LOG=wasmtime_fuzzing=debug cargo +nightly fuzz run differential_meta</code>, the log output shows something like:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="p">[</span><span class="mi">2022</span><span class="o">-</span><span class="mi">08</span><span class="o">-</span><span class="mi">11</span><span class="n">T20</span>:<span class="mi">36</span>:<span class="mi">44</span><span class="n">Z</span><span class="w"> </span><span class="n">DEBUG</span><span class="w"> </span><span class="n">wasmtime_fuzzing</span>::<span class="n">oracles</span><span class="p">]</span><span class="w"> </span><span class="n">wrote</span><span class="w"> </span><span class="n">wasm</span><span class="w"> </span><span class="n">file</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="err">`</span><span class="n">testcase14</span><span class="p">.</span><span class="n">wasm</span><span class="err">`</span><span class="w"></span>
<span class="p">[</span><span class="mi">2022</span><span class="o">-</span><span class="mi">08</span><span class="o">-</span><span class="mi">11</span><span class="n">T20</span>:<span class="mi">36</span>:<span class="mi">44</span><span class="n">Z</span><span class="w"> </span><span class="n">DEBUG</span><span class="w"> </span><span class="n">wasmtime_fuzzing</span>::<span class="n">oracles</span><span class="p">]</span><span class="w"> </span><span class="n">Evaluating</span>: <span class="nc">test</span><span class="p">([</span><span class="n">F32</span><span class="p">(</span><span class="mi">198</span><span class="p">)])</span><span class="w"></span>
<span class="p">[</span><span class="mi">2022</span><span class="o">-</span><span class="mi">08</span><span class="o">-</span><span class="mi">11</span><span class="n">T20</span>:<span class="mi">36</span>:<span class="mi">44</span><span class="n">Z</span><span class="w"> </span><span class="n">DEBUG</span><span class="w"> </span><span class="n">wasmtime_fuzzing</span>::<span class="n">oracles</span><span class="p">]</span><span class="w">  </span>-&gt; <span class="nc">results</span><span class="w"> </span><span class="n">on</span><span class="w"> </span><span class="n">wasmi</span>: <span class="nb">Ok</span><span class="p">([</span><span class="n">F32</span><span class="p">(</span><span class="mi">0</span><span class="p">)])</span><span class="w"></span>
<span class="p">[</span><span class="mi">2022</span><span class="o">-</span><span class="mi">08</span><span class="o">-</span><span class="mi">11</span><span class="n">T20</span>:<span class="mi">36</span>:<span class="mi">44</span><span class="n">Z</span><span class="w"> </span><span class="n">DEBUG</span><span class="w"> </span><span class="n">wasmtime_fuzzing</span>::<span class="n">oracles</span><span class="p">]</span><span class="w">  </span>-&gt; <span class="nc">results</span><span class="w"> </span><span class="n">on</span><span class="w"> </span><span class="n">wasmtime</span>: <span class="nb">Ok</span><span class="p">([</span><span class="n">F32</span><span class="p">(</span><span class="mi">0</span><span class="p">)])</span><span class="w"></span>
<span class="p">[</span><span class="mi">2022</span><span class="o">-</span><span class="mi">08</span><span class="o">-</span><span class="mi">11</span><span class="n">T20</span>:<span class="mi">36</span>:<span class="mi">44</span><span class="n">Z</span><span class="w"> </span><span class="n">DEBUG</span><span class="w"> </span><span class="n">wasmtime_fuzzing</span>::<span class="n">oracles</span><span class="p">]</span><span class="w"> </span><span class="n">Hashing</span><span class="w"> </span><span class="n">instances</span>:
<span class="p">[</span><span class="mi">2022</span><span class="o">-</span><span class="mi">08</span><span class="o">-</span><span class="mi">11</span><span class="n">T20</span>:<span class="mi">36</span>:<span class="mi">44</span><span class="n">Z</span><span class="w"> </span><span class="n">DEBUG</span><span class="w"> </span><span class="n">wasmtime_fuzzing</span>::<span class="n">oracles</span><span class="p">]</span><span class="w">  </span>-&gt; <span class="nc">hash</span><span class="w"> </span><span class="n">of</span><span class="w"> </span><span class="n">wasmi</span>: <span class="mi">15130871412783076140</span><span class="w"></span>
<span class="p">[</span><span class="mi">2022</span><span class="o">-</span><span class="mi">08</span><span class="o">-</span><span class="mi">11</span><span class="n">T20</span>:<span class="mi">36</span>:<span class="mi">44</span><span class="n">Z</span><span class="w"> </span><span class="n">DEBUG</span><span class="w"> </span><span class="n">wasmtime_fuzzing</span>::<span class="n">oracles</span><span class="p">]</span><span class="w">  </span>-&gt; <span class="nc">hash</span><span class="w"> </span><span class="n">of</span><span class="w"> </span><span class="n">wasmtime</span>: <span class="mi">15130871412783076140</span><span class="w"></span>
</code></pre></div>
<p>I expect that once the following big items are finished we could remove all other differential targets and just use this one. For now, though, I would like to get this work merged so I can stop rebasing. This is work that I think could go in different PRs (but I am certainly open for discussion on that):</p>
<ul>
<li>[ ] adapt V8 to the <code>DiffEngine</code>/<code>DiffInstance</code> interface (@alexcrichton volunteered to look into this; the lifetime issues made this a bridge too far for this PR)</li>
<li>[x] start fuzzing with the <code>wasm-smith</code>-generated modules (<code>BigModule</code>) instead of just single-instruction modules; this is complicated by the fact that <code>wasm-smith</code> will eat up all remaining unstructured data, leaving none for choosing engines and function arguments</li>
<li>[x] figure out whether to fully commit to <code>ModuleFeatures</code> and report what Wasm feature a single-instruction uses (see comments above about this)</li>
<li>[ ] refactor how we ignore errors: I currently do this by wrapping the error message in <code>DiffIgnoreError</code> and downcasting the <code>anyhow</code> error to see if it is one of these; @alexcrichton mentioned that he preferred <code>Result&lt;Option&lt;...&gt;&gt;</code> to indicate the various states but this would involve some refactoring</li>
<li>[ ] add more instructions to the single-instruction module generator; e.g., my next feature to add would be SIMD instructions, which would likely find some bugs and require some additional infrastructure (e.g., V128 relaxed NaN comparison)</li>
</ul>
<p>cc: @jameysharp, @alexcrichton, @fitzgen </p>
</blockquote>



<a name="294179408"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%234515%20%5Bfuzz%5D%20Add%20a%20meta-differential%20fuz.../near/294179408" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.234515.20.5Bfuzz.5D.20Add.20a.20meta-differential.20fuz.2E.2E.2E.html#294179408">(Aug 18 2022 at 22:25)</a>:</h4>
<p>abrown edited a <a href="https://github.com/bytecodealliance/wasmtime/pull/4515#issuecomment-1212475678">comment</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/4515">issue #4515</a>:</p>
<blockquote>
<p>All right, I'm marking this ready for review with some caveats that I think should be addressed in subsequent PRs. At this point, the PR provides a new interface for evaluating various engines against Wasmtime but for now is only is using single-instruction modules to do so. After resolving a bunch of issues that this identified (all related to fuzz infrastructure issues, IIRC), I was able to run the target for ~3 million test cases without crashing:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code>#<span class="mi">2963550</span><span class="w">        </span><span class="n">REDUCE</span><span class="w"> </span><span class="n">cov</span>: <span class="mi">30985</span><span class="w"> </span><span class="n">ft</span>: <span class="mi">87395</span><span class="w"> </span><span class="n">corp</span>: <span class="mi">1762</span><span class="o">/</span><span class="mi">219</span><span class="n">Kb</span><span class="w"> </span><span class="n">lim</span>: <span class="mi">4096</span><span class="w"> </span><span class="n">exec</span><span class="o">/</span><span class="n">s</span>: <span class="mi">394</span><span class="w"> </span><span class="n">rss</span>: <span class="mi">676</span><span class="n">Mb</span><span class="w"> </span><span class="n">L</span>: <span class="mi">140</span><span class="o">/</span><span class="mi">521</span><span class="w"> </span><span class="n">MS</span>: <span class="mi">1</span><span class="w"> </span><span class="n">EraseBytes</span><span class="o">-</span><span class="w"></span>
<span class="n">ignoring</span><span class="w"> </span><span class="n">error</span>: <span class="nc">this</span><span class="w"> </span><span class="n">error</span><span class="w"> </span><span class="n">should</span><span class="w"> </span><span class="n">be</span><span class="w"> </span><span class="n">ignored</span><span class="w"> </span><span class="n">by</span><span class="w"> </span><span class="n">fuzzing</span>: <span class="nc">unable</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">compile</span><span class="w"> </span><span class="n">module</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="n">wasmtime</span><span class="w"></span>
<span class="n">ignoring</span><span class="w"> </span><span class="n">error</span>: <span class="nc">this</span><span class="w"> </span><span class="n">error</span><span class="w"> </span><span class="n">should</span><span class="w"> </span><span class="n">be</span><span class="w"> </span><span class="n">ignored</span><span class="w"> </span><span class="n">by</span><span class="w"> </span><span class="n">fuzzing</span>: <span class="nc">unable</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">compile</span><span class="w"> </span><span class="n">module</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="n">wasmtime</span><span class="w"></span>
<span class="n">ignoring</span><span class="w"> </span><span class="n">error</span>: <span class="nc">this</span><span class="w"> </span><span class="n">error</span><span class="w"> </span><span class="n">should</span><span class="w"> </span><span class="n">be</span><span class="w"> </span><span class="n">ignored</span><span class="w"> </span><span class="n">by</span><span class="w"> </span><span class="n">fuzzing</span>: <span class="nc">unable</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">compile</span><span class="w"> </span><span class="n">module</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="n">wasmtime</span><span class="w"></span>
<span class="n">ignoring</span><span class="w"> </span><span class="n">error</span>: <span class="nc">this</span><span class="w"> </span><span class="n">error</span><span class="w"> </span><span class="n">should</span><span class="w"> </span><span class="n">be</span><span class="w"> </span><span class="n">ignored</span><span class="w"> </span><span class="n">by</span><span class="w"> </span><span class="n">fuzzing</span>: <span class="nc">Unknown</span><span class="w"> </span><span class="n">opcode</span><span class="w"> </span><span class="mi">195</span><span class="w"></span>
<span class="n">ignoring</span><span class="w"> </span><span class="n">error</span>: <span class="nc">this</span><span class="w"> </span><span class="n">error</span><span class="w"> </span><span class="n">should</span><span class="w"> </span><span class="n">be</span><span class="w"> </span><span class="n">ignored</span><span class="w"> </span><span class="n">by</span><span class="w"> </span><span class="n">fuzzing</span>: <span class="nc">Unknown</span><span class="w"> </span><span class="n">opcode</span><span class="w"> </span><span class="mi">195</span><span class="w"></span>
<span class="n">ignoring</span><span class="w"> </span><span class="n">error</span>: <span class="nc">this</span><span class="w"> </span><span class="n">error</span><span class="w"> </span><span class="n">should</span><span class="w"> </span><span class="n">be</span><span class="w"> </span><span class="n">ignored</span><span class="w"> </span><span class="n">by</span><span class="w"> </span><span class="n">fuzzing</span>: <span class="nc">Unknown</span><span class="w"> </span><span class="n">opcode</span><span class="w"> </span><span class="mi">195</span><span class="w"></span>
<span class="n">ignoring</span><span class="w"> </span><span class="n">error</span>: <span class="nc">this</span><span class="w"> </span><span class="n">error</span><span class="w"> </span><span class="n">should</span><span class="w"> </span><span class="n">be</span><span class="w"> </span><span class="n">ignored</span><span class="w"> </span><span class="n">by</span><span class="w"> </span><span class="n">fuzzing</span>: <span class="nc">Unknown</span><span class="w"> </span><span class="n">opcode</span><span class="w"> </span><span class="mi">195</span><span class="w"></span>
<span class="n">ignoring</span><span class="w"> </span><span class="n">error</span>: <span class="nc">this</span><span class="w"> </span><span class="n">error</span><span class="w"> </span><span class="n">should</span><span class="w"> </span><span class="n">be</span><span class="w"> </span><span class="n">ignored</span><span class="w"> </span><span class="n">by</span><span class="w"> </span><span class="n">fuzzing</span>: <span class="nc">unable</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">compile</span><span class="w"> </span><span class="n">module</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="n">wasmtime</span><span class="w"></span>
<span class="n">ignoring</span><span class="w"> </span><span class="n">error</span>: <span class="nc">this</span><span class="w"> </span><span class="n">error</span><span class="w"> </span><span class="n">should</span><span class="w"> </span><span class="n">be</span><span class="w"> </span><span class="n">ignored</span><span class="w"> </span><span class="n">by</span><span class="w"> </span><span class="n">fuzzing</span>: <span class="nc">unable</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">compile</span><span class="w"> </span><span class="n">module</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="n">wasmtime</span><span class="w"></span>
<span class="n">ignoring</span><span class="w"> </span><span class="n">error</span>: <span class="nc">this</span><span class="w"> </span><span class="n">error</span><span class="w"> </span><span class="n">should</span><span class="w"> </span><span class="n">be</span><span class="w"> </span><span class="n">ignored</span><span class="w"> </span><span class="n">by</span><span class="w"> </span><span class="n">fuzzing</span>: <span class="nc">unable</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">compile</span><span class="w"> </span><span class="n">module</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="n">wasmtime</span><span class="w"></span>
<span class="n">ignoring</span><span class="w"> </span><span class="n">error</span>: <span class="nc">this</span><span class="w"> </span><span class="n">error</span><span class="w"> </span><span class="n">should</span><span class="w"> </span><span class="n">be</span><span class="w"> </span><span class="n">ignored</span><span class="w"> </span><span class="n">by</span><span class="w"> </span><span class="n">fuzzing</span>: <span class="nc">unable</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">compile</span><span class="w"> </span><span class="n">module</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="n">wasmtime</span><span class="w"></span>
<span class="n">ignoring</span><span class="w"> </span><span class="n">error</span>: <span class="nc">this</span><span class="w"> </span><span class="n">error</span><span class="w"> </span><span class="n">should</span><span class="w"> </span><span class="n">be</span><span class="w"> </span><span class="n">ignored</span><span class="w"> </span><span class="n">by</span><span class="w"> </span><span class="n">fuzzing</span>: <span class="nc">unable</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">compile</span><span class="w"> </span><span class="n">module</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="n">wasmtime</span><span class="w"></span>
<span class="n">ignoring</span><span class="w"> </span><span class="n">error</span>: <span class="nc">this</span><span class="w"> </span><span class="n">error</span><span class="w"> </span><span class="n">should</span><span class="w"> </span><span class="n">be</span><span class="w"> </span><span class="n">ignored</span><span class="w"> </span><span class="n">by</span><span class="w"> </span><span class="n">fuzzing</span>: <span class="nc">unable</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">compile</span><span class="w"> </span><span class="n">module</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="n">wasmtime</span><span class="w"></span>
<span class="n">ignoring</span><span class="w"> </span><span class="n">error</span>: <span class="nc">this</span><span class="w"> </span><span class="n">error</span><span class="w"> </span><span class="n">should</span><span class="w"> </span><span class="n">be</span><span class="w"> </span><span class="n">ignored</span><span class="w"> </span><span class="n">by</span><span class="w"> </span><span class="n">fuzzing</span>: <span class="nc">unable</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">compile</span><span class="w"> </span><span class="n">module</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="n">wasmtime</span><span class="w"></span>
#<span class="mi">2964099</span><span class="w">        </span><span class="n">REDUCE</span><span class="w"> </span><span class="n">cov</span>: <span class="mi">30985</span><span class="w"> </span><span class="n">ft</span>: <span class="mi">87395</span><span class="w"> </span><span class="n">corp</span>: <span class="mi">1762</span><span class="o">/</span><span class="mi">219</span><span class="n">Kb</span><span class="w"> </span><span class="n">lim</span>: <span class="mi">4096</span><span class="w"> </span><span class="n">exec</span><span class="o">/</span><span class="n">s</span>: <span class="mi">394</span><span class="w"> </span><span class="n">rss</span>: <span class="mi">676</span><span class="n">Mb</span><span class="w"> </span><span class="n">L</span>: <span class="mi">131</span><span class="o">/</span><span class="mi">521</span><span class="w"> </span><span class="n">MS</span>: <span class="mi">4</span><span class="w"></span>
<span class="n">PersAutoDict</span><span class="o">-</span><span class="n">ShuffleBytes</span><span class="o">-</span><span class="n">ShuffleBytes</span><span class="o">-</span><span class="n">EraseBytes</span><span class="o">-</span><span class="w"> </span><span class="n">DE</span>: <span class="s">"</span><span class="se">\x17\x00\x00\x00\x00\x00\x00\x00</span><span class="s">"</span><span class="o">-</span><span class="w"></span>
<span class="n">ignoring</span><span class="w"> </span><span class="n">error</span>: <span class="nc">this</span><span class="w"> </span><span class="n">error</span><span class="w"> </span><span class="n">should</span><span class="w"> </span><span class="n">be</span><span class="w"> </span><span class="n">ignored</span><span class="w"> </span><span class="n">by</span><span class="w"> </span><span class="n">fuzzing</span>: <span class="nc">unable</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">compile</span><span class="w"> </span><span class="n">module</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="n">wasmtime</span><span class="w"></span>
</code></pre></div>
<p>Note how ignored errors are printed but don't cause a crash: <code>wasmi</code> doesn't understand all of the opcodes (which probably means we need to make the single-inst modules smarter to report when they use float-to-int conversions, e.g.) and Wasmtime frequently crashes when the pooling allocator picks sizes that are too small.</p>
<p>When run with <code>RUST_LOG=wasmtime_fuzzing=debug cargo +nightly fuzz run differential_meta</code>, the log output shows something like:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="p">[</span><span class="mi">2022</span><span class="o">-</span><span class="mi">08</span><span class="o">-</span><span class="mi">11</span><span class="n">T20</span>:<span class="mi">36</span>:<span class="mi">44</span><span class="n">Z</span><span class="w"> </span><span class="n">DEBUG</span><span class="w"> </span><span class="n">wasmtime_fuzzing</span>::<span class="n">oracles</span><span class="p">]</span><span class="w"> </span><span class="n">wrote</span><span class="w"> </span><span class="n">wasm</span><span class="w"> </span><span class="n">file</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="err">`</span><span class="n">testcase14</span><span class="p">.</span><span class="n">wasm</span><span class="err">`</span><span class="w"></span>
<span class="p">[</span><span class="mi">2022</span><span class="o">-</span><span class="mi">08</span><span class="o">-</span><span class="mi">11</span><span class="n">T20</span>:<span class="mi">36</span>:<span class="mi">44</span><span class="n">Z</span><span class="w"> </span><span class="n">DEBUG</span><span class="w"> </span><span class="n">wasmtime_fuzzing</span>::<span class="n">oracles</span><span class="p">]</span><span class="w"> </span><span class="n">Evaluating</span>: <span class="nc">test</span><span class="p">([</span><span class="n">F32</span><span class="p">(</span><span class="mi">198</span><span class="p">)])</span><span class="w"></span>
<span class="p">[</span><span class="mi">2022</span><span class="o">-</span><span class="mi">08</span><span class="o">-</span><span class="mi">11</span><span class="n">T20</span>:<span class="mi">36</span>:<span class="mi">44</span><span class="n">Z</span><span class="w"> </span><span class="n">DEBUG</span><span class="w"> </span><span class="n">wasmtime_fuzzing</span>::<span class="n">oracles</span><span class="p">]</span><span class="w">  </span>-&gt; <span class="nc">results</span><span class="w"> </span><span class="n">on</span><span class="w"> </span><span class="n">wasmi</span>: <span class="nb">Ok</span><span class="p">([</span><span class="n">F32</span><span class="p">(</span><span class="mi">0</span><span class="p">)])</span><span class="w"></span>
<span class="p">[</span><span class="mi">2022</span><span class="o">-</span><span class="mi">08</span><span class="o">-</span><span class="mi">11</span><span class="n">T20</span>:<span class="mi">36</span>:<span class="mi">44</span><span class="n">Z</span><span class="w"> </span><span class="n">DEBUG</span><span class="w"> </span><span class="n">wasmtime_fuzzing</span>::<span class="n">oracles</span><span class="p">]</span><span class="w">  </span>-&gt; <span class="nc">results</span><span class="w"> </span><span class="n">on</span><span class="w"> </span><span class="n">wasmtime</span>: <span class="nb">Ok</span><span class="p">([</span><span class="n">F32</span><span class="p">(</span><span class="mi">0</span><span class="p">)])</span><span class="w"></span>
<span class="p">[</span><span class="mi">2022</span><span class="o">-</span><span class="mi">08</span><span class="o">-</span><span class="mi">11</span><span class="n">T20</span>:<span class="mi">36</span>:<span class="mi">44</span><span class="n">Z</span><span class="w"> </span><span class="n">DEBUG</span><span class="w"> </span><span class="n">wasmtime_fuzzing</span>::<span class="n">oracles</span><span class="p">]</span><span class="w"> </span><span class="n">Hashing</span><span class="w"> </span><span class="n">instances</span>:
<span class="p">[</span><span class="mi">2022</span><span class="o">-</span><span class="mi">08</span><span class="o">-</span><span class="mi">11</span><span class="n">T20</span>:<span class="mi">36</span>:<span class="mi">44</span><span class="n">Z</span><span class="w"> </span><span class="n">DEBUG</span><span class="w"> </span><span class="n">wasmtime_fuzzing</span>::<span class="n">oracles</span><span class="p">]</span><span class="w">  </span>-&gt; <span class="nc">hash</span><span class="w"> </span><span class="n">of</span><span class="w"> </span><span class="n">wasmi</span>: <span class="mi">15130871412783076140</span><span class="w"></span>
<span class="p">[</span><span class="mi">2022</span><span class="o">-</span><span class="mi">08</span><span class="o">-</span><span class="mi">11</span><span class="n">T20</span>:<span class="mi">36</span>:<span class="mi">44</span><span class="n">Z</span><span class="w"> </span><span class="n">DEBUG</span><span class="w"> </span><span class="n">wasmtime_fuzzing</span>::<span class="n">oracles</span><span class="p">]</span><span class="w">  </span>-&gt; <span class="nc">hash</span><span class="w"> </span><span class="n">of</span><span class="w"> </span><span class="n">wasmtime</span>: <span class="mi">15130871412783076140</span><span class="w"></span>
</code></pre></div>
<p>I expect that once the following big items are finished we could remove all other differential targets and just use this one. For now, though, I would like to get this work merged so I can stop rebasing. This is work that I think could go in different PRs (but I am certainly open for discussion on that):</p>
<ul>
<li>[ ] adapt V8 to the <code>DiffEngine</code>/<code>DiffInstance</code> interface (@alexcrichton volunteered to look into this; the lifetime issues made this a bridge too far for this PR)</li>
<li>[x] start fuzzing with the <code>wasm-smith</code>-generated modules (<code>BigModule</code>) instead of just single-instruction modules; this is complicated by the fact that <code>wasm-smith</code> will eat up all remaining unstructured data, leaving none for choosing engines and function arguments</li>
<li>[x] figure out whether to fully commit to <code>ModuleFeatures</code> and report what Wasm feature a single-instruction uses (see comments above about this)</li>
<li>[x] refactor how we ignore errors: I currently do this by wrapping the error message in <code>DiffIgnoreError</code> and downcasting the <code>anyhow</code> error to see if it is one of these; @alexcrichton mentioned that he preferred <code>Result&lt;Option&lt;...&gt;&gt;</code> to indicate the various states but this would involve some refactoring</li>
<li>[ ] add more instructions to the single-instruction module generator; e.g., my next feature to add would be SIMD instructions, which would likely find some bugs and require some additional infrastructure (e.g., V128 relaxed NaN comparison)</li>
</ul>
<p>cc: @jameysharp, @alexcrichton, @fitzgen </p>
</blockquote>



<a name="294179526"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%234515%20%5Bfuzz%5D%20Add%20a%20meta-differential%20fuz.../near/294179526" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.234515.20.5Bfuzz.5D.20Add.20a.20meta-differential.20fuz.2E.2E.2E.html#294179526">(Aug 18 2022 at 22:26)</a>:</h4>
<p>abrown <a href="https://github.com/bytecodealliance/wasmtime/pull/4515#issuecomment-1220036868">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/4515">issue #4515</a>:</p>
<blockquote>
<p>Ok, I've rebased this PR and included some work @alexcrichton and I did today to adapt the fuzz target to his comments above (thanks @alexcrichton!). There are still some TODOs, noted in the commit message, but this now runs without error for a decent amount of time:</p>
<p><div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="cp">$</span><span class="w"> </span><span class="n">cargo</span><span class="w"> </span><span class="o">+</span><span class="n">nightly</span><span class="w"> </span><span class="n">fuzz</span><span class="w"> </span><span class="n">run</span><span class="w"> </span><span class="n">differential_meta</span><span class="w"> </span><span class="o">-</span><span class="n">s</span><span class="w"> </span><span class="n">none</span><span class="w"></span>
<span class="o">..</span><span class="p">.</span><span class="w"></span>
<span class="o">===</span><span class="w"> </span><span class="n">Execution</span><span class="w"> </span><span class="n">rate</span><span class="w"> </span><span class="p">(</span><span class="mi">464537</span><span class="w"> </span><span class="n">successes</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="mi">880000</span><span class="w"> </span><span class="n">attempted</span><span class="w"> </span><span class="n">modules</span><span class="p">)</span>: <span class="mf">52.788295454545455</span><span class="o">%</span><span class="w"> </span><span class="p">(</span><span class="n">total</span><span class="w"> </span><span class="n">invocations</span>: <span class="mi">3525516</span><span class="p">)</span><span class="w"> </span><span class="o">===</span><span class="w"></span>
#<span class="mi">880057</span><span class="w"> </span><span class="n">REDUCE</span><span class="w"> </span><span class="n">cov</span>: <span class="mi">28361</span><span class="w"> </span><span class="n">ft</span>: <span class="mi">150473</span><span class="w"> </span><span class="n">corp</span>: <span class="mi">9884</span><span class="o">/</span><span class="mi">4009</span><span class="n">Kb</span><span class="w"> </span><span class="n">lim</span>: <span class="mi">627</span><span class="w"> </span><span class="n">exec</span><span class="o">/</span><span class="n">s</span>: <span class="mi">531</span><span class="w"> </span><span class="n">rss</span>: <span class="mi">174</span><span class="n">Mb</span><span class="w"> </span><span class="n">L</span>: <span class="mi">546</span><span class="o">/</span><span class="mi">626</span><span class="w"> </span><span class="n">MS</span>: <span class="mi">1</span><span class="w"> </span><span class="n">EraseBytes</span><span class="o">-</span><span class="w"></span>
#<span class="mi">880293</span><span class="w"> </span><span class="n">REDUCE</span><span class="w"> </span><span class="n">cov</span>: <span class="mi">28361</span><span class="w"> </span><span class="n">ft</span>: <span class="mi">150473</span><span class="w"> </span><span class="n">corp</span>: <span class="mi">9884</span><span class="o">/</span><span class="mi">4009</span><span class="n">Kb</span><span class="w"> </span><span class="n">lim</span>: <span class="mi">627</span><span class="w"> </span><span class="n">exec</span><span class="o">/</span><span class="n">s</span>: <span class="mi">530</span><span class="w"> </span><span class="n">rss</span>: <span class="mi">174</span><span class="n">Mb</span><span class="w"> </span><span class="n">L</span>: <span class="mi">332</span><span class="o">/</span><span class="mi">626</span><span class="w"> </span><span class="n">MS</span>: <span class="mi">1</span><span class="w"> </span><span class="n">EraseBytes</span><span class="o">-</span><span class="w"></span>
#<span class="mi">880511</span><span class="w"> </span><span class="n">NEW</span><span class="w">    </span><span class="n">cov</span>: <span class="mi">28361</span><span class="w"> </span><span class="n">ft</span>: <span class="mi">150475</span><span class="w"> </span><span class="n">corp</span>: <span class="mi">9885</span><span class="o">/</span><span class="mi">4010</span><span class="n">Kb</span><span class="w"> </span><span class="n">lim</span>: <span class="mi">627</span><span class="w"> </span><span class="n">exec</span><span class="o">/</span><span class="n">s</span>: <span class="mi">531</span><span class="w"> </span><span class="n">rss</span>: <span class="mi">174</span><span class="n">Mb</span><span class="w"> </span><span class="n">L</span>: <span class="mi">622</span><span class="o">/</span><span class="mi">626</span><span class="w"> </span><span class="n">MS</span>: <span class="mi">3</span><span class="w"> </span><span class="n">CMP</span><span class="o">-</span><span class="n">CrossOver</span><span class="o">-</span><span class="n">ChangeByte</span><span class="o">-</span><span class="w"> </span><span class="n">DE</span>: <span class="s">"</span><span class="se">\x08</span><span class="s">\xa2"</span><span class="o">-</span><span class="w"></span>
</code></pre></div><br>
</p>
</blockquote>



<a name="294188883"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%234515%20%5Bfuzz%5D%20Add%20a%20meta-differential%20fuz.../near/294188883" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.234515.20.5Bfuzz.5D.20Add.20a.20meta-differential.20fuz.2E.2E.2E.html#294188883">(Aug 19 2022 at 00:22)</a>:</h4>
<p>alexcrichton <a href="https://github.com/bytecodealliance/wasmtime/pull/4515#issuecomment-1220103975">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/4515">issue #4515</a>:</p>
<blockquote>
<p>Thanks again for being patient with me here @abrown! I'm happy with where this has ended up and while I think there's more to do I think it's safe to do that all as a follow-up. I'm gonna merge this and see if we can get this into the next oss-fuzz build to get our first (potentially empty?) crop of fuzz bugs.</p>
</blockquote>



<a name="294193860"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%234515%20%5Bfuzz%5D%20Add%20a%20meta-differential%20fuz.../near/294193860" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.234515.20.5Bfuzz.5D.20Add.20a.20meta-differential.20fuz.2E.2E.2E.html#294193860">(Aug 19 2022 at 01:59)</a>:</h4>
<p>abrown <a href="https://github.com/bytecodealliance/wasmtime/pull/4515#issuecomment-1220154676">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/4515">issue #4515</a>:</p>
<blockquote>
<p>@alexcrichton, thanks for all the help reviewing this and reworking some of the bits!</p>
</blockquote>



<hr><p>Last updated: Jan 20 2025 at 06:04 UTC</p>
</html>