<html>
<head><meta charset="utf-8"><title>wasmtime / PR #1697 Fix missing modification of jump tabl... · git-wasmtime · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/index.html">git-wasmtime</a></h2>
<h3>Topic: <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231697.20Fix.20missing.20modification.20of.20jump.20tabl.2E.2E.2E.html">wasmtime / PR #1697 Fix missing modification of jump tabl...</a></h3>

<hr>

<base href="https://bytecodealliance.zulipchat.com">

<head><link href="https://bytecodealliance.github.io/zulip-archive/style.css" rel="stylesheet"></head>

<a name="197559778"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231697%20Fix%20missing%20modification%20of%20jump%20tabl.../near/197559778" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231697.20Fix.20missing.20modification.20of.20jump.20tabl.2E.2E.2E.html#197559778">(May 14 2020 at 14:09)</a>:</h4>
<p>Y-Nak opened <a href="https://github.com/bytecodealliance/wasmtime/pull/1697">PR #1697</a> from <code>fix-licm-jt-bug</code> to <code>master</code>:</p>
<blockquote>
<p>Resolve #1648 and resolve #1080.</p>
<ul>
<li>[x] This has been discussed in issue #1648 and #1080</li>
<li>[x] A short description of what this does, why it is needed;</li>
</ul>
<ol>
<li>Fix inconsistency between <code>branch_destination</code> and <code>branch_destination_mut</code> (Just adding <code>IndirectJump</code> case to <code>branch_destination_mut</code>).</li>
<li>Modify jump table entry if it points at loop header, and also modify destination if it points at loop header.</li>
</ol>
<ul>
<li>
<p>[x] This PR contains test cases, if meaningful.</p>
</li>
<li>
<p>[x] A reviewer from the core maintainer team has been assigned for this PR.<br>
@iximeow Could you review this please?  I know you are aware of the issue, so please feel free to close this PR if you have started looking into.</p>
</li>
</ul>
</blockquote>



<a name="197565796"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231697%20Fix%20missing%20modification%20of%20jump%20tabl.../near/197565796" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231697.20Fix.20missing.20modification.20of.20jump.20tabl.2E.2E.2E.html#197565796">(May 14 2020 at 14:48)</a>:</h4>
<p>Y-Nak submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/1697#pullrequestreview-411882193">PR Review</a>.</p>



<a name="197565797"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231697%20Fix%20missing%20modification%20of%20jump%20tabl.../near/197565797" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231697.20Fix.20missing.20modification.20of.20jump.20tabl.2E.2E.2E.html#197565797">(May 14 2020 at 14:48)</a>:</h4>
<p>Y-Nak created <a href="https://github.com/bytecodealliance/wasmtime/pull/1697#discussion_r425196156">PR Review Comment</a>:</p>
<blockquote>
<p>Oh, thanks!</p>
</blockquote>



<a name="197565831"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231697%20Fix%20missing%20modification%20of%20jump%20tabl.../near/197565831" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231697.20Fix.20missing.20modification.20of.20jump.20tabl.2E.2E.2E.html#197565831">(May 14 2020 at 14:48)</a>:</h4>
<p>Y-Nak updated <a href="https://github.com/bytecodealliance/wasmtime/pull/1697">PR #1697</a> from <code>fix-licm-jt-bug</code> to <code>master</code>:</p>
<blockquote>
<p>Resolve #1648 and resolve #1080.</p>
<ul>
<li>[x] This has been discussed in issue #1648 and #1080</li>
<li>[x] A short description of what this does, why it is needed;</li>
</ul>
<ol>
<li>Fix inconsistency between <code>branch_destination</code> and <code>branch_destination_mut</code> (Just adding <code>IndirectJump</code> case to <code>branch_destination_mut</code>).</li>
<li>Modify jump table entry if it points at loop header, and also modify destination if it points at loop header.</li>
</ol>
<ul>
<li>
<p>[x] This PR contains test cases, if meaningful.</p>
</li>
<li>
<p>[x] A reviewer from the core maintainer team has been assigned for this PR.<br>
@iximeow Could you review this please?  I know you are aware of the issue, so please feel free to close this PR if you have started looking into.</p>
</li>
</ul>
</blockquote>



<a name="202009320"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231697%20Fix%20missing%20modification%20of%20jump%20tabl.../near/202009320" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231697.20Fix.20missing.20modification.20of.20jump.20tabl.2E.2E.2E.html#202009320">(Jun 25 2020 at 18:49)</a>:</h4>
<p>alexcrichton edited <a href="https://github.com/bytecodealliance/wasmtime/pull/1697">PR #1697</a> from <code>fix-licm-jt-bug</code> to <code>main</code>:</p>
<blockquote>
<p>Resolve #1648 and resolve #1080.</p>
<ul>
<li>[x] This has been discussed in issue #1648 and #1080</li>
<li>[x] A short description of what this does, why it is needed;</li>
</ul>
<ol>
<li>Fix inconsistency between <code>branch_destination</code> and <code>branch_destination_mut</code> (Just adding <code>IndirectJump</code> case to <code>branch_destination_mut</code>).</li>
<li>Modify jump table entry if it points at loop header, and also modify destination if it points at loop header.</li>
</ol>
<ul>
<li>
<p>[x] This PR contains test cases, if meaningful.</p>
</li>
<li>
<p>[x] A reviewer from the core maintainer team has been assigned for this PR.<br>
@iximeow Could you review this please?  I know you are aware of the issue, so please feel free to close this PR if you have started looking into.</p>
</li>
</ul>
</blockquote>



<a name="219109316"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231697%20Fix%20missing%20modification%20of%20jump%20tabl.../near/219109316" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231697.20Fix.20missing.20modification.20of.20jump.20tabl.2E.2E.2E.html#219109316">(Dec 07 2020 at 17:20)</a>:</h4>
<p>cfallin submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/1697#pullrequestreview-546360785">PR Review</a>.</p>



<a name="219109318"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231697%20Fix%20missing%20modification%20of%20jump%20tabl.../near/219109318" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231697.20Fix.20missing.20modification.20of.20jump.20tabl.2E.2E.2E.html#219109318">(Dec 07 2020 at 17:20)</a>:</h4>
<p>cfallin submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/1697#pullrequestreview-546360785">PR Review</a>.</p>



<a name="219109319"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231697%20Fix%20missing%20modification%20of%20jump%20tabl.../near/219109319" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231697.20Fix.20missing.20modification.20of.20jump.20tabl.2E.2E.2E.html#219109319">(Dec 07 2020 at 17:20)</a>:</h4>
<p>cfallin created <a href="https://github.com/bytecodealliance/wasmtime/pull/1697#discussion_r537683519">PR Review Comment</a>:</p>
<blockquote>
<p>It seems we could fold this into a helper alongside <code>change_branch_destination</code> on <code>Function</code>, by defining a <code>rewrite_branch_destination(inst, old_target, new_target)</code> that replaces any <code>old_target</code> target in the instruction with <code>new_target</code>, doing the replacement on any target(s) that exist in the instruction. Thoughts? This would also remove the awkward match below.</p>
</blockquote>



<a name="219109320"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231697%20Fix%20missing%20modification%20of%20jump%20tabl.../near/219109320" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231697.20Fix.20missing.20modification.20of.20jump.20tabl.2E.2E.2E.html#219109320">(Dec 07 2020 at 17:20)</a>:</h4>
<p>cfallin created <a href="https://github.com/bytecodealliance/wasmtime/pull/1697#discussion_r537679903">PR Review Comment</a>:</p>
<blockquote>
<p>Can we remove the encodings here? They'll cause issues when we switch to the new backend by default and I don't think they're needed for the test.</p>
</blockquote>



<a name="219178121"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231697%20Fix%20missing%20modification%20of%20jump%20tabl.../near/219178121" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231697.20Fix.20missing.20modification.20of.20jump.20tabl.2E.2E.2E.html#219178121">(Dec 08 2020 at 07:26)</a>:</h4>
<p>Y-Nak submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/1697#pullrequestreview-546809956">PR Review</a>.</p>



<a name="219178122"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231697%20Fix%20missing%20modification%20of%20jump%20tabl.../near/219178122" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231697.20Fix.20missing.20modification.20of.20jump.20tabl.2E.2E.2E.html#219178122">(Dec 08 2020 at 07:26)</a>:</h4>
<p>Y-Nak created <a href="https://github.com/bytecodealliance/wasmtime/pull/1697#discussion_r538095221">PR Review Comment</a>:</p>
<blockquote>
<p>We can remove the encodings iff the test runs with the new backend, otherwise <code>Verifier::verify_encodings</code> fails because  some <code>jump</code> insts with encodings is inserted here.<br>
<a href="https://github.com/bytecodealliance/wasmtime/blob/2cec20aa57037ecdfaef46176f31fe8f6b33c2d8/cranelift/codegen/src/licm.rs#L94-L98">https://github.com/bytecodealliance/wasmtime/blob/2cec20aa57037ecdfaef46176f31fe8f6b33c2d8/cranelift/codegen/src/licm.rs#L94-L98</a><br>
So, I'm inclined to remove all encodings from the test and change the target machine to <code>aarch64</code> from <code>x86-64</code>,  what do you think about it?</p>
</blockquote>



<a name="219178125"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231697%20Fix%20missing%20modification%20of%20jump%20tabl.../near/219178125" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231697.20Fix.20missing.20modification.20of.20jump.20tabl.2E.2E.2E.html#219178125">(Dec 08 2020 at 07:26)</a>:</h4>
<p>Y-Nak submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/1697#pullrequestreview-546810092">PR Review</a>.</p>



<a name="219178126"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231697%20Fix%20missing%20modification%20of%20jump%20tabl.../near/219178126" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231697.20Fix.20missing.20modification.20of.20jump.20tabl.2E.2E.2E.html#219178126">(Dec 08 2020 at 07:26)</a>:</h4>
<p>Y-Nak created <a href="https://github.com/bytecodealliance/wasmtime/pull/1697#discussion_r538095352">PR Review Comment</a>:</p>
<blockquote>
<p>Exactly! Thanks for pointing out.<br>
I'll add <code>Function::rewrite_branch_destination</code>.</p>
</blockquote>



<a name="219182831"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231697%20Fix%20missing%20modification%20of%20jump%20tabl.../near/219182831" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231697.20Fix.20missing.20modification.20of.20jump.20tabl.2E.2E.2E.html#219182831">(Dec 08 2020 at 08:40)</a>:</h4>
<p>cfallin submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/1697#pullrequestreview-546862338">PR Review</a>.</p>



<a name="219182832"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231697%20Fix%20missing%20modification%20of%20jump%20tabl.../near/219182832" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231697.20Fix.20missing.20modification.20of.20jump.20tabl.2E.2E.2E.html#219182832">(Dec 08 2020 at 08:40)</a>:</h4>
<p>cfallin created <a href="https://github.com/bytecodealliance/wasmtime/pull/1697#discussion_r538141715">PR Review Comment</a>:</p>
<blockquote>
<p>Yes, that sounds good, thanks!</p>
</blockquote>



<a name="219290946"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231697%20Fix%20missing%20modification%20of%20jump%20tabl.../near/219290946" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231697.20Fix.20missing.20modification.20of.20jump.20tabl.2E.2E.2E.html#219290946">(Dec 09 2020 at 02:24)</a>:</h4>
<p>Y-Nak updated <a href="https://github.com/bytecodealliance/wasmtime/pull/1697">PR #1697</a> from <code>fix-licm-jt-bug</code> to <code>main</code>:</p>
<blockquote>
<p>Resolve #1648 and resolve #1080.</p>
<ul>
<li>[x] This has been discussed in issue #1648 and #1080</li>
<li>[x] A short description of what this does, why it is needed;</li>
</ul>
<ol>
<li>Fix inconsistency between <code>branch_destination</code> and <code>branch_destination_mut</code> (Just adding <code>IndirectJump</code> case to <code>branch_destination_mut</code>).</li>
<li>Modify jump table entry if it points at loop header, and also modify destination if it points at loop header.</li>
</ol>
<ul>
<li>
<p>[x] This PR contains test cases, if meaningful.</p>
</li>
<li>
<p>[x] A reviewer from the core maintainer team has been assigned for this PR.<br>
@iximeow Could you review this please?  I know you are aware of the issue, so please feel free to close this PR if you have started looking into.</p>
</li>
</ul>
</blockquote>



<a name="219296455"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231697%20Fix%20missing%20modification%20of%20jump%20tabl.../near/219296455" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231697.20Fix.20missing.20modification.20of.20jump.20tabl.2E.2E.2E.html#219296455">(Dec 09 2020 at 04:18)</a>:</h4>
<p>cfallin submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/1697#pullrequestreview-547823758">PR Review</a>.</p>



<a name="219296461"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231697%20Fix%20missing%20modification%20of%20jump%20tabl.../near/219296461" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231697.20Fix.20missing.20modification.20of.20jump.20tabl.2E.2E.2E.html#219296461">(Dec 09 2020 at 04:19)</a>:</h4>
<p>cfallin merged <a href="https://github.com/bytecodealliance/wasmtime/pull/1697">PR #1697</a>.</p>



<hr><p>Last updated: Jan 20 2025 at 06:04 UTC</p>
</html>