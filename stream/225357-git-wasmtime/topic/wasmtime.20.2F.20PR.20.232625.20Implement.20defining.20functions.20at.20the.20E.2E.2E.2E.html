<html>
<head><meta charset="utf-8"><title>wasmtime / PR #2625 Implement defining functions at the E... · git-wasmtime · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/index.html">git-wasmtime</a></h2>
<h3>Topic: <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232625.20Implement.20defining.20functions.20at.20the.20E.2E.2E.2E.html">wasmtime / PR #2625 Implement defining functions at the E...</a></h3>

<hr>

<base href="https://bytecodealliance.zulipchat.com">

<head><link href="https://bytecodealliance.github.io/zulip-archive/style.css" rel="stylesheet"></head>

<a name="224559718"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232625%20Implement%20defining%20functions%20at%20the%20E.../near/224559718" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232625.20Implement.20defining.20functions.20at.20the.20E.2E.2E.2E.html#224559718">(Jan 30 2021 at 02:09)</a>:</h4>
<p>peterhuene opened <a href="https://github.com/bytecodealliance/wasmtime/pull/2625">PR #2625</a> from <code>engine-funcs</code> to <code>main</code>:</p>
<blockquote>
<p>This PR introduces defining host functions at the <code>Engine</code> rather than with<br>
<code>Func</code> tied to a <code>Store</code>.</p>
<p>The intention here is to enable a host to define all of the functions once at<br>
with an <code>Engine</code> and then use a <code>Linker</code> (or directly with<br>
<code>Store::get_engine_func</code>) to use the functions when instantiating a module.</p>
<p>This should help improve the performance of use cases where a <code>Store</code> is<br>
short-lived and redefining the functions at every module instantiation a<br>
noticeable performance hit.</p>
<p>See <a href="https://github.com/bytecodealliance/rfcs/issues/9">bytecodealliance/rfcs#9</a> regarding these changes.</p>
</blockquote>



<a name="224753210"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232625%20Implement%20defining%20functions%20at%20the%20E.../near/224753210" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232625.20Implement.20defining.20functions.20at.20the.20E.2E.2E.2E.html#224753210">(Feb 01 2021 at 16:37)</a>:</h4>
<p>alexcrichton submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/2625#pullrequestreview-580477354">PR Review</a>.</p>



<a name="224753211"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232625%20Implement%20defining%20functions%20at%20the%20E.../near/224753211" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232625.20Implement.20defining.20functions.20at.20the.20E.2E.2E.2E.html#224753211">(Feb 01 2021 at 16:37)</a>:</h4>
<p>alexcrichton submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/2625#pullrequestreview-580477354">PR Review</a>.</p>



<a name="224753212"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232625%20Implement%20defining%20functions%20at%20the%20E.../near/224753212" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232625.20Implement.20defining.20functions.20at.20the.20E.2E.2E.2E.html#224753212">(Feb 01 2021 at 16:37)</a>:</h4>
<p>alexcrichton created <a href="https://github.com/bytecodealliance/wasmtime/pull/2625#discussion_r567918513">PR Review Comment</a>:</p>
<blockquote>
<p>FWIW this sort of interning I was hoping would make <code>Store</code> faster since <code>Store</code> was short-lived, but since <code>Engine</code> is long-lived it's probably not necessary to do this and we can probably just get away with the simpler-to-read <code>String</code> everywhere perhaps?</p>
</blockquote>



<a name="224753215"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232625%20Implement%20defining%20functions%20at%20the%20E.../near/224753215" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232625.20Implement.20defining.20functions.20at.20the.20E.2E.2E.2E.html#224753215">(Feb 01 2021 at 16:37)</a>:</h4>
<p>alexcrichton created <a href="https://github.com/bytecodealliance/wasmtime/pull/2625#discussion_r567924220">PR Review Comment</a>:</p>
<blockquote>
<p>Similar to above, could this document the <code>Send</code> and <code>Sync</code> bounds?</p>
</blockquote>



<a name="224753216"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232625%20Implement%20defining%20functions%20at%20the%20E.../near/224753216" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232625.20Implement.20defining.20functions.20at.20the.20E.2E.2E.2E.html#224753216">(Feb 01 2021 at 16:37)</a>:</h4>
<p>alexcrichton created <a href="https://github.com/bytecodealliance/wasmtime/pull/2625#discussion_r567922189">PR Review Comment</a>:</p>
<blockquote>
<p>Do you think there's any need for this to be dynamic for the lifetime of the <code>Engine</code> itself? I would naively expect that any typical usage of this would be "let's create everything at the beginning and then that's it". If that's the case I think it's a bummer to put this behind an rwlock.</p>
<p>If you agree, perhaps we could move the building portion to <code>Config</code> which is basically an <code>EngineBuilder</code> at this point anyway. That way we wouldn't need to have the synchronization around this. Similarly we could literally have an <code>EngineBuilder</code> if needed to which is constructed with a <code>Config</code> and is then consumed to produce an <code>Engine</code>.</p>
<p>In any case this is mostly a stylistic thing, I just think it'd be nice to avoid the usage of locks if we can.</p>
</blockquote>



<a name="224753217"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232625%20Implement%20defining%20functions%20at%20the%20E.../near/224753217" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232625.20Implement.20defining.20functions.20at.20the.20E.2E.2E.2E.html#224753217">(Feb 01 2021 at 16:37)</a>:</h4>
<p>alexcrichton created <a href="https://github.com/bytecodealliance/wasmtime/pull/2625#discussion_r567927929">PR Review Comment</a>:</p>
<blockquote>
<p>Ideally this <code>Store::upgrade</code> would only happen once here, although it would make the <code>resume_panic</code> case slightly trickier where it has to be sure to drop <code>store</code>. Since we're already manually dropping things here, though, that may be ok?</p>
</blockquote>



<a name="224753218"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232625%20Implement%20defining%20functions%20at%20the%20E.../near/224753218" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232625.20Implement.20defining.20functions.20at.20the.20E.2E.2E.2E.html#224753218">(Feb 01 2021 at 16:37)</a>:</h4>
<p>alexcrichton created <a href="https://github.com/bytecodealliance/wasmtime/pull/2625#discussion_r567919921">PR Review Comment</a>:</p>
<blockquote>
<p>I think this can be a bit unsafe since <code>EngineFunc</code> doesn't embed a reference to its <code>Engine</code>, so this cloned object isn't guaranteed to not outlive an <code>Engine</code>. That being said I suspect the usage is all correct, but this comment may need to be updated.</p>
</blockquote>



<a name="224753219"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232625%20Implement%20defining%20functions%20at%20the%20E.../near/224753219" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232625.20Implement.20defining.20functions.20at.20the.20E.2E.2E.2E.html#224753219">(Feb 01 2021 at 16:37)</a>:</h4>
<p>alexcrichton created <a href="https://github.com/bytecodealliance/wasmtime/pull/2625#discussion_r567928994">PR Review Comment</a>:</p>
<blockquote>
<p>Due to the trickineses involved here, especially around not having local variables that need to be dropped, could this shim be shared with <code>into_func</code> above?</p>
</blockquote>



<a name="224753220"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232625%20Implement%20defining%20functions%20at%20the%20E.../near/224753220" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232625.20Implement.20defining.20functions.20at.20the.20E.2E.2E.2E.html#224753220">(Feb 01 2021 at 16:37)</a>:</h4>
<p>alexcrichton created <a href="https://github.com/bytecodealliance/wasmtime/pull/2625#discussion_r567923398">PR Review Comment</a>:</p>
<blockquote>
<p>Could the docs here also be sure to point out the <code>Send</code> and <code>Sync</code> bounds and how more relaxed bounds are available on <code>Func</code>?</p>
</blockquote>



<a name="224753221"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232625%20Implement%20defining%20functions%20at%20the%20E.../near/224753221" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232625.20Implement.20defining.20functions.20at.20the.20E.2E.2E.2E.html#224753221">(Feb 01 2021 at 16:37)</a>:</h4>
<p>alexcrichton created <a href="https://github.com/bytecodealliance/wasmtime/pull/2625#discussion_r567936114">PR Review Comment</a>:</p>
<blockquote>
<p>One thing I'm worried about is reading this value later on since it could get signatures mismatched. Could this perhaps store <code>u32::max_value()</code> as a signature index (or w/e the max value is) so if it's accidentally used we weed out that bug sooner rather than later?</p>
</blockquote>



<a name="224753222"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232625%20Implement%20defining%20functions%20at%20the%20E.../near/224753222" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232625.20Implement.20defining.20functions.20at.20the.20E.2E.2E.2E.html#224753222">(Feb 01 2021 at 16:37)</a>:</h4>
<p>alexcrichton created <a href="https://github.com/bytecodealliance/wasmtime/pull/2625#discussion_r567935538">PR Review Comment</a>:</p>
<blockquote>
<p>Could this have <code>+Send+Sync</code> as well? If it can't cast down could a transmute be used to erase the type bounds?</p>
</blockquote>



<a name="224753223"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232625%20Implement%20defining%20functions%20at%20the%20E.../near/224753223" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232625.20Implement.20defining.20functions.20at.20the.20E.2E.2E.2E.html#224753223">(Feb 01 2021 at 16:37)</a>:</h4>
<p>alexcrichton created <a href="https://github.com/bytecodealliance/wasmtime/pull/2625#discussion_r567938966">PR Review Comment</a>:</p>
<blockquote>
<p>To avoid the <code>pub(crate)</code> here could this perhaps be defined in the <code>func.rs</code> module?</p>
</blockquote>



<a name="224753224"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232625%20Implement%20defining%20functions%20at%20the%20E.../near/224753224" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232625.20Implement.20defining.20functions.20at.20the.20E.2E.2E.2E.html#224753224">(Feb 01 2021 at 16:37)</a>:</h4>
<p>alexcrichton created <a href="https://github.com/bytecodealliance/wasmtime/pull/2625#discussion_r567946789">PR Review Comment</a>:</p>
<blockquote>
<p>This is one of the things I'm most worried about with this PR. I don't think there's any issue with this currently, only that one could be lurking by accident in the future.</p>
<p>My concern here is that the not-threadsafe <code>InstanceHandle</code> is being shared across threads. This is ok because we happen to not touch any of the non-threadsafe state, but all of <code>InstanceHandle</code> and consumers are currently written without thread-safety in mind. Do you think there's anything we can do to future-proof this? For example I mentioned one elsewhere in this PR where we store an invalid index so if it's ever used we hopefully abort quickly. I think ideally we'd have checks in <code>wasmtime_runtime::Instance</code> as well, but I'm not sure if they would be too onerous for other usages.</p>
<p>Basically my main worry here is that this function is introducing threading in a non-compiler-checked fashion. All authors of <code>runtime/src/instance.rs</code> need to be aware of this but that's difficult to enforce because this happens in such an isolated location.</p>
</blockquote>



<a name="224753225"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232625%20Implement%20defining%20functions%20at%20the%20E.../near/224753225" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232625.20Implement.20defining.20functions.20at.20the.20E.2E.2E.2E.html#224753225">(Feb 01 2021 at 16:37)</a>:</h4>
<p>alexcrichton created <a href="https://github.com/bytecodealliance/wasmtime/pull/2625#discussion_r567939214">PR Review Comment</a>:</p>
<blockquote>
<p>I think these may not need to be <code>pub</code>?</p>
</blockquote>



<a name="224753226"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232625%20Implement%20defining%20functions%20at%20the%20E.../near/224753226" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232625.20Implement.20defining.20functions.20at.20the.20E.2E.2E.2E.html#224753226">(Feb 01 2021 at 16:37)</a>:</h4>
<p>alexcrichton created <a href="https://github.com/bytecodealliance/wasmtime/pull/2625#discussion_r567937123">PR Review Comment</a>:</p>
<blockquote>
<p>Like above could this have <code>+Send+Sync</code>?</p>
</blockquote>



<a name="224753227"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232625%20Implement%20defining%20functions%20at%20the%20E.../near/224753227" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232625.20Implement.20defining.20functions.20at.20the.20E.2E.2E.2E.html#224753227">(Feb 01 2021 at 16:37)</a>:</h4>
<p>alexcrichton created <a href="https://github.com/bytecodealliance/wasmtime/pull/2625#discussion_r567951452">PR Review Comment</a>:</p>
<blockquote>
<p>Since <code>define_func</code> above returns a <code>Result&lt;()&gt;</code> should this as well?</p>
</blockquote>



<a name="224764709"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232625%20Implement%20defining%20functions%20at%20the%20E.../near/224764709" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232625.20Implement.20defining.20functions.20at.20the.20E.2E.2E.2E.html#224764709">(Feb 01 2021 at 17:51)</a>:</h4>
<p>fitzgen submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/2625#pullrequestreview-580614000">PR Review</a>.</p>



<a name="224764710"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232625%20Implement%20defining%20functions%20at%20the%20E.../near/224764710" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232625.20Implement.20defining.20functions.20at.20the.20E.2E.2E.2E.html#224764710">(Feb 01 2021 at 17:51)</a>:</h4>
<p>fitzgen created <a href="https://github.com/bytecodealliance/wasmtime/pull/2625#discussion_r568022043">PR Review Comment</a>:</p>
<blockquote>
<p>I don't know, deduplicating strings is kinda nice (module string will be repeated a bunch, for example)</p>
</blockquote>



<a name="224767622"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232625%20Implement%20defining%20functions%20at%20the%20E.../near/224767622" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232625.20Implement.20defining.20functions.20at.20the.20E.2E.2E.2E.html#224767622">(Feb 01 2021 at 18:12)</a>:</h4>
<p>fitzgen submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/2625#pullrequestreview-580631156">PR Review</a>.</p>



<a name="224767623"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232625%20Implement%20defining%20functions%20at%20the%20E.../near/224767623" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232625.20Implement.20defining.20functions.20at.20the.20E.2E.2E.2E.html#224767623">(Feb 01 2021 at 18:12)</a>:</h4>
<p>fitzgen created <a href="https://github.com/bytecodealliance/wasmtime/pull/2625#discussion_r568035070">PR Review Comment</a>:</p>
<blockquote>
<blockquote>
<p>My concern here is that the not-threadsafe <code>InstanceHandle</code> is being shared across threads. This is ok because we happen to not touch any of the non-threadsafe state, but all of <code>InstanceHandle</code> and consumers are currently written without thread-safety in mind. Do you think there's anything we can do to future-proof this?</p>
</blockquote>
<p>Would it be feasible to split out a struct of <code>Sync</code> members from <code>InstanceHandle</code> that we can share, without sharing the whole thing across threads?</p>
<p>e.g.</p>
<p><div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="k">struct</span> <span class="nc">InstanceHandleSync</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="c1">// sync members in here...</span>
<span class="p">}</span><span class="w"></span>

<span class="k">struct</span> <span class="nc">InstanceHandle</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">sync</span>: <span class="nc">InstanceHandleSync</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="c1">// non-sync members here...</span>
<span class="p">}</span><span class="w"></span>
</code></pre></div><br>
</p>
</blockquote>



<a name="224772951"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232625%20Implement%20defining%20functions%20at%20the%20E.../near/224772951" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232625.20Implement.20defining.20functions.20at.20the.20E.2E.2E.2E.html#224772951">(Feb 01 2021 at 18:51)</a>:</h4>
<p>peterhuene submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/2625#pullrequestreview-580663308">PR Review</a>.</p>



<a name="224772952"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232625%20Implement%20defining%20functions%20at%20the%20E.../near/224772952" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232625.20Implement.20defining.20functions.20at.20the.20E.2E.2E.2E.html#224772952">(Feb 01 2021 at 18:51)</a>:</h4>
<p>peterhuene created <a href="https://github.com/bytecodealliance/wasmtime/pull/2625#discussion_r568060737">PR Review Comment</a>:</p>
<blockquote>
<p>That's an excellent point.  I don't think one would redefine these functions after creating the <code>Engine</code> and doing this in a builder pattern would also remove the need to track "redefined" functions to keep them alive.</p>
<p>I think <code>Config</code> would work for this.  Perhaps <code>define_host_func</code> and <code>wrap_host_func</code>?</p>
</blockquote>



<a name="224772998"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232625%20Implement%20defining%20functions%20at%20the%20E.../near/224772998" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232625.20Implement.20defining.20functions.20at.20the.20E.2E.2E.2E.html#224772998">(Feb 01 2021 at 18:51)</a>:</h4>
<p>peterhuene submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/2625#pullrequestreview-580663585">PR Review</a>.</p>



<a name="224772999"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232625%20Implement%20defining%20functions%20at%20the%20E.../near/224772999" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232625.20Implement.20defining.20functions.20at.20the.20E.2E.2E.2E.html#224772999">(Feb 01 2021 at 18:51)</a>:</h4>
<p>peterhuene created <a href="https://github.com/bytecodealliance/wasmtime/pull/2625#discussion_r568060903">PR Review Comment</a>:</p>
<blockquote>
<p>I'll add that.</p>
</blockquote>



<a name="224773018"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232625%20Implement%20defining%20functions%20at%20the%20E.../near/224773018" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232625.20Implement.20defining.20functions.20at.20the.20E.2E.2E.2E.html#224773018">(Feb 01 2021 at 18:51)</a>:</h4>
<p>peterhuene submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/2625#pullrequestreview-580663697">PR Review</a>.</p>



<a name="224773020"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232625%20Implement%20defining%20functions%20at%20the%20E.../near/224773020" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232625.20Implement.20defining.20functions.20at.20the.20E.2E.2E.2E.html#224773020">(Feb 01 2021 at 18:51)</a>:</h4>
<p>peterhuene created <a href="https://github.com/bytecodealliance/wasmtime/pull/2625#discussion_r568060976">PR Review Comment</a>:</p>
<blockquote>
<p>I'll add that.</p>
</blockquote>



<a name="224773168"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232625%20Implement%20defining%20functions%20at%20the%20E.../near/224773168" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232625.20Implement.20defining.20functions.20at.20the.20E.2E.2E.2E.html#224773168">(Feb 01 2021 at 18:52)</a>:</h4>
<p>peterhuene submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/2625#pullrequestreview-580664362">PR Review</a>.</p>



<a name="224773170"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232625%20Implement%20defining%20functions%20at%20the%20E.../near/224773170" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232625.20Implement.20defining.20functions.20at.20the.20E.2E.2E.2E.html#224773170">(Feb 01 2021 at 18:52)</a>:</h4>
<p>peterhuene created <a href="https://github.com/bytecodealliance/wasmtime/pull/2625#discussion_r568061536">PR Review Comment</a>:</p>
<blockquote>
<p>I'll add those bounds.</p>
</blockquote>



<a name="224774141"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232625%20Implement%20defining%20functions%20at%20the%20E.../near/224774141" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232625.20Implement.20defining.20functions.20at.20the.20E.2E.2E.2E.html#224774141">(Feb 01 2021 at 18:59)</a>:</h4>
<p>alexcrichton submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/2625#pullrequestreview-580669893">PR Review</a>.</p>



<a name="224774142"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232625%20Implement%20defining%20functions%20at%20the%20E.../near/224774142" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232625.20Implement.20defining.20functions.20at.20the.20E.2E.2E.2E.html#224774142">(Feb 01 2021 at 18:59)</a>:</h4>
<p>alexcrichton created <a href="https://github.com/bytecodealliance/wasmtime/pull/2625#discussion_r568066002">PR Review Comment</a>:</p>
<blockquote>
<p>Eh I don't mind too much about the names, those seem fine to me!</p>
</blockquote>



<a name="224774242"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232625%20Implement%20defining%20functions%20at%20the%20E.../near/224774242" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232625.20Implement.20defining.20functions.20at.20the.20E.2E.2E.2E.html#224774242">(Feb 01 2021 at 19:00)</a>:</h4>
<p>peterhuene submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/2625#pullrequestreview-580670273">PR Review</a>.</p>



<a name="224774245"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232625%20Implement%20defining%20functions%20at%20the%20E.../near/224774245" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232625.20Implement.20defining.20functions.20at.20the.20E.2E.2E.2E.html#224774245">(Feb 01 2021 at 19:00)</a>:</h4>
<p>peterhuene created <a href="https://github.com/bytecodealliance/wasmtime/pull/2625#discussion_r568066372">PR Review Comment</a>:</p>
<blockquote>
<p><code>VMSharedSignatureIndex::default()</code> is <code>u32::max_value()</code> and guaranteed to never match a signature as the registry doesn't hand that value out.</p>
<p>Using the default should cause any indirect call to fail if somehow this value gets used, which would clearly be a bug.</p>
<p>This value should never be read anyway as all imports of the engine function should use the store-local <code>VMCallerCheckedAnyfunc</code> that has the correct shared signature.</p>
</blockquote>



<a name="224774492"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232625%20Implement%20defining%20functions%20at%20the%20E.../near/224774492" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232625.20Implement.20defining.20functions.20at.20the.20E.2E.2E.2E.html#224774492">(Feb 01 2021 at 19:01)</a>:</h4>
<p>alexcrichton submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/2625#pullrequestreview-580671343">PR Review</a>.</p>



<a name="224774494"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232625%20Implement%20defining%20functions%20at%20the%20E.../near/224774494" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232625.20Implement.20defining.20functions.20at.20the.20E.2E.2E.2E.html#224774494">(Feb 01 2021 at 19:01)</a>:</h4>
<p>alexcrichton created <a href="https://github.com/bytecodealliance/wasmtime/pull/2625#discussion_r568067186">PR Review Comment</a>:</p>
<blockquote>
<p>Unfortunately I don't think so since most JIT code goes from <code>*mut VMContext</code> straight to <code>*mut Instance</code> (the internals of the handle) which has all the non-<code>Sync</code> pieces. For example we just have a dynamic guarantee that the instance never tries to <code>elem.drop</code>, for example.</p>
<p>One of my bigger worries is leaking the incorrect <code>VMSharedSignatureIndex</code> which is configured in the <code>VMContext</code>. I think storing an out-of-bounds index will help weed things out, but otherwise I don't have any great ideas. That being said I don't believe that it's leaked today at all.</p>
</blockquote>



<a name="224774525"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232625%20Implement%20defining%20functions%20at%20the%20E.../near/224774525" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232625.20Implement.20defining.20functions.20at.20the.20E.2E.2E.2E.html#224774525">(Feb 01 2021 at 19:01)</a>:</h4>
<p>peterhuene submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/2625#pullrequestreview-580671503">PR Review</a>.</p>



<a name="224774526"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232625%20Implement%20defining%20functions%20at%20the%20E.../near/224774526" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232625.20Implement.20defining.20functions.20at.20the.20E.2E.2E.2E.html#224774526">(Feb 01 2021 at 19:01)</a>:</h4>
<p>peterhuene created <a href="https://github.com/bytecodealliance/wasmtime/pull/2625#discussion_r568067283">PR Review Comment</a>:</p>
<blockquote>
<p>Will add.</p>
</blockquote>



<a name="224774591"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232625%20Implement%20defining%20functions%20at%20the%20E.../near/224774591" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232625.20Implement.20defining.20functions.20at.20the.20E.2E.2E.2E.html#224774591">(Feb 01 2021 at 19:02)</a>:</h4>
<p>peterhuene submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/2625#pullrequestreview-580671787">PR Review</a>.</p>



<a name="224774599"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232625%20Implement%20defining%20functions%20at%20the%20E.../near/224774599" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232625.20Implement.20defining.20functions.20at.20the.20E.2E.2E.2E.html#224774599">(Feb 01 2021 at 19:02)</a>:</h4>
<p>peterhuene created <a href="https://github.com/bytecodealliance/wasmtime/pull/2625#discussion_r568067485">PR Review Comment</a>:</p>
<blockquote>
<p>I'll fix.</p>
</blockquote>



<a name="224774735"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232625%20Implement%20defining%20functions%20at%20the%20E.../near/224774735" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232625.20Implement.20defining.20functions.20at.20the.20E.2E.2E.2E.html#224774735">(Feb 01 2021 at 19:03)</a>:</h4>
<p>alexcrichton submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/2625#pullrequestreview-580672617">PR Review</a>.</p>



<a name="224774737"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232625%20Implement%20defining%20functions%20at%20the%20E.../near/224774737" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232625.20Implement.20defining.20functions.20at.20the.20E.2E.2E.2E.html#224774737">(Feb 01 2021 at 19:03)</a>:</h4>
<p>alexcrichton created <a href="https://github.com/bytecodealliance/wasmtime/pull/2625#discussion_r568068156">PR Review Comment</a>:</p>
<blockquote>
<p>Oh nice! I didn't realize that was the default but that's exactly the behavior I was hoping to have here, so sounds like there's nothing to do!</p>
</blockquote>



<a name="224775851"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232625%20Implement%20defining%20functions%20at%20the%20E.../near/224775851" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232625.20Implement.20defining.20functions.20at.20the.20E.2E.2E.2E.html#224775851">(Feb 01 2021 at 19:11)</a>:</h4>
<p>peterhuene submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/2625#pullrequestreview-580678935">PR Review</a>.</p>



<a name="224775852"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232625%20Implement%20defining%20functions%20at%20the%20E.../near/224775852" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232625.20Implement.20defining.20functions.20at.20the.20E.2E.2E.2E.html#224775852">(Feb 01 2021 at 19:11)</a>:</h4>
<p>peterhuene created <a href="https://github.com/bytecodealliance/wasmtime/pull/2625#discussion_r568072902">PR Review Comment</a>:</p>
<blockquote>
<p>I share your concerns over safety here.</p>
<p>I still think we're getting some mileage out of the compiler for safety as <code>Store</code> is <code>!Send+!Sync</code> and the store to use for an engine function is always retrieved from TLS (and thus should be the same thread that created the store).</p>
<p>Perhaps a check in <code>Caller::store()</code> that ensures the call is happening on the same thread that created the store, just to be safe?</p>
<blockquote>
<p>Would it be feasible to split out a struct of Sync members from InstanceHandle that we can share, without sharing the whole thing across threads?</p>
</blockquote>
<p>I think splitting <code>wasmtime_runtime::Instance</code> like that shouldn't be necessary as the thread-affinity of an instance shouldn't be violated by these changes.</p>
</blockquote>



<a name="224776336"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232625%20Implement%20defining%20functions%20at%20the%20E.../near/224776336" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232625.20Implement.20defining.20functions.20at.20the.20E.2E.2E.2E.html#224776336">(Feb 01 2021 at 19:14)</a>:</h4>
<p>peterhuene submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/2625#pullrequestreview-580681411">PR Review</a>.</p>



<a name="224776337"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232625%20Implement%20defining%20functions%20at%20the%20E.../near/224776337" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232625.20Implement.20defining.20functions.20at.20the.20E.2E.2E.2E.html#224776337">(Feb 01 2021 at 19:14)</a>:</h4>
<p>peterhuene created <a href="https://github.com/bytecodealliance/wasmtime/pull/2625#discussion_r568074786">PR Review Comment</a>:</p>
<blockquote>
<p><code>Func::new</code> returns <code>Self</code> because of the <code>expect</code> call on the result from <code>generate_func_export</code>.</p>
<p>Should we just change <code>define_func</code> to return <code>()</code> similarly to match?</p>
</blockquote>



<a name="224777486"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232625%20Implement%20defining%20functions%20at%20the%20E.../near/224777486" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232625.20Implement.20defining.20functions.20at.20the.20E.2E.2E.2E.html#224777486">(Feb 01 2021 at 19:22)</a>:</h4>
<p>peterhuene submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/2625#pullrequestreview-580687067">PR Review</a>.</p>



<a name="224777487"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232625%20Implement%20defining%20functions%20at%20the%20E.../near/224777487" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232625.20Implement.20defining.20functions.20at.20the.20E.2E.2E.2E.html#224777487">(Feb 01 2021 at 19:22)</a>:</h4>
<p>peterhuene created <a href="https://github.com/bytecodealliance/wasmtime/pull/2625#discussion_r568079276">PR Review Comment</a>:</p>
<blockquote>
<p>Agreed, this comment is misleading as nothing in a runtime instance ties back to the engine itself.</p>
<p>This clone impl will likely not be needed if I remove the <code>RwLock</code> in favor of the builder pattern anyway.</p>
</blockquote>



<a name="224777922"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232625%20Implement%20defining%20functions%20at%20the%20E.../near/224777922" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232625.20Implement.20defining.20functions.20at.20the.20E.2E.2E.2E.html#224777922">(Feb 01 2021 at 19:25)</a>:</h4>
<p>alexcrichton submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/2625#pullrequestreview-580689518">PR Review</a>.</p>



<a name="224777924"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232625%20Implement%20defining%20functions%20at%20the%20E.../near/224777924" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232625.20Implement.20defining.20functions.20at.20the.20E.2E.2E.2E.html#224777924">(Feb 01 2021 at 19:25)</a>:</h4>
<p>alexcrichton created <a href="https://github.com/bytecodealliance/wasmtime/pull/2625#discussion_r568081196">PR Review Comment</a>:</p>
<blockquote>
<p>Yeah that seems fine to me! We'll probably want to document the shadowing behavior though since this differs slightly than that of <code>Linker</code> where by default <code>Linker</code> returns an error. Returning an error here though feels a bit heavyweight.</p>
</blockquote>



<a name="224778172"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232625%20Implement%20defining%20functions%20at%20the%20E.../near/224778172" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232625.20Implement.20defining.20functions.20at.20the.20E.2E.2E.2E.html#224778172">(Feb 01 2021 at 19:27)</a>:</h4>
<p>peterhuene submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/2625#pullrequestreview-580690686">PR Review</a>.</p>



<a name="224778173"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232625%20Implement%20defining%20functions%20at%20the%20E.../near/224778173" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232625.20Implement.20defining.20functions.20at.20the.20E.2E.2E.2E.html#224778173">(Feb 01 2021 at 19:27)</a>:</h4>
<p>peterhuene created <a href="https://github.com/bytecodealliance/wasmtime/pull/2625#discussion_r568082081">PR Review Comment</a>:</p>
<blockquote>
<p>These fields are also accessed from <code>Store::get_engine_func</code>, but I'm happy to make these private with accessor impls if you think it's warranted.</p>
</blockquote>



<a name="224778197"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232625%20Implement%20defining%20functions%20at%20the%20E.../near/224778197" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232625.20Implement.20defining.20functions.20at.20the.20E.2E.2E.2E.html#224778197">(Feb 01 2021 at 19:27)</a>:</h4>
<p>alexcrichton submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/2625#pullrequestreview-580690857">PR Review</a>.</p>



<a name="224778198"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232625%20Implement%20defining%20functions%20at%20the%20E.../near/224778198" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232625.20Implement.20defining.20functions.20at.20the.20E.2E.2E.2E.html#224778198">(Feb 01 2021 at 19:27)</a>:</h4>
<p>alexcrichton created <a href="https://github.com/bytecodealliance/wasmtime/pull/2625#discussion_r568082239">PR Review Comment</a>:</p>
<blockquote>
<p>My worry is moreso for the internals of Wasmtime itself rather than callers. You're right though in that we do have a number of consistency checks and internals (I suspect more than a few locations modified in this PR were found via assertion failures rather than knowing what to do off the top of your head). My biggest worry is hidden mutability in <code>InstanceHandle</code>, but I think it's not the end of the world for that to be something we remain vigilant for.</p>
<p>Perhaps a nice doc-block can go somewhere though explaining the threading involved here?</p>
</blockquote>



<a name="224778755"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232625%20Implement%20defining%20functions%20at%20the%20E.../near/224778755" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232625.20Implement.20defining.20functions.20at.20the.20E.2E.2E.2E.html#224778755">(Feb 01 2021 at 19:30)</a>:</h4>
<p>alexcrichton submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/2625#pullrequestreview-580693724">PR Review</a>.</p>



<a name="224778756"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232625%20Implement%20defining%20functions%20at%20the%20E.../near/224778756" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232625.20Implement.20defining.20functions.20at.20the.20E.2E.2E.2E.html#224778756">(Feb 01 2021 at 19:30)</a>:</h4>
<p>alexcrichton created <a href="https://github.com/bytecodealliance/wasmtime/pull/2625#discussion_r568084496">PR Review Comment</a>:</p>
<blockquote>
<p>Oh true, perhaps though there could be something like <code>engine_func.to_func(&amp;store)</code>? (mostly just looking to localize this logic if we can)</p>
</blockquote>



<a name="224779696"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232625%20Implement%20defining%20functions%20at%20the%20E.../near/224779696" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232625.20Implement.20defining.20functions.20at.20the.20E.2E.2E.2E.html#224779696">(Feb 01 2021 at 19:37)</a>:</h4>
<p>peterhuene submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/2625#pullrequestreview-580698689">PR Review</a>.</p>



<a name="224779697"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232625%20Implement%20defining%20functions%20at%20the%20E.../near/224779697" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232625.20Implement.20defining.20functions.20at.20the.20E.2E.2E.2E.html#224779697">(Feb 01 2021 at 19:37)</a>:</h4>
<p>peterhuene created <a href="https://github.com/bytecodealliance/wasmtime/pull/2625#discussion_r568088300">PR Review Comment</a>:</p>
<blockquote>
<p>I don't have a strong opinion on this.  I'm fine with removing the de-duplication for clarity's sake.</p>
<p>That said, I think de-duplication is more likely to be exploited at the engine-level where (ideally) WASI is being defined rather than in a <code>Linker</code>.</p>
</blockquote>



<a name="224780581"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232625%20Implement%20defining%20functions%20at%20the%20E.../near/224780581" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232625.20Implement.20defining.20functions.20at.20the.20E.2E.2E.2E.html#224780581">(Feb 01 2021 at 19:44)</a>:</h4>
<p>peterhuene submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/2625#pullrequestreview-580703997">PR Review</a>.</p>



<a name="224780582"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232625%20Implement%20defining%20functions%20at%20the%20E.../near/224780582" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232625.20Implement.20defining.20functions.20at.20the.20E.2E.2E.2E.html#224780582">(Feb 01 2021 at 19:44)</a>:</h4>
<p>peterhuene created <a href="https://github.com/bytecodealliance/wasmtime/pull/2625#discussion_r568092489">PR Review Comment</a>:</p>
<blockquote>
<p>I'll see what I can do to localize the implementation to <code>EngineFunc</code>.</p>
</blockquote>



<a name="224780900"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232625%20Implement%20defining%20functions%20at%20the%20E.../near/224780900" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232625.20Implement.20defining.20functions.20at.20the.20E.2E.2E.2E.html#224780900">(Feb 01 2021 at 19:47)</a>:</h4>
<p>peterhuene submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/2625#pullrequestreview-580706253">PR Review</a>.</p>



<a name="224780902"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232625%20Implement%20defining%20functions%20at%20the%20E.../near/224780902" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232625.20Implement.20defining.20functions.20at.20the.20E.2E.2E.2E.html#224780902">(Feb 01 2021 at 19:47)</a>:</h4>
<p>peterhuene created <a href="https://github.com/bytecodealliance/wasmtime/pull/2625#discussion_r568094334">PR Review Comment</a>:</p>
<blockquote>
<p>A non-issue if these get removed from <code>Engine</code> in favor of the builder-pattern, though.</p>
<p>Re: shadowing, this PR should include a check in <code>Linker</code> that ensures failure if an engine function exists and the linker is <code>!allow_shadowing</code>.  I'll fix that.</p>
</blockquote>



<a name="224781011"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232625%20Implement%20defining%20functions%20at%20the%20E.../near/224781011" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232625.20Implement.20defining.20functions.20at.20the.20E.2E.2E.2E.html#224781011">(Feb 01 2021 at 19:48)</a>:</h4>
<p>peterhuene edited <a href="https://github.com/bytecodealliance/wasmtime/pull/2625#discussion_r568094334">PR Review Comment</a>.</p>



<a name="224781289"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232625%20Implement%20defining%20functions%20at%20the%20E.../near/224781289" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232625.20Implement.20defining.20functions.20at.20the.20E.2E.2E.2E.html#224781289">(Feb 01 2021 at 19:51)</a>:</h4>
<p>peterhuene submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/2625#pullrequestreview-580708916">PR Review</a>.</p>



<a name="224781290"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232625%20Implement%20defining%20functions%20at%20the%20E.../near/224781290" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232625.20Implement.20defining.20functions.20at.20the.20E.2E.2E.2E.html#224781290">(Feb 01 2021 at 19:51)</a>:</h4>
<p>peterhuene created <a href="https://github.com/bytecodealliance/wasmtime/pull/2625#discussion_r568096375">PR Review Comment</a>:</p>
<blockquote>
<p>Agreed, this can be done once.  I'll fix this.</p>
</blockquote>



<a name="224781908"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232625%20Implement%20defining%20functions%20at%20the%20E.../near/224781908" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232625.20Implement.20defining.20functions.20at.20the.20E.2E.2E.2E.html#224781908">(Feb 01 2021 at 19:56)</a>:</h4>
<p>peterhuene submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/2625#pullrequestreview-580713044">PR Review</a>.</p>



<a name="224781909"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232625%20Implement%20defining%20functions%20at%20the%20E.../near/224781909" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232625.20Implement.20defining.20functions.20at.20the.20E.2E.2E.2E.html#224781909">(Feb 01 2021 at 19:56)</a>:</h4>
<p>peterhuene created <a href="https://github.com/bytecodealliance/wasmtime/pull/2625#discussion_r568099510">PR Review Comment</a>:</p>
<blockquote>
<p>The problem is these two shims differ in how the store is accessed (one from capture and the other from TLS); related to that is the associated instance state also differs.</p>
<p>As such, I don't think much could be shared here since I wouldn't want the <code>resume_panic</code> call moved to any other frame than the shim function itself.</p>
</blockquote>



<a name="224796184"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232625%20Implement%20defining%20functions%20at%20the%20E.../near/224796184" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232625.20Implement.20defining.20functions.20at.20the.20E.2E.2E.2E.html#224796184">(Feb 01 2021 at 21:48)</a>:</h4>
<p>peterhuene edited <a href="https://github.com/bytecodealliance/wasmtime/pull/2625#discussion_r568099510">PR Review Comment</a>.</p>



<a name="224817186"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232625%20Implement%20defining%20functions%20at%20the%20E.../near/224817186" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232625.20Implement.20defining.20functions.20at.20the.20E.2E.2E.2E.html#224817186">(Feb 02 2021 at 01:11)</a>:</h4>
<p>peterhuene submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/2625#pullrequestreview-580905785">PR Review</a>.</p>



<a name="224817187"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232625%20Implement%20defining%20functions%20at%20the%20E.../near/224817187" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232625.20Implement.20defining.20functions.20at.20the.20E.2E.2E.2E.html#224817187">(Feb 02 2021 at 01:11)</a>:</h4>
<p>peterhuene created <a href="https://github.com/bytecodealliance/wasmtime/pull/2625#discussion_r568253193">PR Review Comment</a>:</p>
<blockquote>
<p>So there's a problem with adding this bound.</p>
<p>We're passing <code>self</code> in the <code>IntoFunc</code> impls, which has type <code>F</code> with bounds <code>F: Fn(Caller&lt;'_&gt;, $($args),*) -&gt; R + 'static</code> and unfortunately that bound is shared with <code>into_func</code> which wouldn't want those bounds on <code>F</code> otherwise it pollutes <code>Func::wrap</code>.</p>
<p>To properly implement this, we'd need a separate <code>IntoEngineFunc</code> impl.  Thoughts?</p>
</blockquote>



<a name="224817203"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232625%20Implement%20defining%20functions%20at%20the%20E.../near/224817203" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232625.20Implement.20defining.20functions.20at.20the.20E.2E.2E.2E.html#224817203">(Feb 02 2021 at 01:11)</a>:</h4>
<p>peterhuene edited <a href="https://github.com/bytecodealliance/wasmtime/pull/2625#discussion_r568253193">PR Review Comment</a>.</p>



<a name="224817816"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232625%20Implement%20defining%20functions%20at%20the%20E.../near/224817816" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232625.20Implement.20defining.20functions.20at.20the.20E.2E.2E.2E.html#224817816">(Feb 02 2021 at 01:21)</a>:</h4>
<p>peterhuene submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/2625#pullrequestreview-580910004">PR Review</a>.</p>



<a name="224817817"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232625%20Implement%20defining%20functions%20at%20the%20E.../near/224817817" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232625.20Implement.20defining.20functions.20at.20the.20E.2E.2E.2E.html#224817817">(Feb 02 2021 at 01:21)</a>:</h4>
<p>peterhuene created <a href="https://github.com/bytecodealliance/wasmtime/pull/2625#discussion_r568256648">PR Review Comment</a>:</p>
<blockquote>
<p>Or would we rather add these bounds here and transmute them in for the <code>IntoFunc</code> impl with a big comment as to why this is safe (i.e. because the bounds are present in the <code>Engine::wrap_func</code>)?</p>
</blockquote>



<a name="224817827"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232625%20Implement%20defining%20functions%20at%20the%20E.../near/224817827" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232625.20Implement.20defining.20functions.20at.20the.20E.2E.2E.2E.html#224817827">(Feb 02 2021 at 01:21)</a>:</h4>
<p>peterhuene edited <a href="https://github.com/bytecodealliance/wasmtime/pull/2625#discussion_r568256648">PR Review Comment</a>.</p>



<a name="224817843"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232625%20Implement%20defining%20functions%20at%20the%20E.../near/224817843" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232625.20Implement.20defining.20functions.20at.20the.20E.2E.2E.2E.html#224817843">(Feb 02 2021 at 01:21)</a>:</h4>
<p>peterhuene edited <a href="https://github.com/bytecodealliance/wasmtime/pull/2625#discussion_r568256648">PR Review Comment</a>.</p>



<hr><p>Last updated: Jan 20 2025 at 06:04 UTC</p>
</html>