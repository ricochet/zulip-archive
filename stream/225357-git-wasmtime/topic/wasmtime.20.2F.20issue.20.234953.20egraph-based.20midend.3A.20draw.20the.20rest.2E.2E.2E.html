<html>
<head><meta charset="utf-8"><title>wasmtime / issue #4953 egraph-based midend: draw the rest... · git-wasmtime · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/index.html">git-wasmtime</a></h2>
<h3>Topic: <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.234953.20egraph-based.20midend.3A.20draw.20the.20rest.2E.2E.2E.html">wasmtime / issue #4953 egraph-based midend: draw the rest...</a></h3>

<hr>

<base href="https://bytecodealliance.zulipchat.com">

<head><link href="https://bytecodealliance.github.io/zulip-archive/style.css" rel="stylesheet"></head>

<a name="302200442"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%234953%20egraph-based%20midend%3A%20draw%20the%20rest.../near/302200442" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.234953.20egraph-based.20midend.3A.20draw.20the.20rest.2E.2E.2E.html#302200442">(Oct 04 2022 at 06:55)</a>:</h4>
<p>nivkner <a href="https://github.com/bytecodealliance/wasmtime/pull/4953#issuecomment-1266486802">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/4953">issue #4953</a>:</p>
<blockquote>
<p>tested using <code>cranelift-tools</code> with the following <code>clif</code> code:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="n">target</span><span class="w"> </span><span class="n">x86_64</span><span class="w"></span>

<span class="n">function</span><span class="w"> </span><span class="n">u0</span>:<span class="mi">359</span><span class="p">(</span><span class="kt">i64</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="kt">i8</span> <span class="nc">system_v</span><span class="w"> </span><span class="p">{</span><span class="w"></span>

<span class="w">    </span><span class="n">ss0</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">explicit_slot</span><span class="w"> </span><span class="mi">16</span><span class="w"></span>
<span class="w">    </span><span class="n">sig0</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="kt">i64</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="kt">i8</span><span class="p">,</span><span class="w"> </span><span class="kt">i8</span><span class="w"> </span><span class="n">system_v</span><span class="w"></span>
<span class="w">    </span><span class="n">fn0</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">colocated</span><span class="w"> </span><span class="n">u0</span>:<span class="mi">521</span><span class="w"> </span><span class="n">sig0</span><span class="w"></span>

<span class="w">    </span><span class="n">block0</span><span class="p">(</span><span class="n">v0</span>: <span class="kt">i64</span><span class="p">)</span>:
    <span class="nc">v3</span><span class="p">,</span><span class="w"> </span><span class="n">v4</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">call</span><span class="w"> </span><span class="n">fn0</span><span class="p">(</span><span class="n">v0</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">v3</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>
<p>when calling</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="p">.</span><span class="o">/</span><span class="n">target</span><span class="o">/</span><span class="n">debug</span><span class="o">/</span><span class="n">clif</span><span class="o">-</span><span class="n">util</span><span class="w"> </span><span class="n">compile</span><span class="w"> </span><span class="o">--</span><span class="n">set</span><span class="w"> </span><span class="n">use_egraphs</span><span class="o">=</span><span class="kc">false</span><span class="w"> </span><span class="o">--</span><span class="n">target</span><span class="w"> </span><span class="n">x86_64</span><span class="o">-</span><span class="n">unknown</span><span class="o">-</span><span class="n">linux</span><span class="o">-</span><span class="n">gnu</span><span class="w"> </span><span class="n">example</span><span class="p">.</span><span class="n">clif</span><span class="w"></span>
</code></pre></div>
<p>the code compiles with out error.</p>
<p>when setting <code>--set use_egraphs=true</code><br>
the following error is produced:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="n">thread</span><span class="w"> </span><span class="o">'</span><span class="na">main</span><span class="o">'</span><span class="w"> </span><span class="n">panicked</span><span class="w"> </span><span class="n">at</span><span class="w"> </span><span class="o">'</span><span class="na">enode</span><span class="w"> </span><span class="n">depends</span><span class="w"> </span><span class="n">directly</span><span class="w"> </span><span class="n">on</span><span class="w"> </span><span class="n">multi</span><span class="o">-</span><span class="n">value</span><span class="w"> </span><span class="n">result</span><span class="o">'</span><span class="p">,</span><span class="w"> </span><span class="n">cranelift</span><span class="o">/</span><span class="n">codegen</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">egraph</span><span class="o">/</span><span class="n">elaborate</span><span class="p">.</span><span class="n">rs</span>:<span class="mi">396</span>:<span class="mi">33</span><span class="w"></span>
</code></pre></div>
<p>&lt;details&gt;<br>
  &lt;summary&gt;backtrace&lt;/summary&gt;</p>
<p><code>
stack backtrace:
   0: rust_begin_unwind
             at /rustc/a55dd71d5fb0ec5a6a3a9e8c27b2127ba491ce52/library/std/src/panicking.rs:584:5
   1: core::panicking::panic_fmt
             at /rustc/a55dd71d5fb0ec5a6a3a9e8c27b2127ba491ce52/library/core/src/panicking.rs:142:14
   2: cranelift_codegen::egraph::elaborate::Elaborator::process_elab_stack::{{closure}}
             at ./cranelift/codegen/src/egraph/elaborate.rs:396:33
   3: core::ops::function::impls::&lt;impl core::ops::function::FnOnce&lt;A&gt; for &amp;mut F&gt;::call_once
             at /rustc/a55dd71d5fb0ec5a6a3a9e8c27b2127ba491ce52/library/core/src/ops/function.rs:301:13
   4: core::option::Option&lt;T&gt;::map
             at /rustc/a55dd71d5fb0ec5a6a3a9e8c27b2127ba491ce52/library/core/src/option.rs:929:29
   5: &lt;core::iter::adapters::map::Map&lt;I,F&gt; as core::iter::traits::iterator::Iterator&gt;::next
             at /rustc/a55dd71d5fb0ec5a6a3a9e8c27b2127ba491ce52/library/core/src/iter/adapters/map.rs:103:9
   6: &lt;smallvec::SmallVec&lt;A&gt; as core::iter::traits::collect::Extend&lt;&lt;A as smallvec::Array&gt;::Item&gt;&gt;::extend
             at /home/user/.local/share/cargo/registry/src/github.com-1ecc6299db9ec823/smallvec-1.8.0/src/lib.rs:1742:36
   7: &lt;smallvec::SmallVec&lt;A&gt; as core::iter::traits::collect::FromIterator&lt;&lt;A as smallvec::Array&gt;::Item&gt;&gt;::from_iter
             at /home/user/.local/share/cargo/registry/src/github.com-1ecc6299db9ec823/smallvec-1.8.0/src/lib.rs:1727:9
   8: core::iter::traits::iterator::Iterator::collect
             at /rustc/a55dd71d5fb0ec5a6a3a9e8c27b2127ba491ce52/library/core/src/iter/traits/iterator.rs:1836:9
   9: cranelift_codegen::egraph::elaborate::Elaborator::process_elab_stack
             at ./cranelift/codegen/src/egraph/elaborate.rs:391:60
  10: cranelift_codegen::egraph::elaborate::Elaborator::elaborate_eclass_use
             at ./cranelift/codegen/src/egraph/elaborate.rs:285:9
  11: cranelift_codegen::egraph::elaborate::Elaborator::elaborate_block
             at ./cranelift/codegen/src/egraph/elaborate.rs:511:13
  12: cranelift_codegen::egraph::elaborate::Elaborator::elaborate_domtree
             at ./cranelift/codegen/src/egraph/elaborate.rs:532:21
  13: cranelift_codegen::egraph::elaborate::Elaborator::elaborate
             at ./cranelift/codegen/src/egraph/elaborate.rs:583:9
  14: cranelift_codegen::egraph::FuncEGraph::elaborate
             at ./cranelift/codegen/src/egraph.rs:348:9
  15: cranelift_codegen::context::Context::optimize
             at ./cranelift/codegen/src/context.rs:203:13
  16: cranelift_codegen::context::Context::compile_stencil
             at ./cranelift/codegen/src/context.rs:149:13
  17: cranelift_codegen::context::Context::compile
             at ./cranelift/codegen/src/context.rs:224:23
  18: cranelift_codegen::context::Context::compile_and_emit
             at ./cranelift/codegen/src/context.rs:132:29
  19: clif_util::compile::handle_module
             at ./cranelift/src/compile.rs:71:33
  20: clif_util::compile::run
             at ./cranelift/src/compile.rs:46:9
  21: clif_util::main
             at ./cranelift/src/clif-util.rs:106:33
  22: core::ops::function::FnOnce::call_once
             at /rustc/a55dd71d5fb0ec5a6a3a9e8c27b2127ba491ce52/library/core/src/ops/function.rs:248:5
note: Some details are omitted, run with `RUST_BACKTRACE=full` for a verbose backtrace.
  </code><br>
&lt;/details&gt;</p>
</blockquote>



<a name="302200710"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%234953%20egraph-based%20midend%3A%20draw%20the%20rest.../near/302200710" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.234953.20egraph-based.20midend.3A.20draw.20the.20rest.2E.2E.2E.html#302200710">(Oct 04 2022 at 06:57)</a>:</h4>
<p>nivkner edited a <a href="https://github.com/bytecodealliance/wasmtime/pull/4953#issuecomment-1266486802">comment</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/4953">issue #4953</a>:</p>
<blockquote>
<p>tested using <code>cranelift-tools</code> with the following <code>clif</code> code:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="n">target</span><span class="w"> </span><span class="n">x86_64</span><span class="w"></span>

<span class="n">function</span><span class="w"> </span><span class="n">u0</span>:<span class="mi">359</span><span class="p">(</span><span class="kt">i64</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="kt">i8</span> <span class="nc">system_v</span><span class="w"> </span><span class="p">{</span><span class="w"></span>

<span class="w">    </span><span class="n">ss0</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">explicit_slot</span><span class="w"> </span><span class="mi">16</span><span class="w"></span>
<span class="w">    </span><span class="n">sig0</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="kt">i64</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="kt">i8</span><span class="p">,</span><span class="w"> </span><span class="kt">i8</span><span class="w"> </span><span class="n">system_v</span><span class="w"></span>
<span class="w">    </span><span class="n">fn0</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">colocated</span><span class="w"> </span><span class="n">u0</span>:<span class="mi">521</span><span class="w"> </span><span class="n">sig0</span><span class="w"></span>

<span class="w">    </span><span class="n">block0</span><span class="p">(</span><span class="n">v0</span>: <span class="kt">i64</span><span class="p">)</span>:
    <span class="nc">v3</span><span class="p">,</span><span class="w"> </span><span class="n">v4</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">call</span><span class="w"> </span><span class="n">fn0</span><span class="p">(</span><span class="n">v0</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">v3</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>
<p>when calling</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="p">.</span><span class="o">/</span><span class="n">target</span><span class="o">/</span><span class="n">debug</span><span class="o">/</span><span class="n">clif</span><span class="o">-</span><span class="n">util</span><span class="w"> </span><span class="n">compile</span><span class="w"> </span><span class="o">--</span><span class="n">set</span><span class="w"> </span><span class="n">use_egraphs</span><span class="o">=</span><span class="kc">false</span><span class="w"> </span><span class="o">--</span><span class="n">target</span><span class="w"> </span><span class="n">x86_64</span><span class="o">-</span><span class="n">unknown</span><span class="o">-</span><span class="n">linux</span><span class="o">-</span><span class="n">gnu</span><span class="w"> </span><span class="n">example</span><span class="p">.</span><span class="n">clif</span><span class="w"></span>
</code></pre></div>
<p>the code compiles with out error.</p>
<p>when setting <code>--set use_egraphs=true</code><br>
the following error is produced:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="n">thread</span><span class="w"> </span><span class="o">'</span><span class="na">main</span><span class="o">'</span><span class="w"> </span><span class="n">panicked</span><span class="w"> </span><span class="n">at</span><span class="w"> </span><span class="o">'</span><span class="na">enode</span><span class="w"> </span><span class="n">depends</span><span class="w"> </span><span class="n">directly</span><span class="w"> </span><span class="n">on</span><span class="w"> </span><span class="n">multi</span><span class="o">-</span><span class="n">value</span><span class="w"> </span><span class="n">result</span><span class="o">'</span><span class="p">,</span><span class="w"> </span><span class="n">cranelift</span><span class="o">/</span><span class="n">codegen</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">egraph</span><span class="o">/</span><span class="n">elaborate</span><span class="p">.</span><span class="n">rs</span>:<span class="mi">396</span>:<span class="mi">33</span><span class="w"></span>
</code></pre></div>
<p>&lt;details&gt;<br>
  &lt;summary&gt;backtrace&lt;/summary&gt;</p>
<p><code>
stack backtrace:
   0: rust_begin_unwind
             at /rustc/a55dd71d5fb0ec5a6a3a9e8c27b2127ba491ce52/library/std/src/panicking.rs:584:5
   1: core::panicking::panic_fmt
             at /rustc/a55dd71d5fb0ec5a6a3a9e8c27b2127ba491ce52/library/core/src/panicking.rs:142:14
   2: cranelift_codegen::egraph::elaborate::Elaborator::process_elab_stack::{{closure}}
             at ./cranelift/codegen/src/egraph/elaborate.rs:396:33
   3: core::ops::function::impls::&lt;impl core::ops::function::FnOnce&lt;A&gt; for &amp;mut F&gt;::call_once
             at /rustc/a55dd71d5fb0ec5a6a3a9e8c27b2127ba491ce52/library/core/src/ops/function.rs:301:13
   4: core::option::Option&lt;T&gt;::map
             at /rustc/a55dd71d5fb0ec5a6a3a9e8c27b2127ba491ce52/library/core/src/option.rs:929:29
   5: &lt;core::iter::adapters::map::Map&lt;I,F&gt; as core::iter::traits::iterator::Iterator&gt;::next
             at /rustc/a55dd71d5fb0ec5a6a3a9e8c27b2127ba491ce52/library/core/src/iter/adapters/map.rs:103:9
   6: &lt;smallvec::SmallVec&lt;A&gt; as core::iter::traits::collect::Extend&lt;&lt;A as smallvec::Array&gt;::Item&gt;&gt;::extend
             at /home/user/.local/share/cargo/registry/src/github.com-1ecc6299db9ec823/smallvec-1.8.0/src/lib.rs:1742:36
   7: &lt;smallvec::SmallVec&lt;A&gt; as core::iter::traits::collect::FromIterator&lt;&lt;A as smallvec::Array&gt;::Item&gt;&gt;::from_iter
             at /home/user/.local/share/cargo/registry/src/github.com-1ecc6299db9ec823/smallvec-1.8.0/src/lib.rs:1727:9
   8: core::iter::traits::iterator::Iterator::collect
             at /rustc/a55dd71d5fb0ec5a6a3a9e8c27b2127ba491ce52/library/core/src/iter/traits/iterator.rs:1836:9
   9: cranelift_codegen::egraph::elaborate::Elaborator::process_elab_stack
             at ./cranelift/codegen/src/egraph/elaborate.rs:391:60
  10: cranelift_codegen::egraph::elaborate::Elaborator::elaborate_eclass_use
             at ./cranelift/codegen/src/egraph/elaborate.rs:285:9
  11: cranelift_codegen::egraph::elaborate::Elaborator::elaborate_block
             at ./cranelift/codegen/src/egraph/elaborate.rs:511:13
  12: cranelift_codegen::egraph::elaborate::Elaborator::elaborate_domtree
             at ./cranelift/codegen/src/egraph/elaborate.rs:532:21
  13: cranelift_codegen::egraph::elaborate::Elaborator::elaborate
             at ./cranelift/codegen/src/egraph/elaborate.rs:583:9
  14: cranelift_codegen::egraph::FuncEGraph::elaborate
             at ./cranelift/codegen/src/egraph.rs:348:9
  15: cranelift_codegen::context::Context::optimize
             at ./cranelift/codegen/src/context.rs:203:13
  16: cranelift_codegen::context::Context::compile_stencil
             at ./cranelift/codegen/src/context.rs:149:13
  17: cranelift_codegen::context::Context::compile
             at ./cranelift/codegen/src/context.rs:224:23
  18: cranelift_codegen::context::Context::compile_and_emit
             at ./cranelift/codegen/src/context.rs:132:29
  19: clif_util::compile::handle_module
             at ./cranelift/src/compile.rs:71:33
  20: clif_util::compile::run
             at ./cranelift/src/compile.rs:46:9
  21: clif_util::main
             at ./cranelift/src/clif-util.rs:106:33
  22: core::ops::function::FnOnce::call_once
             at /rustc/a55dd71d5fb0ec5a6a3a9e8c27b2127ba491ce52/library/core/src/ops/function.rs:248:5
note: Some details are omitted, run with `RUST_BACKTRACE=full` for a verbose backtrace.
  </code><br>
&lt;/details&gt;</p>
<p>file reduced from <code>clif</code> of <code>core</code> produced when attempting to compile <code>core</code> with <a href="https://github.com/bjorn3/rustc_codegen_cranelift">https://github.com/bjorn3/rustc_codegen_cranelift</a> patched to use this PR</p>
</blockquote>



<a name="302200823"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%234953%20egraph-based%20midend%3A%20draw%20the%20rest.../near/302200823" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.234953.20egraph-based.20midend.3A.20draw.20the.20rest.2E.2E.2E.html#302200823">(Oct 04 2022 at 06:58)</a>:</h4>
<p>nivkner edited a <a href="https://github.com/bytecodealliance/wasmtime/pull/4953#issuecomment-1266486802">comment</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/4953">issue #4953</a>:</p>
<blockquote>
<p>tested using <code>cranelift-tools</code> with the following <code>clif</code> code:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="n">target</span><span class="w"> </span><span class="n">x86_64</span><span class="w"></span>

<span class="n">function</span><span class="w"> </span><span class="n">u0</span>:<span class="mi">359</span><span class="p">(</span><span class="kt">i64</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="kt">i8</span> <span class="nc">system_v</span><span class="w"> </span><span class="p">{</span><span class="w"></span>

<span class="w">    </span><span class="n">ss0</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">explicit_slot</span><span class="w"> </span><span class="mi">16</span><span class="w"></span>
<span class="w">    </span><span class="n">sig0</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="kt">i64</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="kt">i8</span><span class="p">,</span><span class="w"> </span><span class="kt">i8</span><span class="w"> </span><span class="n">system_v</span><span class="w"></span>
<span class="w">    </span><span class="n">fn0</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">colocated</span><span class="w"> </span><span class="n">u0</span>:<span class="mi">521</span><span class="w"> </span><span class="n">sig0</span><span class="w"></span>

<span class="w">    </span><span class="n">block0</span><span class="p">(</span><span class="n">v0</span>: <span class="kt">i64</span><span class="p">)</span>:
    <span class="nc">v3</span><span class="p">,</span><span class="w"> </span><span class="n">v4</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">call</span><span class="w"> </span><span class="n">fn0</span><span class="p">(</span><span class="n">v0</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">v3</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>
<p>when calling</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="p">.</span><span class="o">/</span><span class="n">target</span><span class="o">/</span><span class="n">debug</span><span class="o">/</span><span class="n">clif</span><span class="o">-</span><span class="n">util</span><span class="w"> </span><span class="n">compile</span><span class="w"> </span><span class="o">--</span><span class="n">set</span><span class="w"> </span><span class="n">use_egraphs</span><span class="o">=</span><span class="kc">false</span><span class="w"> </span><span class="o">--</span><span class="n">target</span><span class="w"> </span><span class="n">x86_64</span><span class="o">-</span><span class="n">unknown</span><span class="o">-</span><span class="n">linux</span><span class="o">-</span><span class="n">gnu</span><span class="w"> </span><span class="n">example</span><span class="p">.</span><span class="n">clif</span><span class="w"></span>
</code></pre></div>
<p>the code compiles without error.</p>
<p>when setting <code>--set use_egraphs=true</code><br>
the following error is produced:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="n">thread</span><span class="w"> </span><span class="o">'</span><span class="na">main</span><span class="o">'</span><span class="w"> </span><span class="n">panicked</span><span class="w"> </span><span class="n">at</span><span class="w"> </span><span class="o">'</span><span class="na">enode</span><span class="w"> </span><span class="n">depends</span><span class="w"> </span><span class="n">directly</span><span class="w"> </span><span class="n">on</span><span class="w"> </span><span class="n">multi</span><span class="o">-</span><span class="n">value</span><span class="w"> </span><span class="n">result</span><span class="o">'</span><span class="p">,</span><span class="w"> </span><span class="n">cranelift</span><span class="o">/</span><span class="n">codegen</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">egraph</span><span class="o">/</span><span class="n">elaborate</span><span class="p">.</span><span class="n">rs</span>:<span class="mi">396</span>:<span class="mi">33</span><span class="w"></span>
</code></pre></div>
<p>&lt;details&gt;<br>
  &lt;summary&gt;backtrace&lt;/summary&gt;</p>
<p><code>
stack backtrace:
   0: rust_begin_unwind
             at /rustc/a55dd71d5fb0ec5a6a3a9e8c27b2127ba491ce52/library/std/src/panicking.rs:584:5
   1: core::panicking::panic_fmt
             at /rustc/a55dd71d5fb0ec5a6a3a9e8c27b2127ba491ce52/library/core/src/panicking.rs:142:14
   2: cranelift_codegen::egraph::elaborate::Elaborator::process_elab_stack::{{closure}}
             at ./cranelift/codegen/src/egraph/elaborate.rs:396:33
   3: core::ops::function::impls::&lt;impl core::ops::function::FnOnce&lt;A&gt; for &amp;mut F&gt;::call_once
             at /rustc/a55dd71d5fb0ec5a6a3a9e8c27b2127ba491ce52/library/core/src/ops/function.rs:301:13
   4: core::option::Option&lt;T&gt;::map
             at /rustc/a55dd71d5fb0ec5a6a3a9e8c27b2127ba491ce52/library/core/src/option.rs:929:29
   5: &lt;core::iter::adapters::map::Map&lt;I,F&gt; as core::iter::traits::iterator::Iterator&gt;::next
             at /rustc/a55dd71d5fb0ec5a6a3a9e8c27b2127ba491ce52/library/core/src/iter/adapters/map.rs:103:9
   6: &lt;smallvec::SmallVec&lt;A&gt; as core::iter::traits::collect::Extend&lt;&lt;A as smallvec::Array&gt;::Item&gt;&gt;::extend
             at /home/user/.local/share/cargo/registry/src/github.com-1ecc6299db9ec823/smallvec-1.8.0/src/lib.rs:1742:36
   7: &lt;smallvec::SmallVec&lt;A&gt; as core::iter::traits::collect::FromIterator&lt;&lt;A as smallvec::Array&gt;::Item&gt;&gt;::from_iter
             at /home/user/.local/share/cargo/registry/src/github.com-1ecc6299db9ec823/smallvec-1.8.0/src/lib.rs:1727:9
   8: core::iter::traits::iterator::Iterator::collect
             at /rustc/a55dd71d5fb0ec5a6a3a9e8c27b2127ba491ce52/library/core/src/iter/traits/iterator.rs:1836:9
   9: cranelift_codegen::egraph::elaborate::Elaborator::process_elab_stack
             at ./cranelift/codegen/src/egraph/elaborate.rs:391:60
  10: cranelift_codegen::egraph::elaborate::Elaborator::elaborate_eclass_use
             at ./cranelift/codegen/src/egraph/elaborate.rs:285:9
  11: cranelift_codegen::egraph::elaborate::Elaborator::elaborate_block
             at ./cranelift/codegen/src/egraph/elaborate.rs:511:13
  12: cranelift_codegen::egraph::elaborate::Elaborator::elaborate_domtree
             at ./cranelift/codegen/src/egraph/elaborate.rs:532:21
  13: cranelift_codegen::egraph::elaborate::Elaborator::elaborate
             at ./cranelift/codegen/src/egraph/elaborate.rs:583:9
  14: cranelift_codegen::egraph::FuncEGraph::elaborate
             at ./cranelift/codegen/src/egraph.rs:348:9
  15: cranelift_codegen::context::Context::optimize
             at ./cranelift/codegen/src/context.rs:203:13
  16: cranelift_codegen::context::Context::compile_stencil
             at ./cranelift/codegen/src/context.rs:149:13
  17: cranelift_codegen::context::Context::compile
             at ./cranelift/codegen/src/context.rs:224:23
  18: cranelift_codegen::context::Context::compile_and_emit
             at ./cranelift/codegen/src/context.rs:132:29
  19: clif_util::compile::handle_module
             at ./cranelift/src/compile.rs:71:33
  20: clif_util::compile::run
             at ./cranelift/src/compile.rs:46:9
  21: clif_util::main
             at ./cranelift/src/clif-util.rs:106:33
  22: core::ops::function::FnOnce::call_once
             at /rustc/a55dd71d5fb0ec5a6a3a9e8c27b2127ba491ce52/library/core/src/ops/function.rs:248:5
note: Some details are omitted, run with `RUST_BACKTRACE=full` for a verbose backtrace.
  </code><br>
&lt;/details&gt;</p>
<p>file reduced from <code>clif</code> of <code>core</code> produced when attempting to compile <code>core</code> with <a href="https://github.com/bjorn3/rustc_codegen_cranelift">https://github.com/bjorn3/rustc_codegen_cranelift</a> patched to use this PR</p>
</blockquote>



<a name="302201597"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%234953%20egraph-based%20midend%3A%20draw%20the%20rest.../near/302201597" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.234953.20egraph-based.20midend.3A.20draw.20the.20rest.2E.2E.2E.html#302201597">(Oct 04 2022 at 07:05)</a>:</h4>
<p>nivkner edited a <a href="https://github.com/bytecodealliance/wasmtime/pull/4953#issuecomment-1266486802">comment</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/4953">issue #4953</a>:</p>
<blockquote>
<p>tested using <code>cranelift-tools</code> with the following <code>clif</code> code:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="n">target</span><span class="w"> </span><span class="n">x86_64</span><span class="w"></span>

<span class="n">function</span><span class="w"> </span><span class="n">u0</span>:<span class="mi">359</span><span class="p">(</span><span class="kt">i64</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="kt">i8</span> <span class="nc">system_v</span><span class="w"> </span><span class="p">{</span><span class="w"></span>

<span class="w">    </span><span class="n">sig0</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="kt">i64</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="kt">i8</span><span class="p">,</span><span class="w"> </span><span class="kt">i8</span><span class="w"> </span><span class="n">system_v</span><span class="w"></span>
<span class="w">    </span><span class="n">fn0</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">colocated</span><span class="w"> </span><span class="n">u0</span>:<span class="mi">521</span><span class="w"> </span><span class="n">sig0</span><span class="w"></span>

<span class="w">    </span><span class="n">block0</span><span class="p">(</span><span class="n">v0</span>: <span class="kt">i64</span><span class="p">)</span>:
    <span class="nc">v3</span><span class="p">,</span><span class="w"> </span><span class="n">v4</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">call</span><span class="w"> </span><span class="n">fn0</span><span class="p">(</span><span class="n">v0</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">v3</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>
<p>when calling</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="p">.</span><span class="o">/</span><span class="n">target</span><span class="o">/</span><span class="n">debug</span><span class="o">/</span><span class="n">clif</span><span class="o">-</span><span class="n">util</span><span class="w"> </span><span class="n">compile</span><span class="w"> </span><span class="o">--</span><span class="n">set</span><span class="w"> </span><span class="n">use_egraphs</span><span class="o">=</span><span class="kc">false</span><span class="w"> </span><span class="o">--</span><span class="n">target</span><span class="w"> </span><span class="n">x86_64</span><span class="o">-</span><span class="n">unknown</span><span class="o">-</span><span class="n">linux</span><span class="o">-</span><span class="n">gnu</span><span class="w"> </span><span class="n">example</span><span class="p">.</span><span class="n">clif</span><span class="w"></span>
</code></pre></div>
<p>the code compiles without error.</p>
<p>when setting <code>--set use_egraphs=true</code><br>
the following error is produced:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="n">thread</span><span class="w"> </span><span class="o">'</span><span class="na">main</span><span class="o">'</span><span class="w"> </span><span class="n">panicked</span><span class="w"> </span><span class="n">at</span><span class="w"> </span><span class="o">'</span><span class="na">enode</span><span class="w"> </span><span class="n">depends</span><span class="w"> </span><span class="n">directly</span><span class="w"> </span><span class="n">on</span><span class="w"> </span><span class="n">multi</span><span class="o">-</span><span class="n">value</span><span class="w"> </span><span class="n">result</span><span class="o">'</span><span class="p">,</span><span class="w"> </span><span class="n">cranelift</span><span class="o">/</span><span class="n">codegen</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">egraph</span><span class="o">/</span><span class="n">elaborate</span><span class="p">.</span><span class="n">rs</span>:<span class="mi">396</span>:<span class="mi">33</span><span class="w"></span>
</code></pre></div>
<p>&lt;details&gt;<br>
  &lt;summary&gt;backtrace&lt;/summary&gt;</p>
<p><code>
stack backtrace:
   0: rust_begin_unwind
             at /rustc/a55dd71d5fb0ec5a6a3a9e8c27b2127ba491ce52/library/std/src/panicking.rs:584:5
   1: core::panicking::panic_fmt
             at /rustc/a55dd71d5fb0ec5a6a3a9e8c27b2127ba491ce52/library/core/src/panicking.rs:142:14
   2: cranelift_codegen::egraph::elaborate::Elaborator::process_elab_stack::{{closure}}
             at ./cranelift/codegen/src/egraph/elaborate.rs:396:33
   3: core::ops::function::impls::&lt;impl core::ops::function::FnOnce&lt;A&gt; for &amp;mut F&gt;::call_once
             at /rustc/a55dd71d5fb0ec5a6a3a9e8c27b2127ba491ce52/library/core/src/ops/function.rs:301:13
   4: core::option::Option&lt;T&gt;::map
             at /rustc/a55dd71d5fb0ec5a6a3a9e8c27b2127ba491ce52/library/core/src/option.rs:929:29
   5: &lt;core::iter::adapters::map::Map&lt;I,F&gt; as core::iter::traits::iterator::Iterator&gt;::next
             at /rustc/a55dd71d5fb0ec5a6a3a9e8c27b2127ba491ce52/library/core/src/iter/adapters/map.rs:103:9
   6: &lt;smallvec::SmallVec&lt;A&gt; as core::iter::traits::collect::Extend&lt;&lt;A as smallvec::Array&gt;::Item&gt;&gt;::extend
             at /home/user/.local/share/cargo/registry/src/github.com-1ecc6299db9ec823/smallvec-1.8.0/src/lib.rs:1742:36
   7: &lt;smallvec::SmallVec&lt;A&gt; as core::iter::traits::collect::FromIterator&lt;&lt;A as smallvec::Array&gt;::Item&gt;&gt;::from_iter
             at /home/user/.local/share/cargo/registry/src/github.com-1ecc6299db9ec823/smallvec-1.8.0/src/lib.rs:1727:9
   8: core::iter::traits::iterator::Iterator::collect
             at /rustc/a55dd71d5fb0ec5a6a3a9e8c27b2127ba491ce52/library/core/src/iter/traits/iterator.rs:1836:9
   9: cranelift_codegen::egraph::elaborate::Elaborator::process_elab_stack
             at ./cranelift/codegen/src/egraph/elaborate.rs:391:60
  10: cranelift_codegen::egraph::elaborate::Elaborator::elaborate_eclass_use
             at ./cranelift/codegen/src/egraph/elaborate.rs:285:9
  11: cranelift_codegen::egraph::elaborate::Elaborator::elaborate_block
             at ./cranelift/codegen/src/egraph/elaborate.rs:511:13
  12: cranelift_codegen::egraph::elaborate::Elaborator::elaborate_domtree
             at ./cranelift/codegen/src/egraph/elaborate.rs:532:21
  13: cranelift_codegen::egraph::elaborate::Elaborator::elaborate
             at ./cranelift/codegen/src/egraph/elaborate.rs:583:9
  14: cranelift_codegen::egraph::FuncEGraph::elaborate
             at ./cranelift/codegen/src/egraph.rs:348:9
  15: cranelift_codegen::context::Context::optimize
             at ./cranelift/codegen/src/context.rs:203:13
  16: cranelift_codegen::context::Context::compile_stencil
             at ./cranelift/codegen/src/context.rs:149:13
  17: cranelift_codegen::context::Context::compile
             at ./cranelift/codegen/src/context.rs:224:23
  18: cranelift_codegen::context::Context::compile_and_emit
             at ./cranelift/codegen/src/context.rs:132:29
  19: clif_util::compile::handle_module
             at ./cranelift/src/compile.rs:71:33
  20: clif_util::compile::run
             at ./cranelift/src/compile.rs:46:9
  21: clif_util::main
             at ./cranelift/src/clif-util.rs:106:33
  22: core::ops::function::FnOnce::call_once
             at /rustc/a55dd71d5fb0ec5a6a3a9e8c27b2127ba491ce52/library/core/src/ops/function.rs:248:5
note: Some details are omitted, run with `RUST_BACKTRACE=full` for a verbose backtrace.
  </code><br>
&lt;/details&gt;</p>
<p>file reduced from <code>clif</code> of <code>core</code> produced when attempting to compile <code>core</code> with <a href="https://github.com/bjorn3/rustc_codegen_cranelift">https://github.com/bjorn3/rustc_codegen_cranelift</a> patched to use this PR</p>
</blockquote>



<a name="302202019"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%234953%20egraph-based%20midend%3A%20draw%20the%20rest.../near/302202019" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.234953.20egraph-based.20midend.3A.20draw.20the.20rest.2E.2E.2E.html#302202019">(Oct 04 2022 at 07:09)</a>:</h4>
<p>nivkner edited a <a href="https://github.com/bytecodealliance/wasmtime/pull/4953#issuecomment-1266486802">comment</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/4953">issue #4953</a>:</p>
<blockquote>
<p>tested using <code>cranelift-tools</code> with the following <code>clif</code> code:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="n">target</span><span class="w"> </span><span class="n">x86_64</span><span class="w"></span>

<span class="n">function</span><span class="w"> </span><span class="n">u0</span>:<span class="mi">359</span><span class="p">(</span><span class="kt">i64</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="kt">i8</span> <span class="nc">system_v</span><span class="w"> </span><span class="p">{</span><span class="w"></span>

<span class="w">    </span><span class="n">sig0</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="kt">i64</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="kt">i8</span><span class="p">,</span><span class="w"> </span><span class="kt">i8</span><span class="w"> </span><span class="n">system_v</span><span class="w"></span>
<span class="w">    </span><span class="n">fn0</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">colocated</span><span class="w"> </span><span class="n">u0</span>:<span class="mi">521</span><span class="w"> </span><span class="n">sig0</span><span class="w"></span>

<span class="w">    </span><span class="n">block0</span><span class="p">(</span><span class="n">v0</span>: <span class="kt">i64</span><span class="p">)</span>:
    <span class="nc">v3</span><span class="p">,</span><span class="w"> </span><span class="n">v4</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">call</span><span class="w"> </span><span class="n">fn0</span><span class="p">(</span><span class="n">v0</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">v3</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>
<p>when calling</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="p">.</span><span class="o">/</span><span class="n">target</span><span class="o">/</span><span class="n">debug</span><span class="o">/</span><span class="n">clif</span><span class="o">-</span><span class="n">util</span><span class="w"> </span><span class="n">compile</span><span class="w"> </span><span class="o">--</span><span class="n">set</span><span class="w"> </span><span class="n">use_egraphs</span><span class="o">=</span><span class="kc">false</span><span class="w"> </span><span class="o">--</span><span class="n">target</span><span class="w"> </span><span class="n">x86_64</span><span class="o">-</span><span class="n">unknown</span><span class="o">-</span><span class="n">linux</span><span class="o">-</span><span class="n">gnu</span><span class="w"> </span><span class="n">example</span><span class="p">.</span><span class="n">clif</span><span class="w"></span>
</code></pre></div>
<p>the code compiles without error.</p>
<p>when setting <code>--set use_egraphs=true</code> the following error is produced:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="n">thread</span><span class="w"> </span><span class="o">'</span><span class="na">main</span><span class="o">'</span><span class="w"> </span><span class="n">panicked</span><span class="w"> </span><span class="n">at</span><span class="w"> </span><span class="o">'</span><span class="na">enode</span><span class="w"> </span><span class="n">depends</span><span class="w"> </span><span class="n">directly</span><span class="w"> </span><span class="n">on</span><span class="w"> </span><span class="n">multi</span><span class="o">-</span><span class="n">value</span><span class="w"> </span><span class="n">result</span><span class="o">'</span><span class="p">,</span><span class="w"> </span><span class="n">cranelift</span><span class="o">/</span><span class="n">codegen</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">egraph</span><span class="o">/</span><span class="n">elaborate</span><span class="p">.</span><span class="n">rs</span>:<span class="mi">396</span>:<span class="mi">33</span><span class="w"></span>
</code></pre></div>
<p>&lt;details&gt;<br>
  &lt;summary&gt;backtrace&lt;/summary&gt;</p>
<p><code>
stack backtrace:
   0: rust_begin_unwind
             at /rustc/a55dd71d5fb0ec5a6a3a9e8c27b2127ba491ce52/library/std/src/panicking.rs:584:5
   1: core::panicking::panic_fmt
             at /rustc/a55dd71d5fb0ec5a6a3a9e8c27b2127ba491ce52/library/core/src/panicking.rs:142:14
   2: cranelift_codegen::egraph::elaborate::Elaborator::process_elab_stack::{{closure}}
             at ./cranelift/codegen/src/egraph/elaborate.rs:396:33
   3: core::ops::function::impls::&lt;impl core::ops::function::FnOnce&lt;A&gt; for &amp;mut F&gt;::call_once
             at /rustc/a55dd71d5fb0ec5a6a3a9e8c27b2127ba491ce52/library/core/src/ops/function.rs:301:13
   4: core::option::Option&lt;T&gt;::map
             at /rustc/a55dd71d5fb0ec5a6a3a9e8c27b2127ba491ce52/library/core/src/option.rs:929:29
   5: &lt;core::iter::adapters::map::Map&lt;I,F&gt; as core::iter::traits::iterator::Iterator&gt;::next
             at /rustc/a55dd71d5fb0ec5a6a3a9e8c27b2127ba491ce52/library/core/src/iter/adapters/map.rs:103:9
   6: &lt;smallvec::SmallVec&lt;A&gt; as core::iter::traits::collect::Extend&lt;&lt;A as smallvec::Array&gt;::Item&gt;&gt;::extend
             at /home/user/.local/share/cargo/registry/src/github.com-1ecc6299db9ec823/smallvec-1.8.0/src/lib.rs:1742:36
   7: &lt;smallvec::SmallVec&lt;A&gt; as core::iter::traits::collect::FromIterator&lt;&lt;A as smallvec::Array&gt;::Item&gt;&gt;::from_iter
             at /home/user/.local/share/cargo/registry/src/github.com-1ecc6299db9ec823/smallvec-1.8.0/src/lib.rs:1727:9
   8: core::iter::traits::iterator::Iterator::collect
             at /rustc/a55dd71d5fb0ec5a6a3a9e8c27b2127ba491ce52/library/core/src/iter/traits/iterator.rs:1836:9
   9: cranelift_codegen::egraph::elaborate::Elaborator::process_elab_stack
             at ./cranelift/codegen/src/egraph/elaborate.rs:391:60
  10: cranelift_codegen::egraph::elaborate::Elaborator::elaborate_eclass_use
             at ./cranelift/codegen/src/egraph/elaborate.rs:285:9
  11: cranelift_codegen::egraph::elaborate::Elaborator::elaborate_block
             at ./cranelift/codegen/src/egraph/elaborate.rs:511:13
  12: cranelift_codegen::egraph::elaborate::Elaborator::elaborate_domtree
             at ./cranelift/codegen/src/egraph/elaborate.rs:532:21
  13: cranelift_codegen::egraph::elaborate::Elaborator::elaborate
             at ./cranelift/codegen/src/egraph/elaborate.rs:583:9
  14: cranelift_codegen::egraph::FuncEGraph::elaborate
             at ./cranelift/codegen/src/egraph.rs:348:9
  15: cranelift_codegen::context::Context::optimize
             at ./cranelift/codegen/src/context.rs:203:13
  16: cranelift_codegen::context::Context::compile_stencil
             at ./cranelift/codegen/src/context.rs:149:13
  17: cranelift_codegen::context::Context::compile
             at ./cranelift/codegen/src/context.rs:224:23
  18: cranelift_codegen::context::Context::compile_and_emit
             at ./cranelift/codegen/src/context.rs:132:29
  19: clif_util::compile::handle_module
             at ./cranelift/src/compile.rs:71:33
  20: clif_util::compile::run
             at ./cranelift/src/compile.rs:46:9
  21: clif_util::main
             at ./cranelift/src/clif-util.rs:106:33
  22: core::ops::function::FnOnce::call_once
             at /rustc/a55dd71d5fb0ec5a6a3a9e8c27b2127ba491ce52/library/core/src/ops/function.rs:248:5
note: Some details are omitted, run with `RUST_BACKTRACE=full` for a verbose backtrace.
  </code><br>
&lt;/details&gt;</p>
<p>file reduced from <code>clif</code> of <code>core</code> produced when attempting to compile <code>core</code> with <a href="https://github.com/bjorn3/rustc_codegen_cranelift">https://github.com/bjorn3/rustc_codegen_cranelift</a> patched to use this PR</p>
</blockquote>



<a name="302202063"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%234953%20egraph-based%20midend%3A%20draw%20the%20rest.../near/302202063" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.234953.20egraph-based.20midend.3A.20draw.20the.20rest.2E.2E.2E.html#302202063">(Oct 04 2022 at 07:09)</a>:</h4>
<p>nivkner edited a <a href="https://github.com/bytecodealliance/wasmtime/pull/4953#issuecomment-1266486802">comment</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/4953">issue #4953</a>:</p>
<blockquote>
<p>tested using <code>cranelift-tools</code> with the following <code>clif</code> code:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="n">target</span><span class="w"> </span><span class="n">x86_64</span><span class="w"></span>

<span class="n">function</span><span class="w"> </span><span class="n">u0</span>:<span class="mi">359</span><span class="p">(</span><span class="kt">i64</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="kt">i8</span> <span class="nc">system_v</span><span class="w"> </span><span class="p">{</span><span class="w"></span>

<span class="w">    </span><span class="n">sig0</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="kt">i64</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="kt">i8</span><span class="p">,</span><span class="w"> </span><span class="kt">i8</span><span class="w"> </span><span class="n">system_v</span><span class="w"></span>
<span class="w">    </span><span class="n">fn0</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">colocated</span><span class="w"> </span><span class="n">u0</span>:<span class="mi">521</span><span class="w"> </span><span class="n">sig0</span><span class="w"></span>

<span class="w">    </span><span class="n">block0</span><span class="p">(</span><span class="n">v0</span>: <span class="kt">i64</span><span class="p">)</span>:
    <span class="nc">v3</span><span class="p">,</span><span class="w"> </span><span class="n">v4</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">call</span><span class="w"> </span><span class="n">fn0</span><span class="p">(</span><span class="n">v0</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">v3</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>
<p>when calling</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="p">.</span><span class="o">/</span><span class="n">target</span><span class="o">/</span><span class="n">debug</span><span class="o">/</span><span class="n">clif</span><span class="o">-</span><span class="n">util</span><span class="w"> </span><span class="n">compile</span><span class="w"> </span><span class="o">--</span><span class="n">set</span><span class="w"> </span><span class="n">use_egraphs</span><span class="o">=</span><span class="kc">false</span><span class="w"> </span><span class="o">--</span><span class="n">target</span><span class="w"> </span><span class="n">x86_64</span><span class="o">-</span><span class="n">unknown</span><span class="o">-</span><span class="n">linux</span><span class="o">-</span><span class="n">gnu</span><span class="w"> </span><span class="n">example</span><span class="p">.</span><span class="n">clif</span><span class="w"></span>
</code></pre></div>
<p>the code compiles without error.</p>
<p>when setting <code>use_egraphs=true</code> the following error is produced:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="n">thread</span><span class="w"> </span><span class="o">'</span><span class="na">main</span><span class="o">'</span><span class="w"> </span><span class="n">panicked</span><span class="w"> </span><span class="n">at</span><span class="w"> </span><span class="o">'</span><span class="na">enode</span><span class="w"> </span><span class="n">depends</span><span class="w"> </span><span class="n">directly</span><span class="w"> </span><span class="n">on</span><span class="w"> </span><span class="n">multi</span><span class="o">-</span><span class="n">value</span><span class="w"> </span><span class="n">result</span><span class="o">'</span><span class="p">,</span><span class="w"> </span><span class="n">cranelift</span><span class="o">/</span><span class="n">codegen</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">egraph</span><span class="o">/</span><span class="n">elaborate</span><span class="p">.</span><span class="n">rs</span>:<span class="mi">396</span>:<span class="mi">33</span><span class="w"></span>
</code></pre></div>
<p>&lt;details&gt;<br>
  &lt;summary&gt;backtrace&lt;/summary&gt;</p>
<p><code>
stack backtrace:
   0: rust_begin_unwind
             at /rustc/a55dd71d5fb0ec5a6a3a9e8c27b2127ba491ce52/library/std/src/panicking.rs:584:5
   1: core::panicking::panic_fmt
             at /rustc/a55dd71d5fb0ec5a6a3a9e8c27b2127ba491ce52/library/core/src/panicking.rs:142:14
   2: cranelift_codegen::egraph::elaborate::Elaborator::process_elab_stack::{{closure}}
             at ./cranelift/codegen/src/egraph/elaborate.rs:396:33
   3: core::ops::function::impls::&lt;impl core::ops::function::FnOnce&lt;A&gt; for &amp;mut F&gt;::call_once
             at /rustc/a55dd71d5fb0ec5a6a3a9e8c27b2127ba491ce52/library/core/src/ops/function.rs:301:13
   4: core::option::Option&lt;T&gt;::map
             at /rustc/a55dd71d5fb0ec5a6a3a9e8c27b2127ba491ce52/library/core/src/option.rs:929:29
   5: &lt;core::iter::adapters::map::Map&lt;I,F&gt; as core::iter::traits::iterator::Iterator&gt;::next
             at /rustc/a55dd71d5fb0ec5a6a3a9e8c27b2127ba491ce52/library/core/src/iter/adapters/map.rs:103:9
   6: &lt;smallvec::SmallVec&lt;A&gt; as core::iter::traits::collect::Extend&lt;&lt;A as smallvec::Array&gt;::Item&gt;&gt;::extend
             at /home/user/.local/share/cargo/registry/src/github.com-1ecc6299db9ec823/smallvec-1.8.0/src/lib.rs:1742:36
   7: &lt;smallvec::SmallVec&lt;A&gt; as core::iter::traits::collect::FromIterator&lt;&lt;A as smallvec::Array&gt;::Item&gt;&gt;::from_iter
             at /home/user/.local/share/cargo/registry/src/github.com-1ecc6299db9ec823/smallvec-1.8.0/src/lib.rs:1727:9
   8: core::iter::traits::iterator::Iterator::collect
             at /rustc/a55dd71d5fb0ec5a6a3a9e8c27b2127ba491ce52/library/core/src/iter/traits/iterator.rs:1836:9
   9: cranelift_codegen::egraph::elaborate::Elaborator::process_elab_stack
             at ./cranelift/codegen/src/egraph/elaborate.rs:391:60
  10: cranelift_codegen::egraph::elaborate::Elaborator::elaborate_eclass_use
             at ./cranelift/codegen/src/egraph/elaborate.rs:285:9
  11: cranelift_codegen::egraph::elaborate::Elaborator::elaborate_block
             at ./cranelift/codegen/src/egraph/elaborate.rs:511:13
  12: cranelift_codegen::egraph::elaborate::Elaborator::elaborate_domtree
             at ./cranelift/codegen/src/egraph/elaborate.rs:532:21
  13: cranelift_codegen::egraph::elaborate::Elaborator::elaborate
             at ./cranelift/codegen/src/egraph/elaborate.rs:583:9
  14: cranelift_codegen::egraph::FuncEGraph::elaborate
             at ./cranelift/codegen/src/egraph.rs:348:9
  15: cranelift_codegen::context::Context::optimize
             at ./cranelift/codegen/src/context.rs:203:13
  16: cranelift_codegen::context::Context::compile_stencil
             at ./cranelift/codegen/src/context.rs:149:13
  17: cranelift_codegen::context::Context::compile
             at ./cranelift/codegen/src/context.rs:224:23
  18: cranelift_codegen::context::Context::compile_and_emit
             at ./cranelift/codegen/src/context.rs:132:29
  19: clif_util::compile::handle_module
             at ./cranelift/src/compile.rs:71:33
  20: clif_util::compile::run
             at ./cranelift/src/compile.rs:46:9
  21: clif_util::main
             at ./cranelift/src/clif-util.rs:106:33
  22: core::ops::function::FnOnce::call_once
             at /rustc/a55dd71d5fb0ec5a6a3a9e8c27b2127ba491ce52/library/core/src/ops/function.rs:248:5
note: Some details are omitted, run with `RUST_BACKTRACE=full` for a verbose backtrace.
  </code><br>
&lt;/details&gt;</p>
<p>file reduced from <code>clif</code> of <code>core</code> produced when attempting to compile <code>core</code> with <a href="https://github.com/bjorn3/rustc_codegen_cranelift">https://github.com/bjorn3/rustc_codegen_cranelift</a> patched to use this PR</p>
</blockquote>



<a name="302271024"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%234953%20egraph-based%20midend%3A%20draw%20the%20rest.../near/302271024" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.234953.20egraph-based.20midend.3A.20draw.20the.20rest.2E.2E.2E.html#302271024">(Oct 04 2022 at 14:19)</a>:</h4>
<p>alexcrichton <a href="https://github.com/bytecodealliance/wasmtime/pull/4953#issuecomment-1267082659">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/4953">issue #4953</a>:</p>
<blockquote>
<blockquote>
<p>it's surprising that this fails if all the other builds work fine? </p>
</blockquote>
<p>You'll need to edit <a href="https://github.com/bytecodealliance/wasmtime/blob/c9ff14e00bb0a90905a4f1cc2968c1e3e0417ce5/scripts/publish.rs#L18-L67">this list</a> to include automatic publishing of a new crate.</p>
</blockquote>



<a name="302297950"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%234953%20egraph-based%20midend%3A%20draw%20the%20rest.../near/302297950" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.234953.20egraph-based.20midend.3A.20draw.20the.20rest.2E.2E.2E.html#302297950">(Oct 04 2022 at 16:18)</a>:</h4>
<p>cfallin <a href="https://github.com/bytecodealliance/wasmtime/pull/4953#issuecomment-1267250512">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/4953">issue #4953</a>:</p>
<blockquote>
<blockquote>
<blockquote>
<p>it's surprising that this fails if all the other builds work fine?</p>
</blockquote>
<p>You'll need to edit <a href="https://github.com/bytecodealliance/wasmtime/blob/c9ff14e00bb0a90905a4f1cc2968c1e3e0417ce5/scripts/publish.rs#L18-L67">this list</a> to include automatic publishing of a new crate.</p>
</blockquote>
<p>It’s actually already there, from the earlier PR that introduced the crate (line 28); this seems to be something new related to the workspaces change?</p>
</blockquote>



<a name="302299209"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%234953%20egraph-based%20midend%3A%20draw%20the%20rest.../near/302299209" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.234953.20egraph-based.20midend.3A.20draw.20the.20rest.2E.2E.2E.html#302299209">(Oct 04 2022 at 16:24)</a>:</h4>
<p>alexcrichton <a href="https://github.com/bytecodealliance/wasmtime/pull/4953#issuecomment-1267257205">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/4953">issue #4953</a>:</p>
<blockquote>
<p>Ah I only checked the diff of this PR, the list also needs to be topologically sorted so if <code>cranelift-codegen</code> is picking up a new dep then the list needs to be reordered.</p>
</blockquote>



<a name="302302455"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%234953%20egraph-based%20midend%3A%20draw%20the%20rest.../near/302302455" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.234953.20egraph-based.20midend.3A.20draw.20the.20rest.2E.2E.2E.html#302302455">(Oct 04 2022 at 16:41)</a>:</h4>
<p>cfallin <a href="https://github.com/bytecodealliance/wasmtime/pull/4953#issuecomment-1267276643">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/4953">issue #4953</a>:</p>
<blockquote>
<p>Ah, that makes sense, thanks!</p>
</blockquote>



<a name="302319379"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%234953%20egraph-based%20midend%3A%20draw%20the%20rest.../near/302319379" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.234953.20egraph-based.20midend.3A.20draw.20the.20rest.2E.2E.2E.html#302319379">(Oct 04 2022 at 18:13)</a>:</h4>
<p>cfallin <a href="https://github.com/bytecodealliance/wasmtime/pull/4953#issuecomment-1267374913">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/4953">issue #4953</a>:</p>
<blockquote>
<blockquote>
<p>when setting use_egraphs=true the following error is produced:</p>
<p><code>
thread 'main' panicked at 'enode depends directly on multi-value result', cranelift/codegen/src/egraph/elaborate.rs:396:33
</code></p>
</blockquote>
<p>Fixed, thanks! This was an issue introduced in my non-recursive rewrite of the extraction (best-cost node) procedure's handling of value projections.</p>
</blockquote>



<a name="302341474"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%234953%20egraph-based%20midend%3A%20draw%20the%20rest.../near/302341474" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.234953.20egraph-based.20midend.3A.20draw.20the.20rest.2E.2E.2E.html#302341474">(Oct 04 2022 at 20:29)</a>:</h4>
<p>nivkner <a href="https://github.com/bytecodealliance/wasmtime/pull/4953#issuecomment-1267541924">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/4953">issue #4953</a>:</p>
<blockquote>
<p>the following code compiles without error when setting <code>use_egraphs=false</code> but produces an error when <code>use_egraphs=true</code>:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="n">target</span><span class="w"> </span><span class="n">x86_64</span><span class="w"></span>

<span class="n">function</span><span class="w"> </span><span class="n">u0</span>:<span class="mi">1302</span><span class="p">(</span><span class="kt">i64</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="kt">i64</span> <span class="nc">system_v</span><span class="w"> </span><span class="p">{</span><span class="w"></span>

<span class="w">        </span><span class="n">block0</span><span class="p">(</span><span class="n">v0</span>: <span class="kt">i64</span><span class="p">)</span>:
                <span class="nc">v9</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">atomic_rmw</span><span class="p">.</span><span class="kt">i64</span><span class="w"> </span><span class="n">add</span><span class="w"> </span><span class="n">v0</span><span class="p">,</span><span class="w"> </span><span class="n">v0</span><span class="w"></span>
<span class="w">                </span><span class="k">return</span><span class="w"> </span><span class="n">v0</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>
<p>the error is</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="n">thread</span><span class="w"> </span><span class="o">'</span><span class="na">main</span><span class="o">'</span><span class="w"> </span><span class="n">panicked</span><span class="w"> </span><span class="n">at</span><span class="w"> </span><span class="o">'</span><span class="na">index</span><span class="w"> </span><span class="n">out</span><span class="w"> </span><span class="n">of</span><span class="w"> </span><span class="n">bounds</span>: <span class="nc">the</span><span class="w"> </span><span class="n">len</span><span class="w"> </span><span class="n">is</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="n">but</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">index</span><span class="w"> </span><span class="n">is</span><span class="w"> </span><span class="mi">1</span><span class="o">'</span><span class="p">,</span><span class="w"> </span><span class="o">/</span><span class="n">home</span><span class="o">/</span><span class="n">user</span><span class="o">/</span><span class="n">Documents</span><span class="o">/</span><span class="n">wasmtime</span><span class="o">/</span><span class="n">target</span><span class="o">/</span><span class="n">debug</span><span class="o">/</span><span class="n">build</span><span class="o">/</span><span class="n">cranelift</span><span class="o">-</span><span class="n">codegen</span><span class="o">-</span><span class="n">ae89adb74262e952</span><span class="o">/</span><span class="n">out</span><span class="o">/</span><span class="n">opcodes</span><span class="p">.</span><span class="n">rs</span>:<span class="mi">1979</span>:<span class="mi">39</span><span class="w"></span>
</code></pre></div>
<p>&lt;details&gt;<br>
&lt;summary&gt;backtrace&lt;/summary&gt;</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="n">stack</span><span class="w"> </span><span class="n">backtrace</span>:
   <span class="mi">0</span>: <span class="nc">rust_begin_unwind</span><span class="w"></span>
<span class="w">             </span><span class="n">at</span><span class="w"> </span><span class="o">/</span><span class="n">rustc</span><span class="o">/</span><span class="n">a55dd71d5fb0ec5a6a3a9e8c27b2127ba491ce52</span><span class="o">/</span><span class="n">library</span><span class="o">/</span><span class="n">std</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">panicking</span><span class="p">.</span><span class="n">rs</span>:<span class="mi">584</span>:<span class="mi">5</span><span class="w"></span>
<span class="w">   </span><span class="mi">1</span>: <span class="nc">core</span>::<span class="n">panicking</span>::<span class="n">panic_fmt</span><span class="w"></span>
<span class="w">             </span><span class="n">at</span><span class="w"> </span><span class="o">/</span><span class="n">rustc</span><span class="o">/</span><span class="n">a55dd71d5fb0ec5a6a3a9e8c27b2127ba491ce52</span><span class="o">/</span><span class="n">library</span><span class="o">/</span><span class="n">core</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">panicking</span><span class="p">.</span><span class="n">rs</span>:<span class="mi">142</span>:<span class="mi">14</span><span class="w"></span>
<span class="w">   </span><span class="mi">2</span>: <span class="nc">core</span>::<span class="n">panicking</span>::<span class="n">panic_bounds_check</span><span class="w"></span>
<span class="w">             </span><span class="n">at</span><span class="w"> </span><span class="o">/</span><span class="n">rustc</span><span class="o">/</span><span class="n">a55dd71d5fb0ec5a6a3a9e8c27b2127ba491ce52</span><span class="o">/</span><span class="n">library</span><span class="o">/</span><span class="n">core</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">panicking</span><span class="p">.</span><span class="n">rs</span>:<span class="mi">84</span>:<span class="mi">5</span><span class="w"></span>
<span class="w">   </span><span class="mi">3</span>: <span class="nc">cranelift_codegen</span>::<span class="n">ir</span>::<span class="n">instructions</span>::<span class="n">InstructionImms</span>::<span class="n">with_args</span><span class="w"></span>
<span class="w">             </span><span class="n">at</span><span class="w"> </span><span class="p">.</span><span class="o">/</span><span class="n">target</span><span class="o">/</span><span class="n">debug</span><span class="o">/</span><span class="n">build</span><span class="o">/</span><span class="n">cranelift</span><span class="o">-</span><span class="n">codegen</span><span class="o">-</span><span class="n">ae89adb74262e952</span><span class="o">/</span><span class="n">out</span><span class="o">/</span><span class="n">opcodes</span><span class="p">.</span><span class="n">rs</span>:<span class="mi">1979</span>:<span class="mi">39</span><span class="w"></span>
<span class="w">   </span><span class="mi">4</span>: <span class="nc">cranelift_codegen</span>::<span class="n">egraph</span>::<span class="n">elaborate</span>::<span class="n">Elaborator</span>::<span class="n">add_node</span><span class="w"></span>
<span class="w">             </span><span class="n">at</span><span class="w"> </span><span class="p">.</span><span class="o">/</span><span class="n">cranelift</span><span class="o">/</span><span class="n">codegen</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">egraph</span><span class="o">/</span><span class="n">elaborate</span><span class="p">.</span><span class="n">rs</span>:<span class="mi">197</span>:<span class="mi">17</span><span class="w"></span>
<span class="w">   </span><span class="mi">5</span>: <span class="nc">cranelift_codegen</span>::<span class="n">egraph</span>::<span class="n">elaborate</span>::<span class="n">Elaborator</span>::<span class="n">process_elab_stack</span><span class="w"></span>
<span class="w">             </span><span class="n">at</span><span class="w"> </span><span class="p">.</span><span class="o">/</span><span class="n">cranelift</span><span class="o">/</span><span class="n">codegen</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">egraph</span><span class="o">/</span><span class="n">elaborate</span><span class="p">.</span><span class="n">rs</span>:<span class="mi">445</span>:<span class="mi">35</span><span class="w"></span>
<span class="w">   </span><span class="mi">6</span>: <span class="nc">cranelift_codegen</span>::<span class="n">egraph</span>::<span class="n">elaborate</span>::<span class="n">Elaborator</span>::<span class="n">elaborate_eclass_use</span><span class="w"></span>
<span class="w">             </span><span class="n">at</span><span class="w"> </span><span class="p">.</span><span class="o">/</span><span class="n">cranelift</span><span class="o">/</span><span class="n">codegen</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">egraph</span><span class="o">/</span><span class="n">elaborate</span><span class="p">.</span><span class="n">rs</span>:<span class="mi">285</span>:<span class="mi">9</span><span class="w"></span>
<span class="w">   </span><span class="mi">7</span>: <span class="nc">cranelift_codegen</span>::<span class="n">egraph</span>::<span class="n">elaborate</span>::<span class="n">Elaborator</span>::<span class="n">elaborate_block</span><span class="w"></span>
<span class="w">             </span><span class="n">at</span><span class="w"> </span><span class="p">.</span><span class="o">/</span><span class="n">cranelift</span><span class="o">/</span><span class="n">codegen</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">egraph</span><span class="o">/</span><span class="n">elaborate</span><span class="p">.</span><span class="n">rs</span>:<span class="mi">513</span>:<span class="mi">13</span><span class="w"></span>
<span class="w">   </span><span class="mi">8</span>: <span class="nc">cranelift_codegen</span>::<span class="n">egraph</span>::<span class="n">elaborate</span>::<span class="n">Elaborator</span>::<span class="n">elaborate_domtree</span><span class="w"></span>
<span class="w">             </span><span class="n">at</span><span class="w"> </span><span class="p">.</span><span class="o">/</span><span class="n">cranelift</span><span class="o">/</span><span class="n">codegen</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">egraph</span><span class="o">/</span><span class="n">elaborate</span><span class="p">.</span><span class="n">rs</span>:<span class="mi">534</span>:<span class="mi">21</span><span class="w"></span>
<span class="w">   </span><span class="mi">9</span>: <span class="nc">cranelift_codegen</span>::<span class="n">egraph</span>::<span class="n">elaborate</span>::<span class="n">Elaborator</span>::<span class="n">elaborate</span><span class="w"></span>
<span class="w">             </span><span class="n">at</span><span class="w"> </span><span class="p">.</span><span class="o">/</span><span class="n">cranelift</span><span class="o">/</span><span class="n">codegen</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">egraph</span><span class="o">/</span><span class="n">elaborate</span><span class="p">.</span><span class="n">rs</span>:<span class="mi">585</span>:<span class="mi">9</span><span class="w"></span>
<span class="w">  </span><span class="mi">10</span>: <span class="nc">cranelift_codegen</span>::<span class="n">egraph</span>::<span class="n">FuncEGraph</span>::<span class="n">elaborate</span><span class="w"></span>
<span class="w">             </span><span class="n">at</span><span class="w"> </span><span class="p">.</span><span class="o">/</span><span class="n">cranelift</span><span class="o">/</span><span class="n">codegen</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">egraph</span><span class="p">.</span><span class="n">rs</span>:<span class="mi">348</span>:<span class="mi">9</span><span class="w"></span>
<span class="w">  </span><span class="mi">11</span>: <span class="nc">cranelift_codegen</span>::<span class="n">context</span>::<span class="n">Context</span>::<span class="n">optimize</span><span class="w"></span>
<span class="w">             </span><span class="n">at</span><span class="w"> </span><span class="p">.</span><span class="o">/</span><span class="n">cranelift</span><span class="o">/</span><span class="n">codegen</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">context</span><span class="p">.</span><span class="n">rs</span>:<span class="mi">203</span>:<span class="mi">13</span><span class="w"></span>
<span class="w">  </span><span class="mi">12</span>: <span class="nc">cranelift_codegen</span>::<span class="n">context</span>::<span class="n">Context</span>::<span class="n">compile_stencil</span><span class="w"></span>
<span class="w">             </span><span class="n">at</span><span class="w"> </span><span class="p">.</span><span class="o">/</span><span class="n">cranelift</span><span class="o">/</span><span class="n">codegen</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">context</span><span class="p">.</span><span class="n">rs</span>:<span class="mi">149</span>:<span class="mi">13</span><span class="w"></span>
<span class="w">  </span><span class="mi">13</span>: <span class="nc">cranelift_codegen</span>::<span class="n">context</span>::<span class="n">Context</span>::<span class="n">compile</span><span class="w"></span>
<span class="w">             </span><span class="n">at</span><span class="w"> </span><span class="p">.</span><span class="o">/</span><span class="n">cranelift</span><span class="o">/</span><span class="n">codegen</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">context</span><span class="p">.</span><span class="n">rs</span>:<span class="mi">224</span>:<span class="mi">23</span><span class="w"></span>
<span class="w">  </span><span class="mi">14</span>: <span class="nc">cranelift_codegen</span>::<span class="n">context</span>::<span class="n">Context</span>::<span class="n">compile_and_emit</span><span class="w"></span>
<span class="w">             </span><span class="n">at</span><span class="w"> </span><span class="p">.</span><span class="o">/</span><span class="n">cranelift</span><span class="o">/</span><span class="n">codegen</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">context</span><span class="p">.</span><span class="n">rs</span>:<span class="mi">132</span>:<span class="mi">29</span><span class="w"></span>
<span class="w">  </span><span class="mi">15</span>: <span class="nc">clif_util</span>::<span class="n">compile</span>::<span class="n">handle_module</span><span class="w"></span>
<span class="w">             </span><span class="n">at</span><span class="w"> </span><span class="p">.</span><span class="o">/</span><span class="n">cranelift</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">compile</span><span class="p">.</span><span class="n">rs</span>:<span class="mi">71</span>:<span class="mi">33</span><span class="w"></span>
<span class="w">  </span><span class="mi">16</span>: <span class="nc">clif_util</span>::<span class="n">compile</span>::<span class="n">run</span><span class="w"></span>
<span class="w">             </span><span class="n">at</span><span class="w"> </span><span class="p">.</span><span class="o">/</span><span class="n">cranelift</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">compile</span><span class="p">.</span><span class="n">rs</span>:<span class="mi">46</span>:<span class="mi">9</span><span class="w"></span>
<span class="w">  </span><span class="mi">17</span>: <span class="nc">clif_util</span>::<span class="n">main</span><span class="w"></span>
<span class="w">             </span><span class="n">at</span><span class="w"> </span><span class="p">.</span><span class="o">/</span><span class="n">cranelift</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">clif</span><span class="o">-</span><span class="n">util</span><span class="p">.</span><span class="n">rs</span>:<span class="mi">106</span>:<span class="mi">33</span><span class="w"></span>
<span class="w">  </span><span class="mi">18</span>: <span class="nc">core</span>::<span class="n">ops</span>::<span class="n">function</span>::<span class="nb">FnOnce</span>::<span class="n">call_once</span><span class="w"></span>
<span class="w">             </span><span class="n">at</span><span class="w"> </span><span class="o">/</span><span class="n">rustc</span><span class="o">/</span><span class="n">a55dd71d5fb0ec5a6a3a9e8c27b2127ba491ce52</span><span class="o">/</span><span class="n">library</span><span class="o">/</span><span class="n">core</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">ops</span><span class="o">/</span><span class="n">function</span><span class="p">.</span><span class="n">rs</span>:<span class="mi">248</span>:<span class="mi">5</span><span class="w"></span>
</code></pre></div>
<p>&lt;/details&gt;</p>
</blockquote>



<a name="302341876"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%234953%20egraph-based%20midend%3A%20draw%20the%20rest.../near/302341876" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.234953.20egraph-based.20midend.3A.20draw.20the.20rest.2E.2E.2E.html#302341876">(Oct 04 2022 at 20:32)</a>:</h4>
<p>nivkner edited a <a href="https://github.com/bytecodealliance/wasmtime/pull/4953#issuecomment-1267541924">comment</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/4953">issue #4953</a>:</p>
<blockquote>
<p>the following code compiles without error when setting <code>use_egraphs=false</code> but produces an error when <code>use_egraphs=true</code>:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="n">target</span><span class="w"> </span><span class="n">x86_64</span><span class="w"></span>

<span class="n">function</span><span class="w"> </span><span class="n">u0</span>:<span class="mi">1302</span><span class="p">(</span><span class="kt">i64</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="kt">i64</span> <span class="nc">system_v</span><span class="w"> </span><span class="p">{</span><span class="w"></span>

<span class="w">        </span><span class="n">block0</span><span class="p">(</span><span class="n">v0</span>: <span class="kt">i64</span><span class="p">)</span>:
                <span class="nc">v9</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">atomic_rmw</span><span class="p">.</span><span class="kt">i64</span><span class="w"> </span><span class="n">add</span><span class="w"> </span><span class="n">v0</span><span class="p">,</span><span class="w"> </span><span class="n">v0</span><span class="w"></span>
<span class="w">                </span><span class="k">return</span><span class="w"> </span><span class="n">v0</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>
<p>the error is</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="n">thread</span><span class="w"> </span><span class="o">'</span><span class="na">main</span><span class="o">'</span><span class="w"> </span><span class="n">panicked</span><span class="w"> </span><span class="n">at</span><span class="w"> </span><span class="o">'</span><span class="na">index</span><span class="w"> </span><span class="n">out</span><span class="w"> </span><span class="n">of</span><span class="w"> </span><span class="n">bounds</span>: <span class="nc">the</span><span class="w"> </span><span class="n">len</span><span class="w"> </span><span class="n">is</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="n">but</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">index</span><span class="w"> </span><span class="n">is</span><span class="w"> </span><span class="mi">1</span><span class="o">'</span><span class="p">,</span><span class="w"> </span><span class="o">/</span><span class="n">home</span><span class="o">/</span><span class="n">user</span><span class="o">/</span><span class="n">Documents</span><span class="o">/</span><span class="n">wasmtime</span><span class="o">/</span><span class="n">target</span><span class="o">/</span><span class="n">debug</span><span class="o">/</span><span class="n">build</span><span class="o">/</span><span class="n">cranelift</span><span class="o">-</span><span class="n">codegen</span><span class="o">-</span><span class="n">ae89adb74262e952</span><span class="o">/</span><span class="n">out</span><span class="o">/</span><span class="n">opcodes</span><span class="p">.</span><span class="n">rs</span>:<span class="mi">1979</span>:<span class="mi">39</span><span class="w"></span>
</code></pre></div>
<p>&lt;details&gt;<br>
&lt;summary&gt;backtrace&lt;/summary&gt;</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="n">stack</span><span class="w"> </span><span class="n">backtrace</span>:
   <span class="mi">0</span>: <span class="nc">rust_begin_unwind</span><span class="w"></span>
<span class="w">             </span><span class="n">at</span><span class="w"> </span><span class="o">/</span><span class="n">rustc</span><span class="o">/</span><span class="n">a55dd71d5fb0ec5a6a3a9e8c27b2127ba491ce52</span><span class="o">/</span><span class="n">library</span><span class="o">/</span><span class="n">std</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">panicking</span><span class="p">.</span><span class="n">rs</span>:<span class="mi">584</span>:<span class="mi">5</span><span class="w"></span>
<span class="w">   </span><span class="mi">1</span>: <span class="nc">core</span>::<span class="n">panicking</span>::<span class="n">panic_fmt</span><span class="w"></span>
<span class="w">             </span><span class="n">at</span><span class="w"> </span><span class="o">/</span><span class="n">rustc</span><span class="o">/</span><span class="n">a55dd71d5fb0ec5a6a3a9e8c27b2127ba491ce52</span><span class="o">/</span><span class="n">library</span><span class="o">/</span><span class="n">core</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">panicking</span><span class="p">.</span><span class="n">rs</span>:<span class="mi">142</span>:<span class="mi">14</span><span class="w"></span>
<span class="w">   </span><span class="mi">2</span>: <span class="nc">core</span>::<span class="n">panicking</span>::<span class="n">panic_bounds_check</span><span class="w"></span>
<span class="w">             </span><span class="n">at</span><span class="w"> </span><span class="o">/</span><span class="n">rustc</span><span class="o">/</span><span class="n">a55dd71d5fb0ec5a6a3a9e8c27b2127ba491ce52</span><span class="o">/</span><span class="n">library</span><span class="o">/</span><span class="n">core</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">panicking</span><span class="p">.</span><span class="n">rs</span>:<span class="mi">84</span>:<span class="mi">5</span><span class="w"></span>
<span class="w">   </span><span class="mi">3</span>: <span class="nc">cranelift_codegen</span>::<span class="n">ir</span>::<span class="n">instructions</span>::<span class="n">InstructionImms</span>::<span class="n">with_args</span><span class="w"></span>
<span class="w">             </span><span class="n">at</span><span class="w"> </span><span class="p">.</span><span class="o">/</span><span class="n">target</span><span class="o">/</span><span class="n">debug</span><span class="o">/</span><span class="n">build</span><span class="o">/</span><span class="n">cranelift</span><span class="o">-</span><span class="n">codegen</span><span class="o">-</span><span class="n">ae89adb74262e952</span><span class="o">/</span><span class="n">out</span><span class="o">/</span><span class="n">opcodes</span><span class="p">.</span><span class="n">rs</span>:<span class="mi">1979</span>:<span class="mi">39</span><span class="w"></span>
<span class="w">   </span><span class="mi">4</span>: <span class="nc">cranelift_codegen</span>::<span class="n">egraph</span>::<span class="n">elaborate</span>::<span class="n">Elaborator</span>::<span class="n">add_node</span><span class="w"></span>
<span class="w">             </span><span class="n">at</span><span class="w"> </span><span class="p">.</span><span class="o">/</span><span class="n">cranelift</span><span class="o">/</span><span class="n">codegen</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">egraph</span><span class="o">/</span><span class="n">elaborate</span><span class="p">.</span><span class="n">rs</span>:<span class="mi">197</span>:<span class="mi">17</span><span class="w"></span>
<span class="w">   </span><span class="mi">5</span>: <span class="nc">cranelift_codegen</span>::<span class="n">egraph</span>::<span class="n">elaborate</span>::<span class="n">Elaborator</span>::<span class="n">process_elab_stack</span><span class="w"></span>
<span class="w">             </span><span class="n">at</span><span class="w"> </span><span class="p">.</span><span class="o">/</span><span class="n">cranelift</span><span class="o">/</span><span class="n">codegen</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">egraph</span><span class="o">/</span><span class="n">elaborate</span><span class="p">.</span><span class="n">rs</span>:<span class="mi">445</span>:<span class="mi">35</span><span class="w"></span>
<span class="w">   </span><span class="mi">6</span>: <span class="nc">cranelift_codegen</span>::<span class="n">egraph</span>::<span class="n">elaborate</span>::<span class="n">Elaborator</span>::<span class="n">elaborate_eclass_use</span><span class="w"></span>
<span class="w">             </span><span class="n">at</span><span class="w"> </span><span class="p">.</span><span class="o">/</span><span class="n">cranelift</span><span class="o">/</span><span class="n">codegen</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">egraph</span><span class="o">/</span><span class="n">elaborate</span><span class="p">.</span><span class="n">rs</span>:<span class="mi">285</span>:<span class="mi">9</span><span class="w"></span>
<span class="w">   </span><span class="mi">7</span>: <span class="nc">cranelift_codegen</span>::<span class="n">egraph</span>::<span class="n">elaborate</span>::<span class="n">Elaborator</span>::<span class="n">elaborate_block</span><span class="w"></span>
<span class="w">             </span><span class="n">at</span><span class="w"> </span><span class="p">.</span><span class="o">/</span><span class="n">cranelift</span><span class="o">/</span><span class="n">codegen</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">egraph</span><span class="o">/</span><span class="n">elaborate</span><span class="p">.</span><span class="n">rs</span>:<span class="mi">513</span>:<span class="mi">13</span><span class="w"></span>
<span class="w">   </span><span class="mi">8</span>: <span class="nc">cranelift_codegen</span>::<span class="n">egraph</span>::<span class="n">elaborate</span>::<span class="n">Elaborator</span>::<span class="n">elaborate_domtree</span><span class="w"></span>
<span class="w">             </span><span class="n">at</span><span class="w"> </span><span class="p">.</span><span class="o">/</span><span class="n">cranelift</span><span class="o">/</span><span class="n">codegen</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">egraph</span><span class="o">/</span><span class="n">elaborate</span><span class="p">.</span><span class="n">rs</span>:<span class="mi">534</span>:<span class="mi">21</span><span class="w"></span>
<span class="w">   </span><span class="mi">9</span>: <span class="nc">cranelift_codegen</span>::<span class="n">egraph</span>::<span class="n">elaborate</span>::<span class="n">Elaborator</span>::<span class="n">elaborate</span><span class="w"></span>
<span class="w">             </span><span class="n">at</span><span class="w"> </span><span class="p">.</span><span class="o">/</span><span class="n">cranelift</span><span class="o">/</span><span class="n">codegen</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">egraph</span><span class="o">/</span><span class="n">elaborate</span><span class="p">.</span><span class="n">rs</span>:<span class="mi">585</span>:<span class="mi">9</span><span class="w"></span>
<span class="w">  </span><span class="mi">10</span>: <span class="nc">cranelift_codegen</span>::<span class="n">egraph</span>::<span class="n">FuncEGraph</span>::<span class="n">elaborate</span><span class="w"></span>
<span class="w">             </span><span class="n">at</span><span class="w"> </span><span class="p">.</span><span class="o">/</span><span class="n">cranelift</span><span class="o">/</span><span class="n">codegen</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">egraph</span><span class="p">.</span><span class="n">rs</span>:<span class="mi">348</span>:<span class="mi">9</span><span class="w"></span>
<span class="w">  </span><span class="mi">11</span>: <span class="nc">cranelift_codegen</span>::<span class="n">context</span>::<span class="n">Context</span>::<span class="n">optimize</span><span class="w"></span>
<span class="w">             </span><span class="n">at</span><span class="w"> </span><span class="p">.</span><span class="o">/</span><span class="n">cranelift</span><span class="o">/</span><span class="n">codegen</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">context</span><span class="p">.</span><span class="n">rs</span>:<span class="mi">203</span>:<span class="mi">13</span><span class="w"></span>
<span class="w">  </span><span class="mi">12</span>: <span class="nc">cranelift_codegen</span>::<span class="n">context</span>::<span class="n">Context</span>::<span class="n">compile_stencil</span><span class="w"></span>
<span class="w">             </span><span class="n">at</span><span class="w"> </span><span class="p">.</span><span class="o">/</span><span class="n">cranelift</span><span class="o">/</span><span class="n">codegen</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">context</span><span class="p">.</span><span class="n">rs</span>:<span class="mi">149</span>:<span class="mi">13</span><span class="w"></span>
<span class="w">  </span><span class="mi">13</span>: <span class="nc">cranelift_codegen</span>::<span class="n">context</span>::<span class="n">Context</span>::<span class="n">compile</span><span class="w"></span>
<span class="w">             </span><span class="n">at</span><span class="w"> </span><span class="p">.</span><span class="o">/</span><span class="n">cranelift</span><span class="o">/</span><span class="n">codegen</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">context</span><span class="p">.</span><span class="n">rs</span>:<span class="mi">224</span>:<span class="mi">23</span><span class="w"></span>
<span class="w">  </span><span class="mi">14</span>: <span class="nc">cranelift_codegen</span>::<span class="n">context</span>::<span class="n">Context</span>::<span class="n">compile_and_emit</span><span class="w"></span>
<span class="w">             </span><span class="n">at</span><span class="w"> </span><span class="p">.</span><span class="o">/</span><span class="n">cranelift</span><span class="o">/</span><span class="n">codegen</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">context</span><span class="p">.</span><span class="n">rs</span>:<span class="mi">132</span>:<span class="mi">29</span><span class="w"></span>
<span class="w">  </span><span class="mi">15</span>: <span class="nc">clif_util</span>::<span class="n">compile</span>::<span class="n">handle_module</span><span class="w"></span>
<span class="w">             </span><span class="n">at</span><span class="w"> </span><span class="p">.</span><span class="o">/</span><span class="n">cranelift</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">compile</span><span class="p">.</span><span class="n">rs</span>:<span class="mi">71</span>:<span class="mi">33</span><span class="w"></span>
<span class="w">  </span><span class="mi">16</span>: <span class="nc">clif_util</span>::<span class="n">compile</span>::<span class="n">run</span><span class="w"></span>
<span class="w">             </span><span class="n">at</span><span class="w"> </span><span class="p">.</span><span class="o">/</span><span class="n">cranelift</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">compile</span><span class="p">.</span><span class="n">rs</span>:<span class="mi">46</span>:<span class="mi">9</span><span class="w"></span>
<span class="w">  </span><span class="mi">17</span>: <span class="nc">clif_util</span>::<span class="n">main</span><span class="w"></span>
<span class="w">             </span><span class="n">at</span><span class="w"> </span><span class="p">.</span><span class="o">/</span><span class="n">cranelift</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">clif</span><span class="o">-</span><span class="n">util</span><span class="p">.</span><span class="n">rs</span>:<span class="mi">106</span>:<span class="mi">33</span><span class="w"></span>
<span class="w">  </span><span class="mi">18</span>: <span class="nc">core</span>::<span class="n">ops</span>::<span class="n">function</span>::<span class="nb">FnOnce</span>::<span class="n">call_once</span><span class="w"></span>
<span class="w">             </span><span class="n">at</span><span class="w"> </span><span class="o">/</span><span class="n">rustc</span><span class="o">/</span><span class="n">a55dd71d5fb0ec5a6a3a9e8c27b2127ba491ce52</span><span class="o">/</span><span class="n">library</span><span class="o">/</span><span class="n">core</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">ops</span><span class="o">/</span><span class="n">function</span><span class="p">.</span><span class="n">rs</span>:<span class="mi">248</span>:<span class="mi">5</span><span class="w"></span>
</code></pre></div>
<p>&lt;/details&gt;</p>
</blockquote>



<a name="302342032"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%234953%20egraph-based%20midend%3A%20draw%20the%20rest.../near/302342032" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.234953.20egraph-based.20midend.3A.20draw.20the.20rest.2E.2E.2E.html#302342032">(Oct 04 2022 at 20:33)</a>:</h4>
<p>nivkner edited a <a href="https://github.com/bytecodealliance/wasmtime/pull/4953#issuecomment-1267541924">comment</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/4953">issue #4953</a>:</p>
<blockquote>
<p>the following code compiles without error when setting <code>use_egraphs=false</code> but produces an error when <code>use_egraphs=true</code>:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="n">target</span><span class="w"> </span><span class="n">x86_64</span><span class="w"></span>

<span class="n">function</span><span class="w"> </span><span class="n">u0</span>:<span class="mi">1302</span><span class="p">(</span><span class="kt">i64</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="kt">i64</span> <span class="nc">system_v</span><span class="w"> </span><span class="p">{</span><span class="w"></span>

<span class="w">        </span><span class="n">block0</span><span class="p">(</span><span class="n">v0</span>: <span class="kt">i64</span><span class="p">)</span>:
                <span class="nc">v9</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">atomic_rmw</span><span class="p">.</span><span class="kt">i64</span><span class="w"> </span><span class="n">add</span><span class="w"> </span><span class="n">v0</span><span class="p">,</span><span class="w"> </span><span class="n">v0</span><span class="w"></span>
<span class="w">                </span><span class="k">return</span><span class="w"> </span><span class="n">v0</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>
<p>the error is</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="n">thread</span><span class="w"> </span><span class="o">'</span><span class="na">main</span><span class="o">'</span><span class="w"> </span><span class="n">panicked</span><span class="w"> </span><span class="n">at</span><span class="w"> </span><span class="o">'</span><span class="na">index</span><span class="w"> </span><span class="n">out</span><span class="w"> </span><span class="n">of</span><span class="w"> </span><span class="n">bounds</span>: <span class="nc">the</span><span class="w"> </span><span class="n">len</span><span class="w"> </span><span class="n">is</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="n">but</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">index</span><span class="w"> </span><span class="n">is</span><span class="w"> </span><span class="mi">1</span><span class="o">'</span><span class="p">,</span><span class="w"> </span><span class="o">/</span><span class="n">home</span><span class="o">/</span><span class="n">user</span><span class="o">/</span><span class="n">Documents</span><span class="o">/</span><span class="n">wasmtime</span><span class="o">/</span><span class="n">target</span><span class="o">/</span><span class="n">debug</span><span class="o">/</span><span class="n">build</span><span class="o">/</span><span class="n">cranelift</span><span class="o">-</span><span class="n">codegen</span><span class="o">-</span><span class="n">ae89adb74262e952</span><span class="o">/</span><span class="n">out</span><span class="o">/</span><span class="n">opcodes</span><span class="p">.</span><span class="n">rs</span>:<span class="mi">1979</span>:<span class="mi">39</span><span class="w"></span>
</code></pre></div>
<p>&lt;details&gt;<br>
&lt;summary&gt;backtrace&lt;/summary&gt;</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="n">stack</span><span class="w"> </span><span class="n">backtrace</span>:
   <span class="mi">0</span>: <span class="nc">rust_begin_unwind</span><span class="w"></span>
<span class="w">             </span><span class="n">at</span><span class="w"> </span><span class="o">/</span><span class="n">rustc</span><span class="o">/</span><span class="n">a55dd71d5fb0ec5a6a3a9e8c27b2127ba491ce52</span><span class="o">/</span><span class="n">library</span><span class="o">/</span><span class="n">std</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">panicking</span><span class="p">.</span><span class="n">rs</span>:<span class="mi">584</span>:<span class="mi">5</span><span class="w"></span>
<span class="w">   </span><span class="mi">1</span>: <span class="nc">core</span>::<span class="n">panicking</span>::<span class="n">panic_fmt</span><span class="w"></span>
<span class="w">             </span><span class="n">at</span><span class="w"> </span><span class="o">/</span><span class="n">rustc</span><span class="o">/</span><span class="n">a55dd71d5fb0ec5a6a3a9e8c27b2127ba491ce52</span><span class="o">/</span><span class="n">library</span><span class="o">/</span><span class="n">core</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">panicking</span><span class="p">.</span><span class="n">rs</span>:<span class="mi">142</span>:<span class="mi">14</span><span class="w"></span>
<span class="w">   </span><span class="mi">2</span>: <span class="nc">core</span>::<span class="n">panicking</span>::<span class="n">panic_bounds_check</span><span class="w"></span>
<span class="w">             </span><span class="n">at</span><span class="w"> </span><span class="o">/</span><span class="n">rustc</span><span class="o">/</span><span class="n">a55dd71d5fb0ec5a6a3a9e8c27b2127ba491ce52</span><span class="o">/</span><span class="n">library</span><span class="o">/</span><span class="n">core</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">panicking</span><span class="p">.</span><span class="n">rs</span>:<span class="mi">84</span>:<span class="mi">5</span><span class="w"></span>
<span class="w">   </span><span class="mi">3</span>: <span class="nc">cranelift_codegen</span>::<span class="n">ir</span>::<span class="n">instructions</span>::<span class="n">InstructionImms</span>::<span class="n">with_args</span><span class="w"></span>
<span class="w">             </span><span class="n">at</span><span class="w"> </span><span class="p">.</span><span class="o">/</span><span class="n">target</span><span class="o">/</span><span class="n">debug</span><span class="o">/</span><span class="n">build</span><span class="o">/</span><span class="n">cranelift</span><span class="o">-</span><span class="n">codegen</span><span class="o">-</span><span class="n">ae89adb74262e952</span><span class="o">/</span><span class="n">out</span><span class="o">/</span><span class="n">opcodes</span><span class="p">.</span><span class="n">rs</span>:<span class="mi">1979</span>:<span class="mi">39</span><span class="w"></span>
<span class="w">   </span><span class="mi">4</span>: <span class="nc">cranelift_codegen</span>::<span class="n">egraph</span>::<span class="n">elaborate</span>::<span class="n">Elaborator</span>::<span class="n">add_node</span><span class="w"></span>
<span class="w">             </span><span class="n">at</span><span class="w"> </span><span class="p">.</span><span class="o">/</span><span class="n">cranelift</span><span class="o">/</span><span class="n">codegen</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">egraph</span><span class="o">/</span><span class="n">elaborate</span><span class="p">.</span><span class="n">rs</span>:<span class="mi">197</span>:<span class="mi">17</span><span class="w"></span>
<span class="w">   </span><span class="mi">5</span>: <span class="nc">cranelift_codegen</span>::<span class="n">egraph</span>::<span class="n">elaborate</span>::<span class="n">Elaborator</span>::<span class="n">process_elab_stack</span><span class="w"></span>
<span class="w">             </span><span class="n">at</span><span class="w"> </span><span class="p">.</span><span class="o">/</span><span class="n">cranelift</span><span class="o">/</span><span class="n">codegen</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">egraph</span><span class="o">/</span><span class="n">elaborate</span><span class="p">.</span><span class="n">rs</span>:<span class="mi">445</span>:<span class="mi">35</span><span class="w"></span>
<span class="w">   </span><span class="mi">6</span>: <span class="nc">cranelift_codegen</span>::<span class="n">egraph</span>::<span class="n">elaborate</span>::<span class="n">Elaborator</span>::<span class="n">elaborate_eclass_use</span><span class="w"></span>
<span class="w">             </span><span class="n">at</span><span class="w"> </span><span class="p">.</span><span class="o">/</span><span class="n">cranelift</span><span class="o">/</span><span class="n">codegen</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">egraph</span><span class="o">/</span><span class="n">elaborate</span><span class="p">.</span><span class="n">rs</span>:<span class="mi">285</span>:<span class="mi">9</span><span class="w"></span>
<span class="w">   </span><span class="mi">7</span>: <span class="nc">cranelift_codegen</span>::<span class="n">egraph</span>::<span class="n">elaborate</span>::<span class="n">Elaborator</span>::<span class="n">elaborate_block</span><span class="w"></span>
<span class="w">             </span><span class="n">at</span><span class="w"> </span><span class="p">.</span><span class="o">/</span><span class="n">cranelift</span><span class="o">/</span><span class="n">codegen</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">egraph</span><span class="o">/</span><span class="n">elaborate</span><span class="p">.</span><span class="n">rs</span>:<span class="mi">513</span>:<span class="mi">13</span><span class="w"></span>
<span class="w">   </span><span class="mi">8</span>: <span class="nc">cranelift_codegen</span>::<span class="n">egraph</span>::<span class="n">elaborate</span>::<span class="n">Elaborator</span>::<span class="n">elaborate_domtree</span><span class="w"></span>
<span class="w">             </span><span class="n">at</span><span class="w"> </span><span class="p">.</span><span class="o">/</span><span class="n">cranelift</span><span class="o">/</span><span class="n">codegen</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">egraph</span><span class="o">/</span><span class="n">elaborate</span><span class="p">.</span><span class="n">rs</span>:<span class="mi">534</span>:<span class="mi">21</span><span class="w"></span>
<span class="w">   </span><span class="mi">9</span>: <span class="nc">cranelift_codegen</span>::<span class="n">egraph</span>::<span class="n">elaborate</span>::<span class="n">Elaborator</span>::<span class="n">elaborate</span><span class="w"></span>
<span class="w">             </span><span class="n">at</span><span class="w"> </span><span class="p">.</span><span class="o">/</span><span class="n">cranelift</span><span class="o">/</span><span class="n">codegen</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">egraph</span><span class="o">/</span><span class="n">elaborate</span><span class="p">.</span><span class="n">rs</span>:<span class="mi">585</span>:<span class="mi">9</span><span class="w"></span>
<span class="w">  </span><span class="mi">10</span>: <span class="nc">cranelift_codegen</span>::<span class="n">egraph</span>::<span class="n">FuncEGraph</span>::<span class="n">elaborate</span><span class="w"></span>
<span class="w">             </span><span class="n">at</span><span class="w"> </span><span class="p">.</span><span class="o">/</span><span class="n">cranelift</span><span class="o">/</span><span class="n">codegen</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">egraph</span><span class="p">.</span><span class="n">rs</span>:<span class="mi">348</span>:<span class="mi">9</span><span class="w"></span>
<span class="w">  </span><span class="mi">11</span>: <span class="nc">cranelift_codegen</span>::<span class="n">context</span>::<span class="n">Context</span>::<span class="n">optimize</span><span class="w"></span>
<span class="w">             </span><span class="n">at</span><span class="w"> </span><span class="p">.</span><span class="o">/</span><span class="n">cranelift</span><span class="o">/</span><span class="n">codegen</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">context</span><span class="p">.</span><span class="n">rs</span>:<span class="mi">203</span>:<span class="mi">13</span><span class="w"></span>
<span class="w">  </span><span class="mi">12</span>: <span class="nc">cranelift_codegen</span>::<span class="n">context</span>::<span class="n">Context</span>::<span class="n">compile_stencil</span><span class="w"></span>
<span class="w">             </span><span class="n">at</span><span class="w"> </span><span class="p">.</span><span class="o">/</span><span class="n">cranelift</span><span class="o">/</span><span class="n">codegen</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">context</span><span class="p">.</span><span class="n">rs</span>:<span class="mi">149</span>:<span class="mi">13</span><span class="w"></span>
<span class="w">  </span><span class="mi">13</span>: <span class="nc">cranelift_codegen</span>::<span class="n">context</span>::<span class="n">Context</span>::<span class="n">compile</span><span class="w"></span>
<span class="w">             </span><span class="n">at</span><span class="w"> </span><span class="p">.</span><span class="o">/</span><span class="n">cranelift</span><span class="o">/</span><span class="n">codegen</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">context</span><span class="p">.</span><span class="n">rs</span>:<span class="mi">224</span>:<span class="mi">23</span><span class="w"></span>
<span class="w">  </span><span class="mi">14</span>: <span class="nc">cranelift_codegen</span>::<span class="n">context</span>::<span class="n">Context</span>::<span class="n">compile_and_emit</span><span class="w"></span>
<span class="w">             </span><span class="n">at</span><span class="w"> </span><span class="p">.</span><span class="o">/</span><span class="n">cranelift</span><span class="o">/</span><span class="n">codegen</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">context</span><span class="p">.</span><span class="n">rs</span>:<span class="mi">132</span>:<span class="mi">29</span><span class="w"></span>
<span class="w">  </span><span class="mi">15</span>: <span class="nc">clif_util</span>::<span class="n">compile</span>::<span class="n">handle_module</span><span class="w"></span>
<span class="w">             </span><span class="n">at</span><span class="w"> </span><span class="p">.</span><span class="o">/</span><span class="n">cranelift</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">compile</span><span class="p">.</span><span class="n">rs</span>:<span class="mi">71</span>:<span class="mi">33</span><span class="w"></span>
<span class="w">  </span><span class="mi">16</span>: <span class="nc">clif_util</span>::<span class="n">compile</span>::<span class="n">run</span><span class="w"></span>
<span class="w">             </span><span class="n">at</span><span class="w"> </span><span class="p">.</span><span class="o">/</span><span class="n">cranelift</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">compile</span><span class="p">.</span><span class="n">rs</span>:<span class="mi">46</span>:<span class="mi">9</span><span class="w"></span>
<span class="w">  </span><span class="mi">17</span>: <span class="nc">clif_util</span>::<span class="n">main</span><span class="w"></span>
<span class="w">             </span><span class="n">at</span><span class="w"> </span><span class="p">.</span><span class="o">/</span><span class="n">cranelift</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">clif</span><span class="o">-</span><span class="n">util</span><span class="p">.</span><span class="n">rs</span>:<span class="mi">106</span>:<span class="mi">33</span><span class="w"></span>
<span class="w">  </span><span class="mi">18</span>: <span class="nc">core</span>::<span class="n">ops</span>::<span class="n">function</span>::<span class="nb">FnOnce</span>::<span class="n">call_once</span><span class="w"></span>
<span class="w">             </span><span class="n">at</span><span class="w"> </span><span class="o">/</span><span class="n">rustc</span><span class="o">/</span><span class="n">a55dd71d5fb0ec5a6a3a9e8c27b2127ba491ce52</span><span class="o">/</span><span class="n">library</span><span class="o">/</span><span class="n">core</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">ops</span><span class="o">/</span><span class="n">function</span><span class="p">.</span><span class="n">rs</span>:<span class="mi">248</span>:<span class="mi">5</span><span class="w"></span>
</code></pre></div>
<p>&lt;/details&gt;</p>
<p>also reduced from <code>rustc_codegen_cranelift</code> output</p>
</blockquote>



<a name="302350703"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%234953%20egraph-based%20midend%3A%20draw%20the%20rest.../near/302350703" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.234953.20egraph-based.20midend.3A.20draw.20the.20rest.2E.2E.2E.html#302350703">(Oct 04 2022 at 21:31)</a>:</h4>
<p>cfallin <a href="https://github.com/bytecodealliance/wasmtime/pull/4953#issuecomment-1267600329">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/4953">issue #4953</a>:</p>
<blockquote>
<blockquote>
<p>the following code compiles without error when setting use_egraphs=false but produces an error when use_egraphs=true:</p>
</blockquote>
<p>Thanks! Fixed now -- atomic ops were incorrectly being handled as ordinary loads by the alias-analysis machinery in egraph optimization.</p>
</blockquote>



<a name="302745154"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%234953%20egraph-based%20midend%3A%20draw%20the%20rest.../near/302745154" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.234953.20egraph-based.20midend.3A.20draw.20the.20rest.2E.2E.2E.html#302745154">(Oct 06 2022 at 21:35)</a>:</h4>
<p>cfallin <a href="https://github.com/bytecodealliance/wasmtime/pull/4953#issuecomment-1270723215">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/4953">issue #4953</a>:</p>
<blockquote>
<p>Thanks @jameysharp! I've addressed your comments so far and merged the latest <code>main</code> in again (including resolving overlaps in the current mid-end rules, as overlap checking is now on by default). Happy to address any other comments as you have them.</p>
</blockquote>



<a name="302765309"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%234953%20egraph-based%20midend%3A%20draw%20the%20rest.../near/302765309" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.234953.20egraph-based.20midend.3A.20draw.20the.20rest.2E.2E.2E.html#302765309">(Oct 07 2022 at 00:51)</a>:</h4>
<p>nivkner <a href="https://github.com/bytecodealliance/wasmtime/pull/4953#issuecomment-1270935417">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/4953">issue #4953</a>:</p>
<blockquote>
<p>when modifying <a href="https://github.com/bjorn3/rustc_codegen_cranelift">https://github.com/bjorn3/rustc_codegen_cranelift</a> to use this PR, and running the tests of <code>rand_chacha</code> using <code>cargo-clif</code> as described in the <code>rustc_codegen_cranelift</code> repo,<br>
without this PR all the tests pass, with this PR <code>test_chacha_true_values_c</code> fails.</p>
</blockquote>



<a name="302772338"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%234953%20egraph-based%20midend%3A%20draw%20the%20rest.../near/302772338" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.234953.20egraph-based.20midend.3A.20draw.20the.20rest.2E.2E.2E.html#302772338">(Oct 07 2022 at 02:30)</a>:</h4>
<p>cfallin <a href="https://github.com/bytecodealliance/wasmtime/pull/4953#issuecomment-1271030659">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/4953">issue #4953</a>:</p>
<blockquote>
<blockquote>
<p>when modifying <a href="https://github.com/bjorn3/rustc_codegen_cranelift">https://github.com/bjorn3/rustc_codegen_cranelift</a> to use this PR, and running the tests of <code>rand_chacha</code> using <code>cargo-clif</code> as described in the <code>rustc_codegen_cranelift</code> repo,<br>
without this PR all the tests pass, with this PR <code>test_chacha_true_values_c</code> fails.</p>
</blockquote>
<p>Could you see if you can minimize this to a CLIF file? Or at least, provide more details on the failure?</p>
<p>Reports from out-of-repo users are absolutely valuable, but are hard to act upon: generally we should strive for development of Cranelift to require only the Cranelift repo, and if failures are seen only outside of the repo, that means we need more tests in-repo. We definitely should not have to create a cg\_clif development setup to chase down bugs. If/when a bug report with sufficient detail exists, we can work through it.</p>
<p>Thank you for trying this out, though.</p>
</blockquote>



<a name="302900075"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%234953%20egraph-based%20midend%3A%20draw%20the%20rest.../near/302900075" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.234953.20egraph-based.20midend.3A.20draw.20the.20rest.2E.2E.2E.html#302900075">(Oct 07 2022 at 17:24)</a>:</h4>
<p>cfallin <a href="https://github.com/bytecodealliance/wasmtime/pull/4953#issuecomment-1271856599">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/4953">issue #4953</a>:</p>
<blockquote>
<p>@jameysharp I've addressed everything except for the one open thread above; thanks!</p>
</blockquote>



<a name="302950284"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%234953%20egraph-based%20midend%3A%20draw%20the%20rest.../near/302950284" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.234953.20egraph-based.20midend.3A.20draw.20the.20rest.2E.2E.2E.html#302950284">(Oct 07 2022 at 23:57)</a>:</h4>
<p>cfallin <a href="https://github.com/bytecodealliance/wasmtime/pull/4953#issuecomment-1272167766">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/4953">issue #4953</a>:</p>
<blockquote>
<p>Just merged in <code>main</code> once more. Hopefully that's the last merge from <code>main</code> into this PR, if all goes well :-) @jameysharp I'm eagerly awaiting any more comments you have!</p>
</blockquote>



<a name="302994391"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%234953%20egraph-based%20midend%3A%20draw%20the%20rest.../near/302994391" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.234953.20egraph-based.20midend.3A.20draw.20the.20rest.2E.2E.2E.html#302994391">(Oct 08 2022 at 10:23)</a>:</h4>
<p>nivkner edited a <a href="https://github.com/bytecodealliance/wasmtime/pull/4953#issuecomment-1270935417">comment</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/4953">issue #4953</a>:</p>
<blockquote>
<p>when modifying <a href="https://github.com/bjorn3/rustc_codegen_cranelift">https://github.com/bjorn3/rustc_codegen_cranelift</a> to use this PR, and running the tests of <code>rand_chacha</code> using <code>cargo-clif</code> as described in the <code>rustc_codegen_cranelift</code> repo,<br>
without this PR all the tests pass, with this PR <code>test_chacha_true_values_c</code> fails.</p>
<p>EDIT: unable to reproduce the above bug as of e992197b405b8976094b26489955e271379fcda3.</p>
</blockquote>



<a name="303319058"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%234953%20egraph-based%20midend%3A%20draw%20the%20rest.../near/303319058" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.234953.20egraph-based.20midend.3A.20draw.20the.20rest.2E.2E.2E.html#303319058">(Oct 10 2022 at 20:03)</a>:</h4>
<p>bjorn3 <a href="https://github.com/bytecodealliance/wasmtime/pull/4953#issuecomment-1273754408">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/4953">issue #4953</a>:</p>
<blockquote>
<p>To be clear this doesn't change anything if the respective setting isn't explicitly enabled? If it does change things I would like to test it with cg_clif first tomorrow.</p>
</blockquote>



<a name="303319256"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%234953%20egraph-based%20midend%3A%20draw%20the%20rest.../near/303319256" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.234953.20egraph-based.20midend.3A.20draw.20the.20rest.2E.2E.2E.html#303319256">(Oct 10 2022 at 20:05)</a>:</h4>
<p>cfallin <a href="https://github.com/bytecodealliance/wasmtime/pull/4953#issuecomment-1273756082">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/4953">issue #4953</a>:</p>
<blockquote>
<blockquote>
<p>To be clear this doesn't change anything if the respective setting isn't explicitly enabled? If it does change things I would like to test it with cg_clif first tomorrow.</p>
</blockquote>
<p>Yes, there is no change by default; the option has to be specifically enabled. At some later point we'll want to turn it on by default but only after it's tested and mature.</p>
</blockquote>



<a name="303361387"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%234953%20egraph-based%20midend%3A%20draw%20the%20rest.../near/303361387" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.234953.20egraph-based.20midend.3A.20draw.20the.20rest.2E.2E.2E.html#303361387">(Oct 11 2022 at 05:20)</a>:</h4>
<p>cfallin <a href="https://github.com/bytecodealliance/wasmtime/pull/4953#issuecomment-1274101634">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/4953">issue #4953</a>:</p>
<blockquote>
<blockquote>
<p>Have you measured the performance impact of this PR with egraphs disabled? I see that ScopedHashMap is used by simple_gvn, which I was recently noticing takes a non-trivial amount of time. It looks to me like the ScopedHashMap changes should make some operations faster, so it could be an improvement, but it would be nice to check that it's not a regression.</p>
</blockquote>
<p>I did earlier on, and testing again just now with SpiderMonkey.wasm, I see, uh... a 6% speedup?</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="n">cfallin</span><span class="o">@</span><span class="n">min</span>:<span class="o">~/</span><span class="n">work</span><span class="o">/</span><span class="n">wasmtime</span><span class="w"> </span><span class="o">%</span><span class="w"> </span><span class="n">RAYON_NUM_THREADS</span><span class="o">=</span><span class="mi">1</span><span class="w"> </span><span class="n">hyperfine</span><span class="w"> </span><span class="o">'</span><span class="p">.</span><span class="o">/</span><span class="n">wasmtime</span><span class="p">.</span><span class="n">main</span><span class="w"> </span><span class="n">compile</span><span class="w"> </span><span class="o">../</span><span class="n">wasm</span><span class="o">-</span><span class="n">tests</span><span class="o">/</span><span class="n">spidermonkey</span><span class="p">.</span><span class="n">wasm</span><span class="o">'</span><span class="w"></span>
<span class="n">Benchmark</span><span class="w"> </span><span class="mi">1</span>: <span class="p">.</span><span class="o">/</span><span class="n">wasmtime</span><span class="p">.</span><span class="n">main</span><span class="w"> </span><span class="n">compile</span><span class="w"> </span><span class="o">../</span><span class="n">wasm</span><span class="o">-</span><span class="n">tests</span><span class="o">/</span><span class="n">spidermonkey</span><span class="p">.</span><span class="n">wasm</span><span class="w"></span>
<span class="w">  </span><span class="n">Time</span><span class="w"> </span><span class="p">(</span><span class="n">mean</span><span class="w"> </span><span class="err">±</span><span class="w"> </span><span class="err">σ</span><span class="p">)</span>:      <span class="mf">6.028</span><span class="w"> </span><span class="n">s</span><span class="w"> </span><span class="err">±</span><span class="w">  </span><span class="mf">0.196</span><span class="w"> </span><span class="n">s</span><span class="w">    </span><span class="p">[</span><span class="n">User</span>: <span class="mf">5.821</span><span class="w"> </span><span class="n">s</span><span class="p">,</span><span class="w"> </span><span class="n">System</span>: <span class="mf">0.157</span><span class="w"> </span><span class="n">s</span><span class="p">]</span><span class="w"></span>
<span class="w">  </span><span class="n">Range</span><span class="w"> </span><span class="p">(</span><span class="n">min</span><span class="w"> </span><span class="err">…</span><span class="w"> </span><span class="n">max</span><span class="p">)</span>:    <span class="mf">5.883</span><span class="w"> </span><span class="n">s</span><span class="w"> </span><span class="err">…</span><span class="w">  </span><span class="mf">6.483</span><span class="w"> </span><span class="n">s</span><span class="w">    </span><span class="mi">10</span><span class="w"> </span><span class="n">runs</span><span class="w"></span>

<span class="n">cfallin</span><span class="o">@</span><span class="n">min</span>:<span class="o">~/</span><span class="n">work</span><span class="o">/</span><span class="n">wasmtime</span><span class="w"> </span><span class="o">%</span><span class="w"> </span><span class="n">RAYON_NUM_THREADS</span><span class="o">=</span><span class="mi">1</span><span class="w"> </span><span class="n">hyperfine</span><span class="w"> </span><span class="o">'</span><span class="p">.</span><span class="o">/</span><span class="n">wasmtime</span><span class="p">.</span><span class="n">egraph</span><span class="w"> </span><span class="n">compile</span><span class="w"> </span><span class="o">../</span><span class="n">wasm</span><span class="o">-</span><span class="n">tests</span><span class="o">/</span><span class="n">spidermonkey</span><span class="p">.</span><span class="n">wasm</span><span class="o">'</span><span class="w"></span>
<span class="n">Benchmark</span><span class="w"> </span><span class="mi">1</span>: <span class="p">.</span><span class="o">/</span><span class="n">wasmtime</span><span class="p">.</span><span class="n">egraph</span><span class="w"> </span><span class="n">compile</span><span class="w"> </span><span class="o">../</span><span class="n">wasm</span><span class="o">-</span><span class="n">tests</span><span class="o">/</span><span class="n">spidermonkey</span><span class="p">.</span><span class="n">wasm</span><span class="w"></span>
<span class="w">  </span><span class="n">Time</span><span class="w"> </span><span class="p">(</span><span class="n">mean</span><span class="w"> </span><span class="err">±</span><span class="w"> </span><span class="err">σ</span><span class="p">)</span>:      <span class="mf">5.761</span><span class="w"> </span><span class="n">s</span><span class="w"> </span><span class="err">±</span><span class="w">  </span><span class="mf">0.030</span><span class="w"> </span><span class="n">s</span><span class="w">    </span><span class="p">[</span><span class="n">User</span>: <span class="mf">5.613</span><span class="w"> </span><span class="n">s</span><span class="p">,</span><span class="w"> </span><span class="n">System</span>: <span class="mf">0.139</span><span class="w"> </span><span class="n">s</span><span class="p">]</span><span class="w"></span>
<span class="w">  </span><span class="n">Range</span><span class="w"> </span><span class="p">(</span><span class="n">min</span><span class="w"> </span><span class="err">…</span><span class="w"> </span><span class="n">max</span><span class="p">)</span>:    <span class="mf">5.702</span><span class="w"> </span><span class="n">s</span><span class="w"> </span><span class="err">…</span><span class="w">  </span><span class="mf">5.808</span><span class="w"> </span><span class="n">s</span><span class="w">    </span><span class="mi">10</span><span class="w"> </span><span class="n">runs</span><span class="w"></span>
</code></pre></div>
<p>(That's measuring on my M1 Air laptop, pinned to 1 core but otherwise no special measures. I verified looking at the <code>context.rs</code> diff again that the list of passes being run is not any different. I suspect the difference could be at least partly due to the faster <code>ScopedHashMap</code> but I can look a bit deeper into this)</p>
<blockquote>
<p>I don't think I can review the code-motion changes in the ISLE preludes, on either the Rust or .isle sides. I tried some basic diffs but it looks like things are in a different order as well as being moved to different files.</p>
</blockquote>
<p>Yeah, sorry, that's a bit of a mess now due to all the rebasing -- there was a good amount of manual cherrypicking of new definitions. I'll see if I can clean up the diff a bit (given that this is hopefully merging soon there won't be other work that'll invalidate this with more conflicts later!).</p>
<blockquote>
<p>Ignoring those, I think I just have <a href="http://egraph.rs">egraph.rs</a> and <a href="http://elaborate.rs">elaborate.rs</a> left, which I'll have to tackle tomorrow.</p>
</blockquote>
<p>Thanks (and uh, bon voyage and good luck; those are some of the most exciting bits of this PR)!</p>
</blockquote>



<a name="303510434"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%234953%20egraph-based%20midend%3A%20draw%20the%20rest.../near/303510434" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.234953.20egraph-based.20midend.3A.20draw.20the.20rest.2E.2E.2E.html#303510434">(Oct 11 2022 at 20:00)</a>:</h4>
<p>cfallin <a href="https://github.com/bytecodealliance/wasmtime/pull/4953#issuecomment-1275207197">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/4953">issue #4953</a>:</p>
<blockquote>
<blockquote>
<p>Yeah, sorry, that's a bit of a mess now due to all the rebasing -- there was a good amount of manual cherrypicking of new definitions. I'll see if I can clean up the diff a bit (given that this is hopefully merging soon there won't be other work that'll invalidate this with more conflicts later!).</p>
</blockquote>
<p>I've gone over the diff to the ISLE-side and Rust-side definitions of the prelude and ensured that the common bits, which are new files from git's point of view, now have contents that are strictly in the same order and exactly match the removed lines from the old (lowering-only) prelude. (Latest commit does some reordering to make this true.)</p>
<p>(This involved a "diff-of-diffs" workflow and was a little ugly; and I wish git had better ways of showing code provenance for cross-file moves; but in the end at least I'm confident no definition was inadvertently missed or reverted to an older version.)</p>
</blockquote>



<a name="303541789"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%234953%20egraph-based%20midend%3A%20draw%20the%20rest.../near/303541789" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.234953.20egraph-based.20midend.3A.20draw.20the.20rest.2E.2E.2E.html#303541789">(Oct 12 2022 at 00:31)</a>:</h4>
<p>cfallin <a href="https://github.com/bytecodealliance/wasmtime/pull/4953#issuecomment-1275433398">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/4953">issue #4953</a>:</p>
<blockquote>
<p>Thanks so much for the detailed review -- it was really helpful!</p>
<p>So ends one long saga, and begins another (actually using this thing) :-)</p>
</blockquote>



<a name="303542955"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%234953%20egraph-based%20midend%3A%20draw%20the%20rest.../near/303542955" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.234953.20egraph-based.20midend.3A.20draw.20the.20rest.2E.2E.2E.html#303542955">(Oct 12 2022 at 00:44)</a>:</h4>
<p>jameysharp <a href="https://github.com/bytecodealliance/wasmtime/pull/4953#issuecomment-1275441255">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/4953">issue #4953</a>:</p>
<blockquote>
<blockquote>
<blockquote>
<p>Have you measured the performance impact of this PR with egraphs disabled? I see that ScopedHashMap is used by simple_gvn, which I was recently noticing takes a non-trivial amount of time. It looks to me like the ScopedHashMap changes should make some operations faster, so it could be an improvement, but it would be nice to check that it's not a regression.</p>
</blockquote>
<p>I did earlier on, and testing again just now with SpiderMonkey.wasm, I see, uh... a 6% speedup?</p>
</blockquote>
<p>I was curious about this so I've just compared the current merge-base from main (d68ca3711) with this branch (ec8a1a932). I see a 1% improvement in compile time/CPU cycles/instructions retired on the bz2, pulldown-cmark, and spidermonkey benchmarks. Not 6% but definitely nice!</p>
</blockquote>



<hr><p>Last updated: Jan 20 2025 at 06:04 UTC</p>
</html>