<html>
<head><meta charset="utf-8"><title>wasmtime / issue #6094 Further Improve Execution Speed wi... · git-wasmtime · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/index.html">git-wasmtime</a></h2>
<h3>Topic: <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.236094.20Further.20Improve.20Execution.20Speed.20wi.2E.2E.2E.html">wasmtime / issue #6094 Further Improve Execution Speed wi...</a></h3>

<hr>

<base href="https://bytecodealliance.zulipchat.com">

<head><link href="https://bytecodealliance.github.io/zulip-archive/style.css" rel="stylesheet"></head>

<a name="344069643"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%236094%20Further%20Improve%20Execution%20Speed%20wi.../near/344069643" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.236094.20Further.20Improve.20Execution.20Speed.20wi.2E.2E.2E.html#344069643">(Mar 23 2023 at 18:35)</a>:</h4>
<p>fitzgen labeled <a href="https://github.com/bytecodealliance/wasmtime/issues/6094">issue #6094</a>:</p>
<blockquote>
<p>I've been digging into Cranelift's and Wasmtime's code quality and Wasm execution throughput when "dynamic memories" with explicit bounds checks are used to implement Wasm linear memories. Here I'm summarizing the progress made thus far here, and laying out what I believe the next steps to continue this effort should be.</p>
<p>Static memories require large reservations of virtual memory, to the extent that it can become a bottleneck for how many Wasm instances can exist concurrently in a system. Dynamic memories, on the other hand, require very little or even zero virtual memory reservations (depending on configuration) beyond the actually resident pages backing the Wasm linear memory itself. Additionally, when dynamic memories are configured without any guard regions, they incur zero virtual memory-related syscalls on instantiation and tear down (modulo any copy-on-write heap image initialization). <a href="https://github.com/bytecodealliance/wasmtime/issues/4637">These syscalls have been observed to be bottlenecks in concurrent systems due to VMA locks taken in the kernel.</a></p>
<p>Furthermore these issues will only compound in the future. Right now, each tenant in a multi-tenant system is a single core Wasm module with a single Wasm linear memory. With the component model, a tenant will instead be a Wasm component that is made up of many core Wasm modules, each with their own linear memories. If the average Wasm component contains five linear memories, then the multi-tenant system can only support one fifth as many concurrent tenants under the component model, and instantiating and tearing down each tenant's service will take five times as many syscalls as it does today.</p>
<p>So there is a lot of pressure towards implementing Wasm linear memories with dynamic memories. The downside is that dynamic memories currently incur roughly 55% overhead to Wasm execution throughput compared to static memories. That is, a Wasm computation that takes 1 second in a static memory will take about 1.55 seconds in a dynamic memory. This is because dynamic memory accesses must be explicitly bounds checked rather than caught after the fact via page faults like out-of-bounds static memory accesses. The goal of the effort described here is to minimize this overhead.</p>
<p>I don't intend to continue this work in the immediate future, so I wanted to make sure everything was summarized and documented for posterity, as well as written down while it is still fresh in my mind. Additionally I have proposals for new optimization passes we should implement in the future, and this issue can serve as a forum for discussing them.</p>
<h2>Progress Made Thus Far</h2>
<p><strong>Before I began this effort, running the <code>spidermonkey.wasm</code> benchmark in Sightglass with static memories was 3.06x faster than doing the same with dynamic memories. Now we are down to static memories being only 1.55x faster.</strong></p>
<p>This improvement comes from a number of sources:</p>
<ul>
<li><a href="https://github.com/bytecodealliance/wasmtime/pull/5190">Deduplicating explicit bounds checks and Spectre mitigations</a>, since our Spectre mitigations effectively perform bounds checks already, the additional explicit bounds checks were redundant.</li>
<li>Ensuring that our global value numbering (GVN) optimization pass could optimize and deduplicate <a href="https://github.com/bytecodealliance/wasmtime/pull/5520"><code>uadd_overflow_trap</code></a> and <a href="https://github.com/bytecodealliance/wasmtime/pull/5517"><code>select_spectre_guard</code></a> instructions, both of which are emitted in our bounds-checking sequence.</li>
<li>The introduction of a variety of <a href="https://github.com/bytecodealliance/wasmtime/pull/5676">new</a> <a href="https://github.com/bytecodealliance/wasmtime/pull/5772">peephole</a> <a href="https://github.com/bytecodealliance/wasmtime/pull/5673">optimizations</a> and <a href="https://github.com/bytecodealliance/wasmtime/pull/5671">constant propagation rules</a> that were automatically synthesized by <a href="https://github.com/google/souper">Souper</a> from snippets of code harvested from <code>spidermonkey.wasm</code>.</li>
<li><a href="https://github.com/bytecodealliance/wasmtime/pull/6031">New special cases</a> for certain dynamic memory configurations in our bounds-checking implementation.</li>
</ul>
<p>Additionally, <a href="https://github.com/bytecodealliance/wasmtime/pull/5975">I created the <code>wasmtime explore</code> subcommand</a> to dig into native code disassemblies and associate each native instruction with the Wasm bytecode it implements (similar to the Godbolt Compiler Explorer). This new tool has already been incredibly helpful for analyzing what room for improvement still exists, and should help further future optimization efforts in Cranelift and Wasmtime.</p>
<h3>Recent Sightglass Benchmark Results</h3>
<p>Here are some recent Sightglass benchmark results comparing static memories (<code>static.so</code>) versus dynamic memories with a small (64KiB) guard region (<code>dyn-with-guard.so</code>) versus dynamic memories without a guard region (<code>dyn-without-guard.so</code>).</p>
<h4><code>static.so</code> vs <code>dyn-with-guard.so</code></h4>
<p>&lt;details&gt;</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="n">execution</span><span class="w"> </span>:: <span class="nc">cycles</span><span class="w"> </span>:: <span class="nc">benchmarks</span><span class="o">/</span><span class="n">spidermonkey</span><span class="o">/</span><span class="n">benchmark</span><span class="p">.</span><span class="n">wasm</span>

<span class="w">  </span><span class="err">Δ</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">517183665.48</span><span class="w"> </span><span class="err">±</span><span class="w"> </span><span class="mf">6392410.71</span><span class="w"> </span><span class="p">(</span><span class="n">confidence</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">99</span><span class="o">%</span><span class="p">)</span>

<span class="w">  </span><span class="k">static</span><span class="p">.</span><span class="n">so</span><span class="w"> </span><span class="n">is</span><span class="w"> </span><span class="mf">1.55</span><span class="n">x</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="mf">1.56</span><span class="n">x</span><span class="w"> </span><span class="n">faster</span><span class="w"> </span><span class="n">than</span><span class="w"> </span><span class="k">dyn</span><span class="o">-</span><span class="n">with</span><span class="o">-</span><span class="n">guard</span><span class="p">.</span><span class="n">so</span><span class="o">!</span>

<span class="w">  </span><span class="p">[</span><span class="mi">1420787062</span><span class="w"> </span><span class="mf">1450201603.68</span><span class="w"> </span><span class="mi">1522542159</span><span class="p">]</span><span class="w"> </span><span class="k">dyn</span><span class="o">-</span><span class="n">with</span><span class="o">-</span><span class="n">guard</span><span class="p">.</span><span class="n">so</span>
<span class="w">  </span><span class="p">[</span><span class="mi">914013248</span><span class="w"> </span><span class="mf">933017938.20</span><span class="w"> </span><span class="mi">1036142782</span><span class="p">]</span><span class="w"> </span><span class="k">static</span><span class="p">.</span><span class="n">so</span>

<span class="n">execution</span><span class="w"> </span>:: <span class="nc">cycles</span><span class="w"> </span>:: <span class="nc">benchmarks</span><span class="o">/</span><span class="n">bz2</span><span class="o">/</span><span class="n">benchmark</span><span class="p">.</span><span class="n">wasm</span>

<span class="w">  </span><span class="err">Δ</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">45802386.02</span><span class="w"> </span><span class="err">±</span><span class="w"> </span><span class="mf">1486278.64</span><span class="w"> </span><span class="p">(</span><span class="n">confidence</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">99</span><span class="o">%</span><span class="p">)</span>

<span class="w">  </span><span class="k">static</span><span class="p">.</span><span class="n">so</span><span class="w"> </span><span class="n">is</span><span class="w"> </span><span class="mf">1.42</span><span class="n">x</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="mf">1.45</span><span class="n">x</span><span class="w"> </span><span class="n">faster</span><span class="w"> </span><span class="n">than</span><span class="w"> </span><span class="k">dyn</span><span class="o">-</span><span class="n">with</span><span class="o">-</span><span class="n">guard</span><span class="p">.</span><span class="n">so</span><span class="o">!</span>

<span class="w">  </span><span class="p">[</span><span class="mi">146742085</span><span class="w"> </span><span class="mf">150423911.30</span><span class="w"> </span><span class="mi">159078923</span><span class="p">]</span><span class="w"> </span><span class="k">dyn</span><span class="o">-</span><span class="n">with</span><span class="o">-</span><span class="n">guard</span><span class="p">.</span><span class="n">so</span>
<span class="w">  </span><span class="p">[</span><span class="mi">100319894</span><span class="w"> </span><span class="mf">104621525.28</span><span class="w"> </span><span class="mi">149448856</span><span class="p">]</span><span class="w"> </span><span class="k">static</span><span class="p">.</span><span class="n">so</span>

<span class="n">execution</span><span class="w"> </span>:: <span class="nc">cycles</span><span class="w"> </span>:: <span class="nc">benchmarks</span><span class="o">/</span><span class="n">pulldown</span><span class="o">-</span><span class="n">cmark</span><span class="o">/</span><span class="n">benchmark</span><span class="p">.</span><span class="n">wasm</span>

<span class="w">  </span><span class="err">Δ</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">3014103.57</span><span class="w"> </span><span class="err">±</span><span class="w"> </span><span class="mf">316843.43</span><span class="w"> </span><span class="p">(</span><span class="n">confidence</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">99</span><span class="o">%</span><span class="p">)</span>

<span class="w">  </span><span class="k">static</span><span class="p">.</span><span class="n">so</span><span class="w"> </span><span class="n">is</span><span class="w"> </span><span class="mf">1.32</span><span class="n">x</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="mf">1.40</span><span class="n">x</span><span class="w"> </span><span class="n">faster</span><span class="w"> </span><span class="n">than</span><span class="w"> </span><span class="k">dyn</span><span class="o">-</span><span class="n">with</span><span class="o">-</span><span class="n">guard</span><span class="p">.</span><span class="n">so</span><span class="o">!</span>

<span class="w">  </span><span class="p">[</span><span class="mi">10662276</span><span class="w"> </span><span class="mf">11365102.25</span><span class="w"> </span><span class="mi">16630094</span><span class="p">]</span><span class="w"> </span><span class="k">dyn</span><span class="o">-</span><span class="n">with</span><span class="o">-</span><span class="n">guard</span><span class="p">.</span><span class="n">so</span>
<span class="w">  </span><span class="p">[</span><span class="mi">7683153</span><span class="w"> </span><span class="mf">8350998.68</span><span class="w"> </span><span class="mi">13449448</span><span class="p">]</span><span class="w"> </span><span class="k">static</span><span class="p">.</span><span class="n">so</span>

<span class="n">compilation</span><span class="w"> </span>:: <span class="nc">cycles</span><span class="w"> </span>:: <span class="nc">benchmarks</span><span class="o">/</span><span class="n">bz2</span><span class="o">/</span><span class="n">benchmark</span><span class="p">.</span><span class="n">wasm</span>

<span class="w">  </span><span class="err">Δ</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">45130213.24</span><span class="w"> </span><span class="err">±</span><span class="w"> </span><span class="mf">4838200.92</span><span class="w"> </span><span class="p">(</span><span class="n">confidence</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">99</span><span class="o">%</span><span class="p">)</span>

<span class="w">  </span><span class="k">static</span><span class="p">.</span><span class="n">so</span><span class="w"> </span><span class="n">is</span><span class="w"> </span><span class="mf">1.18</span><span class="n">x</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="mf">1.22</span><span class="n">x</span><span class="w"> </span><span class="n">faster</span><span class="w"> </span><span class="n">than</span><span class="w"> </span><span class="k">dyn</span><span class="o">-</span><span class="n">with</span><span class="o">-</span><span class="n">guard</span><span class="p">.</span><span class="n">so</span><span class="o">!</span>

<span class="w">  </span><span class="p">[</span><span class="mi">249993052</span><span class="w"> </span><span class="mf">271654226.14</span><span class="w"> </span><span class="mi">316970220</span><span class="p">]</span><span class="w"> </span><span class="k">dyn</span><span class="o">-</span><span class="n">with</span><span class="o">-</span><span class="n">guard</span><span class="p">.</span><span class="n">so</span>
<span class="w">  </span><span class="p">[</span><span class="mi">208845361</span><span class="w"> </span><span class="mf">226524012.90</span><span class="w"> </span><span class="mi">290090035</span><span class="p">]</span><span class="w"> </span><span class="k">static</span><span class="p">.</span><span class="n">so</span>

<span class="n">compilation</span><span class="w"> </span>:: <span class="nc">cycles</span><span class="w"> </span>:: <span class="nc">benchmarks</span><span class="o">/</span><span class="n">pulldown</span><span class="o">-</span><span class="n">cmark</span><span class="o">/</span><span class="n">benchmark</span><span class="p">.</span><span class="n">wasm</span>

<span class="w">  </span><span class="err">Δ</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">53326476.11</span><span class="w"> </span><span class="err">±</span><span class="w"> </span><span class="mf">5528961.43</span><span class="w"> </span><span class="p">(</span><span class="n">confidence</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">99</span><span class="o">%</span><span class="p">)</span>

<span class="w">  </span><span class="k">static</span><span class="p">.</span><span class="n">so</span><span class="w"> </span><span class="n">is</span><span class="w"> </span><span class="mf">1.16</span><span class="n">x</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="mf">1.19</span><span class="n">x</span><span class="w"> </span><span class="n">faster</span><span class="w"> </span><span class="n">than</span><span class="w"> </span><span class="k">dyn</span><span class="o">-</span><span class="n">with</span><span class="o">-</span><span class="n">guard</span><span class="p">.</span><span class="n">so</span><span class="o">!</span>

<span class="w">  </span><span class="p">[</span><span class="mi">330373001</span><span class="w"> </span><span class="mf">356824375.72</span><span class="w"> </span><span class="mi">397185785</span><span class="p">]</span><span class="w"> </span><span class="k">dyn</span><span class="o">-</span><span class="n">with</span><span class="o">-</span><span class="n">guard</span><span class="p">.</span><span class="n">so</span>
<span class="w">  </span><span class="p">[</span><span class="mi">279072702</span><span class="w"> </span><span class="mf">303497899.61</span><span class="w"> </span><span class="mi">348984338</span><span class="p">]</span><span class="w"> </span><span class="k">static</span><span class="p">.</span><span class="n">so</span>

<span class="n">compilation</span><span class="w"> </span>:: <span class="nc">cycles</span><span class="w"> </span>:: <span class="nc">benchmarks</span><span class="o">/</span><span class="n">spidermonkey</span><span class="o">/</span><span class="n">benchmark</span><span class="p">.</span><span class="n">wasm</span>

<span class="w">  </span><span class="err">Δ</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">1163853854.64</span><span class="w"> </span><span class="err">±</span><span class="w"> </span><span class="mf">81595847.03</span><span class="w"> </span><span class="p">(</span><span class="n">confidence</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">99</span><span class="o">%</span><span class="p">)</span>

<span class="w">  </span><span class="k">static</span><span class="p">.</span><span class="n">so</span><span class="w"> </span><span class="n">is</span><span class="w"> </span><span class="mf">1.15</span><span class="n">x</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="mf">1.18</span><span class="n">x</span><span class="w"> </span><span class="n">faster</span><span class="w"> </span><span class="n">than</span><span class="w"> </span><span class="k">dyn</span><span class="o">-</span><span class="n">with</span><span class="o">-</span><span class="n">guard</span><span class="p">.</span><span class="n">so</span><span class="o">!</span>

<span class="w">  </span><span class="p">[</span><span class="mi">8097294016</span><span class="w"> </span><span class="mf">8213392062.47</span><span class="w"> </span><span class="mi">10103274666</span><span class="p">]</span><span class="w"> </span><span class="k">dyn</span><span class="o">-</span><span class="n">with</span><span class="o">-</span><span class="n">guard</span><span class="p">.</span><span class="n">so</span>
<span class="w">  </span><span class="p">[</span><span class="mi">6969056325</span><span class="w"> </span><span class="mf">7049538207.83</span><span class="w"> </span><span class="mi">8442021515</span><span class="p">]</span><span class="w"> </span><span class="k">static</span><span class="p">.</span><span class="n">so</span>
</code></pre></div>
<p>&lt;/details&gt;</p>
<h4><code>static.so</code> vs <code>dyn-without-guard.so</code></h4>
<p>&lt;details&gt;</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="n">execution</span><span class="w"> </span>:: <span class="nc">cycles</span><span class="w"> </span>:: <span class="nc">benchmarks</span><span class="o">/</span><span class="n">spidermonkey</span><span class="o">/</span><span class="n">benchmark</span><span class="p">.</span><span class="n">wasm</span>

<span class="w">  </span><span class="err">Δ</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">594932587.44</span><span class="w"> </span><span class="err">±</span><span class="w"> </span><span class="mf">6811906.18</span><span class="w"> </span><span class="p">(</span><span class="n">confidence</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">99</span><span class="o">%</span><span class="p">)</span>

<span class="w">  </span><span class="k">static</span><span class="p">.</span><span class="n">so</span><span class="w"> </span><span class="n">is</span><span class="w"> </span><span class="mf">1.63</span><span class="n">x</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="mf">1.65</span><span class="n">x</span><span class="w"> </span><span class="n">faster</span><span class="w"> </span><span class="n">than</span><span class="w"> </span><span class="k">dyn</span><span class="o">-</span><span class="n">without</span><span class="o">-</span><span class="n">guard</span><span class="p">.</span><span class="n">so</span><span class="o">!</span>

<span class="w">  </span><span class="p">[</span><span class="mi">1494952789</span><span class="w"> </span><span class="mf">1524945424.11</span><span class="w"> </span><span class="mi">1606143187</span><span class="p">]</span><span class="w"> </span><span class="k">dyn</span><span class="o">-</span><span class="n">without</span><span class="o">-</span><span class="n">guard</span><span class="p">.</span><span class="n">so</span>
<span class="w">  </span><span class="p">[</span><span class="mi">908877847</span><span class="w"> </span><span class="mf">930012836.67</span><span class="w"> </span><span class="mi">980176520</span><span class="p">]</span><span class="w"> </span><span class="k">static</span><span class="p">.</span><span class="n">so</span>

<span class="n">execution</span><span class="w"> </span>:: <span class="nc">cycles</span><span class="w"> </span>:: <span class="nc">benchmarks</span><span class="o">/</span><span class="n">bz2</span><span class="o">/</span><span class="n">benchmark</span><span class="p">.</span><span class="n">wasm</span>

<span class="w">  </span><span class="err">Δ</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">49482140.46</span><span class="w"> </span><span class="err">±</span><span class="w"> </span><span class="mf">2175287.73</span><span class="w"> </span><span class="p">(</span><span class="n">confidence</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">99</span><span class="o">%</span><span class="p">)</span>

<span class="w">  </span><span class="k">static</span><span class="p">.</span><span class="n">so</span><span class="w"> </span><span class="n">is</span><span class="w"> </span><span class="mf">1.45</span><span class="n">x</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="mf">1.49</span><span class="n">x</span><span class="w"> </span><span class="n">faster</span><span class="w"> </span><span class="n">than</span><span class="w"> </span><span class="k">dyn</span><span class="o">-</span><span class="n">without</span><span class="o">-</span><span class="n">guard</span><span class="p">.</span><span class="n">so</span><span class="o">!</span>

<span class="w">  </span><span class="p">[</span><span class="mi">149370743</span><span class="w"> </span><span class="mf">154540290.45</span><span class="w"> </span><span class="mi">163713075</span><span class="p">]</span><span class="w"> </span><span class="k">dyn</span><span class="o">-</span><span class="n">without</span><span class="o">-</span><span class="n">guard</span><span class="p">.</span><span class="n">so</span>
<span class="w">  </span><span class="p">[</span><span class="mi">99902180</span><span class="w"> </span><span class="mf">105058149.99</span><span class="w"> </span><span class="mi">163151023</span><span class="p">]</span><span class="w"> </span><span class="k">static</span><span class="p">.</span><span class="n">so</span>

<span class="n">compilation</span><span class="w"> </span>:: <span class="nc">cycles</span><span class="w"> </span>:: <span class="nc">benchmarks</span><span class="o">/</span><span class="n">bz2</span><span class="o">/</span><span class="n">benchmark</span><span class="p">.</span><span class="n">wasm</span>

<span class="w">  </span><span class="err">Δ</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">54959651.89</span><span class="w"> </span><span class="err">±</span><span class="w"> </span><span class="mf">5371934.09</span><span class="w"> </span><span class="p">(</span><span class="n">confidence</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">99</span><span class="o">%</span><span class="p">)</span>

<span class="w">  </span><span class="k">static</span><span class="p">.</span><span class="n">so</span><span class="w"> </span><span class="n">is</span><span class="w"> </span><span class="mf">1.22</span><span class="n">x</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="mf">1.26</span><span class="n">x</span><span class="w"> </span><span class="n">faster</span><span class="w"> </span><span class="n">than</span><span class="w"> </span><span class="k">dyn</span><span class="o">-</span><span class="n">without</span><span class="o">-</span><span class="n">guard</span><span class="p">.</span><span class="n">so</span><span class="o">!</span>

<span class="w">  </span><span class="p">[</span><span class="mi">258958338</span><span class="w"> </span><span class="mf">282812487.71</span><span class="w"> </span><span class="mi">327560254</span><span class="p">]</span><span class="w"> </span><span class="k">dyn</span><span class="o">-</span><span class="n">without</span><span class="o">-</span><span class="n">guard</span><span class="p">.</span><span class="n">so</span>
<span class="w">  </span><span class="p">[</span><span class="mi">210542623</span><span class="w"> </span><span class="mf">227852835.82</span><span class="w"> </span><span class="mi">315990395</span><span class="p">]</span><span class="w"> </span><span class="k">static</span><span class="p">.</span><span class="n">so</span>

<span class="n">compilation</span><span class="w"> </span>:: <span class="nc">cycles</span><span class="w"> </span>:: <span class="nc">benchmarks</span><span class="o">/</span><span class="n">spidermonkey</span><span class="o">/</span><span class="n">benchmark</span><span class="p">.</span><span class="n">wasm</span>

<span class="w">  </span><span class="err">Δ</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">1592325533.89</span><span class="w"> </span><span class="err">±</span><span class="w"> </span><span class="mf">100212378.19</span><span class="w"> </span><span class="p">(</span><span class="n">confidence</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">99</span><span class="o">%</span><span class="p">)</span>

<span class="w">  </span><span class="k">static</span><span class="p">.</span><span class="n">so</span><span class="w"> </span><span class="n">is</span><span class="w"> </span><span class="mf">1.21</span><span class="n">x</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="mf">1.24</span><span class="n">x</span><span class="w"> </span><span class="n">faster</span><span class="w"> </span><span class="n">than</span><span class="w"> </span><span class="k">dyn</span><span class="o">-</span><span class="n">without</span><span class="o">-</span><span class="n">guard</span><span class="p">.</span><span class="n">so</span><span class="o">!</span>

<span class="w">  </span><span class="p">[</span><span class="mi">8494305552</span><span class="w"> </span><span class="mf">8674966162.14</span><span class="w"> </span><span class="mi">10607319542</span><span class="p">]</span><span class="w"> </span><span class="k">dyn</span><span class="o">-</span><span class="n">without</span><span class="o">-</span><span class="n">guard</span><span class="p">.</span><span class="n">so</span>
<span class="w">  </span><span class="p">[</span><span class="mi">6985640940</span><span class="w"> </span><span class="mf">7082640628.25</span><span class="w"> </span><span class="mi">8405451996</span><span class="p">]</span><span class="w"> </span><span class="k">static</span><span class="p">.</span><span class="n">so</span>

<span class="n">compilation</span><span class="w"> </span>:: <span class="nc">cycles</span><span class="w"> </span>:: <span class="nc">benchmarks</span><span class="o">/</span><span class="n">pulldown</span><span class="o">-</span><span class="n">cmark</span><span class="o">/</span><span class="n">benchmark</span><span class="p">.</span><span class="n">wasm</span>

<span class="w">  </span><span class="err">Δ</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">66518323.42</span><span class="w"> </span><span class="err">±</span><span class="w"> </span><span class="mf">5778757.98</span><span class="w"> </span><span class="p">(</span><span class="n">confidence</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">99</span><span class="o">%</span><span class="p">)</span>

<span class="w">  </span><span class="k">static</span><span class="p">.</span><span class="n">so</span><span class="w"> </span><span class="n">is</span><span class="w"> </span><span class="mf">1.20</span><span class="n">x</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="mf">1.24</span><span class="n">x</span><span class="w"> </span><span class="n">faster</span><span class="w"> </span><span class="n">than</span><span class="w"> </span><span class="k">dyn</span><span class="o">-</span><span class="n">without</span><span class="o">-</span><span class="n">guard</span><span class="p">.</span><span class="n">so</span><span class="o">!</span>

<span class="w">  </span><span class="p">[</span><span class="mi">342947509</span><span class="w"> </span><span class="mf">371023668.35</span><span class="w"> </span><span class="mi">415514806</span><span class="p">]</span><span class="w"> </span><span class="k">dyn</span><span class="o">-</span><span class="n">without</span><span class="o">-</span><span class="n">guard</span><span class="p">.</span><span class="n">so</span>
<span class="w">  </span><span class="p">[</span><span class="mi">277471563</span><span class="w"> </span><span class="mf">304505344.93</span><span class="w"> </span><span class="mi">339940435</span><span class="p">]</span><span class="w"> </span><span class="k">static</span><span class="p">.</span><span class="n">so</span>

<span class="n">execution</span><span class="w"> </span>:: <span class="nc">cycles</span><span class="w"> </span>:: <span class="nc">benchmarks</span><span class="o">/</span><span class="n">pulldown</span><span class="o">-</span><span class="n">cmark</span><span class="o">/</span><span class="n">benchmark</span><span class="p">.</span><span class="n">wasm</span>

<span class="w">  </span><span class="err">Δ</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">1217702.33</span><span class="w"> </span><span class="err">±</span><span class="w"> </span><span class="mf">627813.45</span><span class="w"> </span><span class="p">(</span><span class="n">confidence</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">99</span><span class="o">%</span><span class="p">)</span>

<span class="w">  </span><span class="k">static</span><span class="p">.</span><span class="n">so</span><span class="w"> </span><span class="n">is</span><span class="w"> </span><span class="mf">1.06</span><span class="n">x</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="mf">1.18</span><span class="n">x</span><span class="w"> </span><span class="n">faster</span><span class="w"> </span><span class="n">than</span><span class="w"> </span><span class="k">dyn</span><span class="o">-</span><span class="n">without</span><span class="o">-</span><span class="n">guard</span><span class="p">.</span><span class="n">so</span><span class="o">!</span>

<span class="w">  </span><span class="p">[</span><span class="mi">11111517</span><span class="w"> </span><span class="mf">11632130.88</span><span class="w"> </span><span class="mi">14705814</span><span class="p">]</span><span class="w"> </span><span class="k">dyn</span><span class="o">-</span><span class="n">without</span><span class="o">-</span><span class="n">guard</span><span class="p">.</span><span class="n">so</span>
<span class="w">  </span><span class="p">[</span><span class="mi">7682848</span><span class="w"> </span><span class="mf">10414428.55</span><span class="w"> </span><span class="mi">14122261</span><span class="p">]</span><span class="w"> </span><span class="k">static</span><span class="p">.</span><span class="n">so</span>
</code></pre></div>
<p>&lt;/details&gt;</p>
<h4>Comparing Wasmtime and SpiderMonkey</h4>
<p>To get a sense of whether our 1.55x slowdown when enabling explicit bounds checks was typical of other engines, I also benchmarked SpiderMonkey (native) running Sightglass's <code>spidermonkey.wasm</code> benchmark with virtual memory guard pages vs with explicit bounds checks.</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="n">execution</span><span class="w"> </span>:: <span class="nc">milliseconds</span><span class="w"> </span>:: <span class="nc">spidermonkey</span><span class="p">.</span><span class="n">wasm</span>

<span class="w">  </span><span class="err">Δ</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">163.62</span><span class="w"> </span><span class="err">±</span><span class="w"> </span><span class="mf">5.57</span><span class="w"> </span><span class="p">(</span><span class="n">confidence</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">99</span><span class="o">%</span><span class="p">)</span>

<span class="w">  </span><span class="kr">virtual</span><span class="o">-</span><span class="n">memory</span><span class="o">-</span><span class="n">spidermonkey</span><span class="w"> </span><span class="n">is</span><span class="w"> </span><span class="mf">1.52</span><span class="n">x</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="mf">1.56</span><span class="n">x</span><span class="w"> </span><span class="n">faster</span><span class="w"> </span><span class="n">than</span><span class="w"> </span><span class="n">bounds</span><span class="o">-</span><span class="n">checks</span><span class="o">-</span><span class="n">spidermonkey</span><span class="o">!</span>

<span class="w">  </span><span class="p">[</span><span class="mi">446</span><span class="w"> </span><span class="mf">465.49</span><span class="w"> </span><span class="mi">520</span><span class="p">]</span><span class="w"> </span><span class="n">bounds</span><span class="o">-</span><span class="n">checks</span><span class="o">-</span><span class="n">spidermonkey</span>
<span class="w">  </span><span class="p">[</span><span class="mi">290</span><span class="w"> </span><span class="mf">301.87</span><span class="w"> </span><span class="mi">353</span><span class="p">]</span><span class="w"> </span><span class="kr">virtual</span><span class="o">-</span><span class="n">memory</span><span class="o">-</span><span class="n">spidermonkey</span>
</code></pre></div>
<p>Because SpiderMonkey's slowdown is almost identical to Wasmtime's, we can infer that there aren't any critical bounds-checking optimizations that SpiderMonkey performs but Wasmtime/Cranelift does not. This is reassuring: it means we can basically ignore other engines (or at least SpiderMonkey) for now, when trying to further improve codegen when explicit bounds checks are enabled, and focus only on ourselves.</p>
<h2>Proposed Future Work</h2>
<p>What fruit remains to be harvested? I've been digging into <code>spidermonkey.wasm</code>'s hot functions (as reported by <code>perf</code> on Linux) and staring at disassemblies to get an idea of how much room for improvement we still have. In short: a lot!</p>
<p>I found many sequences of back-to-back <br>
[message truncated]</p>
</blockquote>



<a name="344069644"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%236094%20Further%20Improve%20Execution%20Speed%20wi.../near/344069644" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.236094.20Further.20Improve.20Execution.20Speed.20wi.2E.2E.2E.html#344069644">(Mar 23 2023 at 18:35)</a>:</h4>
<p>fitzgen opened <a href="https://github.com/bytecodealliance/wasmtime/issues/6094">issue #6094</a>:</p>
<blockquote>
<p>I've been digging into Cranelift's and Wasmtime's code quality and Wasm execution throughput when "dynamic memories" with explicit bounds checks are used to implement Wasm linear memories. Here I'm summarizing the progress made thus far here, and laying out what I believe the next steps to continue this effort should be.</p>
<p>Static memories require large reservations of virtual memory, to the extent that it can become a bottleneck for how many Wasm instances can exist concurrently in a system. Dynamic memories, on the other hand, require very little or even zero virtual memory reservations (depending on configuration) beyond the actually resident pages backing the Wasm linear memory itself. Additionally, when dynamic memories are configured without any guard regions, they incur zero virtual memory-related syscalls on instantiation and tear down (modulo any copy-on-write heap image initialization). <a href="https://github.com/bytecodealliance/wasmtime/issues/4637">These syscalls have been observed to be bottlenecks in concurrent systems due to VMA locks taken in the kernel.</a></p>
<p>Furthermore these issues will only compound in the future. Right now, each tenant in a multi-tenant system is a single core Wasm module with a single Wasm linear memory. With the component model, a tenant will instead be a Wasm component that is made up of many core Wasm modules, each with their own linear memories. If the average Wasm component contains five linear memories, then the multi-tenant system can only support one fifth as many concurrent tenants under the component model, and instantiating and tearing down each tenant's service will take five times as many syscalls as it does today.</p>
<p>So there is a lot of pressure towards implementing Wasm linear memories with dynamic memories. The downside is that dynamic memories currently incur roughly 55% overhead to Wasm execution throughput compared to static memories. That is, a Wasm computation that takes 1 second in a static memory will take about 1.55 seconds in a dynamic memory. This is because dynamic memory accesses must be explicitly bounds checked rather than caught after the fact via page faults like out-of-bounds static memory accesses. The goal of the effort described here is to minimize this overhead.</p>
<p>I don't intend to continue this work in the immediate future, so I wanted to make sure everything was summarized and documented for posterity, as well as written down while it is still fresh in my mind. Additionally I have proposals for new optimization passes we should implement in the future, and this issue can serve as a forum for discussing them.</p>
<h2>Progress Made Thus Far</h2>
<p><strong>Before I began this effort, running the <code>spidermonkey.wasm</code> benchmark in Sightglass with static memories was 3.06x faster than doing the same with dynamic memories. Now we are down to static memories being only 1.55x faster.</strong></p>
<p>This improvement comes from a number of sources:</p>
<ul>
<li><a href="https://github.com/bytecodealliance/wasmtime/pull/5190">Deduplicating explicit bounds checks and Spectre mitigations</a>, since our Spectre mitigations effectively perform bounds checks already, the additional explicit bounds checks were redundant.</li>
<li>Ensuring that our global value numbering (GVN) optimization pass could optimize and deduplicate <a href="https://github.com/bytecodealliance/wasmtime/pull/5520"><code>uadd_overflow_trap</code></a> and <a href="https://github.com/bytecodealliance/wasmtime/pull/5517"><code>select_spectre_guard</code></a> instructions, both of which are emitted in our bounds-checking sequence.</li>
<li>The introduction of a variety of <a href="https://github.com/bytecodealliance/wasmtime/pull/5676">new</a> <a href="https://github.com/bytecodealliance/wasmtime/pull/5772">peephole</a> <a href="https://github.com/bytecodealliance/wasmtime/pull/5673">optimizations</a> and <a href="https://github.com/bytecodealliance/wasmtime/pull/5671">constant propagation rules</a> that were automatically synthesized by <a href="https://github.com/google/souper">Souper</a> from snippets of code harvested from <code>spidermonkey.wasm</code>.</li>
<li><a href="https://github.com/bytecodealliance/wasmtime/pull/6031">New special cases</a> for certain dynamic memory configurations in our bounds-checking implementation.</li>
</ul>
<p>Additionally, <a href="https://github.com/bytecodealliance/wasmtime/pull/5975">I created the <code>wasmtime explore</code> subcommand</a> to dig into native code disassemblies and associate each native instruction with the Wasm bytecode it implements (similar to the Godbolt Compiler Explorer). This new tool has already been incredibly helpful for analyzing what room for improvement still exists, and should help further future optimization efforts in Cranelift and Wasmtime.</p>
<h3>Recent Sightglass Benchmark Results</h3>
<p>Here are some recent Sightglass benchmark results comparing static memories (<code>static.so</code>) versus dynamic memories with a small (64KiB) guard region (<code>dyn-with-guard.so</code>) versus dynamic memories without a guard region (<code>dyn-without-guard.so</code>).</p>
<h4><code>static.so</code> vs <code>dyn-with-guard.so</code></h4>
<p>&lt;details&gt;</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="n">execution</span><span class="w"> </span>:: <span class="nc">cycles</span><span class="w"> </span>:: <span class="nc">benchmarks</span><span class="o">/</span><span class="n">spidermonkey</span><span class="o">/</span><span class="n">benchmark</span><span class="p">.</span><span class="n">wasm</span>

<span class="w">  </span><span class="err">Δ</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">517183665.48</span><span class="w"> </span><span class="err">±</span><span class="w"> </span><span class="mf">6392410.71</span><span class="w"> </span><span class="p">(</span><span class="n">confidence</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">99</span><span class="o">%</span><span class="p">)</span>

<span class="w">  </span><span class="k">static</span><span class="p">.</span><span class="n">so</span><span class="w"> </span><span class="n">is</span><span class="w"> </span><span class="mf">1.55</span><span class="n">x</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="mf">1.56</span><span class="n">x</span><span class="w"> </span><span class="n">faster</span><span class="w"> </span><span class="n">than</span><span class="w"> </span><span class="k">dyn</span><span class="o">-</span><span class="n">with</span><span class="o">-</span><span class="n">guard</span><span class="p">.</span><span class="n">so</span><span class="o">!</span>

<span class="w">  </span><span class="p">[</span><span class="mi">1420787062</span><span class="w"> </span><span class="mf">1450201603.68</span><span class="w"> </span><span class="mi">1522542159</span><span class="p">]</span><span class="w"> </span><span class="k">dyn</span><span class="o">-</span><span class="n">with</span><span class="o">-</span><span class="n">guard</span><span class="p">.</span><span class="n">so</span>
<span class="w">  </span><span class="p">[</span><span class="mi">914013248</span><span class="w"> </span><span class="mf">933017938.20</span><span class="w"> </span><span class="mi">1036142782</span><span class="p">]</span><span class="w"> </span><span class="k">static</span><span class="p">.</span><span class="n">so</span>

<span class="n">execution</span><span class="w"> </span>:: <span class="nc">cycles</span><span class="w"> </span>:: <span class="nc">benchmarks</span><span class="o">/</span><span class="n">bz2</span><span class="o">/</span><span class="n">benchmark</span><span class="p">.</span><span class="n">wasm</span>

<span class="w">  </span><span class="err">Δ</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">45802386.02</span><span class="w"> </span><span class="err">±</span><span class="w"> </span><span class="mf">1486278.64</span><span class="w"> </span><span class="p">(</span><span class="n">confidence</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">99</span><span class="o">%</span><span class="p">)</span>

<span class="w">  </span><span class="k">static</span><span class="p">.</span><span class="n">so</span><span class="w"> </span><span class="n">is</span><span class="w"> </span><span class="mf">1.42</span><span class="n">x</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="mf">1.45</span><span class="n">x</span><span class="w"> </span><span class="n">faster</span><span class="w"> </span><span class="n">than</span><span class="w"> </span><span class="k">dyn</span><span class="o">-</span><span class="n">with</span><span class="o">-</span><span class="n">guard</span><span class="p">.</span><span class="n">so</span><span class="o">!</span>

<span class="w">  </span><span class="p">[</span><span class="mi">146742085</span><span class="w"> </span><span class="mf">150423911.30</span><span class="w"> </span><span class="mi">159078923</span><span class="p">]</span><span class="w"> </span><span class="k">dyn</span><span class="o">-</span><span class="n">with</span><span class="o">-</span><span class="n">guard</span><span class="p">.</span><span class="n">so</span>
<span class="w">  </span><span class="p">[</span><span class="mi">100319894</span><span class="w"> </span><span class="mf">104621525.28</span><span class="w"> </span><span class="mi">149448856</span><span class="p">]</span><span class="w"> </span><span class="k">static</span><span class="p">.</span><span class="n">so</span>

<span class="n">execution</span><span class="w"> </span>:: <span class="nc">cycles</span><span class="w"> </span>:: <span class="nc">benchmarks</span><span class="o">/</span><span class="n">pulldown</span><span class="o">-</span><span class="n">cmark</span><span class="o">/</span><span class="n">benchmark</span><span class="p">.</span><span class="n">wasm</span>

<span class="w">  </span><span class="err">Δ</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">3014103.57</span><span class="w"> </span><span class="err">±</span><span class="w"> </span><span class="mf">316843.43</span><span class="w"> </span><span class="p">(</span><span class="n">confidence</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">99</span><span class="o">%</span><span class="p">)</span>

<span class="w">  </span><span class="k">static</span><span class="p">.</span><span class="n">so</span><span class="w"> </span><span class="n">is</span><span class="w"> </span><span class="mf">1.32</span><span class="n">x</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="mf">1.40</span><span class="n">x</span><span class="w"> </span><span class="n">faster</span><span class="w"> </span><span class="n">than</span><span class="w"> </span><span class="k">dyn</span><span class="o">-</span><span class="n">with</span><span class="o">-</span><span class="n">guard</span><span class="p">.</span><span class="n">so</span><span class="o">!</span>

<span class="w">  </span><span class="p">[</span><span class="mi">10662276</span><span class="w"> </span><span class="mf">11365102.25</span><span class="w"> </span><span class="mi">16630094</span><span class="p">]</span><span class="w"> </span><span class="k">dyn</span><span class="o">-</span><span class="n">with</span><span class="o">-</span><span class="n">guard</span><span class="p">.</span><span class="n">so</span>
<span class="w">  </span><span class="p">[</span><span class="mi">7683153</span><span class="w"> </span><span class="mf">8350998.68</span><span class="w"> </span><span class="mi">13449448</span><span class="p">]</span><span class="w"> </span><span class="k">static</span><span class="p">.</span><span class="n">so</span>

<span class="n">compilation</span><span class="w"> </span>:: <span class="nc">cycles</span><span class="w"> </span>:: <span class="nc">benchmarks</span><span class="o">/</span><span class="n">bz2</span><span class="o">/</span><span class="n">benchmark</span><span class="p">.</span><span class="n">wasm</span>

<span class="w">  </span><span class="err">Δ</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">45130213.24</span><span class="w"> </span><span class="err">±</span><span class="w"> </span><span class="mf">4838200.92</span><span class="w"> </span><span class="p">(</span><span class="n">confidence</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">99</span><span class="o">%</span><span class="p">)</span>

<span class="w">  </span><span class="k">static</span><span class="p">.</span><span class="n">so</span><span class="w"> </span><span class="n">is</span><span class="w"> </span><span class="mf">1.18</span><span class="n">x</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="mf">1.22</span><span class="n">x</span><span class="w"> </span><span class="n">faster</span><span class="w"> </span><span class="n">than</span><span class="w"> </span><span class="k">dyn</span><span class="o">-</span><span class="n">with</span><span class="o">-</span><span class="n">guard</span><span class="p">.</span><span class="n">so</span><span class="o">!</span>

<span class="w">  </span><span class="p">[</span><span class="mi">249993052</span><span class="w"> </span><span class="mf">271654226.14</span><span class="w"> </span><span class="mi">316970220</span><span class="p">]</span><span class="w"> </span><span class="k">dyn</span><span class="o">-</span><span class="n">with</span><span class="o">-</span><span class="n">guard</span><span class="p">.</span><span class="n">so</span>
<span class="w">  </span><span class="p">[</span><span class="mi">208845361</span><span class="w"> </span><span class="mf">226524012.90</span><span class="w"> </span><span class="mi">290090035</span><span class="p">]</span><span class="w"> </span><span class="k">static</span><span class="p">.</span><span class="n">so</span>

<span class="n">compilation</span><span class="w"> </span>:: <span class="nc">cycles</span><span class="w"> </span>:: <span class="nc">benchmarks</span><span class="o">/</span><span class="n">pulldown</span><span class="o">-</span><span class="n">cmark</span><span class="o">/</span><span class="n">benchmark</span><span class="p">.</span><span class="n">wasm</span>

<span class="w">  </span><span class="err">Δ</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">53326476.11</span><span class="w"> </span><span class="err">±</span><span class="w"> </span><span class="mf">5528961.43</span><span class="w"> </span><span class="p">(</span><span class="n">confidence</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">99</span><span class="o">%</span><span class="p">)</span>

<span class="w">  </span><span class="k">static</span><span class="p">.</span><span class="n">so</span><span class="w"> </span><span class="n">is</span><span class="w"> </span><span class="mf">1.16</span><span class="n">x</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="mf">1.19</span><span class="n">x</span><span class="w"> </span><span class="n">faster</span><span class="w"> </span><span class="n">than</span><span class="w"> </span><span class="k">dyn</span><span class="o">-</span><span class="n">with</span><span class="o">-</span><span class="n">guard</span><span class="p">.</span><span class="n">so</span><span class="o">!</span>

<span class="w">  </span><span class="p">[</span><span class="mi">330373001</span><span class="w"> </span><span class="mf">356824375.72</span><span class="w"> </span><span class="mi">397185785</span><span class="p">]</span><span class="w"> </span><span class="k">dyn</span><span class="o">-</span><span class="n">with</span><span class="o">-</span><span class="n">guard</span><span class="p">.</span><span class="n">so</span>
<span class="w">  </span><span class="p">[</span><span class="mi">279072702</span><span class="w"> </span><span class="mf">303497899.61</span><span class="w"> </span><span class="mi">348984338</span><span class="p">]</span><span class="w"> </span><span class="k">static</span><span class="p">.</span><span class="n">so</span>

<span class="n">compilation</span><span class="w"> </span>:: <span class="nc">cycles</span><span class="w"> </span>:: <span class="nc">benchmarks</span><span class="o">/</span><span class="n">spidermonkey</span><span class="o">/</span><span class="n">benchmark</span><span class="p">.</span><span class="n">wasm</span>

<span class="w">  </span><span class="err">Δ</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">1163853854.64</span><span class="w"> </span><span class="err">±</span><span class="w"> </span><span class="mf">81595847.03</span><span class="w"> </span><span class="p">(</span><span class="n">confidence</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">99</span><span class="o">%</span><span class="p">)</span>

<span class="w">  </span><span class="k">static</span><span class="p">.</span><span class="n">so</span><span class="w"> </span><span class="n">is</span><span class="w"> </span><span class="mf">1.15</span><span class="n">x</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="mf">1.18</span><span class="n">x</span><span class="w"> </span><span class="n">faster</span><span class="w"> </span><span class="n">than</span><span class="w"> </span><span class="k">dyn</span><span class="o">-</span><span class="n">with</span><span class="o">-</span><span class="n">guard</span><span class="p">.</span><span class="n">so</span><span class="o">!</span>

<span class="w">  </span><span class="p">[</span><span class="mi">8097294016</span><span class="w"> </span><span class="mf">8213392062.47</span><span class="w"> </span><span class="mi">10103274666</span><span class="p">]</span><span class="w"> </span><span class="k">dyn</span><span class="o">-</span><span class="n">with</span><span class="o">-</span><span class="n">guard</span><span class="p">.</span><span class="n">so</span>
<span class="w">  </span><span class="p">[</span><span class="mi">6969056325</span><span class="w"> </span><span class="mf">7049538207.83</span><span class="w"> </span><span class="mi">8442021515</span><span class="p">]</span><span class="w"> </span><span class="k">static</span><span class="p">.</span><span class="n">so</span>
</code></pre></div>
<p>&lt;/details&gt;</p>
<h4><code>static.so</code> vs <code>dyn-without-guard.so</code></h4>
<p>&lt;details&gt;</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="n">execution</span><span class="w"> </span>:: <span class="nc">cycles</span><span class="w"> </span>:: <span class="nc">benchmarks</span><span class="o">/</span><span class="n">spidermonkey</span><span class="o">/</span><span class="n">benchmark</span><span class="p">.</span><span class="n">wasm</span>

<span class="w">  </span><span class="err">Δ</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">594932587.44</span><span class="w"> </span><span class="err">±</span><span class="w"> </span><span class="mf">6811906.18</span><span class="w"> </span><span class="p">(</span><span class="n">confidence</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">99</span><span class="o">%</span><span class="p">)</span>

<span class="w">  </span><span class="k">static</span><span class="p">.</span><span class="n">so</span><span class="w"> </span><span class="n">is</span><span class="w"> </span><span class="mf">1.63</span><span class="n">x</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="mf">1.65</span><span class="n">x</span><span class="w"> </span><span class="n">faster</span><span class="w"> </span><span class="n">than</span><span class="w"> </span><span class="k">dyn</span><span class="o">-</span><span class="n">without</span><span class="o">-</span><span class="n">guard</span><span class="p">.</span><span class="n">so</span><span class="o">!</span>

<span class="w">  </span><span class="p">[</span><span class="mi">1494952789</span><span class="w"> </span><span class="mf">1524945424.11</span><span class="w"> </span><span class="mi">1606143187</span><span class="p">]</span><span class="w"> </span><span class="k">dyn</span><span class="o">-</span><span class="n">without</span><span class="o">-</span><span class="n">guard</span><span class="p">.</span><span class="n">so</span>
<span class="w">  </span><span class="p">[</span><span class="mi">908877847</span><span class="w"> </span><span class="mf">930012836.67</span><span class="w"> </span><span class="mi">980176520</span><span class="p">]</span><span class="w"> </span><span class="k">static</span><span class="p">.</span><span class="n">so</span>

<span class="n">execution</span><span class="w"> </span>:: <span class="nc">cycles</span><span class="w"> </span>:: <span class="nc">benchmarks</span><span class="o">/</span><span class="n">bz2</span><span class="o">/</span><span class="n">benchmark</span><span class="p">.</span><span class="n">wasm</span>

<span class="w">  </span><span class="err">Δ</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">49482140.46</span><span class="w"> </span><span class="err">±</span><span class="w"> </span><span class="mf">2175287.73</span><span class="w"> </span><span class="p">(</span><span class="n">confidence</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">99</span><span class="o">%</span><span class="p">)</span>

<span class="w">  </span><span class="k">static</span><span class="p">.</span><span class="n">so</span><span class="w"> </span><span class="n">is</span><span class="w"> </span><span class="mf">1.45</span><span class="n">x</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="mf">1.49</span><span class="n">x</span><span class="w"> </span><span class="n">faster</span><span class="w"> </span><span class="n">than</span><span class="w"> </span><span class="k">dyn</span><span class="o">-</span><span class="n">without</span><span class="o">-</span><span class="n">guard</span><span class="p">.</span><span class="n">so</span><span class="o">!</span>

<span class="w">  </span><span class="p">[</span><span class="mi">149370743</span><span class="w"> </span><span class="mf">154540290.45</span><span class="w"> </span><span class="mi">163713075</span><span class="p">]</span><span class="w"> </span><span class="k">dyn</span><span class="o">-</span><span class="n">without</span><span class="o">-</span><span class="n">guard</span><span class="p">.</span><span class="n">so</span>
<span class="w">  </span><span class="p">[</span><span class="mi">99902180</span><span class="w"> </span><span class="mf">105058149.99</span><span class="w"> </span><span class="mi">163151023</span><span class="p">]</span><span class="w"> </span><span class="k">static</span><span class="p">.</span><span class="n">so</span>

<span class="n">compilation</span><span class="w"> </span>:: <span class="nc">cycles</span><span class="w"> </span>:: <span class="nc">benchmarks</span><span class="o">/</span><span class="n">bz2</span><span class="o">/</span><span class="n">benchmark</span><span class="p">.</span><span class="n">wasm</span>

<span class="w">  </span><span class="err">Δ</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">54959651.89</span><span class="w"> </span><span class="err">±</span><span class="w"> </span><span class="mf">5371934.09</span><span class="w"> </span><span class="p">(</span><span class="n">confidence</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">99</span><span class="o">%</span><span class="p">)</span>

<span class="w">  </span><span class="k">static</span><span class="p">.</span><span class="n">so</span><span class="w"> </span><span class="n">is</span><span class="w"> </span><span class="mf">1.22</span><span class="n">x</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="mf">1.26</span><span class="n">x</span><span class="w"> </span><span class="n">faster</span><span class="w"> </span><span class="n">than</span><span class="w"> </span><span class="k">dyn</span><span class="o">-</span><span class="n">without</span><span class="o">-</span><span class="n">guard</span><span class="p">.</span><span class="n">so</span><span class="o">!</span>

<span class="w">  </span><span class="p">[</span><span class="mi">258958338</span><span class="w"> </span><span class="mf">282812487.71</span><span class="w"> </span><span class="mi">327560254</span><span class="p">]</span><span class="w"> </span><span class="k">dyn</span><span class="o">-</span><span class="n">without</span><span class="o">-</span><span class="n">guard</span><span class="p">.</span><span class="n">so</span>
<span class="w">  </span><span class="p">[</span><span class="mi">210542623</span><span class="w"> </span><span class="mf">227852835.82</span><span class="w"> </span><span class="mi">315990395</span><span class="p">]</span><span class="w"> </span><span class="k">static</span><span class="p">.</span><span class="n">so</span>

<span class="n">compilation</span><span class="w"> </span>:: <span class="nc">cycles</span><span class="w"> </span>:: <span class="nc">benchmarks</span><span class="o">/</span><span class="n">spidermonkey</span><span class="o">/</span><span class="n">benchmark</span><span class="p">.</span><span class="n">wasm</span>

<span class="w">  </span><span class="err">Δ</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">1592325533.89</span><span class="w"> </span><span class="err">±</span><span class="w"> </span><span class="mf">100212378.19</span><span class="w"> </span><span class="p">(</span><span class="n">confidence</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">99</span><span class="o">%</span><span class="p">)</span>

<span class="w">  </span><span class="k">static</span><span class="p">.</span><span class="n">so</span><span class="w"> </span><span class="n">is</span><span class="w"> </span><span class="mf">1.21</span><span class="n">x</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="mf">1.24</span><span class="n">x</span><span class="w"> </span><span class="n">faster</span><span class="w"> </span><span class="n">than</span><span class="w"> </span><span class="k">dyn</span><span class="o">-</span><span class="n">without</span><span class="o">-</span><span class="n">guard</span><span class="p">.</span><span class="n">so</span><span class="o">!</span>

<span class="w">  </span><span class="p">[</span><span class="mi">8494305552</span><span class="w"> </span><span class="mf">8674966162.14</span><span class="w"> </span><span class="mi">10607319542</span><span class="p">]</span><span class="w"> </span><span class="k">dyn</span><span class="o">-</span><span class="n">without</span><span class="o">-</span><span class="n">guard</span><span class="p">.</span><span class="n">so</span>
<span class="w">  </span><span class="p">[</span><span class="mi">6985640940</span><span class="w"> </span><span class="mf">7082640628.25</span><span class="w"> </span><span class="mi">8405451996</span><span class="p">]</span><span class="w"> </span><span class="k">static</span><span class="p">.</span><span class="n">so</span>

<span class="n">compilation</span><span class="w"> </span>:: <span class="nc">cycles</span><span class="w"> </span>:: <span class="nc">benchmarks</span><span class="o">/</span><span class="n">pulldown</span><span class="o">-</span><span class="n">cmark</span><span class="o">/</span><span class="n">benchmark</span><span class="p">.</span><span class="n">wasm</span>

<span class="w">  </span><span class="err">Δ</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">66518323.42</span><span class="w"> </span><span class="err">±</span><span class="w"> </span><span class="mf">5778757.98</span><span class="w"> </span><span class="p">(</span><span class="n">confidence</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">99</span><span class="o">%</span><span class="p">)</span>

<span class="w">  </span><span class="k">static</span><span class="p">.</span><span class="n">so</span><span class="w"> </span><span class="n">is</span><span class="w"> </span><span class="mf">1.20</span><span class="n">x</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="mf">1.24</span><span class="n">x</span><span class="w"> </span><span class="n">faster</span><span class="w"> </span><span class="n">than</span><span class="w"> </span><span class="k">dyn</span><span class="o">-</span><span class="n">without</span><span class="o">-</span><span class="n">guard</span><span class="p">.</span><span class="n">so</span><span class="o">!</span>

<span class="w">  </span><span class="p">[</span><span class="mi">342947509</span><span class="w"> </span><span class="mf">371023668.35</span><span class="w"> </span><span class="mi">415514806</span><span class="p">]</span><span class="w"> </span><span class="k">dyn</span><span class="o">-</span><span class="n">without</span><span class="o">-</span><span class="n">guard</span><span class="p">.</span><span class="n">so</span>
<span class="w">  </span><span class="p">[</span><span class="mi">277471563</span><span class="w"> </span><span class="mf">304505344.93</span><span class="w"> </span><span class="mi">339940435</span><span class="p">]</span><span class="w"> </span><span class="k">static</span><span class="p">.</span><span class="n">so</span>

<span class="n">execution</span><span class="w"> </span>:: <span class="nc">cycles</span><span class="w"> </span>:: <span class="nc">benchmarks</span><span class="o">/</span><span class="n">pulldown</span><span class="o">-</span><span class="n">cmark</span><span class="o">/</span><span class="n">benchmark</span><span class="p">.</span><span class="n">wasm</span>

<span class="w">  </span><span class="err">Δ</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">1217702.33</span><span class="w"> </span><span class="err">±</span><span class="w"> </span><span class="mf">627813.45</span><span class="w"> </span><span class="p">(</span><span class="n">confidence</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">99</span><span class="o">%</span><span class="p">)</span>

<span class="w">  </span><span class="k">static</span><span class="p">.</span><span class="n">so</span><span class="w"> </span><span class="n">is</span><span class="w"> </span><span class="mf">1.06</span><span class="n">x</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="mf">1.18</span><span class="n">x</span><span class="w"> </span><span class="n">faster</span><span class="w"> </span><span class="n">than</span><span class="w"> </span><span class="k">dyn</span><span class="o">-</span><span class="n">without</span><span class="o">-</span><span class="n">guard</span><span class="p">.</span><span class="n">so</span><span class="o">!</span>

<span class="w">  </span><span class="p">[</span><span class="mi">11111517</span><span class="w"> </span><span class="mf">11632130.88</span><span class="w"> </span><span class="mi">14705814</span><span class="p">]</span><span class="w"> </span><span class="k">dyn</span><span class="o">-</span><span class="n">without</span><span class="o">-</span><span class="n">guard</span><span class="p">.</span><span class="n">so</span>
<span class="w">  </span><span class="p">[</span><span class="mi">7682848</span><span class="w"> </span><span class="mf">10414428.55</span><span class="w"> </span><span class="mi">14122261</span><span class="p">]</span><span class="w"> </span><span class="k">static</span><span class="p">.</span><span class="n">so</span>
</code></pre></div>
<p>&lt;/details&gt;</p>
<h4>Comparing Wasmtime and SpiderMonkey</h4>
<p>To get a sense of whether our 1.55x slowdown when enabling explicit bounds checks was typical of other engines, I also benchmarked SpiderMonkey (native) running Sightglass's <code>spidermonkey.wasm</code> benchmark with virtual memory guard pages vs with explicit bounds checks.</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="n">execution</span><span class="w"> </span>:: <span class="nc">milliseconds</span><span class="w"> </span>:: <span class="nc">spidermonkey</span><span class="p">.</span><span class="n">wasm</span>

<span class="w">  </span><span class="err">Δ</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">163.62</span><span class="w"> </span><span class="err">±</span><span class="w"> </span><span class="mf">5.57</span><span class="w"> </span><span class="p">(</span><span class="n">confidence</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">99</span><span class="o">%</span><span class="p">)</span>

<span class="w">  </span><span class="kr">virtual</span><span class="o">-</span><span class="n">memory</span><span class="o">-</span><span class="n">spidermonkey</span><span class="w"> </span><span class="n">is</span><span class="w"> </span><span class="mf">1.52</span><span class="n">x</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="mf">1.56</span><span class="n">x</span><span class="w"> </span><span class="n">faster</span><span class="w"> </span><span class="n">than</span><span class="w"> </span><span class="n">bounds</span><span class="o">-</span><span class="n">checks</span><span class="o">-</span><span class="n">spidermonkey</span><span class="o">!</span>

<span class="w">  </span><span class="p">[</span><span class="mi">446</span><span class="w"> </span><span class="mf">465.49</span><span class="w"> </span><span class="mi">520</span><span class="p">]</span><span class="w"> </span><span class="n">bounds</span><span class="o">-</span><span class="n">checks</span><span class="o">-</span><span class="n">spidermonkey</span>
<span class="w">  </span><span class="p">[</span><span class="mi">290</span><span class="w"> </span><span class="mf">301.87</span><span class="w"> </span><span class="mi">353</span><span class="p">]</span><span class="w"> </span><span class="kr">virtual</span><span class="o">-</span><span class="n">memory</span><span class="o">-</span><span class="n">spidermonkey</span>
</code></pre></div>
<p>Because SpiderMonkey's slowdown is almost identical to Wasmtime's, we can infer that there aren't any critical bounds-checking optimizations that SpiderMonkey performs but Wasmtime/Cranelift does not. This is reassuring: it means we can basically ignore other engines (or at least SpiderMonkey) for now, when trying to further improve codegen when explicit bounds checks are enabled, and focus only on ourselves.</p>
<h2>Proposed Future Work</h2>
<p>What fruit remains to be harvested? I've been digging into <code>spidermonkey.wasm</code>'s hot functions (as reported by <code>perf</code> on Linux) and staring at disassemblies to get an idea of how much room for improvement we still have. In short: a lot!</p>
<p>I found many sequences of back-to-back m<br>
[message truncated]</p>
</blockquote>



<a name="344069654"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%236094%20Further%20Improve%20Execution%20Speed%20wi.../near/344069654" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.236094.20Further.20Improve.20Execution.20Speed.20wi.2E.2E.2E.html#344069654">(Mar 23 2023 at 18:35)</a>:</h4>
<p>fitzgen labeled <a href="https://github.com/bytecodealliance/wasmtime/issues/6094">issue #6094</a>:</p>
<blockquote>
<p>I've been digging into Cranelift's and Wasmtime's code quality and Wasm execution throughput when "dynamic memories" with explicit bounds checks are used to implement Wasm linear memories. Here I'm summarizing the progress made thus far here, and laying out what I believe the next steps to continue this effort should be.</p>
<p>Static memories require large reservations of virtual memory, to the extent that it can become a bottleneck for how many Wasm instances can exist concurrently in a system. Dynamic memories, on the other hand, require very little or even zero virtual memory reservations (depending on configuration) beyond the actually resident pages backing the Wasm linear memory itself. Additionally, when dynamic memories are configured without any guard regions, they incur zero virtual memory-related syscalls on instantiation and tear down (modulo any copy-on-write heap image initialization). <a href="https://github.com/bytecodealliance/wasmtime/issues/4637">These syscalls have been observed to be bottlenecks in concurrent systems due to VMA locks taken in the kernel.</a></p>
<p>Furthermore these issues will only compound in the future. Right now, each tenant in a multi-tenant system is a single core Wasm module with a single Wasm linear memory. With the component model, a tenant will instead be a Wasm component that is made up of many core Wasm modules, each with their own linear memories. If the average Wasm component contains five linear memories, then the multi-tenant system can only support one fifth as many concurrent tenants under the component model, and instantiating and tearing down each tenant's service will take five times as many syscalls as it does today.</p>
<p>So there is a lot of pressure towards implementing Wasm linear memories with dynamic memories. The downside is that dynamic memories currently incur roughly 55% overhead to Wasm execution throughput compared to static memories. That is, a Wasm computation that takes 1 second in a static memory will take about 1.55 seconds in a dynamic memory. This is because dynamic memory accesses must be explicitly bounds checked rather than caught after the fact via page faults like out-of-bounds static memory accesses. The goal of the effort described here is to minimize this overhead.</p>
<p>I don't intend to continue this work in the immediate future, so I wanted to make sure everything was summarized and documented for posterity, as well as written down while it is still fresh in my mind. Additionally I have proposals for new optimization passes we should implement in the future, and this issue can serve as a forum for discussing them.</p>
<h2>Progress Made Thus Far</h2>
<p><strong>Before I began this effort, running the <code>spidermonkey.wasm</code> benchmark in Sightglass with static memories was 3.06x faster than doing the same with dynamic memories. Now we are down to static memories being only 1.55x faster.</strong></p>
<p>This improvement comes from a number of sources:</p>
<ul>
<li><a href="https://github.com/bytecodealliance/wasmtime/pull/5190">Deduplicating explicit bounds checks and Spectre mitigations</a>, since our Spectre mitigations effectively perform bounds checks already, the additional explicit bounds checks were redundant.</li>
<li>Ensuring that our global value numbering (GVN) optimization pass could optimize and deduplicate <a href="https://github.com/bytecodealliance/wasmtime/pull/5520"><code>uadd_overflow_trap</code></a> and <a href="https://github.com/bytecodealliance/wasmtime/pull/5517"><code>select_spectre_guard</code></a> instructions, both of which are emitted in our bounds-checking sequence.</li>
<li>The introduction of a variety of <a href="https://github.com/bytecodealliance/wasmtime/pull/5676">new</a> <a href="https://github.com/bytecodealliance/wasmtime/pull/5772">peephole</a> <a href="https://github.com/bytecodealliance/wasmtime/pull/5673">optimizations</a> and <a href="https://github.com/bytecodealliance/wasmtime/pull/5671">constant propagation rules</a> that were automatically synthesized by <a href="https://github.com/google/souper">Souper</a> from snippets of code harvested from <code>spidermonkey.wasm</code>.</li>
<li><a href="https://github.com/bytecodealliance/wasmtime/pull/6031">New special cases</a> for certain dynamic memory configurations in our bounds-checking implementation.</li>
</ul>
<p>Additionally, <a href="https://github.com/bytecodealliance/wasmtime/pull/5975">I created the <code>wasmtime explore</code> subcommand</a> to dig into native code disassemblies and associate each native instruction with the Wasm bytecode it implements (similar to the Godbolt Compiler Explorer). This new tool has already been incredibly helpful for analyzing what room for improvement still exists, and should help further future optimization efforts in Cranelift and Wasmtime.</p>
<h3>Recent Sightglass Benchmark Results</h3>
<p>Here are some recent Sightglass benchmark results comparing static memories (<code>static.so</code>) versus dynamic memories with a small (64KiB) guard region (<code>dyn-with-guard.so</code>) versus dynamic memories without a guard region (<code>dyn-without-guard.so</code>).</p>
<h4><code>static.so</code> vs <code>dyn-with-guard.so</code></h4>
<p>&lt;details&gt;</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="n">execution</span><span class="w"> </span>:: <span class="nc">cycles</span><span class="w"> </span>:: <span class="nc">benchmarks</span><span class="o">/</span><span class="n">spidermonkey</span><span class="o">/</span><span class="n">benchmark</span><span class="p">.</span><span class="n">wasm</span>

<span class="w">  </span><span class="err">Δ</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">517183665.48</span><span class="w"> </span><span class="err">±</span><span class="w"> </span><span class="mf">6392410.71</span><span class="w"> </span><span class="p">(</span><span class="n">confidence</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">99</span><span class="o">%</span><span class="p">)</span>

<span class="w">  </span><span class="k">static</span><span class="p">.</span><span class="n">so</span><span class="w"> </span><span class="n">is</span><span class="w"> </span><span class="mf">1.55</span><span class="n">x</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="mf">1.56</span><span class="n">x</span><span class="w"> </span><span class="n">faster</span><span class="w"> </span><span class="n">than</span><span class="w"> </span><span class="k">dyn</span><span class="o">-</span><span class="n">with</span><span class="o">-</span><span class="n">guard</span><span class="p">.</span><span class="n">so</span><span class="o">!</span>

<span class="w">  </span><span class="p">[</span><span class="mi">1420787062</span><span class="w"> </span><span class="mf">1450201603.68</span><span class="w"> </span><span class="mi">1522542159</span><span class="p">]</span><span class="w"> </span><span class="k">dyn</span><span class="o">-</span><span class="n">with</span><span class="o">-</span><span class="n">guard</span><span class="p">.</span><span class="n">so</span>
<span class="w">  </span><span class="p">[</span><span class="mi">914013248</span><span class="w"> </span><span class="mf">933017938.20</span><span class="w"> </span><span class="mi">1036142782</span><span class="p">]</span><span class="w"> </span><span class="k">static</span><span class="p">.</span><span class="n">so</span>

<span class="n">execution</span><span class="w"> </span>:: <span class="nc">cycles</span><span class="w"> </span>:: <span class="nc">benchmarks</span><span class="o">/</span><span class="n">bz2</span><span class="o">/</span><span class="n">benchmark</span><span class="p">.</span><span class="n">wasm</span>

<span class="w">  </span><span class="err">Δ</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">45802386.02</span><span class="w"> </span><span class="err">±</span><span class="w"> </span><span class="mf">1486278.64</span><span class="w"> </span><span class="p">(</span><span class="n">confidence</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">99</span><span class="o">%</span><span class="p">)</span>

<span class="w">  </span><span class="k">static</span><span class="p">.</span><span class="n">so</span><span class="w"> </span><span class="n">is</span><span class="w"> </span><span class="mf">1.42</span><span class="n">x</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="mf">1.45</span><span class="n">x</span><span class="w"> </span><span class="n">faster</span><span class="w"> </span><span class="n">than</span><span class="w"> </span><span class="k">dyn</span><span class="o">-</span><span class="n">with</span><span class="o">-</span><span class="n">guard</span><span class="p">.</span><span class="n">so</span><span class="o">!</span>

<span class="w">  </span><span class="p">[</span><span class="mi">146742085</span><span class="w"> </span><span class="mf">150423911.30</span><span class="w"> </span><span class="mi">159078923</span><span class="p">]</span><span class="w"> </span><span class="k">dyn</span><span class="o">-</span><span class="n">with</span><span class="o">-</span><span class="n">guard</span><span class="p">.</span><span class="n">so</span>
<span class="w">  </span><span class="p">[</span><span class="mi">100319894</span><span class="w"> </span><span class="mf">104621525.28</span><span class="w"> </span><span class="mi">149448856</span><span class="p">]</span><span class="w"> </span><span class="k">static</span><span class="p">.</span><span class="n">so</span>

<span class="n">execution</span><span class="w"> </span>:: <span class="nc">cycles</span><span class="w"> </span>:: <span class="nc">benchmarks</span><span class="o">/</span><span class="n">pulldown</span><span class="o">-</span><span class="n">cmark</span><span class="o">/</span><span class="n">benchmark</span><span class="p">.</span><span class="n">wasm</span>

<span class="w">  </span><span class="err">Δ</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">3014103.57</span><span class="w"> </span><span class="err">±</span><span class="w"> </span><span class="mf">316843.43</span><span class="w"> </span><span class="p">(</span><span class="n">confidence</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">99</span><span class="o">%</span><span class="p">)</span>

<span class="w">  </span><span class="k">static</span><span class="p">.</span><span class="n">so</span><span class="w"> </span><span class="n">is</span><span class="w"> </span><span class="mf">1.32</span><span class="n">x</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="mf">1.40</span><span class="n">x</span><span class="w"> </span><span class="n">faster</span><span class="w"> </span><span class="n">than</span><span class="w"> </span><span class="k">dyn</span><span class="o">-</span><span class="n">with</span><span class="o">-</span><span class="n">guard</span><span class="p">.</span><span class="n">so</span><span class="o">!</span>

<span class="w">  </span><span class="p">[</span><span class="mi">10662276</span><span class="w"> </span><span class="mf">11365102.25</span><span class="w"> </span><span class="mi">16630094</span><span class="p">]</span><span class="w"> </span><span class="k">dyn</span><span class="o">-</span><span class="n">with</span><span class="o">-</span><span class="n">guard</span><span class="p">.</span><span class="n">so</span>
<span class="w">  </span><span class="p">[</span><span class="mi">7683153</span><span class="w"> </span><span class="mf">8350998.68</span><span class="w"> </span><span class="mi">13449448</span><span class="p">]</span><span class="w"> </span><span class="k">static</span><span class="p">.</span><span class="n">so</span>

<span class="n">compilation</span><span class="w"> </span>:: <span class="nc">cycles</span><span class="w"> </span>:: <span class="nc">benchmarks</span><span class="o">/</span><span class="n">bz2</span><span class="o">/</span><span class="n">benchmark</span><span class="p">.</span><span class="n">wasm</span>

<span class="w">  </span><span class="err">Δ</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">45130213.24</span><span class="w"> </span><span class="err">±</span><span class="w"> </span><span class="mf">4838200.92</span><span class="w"> </span><span class="p">(</span><span class="n">confidence</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">99</span><span class="o">%</span><span class="p">)</span>

<span class="w">  </span><span class="k">static</span><span class="p">.</span><span class="n">so</span><span class="w"> </span><span class="n">is</span><span class="w"> </span><span class="mf">1.18</span><span class="n">x</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="mf">1.22</span><span class="n">x</span><span class="w"> </span><span class="n">faster</span><span class="w"> </span><span class="n">than</span><span class="w"> </span><span class="k">dyn</span><span class="o">-</span><span class="n">with</span><span class="o">-</span><span class="n">guard</span><span class="p">.</span><span class="n">so</span><span class="o">!</span>

<span class="w">  </span><span class="p">[</span><span class="mi">249993052</span><span class="w"> </span><span class="mf">271654226.14</span><span class="w"> </span><span class="mi">316970220</span><span class="p">]</span><span class="w"> </span><span class="k">dyn</span><span class="o">-</span><span class="n">with</span><span class="o">-</span><span class="n">guard</span><span class="p">.</span><span class="n">so</span>
<span class="w">  </span><span class="p">[</span><span class="mi">208845361</span><span class="w"> </span><span class="mf">226524012.90</span><span class="w"> </span><span class="mi">290090035</span><span class="p">]</span><span class="w"> </span><span class="k">static</span><span class="p">.</span><span class="n">so</span>

<span class="n">compilation</span><span class="w"> </span>:: <span class="nc">cycles</span><span class="w"> </span>:: <span class="nc">benchmarks</span><span class="o">/</span><span class="n">pulldown</span><span class="o">-</span><span class="n">cmark</span><span class="o">/</span><span class="n">benchmark</span><span class="p">.</span><span class="n">wasm</span>

<span class="w">  </span><span class="err">Δ</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">53326476.11</span><span class="w"> </span><span class="err">±</span><span class="w"> </span><span class="mf">5528961.43</span><span class="w"> </span><span class="p">(</span><span class="n">confidence</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">99</span><span class="o">%</span><span class="p">)</span>

<span class="w">  </span><span class="k">static</span><span class="p">.</span><span class="n">so</span><span class="w"> </span><span class="n">is</span><span class="w"> </span><span class="mf">1.16</span><span class="n">x</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="mf">1.19</span><span class="n">x</span><span class="w"> </span><span class="n">faster</span><span class="w"> </span><span class="n">than</span><span class="w"> </span><span class="k">dyn</span><span class="o">-</span><span class="n">with</span><span class="o">-</span><span class="n">guard</span><span class="p">.</span><span class="n">so</span><span class="o">!</span>

<span class="w">  </span><span class="p">[</span><span class="mi">330373001</span><span class="w"> </span><span class="mf">356824375.72</span><span class="w"> </span><span class="mi">397185785</span><span class="p">]</span><span class="w"> </span><span class="k">dyn</span><span class="o">-</span><span class="n">with</span><span class="o">-</span><span class="n">guard</span><span class="p">.</span><span class="n">so</span>
<span class="w">  </span><span class="p">[</span><span class="mi">279072702</span><span class="w"> </span><span class="mf">303497899.61</span><span class="w"> </span><span class="mi">348984338</span><span class="p">]</span><span class="w"> </span><span class="k">static</span><span class="p">.</span><span class="n">so</span>

<span class="n">compilation</span><span class="w"> </span>:: <span class="nc">cycles</span><span class="w"> </span>:: <span class="nc">benchmarks</span><span class="o">/</span><span class="n">spidermonkey</span><span class="o">/</span><span class="n">benchmark</span><span class="p">.</span><span class="n">wasm</span>

<span class="w">  </span><span class="err">Δ</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">1163853854.64</span><span class="w"> </span><span class="err">±</span><span class="w"> </span><span class="mf">81595847.03</span><span class="w"> </span><span class="p">(</span><span class="n">confidence</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">99</span><span class="o">%</span><span class="p">)</span>

<span class="w">  </span><span class="k">static</span><span class="p">.</span><span class="n">so</span><span class="w"> </span><span class="n">is</span><span class="w"> </span><span class="mf">1.15</span><span class="n">x</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="mf">1.18</span><span class="n">x</span><span class="w"> </span><span class="n">faster</span><span class="w"> </span><span class="n">than</span><span class="w"> </span><span class="k">dyn</span><span class="o">-</span><span class="n">with</span><span class="o">-</span><span class="n">guard</span><span class="p">.</span><span class="n">so</span><span class="o">!</span>

<span class="w">  </span><span class="p">[</span><span class="mi">8097294016</span><span class="w"> </span><span class="mf">8213392062.47</span><span class="w"> </span><span class="mi">10103274666</span><span class="p">]</span><span class="w"> </span><span class="k">dyn</span><span class="o">-</span><span class="n">with</span><span class="o">-</span><span class="n">guard</span><span class="p">.</span><span class="n">so</span>
<span class="w">  </span><span class="p">[</span><span class="mi">6969056325</span><span class="w"> </span><span class="mf">7049538207.83</span><span class="w"> </span><span class="mi">8442021515</span><span class="p">]</span><span class="w"> </span><span class="k">static</span><span class="p">.</span><span class="n">so</span>
</code></pre></div>
<p>&lt;/details&gt;</p>
<h4><code>static.so</code> vs <code>dyn-without-guard.so</code></h4>
<p>&lt;details&gt;</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="n">execution</span><span class="w"> </span>:: <span class="nc">cycles</span><span class="w"> </span>:: <span class="nc">benchmarks</span><span class="o">/</span><span class="n">spidermonkey</span><span class="o">/</span><span class="n">benchmark</span><span class="p">.</span><span class="n">wasm</span>

<span class="w">  </span><span class="err">Δ</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">594932587.44</span><span class="w"> </span><span class="err">±</span><span class="w"> </span><span class="mf">6811906.18</span><span class="w"> </span><span class="p">(</span><span class="n">confidence</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">99</span><span class="o">%</span><span class="p">)</span>

<span class="w">  </span><span class="k">static</span><span class="p">.</span><span class="n">so</span><span class="w"> </span><span class="n">is</span><span class="w"> </span><span class="mf">1.63</span><span class="n">x</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="mf">1.65</span><span class="n">x</span><span class="w"> </span><span class="n">faster</span><span class="w"> </span><span class="n">than</span><span class="w"> </span><span class="k">dyn</span><span class="o">-</span><span class="n">without</span><span class="o">-</span><span class="n">guard</span><span class="p">.</span><span class="n">so</span><span class="o">!</span>

<span class="w">  </span><span class="p">[</span><span class="mi">1494952789</span><span class="w"> </span><span class="mf">1524945424.11</span><span class="w"> </span><span class="mi">1606143187</span><span class="p">]</span><span class="w"> </span><span class="k">dyn</span><span class="o">-</span><span class="n">without</span><span class="o">-</span><span class="n">guard</span><span class="p">.</span><span class="n">so</span>
<span class="w">  </span><span class="p">[</span><span class="mi">908877847</span><span class="w"> </span><span class="mf">930012836.67</span><span class="w"> </span><span class="mi">980176520</span><span class="p">]</span><span class="w"> </span><span class="k">static</span><span class="p">.</span><span class="n">so</span>

<span class="n">execution</span><span class="w"> </span>:: <span class="nc">cycles</span><span class="w"> </span>:: <span class="nc">benchmarks</span><span class="o">/</span><span class="n">bz2</span><span class="o">/</span><span class="n">benchmark</span><span class="p">.</span><span class="n">wasm</span>

<span class="w">  </span><span class="err">Δ</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">49482140.46</span><span class="w"> </span><span class="err">±</span><span class="w"> </span><span class="mf">2175287.73</span><span class="w"> </span><span class="p">(</span><span class="n">confidence</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">99</span><span class="o">%</span><span class="p">)</span>

<span class="w">  </span><span class="k">static</span><span class="p">.</span><span class="n">so</span><span class="w"> </span><span class="n">is</span><span class="w"> </span><span class="mf">1.45</span><span class="n">x</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="mf">1.49</span><span class="n">x</span><span class="w"> </span><span class="n">faster</span><span class="w"> </span><span class="n">than</span><span class="w"> </span><span class="k">dyn</span><span class="o">-</span><span class="n">without</span><span class="o">-</span><span class="n">guard</span><span class="p">.</span><span class="n">so</span><span class="o">!</span>

<span class="w">  </span><span class="p">[</span><span class="mi">149370743</span><span class="w"> </span><span class="mf">154540290.45</span><span class="w"> </span><span class="mi">163713075</span><span class="p">]</span><span class="w"> </span><span class="k">dyn</span><span class="o">-</span><span class="n">without</span><span class="o">-</span><span class="n">guard</span><span class="p">.</span><span class="n">so</span>
<span class="w">  </span><span class="p">[</span><span class="mi">99902180</span><span class="w"> </span><span class="mf">105058149.99</span><span class="w"> </span><span class="mi">163151023</span><span class="p">]</span><span class="w"> </span><span class="k">static</span><span class="p">.</span><span class="n">so</span>

<span class="n">compilation</span><span class="w"> </span>:: <span class="nc">cycles</span><span class="w"> </span>:: <span class="nc">benchmarks</span><span class="o">/</span><span class="n">bz2</span><span class="o">/</span><span class="n">benchmark</span><span class="p">.</span><span class="n">wasm</span>

<span class="w">  </span><span class="err">Δ</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">54959651.89</span><span class="w"> </span><span class="err">±</span><span class="w"> </span><span class="mf">5371934.09</span><span class="w"> </span><span class="p">(</span><span class="n">confidence</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">99</span><span class="o">%</span><span class="p">)</span>

<span class="w">  </span><span class="k">static</span><span class="p">.</span><span class="n">so</span><span class="w"> </span><span class="n">is</span><span class="w"> </span><span class="mf">1.22</span><span class="n">x</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="mf">1.26</span><span class="n">x</span><span class="w"> </span><span class="n">faster</span><span class="w"> </span><span class="n">than</span><span class="w"> </span><span class="k">dyn</span><span class="o">-</span><span class="n">without</span><span class="o">-</span><span class="n">guard</span><span class="p">.</span><span class="n">so</span><span class="o">!</span>

<span class="w">  </span><span class="p">[</span><span class="mi">258958338</span><span class="w"> </span><span class="mf">282812487.71</span><span class="w"> </span><span class="mi">327560254</span><span class="p">]</span><span class="w"> </span><span class="k">dyn</span><span class="o">-</span><span class="n">without</span><span class="o">-</span><span class="n">guard</span><span class="p">.</span><span class="n">so</span>
<span class="w">  </span><span class="p">[</span><span class="mi">210542623</span><span class="w"> </span><span class="mf">227852835.82</span><span class="w"> </span><span class="mi">315990395</span><span class="p">]</span><span class="w"> </span><span class="k">static</span><span class="p">.</span><span class="n">so</span>

<span class="n">compilation</span><span class="w"> </span>:: <span class="nc">cycles</span><span class="w"> </span>:: <span class="nc">benchmarks</span><span class="o">/</span><span class="n">spidermonkey</span><span class="o">/</span><span class="n">benchmark</span><span class="p">.</span><span class="n">wasm</span>

<span class="w">  </span><span class="err">Δ</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">1592325533.89</span><span class="w"> </span><span class="err">±</span><span class="w"> </span><span class="mf">100212378.19</span><span class="w"> </span><span class="p">(</span><span class="n">confidence</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">99</span><span class="o">%</span><span class="p">)</span>

<span class="w">  </span><span class="k">static</span><span class="p">.</span><span class="n">so</span><span class="w"> </span><span class="n">is</span><span class="w"> </span><span class="mf">1.21</span><span class="n">x</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="mf">1.24</span><span class="n">x</span><span class="w"> </span><span class="n">faster</span><span class="w"> </span><span class="n">than</span><span class="w"> </span><span class="k">dyn</span><span class="o">-</span><span class="n">without</span><span class="o">-</span><span class="n">guard</span><span class="p">.</span><span class="n">so</span><span class="o">!</span>

<span class="w">  </span><span class="p">[</span><span class="mi">8494305552</span><span class="w"> </span><span class="mf">8674966162.14</span><span class="w"> </span><span class="mi">10607319542</span><span class="p">]</span><span class="w"> </span><span class="k">dyn</span><span class="o">-</span><span class="n">without</span><span class="o">-</span><span class="n">guard</span><span class="p">.</span><span class="n">so</span>
<span class="w">  </span><span class="p">[</span><span class="mi">6985640940</span><span class="w"> </span><span class="mf">7082640628.25</span><span class="w"> </span><span class="mi">8405451996</span><span class="p">]</span><span class="w"> </span><span class="k">static</span><span class="p">.</span><span class="n">so</span>

<span class="n">compilation</span><span class="w"> </span>:: <span class="nc">cycles</span><span class="w"> </span>:: <span class="nc">benchmarks</span><span class="o">/</span><span class="n">pulldown</span><span class="o">-</span><span class="n">cmark</span><span class="o">/</span><span class="n">benchmark</span><span class="p">.</span><span class="n">wasm</span>

<span class="w">  </span><span class="err">Δ</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">66518323.42</span><span class="w"> </span><span class="err">±</span><span class="w"> </span><span class="mf">5778757.98</span><span class="w"> </span><span class="p">(</span><span class="n">confidence</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">99</span><span class="o">%</span><span class="p">)</span>

<span class="w">  </span><span class="k">static</span><span class="p">.</span><span class="n">so</span><span class="w"> </span><span class="n">is</span><span class="w"> </span><span class="mf">1.20</span><span class="n">x</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="mf">1.24</span><span class="n">x</span><span class="w"> </span><span class="n">faster</span><span class="w"> </span><span class="n">than</span><span class="w"> </span><span class="k">dyn</span><span class="o">-</span><span class="n">without</span><span class="o">-</span><span class="n">guard</span><span class="p">.</span><span class="n">so</span><span class="o">!</span>

<span class="w">  </span><span class="p">[</span><span class="mi">342947509</span><span class="w"> </span><span class="mf">371023668.35</span><span class="w"> </span><span class="mi">415514806</span><span class="p">]</span><span class="w"> </span><span class="k">dyn</span><span class="o">-</span><span class="n">without</span><span class="o">-</span><span class="n">guard</span><span class="p">.</span><span class="n">so</span>
<span class="w">  </span><span class="p">[</span><span class="mi">277471563</span><span class="w"> </span><span class="mf">304505344.93</span><span class="w"> </span><span class="mi">339940435</span><span class="p">]</span><span class="w"> </span><span class="k">static</span><span class="p">.</span><span class="n">so</span>

<span class="n">execution</span><span class="w"> </span>:: <span class="nc">cycles</span><span class="w"> </span>:: <span class="nc">benchmarks</span><span class="o">/</span><span class="n">pulldown</span><span class="o">-</span><span class="n">cmark</span><span class="o">/</span><span class="n">benchmark</span><span class="p">.</span><span class="n">wasm</span>

<span class="w">  </span><span class="err">Δ</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">1217702.33</span><span class="w"> </span><span class="err">±</span><span class="w"> </span><span class="mf">627813.45</span><span class="w"> </span><span class="p">(</span><span class="n">confidence</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">99</span><span class="o">%</span><span class="p">)</span>

<span class="w">  </span><span class="k">static</span><span class="p">.</span><span class="n">so</span><span class="w"> </span><span class="n">is</span><span class="w"> </span><span class="mf">1.06</span><span class="n">x</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="mf">1.18</span><span class="n">x</span><span class="w"> </span><span class="n">faster</span><span class="w"> </span><span class="n">than</span><span class="w"> </span><span class="k">dyn</span><span class="o">-</span><span class="n">without</span><span class="o">-</span><span class="n">guard</span><span class="p">.</span><span class="n">so</span><span class="o">!</span>

<span class="w">  </span><span class="p">[</span><span class="mi">11111517</span><span class="w"> </span><span class="mf">11632130.88</span><span class="w"> </span><span class="mi">14705814</span><span class="p">]</span><span class="w"> </span><span class="k">dyn</span><span class="o">-</span><span class="n">without</span><span class="o">-</span><span class="n">guard</span><span class="p">.</span><span class="n">so</span>
<span class="w">  </span><span class="p">[</span><span class="mi">7682848</span><span class="w"> </span><span class="mf">10414428.55</span><span class="w"> </span><span class="mi">14122261</span><span class="p">]</span><span class="w"> </span><span class="k">static</span><span class="p">.</span><span class="n">so</span>
</code></pre></div>
<p>&lt;/details&gt;</p>
<h4>Comparing Wasmtime and SpiderMonkey</h4>
<p>To get a sense of whether our 1.55x slowdown when enabling explicit bounds checks was typical of other engines, I also benchmarked SpiderMonkey (native) running Sightglass's <code>spidermonkey.wasm</code> benchmark with virtual memory guard pages vs with explicit bounds checks.</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="n">execution</span><span class="w"> </span>:: <span class="nc">milliseconds</span><span class="w"> </span>:: <span class="nc">spidermonkey</span><span class="p">.</span><span class="n">wasm</span>

<span class="w">  </span><span class="err">Δ</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">163.62</span><span class="w"> </span><span class="err">±</span><span class="w"> </span><span class="mf">5.57</span><span class="w"> </span><span class="p">(</span><span class="n">confidence</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">99</span><span class="o">%</span><span class="p">)</span>

<span class="w">  </span><span class="kr">virtual</span><span class="o">-</span><span class="n">memory</span><span class="o">-</span><span class="n">spidermonkey</span><span class="w"> </span><span class="n">is</span><span class="w"> </span><span class="mf">1.52</span><span class="n">x</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="mf">1.56</span><span class="n">x</span><span class="w"> </span><span class="n">faster</span><span class="w"> </span><span class="n">than</span><span class="w"> </span><span class="n">bounds</span><span class="o">-</span><span class="n">checks</span><span class="o">-</span><span class="n">spidermonkey</span><span class="o">!</span>

<span class="w">  </span><span class="p">[</span><span class="mi">446</span><span class="w"> </span><span class="mf">465.49</span><span class="w"> </span><span class="mi">520</span><span class="p">]</span><span class="w"> </span><span class="n">bounds</span><span class="o">-</span><span class="n">checks</span><span class="o">-</span><span class="n">spidermonkey</span>
<span class="w">  </span><span class="p">[</span><span class="mi">290</span><span class="w"> </span><span class="mf">301.87</span><span class="w"> </span><span class="mi">353</span><span class="p">]</span><span class="w"> </span><span class="kr">virtual</span><span class="o">-</span><span class="n">memory</span><span class="o">-</span><span class="n">spidermonkey</span>
</code></pre></div>
<p>Because SpiderMonkey's slowdown is almost identical to Wasmtime's, we can infer that there aren't any critical bounds-checking optimizations that SpiderMonkey performs but Wasmtime/Cranelift does not. This is reassuring: it means we can basically ignore other engines (or at least SpiderMonkey) for now, when trying to further improve codegen when explicit bounds checks are enabled, and focus only on ourselves.</p>
<h2>Proposed Future Work</h2>
<p>What fruit remains to be harvested? I've been digging into <code>spidermonkey.wasm</code>'s hot functions (as reported by <code>perf</code> on Linux) and staring at disassemblies to get an idea of how much room for improvement we still have. In short: a lot!</p>
<p>I found many sequences of back-to-back <br>
[message truncated]</p>
</blockquote>



<a name="344069655"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%236094%20Further%20Improve%20Execution%20Speed%20wi.../near/344069655" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.236094.20Further.20Improve.20Execution.20Speed.20wi.2E.2E.2E.html#344069655">(Mar 23 2023 at 18:35)</a>:</h4>
<p>fitzgen labeled <a href="https://github.com/bytecodealliance/wasmtime/issues/6094">issue #6094</a>:</p>
<blockquote>
<p>I've been digging into Cranelift's and Wasmtime's code quality and Wasm execution throughput when "dynamic memories" with explicit bounds checks are used to implement Wasm linear memories. Here I'm summarizing the progress made thus far here, and laying out what I believe the next steps to continue this effort should be.</p>
<p>Static memories require large reservations of virtual memory, to the extent that it can become a bottleneck for how many Wasm instances can exist concurrently in a system. Dynamic memories, on the other hand, require very little or even zero virtual memory reservations (depending on configuration) beyond the actually resident pages backing the Wasm linear memory itself. Additionally, when dynamic memories are configured without any guard regions, they incur zero virtual memory-related syscalls on instantiation and tear down (modulo any copy-on-write heap image initialization). <a href="https://github.com/bytecodealliance/wasmtime/issues/4637">These syscalls have been observed to be bottlenecks in concurrent systems due to VMA locks taken in the kernel.</a></p>
<p>Furthermore these issues will only compound in the future. Right now, each tenant in a multi-tenant system is a single core Wasm module with a single Wasm linear memory. With the component model, a tenant will instead be a Wasm component that is made up of many core Wasm modules, each with their own linear memories. If the average Wasm component contains five linear memories, then the multi-tenant system can only support one fifth as many concurrent tenants under the component model, and instantiating and tearing down each tenant's service will take five times as many syscalls as it does today.</p>
<p>So there is a lot of pressure towards implementing Wasm linear memories with dynamic memories. The downside is that dynamic memories currently incur roughly 55% overhead to Wasm execution throughput compared to static memories. That is, a Wasm computation that takes 1 second in a static memory will take about 1.55 seconds in a dynamic memory. This is because dynamic memory accesses must be explicitly bounds checked rather than caught after the fact via page faults like out-of-bounds static memory accesses. The goal of the effort described here is to minimize this overhead.</p>
<p>I don't intend to continue this work in the immediate future, so I wanted to make sure everything was summarized and documented for posterity, as well as written down while it is still fresh in my mind. Additionally I have proposals for new optimization passes we should implement in the future, and this issue can serve as a forum for discussing them.</p>
<h2>Progress Made Thus Far</h2>
<p><strong>Before I began this effort, running the <code>spidermonkey.wasm</code> benchmark in Sightglass with static memories was 3.06x faster than doing the same with dynamic memories. Now we are down to static memories being only 1.55x faster.</strong></p>
<p>This improvement comes from a number of sources:</p>
<ul>
<li><a href="https://github.com/bytecodealliance/wasmtime/pull/5190">Deduplicating explicit bounds checks and Spectre mitigations</a>, since our Spectre mitigations effectively perform bounds checks already, the additional explicit bounds checks were redundant.</li>
<li>Ensuring that our global value numbering (GVN) optimization pass could optimize and deduplicate <a href="https://github.com/bytecodealliance/wasmtime/pull/5520"><code>uadd_overflow_trap</code></a> and <a href="https://github.com/bytecodealliance/wasmtime/pull/5517"><code>select_spectre_guard</code></a> instructions, both of which are emitted in our bounds-checking sequence.</li>
<li>The introduction of a variety of <a href="https://github.com/bytecodealliance/wasmtime/pull/5676">new</a> <a href="https://github.com/bytecodealliance/wasmtime/pull/5772">peephole</a> <a href="https://github.com/bytecodealliance/wasmtime/pull/5673">optimizations</a> and <a href="https://github.com/bytecodealliance/wasmtime/pull/5671">constant propagation rules</a> that were automatically synthesized by <a href="https://github.com/google/souper">Souper</a> from snippets of code harvested from <code>spidermonkey.wasm</code>.</li>
<li><a href="https://github.com/bytecodealliance/wasmtime/pull/6031">New special cases</a> for certain dynamic memory configurations in our bounds-checking implementation.</li>
</ul>
<p>Additionally, <a href="https://github.com/bytecodealliance/wasmtime/pull/5975">I created the <code>wasmtime explore</code> subcommand</a> to dig into native code disassemblies and associate each native instruction with the Wasm bytecode it implements (similar to the Godbolt Compiler Explorer). This new tool has already been incredibly helpful for analyzing what room for improvement still exists, and should help further future optimization efforts in Cranelift and Wasmtime.</p>
<h3>Recent Sightglass Benchmark Results</h3>
<p>Here are some recent Sightglass benchmark results comparing static memories (<code>static.so</code>) versus dynamic memories with a small (64KiB) guard region (<code>dyn-with-guard.so</code>) versus dynamic memories without a guard region (<code>dyn-without-guard.so</code>).</p>
<h4><code>static.so</code> vs <code>dyn-with-guard.so</code></h4>
<p>&lt;details&gt;</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="n">execution</span><span class="w"> </span>:: <span class="nc">cycles</span><span class="w"> </span>:: <span class="nc">benchmarks</span><span class="o">/</span><span class="n">spidermonkey</span><span class="o">/</span><span class="n">benchmark</span><span class="p">.</span><span class="n">wasm</span>

<span class="w">  </span><span class="err">Δ</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">517183665.48</span><span class="w"> </span><span class="err">±</span><span class="w"> </span><span class="mf">6392410.71</span><span class="w"> </span><span class="p">(</span><span class="n">confidence</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">99</span><span class="o">%</span><span class="p">)</span>

<span class="w">  </span><span class="k">static</span><span class="p">.</span><span class="n">so</span><span class="w"> </span><span class="n">is</span><span class="w"> </span><span class="mf">1.55</span><span class="n">x</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="mf">1.56</span><span class="n">x</span><span class="w"> </span><span class="n">faster</span><span class="w"> </span><span class="n">than</span><span class="w"> </span><span class="k">dyn</span><span class="o">-</span><span class="n">with</span><span class="o">-</span><span class="n">guard</span><span class="p">.</span><span class="n">so</span><span class="o">!</span>

<span class="w">  </span><span class="p">[</span><span class="mi">1420787062</span><span class="w"> </span><span class="mf">1450201603.68</span><span class="w"> </span><span class="mi">1522542159</span><span class="p">]</span><span class="w"> </span><span class="k">dyn</span><span class="o">-</span><span class="n">with</span><span class="o">-</span><span class="n">guard</span><span class="p">.</span><span class="n">so</span>
<span class="w">  </span><span class="p">[</span><span class="mi">914013248</span><span class="w"> </span><span class="mf">933017938.20</span><span class="w"> </span><span class="mi">1036142782</span><span class="p">]</span><span class="w"> </span><span class="k">static</span><span class="p">.</span><span class="n">so</span>

<span class="n">execution</span><span class="w"> </span>:: <span class="nc">cycles</span><span class="w"> </span>:: <span class="nc">benchmarks</span><span class="o">/</span><span class="n">bz2</span><span class="o">/</span><span class="n">benchmark</span><span class="p">.</span><span class="n">wasm</span>

<span class="w">  </span><span class="err">Δ</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">45802386.02</span><span class="w"> </span><span class="err">±</span><span class="w"> </span><span class="mf">1486278.64</span><span class="w"> </span><span class="p">(</span><span class="n">confidence</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">99</span><span class="o">%</span><span class="p">)</span>

<span class="w">  </span><span class="k">static</span><span class="p">.</span><span class="n">so</span><span class="w"> </span><span class="n">is</span><span class="w"> </span><span class="mf">1.42</span><span class="n">x</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="mf">1.45</span><span class="n">x</span><span class="w"> </span><span class="n">faster</span><span class="w"> </span><span class="n">than</span><span class="w"> </span><span class="k">dyn</span><span class="o">-</span><span class="n">with</span><span class="o">-</span><span class="n">guard</span><span class="p">.</span><span class="n">so</span><span class="o">!</span>

<span class="w">  </span><span class="p">[</span><span class="mi">146742085</span><span class="w"> </span><span class="mf">150423911.30</span><span class="w"> </span><span class="mi">159078923</span><span class="p">]</span><span class="w"> </span><span class="k">dyn</span><span class="o">-</span><span class="n">with</span><span class="o">-</span><span class="n">guard</span><span class="p">.</span><span class="n">so</span>
<span class="w">  </span><span class="p">[</span><span class="mi">100319894</span><span class="w"> </span><span class="mf">104621525.28</span><span class="w"> </span><span class="mi">149448856</span><span class="p">]</span><span class="w"> </span><span class="k">static</span><span class="p">.</span><span class="n">so</span>

<span class="n">execution</span><span class="w"> </span>:: <span class="nc">cycles</span><span class="w"> </span>:: <span class="nc">benchmarks</span><span class="o">/</span><span class="n">pulldown</span><span class="o">-</span><span class="n">cmark</span><span class="o">/</span><span class="n">benchmark</span><span class="p">.</span><span class="n">wasm</span>

<span class="w">  </span><span class="err">Δ</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">3014103.57</span><span class="w"> </span><span class="err">±</span><span class="w"> </span><span class="mf">316843.43</span><span class="w"> </span><span class="p">(</span><span class="n">confidence</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">99</span><span class="o">%</span><span class="p">)</span>

<span class="w">  </span><span class="k">static</span><span class="p">.</span><span class="n">so</span><span class="w"> </span><span class="n">is</span><span class="w"> </span><span class="mf">1.32</span><span class="n">x</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="mf">1.40</span><span class="n">x</span><span class="w"> </span><span class="n">faster</span><span class="w"> </span><span class="n">than</span><span class="w"> </span><span class="k">dyn</span><span class="o">-</span><span class="n">with</span><span class="o">-</span><span class="n">guard</span><span class="p">.</span><span class="n">so</span><span class="o">!</span>

<span class="w">  </span><span class="p">[</span><span class="mi">10662276</span><span class="w"> </span><span class="mf">11365102.25</span><span class="w"> </span><span class="mi">16630094</span><span class="p">]</span><span class="w"> </span><span class="k">dyn</span><span class="o">-</span><span class="n">with</span><span class="o">-</span><span class="n">guard</span><span class="p">.</span><span class="n">so</span>
<span class="w">  </span><span class="p">[</span><span class="mi">7683153</span><span class="w"> </span><span class="mf">8350998.68</span><span class="w"> </span><span class="mi">13449448</span><span class="p">]</span><span class="w"> </span><span class="k">static</span><span class="p">.</span><span class="n">so</span>

<span class="n">compilation</span><span class="w"> </span>:: <span class="nc">cycles</span><span class="w"> </span>:: <span class="nc">benchmarks</span><span class="o">/</span><span class="n">bz2</span><span class="o">/</span><span class="n">benchmark</span><span class="p">.</span><span class="n">wasm</span>

<span class="w">  </span><span class="err">Δ</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">45130213.24</span><span class="w"> </span><span class="err">±</span><span class="w"> </span><span class="mf">4838200.92</span><span class="w"> </span><span class="p">(</span><span class="n">confidence</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">99</span><span class="o">%</span><span class="p">)</span>

<span class="w">  </span><span class="k">static</span><span class="p">.</span><span class="n">so</span><span class="w"> </span><span class="n">is</span><span class="w"> </span><span class="mf">1.18</span><span class="n">x</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="mf">1.22</span><span class="n">x</span><span class="w"> </span><span class="n">faster</span><span class="w"> </span><span class="n">than</span><span class="w"> </span><span class="k">dyn</span><span class="o">-</span><span class="n">with</span><span class="o">-</span><span class="n">guard</span><span class="p">.</span><span class="n">so</span><span class="o">!</span>

<span class="w">  </span><span class="p">[</span><span class="mi">249993052</span><span class="w"> </span><span class="mf">271654226.14</span><span class="w"> </span><span class="mi">316970220</span><span class="p">]</span><span class="w"> </span><span class="k">dyn</span><span class="o">-</span><span class="n">with</span><span class="o">-</span><span class="n">guard</span><span class="p">.</span><span class="n">so</span>
<span class="w">  </span><span class="p">[</span><span class="mi">208845361</span><span class="w"> </span><span class="mf">226524012.90</span><span class="w"> </span><span class="mi">290090035</span><span class="p">]</span><span class="w"> </span><span class="k">static</span><span class="p">.</span><span class="n">so</span>

<span class="n">compilation</span><span class="w"> </span>:: <span class="nc">cycles</span><span class="w"> </span>:: <span class="nc">benchmarks</span><span class="o">/</span><span class="n">pulldown</span><span class="o">-</span><span class="n">cmark</span><span class="o">/</span><span class="n">benchmark</span><span class="p">.</span><span class="n">wasm</span>

<span class="w">  </span><span class="err">Δ</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">53326476.11</span><span class="w"> </span><span class="err">±</span><span class="w"> </span><span class="mf">5528961.43</span><span class="w"> </span><span class="p">(</span><span class="n">confidence</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">99</span><span class="o">%</span><span class="p">)</span>

<span class="w">  </span><span class="k">static</span><span class="p">.</span><span class="n">so</span><span class="w"> </span><span class="n">is</span><span class="w"> </span><span class="mf">1.16</span><span class="n">x</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="mf">1.19</span><span class="n">x</span><span class="w"> </span><span class="n">faster</span><span class="w"> </span><span class="n">than</span><span class="w"> </span><span class="k">dyn</span><span class="o">-</span><span class="n">with</span><span class="o">-</span><span class="n">guard</span><span class="p">.</span><span class="n">so</span><span class="o">!</span>

<span class="w">  </span><span class="p">[</span><span class="mi">330373001</span><span class="w"> </span><span class="mf">356824375.72</span><span class="w"> </span><span class="mi">397185785</span><span class="p">]</span><span class="w"> </span><span class="k">dyn</span><span class="o">-</span><span class="n">with</span><span class="o">-</span><span class="n">guard</span><span class="p">.</span><span class="n">so</span>
<span class="w">  </span><span class="p">[</span><span class="mi">279072702</span><span class="w"> </span><span class="mf">303497899.61</span><span class="w"> </span><span class="mi">348984338</span><span class="p">]</span><span class="w"> </span><span class="k">static</span><span class="p">.</span><span class="n">so</span>

<span class="n">compilation</span><span class="w"> </span>:: <span class="nc">cycles</span><span class="w"> </span>:: <span class="nc">benchmarks</span><span class="o">/</span><span class="n">spidermonkey</span><span class="o">/</span><span class="n">benchmark</span><span class="p">.</span><span class="n">wasm</span>

<span class="w">  </span><span class="err">Δ</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">1163853854.64</span><span class="w"> </span><span class="err">±</span><span class="w"> </span><span class="mf">81595847.03</span><span class="w"> </span><span class="p">(</span><span class="n">confidence</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">99</span><span class="o">%</span><span class="p">)</span>

<span class="w">  </span><span class="k">static</span><span class="p">.</span><span class="n">so</span><span class="w"> </span><span class="n">is</span><span class="w"> </span><span class="mf">1.15</span><span class="n">x</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="mf">1.18</span><span class="n">x</span><span class="w"> </span><span class="n">faster</span><span class="w"> </span><span class="n">than</span><span class="w"> </span><span class="k">dyn</span><span class="o">-</span><span class="n">with</span><span class="o">-</span><span class="n">guard</span><span class="p">.</span><span class="n">so</span><span class="o">!</span>

<span class="w">  </span><span class="p">[</span><span class="mi">8097294016</span><span class="w"> </span><span class="mf">8213392062.47</span><span class="w"> </span><span class="mi">10103274666</span><span class="p">]</span><span class="w"> </span><span class="k">dyn</span><span class="o">-</span><span class="n">with</span><span class="o">-</span><span class="n">guard</span><span class="p">.</span><span class="n">so</span>
<span class="w">  </span><span class="p">[</span><span class="mi">6969056325</span><span class="w"> </span><span class="mf">7049538207.83</span><span class="w"> </span><span class="mi">8442021515</span><span class="p">]</span><span class="w"> </span><span class="k">static</span><span class="p">.</span><span class="n">so</span>
</code></pre></div>
<p>&lt;/details&gt;</p>
<h4><code>static.so</code> vs <code>dyn-without-guard.so</code></h4>
<p>&lt;details&gt;</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="n">execution</span><span class="w"> </span>:: <span class="nc">cycles</span><span class="w"> </span>:: <span class="nc">benchmarks</span><span class="o">/</span><span class="n">spidermonkey</span><span class="o">/</span><span class="n">benchmark</span><span class="p">.</span><span class="n">wasm</span>

<span class="w">  </span><span class="err">Δ</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">594932587.44</span><span class="w"> </span><span class="err">±</span><span class="w"> </span><span class="mf">6811906.18</span><span class="w"> </span><span class="p">(</span><span class="n">confidence</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">99</span><span class="o">%</span><span class="p">)</span>

<span class="w">  </span><span class="k">static</span><span class="p">.</span><span class="n">so</span><span class="w"> </span><span class="n">is</span><span class="w"> </span><span class="mf">1.63</span><span class="n">x</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="mf">1.65</span><span class="n">x</span><span class="w"> </span><span class="n">faster</span><span class="w"> </span><span class="n">than</span><span class="w"> </span><span class="k">dyn</span><span class="o">-</span><span class="n">without</span><span class="o">-</span><span class="n">guard</span><span class="p">.</span><span class="n">so</span><span class="o">!</span>

<span class="w">  </span><span class="p">[</span><span class="mi">1494952789</span><span class="w"> </span><span class="mf">1524945424.11</span><span class="w"> </span><span class="mi">1606143187</span><span class="p">]</span><span class="w"> </span><span class="k">dyn</span><span class="o">-</span><span class="n">without</span><span class="o">-</span><span class="n">guard</span><span class="p">.</span><span class="n">so</span>
<span class="w">  </span><span class="p">[</span><span class="mi">908877847</span><span class="w"> </span><span class="mf">930012836.67</span><span class="w"> </span><span class="mi">980176520</span><span class="p">]</span><span class="w"> </span><span class="k">static</span><span class="p">.</span><span class="n">so</span>

<span class="n">execution</span><span class="w"> </span>:: <span class="nc">cycles</span><span class="w"> </span>:: <span class="nc">benchmarks</span><span class="o">/</span><span class="n">bz2</span><span class="o">/</span><span class="n">benchmark</span><span class="p">.</span><span class="n">wasm</span>

<span class="w">  </span><span class="err">Δ</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">49482140.46</span><span class="w"> </span><span class="err">±</span><span class="w"> </span><span class="mf">2175287.73</span><span class="w"> </span><span class="p">(</span><span class="n">confidence</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">99</span><span class="o">%</span><span class="p">)</span>

<span class="w">  </span><span class="k">static</span><span class="p">.</span><span class="n">so</span><span class="w"> </span><span class="n">is</span><span class="w"> </span><span class="mf">1.45</span><span class="n">x</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="mf">1.49</span><span class="n">x</span><span class="w"> </span><span class="n">faster</span><span class="w"> </span><span class="n">than</span><span class="w"> </span><span class="k">dyn</span><span class="o">-</span><span class="n">without</span><span class="o">-</span><span class="n">guard</span><span class="p">.</span><span class="n">so</span><span class="o">!</span>

<span class="w">  </span><span class="p">[</span><span class="mi">149370743</span><span class="w"> </span><span class="mf">154540290.45</span><span class="w"> </span><span class="mi">163713075</span><span class="p">]</span><span class="w"> </span><span class="k">dyn</span><span class="o">-</span><span class="n">without</span><span class="o">-</span><span class="n">guard</span><span class="p">.</span><span class="n">so</span>
<span class="w">  </span><span class="p">[</span><span class="mi">99902180</span><span class="w"> </span><span class="mf">105058149.99</span><span class="w"> </span><span class="mi">163151023</span><span class="p">]</span><span class="w"> </span><span class="k">static</span><span class="p">.</span><span class="n">so</span>

<span class="n">compilation</span><span class="w"> </span>:: <span class="nc">cycles</span><span class="w"> </span>:: <span class="nc">benchmarks</span><span class="o">/</span><span class="n">bz2</span><span class="o">/</span><span class="n">benchmark</span><span class="p">.</span><span class="n">wasm</span>

<span class="w">  </span><span class="err">Δ</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">54959651.89</span><span class="w"> </span><span class="err">±</span><span class="w"> </span><span class="mf">5371934.09</span><span class="w"> </span><span class="p">(</span><span class="n">confidence</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">99</span><span class="o">%</span><span class="p">)</span>

<span class="w">  </span><span class="k">static</span><span class="p">.</span><span class="n">so</span><span class="w"> </span><span class="n">is</span><span class="w"> </span><span class="mf">1.22</span><span class="n">x</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="mf">1.26</span><span class="n">x</span><span class="w"> </span><span class="n">faster</span><span class="w"> </span><span class="n">than</span><span class="w"> </span><span class="k">dyn</span><span class="o">-</span><span class="n">without</span><span class="o">-</span><span class="n">guard</span><span class="p">.</span><span class="n">so</span><span class="o">!</span>

<span class="w">  </span><span class="p">[</span><span class="mi">258958338</span><span class="w"> </span><span class="mf">282812487.71</span><span class="w"> </span><span class="mi">327560254</span><span class="p">]</span><span class="w"> </span><span class="k">dyn</span><span class="o">-</span><span class="n">without</span><span class="o">-</span><span class="n">guard</span><span class="p">.</span><span class="n">so</span>
<span class="w">  </span><span class="p">[</span><span class="mi">210542623</span><span class="w"> </span><span class="mf">227852835.82</span><span class="w"> </span><span class="mi">315990395</span><span class="p">]</span><span class="w"> </span><span class="k">static</span><span class="p">.</span><span class="n">so</span>

<span class="n">compilation</span><span class="w"> </span>:: <span class="nc">cycles</span><span class="w"> </span>:: <span class="nc">benchmarks</span><span class="o">/</span><span class="n">spidermonkey</span><span class="o">/</span><span class="n">benchmark</span><span class="p">.</span><span class="n">wasm</span>

<span class="w">  </span><span class="err">Δ</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">1592325533.89</span><span class="w"> </span><span class="err">±</span><span class="w"> </span><span class="mf">100212378.19</span><span class="w"> </span><span class="p">(</span><span class="n">confidence</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">99</span><span class="o">%</span><span class="p">)</span>

<span class="w">  </span><span class="k">static</span><span class="p">.</span><span class="n">so</span><span class="w"> </span><span class="n">is</span><span class="w"> </span><span class="mf">1.21</span><span class="n">x</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="mf">1.24</span><span class="n">x</span><span class="w"> </span><span class="n">faster</span><span class="w"> </span><span class="n">than</span><span class="w"> </span><span class="k">dyn</span><span class="o">-</span><span class="n">without</span><span class="o">-</span><span class="n">guard</span><span class="p">.</span><span class="n">so</span><span class="o">!</span>

<span class="w">  </span><span class="p">[</span><span class="mi">8494305552</span><span class="w"> </span><span class="mf">8674966162.14</span><span class="w"> </span><span class="mi">10607319542</span><span class="p">]</span><span class="w"> </span><span class="k">dyn</span><span class="o">-</span><span class="n">without</span><span class="o">-</span><span class="n">guard</span><span class="p">.</span><span class="n">so</span>
<span class="w">  </span><span class="p">[</span><span class="mi">6985640940</span><span class="w"> </span><span class="mf">7082640628.25</span><span class="w"> </span><span class="mi">8405451996</span><span class="p">]</span><span class="w"> </span><span class="k">static</span><span class="p">.</span><span class="n">so</span>

<span class="n">compilation</span><span class="w"> </span>:: <span class="nc">cycles</span><span class="w"> </span>:: <span class="nc">benchmarks</span><span class="o">/</span><span class="n">pulldown</span><span class="o">-</span><span class="n">cmark</span><span class="o">/</span><span class="n">benchmark</span><span class="p">.</span><span class="n">wasm</span>

<span class="w">  </span><span class="err">Δ</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">66518323.42</span><span class="w"> </span><span class="err">±</span><span class="w"> </span><span class="mf">5778757.98</span><span class="w"> </span><span class="p">(</span><span class="n">confidence</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">99</span><span class="o">%</span><span class="p">)</span>

<span class="w">  </span><span class="k">static</span><span class="p">.</span><span class="n">so</span><span class="w"> </span><span class="n">is</span><span class="w"> </span><span class="mf">1.20</span><span class="n">x</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="mf">1.24</span><span class="n">x</span><span class="w"> </span><span class="n">faster</span><span class="w"> </span><span class="n">than</span><span class="w"> </span><span class="k">dyn</span><span class="o">-</span><span class="n">without</span><span class="o">-</span><span class="n">guard</span><span class="p">.</span><span class="n">so</span><span class="o">!</span>

<span class="w">  </span><span class="p">[</span><span class="mi">342947509</span><span class="w"> </span><span class="mf">371023668.35</span><span class="w"> </span><span class="mi">415514806</span><span class="p">]</span><span class="w"> </span><span class="k">dyn</span><span class="o">-</span><span class="n">without</span><span class="o">-</span><span class="n">guard</span><span class="p">.</span><span class="n">so</span>
<span class="w">  </span><span class="p">[</span><span class="mi">277471563</span><span class="w"> </span><span class="mf">304505344.93</span><span class="w"> </span><span class="mi">339940435</span><span class="p">]</span><span class="w"> </span><span class="k">static</span><span class="p">.</span><span class="n">so</span>

<span class="n">execution</span><span class="w"> </span>:: <span class="nc">cycles</span><span class="w"> </span>:: <span class="nc">benchmarks</span><span class="o">/</span><span class="n">pulldown</span><span class="o">-</span><span class="n">cmark</span><span class="o">/</span><span class="n">benchmark</span><span class="p">.</span><span class="n">wasm</span>

<span class="w">  </span><span class="err">Δ</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">1217702.33</span><span class="w"> </span><span class="err">±</span><span class="w"> </span><span class="mf">627813.45</span><span class="w"> </span><span class="p">(</span><span class="n">confidence</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">99</span><span class="o">%</span><span class="p">)</span>

<span class="w">  </span><span class="k">static</span><span class="p">.</span><span class="n">so</span><span class="w"> </span><span class="n">is</span><span class="w"> </span><span class="mf">1.06</span><span class="n">x</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="mf">1.18</span><span class="n">x</span><span class="w"> </span><span class="n">faster</span><span class="w"> </span><span class="n">than</span><span class="w"> </span><span class="k">dyn</span><span class="o">-</span><span class="n">without</span><span class="o">-</span><span class="n">guard</span><span class="p">.</span><span class="n">so</span><span class="o">!</span>

<span class="w">  </span><span class="p">[</span><span class="mi">11111517</span><span class="w"> </span><span class="mf">11632130.88</span><span class="w"> </span><span class="mi">14705814</span><span class="p">]</span><span class="w"> </span><span class="k">dyn</span><span class="o">-</span><span class="n">without</span><span class="o">-</span><span class="n">guard</span><span class="p">.</span><span class="n">so</span>
<span class="w">  </span><span class="p">[</span><span class="mi">7682848</span><span class="w"> </span><span class="mf">10414428.55</span><span class="w"> </span><span class="mi">14122261</span><span class="p">]</span><span class="w"> </span><span class="k">static</span><span class="p">.</span><span class="n">so</span>
</code></pre></div>
<p>&lt;/details&gt;</p>
<h4>Comparing Wasmtime and SpiderMonkey</h4>
<p>To get a sense of whether our 1.55x slowdown when enabling explicit bounds checks was typical of other engines, I also benchmarked SpiderMonkey (native) running Sightglass's <code>spidermonkey.wasm</code> benchmark with virtual memory guard pages vs with explicit bounds checks.</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="n">execution</span><span class="w"> </span>:: <span class="nc">milliseconds</span><span class="w"> </span>:: <span class="nc">spidermonkey</span><span class="p">.</span><span class="n">wasm</span>

<span class="w">  </span><span class="err">Δ</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">163.62</span><span class="w"> </span><span class="err">±</span><span class="w"> </span><span class="mf">5.57</span><span class="w"> </span><span class="p">(</span><span class="n">confidence</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">99</span><span class="o">%</span><span class="p">)</span>

<span class="w">  </span><span class="kr">virtual</span><span class="o">-</span><span class="n">memory</span><span class="o">-</span><span class="n">spidermonkey</span><span class="w"> </span><span class="n">is</span><span class="w"> </span><span class="mf">1.52</span><span class="n">x</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="mf">1.56</span><span class="n">x</span><span class="w"> </span><span class="n">faster</span><span class="w"> </span><span class="n">than</span><span class="w"> </span><span class="n">bounds</span><span class="o">-</span><span class="n">checks</span><span class="o">-</span><span class="n">spidermonkey</span><span class="o">!</span>

<span class="w">  </span><span class="p">[</span><span class="mi">446</span><span class="w"> </span><span class="mf">465.49</span><span class="w"> </span><span class="mi">520</span><span class="p">]</span><span class="w"> </span><span class="n">bounds</span><span class="o">-</span><span class="n">checks</span><span class="o">-</span><span class="n">spidermonkey</span>
<span class="w">  </span><span class="p">[</span><span class="mi">290</span><span class="w"> </span><span class="mf">301.87</span><span class="w"> </span><span class="mi">353</span><span class="p">]</span><span class="w"> </span><span class="kr">virtual</span><span class="o">-</span><span class="n">memory</span><span class="o">-</span><span class="n">spidermonkey</span>
</code></pre></div>
<p>Because SpiderMonkey's slowdown is almost identical to Wasmtime's, we can infer that there aren't any critical bounds-checking optimizations that SpiderMonkey performs but Wasmtime/Cranelift does not. This is reassuring: it means we can basically ignore other engines (or at least SpiderMonkey) for now, when trying to further improve codegen when explicit bounds checks are enabled, and focus only on ourselves.</p>
<h2>Proposed Future Work</h2>
<p>What fruit remains to be harvested? I've been digging into <code>spidermonkey.wasm</code>'s hot functions (as reported by <code>perf</code> on Linux) and staring at disassemblies to get an idea of how much room for improvement we still have. In short: a lot!</p>
<p>I found many sequences of back-to-back <br>
[message truncated]</p>
</blockquote>



<a name="344072254"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%236094%20Further%20Improve%20Execution%20Speed%20wi.../near/344072254" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.236094.20Further.20Improve.20Execution.20Speed.20wi.2E.2E.2E.html#344072254">(Mar 23 2023 at 18:46)</a>:</h4>
<p>fitzgen edited <a href="https://github.com/bytecodealliance/wasmtime/issues/6094">issue #6094</a>:</p>
<blockquote>
<p>I've been digging into Cranelift's and Wasmtime's code quality and Wasm execution throughput when "dynamic memories" with explicit bounds checks are used to implement Wasm linear memories. Here I'm summarizing the progress made thus far here, and laying out what I believe the next steps to continue this effort should be.</p>
<p>Static memories require large reservations of virtual memory, to the extent that it can become a bottleneck for how many Wasm instances can exist concurrently in a system. Dynamic memories, on the other hand, require very little or even zero virtual memory reservations (depending on configuration) beyond the actually resident pages backing the Wasm linear memory itself. Additionally, when dynamic memories are configured without any guard regions, they incur zero virtual memory-related syscalls on instantiation and tear down (modulo any copy-on-write heap image initialization). <a href="https://github.com/bytecodealliance/wasmtime/issues/4637">These syscalls have been observed to be bottlenecks in concurrent systems due to VMA locks taken in the kernel.</a></p>
<p>Furthermore these issues will only compound in the future. Right now, each tenant in a multi-tenant system is a single core Wasm module with a single Wasm linear memory. With the component model, a tenant will instead be a Wasm component that is made up of many core Wasm modules, each with their own linear memories. If the average Wasm component contains five linear memories, then the multi-tenant system can only support one fifth as many concurrent tenants under the component model, and instantiating and tearing down each tenant's service will take five times as many syscalls as it does today.</p>
<p>So there is a lot of pressure towards implementing Wasm linear memories with dynamic memories. The downside is that dynamic memories currently incur roughly 55% overhead to Wasm execution throughput compared to static memories. That is, a Wasm computation that takes 1 second in a static memory will take about 1.55 seconds in a dynamic memory. This is because dynamic memory accesses must be explicitly bounds checked rather than caught after the fact via page faults like out-of-bounds static memory accesses. The goal of the effort described here is to minimize this overhead.</p>
<p>I don't intend to continue this work in the immediate future, so I wanted to make sure everything was summarized and documented for posterity, as well as written down while it is still fresh in my mind. Additionally I have proposals for new optimization passes we should implement in the future, and this issue can serve as a forum for discussing them.</p>
<h2>Progress Made Thus Far</h2>
<p><strong>Before I began this effort, running the <code>spidermonkey.wasm</code> benchmark in Sightglass with static memories was 3.06x faster than doing the same with dynamic memories. Now we are down to static memories being only 1.55x faster.</strong></p>
<p>This improvement comes from a number of sources:</p>
<ul>
<li><a href="https://github.com/bytecodealliance/wasmtime/pull/5190">Deduplicating explicit bounds checks and Spectre mitigations</a>, since our Spectre mitigations effectively perform bounds checks already, the additional explicit bounds checks were redundant.</li>
<li>Ensuring that our global value numbering (GVN) optimization pass could optimize and deduplicate <a href="https://github.com/bytecodealliance/wasmtime/pull/5520"><code>uadd_overflow_trap</code></a> and <a href="https://github.com/bytecodealliance/wasmtime/pull/5517"><code>select_spectre_guard</code></a> instructions, both of which are emitted in our bounds-checking sequence.</li>
<li>The introduction of a variety of <a href="https://github.com/bytecodealliance/wasmtime/pull/5676">new</a> <a href="https://github.com/bytecodealliance/wasmtime/pull/5772">peephole</a> <a href="https://github.com/bytecodealliance/wasmtime/pull/5673">optimizations</a> and <a href="https://github.com/bytecodealliance/wasmtime/pull/5671">constant propagation rules</a> that were automatically synthesized by <a href="https://github.com/google/souper">Souper</a> from snippets of code harvested from <code>spidermonkey.wasm</code>.</li>
<li><a href="https://github.com/bytecodealliance/wasmtime/pull/6031">New special cases</a> for certain dynamic memory configurations in our bounds-checking implementation.</li>
</ul>
<p>Additionally, <a href="https://github.com/bytecodealliance/wasmtime/pull/5975">I created the <code>wasmtime explore</code> subcommand</a> to dig into native code disassemblies and associate each native instruction with the Wasm bytecode it implements (similar to the Godbolt Compiler Explorer). This new tool has already been incredibly helpful for analyzing what room for improvement still exists, and should help further future optimization efforts in Cranelift and Wasmtime.</p>
<h3>Recent Sightglass Benchmark Results</h3>
<p>Here are some recent Sightglass benchmark results comparing static memories (<code>static.so</code>) versus dynamic memories with a small (64KiB) guard region (<code>dyn-with-guard.so</code>) versus dynamic memories without a guard region (<code>dyn-without-guard.so</code>).</p>
<h4><code>static.so</code> vs <code>dyn-with-guard.so</code></h4>
<p>&lt;details&gt;</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="n">execution</span><span class="w"> </span>:: <span class="nc">cycles</span><span class="w"> </span>:: <span class="nc">benchmarks</span><span class="o">/</span><span class="n">spidermonkey</span><span class="o">/</span><span class="n">benchmark</span><span class="p">.</span><span class="n">wasm</span>

<span class="w">  </span><span class="err">Δ</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">517183665.48</span><span class="w"> </span><span class="err">±</span><span class="w"> </span><span class="mf">6392410.71</span><span class="w"> </span><span class="p">(</span><span class="n">confidence</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">99</span><span class="o">%</span><span class="p">)</span>

<span class="w">  </span><span class="k">static</span><span class="p">.</span><span class="n">so</span><span class="w"> </span><span class="n">is</span><span class="w"> </span><span class="mf">1.55</span><span class="n">x</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="mf">1.56</span><span class="n">x</span><span class="w"> </span><span class="n">faster</span><span class="w"> </span><span class="n">than</span><span class="w"> </span><span class="k">dyn</span><span class="o">-</span><span class="n">with</span><span class="o">-</span><span class="n">guard</span><span class="p">.</span><span class="n">so</span><span class="o">!</span>

<span class="w">  </span><span class="p">[</span><span class="mi">1420787062</span><span class="w"> </span><span class="mf">1450201603.68</span><span class="w"> </span><span class="mi">1522542159</span><span class="p">]</span><span class="w"> </span><span class="k">dyn</span><span class="o">-</span><span class="n">with</span><span class="o">-</span><span class="n">guard</span><span class="p">.</span><span class="n">so</span>
<span class="w">  </span><span class="p">[</span><span class="mi">914013248</span><span class="w"> </span><span class="mf">933017938.20</span><span class="w"> </span><span class="mi">1036142782</span><span class="p">]</span><span class="w"> </span><span class="k">static</span><span class="p">.</span><span class="n">so</span>

<span class="n">execution</span><span class="w"> </span>:: <span class="nc">cycles</span><span class="w"> </span>:: <span class="nc">benchmarks</span><span class="o">/</span><span class="n">bz2</span><span class="o">/</span><span class="n">benchmark</span><span class="p">.</span><span class="n">wasm</span>

<span class="w">  </span><span class="err">Δ</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">45802386.02</span><span class="w"> </span><span class="err">±</span><span class="w"> </span><span class="mf">1486278.64</span><span class="w"> </span><span class="p">(</span><span class="n">confidence</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">99</span><span class="o">%</span><span class="p">)</span>

<span class="w">  </span><span class="k">static</span><span class="p">.</span><span class="n">so</span><span class="w"> </span><span class="n">is</span><span class="w"> </span><span class="mf">1.42</span><span class="n">x</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="mf">1.45</span><span class="n">x</span><span class="w"> </span><span class="n">faster</span><span class="w"> </span><span class="n">than</span><span class="w"> </span><span class="k">dyn</span><span class="o">-</span><span class="n">with</span><span class="o">-</span><span class="n">guard</span><span class="p">.</span><span class="n">so</span><span class="o">!</span>

<span class="w">  </span><span class="p">[</span><span class="mi">146742085</span><span class="w"> </span><span class="mf">150423911.30</span><span class="w"> </span><span class="mi">159078923</span><span class="p">]</span><span class="w"> </span><span class="k">dyn</span><span class="o">-</span><span class="n">with</span><span class="o">-</span><span class="n">guard</span><span class="p">.</span><span class="n">so</span>
<span class="w">  </span><span class="p">[</span><span class="mi">100319894</span><span class="w"> </span><span class="mf">104621525.28</span><span class="w"> </span><span class="mi">149448856</span><span class="p">]</span><span class="w"> </span><span class="k">static</span><span class="p">.</span><span class="n">so</span>

<span class="n">execution</span><span class="w"> </span>:: <span class="nc">cycles</span><span class="w"> </span>:: <span class="nc">benchmarks</span><span class="o">/</span><span class="n">pulldown</span><span class="o">-</span><span class="n">cmark</span><span class="o">/</span><span class="n">benchmark</span><span class="p">.</span><span class="n">wasm</span>

<span class="w">  </span><span class="err">Δ</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">3014103.57</span><span class="w"> </span><span class="err">±</span><span class="w"> </span><span class="mf">316843.43</span><span class="w"> </span><span class="p">(</span><span class="n">confidence</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">99</span><span class="o">%</span><span class="p">)</span>

<span class="w">  </span><span class="k">static</span><span class="p">.</span><span class="n">so</span><span class="w"> </span><span class="n">is</span><span class="w"> </span><span class="mf">1.32</span><span class="n">x</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="mf">1.40</span><span class="n">x</span><span class="w"> </span><span class="n">faster</span><span class="w"> </span><span class="n">than</span><span class="w"> </span><span class="k">dyn</span><span class="o">-</span><span class="n">with</span><span class="o">-</span><span class="n">guard</span><span class="p">.</span><span class="n">so</span><span class="o">!</span>

<span class="w">  </span><span class="p">[</span><span class="mi">10662276</span><span class="w"> </span><span class="mf">11365102.25</span><span class="w"> </span><span class="mi">16630094</span><span class="p">]</span><span class="w"> </span><span class="k">dyn</span><span class="o">-</span><span class="n">with</span><span class="o">-</span><span class="n">guard</span><span class="p">.</span><span class="n">so</span>
<span class="w">  </span><span class="p">[</span><span class="mi">7683153</span><span class="w"> </span><span class="mf">8350998.68</span><span class="w"> </span><span class="mi">13449448</span><span class="p">]</span><span class="w"> </span><span class="k">static</span><span class="p">.</span><span class="n">so</span>

<span class="n">compilation</span><span class="w"> </span>:: <span class="nc">cycles</span><span class="w"> </span>:: <span class="nc">benchmarks</span><span class="o">/</span><span class="n">bz2</span><span class="o">/</span><span class="n">benchmark</span><span class="p">.</span><span class="n">wasm</span>

<span class="w">  </span><span class="err">Δ</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">45130213.24</span><span class="w"> </span><span class="err">±</span><span class="w"> </span><span class="mf">4838200.92</span><span class="w"> </span><span class="p">(</span><span class="n">confidence</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">99</span><span class="o">%</span><span class="p">)</span>

<span class="w">  </span><span class="k">static</span><span class="p">.</span><span class="n">so</span><span class="w"> </span><span class="n">is</span><span class="w"> </span><span class="mf">1.18</span><span class="n">x</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="mf">1.22</span><span class="n">x</span><span class="w"> </span><span class="n">faster</span><span class="w"> </span><span class="n">than</span><span class="w"> </span><span class="k">dyn</span><span class="o">-</span><span class="n">with</span><span class="o">-</span><span class="n">guard</span><span class="p">.</span><span class="n">so</span><span class="o">!</span>

<span class="w">  </span><span class="p">[</span><span class="mi">249993052</span><span class="w"> </span><span class="mf">271654226.14</span><span class="w"> </span><span class="mi">316970220</span><span class="p">]</span><span class="w"> </span><span class="k">dyn</span><span class="o">-</span><span class="n">with</span><span class="o">-</span><span class="n">guard</span><span class="p">.</span><span class="n">so</span>
<span class="w">  </span><span class="p">[</span><span class="mi">208845361</span><span class="w"> </span><span class="mf">226524012.90</span><span class="w"> </span><span class="mi">290090035</span><span class="p">]</span><span class="w"> </span><span class="k">static</span><span class="p">.</span><span class="n">so</span>

<span class="n">compilation</span><span class="w"> </span>:: <span class="nc">cycles</span><span class="w"> </span>:: <span class="nc">benchmarks</span><span class="o">/</span><span class="n">pulldown</span><span class="o">-</span><span class="n">cmark</span><span class="o">/</span><span class="n">benchmark</span><span class="p">.</span><span class="n">wasm</span>

<span class="w">  </span><span class="err">Δ</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">53326476.11</span><span class="w"> </span><span class="err">±</span><span class="w"> </span><span class="mf">5528961.43</span><span class="w"> </span><span class="p">(</span><span class="n">confidence</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">99</span><span class="o">%</span><span class="p">)</span>

<span class="w">  </span><span class="k">static</span><span class="p">.</span><span class="n">so</span><span class="w"> </span><span class="n">is</span><span class="w"> </span><span class="mf">1.16</span><span class="n">x</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="mf">1.19</span><span class="n">x</span><span class="w"> </span><span class="n">faster</span><span class="w"> </span><span class="n">than</span><span class="w"> </span><span class="k">dyn</span><span class="o">-</span><span class="n">with</span><span class="o">-</span><span class="n">guard</span><span class="p">.</span><span class="n">so</span><span class="o">!</span>

<span class="w">  </span><span class="p">[</span><span class="mi">330373001</span><span class="w"> </span><span class="mf">356824375.72</span><span class="w"> </span><span class="mi">397185785</span><span class="p">]</span><span class="w"> </span><span class="k">dyn</span><span class="o">-</span><span class="n">with</span><span class="o">-</span><span class="n">guard</span><span class="p">.</span><span class="n">so</span>
<span class="w">  </span><span class="p">[</span><span class="mi">279072702</span><span class="w"> </span><span class="mf">303497899.61</span><span class="w"> </span><span class="mi">348984338</span><span class="p">]</span><span class="w"> </span><span class="k">static</span><span class="p">.</span><span class="n">so</span>

<span class="n">compilation</span><span class="w"> </span>:: <span class="nc">cycles</span><span class="w"> </span>:: <span class="nc">benchmarks</span><span class="o">/</span><span class="n">spidermonkey</span><span class="o">/</span><span class="n">benchmark</span><span class="p">.</span><span class="n">wasm</span>

<span class="w">  </span><span class="err">Δ</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">1163853854.64</span><span class="w"> </span><span class="err">±</span><span class="w"> </span><span class="mf">81595847.03</span><span class="w"> </span><span class="p">(</span><span class="n">confidence</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">99</span><span class="o">%</span><span class="p">)</span>

<span class="w">  </span><span class="k">static</span><span class="p">.</span><span class="n">so</span><span class="w"> </span><span class="n">is</span><span class="w"> </span><span class="mf">1.15</span><span class="n">x</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="mf">1.18</span><span class="n">x</span><span class="w"> </span><span class="n">faster</span><span class="w"> </span><span class="n">than</span><span class="w"> </span><span class="k">dyn</span><span class="o">-</span><span class="n">with</span><span class="o">-</span><span class="n">guard</span><span class="p">.</span><span class="n">so</span><span class="o">!</span>

<span class="w">  </span><span class="p">[</span><span class="mi">8097294016</span><span class="w"> </span><span class="mf">8213392062.47</span><span class="w"> </span><span class="mi">10103274666</span><span class="p">]</span><span class="w"> </span><span class="k">dyn</span><span class="o">-</span><span class="n">with</span><span class="o">-</span><span class="n">guard</span><span class="p">.</span><span class="n">so</span>
<span class="w">  </span><span class="p">[</span><span class="mi">6969056325</span><span class="w"> </span><span class="mf">7049538207.83</span><span class="w"> </span><span class="mi">8442021515</span><span class="p">]</span><span class="w"> </span><span class="k">static</span><span class="p">.</span><span class="n">so</span>
</code></pre></div>
<p>&lt;/details&gt;</p>
<h4><code>static.so</code> vs <code>dyn-without-guard.so</code></h4>
<p>&lt;details&gt;</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="n">execution</span><span class="w"> </span>:: <span class="nc">cycles</span><span class="w"> </span>:: <span class="nc">benchmarks</span><span class="o">/</span><span class="n">spidermonkey</span><span class="o">/</span><span class="n">benchmark</span><span class="p">.</span><span class="n">wasm</span>

<span class="w">  </span><span class="err">Δ</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">594932587.44</span><span class="w"> </span><span class="err">±</span><span class="w"> </span><span class="mf">6811906.18</span><span class="w"> </span><span class="p">(</span><span class="n">confidence</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">99</span><span class="o">%</span><span class="p">)</span>

<span class="w">  </span><span class="k">static</span><span class="p">.</span><span class="n">so</span><span class="w"> </span><span class="n">is</span><span class="w"> </span><span class="mf">1.63</span><span class="n">x</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="mf">1.65</span><span class="n">x</span><span class="w"> </span><span class="n">faster</span><span class="w"> </span><span class="n">than</span><span class="w"> </span><span class="k">dyn</span><span class="o">-</span><span class="n">without</span><span class="o">-</span><span class="n">guard</span><span class="p">.</span><span class="n">so</span><span class="o">!</span>

<span class="w">  </span><span class="p">[</span><span class="mi">1494952789</span><span class="w"> </span><span class="mf">1524945424.11</span><span class="w"> </span><span class="mi">1606143187</span><span class="p">]</span><span class="w"> </span><span class="k">dyn</span><span class="o">-</span><span class="n">without</span><span class="o">-</span><span class="n">guard</span><span class="p">.</span><span class="n">so</span>
<span class="w">  </span><span class="p">[</span><span class="mi">908877847</span><span class="w"> </span><span class="mf">930012836.67</span><span class="w"> </span><span class="mi">980176520</span><span class="p">]</span><span class="w"> </span><span class="k">static</span><span class="p">.</span><span class="n">so</span>

<span class="n">execution</span><span class="w"> </span>:: <span class="nc">cycles</span><span class="w"> </span>:: <span class="nc">benchmarks</span><span class="o">/</span><span class="n">bz2</span><span class="o">/</span><span class="n">benchmark</span><span class="p">.</span><span class="n">wasm</span>

<span class="w">  </span><span class="err">Δ</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">49482140.46</span><span class="w"> </span><span class="err">±</span><span class="w"> </span><span class="mf">2175287.73</span><span class="w"> </span><span class="p">(</span><span class="n">confidence</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">99</span><span class="o">%</span><span class="p">)</span>

<span class="w">  </span><span class="k">static</span><span class="p">.</span><span class="n">so</span><span class="w"> </span><span class="n">is</span><span class="w"> </span><span class="mf">1.45</span><span class="n">x</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="mf">1.49</span><span class="n">x</span><span class="w"> </span><span class="n">faster</span><span class="w"> </span><span class="n">than</span><span class="w"> </span><span class="k">dyn</span><span class="o">-</span><span class="n">without</span><span class="o">-</span><span class="n">guard</span><span class="p">.</span><span class="n">so</span><span class="o">!</span>

<span class="w">  </span><span class="p">[</span><span class="mi">149370743</span><span class="w"> </span><span class="mf">154540290.45</span><span class="w"> </span><span class="mi">163713075</span><span class="p">]</span><span class="w"> </span><span class="k">dyn</span><span class="o">-</span><span class="n">without</span><span class="o">-</span><span class="n">guard</span><span class="p">.</span><span class="n">so</span>
<span class="w">  </span><span class="p">[</span><span class="mi">99902180</span><span class="w"> </span><span class="mf">105058149.99</span><span class="w"> </span><span class="mi">163151023</span><span class="p">]</span><span class="w"> </span><span class="k">static</span><span class="p">.</span><span class="n">so</span>

<span class="n">compilation</span><span class="w"> </span>:: <span class="nc">cycles</span><span class="w"> </span>:: <span class="nc">benchmarks</span><span class="o">/</span><span class="n">bz2</span><span class="o">/</span><span class="n">benchmark</span><span class="p">.</span><span class="n">wasm</span>

<span class="w">  </span><span class="err">Δ</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">54959651.89</span><span class="w"> </span><span class="err">±</span><span class="w"> </span><span class="mf">5371934.09</span><span class="w"> </span><span class="p">(</span><span class="n">confidence</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">99</span><span class="o">%</span><span class="p">)</span>

<span class="w">  </span><span class="k">static</span><span class="p">.</span><span class="n">so</span><span class="w"> </span><span class="n">is</span><span class="w"> </span><span class="mf">1.22</span><span class="n">x</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="mf">1.26</span><span class="n">x</span><span class="w"> </span><span class="n">faster</span><span class="w"> </span><span class="n">than</span><span class="w"> </span><span class="k">dyn</span><span class="o">-</span><span class="n">without</span><span class="o">-</span><span class="n">guard</span><span class="p">.</span><span class="n">so</span><span class="o">!</span>

<span class="w">  </span><span class="p">[</span><span class="mi">258958338</span><span class="w"> </span><span class="mf">282812487.71</span><span class="w"> </span><span class="mi">327560254</span><span class="p">]</span><span class="w"> </span><span class="k">dyn</span><span class="o">-</span><span class="n">without</span><span class="o">-</span><span class="n">guard</span><span class="p">.</span><span class="n">so</span>
<span class="w">  </span><span class="p">[</span><span class="mi">210542623</span><span class="w"> </span><span class="mf">227852835.82</span><span class="w"> </span><span class="mi">315990395</span><span class="p">]</span><span class="w"> </span><span class="k">static</span><span class="p">.</span><span class="n">so</span>

<span class="n">compilation</span><span class="w"> </span>:: <span class="nc">cycles</span><span class="w"> </span>:: <span class="nc">benchmarks</span><span class="o">/</span><span class="n">spidermonkey</span><span class="o">/</span><span class="n">benchmark</span><span class="p">.</span><span class="n">wasm</span>

<span class="w">  </span><span class="err">Δ</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">1592325533.89</span><span class="w"> </span><span class="err">±</span><span class="w"> </span><span class="mf">100212378.19</span><span class="w"> </span><span class="p">(</span><span class="n">confidence</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">99</span><span class="o">%</span><span class="p">)</span>

<span class="w">  </span><span class="k">static</span><span class="p">.</span><span class="n">so</span><span class="w"> </span><span class="n">is</span><span class="w"> </span><span class="mf">1.21</span><span class="n">x</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="mf">1.24</span><span class="n">x</span><span class="w"> </span><span class="n">faster</span><span class="w"> </span><span class="n">than</span><span class="w"> </span><span class="k">dyn</span><span class="o">-</span><span class="n">without</span><span class="o">-</span><span class="n">guard</span><span class="p">.</span><span class="n">so</span><span class="o">!</span>

<span class="w">  </span><span class="p">[</span><span class="mi">8494305552</span><span class="w"> </span><span class="mf">8674966162.14</span><span class="w"> </span><span class="mi">10607319542</span><span class="p">]</span><span class="w"> </span><span class="k">dyn</span><span class="o">-</span><span class="n">without</span><span class="o">-</span><span class="n">guard</span><span class="p">.</span><span class="n">so</span>
<span class="w">  </span><span class="p">[</span><span class="mi">6985640940</span><span class="w"> </span><span class="mf">7082640628.25</span><span class="w"> </span><span class="mi">8405451996</span><span class="p">]</span><span class="w"> </span><span class="k">static</span><span class="p">.</span><span class="n">so</span>

<span class="n">compilation</span><span class="w"> </span>:: <span class="nc">cycles</span><span class="w"> </span>:: <span class="nc">benchmarks</span><span class="o">/</span><span class="n">pulldown</span><span class="o">-</span><span class="n">cmark</span><span class="o">/</span><span class="n">benchmark</span><span class="p">.</span><span class="n">wasm</span>

<span class="w">  </span><span class="err">Δ</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">66518323.42</span><span class="w"> </span><span class="err">±</span><span class="w"> </span><span class="mf">5778757.98</span><span class="w"> </span><span class="p">(</span><span class="n">confidence</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">99</span><span class="o">%</span><span class="p">)</span>

<span class="w">  </span><span class="k">static</span><span class="p">.</span><span class="n">so</span><span class="w"> </span><span class="n">is</span><span class="w"> </span><span class="mf">1.20</span><span class="n">x</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="mf">1.24</span><span class="n">x</span><span class="w"> </span><span class="n">faster</span><span class="w"> </span><span class="n">than</span><span class="w"> </span><span class="k">dyn</span><span class="o">-</span><span class="n">without</span><span class="o">-</span><span class="n">guard</span><span class="p">.</span><span class="n">so</span><span class="o">!</span>

<span class="w">  </span><span class="p">[</span><span class="mi">342947509</span><span class="w"> </span><span class="mf">371023668.35</span><span class="w"> </span><span class="mi">415514806</span><span class="p">]</span><span class="w"> </span><span class="k">dyn</span><span class="o">-</span><span class="n">without</span><span class="o">-</span><span class="n">guard</span><span class="p">.</span><span class="n">so</span>
<span class="w">  </span><span class="p">[</span><span class="mi">277471563</span><span class="w"> </span><span class="mf">304505344.93</span><span class="w"> </span><span class="mi">339940435</span><span class="p">]</span><span class="w"> </span><span class="k">static</span><span class="p">.</span><span class="n">so</span>

<span class="n">execution</span><span class="w"> </span>:: <span class="nc">cycles</span><span class="w"> </span>:: <span class="nc">benchmarks</span><span class="o">/</span><span class="n">pulldown</span><span class="o">-</span><span class="n">cmark</span><span class="o">/</span><span class="n">benchmark</span><span class="p">.</span><span class="n">wasm</span>

<span class="w">  </span><span class="err">Δ</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">1217702.33</span><span class="w"> </span><span class="err">±</span><span class="w"> </span><span class="mf">627813.45</span><span class="w"> </span><span class="p">(</span><span class="n">confidence</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">99</span><span class="o">%</span><span class="p">)</span>

<span class="w">  </span><span class="k">static</span><span class="p">.</span><span class="n">so</span><span class="w"> </span><span class="n">is</span><span class="w"> </span><span class="mf">1.06</span><span class="n">x</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="mf">1.18</span><span class="n">x</span><span class="w"> </span><span class="n">faster</span><span class="w"> </span><span class="n">than</span><span class="w"> </span><span class="k">dyn</span><span class="o">-</span><span class="n">without</span><span class="o">-</span><span class="n">guard</span><span class="p">.</span><span class="n">so</span><span class="o">!</span>

<span class="w">  </span><span class="p">[</span><span class="mi">11111517</span><span class="w"> </span><span class="mf">11632130.88</span><span class="w"> </span><span class="mi">14705814</span><span class="p">]</span><span class="w"> </span><span class="k">dyn</span><span class="o">-</span><span class="n">without</span><span class="o">-</span><span class="n">guard</span><span class="p">.</span><span class="n">so</span>
<span class="w">  </span><span class="p">[</span><span class="mi">7682848</span><span class="w"> </span><span class="mf">10414428.55</span><span class="w"> </span><span class="mi">14122261</span><span class="p">]</span><span class="w"> </span><span class="k">static</span><span class="p">.</span><span class="n">so</span>
</code></pre></div>
<p>&lt;/details&gt;</p>
<h4>Comparing Wasmtime and SpiderMonkey</h4>
<p>To get a sense of whether our 1.55x slowdown when enabling explicit bounds checks was typical of other engines, I also benchmarked SpiderMonkey (native) running Sightglass's <code>spidermonkey.wasm</code> benchmark with virtual memory guard pages vs with explicit bounds checks.</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="n">execution</span><span class="w"> </span>:: <span class="nc">milliseconds</span><span class="w"> </span>:: <span class="nc">spidermonkey</span><span class="p">.</span><span class="n">wasm</span>

<span class="w">  </span><span class="err">Δ</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">163.62</span><span class="w"> </span><span class="err">±</span><span class="w"> </span><span class="mf">5.57</span><span class="w"> </span><span class="p">(</span><span class="n">confidence</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">99</span><span class="o">%</span><span class="p">)</span>

<span class="w">  </span><span class="kr">virtual</span><span class="o">-</span><span class="n">memory</span><span class="o">-</span><span class="n">spidermonkey</span><span class="w"> </span><span class="n">is</span><span class="w"> </span><span class="mf">1.52</span><span class="n">x</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="mf">1.56</span><span class="n">x</span><span class="w"> </span><span class="n">faster</span><span class="w"> </span><span class="n">than</span><span class="w"> </span><span class="n">bounds</span><span class="o">-</span><span class="n">checks</span><span class="o">-</span><span class="n">spidermonkey</span><span class="o">!</span>

<span class="w">  </span><span class="p">[</span><span class="mi">446</span><span class="w"> </span><span class="mf">465.49</span><span class="w"> </span><span class="mi">520</span><span class="p">]</span><span class="w"> </span><span class="n">bounds</span><span class="o">-</span><span class="n">checks</span><span class="o">-</span><span class="n">spidermonkey</span>
<span class="w">  </span><span class="p">[</span><span class="mi">290</span><span class="w"> </span><span class="mf">301.87</span><span class="w"> </span><span class="mi">353</span><span class="p">]</span><span class="w"> </span><span class="kr">virtual</span><span class="o">-</span><span class="n">memory</span><span class="o">-</span><span class="n">spidermonkey</span>
</code></pre></div>
<p>Because SpiderMonkey's slowdown is almost identical to Wasmtime's, we can infer that there aren't any critical bounds-checking optimizations that SpiderMonkey performs but Wasmtime/Cranelift does not. This is reassuring: it means we can basically ignore other engines (or at least SpiderMonkey) for now, when trying to further improve codegen when explicit bounds checks are enabled, and focus only on ourselves.</p>
<h2>Proposed Future Work</h2>
<p>What fruit remains to be harvested? I've been digging into <code>spidermonkey.wasm</code>'s hot functions (as reported by <code>perf</code> on Linux) and staring at disassemblies to get an idea of how much room for improvement we still have. In short: a lot!</p>
<p>I found many sequences of back-to-back m<br>
[message truncated]</p>
</blockquote>



<a name="344073994"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%236094%20Further%20Improve%20Execution%20Speed%20wi.../near/344073994" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.236094.20Further.20Improve.20Execution.20Speed.20wi.2E.2E.2E.html#344073994">(Mar 23 2023 at 18:53)</a>:</h4>
<p>fitzgen <a href="https://github.com/bytecodealliance/wasmtime/issues/6094#issuecomment-1481730819">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/6094">issue #6094</a>:</p>
<blockquote>
<p>For posterity, here is the suuuuuper-hacky WASI polyfill I used to get SpiderMonkey running the <code>spidermonkey.wasm</code> benchmark from sightglass (which was forked off from a smaller polyfill that @alexcrichton shared with me, thank you).</p>
<p>&lt;details&gt;</p>
<div class="codehilite" data-code-language="JavaScript"><pre><span></span><code><span class="kd">const</span><span class="w"> </span><span class="nx">ITERS</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">100</span><span class="p">;</span>

<span class="c1">////////////////////////////////////////////////////////////////////////////////</span>

<span class="kd">class</span><span class="w"> </span><span class="nx">TextEncoder</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="kr">constructor</span><span class="p">(</span><span class="nx">enc</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">enc</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="s2">"utf-8"</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="k">throw</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="ne">Error</span><span class="p">(</span><span class="s2">"FITZGEN: unsupported encoding: "</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nx">enc</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">  </span><span class="p">}</span>
<span class="w">  </span><span class="nx">encode</span><span class="p">(</span><span class="nx">s</span><span class="p">,</span><span class="w"> </span><span class="nx">n</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="nx">buf</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nb">Uint8Array</span><span class="p">(</span><span class="nx">s</span><span class="p">.</span><span class="nx">length</span><span class="p">);</span>
<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kd">let</span><span class="w"> </span><span class="nx">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0</span><span class="p">;</span><span class="w"> </span><span class="nx">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="nb">Math</span><span class="p">.</span><span class="nx">min</span><span class="p">(</span><span class="nx">s</span><span class="p">.</span><span class="nx">length</span><span class="p">,</span><span class="w"> </span><span class="nx">n</span><span class="p">);</span><span class="w"> </span><span class="nx">i</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nx">buf</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">s</span><span class="p">.</span><span class="nx">charCodeAt</span><span class="p">(</span><span class="nx">i</span><span class="p">);</span><span class="w"> </span><span class="c1">// lol</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nx">buf</span><span class="p">;</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">};</span>

<span class="kd">class</span><span class="w"> </span><span class="nx">TextDecoder</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="kr">constructor</span><span class="p">(</span><span class="nx">enc</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">enc</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="s2">"utf-8"</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="k">throw</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="ne">Error</span><span class="p">(</span><span class="s2">"FITZGEN: unsupported encoding: "</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nx">enc</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">  </span><span class="p">}</span>
<span class="w">  </span><span class="nx">decode</span><span class="p">(</span><span class="nx">buf</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="nx">buf8</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nb">Uint8Array</span><span class="p">(</span><span class="nx">buf</span><span class="p">);</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="nx">s</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">""</span><span class="p">;</span>
<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kd">let</span><span class="w"> </span><span class="nx">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0</span><span class="p">;</span><span class="w"> </span><span class="nx">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="nx">buf8</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span><span class="w"> </span><span class="nx">i</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nx">s</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="nb">String</span><span class="p">.</span><span class="nx">fromCharCode</span><span class="p">(</span><span class="nx">buf8</span><span class="p">[</span><span class="nx">i</span><span class="p">]);</span><span class="w"> </span><span class="c1">// lol</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nx">s</span><span class="p">;</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">};</span>

<span class="c1">////////////////////////////////////////////////////////////////////////////////</span>

<span class="k">async</span><span class="w"> </span><span class="kd">function</span><span class="w"> </span><span class="nx">ionCompile</span><span class="p">(</span><span class="nx">wasm</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="kd">let</span><span class="w"> </span><span class="nx">module</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">WebAssembly</span><span class="p">.</span><span class="nx">compile</span><span class="p">(</span><span class="nx">wasm</span><span class="p">);</span>
<span class="w">  </span><span class="k">while</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="nx">wasmHasTier2CompilationCompleted</span><span class="p">(</span><span class="nx">module</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">sleep</span><span class="p">(</span><span class="mf">1</span><span class="p">);</span>
<span class="w">  </span><span class="p">}</span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="nx">module</span><span class="p">;</span>
<span class="p">}</span>

<span class="kd">function</span><span class="w"> </span><span class="nx">unimplemented</span><span class="p">(</span><span class="nx">name</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="kd">function</span><span class="w"> </span><span class="p">(...</span><span class="nx">args</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">throw</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="ne">Error</span><span class="p">(</span><span class="nx">name</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s2">" is unimplemented! args = "</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nx">args</span><span class="p">);</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">}</span>

<span class="kd">class</span><span class="w"> </span><span class="nx">ProcExitError</span><span class="w"> </span><span class="k">extends</span><span class="w"> </span><span class="ne">Error</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="kr">constructor</span><span class="p">(</span><span class="nx">code</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">this</span><span class="p">.</span><span class="nx">code</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">code</span><span class="p">;</span>
<span class="w">    </span><span class="k">this</span><span class="p">.</span><span class="nx">message</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"Program exited with code "</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nx">code</span><span class="p">;</span>
<span class="w">  </span><span class="p">}</span>
<span class="w">  </span><span class="nx">toString</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="s2">"ProcExitError: "</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">message</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">}</span>

<span class="kd">function</span><span class="w"> </span><span class="nx">trace</span><span class="p">(</span><span class="nx">obj</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="kd">let</span><span class="w"> </span><span class="nx">proxy</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{};</span>
<span class="w">  </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kd">let</span><span class="w"> </span><span class="nx">key</span><span class="w"> </span><span class="k">of</span><span class="w"> </span><span class="nb">Object</span><span class="p">.</span><span class="nx">keys</span><span class="p">(</span><span class="nx">obj</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="ow">typeof</span><span class="w"> </span><span class="nx">obj</span><span class="p">[</span><span class="nx">key</span><span class="p">]</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="s2">"function"</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nx">proxy</span><span class="p">[</span><span class="nx">key</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">obj</span><span class="p">[</span><span class="nx">key</span><span class="p">];</span>
<span class="w">      </span><span class="k">continue</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="nx">proxy</span><span class="p">[</span><span class="nx">key</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kd">function</span><span class="w"> </span><span class="p">(...</span><span class="nx">args</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nx">print</span><span class="p">(</span><span class="s2">"TRACE: "</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nx">key</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s2">"("</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nx">args</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s2">")"</span><span class="p">);</span>
<span class="w">      </span><span class="kd">let</span><span class="w"> </span><span class="nx">ret</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">obj</span><span class="p">[</span><span class="nx">key</span><span class="p">](...</span><span class="nx">args</span><span class="p">);</span>
<span class="w">      </span><span class="nx">print</span><span class="p">(</span><span class="s2">"TRACE:   -&gt; "</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nx">ret</span><span class="p">);</span>
<span class="w">      </span><span class="k">return</span><span class="w"> </span><span class="nx">ret</span><span class="p">;</span>
<span class="w">    </span><span class="p">};</span>
<span class="w">  </span><span class="p">}</span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="nx">proxy</span><span class="p">;</span>
<span class="p">}</span>

<span class="c1">////////////////////////////////////////////////////////////////////////////////</span>

<span class="k">async</span><span class="w"> </span><span class="kd">function</span><span class="w"> </span><span class="nx">main</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="kd">let</span><span class="w"> </span><span class="nx">smWasm</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">os</span><span class="p">.</span><span class="nx">file</span><span class="p">.</span><span class="nx">readFile</span><span class="p">(</span><span class="s2">"/home/nick/sightglass/benchmarks/spidermonkey/benchmark.wasm"</span><span class="p">,</span><span class="w"> </span><span class="s2">"binary"</span><span class="p">);</span>
<span class="w">  </span><span class="kd">let</span><span class="w"> </span><span class="nx">smModule</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">ionCompile</span><span class="p">(</span><span class="nx">smWasm</span><span class="p">);</span>

<span class="w">  </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kd">let</span><span class="w"> </span><span class="nx">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0</span><span class="p">;</span><span class="w"> </span><span class="nx">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="nx">ITERS</span><span class="p">;</span><span class="w"> </span><span class="nx">i</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="nx">args</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span><span class="s2">"js"</span><span class="p">];</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="nx">mem</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">null</span><span class="p">;</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="nx">start</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">null</span><span class="p">;</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="nx">unread</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">true</span><span class="p">;</span>

<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="nx">smInstance</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">WebAssembly</span><span class="p">.</span><span class="nx">instantiate</span><span class="p">(</span><span class="nx">smModule</span><span class="p">,</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nx">bench</span><span class="o">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nx">start</span><span class="o">:</span><span class="w"> </span><span class="kd">function</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">          </span><span class="nx">start</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">monotonicNow</span><span class="p">()</span>
<span class="w">        </span><span class="p">},</span>
<span class="w">        </span><span class="nx">end</span><span class="o">:</span><span class="w"> </span><span class="kd">function</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">          </span><span class="kd">let</span><span class="w"> </span><span class="nx">end</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">monotonicNow</span><span class="p">();</span>
<span class="w">          </span><span class="nx">print</span><span class="p">(</span><span class="s2">"ITER: "</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="p">(</span><span class="nx">end</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="nx">start</span><span class="p">));</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">      </span><span class="p">},</span>
<span class="w">      </span><span class="nx">wasi_snapshot_preview1</span><span class="o">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nx">random_get</span><span class="o">:</span><span class="w"> </span><span class="kd">function</span><span class="p">(</span><span class="nx">a</span><span class="p">,</span><span class="w"> </span><span class="nx">b</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">          </span><span class="k">while</span><span class="w"> </span><span class="p">(</span><span class="nx">b</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mf">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="p">(</span><span class="ow">new</span><span class="w"> </span><span class="nb">DataView</span><span class="p">(</span><span class="nx">mem</span><span class="p">.</span><span class="nx">buffer</span><span class="p">)).</span><span class="nx">setInt8</span><span class="p">(</span><span class="nx">a</span><span class="p">,</span><span class="w"> </span><span class="mf">1</span><span class="p">,</span><span class="w"> </span><span class="kc">true</span><span class="p">);</span>
<span class="w">            </span><span class="nx">b</span><span class="w"> </span><span class="o">-=</span><span class="w"> </span><span class="mf">1</span><span class="p">;</span>
<span class="w">            </span><span class="nx">a</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="mf">1</span><span class="p">;</span>
<span class="w">          </span><span class="p">}</span>
<span class="w">          </span><span class="k">return</span><span class="w"> </span><span class="mf">0</span><span class="p">;</span>
<span class="w">        </span><span class="p">},</span>
<span class="w">        </span><span class="nx">args_get</span><span class="o">:</span><span class="w"> </span><span class="kd">function</span><span class="p">(</span><span class="nx">a</span><span class="p">,</span><span class="w"> </span><span class="nx">b</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">          </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kd">let</span><span class="w"> </span><span class="nx">arg</span><span class="w"> </span><span class="k">of</span><span class="w"> </span><span class="nx">args</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="p">(</span><span class="ow">new</span><span class="w"> </span><span class="nb">DataView</span><span class="p">(</span><span class="nx">mem</span><span class="p">.</span><span class="nx">buffer</span><span class="p">)).</span><span class="nx">setInt32</span><span class="p">(</span><span class="nx">a</span><span class="p">,</span><span class="w"> </span><span class="nx">b</span><span class="p">,</span><span class="w"> </span><span class="kc">true</span><span class="p">);</span>
<span class="w">            </span><span class="nx">a</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="mf">4</span><span class="p">;</span>
<span class="w">            </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kd">let</span><span class="w"> </span><span class="nx">c</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="nx">arg</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">              </span><span class="p">(</span><span class="ow">new</span><span class="w"> </span><span class="nb">DataView</span><span class="p">(</span><span class="nx">mem</span><span class="p">.</span><span class="nx">buffer</span><span class="p">)).</span><span class="nx">setInt8</span><span class="p">(</span><span class="nx">b</span><span class="p">,</span><span class="w"> </span><span class="nx">arg</span><span class="p">.</span><span class="nx">charCodeAt</span><span class="p">(</span><span class="nx">c</span><span class="p">),</span><span class="w"> </span><span class="kc">true</span><span class="p">);</span>
<span class="w">              </span><span class="nx">b</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="mf">1</span><span class="p">;</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">            </span><span class="p">(</span><span class="ow">new</span><span class="w"> </span><span class="nb">DataView</span><span class="p">(</span><span class="nx">mem</span><span class="p">.</span><span class="nx">buffer</span><span class="p">)).</span><span class="nx">setInt8</span><span class="p">(</span><span class="nx">b</span><span class="p">,</span><span class="w"> </span><span class="mf">0</span><span class="p">,</span><span class="w"> </span><span class="kc">true</span><span class="p">);</span>
<span class="w">            </span><span class="nx">b</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="mf">1</span><span class="p">;</span>
<span class="w">          </span><span class="p">}</span>
<span class="w">          </span><span class="k">return</span><span class="w"> </span><span class="mf">0</span><span class="p">;</span>
<span class="w">        </span><span class="p">},</span>
<span class="w">        </span><span class="nx">args_sizes_get</span><span class="o">:</span><span class="w"> </span><span class="kd">function</span><span class="p">(</span><span class="nx">a</span><span class="p">,</span><span class="w"> </span><span class="nx">b</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">          </span><span class="kd">let</span><span class="w"> </span><span class="nx">len</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0</span><span class="p">;</span>
<span class="w">          </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kd">let</span><span class="w"> </span><span class="nx">arg</span><span class="w"> </span><span class="k">of</span><span class="w"> </span><span class="nx">args</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="nx">len</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="nx">arg</span><span class="p">.</span><span class="nx">length</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mf">1</span><span class="p">;</span>
<span class="w">          </span><span class="p">}</span>
<span class="w">          </span><span class="p">(</span><span class="ow">new</span><span class="w"> </span><span class="nb">DataView</span><span class="p">(</span><span class="nx">mem</span><span class="p">.</span><span class="nx">buffer</span><span class="p">)).</span><span class="nx">setInt32</span><span class="p">(</span><span class="nx">a</span><span class="p">,</span><span class="w"> </span><span class="nx">args</span><span class="p">.</span><span class="nx">length</span><span class="p">,</span><span class="w"> </span><span class="kc">true</span><span class="p">);</span>
<span class="w">          </span><span class="p">(</span><span class="ow">new</span><span class="w"> </span><span class="nb">DataView</span><span class="p">(</span><span class="nx">mem</span><span class="p">.</span><span class="nx">buffer</span><span class="p">)).</span><span class="nx">setInt32</span><span class="p">(</span><span class="nx">b</span><span class="p">,</span><span class="w"> </span><span class="nx">len</span><span class="p">,</span><span class="w"> </span><span class="kc">true</span><span class="p">);</span>
<span class="w">          </span><span class="k">return</span><span class="w"> </span><span class="mf">0</span><span class="p">;</span>
<span class="w">        </span><span class="p">},</span>
<span class="w">        </span><span class="nx">clock_res_get</span><span class="o">:</span><span class="w"> </span><span class="kd">function</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="mf">1</span><span class="p">;</span><span class="w"> </span><span class="p">},</span>
<span class="w">        </span><span class="nx">clock_time_get</span><span class="o">:</span><span class="w"> </span><span class="kd">function</span><span class="p">(</span><span class="nx">a</span><span class="p">,</span><span class="w"> </span><span class="nx">b</span><span class="p">,</span><span class="w"> </span><span class="nx">c</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">          </span><span class="kd">const</span><span class="w"> </span><span class="nx">now</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">Math</span><span class="p">.</span><span class="nx">round</span><span class="p">(</span><span class="nx">performance</span><span class="p">.</span><span class="nx">now</span><span class="p">()</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mf">1000000</span><span class="p">);</span>
<span class="w">          </span><span class="p">(</span><span class="ow">new</span><span class="w"> </span><span class="nb">DataView</span><span class="p">(</span><span class="nx">mem</span><span class="p">.</span><span class="nx">buffer</span><span class="p">)).</span><span class="nx">setBigInt64</span><span class="p">(</span><span class="nx">c</span><span class="p">,</span><span class="w"> </span><span class="nb">BigInt</span><span class="p">(</span><span class="nx">now</span><span class="p">),</span><span class="w"> </span><span class="kc">true</span><span class="p">);</span>
<span class="w">          </span><span class="k">return</span><span class="w"> </span><span class="mf">0</span><span class="p">;</span>
<span class="w">        </span><span class="p">},</span>
<span class="w">        </span><span class="nx">fd_filestat_get</span><span class="o">:</span><span class="w"> </span><span class="kd">function</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="k">throw</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="ne">Error</span><span class="p">(</span><span class="s1">'fd_filestat_get'</span><span class="p">);</span><span class="w"> </span><span class="p">},</span>
<span class="w">        </span><span class="nx">fd_read</span><span class="o">:</span><span class="w"> </span><span class="kd">function</span><span class="p">(</span><span class="nx">fd</span><span class="p">,</span><span class="w"> </span><span class="nx">iovecs_ptr</span><span class="p">,</span><span class="w"> </span><span class="nx">iovecs_len</span><span class="p">,</span><span class="w"> </span><span class="nx">out_ptr</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">          </span><span class="kd">let</span><span class="w"> </span><span class="nx">mem8</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nb">Uint8Array</span><span class="p">(</span><span class="nx">mem</span><span class="p">.</span><span class="nx">buffer</span><span class="p">);</span>
<span class="w">          </span><span class="k">switch</span><span class="w"> </span><span class="p">(</span><span class="nx">fd</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">          </span><span class="k">case</span><span class="w"> </span><span class="mf">4</span><span class="o">:</span>
<span class="w">            </span><span class="kd">let</span><span class="w"> </span><span class="nx">data</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">os</span><span class="p">.</span><span class="nx">file</span><span class="p">.</span><span class="nx">readFile</span><span class="p">(</span><span class="s2">"/home/nick/sightglass/benchmarks/spidermonkey/default.input.md"</span><span class="p">);</span>
<span class="w">            </span><span class="kd">let</span><span class="w"> </span><span class="nx">k</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0</span><span class="p">;</span>
<span class="w">            </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kd">let</span><span class="w"> </span><span class="nx">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0</span><span class="p">;</span><span class="w"> </span><span class="nx">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="nx">iovecs_len</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="nx">k</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="nx">data</span><span class="p">.</span><span class="nx">length</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="nx">unread</span><span class="p">;</span><span class="w"> </span><span class="nx">i</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">              </span><span class="kd">let</span><span class="w"> </span><span class="nx">ptr</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="ow">new</span><span class="w"> </span><span class="nb">DataView</span><span class="p">(</span><span class="nx">mem</span><span class="p">.</span><span class="nx">buffer</span><span class="p">)).</span><span class="nx">getUint32</span><span class="p">(</span><span class="nx">iovecs_ptr</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nx">i</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mf">8</span><span class="p">,</span><span class="w"> </span><span class="kc">true</span><span class="p">);</span>
<span class="w">              </span><span class="kd">let</span><span class="w"> </span><span class="nx">len</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="ow">new</span><span class="w"> </span><span class="nb">DataView</span><span class="p">(</span><span class="nx">mem</span><span class="p">.</span><span class="nx">buffer</span><span class="p">)).</span><span class="nx">getUint32</span><span class="p">(</span><span class="nx">iovecs_ptr</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nx">i</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mf">8</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mf">4</span><span class="p">,</span><span class="w"> </span><span class="kc">true</span><span class="p">);</span>
<span class="w">              </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kd">let</span><span class="w"> </span><span class="nx">j</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0</span><span class="p">;</span><span class="w"> </span><span class="nx">j</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="nx">len</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="nx">k</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="nx">data</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span><span class="w"> </span><span class="nx">j</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="nx">mem8</span><span class="p">[</span><span class="nx">ptr</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nx">j</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">data</span><span class="p">.</span><span class="nx">charCodeAt</span><span class="p">(</span><span class="nx">k</span><span class="o">++</span><span class="p">);</span>
<span class="w">              </span><span class="p">}</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">            </span><span class="nx">unread</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">false</span><span class="p">;</span>
<span class="w">            </span><span class="p">(</span><span class="ow">new</span><span class="w"> </span><span class="nb">DataView</span><span class="p">(</span><span class="nx">mem</span><span class="p">.</span><span class="nx">buffer</span><span class="p">)).</span><span class="nx">setUint32</span><span class="p">(</span><span class="nx">out_ptr</span><span class="p">,</span><span class="w"> </span><span class="nx">k</span><span class="p">,</span><span class="w"> </span><span class="kc">true</span><span class="p">);</span>
<span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="mf">0</span><span class="p">;</span>
<span class="w">          </span><span class="k">default</span><span class="o">:</span>
<span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="mf">8</span><span class="p">;</span>
<span class="w">          </span><span class="p">}</span>
<span class="w">        </span><span class="p">},</span>
<span class="w">        </span><span class="nx">fd_seek</span><span class="o">:</span><span class="w"> </span><span class="kd">function</span><span class="p">(</span><span class="nx">fd</span><span class="p">,</span><span class="w"> </span><span class="nx">offset</span><span class="p">,</span><span class="w"> </span><span class="nx">whence</span><span class="p">,</span><span class="w"> </span><span class="nx">out_ptr</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">          </span><span class="k">switch</span><span class="w"> </span><span class="p">(</span><span class="nx">fd</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">          </span><span class="k">case</span><span class="w"> </span><span class="mf">4</span><span class="o">:</span>
<span class="w">            </span><span class="kd">let</span><span class="w"> </span><span class="nx">len</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">os</span><span class="p">.</span><span class="nx">file</span><span class="p">.</span><span class="nx">readFile</span><span class="p">(</span><span class="s2">"/home/nick/sightglass/benchmarks/spidermonkey/default.input.md"</span><span class="p">).</span><span class="nx">length</span><span class="p">;</span>
<span class="w">            </span><span class="p">(</span><span class="ow">new</span><span class="w"> </span><span class="nb">DataView</span><span class="p">(</span><span class="nx">mem</span><span class="p">.</span><span class="nx">buffer</span><span class="p">)).</span><span class="nx">setBigUint64</span><span class="p">(</span><span class="nx">out_ptr</span><span class="p">,</span><span class="w"> </span><span class="nb">BigInt</span><span class="p">(</span><span class="nx">len</span><span class="p">),</span><span class="w"> </span><span class="kc">true</span><span class="p">);</span>
<span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="mf">0</span><span class="p">;</span>
<span class="w">          </span><span class="k">default</span><span class="o">:</span>
<span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="mf">8</span><span class="p">;</span>
<span class="w">          </span><span class="p">}</span>
<span class="w">        </span><span class="p">},</span>
<span class="w">        </span><span class="nx">fd_write</span><span class="o">:</span><span class="w"> </span><span class="kd">function</span><span class="p">(</span><span class="nx">a</span><span class="p">,</span><span class="w"> </span><span class="nx">b</span><span class="p">,</span><span class="w"> </span><span class="nx">c</span><span class="p">,</span><span class="w"> </span><span class="nx">d</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">          </span><span class="kd">let</span><span class="w"> </span><span class="nx">s</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">''</span><span class="p">;</span>
<span class="w">          </span><span class="kd">let</span><span class="w"> </span><span class="nx">total</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0</span><span class="p">;</span>
<span class="w">          </span><span class="k">while</span><span class="w"> </span><span class="p">(</span><span class="nx">c</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mf">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="kd">let</span><span class="w"> </span><span class="nx">base</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="ow">new</span><span class="w"> </span><span class="nb">DataView</span><span class="p">(</span><span class="nx">mem</span><span class="p">.</span><span class="nx">buffer</span><span class="p">)).</span><span class="nx">getInt32</span><span class="p">(</span><span class="nx">b</span><span class="p">,</span><span class="w"> </span><span class="kc">true</span><span class="p">);</span>
<span class="w">            </span><span class="kd">let</span><span class="w"> </span><span class="nx">len</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="ow">new</span><span class="w"> </span><span class="nb">DataView</span><span class="p">(</span><span class="nx">mem</span><span class="p">.</span><span class="nx">buffer</span><span class="p">)).</span><span class="nx">getInt32</span><span class="p">(</span><span class="nx">b</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mf">4</span><span class="p">,</span><span class="w"> </span><span class="kc">true</span><span class="p">);</span>
<span class="w">            </span><span class="nx">b</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="mf">8</span><span class="p">;</span>
<span class="w">            </span><span class="nx">c</span><span class="w"> </span><span class="o">-=</span><span class="w"> </span><span class="mf">1</span><span class="p">;</span>

<span class="w">            </span><span class="k">while</span><span class="w"> </span><span class="p">(</span><span class="nx">len</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mf">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">              </span><span class="kd">let</span><span class="w"> </span><span class="nx">c</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nb">Uint8Array</span><span class="p">(</span><span class="nx">mem</span><span class="p">.</span><span class="nx">buffer</span><span class="p">)[</span><span class="nx">base</span><span class="p">]</span>
<span class="w">              </span><span class="nx">s</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="nb">String</span><span class="p">.</span><span class="nx">fromCharCode</span><span class="p">(</span><span class="nx">c</span><span class="p">);</span>
<span class="w">              </span><span class="nx">len</span><span class="w"> </span><span class="o">-=</span><span class="w"> </span><span class="mf">1</span><span class="p">;</span>
<span class="w">              </span><span class="nx">base</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="mf">1</span><span class="p">;</span>
<span class="w">              </span><span class="nx">total</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="mf">1</span><span class="p">;</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">          </span><span class="p">}</span>
<span class="w">          </span><span class="c1">// print("fd_write(" + a + "): " + s.trimEnd());</span>
<span class="w">          </span><span class="p">(</span><span class="ow">new</span><span class="w"> </span><span class="nb">DataView</span><span class="p">(</span><span class="nx">mem</span><span class="p">.</span><span class="nx">buffer</span><span class="p">)).</span><span class="nx">setInt32</span><span class="p">(</span><span class="nx">d</span><span class="p">,</span><span class="w"> </span><span class="nx">total</span><span class="p">,</span><span class="w"> </span><span class="kc">true</span><span class="p">);</span>
<span class="w">          </span><span class="k">return</span><span class="w"> </span><span class="mf">0</span><span class="p">;</span>
<span class="w">        </span><span class="p">},</span>
<span class="w">        </span><span class="nx">fd_fdstat_set_flags</span><span class="o">:</span><span class="w"> </span><span class="kd">function</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="k">throw</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="ne">Error</span><span class="p">(</span><span class="s1">'fd_fdstat_set_flags'</span><span class="p">);</span><span class="w"> </span><span class="p">},</span>
<span class="w">        </span><span class="nx">path_filestat_get</span><span class="o">:</span><span class="w"> </span><span class="kd">function</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="k">throw</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="ne">Error</span><span class="p">(</span><span class="s1">'path_filestat_get'</span><span class="p">);</span><span class="w"> </span><span class="p">},</span>
<span class="w">        </span><span class="nx">path_open</span><span class="o">:</span><span class="w"> </span><span class="kd">function</span><span class="p">(</span><span class="nx">fd</span><span class="p">,</span><span class="w"> </span><span class="nx">dirflags</span><span class="p">,</span><span class="w"> </span><span class="nx">path_ptr</span><span class="p">,</span><span class="w"> </span><span class="nx">path_len</span><span class="p">,</span><span class="w"> </span><span class="nx">oflags</span><span class="p">,</span><span class="w"> </span><span class="nx">fs_rights_base</span><span class="p">,</span><span class="w"> </span><span class="nx">fs_rights_inheriting</span><span class="p">,</span><span class="w"> </span><span class="nx">fdflags</span><span class="p">,</span><span class="w"> </span><span class="nx">out_ptr</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">          </span><span class="kd">let</span><span class="w"> </span><span class="nx">buf</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nb">Uint8Array</span><span class="p">(</span><span class="nx">path_len</span><span class="p">);</span>
<span class="w">          </span><span class="kd">let</span><span class="w"> </span><span class="nx">mem8</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nb">Uint8Array</span><span class="p">(</span><span class="nx">mem</span><span class="p">.</span><span class="nx">buffer</span><span class="p">);</span>
<span class="w">          </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kd">let</span><span class="w"> </span><span class="nx">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0</span><span class="p">;</span><span class="w"> </span><span class="nx">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="nx">path_len</span><span class="p">;</span><span class="w"> </span><span class="nx">i</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="nx">buf</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">mem8</span><span class="p">[</span><span class="nx">path_ptr</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nx">i</span><span class="p">];</span>
<span class="w">          </span><span class="p">}</span>
<span class="w">          </span><span class="kd">let</span><span class="w"> </span><span class="nx">path</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="ow">new</span><span class="w"> </span><span class="nx">TextDecoder</span><span class="p">(</span><span class="s1">'utf-8'</span><span class="p">)).</span><span class="nx">decode</span><span class="p">(</span><span class="nx">buf</span><span class="p">);</span>
<span class="w">          </span><span class="k">switch</span><span class="w"> </span><span class="p">(</span><span class="nx">path</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">          </span><span class="k">case</span><span class="w"> </span><span class="s2">"default.input.md"</span><span class="o">:</span>
<span class="w">            </span><span class="p">(</span><span class="ow">new</span><span class="w"> </span><span class="nb">DataView</span><span class="p">(</span><span class="nx">mem</span><span class="p">.</span><span class="nx">buffer</span><span class="p">)).</span><span class="nx">setInt32</span><span class="p">(</span><span class="nx">out_ptr</span><span class="p">,</span><span class="w"> </span><span class="mf">4</span><span class="p">,</span><span class="w"> </span><span class="kc">true</span><span class="p">);</span>
<span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="mf">0</span><span class="p">;</span>
<span class="w">          </span><span class="k">default</span><span class="o">:</span>
<span class="w">            </span><span class="nx">print</span><span class="p">(</span><span class="s1">'denying path_open('</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nx">path</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s1">')'</span><span class="p">);</span>
<span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="mf">2</span><span class="p">;</span>
<span class="w">          </span><span class="p">}</span>
<span class="w">        </span><span class="p">},</span>
<span class="w">        </span><span class="nx">path_remove_directory</span><span class="o">:</span><span class="w"> </span><span class="kd">function</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="k">throw</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="ne">Error</span><span class="p">(</span><span class="s1">'path_remove_directory'</span><span class="p">);</span><span class="w"> </span><span class="p">},</span>
<span class="w">        </span><span class="nx">path_unlink_file</span><span class="o">:</span><span class="w"> </span><span class="kd">function</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="k">throw</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="ne">Error</span><span class="p">(</span><span class="s1">'path_unlink_file'</span><span class="p">);</span><span class="w"> </span><span class="p">},</span>
<span class="w">        </span><span class="nx">sched_yield</span><span class="o">:</span><span class="w"> </span><span class="kd">function</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="k">throw</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="ne">Error</span><span class="p">(</span><span class="s1">'sched_yield'</span><span class="p">);</span><span class="w"> </span><span class="p">},</span>
<span class="w">        </span><span class="nx">environ_get</span><span class="o">:</span><span class="w"> </span><span class="kd">function</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="mf">0</span><span class="p">;</span><span class="w"> </span><span class="p">},</span>
<span class="w">        </span><span class="nx">environ_sizes_get</span><span class="o">:</span><span class="w"> </span><span class="kd">function</span><span class="p">(</span><span class="nx">a</span><span class="p">,</span><span class="w"> </span><span class="nx">b</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">          </span><span class="p">(</span><span class="ow">new</span><span class="w"> </span><span class="nb">DataView</span><span class="p">(</span><span class="nx">mem</span><span class="p">.</span><span class="nx">buffer</span><span class="p">)).</span><span class="nx">setInt32</span><span class="p">(</span><span class="nx">a</span><span class="p">,</span><span class="w"> </span><span class="mf">0</span><span class="p">,</span><span class="w"> </span><span class="kc">true</span><span class="p">);</span>
<span class="w">          </span><span class="p">(</span><span class="ow">new</span><span class="w"> </span><span class="nb">DataView</span><span class="p">(</span><span class="nx">mem</span><span class="p">.</span><span class="nx">buffer</span><span class="p">)).</span><span class="nx">setInt32</span><span class="p">(</span><span class="nx">b</span><span class="p">,</span><span class="w"> </span><span class="mf">0</span><span class="p">,</span><span class="w"> </span><span class="kc">true</span><span class="p">);</span>
<span class="w">          </span><span class="k">return</span><span class="w"> </span><span class="mf">0</span><span class="p">;</span>
<span class="w">        </span><span class="p">},</span>
<span class="w">        </span><span class="nx">fd_close</span><span class="o">:</span><span class="w"> </span><span class="kd">function</span><span class="p">(</span><span class="nx">fd</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">          </span><span class="k">return</span><span class="w"> </span><span class="mf">0</span><span class="p">;</span>
<span class="w">        </span><span class="p">},</span>
<span class="w">        </span><span class="nx">fd_fdstat_get</span><span class="o">:</span><span class="w"> </span><span class="kd">function</span><span class="p">(</span><span class="nx">fd</span><span class="p">,</span><span class="w"> </span><span class="nx">out_ptr</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">          </span><span class="p">(</span><span class="ow">new</span><span class="w"> </span><span class="nb">DataView</span><span class="p">(</span><span class="nx">mem</span><span class="p">.</span><span class="nx">buffer</span><span class="p">)).</span><span class="nx">setInt32</span><span class="p">(</span><span class="nx">out_ptr</span><span class="p">,</span><span class="w"> </span><span class="mf">0</span><span class="p">);</span>
<span class="w">          </span><span class="c1">// type</span>
<span class="w">          </span><span class="k">switch</span><span class="w"> </span><span class="p">(</span><span class="nx">fd</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">          </span><span class="k">case</span><span class="w"> </span><span class="mf">3</span><span class="o">:</span>
<span class="w">            </span><span class="p">(</span><span class="ow">new</span><span class="w"> </span><span class="nb">DataView</span><span class="p">(</span><span class="nx">mem</span><span class="p">.</span><span class="nx">buffer</span><span class="p">)).</span><span class="nx">setInt32</span><span class="p">(</span><span class="nx">out_ptr</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mf">4</span><span class="p">,</span><span class="w"> </span><span class="mf">3</span><span class="p">,</span><span class="w"> </span><span class="kc">true</span><span class="p">);</span>
<span class="w">            </span><span class="k">break</span><span class="p">;</span>
<span class="w">          </span><span class="k">case</span><span class="w"> </span><span class="mf">4</span><span class="o">:</span>
<span class="w">            </span><span class="p">(</span><span class="ow">new</span><span class="w"> </span><span class="nb">DataView</span><span class="p">(</span><span class="nx">mem</span><span class="p">.</span><span class="nx">buffer</span><span class="p">)).</span><span class="nx">setInt32</span><span class="p">(</span><span class="nx">out_ptr</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mf">4</span><span class="p">,</span><span class="w"> </span><span class="mf">4</span><span class="p">,</span><span class="w"> </span><span class="kc">true</span><span class="p">);</span>
<span class="w">            </span><span class="k">break</span><span class="p">;</span>
<span class="w">          </span><span class="k">default</span><span class="o">:</span>
<span class="w">            </span><span class="p">(</span><span class="ow">new</span><span class="w"> </span><span class="nb">DataView</span><span class="p">(</span><span class="nx">mem</span><span class="p">.</span><span class="nx">buffer</span><span class="p">)).</span><span class="nx">setInt32</span><span class="p">(</span><span class="nx">out_ptr</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mf">4</span><span class="p">,</span><span class="w"> </span><span class="mf">0</span><span class="p">,</span><span class="w"> </span><span class="kc">true</span><span class="p">);</span>
<span class="w">            </span><span class="k">break</span><span class="p">;</span>
<span class="w">          </span><span class="p">}</span>
<span class="w">          </span><span class="p">(</span><span class="ow">new</span><span class="w"> </span><span class="nb">DataView</span><span class="p">(</span><span class="nx">mem</span><span class="p">.</span><span class="nx">buffer</span><span class="p">)).</span><span class="nx">setInt32</span><span class="p">(</span><span class="nx">out_ptr</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mf">8</span><span class="p">,</span><span class="w"> </span><span class="mf">0</span><span class="p">,</span><span class="w"> </span><span class="kc">true</span><span class="p">);</span>
<span class="w">          </span><span class="p">(</span><span class="ow">new</span><span class="w"> </span><span class="nb">DataView</span><span class="p">(</span><span class="nx">mem</span><span class="p">.</span><span class="nx">buffer</span><span class="p">)).</span><span class="nx">setInt32</span><span class="p">(</span><span class="nx">out_ptr</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mf">12</span><span class="p">,</span><span class="w"> </span><span class="mf">0</span><span class="p">,</span><span class="w"> </span><span class="kc">true</span><span class="p">);</span>
<span class="w">          </span><span class="p">(</span><span class="ow">new</span><span class="w"> </span><span class="nb">DataView</span><span class="p">(</span><span class="nx">mem</span><span class="p">.</span><span class="nx">buffer</span><span class="p">)).</span><span class="nx">setInt32</span><span class="p">(</span><span class="nx">out_ptr</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mf">16</span><span class="p">,</span><span class="w"> </span><span class="mf">0</span><span class="p">,</span><span class="w"> </span><span class="kc">true</span><span class="p">);</span>
<span class="w">          </span><span class="p">(</span><span class="ow">new</span><span class="w"> </span><span class="nb">DataView</span><span class="p">(</span><span class="nx">mem</span><span class="p">.</span><span class="nx">buffer</span><span class="p">)).</span><span class="nx">setInt32</span><span class="p">(</span><span class="nx">out_ptr</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mf">20</span><span class="p">,</span><span class="w"> </span><span class="mf">0</span><span class="p">,</span><span class="w"> </span><span class="kc">true</span><span class="p">);</span>
<span class="w">          </span><span class="k">return</span><span class="w"> </span><span class="mf">0</span><span class="p">;</span>
<span class="w">        </span><span class="p">},</span>
<span class="w">        </span><span class="nx">fd_prestat_get</span><span class="o">:</span><span class="w"> </span><span class="kd">function</span><span class="p">(</span><span class="nx">a</span><span class="p">,</span><span class="w"> </span><span class="nx">b</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">          </span><span class="c1">// case for preopened "."</span>
<span class="w">          </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">a</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mf">3</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="c1">// discriminant for directory</span>
<span class="w">            </span><span class="p">(</span><span class="ow">new</span><span class="w"> </span><span class="nb">DataView</span><span class="p">(</span><span class="nx">mem</span><span class="p">.</span><span class="nx">buffer</span><span class="p">)).</span><span class="nx">setInt32</span><span class="p">(</span><span class="nx">b</span><span class="p">,</span><span class="w"> </span><span class="mf">0</span><span class="p">,</span><span class="w"> </span><span class="kc">true</span><span class="p">);</span>
<span class="w">            </span><span class="c1">// one entry in directory</span>
<span class="w">            </span><span class="p">(</span><span class="ow">new</span><span class="w"> </span><span class="nb">DataView</span><span class="p">(</span><span class="nx">mem</span><span class="p">.</span><span class="nx">buffer</span><span class="p">)).</span><span class="nx">setInt32</span><span class="p">(</span><span class="nx">b</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mf">4</span><span class="p">,</span><span class="w"> </span><span class="mf">1</span><span class="p">,</span><span class="w"> </span><span class="kc">true</span><span class="p">);</span>
<span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="mf">0</span><span class="p">;</span>
<span class="w">          </span><span class="p">}</span>
<span class="w">          </span><span class="k">return</span><span class="w"> </span><span class="mf">8</span><span class="p">;</span>
<span class="w">        </span><span class="p">},</span>
<span class="w">        </span><span class="nx">fd_prestat_dir_name</span><span class="o">:</span><span class="w"> </span><span class="kd">function</span><span class="p">(</span><span class="nx">fd</span><span class="p">,</span><span class="w"> </span><span class="nx">ptr</span><span class="p">,</span><span class="w"> </span><span class="nx">len</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">          </span><span class="kd">let</span><span class="w"> </span><span class="nx">buf</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="ow">new</span><span class="w"> </span><span class="nx">TextEncoder</span><span class="p">(</span><span class="s1">'utf-8'</span><span class="p">)).</span><span class="nx">encode</span><span class="p">(</span><span class="s2">"."</span><span class="p">,</span><span class="w"> </span><span class="mf">1</span><span class="p">);</span>
<span class="w">          </span><span class="kd">let</span><span class="w"> </span><span class="nx">mem8</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nb">Uint8Array</span><span class="p">(</span><span class="nx">mem</span><span class="p">.</span><span class="nx">buffer</span><span class="p">);</span>
<span class="w">          </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kd">let</span><span class="w"> </span><span class="nx">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0</span><span class="p">;</span><span class="w"> </span><span class="nx">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="nb">Math</span><span class="p">.</span><span class="nx">min</span><span class="p">(</span><span class="nx">buf</span><span class="p">.</span><span class="nx">length</span><span class="p">,</span><span class="w"> </span><span class="nx">len</span><span class="p">);</span><span class="w"> </span><span class="nx">i</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="nx">mem8</span><span class="p">[</span><span class="nx">ptr</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nx">i</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">buf</span><span class="p">[</span><span class="nx">i</span><span class="p">];</span>
<span class="w">          </span><span class="p">}</span>
<span class="w">          </span><span class="nx">mem8</span><span class="p">[</span><span class="nb">Math</span><span class="p">.</span><span class="nx">min</span><span class="p">(</span><span class="nx">buf</span><span class="p">.</span><span class="nx">length</span><span class="p">,</span><span class="w"> </span><span class="nx">len</span><span class="p">)]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0</span><span class="p">;</span>
<span class="w">          </span><span class="k">return</span><span class="w"> </span><span class="mf">0</span><span class="p">;</span>
<span class="w">        </span><span class="p">},</span>
<span class="w">        </span><span class="nx">proc_exit</span><span class="o">:</span><span class="w"> </span><span class="kd">function</span><span class="p">(</span><span class="nx">code</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="k">throw</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nx">ProcExitError</span><span class="p">(</span><span class="nx">code</span><span class="p">);</span><span class="w"> </span><span class="p">},</span>
<span class="w">      </span><span class="p">},</span>
<span class="w">    </span><span class="p">});</span>

<span class="w">    </span><span class="nx">mem</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">smInstance</span><span class="p">.</span><span class="nx">exports</span><span class="p">.</span><span class="nx">memory</span><span class="p">;</span>

<span class="w">    </span><span class="k">try</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nx">smInstance</span><span class="p">.</span><span class="nx">exports</span><span class="p">.</span><span class="nx">_start</span><span class="p">();</span>
<span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="nx">e</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">((</span><span class="nx">e</span><span class="w"> </span><span class="ow">instanceof</span><span class="w"> </span><span class="nx">ProcExitError</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="nx">e</span><span class="p">.</span><span class="nx">code</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mf">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">continue</span><span class="p">;</span>
<span class="w">      </span><span class="p">}</span>
<span class="w">      </span><span class="k">throw</span><span class="w"> </span><span class="nx">e</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">  </span><span class="p">}</span>
<span class="w">  </span><span class="nx">print</span><span class="p">(</span><span class="s2">"Okay!"</span><span class="p">);</span>
<span class="p">}</span>

<span class="nx">main</span><span class="p">().</span><span class="k">catch</span><span class="p">(</span><span class="kd">function</span><span class="w"> </span><span class="p">(</span><span class="nx">e</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="nx">print</span><span class="p">(</span><span class="s2">"====== ERROR!!! ======"</span><span class="p">);</span>
<span class="w">  </span><span class="nx">print</span><span class="p">(</span><span class="nx">e</span><span class="p">);</span>
<span class="w">  </span><span class="nx">print</span><span class="p">(</span><span class="nx">e</span><span class="p">.</span><span class="nx">stack</span><span class="p">);</span>
<span class="p">});</span>
</code></pre></div>
<p>&lt;/details&gt;</p>
</blockquote>



<a name="376987569"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%236094%20Further%20Improve%20Execution%20Speed%20wi.../near/376987569" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.236094.20Further.20Improve.20Execution.20Speed.20wi.2E.2E.2E.html#376987569">(Jul 20 2023 at 13:55)</a>:</h4>
<p>fitzgen <a href="https://github.com/bytecodealliance/wasmtime/issues/6094#issuecomment-1643974037">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/6094">issue #6094</a>:</p>
<blockquote>
<p>I talked with @cfallin about these optimizations a little bit yesterday and he pointed out that the <code>select_spectre_guard</code>-elimination pass is probably not safe because it relies on certain guards <strong>_dominating_</strong> other guards. This is a control-flow property but we can only rely on data-flow properties when optimizing Spectre guards. Speculative execution can guess (incorrectly) that control will transfer to a dominated block (where we optimized away a Spectre guard) from some code path that doesn't include the dominator block (where the remaining Spectre guard lives). This guess will ultimately fail, but until then the speculative execution got to execute loads/stores that weren't Spectre guarded, modifying micro-arch state (eg caches) that could then leak data via side channel timing attacks.</p>
<p>(Thinking out loud a bit here:) It is unclear to me whether a local (within the same basic block) version of the <code>select_spectre_guard</code>-elimination pass would be safe. This would still give us nearly all the benefit for the examples I was previously digging into in <code>spidermonkey.wasm</code>. But this is still a control-flow property, and not a data-flow property. Speculative execution could technically still guess that control would transfer into the middle of a block (even though that would be impossible at runtime, assuming we maintain control flow integrity, which if we aren't then we have bigger problems) but that seems like it would never actually happen in practice? I'm not sure I really want to make that argument and stand by it...</p>
<p>All that said, I think the basic constraint-elimination pass would still be beneficial here, but we wouldn't get as much as I originally hoped for in the OP.</p>
</blockquote>



<a name="377022065"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%236094%20Further%20Improve%20Execution%20Speed%20wi.../near/377022065" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.236094.20Further.20Improve.20Execution.20Speed.20wi.2E.2E.2E.html#377022065">(Jul 20 2023 at 15:23)</a>:</h4>
<p>cfallin <a href="https://github.com/bytecodealliance/wasmtime/issues/6094#issuecomment-1644128910">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/6094">issue #6094</a>:</p>
<blockquote>
<p>Thanks for summarizing all this @fitzgen; sorry for not getting to it sooner!</p>
<p>I don't think a "remove dominated checks within a basic block" optimization is safe, either, for the same reasons; I want to try to give a little intuition into how the out-of-order execution works to show why and help guide any further discussions.</p>
<p>The main idea behind OoO is <a href="https://dl.acm.org/doi/10.1145/17356.17391">restricted dataflow execution</a>: "restricted" because it operates like a sliding window over the program's execution trace, and "dataflow execution" because within that window, instructions are decoded into a true dependency graph and can execute whenever their inputs are ready.</p>
<p>You can think of the CPU has having a frontend that predicts some trace (at each branch, picks a direction; at indirects, predicts a target; at returns, predicts based on an internal predictor callstack); that output is a linear stream of instructions. This stream goes through a "rename" stage that computes dependencies and does a sort of SSA-like thing, assigning new physical registers to instructions' written dests; and an "allocate" stage that puts the instructions into a "reorder buffer" (ROB) as well as the scheduling data structures (think "ready queues" and such). Then there is a "retirement stage" that crawls the reorder buffer from a tail pointer, and at any cycle can take some number of the oldest instructions in-flight and "commit" or "retire".</p>
<p>Speculation is a behavior that arises out of the cooperation of the frontend and backend. The frontend is predicting some path; the OoO engine then treats this linear stream as truth; but if a branch resolves differently than it was predicted, or an instruction traps, we need to <em>flush and resteer</em>. In the simplest designs, this happens when the instruction reaches retirement (is the oldest instruction): we need a consistent architectural machine state to restart from, and the most natural way to get that is to let retirement put things back in-order. More complex aproaches use periodic checkpoints but the effect is the same -- the speculation recovery is delayed a bit, and younger instructions (those "beyond" the misspeculation or trap) were still in the dataflow window for however long and could have executed.</p>
<p>So if we have a program something like:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="n">block0</span>:
<span class="nc">jnz</span><span class="w"> </span><span class="n">oob</span><span class="w"> </span><span class="c1">// if out-of-bounds, go elsewhere</span>
<span class="n">r0</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">cmove0</span><span class="w"> </span><span class="c1">// check conditions for unsafe_load0</span>
<span class="n">unsafe_load0</span><span class="w"> </span><span class="n">r0</span>
<span class="n">r1</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">cmove1</span><span class="w"> </span><span class="c1">// check conditions for unsafe_load1</span>
<span class="n">unsafe_load1</span><span class="w"> </span><span class="n">r1</span>
</code></pre></div>
<p>and let's say the branch is mispredicted as falling through (predicted not-OOB, but actually is). Then the reorder buffer will contain those five instructions in order and execution obeys only true dataflow dependencies. Even if we can resolve the branch relatively early, misspeculation recovery is delayed somewhat (possibly until retirement in simple designs, and imagine there are 100 instructions prior to these in the window, so it could be a while). If it weren't for the <code>cmove</code>s, the loads could execute and there's our side-channel. But <code>unsafe_load0</code> can't execute until <code>cmove0</code> produces its result, and likewise <code>unsafe_load1</code>, and even though we predicted this wrong path, the actual dataflow is correct, so the cmoves will pick a NULL pointer and we don't leak anything.</p>
<p>Now say we have</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="n">jnz</span><span class="w"> </span><span class="n">oob</span>
<span class="n">r0</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">cmove0</span>
<span class="n">unsafe_load</span><span class="w"> </span><span class="n">r0</span>
<span class="n">unsafe_load</span><span class="w"> </span><span class="n">r1</span><span class="w"> </span><span class="c1">// assume first inst trapping will guard this one</span>
</code></pre></div>
<p>we get these instructions into the window, and the <code>jnz</code> might be marked in the ROB as mispredicted (resteer at retirement), and the <code>unsafe_load r0</code> might be marked as faulting (resteer to pagefault handler when it reaches retirement; this will never happen though because the jnz recovery happens first), but hey look, this <code>unsafe_load r1</code> uses a register that has been available for a while; nothing is stopping us from running it out-of-order (just as it says on the tin; out-of-order execution to the rescue!). And there's our side-channel leak again.</p>
<p>The basic intuition behind the Spectre mitigations, and guidance from all the CPU vendors, is that processors can speculate control-flow <em>and execute instructions in arbitrary order</em> (and this is fundamental to the 10x perf per clock cycle we've gotten in hardware in the last few decades), but they won't speculate <em>dataflow</em>. (Value speculation is a thing in the uarch research literature but AFAIK no one has ever shipped it; and now that Spectre is a thing, likely no one will?). This is why the cmove thing works. Fences also work, because a fence instruction can't enter the OoO window until every older instruction retires (the window is empty). But of course that window flush is quite expensive.</p>
<p>Given that, I think we need to obey the invariant that <em>some</em> cmove based on an OOB condition exists in the computation of every Wasm address we load. It's possible we could do a multi-stage thing: if we access <code>p</code> and later <code>p - 16</code>, the computation of <code>p - 16</code> could use the cmove-guarded <code>p</code> as input. So something like: <code>v2 = icmp ge v1, bound; v3 = select_spectre_guard v2, v1, nullptr; v4 = load v3+0; v5 = load v3-16</code>. But I suspect that's the best we can do, unless we start playing with fences. My intuition is that this might still be OK if it means we can hoist the one cmove out of a loop -- basically we have a single choke-point where we can "turn off" all the address dataflow. But we'd have to think through it a bit further...</p>
</blockquote>



<a name="377028244"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%236094%20Further%20Improve%20Execution%20Speed%20wi.../near/377028244" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.236094.20Further.20Improve.20Execution.20Speed.20wi.2E.2E.2E.html#377028244">(Jul 20 2023 at 15:39)</a>:</h4>
<p>cfallin <a href="https://github.com/bytecodealliance/wasmtime/issues/6094#issuecomment-1644155607">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/6094">issue #6094</a>:</p>
<blockquote>
<p>Ah, the tidbit of intuition I forgot to state explicitly as well, in case it helps: we can think of faulting loads/stores as a kind of "branch" as well, given that we use the same recovery mechanism as for mispredicted branches. So instructions beyond one that must fault may still be executed speculatively, because we either haven't executed the to-fault inst yet, or we have but our recovery mechanism hasn't yet let us flush the window and redirect to the trap handler. So the "make the load fault" mitigation protects <em>that</em> load, because it won't result to a value that lets its dependent instructions run; but it doesn't protect younger instructions, because they can run before or after (of course with architectural effects only committed once earlier insts resolve successfully, so, never if earlier fault).</p>
<p>Other tidbit of intuition that might help: it's more accurate to think of an OoO CPU as executing <em>every</em> instruction speculatively, rather than thinking of speculation as a thing that happens when the branch predictor meets a branch. The latter is certainly a form of speculation, which we need to produce the linear stream of instructions into the backend. But strictly speaking every execution of a node in the dataflow graph in the backend when that node is <em>not</em> the oldest is speculation that some condition (trap, misspeculated memory ordering or aliasing (st-to-ld-fwd) condition; etc) will not cause a flush. Effects of this speculative early execution are kept in the ROB (or equivalent structures alongside, such as the store buffer) until retirement.</p>
</blockquote>



<a name="377062905"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%236094%20Further%20Improve%20Execution%20Speed%20wi.../near/377062905" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.236094.20Further.20Improve.20Execution.20Speed.20wi.2E.2E.2E.html#377062905">(Jul 20 2023 at 17:37)</a>:</h4>
<p>fitzgen <a href="https://github.com/bytecodealliance/wasmtime/issues/6094#issuecomment-1644327346">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/6094">issue #6094</a>:</p>
<blockquote>
<p>If we add a knob for tuning the size of the null guard page, and both <code>offset1</code> and <code>offset2</code> were within the null guard page and <code>offset1 &gt; offset2</code>, then with the help of the basic constraint-elimination pass, we could do this series of rewrites</p>
<p>Original input, what <code>cranelift-wasm</code> generates now:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="n">addr1_oob</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">index</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">offset1</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="n">heap_bound</span>
<span class="n">addr1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">spectre_select_guard</span><span class="p">(</span><span class="n">addr1_oob</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">heap_base</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">index</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">offset1</span><span class="p">)</span>
<span class="n">addr2_oob</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">index</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">offset2</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="n">heap_bound</span>
<span class="n">addr2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">spectre_select_guard</span><span class="p">(</span><span class="n">addr2_oob</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">heap_base</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">index</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">offset2</span><span class="p">)</span>
</code></pre></div>
<p>Pull offsets out the spectre guard because they are smaller than the null guard page (or just modify <code>cranelift-wasm</code> to emit them like this in the first place, since that is the location where we know the heap configuration):</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="n">addr1_oob</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">index</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">offset1</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="n">heap_bound</span>
<span class="n">addr1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">spectre_select_guard</span><span class="p">(</span><span class="n">addr1_oob</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">heap_base</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">index</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">offset1</span>
<span class="n">addr2_oob</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">index</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">offset2</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="n">heap_bound</span>
<span class="n">addr2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">spectre_select_guard</span><span class="p">(</span><span class="n">addr2_oob</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">heap_base</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">index</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">offset2</span>
</code></pre></div>
<p>Basic constraint-elimination pass makes <code>addr2_oob</code> an alias of <code>addr1_oob</code> because <code>offset1 &gt; offset2</code>:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="n">addr1_oob</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">index</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">offset1</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="n">heap_bound</span>
<span class="n">addr1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">spectre_select_guard</span><span class="p">(</span><span class="n">addr1_oob</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">heap_base</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">index</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">offset1</span>
<span class="n">addr2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">spectre_select_guard</span><span class="p">(</span><span class="n">addr1_oob</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">heap_base</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">index</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">offset2</span>
</code></pre></div>
<p>"GVN" (via e-graphs) the <code>spectre_select_guard</code> operation:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="n">addr1_oob</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">index</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">offset1</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="n">heap_bound</span>
<span class="n">base_and_index</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">spectre_select_guard</span><span class="p">(</span><span class="n">addr1_oob</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">heap_base</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">index</span><span class="p">)</span>
<span class="n">addr1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">base_and_index</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">offset1</span>
<span class="n">addr2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">base_and_index</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">offset2</span>
</code></pre></div>
<p>Now we only have a single <code>spectre_select_guard</code>!</p>
<p>@cfallin, how does that sound?</p>
</blockquote>



<a name="377063095"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%236094%20Further%20Improve%20Execution%20Speed%20wi.../near/377063095" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.236094.20Further.20Improve.20Execution.20Speed.20wi.2E.2E.2E.html#377063095">(Jul 20 2023 at 17:38)</a>:</h4>
<p>fitzgen edited a <a href="https://github.com/bytecodealliance/wasmtime/issues/6094#issuecomment-1644327346">comment</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/6094">issue #6094</a>:</p>
<blockquote>
<p>If we add a knob for tuning the size of the null guard page, and both <code>offset1</code> and <code>offset2</code> were within the null guard page and <code>offset1 &gt; offset2</code>, then with the help of the basic constraint-elimination pass, we could do this series of rewrites</p>
<p>Original input, what <code>cranelift-wasm</code> generates now:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="n">addr1_oob</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">index</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">offset1</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="n">heap_bound</span>
<span class="n">addr1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">spectre_select_guard</span><span class="p">(</span><span class="n">addr1_oob</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">heap_base</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">index</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">offset1</span><span class="p">)</span>
<span class="n">addr2_oob</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">index</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">offset2</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="n">heap_bound</span>
<span class="n">addr2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">spectre_select_guard</span><span class="p">(</span><span class="n">addr2_oob</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">heap_base</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">index</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">offset2</span><span class="p">)</span>
</code></pre></div>
<p>Pull offsets out the spectre guard because they are smaller than the null guard page (or just modify <code>cranelift-wasm</code> to emit them like this in the first place, since that is the location where we know the heap configuration):</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="n">addr1_oob</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">index</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">offset1</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="n">heap_bound</span>
<span class="n">addr1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">spectre_select_guard</span><span class="p">(</span><span class="n">addr1_oob</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">heap_base</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">index</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">offset1</span>
<span class="n">addr2_oob</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">index</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">offset2</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="n">heap_bound</span>
<span class="n">addr2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">spectre_select_guard</span><span class="p">(</span><span class="n">addr2_oob</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">heap_base</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">index</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">offset2</span>
</code></pre></div>
<p>Basic constraint-elimination pass makes <code>addr2_oob</code> an alias of <code>addr1_oob</code> because <code>offset1 &gt; offset2</code>:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="n">addr1_oob</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">index</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">offset1</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="n">heap_bound</span>
<span class="n">addr1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">spectre_select_guard</span><span class="p">(</span><span class="n">addr1_oob</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">heap_base</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">index</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">offset1</span>
<span class="n">addr2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">spectre_select_guard</span><span class="p">(</span><span class="n">addr1_oob</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">heap_base</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">index</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">offset2</span>
</code></pre></div>
<p>"GVN" (via e-graphs) the <code>spectre_select_guard</code> operation:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="n">addr1_oob</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">index</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">offset1</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="n">heap_bound</span>
<span class="n">base_and_index</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">spectre_select_guard</span><span class="p">(</span><span class="n">addr1_oob</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">heap_base</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">index</span><span class="p">)</span>
<span class="n">addr1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">base_and_index</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">offset1</span>
<span class="n">addr2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">base_and_index</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">offset2</span>
</code></pre></div>
<p>Now we only have a single <code>spectre_select_guard</code>! And we kept a <code>spectre_select_guard</code> in the DFG for all addresses.</p>
<p>@cfallin, how does that sound?</p>
</blockquote>



<a name="377106815"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%236094%20Further%20Improve%20Execution%20Speed%20wi.../near/377106815" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.236094.20Further.20Improve.20Execution.20Speed.20wi.2E.2E.2E.html#377106815">(Jul 20 2023 at 20:39)</a>:</h4>
<p>cfallin <a href="https://github.com/bytecodealliance/wasmtime/issues/6094#issuecomment-1644574324">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/6094">issue #6094</a>:</p>
<blockquote>
<p>I think this looks workable, yep. It's worth defining here precisely what the "replace <code>addr2_oob</code> with <code>addr1_oob</code>" condition is because it's a little nonstandard -- it isn't equivalence but rather implication (<code>addr2_oob --&gt; addr1_oob</code>). It thus wouldn't be a valid substitution on its own, sans any control-flow context (if <code>addr1</code> and <code>addr2</code> were just value outputs of the program, we'd be changing <code>addr2</code> sometimes); but here it is fine because the access of <code>addr1</code> dominates the access of <code>addr2</code>. Said another way: altering the computed value is fine because such alteration is only observable on a path past a trap.</p>
</blockquote>



<a name="424945642"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%236094%20Further%20Improve%20Execution%20Speed%20wi.../near/424945642" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.236094.20Further.20Improve.20Execution.20Speed.20wi.2E.2E.2E.html#424945642">(Mar 05 2024 at 19:47)</a>:</h4>
<p>jameysharp <a href="https://github.com/bytecodealliance/wasmtime/issues/6094#issuecomment-1979513676">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/6094">issue #6094</a>:</p>
<blockquote>
<p>Could cranelift-wasm track enough information to fully do this transformation itself, instead of implementing a generic optimization in Cranelift?</p>
<p>I think that because wasm only has reducible control flow, the dominator tree is implied by the control-flow instructions in the input wasm. So I think we can keep track of which linear-memory accesses dominate the current instruction while making a single pass over the input program.</p>
<p>If so, then we could maintain a scoped hash map keyed on CLIF <code>Value</code>s which have been used as the index to some dominating memory access. (Since <code>local.get</code> and various stack manipulations are all rewritten to SSA values during this phase, this should suffice to normalize a variety of weird patterns in the original wasm.)</p>
<p>These keys would map to a pair of the maximum offset checked so far, and the <code>select_spectre_guard</code> result that was used in that check. If the current access is less than or equal to that offset then the result can be reused. Otherwise we need another bounds-check but can update the map with the new larger offset and new bounds-checked base.</p>
<p>That's pretty simple compared to doing it generically in Cranelift, right?</p>
</blockquote>



<a name="424972664"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%236094%20Further%20Improve%20Execution%20Speed%20wi.../near/424972664" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.236094.20Further.20Improve.20Execution.20Speed.20wi.2E.2E.2E.html#424972664">(Mar 05 2024 at 22:54)</a>:</h4>
<p>fitzgen <a href="https://github.com/bytecodealliance/wasmtime/issues/6094#issuecomment-1979774334">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/6094">issue #6094</a>:</p>
<blockquote>
<p>I think it is possible, yes. The idea of fusing this optimization with an existing pass where we have domination "for free" is definitely tempting.</p>
<p>One hardship I expect we would encounter would be that this runs before the phi-elimination pass and therefore we would likely leave some optimizations on the table, especially around Wasm locals and joining control flow.</p>
<blockquote>
<p>That's pretty simple compared to doing it generically in Cranelift, right?</p>
</blockquote>
<p>Perhaps?</p>
<p>I don't think the passes I outlined above are too complicated, its mostly just a matter of writing them such that they can be fused with each other and with the egraphs pass (similar to how the alias analysis is written). As long as that is done, then it seems fairly straightforward to me: two passes that each do a single shape of optimization.</p>
<p>In contrast, in <code>cranelift-wasm</code> we are already doing a bunch of translation and such, and adding another optimization responsibility in addition to that feels a bit like conflating concerns.</p>
</blockquote>



<hr><p>Last updated: Jan 20 2025 at 06:04 UTC</p>
</html>