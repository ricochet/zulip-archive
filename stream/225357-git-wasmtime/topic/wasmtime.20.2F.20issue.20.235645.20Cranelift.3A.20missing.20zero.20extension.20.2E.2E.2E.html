<html>
<head><meta charset="utf-8"><title>wasmtime / issue #5645 Cranelift: missing zero extension ... · git-wasmtime · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/index.html">git-wasmtime</a></h2>
<h3>Topic: <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.235645.20Cranelift.3A.20missing.20zero.20extension.20.2E.2E.2E.html">wasmtime / issue #5645 Cranelift: missing zero extension ...</a></h3>

<hr>

<base href="https://bytecodealliance.zulipchat.com">

<head><link href="https://bytecodealliance.github.io/zulip-archive/style.css" rel="stylesheet"></head>

<a name="324134679"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%235645%20Cranelift%3A%20missing%20zero%20extension%20.../near/324134679" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.235645.20Cranelift.3A.20missing.20zero.20extension.20.2E.2E.2E.html#324134679">(Jan 27 2023 at 19:10)</a>:</h4>
<p>T0b1-iOS opened <a href="https://github.com/bytecodealliance/wasmtime/issues/5645">issue #5645</a>:</p>
<blockquote>
<p>I have stumbled upon a rather nasty 'bug' this week.<br>
When compiling IR like this:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="n">function</span><span class="w"> </span><span class="n">u0</span>:<span class="mi">0</span><span class="p">(</span><span class="kt">i64</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="kt">i64</span> <span class="nc">system_v</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">sig2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="kt">i64</span><span class="p">,</span><span class="w"> </span><span class="kt">i8</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="kt">i64</span> <span class="nc">system_v</span><span class="w"></span>
<span class="w">    </span><span class="n">fn2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">u0</span>:<span class="mi">112</span><span class="w"> </span><span class="n">sig2</span><span class="w"></span>

<span class="n">block0</span><span class="p">(</span><span class="n">v0</span>: <span class="kt">i64</span><span class="p">)</span>:
    <span class="nc">v1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">icmp_imm</span><span class="w"> </span><span class="n">ne</span><span class="w"> </span><span class="n">v0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="w"></span>
<span class="w">    </span><span class="n">v2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">call</span><span class="w"> </span><span class="n">fn2</span><span class="p">(</span><span class="n">v0</span><span class="p">,</span><span class="w"> </span><span class="n">v1</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">v2</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>
<p>you will get assembly that looks like this:</p>
<div class="codehilite" data-code-language="GAS"><pre><span></span><code><span class="w">  </span><span class="nf">pushq</span><span class="w">   </span><span class="nv">%rbp</span><span class="w"></span>
<span class="w">  </span><span class="nf">unwind</span><span class="w"> </span><span class="no">PushFrameRegs</span><span class="w"> </span><span class="err">{</span><span class="w"> </span><span class="no">offset_upward_to_caller_sp</span><span class="p">:</span><span class="w"> </span><span class="mi">16</span><span class="w"> </span><span class="err">}</span><span class="w"></span>
<span class="w">  </span><span class="nf">movq</span><span class="w">    </span><span class="nv">%rsp</span><span class="p">,</span><span class="w"> </span><span class="nv">%rbp</span><span class="w"></span>
<span class="w">  </span><span class="nf">unwind</span><span class="w"> </span><span class="no">DefineNewFrame</span><span class="w"> </span><span class="err">{</span><span class="w"> </span><span class="no">offset_upward_to_caller_sp</span><span class="p">:</span><span class="w"> </span><span class="mi">16</span><span class="p">,</span><span class="w"> </span><span class="no">offset_downward_to_clobbers</span><span class="p">:</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="err">}</span><span class="w"></span>
<span class="nl">block0:</span><span class="w"></span>
<span class="w">  </span><span class="nf">cmpq</span><span class="w">    </span><span class="no">$0</span><span class="p">,</span><span class="w"> </span><span class="nv">%rdi</span><span class="w"></span>
<span class="w">  </span><span class="nf">setnz</span><span class="w">   </span><span class="nv">%sil</span><span class="w"></span>
<span class="w">  </span><span class="nf">load_ext_name</span><span class="w"> </span><span class="no">userextname0</span><span class="err">+</span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="nv">%r8</span><span class="w"></span>
<span class="w">  </span><span class="nf">call</span><span class="w">    </span><span class="p">*</span><span class="nv">%r8</span><span class="w"></span>
<span class="w">  </span><span class="nf">movq</span><span class="w">    </span><span class="nv">%rbp</span><span class="p">,</span><span class="w"> </span><span class="nv">%rsp</span><span class="w"></span>
<span class="w">  </span><span class="nf">popq</span><span class="w">    </span><span class="nv">%rbp</span><span class="w"></span>
<span class="w">  </span><span class="nf">ret</span><span class="w"></span>
</code></pre></div>
<p>Note that the <code>icmp_imm</code> gets compiled to a <code>cmp</code> followed by a <code>setcc</code> instruction using <code>sil</code> as a parameter.<br>
This means that the upper bytes of <code>rsi</code> are undefined. Now when <code>fn2</code> is a C function that looks like this:</p>
<div class="codehilite" data-code-language="C"><pre><span></span><code><span class="kt">void</span><span class="w"> </span><span class="nf">fun</span><span class="p">(</span><span class="kt">uint64_t</span><span class="w"> </span><span class="n">x</span><span class="p">,</span><span class="w"> </span><span class="kt">bool</span><span class="w"> </span><span class="n">a</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">do_smth</span><span class="p">(</span><span class="n">a</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="mi">0</span><span class="p">);</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>
<p>and you compile this with clang the assembly looks like this:</p>
<div class="codehilite" data-code-language="GAS"><pre><span></span><code><span class="nf">xor</span><span class="w">     </span><span class="no">eax</span><span class="p">,</span><span class="w"> </span><span class="no">eax</span><span class="w"></span>
<span class="nf">test</span><span class="w">    </span><span class="no">esi</span><span class="p">,</span><span class="w"> </span><span class="no">esi</span><span class="w"></span>
<span class="nf">cmove</span><span class="w">   </span><span class="no">rdi</span><span class="p">,</span><span class="w"> </span><span class="no">rax</span><span class="w"></span>
<span class="nf">jmp</span><span class="w">     </span><span class="no">do_smth</span><span class="p">(</span><span class="no">unsigned</span><span class="w"> </span><span class="no">long</span><span class="p">)</span><span class="err">@</span><span class="no">PLT</span><span class="w"></span>
</code></pre></div>
<p>while with gcc you get</p>
<div class="codehilite" data-code-language="GAS"><pre><span></span><code><span class="nf">xor</span><span class="w">     </span><span class="no">eax</span><span class="p">,</span><span class="w"> </span><span class="no">eax</span><span class="w"></span>
<span class="nf">test</span><span class="w">    </span><span class="no">sil</span><span class="p">,</span><span class="w"> </span><span class="no">sil</span><span class="w"></span>
<span class="nf">cmove</span><span class="w">   </span><span class="no">rdi</span><span class="p">,</span><span class="w"> </span><span class="no">rax</span><span class="w"></span>
<span class="nf">jmp</span><span class="w">     </span><span class="no">do_smth</span><span class="p">(</span><span class="no">unsigned</span><span class="w"> </span><span class="no">long</span><span class="p">)</span><span class="w"></span>
</code></pre></div>
<p>Note that gcc emits a <code>test sil, sil</code> instruction while clang emits <code>test esi, esi</code> meaning that it relies on the 8bit argument getting zero-extended to at least 32 bit and therefore you will get random behavior depending on whether the upper bytes of <code>rsi</code> were zero or not. (<a href="https://godbolt.org/z/Mn5qzjP8j">Compiler Explorer link</a>)<br>
<a href="https://bugs.llvm.org/show_bug.cgi?id=44228">According to the people at LLVM</a>, whether arguments should be zero-extended or not is unclear in the ABI and therefore they do not consider it a bug until this issue has been resolved on the ABI level since the major compilers do zero-extend the arguments.</p>
<p>Now my question is, do you consider this a bug in cranelift or at least an issue that should be addressed on the codegen level inside cranelift? (I have fixed this by manually checking if an argument is I8/I16 when emitting a function call and then passed that through a <code>uextend</code>/<code>inarrow</code> combo)<br>
Maybe this could be done when the <code>enable_llvm_abi_extensions</code> flag is set?<br>
And then the question would be where to fix it: When passing a variable to an external function or making sure that when instructions like <code>setcc</code> are emitted the upper parts of the destination register are cleared beforehand?<br>
</p>
</blockquote>



<a name="324134680"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%235645%20Cranelift%3A%20missing%20zero%20extension%20.../near/324134680" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.235645.20Cranelift.3A.20missing.20zero.20extension.20.2E.2E.2E.html#324134680">(Jan 27 2023 at 19:10)</a>:</h4>
<p>T0b1-iOS labeled <a href="https://github.com/bytecodealliance/wasmtime/issues/5645">issue #5645</a>:</p>
<blockquote>
<p>I have stumbled upon a rather nasty 'bug' this week.<br>
When compiling IR like this:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="n">function</span><span class="w"> </span><span class="n">u0</span>:<span class="mi">0</span><span class="p">(</span><span class="kt">i64</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="kt">i64</span> <span class="nc">system_v</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">sig2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="kt">i64</span><span class="p">,</span><span class="w"> </span><span class="kt">i8</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="kt">i64</span> <span class="nc">system_v</span><span class="w"></span>
<span class="w">    </span><span class="n">fn2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">u0</span>:<span class="mi">112</span><span class="w"> </span><span class="n">sig2</span><span class="w"></span>

<span class="n">block0</span><span class="p">(</span><span class="n">v0</span>: <span class="kt">i64</span><span class="p">)</span>:
    <span class="nc">v1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">icmp_imm</span><span class="w"> </span><span class="n">ne</span><span class="w"> </span><span class="n">v0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="w"></span>
<span class="w">    </span><span class="n">v2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">call</span><span class="w"> </span><span class="n">fn2</span><span class="p">(</span><span class="n">v0</span><span class="p">,</span><span class="w"> </span><span class="n">v1</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">v2</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>
<p>you will get assembly that looks like this:</p>
<div class="codehilite" data-code-language="GAS"><pre><span></span><code><span class="w">  </span><span class="nf">pushq</span><span class="w">   </span><span class="nv">%rbp</span><span class="w"></span>
<span class="w">  </span><span class="nf">unwind</span><span class="w"> </span><span class="no">PushFrameRegs</span><span class="w"> </span><span class="err">{</span><span class="w"> </span><span class="no">offset_upward_to_caller_sp</span><span class="p">:</span><span class="w"> </span><span class="mi">16</span><span class="w"> </span><span class="err">}</span><span class="w"></span>
<span class="w">  </span><span class="nf">movq</span><span class="w">    </span><span class="nv">%rsp</span><span class="p">,</span><span class="w"> </span><span class="nv">%rbp</span><span class="w"></span>
<span class="w">  </span><span class="nf">unwind</span><span class="w"> </span><span class="no">DefineNewFrame</span><span class="w"> </span><span class="err">{</span><span class="w"> </span><span class="no">offset_upward_to_caller_sp</span><span class="p">:</span><span class="w"> </span><span class="mi">16</span><span class="p">,</span><span class="w"> </span><span class="no">offset_downward_to_clobbers</span><span class="p">:</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="err">}</span><span class="w"></span>
<span class="nl">block0:</span><span class="w"></span>
<span class="w">  </span><span class="nf">cmpq</span><span class="w">    </span><span class="no">$0</span><span class="p">,</span><span class="w"> </span><span class="nv">%rdi</span><span class="w"></span>
<span class="w">  </span><span class="nf">setnz</span><span class="w">   </span><span class="nv">%sil</span><span class="w"></span>
<span class="w">  </span><span class="nf">load_ext_name</span><span class="w"> </span><span class="no">userextname0</span><span class="err">+</span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="nv">%r8</span><span class="w"></span>
<span class="w">  </span><span class="nf">call</span><span class="w">    </span><span class="p">*</span><span class="nv">%r8</span><span class="w"></span>
<span class="w">  </span><span class="nf">movq</span><span class="w">    </span><span class="nv">%rbp</span><span class="p">,</span><span class="w"> </span><span class="nv">%rsp</span><span class="w"></span>
<span class="w">  </span><span class="nf">popq</span><span class="w">    </span><span class="nv">%rbp</span><span class="w"></span>
<span class="w">  </span><span class="nf">ret</span><span class="w"></span>
</code></pre></div>
<p>Note that the <code>icmp_imm</code> gets compiled to a <code>cmp</code> followed by a <code>setcc</code> instruction using <code>sil</code> as a parameter.<br>
This means that the upper bytes of <code>rsi</code> are undefined. Now when <code>fn2</code> is a C function that looks like this:</p>
<div class="codehilite" data-code-language="C"><pre><span></span><code><span class="kt">void</span><span class="w"> </span><span class="nf">fun</span><span class="p">(</span><span class="kt">uint64_t</span><span class="w"> </span><span class="n">x</span><span class="p">,</span><span class="w"> </span><span class="kt">bool</span><span class="w"> </span><span class="n">a</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">do_smth</span><span class="p">(</span><span class="n">a</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="mi">0</span><span class="p">);</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>
<p>and you compile this with clang the assembly looks like this:</p>
<div class="codehilite" data-code-language="GAS"><pre><span></span><code><span class="nf">xor</span><span class="w">     </span><span class="no">eax</span><span class="p">,</span><span class="w"> </span><span class="no">eax</span><span class="w"></span>
<span class="nf">test</span><span class="w">    </span><span class="no">esi</span><span class="p">,</span><span class="w"> </span><span class="no">esi</span><span class="w"></span>
<span class="nf">cmove</span><span class="w">   </span><span class="no">rdi</span><span class="p">,</span><span class="w"> </span><span class="no">rax</span><span class="w"></span>
<span class="nf">jmp</span><span class="w">     </span><span class="no">do_smth</span><span class="p">(</span><span class="no">unsigned</span><span class="w"> </span><span class="no">long</span><span class="p">)</span><span class="err">@</span><span class="no">PLT</span><span class="w"></span>
</code></pre></div>
<p>while with gcc you get</p>
<div class="codehilite" data-code-language="GAS"><pre><span></span><code><span class="nf">xor</span><span class="w">     </span><span class="no">eax</span><span class="p">,</span><span class="w"> </span><span class="no">eax</span><span class="w"></span>
<span class="nf">test</span><span class="w">    </span><span class="no">sil</span><span class="p">,</span><span class="w"> </span><span class="no">sil</span><span class="w"></span>
<span class="nf">cmove</span><span class="w">   </span><span class="no">rdi</span><span class="p">,</span><span class="w"> </span><span class="no">rax</span><span class="w"></span>
<span class="nf">jmp</span><span class="w">     </span><span class="no">do_smth</span><span class="p">(</span><span class="no">unsigned</span><span class="w"> </span><span class="no">long</span><span class="p">)</span><span class="w"></span>
</code></pre></div>
<p>Note that gcc emits a <code>test sil, sil</code> instruction while clang emits <code>test esi, esi</code> meaning that it relies on the 8bit argument getting zero-extended to at least 32 bit and therefore you will get random behavior depending on whether the upper bytes of <code>rsi</code> were zero or not. (<a href="https://godbolt.org/z/Mn5qzjP8j">Compiler Explorer link</a>)<br>
<a href="https://bugs.llvm.org/show_bug.cgi?id=44228">According to the people at LLVM</a>, whether arguments should be zero-extended or not is unclear in the ABI and therefore they do not consider it a bug until this issue has been resolved on the ABI level since the major compilers do zero-extend the arguments.</p>
<p>Now my question is, do you consider this a bug in cranelift or at least an issue that should be addressed on the codegen level inside cranelift? (I have fixed this by manually checking if an argument is I8/I16 when emitting a function call and then passed that through a <code>uextend</code>/<code>inarrow</code> combo)<br>
Maybe this could be done when the <code>enable_llvm_abi_extensions</code> flag is set?<br>
And then the question would be where to fix it: When passing a variable to an external function or making sure that when instructions like <code>setcc</code> are emitted the upper parts of the destination register are cleared beforehand?<br>
</p>
</blockquote>



<a name="324134682"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%235645%20Cranelift%3A%20missing%20zero%20extension%20.../near/324134682" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.235645.20Cranelift.3A.20missing.20zero.20extension.20.2E.2E.2E.html#324134682">(Jan 27 2023 at 19:10)</a>:</h4>
<p>T0b1-iOS labeled <a href="https://github.com/bytecodealliance/wasmtime/issues/5645">issue #5645</a>:</p>
<blockquote>
<p>I have stumbled upon a rather nasty 'bug' this week.<br>
When compiling IR like this:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="n">function</span><span class="w"> </span><span class="n">u0</span>:<span class="mi">0</span><span class="p">(</span><span class="kt">i64</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="kt">i64</span> <span class="nc">system_v</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">sig2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="kt">i64</span><span class="p">,</span><span class="w"> </span><span class="kt">i8</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="kt">i64</span> <span class="nc">system_v</span><span class="w"></span>
<span class="w">    </span><span class="n">fn2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">u0</span>:<span class="mi">112</span><span class="w"> </span><span class="n">sig2</span><span class="w"></span>

<span class="n">block0</span><span class="p">(</span><span class="n">v0</span>: <span class="kt">i64</span><span class="p">)</span>:
    <span class="nc">v1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">icmp_imm</span><span class="w"> </span><span class="n">ne</span><span class="w"> </span><span class="n">v0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="w"></span>
<span class="w">    </span><span class="n">v2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">call</span><span class="w"> </span><span class="n">fn2</span><span class="p">(</span><span class="n">v0</span><span class="p">,</span><span class="w"> </span><span class="n">v1</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">v2</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>
<p>you will get assembly that looks like this:</p>
<div class="codehilite" data-code-language="GAS"><pre><span></span><code><span class="w">  </span><span class="nf">pushq</span><span class="w">   </span><span class="nv">%rbp</span><span class="w"></span>
<span class="w">  </span><span class="nf">unwind</span><span class="w"> </span><span class="no">PushFrameRegs</span><span class="w"> </span><span class="err">{</span><span class="w"> </span><span class="no">offset_upward_to_caller_sp</span><span class="p">:</span><span class="w"> </span><span class="mi">16</span><span class="w"> </span><span class="err">}</span><span class="w"></span>
<span class="w">  </span><span class="nf">movq</span><span class="w">    </span><span class="nv">%rsp</span><span class="p">,</span><span class="w"> </span><span class="nv">%rbp</span><span class="w"></span>
<span class="w">  </span><span class="nf">unwind</span><span class="w"> </span><span class="no">DefineNewFrame</span><span class="w"> </span><span class="err">{</span><span class="w"> </span><span class="no">offset_upward_to_caller_sp</span><span class="p">:</span><span class="w"> </span><span class="mi">16</span><span class="p">,</span><span class="w"> </span><span class="no">offset_downward_to_clobbers</span><span class="p">:</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="err">}</span><span class="w"></span>
<span class="nl">block0:</span><span class="w"></span>
<span class="w">  </span><span class="nf">cmpq</span><span class="w">    </span><span class="no">$0</span><span class="p">,</span><span class="w"> </span><span class="nv">%rdi</span><span class="w"></span>
<span class="w">  </span><span class="nf">setnz</span><span class="w">   </span><span class="nv">%sil</span><span class="w"></span>
<span class="w">  </span><span class="nf">load_ext_name</span><span class="w"> </span><span class="no">userextname0</span><span class="err">+</span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="nv">%r8</span><span class="w"></span>
<span class="w">  </span><span class="nf">call</span><span class="w">    </span><span class="p">*</span><span class="nv">%r8</span><span class="w"></span>
<span class="w">  </span><span class="nf">movq</span><span class="w">    </span><span class="nv">%rbp</span><span class="p">,</span><span class="w"> </span><span class="nv">%rsp</span><span class="w"></span>
<span class="w">  </span><span class="nf">popq</span><span class="w">    </span><span class="nv">%rbp</span><span class="w"></span>
<span class="w">  </span><span class="nf">ret</span><span class="w"></span>
</code></pre></div>
<p>Note that the <code>icmp_imm</code> gets compiled to a <code>cmp</code> followed by a <code>setcc</code> instruction using <code>sil</code> as a parameter.<br>
This means that the upper bytes of <code>rsi</code> are undefined. Now when <code>fn2</code> is a C function that looks like this:</p>
<div class="codehilite" data-code-language="C"><pre><span></span><code><span class="kt">void</span><span class="w"> </span><span class="nf">fun</span><span class="p">(</span><span class="kt">uint64_t</span><span class="w"> </span><span class="n">x</span><span class="p">,</span><span class="w"> </span><span class="kt">bool</span><span class="w"> </span><span class="n">a</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">do_smth</span><span class="p">(</span><span class="n">a</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="mi">0</span><span class="p">);</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>
<p>and you compile this with clang the assembly looks like this:</p>
<div class="codehilite" data-code-language="GAS"><pre><span></span><code><span class="nf">xor</span><span class="w">     </span><span class="no">eax</span><span class="p">,</span><span class="w"> </span><span class="no">eax</span><span class="w"></span>
<span class="nf">test</span><span class="w">    </span><span class="no">esi</span><span class="p">,</span><span class="w"> </span><span class="no">esi</span><span class="w"></span>
<span class="nf">cmove</span><span class="w">   </span><span class="no">rdi</span><span class="p">,</span><span class="w"> </span><span class="no">rax</span><span class="w"></span>
<span class="nf">jmp</span><span class="w">     </span><span class="no">do_smth</span><span class="p">(</span><span class="no">unsigned</span><span class="w"> </span><span class="no">long</span><span class="p">)</span><span class="err">@</span><span class="no">PLT</span><span class="w"></span>
</code></pre></div>
<p>while with gcc you get</p>
<div class="codehilite" data-code-language="GAS"><pre><span></span><code><span class="nf">xor</span><span class="w">     </span><span class="no">eax</span><span class="p">,</span><span class="w"> </span><span class="no">eax</span><span class="w"></span>
<span class="nf">test</span><span class="w">    </span><span class="no">sil</span><span class="p">,</span><span class="w"> </span><span class="no">sil</span><span class="w"></span>
<span class="nf">cmove</span><span class="w">   </span><span class="no">rdi</span><span class="p">,</span><span class="w"> </span><span class="no">rax</span><span class="w"></span>
<span class="nf">jmp</span><span class="w">     </span><span class="no">do_smth</span><span class="p">(</span><span class="no">unsigned</span><span class="w"> </span><span class="no">long</span><span class="p">)</span><span class="w"></span>
</code></pre></div>
<p>Note that gcc emits a <code>test sil, sil</code> instruction while clang emits <code>test esi, esi</code> meaning that it relies on the 8bit argument getting zero-extended to at least 32 bit and therefore you will get random behavior depending on whether the upper bytes of <code>rsi</code> were zero or not. (<a href="https://godbolt.org/z/Mn5qzjP8j">Compiler Explorer link</a>)<br>
<a href="https://bugs.llvm.org/show_bug.cgi?id=44228">According to the people at LLVM</a>, whether arguments should be zero-extended or not is unclear in the ABI and therefore they do not consider it a bug until this issue has been resolved on the ABI level since the major compilers do zero-extend the arguments.</p>
<p>Now my question is, do you consider this a bug in cranelift or at least an issue that should be addressed on the codegen level inside cranelift? (I have fixed this by manually checking if an argument is I8/I16 when emitting a function call and then passed that through a <code>uextend</code>/<code>inarrow</code> combo)<br>
Maybe this could be done when the <code>enable_llvm_abi_extensions</code> flag is set?<br>
And then the question would be where to fix it: When passing a variable to an external function or making sure that when instructions like <code>setcc</code> are emitted the upper parts of the destination register are cleared beforehand?<br>
</p>
</blockquote>



<a name="324136041"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%235645%20Cranelift%3A%20missing%20zero%20extension%20.../near/324136041" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.235645.20Cranelift.3A.20missing.20zero.20extension.20.2E.2E.2E.html#324136041">(Jan 27 2023 at 19:18)</a>:</h4>
<p>bjorn3 <a href="https://github.com/bytecodealliance/wasmtime/issues/5645#issuecomment-1406968622">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/5645">issue #5645</a>:</p>
<blockquote>
<p>You will need to set the <code>zext</code> flag in the function signature (and <code>sext</code> in case of signed ints). Cranelift provides all the building blocks for correctly handling the abi, but it is the responsibility of the frontend to correctly use those building blocks, just like in LLVM. See for example <a href="https://github.com/rust-lang/rust/blob/7919ef0ec5776c72dace7fec1c68551a617505ad/compiler/rustc_target/src/abi/call/x86_64.rs#L232">https://github.com/rust-lang/rust/blob/7919ef0ec5776c72dace7fec1c68551a617505ad/compiler/rustc_target/src/abi/call/x86_64.rs#L232</a> for where rustc specifies that these flags need to be set.</p>
</blockquote>



<a name="324138796"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%235645%20Cranelift%3A%20missing%20zero%20extension%20.../near/324138796" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.235645.20Cranelift.3A.20missing.20zero.20extension.20.2E.2E.2E.html#324138796">(Jan 27 2023 at 19:35)</a>:</h4>
<p>cfallin <a href="https://github.com/bytecodealliance/wasmtime/issues/5645#issuecomment-1406986262">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/5645">issue #5645</a>:</p>
<blockquote>
<p>It seems the crux of the matter is how we interpret SysV ABI handling of narrow values; if according to the LLVM bug you linked, zext up to 32 bits is "de-facto the ABI already", then we could implement that, perhaps under a flag. But until/unless we decide to do that, @bjorn3's suggestion is the best: when translating C signatures to Cranelift, add <code>zext</code> to <code>i8</code> or <code>i16</code> values.</p>
</blockquote>



<a name="324138934"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%235645%20Cranelift%3A%20missing%20zero%20extension%20.../near/324138934" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.235645.20Cranelift.3A.20missing.20zero.20extension.20.2E.2E.2E.html#324138934">(Jan 27 2023 at 19:35)</a>:</h4>
<p>T0b1-iOS <a href="https://github.com/bytecodealliance/wasmtime/issues/5645#issuecomment-1406987930">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/5645">issue #5645</a>:</p>
<blockquote>
<p>I'm not sure where to set it though since setting it on the parameter (that's what the ArgumentExtension doc suggests) like below compiles to the same assembly.</p>
<p><div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="n">function</span><span class="w"> </span><span class="n">u0</span>:<span class="mi">0</span><span class="p">(</span><span class="kt">i64</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="kt">i64</span> <span class="nc">system_v</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">sig2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="kt">i64</span><span class="p">,</span><span class="w"> </span><span class="kt">i8</span><span class="w"> </span><span class="n">uext</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="kt">i64</span> <span class="nc">system_v</span><span class="w"></span>
<span class="w">    </span><span class="n">fn2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">u0</span>:<span class="mi">112</span><span class="w"> </span><span class="n">sig2</span><span class="w"></span>

<span class="n">block0</span><span class="p">(</span><span class="n">v0</span>: <span class="kt">i64</span><span class="p">)</span>:
    <span class="nc">v1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">icmp_imm</span><span class="w"> </span><span class="n">ne</span><span class="w"> </span><span class="n">v0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="w"></span>
<span class="w">    </span><span class="n">v2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">call</span><span class="w"> </span><span class="n">fn2</span><span class="p">(</span><span class="n">v0</span><span class="p">,</span><span class="w"> </span><span class="n">v1</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">v2</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div><br>
</p>
</blockquote>



<a name="324139128"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%235645%20Cranelift%3A%20missing%20zero%20extension%20.../near/324139128" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.235645.20Cranelift.3A.20missing.20zero.20extension.20.2E.2E.2E.html#324139128">(Jan 27 2023 at 19:36)</a>:</h4>
<p>T0b1-iOS edited a <a href="https://github.com/bytecodealliance/wasmtime/issues/5645#issuecomment-1406987930">comment</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/5645">issue #5645</a>:</p>
<blockquote>
<p>I'm not sure where to set it though since setting it on the parameter (that's what the ArgumentExtension doc suggests) like below compiles to the same assembly. (maybe it's not parsed by cranelift-reader there? Need to check.</p>
<p><div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="n">function</span><span class="w"> </span><span class="n">u0</span>:<span class="mi">0</span><span class="p">(</span><span class="kt">i64</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="kt">i64</span> <span class="nc">system_v</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">sig2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="kt">i64</span><span class="p">,</span><span class="w"> </span><span class="kt">i8</span><span class="w"> </span><span class="n">uext</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="kt">i64</span> <span class="nc">system_v</span><span class="w"></span>
<span class="w">    </span><span class="n">fn2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">u0</span>:<span class="mi">112</span><span class="w"> </span><span class="n">sig2</span><span class="w"></span>

<span class="n">block0</span><span class="p">(</span><span class="n">v0</span>: <span class="kt">i64</span><span class="p">)</span>:
    <span class="nc">v1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">icmp_imm</span><span class="w"> </span><span class="n">ne</span><span class="w"> </span><span class="n">v0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="w"></span>
<span class="w">    </span><span class="n">v2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">call</span><span class="w"> </span><span class="n">fn2</span><span class="p">(</span><span class="n">v0</span><span class="p">,</span><span class="w"> </span><span class="n">v1</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">v2</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div><br>
</p>
</blockquote>



<a name="324139140"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%235645%20Cranelift%3A%20missing%20zero%20extension%20.../near/324139140" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.235645.20Cranelift.3A.20missing.20zero.20extension.20.2E.2E.2E.html#324139140">(Jan 27 2023 at 19:37)</a>:</h4>
<p>T0b1-iOS edited a <a href="https://github.com/bytecodealliance/wasmtime/issues/5645#issuecomment-1406987930">comment</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/5645">issue #5645</a>:</p>
<blockquote>
<p>I'm not sure where to set it though since setting it on the parameter (that's what the ArgumentExtension doc suggests) like below compiles to the same assembly. (maybe it's not parsed by cranelift-reader there? Need to check.)</p>
<p><div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="n">function</span><span class="w"> </span><span class="n">u0</span>:<span class="mi">0</span><span class="p">(</span><span class="kt">i64</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="kt">i64</span> <span class="nc">system_v</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">sig2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="kt">i64</span><span class="p">,</span><span class="w"> </span><span class="kt">i8</span><span class="w"> </span><span class="n">uext</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="kt">i64</span> <span class="nc">system_v</span><span class="w"></span>
<span class="w">    </span><span class="n">fn2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">u0</span>:<span class="mi">112</span><span class="w"> </span><span class="n">sig2</span><span class="w"></span>

<span class="n">block0</span><span class="p">(</span><span class="n">v0</span>: <span class="kt">i64</span><span class="p">)</span>:
    <span class="nc">v1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">icmp_imm</span><span class="w"> </span><span class="n">ne</span><span class="w"> </span><span class="n">v0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="w"></span>
<span class="w">    </span><span class="n">v2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">call</span><span class="w"> </span><span class="n">fn2</span><span class="p">(</span><span class="n">v0</span><span class="p">,</span><span class="w"> </span><span class="n">v1</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">v2</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div><br>
</p>
</blockquote>



<a name="324140462"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%235645%20Cranelift%3A%20missing%20zero%20extension%20.../near/324140462" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.235645.20Cranelift.3A.20missing.20zero.20extension.20.2E.2E.2E.html#324140462">(Jan 27 2023 at 19:43)</a>:</h4>
<p>cfallin <a href="https://github.com/bytecodealliance/wasmtime/issues/5645#issuecomment-1406997500">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/5645">issue #5645</a>:</p>
<blockquote>
<p>Ah, that is indeed a bug if <code>uext</code> doesn't actually work! We'll look into this.</p>
</blockquote>



<a name="324142626"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%235645%20Cranelift%3A%20missing%20zero%20extension%20.../near/324142626" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.235645.20Cranelift.3A.20missing.20zero.20extension.20.2E.2E.2E.html#324142626">(Jan 27 2023 at 19:57)</a>:</h4>
<p>T0b1-iOS <a href="https://github.com/bytecodealliance/wasmtime/issues/5645#issuecomment-1407010503">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/5645">issue #5645</a>:</p>
<blockquote>
<p>I mean, the comment for ArgumentExtensions mentions </p>
<blockquote>
<p>This attribute specifies how an argument or return value should be extended <em>if the platform and ABI require it</em></p>
</blockquote>
<p>and since the SystemV document is 'ambigous' on this issue it's technically not required so no extension needs to be done :P</p>
<p>The culprit seems to be <code>get_ext_mode</code> in <code>X64ABIMachineSpec</code>:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="k">fn</span> <span class="nf">get_ext_mode</span><span class="p">(</span><span class="w"></span>
<span class="w">    </span><span class="n">_call_conv</span>: <span class="nc">isa</span>::<span class="n">CallConv</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="n">_specified</span>: <span class="nc">ir</span>::<span class="n">ArgumentExtension</span><span class="p">,</span><span class="w"></span>
<span class="p">)</span><span class="w"> </span>-&gt; <span class="nc">ir</span>::<span class="n">ArgumentExtension</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">ir</span>::<span class="n">ArgumentExtension</span>::<span class="nb">None</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>
<p>It always ignores the specified extension. So make it honor the specified extension if the calling conv is SysV? Or only when the LLVM ABI Extensions are used...</p>
</blockquote>



<a name="324156172"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%235645%20Cranelift%3A%20missing%20zero%20extension%20.../near/324156172" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.235645.20Cranelift.3A.20missing.20zero.20extension.20.2E.2E.2E.html#324156172">(Jan 27 2023 at 21:21)</a>:</h4>
<p>bjorn3 <a href="https://github.com/bytecodealliance/wasmtime/issues/5645#issuecomment-1407086829">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/5645">issue #5645</a>:</p>
<blockquote>
<blockquote>
<p>if according to the LLVM bug you linked, zext up to 32 bits is "de-facto the ABI already", then we could implement that, perhaps under a flag.</p>
</blockquote>
<p>As I understand it the de-facto ABI is to zero or sign extend depending on if the type is unsigned or signed. As clif ir doesn't distinguish between the two, explicit zext and sext are the only way to know if it should be zero or sign extended.</p>
</blockquote>



<hr><p>Last updated: Jan 20 2025 at 06:04 UTC</p>
</html>