<html>
<head><meta charset="utf-8"><title>wasmtime / PR #6955 riscv64: Use labels for branches when... · git-wasmtime · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/index.html">git-wasmtime</a></h2>
<h3>Topic: <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.236955.20riscv64.3A.20Use.20labels.20for.20branches.20when.2E.2E.2E.html">wasmtime / PR #6955 riscv64: Use labels for branches when...</a></h3>

<hr>

<base href="https://bytecodealliance.zulipchat.com">

<head><link href="https://bytecodealliance.github.io/zulip-archive/style.css" rel="stylesheet"></head>

<a name="388683445"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%236955%20riscv64%3A%20Use%20labels%20for%20branches%20when.../near/388683445" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.236955.20riscv64.3A.20Use.20labels.20for.20branches.20when.2E.2E.2E.html#388683445">(Sep 02 2023 at 11:39)</a>:</h4>
<p>afonso360 opened <a href="https://github.com/bytecodealliance/wasmtime/pull/6955">PR #6955</a> from <code>afonso360:riscv-use-branch-labels</code> to <code>bytecodealliance:main</code>:</p>
<blockquote>
<p><span aria-label="wave" class="emoji emoji-1f44b" role="img" title="wave">:wave:</span> Hey,</p>
<p>This PR is a preparation for enabling the C (Compressed instructions) extension on the RISC-V backend. This extension means that we can emit a bunch of instructions as compressed instructions (2 bytes instead of 4) and essentially makes this a variable(-ish) length ISA.</p>
<p>The first step is to try to remove as many fixed offset jumps as possible and replace them with label based counterparts that should take into account if an instruction has been emitted as compressed or not.</p>
<p>Additionally and somewhat unrelated this PR also enables by default the minimum set of flags with what we expect in the backend. We currently target RISC-V GC which is the general set of extensions for application processors.</p>
</blockquote>



<a name="388683448"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%236955%20riscv64%3A%20Use%20labels%20for%20branches%20when.../near/388683448" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.236955.20riscv64.3A.20Use.20labels.20for.20branches.20when.2E.2E.2E.html#388683448">(Sep 02 2023 at 11:39)</a>:</h4>
<p><strong>afonso360</strong> requested <a href="https://github.com/orgs/bytecodealliance/teams/wasmtime-compiler-reviewers">wasmtime-compiler-reviewers</a> for a review on <a href="https://github.com/bytecodealliance/wasmtime/pull/6955">PR #6955</a>.</p>



<a name="388683449"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%236955%20riscv64%3A%20Use%20labels%20for%20branches%20when.../near/388683449" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.236955.20riscv64.3A.20Use.20labels.20for.20branches.20when.2E.2E.2E.html#388683449">(Sep 02 2023 at 11:39)</a>:</h4>
<p><strong>afonso360</strong> requested <a href="https://github.com/abrown">abrown</a> for a review on <a href="https://github.com/bytecodealliance/wasmtime/pull/6955">PR #6955</a>.</p>



<a name="388683877"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%236955%20riscv64%3A%20Use%20labels%20for%20branches%20when.../near/388683877" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.236955.20riscv64.3A.20Use.20labels.20for.20branches.20when.2E.2E.2E.html#388683877">(Sep 02 2023 at 11:43)</a>:</h4>
<p>afonso360 edited <a href="https://github.com/bytecodealliance/wasmtime/pull/6955">PR #6955</a>:</p>
<blockquote>
<p><span aria-label="wave" class="emoji emoji-1f44b" role="img" title="wave">:wave:</span> Hey,</p>
<p>This PR is a preparation for enabling the C (Compressed instructions) extension on the RISC-V backend. This extension means that we can emit a bunch of instructions as compressed instructions (2 bytes instead of 4) and essentially makes this a variable(-ish) length ISA.</p>
<p>The first step is to try to remove as many fixed offset jumps as possible and replace them with label based counterparts that should take into account if an instruction has been emitted as compressed or not. </p>
<p>Additionally and somewhat unrelated this PR also enables by default the minimum set of flags with what we expect in the backend. We currently target RISC-V GC which is the general set of extensions for application processors. This is also aligned with the rust toolchain target for Cranelift/Wasmtime which is <code>riscv64gc-...</code>.</p>
</blockquote>



<a name="389259486"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%236955%20riscv64%3A%20Use%20labels%20for%20branches%20when.../near/389259486" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.236955.20riscv64.3A.20Use.20labels.20for.20branches.20when.2E.2E.2E.html#389259486">(Sep 05 2023 at 18:48)</a>:</h4>
<p>alexcrichton submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/6955#pullrequestreview-1611721741">PR review</a>:</p>
<blockquote>
<p>Some minor follow-up questions, but looks good to me <span aria-label="+1" class="emoji emoji-1f44d" role="img" title="+1">:+1:</span> </p>
</blockquote>



<a name="389259489"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%236955%20riscv64%3A%20Use%20labels%20for%20branches%20when.../near/389259489" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.236955.20riscv64.3A.20Use.20labels.20for.20branches.20when.2E.2E.2E.html#389259489">(Sep 05 2023 at 18:48)</a>:</h4>
<p>alexcrichton created <a href="https://github.com/bytecodealliance/wasmtime/pull/6955#discussion_r1316272053">PR review comment</a>:</p>
<blockquote>
<p>As a follow-up, should <code>Inst::INSTRUCTION_SIZE</code> be deleted if the instruction size is going to become variable?</p>
</blockquote>



<a name="389259490"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%236955%20riscv64%3A%20Use%20labels%20for%20branches%20when.../near/389259490" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.236955.20riscv64.3A.20Use.20labels.20for.20branches.20when.2E.2E.2E.html#389259490">(Sep 05 2023 at 18:48)</a>:</h4>
<p>alexcrichton created <a href="https://github.com/bytecodealliance/wasmtime/pull/6955#discussion_r1316270962">PR review comment</a>:</p>
<blockquote>
<p>Question that's somewhat unrelated to this PR but this inspired me to ask. IIRC I don't remember seeing lots of <code>has_f</code> checks, for example, in the <code>lower.isle</code> or <code>inst.isle</code> bits we have for RISC-V. I'm not sure whether that extension is itself relevant here, but this seems like a bug perhaps?</p>
<p>For example if <code>has_f</code> is disabled then I'd expect the backend would either automatically pick other instructions or if it's a require extension then we'd generate an error during construction of the ISA saying "required features are not enabled". Otherwise I think today what might happen is that if <code>has_f</code> is disabled then we'd generate instructions from the <code>f</code> instruction set?</p>
<p>(and again sorry I don't mean to pick on <code>f</code> here, I don't actually know what any of these extensions are, I just picked it randomly and this question applies to all of these enabled-by-default ones here)</p>
</blockquote>



<a name="389259491"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%236955%20riscv64%3A%20Use%20labels%20for%20branches%20when.../near/389259491" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.236955.20riscv64.3A.20Use.20labels.20for.20branches.20when.2E.2E.2E.html#389259491">(Sep 05 2023 at 18:48)</a>:</h4>
<p>alexcrichton submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/6955#pullrequestreview-1611721741">PR review</a>:</p>
<blockquote>
<p>Some minor follow-up questions, but looks good to me <span aria-label="+1" class="emoji emoji-1f44d" role="img" title="+1">:+1:</span> </p>
</blockquote>



<a name="389263653"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%236955%20riscv64%3A%20Use%20labels%20for%20branches%20when.../near/389263653" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.236955.20riscv64.3A.20Use.20labels.20for.20branches.20when.2E.2E.2E.html#389263653">(Sep 05 2023 at 19:15)</a>:</h4>
<p>afonso360 submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/6955#pullrequestreview-1611771180">PR review</a>.</p>



<a name="389263654"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%236955%20riscv64%3A%20Use%20labels%20for%20branches%20when.../near/389263654" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.236955.20riscv64.3A.20Use.20labels.20for.20branches.20when.2E.2E.2E.html#389263654">(Sep 05 2023 at 19:15)</a>:</h4>
<p>afonso360 created <a href="https://github.com/bytecodealliance/wasmtime/pull/6955#discussion_r1316300371">PR review comment</a>:</p>
<blockquote>
<blockquote>
<p>Otherwise I think today what might happen is that if has_f is disabled then we'd generate instructions from the f instruction set?</p>
</blockquote>
<p>Yeah that is exactly what happens. I don't think we ever check these base features in the backend only the non default ones. </p>
<p>Adding those checks when constructing the ISA is a really good idea, I'm going to do that in a follow up PR.</p>
<p>The <code>f</code> extension is support for single precision floating point, the rest of them are equally basic stuff like that (I'm also going to add that to the flag description)</p>
</blockquote>



<a name="389264207"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%236955%20riscv64%3A%20Use%20labels%20for%20branches%20when.../near/389264207" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.236955.20riscv64.3A.20Use.20labels.20for.20branches.20when.2E.2E.2E.html#389264207">(Sep 05 2023 at 19:18)</a>:</h4>
<p>alexcrichton submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/6955#pullrequestreview-1611775269">PR review</a>.</p>



<a name="389264209"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%236955%20riscv64%3A%20Use%20labels%20for%20branches%20when.../near/389264209" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.236955.20riscv64.3A.20Use.20labels.20for.20branches.20when.2E.2E.2E.html#389264209">(Sep 05 2023 at 19:18)</a>:</h4>
<p>alexcrichton created <a href="https://github.com/bytecodealliance/wasmtime/pull/6955#discussion_r1316303043">PR review comment</a>:</p>
<blockquote>
<p>Ok cool makes sense! If it helps this is the example I was thinking of that used to be in the x64 backend:</p>
<p><a href="https://github.com/bytecodealliance/wasmtime/blob/66fd3d72c9d96b06df2dc5d930f12ccaa98f23f6/cranelift/codegen/src/isa/x64/mod.rs#L225-L233">https://github.com/bytecodealliance/wasmtime/blob/66fd3d72c9d96b06df2dc5d930f12ccaa98f23f6/cranelift/codegen/src/isa/x64/mod.rs#L225-L233</a></p>
<p>that's since been removed for other reasons but I imagine there's a similar location to put this for the RISC-V backend.</p>
</blockquote>



<a name="389264234"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%236955%20riscv64%3A%20Use%20labels%20for%20branches%20when.../near/389264234" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.236955.20riscv64.3A.20Use.20labels.20for.20branches.20when.2E.2E.2E.html#389264234">(Sep 05 2023 at 19:18)</a>:</h4>
<p>afonso360 submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/6955#pullrequestreview-1611775526">PR review</a>.</p>



<a name="389264235"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%236955%20riscv64%3A%20Use%20labels%20for%20branches%20when.../near/389264235" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.236955.20riscv64.3A.20Use.20labels.20for.20branches.20when.2E.2E.2E.html#389264235">(Sep 05 2023 at 19:18)</a>:</h4>
<p>afonso360 created <a href="https://github.com/bytecodealliance/wasmtime/pull/6955#discussion_r1316303203">PR review comment</a>:</p>
<blockquote>
<p>I think we should rename it to something like <code>UNCOMPRESSED_INSTRUCTION_SIZE</code>. It's still used in a couple of places for example when checking if we need to emit an island.</p>
<p>It is also used when calculating <code>br_table</code> offsets, which are going to be forced to emit uncompressed instructions.</p>
</blockquote>



<a name="389508357"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%236955%20riscv64%3A%20Use%20labels%20for%20branches%20when.../near/389508357" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.236955.20riscv64.3A.20Use.20labels.20for.20branches.20when.2E.2E.2E.html#389508357">(Sep 06 2023 at 20:03)</a>:</h4>
<p>afonso360 merged <a href="https://github.com/bytecodealliance/wasmtime/pull/6955">PR #6955</a>.</p>



<hr><p>Last updated: Jan 20 2025 at 06:04 UTC</p>
</html>