<html>
<head><meta charset="utf-8"><title>wasmtime / PR #9361 s390x: Hard code the link register in... · git-wasmtime · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/index.html">git-wasmtime</a></h2>
<h3>Topic: <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.239361.20s390x.3A.20Hard.20code.20the.20link.20register.20in.2E.2E.2E.html">wasmtime / PR #9361 s390x: Hard code the link register in...</a></h3>

<hr>

<base href="https://bytecodealliance.zulipchat.com">

<head><link href="https://bytecodealliance.github.io/zulip-archive/style.css" rel="stylesheet"></head>

<a name="474518960"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%239361%20s390x%3A%20Hard%20code%20the%20link%20register%20in.../near/474518960" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.239361.20s390x.3A.20Hard.20code.20the.20link.20register.20in.2E.2E.2E.html#474518960">(Oct 03 2024 at 08:18)</a>:</h4>
<p><strong>bjorn3</strong> requested <a href="https://github.com/cfallin">cfallin</a> for a review on <a href="https://github.com/bytecodealliance/wasmtime/pull/9361">PR #9361</a>.</p>



<a name="474518961"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%239361%20s390x%3A%20Hard%20code%20the%20link%20register%20in.../near/474518961" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.239361.20s390x.3A.20Hard.20code.20the.20link.20register.20in.2E.2E.2E.html#474518961">(Oct 03 2024 at 08:18)</a>:</h4>
<p>bjorn3 opened <a href="https://github.com/bytecodealliance/wasmtime/pull/9361">PR #9361</a> from <code>bjorn3:abi_cleanup9</code> to <code>bytecodealliance:main</code>:</p>
<blockquote>
<p>This matches the riscv64 arch which also has the link register defined only by the abi and not by the isa itself. Also remove a couple of dead_code allows.</p>
</blockquote>



<a name="474518962"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%239361%20s390x%3A%20Hard%20code%20the%20link%20register%20in.../near/474518962" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.239361.20s390x.3A.20Hard.20code.20the.20link.20register.20in.2E.2E.2E.html#474518962">(Oct 03 2024 at 08:18)</a>:</h4>
<p><strong>bjorn3</strong> requested <a href="https://github.com/orgs/bytecodealliance/teams/wasmtime-compiler-reviewers">wasmtime-compiler-reviewers</a> for a review on <a href="https://github.com/bytecodealliance/wasmtime/pull/9361">PR #9361</a>.</p>



<a name="474699760"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%239361%20s390x%3A%20Hard%20code%20the%20link%20register%20in.../near/474699760" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.239361.20s390x.3A.20Hard.20code.20the.20link.20register.20in.2E.2E.2E.html#474699760">(Oct 03 2024 at 23:57)</a>:</h4>
<p>cfallin <a href="https://github.com/bytecodealliance/wasmtime/pull/9361#issuecomment-2392528940">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/9361">PR #9361</a>:</p>
<blockquote>
<p>cc @uweigand -- this looks reasonable to me overall, and there's no functional change to the emitted code or the regalloc metadata (fields were only ever used with one value) -- but maybe there's a reason it was generic?</p>
</blockquote>



<a name="474897484"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%239361%20s390x%3A%20Hard%20code%20the%20link%20register%20in.../near/474897484" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.239361.20s390x.3A.20Hard.20code.20the.20link.20register.20in.2E.2E.2E.html#474897484">(Oct 04 2024 at 20:35)</a>:</h4>
<p>uweigand <a href="https://github.com/bytecodealliance/wasmtime/pull/9361#issuecomment-2394529471">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/9361">PR #9361</a>:</p>
<blockquote>
<p>Well, as long as the ELF ABI is the only s390x ABI supported by wasmtime, I guess it doesn't make any difference, really.</p>
<p>That said, this seems a step in the wrong direction to me: there <em>are</em> other ABIs used by other OSes on the platforms, and they do use different registers than r14 as the link register, so I'm not sure why it's an improvement to hard-code that value?  Logically, it is an ABI property, that's why I placed that choice in ABI code rather than ISA code.<br>
</p>
</blockquote>



<a name="474900711"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%239361%20s390x%3A%20Hard%20code%20the%20link%20register%20in.../near/474900711" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.239361.20s390x.3A.20Hard.20code.20the.20link.20register.20in.2E.2E.2E.html#474900711">(Oct 04 2024 at 21:05)</a>:</h4>
<p>bjorn3 <a href="https://github.com/bytecodealliance/wasmtime/pull/9361#issuecomment-2394607913">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/9361">PR #9361</a>:</p>
<blockquote>
<p>The ret instruction is also hard coding r15 (stack pointer?) and it has a debug assert that r14 is used as link register. What other OSes use a different link register?</p>
</blockquote>



<a name="474906840"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%239361%20s390x%3A%20Hard%20code%20the%20link%20register%20in.../near/474906840" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.239361.20s390x.3A.20Hard.20code.20the.20link.20register.20in.2E.2E.2E.html#474906840">(Oct 04 2024 at 22:06)</a>:</h4>
<p>uweigand <a href="https://github.com/bytecodealliance/wasmtime/pull/9361#issuecomment-2394729806">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/9361">PR #9361</a>:</p>
<blockquote>
<blockquote>
<p>The ret instruction is also hard coding r15 (stack pointer?) </p>
</blockquote>
<p>Ah, not really.  This instruction uses a condition mask field as "R1", not an actual register field, and the contents are 15 (all mask bits set) to indicate a "branch on any condition", i.e. an unconditional branch.  It would have been clearer to add a variant of the <code>enc_rr</code> helper instead of passing the condition mask as a "register".</p>
<blockquote>
<p>and it has a debug assert that r14 is used as link register.</p>
</blockquote>
<p>Huh, I'm surprised to see that.  Looks like @elliottt added a bunch of asserts here: <a href="https://github.com/bytecodealliance/wasmtime/pull/5172">https://github.com/bytecodealliance/wasmtime/pull/5172</a> - I'm not sure if there's anything in that diff that makes those asserts necessary?</p>
<blockquote>
<p>What other OSes use a different link register?</p>
</blockquote>
<p>Well, XPLINK (the current main calling convention on z/OS) uses %r4, as one major example.</p>
<p>In general, I'm pretty sure in case we ever wanted to support a significantly different calling convention like XPLINK that uses different registers for the link register, the stack register, and pretty much any ABI-defined register, we will find places where the current code isn't fully generalized.  I tried to keep things general where it seemed easily possible, but didn't attempt any full review ...   I just don't see why it's beneficial now to make the code <em>less</em> general.<br>
</p>
</blockquote>



<a name="474909347"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%239361%20s390x%3A%20Hard%20code%20the%20link%20register%20in.../near/474909347" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.239361.20s390x.3A.20Hard.20code.20the.20link.20register.20in.2E.2E.2E.html#474909347">(Oct 04 2024 at 22:32)</a>:</h4>
<p>elliottt <a href="https://github.com/bytecodealliance/wasmtime/pull/9361#issuecomment-2394750631">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/9361">PR #9361</a>:</p>
<blockquote>
<blockquote>
<p>Huh, I'm surprised to see that. Looks like @elliottt added a bunch of asserts here: #5172 - I'm not sure if there's anything in that diff that makes those asserts necessary?</p>
</blockquote>
<p>I think you're right, we should probably remove them. They're added in other cases to check that fixed constraints are respected, but as there's no fixed constraints in the constraint generation code in <a href="http://mod.rs">mod.rs</a>, I don't think that assertion applies.</p>
</blockquote>



<a name="475609924"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%239361%20s390x%3A%20Hard%20code%20the%20link%20register%20in.../near/475609924" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.239361.20s390x.3A.20Hard.20code.20the.20link.20register.20in.2E.2E.2E.html#475609924">(Oct 08 2024 at 16:22)</a>:</h4>
<p>uweigand <a href="https://github.com/bytecodealliance/wasmtime/pull/9361#issuecomment-2400318173">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/9361">PR #9361</a>:</p>
<blockquote>
<blockquote>
<blockquote>
<p>Huh, I'm surprised to see that. Looks like @elliottt added a bunch of asserts here: #5172 - I'm not sure if there's anything in that diff that makes those asserts necessary?</p>
</blockquote>
<p>I think you're right, we should probably remove them. They're added in other cases to check that fixed constraints are respected, but as there's no fixed constraints in the constraint generation code in <a href="http://mod.rs">mod.rs</a>, I don't think that assertion applies.</p>
</blockquote>
<p>Thanks.  I've now submitted a PR: <a href="https://github.com/bytecodealliance/wasmtime/pull/9397">https://github.com/bytecodealliance/wasmtime/pull/9397</a></p>
</blockquote>



<a name="477420616"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%239361%20s390x%3A%20Hard%20code%20the%20link%20register%20in.../near/477420616" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.239361.20s390x.3A.20Hard.20code.20the.20link.20register.20in.2E.2E.2E.html#477420616">(Oct 17 2024 at 11:35)</a>:</h4>
<p>bjorn3 updated <a href="https://github.com/bytecodealliance/wasmtime/pull/9361">PR #9361</a>.</p>



<a name="477420672"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%239361%20s390x%3A%20Hard%20code%20the%20link%20register%20in.../near/477420672" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.239361.20s390x.3A.20Hard.20code.20the.20link.20register.20in.2E.2E.2E.html#477420672">(Oct 17 2024 at 11:35)</a>:</h4>
<p>bjorn3 edited <a href="https://github.com/bytecodealliance/wasmtime/pull/9361">PR #9361</a>:</p>
<blockquote>
<p>The ElfTlsGetOffset pseudo-instruction already hard codes the rest of the abi anyway and if another abi is ever needed, adding another pseudo-instruction or an enum field to the existing one would likely be necessary anyway. Also remove a couple of dead_code allows.</p>
</blockquote>



<hr><p>Last updated: Jan 20 2025 at 06:04 UTC</p>
</html>