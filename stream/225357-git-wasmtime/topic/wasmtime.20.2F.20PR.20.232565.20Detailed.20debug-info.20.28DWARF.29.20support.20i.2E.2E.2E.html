<html>
<head><meta charset="utf-8"><title>wasmtime / PR #2565 Detailed debug-info (DWARF) support i... · git-wasmtime · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/index.html">git-wasmtime</a></h2>
<h3>Topic: <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232565.20Detailed.20debug-info.20.28DWARF.29.20support.20i.2E.2E.2E.html">wasmtime / PR #2565 Detailed debug-info (DWARF) support i...</a></h3>

<hr>

<base href="https://bytecodealliance.zulipchat.com">

<head><link href="https://bytecodealliance.github.io/zulip-archive/style.css" rel="stylesheet"></head>

<a name="222189821"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232565%20Detailed%20debug-info%20%28DWARF%29%20support%20i.../near/222189821" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232565.20Detailed.20debug-info.20.28DWARF.29.20support.20i.2E.2E.2E.html#222189821">(Jan 09 2021 at 21:05)</a>:</h4>
<p>cfallin edited <a href="https://github.com/bytecodealliance/wasmtime/pull/2565">PR #2565</a> from <code>debug-value-labels</code> to <code>main</code>:</p>
<blockquote>
<p>This PR propagates "value labels" all the way from CLIF to DWARF<br>
metadata on the emitted machine code. The key idea is as follows:</p>
<ul>
<li>
<p>Translate value-label metadata on the input into "value_label"<br>
  pseudo-instructions when lowering into VCode. These<br>
  pseudo-instructions take a register as input, denote a value label,<br>
  and semantically are like a "move into value label" -- i.e., they<br>
  update the current value (as seen by debugging tools) of the given<br>
  local. These pseudo-instructions emit no machine code.</p>
</li>
<li>
<p>Perform a dataflow analysis <em>at the machine-code level</em>, tracking<br>
  value-labels that propagate into registers and into [SP+constant]<br>
  stack storage. This is a forward dataflow fixpoint analysis where each<br>
  storage location can contain a <em>set</em> of value labels, and each value<br>
  label can reside in a <em>set</em> of storage locations. (Meet function is<br>
  pairwise intersection by storage location.)</p>
<p>This analysis traces value labels symbolically through loads and<br>
stores and reg-to-reg moves, so it will naturally handle spills and<br>
reloads without knowing anything special about them.</p>
</li>
<li>
<p>When this analysis converges, we have, at each machine-code offset, a<br>
  mapping from value labels to some number of storage locations; for<br>
  each offset for each label, we choose the best location (prefer<br>
  registers). Note that we can choose any location, as the symbolic<br>
  dataflow analysis is sound and guarantees that the value at the<br>
  value_label instruction propagates to all of the named locations.</p>
</li>
<li>
<p>Then we can convert this mapping into a format that the DWARF<br>
  generation code (wasmtime's debug crate) can use.</p>
</li>
</ul>
<p>This PR also adds the new-backend variant to the gdb tests on CI.</p>
</blockquote>



<a name="222191206"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232565%20Detailed%20debug-info%20%28DWARF%29%20support%20i.../near/222191206" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232565.20Detailed.20debug-info.20.28DWARF.29.20support.20i.2E.2E.2E.html#222191206">(Jan 09 2021 at 21:44)</a>:</h4>
<p>cfallin updated <a href="https://github.com/bytecodealliance/wasmtime/pull/2565">PR #2565</a> from <code>debug-value-labels</code> to <code>main</code>:</p>
<blockquote>
<p>This PR propagates "value labels" all the way from CLIF to DWARF<br>
metadata on the emitted machine code. The key idea is as follows:</p>
<ul>
<li>
<p>Translate value-label metadata on the input into "value_label"<br>
  pseudo-instructions when lowering into VCode. These<br>
  pseudo-instructions take a register as input, denote a value label,<br>
  and semantically are like a "move into value label" -- i.e., they<br>
  update the current value (as seen by debugging tools) of the given<br>
  local. These pseudo-instructions emit no machine code.</p>
</li>
<li>
<p>Perform a dataflow analysis <em>at the machine-code level</em>, tracking<br>
  value-labels that propagate into registers and into [SP+constant]<br>
  stack storage. This is a forward dataflow fixpoint analysis where each<br>
  storage location can contain a <em>set</em> of value labels, and each value<br>
  label can reside in a <em>set</em> of storage locations. (Meet function is<br>
  pairwise intersection by storage location.)</p>
<p>This analysis traces value labels symbolically through loads and<br>
stores and reg-to-reg moves, so it will naturally handle spills and<br>
reloads without knowing anything special about them.</p>
</li>
<li>
<p>When this analysis converges, we have, at each machine-code offset, a<br>
  mapping from value labels to some number of storage locations; for<br>
  each offset for each label, we choose the best location (prefer<br>
  registers). Note that we can choose any location, as the symbolic<br>
  dataflow analysis is sound and guarantees that the value at the<br>
  value_label instruction propagates to all of the named locations.</p>
</li>
<li>
<p>Then we can convert this mapping into a format that the DWARF<br>
  generation code (wasmtime's debug crate) can use.</p>
</li>
</ul>
<p>This PR also adds the new-backend variant to the gdb tests on CI.</p>
</blockquote>



<a name="222203057"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232565%20Detailed%20debug-info%20%28DWARF%29%20support%20i.../near/222203057" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232565.20Detailed.20debug-info.20.28DWARF.29.20support.20i.2E.2E.2E.html#222203057">(Jan 10 2021 at 03:21)</a>:</h4>
<p>cfallin updated <a href="https://github.com/bytecodealliance/wasmtime/pull/2565">PR #2565</a> from <code>debug-value-labels</code> to <code>main</code>:</p>
<blockquote>
<p>This PR propagates "value labels" all the way from CLIF to DWARF<br>
metadata on the emitted machine code. The key idea is as follows:</p>
<ul>
<li>
<p>Translate value-label metadata on the input into "value_label"<br>
  pseudo-instructions when lowering into VCode. These<br>
  pseudo-instructions take a register as input, denote a value label,<br>
  and semantically are like a "move into value label" -- i.e., they<br>
  update the current value (as seen by debugging tools) of the given<br>
  local. These pseudo-instructions emit no machine code.</p>
</li>
<li>
<p>Perform a dataflow analysis <em>at the machine-code level</em>, tracking<br>
  value-labels that propagate into registers and into [SP+constant]<br>
  stack storage. This is a forward dataflow fixpoint analysis where each<br>
  storage location can contain a <em>set</em> of value labels, and each value<br>
  label can reside in a <em>set</em> of storage locations. (Meet function is<br>
  pairwise intersection by storage location.)</p>
<p>This analysis traces value labels symbolically through loads and<br>
stores and reg-to-reg moves, so it will naturally handle spills and<br>
reloads without knowing anything special about them.</p>
</li>
<li>
<p>When this analysis converges, we have, at each machine-code offset, a<br>
  mapping from value labels to some number of storage locations; for<br>
  each offset for each label, we choose the best location (prefer<br>
  registers). Note that we can choose any location, as the symbolic<br>
  dataflow analysis is sound and guarantees that the value at the<br>
  value_label instruction propagates to all of the named locations.</p>
</li>
<li>
<p>Then we can convert this mapping into a format that the DWARF<br>
  generation code (wasmtime's debug crate) can use.</p>
</li>
</ul>
<p>This PR also adds the new-backend variant to the gdb tests on CI.</p>
</blockquote>



<a name="223577556"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232565%20Detailed%20debug-info%20%28DWARF%29%20support%20i.../near/223577556" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232565.20Detailed.20debug-info.20.28DWARF.29.20support.20i.2E.2E.2E.html#223577556">(Jan 21 2021 at 22:06)</a>:</h4>
<p><strong>cfallin</strong> requested <a href="https://github.com/fitzgen">fitzgen</a>, <a href="https://github.com/bnjbvr">bnjbvr</a> and <a href="https://github.com/yurydelendik">yurydelendik</a> for a review on <a href="https://github.com/bytecodealliance/wasmtime/pull/2565">PR #2565</a>.</p>



<a name="223577557"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232565%20Detailed%20debug-info%20%28DWARF%29%20support%20i.../near/223577557" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232565.20Detailed.20debug-info.20.28DWARF.29.20support.20i.2E.2E.2E.html#223577557">(Jan 21 2021 at 22:06)</a>:</h4>
<p><strong>cfallin</strong> requested <a href="https://github.com/fitzgen">fitzgen</a>, <a href="https://github.com/bnjbvr">bnjbvr</a> and <a href="https://github.com/yurydelendik">yurydelendik</a> for a review on <a href="https://github.com/bytecodealliance/wasmtime/pull/2565">PR #2565</a>.</p>



<a name="223588188"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232565%20Detailed%20debug-info%20%28DWARF%29%20support%20i.../near/223588188" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232565.20Detailed.20debug-info.20.28DWARF.29.20support.20i.2E.2E.2E.html#223588188">(Jan 22 2021 at 00:01)</a>:</h4>
<p>cfallin updated <a href="https://github.com/bytecodealliance/wasmtime/pull/2565">PR #2565</a> from <code>debug-value-labels</code> to <code>main</code>:</p>
<blockquote>
<p>This PR propagates "value labels" all the way from CLIF to DWARF<br>
metadata on the emitted machine code. The key idea is as follows:</p>
<ul>
<li>
<p>Translate value-label metadata on the input into "value_label"<br>
  pseudo-instructions when lowering into VCode. These<br>
  pseudo-instructions take a register as input, denote a value label,<br>
  and semantically are like a "move into value label" -- i.e., they<br>
  update the current value (as seen by debugging tools) of the given<br>
  local. These pseudo-instructions emit no machine code.</p>
</li>
<li>
<p>Perform a dataflow analysis <em>at the machine-code level</em>, tracking<br>
  value-labels that propagate into registers and into [SP+constant]<br>
  stack storage. This is a forward dataflow fixpoint analysis where each<br>
  storage location can contain a <em>set</em> of value labels, and each value<br>
  label can reside in a <em>set</em> of storage locations. (Meet function is<br>
  pairwise intersection by storage location.)</p>
<p>This analysis traces value labels symbolically through loads and<br>
stores and reg-to-reg moves, so it will naturally handle spills and<br>
reloads without knowing anything special about them.</p>
</li>
<li>
<p>When this analysis converges, we have, at each machine-code offset, a<br>
  mapping from value labels to some number of storage locations; for<br>
  each offset for each label, we choose the best location (prefer<br>
  registers). Note that we can choose any location, as the symbolic<br>
  dataflow analysis is sound and guarantees that the value at the<br>
  value_label instruction propagates to all of the named locations.</p>
</li>
<li>
<p>Then we can convert this mapping into a format that the DWARF<br>
  generation code (wasmtime's debug crate) can use.</p>
</li>
</ul>
<p>This PR also adds the new-backend variant to the gdb tests on CI.</p>
</blockquote>



<a name="223646142"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232565%20Detailed%20debug-info%20%28DWARF%29%20support%20i.../near/223646142" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232565.20Detailed.20debug-info.20.28DWARF.29.20support.20i.2E.2E.2E.html#223646142">(Jan 22 2021 at 14:15)</a>:</h4>
<p>yurydelendik submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/2565#pullrequestreview-574296276">PR Review</a>.</p>



<a name="223646144"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232565%20Detailed%20debug-info%20%28DWARF%29%20support%20i.../near/223646144" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232565.20Detailed.20debug-info.20.28DWARF.29.20support.20i.2E.2E.2E.html#223646144">(Jan 22 2021 at 14:15)</a>:</h4>
<p>yurydelendik created <a href="https://github.com/bytecodealliance/wasmtime/pull/2565#discussion_r562659084">PR Review Comment</a>:</p>
<blockquote>
<p><code>ExpressionWriter</code> has <code>write_op_breg</code></p>
</blockquote>



<a name="223713126"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232565%20Detailed%20debug-info%20%28DWARF%29%20support%20i.../near/223713126" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232565.20Detailed.20debug-info.20.28DWARF.29.20support.20i.2E.2E.2E.html#223713126">(Jan 22 2021 at 23:00)</a>:</h4>
<p>fitzgen submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/2565#pullrequestreview-574664264">PR Review</a>.</p>



<a name="223713127"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232565%20Detailed%20debug-info%20%28DWARF%29%20support%20i.../near/223713127" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232565.20Detailed.20debug-info.20.28DWARF.29.20support.20i.2E.2E.2E.html#223713127">(Jan 22 2021 at 23:00)</a>:</h4>
<p>fitzgen created <a href="https://github.com/bytecodealliance/wasmtime/pull/2565#discussion_r562946523">PR Review Comment</a>:</p>
<blockquote>
<p>All of these methods could use a little, single-sentence doc comment describing what they're doing.</p>
</blockquote>



<a name="223713128"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232565%20Detailed%20debug-info%20%28DWARF%29%20support%20i.../near/223713128" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232565.20Detailed.20debug-info.20.28DWARF.29.20support.20i.2E.2E.2E.html#223713128">(Jan 22 2021 at 23:00)</a>:</h4>
<p>fitzgen submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/2565#pullrequestreview-574664264">PR Review</a>.</p>



<a name="223713129"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232565%20Detailed%20debug-info%20%28DWARF%29%20support%20i.../near/223713129" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232565.20Detailed.20debug-info.20.28DWARF.29.20support.20i.2E.2E.2E.html#223713129">(Jan 22 2021 at 23:00)</a>:</h4>
<p>fitzgen created <a href="https://github.com/bytecodealliance/wasmtime/pull/2565#discussion_r562954209">PR Review Comment</a>:</p>
<blockquote>
<p>Is the worklist processing order important here (eg avoiding big O blow up)? If not, I suspect that <code>Vec</code> and <code>pop</code> would be faster than <code>VecDeque</code> and <code>pop_front</code>.</p>
</blockquote>



<a name="223713130"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232565%20Detailed%20debug-info%20%28DWARF%29%20support%20i.../near/223713130" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232565.20Detailed.20debug-info.20.28DWARF.29.20support.20i.2E.2E.2E.html#223713130">(Jan 22 2021 at 23:00)</a>:</h4>
<p>fitzgen created <a href="https://github.com/bytecodealliance/wasmtime/pull/2565#discussion_r562948083">PR Review Comment</a>:</p>
<blockquote>
<p>What is <code>remove</code> here? Can you add comments for this struct and its members?</p>
</blockquote>



<a name="223713131"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232565%20Detailed%20debug-info%20%28DWARF%29%20support%20i.../near/223713131" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232565.20Detailed.20debug-info.20.28DWARF.29.20support.20i.2E.2E.2E.html#223713131">(Jan 22 2021 at 23:00)</a>:</h4>
<p>fitzgen created <a href="https://github.com/bytecodealliance/wasmtime/pull/2565#discussion_r562957252">PR Review Comment</a>:</p>
<blockquote>
<p>Ah is this when a collection becomes empty and can be removed from its parent collection? Maybe <code>is_empty</code> is a better name, or maybe just having a comment that explains would be enough.</p>
</blockquote>



<a name="223713132"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232565%20Detailed%20debug-info%20%28DWARF%29%20support%20i.../near/223713132" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232565.20Detailed.20debug-info.20.28DWARF.29.20support.20i.2E.2E.2E.html#223713132">(Jan 22 2021 at 23:00)</a>:</h4>
<p>fitzgen created <a href="https://github.com/bytecodealliance/wasmtime/pull/2565#discussion_r562956147">PR Review Comment</a>:</p>
<blockquote>
<p>This will always search for <code>stack</code> even if <code>reg.is_some()</code>. This can be remedied by using <code>.or_else(inline_the_def_of_stack_here)</code>.</p>
</blockquote>



<a name="223713133"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232565%20Detailed%20debug-info%20%28DWARF%29%20support%20i.../near/223713133" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232565.20Detailed.20debug-info.20.28DWARF.29.20support.20i.2E.2E.2E.html#223713133">(Jan 22 2021 at 23:00)</a>:</h4>
<p>fitzgen created <a href="https://github.com/bytecodealliance/wasmtime/pull/2565#discussion_r562958244">PR Review Comment</a>:</p>
<blockquote>
<p>This could be a little tighter as</p>
<p><div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="k">if</span><span class="w"> </span><span class="n">list</span><span class="p">.</span><span class="n">last</span><span class="p">().</span><span class="n">map_or</span><span class="p">(</span><span class="kc">true</span><span class="p">,</span><span class="w"> </span><span class="o">|</span><span class="n">last</span><span class="o">|</span><span class="w"> </span><span class="n">last</span><span class="p">.</span><span class="n">end</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="n">offset</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="n">last</span><span class="p">.</span><span class="n">loc</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">loc</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="o">..</span><span class="p">.</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div><br>
</p>
</blockquote>



<a name="223713134"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232565%20Detailed%20debug-info%20%28DWARF%29%20support%20i.../near/223713134" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232565.20Detailed.20debug-info.20.28DWARF.29.20support.20i.2E.2E.2E.html#223713134">(Jan 22 2021 at 23:00)</a>:</h4>
<p>fitzgen created <a href="https://github.com/bytecodealliance/wasmtime/pull/2565#discussion_r562952511">PR Review Comment</a>:</p>
<blockquote>
<p>What is this? I have no idea what <code>iix</code> means here.</p>
</blockquote>



<a name="223713135"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232565%20Detailed%20debug-info%20%28DWARF%29%20support%20i.../near/223713135" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232565.20Detailed.20debug-info.20.28DWARF.29.20support.20i.2E.2E.2E.html#223713135">(Jan 22 2021 at 23:00)</a>:</h4>
<p>fitzgen created <a href="https://github.com/bytecodealliance/wasmtime/pull/2565#discussion_r562948347">PR Review Comment</a>:</p>
<blockquote>
<p><code>remove_keys.clear()</code> to reuse the previous allocation</p>
</blockquote>



<a name="223718271"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232565%20Detailed%20debug-info%20%28DWARF%29%20support%20i.../near/223718271" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232565.20Detailed.20debug-info.20.28DWARF.29.20support.20i.2E.2E.2E.html#223718271">(Jan 23 2021 at 00:02)</a>:</h4>
<p>cfallin updated <a href="https://github.com/bytecodealliance/wasmtime/pull/2565">PR #2565</a> from <code>debug-value-labels</code> to <code>main</code>:</p>
<blockquote>
<p>This PR propagates "value labels" all the way from CLIF to DWARF<br>
metadata on the emitted machine code. The key idea is as follows:</p>
<ul>
<li>
<p>Translate value-label metadata on the input into "value_label"<br>
  pseudo-instructions when lowering into VCode. These<br>
  pseudo-instructions take a register as input, denote a value label,<br>
  and semantically are like a "move into value label" -- i.e., they<br>
  update the current value (as seen by debugging tools) of the given<br>
  local. These pseudo-instructions emit no machine code.</p>
</li>
<li>
<p>Perform a dataflow analysis <em>at the machine-code level</em>, tracking<br>
  value-labels that propagate into registers and into [SP+constant]<br>
  stack storage. This is a forward dataflow fixpoint analysis where each<br>
  storage location can contain a <em>set</em> of value labels, and each value<br>
  label can reside in a <em>set</em> of storage locations. (Meet function is<br>
  pairwise intersection by storage location.)</p>
<p>This analysis traces value labels symbolically through loads and<br>
stores and reg-to-reg moves, so it will naturally handle spills and<br>
reloads without knowing anything special about them.</p>
</li>
<li>
<p>When this analysis converges, we have, at each machine-code offset, a<br>
  mapping from value labels to some number of storage locations; for<br>
  each offset for each label, we choose the best location (prefer<br>
  registers). Note that we can choose any location, as the symbolic<br>
  dataflow analysis is sound and guarantees that the value at the<br>
  value_label instruction propagates to all of the named locations.</p>
</li>
<li>
<p>Then we can convert this mapping into a format that the DWARF<br>
  generation code (wasmtime's debug crate) can use.</p>
</li>
</ul>
<p>This PR also adds the new-backend variant to the gdb tests on CI.</p>
</blockquote>



<a name="223718333"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232565%20Detailed%20debug-info%20%28DWARF%29%20support%20i.../near/223718333" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232565.20Detailed.20debug-info.20.28DWARF.29.20support.20i.2E.2E.2E.html#223718333">(Jan 23 2021 at 00:03)</a>:</h4>
<p>cfallin submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/2565#pullrequestreview-574702694">PR Review</a>.</p>



<a name="223718335"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232565%20Detailed%20debug-info%20%28DWARF%29%20support%20i.../near/223718335" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232565.20Detailed.20debug-info.20.28DWARF.29.20support.20i.2E.2E.2E.html#223718335">(Jan 23 2021 at 00:03)</a>:</h4>
<p>cfallin created <a href="https://github.com/bytecodealliance/wasmtime/pull/2565#discussion_r562979154">PR Review Comment</a>:</p>
<blockquote>
<p>The <code>map_or(true, ...)</code> form is a little hard to read for me, so I did <code>list.last().map(...).unwrap_or(true)</code> to be a little more explicit, and added a comment too. Happy to make things more concise, just want to avoid Haskell-like terseness that takes too much brain (for me, anyway) to decode :-)</p>
</blockquote>



<a name="223718338"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232565%20Detailed%20debug-info%20%28DWARF%29%20support%20i.../near/223718338" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232565.20Detailed.20debug-info.20.28DWARF.29.20support.20i.2E.2E.2E.html#223718338">(Jan 23 2021 at 00:03)</a>:</h4>
<p>cfallin submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/2565#pullrequestreview-574702698">PR Review</a>.</p>



<a name="223718339"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232565%20Detailed%20debug-info%20%28DWARF%29%20support%20i.../near/223718339" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232565.20Detailed.20debug-info.20.28DWARF.29.20support.20i.2E.2E.2E.html#223718339">(Jan 23 2021 at 00:03)</a>:</h4>
<p>cfallin created <a href="https://github.com/bytecodealliance/wasmtime/pull/2565#discussion_r562979158">PR Review Comment</a>:</p>
<blockquote>
<p>Nice improvement, thanks!</p>
</blockquote>



<a name="223718349"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232565%20Detailed%20debug-info%20%28DWARF%29%20support%20i.../near/223718349" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232565.20Detailed.20debug-info.20.28DWARF.29.20support.20i.2E.2E.2E.html#223718349">(Jan 23 2021 at 00:03)</a>:</h4>
<p>cfallin submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/2565#pullrequestreview-574702709">PR Review</a>.</p>



<a name="223718350"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232565%20Detailed%20debug-info%20%28DWARF%29%20support%20i.../near/223718350" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232565.20Detailed.20debug-info.20.28DWARF.29.20support.20i.2E.2E.2E.html#223718350">(Jan 23 2021 at 00:03)</a>:</h4>
<p>cfallin created <a href="https://github.com/bytecodealliance/wasmtime/pull/2565#discussion_r562979167">PR Review Comment</a>:</p>
<blockquote>
<p>Done; no, it shouldn't be important.</p>
</blockquote>



<a name="223718407"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232565%20Detailed%20debug-info%20%28DWARF%29%20support%20i.../near/223718407" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232565.20Detailed.20debug-info.20.28DWARF.29.20support.20i.2E.2E.2E.html#223718407">(Jan 23 2021 at 00:04)</a>:</h4>
<p>cfallin submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/2565#pullrequestreview-574702863">PR Review</a>.</p>



<a name="223718408"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232565%20Detailed%20debug-info%20%28DWARF%29%20support%20i.../near/223718408" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232565.20Detailed.20debug-info.20.28DWARF.29.20support.20i.2E.2E.2E.html#223718408">(Jan 23 2021 at 00:04)</a>:</h4>
<p>cfallin created <a href="https://github.com/bytecodealliance/wasmtime/pull/2565#discussion_r562979274">PR Review Comment</a>:</p>
<blockquote>
<p>Changed to <code>index</code>; it's a regalloc.rs-ism but I should really just write it out.</p>
</blockquote>



<a name="223718410"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232565%20Detailed%20debug-info%20%28DWARF%29%20support%20i.../near/223718410" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232565.20Detailed.20debug-info.20.28DWARF.29.20support.20i.2E.2E.2E.html#223718410">(Jan 23 2021 at 00:04)</a>:</h4>
<p>cfallin submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/2565#pullrequestreview-574702872">PR Review</a>.</p>



<a name="223718411"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232565%20Detailed%20debug-info%20%28DWARF%29%20support%20i.../near/223718411" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232565.20Detailed.20debug-info.20.28DWARF.29.20support.20i.2E.2E.2E.html#223718411">(Jan 23 2021 at 00:04)</a>:</h4>
<p>cfallin created <a href="https://github.com/bytecodealliance/wasmtime/pull/2565#discussion_r562979293">PR Review Comment</a>:</p>
<blockquote>
<p>Done, thanks!</p>
</blockquote>



<a name="223718413"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232565%20Detailed%20debug-info%20%28DWARF%29%20support%20i.../near/223718413" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232565.20Detailed.20debug-info.20.28DWARF.29.20support.20i.2E.2E.2E.html#223718413">(Jan 23 2021 at 00:04)</a>:</h4>
<p>cfallin submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/2565#pullrequestreview-574702887">PR Review</a>.</p>



<a name="223718414"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232565%20Detailed%20debug-info%20%28DWARF%29%20support%20i.../near/223718414" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232565.20Detailed.20debug-info.20.28DWARF.29.20support.20i.2E.2E.2E.html#223718414">(Jan 23 2021 at 00:04)</a>:</h4>
<p>cfallin created <a href="https://github.com/bytecodealliance/wasmtime/pull/2565#discussion_r562979299">PR Review Comment</a>:</p>
<blockquote>
<p>Added comment and renamed; agreed, that's more clear.</p>
</blockquote>



<a name="223718416"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232565%20Detailed%20debug-info%20%28DWARF%29%20support%20i.../near/223718416" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232565.20Detailed.20debug-info.20.28DWARF.29.20support.20i.2E.2E.2E.html#223718416">(Jan 23 2021 at 00:04)</a>:</h4>
<p>cfallin submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/2565#pullrequestreview-574702903">PR Review</a>.</p>



<a name="223718417"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232565%20Detailed%20debug-info%20%28DWARF%29%20support%20i.../near/223718417" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232565.20Detailed.20debug-info.20.28DWARF.29.20support.20i.2E.2E.2E.html#223718417">(Jan 23 2021 at 00:04)</a>:</h4>
<p>cfallin created <a href="https://github.com/bytecodealliance/wasmtime/pull/2565#discussion_r562979312">PR Review Comment</a>:</p>
<blockquote>
<p>Done; sorry about the terseness!</p>
</blockquote>



<a name="223721331"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232565%20Detailed%20debug-info%20%28DWARF%29%20support%20i.../near/223721331" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232565.20Detailed.20debug-info.20.28DWARF.29.20support.20i.2E.2E.2E.html#223721331">(Jan 23 2021 at 00:45)</a>:</h4>
<p>cfallin updated <a href="https://github.com/bytecodealliance/wasmtime/pull/2565">PR #2565</a> from <code>debug-value-labels</code> to <code>main</code>:</p>
<blockquote>
<p>This PR propagates "value labels" all the way from CLIF to DWARF<br>
metadata on the emitted machine code. The key idea is as follows:</p>
<ul>
<li>
<p>Translate value-label metadata on the input into "value_label"<br>
  pseudo-instructions when lowering into VCode. These<br>
  pseudo-instructions take a register as input, denote a value label,<br>
  and semantically are like a "move into value label" -- i.e., they<br>
  update the current value (as seen by debugging tools) of the given<br>
  local. These pseudo-instructions emit no machine code.</p>
</li>
<li>
<p>Perform a dataflow analysis <em>at the machine-code level</em>, tracking<br>
  value-labels that propagate into registers and into [SP+constant]<br>
  stack storage. This is a forward dataflow fixpoint analysis where each<br>
  storage location can contain a <em>set</em> of value labels, and each value<br>
  label can reside in a <em>set</em> of storage locations. (Meet function is<br>
  pairwise intersection by storage location.)</p>
<p>This analysis traces value labels symbolically through loads and<br>
stores and reg-to-reg moves, so it will naturally handle spills and<br>
reloads without knowing anything special about them.</p>
</li>
<li>
<p>When this analysis converges, we have, at each machine-code offset, a<br>
  mapping from value labels to some number of storage locations; for<br>
  each offset for each label, we choose the best location (prefer<br>
  registers). Note that we can choose any location, as the symbolic<br>
  dataflow analysis is sound and guarantees that the value at the<br>
  value_label instruction propagates to all of the named locations.</p>
</li>
<li>
<p>Then we can convert this mapping into a format that the DWARF<br>
  generation code (wasmtime's debug crate) can use.</p>
</li>
</ul>
<p>This PR also adds the new-backend variant to the gdb tests on CI.</p>
</blockquote>



<a name="223722008"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232565%20Detailed%20debug-info%20%28DWARF%29%20support%20i.../near/223722008" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232565.20Detailed.20debug-info.20.28DWARF.29.20support.20i.2E.2E.2E.html#223722008">(Jan 23 2021 at 00:56)</a>:</h4>
<p>fitzgen submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/2565#pullrequestreview-574714720">PR Review</a>.</p>



<a name="223723609"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232565%20Detailed%20debug-info%20%28DWARF%29%20support%20i.../near/223723609" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232565.20Detailed.20debug-info.20.28DWARF.29.20support.20i.2E.2E.2E.html#223723609">(Jan 23 2021 at 01:22)</a>:</h4>
<p>cfallin merged <a href="https://github.com/bytecodealliance/wasmtime/pull/2565">PR #2565</a>.</p>



<hr><p>Last updated: Jan 20 2025 at 06:04 UTC</p>
</html>