<html>
<head><meta charset="utf-8"><title>wasmtime / PR #6358 winch: Implement new trampolines · git-wasmtime · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/index.html">git-wasmtime</a></h2>
<h3>Topic: <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.236358.20winch.3A.20Implement.20new.20trampolines.html">wasmtime / PR #6358 winch: Implement new trampolines</a></h3>

<hr>

<base href="https://bytecodealliance.zulipchat.com">

<head><link href="https://bytecodealliance.github.io/zulip-archive/style.css" rel="stylesheet"></head>

<a name="356980946"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%236358%20winch%3A%20Implement%20new%20trampolines/near/356980946" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.236358.20winch.3A.20Implement.20new.20trampolines.html#356980946">(May 09 2023 at 13:17)</a>:</h4>
<p>saulecabrera opened <a href="https://github.com/bytecodealliance/wasmtime/pull/6358">PR #6358</a> from <code>saulecabrera:winch-array-wasm-trampoline</code> to <code>bytecodealliance:main</code>:</p>
<blockquote>
<p>This change is a follow-up to<br>
<a href="https://github.com/bytecodealliance/wasmtime/pull/6262">https://github.com/bytecodealliance/wasmtime/pull/6262</a>, in which the new trampolines, described <a href="https://github.com/bytecodealliance/rfcs/blob/main/accepted/tail-calls.md#new-trampolines-and-vmcallercheckedanyfunc-changes">here</a>, were introduced to Wasmtime.</p>
<p>This change, focuses on the <code>array-to-wasm</code>,<br>
<code>native-to-wasm</code> and <code>wasm-to-native</code> trampolines to restore Winch's working state prior to the introduction of the new trampolines. It's worth noting that the new approach for trampolines make it easier to support the <code>TypedFunc</code> API in Winch. Prior to the introduction of the new trampolines, it was not obvious how to approach it.</p>
<p>This change also introduces a pinned register that will hold the <code>VMContext</code> pointer, which is loaded in the <code>*-to-wasm</code>  trampolines; the <code>VMContext</code>  register is a pre-requisite to this change to support the <code>wasm-to-native</code> trampolines.</p>
<p>Lastly, with the introduction of the <code>VMContext</code> register and the <code>wasm-to-native</code> trampolines, this change also introduces support for calling function imports, which is a variation of the already existing calls to locally defined functions.</p>
<p>&lt;!--<br>
Please make sure you include the following information:</p>
<ul>
<li>
<p>If this work has been discussed elsewhere, please include a link to that<br>
  conversation. If it was discussed in an issue, just mention "issue #...".</p>
</li>
<li>
<p>Explain why this change is needed. If the details are in an issue already,<br>
  this can be brief.</p>
</li>
</ul>
<p>Our development process is documented in the Wasmtime book:<br>
<a href="https://docs.wasmtime.dev/contributing-development-process.html">https://docs.wasmtime.dev/contributing-development-process.html</a></p>
<p>Please ensure all communication follows the code of conduct:<br>
<a href="https://github.com/bytecodealliance/wasmtime/blob/main/CODE_OF_CONDUCT.md">https://github.com/bytecodealliance/wasmtime/blob/main/CODE_OF_CONDUCT.md</a><br>
--&gt;</p>
</blockquote>



<a name="357006684"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%236358%20winch%3A%20Implement%20new%20trampolines/near/357006684" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.236358.20winch.3A.20Implement.20new.20trampolines.html#357006684">(May 09 2023 at 14:40)</a>:</h4>
<p>alexcrichton submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/6358#pullrequestreview-1418783515">PR review</a>:</p>
<blockquote>
<p>Nice!</p>
</blockquote>



<a name="357006691"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%236358%20winch%3A%20Implement%20new%20trampolines/near/357006691" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.236358.20winch.3A.20Implement.20new.20trampolines.html#357006691">(May 09 2023 at 14:40)</a>:</h4>
<p>alexcrichton submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/6358#pullrequestreview-1418783515">PR review</a>:</p>
<blockquote>
<p>Nice!</p>
</blockquote>



<a name="357006692"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%236358%20winch%3A%20Implement%20new%20trampolines/near/357006692" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.236358.20winch.3A.20Implement.20new.20trampolines.html#357006692">(May 09 2023 at 14:40)</a>:</h4>
<p>alexcrichton created <a href="https://github.com/bytecodealliance/wasmtime/pull/6358#discussion_r1188696276">PR review comment</a>:</p>
<blockquote>
<p>Not 100% related to this PR per se, but I've found that using all the <code>FooIndex</code> types has been quite helpful throughout Cranelift and the existing wasm lowering to ensure that everything is kept straight. For example I saw this and immediately thought "wait that's bad because this is a defined index" and then looked around a bit before I noticed above that the variable was shadowed with the <code>FuncIndex</code>. This <code>index.as_u32()</code> is fine as-is, but it might be useful to use the <code>wasmtime-types::*</code> index types throughout winch in the future (only if you agree of course!)</p>
</blockquote>



<a name="357006694"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%236358%20winch%3A%20Implement%20new%20trampolines/near/357006694" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.236358.20winch.3A.20Implement.20new.20trampolines.html#357006694">(May 09 2023 at 14:40)</a>:</h4>
<p>alexcrichton created <a href="https://github.com/bytecodealliance/wasmtime/pull/6358#discussion_r1188701342">PR review comment</a>:</p>
<blockquote>
<p>Out of curiosity, is there any particular reason to have accessor methods like this as opposed to exposing the <code>VMOffsets</code> directly?</p>
</blockquote>



<a name="357006698"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%236358%20winch%3A%20Implement%20new%20trampolines/near/357006698" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.236358.20winch.3A.20Implement.20new.20trampolines.html#357006698">(May 09 2023 at 14:40)</a>:</h4>
<p>alexcrichton created <a href="https://github.com/bytecodealliance/wasmtime/pull/6358#discussion_r1188697641">PR review comment</a>:</p>
<blockquote>
<p>Instead of manufacturing a dummy <code>1u32</code> here could the index of what to call perhaps be a payload of <code>TrampolineKind</code>? That way <code>WasmToNative</code> would have no payload but the other two would have payloads.</p>
</blockquote>



<a name="357006700"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%236358%20winch%3A%20Implement%20new%20trampolines/near/357006700" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.236358.20winch.3A.20Implement.20new.20trampolines.html#357006700">(May 09 2023 at 14:40)</a>:</h4>
<p>alexcrichton created <a href="https://github.com/bytecodealliance/wasmtime/pull/6358#discussion_r1188707372">PR review comment</a>:</p>
<blockquote>
<p>minor nit, but here instead of <code>ty</code> vs <code>ty.clone()</code> vs <code>&amp;ty</code> could these all take <code>ty: &amp;FuncType</code>?</p>
</blockquote>



<a name="357006702"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%236358%20winch%3A%20Implement%20new%20trampolines/near/357006702" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.236358.20winch.3A.20Implement.20new.20trampolines.html#357006702">(May 09 2023 at 14:40)</a>:</h4>
<p>alexcrichton created <a href="https://github.com/bytecodealliance/wasmtime/pull/6358#discussion_r1188713171">PR review comment</a>:</p>
<blockquote>
<p>Like above, technically this <code>I64</code> should conditionally be <code>I32</code> for 32-bit hosts, right? Not that we're going to support those any time soon, but might be good to perhaps abstract ahead of time in case anyone in the future comes to add support if it's not too hard. (if it is a bit onerous I think a <code>// FIXME: ...</code> is fine too since we don't have 32-bit support anywhere on the horizon)</p>
</blockquote>



<a name="357006710"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%236358%20winch%3A%20Implement%20new%20trampolines/near/357006710" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.236358.20winch.3A.20Implement.20new.20trampolines.html#357006710">(May 09 2023 at 14:40)</a>:</h4>
<p>alexcrichton created <a href="https://github.com/bytecodealliance/wasmtime/pull/6358#discussion_r1188709922">PR review comment</a>:</p>
<blockquote>
<p>Technically this <code>S64</code> is actually "whatever the <code>A</code>'s pointer size is", right?</p>
</blockquote>



<a name="357078232"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%236358%20winch%3A%20Implement%20new%20trampolines/near/357078232" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.236358.20winch.3A.20Implement.20new.20trampolines.html#357078232">(May 09 2023 at 19:03)</a>:</h4>
<p>saulecabrera updated <a href="https://github.com/bytecodealliance/wasmtime/pull/6358">PR #6358</a>.</p>



<a name="357085197"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%236358%20winch%3A%20Implement%20new%20trampolines/near/357085197" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.236358.20winch.3A.20Implement.20new.20trampolines.html#357085197">(May 09 2023 at 19:41)</a>:</h4>
<p>saulecabrera updated <a href="https://github.com/bytecodealliance/wasmtime/pull/6358">PR #6358</a>.</p>



<a name="357352973"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%236358%20winch%3A%20Implement%20new%20trampolines/near/357352973" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.236358.20winch.3A.20Implement.20new.20trampolines.html#357352973">(May 10 2023 at 16:47)</a>:</h4>
<p>saulecabrera updated <a href="https://github.com/bytecodealliance/wasmtime/pull/6358">PR #6358</a>.</p>



<a name="357354095"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%236358%20winch%3A%20Implement%20new%20trampolines/near/357354095" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.236358.20winch.3A.20Implement.20new.20trampolines.html#357354095">(May 10 2023 at 16:52)</a>:</h4>
<p>saulecabrera updated <a href="https://github.com/bytecodealliance/wasmtime/pull/6358">PR #6358</a>.</p>



<a name="357375413"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%236358%20winch%3A%20Implement%20new%20trampolines/near/357375413" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.236358.20winch.3A.20Implement.20new.20trampolines.html#357375413">(May 10 2023 at 18:32)</a>:</h4>
<p>saulecabrera updated <a href="https://github.com/bytecodealliance/wasmtime/pull/6358">PR #6358</a>.</p>



<a name="357393594"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%236358%20winch%3A%20Implement%20new%20trampolines/near/357393594" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.236358.20winch.3A.20Implement.20new.20trampolines.html#357393594">(May 10 2023 at 20:02)</a>:</h4>
<p>saulecabrera updated <a href="https://github.com/bytecodealliance/wasmtime/pull/6358">PR #6358</a>.</p>



<a name="357408234"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%236358%20winch%3A%20Implement%20new%20trampolines/near/357408234" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.236358.20winch.3A.20Implement.20new.20trampolines.html#357408234">(May 10 2023 at 21:34)</a>:</h4>
<p>saulecabrera updated <a href="https://github.com/bytecodealliance/wasmtime/pull/6358">PR #6358</a>.</p>



<a name="358479755"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%236358%20winch%3A%20Implement%20new%20trampolines/near/358479755" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.236358.20winch.3A.20Implement.20new.20trampolines.html#358479755">(May 15 2023 at 14:39)</a>:</h4>
<p>saulecabrera updated <a href="https://github.com/bytecodealliance/wasmtime/pull/6358">PR #6358</a>.</p>



<a name="358515994"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%236358%20winch%3A%20Implement%20new%20trampolines/near/358515994" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.236358.20winch.3A.20Implement.20new.20trampolines.html#358515994">(May 15 2023 at 16:46)</a>:</h4>
<p>saulecabrera updated <a href="https://github.com/bytecodealliance/wasmtime/pull/6358">PR #6358</a>.</p>



<a name="358541599"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%236358%20winch%3A%20Implement%20new%20trampolines/near/358541599" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.236358.20winch.3A.20Implement.20new.20trampolines.html#358541599">(May 15 2023 at 18:28)</a>:</h4>
<p>saulecabrera updated <a href="https://github.com/bytecodealliance/wasmtime/pull/6358">PR #6358</a>.</p>



<a name="358541805"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%236358%20winch%3A%20Implement%20new%20trampolines/near/358541805" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.236358.20winch.3A.20Implement.20new.20trampolines.html#358541805">(May 15 2023 at 18:29)</a>:</h4>
<p>saulecabrera updated <a href="https://github.com/bytecodealliance/wasmtime/pull/6358">PR #6358</a>.</p>



<a name="358543337"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%236358%20winch%3A%20Implement%20new%20trampolines/near/358543337" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.236358.20winch.3A.20Implement.20new.20trampolines.html#358543337">(May 15 2023 at 18:35)</a>:</h4>
<p>saulecabrera updated <a href="https://github.com/bytecodealliance/wasmtime/pull/6358">PR #6358</a>.</p>



<a name="358543695"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%236358%20winch%3A%20Implement%20new%20trampolines/near/358543695" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.236358.20winch.3A.20Implement.20new.20trampolines.html#358543695">(May 15 2023 at 18:37)</a>:</h4>
<p>saulecabrera edited <a href="https://github.com/bytecodealliance/wasmtime/pull/6358">PR #6358</a>:</p>
<blockquote>
<p>This change is a follow-up to<br>
<a href="https://github.com/bytecodealliance/wasmtime/pull/6262">https://github.com/bytecodealliance/wasmtime/pull/6262</a>, in which the new trampolines, described <a href="https://github.com/bytecodealliance/rfcs/blob/main/accepted/tail-calls.md#new-trampolines-and-vmcallercheckedanyfunc-changes">here</a>, were introduced to Wasmtime.</p>
<p>This change, focuses on the <code>array-to-wasm</code>,<br>
<code>native-to-wasm</code> and <code>wasm-to-native</code> trampolines to restore Winch's working state prior to the introduction of the new trampolines. It's worth noting that the new approach for trampolines make it easier to support the <code>TypedFunc</code> API in Winch. Prior to the introduction of the new trampolines, it was not obvious how to approach it.</p>
<p>This change also introduces a pinned register that will hold the <code>VMContext</code> pointer, which is loaded in the <code>*-to-wasm</code>  trampolines; the <code>VMContext</code>  register is a pre-requisite to this change to support the <code>wasm-to-native</code> trampolines.</p>
<p>Lastly, with the introduction of the <code>VMContext</code> register and the <code>wasm-to-native</code> trampolines, this change also introduces support for calling function imports, which is a variation of the already existing calls to locally defined functions.</p>
<p>The other notable piece of this change aside from the trampolines is <code>winch-codegen</code>'s dependency on <code>wasmtime-environ</code>. Winch is so closely tied to the concepts exposed by the wasmtime crates that it makes sense to tie them together, even though the separation provides some advantages like easier testing in some cases, in the long run, there's probably going to be less need to test Winch in isolation and rather we'd rely more on integration style tests which require all of Wasmtime<br>
pieces anyway (fuzzing, spec tests, etc).</p>
<p>This change doesn't update the  existing implmenetation of <code>winch_codegen::FuncEnv</code>, but the intention is to update that part after this change.</p>
<p>&lt;!--<br>
Please make sure you include the following information:</p>
<ul>
<li>
<p>If this work has been discussed elsewhere, please include a link to that<br>
  conversation. If it was discussed in an issue, just mention "issue #...".</p>
</li>
<li>
<p>Explain why this change is needed. If the details are in an issue already,<br>
  this can be brief.</p>
</li>
</ul>
<p>Our development process is documented in the Wasmtime book:<br>
<a href="https://docs.wasmtime.dev/contributing-development-process.html">https://docs.wasmtime.dev/contributing-development-process.html</a></p>
<p>Please ensure all communication follows the code of conduct:<br>
<a href="https://github.com/bytecodealliance/wasmtime/blob/main/CODE_OF_CONDUCT.md">https://github.com/bytecodealliance/wasmtime/blob/main/CODE_OF_CONDUCT.md</a><br>
--&gt;</p>
</blockquote>



<a name="358555533"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%236358%20winch%3A%20Implement%20new%20trampolines/near/358555533" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.236358.20winch.3A.20Implement.20new.20trampolines.html#358555533">(May 15 2023 at 19:35)</a>:</h4>
<p>saulecabrera updated <a href="https://github.com/bytecodealliance/wasmtime/pull/6358">PR #6358</a>.</p>



<a name="358555921"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%236358%20winch%3A%20Implement%20new%20trampolines/near/358555921" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.236358.20winch.3A.20Implement.20new.20trampolines.html#358555921">(May 15 2023 at 19:37)</a>:</h4>
<p>saulecabrera updated <a href="https://github.com/bytecodealliance/wasmtime/pull/6358">PR #6358</a>.</p>



<a name="358561253"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%236358%20winch%3A%20Implement%20new%20trampolines/near/358561253" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.236358.20winch.3A.20Implement.20new.20trampolines.html#358561253">(May 15 2023 at 20:06)</a>:</h4>
<p>saulecabrera updated <a href="https://github.com/bytecodealliance/wasmtime/pull/6358">PR #6358</a>.</p>



<a name="358564332"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%236358%20winch%3A%20Implement%20new%20trampolines/near/358564332" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.236358.20winch.3A.20Implement.20new.20trampolines.html#358564332">(May 15 2023 at 20:24)</a>:</h4>
<p>saulecabrera updated <a href="https://github.com/bytecodealliance/wasmtime/pull/6358">PR #6358</a>.</p>



<a name="358565615"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%236358%20winch%3A%20Implement%20new%20trampolines/near/358565615" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.236358.20winch.3A.20Implement.20new.20trampolines.html#358565615">(May 15 2023 at 20:31)</a>:</h4>
<p>saulecabrera updated <a href="https://github.com/bytecodealliance/wasmtime/pull/6358">PR #6358</a>.</p>



<a name="358566229"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%236358%20winch%3A%20Implement%20new%20trampolines/near/358566229" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.236358.20winch.3A.20Implement.20new.20trampolines.html#358566229">(May 15 2023 at 20:34)</a>:</h4>
<p>saulecabrera updated <a href="https://github.com/bytecodealliance/wasmtime/pull/6358">PR #6358</a>.</p>



<a name="358566689"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%236358%20winch%3A%20Implement%20new%20trampolines/near/358566689" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.236358.20winch.3A.20Implement.20new.20trampolines.html#358566689">(May 15 2023 at 20:37)</a>:</h4>
<p><strong>saulecabrera</strong> has marked <a href="https://github.com/bytecodealliance/wasmtime/pull/6358">PR #6358</a> as ready for review.</p>



<a name="358566691"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%236358%20winch%3A%20Implement%20new%20trampolines/near/358566691" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.236358.20winch.3A.20Implement.20new.20trampolines.html#358566691">(May 15 2023 at 20:37)</a>:</h4>
<p><strong>saulecabrera</strong> requested <a href="https://github.com/cfallin">cfallin</a> for a review on <a href="https://github.com/bytecodealliance/wasmtime/pull/6358">PR #6358</a>.</p>



<a name="358566692"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%236358%20winch%3A%20Implement%20new%20trampolines/near/358566692" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.236358.20winch.3A.20Implement.20new.20trampolines.html#358566692">(May 15 2023 at 20:37)</a>:</h4>
<p><strong>saulecabrera</strong> requested <a href="https://github.com/orgs/bytecodealliance/teams/wasmtime-compiler-reviewers">wasmtime-compiler-reviewers</a> for a review on <a href="https://github.com/bytecodealliance/wasmtime/pull/6358">PR #6358</a>.</p>



<a name="358566695"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%236358%20winch%3A%20Implement%20new%20trampolines/near/358566695" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.236358.20winch.3A.20Implement.20new.20trampolines.html#358566695">(May 15 2023 at 20:37)</a>:</h4>
<p><strong>saulecabrera</strong> requested <a href="https://github.com/itsrainy">itsrainy</a> for a review on <a href="https://github.com/bytecodealliance/wasmtime/pull/6358">PR #6358</a>.</p>



<a name="358566697"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%236358%20winch%3A%20Implement%20new%20trampolines/near/358566697" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.236358.20winch.3A.20Implement.20new.20trampolines.html#358566697">(May 15 2023 at 20:37)</a>:</h4>
<p><strong>saulecabrera</strong> requested <a href="https://github.com/orgs/bytecodealliance/teams/wasmtime-core-reviewers">wasmtime-core-reviewers</a> for a review on <a href="https://github.com/bytecodealliance/wasmtime/pull/6358">PR #6358</a>.</p>



<a name="358566698"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%236358%20winch%3A%20Implement%20new%20trampolines/near/358566698" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.236358.20winch.3A.20Implement.20new.20trampolines.html#358566698">(May 15 2023 at 20:37)</a>:</h4>
<p><strong>saulecabrera</strong> requested <a href="https://github.com/orgs/bytecodealliance/teams/wasmtime-default-reviewers">wasmtime-default-reviewers</a> for a review on <a href="https://github.com/bytecodealliance/wasmtime/pull/6358">PR #6358</a>.</p>



<a name="358568647"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%236358%20winch%3A%20Implement%20new%20trampolines/near/358568647" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.236358.20winch.3A.20Implement.20new.20trampolines.html#358568647">(May 15 2023 at 20:50)</a>:</h4>
<p>saulecabrera updated <a href="https://github.com/bytecodealliance/wasmtime/pull/6358">PR #6358</a>.</p>



<a name="358570862"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%236358%20winch%3A%20Implement%20new%20trampolines/near/358570862" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.236358.20winch.3A.20Implement.20new.20trampolines.html#358570862">(May 15 2023 at 21:04)</a>:</h4>
<p><strong>saulecabrera</strong> requested <a href="https://github.com/alexcrichton">alexcrichton</a> for a review on <a href="https://github.com/bytecodealliance/wasmtime/pull/6358">PR #6358</a>.</p>



<a name="358576264"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%236358%20winch%3A%20Implement%20new%20trampolines/near/358576264" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.236358.20winch.3A.20Implement.20new.20trampolines.html#358576264">(May 15 2023 at 21:40)</a>:</h4>
<p>saulecabrera updated <a href="https://github.com/bytecodealliance/wasmtime/pull/6358">PR #6358</a>.</p>



<a name="358576882"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%236358%20winch%3A%20Implement%20new%20trampolines/near/358576882" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.236358.20winch.3A.20Implement.20new.20trampolines.html#358576882">(May 15 2023 at 21:45)</a>:</h4>
<p>saulecabrera updated <a href="https://github.com/bytecodealliance/wasmtime/pull/6358">PR #6358</a>.</p>



<a name="358725532"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%236358%20winch%3A%20Implement%20new%20trampolines/near/358725532" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.236358.20winch.3A.20Implement.20new.20trampolines.html#358725532">(May 16 2023 at 13:07)</a>:</h4>
<p>saulecabrera updated <a href="https://github.com/bytecodealliance/wasmtime/pull/6358">PR #6358</a>.</p>



<a name="358726740"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%236358%20winch%3A%20Implement%20new%20trampolines/near/358726740" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.236358.20winch.3A.20Implement.20new.20trampolines.html#358726740">(May 16 2023 at 13:11)</a>:</h4>
<p>saulecabrera updated <a href="https://github.com/bytecodealliance/wasmtime/pull/6358">PR #6358</a>.</p>



<a name="358740982"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%236358%20winch%3A%20Implement%20new%20trampolines/near/358740982" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.236358.20winch.3A.20Implement.20new.20trampolines.html#358740982">(May 16 2023 at 13:58)</a>:</h4>
<p>saulecabrera updated <a href="https://github.com/bytecodealliance/wasmtime/pull/6358">PR #6358</a>.</p>



<a name="358751695"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%236358%20winch%3A%20Implement%20new%20trampolines/near/358751695" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.236358.20winch.3A.20Implement.20new.20trampolines.html#358751695">(May 16 2023 at 14:32)</a>:</h4>
<p>alexcrichton submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/6358#pullrequestreview-1428734123">PR review</a>:</p>
<blockquote>
<p>Looks good to me! @cfallin may want to also take a look at some of the assembly bits too though?</p>
</blockquote>



<a name="358780566"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%236358%20winch%3A%20Implement%20new%20trampolines/near/358780566" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.236358.20winch.3A.20Implement.20new.20trampolines.html#358780566">(May 16 2023 at 16:08)</a>:</h4>
<p>saulecabrera updated <a href="https://github.com/bytecodealliance/wasmtime/pull/6358">PR #6358</a>.</p>



<a name="358781123"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%236358%20winch%3A%20Implement%20new%20trampolines/near/358781123" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.236358.20winch.3A.20Implement.20new.20trampolines.html#358781123">(May 16 2023 at 16:11)</a>:</h4>
<p><strong>saulecabrera</strong> requested <a href="https://github.com/cfallin">cfallin</a> for a review on <a href="https://github.com/bytecodealliance/wasmtime/pull/6358">PR #6358</a>.</p>



<a name="358782623"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%236358%20winch%3A%20Implement%20new%20trampolines/near/358782623" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.236358.20winch.3A.20Implement.20new.20trampolines.html#358782623">(May 16 2023 at 16:16)</a>:</h4>
<p>saulecabrera updated <a href="https://github.com/bytecodealliance/wasmtime/pull/6358">PR #6358</a>.</p>



<a name="358802836"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%236358%20winch%3A%20Implement%20new%20trampolines/near/358802836" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.236358.20winch.3A.20Implement.20new.20trampolines.html#358802836">(May 16 2023 at 17:31)</a>:</h4>
<p>cfallin submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/6358#pullrequestreview-1429073702">PR review</a>:</p>
<blockquote>
<p>Overall this looks very reasonable -- no objections (and thanks Alex for doing the detailed review here)!</p>
</blockquote>



<a name="358812612"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%236358%20winch%3A%20Implement%20new%20trampolines/near/358812612" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.236358.20winch.3A.20Implement.20new.20trampolines.html#358812612">(May 16 2023 at 18:06)</a>:</h4>
<p>saulecabrera merged <a href="https://github.com/bytecodealliance/wasmtime/pull/6358">PR #6358</a>.</p>



<hr><p>Last updated: Jan 20 2025 at 06:04 UTC</p>
</html>