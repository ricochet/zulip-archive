<html>
<head><meta charset="utf-8"><title>wasmtime / Issue #1216 Windows fprs preservation · git-wasmtime · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/index.html">git-wasmtime</a></h2>
<h3>Topic: <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20Issue.20.231216.20Windows.20fprs.20preservation.html">wasmtime / Issue #1216 Windows fprs preservation</a></h3>

<hr>

<base href="https://bytecodealliance.zulipchat.com">

<head><link href="https://bytecodealliance.github.io/zulip-archive/style.css" rel="stylesheet"></head>

<a name="190322974"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20Issue%20%231216%20Windows%20fprs%20preservation/near/190322974" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20Issue.20.231216.20Windows.20fprs.20preservation.html#190322974">(Mar 11 2020 at 19:43)</a>:</h4>
<p>iximeow <a href="https://github.com/bytecodealliance/wasmtime/pull/1216#issuecomment-597831470" target="_blank" title="https://github.com/bytecodealliance/wasmtime/pull/1216#issuecomment-597831470">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/1216" target="_blank" title="https://github.com/bytecodealliance/wasmtime/pull/1216">Issue #1216</a>:</p>
<blockquote>
<p>The CI failure is due to tripping <a href="https://github.com/bytecodealliance/wasmtime/pull/1216/files#diff-890393297114ccac3e3873180274f04aR349" target="_blank" title="https://github.com/bytecodealliance/wasmtime/pull/1216/files#diff-890393297114ccac3e3873180274f04aR349">this check</a> that we wouldn't misreport unwind information in cases where we have callee-save floating-point registers. I tried reproducing this locally by building the module in <code>multi_func_value/func.wast</code> by <code>clif-util wasm funct_module.wast --target x86_64-windows -D</code>, but for some reason that seems to build fine, using a significantly smaller amount of stack space? I ran <code>clif-util</code> from Linux, but the only thing that should be a factor here is the target specification. I'm not sure why it doesn't reproduce this way. Is there a flag I should set that influences lowering to clif as well?</p>
<p>Anyway, I printed the faulting prologue in CI to double-check that the panic is correctly hit, and indeed a function in the module uses well over the 240-byte limit I've noted above:</p>
<div class="codehilite"><pre><span></span>x86_push.i64 v105
offset 2: copy_special %rsp -&gt; %rbp
offset 5: x86_push.i64 v106
offset 7: x86_push.i64 v107
offset 9: x86_push.i64 v108
offset 11: x86_push.i64 v109
offset 13: x86_push.i64 v110
offset 15: x86_push.i64 v111
offset 17: adjust_sp_down_imm 336
offset 24: v112 = stack_addr.i64 ss18
offset 32: store.f64 notrap aligned v113, v112
offset 37: store.f64 notrap aligned v114, v112+16
offset 43: store.f64 notrap aligned v115, v112+32
</pre></div>


<p>Since this function uses callee-save floats, we miscompile it on Windows today. Should I disable this test on Windows? (not sure if there's a mechanism for this in spectests, honestly) It would be fixed in the same PR that adjusts stack layout to not be constrained to 240 byte frames when using callee-save xmm registers.</p>
</blockquote>



<a name="190323210"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20Issue%20%231216%20Windows%20fprs%20preservation/near/190323210" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20Issue.20.231216.20Windows.20fprs.20preservation.html#190323210">(Mar 11 2020 at 19:46)</a>:</h4>
<p>iximeow edited a <a href="https://github.com/bytecodealliance/wasmtime/pull/1216#issuecomment-597831470" target="_blank" title="https://github.com/bytecodealliance/wasmtime/pull/1216#issuecomment-597831470">comment</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/1216" target="_blank" title="https://github.com/bytecodealliance/wasmtime/pull/1216">Issue #1216</a>:</p>
<blockquote>
<p>The CI failure is due to tripping <a href="https://github.com/bytecodealliance/wasmtime/pull/1216/files#diff-890393297114ccac3e3873180274f04aR349" target="_blank" title="https://github.com/bytecodealliance/wasmtime/pull/1216/files#diff-890393297114ccac3e3873180274f04aR349">this check</a> that we wouldn't misreport unwind information in cases where we have callee-save floating-point registers. I tried reproducing this locally by building the module in <code>multi_func_value/func.wast</code> by <code>clif-util wasm funct_module.wast --target x86_64-windows -D</code>, but for some reason that seems to build fine, using a significantly smaller amount of stack space? I ran <code>clif-util</code> from Linux, but the only thing that should be a factor here is the target specification. I'm not sure why it doesn't reproduce this way. Is there a flag I should set that influences lowering to clif as well?</p>
<p>Anyway, I printed the faulting prologue in CI to double-check that the panic is correctly hit, and indeed a function in the module uses well over the 240-byte limit I've noted above:</p>
<div class="codehilite"><pre><span></span>x86_push.i64 v105
offset 2: copy_special %rsp -&gt; %rbp
offset 5: x86_push.i64 v106
offset 7: x86_push.i64 v107
offset 9: x86_push.i64 v108
offset 11: x86_push.i64 v109
offset 13: x86_push.i64 v110
offset 15: x86_push.i64 v111
offset 17: adjust_sp_down_imm 336
offset 24: v112 = stack_addr.i64 ss18
offset 32: store.f64 notrap aligned v113, v112
offset 37: store.f64 notrap aligned v114, v112+16
offset 43: store.f64 notrap aligned v115, v112+32
</pre></div>


<p>Since this function uses callee-save floats, we miscompile it on Windows today. Should I disable this test on Windows? (not sure if there's a mechanism for this in spectests, honestly) It would be fixed in the same PR that adjusts stack layout to not be constrained to 240 byte frames when using callee-save xmm registers.</p>
<p>Edit: this panic is only reached if you want a fastcall function with all of:</p>
<ul>
<li>a &gt;240 byte stack frame</li>
<li>callee-save floats</li>
<li>unwind information</li>
</ul>
<p>This PR fixes callee-save float preservation in fastcall functions generally. Asking for unwind information causes the panic. I'm not sure how easily Windows targets can get the former without the latter.</p>
</blockquote>



<a name="190416718"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20Issue%20%231216%20Windows%20fprs%20preservation/near/190416718" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20Issue.20.231216.20Windows.20fprs.20preservation.html#190416718">(Mar 12 2020 at 17:11)</a>:</h4>
<p>github-actions[bot] <a href="https://github.com/bytecodealliance/wasmtime/pull/1216#issuecomment-598306921" target="_blank" title="https://github.com/bytecodealliance/wasmtime/pull/1216#issuecomment-598306921">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/1216" target="_blank" title="https://github.com/bytecodealliance/wasmtime/pull/1216">Issue #1216</a>:</p>
<blockquote>
<h4>Subscribe to Label Action</h4>
<p>This issue or pull request has been labeled: "c", "r", "a", "n", "e", "l", "i", "f", "t"</p>
<p>To subscribe or unsubscribe from this label, edit the &lt;code&gt;.github/subscribe-to-label.json&lt;/code&gt; configuration file.</p>
<p><a href="https://github.com/bytecodealliance/subscribe-to-label-action" target="_blank" title="https://github.com/bytecodealliance/subscribe-to-label-action">Learn more.</a></p>
</blockquote>



<a name="190417414"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20Issue%20%231216%20Windows%20fprs%20preservation/near/190417414" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20Issue.20.231216.20Windows.20fprs.20preservation.html#190417414">(Mar 12 2020 at 17:17)</a>:</h4>
<p>github-actions[bot] <a href="https://github.com/bytecodealliance/wasmtime/pull/1216#issuecomment-598310226" target="_blank" title="https://github.com/bytecodealliance/wasmtime/pull/1216#issuecomment-598310226">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/1216" target="_blank" title="https://github.com/bytecodealliance/wasmtime/pull/1216">Issue #1216</a>:</p>
<blockquote>
<h4>Subscribe to Label Action</h4>
<p>This issue or pull request has been labeled: "c", "r", "a", "n", "e", "l", "i", "f", "t"</p>
<p>To subscribe or unsubscribe from this label, edit the &lt;code&gt;.github/subscribe-to-label.json&lt;/code&gt; configuration file.</p>
<p><a href="https://github.com/bytecodealliance/subscribe-to-label-action" target="_blank" title="https://github.com/bytecodealliance/subscribe-to-label-action">Learn more.</a></p>
</blockquote>



<a name="190432415"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20Issue%20%231216%20Windows%20fprs%20preservation/near/190432415" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20Issue.20.231216.20Windows.20fprs.20preservation.html#190432415">(Mar 12 2020 at 19:16)</a>:</h4>
<p>peterhuene deleted a <a href="https://github.com/bytecodealliance/wasmtime/pull/1216#issuecomment-598306921" target="_blank" title="https://github.com/bytecodealliance/wasmtime/pull/1216#issuecomment-598306921">comment</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/1216" target="_blank" title="https://github.com/bytecodealliance/wasmtime/pull/1216">Issue #1216</a>:</p>
<blockquote>
<h4>Subscribe to Label Action</h4>
<p>This issue or pull request has been labeled: "c", "r", "a", "n", "e", "l", "i", "f", "t"</p>
<p>To subscribe or unsubscribe from this label, edit the &lt;code&gt;.github/subscribe-to-label.json&lt;/code&gt; configuration file.</p>
<p><a href="https://github.com/bytecodealliance/subscribe-to-label-action" target="_blank" title="https://github.com/bytecodealliance/subscribe-to-label-action">Learn more.</a></p>
</blockquote>



<a name="190432421"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20Issue%20%231216%20Windows%20fprs%20preservation/near/190432421" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20Issue.20.231216.20Windows.20fprs.20preservation.html#190432421">(Mar 12 2020 at 19:16)</a>:</h4>
<p>peterhuene deleted a <a href="https://github.com/bytecodealliance/wasmtime/pull/1216#issuecomment-598310226" target="_blank" title="https://github.com/bytecodealliance/wasmtime/pull/1216#issuecomment-598310226">comment</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/1216" target="_blank" title="https://github.com/bytecodealliance/wasmtime/pull/1216">Issue #1216</a>:</p>
<blockquote>
<h4>Subscribe to Label Action</h4>
<p>This issue or pull request has been labeled: "c", "r", "a", "n", "e", "l", "i", "f", "t"</p>
<p>To subscribe or unsubscribe from this label, edit the &lt;code&gt;.github/subscribe-to-label.json&lt;/code&gt; configuration file.</p>
<p><a href="https://github.com/bytecodealliance/subscribe-to-label-action" target="_blank" title="https://github.com/bytecodealliance/subscribe-to-label-action">Learn more.</a></p>
</blockquote>



<a name="190568875"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20Issue%20%231216%20Windows%20fprs%20preservation/near/190568875" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20Issue.20.231216.20Windows.20fprs.20preservation.html#190568875">(Mar 14 2020 at 00:08)</a>:</h4>
<p>iximeow <a href="https://github.com/bytecodealliance/wasmtime/pull/1216#issuecomment-598978800" target="_blank" title="https://github.com/bytecodealliance/wasmtime/pull/1216#issuecomment-598978800">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/1216" target="_blank" title="https://github.com/bytecodealliance/wasmtime/pull/1216">Issue #1216</a>:</p>
<blockquote>
<p>Nudging this again as I think this is as good as this fix can get without getting into the weeds on stack layout details.</p>
<p>I have three(ish) issues to open assuming a <span aria-label="+1" class="emoji emoji-1f44d" role="img" title="+1">:+1:</span> :</p>
<ul>
<li>[ ] Use of an <code>F64</code> type instead of the more accurate <code>F64x2</code> for callee-save FPRs, which _works_ but just isn't fully expressive of intent. See <a href="https://github.com/bytecodealliance/cranelift/pull/1378#discussion_r382268121" target="_blank" title="https://github.com/bytecodealliance/cranelift/pull/1378#discussion_r382268121">here</a></li>
<li>[ ] Fix how Cranelift lays out Fastcall stacks to avoid the 240-byte stack frame limit when using unwind information and callee-save XMM registers. See <a href="https://github.com/bytecodealliance/wasmtime/pull/1216#discussion_r390593267" target="_blank" title="https://github.com/bytecodealliance/wasmtime/pull/1216#discussion_r390593267">here</a> for conversation and <a href="https://github.com/bytecodealliance/wasmtime/pull/1216/files#diff-a7b0a2dee0126cddf994326e705a91eaR199-R206" target="_blank" title="https://github.com/bytecodealliance/wasmtime/pull/1216/files#diff-a7b0a2dee0126cddf994326e705a91eaR199-R206">here</a> for a test I've had to disable as a consequence.</li>
<li>[ ] Might not be worth a tracking issue, but there are two TODO's contingent on <a href="https://github.com/bytecodealliance/wasmtime/pull/1216/files#diff-63eb2d3a8c23f2a0199e4161f983d29dR892-R895" target="_blank" title="https://github.com/bytecodealliance/wasmtime/pull/1216/files#diff-63eb2d3a8c23f2a0199e4161f983d29dR892-R895">an encoding existing</a> that would result in changes here after this lands.</li>
</ul>
</blockquote>



<a name="190832085"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20Issue%20%231216%20Windows%20fprs%20preservation/near/190832085" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20Issue.20.231216.20Windows.20fprs.20preservation.html#190832085">(Mar 17 2020 at 10:52)</a>:</h4>
<p>github-actions[bot] <a href="https://github.com/bytecodealliance/wasmtime/pull/1216#issuecomment-600004726" target="_blank" title="https://github.com/bytecodealliance/wasmtime/pull/1216#issuecomment-600004726">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/1216" target="_blank" title="https://github.com/bytecodealliance/wasmtime/pull/1216">Issue #1216</a>:</p>
<blockquote>
<h4>Subscribe to Label Action</h4>
<p>This issue or pull request has been labeled: "cranelift"</p>
<p>&lt;details&gt; &lt;summary&gt;Users Subscribed to "cranelift"&lt;/summary&gt;</p>
<ul>
<li>@bnjbvr</li>
</ul>
<p>&lt;/details&gt;</p>
<p>To subscribe or unsubscribe from this label, edit the &lt;code&gt;.github/subscribe-to-label.json&lt;/code&gt; configuration file.</p>
<p><a href="https://github.com/bytecodealliance/subscribe-to-label-action" target="_blank" title="https://github.com/bytecodealliance/subscribe-to-label-action">Learn more.</a></p>
</blockquote>



<a name="191948472"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20Issue%20%231216%20Windows%20fprs%20preservation/near/191948472" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20Issue.20.231216.20Windows.20fprs.20preservation.html#191948472">(Mar 26 2020 at 21:03)</a>:</h4>
<p>iximeow <a href="https://github.com/bytecodealliance/wasmtime/pull/1216#issuecomment-604684561" title="https://github.com/bytecodealliance/wasmtime/pull/1216#issuecomment-604684561">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/1216" title="https://github.com/bytecodealliance/wasmtime/pull/1216">Issue #1216</a>:</p>
<blockquote>
<p>Pardon the rebase, just want to get this on a more recent <code>master</code> so as to pick up a fix for nightly builds failing in CI.</p>
</blockquote>



<a name="191997458"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20Issue%20%231216%20Windows%20fprs%20preservation/near/191997458" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20Issue.20.231216.20Windows.20fprs.20preservation.html#191997458">(Mar 27 2020 at 10:17)</a>:</h4>
<p>bjorn3 <a href="https://github.com/bytecodealliance/wasmtime/pull/1216#issuecomment-604921488" title="https://github.com/bytecodealliance/wasmtime/pull/1216#issuecomment-604921488">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/1216" title="https://github.com/bytecodealliance/wasmtime/pull/1216">Issue #1216</a>:</p>
<blockquote>
<p>@iximeow I think you forgot to push :)</p>
</blockquote>



<a name="192056474"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20Issue%20%231216%20Windows%20fprs%20preservation/near/192056474" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20Issue.20.231216.20Windows.20fprs.20preservation.html#192056474">(Mar 27 2020 at 17:58)</a>:</h4>
<p>iximeow <a href="https://github.com/bytecodealliance/wasmtime/pull/1216#issuecomment-605166714" title="https://github.com/bytecodealliance/wasmtime/pull/1216#issuecomment-605166714">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/1216" title="https://github.com/bytecodealliance/wasmtime/pull/1216">Issue #1216</a>:</p>
<blockquote>
<p>@bjorn3 even worse, I'd pushed to the wrong remote. Thanks for the heads up!</p>
</blockquote>



<a name="192339386"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20Issue%20%231216%20Windows%20fprs%20preservation/near/192339386" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20Issue.20.231216.20Windows.20fprs.20preservation.html#192339386">(Mar 31 2020 at 02:14)</a>:</h4>
<p>peterhuene <a href="https://github.com/bytecodealliance/wasmtime/pull/1216#issuecomment-606356267" title="https://github.com/bytecodealliance/wasmtime/pull/1216#issuecomment-606356267">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/1216" title="https://github.com/bytecodealliance/wasmtime/pull/1216">Issue #1216</a>:</p>
<blockquote>
<p>It looks like there's at least a few more tests to disable due to the frame size limitation this adds to functions using Windows x64 calling convention.</p>
</blockquote>



<a name="192840868"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20Issue%20%231216%20Windows%20fprs%20preservation/near/192840868" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20Issue.20.231216.20Windows.20fprs.20preservation.html#192840868">(Apr 03 2020 at 17:50)</a>:</h4>
<p>iximeow <a href="https://github.com/bytecodealliance/wasmtime/pull/1216#issuecomment-608576352" title="https://github.com/bytecodealliance/wasmtime/pull/1216#issuecomment-608576352">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/1216" title="https://github.com/bytecodealliance/wasmtime/pull/1216">Issue #1216</a>:</p>
<blockquote>
<p>it passes <span aria-label="tada" class="emoji emoji-1f389" role="img" title="tada">:tada:</span></p>
<p>GitHub appears to believe that <code>3be2d1c</code> doesn't exist, so I pushed an empty commit (<code>ea9f77a</code>) to fool CI into running after yesterday's availability issues. After ignoring more tests, it's green again 🥴</p>
</blockquote>



<a name="192868569"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20Issue%20%231216%20Windows%20fprs%20preservation/near/192868569" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20Issue.20.231216.20Windows.20fprs.20preservation.html#192868569">(Apr 03 2020 at 21:56)</a>:</h4>
<p>peterhuene <a href="https://github.com/bytecodealliance/wasmtime/pull/1216#issuecomment-608705730" title="https://github.com/bytecodealliance/wasmtime/pull/1216#issuecomment-608705730">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/1216" title="https://github.com/bytecodealliance/wasmtime/pull/1216">Issue #1216</a>:</p>
<blockquote>
<p>@iximeow I'll review this soon and if everyone signs off, I think we should merge this before my unwind refactoring changes.  I can easily update that PR to integrate this PR's changes to save  the FPRs in the windows unwind info.</p>
</blockquote>



<a name="193084583"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20Issue%20%231216%20Windows%20fprs%20preservation/near/193084583" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20Issue.20.231216.20Windows.20fprs.20preservation.html#193084583">(Apr 06 2020 at 18:47)</a>:</h4>
<p>bjorn3 <a href="https://github.com/bytecodealliance/wasmtime/pull/1216#issuecomment-609971813" title="https://github.com/bytecodealliance/wasmtime/pull/1216#issuecomment-609971813">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/1216" title="https://github.com/bytecodealliance/wasmtime/pull/1216">Issue #1216</a>:</p>
<blockquote>
<blockquote>
<p>We probably want @bjorn3 or another core cranelift maintainer to sign off as well.</p>
</blockquote>
<p>I am actually not a maintainer. :)</p>
</blockquote>



<a name="193087215"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20Issue%20%231216%20Windows%20fprs%20preservation/near/193087215" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20Issue.20.231216.20Windows.20fprs.20preservation.html#193087215">(Apr 06 2020 at 19:07)</a>:</h4>
<p>peterhuene <a href="https://github.com/bytecodealliance/wasmtime/pull/1216#issuecomment-609981468" title="https://github.com/bytecodealliance/wasmtime/pull/1216#issuecomment-609981468">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/1216" title="https://github.com/bytecodealliance/wasmtime/pull/1216">Issue #1216</a>:</p>
<blockquote>
<p><span aria-label="scream" class="emoji emoji-1f631" role="img" title="scream">:scream:</span> my apologies, although your review is obviously always appreciated :) I'm not actually a core cranelift maintainer either, so I'm more comfortable when others sign off on bits I haven't been directly involved in.</p>
</blockquote>



<a name="193088539"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20Issue%20%231216%20Windows%20fprs%20preservation/near/193088539" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20Issue.20.231216.20Windows.20fprs.20preservation.html#193088539">(Apr 06 2020 at 19:20)</a>:</h4>
<p>bjorn3 <a href="https://github.com/bytecodealliance/wasmtime/pull/1216#issuecomment-609987256" title="https://github.com/bytecodealliance/wasmtime/pull/1216#issuecomment-609987256">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/1216" title="https://github.com/bytecodealliance/wasmtime/pull/1216">Issue #1216</a>:</p>
<blockquote>
<blockquote>
<p><span aria-label="scream" class="emoji emoji-1f631" role="img" title="scream">:scream:</span> my apologies, although your review is obviously always appreciated :)</p>
</blockquote>
<p>You are not the first to think I am a maintainer of a project. :) I often review PR's on projects I am (slightly) interested in. And sometimes the PR author assumes I am a maintainer.</p>
</blockquote>



<a name="193092825"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20Issue%20%231216%20Windows%20fprs%20preservation/near/193092825" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20Issue.20.231216.20Windows.20fprs.20preservation.html#193092825">(Apr 06 2020 at 19:56)</a>:</h4>
<p>peterhuene <a href="https://github.com/bytecodealliance/wasmtime/pull/1216#issuecomment-610004450" title="https://github.com/bytecodealliance/wasmtime/pull/1216#issuecomment-610004450">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/1216" title="https://github.com/bytecodealliance/wasmtime/pull/1216">Issue #1216</a>:</p>
<blockquote>
<p>I'll ping @bnjbvr for the core maintainer sign-off, then.</p>
</blockquote>



<a name="193116482"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20Issue%20%231216%20Windows%20fprs%20preservation/near/193116482" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20Issue.20.231216.20Windows.20fprs.20preservation.html#193116482">(Apr 06 2020 at 23:42)</a>:</h4>
<p>iximeow edited a <a href="https://github.com/bytecodealliance/wasmtime/pull/1216#issuecomment-598978800" title="https://github.com/bytecodealliance/wasmtime/pull/1216#issuecomment-598978800">comment</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/1216" title="https://github.com/bytecodealliance/wasmtime/pull/1216">Issue #1216</a>:</p>
<blockquote>
<p>Nudging this again as I think this is as good as this fix can get without getting into the weeds on stack layout details.</p>
<p>I have three(ish) issues to open assuming a <span aria-label="+1" class="emoji emoji-1f44d" role="img" title="+1">:+1:</span> :</p>
<ul>
<li>[ ] Use of an <code>F64</code> type instead of the more accurate <code>F64x2</code> for callee-save FPRs, which _works_ but just isn't fully expressive of intent. See <a href="https://github.com/bytecodealliance/cranelift/pull/1378#discussion_r382268121" title="https://github.com/bytecodealliance/cranelift/pull/1378#discussion_r382268121">here</a></li>
<li>[x] Fix how Cranelift lays out Fastcall stacks to avoid the 240-byte stack frame limit when using unwind information and callee-save XMM registers. See <a href="https://github.com/bytecodealliance/wasmtime/pull/1216#discussion_r390593267" title="https://github.com/bytecodealliance/wasmtime/pull/1216#discussion_r390593267">here</a> for conversation and <a href="https://github.com/bytecodealliance/wasmtime/pull/1216/files#diff-a7b0a2dee0126cddf994326e705a91eaR199-R206" title="https://github.com/bytecodealliance/wasmtime/pull/1216/files#diff-a7b0a2dee0126cddf994326e705a91eaR199-R206">here</a> for a test I've had to disable as a consequence.</li>
<li>[ ] Might not be worth a tracking issue, but there are two TODO's contingent on <a href="https://github.com/bytecodealliance/wasmtime/pull/1216/files#diff-63eb2d3a8c23f2a0199e4161f983d29dR892-R895" title="https://github.com/bytecodealliance/wasmtime/pull/1216/files#diff-63eb2d3a8c23f2a0199e4161f983d29dR892-R895">an encoding existing</a> that would result in changes here after this lands.</li>
</ul>
</blockquote>



<a name="193508501"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20Issue%20%231216%20Windows%20fprs%20preservation/near/193508501" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20Issue.20.231216.20Windows.20fprs.20preservation.html#193508501">(Apr 09 2020 at 20:59)</a>:</h4>
<p>github-actions[bot] <a href="https://github.com/bytecodealliance/wasmtime/pull/1216#issuecomment-611749700" title="https://github.com/bytecodealliance/wasmtime/pull/1216#issuecomment-611749700">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/1216" title="https://github.com/bytecodealliance/wasmtime/pull/1216">Issue #1216</a>:</p>
<blockquote>
<h4>Subscribe to Label Action</h4>
<p>This issue or pull request has been labeled: "wasmtime:api"</p>
<p>&lt;details&gt; &lt;summary&gt;Users Subscribed to "wasmtime:api"&lt;/summary&gt;</p>
<ul>
<li>@peterhuene</li>
</ul>
<p>&lt;/details&gt;</p>
<p>To subscribe or unsubscribe from this label, edit the &lt;code&gt;.github/subscribe-to-label.json&lt;/code&gt; configuration file.</p>
<p><a href="https://github.com/bytecodealliance/subscribe-to-label-action" title="https://github.com/bytecodealliance/subscribe-to-label-action">Learn more.</a></p>
</blockquote>



<a name="193590662"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20Issue%20%231216%20Windows%20fprs%20preservation/near/193590662" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20Issue.20.231216.20Windows.20fprs.20preservation.html#193590662">(Apr 10 2020 at 16:50)</a>:</h4>
<p>iximeow <a href="https://github.com/bytecodealliance/wasmtime/pull/1216#issuecomment-612117385" title="https://github.com/bytecodealliance/wasmtime/pull/1216#issuecomment-612117385">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/1216" title="https://github.com/bytecodealliance/wasmtime/pull/1216">Issue #1216</a>:</p>
<blockquote>
<p>I had to force push to rebase and fix a merge conflict that crept in. Unwind-producing functions are <code>Result</code>-y, which of course resulted in some Wasmtime changes as well. Given the wider scope, I'd like one last +1 before clicking the tempting green button :)</p>
</blockquote>



<a name="193615772"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20Issue%20%231216%20Windows%20fprs%20preservation/near/193615772" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20Issue.20.231216.20Windows.20fprs.20preservation.html#193615772">(Apr 10 2020 at 20:45)</a>:</h4>
<p>iximeow edited a <a href="https://github.com/bytecodealliance/wasmtime/pull/1216#issuecomment-598978800" title="https://github.com/bytecodealliance/wasmtime/pull/1216#issuecomment-598978800">comment</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/1216" title="https://github.com/bytecodealliance/wasmtime/pull/1216">Issue #1216</a>:</p>
<blockquote>
<p>Nudging this again as I think this is as good as this fix can get without getting into the weeds on stack layout details.</p>
<p>I have three(ish) issues to open assuming a <span aria-label="+1" class="emoji emoji-1f44d" role="img" title="+1">:+1:</span> :</p>
<ul>
<li>[x] Use of an <code>F64</code> type instead of the more accurate <code>F64x2</code> for callee-save FPRs, which _works_ but just isn't fully expressive of intent. See <a href="https://github.com/bytecodealliance/cranelift/pull/1378#discussion_r382268121" title="https://github.com/bytecodealliance/cranelift/pull/1378#discussion_r382268121">here</a></li>
<li>[x] Fix how Cranelift lays out Fastcall stacks to avoid the 240-byte stack frame limit when using unwind information and callee-save XMM registers. See <a href="https://github.com/bytecodealliance/wasmtime/pull/1216#discussion_r390593267" title="https://github.com/bytecodealliance/wasmtime/pull/1216#discussion_r390593267">here</a> for conversation and <a href="https://github.com/bytecodealliance/wasmtime/pull/1216/files#diff-a7b0a2dee0126cddf994326e705a91eaR199-R206" title="https://github.com/bytecodealliance/wasmtime/pull/1216/files#diff-a7b0a2dee0126cddf994326e705a91eaR199-R206">here</a> for a test I've had to disable as a consequence.</li>
<li>[ ] Might not be worth a tracking issue, but there are two TODO's contingent on <a href="https://github.com/bytecodealliance/wasmtime/pull/1216/files#diff-63eb2d3a8c23f2a0199e4161f983d29dR892-R895" title="https://github.com/bytecodealliance/wasmtime/pull/1216/files#diff-63eb2d3a8c23f2a0199e4161f983d29dR892-R895">an encoding existing</a> that would result in changes here after this lands.</li>
</ul>
</blockquote>



<a name="193616861"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20Issue%20%231216%20Windows%20fprs%20preservation/near/193616861" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20Issue.20.231216.20Windows.20fprs.20preservation.html#193616861">(Apr 10 2020 at 20:57)</a>:</h4>
<p>iximeow edited a <a href="https://github.com/bytecodealliance/wasmtime/pull/1216#issuecomment-598978800" title="https://github.com/bytecodealliance/wasmtime/pull/1216#issuecomment-598978800">comment</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/1216" title="https://github.com/bytecodealliance/wasmtime/pull/1216">Issue #1216</a>:</p>
<blockquote>
<p>Nudging this again as I think this is as good as this fix can get without getting into the weeds on stack layout details.</p>
<p>I have three(ish) issues to open assuming a <span aria-label="+1" class="emoji emoji-1f44d" role="img" title="+1">:+1:</span> :</p>
<ul>
<li>[x] Use of an <code>F64</code> type instead of the more accurate <code>F64x2</code> for callee-save FPRs, which _works_ but just isn't fully expressive of intent. See <a href="https://github.com/bytecodealliance/cranelift/pull/1378#discussion_r382268121" title="https://github.com/bytecodealliance/cranelift/pull/1378#discussion_r382268121">here</a></li>
<li>[x] Fix how Cranelift lays out Fastcall stacks to avoid the 240-byte stack frame limit when using unwind information and callee-save XMM registers. See <a href="https://github.com/bytecodealliance/wasmtime/pull/1216#discussion_r390593267" title="https://github.com/bytecodealliance/wasmtime/pull/1216#discussion_r390593267">here</a> for conversation and <a href="https://github.com/bytecodealliance/wasmtime/pull/1216/files#diff-a7b0a2dee0126cddf994326e705a91eaR199-R206" title="https://github.com/bytecodealliance/wasmtime/pull/1216/files#diff-a7b0a2dee0126cddf994326e705a91eaR199-R206">here</a> for a test I've had to disable as a consequence.</li>
<li>[x] Might not be worth a tracking issue, but there are two TODO's contingent on <a href="https://github.com/bytecodealliance/wasmtime/pull/1216/files#diff-63eb2d3a8c23f2a0199e4161f983d29dR892-R895" title="https://github.com/bytecodealliance/wasmtime/pull/1216/files#diff-63eb2d3a8c23f2a0199e4161f983d29dR892-R895">an encoding existing</a> that would result in changes here after this lands.</li>
</ul>
</blockquote>



<a name="193628637"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20Issue%20%231216%20Windows%20fprs%20preservation/near/193628637" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20Issue.20.231216.20Windows.20fprs.20preservation.html#193628637">(Apr 10 2020 at 23:14)</a>:</h4>
<p>peterhuene <a href="https://github.com/bytecodealliance/wasmtime/pull/1216#issuecomment-612260747" title="https://github.com/bytecodealliance/wasmtime/pull/1216#issuecomment-612260747">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/1216" title="https://github.com/bytecodealliance/wasmtime/pull/1216">Issue #1216</a>:</p>
<blockquote>
<p><span aria-label="tada" class="emoji emoji-1f389" role="img" title="tada">:tada:</span> thanks for fixing this @iximeow! <span aria-label="tada" class="emoji emoji-1f389" role="img" title="tada">:tada:</span>  I realize it was a slog of a PR.</p>
<p>Now I get to merge these changes in to my refactoring PR and we'll see about prioritizing the fixing of the stack layout of the register saves <span aria-label="smile" class="emoji emoji-263a" role="img" title="smile">:smile:</span></p>
</blockquote>



<a name="193992935"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20Issue%20%231216%20Windows%20fprs%20preservation/near/193992935" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20Issue.20.231216.20Windows.20fprs.20preservation.html#193992935">(Apr 15 2020 at 07:26)</a>:</h4>
<p>hrydgard <a href="https://github.com/bytecodealliance/wasmtime/pull/1216#issuecomment-613866149" title="https://github.com/bytecodealliance/wasmtime/pull/1216#issuecomment-613866149">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/1216" title="https://github.com/bytecodealliance/wasmtime/pull/1216">Issue #1216</a>:</p>
<blockquote>
<p>Awesome, thanks for getting this done!</p>
</blockquote>



<hr><p>Last updated: Jan 20 2025 at 06:04 UTC</p>
</html>