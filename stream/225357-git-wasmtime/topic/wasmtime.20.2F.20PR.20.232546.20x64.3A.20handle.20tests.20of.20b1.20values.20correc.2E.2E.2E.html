<html>
<head><meta charset="utf-8"><title>wasmtime / PR #2546 x64: handle tests of b1 values correc... · git-wasmtime · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/index.html">git-wasmtime</a></h2>
<h3>Topic: <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232546.20x64.3A.20handle.20tests.20of.20b1.20values.20correc.2E.2E.2E.html">wasmtime / PR #2546 x64: handle tests of b1 values correc...</a></h3>

<hr>

<base href="https://bytecodealliance.zulipchat.com">

<head><link href="https://bytecodealliance.github.io/zulip-archive/style.css" rel="stylesheet"></head>

<a name="221601862"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232546%20x64%3A%20handle%20tests%20of%20b1%20values%20correc.../near/221601862" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232546.20x64.3A.20handle.20tests.20of.20b1.20values.20correc.2E.2E.2E.html#221601862">(Jan 05 2021 at 00:59)</a>:</h4>
<p>cfallin opened <a href="https://github.com/bytecodealliance/wasmtime/pull/2546">PR #2546</a> from <code>fix-b1</code> to <code>main</code>:</p>
<blockquote>
<p>Previously, <code>select</code> and <code>brz</code>/<code>brnz</code> instructions, when given a <code>b1</code><br>
boolean argument, would test whether that boolean argument was nonzero,<br>
rather than whether its LSB was nonzero. Since our invariant for mapping<br>
CLIF state to machine state is that bits beyond the width of a value are<br>
undefined, the proper lowering is to test only the LSB.</p>
<p>(aarch64 does not have the same issue because its <code>Extend</code> pseudoinst<br>
already properly handles masking of b1 values when a zero-extend is<br>
requested, as it is for select/brz/brnz.)</p>
<p>Found by Nathan Ringo on Zulip [1] (thanks!).</p>
<p>[1]<br>
<a href="#narrow/stream/217117-cranelift/topic/bnot.20on.20b1s">https://bytecodealliance.zulipchat.com/#narrow/stream/217117-cranelift/topic/bnot.20on.20b1s</a></p>
<p>&lt;!--</p>
<p>Please ensure that the following steps are all taken care of before submitting<br>
the PR.</p>
<ul>
<li>
<p>[ ] This has been discussed in issue #..., or if not, please tell us why<br>
  here.</p>
</li>
<li>
<p>[ ] A short description of what this does, why it is needed; if the<br>
  description becomes long, the matter should probably be discussed in an issue<br>
  first.</p>
</li>
<li>
<p>[ ] This PR contains test cases, if meaningful.</p>
</li>
<li>[ ] A reviewer from the core maintainer team has been assigned for this PR.<br>
  If you don't know who could review this, please indicate so. The list of<br>
  suggested reviewers on the right can help you.</li>
</ul>
<p>Please ensure all communication adheres to the <a href="https://github.com/bytecodealliance/wasmtime/blob/master/CODE_OF_CONDUCT.md">code of
conduct</a>.<br>
--&gt;<br>
</p>
</blockquote>



<a name="221601863"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232546%20x64%3A%20handle%20tests%20of%20b1%20values%20correc.../near/221601863" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232546.20x64.3A.20handle.20tests.20of.20b1.20values.20correc.2E.2E.2E.html#221601863">(Jan 05 2021 at 00:59)</a>:</h4>
<p><strong>cfallin</strong> requested <a href="https://github.com/abrown">abrown</a> and <a href="https://github.com/bnjbvr">bnjbvr</a> for a review on <a href="https://github.com/bytecodealliance/wasmtime/pull/2546">PR #2546</a>.</p>



<a name="221601864"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232546%20x64%3A%20handle%20tests%20of%20b1%20values%20correc.../near/221601864" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232546.20x64.3A.20handle.20tests.20of.20b1.20values.20correc.2E.2E.2E.html#221601864">(Jan 05 2021 at 00:59)</a>:</h4>
<p><strong>cfallin</strong> requested <a href="https://github.com/abrown">abrown</a> and <a href="https://github.com/bnjbvr">bnjbvr</a> for a review on <a href="https://github.com/bytecodealliance/wasmtime/pull/2546">PR #2546</a>.</p>



<a name="221611705"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232546%20x64%3A%20handle%20tests%20of%20b1%20values%20correc.../near/221611705" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232546.20x64.3A.20handle.20tests.20of.20b1.20values.20correc.2E.2E.2E.html#221611705">(Jan 05 2021 at 04:25)</a>:</h4>
<p>cfallin updated <a href="https://github.com/bytecodealliance/wasmtime/pull/2546">PR #2546</a> from <code>fix-b1</code> to <code>main</code>:</p>
<blockquote>
<p>Previously, <code>select</code> and <code>brz</code>/<code>brnz</code> instructions, when given a <code>b1</code><br>
boolean argument, would test whether that boolean argument was nonzero,<br>
rather than whether its LSB was nonzero. Since our invariant for mapping<br>
CLIF state to machine state is that bits beyond the width of a value are<br>
undefined, the proper lowering is to test only the LSB.</p>
<p>(aarch64 does not have the same issue because its <code>Extend</code> pseudoinst<br>
already properly handles masking of b1 values when a zero-extend is<br>
requested, as it is for select/brz/brnz.)</p>
<p>Found by Nathan Ringo on Zulip [1] (thanks!).</p>
<p>[1]<br>
<a href="#narrow/stream/217117-cranelift/topic/bnot.20on.20b1s">https://bytecodealliance.zulipchat.com/#narrow/stream/217117-cranelift/topic/bnot.20on.20b1s</a></p>
<p>&lt;!--</p>
<p>Please ensure that the following steps are all taken care of before submitting<br>
the PR.</p>
<ul>
<li>
<p>[ ] This has been discussed in issue #..., or if not, please tell us why<br>
  here.</p>
</li>
<li>
<p>[ ] A short description of what this does, why it is needed; if the<br>
  description becomes long, the matter should probably be discussed in an issue<br>
  first.</p>
</li>
<li>
<p>[ ] This PR contains test cases, if meaningful.</p>
</li>
<li>[ ] A reviewer from the core maintainer team has been assigned for this PR.<br>
  If you don't know who could review this, please indicate so. The list of<br>
  suggested reviewers on the right can help you.</li>
</ul>
<p>Please ensure all communication adheres to the <a href="https://github.com/bytecodealliance/wasmtime/blob/master/CODE_OF_CONDUCT.md">code of
conduct</a>.<br>
--&gt;<br>
</p>
</blockquote>



<a name="221650487"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232546%20x64%3A%20handle%20tests%20of%20b1%20values%20correc.../near/221650487" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232546.20x64.3A.20handle.20tests.20of.20b1.20values.20correc.2E.2E.2E.html#221650487">(Jan 05 2021 at 14:20)</a>:</h4>
<p>bnjbvr submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/2546#pullrequestreview-561813524">PR Review</a>.</p>



<a name="221650488"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232546%20x64%3A%20handle%20tests%20of%20b1%20values%20correc.../near/221650488" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232546.20x64.3A.20handle.20tests.20of.20b1.20values.20correc.2E.2E.2E.html#221650488">(Jan 05 2021 at 14:20)</a>:</h4>
<p>bnjbvr submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/2546#pullrequestreview-561813524">PR Review</a>.</p>



<a name="221650489"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232546%20x64%3A%20handle%20tests%20of%20b1%20values%20correc.../near/221650489" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232546.20x64.3A.20handle.20tests.20of.20b1.20values.20correc.2E.2E.2E.html#221650489">(Jan 05 2021 at 14:20)</a>:</h4>
<p>bnjbvr created <a href="https://github.com/bytecodealliance/wasmtime/pull/2546#discussion_r551955132">PR Review Comment</a>:</p>
<blockquote>
<p>Would this read slightly better as <code>if is_cmp { if *size == 1 { 0x80 } else if use_imm8 { 0x83 } else { 0x81 } } else if *size == 1 { 0xf6 } else { 0xf7 }</code> ?</p>
<p>/me also wonders if rustc/llvm can rearrange the order of the comparisons here, so that <code>is_cmp</code> is checked only once in generated code.</p>
</blockquote>



<a name="221650491"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232546%20x64%3A%20handle%20tests%20of%20b1%20values%20correc.../near/221650491" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232546.20x64.3A.20handle.20tests.20of.20b1.20values.20correc.2E.2E.2E.html#221650491">(Jan 05 2021 at 14:20)</a>:</h4>
<p>bnjbvr created <a href="https://github.com/bytecodealliance/wasmtime/pull/2546#discussion_r551955504">PR Review Comment</a>:</p>
<blockquote>
<p>nit: debug_assert_eq! (gives better debug output)</p>
</blockquote>



<a name="221650492"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232546%20x64%3A%20handle%20tests%20of%20b1%20values%20correc.../near/221650492" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232546.20x64.3A.20handle.20tests.20of.20b1.20values.20correc.2E.2E.2E.html#221650492">(Jan 05 2021 at 14:20)</a>:</h4>
<p>bnjbvr created <a href="https://github.com/bytecodealliance/wasmtime/pull/2546#discussion_r551958692">PR Review Comment</a>:</p>
<blockquote>
<p>uber-nit: could be an int or boolean, but the <code>size</code> value matches the type size in this case.</p>
<p>We could in fact use a <code>test</code> instruction against zero here. If so, the whole <code>if</code> can select the immediate to test against, slightly reducing code duplication here.</p>
</blockquote>



<a name="221650493"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232546%20x64%3A%20handle%20tests%20of%20b1%20values%20correc.../near/221650493" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232546.20x64.3A.20handle.20tests.20of.20b1.20values.20correc.2E.2E.2E.html#221650493">(Jan 05 2021 at 14:20)</a>:</h4>
<p>bnjbvr created <a href="https://github.com/bytecodealliance/wasmtime/pull/2546#discussion_r551951830">PR Review Comment</a>:</p>
<blockquote>
<p>Pre-existing: in the above inst definition for <code>CmpRmiR</code>, can you remove <code>/tests</code> from the comment? it's a bit misleading considering the new variant.</p>
</blockquote>



<a name="221650494"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232546%20x64%3A%20handle%20tests%20of%20b1%20values%20correc.../near/221650494" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232546.20x64.3A.20handle.20tests.20of.20b1.20values.20correc.2E.2E.2E.html#221650494">(Jan 05 2021 at 14:20)</a>:</h4>
<p>bnjbvr created <a href="https://github.com/bytecodealliance/wasmtime/pull/2546#discussion_r551958841">PR Review Comment</a>:</p>
<blockquote>
<p>Same remark about using test in both branches here.</p>
</blockquote>



<a name="221650495"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232546%20x64%3A%20handle%20tests%20of%20b1%20values%20correc.../near/221650495" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232546.20x64.3A.20handle.20tests.20of.20b1.20values.20correc.2E.2E.2E.html#221650495">(Jan 05 2021 at 14:20)</a>:</h4>
<p>bnjbvr created <a href="https://github.com/bytecodealliance/wasmtime/pull/2546#discussion_r551957497">PR Review Comment</a>:</p>
<blockquote>
<p>In fact, do we need the new variant <code>TestRmiR</code>? I had in mind that we needed to add new instructions when no other instructions matched the following:</p>
<ul>
<li>regalloc constraints are the same</li>
<li>instruction operands are the same</li>
<li>codegen is (almost) the same</li>
</ul>
<p>In this case, it seems that <code>CmpRmiR</code> has the same behavior for the three above, so we could add one boolean field there meaning <code>is_test</code>, and have one fewer enum variant in return. We can absolutely keep the constructor <code>test_rmi_r</code> though, as an higher-level helper.</p>
</blockquote>



<a name="221650496"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232546%20x64%3A%20handle%20tests%20of%20b1%20values%20correc.../near/221650496" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232546.20x64.3A.20handle.20tests.20of.20b1.20values.20correc.2E.2E.2E.html#221650496">(Jan 05 2021 at 14:20)</a>:</h4>
<p>bnjbvr created <a href="https://github.com/bytecodealliance/wasmtime/pull/2546#discussion_r551959923">PR Review Comment</a>:</p>
<blockquote>
<p>Do you mind duplicating this test for <code>brz</code> please?</p>
</blockquote>



<a name="221710593"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232546%20x64%3A%20handle%20tests%20of%20b1%20values%20correc.../near/221710593" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232546.20x64.3A.20handle.20tests.20of.20b1.20values.20correc.2E.2E.2E.html#221710593">(Jan 05 2021 at 22:30)</a>:</h4>
<p>cfallin updated <a href="https://github.com/bytecodealliance/wasmtime/pull/2546">PR #2546</a> from <code>fix-b1</code> to <code>main</code>:</p>
<blockquote>
<p>Previously, <code>select</code> and <code>brz</code>/<code>brnz</code> instructions, when given a <code>b1</code><br>
boolean argument, would test whether that boolean argument was nonzero,<br>
rather than whether its LSB was nonzero. Since our invariant for mapping<br>
CLIF state to machine state is that bits beyond the width of a value are<br>
undefined, the proper lowering is to test only the LSB.</p>
<p>(aarch64 does not have the same issue because its <code>Extend</code> pseudoinst<br>
already properly handles masking of b1 values when a zero-extend is<br>
requested, as it is for select/brz/brnz.)</p>
<p>Found by Nathan Ringo on Zulip [1] (thanks!).</p>
<p>[1]<br>
<a href="#narrow/stream/217117-cranelift/topic/bnot.20on.20b1s">https://bytecodealliance.zulipchat.com/#narrow/stream/217117-cranelift/topic/bnot.20on.20b1s</a></p>
<p>&lt;!--</p>
<p>Please ensure that the following steps are all taken care of before submitting<br>
the PR.</p>
<ul>
<li>
<p>[ ] This has been discussed in issue #..., or if not, please tell us why<br>
  here.</p>
</li>
<li>
<p>[ ] A short description of what this does, why it is needed; if the<br>
  description becomes long, the matter should probably be discussed in an issue<br>
  first.</p>
</li>
<li>
<p>[ ] This PR contains test cases, if meaningful.</p>
</li>
<li>[ ] A reviewer from the core maintainer team has been assigned for this PR.<br>
  If you don't know who could review this, please indicate so. The list of<br>
  suggested reviewers on the right can help you.</li>
</ul>
<p>Please ensure all communication adheres to the <a href="https://github.com/bytecodealliance/wasmtime/blob/master/CODE_OF_CONDUCT.md">code of
conduct</a>.<br>
--&gt;<br>
</p>
</blockquote>



<a name="221710959"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232546%20x64%3A%20handle%20tests%20of%20b1%20values%20correc.../near/221710959" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232546.20x64.3A.20handle.20tests.20of.20b1.20values.20correc.2E.2E.2E.html#221710959">(Jan 05 2021 at 22:34)</a>:</h4>
<p>cfallin submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/2546#pullrequestreview-562186440">PR Review</a>.</p>



<a name="221710960"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232546%20x64%3A%20handle%20tests%20of%20b1%20values%20correc.../near/221710960" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232546.20x64.3A.20handle.20tests.20of.20b1.20values.20correc.2E.2E.2E.html#221710960">(Jan 05 2021 at 22:34)</a>:</h4>
<p>cfallin created <a href="https://github.com/bytecodealliance/wasmtime/pull/2546#discussion_r552239593">PR Review Comment</a>:</p>
<blockquote>
<p>Yes, that's a better idea -- merged this in and added <code>CmpOpcode::{Test, Cmp}</code>.</p>
</blockquote>



<a name="221710986"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232546%20x64%3A%20handle%20tests%20of%20b1%20values%20correc.../near/221710986" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232546.20x64.3A.20handle.20tests.20of.20b1.20values.20correc.2E.2E.2E.html#221710986">(Jan 05 2021 at 22:35)</a>:</h4>
<p>cfallin submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/2546#pullrequestreview-562186641">PR Review</a>.</p>



<a name="221710987"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232546%20x64%3A%20handle%20tests%20of%20b1%20values%20correc.../near/221710987" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232546.20x64.3A.20handle.20tests.20of.20b1.20values.20correc.2E.2E.2E.html#221710987">(Jan 05 2021 at 22:35)</a>:</h4>
<p>cfallin created <a href="https://github.com/bytecodealliance/wasmtime/pull/2546#discussion_r552239772">PR Review Comment</a>:</p>
<blockquote>
<p>Yes, that is a bit clearer; updated!</p>
</blockquote>



<a name="221711006"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232546%20x64%3A%20handle%20tests%20of%20b1%20values%20correc.../near/221711006" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232546.20x64.3A.20handle.20tests.20of.20b1.20values.20correc.2E.2E.2E.html#221711006">(Jan 05 2021 at 22:35)</a>:</h4>
<p>cfallin submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/2546#pullrequestreview-562186736">PR Review</a>.</p>



<a name="221711007"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232546%20x64%3A%20handle%20tests%20of%20b1%20values%20correc.../near/221711007" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232546.20x64.3A.20handle.20tests.20of.20b1.20values.20correc.2E.2E.2E.html#221711007">(Jan 05 2021 at 22:35)</a>:</h4>
<p>cfallin created <a href="https://github.com/bytecodealliance/wasmtime/pull/2546#discussion_r552239873">PR Review Comment</a>:</p>
<blockquote>
<p>Done.</p>
</blockquote>



<a name="221711210"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232546%20x64%3A%20handle%20tests%20of%20b1%20values%20correc.../near/221711210" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232546.20x64.3A.20handle.20tests.20of.20b1.20values.20correc.2E.2E.2E.html#221711210">(Jan 05 2021 at 22:37)</a>:</h4>
<p>cfallin submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/2546#pullrequestreview-562187988">PR Review</a>.</p>



<a name="221711211"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232546%20x64%3A%20handle%20tests%20of%20b1%20values%20correc.../near/221711211" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232546.20x64.3A.20handle.20tests.20of.20b1.20values.20correc.2E.2E.2E.html#221711211">(Jan 05 2021 at 22:37)</a>:</h4>
<p>cfallin created <a href="https://github.com/bytecodealliance/wasmtime/pull/2546#discussion_r552240967">PR Review Comment</a>:</p>
<blockquote>
<p>Re: the nit -- yes, good point; it could be a wider-than-1-bit bool. I'm not sure what that would mean as an input to a select or brz/brnz, so I've just added an assert that we do not see another bool type in the else-branch.</p>
<p>Re: using <code>test</code> always -- yes, good point; actually <code>test rN, rN</code> is one byte shorter than <code>cmp rN, 0</code> so this is a code-size win too. (<code>rN, rN</code> and not <code>rN, 0</code> because this is an and-op; and 0xff...ff is much larger in emitted code than the R-R form).</p>
</blockquote>



<a name="221711216"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232546%20x64%3A%20handle%20tests%20of%20b1%20values%20correc.../near/221711216" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232546.20x64.3A.20handle.20tests.20of.20b1.20values.20correc.2E.2E.2E.html#221711216">(Jan 05 2021 at 22:37)</a>:</h4>
<p>cfallin submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/2546#pullrequestreview-562188045">PR Review</a>.</p>



<a name="221711217"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232546%20x64%3A%20handle%20tests%20of%20b1%20values%20correc.../near/221711217" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232546.20x64.3A.20handle.20tests.20of.20b1.20values.20correc.2E.2E.2E.html#221711217">(Jan 05 2021 at 22:37)</a>:</h4>
<p>cfallin created <a href="https://github.com/bytecodealliance/wasmtime/pull/2546#discussion_r552241003">PR Review Comment</a>:</p>
<blockquote>
<p>Done!</p>
</blockquote>



<a name="221711224"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232546%20x64%3A%20handle%20tests%20of%20b1%20values%20correc.../near/221711224" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232546.20x64.3A.20handle.20tests.20of.20b1.20values.20correc.2E.2E.2E.html#221711224">(Jan 05 2021 at 22:38)</a>:</h4>
<p>cfallin submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/2546#pullrequestreview-562188095">PR Review</a>.</p>



<a name="221711225"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232546%20x64%3A%20handle%20tests%20of%20b1%20values%20correc.../near/221711225" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232546.20x64.3A.20handle.20tests.20of.20b1.20values.20correc.2E.2E.2E.html#221711225">(Jan 05 2021 at 22:38)</a>:</h4>
<p>cfallin created <a href="https://github.com/bytecodealliance/wasmtime/pull/2546#discussion_r552241042">PR Review Comment</a>:</p>
<blockquote>
<p>Done!</p>
</blockquote>



<a name="221711442"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232546%20x64%3A%20handle%20tests%20of%20b1%20values%20correc.../near/221711442" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232546.20x64.3A.20handle.20tests.20of.20b1.20values.20correc.2E.2E.2E.html#221711442">(Jan 05 2021 at 22:40)</a>:</h4>
<p>cfallin updated <a href="https://github.com/bytecodealliance/wasmtime/pull/2546">PR #2546</a> from <code>fix-b1</code> to <code>main</code>:</p>
<blockquote>
<p>Previously, <code>select</code> and <code>brz</code>/<code>brnz</code> instructions, when given a <code>b1</code><br>
boolean argument, would test whether that boolean argument was nonzero,<br>
rather than whether its LSB was nonzero. Since our invariant for mapping<br>
CLIF state to machine state is that bits beyond the width of a value are<br>
undefined, the proper lowering is to test only the LSB.</p>
<p>(aarch64 does not have the same issue because its <code>Extend</code> pseudoinst<br>
already properly handles masking of b1 values when a zero-extend is<br>
requested, as it is for select/brz/brnz.)</p>
<p>Found by Nathan Ringo on Zulip [1] (thanks!).</p>
<p>[1]<br>
<a href="#narrow/stream/217117-cranelift/topic/bnot.20on.20b1s">https://bytecodealliance.zulipchat.com/#narrow/stream/217117-cranelift/topic/bnot.20on.20b1s</a></p>
<p>&lt;!--</p>
<p>Please ensure that the following steps are all taken care of before submitting<br>
the PR.</p>
<ul>
<li>
<p>[ ] This has been discussed in issue #..., or if not, please tell us why<br>
  here.</p>
</li>
<li>
<p>[ ] A short description of what this does, why it is needed; if the<br>
  description becomes long, the matter should probably be discussed in an issue<br>
  first.</p>
</li>
<li>
<p>[ ] This PR contains test cases, if meaningful.</p>
</li>
<li>[ ] A reviewer from the core maintainer team has been assigned for this PR.<br>
  If you don't know who could review this, please indicate so. The list of<br>
  suggested reviewers on the right can help you.</li>
</ul>
<p>Please ensure all communication adheres to the <a href="https://github.com/bytecodealliance/wasmtime/blob/master/CODE_OF_CONDUCT.md">code of
conduct</a>.<br>
--&gt;<br>
</p>
</blockquote>



<a name="221711714"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232546%20x64%3A%20handle%20tests%20of%20b1%20values%20correc.../near/221711714" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232546.20x64.3A.20handle.20tests.20of.20b1.20values.20correc.2E.2E.2E.html#221711714">(Jan 05 2021 at 22:43)</a>:</h4>
<p>bjorn3 submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/2546#pullrequestreview-562190997">PR Review</a>.</p>



<a name="221711715"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232546%20x64%3A%20handle%20tests%20of%20b1%20values%20correc.../near/221711715" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232546.20x64.3A.20handle.20tests.20of.20b1.20values.20correc.2E.2E.2E.html#221711715">(Jan 05 2021 at 22:43)</a>:</h4>
<p>bjorn3 created <a href="https://github.com/bytecodealliance/wasmtime/pull/2546#discussion_r552243324">PR Review Comment</a>:</p>
<blockquote>
<p>Please revert this. I am pretty sure that cranelif-module doesn't disable default features and as such it would become impossible to use the old backend.</p>
</blockquote>



<a name="221711881"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232546%20x64%3A%20handle%20tests%20of%20b1%20values%20correc.../near/221711881" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232546.20x64.3A.20handle.20tests.20of.20b1.20values.20correc.2E.2E.2E.html#221711881">(Jan 05 2021 at 22:45)</a>:</h4>
<p>cfallin submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/2546#pullrequestreview-562191833">PR Review</a>.</p>



<a name="221711882"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232546%20x64%3A%20handle%20tests%20of%20b1%20values%20correc.../near/221711882" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232546.20x64.3A.20handle.20tests.20of.20b1.20values.20correc.2E.2E.2E.html#221711882">(Jan 05 2021 at 22:45)</a>:</h4>
<p>cfallin created <a href="https://github.com/bytecodealliance/wasmtime/pull/2546#discussion_r552244041">PR Review Comment</a>:</p>
<blockquote>
<p>Eek, this slipped in from local testing. Thanks for catching this.</p>
</blockquote>



<a name="221711915"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232546%20x64%3A%20handle%20tests%20of%20b1%20values%20correc.../near/221711915" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232546.20x64.3A.20handle.20tests.20of.20b1.20values.20correc.2E.2E.2E.html#221711915">(Jan 05 2021 at 22:45)</a>:</h4>
<p>cfallin updated <a href="https://github.com/bytecodealliance/wasmtime/pull/2546">PR #2546</a> from <code>fix-b1</code> to <code>main</code>:</p>
<blockquote>
<p>Previously, <code>select</code> and <code>brz</code>/<code>brnz</code> instructions, when given a <code>b1</code><br>
boolean argument, would test whether that boolean argument was nonzero,<br>
rather than whether its LSB was nonzero. Since our invariant for mapping<br>
CLIF state to machine state is that bits beyond the width of a value are<br>
undefined, the proper lowering is to test only the LSB.</p>
<p>(aarch64 does not have the same issue because its <code>Extend</code> pseudoinst<br>
already properly handles masking of b1 values when a zero-extend is<br>
requested, as it is for select/brz/brnz.)</p>
<p>Found by Nathan Ringo on Zulip [1] (thanks!).</p>
<p>[1]<br>
<a href="#narrow/stream/217117-cranelift/topic/bnot.20on.20b1s">https://bytecodealliance.zulipchat.com/#narrow/stream/217117-cranelift/topic/bnot.20on.20b1s</a></p>
<p>&lt;!--</p>
<p>Please ensure that the following steps are all taken care of before submitting<br>
the PR.</p>
<ul>
<li>
<p>[ ] This has been discussed in issue #..., or if not, please tell us why<br>
  here.</p>
</li>
<li>
<p>[ ] A short description of what this does, why it is needed; if the<br>
  description becomes long, the matter should probably be discussed in an issue<br>
  first.</p>
</li>
<li>
<p>[ ] This PR contains test cases, if meaningful.</p>
</li>
<li>[ ] A reviewer from the core maintainer team has been assigned for this PR.<br>
  If you don't know who could review this, please indicate so. The list of<br>
  suggested reviewers on the right can help you.</li>
</ul>
<p>Please ensure all communication adheres to the <a href="https://github.com/bytecodealliance/wasmtime/blob/master/CODE_OF_CONDUCT.md">code of
conduct</a>.<br>
--&gt;<br>
</p>
</blockquote>



<a name="221711989"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232546%20x64%3A%20handle%20tests%20of%20b1%20values%20correc.../near/221711989" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232546.20x64.3A.20handle.20tests.20of.20b1.20values.20correc.2E.2E.2E.html#221711989">(Jan 05 2021 at 22:46)</a>:</h4>
<p>cfallin submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/2546#pullrequestreview-562192337">PR Review</a>.</p>



<a name="221711990"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232546%20x64%3A%20handle%20tests%20of%20b1%20values%20correc.../near/221711990" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232546.20x64.3A.20handle.20tests.20of.20b1.20values.20correc.2E.2E.2E.html#221711990">(Jan 05 2021 at 22:46)</a>:</h4>
<p>cfallin created <a href="https://github.com/bytecodealliance/wasmtime/pull/2546#discussion_r552244499">PR Review Comment</a>:</p>
<blockquote>
<p>(I think that's why I was newly seeing a warning issue; CI doesn't otherwise check for warnings with non-default options.)</p>
</blockquote>



<a name="221716268"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232546%20x64%3A%20handle%20tests%20of%20b1%20values%20correc.../near/221716268" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232546.20x64.3A.20handle.20tests.20of.20b1.20values.20correc.2E.2E.2E.html#221716268">(Jan 05 2021 at 23:32)</a>:</h4>
<p>cfallin merged <a href="https://github.com/bytecodealliance/wasmtime/pull/2546">PR #2546</a>.</p>



<hr><p>Last updated: Jan 20 2025 at 06:04 UTC</p>
</html>