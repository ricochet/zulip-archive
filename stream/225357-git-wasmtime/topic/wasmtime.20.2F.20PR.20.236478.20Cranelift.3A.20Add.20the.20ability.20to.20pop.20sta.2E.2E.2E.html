<html>
<head><meta charset="utf-8"><title>wasmtime / PR #6478 Cranelift: Add the ability to pop sta... · git-wasmtime · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/index.html">git-wasmtime</a></h2>
<h3>Topic: <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.236478.20Cranelift.3A.20Add.20the.20ability.20to.20pop.20sta.2E.2E.2E.html">wasmtime / PR #6478 Cranelift: Add the ability to pop sta...</a></h3>

<hr>

<base href="https://bytecodealliance.zulipchat.com">

<head><link href="https://bytecodealliance.github.io/zulip-archive/style.css" rel="stylesheet"></head>

<a name="362309908"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%236478%20Cranelift%3A%20Add%20the%20ability%20to%20pop%20sta.../near/362309908" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.236478.20Cranelift.3A.20Add.20the.20ability.20to.20pop.20sta.2E.2E.2E.html#362309908">(May 30 2023 at 22:19)</a>:</h4>
<p>fitzgen opened <a href="https://github.com/bytecodealliance/wasmtime/pull/6478">PR #6478</a> from <code>fitzgen:stack-to-pop-in-ret</code> to <code>bytecodealliance:main</code>:</p>
<blockquote>
<p>This is necessary for implementing callee-pops calling conventions, as is required for tail calls. This is just a small part of tail calls, and doesn't implement everything, but is a good piece to land on its own so that eventual PR isn't so huge.</p>
<p>&lt;!--<br>
Please make sure you include the following information:</p>
<ul>
<li>
<p>If this work has been discussed elsewhere, please include a link to that<br>
  conversation. If it was discussed in an issue, just mention "issue #...".</p>
</li>
<li>
<p>Explain why this change is needed. If the details are in an issue already,<br>
  this can be brief.</p>
</li>
</ul>
<p>Our development process is documented in the Wasmtime book:<br>
<a href="https://docs.wasmtime.dev/contributing-development-process.html">https://docs.wasmtime.dev/contributing-development-process.html</a></p>
<p>Please ensure all communication follows the code of conduct:<br>
<a href="https://github.com/bytecodealliance/wasmtime/blob/main/CODE_OF_CONDUCT.md">https://github.com/bytecodealliance/wasmtime/blob/main/CODE_OF_CONDUCT.md</a><br>
--&gt;</p>
</blockquote>



<a name="362309911"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%236478%20Cranelift%3A%20Add%20the%20ability%20to%20pop%20sta.../near/362309911" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.236478.20Cranelift.3A.20Add.20the.20ability.20to.20pop.20sta.2E.2E.2E.html#362309911">(May 30 2023 at 22:19)</a>:</h4>
<p><strong>fitzgen</strong> requested <a href="https://github.com/cfallin">cfallin</a> for a review on <a href="https://github.com/bytecodealliance/wasmtime/pull/6478">PR #6478</a>.</p>



<a name="362309912"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%236478%20Cranelift%3A%20Add%20the%20ability%20to%20pop%20sta.../near/362309912" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.236478.20Cranelift.3A.20Add.20the.20ability.20to.20pop.20sta.2E.2E.2E.html#362309912">(May 30 2023 at 22:19)</a>:</h4>
<p><strong>fitzgen</strong> requested <a href="https://github.com/orgs/bytecodealliance/teams/wasmtime-compiler-reviewers">wasmtime-compiler-reviewers</a> for a review on <a href="https://github.com/bytecodealliance/wasmtime/pull/6478">PR #6478</a>.</p>



<a name="362309932"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%236478%20Cranelift%3A%20Add%20the%20ability%20to%20pop%20sta.../near/362309932" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.236478.20Cranelift.3A.20Add.20the.20ability.20to.20pop.20sta.2E.2E.2E.html#362309932">(May 30 2023 at 22:19)</a>:</h4>
<p>fitzgen edited <a href="https://github.com/bytecodealliance/wasmtime/pull/6478">PR #6478</a>:</p>
<blockquote>
<p>This is necessary for implementing callee-pops calling conventions, as is required for tail calls. This is just a small part of tail calls, and doesn't implement everything, but is a good piece to land on its own so that eventual PR isn't so huge. Just trying to shrink the yak stack.</p>
<p>&lt;!--<br>
Please make sure you include the following information:</p>
<ul>
<li>
<p>If this work has been discussed elsewhere, please include a link to that<br>
  conversation. If it was discussed in an issue, just mention "issue #...".</p>
</li>
<li>
<p>Explain why this change is needed. If the details are in an issue already,<br>
  this can be brief.</p>
</li>
</ul>
<p>Our development process is documented in the Wasmtime book:<br>
<a href="https://docs.wasmtime.dev/contributing-development-process.html">https://docs.wasmtime.dev/contributing-development-process.html</a></p>
<p>Please ensure all communication follows the code of conduct:<br>
<a href="https://github.com/bytecodealliance/wasmtime/blob/main/CODE_OF_CONDUCT.md">https://github.com/bytecodealliance/wasmtime/blob/main/CODE_OF_CONDUCT.md</a><br>
--&gt;</p>
</blockquote>



<a name="362311269"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%236478%20Cranelift%3A%20Add%20the%20ability%20to%20pop%20sta.../near/362311269" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.236478.20Cranelift.3A.20Add.20the.20ability.20to.20pop.20sta.2E.2E.2E.html#362311269">(May 30 2023 at 22:30)</a>:</h4>
<p>cfallin submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/6478#pullrequestreview-1451917241">PR review</a>:</p>
<blockquote>
<p>Looks great; thanks for splitting this out!</p>
<p>One thought on the pseudo-assembly printing in VCode (for aarch64 but similar thoughts on riscv64); and one request for a bit more in a doc-comment; but otherwise LGTM.</p>
</blockquote>



<a name="362311274"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%236478%20Cranelift%3A%20Add%20the%20ability%20to%20pop%20sta.../near/362311274" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.236478.20Cranelift.3A.20Add.20the.20ability.20to.20pop.20sta.2E.2E.2E.html#362311274">(May 30 2023 at 22:30)</a>:</h4>
<p>cfallin submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/6478#pullrequestreview-1451917241">PR review</a>:</p>
<blockquote>
<p>Looks great; thanks for splitting this out!</p>
<p>One thought on the pseudo-assembly printing in VCode (for aarch64 but similar thoughts on riscv64); and one request for a bit more in a doc-comment; but otherwise LGTM.</p>
</blockquote>



<a name="362311284"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%236478%20Cranelift%3A%20Add%20the%20ability%20to%20pop%20sta.../near/362311284" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.236478.20Cranelift.3A.20Add.20the.20ability.20to.20pop.20sta.2E.2E.2E.html#362311284">(May 30 2023 at 22:30)</a>:</h4>
<p>cfallin created <a href="https://github.com/bytecodealliance/wasmtime/pull/6478#discussion_r1210884589">PR review comment</a>:</p>
<blockquote>
<p>Rather than print a pseudo-inst here, could we print e.g. `add sp, sp, #imm ; ret" or similar?</p>
</blockquote>



<a name="362311286"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%236478%20Cranelift%3A%20Add%20the%20ability%20to%20pop%20sta.../near/362311286" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.236478.20Cranelift.3A.20Add.20the.20ability.20to.20pop.20sta.2E.2E.2E.html#362311286">(May 30 2023 at 22:30)</a>:</h4>
<p>cfallin created <a href="https://github.com/bytecodealliance/wasmtime/pull/6478#discussion_r1210885834">PR review comment</a>:</p>
<blockquote>
<p>"At the same time as returning" is slightly ambiguous: does the pop happen logically just before popping the return address, or just after? (I think after?) A diagram of the stack before-and-after might be helpful actually, if it's not too much trouble to draw one quickly!</p>
</blockquote>



<a name="362324472"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%236478%20Cranelift%3A%20Add%20the%20ability%20to%20pop%20sta.../near/362324472" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.236478.20Cranelift.3A.20Add.20the.20ability.20to.20pop.20sta.2E.2E.2E.html#362324472">(May 31 2023 at 00:52)</a>:</h4>
<p>jameysharp created <a href="https://github.com/bytecodealliance/wasmtime/pull/6478#discussion_r1210973695">PR review comment</a>:</p>
<blockquote>
<p>The exact sequence of events is target-specific. The return address may not be on the stack at all by the time we get to the return instruction; x86 is the only target we support where <code>ret</code> pops an address off the stack for you. So yes, on x86 this emits an instruction which first pops the return address, and then removes the arguments from the caller's frame. Everywhere else, the return address is in a register by that point. So we can emit separate instructions to adjust the stack pointer and then branch through the appropriate register.</p>
</blockquote>



<a name="362508722"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%236478%20Cranelift%3A%20Add%20the%20ability%20to%20pop%20sta.../near/362508722" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.236478.20Cranelift.3A.20Add.20the.20ability.20to.20pop.20sta.2E.2E.2E.html#362508722">(May 31 2023 at 16:25)</a>:</h4>
<p>fitzgen updated <a href="https://github.com/bytecodealliance/wasmtime/pull/6478">PR #6478</a>.</p>



<a name="362514448"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%236478%20Cranelift%3A%20Add%20the%20ability%20to%20pop%20sta.../near/362514448" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.236478.20Cranelift.3A.20Add.20the.20ability.20to.20pop.20sta.2E.2E.2E.html#362514448">(May 31 2023 at 16:48)</a>:</h4>
<p>fitzgen updated <a href="https://github.com/bytecodealliance/wasmtime/pull/6478">PR #6478</a>.</p>



<a name="362514490"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%236478%20Cranelift%3A%20Add%20the%20ability%20to%20pop%20sta.../near/362514490" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.236478.20Cranelift.3A.20Add.20the.20ability.20to.20pop.20sta.2E.2E.2E.html#362514490">(May 31 2023 at 16:48)</a>:</h4>
<p>fitzgen has enabled auto merge for <a href="https://github.com/bytecodealliance/wasmtime/pull/6478">PR #6478</a>.</p>



<a name="362514887"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%236478%20Cranelift%3A%20Add%20the%20ability%20to%20pop%20sta.../near/362514887" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.236478.20Cranelift.3A.20Add.20the.20ability.20to.20pop.20sta.2E.2E.2E.html#362514887">(May 31 2023 at 16:50)</a>:</h4>
<p>cfallin created <a href="https://github.com/bytecodealliance/wasmtime/pull/6478#discussion_r1212021003">PR review comment</a>:</p>
<blockquote>
<p>Unresolving -- this could still use a diagram or better description in the comment, I think.</p>
<p>The sequencing question is really about the order of items on the stack: are the additionally-popped items <em>before</em> (below) the return address or <em>after</em> (above)? I think the latter, but I have to think about it to come to that conclusion by reasoning through it; I'd prefer for it to be clear in the comment here.</p>
</blockquote>



<a name="362515316"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%236478%20Cranelift%3A%20Add%20the%20ability%20to%20pop%20sta.../near/362515316" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.236478.20Cranelift.3A.20Add.20the.20ability.20to.20pop.20sta.2E.2E.2E.html#362515316">(May 31 2023 at 16:51)</a>:</h4>
<p>cfallin created <a href="https://github.com/bytecodealliance/wasmtime/pull/6478#discussion_r1212023096">PR review comment</a>:</p>
<blockquote>
<p>Ah, I see the just-pushed commit does resolve the ambiguity, so I'm happy now!</p>
</blockquote>



<a name="362544765"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%236478%20Cranelift%3A%20Add%20the%20ability%20to%20pop%20sta.../near/362544765" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.236478.20Cranelift.3A.20Add.20the.20ability.20to.20pop.20sta.2E.2E.2E.html#362544765">(May 31 2023 at 18:50)</a>:</h4>
<p>fitzgen updated <a href="https://github.com/bytecodealliance/wasmtime/pull/6478">PR #6478</a>.</p>



<a name="362796041"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%236478%20Cranelift%3A%20Add%20the%20ability%20to%20pop%20sta.../near/362796041" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.236478.20Cranelift.3A.20Add.20the.20ability.20to.20pop.20sta.2E.2E.2E.html#362796041">(Jun 01 2023 at 15:30)</a>:</h4>
<p>fitzgen updated <a href="https://github.com/bytecodealliance/wasmtime/pull/6478">PR #6478</a>.</p>



<a name="362811022"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%236478%20Cranelift%3A%20Add%20the%20ability%20to%20pop%20sta.../near/362811022" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.236478.20Cranelift.3A.20Add.20the.20ability.20to.20pop.20sta.2E.2E.2E.html#362811022">(Jun 01 2023 at 16:17)</a>:</h4>
<p>bjorn3 created <a href="https://github.com/bytecodealliance/wasmtime/pull/6478#discussion_r1213394863">PR review comment</a>:</p>
<blockquote>
<p>Less commonly used instructions from the 16bit x86 era can be slower than writing multiple simpler instructions. Does this also apply to <code>retn</code> or is it just as fast as <code>add rsp, n</code> + <code>ret</code>?</p>
</blockquote>



<a name="362813989"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%236478%20Cranelift%3A%20Add%20the%20ability%20to%20pop%20sta.../near/362813989" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.236478.20Cranelift.3A.20Add.20the.20ability.20to.20pop.20sta.2E.2E.2E.html#362813989">(Jun 01 2023 at 16:27)</a>:</h4>
<p>cfallin created <a href="https://github.com/bytecodealliance/wasmtime/pull/6478#discussion_r1213406464">PR review comment</a>:</p>
<blockquote>
<p>According to <a href="https://www.agner.org/optimize/instruction_tables.pdf">Agner Fog's instruction tables</a>, and picking a random semi-recent microarchitecture (Skylake), <code>ret</code> and <code>ret imm</code> are both 2 µops; the latter has a throughput of 0.5 per cycle, the former 1 per cycle. So it looks like there's a tiny penalty but it's no worse than rearranging the stack manually. (And keep in mind that the popped data is <em>above</em> the return address, so one would need to load that, store it higher up, move rsp, and <code>ret</code>; the store alone in that sequence would kill the perf advantage.)</p>
</blockquote>



<a name="362814179"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%236478%20Cranelift%3A%20Add%20the%20ability%20to%20pop%20sta.../near/362814179" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.236478.20Cranelift.3A.20Add.20the.20ability.20to.20pop.20sta.2E.2E.2E.html#362814179">(Jun 01 2023 at 16:28)</a>:</h4>
<p>fitzgen created <a href="https://github.com/bytecodealliance/wasmtime/pull/6478#discussion_r1213407189">PR review comment</a>:</p>
<blockquote>
<p><code>add rsp, n; ret</code> isn't equivalent because the return address must be on top of the stack in both cases. That is, <code>ret n</code> pops the RA and <em>then</em> pops <code>n</code> bytes.</p>
<p>So I don't know if it is actually slower or not, but it is not semantically equivalent, so the point is moot to some degree.</p>
<p>The actual alternative would be something like</p>
<div class="codehilite"><pre><span></span><code>mov tmp, [rsp]
add rsp, n
mov [rsp], tmp
ret
</code></pre></div>

<p>I kind of doubt that is any better than <code>ret n</code>, but it is certainly possible. Would be interesting to see what LLVM does here.</p>
</blockquote>



<a name="362814394"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%236478%20Cranelift%3A%20Add%20the%20ability%20to%20pop%20sta.../near/362814394" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.236478.20Cranelift.3A.20Add.20the.20ability.20to.20pop.20sta.2E.2E.2E.html#362814394">(Jun 01 2023 at 16:29)</a>:</h4>
<p>cfallin edited <a href="https://github.com/bytecodealliance/wasmtime/pull/6478#discussion_r1213406464">PR review comment</a>.</p>



<a name="362817780"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%236478%20Cranelift%3A%20Add%20the%20ability%20to%20pop%20sta.../near/362817780" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.236478.20Cranelift.3A.20Add.20the.20ability.20to.20pop.20sta.2E.2E.2E.html#362817780">(Jun 01 2023 at 16:39)</a>:</h4>
<p>fitzgen merged <a href="https://github.com/bytecodealliance/wasmtime/pull/6478">PR #6478</a>.</p>



<a name="362818266"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%236478%20Cranelift%3A%20Add%20the%20ability%20to%20pop%20sta.../near/362818266" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.236478.20Cranelift.3A.20Add.20the.20ability.20to.20pop.20sta.2E.2E.2E.html#362818266">(Jun 01 2023 at 16:41)</a>:</h4>
<p>cfallin created <a href="https://github.com/bytecodealliance/wasmtime/pull/6478#discussion_r1213421553">PR review comment</a>:</p>
<blockquote>
<p>I did a fun little <a href="https://gist.github.com/cfallin/7721bdd36975232c65611569c2f333d0">experiment</a> with a <code>ret imm</code> implementation, a "move the return address and <code>ret</code>" implementation, and a "load the return address, manually pop, and jump-indirect" implementation.</p>
<p>On my system (Zen 2 core, Ryzen 3900X) the first two have identical performance, and the last is 25% faster. Huh!</p>
<p>I sort of suspect what's happening here is:</p>
<ul>
<li>With enough spare pipeline capacity, the store of the return address in the new location is "free", and the memory-renaming that Zen is known to do (tracking constant offsets of rsp stored from registers and using that register directly) eliminate a critical path on re-loading the RA as part of <code>ret</code>.</li>
<li>With only one returned-to address in this microbenchmark, the <code>jmp rdi</code> is trivial for the indirect predictor to get right; but this example will overflow the return-stack predictor and so in a real program it would do poorly.</li>
<li>In other words, this is kind of hard to test without having a "real program" surrounding it.</li>
</ul>
<p>Anyway it's sort of getting into the weeds and <code>ret imm</code> isn't obviously worse so I think we should keep this until/unless we discover it becoming a bottleneck.</p>
</blockquote>



<a name="362882558"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%236478%20Cranelift%3A%20Add%20the%20ability%20to%20pop%20sta.../near/362882558" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.236478.20Cranelift.3A.20Add.20the.20ability.20to.20pop.20sta.2E.2E.2E.html#362882558">(Jun 01 2023 at 21:13)</a>:</h4>
<p>bjorn3 created <a href="https://github.com/bytecodealliance/wasmtime/pull/6478#discussion_r1213686672">PR review comment</a>:</p>
<blockquote>
<p>Makes sense. I didn't know that <code>ret imm</code> would move the stack pointer after reading the return address.</p>
</blockquote>



<hr><p>Last updated: Jan 20 2025 at 06:04 UTC</p>
</html>