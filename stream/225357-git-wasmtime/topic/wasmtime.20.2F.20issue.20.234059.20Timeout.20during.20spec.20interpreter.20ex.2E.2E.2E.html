<html>
<head><meta charset="utf-8"><title>wasmtime / issue #4059 Timeout during spec interpreter ex... · git-wasmtime · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/index.html">git-wasmtime</a></h2>
<h3>Topic: <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.234059.20Timeout.20during.20spec.20interpreter.20ex.2E.2E.2E.html">wasmtime / issue #4059 Timeout during spec interpreter ex...</a></h3>

<hr>

<base href="https://bytecodealliance.zulipchat.com">

<head><link href="https://bytecodealliance.github.io/zulip-archive/style.css" rel="stylesheet"></head>

<a name="279596234"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%234059%20Timeout%20during%20spec%20interpreter%20ex.../near/279596234" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.234059.20Timeout.20during.20spec.20interpreter.20ex.2E.2E.2E.html#279596234">(Apr 20 2022 at 20:05)</a>:</h4>
<p>alexcrichton opened <a href="https://github.com/bytecodealliance/wasmtime/issues/4059">issue #4059</a>:</p>
<blockquote>
<p>We hit a fuzz bug just now where the spec interpreter is timing out the fuzz test case when wasmtime looks to execute the wasm in under a second, so I'm opening this to track investigation into the spec interpreter to see if there's perhaps some performance wins to gain there.</p>
<ul>
<li><a href="https://github.com/bytecodealliance/wasmtime/files/8524996/testcase0.wasm.gz">wasm</a></li>
<li><a href="https://github.com/bytecodealliance/wasmtime/files/8524997/input.gz">fuzz input (gzipped)</a></li>
</ul>
<p>cc @conrad-watt </p>
</blockquote>



<a name="279596246"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%234059%20Timeout%20during%20spec%20interpreter%20ex.../near/279596246" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.234059.20Timeout.20during.20spec.20interpreter.20ex.2E.2E.2E.html#279596246">(Apr 20 2022 at 20:05)</a>:</h4>
<p>alexcrichton labeled <a href="https://github.com/bytecodealliance/wasmtime/issues/4059">issue #4059</a>:</p>
<blockquote>
<p>We hit a fuzz bug just now where the spec interpreter is timing out the fuzz test case when wasmtime looks to execute the wasm in under a second, so I'm opening this to track investigation into the spec interpreter to see if there's perhaps some performance wins to gain there.</p>
<ul>
<li><a href="https://github.com/bytecodealliance/wasmtime/files/8524996/testcase0.wasm.gz">wasm</a></li>
<li><a href="https://github.com/bytecodealliance/wasmtime/files/8524997/input.gz">fuzz input (gzipped)</a></li>
</ul>
<p>cc @conrad-watt </p>
</blockquote>



<a name="279596423"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%234059%20Timeout%20during%20spec%20interpreter%20ex.../near/279596423" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.234059.20Timeout.20during.20spec.20interpreter.20ex.2E.2E.2E.html#279596423">(Apr 20 2022 at 20:07)</a>:</h4>
<p>alexcrichton <a href="https://github.com/bytecodealliance/wasmtime/issues/4059#issuecomment-1104410696">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/4059">issue #4059</a>:</p>
<blockquote>
<p>Ah and for reference locally the spec interpreter is taking ~1 minute. I'm not entirely sure how to profile ocaml but perf is reporting:</p>
<p>&lt;img width="704" alt="Screen Shot 2022-04-20 at 3 06 56 PM" src="<a href="https://user-images.githubusercontent.com/64996/164313995-d7c14c0c-c702-4f15-8731-279d5b5ac58d.png">https://user-images.githubusercontent.com/64996/164313995-d7c14c0c-c702-4f15-8731-279d5b5ac58d.png</a>"&gt;</p>
</blockquote>



<a name="279598484"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%234059%20Timeout%20during%20spec%20interpreter%20ex.../near/279598484" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.234059.20Timeout.20during.20spec.20interpreter.20ex.2E.2E.2E.html#279598484">(Apr 20 2022 at 20:24)</a>:</h4>
<p>conrad-watt <a href="https://github.com/bytecodealliance/wasmtime/issues/4059#issuecomment-1104425128">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/4059">issue #4059</a>:</p>
<blockquote>
<p>Ah, interesting. The formal model's implementations of <code>reinterpret</code> and <code>popcnt</code> are particularly inefficient (still a constant factor only), and it looks like this test calls a whole bunch of them. I'll dig into this on my side, but do you see a big difference in the (forked) spec interpreter's runtime locally when providing/not providing the <code>-isa</code> flag?</p>
</blockquote>



<a name="279598743"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%234059%20Timeout%20during%20spec%20interpreter%20ex.../near/279598743" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.234059.20Timeout.20during.20spec.20interpreter.20ex.2E.2E.2E.html#279598743">(Apr 20 2022 at 20:27)</a>:</h4>
<p>alexcrichton <a href="https://github.com/bytecodealliance/wasmtime/issues/4059#issuecomment-1104427096">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/4059">issue #4059</a>:</p>
<blockquote>
<p>Ah sorry I'm not super familiar with running the interpreter outside the fuzzer itself, can you clarify what you mean by the <code>-isa</code> flag?</p>
</blockquote>



<a name="279599414"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%234059%20Timeout%20during%20spec%20interpreter%20ex.../near/279599414" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.234059.20Timeout.20during.20spec.20interpreter.20ex.2E.2E.2E.html#279599414">(Apr 20 2022 at 20:33)</a>:</h4>
<p>conrad-watt <a href="https://github.com/bytecodealliance/wasmtime/issues/4059#issuecomment-1104431577">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/4059">issue #4059</a>:</p>
<blockquote>
<p>Ah sorry, if it's any trouble, I can look myself later (not at my workstation right now).</p>
<p>When running the spec interpreter from the command line, the invocation normally looks like</p>
<p><code>./bin-name -i file-name</code></p>
<p>this runs the reference interpreter (more or less) unchanged from the main repository</p>
<p>if you instead run</p>
<p><code>./bin-name -isa -i file-name</code></p>
<p>it runs using my formal model</p>
<p>if it runs much slower with the <code>-isa</code> flag provided, that suggests the culprit is my slow implementation of <code>reinterpret</code> and <code>popcnt</code>.</p>
</blockquote>



<a name="279599552"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%234059%20Timeout%20during%20spec%20interpreter%20ex.../near/279599552" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.234059.20Timeout.20during.20spec.20interpreter.20ex.2E.2E.2E.html#279599552">(Apr 20 2022 at 20:34)</a>:</h4>
<p>conrad-watt edited a <a href="https://github.com/bytecodealliance/wasmtime/issues/4059#issuecomment-1104431577">comment</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/4059">issue #4059</a>:</p>
<blockquote>
<p>Ah sorry, if it's any trouble, I can look myself later (not at my workstation right now).</p>
<p>When running the spec interpreter from the command line, the invocation normally looks like</p>
<p><code>./bin-name -i file-name</code></p>
<p>this runs the reference interpreter (more or less) unchanged from the main repository</p>
<p>if you instead run</p>
<p><code>./bin-name -isa -i file-name</code></p>
<p>it runs using my formal model (this flag is only implemented in my fork)</p>
<p>if it runs much slower with the <code>-isa</code> flag provided, that suggests the culprit is my slow implementation of <code>reinterpret</code> and <code>popcnt</code>.</p>
</blockquote>



<a name="279599872"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%234059%20Timeout%20during%20spec%20interpreter%20ex.../near/279599872" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.234059.20Timeout.20during.20spec.20interpreter.20ex.2E.2E.2E.html#279599872">(Apr 20 2022 at 20:37)</a>:</h4>
<p>conrad-watt edited a <a href="https://github.com/bytecodealliance/wasmtime/issues/4059#issuecomment-1104431577">comment</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/4059">issue #4059</a>:</p>
<blockquote>
<p>Ah sorry, if it's any trouble, I can look myself later (not at my workstation right now).</p>
<p>When running the spec interpreter from the command line, the invocation normally looks like</p>
<p><code>./exe-name -i file-name</code></p>
<p>this runs the reference interpreter (more or less) unchanged from the main repository</p>
<p>if you instead run</p>
<p><code>./exe-name -isa -i file-name</code></p>
<p>it runs using my formal model (this flag is only implemented in my fork)</p>
<p>if it runs much slower with the <code>-isa</code> flag provided, that suggests the culprit is my slow implementation of <code>reinterpret</code> and <code>popcnt</code>.</p>
</blockquote>



<a name="279600291"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%234059%20Timeout%20during%20spec%20interpreter%20ex.../near/279600291" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.234059.20Timeout.20during.20spec.20interpreter.20ex.2E.2E.2E.html#279600291">(Apr 20 2022 at 20:41)</a>:</h4>
<p>alexcrichton <a href="https://github.com/bytecodealliance/wasmtime/issues/4059#issuecomment-1104437328">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/4059">issue #4059</a>:</p>
<blockquote>
<p>Ah ok makes sense! </p>
<p>Looks like the default spec interpreter executes this in 0.8s, and the <code>-isa</code> flag runs in 74s</p>
<p>I used this small script to execute the interpreter:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="n">expr</span><span class="o">=</span><span class="s">"(assert_return (invoke </span><span class="se">\"\"</span><span class="s">"</span><span class="w"></span>
<span class="k">for</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="err">`</span><span class="n">seq</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="mi">19</span><span class="err">`</span><span class="p">;</span><span class="w"> </span><span class="kr">do</span><span class="w"></span>
<span class="w">  </span><span class="n">expr</span><span class="o">=</span><span class="s">"$expr (f32.const 0)"</span><span class="w"></span>
<span class="n">done</span><span class="w"></span>
<span class="n">expr</span><span class="o">=</span><span class="s">"$expr) (f32.const 0))"</span><span class="w"></span>
<span class="n">time</span><span class="w"> </span><span class="p">.</span><span class="o">/</span><span class="n">wasm</span><span class="w"> </span><span class="o">-</span><span class="n">i</span><span class="w"> </span><span class="cp">$HOME</span><span class="o">/</span><span class="n">code</span><span class="o">/</span><span class="n">wasmtime</span><span class="o">/</span><span class="n">testcase0</span><span class="p">.</span><span class="n">wasm</span><span class="w"> </span><span class="o">-</span><span class="n">e</span><span class="w"> </span><span class="s">"$expr"</span><span class="w"></span>
<span class="n">time</span><span class="w"> </span><span class="p">.</span><span class="o">/</span><span class="n">wasm</span><span class="w"> </span><span class="o">-</span><span class="n">isa</span><span class="w"> </span><span class="o">-</span><span class="n">i</span><span class="w"> </span><span class="cp">$HOME</span><span class="o">/</span><span class="n">code</span><span class="o">/</span><span class="n">wasmtime</span><span class="o">/</span><span class="n">testcase0</span><span class="p">.</span><span class="n">wasm</span><span class="w"> </span><span class="o">-</span><span class="n">e</span><span class="w"> </span><span class="s">"$expr"</span><span class="w"></span>
</code></pre></div>
<p>Also to clarify it's not urgent to fix this, just wanted to log this as the fuzz bug came in</p>
</blockquote>



<a name="279600311"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%234059%20Timeout%20during%20spec%20interpreter%20ex.../near/279600311" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.234059.20Timeout.20during.20spec.20interpreter.20ex.2E.2E.2E.html#279600311">(Apr 20 2022 at 20:41)</a>:</h4>
<p>conrad-watt edited a <a href="https://github.com/bytecodealliance/wasmtime/issues/4059#issuecomment-1104431577">comment</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/4059">issue #4059</a>:</p>
<blockquote>
<p>Ah sorry, if it's any trouble, I can look myself later (not at my workstation right now).</p>
<p>When running the spec interpreter from the command line, the invocation normally looks like</p>
<p><code>./exe-name -i file-name</code></p>
<p>this runs the reference interpreter (more or less) unchanged from the main repository</p>
<p>if you instead run</p>
<p><code>./exe-name -isa -i file-name</code></p>
<p>it runs using my formal model (this flag is only implemented in my fork)</p>
<p>if it runs much slower with the <code>-isa</code> flag provided, that suggests the culprit is my slow implementation of <code>reinterpret</code> and <code>popcnt</code>.</p>
<p>EDIT: I should clarify that the fuzzer is only set up to run using the formal model path right now</p>
</blockquote>



<a name="280291468"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%234059%20Timeout%20during%20spec%20interpreter%20ex.../near/280291468" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.234059.20Timeout.20during.20spec.20interpreter.20ex.2E.2E.2E.html#280291468">(Apr 27 2022 at 00:52)</a>:</h4>
<p>conrad-watt <a href="https://github.com/bytecodealliance/wasmtime/issues/4059#issuecomment-1110397137">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/4059">issue #4059</a>:</p>
<blockquote>
<p>Just to flag up - I've identified a fix, but I'm currently dealing with an unrelated deadline, so I'll probably make a PR late next week.</p>
</blockquote>



<a name="281705706"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%234059%20Timeout%20during%20spec%20interpreter%20ex.../near/281705706" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.234059.20Timeout.20during.20spec.20interpreter.20ex.2E.2E.2E.html#281705706">(May 09 2022 at 15:58)</a>:</h4>
<p>conrad-watt <a href="https://github.com/bytecodealliance/wasmtime/issues/4059#issuecomment-1121284754">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/4059">issue #4059</a>:</p>
<blockquote>
<p>With the fix in <a href="https://github.com/bytecodealliance/wasmtime/pull/4113">https://github.com/bytecodealliance/wasmtime/pull/4113</a>, the Isabelle-based interpreter seems to (thankfully!) outperform the base spec interpreter on this example. As I feared, the culprit was <code>popcnt</code>'s performance. As I mention in that PR, there are a few more ops which could currently cause similar timeouts if a fuzz test is heavily weighted towards them, so I'll work on fixing those next.</p>
</blockquote>



<a name="281707492"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%234059%20Timeout%20during%20spec%20interpreter%20ex.../near/281707492" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.234059.20Timeout.20during.20spec.20interpreter.20ex.2E.2E.2E.html#281707492">(May 09 2022 at 16:10)</a>:</h4>
<p>alexcrichton <a href="https://github.com/bytecodealliance/wasmtime/issues/4059#issuecomment-1121298426">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/4059">issue #4059</a>:</p>
<blockquote>
<p>Sounds good! I'll ping here if we get a concrete test case but otherwise I'm gonna go ahead and close this since the fuzz bug in question is now fixed. </p>
</blockquote>



<a name="281707494"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%234059%20Timeout%20during%20spec%20interpreter%20ex.../near/281707494" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.234059.20Timeout.20during.20spec.20interpreter.20ex.2E.2E.2E.html#281707494">(May 09 2022 at 16:10)</a>:</h4>
<p>alexcrichton closed <a href="https://github.com/bytecodealliance/wasmtime/issues/4059">issue #4059</a>:</p>
<blockquote>
<p>We hit a fuzz bug just now where the spec interpreter is timing out the fuzz test case when wasmtime looks to execute the wasm in under a second, so I'm opening this to track investigation into the spec interpreter to see if there's perhaps some performance wins to gain there.</p>
<ul>
<li><a href="https://github.com/bytecodealliance/wasmtime/files/8524996/testcase0.wasm.gz">wasm</a></li>
<li><a href="https://github.com/bytecodealliance/wasmtime/files/8524997/input.gz">fuzz input (gzipped)</a></li>
</ul>
<p>cc @conrad-watt </p>
</blockquote>



<hr><p>Last updated: Jan 20 2025 at 06:04 UTC</p>
</html>