<html>
<head><meta charset="utf-8"><title>wasmtime / Issue #2278 Introduce the Cranelift IR instruc... · git-wasmtime · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/index.html">git-wasmtime</a></h2>
<h3>Topic: <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20Issue.20.232278.20Introduce.20the.20Cranelift.20IR.20instruc.2E.2E.2E.html">wasmtime / Issue #2278 Introduce the Cranelift IR instruc...</a></h3>

<hr>

<base href="https://bytecodealliance.zulipchat.com">

<head><link href="https://bytecodealliance.github.io/zulip-archive/style.css" rel="stylesheet"></head>

<a name="212614038"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20Issue%20%232278%20Introduce%20the%20Cranelift%20IR%20instruc.../near/212614038" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20Issue.20.232278.20Introduce.20the.20Cranelift.20IR.20instruc.2E.2E.2E.html#212614038">(Oct 07 2020 at 20:19)</a>:</h4>
<p>abrown <a href="https://github.com/bytecodealliance/wasmtime/pull/2278#issuecomment-705171644">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/2278">Issue #2278</a>:</p>
<blockquote>
<blockquote>
<p>@abrown, would you be willing to help with this (and then we can land it all at once)?</p>
</blockquote>
<p>Yes, but I might not get around to it until next week? If the delay is not a problem, I don't mind doing that so that the issue is resolved all at once. (I think I can push to this PR, right?)</p>
</blockquote>



<a name="212621871"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20Issue%20%232278%20Introduce%20the%20Cranelift%20IR%20instruc.../near/212621871" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20Issue.20.232278.20Introduce.20the.20Cranelift.20IR.20instruc.2E.2E.2E.html#212621871">(Oct 07 2020 at 21:30)</a>:</h4>
<p>cfallin <a href="https://github.com/bytecodealliance/wasmtime/pull/2278#issuecomment-705204996">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/2278">Issue #2278</a>:</p>
<blockquote>
<p>That sounds fine to me at least!</p>
</blockquote>



<a name="212707412"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20Issue%20%232278%20Introduce%20the%20Cranelift%20IR%20instruc.../near/212707412" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20Issue.20.232278.20Introduce.20the.20Cranelift.20IR.20instruc.2E.2E.2E.html#212707412">(Oct 08 2020 at 15:30)</a>:</h4>
<p>akirilov-arm <a href="https://github.com/bytecodealliance/wasmtime/pull/2278#issuecomment-705648274">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/2278">Issue #2278</a>:</p>
<blockquote>
<p>I don't mind a one week delay either.</p>
</blockquote>



<a name="212823704"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20Issue%20%232278%20Introduce%20the%20Cranelift%20IR%20instruc.../near/212823704" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20Issue.20.232278.20Introduce.20the.20Cranelift.20IR.20instruc.2E.2E.2E.html#212823704">(Oct 09 2020 at 13:15)</a>:</h4>
<p>akirilov-arm <a href="https://github.com/bytecodealliance/wasmtime/pull/2278#issuecomment-706173915">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/2278">Issue #2278</a>:</p>
<blockquote>
<p>I added the necessary legalization rule to the old x86 backend.</p>
</blockquote>



<a name="212823954"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20Issue%20%232278%20Introduce%20the%20Cranelift%20IR%20instruc.../near/212823954" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20Issue.20.232278.20Introduce.20the.20Cranelift.20IR.20instruc.2E.2E.2E.html#212823954">(Oct 09 2020 at 13:17)</a>:</h4>
<p>akirilov-arm edited a <a href="https://github.com/bytecodealliance/wasmtime/pull/2278#issuecomment-706173915">comment</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/2278">Issue #2278</a>:</p>
<blockquote>
<p>I added the necessary legalization rule to the old x86 backend. I also removed the temporary work-around in <code>cranelift-wasm</code>, so the lowering logic is no longer conditional.</p>
</blockquote>



<a name="212824056"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20Issue%20%232278%20Introduce%20the%20Cranelift%20IR%20instruc.../near/212824056" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20Issue.20.232278.20Introduce.20the.20Cranelift.20IR.20instruc.2E.2E.2E.html#212824056">(Oct 09 2020 at 13:18)</a>:</h4>
<p>akirilov-arm edited a <a href="https://github.com/bytecodealliance/wasmtime/pull/2278#issuecomment-706173915">comment</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/2278">Issue #2278</a>:</p>
<blockquote>
<p>I added the necessary legalization rule to the old x86 backend. I also removed the temporary work-around in <code>cranelift-wasm</code>, so the lowering logic is no longer target-specific.</p>
</blockquote>



<a name="212848860"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20Issue%20%232278%20Introduce%20the%20Cranelift%20IR%20instruc.../near/212848860" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20Issue.20.232278.20Introduce.20the.20Cranelift.20IR.20instruc.2E.2E.2E.html#212848860">(Oct 09 2020 at 16:37)</a>:</h4>
<p>abrown <a href="https://github.com/bytecodealliance/wasmtime/pull/2278#issuecomment-706283455">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/2278">Issue #2278</a>:</p>
<blockquote>
<p>@akirilov-arm, nice! So I'm tracking the only thing I need to do next week is lower <code>LoadSplat</code> in the x64 backend, right? (Unless you get to it first...).</p>
</blockquote>



<a name="212851085"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20Issue%20%232278%20Introduce%20the%20Cranelift%20IR%20instruc.../near/212851085" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20Issue.20.232278.20Introduce.20the.20Cranelift.20IR.20instruc.2E.2E.2E.html#212851085">(Oct 09 2020 at 17:00)</a>:</h4>
<p>akirilov-arm <a href="https://github.com/bytecodealliance/wasmtime/pull/2278#issuecomment-706294506">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/2278">Issue #2278</a>:</p>
<blockquote>
<p>@abrown Yes, that's the only thing remaining, and no, I don't intend to do any other x86 changes (unless I am addressing review feedback, of course).</p>
<p>However, I have noticed that the peephole optimizer tests are failing and according to the logs the reason seems unrelated to my changes...</p>
</blockquote>



<a name="213187710"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20Issue%20%232278%20Introduce%20the%20Cranelift%20IR%20instruc.../near/213187710" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20Issue.20.232278.20Introduce.20the.20Cranelift.20IR.20instruc.2E.2E.2E.html#213187710">(Oct 13 2020 at 17:14)</a>:</h4>
<p>abrown <a href="https://github.com/bytecodealliance/wasmtime/pull/2278#issuecomment-707888014">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/2278">Issue #2278</a>:</p>
<blockquote>
<p>@akirilov-arm, @cfallin: I committed an implementation of <code>LoadSplat</code> on x64--please take a look. Unfortunately I had to thread <code>SourceLoc</code>s through more <code>Inst</code> formats in c9c8de6 and I feel there may a better way to do this so I opened #2290.</p>
</blockquote>



<a name="213190450"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20Issue%20%232278%20Introduce%20the%20Cranelift%20IR%20instruc.../near/213190450" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20Issue.20.232278.20Introduce.20the.20Cranelift.20IR.20instruc.2E.2E.2E.html#213190450">(Oct 13 2020 at 17:35)</a>:</h4>
<p>abrown <a href="https://github.com/bytecodealliance/wasmtime/pull/2278#issuecomment-707900184">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/2278">Issue #2278</a>:</p>
<blockquote>
<p>Looking at the failures in the CI, I think something is behaving weirdly re: Git. The lines it claims need extra parameters should have those added by c9c8de6 and <code>ci/run-experimental-x64-ci.sh</code>. Perhaps we should rebase on <code>main</code> and re-push?</p>
</blockquote>



<a name="213194085"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20Issue%20%232278%20Introduce%20the%20Cranelift%20IR%20instruc.../near/213194085" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20Issue.20.232278.20Introduce.20the.20Cranelift.20IR.20instruc.2E.2E.2E.html#213194085">(Oct 13 2020 at 18:04)</a>:</h4>
<p>akirilov-arm <a href="https://github.com/bytecodealliance/wasmtime/pull/2278#issuecomment-707915327">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/2278">Issue #2278</a>:</p>
<blockquote>
<p>@abrown I have just rebased, but the tests are still failing. Your changes look fine to me, but I am not particularly familiar with the x64 backend.</p>
</blockquote>



<a name="213195396"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20Issue%20%232278%20Introduce%20the%20Cranelift%20IR%20instruc.../near/213195396" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20Issue.20.232278.20Introduce.20the.20Cranelift.20IR.20instruc.2E.2E.2E.html#213195396">(Oct 13 2020 at 18:14)</a>:</h4>
<p>akirilov-arm edited a <a href="https://github.com/bytecodealliance/wasmtime/pull/2278#issuecomment-707915327">comment</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/2278">Issue #2278</a>:</p>
<blockquote>
<p>@abrown I have just rebased, but the tests are still failing. Your changes look fine to me otherwise, but I am not particularly familiar with the x64 backend.</p>
</blockquote>



<a name="213282422"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20Issue%20%232278%20Introduce%20the%20Cranelift%20IR%20instruc.../near/213282422" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20Issue.20.232278.20Introduce.20the.20Cranelift.20IR.20instruc.2E.2E.2E.html#213282422">(Oct 14 2020 at 12:45)</a>:</h4>
<p>akirilov-arm <a href="https://github.com/bytecodealliance/wasmtime/pull/2278#issuecomment-708377464">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/2278">Issue #2278</a>:</p>
<blockquote>
<p>I am not sure why, but I have moved the new IR instruction definition to the end of the function defining all the operations in <code>cranelift/codegen/meta/src/shared/instructions.rs</code> and now the peephole optimizer tests are no longer failing.</p>
<p>cc @fitzgen</p>
</blockquote>



<a name="213285372"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20Issue%20%232278%20Introduce%20the%20Cranelift%20IR%20instruc.../near/213285372" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20Issue.20.232278.20Introduce.20the.20Cranelift.20IR.20instruc.2E.2E.2E.html#213285372">(Oct 14 2020 at 13:08)</a>:</h4>
<p>akirilov-arm <a href="https://github.com/bytecodealliance/wasmtime/pull/2278#issuecomment-708390693">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/2278">Issue #2278</a>:</p>
<blockquote>
<p>@abrown It looks like you missed updating a couple of <code>Inst::xmm_rm_r</code> and <code>Inst::xmm_rm_r_imm</code> call sites, probably because my branch was outdated when you started working on it. I just rebased, so would you be able to fix it?</p>
</blockquote>



<a name="213309067"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20Issue%20%232278%20Introduce%20the%20Cranelift%20IR%20instruc.../near/213309067" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20Issue.20.232278.20Introduce.20the.20Cranelift.20IR.20instruc.2E.2E.2E.html#213309067">(Oct 14 2020 at 15:42)</a>:</h4>
<p>julian-seward1 <a href="https://github.com/bytecodealliance/wasmtime/pull/2278#issuecomment-708487785">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/2278">Issue #2278</a>:</p>
<blockquote>
<p>I apologise for getting to this so late in the day.</p>
<p>I would like to request that this be reconsidered.  I believe the approach discussed so far works against the design goals of the new backend framework, and that an alternative approach would be preferable.</p>
<p>A primary goal of CLIF, in the new backend framework, is to provide a way to conveniently do redundancy elimination.  One key aspect is to provide only a single way to represent any computation.  This change runs counter to those goals.  For example, consider GVN: with this change in place, there is no way to GVN a single <code>LoadSplat</code> CLIF with an equivalent two-CLIF load and splat sequence.</p>
<p>Of course I want this to become a single instruction on AArch64.  The instruction selection framework in the new backend has been designed from the start to allow matching multiple CLIF nodes into a single machine instruction, and so we should use that here, and not add the proposed <code>LoadSplat</code> CLIF node.</p>
<p>@akirilov-arm writes:</p>
<blockquote>
<p>In order to generate it, it is necessary to merge the Load and the Splat in the backend, which is not possible because the load may have side effects.</p>
</blockquote>
<p>I don't follow .. can you clarify this?  What instruction are you referring to?</p>
</blockquote>



<a name="213311172"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20Issue%20%232278%20Introduce%20the%20Cranelift%20IR%20instruc.../near/213311172" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20Issue.20.232278.20Introduce.20the.20Cranelift.20IR.20instruc.2E.2E.2E.html#213311172">(Oct 14 2020 at 15:55)</a>:</h4>
<p>akirilov-arm <a href="https://github.com/bytecodealliance/wasmtime/pull/2278#issuecomment-708495967">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/2278">Issue #2278</a>:</p>
<blockquote>
<blockquote>
<p>What instruction are you referring to?<br>
<code>Opcode::Load</code> and <code>Opcode::Splat</code>. I actually tried what you are talking about and it didn't work - refer to the discussion in #1175.</p>
</blockquote>
</blockquote>



<a name="213311200"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20Issue%20%232278%20Introduce%20the%20Cranelift%20IR%20instruc.../near/213311200" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20Issue.20.232278.20Introduce.20the.20Cranelift.20IR.20instruc.2E.2E.2E.html#213311200">(Oct 14 2020 at 15:55)</a>:</h4>
<p>akirilov-arm edited a <a href="https://github.com/bytecodealliance/wasmtime/pull/2278#issuecomment-708495967">comment</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/2278">Issue #2278</a>:</p>
<blockquote>
<blockquote>
<p>What instruction are you referring to?</p>
</blockquote>
<p><code>Opcode::Load</code> and <code>Opcode::Splat</code>. I actually tried what you are talking about and it didn't work - refer to the discussion in #1175.</p>
</blockquote>



<a name="213313638"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20Issue%20%232278%20Introduce%20the%20Cranelift%20IR%20instruc.../near/213313638" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20Issue.20.232278.20Introduce.20the.20Cranelift.20IR.20instruc.2E.2E.2E.html#213313638">(Oct 14 2020 at 16:10)</a>:</h4>
<p>julian-seward1 <a href="https://github.com/bytecodealliance/wasmtime/pull/2278#issuecomment-708505318">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/2278">Issue #2278</a>:</p>
<blockquote>
<p>Ah, I see.  Yes, it's true; the new framework currently doesn't allow what you tried -- it only allows a load to be at the root of a pattern tree.  Whereas here, the splat would be at the root.</p>
<p>Having said that, @cfallin was talking recently about lifting that restriction in the framework.  This isn't of much significance in the AArch64 case (apart from here, obviously) since AArch64 have very few load-op instructions.  But for x64, almost all instructions have a load-op form, and so it's important that the framework can support that idiom effectively.  Hence it might be the case that this limitation gets lifted sooner rather than later.</p>
</blockquote>



<a name="213313751"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20Issue%20%232278%20Introduce%20the%20Cranelift%20IR%20instruc.../near/213313751" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20Issue.20.232278.20Introduce.20the.20Cranelift.20IR.20instruc.2E.2E.2E.html#213313751">(Oct 14 2020 at 16:11)</a>:</h4>
<p>julian-seward1 edited a <a href="https://github.com/bytecodealliance/wasmtime/pull/2278#issuecomment-708505318">comment</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/2278">Issue #2278</a>:</p>
<blockquote>
<p>Ah, I see.  Yes, it's true; the new framework currently doesn't allow what you tried -- it only allows a load to be at the root of a pattern tree.  Whereas here, the splat would be at the root.</p>
<p>Having said that, @cfallin was talking recently about lifting that restriction in the framework.  This isn't of much significance in the AArch64 case (apart from here, obviously) since AArch64 has very few load-op instructions.  But for x64, almost all instructions have a load-op form, and so it's important that the framework can support that idiom effectively.  Hence it might be the case that this limitation gets lifted sooner rather than later.</p>
</blockquote>



<a name="213318711"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20Issue%20%232278%20Introduce%20the%20Cranelift%20IR%20instruc.../near/213318711" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20Issue.20.232278.20Introduce.20the.20Cranelift.20IR.20instruc.2E.2E.2E.html#213318711">(Oct 14 2020 at 16:46)</a>:</h4>
<p>abrown <a href="https://github.com/bytecodealliance/wasmtime/pull/2278#issuecomment-708525523">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/2278">Issue #2278</a>:</p>
<blockquote>
<p>@akirilov-arm: good call, now d990dd4 should have source locations in more places. @julian-seward1: regardless of what we decide to do with this PR, you should also take a look at #2290--we need a good way to trap at all of the places an x64 instruction could load (which could be quite a few) so I suggest a possible alternative in that issue.</p>
</blockquote>



<a name="213409270"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20Issue%20%232278%20Introduce%20the%20Cranelift%20IR%20instruc.../near/213409270" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20Issue.20.232278.20Introduce.20the.20Cranelift.20IR.20instruc.2E.2E.2E.html#213409270">(Oct 15 2020 at 11:14)</a>:</h4>
<p>akirilov-arm <a href="https://github.com/bytecodealliance/wasmtime/pull/2278#issuecomment-709208485">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/2278">Issue #2278</a>:</p>
<blockquote>
<p>Thanks, @abrown!</p>
<p>@cfallin @julian-seward1 How are we going to proceed with this? The implementation is now complete (covering all three major backends) and passes all tests. Based on the discussion in #1175, I believed that this would be an acceptable approach, but even if it is not, most of my code is actually independent of whether there is a new CLIF operation or not, and I think that's the case for @abrown's code as well. Are there plans to change the new framework soon, so that it supports the type of pattern matching that would be applicable to this case?</p>
</blockquote>



<a name="213470870"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20Issue%20%232278%20Introduce%20the%20Cranelift%20IR%20instruc.../near/213470870" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20Issue.20.232278.20Introduce.20the.20Cranelift.20IR.20instruc.2E.2E.2E.html#213470870">(Oct 15 2020 at 18:51)</a>:</h4>
<p>cfallin <a href="https://github.com/bytecodealliance/wasmtime/pull/2278#issuecomment-709524620">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/2278">Issue #2278</a>:</p>
<blockquote>
<p>@akirilov-arm @julian-seward1 @abrown   so, I'm off for this week and next (but I'll try to keep up with this when I can).  At a high level, I am fine with the pragmatic approach here (and in #1175) of creating these merged opcodes for now, and then eventually removing them when we have the story for load-related code motion sorted out.</p>
<p>In other words, I don't necessarily think that we are so close to having the "right thing" built that we should hold back true codegen improvements in the meantime and create a dependence on a to-be-built part of the framework; I think the cost of removing these opcodes later is minimal, and can be done as part of a PR that introduces the proper pattern-matching. It's not the ideal end-state, but it lets us move forward in the meantime.</p>
<p>@julian-seward1, what do you think?</p>
</blockquote>



<a name="214794695"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20Issue%20%232278%20Introduce%20the%20Cranelift%20IR%20instruc.../near/214794695" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20Issue.20.232278.20Introduce.20the.20Cranelift.20IR.20instruc.2E.2E.2E.html#214794695">(Oct 28 2020 at 04:09)</a>:</h4>
<p>cfallin <a href="https://github.com/bytecodealliance/wasmtime/pull/2278#issuecomment-717683213">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/2278">Issue #2278</a>:</p>
<blockquote>
<p>So, @julian-seward1 and I discussed this last week; apologies for taking so long to get back to it (I'm back to work again, albeit somewhat busy with onboarding stuff.)</p>
<p>In general I agree with @julian-seward1 (and it seems others would be on board with) a better approach eventually that can actually handle pattern-matching load sources to instructions. This has been on my to-do list for a while; but in theory is possible if we loosen the load-motion conditions a bit.</p>
<p>However, I think that having the better codegen as a starting point is valuable; if we take this as-is for now, then we have a baseline whose codegen output we should match when we do have the proper pattern-matching in place.</p>
<p>Thus, I'm happy to take this, and I'll commit to removing the <code>LoadSplat</code> as part of my pattern-matching fixup later, as long as @julian-seward1 doesn't strongly object to this transitional state. Thoughts?</p>
</blockquote>



<a name="214882312"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20Issue%20%232278%20Introduce%20the%20Cranelift%20IR%20instruc.../near/214882312" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20Issue.20.232278.20Introduce.20the.20Cranelift.20IR.20instruc.2E.2E.2E.html#214882312">(Oct 28 2020 at 18:55)</a>:</h4>
<p>akirilov-arm <a href="https://github.com/bytecodealliance/wasmtime/pull/2278#issuecomment-718140685">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/2278">Issue #2278</a>:</p>
<blockquote>
<p>@cfallin Sounds good to me. It's always better to have a good test case before adding non-trivial functionality and, if I understand correctly, previously there were no actual use cases for the enhanced pattern matching.</p>
</blockquote>



<a name="214885731"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20Issue%20%232278%20Introduce%20the%20Cranelift%20IR%20instruc.../near/214885731" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20Issue.20.232278.20Introduce.20the.20Cranelift.20IR.20instruc.2E.2E.2E.html#214885731">(Oct 28 2020 at 19:24)</a>:</h4>
<p>julian-seward1 <a href="https://github.com/bytecodealliance/wasmtime/pull/2278#issuecomment-718156619">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/2278">Issue #2278</a>:</p>
<blockquote>
<p>Well, I can't say I'm enthusiastic; I think it moves the design in the wrong direction.  But if it's only temporary, and since it's useful to land the rest of it anyway, I won't stand in the way.</p>
<p>I should add .. Today I implemented the proposed wasm instructions <code>v128.load32_zero</code> and <code>v128.load64_zero</code>, although the patch isn't on any PR yet.  These are almost identical to the load-splat insns, except that all lanes other than lane zero are zeroed out, not made into clones of it.  I used a two-CLIF-insn scheme -- a scalar load, and a move-scalar-to-lowest-lane-and-zero-others.  Once the isel framework can do load-op merging, I'll add a matching rule so as to only generate a single insn.</p>
<p>So .. if/when that lands, it'll create further CLIF-level inconsistency, at least in the short term :-/</p>
</blockquote>



<a name="214888754"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20Issue%20%232278%20Introduce%20the%20Cranelift%20IR%20instruc.../near/214888754" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20Issue.20.232278.20Introduce.20the.20Cranelift.20IR.20instruc.2E.2E.2E.html#214888754">(Oct 28 2020 at 19:51)</a>:</h4>
<p>cfallin <a href="https://github.com/bytecodealliance/wasmtime/pull/2278#issuecomment-718171064">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/2278">Issue #2278</a>:</p>
<blockquote>
<p>@julian-seward1 understood, and yes, not an ideal situation; but I think this should be a useful test case in the sense that if a new matching framework can handle this case (allow <code>LoadSplat</code> to be removed while retaining identical output), it will have succeeded. I definitely want to get to that point as soon as possible :-)</p>
<p>I'll go ahead and approve and merge now; thanks for the discussion, all!</p>
</blockquote>



<hr><p>Last updated: Jan 20 2025 at 06:04 UTC</p>
</html>