<html>
<head><meta charset="utf-8"><title>wasmtime / PR #1832 externref: implement stack map-based ... · git-wasmtime · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/index.html">git-wasmtime</a></h2>
<h3>Topic: <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231832.20externref.3A.20implement.20stack.20map-based.20.2E.2E.2E.html">wasmtime / PR #1832 externref: implement stack map-based ...</a></h3>

<hr>

<base href="https://bytecodealliance.zulipchat.com">

<head><link href="https://bytecodealliance.github.io/zulip-archive/style.css" rel="stylesheet"></head>

<a name="199944359"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231832%20externref%3A%20implement%20stack%20map-based%20.../near/199944359" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231832.20externref.3A.20implement.20stack.20map-based.20.2E.2E.2E.html#199944359">(Jun 05 2020 at 23:20)</a>:</h4>
<p>fitzgen opened <a href="https://github.com/bytecodealliance/wasmtime/pull/1832">PR #1832</a> from <code>externref-stack-maps</code> to <code>master</code>:</p>
<blockquote>
<p>For host VM code, we use plain reference counting, where cloning increments the reference count, and dropping decrements it. We can avoid many of the on-stack increment/decrement operations that typically plague the performance of reference counting via Rust's ownership and borrowing system. Moving a <code>VMExternRef</code> avoids mutating its reference count, and borrowing it either avoids the reference count increment or delays it until if/when the <code>VMExternRef</code> is cloned.</p>
<p>When passing a <code>VMExternRef</code> into compiled Wasm code, we don't want to do reference count mutations for every compiled <code>local.{get,set}</code>, nor for every function call. Therefore, we use a variation of <strong>deferred reference counting</strong>, where we only mutate reference counts when storing <code>VMExternRef</code>s somewhere that outlives the activation: into a global or table. Simultaneously, we over-approximate the set of <code>VMExternRef</code>s that are inside Wasm function activations. Periodically, we walk the stack at GC safe points, and use stack map information to precisely identify the set of <code>VMExternRef</code>s inside Wasm activations. Then we take the difference between this precise set and our over-approximation, and decrement the reference count for each of the <code>VMExternRef</code>s that are in our over-approximation but not in the precise set. Finally, the over-approximation is replaced with the precise set.</p>
<p>The <code>VMExternRefActivationsTable</code> implements the over-approximized set of <code>VMExternRef</code>s referenced by Wasm activations. Calling a Wasm function and passing it a <code>VMExternRef</code> moves the <code>VMExternRef</code> into the table, and the compiled Wasm function logically "borrows" the <code>VMExternRef</code> from the table. Similarly, <code>global.get</code> and <code>table.get</code> operations clone the gotten<br>
<code>VMExternRef</code> into the <code>VMExternRefActivationsTable</code> and then "borrow" the reference out of the table.</p>
<p>When a <code>VMExternRef</code> is returned to host code from a Wasm function, the host increments the reference count (because the reference is logically "borrowed" from the <code>VMExternRefActivationsTable</code> and the reference count from the table will be dropped at the next GC).</p>
<p>For more general information on deferred reference counting, see <em>An Examination of Deferred Reference Counting and Cycle Detection</em> by Quinane: <a href="https://openresearch-repository.anu.edu.au/bitstream/1885/42030/2/hon-thesis.pdf">https://openresearch-repository.anu.edu.au/bitstream/1885/42030/2/hon-thesis.pdf</a></p>
<p>cc #929</p>
<p>Fixes #1804</p>
<p>Depends on <a href="https://github.com/rust-lang/backtrace-rs/pull/341">https://github.com/rust-lang/backtrace-rs/pull/341</a></p>
</blockquote>



<a name="199944360"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231832%20externref%3A%20implement%20stack%20map-based%20.../near/199944360" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231832.20externref.3A.20implement.20stack.20map-based.20.2E.2E.2E.html#199944360">(Jun 05 2020 at 23:20)</a>:</h4>
<p><strong>fitzgen</strong> requested <a href="https://github.com/alexcrichton">alexcrichton</a> for a review on <a href="https://github.com/bytecodealliance/wasmtime/pull/1832">PR #1832</a>.</p>



<a name="199965771"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231832%20externref%3A%20implement%20stack%20map-based%20.../near/199965771" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231832.20externref.3A.20implement.20stack.20map-based.20.2E.2E.2E.html#199965771">(Jun 06 2020 at 09:31)</a>:</h4>
<p>bjorn3 submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/1832#pullrequestreview-425726558">PR Review</a>.</p>



<a name="199965772"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231832%20externref%3A%20implement%20stack%20map-based%20.../near/199965772" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231832.20externref.3A.20implement.20stack.20map-based.20.2E.2E.2E.html#199965772">(Jun 06 2020 at 09:31)</a>:</h4>
<p>bjorn3 submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/1832#pullrequestreview-425726558">PR Review</a>.</p>



<a name="199965773"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231832%20externref%3A%20implement%20stack%20map-based%20.../near/199965773" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231832.20externref.3A.20implement.20stack.20map-based.20.2E.2E.2E.html#199965773">(Jun 06 2020 at 09:31)</a>:</h4>
<p>bjorn3 created <a href="https://github.com/bytecodealliance/wasmtime/pull/1832#discussion_r436253279">PR Review Comment</a>:</p>
<blockquote>
<p>Reminder to uncomment or remove.</p>
</blockquote>



<a name="199965774"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231832%20externref%3A%20implement%20stack%20map-based%20.../near/199965774" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231832.20externref.3A.20implement.20stack.20map-based.20.2E.2E.2E.html#199965774">(Jun 06 2020 at 09:31)</a>:</h4>
<p>bjorn3 created <a href="https://github.com/bytecodealliance/wasmtime/pull/1832#discussion_r436252959">PR Review Comment</a>:</p>
<blockquote>
<div class="codehilite"><pre><span></span><code>        self.infos.sort_unstable_by_key(|info| info.code_offset);
</code></pre></div>


</blockquote>



<a name="199965775"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231832%20externref%3A%20implement%20stack%20map-based%20.../near/199965775" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231832.20externref.3A.20implement.20stack.20map-based.20.2E.2E.2E.html#199965775">(Jun 06 2020 at 09:31)</a>:</h4>
<p>bjorn3 created <a href="https://github.com/bytecodealliance/wasmtime/pull/1832#discussion_r436253498">PR Review Comment</a>:</p>
<blockquote>
<div class="codehilite"><pre><span></span><code>    /// The range of PCs that this module covers. Different modules must
</code></pre></div>


</blockquote>



<a name="199965776"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231832%20externref%3A%20implement%20stack%20map-based%20.../near/199965776" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231832.20externref.3A.20implement.20stack.20map-based.20.2E.2E.2E.html#199965776">(Jun 06 2020 at 09:31)</a>:</h4>
<p>bjorn3 created <a href="https://github.com/bytecodealliance/wasmtime/pull/1832#discussion_r436253760">PR Review Comment</a>:</p>
<blockquote>
<p>Maybe panic in the drop implementation instead and add an unsafe <code>finish</code> function?</p>
</blockquote>



<a name="199965777"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231832%20externref%3A%20implement%20stack%20map-based%20.../near/199965777" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231832.20externref.3A.20implement.20stack.20map-based.20.2E.2E.2E.html#199965777">(Jun 06 2020 at 09:31)</a>:</h4>
<p>bjorn3 created <a href="https://github.com/bytecodealliance/wasmtime/pull/1832#discussion_r436254103">PR Review Comment</a>:</p>
<blockquote>
<div class="codehilite"><pre><span></span><code>            flag_builder.enable(&quot;enable_safepoints&quot;).unwrap();
</code></pre></div>


</blockquote>



<a name="199965778"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231832%20externref%3A%20implement%20stack%20map-based%20.../near/199965778" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231832.20externref.3A.20implement.20stack.20map-based.20.2E.2E.2E.html#199965778">(Jun 06 2020 at 09:31)</a>:</h4>
<p>bjorn3 created <a href="https://github.com/bytecodealliance/wasmtime/pull/1832#discussion_r436254059">PR Review Comment</a>:</p>
<blockquote>
<div class="codehilite"><pre><span></span><code>        if enable {
            self.flags.enable(&quot;enable_safepoints&quot;).unwrap();
        }
</code></pre></div>


</blockquote>



<a name="200124575"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231832%20externref%3A%20implement%20stack%20map-based%20.../near/200124575" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231832.20externref.3A.20implement.20stack.20map-based.20.2E.2E.2E.html#200124575">(Jun 08 2020 at 16:41)</a>:</h4>
<p>alexcrichton submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/1832#pullrequestreview-426405883">PR Review</a>.</p>



<a name="200124576"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231832%20externref%3A%20implement%20stack%20map-based%20.../near/200124576" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231832.20externref.3A.20implement.20stack.20map-based.20.2E.2E.2E.html#200124576">(Jun 08 2020 at 16:41)</a>:</h4>
<p>alexcrichton created <a href="https://github.com/bytecodealliance/wasmtime/pull/1832#discussion_r436832929">PR Review Comment</a>:</p>
<blockquote>
<p>I think this line can now be removed</p>
</blockquote>



<a name="200124577"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231832%20externref%3A%20implement%20stack%20map-based%20.../near/200124577" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231832.20externref.3A.20implement.20stack.20map-based.20.2E.2E.2E.html#200124577">(Jun 08 2020 at 16:41)</a>:</h4>
<p>alexcrichton submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/1832#pullrequestreview-426405883">PR Review</a>.</p>



<a name="200124578"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231832%20externref%3A%20implement%20stack%20map-based%20.../near/200124578" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231832.20externref.3A.20implement.20stack.20map-based.20.2E.2E.2E.html#200124578">(Jun 08 2020 at 16:41)</a>:</h4>
<p>alexcrichton created <a href="https://github.com/bytecodealliance/wasmtime/pull/1832#discussion_r436835077">PR Review Comment</a>:</p>
<blockquote>
<p>We've got a lot of various registries floating around wasmtime, would it be possible to insert this into an existing registry somehow? For example most of the code here looks like it's copying what we do for frame information.</p>
</blockquote>



<a name="200124579"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231832%20externref%3A%20implement%20stack%20map-based%20.../near/200124579" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231832.20externref.3A.20implement.20stack.20map-based.20.2E.2E.2E.html#200124579">(Jun 08 2020 at 16:41)</a>:</h4>
<p>alexcrichton created <a href="https://github.com/bytecodealliance/wasmtime/pull/1832#discussion_r436836915">PR Review Comment</a>:</p>
<blockquote>
<p>FWIW I've been trying to clean this up over time where <code>Instance</code> doesn't do much memory management of its internals. Is it possible to package up this and the stack map registry elsewhere? I'm not really sure entirely what that would look like but I think it would be best if we could keep <code>Instance</code> having a pretty "raw" feeling rather than holding onto various items.</p>
<p>(e.g. shoving this into <code>Store</code> and passing it through for when we call wasm)</p>
</blockquote>



<a name="200124580"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231832%20externref%3A%20implement%20stack%20map-based%20.../near/200124580" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231832.20externref.3A.20implement.20stack.20map-based.20.2E.2E.2E.html#200124580">(Jun 08 2020 at 16:41)</a>:</h4>
<p>alexcrichton created <a href="https://github.com/bytecodealliance/wasmtime/pull/1832#discussion_r436837789">PR Review Comment</a>:</p>
<blockquote>
<p>Also, to keep adding to this, I'd like to get around to cleaning up the interrupts part eventually too</p>
</blockquote>



<a name="200124581"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231832%20externref%3A%20implement%20stack%20map-based%20.../near/200124581" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231832.20externref.3A.20implement.20stack.20map-based.20.2E.2E.2E.html#200124581">(Jun 08 2020 at 16:41)</a>:</h4>
<p>alexcrichton created <a href="https://github.com/bytecodealliance/wasmtime/pull/1832#discussion_r436837239">PR Review Comment</a>:</p>
<blockquote>
<p>Reading over this, I also don't think that this needs to hold onto this information? It looks like the store can hold onto it for all instances?</p>
</blockquote>



<a name="200124582"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231832%20externref%3A%20implement%20stack%20map-based%20.../near/200124582" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231832.20externref.3A.20implement.20stack.20map-based.20.2E.2E.2E.html#200124582">(Jun 08 2020 at 16:41)</a>:</h4>
<p>alexcrichton created <a href="https://github.com/bytecodealliance/wasmtime/pull/1832#discussion_r436839101">PR Review Comment</a>:</p>
<blockquote>
<p>Sort of continuing my comment from earlier, but this is an example where it would be great to not have this duplication. Ideally there'd be one "register stuff" call, although I'm not sure yet if this is fundamentally required to be two separate steps.</p>
</blockquote>



<a name="200124583"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231832%20externref%3A%20implement%20stack%20map-based%20.../near/200124583" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231832.20externref.3A.20implement.20stack.20map-based.20.2E.2E.2E.html#200124583">(Jun 08 2020 at 16:41)</a>:</h4>
<p>alexcrichton created <a href="https://github.com/bytecodealliance/wasmtime/pull/1832#discussion_r436839293">PR Review Comment</a>:</p>
<blockquote>
<p>Looks like this file become executable?</p>
</blockquote>



<a name="200124585"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231832%20externref%3A%20implement%20stack%20map-based%20.../near/200124585" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231832.20externref.3A.20implement.20stack.20map-based.20.2E.2E.2E.html#200124585">(Jun 08 2020 at 16:41)</a>:</h4>
<p>alexcrichton created <a href="https://github.com/bytecodealliance/wasmtime/pull/1832#discussion_r436839836">PR Review Comment</a>:</p>
<blockquote>
<p>I think I may be missing something, but how come this is stored in an <code>Engine</code>? (vs a <code>Store</code>)</p>
</blockquote>



<a name="200258549"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231832%20externref%3A%20implement%20stack%20map-based%20.../near/200258549" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231832.20externref.3A.20implement.20stack.20map-based.20.2E.2E.2E.html#200258549">(Jun 09 2020 at 16:48)</a>:</h4>
<p>fitzgen submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/1832#pullrequestreview-427354531">PR Review</a>.</p>



<a name="200258550"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231832%20externref%3A%20implement%20stack%20map-based%20.../near/200258550" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231832.20externref.3A.20implement.20stack.20map-based.20.2E.2E.2E.html#200258550">(Jun 09 2020 at 16:48)</a>:</h4>
<p>fitzgen created <a href="https://github.com/bytecodealliance/wasmtime/pull/1832#discussion_r437574964">PR Review Comment</a>:</p>
<blockquote>
<p>I really need to figure out why the heck this is happening...</p>
</blockquote>



<a name="200585563"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231832%20externref%3A%20implement%20stack%20map-based%20.../near/200585563" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231832.20externref.3A.20implement.20stack.20map-based.20.2E.2E.2E.html#200585563">(Jun 11 2020 at 18:24)</a>:</h4>
<p>fitzgen updated <a href="https://github.com/bytecodealliance/wasmtime/pull/1832">PR #1832</a> from <code>externref-stack-maps</code> to <code>master</code>:</p>
<blockquote>
<p>For host VM code, we use plain reference counting, where cloning increments the reference count, and dropping decrements it. We can avoid many of the on-stack increment/decrement operations that typically plague the performance of reference counting via Rust's ownership and borrowing system. Moving a <code>VMExternRef</code> avoids mutating its reference count, and borrowing it either avoids the reference count increment or delays it until if/when the <code>VMExternRef</code> is cloned.</p>
<p>When passing a <code>VMExternRef</code> into compiled Wasm code, we don't want to do reference count mutations for every compiled <code>local.{get,set}</code>, nor for every function call. Therefore, we use a variation of <strong>deferred reference counting</strong>, where we only mutate reference counts when storing <code>VMExternRef</code>s somewhere that outlives the activation: into a global or table. Simultaneously, we over-approximate the set of <code>VMExternRef</code>s that are inside Wasm function activations. Periodically, we walk the stack at GC safe points, and use stack map information to precisely identify the set of <code>VMExternRef</code>s inside Wasm activations. Then we take the difference between this precise set and our over-approximation, and decrement the reference count for each of the <code>VMExternRef</code>s that are in our over-approximation but not in the precise set. Finally, the over-approximation is replaced with the precise set.</p>
<p>The <code>VMExternRefActivationsTable</code> implements the over-approximized set of <code>VMExternRef</code>s referenced by Wasm activations. Calling a Wasm function and passing it a <code>VMExternRef</code> moves the <code>VMExternRef</code> into the table, and the compiled Wasm function logically "borrows" the <code>VMExternRef</code> from the table. Similarly, <code>global.get</code> and <code>table.get</code> operations clone the gotten<br>
<code>VMExternRef</code> into the <code>VMExternRefActivationsTable</code> and then "borrow" the reference out of the table.</p>
<p>When a <code>VMExternRef</code> is returned to host code from a Wasm function, the host increments the reference count (because the reference is logically "borrowed" from the <code>VMExternRefActivationsTable</code> and the reference count from the table will be dropped at the next GC).</p>
<p>For more general information on deferred reference counting, see <em>An Examination of Deferred Reference Counting and Cycle Detection</em> by Quinane: <a href="https://openresearch-repository.anu.edu.au/bitstream/1885/42030/2/hon-thesis.pdf">https://openresearch-repository.anu.edu.au/bitstream/1885/42030/2/hon-thesis.pdf</a></p>
<p>cc #929</p>
<p>Fixes #1804</p>
<p>Depends on <a href="https://github.com/rust-lang/backtrace-rs/pull/341">https://github.com/rust-lang/backtrace-rs/pull/341</a></p>
</blockquote>



<a name="200611275"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231832%20externref%3A%20implement%20stack%20map-based%20.../near/200611275" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231832.20externref.3A.20implement.20stack.20map-based.20.2E.2E.2E.html#200611275">(Jun 11 2020 at 21:48)</a>:</h4>
<p>fitzgen updated <a href="https://github.com/bytecodealliance/wasmtime/pull/1832">PR #1832</a> from <code>externref-stack-maps</code> to <code>master</code>:</p>
<blockquote>
<p>For host VM code, we use plain reference counting, where cloning increments the reference count, and dropping decrements it. We can avoid many of the on-stack increment/decrement operations that typically plague the performance of reference counting via Rust's ownership and borrowing system. Moving a <code>VMExternRef</code> avoids mutating its reference count, and borrowing it either avoids the reference count increment or delays it until if/when the <code>VMExternRef</code> is cloned.</p>
<p>When passing a <code>VMExternRef</code> into compiled Wasm code, we don't want to do reference count mutations for every compiled <code>local.{get,set}</code>, nor for every function call. Therefore, we use a variation of <strong>deferred reference counting</strong>, where we only mutate reference counts when storing <code>VMExternRef</code>s somewhere that outlives the activation: into a global or table. Simultaneously, we over-approximate the set of <code>VMExternRef</code>s that are inside Wasm function activations. Periodically, we walk the stack at GC safe points, and use stack map information to precisely identify the set of <code>VMExternRef</code>s inside Wasm activations. Then we take the difference between this precise set and our over-approximation, and decrement the reference count for each of the <code>VMExternRef</code>s that are in our over-approximation but not in the precise set. Finally, the over-approximation is replaced with the precise set.</p>
<p>The <code>VMExternRefActivationsTable</code> implements the over-approximized set of <code>VMExternRef</code>s referenced by Wasm activations. Calling a Wasm function and passing it a <code>VMExternRef</code> moves the <code>VMExternRef</code> into the table, and the compiled Wasm function logically "borrows" the <code>VMExternRef</code> from the table. Similarly, <code>global.get</code> and <code>table.get</code> operations clone the gotten<br>
<code>VMExternRef</code> into the <code>VMExternRefActivationsTable</code> and then "borrow" the reference out of the table.</p>
<p>When a <code>VMExternRef</code> is returned to host code from a Wasm function, the host increments the reference count (because the reference is logically "borrowed" from the <code>VMExternRefActivationsTable</code> and the reference count from the table will be dropped at the next GC).</p>
<p>For more general information on deferred reference counting, see <em>An Examination of Deferred Reference Counting and Cycle Detection</em> by Quinane: <a href="https://openresearch-repository.anu.edu.au/bitstream/1885/42030/2/hon-thesis.pdf">https://openresearch-repository.anu.edu.au/bitstream/1885/42030/2/hon-thesis.pdf</a></p>
<p>cc #929</p>
<p>Fixes #1804</p>
<p>Depends on <a href="https://github.com/rust-lang/backtrace-rs/pull/341">https://github.com/rust-lang/backtrace-rs/pull/341</a></p>
</blockquote>



<a name="200611507"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231832%20externref%3A%20implement%20stack%20map-based%20.../near/200611507" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231832.20externref.3A.20implement.20stack.20map-based.20.2E.2E.2E.html#200611507">(Jun 11 2020 at 21:50)</a>:</h4>
<p>fitzgen updated <a href="https://github.com/bytecodealliance/wasmtime/pull/1832">PR #1832</a> from <code>externref-stack-maps</code> to <code>master</code>:</p>
<blockquote>
<p>For host VM code, we use plain reference counting, where cloning increments the reference count, and dropping decrements it. We can avoid many of the on-stack increment/decrement operations that typically plague the performance of reference counting via Rust's ownership and borrowing system. Moving a <code>VMExternRef</code> avoids mutating its reference count, and borrowing it either avoids the reference count increment or delays it until if/when the <code>VMExternRef</code> is cloned.</p>
<p>When passing a <code>VMExternRef</code> into compiled Wasm code, we don't want to do reference count mutations for every compiled <code>local.{get,set}</code>, nor for every function call. Therefore, we use a variation of <strong>deferred reference counting</strong>, where we only mutate reference counts when storing <code>VMExternRef</code>s somewhere that outlives the activation: into a global or table. Simultaneously, we over-approximate the set of <code>VMExternRef</code>s that are inside Wasm function activations. Periodically, we walk the stack at GC safe points, and use stack map information to precisely identify the set of <code>VMExternRef</code>s inside Wasm activations. Then we take the difference between this precise set and our over-approximation, and decrement the reference count for each of the <code>VMExternRef</code>s that are in our over-approximation but not in the precise set. Finally, the over-approximation is replaced with the precise set.</p>
<p>The <code>VMExternRefActivationsTable</code> implements the over-approximized set of <code>VMExternRef</code>s referenced by Wasm activations. Calling a Wasm function and passing it a <code>VMExternRef</code> moves the <code>VMExternRef</code> into the table, and the compiled Wasm function logically "borrows" the <code>VMExternRef</code> from the table. Similarly, <code>global.get</code> and <code>table.get</code> operations clone the gotten<br>
<code>VMExternRef</code> into the <code>VMExternRefActivationsTable</code> and then "borrow" the reference out of the table.</p>
<p>When a <code>VMExternRef</code> is returned to host code from a Wasm function, the host increments the reference count (because the reference is logically "borrowed" from the <code>VMExternRefActivationsTable</code> and the reference count from the table will be dropped at the next GC).</p>
<p>For more general information on deferred reference counting, see <em>An Examination of Deferred Reference Counting and Cycle Detection</em> by Quinane: <a href="https://openresearch-repository.anu.edu.au/bitstream/1885/42030/2/hon-thesis.pdf">https://openresearch-repository.anu.edu.au/bitstream/1885/42030/2/hon-thesis.pdf</a></p>
<p>cc #929</p>
<p>Fixes #1804</p>
<p>Depends on <a href="https://github.com/rust-lang/backtrace-rs/pull/341">https://github.com/rust-lang/backtrace-rs/pull/341</a></p>
</blockquote>



<a name="200611555"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231832%20externref%3A%20implement%20stack%20map-based%20.../near/200611555" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231832.20externref.3A.20implement.20stack.20map-based.20.2E.2E.2E.html#200611555">(Jun 11 2020 at 21:51)</a>:</h4>
<p><strong>fitzgen</strong> requested <a href="https://github.com/alexcrichton">alexcrichton</a> for a review on <a href="https://github.com/bytecodealliance/wasmtime/pull/1832">PR #1832</a>.</p>



<a name="200614328"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231832%20externref%3A%20implement%20stack%20map-based%20.../near/200614328" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231832.20externref.3A.20implement.20stack.20map-based.20.2E.2E.2E.html#200614328">(Jun 11 2020 at 22:17)</a>:</h4>
<p>fitzgen updated <a href="https://github.com/bytecodealliance/wasmtime/pull/1832">PR #1832</a> from <code>externref-stack-maps</code> to <code>master</code>:</p>
<blockquote>
<p>For host VM code, we use plain reference counting, where cloning increments the reference count, and dropping decrements it. We can avoid many of the on-stack increment/decrement operations that typically plague the performance of reference counting via Rust's ownership and borrowing system. Moving a <code>VMExternRef</code> avoids mutating its reference count, and borrowing it either avoids the reference count increment or delays it until if/when the <code>VMExternRef</code> is cloned.</p>
<p>When passing a <code>VMExternRef</code> into compiled Wasm code, we don't want to do reference count mutations for every compiled <code>local.{get,set}</code>, nor for every function call. Therefore, we use a variation of <strong>deferred reference counting</strong>, where we only mutate reference counts when storing <code>VMExternRef</code>s somewhere that outlives the activation: into a global or table. Simultaneously, we over-approximate the set of <code>VMExternRef</code>s that are inside Wasm function activations. Periodically, we walk the stack at GC safe points, and use stack map information to precisely identify the set of <code>VMExternRef</code>s inside Wasm activations. Then we take the difference between this precise set and our over-approximation, and decrement the reference count for each of the <code>VMExternRef</code>s that are in our over-approximation but not in the precise set. Finally, the over-approximation is replaced with the precise set.</p>
<p>The <code>VMExternRefActivationsTable</code> implements the over-approximized set of <code>VMExternRef</code>s referenced by Wasm activations. Calling a Wasm function and passing it a <code>VMExternRef</code> moves the <code>VMExternRef</code> into the table, and the compiled Wasm function logically "borrows" the <code>VMExternRef</code> from the table. Similarly, <code>global.get</code> and <code>table.get</code> operations clone the gotten<br>
<code>VMExternRef</code> into the <code>VMExternRefActivationsTable</code> and then "borrow" the reference out of the table.</p>
<p>When a <code>VMExternRef</code> is returned to host code from a Wasm function, the host increments the reference count (because the reference is logically "borrowed" from the <code>VMExternRefActivationsTable</code> and the reference count from the table will be dropped at the next GC).</p>
<p>For more general information on deferred reference counting, see <em>An Examination of Deferred Reference Counting and Cycle Detection</em> by Quinane: <a href="https://openresearch-repository.anu.edu.au/bitstream/1885/42030/2/hon-thesis.pdf">https://openresearch-repository.anu.edu.au/bitstream/1885/42030/2/hon-thesis.pdf</a></p>
<p>cc #929</p>
<p>Fixes #1804</p>
<p>Depends on <a href="https://github.com/rust-lang/backtrace-rs/pull/341">https://github.com/rust-lang/backtrace-rs/pull/341</a></p>
</blockquote>



<a name="200708079"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231832%20externref%3A%20implement%20stack%20map-based%20.../near/200708079" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231832.20externref.3A.20implement.20stack.20map-based.20.2E.2E.2E.html#200708079">(Jun 12 2020 at 18:37)</a>:</h4>
<p>alexcrichton submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/1832#pullrequestreview-429878689">PR Review</a>.</p>



<a name="200708080"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231832%20externref%3A%20implement%20stack%20map-based%20.../near/200708080" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231832.20externref.3A.20implement.20stack.20map-based.20.2E.2E.2E.html#200708080">(Jun 12 2020 at 18:37)</a>:</h4>
<p>alexcrichton submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/1832#pullrequestreview-429878689">PR Review</a>.</p>



<a name="200708081"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231832%20externref%3A%20implement%20stack%20map-based%20.../near/200708081" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231832.20externref.3A.20implement.20stack.20map-based.20.2E.2E.2E.html#200708081">(Jun 12 2020 at 18:37)</a>:</h4>
<p>alexcrichton created <a href="https://github.com/bytecodealliance/wasmtime/pull/1832#discussion_r439521473">PR Review Comment</a>:</p>
<blockquote>
<p>Perhaps a merge conflict gone wrong?</p>
</blockquote>



<a name="200708082"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231832%20externref%3A%20implement%20stack%20map-based%20.../near/200708082" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231832.20externref.3A.20implement.20stack.20map-based.20.2E.2E.2E.html#200708082">(Jun 12 2020 at 18:37)</a>:</h4>
<p>alexcrichton created <a href="https://github.com/bytecodealliance/wasmtime/pull/1832#discussion_r439522588">PR Review Comment</a>:</p>
<blockquote>
<p>Could the canary business here be moved into <code>catch_traps</code> to avoid some duplication?</p>
</blockquote>



<a name="200708083"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231832%20externref%3A%20implement%20stack%20map-based%20.../near/200708083" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231832.20externref.3A.20implement.20stack.20map-based.20.2E.2E.2E.html#200708083">(Jun 12 2020 at 18:37)</a>:</h4>
<p>alexcrichton created <a href="https://github.com/bytecodealliance/wasmtime/pull/1832#discussion_r439522070">PR Review Comment</a>:</p>
<blockquote>
<p>I'd personally still prefer to avoid having this here if it's sole purpose is to keep the field alive. I think that memory management should be deferred to <code>Store</code></p>
</blockquote>



<a name="200708084"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231832%20externref%3A%20implement%20stack%20map-based%20.../near/200708084" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231832.20externref.3A.20implement.20stack.20map-based.20.2E.2E.2E.html#200708084">(Jun 12 2020 at 18:37)</a>:</h4>
<p>alexcrichton created <a href="https://github.com/bytecodealliance/wasmtime/pull/1832#discussion_r439566773">PR Review Comment</a>:</p>
<blockquote>
<p>This might be a bit more compact as <code>(0..size).map(|_| ...).collect()</code></p>
</blockquote>



<a name="200708085"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231832%20externref%3A%20implement%20stack%20map-based%20.../near/200708085" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231832.20externref.3A.20implement.20stack.20map-based.20.2E.2E.2E.html#200708085">(Jun 12 2020 at 18:37)</a>:</h4>
<p>alexcrichton created <a href="https://github.com/bytecodealliance/wasmtime/pull/1832#discussion_r439522242">PR Review Comment</a>:</p>
<blockquote>
<p>(same with <code>externref_activations_table</code> above too)</p>
</blockquote>



<a name="200708086"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231832%20externref%3A%20implement%20stack%20map-based%20.../near/200708086" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231832.20externref.3A.20implement.20stack.20map-based.20.2E.2E.2E.html#200708086">(Jun 12 2020 at 18:37)</a>:</h4>
<p>alexcrichton created <a href="https://github.com/bytecodealliance/wasmtime/pull/1832#discussion_r439568002">PR Review Comment</a>:</p>
<blockquote>
<p>I don't actually see this end up getting used anywhere, was this perhaps from a previous iteration?</p>
</blockquote>



<a name="200708088"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231832%20externref%3A%20implement%20stack%20map-based%20.../near/200708088" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231832.20externref.3A.20implement.20stack.20map-based.20.2E.2E.2E.html#200708088">(Jun 12 2020 at 18:37)</a>:</h4>
<p>alexcrichton created <a href="https://github.com/bytecodealliance/wasmtime/pull/1832#discussion_r439568333">PR Review Comment</a>:</p>
<blockquote>
<p>How is this field used from wasm code? I tried to read over but couldn't find much... It also looked like <code>VMOffsets</code> contained information about the <code>end</code> field below too, but it's not an <code>UnsafeCell</code>?</p>
</blockquote>



<a name="200708089"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231832%20externref%3A%20implement%20stack%20map-based%20.../near/200708089" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231832.20externref.3A.20implement.20stack.20map-based.20.2E.2E.2E.html#200708089">(Jun 12 2020 at 18:37)</a>:</h4>
<p>alexcrichton created <a href="https://github.com/bytecodealliance/wasmtime/pull/1832#discussion_r439571234">PR Review Comment</a>:</p>
<blockquote>
<p>Since this registry only needs to be within a <code>Store</code>, how come this is an <code>RwLock</code> instead of <code>RefCell</code>?</p>
</blockquote>



<a name="200708090"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231832%20externref%3A%20implement%20stack%20map-based%20.../near/200708090" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231832.20externref.3A.20implement.20stack.20map-based.20.2E.2E.2E.html#200708090">(Jun 12 2020 at 18:37)</a>:</h4>
<p>alexcrichton created <a href="https://github.com/bytecodealliance/wasmtime/pull/1832#discussion_r439573131">PR Review Comment</a>:</p>
<blockquote>
<p>Could this assert that <code>sp</code> is not null for wasm frames? (help catch bugs in <code>backtrace</code>)</p>
</blockquote>



<a name="200708091"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231832%20externref%3A%20implement%20stack%20map-based%20.../near/200708091" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231832.20externref.3A.20implement.20stack.20map-based.20.2E.2E.2E.html#200708091">(Jun 12 2020 at 18:37)</a>:</h4>
<p>alexcrichton created <a href="https://github.com/bytecodealliance/wasmtime/pull/1832#discussion_r439580671">PR Review Comment</a>:</p>
<blockquote>
<p>Ah ok I confirmed on Zulip, but it sounds like this is planned to get used in the future. I presume that the idea is that with <code>table.get</code> you'd have a fast path for using these two fields to inline the <code>try_insert</code> method, and you'd fallback to an intrinsic for out-of-line growth and such?</p>
<p>Reading over all this dealing with chunks and such feels a bit overly complicated. Could this perhaps be simplified a bit? I'm thinking that this could perhaps be restructured to something that looks like:</p>
<div class="codehilite"><pre><span></span><code><span class="w"> </span><span class="k">pub</span><span class="w"> </span><span class="k">struct</span> <span class="nc">VMExternRefActivationsTable</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="c1">// finter into `fast_path_storage`</span>
<span class="w">    </span><span class="n">next</span>: <span class="nc">UnsafeCell</span><span class="o">&lt;</span><span class="n">NonNull</span><span class="o">&lt;</span><span class="n">TableElem</span><span class="o">&gt;&gt;</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="c1">// never changes after creation</span>
<span class="w">    </span><span class="n">end</span>: <span class="nc">NonNull</span><span class="o">&lt;</span><span class="n">TableElem</span><span class="o">&gt;</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="c1">// used by `try_insert` and stored via `next` in jit code</span>
<span class="w">    </span><span class="n">fast_path_storage</span>: <span class="nb">Box</span><span class="o">&lt;</span><span class="p">[</span><span class="n">TableElem</span><span class="p">]</span><span class="o">&gt;</span><span class="p">,</span><span class="w"></span>

<span class="w">    </span><span class="n">imprecise_roots</span>: <span class="nc">HashSet</span><span class="o">&lt;</span><span class="n">VMExternRef</span><span class="o">&gt;</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="n">precise_roots</span>: <span class="nc">HashSet</span><span class="o">&lt;</span><span class="n">VMExternRef</span><span class="o">&gt;</span><span class="p">,</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>


<p>where here <code>fast_path_storage</code> is allocated once and never changes. When an overflow of that table happens it's drained and everything is moved into <code>imprecise_roots</code>. That way <code>imprecise_roots</code> is a growing set which deduplicates things (in case you <code>table.get</code> the same thing a bunch of times) and also handles reallocation for us (we don't need to manually double capacities and such).</p>
<p>On a GC we'd fill in <code>precise_roots</code> and then we'd <code>mem::swap</code> the precise/imprecise sets and then clear the imprecise one. Maybe with some other trickery around optimizing reference counts or something like that.</p>
<p>I'm mostly hoping that we can simplifiy the <code>chunks</code> list because:</p>
<ul>
<li>It seems somewhat complicated to manage, especially if we're trying to be clever about capacities and double them</li>
<li>I'm a bit worried about the segmented-stacks thrashing problem where you keep allocating a doubly-bigger chunk but then freeing it, when it'd be more efficient to just double the size of the internal chunk.</li>
<li>Roots aren't deduplicated in the chunks so if you pass around the same <code>VMExternRef</code> a bunch it may accidentally fill them up quite a lot.</li>
</ul>
<p>With a persistent hash set I think it'd solve the duplication/capacity issues? Anyway curious what you think about this!</p>
</blockquote>



<a name="200708093"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231832%20externref%3A%20implement%20stack%20map-based%20.../near/200708093" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231832.20externref.3A.20implement.20stack.20map-based.20.2E.2E.2E.html#200708093">(Jun 12 2020 at 18:37)</a>:</h4>
<p>alexcrichton created <a href="https://github.com/bytecodealliance/wasmtime/pull/1832#discussion_r439581101">PR Review Comment</a>:</p>
<blockquote>
<p>Because of this, could the activation table have a <code>Drop</code> which asserts that the <code>precise_stack_roots</code> set is empty? Otherwise we'd leak data accidentally b/c there's no dtor which drains the map.</p>
<p>(or maybe we should also assert that all chunks are <code>None</code> since they don't get frobbed on <code>Drop</code> either?)</p>
</blockquote>



<a name="200719258"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231832%20externref%3A%20implement%20stack%20map-based%20.../near/200719258" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231832.20externref.3A.20implement.20stack.20map-based.20.2E.2E.2E.html#200719258">(Jun 12 2020 at 20:12)</a>:</h4>
<p>fitzgen submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/1832#pullrequestreview-430011071">PR Review</a>.</p>



<a name="200719259"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231832%20externref%3A%20implement%20stack%20map-based%20.../near/200719259" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231832.20externref.3A.20implement.20stack.20map-based.20.2E.2E.2E.html#200719259">(Jun 12 2020 at 20:12)</a>:</h4>
<p>fitzgen created <a href="https://github.com/bytecodealliance/wasmtime/pull/1832#discussion_r439621908">PR Review Comment</a>:</p>
<blockquote>
<p>Yeah, when I get merge conflicts in <code>Cargo.lock</code> I generally just blow it away and let the next build recreate it, but this pulled in that problematic dep update we all talked about a couple days ago. Bleh.</p>
</blockquote>



<a name="200719423"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231832%20externref%3A%20implement%20stack%20map-based%20.../near/200719423" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231832.20externref.3A.20implement.20stack.20map-based.20.2E.2E.2E.html#200719423">(Jun 12 2020 at 20:14)</a>:</h4>
<p>fitzgen submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/1832#pullrequestreview-430012246">PR Review</a>.</p>



<a name="200719424"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231832%20externref%3A%20implement%20stack%20map-based%20.../near/200719424" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231832.20externref.3A.20implement.20stack.20map-based.20.2E.2E.2E.html#200719424">(Jun 12 2020 at 20:14)</a>:</h4>
<p>fitzgen created <a href="https://github.com/bytecodealliance/wasmtime/pull/1832#discussion_r439622764">PR Review Comment</a>:</p>
<blockquote>
<p>It probably doesn't matter in practice, but that would mean the canary is taken from a stack frame that has since been popped</p>
<p>/me shrugs</p>
<p>I guess I could switch the API to <code>table.with_stack_canary(|| { ... })</code> instead of an RAII thing? Would be harder to misuse this way too. I think I'll do that.</p>
</blockquote>



<a name="200721282"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231832%20externref%3A%20implement%20stack%20map-based%20.../near/200721282" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231832.20externref.3A.20implement.20stack.20map-based.20.2E.2E.2E.html#200721282">(Jun 12 2020 at 20:32)</a>:</h4>
<p>fitzgen submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/1832#pullrequestreview-430021084">PR Review</a>.</p>



<a name="200721283"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231832%20externref%3A%20implement%20stack%20map-based%20.../near/200721283" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231832.20externref.3A.20implement.20stack.20map-based.20.2E.2E.2E.html#200721283">(Jun 12 2020 at 20:32)</a>:</h4>
<p>fitzgen created <a href="https://github.com/bytecodealliance/wasmtime/pull/1832#discussion_r439629605">PR Review Comment</a>:</p>
<blockquote>
<p>This is a good idea, however</p>
<ul>
<li>
<p>we may still want to have the fast-path table grow shrink based on the precise size of the last root set (probably fine to skip for now, but we'll likely want to investigate this in the future)</p>
</li>
<li>
<p>we lose the ability to reclaim memory once we are no longer using excessive capacity in these sets (again, probably fine for now, but we'll likely want to handle this sometime in the future)</p>
</li>
</ul>
</blockquote>



<a name="200729957"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231832%20externref%3A%20implement%20stack%20map-based%20.../near/200729957" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231832.20externref.3A.20implement.20stack.20map-based.20.2E.2E.2E.html#200729957">(Jun 12 2020 at 22:09)</a>:</h4>
<p>alexcrichton submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/1832#pullrequestreview-430062236">PR Review</a>.</p>



<a name="200729958"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231832%20externref%3A%20implement%20stack%20map-based%20.../near/200729958" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231832.20externref.3A.20implement.20stack.20map-based.20.2E.2E.2E.html#200729958">(Jun 12 2020 at 22:09)</a>:</h4>
<p>alexcrichton created <a href="https://github.com/bytecodealliance/wasmtime/pull/1832#discussion_r439661638">PR Review Comment</a>:</p>
<blockquote>
<p>Either way's fine by me, I was mostly just hoping that we can encapsulate everything necessary to enter wasm in one function in wasmtime, which currently is <code>catch_traps</code>. I think the <code>with_stack_canary</code> call can be embedded in there too? (we can perhaps rename <code>catch_traps</code> to <code>invoke_wasm</code> or something like that)</p>
</blockquote>



<a name="200730145"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231832%20externref%3A%20implement%20stack%20map-based%20.../near/200730145" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231832.20externref.3A.20implement.20stack.20map-based.20.2E.2E.2E.html#200730145">(Jun 12 2020 at 22:11)</a>:</h4>
<p>alexcrichton submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/1832#pullrequestreview-430062805">PR Review</a>.</p>



<a name="200730146"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231832%20externref%3A%20implement%20stack%20map-based%20.../near/200730146" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231832.20externref.3A.20implement.20stack.20map-based.20.2E.2E.2E.html#200730146">(Jun 12 2020 at 22:11)</a>:</h4>
<p>alexcrichton created <a href="https://github.com/bytecodealliance/wasmtime/pull/1832#discussion_r439662142">PR Review Comment</a>:</p>
<blockquote>
<p>Switching <code>fast_path_storage</code> to a <code>Vec&lt;T&gt;</code> would be an easy way to make the fast-path-table growable (that's a good point, and one thing I was curious how often it would come into play). For shrinking we could periodically call <code>HashSet::shrink_to_fit</code> I think?</p>
</blockquote>



<a name="200731321"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231832%20externref%3A%20implement%20stack%20map-based%20.../near/200731321" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231832.20externref.3A.20implement.20stack.20map-based.20.2E.2E.2E.html#200731321">(Jun 12 2020 at 22:24)</a>:</h4>
<p>fitzgen submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/1832#pullrequestreview-430067030">PR Review</a>.</p>



<a name="200731322"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231832%20externref%3A%20implement%20stack%20map-based%20.../near/200731322" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231832.20externref.3A.20implement.20stack.20map-based.20.2E.2E.2E.html#200731322">(Jun 12 2020 at 22:24)</a>:</h4>
<p>fitzgen created <a href="https://github.com/bytecodealliance/wasmtime/pull/1832#discussion_r439665582">PR Review Comment</a>:</p>
<blockquote>
<p>Yeah. Would be nice if <code>HashSet::shrink_to</code> was stable, so we could shrink capacity by half when the length is a quarter of the capacity, and keep the amortized O(1). We could do <code>shrink_to_fit</code> followed by <code>reserve</code> but this is suboptimal.</p>
<p>Anyways, I'm just gonna do the simplest thing here for now, and leave that stuff to when we actually see it in profiles.</p>
</blockquote>



<a name="200736744"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231832%20externref%3A%20implement%20stack%20map-based%20.../near/200736744" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231832.20externref.3A.20implement.20stack.20map-based.20.2E.2E.2E.html#200736744">(Jun 12 2020 at 23:33)</a>:</h4>
<p>fitzgen submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/1832#pullrequestreview-430083641">PR Review</a>.</p>



<a name="200736745"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231832%20externref%3A%20implement%20stack%20map-based%20.../near/200736745" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231832.20externref.3A.20implement.20stack.20map-based.20.2E.2E.2E.html#200736745">(Jun 12 2020 at 23:33)</a>:</h4>
<p>fitzgen created <a href="https://github.com/bytecodealliance/wasmtime/pull/1832#discussion_r439679723">PR Review Comment</a>:</p>
<blockquote>
<p>Also, the <code>backtrace</code> update needs these dep updates.</p>
</blockquote>



<a name="200737501"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231832%20externref%3A%20implement%20stack%20map-based%20.../near/200737501" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231832.20externref.3A.20implement.20stack.20map-based.20.2E.2E.2E.html#200737501">(Jun 12 2020 at 23:44)</a>:</h4>
<p>fitzgen submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/1832#pullrequestreview-430085715">PR Review</a>.</p>



<a name="200737502"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231832%20externref%3A%20implement%20stack%20map-based%20.../near/200737502" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231832.20externref.3A.20implement.20stack.20map-based.20.2E.2E.2E.html#200737502">(Jun 12 2020 at 23:44)</a>:</h4>
<p>fitzgen created <a href="https://github.com/bytecodealliance/wasmtime/pull/1832#discussion_r439681507">PR Review Comment</a>:</p>
<blockquote>
<p>This runs into the weirdness at the <code>wasmtime</code> and <code>wasmtime-runtime</code> boundary again: this is inside <code>wasmtime-runtime</code> and so it has "no" knowledge of <code>Store</code> and whether anything else is holding the table alive for it.</p>
<p>Would you prefer that <code>InstanceHandle::new</code> took a <code>*mut VMExternRefActivationsTable</code> instead of an <code>Rc</code> and we added this to the safetry invariants required to be maintained for <code>InstanceHandle::new</code>?</p>
</blockquote>



<a name="200737523"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231832%20externref%3A%20implement%20stack%20map-based%20.../near/200737523" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231832.20externref.3A.20implement.20stack.20map-based.20.2E.2E.2E.html#200737523">(Jun 12 2020 at 23:44)</a>:</h4>
<p>fitzgen submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/1832#pullrequestreview-430085831">PR Review</a>.</p>



<a name="200737524"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231832%20externref%3A%20implement%20stack%20map-based%20.../near/200737524" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231832.20externref.3A.20implement.20stack.20map-based.20.2E.2E.2E.html#200737524">(Jun 12 2020 at 23:44)</a>:</h4>
<p>fitzgen created <a href="https://github.com/bytecodealliance/wasmtime/pull/1832#discussion_r439681607">PR Review Comment</a>:</p>
<blockquote>
<p>Same question as above regarding <code>*mut</code> vs <code>Arc</code>: <a href="https://github.com/bytecodealliance/wasmtime/pull/1832/files?file-filters%5B%5D=.rs#r439681507">https://github.com/bytecodealliance/wasmtime/pull/1832/files?file-filters%5B%5D=.rs#r439681507</a></p>
</blockquote>



<a name="200737850"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231832%20externref%3A%20implement%20stack%20map-based%20.../near/200737850" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231832.20externref.3A.20implement.20stack.20map-based.20.2E.2E.2E.html#200737850">(Jun 12 2020 at 23:49)</a>:</h4>
<p>fitzgen submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/1832#pullrequestreview-430086719">PR Review</a>.</p>



<a name="200737851"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231832%20externref%3A%20implement%20stack%20map-based%20.../near/200737851" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231832.20externref.3A.20implement.20stack.20map-based.20.2E.2E.2E.html#200737851">(Jun 12 2020 at 23:49)</a>:</h4>
<p>fitzgen created <a href="https://github.com/bytecodealliance/wasmtime/pull/1832#discussion_r439682344">PR Review Comment</a>:</p>
<blockquote>
<p>Ah I misunderstood what you were asking for in the original comment. This is done now.</p>
</blockquote>



<a name="200738061"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231832%20externref%3A%20implement%20stack%20map-based%20.../near/200738061" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231832.20externref.3A.20implement.20stack.20map-based.20.2E.2E.2E.html#200738061">(Jun 12 2020 at 23:52)</a>:</h4>
<p>fitzgen submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/1832#pullrequestreview-430087342">PR Review</a>.</p>



<a name="200738063"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231832%20externref%3A%20implement%20stack%20map-based%20.../near/200738063" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231832.20externref.3A.20implement.20stack.20map-based.20.2E.2E.2E.html#200738063">(Jun 12 2020 at 23:52)</a>:</h4>
<p>fitzgen created <a href="https://github.com/bytecodealliance/wasmtime/pull/1832#discussion_r439682899">PR Review Comment</a>:</p>
<blockquote>
<p>This doesn't work for disabling reference types, and there is no <code>disable</code> function to go along with <code>enable</code> either.</p>
</blockquote>



<a name="200739683"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231832%20externref%3A%20implement%20stack%20map-based%20.../near/200739683" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231832.20externref.3A.20implement.20stack.20map-based.20.2E.2E.2E.html#200739683">(Jun 13 2020 at 00:23)</a>:</h4>
<p>fitzgen updated <a href="https://github.com/bytecodealliance/wasmtime/pull/1832">PR #1832</a> from <code>externref-stack-maps</code> to <code>master</code>:</p>
<blockquote>
<p>For host VM code, we use plain reference counting, where cloning increments the reference count, and dropping decrements it. We can avoid many of the on-stack increment/decrement operations that typically plague the performance of reference counting via Rust's ownership and borrowing system. Moving a <code>VMExternRef</code> avoids mutating its reference count, and borrowing it either avoids the reference count increment or delays it until if/when the <code>VMExternRef</code> is cloned.</p>
<p>When passing a <code>VMExternRef</code> into compiled Wasm code, we don't want to do reference count mutations for every compiled <code>local.{get,set}</code>, nor for every function call. Therefore, we use a variation of <strong>deferred reference counting</strong>, where we only mutate reference counts when storing <code>VMExternRef</code>s somewhere that outlives the activation: into a global or table. Simultaneously, we over-approximate the set of <code>VMExternRef</code>s that are inside Wasm function activations. Periodically, we walk the stack at GC safe points, and use stack map information to precisely identify the set of <code>VMExternRef</code>s inside Wasm activations. Then we take the difference between this precise set and our over-approximation, and decrement the reference count for each of the <code>VMExternRef</code>s that are in our over-approximation but not in the precise set. Finally, the over-approximation is replaced with the precise set.</p>
<p>The <code>VMExternRefActivationsTable</code> implements the over-approximized set of <code>VMExternRef</code>s referenced by Wasm activations. Calling a Wasm function and passing it a <code>VMExternRef</code> moves the <code>VMExternRef</code> into the table, and the compiled Wasm function logically "borrows" the <code>VMExternRef</code> from the table. Similarly, <code>global.get</code> and <code>table.get</code> operations clone the gotten<br>
<code>VMExternRef</code> into the <code>VMExternRefActivationsTable</code> and then "borrow" the reference out of the table.</p>
<p>When a <code>VMExternRef</code> is returned to host code from a Wasm function, the host increments the reference count (because the reference is logically "borrowed" from the <code>VMExternRefActivationsTable</code> and the reference count from the table will be dropped at the next GC).</p>
<p>For more general information on deferred reference counting, see <em>An Examination of Deferred Reference Counting and Cycle Detection</em> by Quinane: <a href="https://openresearch-repository.anu.edu.au/bitstream/1885/42030/2/hon-thesis.pdf">https://openresearch-repository.anu.edu.au/bitstream/1885/42030/2/hon-thesis.pdf</a></p>
<p>cc #929</p>
<p>Fixes #1804</p>
<p>Depends on <a href="https://github.com/rust-lang/backtrace-rs/pull/341">https://github.com/rust-lang/backtrace-rs/pull/341</a></p>
</blockquote>



<a name="200912856"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231832%20externref%3A%20implement%20stack%20map-based%20.../near/200912856" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231832.20externref.3A.20implement.20stack.20map-based.20.2E.2E.2E.html#200912856">(Jun 15 2020 at 16:27)</a>:</h4>
<p>fitzgen submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/1832#pullrequestreview-430804800">PR Review</a>.</p>



<a name="200912857"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231832%20externref%3A%20implement%20stack%20map-based%20.../near/200912857" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231832.20externref.3A.20implement.20stack.20map-based.20.2E.2E.2E.html#200912857">(Jun 15 2020 at 16:27)</a>:</h4>
<p>fitzgen created <a href="https://github.com/bytecodealliance/wasmtime/pull/1832#discussion_r440298838">PR Review Comment</a>:</p>
<blockquote>
<p>It was unnecessary, and is now removed.</p>
</blockquote>



<a name="200913379"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231832%20externref%3A%20implement%20stack%20map-based%20.../near/200913379" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231832.20externref.3A.20implement.20stack.20map-based.20.2E.2E.2E.html#200913379">(Jun 15 2020 at 16:31)</a>:</h4>
<p>fitzgen submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/1832#pullrequestreview-430807901">PR Review</a>.</p>



<a name="200913380"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231832%20externref%3A%20implement%20stack%20map-based%20.../near/200913380" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231832.20externref.3A.20implement.20stack.20map-based.20.2E.2E.2E.html#200913380">(Jun 15 2020 at 16:31)</a>:</h4>
<p>fitzgen created <a href="https://github.com/bytecodealliance/wasmtime/pull/1832#discussion_r440301149">PR Review Comment</a>:</p>
<blockquote>
<p>Otherwise <code>Module</code> is not <code>Send</code>:</p>
<div class="codehilite"><pre><span></span><code>error[E0277]: `std::cell::RefCell&lt;wasmtime_runtime::externref::StackMapRegistryInner&gt;` cannot be shared between threads safely
   --&gt; crates/wasmtime/src/module.rs:579:5
    |
578 |     fn _assert&lt;T: Send + Sync&gt;() {}
    |                   ---- required by this bound in `module::_assert_send_sync::_assert`
579 |     _assert::&lt;Module&gt;();
    |     ^^^^^^^^^^^^^^^^^ `std::cell::RefCell&lt;wasmtime_runtime::externref::StackMapRegistryInner&gt;` cannot be shared between threads safely
    |
    = help: within `wasmtime_runtime::externref::StackMapRegistry`, the trait `std::marker::Sync` is not implemented for `std::cell::RefCell&lt;wasmtime_runtime::externref::StackMapRegistryInner&gt;`
    = note: required because it appears within the type `wasmtime_runtime::externref::StackMapRegistry`
    = note: required because of the requirements on the impl of `std::marker::Send` for `std::sync::Arc&lt;wasmtime_runtime::externref::StackMapRegistry&gt;`
    = note: required because it appears within the type `wasmtime_runtime::externref::StackMapRegistration`
    = note: required because of the requirements on the impl of `std::marker::Send` for `std::sync::Arc&lt;wasmtime_runtime::externref::StackMapRegistration&gt;`
    = note: required because it appears within the type `std::option::Option&lt;std::sync::Arc&lt;wasmtime_runtime::externref::StackMapRegistration&gt;&gt;`
    = note: required because it appears within the type `std::option::Option&lt;std::option::Option&lt;std::sync::Arc&lt;wasmtime_runtime::externref::StackMapRegistration&gt;&gt;&gt;`
    = note: required because of the requirements on the impl of `std::marker::Send` for `std::sync::Mutex&lt;std::option::Option&lt;std::option::Option&lt;std::sync::Arc&lt;wasmtime_runtime::externref::StackMapRegistration&gt;&gt;&gt;&gt;`
    = note: required because of the requirements on the impl of `std::marker::Send` for `std::sync::Arc&lt;std::sync::Mutex&lt;std::option::Option&lt;std::option::Option&lt;std::sync::Arc&lt;wasmtime_runtime::externref::StackMapRegistration&gt;&gt;&gt;&gt;&gt;`
    = note: required because it appears within the type `module::Module`
</code></pre></div>


</blockquote>



<a name="200913542"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231832%20externref%3A%20implement%20stack%20map-based%20.../near/200913542" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231832.20externref.3A.20implement.20stack.20map-based.20.2E.2E.2E.html#200913542">(Jun 15 2020 at 16:32)</a>:</h4>
<p>fitzgen updated <a href="https://github.com/bytecodealliance/wasmtime/pull/1832">PR #1832</a> from <code>externref-stack-maps</code> to <code>master</code>:</p>
<blockquote>
<p>For host VM code, we use plain reference counting, where cloning increments the reference count, and dropping decrements it. We can avoid many of the on-stack increment/decrement operations that typically plague the performance of reference counting via Rust's ownership and borrowing system. Moving a <code>VMExternRef</code> avoids mutating its reference count, and borrowing it either avoids the reference count increment or delays it until if/when the <code>VMExternRef</code> is cloned.</p>
<p>When passing a <code>VMExternRef</code> into compiled Wasm code, we don't want to do reference count mutations for every compiled <code>local.{get,set}</code>, nor for every function call. Therefore, we use a variation of <strong>deferred reference counting</strong>, where we only mutate reference counts when storing <code>VMExternRef</code>s somewhere that outlives the activation: into a global or table. Simultaneously, we over-approximate the set of <code>VMExternRef</code>s that are inside Wasm function activations. Periodically, we walk the stack at GC safe points, and use stack map information to precisely identify the set of <code>VMExternRef</code>s inside Wasm activations. Then we take the difference between this precise set and our over-approximation, and decrement the reference count for each of the <code>VMExternRef</code>s that are in our over-approximation but not in the precise set. Finally, the over-approximation is replaced with the precise set.</p>
<p>The <code>VMExternRefActivationsTable</code> implements the over-approximized set of <code>VMExternRef</code>s referenced by Wasm activations. Calling a Wasm function and passing it a <code>VMExternRef</code> moves the <code>VMExternRef</code> into the table, and the compiled Wasm function logically "borrows" the <code>VMExternRef</code> from the table. Similarly, <code>global.get</code> and <code>table.get</code> operations clone the gotten<br>
<code>VMExternRef</code> into the <code>VMExternRefActivationsTable</code> and then "borrow" the reference out of the table.</p>
<p>When a <code>VMExternRef</code> is returned to host code from a Wasm function, the host increments the reference count (because the reference is logically "borrowed" from the <code>VMExternRefActivationsTable</code> and the reference count from the table will be dropped at the next GC).</p>
<p>For more general information on deferred reference counting, see <em>An Examination of Deferred Reference Counting and Cycle Detection</em> by Quinane: <a href="https://openresearch-repository.anu.edu.au/bitstream/1885/42030/2/hon-thesis.pdf">https://openresearch-repository.anu.edu.au/bitstream/1885/42030/2/hon-thesis.pdf</a></p>
<p>cc #929</p>
<p>Fixes #1804</p>
<p>Depends on <a href="https://github.com/rust-lang/backtrace-rs/pull/341">https://github.com/rust-lang/backtrace-rs/pull/341</a></p>
</blockquote>



<a name="200915137"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231832%20externref%3A%20implement%20stack%20map-based%20.../near/200915137" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231832.20externref.3A.20implement.20stack.20map-based.20.2E.2E.2E.html#200915137">(Jun 15 2020 at 16:46)</a>:</h4>
<p>fitzgen updated <a href="https://github.com/bytecodealliance/wasmtime/pull/1832">PR #1832</a> from <code>externref-stack-maps</code> to <code>master</code>:</p>
<blockquote>
<p>For host VM code, we use plain reference counting, where cloning increments the reference count, and dropping decrements it. We can avoid many of the on-stack increment/decrement operations that typically plague the performance of reference counting via Rust's ownership and borrowing system. Moving a <code>VMExternRef</code> avoids mutating its reference count, and borrowing it either avoids the reference count increment or delays it until if/when the <code>VMExternRef</code> is cloned.</p>
<p>When passing a <code>VMExternRef</code> into compiled Wasm code, we don't want to do reference count mutations for every compiled <code>local.{get,set}</code>, nor for every function call. Therefore, we use a variation of <strong>deferred reference counting</strong>, where we only mutate reference counts when storing <code>VMExternRef</code>s somewhere that outlives the activation: into a global or table. Simultaneously, we over-approximate the set of <code>VMExternRef</code>s that are inside Wasm function activations. Periodically, we walk the stack at GC safe points, and use stack map information to precisely identify the set of <code>VMExternRef</code>s inside Wasm activations. Then we take the difference between this precise set and our over-approximation, and decrement the reference count for each of the <code>VMExternRef</code>s that are in our over-approximation but not in the precise set. Finally, the over-approximation is replaced with the precise set.</p>
<p>The <code>VMExternRefActivationsTable</code> implements the over-approximized set of <code>VMExternRef</code>s referenced by Wasm activations. Calling a Wasm function and passing it a <code>VMExternRef</code> moves the <code>VMExternRef</code> into the table, and the compiled Wasm function logically "borrows" the <code>VMExternRef</code> from the table. Similarly, <code>global.get</code> and <code>table.get</code> operations clone the gotten<br>
<code>VMExternRef</code> into the <code>VMExternRefActivationsTable</code> and then "borrow" the reference out of the table.</p>
<p>When a <code>VMExternRef</code> is returned to host code from a Wasm function, the host increments the reference count (because the reference is logically "borrowed" from the <code>VMExternRefActivationsTable</code> and the reference count from the table will be dropped at the next GC).</p>
<p>For more general information on deferred reference counting, see <em>An Examination of Deferred Reference Counting and Cycle Detection</em> by Quinane: <a href="https://openresearch-repository.anu.edu.au/bitstream/1885/42030/2/hon-thesis.pdf">https://openresearch-repository.anu.edu.au/bitstream/1885/42030/2/hon-thesis.pdf</a></p>
<p>cc #929</p>
<p>Fixes #1804</p>
<p>Depends on <a href="https://github.com/rust-lang/backtrace-rs/pull/341">https://github.com/rust-lang/backtrace-rs/pull/341</a></p>
</blockquote>



<a name="200915651"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231832%20externref%3A%20implement%20stack%20map-based%20.../near/200915651" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231832.20externref.3A.20implement.20stack.20map-based.20.2E.2E.2E.html#200915651">(Jun 15 2020 at 16:50)</a>:</h4>
<p>fitzgen updated <a href="https://github.com/bytecodealliance/wasmtime/pull/1832">PR #1832</a> from <code>externref-stack-maps</code> to <code>master</code>:</p>
<blockquote>
<p>For host VM code, we use plain reference counting, where cloning increments the reference count, and dropping decrements it. We can avoid many of the on-stack increment/decrement operations that typically plague the performance of reference counting via Rust's ownership and borrowing system. Moving a <code>VMExternRef</code> avoids mutating its reference count, and borrowing it either avoids the reference count increment or delays it until if/when the <code>VMExternRef</code> is cloned.</p>
<p>When passing a <code>VMExternRef</code> into compiled Wasm code, we don't want to do reference count mutations for every compiled <code>local.{get,set}</code>, nor for every function call. Therefore, we use a variation of <strong>deferred reference counting</strong>, where we only mutate reference counts when storing <code>VMExternRef</code>s somewhere that outlives the activation: into a global or table. Simultaneously, we over-approximate the set of <code>VMExternRef</code>s that are inside Wasm function activations. Periodically, we walk the stack at GC safe points, and use stack map information to precisely identify the set of <code>VMExternRef</code>s inside Wasm activations. Then we take the difference between this precise set and our over-approximation, and decrement the reference count for each of the <code>VMExternRef</code>s that are in our over-approximation but not in the precise set. Finally, the over-approximation is replaced with the precise set.</p>
<p>The <code>VMExternRefActivationsTable</code> implements the over-approximized set of <code>VMExternRef</code>s referenced by Wasm activations. Calling a Wasm function and passing it a <code>VMExternRef</code> moves the <code>VMExternRef</code> into the table, and the compiled Wasm function logically "borrows" the <code>VMExternRef</code> from the table. Similarly, <code>global.get</code> and <code>table.get</code> operations clone the gotten<br>
<code>VMExternRef</code> into the <code>VMExternRefActivationsTable</code> and then "borrow" the reference out of the table.</p>
<p>When a <code>VMExternRef</code> is returned to host code from a Wasm function, the host increments the reference count (because the reference is logically "borrowed" from the <code>VMExternRefActivationsTable</code> and the reference count from the table will be dropped at the next GC).</p>
<p>For more general information on deferred reference counting, see <em>An Examination of Deferred Reference Counting and Cycle Detection</em> by Quinane: <a href="https://openresearch-repository.anu.edu.au/bitstream/1885/42030/2/hon-thesis.pdf">https://openresearch-repository.anu.edu.au/bitstream/1885/42030/2/hon-thesis.pdf</a></p>
<p>cc #929</p>
<p>Fixes #1804</p>
<p>Depends on <a href="https://github.com/rust-lang/backtrace-rs/pull/341">https://github.com/rust-lang/backtrace-rs/pull/341</a></p>
</blockquote>



<a name="200932289"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231832%20externref%3A%20implement%20stack%20map-based%20.../near/200932289" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231832.20externref.3A.20implement.20stack.20map-based.20.2E.2E.2E.html#200932289">(Jun 15 2020 at 19:13)</a>:</h4>
<p>alexcrichton submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/1832#pullrequestreview-430903134">PR Review</a>.</p>



<a name="200932290"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231832%20externref%3A%20implement%20stack%20map-based%20.../near/200932290" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231832.20externref.3A.20implement.20stack.20map-based.20.2E.2E.2E.html#200932290">(Jun 15 2020 at 19:13)</a>:</h4>
<p>alexcrichton submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/1832#pullrequestreview-430903134">PR Review</a>.</p>



<a name="200932291"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231832%20externref%3A%20implement%20stack%20map-based%20.../near/200932291" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231832.20externref.3A.20implement.20stack.20map-based.20.2E.2E.2E.html#200932291">(Jun 15 2020 at 19:13)</a>:</h4>
<p>alexcrichton created <a href="https://github.com/bytecodealliance/wasmtime/pull/1832#discussion_r440375514">PR Review Comment</a>:</p>
<blockquote>
<p>This seems to have gone backwards? </p>
<p>(along with a number of other crates?)</p>
</blockquote>



<a name="200932292"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231832%20externref%3A%20implement%20stack%20map-based%20.../near/200932292" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231832.20externref.3A.20implement.20stack.20map-based.20.2E.2E.2E.html#200932292">(Jun 15 2020 at 19:13)</a>:</h4>
<p>alexcrichton created <a href="https://github.com/bytecodealliance/wasmtime/pull/1832#discussion_r440375239">PR Review Comment</a>:</p>
<blockquote>
<p>FWIW this is likely to break CI <a href="https://github.com/bytecodealliance/wasmtime/issues/1813">until this is fixed</a></p>
</blockquote>



<a name="200932293"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231832%20externref%3A%20implement%20stack%20map-based%20.../near/200932293" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231832.20externref.3A.20implement.20stack.20map-based.20.2E.2E.2E.html#200932293">(Jun 15 2020 at 19:13)</a>:</h4>
<p>alexcrichton created <a href="https://github.com/bytecodealliance/wasmtime/pull/1832#discussion_r440375682">PR Review Comment</a>:</p>
<blockquote>
<p>Published now!</p>
</blockquote>



<a name="200932294"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231832%20externref%3A%20implement%20stack%20map-based%20.../near/200932294" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231832.20externref.3A.20implement.20stack.20map-based.20.2E.2E.2E.html#200932294">(Jun 15 2020 at 19:13)</a>:</h4>
<p>alexcrichton created <a href="https://github.com/bytecodealliance/wasmtime/pull/1832#discussion_r440377553">PR Review Comment</a>:</p>
<blockquote>
<p>I think I commented on this last time too, so sorry if I missed your response in the meantime, but can there be a destructor for this type which debug-asserts that all slots in this <code>chunk</code> are <code>None</code>?</p>
</blockquote>



<a name="200932295"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231832%20externref%3A%20implement%20stack%20map-based%20.../near/200932295" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231832.20externref.3A.20implement.20stack.20map-based.20.2E.2E.2E.html#200932295">(Jun 15 2020 at 19:13)</a>:</h4>
<p>alexcrichton created <a href="https://github.com/bytecodealliance/wasmtime/pull/1832#discussion_r440378491">PR Review Comment</a>:</p>
<blockquote>
<p>Here on <code>insert_slow_path</code> it always inserts in the hash set, but presumably after <code>gc</code> the chunk is empty?</p>
</blockquote>



<a name="200932296"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231832%20externref%3A%20implement%20stack%20map-based%20.../near/200932296" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231832.20externref.3A.20implement.20stack.20map-based.20.2E.2E.2E.html#200932296">(Jun 15 2020 at 19:13)</a>:</h4>
<p>alexcrichton created <a href="https://github.com/bytecodealliance/wasmtime/pull/1832#discussion_r440378713">PR Review Comment</a>:</p>
<blockquote>
<p>Also, should this idiom perhaps be encapsulated in a method on the activation table?</p>
</blockquote>



<a name="200932297"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231832%20externref%3A%20implement%20stack%20map-based%20.../near/200932297" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231832.20externref.3A.20implement.20stack.20map-based.20.2E.2E.2E.html#200932297">(Jun 15 2020 at 19:13)</a>:</h4>
<p>alexcrichton created <a href="https://github.com/bytecodealliance/wasmtime/pull/1832#discussion_r440380949">PR Review Comment</a>:</p>
<blockquote>
<p>Ah right yeah, I think we probably need to clean up that storge of the registrations in <code>Module</code>, but for now seems fine.</p>
</blockquote>



<a name="200932298"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231832%20externref%3A%20implement%20stack%20map-based%20.../near/200932298" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231832.20externref.3A.20implement.20stack.20map-based.20.2E.2E.2E.html#200932298">(Jun 15 2020 at 19:13)</a>:</h4>
<p>alexcrichton created <a href="https://github.com/bytecodealliance/wasmtime/pull/1832#discussion_r440381768">PR Review Comment</a>:</p>
<blockquote>
<p>Instead of <code>#[cfg]</code> could this conditionally panic if <code>if cfg!</code> in the implementation of <code>Deref</code> and such?</p>
</blockquote>



<a name="200932299"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231832%20externref%3A%20implement%20stack%20map-based%20.../near/200932299" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231832.20externref.3A.20implement.20stack.20map-based.20.2E.2E.2E.html#200932299">(Jun 15 2020 at 19:13)</a>:</h4>
<p>alexcrichton created <a href="https://github.com/bytecodealliance/wasmtime/pull/1832#discussion_r440382217">PR Review Comment</a>:</p>
<blockquote>
<p>Ah sorry missed this earlier, but yeah let's try passing around <code>*mut</code> here instead of an owned pointer.</p>
</blockquote>



<a name="200932300"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231832%20externref%3A%20implement%20stack%20map-based%20.../near/200932300" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231832.20externref.3A.20implement.20stack.20map-based.20.2E.2E.2E.html#200932300">(Jun 15 2020 at 19:13)</a>:</h4>
<p>alexcrichton created <a href="https://github.com/bytecodealliance/wasmtime/pull/1832#discussion_r440384784">PR Review Comment</a>:</p>
<blockquote>
<p>Perhaps we should take a leaf out of <code>Rc</code>'s book and use <a href="https://doc.rust-lang.org/std/rc/struct.Rc.html#method.strong_count"><code>strong_count</code></a> for forwards-compatibility with weak references if we ever add them?</p>
</blockquote>



<a name="200932301"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231832%20externref%3A%20implement%20stack%20map-based%20.../near/200932301" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231832.20externref.3A.20implement.20stack.20map-based.20.2E.2E.2E.html#200932301">(Jun 15 2020 at 19:13)</a>:</h4>
<p>alexcrichton created <a href="https://github.com/bytecodealliance/wasmtime/pull/1832#discussion_r440380599">PR Review Comment</a>:</p>
<blockquote>
<p>To confirm, this for sure works, right? One thing I'd be worried about is rustc's rvalue-promotion where the 0 gets promoted into static data. If you did <code>let canary = &amp;0</code>, for example, I think that'd point into static data rather than on the stack. I'd be a bit worried that eventually if rustc did more mir inlining or something like that it'd inline the definition of <code>canary</code> to here and do the rvalue promotion anyway.</p>
<p>In any case so long as this works today I'm fine, and I would imagine that if rustc ever changed it would cause tests to fail here too.</p>
</blockquote>



<a name="200932302"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231832%20externref%3A%20implement%20stack%20map-based%20.../near/200932302" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231832.20externref.3A.20implement.20stack.20map-based.20.2E.2E.2E.html#200932302">(Jun 15 2020 at 19:13)</a>:</h4>
<p>alexcrichton created <a href="https://github.com/bytecodealliance/wasmtime/pull/1832#discussion_r440386861">PR Review Comment</a>:</p>
<blockquote>
<p>I think this'll need to look like <a href="https://github.com/bytecodealliance/wasmtime/blob/357fb11f4603afc5f81eb087e00ca9e543ab4db7/crates/wasmtime/src/runtime.rs#L890-L905"><code>register_jit_code</code></a> ish where we register a compiled module with a <code>Store</code> and metadata about that is stored in <code>Store</code> rather than the <code>Module</code>.</p>
<p>Honestly we should do this with <code>register_frame_info</code> too, but I can tackle that some other time.</p>
</blockquote>



<a name="200932303"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231832%20externref%3A%20implement%20stack%20map-based%20.../near/200932303" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231832.20externref.3A.20implement.20stack.20map-based.20.2E.2E.2E.html#200932303">(Jun 15 2020 at 19:13)</a>:</h4>
<p>alexcrichton created <a href="https://github.com/bytecodealliance/wasmtime/pull/1832#discussion_r440382895">PR Review Comment</a>:</p>
<blockquote>
<p>you can probably avoid passing these two parameters explicitly and read them from the passed-in <code>store</code> argument inside the method.</p>
</blockquote>



<a name="200932304"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231832%20externref%3A%20implement%20stack%20map-based%20.../near/200932304" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231832.20externref.3A.20implement.20stack.20map-based.20.2E.2E.2E.html#200932304">(Jun 15 2020 at 19:13)</a>:</h4>
<p>alexcrichton created <a href="https://github.com/bytecodealliance/wasmtime/pull/1832#discussion_r440385209">PR Review Comment</a>:</p>
<blockquote>
<p>Out of curiosity, could we always enable this? Presumably once reference types ships we'll enable this unconditionally anyway.</p>
</blockquote>



<a name="200932305"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231832%20externref%3A%20implement%20stack%20map-based%20.../near/200932305" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231832.20externref.3A.20implement.20stack.20map-based.20.2E.2E.2E.html#200932305">(Jun 15 2020 at 19:13)</a>:</h4>
<p>alexcrichton created <a href="https://github.com/bytecodealliance/wasmtime/pull/1832#discussion_r440384394">PR Review Comment</a>:</p>
<blockquote>
<p>I think that this API may actually be incorrect for GC, because you can register a module into two stores. The second store won't actually get registered in its <code>registry</code> which I think means GC won't be precise?</p>
</blockquote>



<a name="200932306"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231832%20externref%3A%20implement%20stack%20map-based%20.../near/200932306" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231832.20externref.3A.20implement.20stack.20map-based.20.2E.2E.2E.html#200932306">(Jun 15 2020 at 19:13)</a>:</h4>
<p>alexcrichton created <a href="https://github.com/bytecodealliance/wasmtime/pull/1832#discussion_r440388751">PR Review Comment</a>:</p>
<blockquote>
<p>Answering my own question, if my thought earlier about the stack canary and rvalue promotion breaks things this assertion will break. If our stack canary <em>never</em> works then nothing will get gc'd from the above loop.</p>
</blockquote>



<a name="200938708"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231832%20externref%3A%20implement%20stack%20map-based%20.../near/200938708" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231832.20externref.3A.20implement.20stack.20map-based.20.2E.2E.2E.html#200938708">(Jun 15 2020 at 20:06)</a>:</h4>
<p>fitzgen submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/1832#pullrequestreview-430955354">PR Review</a>.</p>



<a name="200938709"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231832%20externref%3A%20implement%20stack%20map-based%20.../near/200938709" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231832.20externref.3A.20implement.20stack.20map-based.20.2E.2E.2E.html#200938709">(Jun 15 2020 at 20:06)</a>:</h4>
<p>fitzgen created <a href="https://github.com/bytecodealliance/wasmtime/pull/1832#discussion_r440417080">PR Review Comment</a>:</p>
<blockquote>
<p>Sorry I didn't mention this, but since switching from the list-of-chunks representation to your new suggested one, the table automatically runs the <code>Drop</code> implementations, so dropping the table will now properly avoid leaks.</p>
<p>Therefore, I didn't think it was necessary to insert these debug assertions anymore. (Also, inserting them would require that we <code>gc</code> before dropping the table, to ensure that it gets swept. Everything is easier when we can rely on automatic <code>Drop</code>s!)</p>
</blockquote>



<a name="200938798"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231832%20externref%3A%20implement%20stack%20map-based%20.../near/200938798" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231832.20externref.3A.20implement.20stack.20map-based.20.2E.2E.2E.html#200938798">(Jun 15 2020 at 20:07)</a>:</h4>
<p>fitzgen submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/1832#pullrequestreview-430955946">PR Review</a>.</p>



<a name="200938800"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231832%20externref%3A%20implement%20stack%20map-based%20.../near/200938800" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231832.20externref.3A.20implement.20stack.20map-based.20.2E.2E.2E.html#200938800">(Jun 15 2020 at 20:07)</a>:</h4>
<p>fitzgen created <a href="https://github.com/bytecodealliance/wasmtime/pull/1832#discussion_r440417566">PR Review Comment</a>:</p>
<blockquote>
<p>I figured since it is already a slow path, it might as well do de-duplication, rather than use the bump chunk. I can leave a comment to this effect, and also make a method for this idiom.</p>
</blockquote>



<a name="200939131"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231832%20externref%3A%20implement%20stack%20map-based%20.../near/200939131" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231832.20externref.3A.20implement.20stack.20map-based.20.2E.2E.2E.html#200939131">(Jun 15 2020 at 20:10)</a>:</h4>
<p>alexcrichton submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/1832#pullrequestreview-430957636">PR Review</a>.</p>



<a name="200939134"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231832%20externref%3A%20implement%20stack%20map-based%20.../near/200939134" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231832.20externref.3A.20implement.20stack.20map-based.20.2E.2E.2E.html#200939134">(Jun 15 2020 at 20:10)</a>:</h4>
<p>alexcrichton created <a href="https://github.com/bytecodealliance/wasmtime/pull/1832#discussion_r440418968">PR Review Comment</a>:</p>
<blockquote>
<p>Whoops missed that, nice!</p>
</blockquote>



<a name="200939724"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231832%20externref%3A%20implement%20stack%20map-based%20.../near/200939724" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231832.20externref.3A.20implement.20stack.20map-based.20.2E.2E.2E.html#200939724">(Jun 15 2020 at 20:16)</a>:</h4>
<p>fitzgen submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/1832#pullrequestreview-430961254">PR Review</a>.</p>



<a name="200939725"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231832%20externref%3A%20implement%20stack%20map-based%20.../near/200939725" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231832.20externref.3A.20implement.20stack.20map-based.20.2E.2E.2E.html#200939725">(Jun 15 2020 at 20:16)</a>:</h4>
<p>fitzgen created <a href="https://github.com/bytecodealliance/wasmtime/pull/1832#discussion_r440421876">PR Review Comment</a>:</p>
<blockquote>
<p>It does work today (the tests would fail if it didn't, since they are checking the reference counts and asserting that they go down after GC, which means we did sweep the table, which means we saw the canary).</p>
<p>I agree that it is slightly fragile. I don't know what we could do to avoid it without something like <code>test::blackbox</code> or calling <code>getcontext</code> to get the SP (eww out-of-line call).</p>
</blockquote>



<a name="200939908"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231832%20externref%3A%20implement%20stack%20map-based%20.../near/200939908" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231832.20externref.3A.20implement.20stack.20map-based.20.2E.2E.2E.html#200939908">(Jun 15 2020 at 20:17)</a>:</h4>
<p>fitzgen submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/1832#pullrequestreview-430962340">PR Review</a>.</p>



<a name="200939910"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231832%20externref%3A%20implement%20stack%20map-based%20.../near/200939910" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231832.20externref.3A.20implement.20stack.20map-based.20.2E.2E.2E.html#200939910">(Jun 15 2020 at 20:17)</a>:</h4>
<p>fitzgen created <a href="https://github.com/bytecodealliance/wasmtime/pull/1832#discussion_r440422735">PR Review Comment</a>:</p>
<blockquote>
<p>Then we would need to always have the <code>inner: T</code> member and rely on LLVM to optimize it away when not used in non-<code>cfg(debug_assertions)</code>. Does that sound OK to you?</p>
</blockquote>



<a name="200940582"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231832%20externref%3A%20implement%20stack%20map-based%20.../near/200940582" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231832.20externref.3A.20implement.20stack.20map-based.20.2E.2E.2E.html#200940582">(Jun 15 2020 at 20:23)</a>:</h4>
<p>alexcrichton submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/1832#pullrequestreview-430965752">PR Review</a>.</p>



<a name="200940583"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231832%20externref%3A%20implement%20stack%20map-based%20.../near/200940583" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231832.20externref.3A.20implement.20stack.20map-based.20.2E.2E.2E.html#200940583">(Jun 15 2020 at 20:23)</a>:</h4>
<p>alexcrichton created <a href="https://github.com/bytecodealliance/wasmtime/pull/1832#discussion_r440425300">PR Review Comment</a>:</p>
<blockquote>
<p>Yeah given the limited usage of this I trust LLVM enough to figure everything out.</p>
</blockquote>



<a name="200943953"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231832%20externref%3A%20implement%20stack%20map-based%20.../near/200943953" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231832.20externref.3A.20implement.20stack.20map-based.20.2E.2E.2E.html#200943953">(Jun 15 2020 at 20:51)</a>:</h4>
<p>fitzgen submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/1832#pullrequestreview-430983984">PR Review</a>.</p>



<a name="200943954"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231832%20externref%3A%20implement%20stack%20map-based%20.../near/200943954" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231832.20externref.3A.20implement.20stack.20map-based.20.2E.2E.2E.html#200943954">(Jun 15 2020 at 20:51)</a>:</h4>
<p>fitzgen created <a href="https://github.com/bytecodealliance/wasmtime/pull/1832#discussion_r440439480">PR Review Comment</a>:</p>
<blockquote>
<p>Good eye! I didn't realize that a single module could be registered with multiple stores!</p>
</blockquote>



<a name="200947241"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231832%20externref%3A%20implement%20stack%20map-based%20.../near/200947241" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231832.20externref.3A.20implement.20stack.20map-based.20.2E.2E.2E.html#200947241">(Jun 15 2020 at 21:19)</a>:</h4>
<p>fitzgen submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/1832#pullrequestreview-431001279">PR Review</a>.</p>



<a name="200947243"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231832%20externref%3A%20implement%20stack%20map-based%20.../near/200947243" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231832.20externref.3A.20implement.20stack.20map-based.20.2E.2E.2E.html#200947243">(Jun 15 2020 at 21:19)</a>:</h4>
<p>fitzgen created <a href="https://github.com/bytecodealliance/wasmtime/pull/1832#discussion_r440453169">PR Review Comment</a>:</p>
<blockquote>
<p>We could, but it implies an additional pass over the IR by cranelift, and if we know there aren't any being used, then we can skip that unnecessary work.</p>
</blockquote>



<a name="200947271"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231832%20externref%3A%20implement%20stack%20map-based%20.../near/200947271" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231832.20externref.3A.20implement.20stack.20map-based.20.2E.2E.2E.html#200947271">(Jun 15 2020 at 21:19)</a>:</h4>
<p>fitzgen submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/1832#pullrequestreview-431001540">PR Review</a>.</p>



<a name="200947273"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231832%20externref%3A%20implement%20stack%20map-based%20.../near/200947273" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231832.20externref.3A.20implement.20stack.20map-based.20.2E.2E.2E.html#200947273">(Jun 15 2020 at 21:19)</a>:</h4>
<p>fitzgen created <a href="https://github.com/bytecodealliance/wasmtime/pull/1832#discussion_r440453352">PR Review Comment</a>:</p>
<blockquote>
<p>Ah, yep, I see you figured it out :)</p>
</blockquote>



<a name="200947415"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231832%20externref%3A%20implement%20stack%20map-based%20.../near/200947415" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231832.20externref.3A.20implement.20stack.20map-based.20.2E.2E.2E.html#200947415">(Jun 15 2020 at 21:20)</a>:</h4>
<p>fitzgen updated <a href="https://github.com/bytecodealliance/wasmtime/pull/1832">PR #1832</a> from <code>externref-stack-maps</code> to <code>master</code>:</p>
<blockquote>
<p>For host VM code, we use plain reference counting, where cloning increments the reference count, and dropping decrements it. We can avoid many of the on-stack increment/decrement operations that typically plague the performance of reference counting via Rust's ownership and borrowing system. Moving a <code>VMExternRef</code> avoids mutating its reference count, and borrowing it either avoids the reference count increment or delays it until if/when the <code>VMExternRef</code> is cloned.</p>
<p>When passing a <code>VMExternRef</code> into compiled Wasm code, we don't want to do reference count mutations for every compiled <code>local.{get,set}</code>, nor for every function call. Therefore, we use a variation of <strong>deferred reference counting</strong>, where we only mutate reference counts when storing <code>VMExternRef</code>s somewhere that outlives the activation: into a global or table. Simultaneously, we over-approximate the set of <code>VMExternRef</code>s that are inside Wasm function activations. Periodically, we walk the stack at GC safe points, and use stack map information to precisely identify the set of <code>VMExternRef</code>s inside Wasm activations. Then we take the difference between this precise set and our over-approximation, and decrement the reference count for each of the <code>VMExternRef</code>s that are in our over-approximation but not in the precise set. Finally, the over-approximation is replaced with the precise set.</p>
<p>The <code>VMExternRefActivationsTable</code> implements the over-approximized set of <code>VMExternRef</code>s referenced by Wasm activations. Calling a Wasm function and passing it a <code>VMExternRef</code> moves the <code>VMExternRef</code> into the table, and the compiled Wasm function logically "borrows" the <code>VMExternRef</code> from the table. Similarly, <code>global.get</code> and <code>table.get</code> operations clone the gotten<br>
<code>VMExternRef</code> into the <code>VMExternRefActivationsTable</code> and then "borrow" the reference out of the table.</p>
<p>When a <code>VMExternRef</code> is returned to host code from a Wasm function, the host increments the reference count (because the reference is logically "borrowed" from the <code>VMExternRefActivationsTable</code> and the reference count from the table will be dropped at the next GC).</p>
<p>For more general information on deferred reference counting, see <em>An Examination of Deferred Reference Counting and Cycle Detection</em> by Quinane: <a href="https://openresearch-repository.anu.edu.au/bitstream/1885/42030/2/hon-thesis.pdf">https://openresearch-repository.anu.edu.au/bitstream/1885/42030/2/hon-thesis.pdf</a></p>
<p>cc #929</p>
<p>Fixes #1804</p>
<p>Depends on <a href="https://github.com/rust-lang/backtrace-rs/pull/341">https://github.com/rust-lang/backtrace-rs/pull/341</a></p>
</blockquote>



<a name="200947832"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231832%20externref%3A%20implement%20stack%20map-based%20.../near/200947832" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231832.20externref.3A.20implement.20stack.20map-based.20.2E.2E.2E.html#200947832">(Jun 15 2020 at 21:24)</a>:</h4>
<p>fitzgen updated <a href="https://github.com/bytecodealliance/wasmtime/pull/1832">PR #1832</a> from <code>externref-stack-maps</code> to <code>master</code>:</p>
<blockquote>
<p>For host VM code, we use plain reference counting, where cloning increments the reference count, and dropping decrements it. We can avoid many of the on-stack increment/decrement operations that typically plague the performance of reference counting via Rust's ownership and borrowing system. Moving a <code>VMExternRef</code> avoids mutating its reference count, and borrowing it either avoids the reference count increment or delays it until if/when the <code>VMExternRef</code> is cloned.</p>
<p>When passing a <code>VMExternRef</code> into compiled Wasm code, we don't want to do reference count mutations for every compiled <code>local.{get,set}</code>, nor for every function call. Therefore, we use a variation of <strong>deferred reference counting</strong>, where we only mutate reference counts when storing <code>VMExternRef</code>s somewhere that outlives the activation: into a global or table. Simultaneously, we over-approximate the set of <code>VMExternRef</code>s that are inside Wasm function activations. Periodically, we walk the stack at GC safe points, and use stack map information to precisely identify the set of <code>VMExternRef</code>s inside Wasm activations. Then we take the difference between this precise set and our over-approximation, and decrement the reference count for each of the <code>VMExternRef</code>s that are in our over-approximation but not in the precise set. Finally, the over-approximation is replaced with the precise set.</p>
<p>The <code>VMExternRefActivationsTable</code> implements the over-approximized set of <code>VMExternRef</code>s referenced by Wasm activations. Calling a Wasm function and passing it a <code>VMExternRef</code> moves the <code>VMExternRef</code> into the table, and the compiled Wasm function logically "borrows" the <code>VMExternRef</code> from the table. Similarly, <code>global.get</code> and <code>table.get</code> operations clone the gotten<br>
<code>VMExternRef</code> into the <code>VMExternRefActivationsTable</code> and then "borrow" the reference out of the table.</p>
<p>When a <code>VMExternRef</code> is returned to host code from a Wasm function, the host increments the reference count (because the reference is logically "borrowed" from the <code>VMExternRefActivationsTable</code> and the reference count from the table will be dropped at the next GC).</p>
<p>For more general information on deferred reference counting, see <em>An Examination of Deferred Reference Counting and Cycle Detection</em> by Quinane: <a href="https://openresearch-repository.anu.edu.au/bitstream/1885/42030/2/hon-thesis.pdf">https://openresearch-repository.anu.edu.au/bitstream/1885/42030/2/hon-thesis.pdf</a></p>
<p>cc #929</p>
<p>Fixes #1804</p>
<p>Depends on <a href="https://github.com/rust-lang/backtrace-rs/pull/341">https://github.com/rust-lang/backtrace-rs/pull/341</a></p>
</blockquote>



<a name="200947935"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231832%20externref%3A%20implement%20stack%20map-based%20.../near/200947935" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231832.20externref.3A.20implement.20stack.20map-based.20.2E.2E.2E.html#200947935">(Jun 15 2020 at 21:25)</a>:</h4>
<p>fitzgen submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/1832#pullrequestreview-431005092">PR Review</a>.</p>



<a name="200947936"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231832%20externref%3A%20implement%20stack%20map-based%20.../near/200947936" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231832.20externref.3A.20implement.20stack.20map-based.20.2E.2E.2E.html#200947936">(Jun 15 2020 at 21:25)</a>:</h4>
<p>fitzgen created <a href="https://github.com/bytecodealliance/wasmtime/pull/1832#discussion_r440456259">PR Review Comment</a>:</p>
<blockquote>
<p>Okay the new version fixes this by registering with the store, rather than with the module. This also means that we can get rid of <code>StackMapRegistration</code> entirely, and can instead rely on the store to keep the registry itself alive!</p>
</blockquote>



<a name="200947943"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231832%20externref%3A%20implement%20stack%20map-based%20.../near/200947943" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231832.20externref.3A.20implement.20stack.20map-based.20.2E.2E.2E.html#200947943">(Jun 15 2020 at 21:25)</a>:</h4>
<p>alexcrichton submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/1832#pullrequestreview-431005125">PR Review</a>.</p>



<a name="200947944"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231832%20externref%3A%20implement%20stack%20map-based%20.../near/200947944" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231832.20externref.3A.20implement.20stack.20map-based.20.2E.2E.2E.html#200947944">(Jun 15 2020 at 21:25)</a>:</h4>
<p>alexcrichton created <a href="https://github.com/bytecodealliance/wasmtime/pull/1832#discussion_r440456291">PR Review Comment</a>:</p>
<blockquote>
<p>This seems fine for now, but I wanted to point this out because that optimization is something we need to likely implement in short order in that case. In theory there should be a fast path for functions which don't use anyref?</p>
<p>Put another way, if this is scoped to only reference types for performance reasons, then we need to file an issue about that and get it fixed before fully shipping reference types.</p>
</blockquote>



<a name="200948984"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231832%20externref%3A%20implement%20stack%20map-based%20.../near/200948984" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231832.20externref.3A.20implement.20stack.20map-based.20.2E.2E.2E.html#200948984">(Jun 15 2020 at 21:35)</a>:</h4>
<p>fitzgen submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/1832#pullrequestreview-431010319">PR Review</a>.</p>



<a name="200948986"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231832%20externref%3A%20implement%20stack%20map-based%20.../near/200948986" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231832.20externref.3A.20implement.20stack.20map-based.20.2E.2E.2E.html#200948986">(Jun 15 2020 at 21:35)</a>:</h4>
<p>fitzgen created <a href="https://github.com/bytecodealliance/wasmtime/pull/1832#discussion_r440460395">PR Review Comment</a>:</p>
<blockquote>
<p>Filed <a href="https://github.com/bytecodealliance/wasmtime/issues/1883">https://github.com/bytecodealliance/wasmtime/issues/1883</a></p>
</blockquote>



<a name="200951801"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231832%20externref%3A%20implement%20stack%20map-based%20.../near/200951801" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231832.20externref.3A.20implement.20stack.20map-based.20.2E.2E.2E.html#200951801">(Jun 15 2020 at 22:05)</a>:</h4>
<p>alexcrichton submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/1832#pullrequestreview-431022995">PR Review</a>.</p>



<a name="200951802"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231832%20externref%3A%20implement%20stack%20map-based%20.../near/200951802" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231832.20externref.3A.20implement.20stack.20map-based.20.2E.2E.2E.html#200951802">(Jun 15 2020 at 22:05)</a>:</h4>
<p>alexcrichton submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/1832#pullrequestreview-431022995">PR Review</a>.</p>



<a name="200951803"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231832%20externref%3A%20implement%20stack%20map-based%20.../near/200951803" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231832.20externref.3A.20implement.20stack.20map-based.20.2E.2E.2E.html#200951803">(Jun 15 2020 at 22:05)</a>:</h4>
<p>alexcrichton created <a href="https://github.com/bytecodealliance/wasmtime/pull/1832#discussion_r440471123">PR Review Comment</a>:</p>
<blockquote>
<p>I think at this point this can be <code>RefCell</code>?</p>
</blockquote>



<a name="200951804"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231832%20externref%3A%20implement%20stack%20map-based%20.../near/200951804" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231832.20externref.3A.20implement.20stack.20map-based.20.2E.2E.2E.html#200951804">(Jun 15 2020 at 22:05)</a>:</h4>
<p>alexcrichton created <a href="https://github.com/bytecodealliance/wasmtime/pull/1832#discussion_r440470538">PR Review Comment</a>:</p>
<blockquote>
<p>Since these strong references are dropped here, could this either take<code> &amp;...</code> or plumb through the <code>*mut</code> business?</p>
</blockquote>



<a name="200951806"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231832%20externref%3A%20implement%20stack%20map-based%20.../near/200951806" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231832.20externref.3A.20implement.20stack.20map-based.20.2E.2E.2E.html#200951806">(Jun 15 2020 at 22:05)</a>:</h4>
<p>alexcrichton created <a href="https://github.com/bytecodealliance/wasmtime/pull/1832#discussion_r440472392">PR Review Comment</a>:</p>
<blockquote>
<p>To confirm, is every function guaranteed to have a stack map, even if it doesn't use reference types?</p>
</blockquote>



<a name="200951807"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231832%20externref%3A%20implement%20stack%20map-based%20.../near/200951807" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231832.20externref.3A.20implement.20stack.20map-based.20.2E.2E.2E.html#200951807">(Jun 15 2020 at 22:05)</a>:</h4>
<p>alexcrichton created <a href="https://github.com/bytecodealliance/wasmtime/pull/1832#discussion_r440472175">PR Review Comment</a>:</p>
<blockquote>
<p>I think this can be <code>RefCell</code> now?</p>
</blockquote>



<a name="200951808"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231832%20externref%3A%20implement%20stack%20map-based%20.../near/200951808" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231832.20externref.3A.20implement.20stack.20map-based.20.2E.2E.2E.html#200951808">(Jun 15 2020 at 22:05)</a>:</h4>
<p>alexcrichton created <a href="https://github.com/bytecodealliance/wasmtime/pull/1832#discussion_r440473125">PR Review Comment</a>:</p>
<blockquote>
<p>Mind throwing a <code>cfg!</code> here for the target pointer width? (and below too)</p>
</blockquote>



<a name="200951809"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231832%20externref%3A%20implement%20stack%20map-based%20.../near/200951809" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231832.20externref.3A.20implement.20stack.20map-based.20.2E.2E.2E.html#200951809">(Jun 15 2020 at 22:05)</a>:</h4>
<p>alexcrichton created <a href="https://github.com/bytecodealliance/wasmtime/pull/1832#discussion_r440472752">PR Review Comment</a>:</p>
<blockquote>
<p>Oh dear this is nasty, can we load flags from the <code>Store</code> instead of trying to recreate them here though?</p>
</blockquote>



<a name="200951810"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231832%20externref%3A%20implement%20stack%20map-based%20.../near/200951810" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231832.20externref.3A.20implement.20stack.20map-based.20.2E.2E.2E.html#200951810">(Jun 15 2020 at 22:05)</a>:</h4>
<p>alexcrichton created <a href="https://github.com/bytecodealliance/wasmtime/pull/1832#discussion_r440472974">PR Review Comment</a>:</p>
<blockquote>
<p>(in that I think we have a <code>Box&lt;dyn TargetIsa&gt;</code> shoved somewhere in there I think</p>
</blockquote>



<a name="200953875"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231832%20externref%3A%20implement%20stack%20map-based%20.../near/200953875" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231832.20externref.3A.20implement.20stack.20map-based.20.2E.2E.2E.html#200953875">(Jun 15 2020 at 22:31)</a>:</h4>
<p>fitzgen created <a href="https://github.com/bytecodealliance/wasmtime/pull/1832#discussion_r440482850">PR Review Comment</a>:</p>
<blockquote>
<p>Good eye, this is a bug introduced during all the refactoring today. I'm going to just make <code>StackMapRegistry::register_stack_maps</code> idempotent, rather than trying to check if its already registered here. This is a nice little clean up, since the registry is in the best position to answer this question anyways.</p>
</blockquote>



<a name="200953876"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231832%20externref%3A%20implement%20stack%20map-based%20.../near/200953876" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231832.20externref.3A.20implement.20stack.20map-based.20.2E.2E.2E.html#200953876">(Jun 15 2020 at 22:31)</a>:</h4>
<p>fitzgen submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/1832#pullrequestreview-431037551">PR Review</a>.</p>



<a name="200954492"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231832%20externref%3A%20implement%20stack%20map-based%20.../near/200954492" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231832.20externref.3A.20implement.20stack.20map-based.20.2E.2E.2E.html#200954492">(Jun 15 2020 at 22:39)</a>:</h4>
<p>fitzgen updated <a href="https://github.com/bytecodealliance/wasmtime/pull/1832">PR #1832</a> from <code>externref-stack-maps</code> to <code>master</code>:</p>
<blockquote>
<p>For host VM code, we use plain reference counting, where cloning increments the reference count, and dropping decrements it. We can avoid many of the on-stack increment/decrement operations that typically plague the performance of reference counting via Rust's ownership and borrowing system. Moving a <code>VMExternRef</code> avoids mutating its reference count, and borrowing it either avoids the reference count increment or delays it until if/when the <code>VMExternRef</code> is cloned.</p>
<p>When passing a <code>VMExternRef</code> into compiled Wasm code, we don't want to do reference count mutations for every compiled <code>local.{get,set}</code>, nor for every function call. Therefore, we use a variation of <strong>deferred reference counting</strong>, where we only mutate reference counts when storing <code>VMExternRef</code>s somewhere that outlives the activation: into a global or table. Simultaneously, we over-approximate the set of <code>VMExternRef</code>s that are inside Wasm function activations. Periodically, we walk the stack at GC safe points, and use stack map information to precisely identify the set of <code>VMExternRef</code>s inside Wasm activations. Then we take the difference between this precise set and our over-approximation, and decrement the reference count for each of the <code>VMExternRef</code>s that are in our over-approximation but not in the precise set. Finally, the over-approximation is replaced with the precise set.</p>
<p>The <code>VMExternRefActivationsTable</code> implements the over-approximized set of <code>VMExternRef</code>s referenced by Wasm activations. Calling a Wasm function and passing it a <code>VMExternRef</code> moves the <code>VMExternRef</code> into the table, and the compiled Wasm function logically "borrows" the <code>VMExternRef</code> from the table. Similarly, <code>global.get</code> and <code>table.get</code> operations clone the gotten<br>
<code>VMExternRef</code> into the <code>VMExternRefActivationsTable</code> and then "borrow" the reference out of the table.</p>
<p>When a <code>VMExternRef</code> is returned to host code from a Wasm function, the host increments the reference count (because the reference is logically "borrowed" from the <code>VMExternRefActivationsTable</code> and the reference count from the table will be dropped at the next GC).</p>
<p>For more general information on deferred reference counting, see <em>An Examination of Deferred Reference Counting and Cycle Detection</em> by Quinane: <a href="https://openresearch-repository.anu.edu.au/bitstream/1885/42030/2/hon-thesis.pdf">https://openresearch-repository.anu.edu.au/bitstream/1885/42030/2/hon-thesis.pdf</a></p>
<p>cc #929</p>
<p>Fixes #1804</p>
<p>Depends on <a href="https://github.com/rust-lang/backtrace-rs/pull/341">https://github.com/rust-lang/backtrace-rs/pull/341</a></p>
</blockquote>



<a name="200956414"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231832%20externref%3A%20implement%20stack%20map-based%20.../near/200956414" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231832.20externref.3A.20implement.20stack.20map-based.20.2E.2E.2E.html#200956414">(Jun 15 2020 at 23:06)</a>:</h4>
<p>fitzgen updated <a href="https://github.com/bytecodealliance/wasmtime/pull/1832">PR #1832</a> from <code>externref-stack-maps</code> to <code>master</code>:</p>
<blockquote>
<p>For host VM code, we use plain reference counting, where cloning increments the reference count, and dropping decrements it. We can avoid many of the on-stack increment/decrement operations that typically plague the performance of reference counting via Rust's ownership and borrowing system. Moving a <code>VMExternRef</code> avoids mutating its reference count, and borrowing it either avoids the reference count increment or delays it until if/when the <code>VMExternRef</code> is cloned.</p>
<p>When passing a <code>VMExternRef</code> into compiled Wasm code, we don't want to do reference count mutations for every compiled <code>local.{get,set}</code>, nor for every function call. Therefore, we use a variation of <strong>deferred reference counting</strong>, where we only mutate reference counts when storing <code>VMExternRef</code>s somewhere that outlives the activation: into a global or table. Simultaneously, we over-approximate the set of <code>VMExternRef</code>s that are inside Wasm function activations. Periodically, we walk the stack at GC safe points, and use stack map information to precisely identify the set of <code>VMExternRef</code>s inside Wasm activations. Then we take the difference between this precise set and our over-approximation, and decrement the reference count for each of the <code>VMExternRef</code>s that are in our over-approximation but not in the precise set. Finally, the over-approximation is replaced with the precise set.</p>
<p>The <code>VMExternRefActivationsTable</code> implements the over-approximized set of <code>VMExternRef</code>s referenced by Wasm activations. Calling a Wasm function and passing it a <code>VMExternRef</code> moves the <code>VMExternRef</code> into the table, and the compiled Wasm function logically "borrows" the <code>VMExternRef</code> from the table. Similarly, <code>global.get</code> and <code>table.get</code> operations clone the gotten<br>
<code>VMExternRef</code> into the <code>VMExternRefActivationsTable</code> and then "borrow" the reference out of the table.</p>
<p>When a <code>VMExternRef</code> is returned to host code from a Wasm function, the host increments the reference count (because the reference is logically "borrowed" from the <code>VMExternRefActivationsTable</code> and the reference count from the table will be dropped at the next GC).</p>
<p>For more general information on deferred reference counting, see <em>An Examination of Deferred Reference Counting and Cycle Detection</em> by Quinane: <a href="https://openresearch-repository.anu.edu.au/bitstream/1885/42030/2/hon-thesis.pdf">https://openresearch-repository.anu.edu.au/bitstream/1885/42030/2/hon-thesis.pdf</a></p>
<p>cc #929</p>
<p>Fixes #1804</p>
<p>Depends on <a href="https://github.com/rust-lang/backtrace-rs/pull/341">https://github.com/rust-lang/backtrace-rs/pull/341</a></p>
</blockquote>



<a name="200956459"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231832%20externref%3A%20implement%20stack%20map-based%20.../near/200956459" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231832.20externref.3A.20implement.20stack.20map-based.20.2E.2E.2E.html#200956459">(Jun 15 2020 at 23:07)</a>:</h4>
<p>fitzgen updated <a href="https://github.com/bytecodealliance/wasmtime/pull/1832">PR #1832</a> from <code>externref-stack-maps</code> to <code>master</code>:</p>
<blockquote>
<p>For host VM code, we use plain reference counting, where cloning increments the reference count, and dropping decrements it. We can avoid many of the on-stack increment/decrement operations that typically plague the performance of reference counting via Rust's ownership and borrowing system. Moving a <code>VMExternRef</code> avoids mutating its reference count, and borrowing it either avoids the reference count increment or delays it until if/when the <code>VMExternRef</code> is cloned.</p>
<p>When passing a <code>VMExternRef</code> into compiled Wasm code, we don't want to do reference count mutations for every compiled <code>local.{get,set}</code>, nor for every function call. Therefore, we use a variation of <strong>deferred reference counting</strong>, where we only mutate reference counts when storing <code>VMExternRef</code>s somewhere that outlives the activation: into a global or table. Simultaneously, we over-approximate the set of <code>VMExternRef</code>s that are inside Wasm function activations. Periodically, we walk the stack at GC safe points, and use stack map information to precisely identify the set of <code>VMExternRef</code>s inside Wasm activations. Then we take the difference between this precise set and our over-approximation, and decrement the reference count for each of the <code>VMExternRef</code>s that are in our over-approximation but not in the precise set. Finally, the over-approximation is replaced with the precise set.</p>
<p>The <code>VMExternRefActivationsTable</code> implements the over-approximized set of <code>VMExternRef</code>s referenced by Wasm activations. Calling a Wasm function and passing it a <code>VMExternRef</code> moves the <code>VMExternRef</code> into the table, and the compiled Wasm function logically "borrows" the <code>VMExternRef</code> from the table. Similarly, <code>global.get</code> and <code>table.get</code> operations clone the gotten<br>
<code>VMExternRef</code> into the <code>VMExternRefActivationsTable</code> and then "borrow" the reference out of the table.</p>
<p>When a <code>VMExternRef</code> is returned to host code from a Wasm function, the host increments the reference count (because the reference is logically "borrowed" from the <code>VMExternRefActivationsTable</code> and the reference count from the table will be dropped at the next GC).</p>
<p>For more general information on deferred reference counting, see <em>An Examination of Deferred Reference Counting and Cycle Detection</em> by Quinane: <a href="https://openresearch-repository.anu.edu.au/bitstream/1885/42030/2/hon-thesis.pdf">https://openresearch-repository.anu.edu.au/bitstream/1885/42030/2/hon-thesis.pdf</a></p>
<p>cc #929</p>
<p>Fixes #1804</p>
<p>Depends on <a href="https://github.com/rust-lang/backtrace-rs/pull/341">https://github.com/rust-lang/backtrace-rs/pull/341</a></p>
</blockquote>



<a name="200958693"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231832%20externref%3A%20implement%20stack%20map-based%20.../near/200958693" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231832.20externref.3A.20implement.20stack.20map-based.20.2E.2E.2E.html#200958693">(Jun 15 2020 at 23:38)</a>:</h4>
<p>fitzgen updated <a href="https://github.com/bytecodealliance/wasmtime/pull/1832">PR #1832</a> from <code>externref-stack-maps</code> to <code>master</code>:</p>
<blockquote>
<p>For host VM code, we use plain reference counting, where cloning increments the reference count, and dropping decrements it. We can avoid many of the on-stack increment/decrement operations that typically plague the performance of reference counting via Rust's ownership and borrowing system. Moving a <code>VMExternRef</code> avoids mutating its reference count, and borrowing it either avoids the reference count increment or delays it until if/when the <code>VMExternRef</code> is cloned.</p>
<p>When passing a <code>VMExternRef</code> into compiled Wasm code, we don't want to do reference count mutations for every compiled <code>local.{get,set}</code>, nor for every function call. Therefore, we use a variation of <strong>deferred reference counting</strong>, where we only mutate reference counts when storing <code>VMExternRef</code>s somewhere that outlives the activation: into a global or table. Simultaneously, we over-approximate the set of <code>VMExternRef</code>s that are inside Wasm function activations. Periodically, we walk the stack at GC safe points, and use stack map information to precisely identify the set of <code>VMExternRef</code>s inside Wasm activations. Then we take the difference between this precise set and our over-approximation, and decrement the reference count for each of the <code>VMExternRef</code>s that are in our over-approximation but not in the precise set. Finally, the over-approximation is replaced with the precise set.</p>
<p>The <code>VMExternRefActivationsTable</code> implements the over-approximized set of <code>VMExternRef</code>s referenced by Wasm activations. Calling a Wasm function and passing it a <code>VMExternRef</code> moves the <code>VMExternRef</code> into the table, and the compiled Wasm function logically "borrows" the <code>VMExternRef</code> from the table. Similarly, <code>global.get</code> and <code>table.get</code> operations clone the gotten<br>
<code>VMExternRef</code> into the <code>VMExternRefActivationsTable</code> and then "borrow" the reference out of the table.</p>
<p>When a <code>VMExternRef</code> is returned to host code from a Wasm function, the host increments the reference count (because the reference is logically "borrowed" from the <code>VMExternRefActivationsTable</code> and the reference count from the table will be dropped at the next GC).</p>
<p>For more general information on deferred reference counting, see <em>An Examination of Deferred Reference Counting and Cycle Detection</em> by Quinane: <a href="https://openresearch-repository.anu.edu.au/bitstream/1885/42030/2/hon-thesis.pdf">https://openresearch-repository.anu.edu.au/bitstream/1885/42030/2/hon-thesis.pdf</a></p>
<p>cc #929</p>
<p>Fixes #1804</p>
<p>Depends on <a href="https://github.com/rust-lang/backtrace-rs/pull/341">https://github.com/rust-lang/backtrace-rs/pull/341</a></p>
</blockquote>



<a name="200958992"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231832%20externref%3A%20implement%20stack%20map-based%20.../near/200958992" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231832.20externref.3A.20implement.20stack.20map-based.20.2E.2E.2E.html#200958992">(Jun 15 2020 at 23:43)</a>:</h4>
<p>fitzgen updated <a href="https://github.com/bytecodealliance/wasmtime/pull/1832">PR #1832</a> from <code>externref-stack-maps</code> to <code>master</code>:</p>
<blockquote>
<p>For host VM code, we use plain reference counting, where cloning increments the reference count, and dropping decrements it. We can avoid many of the on-stack increment/decrement operations that typically plague the performance of reference counting via Rust's ownership and borrowing system. Moving a <code>VMExternRef</code> avoids mutating its reference count, and borrowing it either avoids the reference count increment or delays it until if/when the <code>VMExternRef</code> is cloned.</p>
<p>When passing a <code>VMExternRef</code> into compiled Wasm code, we don't want to do reference count mutations for every compiled <code>local.{get,set}</code>, nor for every function call. Therefore, we use a variation of <strong>deferred reference counting</strong>, where we only mutate reference counts when storing <code>VMExternRef</code>s somewhere that outlives the activation: into a global or table. Simultaneously, we over-approximate the set of <code>VMExternRef</code>s that are inside Wasm function activations. Periodically, we walk the stack at GC safe points, and use stack map information to precisely identify the set of <code>VMExternRef</code>s inside Wasm activations. Then we take the difference between this precise set and our over-approximation, and decrement the reference count for each of the <code>VMExternRef</code>s that are in our over-approximation but not in the precise set. Finally, the over-approximation is replaced with the precise set.</p>
<p>The <code>VMExternRefActivationsTable</code> implements the over-approximized set of <code>VMExternRef</code>s referenced by Wasm activations. Calling a Wasm function and passing it a <code>VMExternRef</code> moves the <code>VMExternRef</code> into the table, and the compiled Wasm function logically "borrows" the <code>VMExternRef</code> from the table. Similarly, <code>global.get</code> and <code>table.get</code> operations clone the gotten<br>
<code>VMExternRef</code> into the <code>VMExternRefActivationsTable</code> and then "borrow" the reference out of the table.</p>
<p>When a <code>VMExternRef</code> is returned to host code from a Wasm function, the host increments the reference count (because the reference is logically "borrowed" from the <code>VMExternRefActivationsTable</code> and the reference count from the table will be dropped at the next GC).</p>
<p>For more general information on deferred reference counting, see <em>An Examination of Deferred Reference Counting and Cycle Detection</em> by Quinane: <a href="https://openresearch-repository.anu.edu.au/bitstream/1885/42030/2/hon-thesis.pdf">https://openresearch-repository.anu.edu.au/bitstream/1885/42030/2/hon-thesis.pdf</a></p>
<p>cc #929</p>
<p>Fixes #1804</p>
<p>Depends on <a href="https://github.com/rust-lang/backtrace-rs/pull/341">https://github.com/rust-lang/backtrace-rs/pull/341</a></p>
</blockquote>



<a name="200962993"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231832%20externref%3A%20implement%20stack%20map-based%20.../near/200962993" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231832.20externref.3A.20implement.20stack.20map-based.20.2E.2E.2E.html#200962993">(Jun 16 2020 at 00:53)</a>:</h4>
<p>fitzgen updated <a href="https://github.com/bytecodealliance/wasmtime/pull/1832">PR #1832</a> from <code>externref-stack-maps</code> to <code>master</code>:</p>
<blockquote>
<p>For host VM code, we use plain reference counting, where cloning increments the reference count, and dropping decrements it. We can avoid many of the on-stack increment/decrement operations that typically plague the performance of reference counting via Rust's ownership and borrowing system. Moving a <code>VMExternRef</code> avoids mutating its reference count, and borrowing it either avoids the reference count increment or delays it until if/when the <code>VMExternRef</code> is cloned.</p>
<p>When passing a <code>VMExternRef</code> into compiled Wasm code, we don't want to do reference count mutations for every compiled <code>local.{get,set}</code>, nor for every function call. Therefore, we use a variation of <strong>deferred reference counting</strong>, where we only mutate reference counts when storing <code>VMExternRef</code>s somewhere that outlives the activation: into a global or table. Simultaneously, we over-approximate the set of <code>VMExternRef</code>s that are inside Wasm function activations. Periodically, we walk the stack at GC safe points, and use stack map information to precisely identify the set of <code>VMExternRef</code>s inside Wasm activations. Then we take the difference between this precise set and our over-approximation, and decrement the reference count for each of the <code>VMExternRef</code>s that are in our over-approximation but not in the precise set. Finally, the over-approximation is replaced with the precise set.</p>
<p>The <code>VMExternRefActivationsTable</code> implements the over-approximized set of <code>VMExternRef</code>s referenced by Wasm activations. Calling a Wasm function and passing it a <code>VMExternRef</code> moves the <code>VMExternRef</code> into the table, and the compiled Wasm function logically "borrows" the <code>VMExternRef</code> from the table. Similarly, <code>global.get</code> and <code>table.get</code> operations clone the gotten<br>
<code>VMExternRef</code> into the <code>VMExternRefActivationsTable</code> and then "borrow" the reference out of the table.</p>
<p>When a <code>VMExternRef</code> is returned to host code from a Wasm function, the host increments the reference count (because the reference is logically "borrowed" from the <code>VMExternRefActivationsTable</code> and the reference count from the table will be dropped at the next GC).</p>
<p>For more general information on deferred reference counting, see <em>An Examination of Deferred Reference Counting and Cycle Detection</em> by Quinane: <a href="https://openresearch-repository.anu.edu.au/bitstream/1885/42030/2/hon-thesis.pdf">https://openresearch-repository.anu.edu.au/bitstream/1885/42030/2/hon-thesis.pdf</a></p>
<p>cc #929</p>
<p>Fixes #1804</p>
<p>Depends on <a href="https://github.com/rust-lang/backtrace-rs/pull/341">https://github.com/rust-lang/backtrace-rs/pull/341</a></p>
</blockquote>



<a name="200964574"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231832%20externref%3A%20implement%20stack%20map-based%20.../near/200964574" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231832.20externref.3A.20implement.20stack.20map-based.20.2E.2E.2E.html#200964574">(Jun 16 2020 at 01:26)</a>:</h4>
<p>fitzgen merged <a href="https://github.com/bytecodealliance/wasmtime/pull/1832">PR #1832</a>.</p>



<a name="201018234"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231832%20externref%3A%20implement%20stack%20map-based%20.../near/201018234" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231832.20externref.3A.20implement.20stack.20map-based.20.2E.2E.2E.html#201018234">(Jun 16 2020 at 13:56)</a>:</h4>
<p>alexcrichton created <a href="https://github.com/bytecodealliance/wasmtime/pull/1832#discussion_r440870001">PR Review Comment</a>:</p>
<blockquote>
<p>For future instnaces of this, mind tagging this with a FIXME and an issue number so when we get around to aarch64 reference types we can make sure we run all the tests?</p>
</blockquote>



<a name="201018235"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231832%20externref%3A%20implement%20stack%20map-based%20.../near/201018235" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231832.20externref.3A.20implement.20stack.20map-based.20.2E.2E.2E.html#201018235">(Jun 16 2020 at 13:56)</a>:</h4>
<p>alexcrichton submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/1832#pullrequestreview-431531362">PR Review</a>.</p>



<a name="201018266"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231832%20externref%3A%20implement%20stack%20map-based%20.../near/201018266" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231832.20externref.3A.20implement.20stack.20map-based.20.2E.2E.2E.html#201018266">(Jun 16 2020 at 13:56)</a>:</h4>
<p>alexcrichton submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/1832#pullrequestreview-431531802">PR Review</a>.</p>



<a name="201018267"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231832%20externref%3A%20implement%20stack%20map-based%20.../near/201018267" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231832.20externref.3A.20implement.20stack.20map-based.20.2E.2E.2E.html#201018267">(Jun 16 2020 at 13:56)</a>:</h4>
<p>alexcrichton created <a href="https://github.com/bytecodealliance/wasmtime/pull/1832#discussion_r440870222">PR Review Comment</a>:</p>
<blockquote>
<p>Same comment here for the aarch64 testing</p>
</blockquote>



<hr><p>Last updated: Jan 20 2025 at 06:04 UTC</p>
</html>