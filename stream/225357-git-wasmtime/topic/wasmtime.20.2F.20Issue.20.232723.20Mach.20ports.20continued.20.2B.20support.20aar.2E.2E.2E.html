<html>
<head><meta charset="utf-8"><title>wasmtime / Issue #2723 Mach ports continued + support aar... · git-wasmtime · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/index.html">git-wasmtime</a></h2>
<h3>Topic: <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20Issue.20.232723.20Mach.20ports.20continued.20.2B.20support.20aar.2E.2E.2E.html">wasmtime / Issue #2723 Mach ports continued + support aar...</a></h3>

<hr>

<base href="https://bytecodealliance.zulipchat.com">

<head><link href="https://bytecodealliance.github.io/zulip-archive/style.css" rel="stylesheet"></head>

<a name="230071039"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20Issue%20%232723%20Mach%20ports%20continued%20%2B%20support%20aar.../near/230071039" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20Issue.20.232723.20Mach.20ports.20continued.20.2B.20support.20aar.2E.2E.2E.html#230071039">(Mar 12 2021 at 17:51)</a>:</h4>
<p>github-actions[bot] <a href="https://github.com/bytecodealliance/wasmtime/pull/2723#issuecomment-797653760">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/2723">Issue #2723</a>:</p>
<blockquote>
<h4>Subscribe to Label Action</h4>
<p>cc @peterhuene</p>
<p>&lt;details&gt;<br>
This issue or pull request has been labeled: "cranelift", "cranelift:area:aarch64", "wasmtime:api"</p>
<p>Thus the following users have been cc'd because of the following labels:</p>
<ul>
<li>peterhuene: wasmtime:api</li>
</ul>
<p>To subscribe or unsubscribe from this label, edit the &lt;code&gt;.github/subscribe-to-label.json&lt;/code&gt; configuration file.</p>
<p><a href="https://github.com/bytecodealliance/subscribe-to-label-action">Learn more.</a><br>
&lt;/details&gt;</p>
</blockquote>



<a name="230367911"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20Issue%20%232723%20Mach%20ports%20continued%20%2B%20support%20aar.../near/230367911" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20Issue.20.232723.20Mach.20ports.20continued.20.2B.20support.20aar.2E.2E.2E.html#230367911">(Mar 15 2021 at 15:49)</a>:</h4>
<p>bnjbvr <a href="https://github.com/bytecodealliance/wasmtime/pull/2723#issuecomment-799527899">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/2723">Issue #2723</a>:</p>
<blockquote>
<p>I'm hitting this in CI and I've got no clue how to get around it:</p>
<p><div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="n">E</span>: <span class="nc">The</span><span class="w"> </span><span class="n">repository</span><span class="w"> </span><span class="o">'</span><span class="na">https</span>:<span class="c1">//download.opensuse.org/repositories/devel:/kubic:/libcontainers:/stable/xUbuntu_18.04  Release' no longer has a Release file.</span>
</code></pre></div><br>
</p>
</blockquote>



<a name="230515387"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20Issue%20%232723%20Mach%20ports%20continued%20%2B%20support%20aar.../near/230515387" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20Issue.20.232723.20Mach.20ports.20continued.20.2B.20support.20aar.2E.2E.2E.html#230515387">(Mar 16 2021 at 13:55)</a>:</h4>
<p>bnjbvr <a href="https://github.com/bytecodealliance/wasmtime/pull/2723#issuecomment-800277465">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/2723">Issue #2723</a>:</p>
<blockquote>
<p>Thanks for the reviews! This will require a review of <a href="https://github.com/fitzgen/mach/pull/64">https://github.com/fitzgen/mach/pull/64</a>, which I can incorporate in this PR, if it's simpler -- would be nice to have the code be in the right places, though :)</p>
</blockquote>



<a name="230661602"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20Issue%20%232723%20Mach%20ports%20continued%20%2B%20support%20aar.../near/230661602" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20Issue.20.232723.20Mach.20ports.20continued.20.2B.20support.20aar.2E.2E.2E.html#230661602">(Mar 17 2021 at 09:34)</a>:</h4>
<p>bnjbvr <a href="https://github.com/bytecodealliance/wasmtime/pull/2723#issuecomment-800936519">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/2723">Issue #2723</a>:</p>
<blockquote>
<p>Now not depending on the Mach PR anymore; should make the verify CI task happy!</p>
</blockquote>



<a name="230696154"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20Issue%20%232723%20Mach%20ports%20continued%20%2B%20support%20aar.../near/230696154" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20Issue.20.232723.20Mach.20ports.20continued.20.2B.20support.20aar.2E.2E.2E.html#230696154">(Mar 17 2021 at 14:10)</a>:</h4>
<p>alexcrichton <a href="https://github.com/bytecodealliance/wasmtime/pull/2723#issuecomment-801112395">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/2723">Issue #2723</a>:</p>
<blockquote>
<p>To confirm, am I correct in understanding that this PR now serves two purposes and is reading for landing:</p>
<ol>
<li>First it fixes the combination of wasmtime and breakpad on macOS by using mach ports for exceptions instead of signal handlers.</li>
<li>Second it adds a small bit of support for AArch64 mac machines to the point where we can "catch" wasm traps but the backtraces are incorrect. (maybe only one frame of wasm instead of all the frames)</li>
</ol>
<p>Does that sound right? If so seems reasonable to me to land!</p>
</blockquote>



<a name="230697740"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20Issue%20%232723%20Mach%20ports%20continued%20%2B%20support%20aar.../near/230697740" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20Issue.20.232723.20Mach.20ports.20continued.20.2B.20support.20aar.2E.2E.2E.html#230697740">(Mar 17 2021 at 14:20)</a>:</h4>
<p>bnjbvr <a href="https://github.com/bytecodealliance/wasmtime/pull/2723#issuecomment-801120463">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/2723">Issue #2723</a>:</p>
<blockquote>
<p>Yes, this is entirely correct! MacOS CI passing suggests that the backtraces are still properly filled (i.e. contain all the frames) on darwin x86_64.</p>
<p>One note for readers: it's possible to get all the frames in backtrace by using a custom build of libunwind:</p>
<ul>
<li>clone and build libunwind from LLVM's repository. Say <code>/tmp/libunwind_build/</code> contains the build artifacts.</li>
<li>in crates/jit/src/unwind/system.rs, add <code>#[link(lib = "unwind", kind = "static")]</code> on top of the <code>extern "C"</code> block that defines <code>__register_frame</code>.</li>
<li>build with <code>RUSTFLAGS="-L /tmp/libunwind_build/" cargo build</code></li>
</ul>
<p>This is sufficient to get all the frames appearing on backtraces on mac aarch64.</p>
</blockquote>



<a name="230701353"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20Issue%20%232723%20Mach%20ports%20continued%20%2B%20support%20aar.../near/230701353" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20Issue.20.232723.20Mach.20ports.20continued.20.2B.20support.20aar.2E.2E.2E.html#230701353">(Mar 17 2021 at 14:43)</a>:</h4>
<p>alexcrichton <a href="https://github.com/bytecodealliance/wasmtime/pull/2723#issuecomment-801141481">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/2723">Issue #2723</a>:</p>
<blockquote>
<p>Ok! Let's go ahead and land this to get to a more working state along those two points, and we can figure out later how to best handle the unwinding intricacies on macOS AArch64</p>
</blockquote>



<a name="233321376"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20Issue%20%232723%20Mach%20ports%20continued%20%2B%20support%20aar.../near/233321376" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20Issue.20.232723.20Mach.20ports.20continued.20.2B.20support.20aar.2E.2E.2E.html#233321376">(Apr 06 2021 at 13:48)</a>:</h4>
<p>bnjbvr edited a <a href="https://github.com/bytecodealliance/wasmtime/pull/2723#issuecomment-801120463">comment</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/2723">Issue #2723</a>:</p>
<blockquote>
<p>Yes, this is entirely correct! MacOS CI passing suggests that the backtraces are still properly filled (i.e. contain all the frames) on darwin x86_64.</p>
<p>One note for readers: it's possible to get all the frames in backtrace by using a custom build of libunwind:</p>
<ul>
<li>clone and build libunwind from LLVM's repository. Say <code>/tmp/libunwind_build/</code> contains the build artifacts.</li>
<li>in crates/jit/src/unwind/system.rs, add <code>#[link(name = "unwind", kind = "static")]</code> on top of the <code>extern "C"</code> block that defines <code>__register_frame</code>.</li>
<li>build with <code>RUSTFLAGS="-L /tmp/libunwind_build/" cargo build</code></li>
</ul>
<p>This is sufficient to get all the frames appearing on backtraces on mac aarch64.</p>
</blockquote>



<hr><p>Last updated: Jan 20 2025 at 06:04 UTC</p>
</html>