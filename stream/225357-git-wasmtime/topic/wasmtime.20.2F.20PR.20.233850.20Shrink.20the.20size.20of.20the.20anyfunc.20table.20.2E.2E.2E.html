<html>
<head><meta charset="utf-8"><title>wasmtime / PR #3850 Shrink the size of the anyfunc table ... · git-wasmtime · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/index.html">git-wasmtime</a></h2>
<h3>Topic: <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.233850.20Shrink.20the.20size.20of.20the.20anyfunc.20table.20.2E.2E.2E.html">wasmtime / PR #3850 Shrink the size of the anyfunc table ...</a></h3>

<hr>

<base href="https://bytecodealliance.zulipchat.com">

<head><link href="https://bytecodealliance.github.io/zulip-archive/style.css" rel="stylesheet"></head>

<a name="273249137"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%233850%20Shrink%20the%20size%20of%20the%20anyfunc%20table%20.../near/273249137" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.233850.20Shrink.20the.20size.20of.20the.20anyfunc.20table.20.2E.2E.2E.html#273249137">(Feb 25 2022 at 16:19)</a>:</h4>
<p>alexcrichton opened <a href="https://github.com/bytecodealliance/wasmtime/pull/3850">PR #3850</a> from <code>smaller-anyfunc-table</code> to <code>main</code>:</p>
<blockquote>
<p>This commit shrinks the size of the <code>VMCallerCheckedAnyfunc</code> table<br>
allocated into a <code>VMContext</code> to be the size of the number of "escaped"<br>
functions in a module rather than the number of functions in a module.<br>
Escaped functions include exports, table elements, etc, and are<br>
typically an order of magnitude smaller than the number of functions in<br>
general. This should greatly shrink the <code>VMContext</code> for some modules<br>
which while we aren't necessarily having any problems with that today<br>
shouldn't cause any problems in the future.</p>
<p>The original motivation for this was that this came up during the recent<br>
lazy-table-initialization work and while it no longer has a direct<br>
performance benefit since tables aren't initialized at all on<br>
instantiation it should still improve long-running instances<br>
theoretically with smaller <code>VMContext</code> allocations as well as better<br>
locality between anyfuncs.</p>
<p>&lt;!--</p>
<p>Please ensure that the following steps are all taken care of before submitting<br>
the PR.</p>
<ul>
<li>
<p>[ ] This has been discussed in issue #..., or if not, please tell us why<br>
  here.</p>
</li>
<li>
<p>[ ] A short description of what this does, why it is needed; if the<br>
  description becomes long, the matter should probably be discussed in an issue<br>
  first.</p>
</li>
<li>
<p>[ ] This PR contains test cases, if meaningful.</p>
</li>
<li>[ ] A reviewer from the core maintainer team has been assigned for this PR.<br>
  If you don't know who could review this, please indicate so. The list of<br>
  suggested reviewers on the right can help you.</li>
</ul>
<p>Please ensure all communication adheres to the <a href="https://github.com/bytecodealliance/wasmtime/blob/master/CODE_OF_CONDUCT.md">code of
conduct</a>.<br>
--&gt;<br>
</p>
</blockquote>



<a name="273253956"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%233850%20Shrink%20the%20size%20of%20the%20anyfunc%20table%20.../near/273253956" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.233850.20Shrink.20the.20size.20of.20the.20anyfunc.20table.20.2E.2E.2E.html#273253956">(Feb 25 2022 at 16:56)</a>:</h4>
<p>alexcrichton updated <a href="https://github.com/bytecodealliance/wasmtime/pull/3850">PR #3850</a> from <code>smaller-anyfunc-table</code> to <code>main</code>.</p>



<a name="273254696"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%233850%20Shrink%20the%20size%20of%20the%20anyfunc%20table%20.../near/273254696" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.233850.20Shrink.20the.20size.20of.20the.20anyfunc.20table.20.2E.2E.2E.html#273254696">(Feb 25 2022 at 17:01)</a>:</h4>
<p>cfallin submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/3850#pullrequestreview-893934560">PR review</a>.</p>



<a name="273254697"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%233850%20Shrink%20the%20size%20of%20the%20anyfunc%20table%20.../near/273254697" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.233850.20Shrink.20the.20size.20of.20the.20anyfunc.20table.20.2E.2E.2E.html#273254697">(Feb 25 2022 at 17:01)</a>:</h4>
<p>cfallin submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/3850#pullrequestreview-893934560">PR review</a>.</p>



<a name="273254698"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%233850%20Shrink%20the%20size%20of%20the%20anyfunc%20table%20.../near/273254698" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.233850.20Shrink.20the.20size.20of.20the.20anyfunc.20table.20.2E.2E.2E.html#273254698">(Feb 25 2022 at 17:01)</a>:</h4>
<p>cfallin created <a href="https://github.com/bytecodealliance/wasmtime/pull/3850#discussion_r814934063">PR review comment</a>:</p>
<blockquote>
<p>Could we extract a helper (<code>add_func_with_signature</code> or somesuch) since this occurs in three spots and is now a bit repetitive?</p>
</blockquote>



<a name="273254700"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%233850%20Shrink%20the%20size%20of%20the%20anyfunc%20table%20.../near/273254700" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.233850.20Shrink.20the.20size.20of.20the.20anyfunc.20table.20.2E.2E.2E.html#273254700">(Feb 25 2022 at 17:01)</a>:</h4>
<p>cfallin created <a href="https://github.com/bytecodealliance/wasmtime/pull/3850#discussion_r814935498">PR review comment</a>:</p>
<blockquote>
<p>Since <code>anyfunc</code> will always be <code>reserved_value</code> (we assert this just below), can we use that as an indicator here rather than a separate <code>HashSet</code>?</p>
</blockquote>



<a name="273254797"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%233850%20Shrink%20the%20size%20of%20the%20anyfunc%20table%20.../near/273254797" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.233850.20Shrink.20the.20size.20of.20the.20anyfunc.20table.20.2E.2E.2E.html#273254797">(Feb 25 2022 at 17:01)</a>:</h4>
<p>cfallin edited <a href="https://github.com/bytecodealliance/wasmtime/pull/3850#discussion_r814935498">PR review comment</a>.</p>



<a name="273256815"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%233850%20Shrink%20the%20size%20of%20the%20anyfunc%20table%20.../near/273256815" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.233850.20Shrink.20the.20size.20of.20the.20anyfunc.20table.20.2E.2E.2E.html#273256815">(Feb 25 2022 at 17:15)</a>:</h4>
<p>alexcrichton updated <a href="https://github.com/bytecodealliance/wasmtime/pull/3850">PR #3850</a> from <code>smaller-anyfunc-table</code> to <code>main</code>.</p>



<a name="273256845"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%233850%20Shrink%20the%20size%20of%20the%20anyfunc%20table%20.../near/273256845" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.233850.20Shrink.20the.20size.20of.20the.20anyfunc.20table.20.2E.2E.2E.html#273256845">(Feb 25 2022 at 17:15)</a>:</h4>
<p>alexcrichton submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/3850#pullrequestreview-893954979">PR review</a>.</p>



<a name="273256846"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%233850%20Shrink%20the%20size%20of%20the%20anyfunc%20table%20.../near/273256846" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.233850.20Shrink.20the.20size.20of.20the.20anyfunc.20table.20.2E.2E.2E.html#273256846">(Feb 25 2022 at 17:15)</a>:</h4>
<p>alexcrichton created <a href="https://github.com/bytecodealliance/wasmtime/pull/3850#discussion_r814948722">PR review comment</a>:</p>
<blockquote>
<p>Oh nice idea!</p>
</blockquote>



<a name="273257694"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%233850%20Shrink%20the%20size%20of%20the%20anyfunc%20table%20.../near/273257694" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.233850.20Shrink.20the.20size.20of.20the.20anyfunc.20table.20.2E.2E.2E.html#273257694">(Feb 25 2022 at 17:21)</a>:</h4>
<p>sunfishcode submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/3850#pullrequestreview-893956680">PR review</a>.</p>



<a name="273257695"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%233850%20Shrink%20the%20size%20of%20the%20anyfunc%20table%20.../near/273257695" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.233850.20Shrink.20the.20size.20of.20the.20anyfunc.20table.20.2E.2E.2E.html#273257695">(Feb 25 2022 at 17:21)</a>:</h4>
<p>sunfishcode submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/3850#pullrequestreview-893956680">PR review</a>.</p>



<a name="273257696"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%233850%20Shrink%20the%20size%20of%20the%20anyfunc%20table%20.../near/273257696" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.233850.20Shrink.20the.20size.20of.20the.20anyfunc.20table.20.2E.2E.2E.html#273257696">(Feb 25 2022 at 17:21)</a>:</h4>
<p>sunfishcode created <a href="https://github.com/bytecodealliance/wasmtime/pull/3850#discussion_r814952300">PR review comment</a>:</p>
<blockquote>
<p>"Global" in the comment here is a little ambiguous; would it be correct to say "module-wide" instead?</p>
</blockquote>



<a name="273257697"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%233850%20Shrink%20the%20size%20of%20the%20anyfunc%20table%20.../near/273257697" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.233850.20Shrink.20the.20size.20of.20the.20anyfunc.20table.20.2E.2E.2E.html#273257697">(Feb 25 2022 at 17:21)</a>:</h4>
<p>sunfishcode created <a href="https://github.com/bytecodealliance/wasmtime/pull/3850#discussion_r814949854">PR review comment</a>:</p>
<blockquote>
<p>What would you think about adding <code>is_escaping(&amp;self) -&gt; bool</code> and <code>non_escaping() -&gt; Self</code> functions for <code>FunctionType</code>, instead of having <code>is_reserved_value()</code> and <code>reserved_value()</code> calls in lots of places? That'd make code using this more self-explanitory.</p>
</blockquote>



<a name="273500426"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%233850%20Shrink%20the%20size%20of%20the%20anyfunc%20table%20.../near/273500426" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.233850.20Shrink.20the.20size.20of.20the.20anyfunc.20table.20.2E.2E.2E.html#273500426">(Feb 28 2022 at 14:54)</a>:</h4>
<p>alexcrichton updated <a href="https://github.com/bytecodealliance/wasmtime/pull/3850">PR #3850</a> from <code>smaller-anyfunc-table</code> to <code>main</code>.</p>



<a name="273505707"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%233850%20Shrink%20the%20size%20of%20the%20anyfunc%20table%20.../near/273505707" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.233850.20Shrink.20the.20size.20of.20the.20anyfunc.20table.20.2E.2E.2E.html#273505707">(Feb 28 2022 at 15:28)</a>:</h4>
<p>alexcrichton updated <a href="https://github.com/bytecodealliance/wasmtime/pull/3850">PR #3850</a> from <code>smaller-anyfunc-table</code> to <code>main</code>.</p>



<a name="273507607"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%233850%20Shrink%20the%20size%20of%20the%20anyfunc%20table%20.../near/273507607" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.233850.20Shrink.20the.20size.20of.20the.20anyfunc.20table.20.2E.2E.2E.html#273507607">(Feb 28 2022 at 15:39)</a>:</h4>
<p>alexcrichton updated <a href="https://github.com/bytecodealliance/wasmtime/pull/3850">PR #3850</a> from <code>smaller-anyfunc-table</code> to <code>main</code>.</p>



<a name="273513095"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%233850%20Shrink%20the%20size%20of%20the%20anyfunc%20table%20.../near/273513095" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.233850.20Shrink.20the.20size.20of.20the.20anyfunc.20table.20.2E.2E.2E.html#273513095">(Feb 28 2022 at 16:11)</a>:</h4>
<p>alexcrichton merged <a href="https://github.com/bytecodealliance/wasmtime/pull/3850">PR #3850</a>.</p>



<hr><p>Last updated: Jan 20 2025 at 06:04 UTC</p>
</html>