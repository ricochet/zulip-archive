<html>
<head><meta charset="utf-8"><title>wasmtime / Issue #2547 Wasmtime host address calculation ... · git-wasmtime · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/index.html">git-wasmtime</a></h2>
<h3>Topic: <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20Issue.20.232547.20Wasmtime.20host.20address.20calculation.20.2E.2E.2E.html">wasmtime / Issue #2547 Wasmtime host address calculation ...</a></h3>

<hr>

<base href="https://bytecodealliance.zulipchat.com">

<head><link href="https://bytecodealliance.github.io/zulip-archive/style.css" rel="stylesheet"></head>

<a name="221689890"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20Issue%20%232547%20Wasmtime%20host%20address%20calculation%20.../near/221689890" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20Issue.20.232547.20Wasmtime.20host.20address.20calculation.20.2E.2E.2E.html#221689890">(Jan 05 2021 at 19:24)</a>:</h4>
<p>JulietteCarter opened <a href="https://github.com/bytecodealliance/wasmtime/issues/2547">Issue #2547</a>:</p>
<blockquote>
<p>I am having issues understanding how to access data stored in the different parts of a wasm module's memory (data, stack and heap), from a runtime in C (using libwasmtime.a).</p>
<p>I'm trying to pass a C string literal pointer from a WebAssembly program to an imported function implemented in C in the wasm runtime. Adding the 'base memory pointer' to the guest pointer address doesn't yield a valid host address when strings are stored on the stack or in the heap. It only works for global data. I don't know what I'm doing wrong. How do I compute the host address for all global, stack and heap memory addresses? </p>
<p>I have constructed the following reproducible test case to illustrate the problem.<br>
I have produced a small c++ example, which creates a static string (global data) <code>globalStr</code>, a string allocated on the stack <code>stackStr</code>, and string allocated on the heap <code>heapStr</code>.</p>
<p>For each of those 3 strings, I print the value of the string and its memory address. I then call the custom import <code>printHostAddress</code> (which I implement in the runtime - see later), which tries to access the memory at the address passed from the wasm module to the runtime.</p>
<p>Produced from wasmtime main branch, commit hash <code>128c3bd74</code>.<br>
Using clang++ version 10.0.0.</p>
<p>Example below, compiled to wasm using the wasi-sdk.</p>
<div class="codehilite" data-code-language="C++"><pre><span></span><code><span class="cm">/* example.cpp</span>

<span class="cm">Compile to wasm: clang++ --target=wasm32-wasi -Wl,--allow-undefined -o example.wasm example.cpp</span>
<span class="cm">*/</span>

<span class="cp">#include</span> <span class="cpf">&lt;stdio.h&gt;</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&lt;string.h&gt;</span><span class="cp"></span>

<span class="k">extern</span> <span class="s">"C"</span> <span class="kt">void</span> <span class="n">printHostAddress</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span><span class="o">*</span> <span class="n">str</span><span class="p">);</span> <span class="c1">// custom import</span>

<span class="kt">int</span> <span class="nf">main</span><span class="p">()</span>
<span class="p">{</span>
    <span class="c1">// Global data</span>
    <span class="k">static</span> <span class="k">const</span> <span class="kt">char</span><span class="o">*</span> <span class="n">globalStr</span> <span class="o">=</span> <span class="s">"Global data"</span><span class="p">;</span>
    <span class="n">printf</span><span class="p">(</span><span class="s">"Global data str: %s, ptr: %p</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">globalStr</span><span class="p">,</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">globalStr</span><span class="p">);</span> <span class="c1">// call wasi imports</span>
    <span class="n">printHostAddress</span><span class="p">(</span><span class="n">globalStr</span><span class="p">);</span> <span class="c1">// call custom import</span>

    <span class="c1">// Stack allocation</span>
    <span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="n">strLiteral</span><span class="p">[]</span> <span class="o">=</span> <span class="s">"Stack data"</span><span class="p">;</span>
    <span class="kt">char</span> <span class="n">stackStr</span><span class="p">[</span><span class="k">sizeof</span><span class="p">(</span><span class="n">strLiteral</span><span class="p">)];</span>
    <span class="n">strcpy</span><span class="p">(</span><span class="n">stackStr</span><span class="p">,</span> <span class="n">strLiteral</span><span class="p">);</span>
    <span class="n">printf</span><span class="p">(</span><span class="s">"Stack str: %s, ptr: %p</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">stackStr</span><span class="p">,</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">stackStr</span><span class="p">);</span> <span class="c1">// call wasi imports</span>
    <span class="n">printHostAddress</span><span class="p">(</span><span class="n">stackStr</span><span class="p">);</span> <span class="c1">// call custom import</span>

    <span class="c1">// Heap allocation</span>
    <span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="n">strLiteral2</span><span class="p">[]</span> <span class="o">=</span> <span class="s">"Heap data"</span><span class="p">;</span>
    <span class="kt">char</span><span class="o">*</span> <span class="n">heapStr</span> <span class="o">=</span> <span class="k">new</span> <span class="kt">char</span><span class="p">[</span><span class="k">sizeof</span><span class="p">(</span><span class="n">strLiteral2</span><span class="p">)];</span>
    <span class="n">strcpy</span><span class="p">(</span><span class="n">heapStr</span><span class="p">,</span> <span class="n">strLiteral2</span><span class="p">);</span>
    <span class="n">printf</span><span class="p">(</span><span class="s">"Heap str: %s, ptr: %p</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">heapStr</span><span class="p">,</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">heapStr</span><span class="p">);</span> <span class="c1">// call wasi imports</span>
    <span class="n">printHostAddress</span><span class="p">(</span><span class="n">heapStr</span><span class="p">);</span> <span class="c1">// call custom import</span>

    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div>
<p>I've provided the cpp implementation for the runtime below. Most of it is boilerplate code, the bit of interest is the implementation of the <code>printHostAddress</code> import function, given to the example.wasm module (see <code>printHostAddress_callback</code>).</p>
<div class="codehilite" data-code-language="C++"><pre><span></span><code><span class="cm">/* runtime.cpp</span>

<span class="cm">    To build, from wasmtime repo:</span>
<span class="cm">    1. Build libwasmtime.a:</span>
<span class="cm">        cargo build --release -p wasmtime-c-api</span>
<span class="cm">    2. Build runtime.cpp</span>
<span class="cm">        clang++ target/release/libwasmtime.a \</span>
<span class="cm">             -I./crates/c-api/include/ \</span>
<span class="cm">             -I./crates/c-api/wasm-c-api/include \</span>
<span class="cm">             -o runtime runtime.cpp</span>
<span class="cm">*/</span>


<span class="cp">#include</span> <span class="cpf">&lt;assert.h&gt;</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&lt;stdio.h&gt;</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&lt;stdlib.h&gt;</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&lt;wasm.h&gt;</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&lt;wasi.h&gt;</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&lt;wasmtime.h&gt;</span><span class="cp"></span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">exit_with_error</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">message</span><span class="p">,</span> <span class="n">wasmtime_error_t</span> <span class="o">*</span><span class="n">error</span><span class="p">,</span> <span class="n">wasm_trap_t</span> <span class="o">*</span><span class="n">trap</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="s">"error: %s</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">message</span><span class="p">);</span>
    <span class="n">wasm_byte_vec_t</span> <span class="n">error_message</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">error</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">wasmtime_error_message</span><span class="p">(</span><span class="n">error</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">error_message</span><span class="p">);</span>
        <span class="n">wasmtime_error_delete</span><span class="p">(</span><span class="n">error</span><span class="p">);</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="n">wasm_trap_message</span><span class="p">(</span><span class="n">trap</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">error_message</span><span class="p">);</span>
        <span class="n">wasm_trap_delete</span><span class="p">(</span><span class="n">trap</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="s">"%.*s</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span> <span class="n">error_message</span><span class="p">.</span><span class="n">size</span><span class="p">,</span> <span class="n">error_message</span><span class="p">.</span><span class="n">data</span><span class="p">);</span>
    <span class="n">wasm_byte_vec_delete</span><span class="p">(</span><span class="o">&amp;</span><span class="n">error_message</span><span class="p">);</span>
    <span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
<span class="p">}</span>

<span class="c1">// Make memory a global to access it in the printHostAddress_callback function</span>
<span class="n">wasm_memory_t</span><span class="o">*</span> <span class="n">g_memory</span><span class="p">;</span>

<span class="n">wasm_memory_t</span><span class="o">*</span> <span class="nf">get_export_memory</span><span class="p">(</span><span class="k">const</span> <span class="n">wasm_extern_vec_t</span><span class="o">*</span> <span class="n">exports</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">i</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">exports</span><span class="o">-&gt;</span><span class="n">size</span> <span class="o">&lt;=</span> <span class="n">i</span> <span class="o">||</span> <span class="o">!</span><span class="n">wasm_extern_as_memory</span><span class="p">(</span><span class="n">exports</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="p">]))</span> <span class="p">{</span>
    <span class="n">printf</span><span class="p">(</span><span class="s">"&gt; Error accessing memory export %zu!</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
    <span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
  <span class="p">}</span>
  <span class="k">return</span> <span class="n">wasm_extern_as_memory</span><span class="p">(</span><span class="n">exports</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
<span class="p">}</span>
<span class="cm">/*</span>
<span class="cm">    LOOK HERE!</span>
<span class="cm">*/</span>
<span class="k">static</span> <span class="n">wasm_trap_t</span><span class="o">*</span> <span class="n">printHostAddress_callback</span><span class="p">(</span><span class="k">const</span> <span class="n">wasm_val_t</span> <span class="n">args</span><span class="p">[],</span> <span class="n">wasm_val_t</span> <span class="n">results</span><span class="p">[])</span>
<span class="p">{</span>
    <span class="n">printf</span><span class="p">(</span><span class="s">"&gt; Print Host Address Callback: </span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
    <span class="k">auto</span> <span class="n">base_memory</span> <span class="o">=</span> <span class="n">wasm_memory_data</span><span class="p">(</span><span class="n">g_memory</span><span class="p">);</span>
    <span class="n">printf</span><span class="p">(</span><span class="s">"&gt; Base memory: %p</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span><span class="n">base_memory</span><span class="p">);</span>
    <span class="k">const</span> <span class="kt">char</span><span class="o">*</span> <span class="n">str</span> <span class="o">=</span> <span class="k">reinterpret_cast</span><span class="o">&lt;</span><span class="k">const</span> <span class="kt">char</span><span class="o">*</span> <span class="o">&gt;</span><span class="p">(</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">of</span><span class="p">.</span><span class="n">i32</span> <span class="o">+</span> <span class="n">base_memory</span><span class="p">);</span>
    <span class="n">printf</span><span class="p">(</span><span class="s">"&gt; Received ptr: %p</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">str</span><span class="p">);</span>
    <span class="n">printf</span><span class="p">(</span><span class="s">"&gt; String value: %s</span><span class="se">\n\n</span><span class="s">"</span><span class="p">,</span> <span class="n">str</span><span class="p">);</span>
    <span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="c1">///////////// Boilerplate code starts here!</span>
<span class="kt">int</span> <span class="n">main</span><span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">argv</span><span class="p">[])</span>
<span class="p">{</span>
    <span class="k">const</span> <span class="kt">char</span><span class="o">*</span> <span class="n">wasm_module_file</span> <span class="o">=</span> <span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>

    <span class="c1">// Set up our context</span>
    <span class="n">wasm_engine_t</span><span class="o">*</span> <span class="n">engine</span> <span class="o">=</span> <span class="n">wasm_engine_new</span><span class="p">();</span>
    <span class="n">assert</span><span class="p">(</span><span class="n">engine</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">);</span>
    <span class="n">wasm_store_t</span><span class="o">*</span> <span class="n">store</span> <span class="o">=</span> <span class="n">wasm_store_new</span><span class="p">(</span><span class="n">engine</span><span class="p">);</span>
    <span class="n">assert</span><span class="p">(</span><span class="n">store</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">);</span>

    <span class="n">wasm_byte_vec_t</span> <span class="n">wasm</span><span class="p">;</span>
    <span class="c1">// Load our input file to parse it next</span>
    <span class="kt">FILE</span><span class="o">*</span> <span class="n">file</span> <span class="o">=</span> <span class="n">fopen</span><span class="p">(</span><span class="n">wasm_module_file</span><span class="p">,</span> <span class="s">"rb"</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">file</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">printf</span><span class="p">(</span><span class="s">"&gt; Error loading file %s!</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">wasm_module_file</span><span class="p">);</span>
        <span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="n">fseek</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="mf">0L</span><span class="p">,</span> <span class="n">SEEK_END</span><span class="p">);</span>
    <span class="kt">size_t</span> <span class="n">file_size</span> <span class="o">=</span> <span class="n">ftell</span><span class="p">(</span><span class="n">file</span><span class="p">);</span>
    <span class="n">wasm_byte_vec_new_uninitialized</span><span class="p">(</span><span class="o">&amp;</span><span class="n">wasm</span><span class="p">,</span> <span class="n">file_size</span><span class="p">);</span>
    <span class="n">fseek</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="mf">0L</span><span class="p">,</span> <span class="n">SEEK_SET</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">fread</span><span class="p">(</span><span class="n">wasm</span><span class="p">.</span><span class="n">data</span><span class="p">,</span> <span class="n">file_size</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">file</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">printf</span><span class="p">(</span><span class="s">"&gt; Error loading module!</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
        <span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="n">fclose</span><span class="p">(</span><span class="n">file</span><span class="p">);</span>

    <span class="c1">// Compile our modules</span>
    <span class="n">wasm_module_t</span><span class="o">*</span> <span class="k">module</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
    <span class="n">wasmtime_error_t</span><span class="o">*</span> <span class="n">error</span> <span class="o">=</span> <span class="n">wasmtime_module_new</span><span class="p">(</span><span class="n">engine</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">wasm</span><span class="p">,</span> <span class="o">&amp;</span><span class="k">module</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">module</span><span class="p">)</span>
        <span class="n">exit_with_error</span><span class="p">(</span><span class="s">"failed to compile module"</span><span class="p">,</span> <span class="n">error</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>

    <span class="n">wasm_byte_vec_delete</span><span class="p">(</span><span class="o">&amp;</span><span class="n">wasm</span><span class="p">);</span>

    <span class="c1">// Instantiate wasi</span>
    <span class="n">wasi_config_t</span> <span class="o">*</span><span class="n">wasi_config</span> <span class="o">=</span> <span class="n">wasi_config_new</span><span class="p">();</span>
    <span class="n">assert</span><span class="p">(</span><span class="n">wasi_config</span><span class="p">);</span>
    <span class="n">wasi_config_inherit_argv</span><span class="p">(</span><span class="n">wasi_config</span><span class="p">);</span>
    <span class="n">wasi_config_inherit_env</span><span class="p">(</span><span class="n">wasi_config</span><span class="p">);</span>
    <span class="n">wasi_config_inherit_stdin</span><span class="p">(</span><span class="n">wasi_config</span><span class="p">);</span>
    <span class="n">wasi_config_inherit_stdout</span><span class="p">(</span><span class="n">wasi_config</span><span class="p">);</span>
    <span class="n">wasi_config_inherit_stderr</span><span class="p">(</span><span class="n">wasi_config</span><span class="p">);</span>

    <span class="n">wasm_trap_t</span> <span class="o">*</span><span class="n">trap</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
    <span class="n">wasi_instance_t</span> <span class="o">*</span><span class="n">wasi</span> <span class="o">=</span> <span class="n">wasi_instance_new</span><span class="p">(</span><span class="n">store</span><span class="p">,</span> <span class="s">"wasi_snapshot_preview1"</span><span class="p">,</span> <span class="n">wasi_config</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">trap</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">wasi</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
        <span class="n">exit_with_error</span><span class="p">(</span><span class="s">"failed to instantiate WASI"</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">trap</span><span class="p">);</span>

    <span class="c1">// Create the linker</span>
    <span class="n">wasmtime_linker_t</span><span class="o">*</span> <span class="n">linker</span> <span class="o">=</span> <span class="n">wasmtime_linker_new</span><span class="p">(</span><span class="n">store</span><span class="p">);</span>
    <span class="c1">// Add wasi to the linker</span>
    <span class="n">error</span> <span class="o">=</span> <span class="n">wasmtime_linker_define_wasi</span><span class="p">(</span><span class="n">linker</span><span class="p">,</span> <span class="n">wasi</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">error</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span>
        <span class="n">exit_with_error</span><span class="p">(</span><span class="s">"failed to link wasi"</span><span class="p">,</span> <span class="n">error</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>

    <span class="c1">// Define the printHostAddress import and register it with the linker</span>
    <span class="n">wasm_functype_t</span><span class="o">*</span> <span class="n">printHostAddress_callback_ty</span> <span class="o">=</span> <span class="n">wasm_functype_new_1_0</span><span class="p">(</span>
        <span class="n">wasm_valtype_new_i32</span><span class="p">()</span>
    <span class="p">);</span>
    <span class="n">wasm_extern_t</span><span class="o">*</span> <span class="n">funcAsExt</span> <span class="o">=</span> <span class="n">wasm_func_as_extern</span><span class="p">(</span>
        <span class="n">wasm_func_new</span><span class="p">(</span><span class="n">store</span><span class="p">,</span> <span class="n">printHostAddress_callback_ty</span><span class="p">,</span> <span class="n">printHostAddress_callback</span><span class="p">)</span>
    <span class="p">);</span>
    <span class="n">wasm_name_t</span> <span class="n">mod_name</span><span class="p">;</span>
    <span class="n">wasm_name_new</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mod_name</span><span class="p">,</span> <span class="n">strlen</span><span class="p">(</span><span class="s">"env"</span><span class="p">),</span> <span class="s">"env"</span><span class="p">);</span>
    <span class="n">wasm_name_t</span> <span class="n">func_name</span><span class="p">;</span>
    <span class="n">wasm_name_new</span><span class="p">(</span><span class="o">&amp;</span><span class="n">func_name</span><span class="p">,</span> <span class="n">strlen</span><span class="p">(</span><span class="s">"printHostAddress"</span><span class="p">),</span> <span class="s">"printHostAddress"</span><span class="p">);</span>
    <span class="n">error</span> <span class="o">=</span> <span class="n">wasmtime_linker_define</span><span class="p">(</span><span class="n">linker</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mod_name</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">func_name</span><span class="p">,</span> <span class="n">funcAsExt</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">error</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">printf</span><span class="p">(</span><span class="s">"Failed to register %s with wasmtime linker</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="s">"printHostAddress"</span><span class="p">);</span>
        <span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
    <span class="p">};</span>


    <span class="n">wasm_name_t</span> <span class="n">empty</span><span class="p">;</span>
    <span class="n">wasm_name_new_from_string</span><span class="p">(</span><span class="o">&amp;</span><span class="n">empty</span><span class="p">,</span> <span class="s">""</span><span class="p">);</span>
    <span class="n">error</span> <span class="o">=</span> <span class="n">wasmtime_linker_module</span><span class="p">(</span><span class="n">linker</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">empty</span><span class="p">,</span> <span class="k">module</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">error</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span>
        <span class="n">exit_with_error</span><span class="p">(</span><span class="s">"failed to instantiate module"</span><span class="p">,</span> <span class="n">error</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>

    <span class="n">wasm_instance_t</span><span class="o">*</span> <span class="n">wasm_instance</span><span class="p">;</span>
    <span class="n">error</span> <span class="o">=</span> <span class="n">wasmtime_linker_instantiate</span><span class="p">(</span><span class="n">linker</span><span class="p">,</span> <span class="k">module</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">wasm_instance</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">trap</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">error</span> <span class="o">!=</span> <span class="nb">NULL</span> <span class="o">||</span> <span class="n">trap</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">printf</span><span class="p">(</span><span class="s">"Failed to instantiate </span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
        <span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="n">wasm_extern_vec_t</span> <span class="n">exports</span><span class="p">;</span>
    <span class="n">wasm_instance_exports</span><span class="p">(</span><span class="n">wasm_instance</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">exports</span><span class="p">);</span>
    <span class="kt">size_t</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="n">g_memory</span> <span class="o">=</span> <span class="n">get_export_memory</span><span class="p">(</span><span class="o">&amp;</span><span class="n">exports</span><span class="p">,</span> <span class="n">i</span><span class="o">++</span><span class="p">);</span>

    <span class="c1">// Run it.</span>
    <span class="n">wasm_func_t</span><span class="o">*</span> <span class="n">func</span><span class="p">;</span>
    <span class="n">wasmtime_linker_get_default</span><span class="p">(</span><span class="n">linker</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">empty</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">func</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">error</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span>
        <span class="n">exit_with_error</span><span class="p">(</span><span class="s">"failed to locate default export for module"</span><span class="p">,</span> <span class="n">error</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
    <span class="n">error</span> <span class="o">=</span> <span class="n">wasmtime_func_call</span><span class="p">(</span><span class="n">func</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">trap</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">error</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span>
        <span class="n">exit_with_error</span><span class="p">(</span><span class="s">"error calling default export"</span><span class="p">,</span> <span class="n">error</span><span class="p">,</span> <span class="n">trap</span><span class="p">);</span>

    <span class="c1">// Clean up after ourselves at this point</span>
    <span class="n">wasm_module_delete</span><span class="p">(</span><span class="k">module</span><span class="p">);</span>
    <span class="n">wasm_store_delete</span><span class="p">(</span><span class="n">store</span><span class="p">);</span>
    <span class="n">wasm_engine_delete</span><span class="p">(</span><span class="n">engine</span><span class="p">);</span>

    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div>
<p>The implementation of the <code>printHostAddress_callback</code> import function prints the base address of the wasm module's memory (for reference), the received pointer and the string accessed at that address.</p>
<p>Compile the runtime, using libwasmatime.a:</p>
<div class="codehilite" data-code-language="Bash"><pre><span></span><code>$ cargo build --release -p wasmtime-c-api
$ clang++ target/release/libwasmtime.a <span class="se">\</span>
             -I./crates/c-api/include/ <span class="se">\</span>
             -I./crates/c-api/wasm-c-api/include <span class="se">\</span>
             -o runtime runtime.cpp
</code></pre></div>
<p>Run the example runtime with the previously compiled wasm module:</p>
<div class="codehilite" data-code-language="Bash"><pre><span></span><code>$ ./runtime example.wasm
</code></pre></div>
<p>This is the output I get:</p>
<div class="codehilite" data-code-language="Bash"><pre><span></span><code>Global data str: Global data, ptr: 0x400
&gt; Print Host Address Callback:
&gt; Base memory: 0x10d919000
&gt; Received ptr: 0x10d919400
&gt; String value: Global data

Stack str: Stack data, ptr: 0x114b1
&gt; Print Host Address Callback:
&gt; Base memory: 0x10d919000
&gt; Received ptr: 0x10d92a4b1
&gt; String value:

Heap str: Heap data, ptr: 0x20010
&gt; Print Host Address Callback:
&gt; Base memory: 0x10d919000
&gt; Received ptr: 0x10d939010
<span class="o">[</span><span class="m">1</span><span class="o">]</span>    <span class="m">7734</span> bus error  ./runtime example.wasm
</code></pre></div>
<p>The global data string has an expected memory offset of 0x400, and the string literal is retrieved succesfully.</p>
<p>The issue comes for the strings allocated on the stack and the heap. For the one allocated on the stack, the address is valid, but is clearly not the right one, as there is nothing at that address! </p>
<p>As for the one allocated on the he<br>
[message truncated]</p>
</blockquote>



<a name="221694710"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20Issue%20%232547%20Wasmtime%20host%20address%20calculation%20.../near/221694710" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20Issue.20.232547.20Wasmtime.20host.20address.20calculation.20.2E.2E.2E.html#221694710">(Jan 05 2021 at 20:04)</a>:</h4>
<p>cfallin <a href="https://github.com/bytecodealliance/wasmtime/issues/2547#issuecomment-754868197">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/2547">Issue #2547</a>:</p>
<blockquote>
<p>Hypothesis: is the memory growing, and as a result, the pointer invalidated? (I don't know anything about the C API so I'm not sure why or how the lifetimes could cause this; @sunfishcode appears to mention a related lifetime issue over in <a href="https://github.com/WebAssembly/c-api/issues/105">WebAssembly/c-api#105</a>.)</p>
<p>The reason I suspect this is that the second and third cases, where the data is not as expected, have pointers just above the first Wasm page (64K bytes, or 0x10000).</p>
<p>A way to check whether this is the case would be to call your host function (again) with the global pointer at the end of your Wasm module's <code>main()</code>. If it works at first but not the second time, then that means the memory storage will have been moved to a larger buffer.</p>
</blockquote>



<a name="221694784"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20Issue%20%232547%20Wasmtime%20host%20address%20calculation%20.../near/221694784" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20Issue.20.232547.20Wasmtime.20host.20address.20calculation.20.2E.2E.2E.html#221694784">(Jan 05 2021 at 20:05)</a>:</h4>
<p>cfallin edited a <a href="https://github.com/bytecodealliance/wasmtime/issues/2547#issuecomment-754868197">comment</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/2547">Issue #2547</a>:</p>
<blockquote>
<p>Hypothesis: is the memory growing, and as a result, the pointer invalidated? (I don't know anything about the C API so I'm not sure why or how the lifetimes could cause this; @sunfishcode appears to mention a related lifetime issue over in <a href="https://github.com/WebAssembly/wasm-c-api/issues/105">WebAssembly/wasm-c-api#105</a>.)</p>
<p>The reason I suspect this is that the second and third cases, where the data is not as expected, have pointers just above the first Wasm page (64K bytes, or 0x10000).</p>
<p>A way to check whether this is the case would be to call your host function (again) with the global pointer at the end of your Wasm module's <code>main()</code>. If it works at first but not the second time, then that means the memory storage will have been moved to a larger buffer.</p>
</blockquote>



<a name="221699424"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20Issue%20%232547%20Wasmtime%20host%20address%20calculation%20.../near/221699424" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20Issue.20.232547.20Wasmtime.20host.20address.20calculation.20.2E.2E.2E.html#221699424">(Jan 05 2021 at 20:48)</a>:</h4>
<p>peterhuene <a href="https://github.com/bytecodealliance/wasmtime/issues/2547#issuecomment-754889911">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/2547">Issue #2547</a>:</p>
<blockquote>
<p>Provided the return value of <code>wasm_memory_data</code> isn't reused between either execution of Wasm code or calls to explicitly grow the memory then data pointer shouldn't be invalidated.</p>
</blockquote>



<a name="221699471"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20Issue%20%232547%20Wasmtime%20host%20address%20calculation%20.../near/221699471" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20Issue.20.232547.20Wasmtime.20host.20address.20calculation.20.2E.2E.2E.html#221699471">(Jan 05 2021 at 20:48)</a>:</h4>
<p>peterhuene edited a <a href="https://github.com/bytecodealliance/wasmtime/issues/2547#issuecomment-754889911">comment</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/2547">Issue #2547</a>:</p>
<blockquote>
<p>Provided the return value of <code>wasm_memory_data</code> isn't reused between either execution of Wasm code or calls to explicitly grow the memory then the data pointer shouldn't be invalidated.</p>
</blockquote>



<a name="221699612"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20Issue%20%232547%20Wasmtime%20host%20address%20calculation%20.../near/221699612" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20Issue.20.232547.20Wasmtime.20host.20address.20calculation.20.2E.2E.2E.html#221699612">(Jan 05 2021 at 20:49)</a>:</h4>
<p>peterhuene edited a <a href="https://github.com/bytecodealliance/wasmtime/issues/2547#issuecomment-754889911">comment</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/2547">Issue #2547</a>:</p>
<blockquote>
<p>Provided the return value of <code>wasm_memory_data</code> isn't reused between either execution of Wasm code or calls to explicitly grow the memory then the data pointer shouldn't be invalidated.</p>
<p>That doesn't seem to be the case here, so I have no hypothesis to offer without some debugging.</p>
</blockquote>



<a name="221705238"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20Issue%20%232547%20Wasmtime%20host%20address%20calculation%20.../near/221705238" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20Issue.20.232547.20Wasmtime.20host.20address.20calculation.20.2E.2E.2E.html#221705238">(Jan 05 2021 at 21:38)</a>:</h4>
<p>alexcrichton <a href="https://github.com/bytecodealliance/wasmtime/issues/2547#issuecomment-754917797">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/2547">Issue #2547</a>:</p>
<blockquote>
<p>I believe the issue here is in the usage of the <code>wasmtime_linker_t</code> type and the interaction  between <code>wasmtime_linker_get_default</code> and  <code>wasmtime_linker_instantiate</code>. The module you're defining in the linker is a "command" module which means that every time the function is called through the linker it will re-instantiate the module. This means that the instance returned from <code>wasmtime_linker_instantiate</code> is not the same instance as the one executing code from <code>wasmtime_linker_get_default</code></p>
<p>If you switch <code>wasmtime_linker_get_default</code> to instead execute the <code>_start</code> export, or if you use <code>wasmtime_caller_t</code> to extract the memory, I believe the example should work.</p>
</blockquote>



<a name="221707050"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20Issue%20%232547%20Wasmtime%20host%20address%20calculation%20.../near/221707050" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20Issue.20.232547.20Wasmtime.20host.20address.20calculation.20.2E.2E.2E.html#221707050">(Jan 05 2021 at 21:55)</a>:</h4>
<p>peterhuene <a href="https://github.com/bytecodealliance/wasmtime/issues/2547#issuecomment-754925765">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/2547">Issue #2547</a>:</p>
<blockquote>
<p>Ah good catch; that makes sense why the memory wasn't grown as it's the wrong memory being accessed.</p>
</blockquote>



<a name="221756192"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20Issue%20%232547%20Wasmtime%20host%20address%20calculation%20.../near/221756192" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20Issue.20.232547.20Wasmtime.20host.20address.20calculation.20.2E.2E.2E.html#221756192">(Jan 06 2021 at 11:17)</a>:</h4>
<p>JulietteCarter <a href="https://github.com/bytecodealliance/wasmtime/issues/2547#issuecomment-755241698">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/2547">Issue #2547</a>:</p>
<blockquote>
<p>Thank you very much indeed for your speedy replies!<br>
I used the exported <code>start</code> function instead of <code>wasmtime_linker_get_default</code> and it worked as expected! :D</p>
<div class="codehilite" data-code-language="Bash"><pre><span></span><code>Global data str: Global data, ptr: 0x400
&gt; Print Host Address Callback:
&gt; Base memory: 0x10ccb4000
&gt; Received ptr: 0x10ccb4400
&gt; String value: Global data
Stack str: Stack data, ptr: 0x114b1
&gt; Print Host Address Callback:
&gt; Base memory: 0x10ccb4000
&gt; Received ptr: 0x10ccc54b1
&gt; String value: Stack data
Heap str: Heap data, ptr: 0x20010
&gt; Print Host Address Callback:
&gt; Base memory: 0x10ccb4000
&gt; Received ptr: 0x10ccd4010
&gt; String value: Heap data
</code></pre></div>
<p>Is there any further documentation about "command mode" ?</p>
<p>Thanks again for all your quick responses, the wasmtime project is really fantastic and the community is doing great work!<br>
</p>
</blockquote>



<a name="221776845"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20Issue%20%232547%20Wasmtime%20host%20address%20calculation%20.../near/221776845" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20Issue.20.232547.20Wasmtime.20host.20address.20calculation.20.2E.2E.2E.html#221776845">(Jan 06 2021 at 15:03)</a>:</h4>
<p>alexcrichton <a href="https://github.com/bytecodealliance/wasmtime/issues/2547#issuecomment-755351041">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/2547">Issue #2547</a>:</p>
<blockquote>
<p>There's some more information here -- <a href="https://github.com/WebAssembly/WASI/blob/master/design/application-abi.md#current-unstable-abi">https://github.com/WebAssembly/WASI/blob/master/design/application-abi.md#current-unstable-abi</a>  and a brief description on <a href="https://docs.rs/wasmtime/0.21.0/wasmtime/struct.Linker.html#method.module"><code>Linker::module</code></a> too. I'm gonna go ahead and close this because I think it's fixed, but feel free to ask any follow-ups here of course!</p>
</blockquote>



<a name="221776847"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20Issue%20%232547%20Wasmtime%20host%20address%20calculation%20.../near/221776847" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20Issue.20.232547.20Wasmtime.20host.20address.20calculation.20.2E.2E.2E.html#221776847">(Jan 06 2021 at 15:03)</a>:</h4>
<p>alexcrichton closed <a href="https://github.com/bytecodealliance/wasmtime/issues/2547">Issue #2547</a>:</p>
<blockquote>
<p>I am having issues understanding how to access data stored in the different parts of a wasm module's memory (data, stack and heap), from a runtime in C (using libwasmtime.a).</p>
<p>I'm trying to pass a C string literal pointer from a WebAssembly program to an imported function implemented in C in the wasm runtime. Adding the 'base memory pointer' to the guest pointer address doesn't yield a valid host address when strings are stored on the stack or in the heap. It only works for global data. I don't know what I'm doing wrong. How do I compute the host address for all global, stack and heap memory addresses? </p>
<p>I have constructed the following reproducible test case to illustrate the problem.<br>
I have produced a small c++ example, which creates a static string (global data) <code>globalStr</code>, a string allocated on the stack <code>stackStr</code>, and string allocated on the heap <code>heapStr</code>.</p>
<p>For each of those 3 strings, I print the value of the string and its memory address. I then call the custom import <code>printHostAddress</code> (which I implement in the runtime - see later), which tries to access the memory at the address passed from the wasm module to the runtime.</p>
<p>Produced from wasmtime main branch, commit hash <code>128c3bd74</code>.<br>
Using clang++ version 10.0.0.</p>
<p>Example below, compiled to wasm using the wasi-sdk.</p>
<div class="codehilite" data-code-language="C++"><pre><span></span><code><span class="cm">/* example.cpp</span>

<span class="cm">Compile to wasm: clang++ --target=wasm32-wasi -Wl,--allow-undefined -o example.wasm example.cpp</span>
<span class="cm">*/</span>

<span class="cp">#include</span> <span class="cpf">&lt;stdio.h&gt;</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&lt;string.h&gt;</span><span class="cp"></span>

<span class="k">extern</span> <span class="s">"C"</span> <span class="kt">void</span> <span class="n">printHostAddress</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span><span class="o">*</span> <span class="n">str</span><span class="p">);</span> <span class="c1">// custom import</span>

<span class="kt">int</span> <span class="nf">main</span><span class="p">()</span>
<span class="p">{</span>
    <span class="c1">// Global data</span>
    <span class="k">static</span> <span class="k">const</span> <span class="kt">char</span><span class="o">*</span> <span class="n">globalStr</span> <span class="o">=</span> <span class="s">"Global data"</span><span class="p">;</span>
    <span class="n">printf</span><span class="p">(</span><span class="s">"Global data str: %s, ptr: %p</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">globalStr</span><span class="p">,</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">globalStr</span><span class="p">);</span> <span class="c1">// call wasi imports</span>
    <span class="n">printHostAddress</span><span class="p">(</span><span class="n">globalStr</span><span class="p">);</span> <span class="c1">// call custom import</span>

    <span class="c1">// Stack allocation</span>
    <span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="n">strLiteral</span><span class="p">[]</span> <span class="o">=</span> <span class="s">"Stack data"</span><span class="p">;</span>
    <span class="kt">char</span> <span class="n">stackStr</span><span class="p">[</span><span class="k">sizeof</span><span class="p">(</span><span class="n">strLiteral</span><span class="p">)];</span>
    <span class="n">strcpy</span><span class="p">(</span><span class="n">stackStr</span><span class="p">,</span> <span class="n">strLiteral</span><span class="p">);</span>
    <span class="n">printf</span><span class="p">(</span><span class="s">"Stack str: %s, ptr: %p</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">stackStr</span><span class="p">,</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">stackStr</span><span class="p">);</span> <span class="c1">// call wasi imports</span>
    <span class="n">printHostAddress</span><span class="p">(</span><span class="n">stackStr</span><span class="p">);</span> <span class="c1">// call custom import</span>

    <span class="c1">// Heap allocation</span>
    <span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="n">strLiteral2</span><span class="p">[]</span> <span class="o">=</span> <span class="s">"Heap data"</span><span class="p">;</span>
    <span class="kt">char</span><span class="o">*</span> <span class="n">heapStr</span> <span class="o">=</span> <span class="k">new</span> <span class="kt">char</span><span class="p">[</span><span class="k">sizeof</span><span class="p">(</span><span class="n">strLiteral2</span><span class="p">)];</span>
    <span class="n">strcpy</span><span class="p">(</span><span class="n">heapStr</span><span class="p">,</span> <span class="n">strLiteral2</span><span class="p">);</span>
    <span class="n">printf</span><span class="p">(</span><span class="s">"Heap str: %s, ptr: %p</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">heapStr</span><span class="p">,</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">heapStr</span><span class="p">);</span> <span class="c1">// call wasi imports</span>
    <span class="n">printHostAddress</span><span class="p">(</span><span class="n">heapStr</span><span class="p">);</span> <span class="c1">// call custom import</span>

    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div>
<p>I've provided the cpp implementation for the runtime below. Most of it is boilerplate code, the bit of interest is the implementation of the <code>printHostAddress</code> import function, given to the example.wasm module (see <code>printHostAddress_callback</code>).</p>
<div class="codehilite" data-code-language="C++"><pre><span></span><code><span class="cm">/* runtime.cpp</span>

<span class="cm">    To build, from wasmtime repo:</span>
<span class="cm">    1. Build libwasmtime.a:</span>
<span class="cm">        cargo build --release -p wasmtime-c-api</span>
<span class="cm">    2. Build runtime.cpp</span>
<span class="cm">        clang++ target/release/libwasmtime.a \</span>
<span class="cm">             -I./crates/c-api/include/ \</span>
<span class="cm">             -I./crates/c-api/wasm-c-api/include \</span>
<span class="cm">             -o runtime runtime.cpp</span>
<span class="cm">*/</span>


<span class="cp">#include</span> <span class="cpf">&lt;assert.h&gt;</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&lt;stdio.h&gt;</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&lt;stdlib.h&gt;</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&lt;wasm.h&gt;</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&lt;wasi.h&gt;</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&lt;wasmtime.h&gt;</span><span class="cp"></span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">exit_with_error</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">message</span><span class="p">,</span> <span class="n">wasmtime_error_t</span> <span class="o">*</span><span class="n">error</span><span class="p">,</span> <span class="n">wasm_trap_t</span> <span class="o">*</span><span class="n">trap</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="s">"error: %s</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">message</span><span class="p">);</span>
    <span class="n">wasm_byte_vec_t</span> <span class="n">error_message</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">error</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">wasmtime_error_message</span><span class="p">(</span><span class="n">error</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">error_message</span><span class="p">);</span>
        <span class="n">wasmtime_error_delete</span><span class="p">(</span><span class="n">error</span><span class="p">);</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="n">wasm_trap_message</span><span class="p">(</span><span class="n">trap</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">error_message</span><span class="p">);</span>
        <span class="n">wasm_trap_delete</span><span class="p">(</span><span class="n">trap</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="s">"%.*s</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span> <span class="n">error_message</span><span class="p">.</span><span class="n">size</span><span class="p">,</span> <span class="n">error_message</span><span class="p">.</span><span class="n">data</span><span class="p">);</span>
    <span class="n">wasm_byte_vec_delete</span><span class="p">(</span><span class="o">&amp;</span><span class="n">error_message</span><span class="p">);</span>
    <span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
<span class="p">}</span>

<span class="c1">// Make memory a global to access it in the printHostAddress_callback function</span>
<span class="n">wasm_memory_t</span><span class="o">*</span> <span class="n">g_memory</span><span class="p">;</span>

<span class="n">wasm_memory_t</span><span class="o">*</span> <span class="nf">get_export_memory</span><span class="p">(</span><span class="k">const</span> <span class="n">wasm_extern_vec_t</span><span class="o">*</span> <span class="n">exports</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">i</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">exports</span><span class="o">-&gt;</span><span class="n">size</span> <span class="o">&lt;=</span> <span class="n">i</span> <span class="o">||</span> <span class="o">!</span><span class="n">wasm_extern_as_memory</span><span class="p">(</span><span class="n">exports</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="p">]))</span> <span class="p">{</span>
    <span class="n">printf</span><span class="p">(</span><span class="s">"&gt; Error accessing memory export %zu!</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
    <span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
  <span class="p">}</span>
  <span class="k">return</span> <span class="n">wasm_extern_as_memory</span><span class="p">(</span><span class="n">exports</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
<span class="p">}</span>
<span class="cm">/*</span>
<span class="cm">    LOOK HERE!</span>
<span class="cm">*/</span>
<span class="k">static</span> <span class="n">wasm_trap_t</span><span class="o">*</span> <span class="n">printHostAddress_callback</span><span class="p">(</span><span class="k">const</span> <span class="n">wasm_val_t</span> <span class="n">args</span><span class="p">[],</span> <span class="n">wasm_val_t</span> <span class="n">results</span><span class="p">[])</span>
<span class="p">{</span>
    <span class="n">printf</span><span class="p">(</span><span class="s">"&gt; Print Host Address Callback: </span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
    <span class="k">auto</span> <span class="n">base_memory</span> <span class="o">=</span> <span class="n">wasm_memory_data</span><span class="p">(</span><span class="n">g_memory</span><span class="p">);</span>
    <span class="n">printf</span><span class="p">(</span><span class="s">"&gt; Base memory: %p</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span><span class="n">base_memory</span><span class="p">);</span>
    <span class="k">const</span> <span class="kt">char</span><span class="o">*</span> <span class="n">str</span> <span class="o">=</span> <span class="k">reinterpret_cast</span><span class="o">&lt;</span><span class="k">const</span> <span class="kt">char</span><span class="o">*</span> <span class="o">&gt;</span><span class="p">(</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">of</span><span class="p">.</span><span class="n">i32</span> <span class="o">+</span> <span class="n">base_memory</span><span class="p">);</span>
    <span class="n">printf</span><span class="p">(</span><span class="s">"&gt; Received ptr: %p</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">str</span><span class="p">);</span>
    <span class="n">printf</span><span class="p">(</span><span class="s">"&gt; String value: %s</span><span class="se">\n\n</span><span class="s">"</span><span class="p">,</span> <span class="n">str</span><span class="p">);</span>
    <span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="c1">///////////// Boilerplate code starts here!</span>
<span class="kt">int</span> <span class="n">main</span><span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">argv</span><span class="p">[])</span>
<span class="p">{</span>
    <span class="k">const</span> <span class="kt">char</span><span class="o">*</span> <span class="n">wasm_module_file</span> <span class="o">=</span> <span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>

    <span class="c1">// Set up our context</span>
    <span class="n">wasm_engine_t</span><span class="o">*</span> <span class="n">engine</span> <span class="o">=</span> <span class="n">wasm_engine_new</span><span class="p">();</span>
    <span class="n">assert</span><span class="p">(</span><span class="n">engine</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">);</span>
    <span class="n">wasm_store_t</span><span class="o">*</span> <span class="n">store</span> <span class="o">=</span> <span class="n">wasm_store_new</span><span class="p">(</span><span class="n">engine</span><span class="p">);</span>
    <span class="n">assert</span><span class="p">(</span><span class="n">store</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">);</span>

    <span class="n">wasm_byte_vec_t</span> <span class="n">wasm</span><span class="p">;</span>
    <span class="c1">// Load our input file to parse it next</span>
    <span class="kt">FILE</span><span class="o">*</span> <span class="n">file</span> <span class="o">=</span> <span class="n">fopen</span><span class="p">(</span><span class="n">wasm_module_file</span><span class="p">,</span> <span class="s">"rb"</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">file</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">printf</span><span class="p">(</span><span class="s">"&gt; Error loading file %s!</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">wasm_module_file</span><span class="p">);</span>
        <span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="n">fseek</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="mf">0L</span><span class="p">,</span> <span class="n">SEEK_END</span><span class="p">);</span>
    <span class="kt">size_t</span> <span class="n">file_size</span> <span class="o">=</span> <span class="n">ftell</span><span class="p">(</span><span class="n">file</span><span class="p">);</span>
    <span class="n">wasm_byte_vec_new_uninitialized</span><span class="p">(</span><span class="o">&amp;</span><span class="n">wasm</span><span class="p">,</span> <span class="n">file_size</span><span class="p">);</span>
    <span class="n">fseek</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="mf">0L</span><span class="p">,</span> <span class="n">SEEK_SET</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">fread</span><span class="p">(</span><span class="n">wasm</span><span class="p">.</span><span class="n">data</span><span class="p">,</span> <span class="n">file_size</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">file</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">printf</span><span class="p">(</span><span class="s">"&gt; Error loading module!</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
        <span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="n">fclose</span><span class="p">(</span><span class="n">file</span><span class="p">);</span>

    <span class="c1">// Compile our modules</span>
    <span class="n">wasm_module_t</span><span class="o">*</span> <span class="k">module</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
    <span class="n">wasmtime_error_t</span><span class="o">*</span> <span class="n">error</span> <span class="o">=</span> <span class="n">wasmtime_module_new</span><span class="p">(</span><span class="n">engine</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">wasm</span><span class="p">,</span> <span class="o">&amp;</span><span class="k">module</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">module</span><span class="p">)</span>
        <span class="n">exit_with_error</span><span class="p">(</span><span class="s">"failed to compile module"</span><span class="p">,</span> <span class="n">error</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>

    <span class="n">wasm_byte_vec_delete</span><span class="p">(</span><span class="o">&amp;</span><span class="n">wasm</span><span class="p">);</span>

    <span class="c1">// Instantiate wasi</span>
    <span class="n">wasi_config_t</span> <span class="o">*</span><span class="n">wasi_config</span> <span class="o">=</span> <span class="n">wasi_config_new</span><span class="p">();</span>
    <span class="n">assert</span><span class="p">(</span><span class="n">wasi_config</span><span class="p">);</span>
    <span class="n">wasi_config_inherit_argv</span><span class="p">(</span><span class="n">wasi_config</span><span class="p">);</span>
    <span class="n">wasi_config_inherit_env</span><span class="p">(</span><span class="n">wasi_config</span><span class="p">);</span>
    <span class="n">wasi_config_inherit_stdin</span><span class="p">(</span><span class="n">wasi_config</span><span class="p">);</span>
    <span class="n">wasi_config_inherit_stdout</span><span class="p">(</span><span class="n">wasi_config</span><span class="p">);</span>
    <span class="n">wasi_config_inherit_stderr</span><span class="p">(</span><span class="n">wasi_config</span><span class="p">);</span>

    <span class="n">wasm_trap_t</span> <span class="o">*</span><span class="n">trap</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
    <span class="n">wasi_instance_t</span> <span class="o">*</span><span class="n">wasi</span> <span class="o">=</span> <span class="n">wasi_instance_new</span><span class="p">(</span><span class="n">store</span><span class="p">,</span> <span class="s">"wasi_snapshot_preview1"</span><span class="p">,</span> <span class="n">wasi_config</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">trap</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">wasi</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
        <span class="n">exit_with_error</span><span class="p">(</span><span class="s">"failed to instantiate WASI"</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">trap</span><span class="p">);</span>

    <span class="c1">// Create the linker</span>
    <span class="n">wasmtime_linker_t</span><span class="o">*</span> <span class="n">linker</span> <span class="o">=</span> <span class="n">wasmtime_linker_new</span><span class="p">(</span><span class="n">store</span><span class="p">);</span>
    <span class="c1">// Add wasi to the linker</span>
    <span class="n">error</span> <span class="o">=</span> <span class="n">wasmtime_linker_define_wasi</span><span class="p">(</span><span class="n">linker</span><span class="p">,</span> <span class="n">wasi</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">error</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span>
        <span class="n">exit_with_error</span><span class="p">(</span><span class="s">"failed to link wasi"</span><span class="p">,</span> <span class="n">error</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>

    <span class="c1">// Define the printHostAddress import and register it with the linker</span>
    <span class="n">wasm_functype_t</span><span class="o">*</span> <span class="n">printHostAddress_callback_ty</span> <span class="o">=</span> <span class="n">wasm_functype_new_1_0</span><span class="p">(</span>
        <span class="n">wasm_valtype_new_i32</span><span class="p">()</span>
    <span class="p">);</span>
    <span class="n">wasm_extern_t</span><span class="o">*</span> <span class="n">funcAsExt</span> <span class="o">=</span> <span class="n">wasm_func_as_extern</span><span class="p">(</span>
        <span class="n">wasm_func_new</span><span class="p">(</span><span class="n">store</span><span class="p">,</span> <span class="n">printHostAddress_callback_ty</span><span class="p">,</span> <span class="n">printHostAddress_callback</span><span class="p">)</span>
    <span class="p">);</span>
    <span class="n">wasm_name_t</span> <span class="n">mod_name</span><span class="p">;</span>
    <span class="n">wasm_name_new</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mod_name</span><span class="p">,</span> <span class="n">strlen</span><span class="p">(</span><span class="s">"env"</span><span class="p">),</span> <span class="s">"env"</span><span class="p">);</span>
    <span class="n">wasm_name_t</span> <span class="n">func_name</span><span class="p">;</span>
    <span class="n">wasm_name_new</span><span class="p">(</span><span class="o">&amp;</span><span class="n">func_name</span><span class="p">,</span> <span class="n">strlen</span><span class="p">(</span><span class="s">"printHostAddress"</span><span class="p">),</span> <span class="s">"printHostAddress"</span><span class="p">);</span>
    <span class="n">error</span> <span class="o">=</span> <span class="n">wasmtime_linker_define</span><span class="p">(</span><span class="n">linker</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mod_name</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">func_name</span><span class="p">,</span> <span class="n">funcAsExt</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">error</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">printf</span><span class="p">(</span><span class="s">"Failed to register %s with wasmtime linker</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="s">"printHostAddress"</span><span class="p">);</span>
        <span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
    <span class="p">};</span>


    <span class="n">wasm_name_t</span> <span class="n">empty</span><span class="p">;</span>
    <span class="n">wasm_name_new_from_string</span><span class="p">(</span><span class="o">&amp;</span><span class="n">empty</span><span class="p">,</span> <span class="s">""</span><span class="p">);</span>
    <span class="n">error</span> <span class="o">=</span> <span class="n">wasmtime_linker_module</span><span class="p">(</span><span class="n">linker</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">empty</span><span class="p">,</span> <span class="k">module</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">error</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span>
        <span class="n">exit_with_error</span><span class="p">(</span><span class="s">"failed to instantiate module"</span><span class="p">,</span> <span class="n">error</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>

    <span class="n">wasm_instance_t</span><span class="o">*</span> <span class="n">wasm_instance</span><span class="p">;</span>
    <span class="n">error</span> <span class="o">=</span> <span class="n">wasmtime_linker_instantiate</span><span class="p">(</span><span class="n">linker</span><span class="p">,</span> <span class="k">module</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">wasm_instance</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">trap</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">error</span> <span class="o">!=</span> <span class="nb">NULL</span> <span class="o">||</span> <span class="n">trap</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">printf</span><span class="p">(</span><span class="s">"Failed to instantiate </span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
        <span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="n">wasm_extern_vec_t</span> <span class="n">exports</span><span class="p">;</span>
    <span class="n">wasm_instance_exports</span><span class="p">(</span><span class="n">wasm_instance</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">exports</span><span class="p">);</span>
    <span class="kt">size_t</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="n">g_memory</span> <span class="o">=</span> <span class="n">get_export_memory</span><span class="p">(</span><span class="o">&amp;</span><span class="n">exports</span><span class="p">,</span> <span class="n">i</span><span class="o">++</span><span class="p">);</span>

    <span class="c1">// Run it.</span>
    <span class="n">wasm_func_t</span><span class="o">*</span> <span class="n">func</span><span class="p">;</span>
    <span class="n">wasmtime_linker_get_default</span><span class="p">(</span><span class="n">linker</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">empty</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">func</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">error</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span>
        <span class="n">exit_with_error</span><span class="p">(</span><span class="s">"failed to locate default export for module"</span><span class="p">,</span> <span class="n">error</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
    <span class="n">error</span> <span class="o">=</span> <span class="n">wasmtime_func_call</span><span class="p">(</span><span class="n">func</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">trap</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">error</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span>
        <span class="n">exit_with_error</span><span class="p">(</span><span class="s">"error calling default export"</span><span class="p">,</span> <span class="n">error</span><span class="p">,</span> <span class="n">trap</span><span class="p">);</span>

    <span class="c1">// Clean up after ourselves at this point</span>
    <span class="n">wasm_module_delete</span><span class="p">(</span><span class="k">module</span><span class="p">);</span>
    <span class="n">wasm_store_delete</span><span class="p">(</span><span class="n">store</span><span class="p">);</span>
    <span class="n">wasm_engine_delete</span><span class="p">(</span><span class="n">engine</span><span class="p">);</span>

    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div>
<p>The implementation of the <code>printHostAddress_callback</code> import function prints the base address of the wasm module's memory (for reference), the received pointer and the string accessed at that address.</p>
<p>Compile the runtime, using libwasmatime.a:</p>
<div class="codehilite" data-code-language="Bash"><pre><span></span><code>$ cargo build --release -p wasmtime-c-api
$ clang++ target/release/libwasmtime.a <span class="se">\</span>
             -I./crates/c-api/include/ <span class="se">\</span>
             -I./crates/c-api/wasm-c-api/include <span class="se">\</span>
             -o runtime runtime.cpp
</code></pre></div>
<p>Run the example runtime with the previously compiled wasm module:</p>
<div class="codehilite" data-code-language="Bash"><pre><span></span><code>$ ./runtime example.wasm
</code></pre></div>
<p>This is the output I get:</p>
<div class="codehilite" data-code-language="Bash"><pre><span></span><code>Global data str: Global data, ptr: 0x400
&gt; Print Host Address Callback:
&gt; Base memory: 0x10d919000
&gt; Received ptr: 0x10d919400
&gt; String value: Global data

Stack str: Stack data, ptr: 0x114b1
&gt; Print Host Address Callback:
&gt; Base memory: 0x10d919000
&gt; Received ptr: 0x10d92a4b1
&gt; String value:

Heap str: Heap data, ptr: 0x20010
&gt; Print Host Address Callback:
&gt; Base memory: 0x10d919000
&gt; Received ptr: 0x10d939010
<span class="o">[</span><span class="m">1</span><span class="o">]</span>    <span class="m">7734</span> bus error  ./runtime example.wasm
</code></pre></div>
<p>The global data string has an expected memory offset of 0x400, and the string literal is retrieved succesfully.</p>
<p>The issue comes for the strings allocated on the stack and the heap. For the one allocated on the stack, the address is valid, but is clearly not the right one, as there is nothing at that address! </p>
<p>As for the one allocated on the heap<br>
[message truncated]</p>
</blockquote>



<hr><p>Last updated: Jan 20 2025 at 06:04 UTC</p>
</html>