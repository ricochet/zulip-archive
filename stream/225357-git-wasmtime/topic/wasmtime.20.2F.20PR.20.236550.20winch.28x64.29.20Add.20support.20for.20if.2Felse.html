<html>
<head><meta charset="utf-8"><title>wasmtime / PR #6550 winch(x64) Add support for if/else · git-wasmtime · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/index.html">git-wasmtime</a></h2>
<h3>Topic: <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.236550.20winch.28x64.29.20Add.20support.20for.20if.2Felse.html">wasmtime / PR #6550 winch(x64) Add support for if/else</a></h3>

<hr>

<base href="https://bytecodealliance.zulipchat.com">

<head><link href="https://bytecodealliance.github.io/zulip-archive/style.css" rel="stylesheet"></head>

<a name="364927552"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%236550%20winch%28x64%29%20Add%20support%20for%20if/else/near/364927552" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.236550.20winch.28x64.29.20Add.20support.20for.20if.2Felse.html#364927552">(Jun 09 2023 at 17:41)</a>:</h4>
<p>saulecabrera opened <a href="https://github.com/bytecodealliance/wasmtime/pull/6550">PR #6550</a> from <code>saulecabrera:winch-control-flow</code> to <code>bytecodealliance:main</code>:</p>
<blockquote>
<p>This change adds the necessary building blocks to support control flow; this change also adds support for the <code>If</code> / <code>Else</code> operators.</p>
<p>This change does not include multi-value support. The idea is to add support for multi-value across the compiler (functions and blocks) as a separate future change.</p>
<p>The general gist of the change is to track the presence of control flow frames as part of the code generation context and emit the corresponding labels as and instructions as control flow blocks are found.</p>
<p>&lt;!--<br>
Please make sure you include the following information:</p>
<ul>
<li>
<p>If this work has been discussed elsewhere, please include a link to that<br>
  conversation. If it was discussed in an issue, just mention "issue #...".</p>
</li>
<li>
<p>Explain why this change is needed. If the details are in an issue already,<br>
  this can be brief.</p>
</li>
</ul>
<p>Our development process is documented in the Wasmtime book:<br>
<a href="https://docs.wasmtime.dev/contributing-development-process.html">https://docs.wasmtime.dev/contributing-development-process.html</a></p>
<p>Please ensure all communication follows the code of conduct:<br>
<a href="https://github.com/bytecodealliance/wasmtime/blob/main/CODE_OF_CONDUCT.md">https://github.com/bytecodealliance/wasmtime/blob/main/CODE_OF_CONDUCT.md</a><br>
--&gt;</p>
</blockquote>



<a name="364927554"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%236550%20winch%28x64%29%20Add%20support%20for%20if/else/near/364927554" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.236550.20winch.28x64.29.20Add.20support.20for.20if.2Felse.html#364927554">(Jun 09 2023 at 17:41)</a>:</h4>
<p><strong>saulecabrera</strong> requested <a href="https://github.com/itsrainy">itsrainy</a> for a review on <a href="https://github.com/bytecodealliance/wasmtime/pull/6550">PR #6550</a>.</p>



<a name="364927555"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%236550%20winch%28x64%29%20Add%20support%20for%20if/else/near/364927555" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.236550.20winch.28x64.29.20Add.20support.20for.20if.2Felse.html#364927555">(Jun 09 2023 at 17:41)</a>:</h4>
<p><strong>saulecabrera</strong> requested <a href="https://github.com/orgs/bytecodealliance/teams/wasmtime-fuzz-reviewers">wasmtime-fuzz-reviewers</a> for a review on <a href="https://github.com/bytecodealliance/wasmtime/pull/6550">PR #6550</a>.</p>



<a name="364927558"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%236550%20winch%28x64%29%20Add%20support%20for%20if/else/near/364927558" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.236550.20winch.28x64.29.20Add.20support.20for.20if.2Felse.html#364927558">(Jun 09 2023 at 17:41)</a>:</h4>
<p><strong>saulecabrera</strong> requested <a href="https://github.com/orgs/bytecodealliance/teams/wasmtime-compiler-reviewers">wasmtime-compiler-reviewers</a> for a review on <a href="https://github.com/bytecodealliance/wasmtime/pull/6550">PR #6550</a>.</p>



<a name="364927561"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%236550%20winch%28x64%29%20Add%20support%20for%20if/else/near/364927561" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.236550.20winch.28x64.29.20Add.20support.20for.20if.2Felse.html#364927561">(Jun 09 2023 at 17:41)</a>:</h4>
<p><strong>saulecabrera</strong> requested <a href="https://github.com/jameysharp">jameysharp</a> for a review on <a href="https://github.com/bytecodealliance/wasmtime/pull/6550">PR #6550</a>.</p>



<a name="364927595"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%236550%20winch%28x64%29%20Add%20support%20for%20if/else/near/364927595" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.236550.20winch.28x64.29.20Add.20support.20for.20if.2Felse.html#364927595">(Jun 09 2023 at 17:41)</a>:</h4>
<p><strong>saulecabrera</strong> requested <a href="https://github.com/cfallin">cfallin</a> for a review on <a href="https://github.com/bytecodealliance/wasmtime/pull/6550">PR #6550</a>.</p>



<a name="364930857"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%236550%20winch%28x64%29%20Add%20support%20for%20if/else/near/364930857" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.236550.20winch.28x64.29.20Add.20support.20for.20if.2Felse.html#364930857">(Jun 09 2023 at 17:56)</a>:</h4>
<p>saulecabrera updated <a href="https://github.com/bytecodealliance/wasmtime/pull/6550">PR #6550</a>.</p>



<a name="365608474"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%236550%20winch%28x64%29%20Add%20support%20for%20if/else/near/365608474" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.236550.20winch.28x64.29.20Add.20support.20for.20if.2Felse.html#365608474">(Jun 12 2023 at 15:57)</a>:</h4>
<p>cfallin submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/6550#pullrequestreview-1475239651">PR review</a>:</p>
<blockquote>
<p>LGTM overall -- excited to have the beginning of control-flow handling, thanks!</p>
<p>A few thoughts for refactors below; curious to know what you think.</p>
</blockquote>



<a name="365608475"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%236550%20winch%28x64%29%20Add%20support%20for%20if/else/near/365608475" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.236550.20winch.28x64.29.20Add.20support.20for.20if.2Felse.html#365608475">(Jun 12 2023 at 15:57)</a>:</h4>
<p>cfallin submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/6550#pullrequestreview-1475239651">PR review</a>:</p>
<blockquote>
<p>LGTM overall -- excited to have the beginning of control-flow handling, thanks!</p>
<p>A few thoughts for refactors below; curious to know what you think.</p>
</blockquote>



<a name="365608477"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%236550%20winch%28x64%29%20Add%20support%20for%20if/else/near/365608477" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.236550.20winch.28x64.29.20Add.20support.20for.20if.2Felse.html#365608477">(Jun 12 2023 at 15:57)</a>:</h4>
<p>cfallin created <a href="https://github.com/bytecodealliance/wasmtime/pull/6550#discussion_r1226872043">PR review comment</a>:</p>
<blockquote>
<p>s/doesnt/doesn't/</p>
</blockquote>



<a name="365608478"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%236550%20winch%28x64%29%20Add%20support%20for%20if/else/near/365608478" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.236550.20winch.28x64.29.20Add.20support.20for.20if.2Felse.html#365608478">(Jun 12 2023 at 15:57)</a>:</h4>
<p>cfallin created <a href="https://github.com/bytecodealliance/wasmtime/pull/6550#discussion_r1226871236">PR review comment</a>:</p>
<blockquote>
<p>The naming here is a little confusing -- I would have expected this method to take a callback (closure) and call it for something, but I guess the idea is that this is actually meant to be called from within a callback, where we have an explicit borrow of <code>self.regalloc</code> and <code>self.frame</code>?</p>
<p>Maybe <code>spill_impl</code> instead?</p>
</blockquote>



<a name="365608479"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%236550%20winch%28x64%29%20Add%20support%20for%20if/else/near/365608479" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.236550.20winch.28x64.29.20Add.20support.20for.20if.2Felse.html#365608479">(Jun 12 2023 at 15:57)</a>:</h4>
<p>cfallin created <a href="https://github.com/bytecodealliance/wasmtime/pull/6550#discussion_r1226882907">PR review comment</a>:</p>
<blockquote>
<p>I kind of like what <code>cranelift-wasm</code> does: it has another frame type <code>Else</code>, and the <code>else</code> opcode pops the <code>If</code> and pushes an <code>Else</code>. This keeps a 1-to-1 correspondence between the control-flow stack and the position in the code (i.e., the full context is captured) which is a little less error-prone I think. In this design with the methods on the frame struct itself, the <code>emit_else</code> method could mutate <code>self</code> (<code>*self = ControlStackFrame::Else { ... }</code>). This also removes the need for the conditional in the <code>end</code> case below and the somewhat subtle invariant around the option-of-label. What do you think?</p>
</blockquote>



<a name="365608480"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%236550%20winch%28x64%29%20Add%20support%20for%20if/else/near/365608480" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.236550.20winch.28x64.29.20Add.20support.20for.20if.2Felse.html#365608480">(Jun 12 2023 at 15:57)</a>:</h4>
<p>cfallin created <a href="https://github.com/bytecodealliance/wasmtime/pull/6550#discussion_r1226884734">PR review comment</a>:</p>
<blockquote>
<p>I don't want to bikeshed SmallVec sizes too much (we should just profile) but I'm curious, was this derived from some samples? I've seen block nesting go quite a bit deeper in real wasms; if <code>ControlStackFrame</code> isn't too large, and given that this is just one context struct for the length of the compilation, I don't see the harm in something like <code>64</code> or thereabouts?</p>
</blockquote>



<a name="365931847"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%236550%20winch%28x64%29%20Add%20support%20for%20if/else/near/365931847" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.236550.20winch.28x64.29.20Add.20support.20for.20if.2Felse.html#365931847">(Jun 13 2023 at 16:47)</a>:</h4>
<p>saulecabrera updated <a href="https://github.com/bytecodealliance/wasmtime/pull/6550">PR #6550</a>.</p>



<a name="365931983"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%236550%20winch%28x64%29%20Add%20support%20for%20if/else/near/365931983" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.236550.20winch.28x64.29.20Add.20support.20for.20if.2Felse.html#365931983">(Jun 13 2023 at 16:47)</a>:</h4>
<p>saulecabrera created <a href="https://github.com/bytecodealliance/wasmtime/pull/6550#discussion_r1228428645">PR review comment</a>:</p>
<blockquote>
<p>Yeah <code>spill_impl</code> makes sense to me. </p>
</blockquote>



<a name="365932201"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%236550%20winch%28x64%29%20Add%20support%20for%20if/else/near/365932201" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.236550.20winch.28x64.29.20Add.20support.20for.20if.2Felse.html#365932201">(Jun 13 2023 at 16:48)</a>:</h4>
<p>saulecabrera created <a href="https://github.com/bytecodealliance/wasmtime/pull/6550#discussion_r1228429470">PR review comment</a>:</p>
<blockquote>
<p>The resulting code is definitely cleaner with this approach, thanks!</p>
</blockquote>



<a name="365932483"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%236550%20winch%28x64%29%20Add%20support%20for%20if/else/near/365932483" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.236550.20winch.28x64.29.20Add.20support.20for.20if.2Felse.html#365932483">(Jun 13 2023 at 16:49)</a>:</h4>
<p>saulecabrera created <a href="https://github.com/bytecodealliance/wasmtime/pull/6550#discussion_r1228430555">PR review comment</a>:</p>
<blockquote>
<p>I didn't take any samples, so 6 was chosen arbitrarily, I'm not opposed to 64 though. I changed it to 64 and we can modify it later if needed. </p>
</blockquote>



<a name="365933843"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%236550%20winch%28x64%29%20Add%20support%20for%20if/else/near/365933843" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.236550.20winch.28x64.29.20Add.20support.20for.20if.2Felse.html#365933843">(Jun 13 2023 at 16:54)</a>:</h4>
<p>saulecabrera updated <a href="https://github.com/bytecodealliance/wasmtime/pull/6550">PR #6550</a>.</p>



<a name="365954147"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%236550%20winch%28x64%29%20Add%20support%20for%20if/else/near/365954147" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.236550.20winch.28x64.29.20Add.20support.20for.20if.2Felse.html#365954147">(Jun 13 2023 at 18:13)</a>:</h4>
<p>saulecabrera merged <a href="https://github.com/bytecodealliance/wasmtime/pull/6550">PR #6550</a>.</p>



<hr><p>Last updated: Jan 20 2025 at 06:04 UTC</p>
</html>