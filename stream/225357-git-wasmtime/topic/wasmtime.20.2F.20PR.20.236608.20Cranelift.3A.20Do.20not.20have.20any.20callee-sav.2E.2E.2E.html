<html>
<head><meta charset="utf-8"><title>wasmtime / PR #6608 Cranelift: Do not have any callee-sav... · git-wasmtime · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/index.html">git-wasmtime</a></h2>
<h3>Topic: <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.236608.20Cranelift.3A.20Do.20not.20have.20any.20callee-sav.2E.2E.2E.html">wasmtime / PR #6608 Cranelift: Do not have any callee-sav...</a></h3>

<hr>

<base href="https://bytecodealliance.zulipchat.com">

<head><link href="https://bytecodealliance.github.io/zulip-archive/style.css" rel="stylesheet"></head>

<a name="368039532"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%236608%20Cranelift%3A%20Do%20not%20have%20any%20callee-sav.../near/368039532" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.236608.20Cranelift.3A.20Do.20not.20have.20any.20callee-sav.2E.2E.2E.html#368039532">(Jun 20 2023 at 19:52)</a>:</h4>
<p>fitzgen opened <a href="https://github.com/bytecodealliance/wasmtime/pull/6608">PR #6608</a> from <code>fitzgen:tail-no-callee-saves</code> to <code>bytecodealliance:main</code>:</p>
<blockquote>
<p>That is, mark all allocatable registers as clobbered by <code>tail</code> calls.</p>
<p>Additionally, use (basically) all allocatable registers for passing arguments and returns. ("Basically" because we have to leave at least one register available to hold the callee address for indirect calls or else we'll get regalloc constraint errors.)</p>
<p>I could get three more argument registers on riscv if I refactored <code>compute_arg_locs</code> and/or did something similar to aarch64's <code>compute_arg_locs_tail</code> but it didn't seem worth the hassle.</p>
</blockquote>



<a name="368039537"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%236608%20Cranelift%3A%20Do%20not%20have%20any%20callee-sav.../near/368039537" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.236608.20Cranelift.3A.20Do.20not.20have.20any.20callee-sav.2E.2E.2E.html#368039537">(Jun 20 2023 at 19:52)</a>:</h4>
<p><strong>fitzgen</strong> requested <a href="https://github.com/abrown">abrown</a> for a review on <a href="https://github.com/bytecodealliance/wasmtime/pull/6608">PR #6608</a>.</p>



<a name="368039538"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%236608%20Cranelift%3A%20Do%20not%20have%20any%20callee-sav.../near/368039538" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.236608.20Cranelift.3A.20Do.20not.20have.20any.20callee-sav.2E.2E.2E.html#368039538">(Jun 20 2023 at 19:52)</a>:</h4>
<p><strong>fitzgen</strong> requested <a href="https://github.com/orgs/bytecodealliance/teams/wasmtime-compiler-reviewers">wasmtime-compiler-reviewers</a> for a review on <a href="https://github.com/bytecodealliance/wasmtime/pull/6608">PR #6608</a>.</p>



<a name="368039540"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%236608%20Cranelift%3A%20Do%20not%20have%20any%20callee-sav.../near/368039540" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.236608.20Cranelift.3A.20Do.20not.20have.20any.20callee-sav.2E.2E.2E.html#368039540">(Jun 20 2023 at 19:52)</a>:</h4>
<p><strong>fitzgen</strong> requested <a href="https://github.com/orgs/bytecodealliance/teams/wasmtime-default-reviewers">wasmtime-default-reviewers</a> for a review on <a href="https://github.com/bytecodealliance/wasmtime/pull/6608">PR #6608</a>.</p>



<a name="368039633"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%236608%20Cranelift%3A%20Do%20not%20have%20any%20callee-sav.../near/368039633" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.236608.20Cranelift.3A.20Do.20not.20have.20any.20callee-sav.2E.2E.2E.html#368039633">(Jun 20 2023 at 19:52)</a>:</h4>
<p><strong>fitzgen</strong> requested <a href="https://github.com/jameysharp">jameysharp</a> for a review on <a href="https://github.com/bytecodealliance/wasmtime/pull/6608">PR #6608</a>.</p>



<a name="368041372"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%236608%20Cranelift%3A%20Do%20not%20have%20any%20callee-sav.../near/368041372" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.236608.20Cranelift.3A.20Do.20not.20have.20any.20callee-sav.2E.2E.2E.html#368041372">(Jun 20 2023 at 20:00)</a>:</h4>
<p>fitzgen submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/6608#pullrequestreview-1488921188">PR review</a>.</p>



<a name="368041373"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%236608%20Cranelift%3A%20Do%20not%20have%20any%20callee-sav.../near/368041373" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.236608.20Cranelift.3A.20Do.20not.20have.20any.20callee-sav.2E.2E.2E.html#368041373">(Jun 20 2023 at 20:00)</a>:</h4>
<p>fitzgen submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/6608#pullrequestreview-1488921188">PR review</a>.</p>



<a name="368041376"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%236608%20Cranelift%3A%20Do%20not%20have%20any%20callee-sav.../near/368041376" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.236608.20Cranelift.3A.20Do.20not.20have.20any.20callee-sav.2E.2E.2E.html#368041376">(Jun 20 2023 at 20:00)</a>:</h4>
<p>fitzgen created <a href="https://github.com/bytecodealliance/wasmtime/pull/6608#discussion_r1235762367">PR review comment</a>:</p>
<blockquote>
<p>Note: this is just <code>clif-util</code> enabling the <code>trace-log</code> feature by default, not changing <code>cranelift-codegen</code> or any other crate that is actually used as a dep anywhere.</p>
</blockquote>



<a name="368305789"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%236608%20Cranelift%3A%20Do%20not%20have%20any%20callee-sav.../near/368305789" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.236608.20Cranelift.3A.20Do.20not.20have.20any.20callee-sav.2E.2E.2E.html#368305789">(Jun 21 2023 at 16:59)</a>:</h4>
<p>jameysharp submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/6608#pullrequestreview-1488927475">PR review</a>:</p>
<blockquote>
<p>I don't much like the structure of this code; I know you've said you don't either. But this PR doesn't make it worse, so let's go with it.</p>
<p>I spent some time trying to figure out if there was more we could share between the register allocator configuration and these ABI bits, given that all allocatable registers are supposed to be clobbered in this ABI, but that didn't look straightforward.</p>
<p>As future work, I think there's something we can do with RA2's <code>PRegSet</code> to represent all of these different ABI-relevant sets of registers compactly; there's a popcount-like trick for finding the index of the Nth set bit that I think covers most of the uses we need here. (See the "Select the bit position (from the most-significant bit) with the given count (rank)" section of <a href="https://graphics.stanford.edu/~seander/bithacks.html">https://graphics.stanford.edu/~seander/bithacks.html</a>.) But that's not necessary to land this.</p>
</blockquote>



<a name="368305790"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%236608%20Cranelift%3A%20Do%20not%20have%20any%20callee-sav.../near/368305790" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.236608.20Cranelift.3A.20Do.20not.20have.20any.20callee-sav.2E.2E.2E.html#368305790">(Jun 21 2023 at 16:59)</a>:</h4>
<p>jameysharp submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/6608#pullrequestreview-1488927475">PR review</a>:</p>
<blockquote>
<p>I don't much like the structure of this code; I know you've said you don't either. But this PR doesn't make it worse, so let's go with it.</p>
<p>I spent some time trying to figure out if there was more we could share between the register allocator configuration and these ABI bits, given that all allocatable registers are supposed to be clobbered in this ABI, but that didn't look straightforward.</p>
<p>As future work, I think there's something we can do with RA2's <code>PRegSet</code> to represent all of these different ABI-relevant sets of registers compactly; there's a popcount-like trick for finding the index of the Nth set bit that I think covers most of the uses we need here. (See the "Select the bit position (from the most-significant bit) with the given count (rank)" section of <a href="https://graphics.stanford.edu/~seander/bithacks.html">https://graphics.stanford.edu/~seander/bithacks.html</a>.) But that's not necessary to land this.</p>
</blockquote>



<a name="368305791"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%236608%20Cranelift%3A%20Do%20not%20have%20any%20callee-sav.../near/368305791" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.236608.20Cranelift.3A.20Do.20not.20have.20any.20callee-sav.2E.2E.2E.html#368305791">(Jun 21 2023 at 16:59)</a>:</h4>
<p>jameysharp created <a href="https://github.com/bytecodealliance/wasmtime/pull/6608#discussion_r1235783327">PR review comment</a>:</p>
<blockquote>
<p>Would you add a comment here saying so?</p>
</blockquote>



<a name="368345652"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%236608%20Cranelift%3A%20Do%20not%20have%20any%20callee-sav.../near/368345652" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.236608.20Cranelift.3A.20Do.20not.20have.20any.20callee-sav.2E.2E.2E.html#368345652">(Jun 21 2023 at 19:42)</a>:</h4>
<p>fitzgen updated <a href="https://github.com/bytecodealliance/wasmtime/pull/6608">PR #6608</a>.</p>



<a name="368345687"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%236608%20Cranelift%3A%20Do%20not%20have%20any%20callee-sav.../near/368345687" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.236608.20Cranelift.3A.20Do.20not.20have.20any.20callee-sav.2E.2E.2E.html#368345687">(Jun 21 2023 at 19:42)</a>:</h4>
<p>fitzgen has enabled auto merge for <a href="https://github.com/bytecodealliance/wasmtime/pull/6608">PR #6608</a>.</p>



<a name="368362198"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%236608%20Cranelift%3A%20Do%20not%20have%20any%20callee-sav.../near/368362198" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.236608.20Cranelift.3A.20Do.20not.20have.20any.20callee-sav.2E.2E.2E.html#368362198">(Jun 21 2023 at 21:06)</a>:</h4>
<p>fitzgen merged <a href="https://github.com/bytecodealliance/wasmtime/pull/6608">PR #6608</a>.</p>



<hr><p>Last updated: Jan 20 2025 at 06:04 UTC</p>
</html>