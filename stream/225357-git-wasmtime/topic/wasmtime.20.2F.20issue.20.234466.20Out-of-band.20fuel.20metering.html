<html>
<head><meta charset="utf-8"><title>wasmtime / issue #4466 Out-of-band fuel metering · git-wasmtime · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/index.html">git-wasmtime</a></h2>
<h3>Topic: <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.234466.20Out-of-band.20fuel.20metering.html">wasmtime / issue #4466 Out-of-band fuel metering</a></h3>

<hr>

<base href="https://bytecodealliance.zulipchat.com">

<head><link href="https://bytecodealliance.github.io/zulip-archive/style.css" rel="stylesheet"></head>

<a name="290137859"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%234466%20Out-of-band%20fuel%20metering/near/290137859" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.234466.20Out-of-band.20fuel.20metering.html#290137859">(Jul 19 2022 at 18:00)</a>:</h4>
<p>github-actions[bot] <a href="https://github.com/bytecodealliance/wasmtime/pull/4466#issuecomment-1189392563">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/4466">issue #4466</a>:</p>
<blockquote>
<h4>Subscribe to Label Action</h4>
<p>cc @peterhuene</p>
<p>&lt;details&gt;<br>
This issue or pull request has been labeled: "wasmtime:api", "wasmtime:config"</p>
<p>Thus the following users have been cc'd because of the following labels:</p>
<ul>
<li>peterhuene: wasmtime:api</li>
</ul>
<p>To subscribe or unsubscribe from this label, edit the &lt;code&gt;.github/subscribe-to-label.json&lt;/code&gt; configuration file.</p>
<p><a href="https://github.com/bytecodealliance/subscribe-to-label-action">Learn more.</a><br>
&lt;/details&gt;</p>
</blockquote>



<a name="290137893"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%234466%20Out-of-band%20fuel%20metering/near/290137893" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.234466.20Out-of-band.20fuel.20metering.html#290137893">(Jul 19 2022 at 18:01)</a>:</h4>
<p>github-actions[bot] <a href="https://github.com/bytecodealliance/wasmtime/pull/4466#issuecomment-1189392732">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/4466">issue #4466</a>:</p>
<blockquote>
<h4>Label Messager: wasmtime:config</h4>
<p>It looks like you are changing Wasmtime's configuration options. Make sure to<br>
complete this check list:</p>
<ul>
<li>
<p>[ ] If you added a new <code>Config</code> method, you wrote extensive documentation for<br>
      it.</p>
<p>&lt;details&gt;</p>
<p>Our documentation should be of the following form:</p>
<p>```text<br>
Short, simple summary sentence.</p>
<p>More details. These details can be multiple paragraphs. There should be<br>
information about not just the method, but its parameters and results as<br>
well.</p>
<p>Is this method fallible? If so, when can it return an error?</p>
<p>Can this method panic? If so, when does it panic?</p>
<h1>Example</h1>
<p>Optional example here.<br>
```</p>
<p>&lt;/details&gt;</p>
</li>
<li>
<p>[ ] If you added a new <code>Config</code> method, or modified an existing one, you<br>
  ensured that this configuration is exercised by the fuzz targets.</p>
<p>&lt;details&gt;</p>
<p>For example, if you expose a new strategy for allocating the next instance<br>
slot inside the pooling allocator, you should ensure that at least one of our<br>
fuzz targets exercises that new strategy.</p>
<p>Often, all that is required of you is to ensure that there is a knob for this<br>
configuration option in [<code>wasmtime_fuzzing::Config</code>][fuzzing-config] (or one<br>
of its nested <code>struct</code>s).</p>
<p>Rarely, this may require authoring a new fuzz target to specifically test this<br>
configuration. See [our docs on fuzzing][fuzzing-docs] for more details.</p>
<p>&lt;/details&gt;</p>
</li>
<li>
<p>[ ] If you are enabling a configuration option by default, make sure that it<br>
  has been fuzzed for at least two weeks before turning it on by default.</p>
</li>
</ul>
<p>[fuzzing-config]: <a href="https://github.com/bytecodealliance/wasmtime/blob/ca0e8d0a1d8cefc0496dba2f77a670571d8fdcab/crates/fuzzing/src/generators.rs#L182-L194">https://github.com/bytecodealliance/wasmtime/blob/ca0e8d0a1d8cefc0496dba2f77a670571d8fdcab/crates/fuzzing/src/generators.rs#L182-L194</a><br>
[fuzzing-docs]: <a href="https://docs.wasmtime.dev/contributing-fuzzing.html">https://docs.wasmtime.dev/contributing-fuzzing.html</a></p>
<hr>
<p>&lt;details&gt;</p>
<p>To modify this label's message, edit the &lt;code&gt;.github/label-messager/wasmtime-config.md&lt;/code&gt; file.</p>
<p>To add new label messages or remove existing label messages, edit the<br>
&lt;code&gt;.github/label-messager.json&lt;/code&gt; configuration file.</p>
<p><a href="https://github.com/bytecodealliance/label-messager-action">Learn more.</a></p>
<p>&lt;/details&gt;</p>
</blockquote>



<a name="290534030"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%234466%20Out-of-band%20fuel%20metering/near/290534030" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.234466.20Out-of-band.20fuel.20metering.html#290534030">(Jul 22 2022 at 16:26)</a>:</h4>
<p>pepyakin <a href="https://github.com/bytecodealliance/wasmtime/pull/4466#issuecomment-1192742842">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/4466">issue #4466</a>:</p>
<blockquote>
<p>Thank you for taking a look!</p>
<p>Yes, @alexcrichton, this PR is very raw right, way much less that I prefer right now. Sorry about that. I was eager to create it because of two reasons:</p>
<ol>
<li>I wanted to check if the general approach is what we want to,</li>
<li>the actual trigger, was that I discovered Nick's PR #4431.</li>
</ol>
<p>Specifically, to give the context for this question <a href="https://github.com/bytecodealliance/wasmtime/pull/4431#discussion_r924804070">https://github.com/bytecodealliance/wasmtime/pull/4431#discussion_r924804070</a>. I was scared that it made this PR impossible or very hard to implement.</p>
<p>Right now, I am rebasing this PR onto Nick's and trying to figure out what to do with the trampolines. The best I came up with so far is under the spoiler below. I hope my programming license won't be revoked.</p>
<p>&lt;details&gt;</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="k">struct</span> <span class="nc">VMRuntimeLimits</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="c1">// ...</span>

<span class="w">    </span><span class="sd">/// A flag that indicates if the out-of-band fuel metering is enabled.</span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="n">outband_fuel</span>: <span class="nc">UnsafeCell</span><span class="o">&lt;</span><span class="kt">bool</span><span class="o">&gt;</span><span class="p">,</span><span class="w"></span>

<span class="w">    </span><span class="sd">/// host-to-wasm return address.</span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="n">orig_entry_trampoline_return_address</span>: <span class="nc">UnsafeCell</span><span class="o">&lt;</span><span class="kt">usize</span><span class="o">&gt;</span><span class="p">,</span><span class="w"></span>

<span class="w">    </span><span class="sd">/// wasm-to-host return address.</span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="n">orig_exit_trampoline_return_address</span>: <span class="nc">UnsafeCell</span><span class="o">&lt;</span><span class="kt">usize</span><span class="o">&gt;</span><span class="p">,</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="c1">// ...</span>

<span class="n">asm_func</span><span class="o">!</span><span class="p">(</span><span class="w"></span>
<span class="w">    </span><span class="s">"host_to_wasm_trampoline"</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="s">"</span>
<span class="s">        .cfi_startproc simple</span>
<span class="s">        .cfi_def_cfa_offset 0</span>

<span class="s">        // Load the pointer to `VMRuntimeLimits` in `r10`.</span>
<span class="s">        mov r10, 8[rsi]</span>

<span class="s">        // Check to see if this is a core `VMContext` (MAGIC == 'core').</span>
<span class="s">        cmp DWORD PTR [rdi], 0x65726f63</span>

<span class="s">        // Store the last Wasm SP into the `last_wasm_entry_sp` in the limits, if this</span>
<span class="s">        // was core Wasm, otherwise store an invalid sentinal value.</span>
<span class="s">        mov r11, -1</span>
<span class="s">        cmove r11, rsp</span>
<span class="s">        mov 40[r10], r11</span>

<span class="s">        // Check if the out-of-band fuel metering is enabled. If it is not enabled, skip to the</span>
<span class="s">        // tail call directly.</span>
<span class="s">        cmp QWORD PTR 48[r10], 0x00</span>
<span class="s">        je host_to_wasm_trampoline__perform_tail_call</span>

<span class="s">        // OK, here we know that the out-of-band fuel metering is enabled.</span>
<span class="s">        //</span>
<span class="s">        // Dump the `fuel_consumed` into the fuel register.</span>
<span class="s">        mov r15, 8[r10]</span>

<span class="s">        // Next, we have to do some shenanigans. Below we call into the wasm with a tail call, to</span>
<span class="s">        // not mess with the stack layout. But at the same time, after returning from wasm, we</span>
<span class="s">        // have to our fuel register r15 back into `fuel_consumed` of `VMRuntimeLimits`. To do that</span>
<span class="s">        // we stash the original return address (which is currently located at `[rsp]`) that points</span>
<span class="s">        // back to the caller from the host side and change it with the continuation defined</span>
<span class="s">        // below. The continuation will dump the r15 back into the memory and unstash the original</span>
<span class="s">        // return address and jump at it.</span>

<span class="s">        mov r11, [rsp]</span>
<span class="s">        mov 56[r10], r11</span>
<span class="s">        lea r11, [rip+host_to_wasm_trampoline__cont]</span>
<span class="s">        mov [rsp], r11</span>

<span class="s">        host_to_wasm_trampoline__perform_tail_call:</span>

<span class="s">        // Tail call to the callee function pointer in the vmctx.</span>
<span class="s">        jmp 16[rsi]</span>

<span class="s">        host_to_wasm_trampoline__cont:</span>

<span class="s">        // Here we're in a inconvenient situation, where the callee's frame is popped and all the</span>
<span class="s">        // arguments are gone. We have to improvise our way out of this situation.</span>

<span class="s">        // Open a temporary stack frame.</span>
<span class="s">        //</span>
<span class="s">        // The frame layout:</span>
<span class="s">        //</span>
<span class="s">        // rsp +  0: The original return address. Written by `wasmtime_outband_fuel_on_entry`.</span>
<span class="s">        // rsp +  8: r15</span>
<span class="s">        // rsp + 16: rax</span>
<span class="s">        // rsp + 24: padding</span>
<span class="s">        // rsp + 32: xmm0</span>
<span class="s">        sub rsp, 48</span>
<span class="s">        mov 8[rsp], r15</span>
<span class="s">        mov 16[rsp], rax</span>
<span class="s">        movdqu XMMWORD PTR 32[rsp], xmm0</span>

<span class="s">        // Finally, move the current rsp into the first argument.</span>
<span class="s">        mov rdi, rsp</span>
<span class="s">        call wasmtime_outband_fuel_on_entry</span>

<span class="s">        // Load the original return address into r10</span>
<span class="s">        mov r10, 0[rsp]</span>

<span class="s">        // Restore the initial values of rax and xmm0.</span>
<span class="s">        mov rax, 16[rsp]</span>
<span class="s">        movdqu xmm0, XMMWORD PTR 32[rsp]</span>

<span class="s">        // Release the allocated stack area.</span>
<span class="s">        add rsp, 48</span>

<span class="s">        // Jump at the original return address.</span>
<span class="s">        jmp r10</span>

<span class="s">        .cfi_endproc</span>
<span class="s">    "</span><span class="p">,</span><span class="w"></span>
<span class="p">);</span><span class="w"></span>


<span class="sd">/// Dumps fuel into the `VMRuntimeLimits-&gt;fuel_consumed` and unstashes the original return address</span>
<span class="sd">/// for the trampoline.</span>
<span class="sd">///</span>
<span class="sd">/// Only used if out-of-band fuel is used.</span>
<span class="cp">#[no_mangle]</span><span class="w"></span>
<span class="k">pub</span><span class="w"> </span><span class="k">unsafe</span><span class="w"> </span><span class="k">extern</span><span class="w"> </span><span class="s">"C"</span><span class="w"> </span><span class="k">fn</span> <span class="nf">wasmtime_outband_fuel_on_entry</span><span class="p">(</span><span class="n">sp</span>: <span class="o">*</span><span class="k">mut</span><span class="w"> </span><span class="kt">usize</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">use</span><span class="w"> </span><span class="k">crate</span>::<span class="n">traphandlers</span>::<span class="n">tls</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="n">tls</span>::<span class="n">with</span><span class="p">(</span><span class="o">|</span><span class="n">info</span><span class="o">|</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="n">info</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">match</span><span class="w"> </span><span class="n">info</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">            </span><span class="nb">Some</span><span class="p">(</span><span class="n">info</span><span class="p">)</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="n">info</span><span class="p">,</span><span class="w"></span>
<span class="w">            </span><span class="nb">None</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">                </span><span class="c1">// Entering trampoline must set the TLS.</span>
<span class="w">                </span><span class="n">std</span>::<span class="n">hint</span>::<span class="n">unreachable_unchecked</span><span class="p">();</span><span class="w"></span>
<span class="w">            </span><span class="p">}</span><span class="w"></span>
<span class="w">        </span><span class="p">};</span><span class="w"></span>

<span class="w">        </span><span class="cp">#[repr(C)]</span><span class="w"></span>
<span class="w">        </span><span class="k">struct</span> <span class="nc">StackArgs</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">            </span><span class="n">return_address</span>: <span class="kt">usize</span><span class="p">,</span><span class="w"></span>
<span class="w">            </span><span class="n">fuel</span>: <span class="kt">i64</span><span class="p">,</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"></span>

<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="n">args</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">sp</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="o">*</span><span class="k">mut</span><span class="w"> </span><span class="n">StackArgs</span><span class="p">;</span><span class="w"></span>

<span class="w">        </span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">).</span><span class="n">return_address</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">*</span><span class="p">(</span><span class="o">*</span><span class="n">info</span><span class="p">.</span><span class="n">runtime_limits</span><span class="p">())</span><span class="w"></span>
<span class="w">            </span><span class="p">.</span><span class="n">orig_entry_trampoline_return_address</span><span class="w"></span>
<span class="w">            </span><span class="p">.</span><span class="n">get</span><span class="p">();</span><span class="w"></span>
<span class="w">        </span><span class="o">*</span><span class="p">(</span><span class="o">*</span><span class="n">info</span><span class="p">.</span><span class="n">runtime_limits</span><span class="p">()).</span><span class="n">fuel_consumed</span><span class="p">.</span><span class="n">get</span><span class="p">()</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">).</span><span class="n">fuel</span><span class="p">;</span><span class="w"></span>

<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">).</span><span class="n">fuel</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">            </span><span class="c1">// Fuel ran out and we bail through unwinding.</span>
<span class="w">            </span><span class="k">crate</span>::<span class="n">traphandlers</span>::<span class="n">raise_lib_trap</span><span class="p">(</span><span class="n">wasmtime_environ</span>::<span class="n">TrapCode</span>::<span class="n">Interrupt</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="p">});</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>
<p>&lt;/details&gt;</p>
<p>This seems to be working and I hope I am not missing anything. I am in the process of replicating the same construction for the wasm-to-host and libcall trampolines. </p>
<p>You can see there it should address the concerns you expressed wrt not checking the fuel. To be clear, the trampoline generation in <code>compiler.rs</code> will also be removed, since the common variadic asm trampoline (what's a better name to distingiush it from the ones generated in <a href="http://compiler.rs">compiler.rs</a>?) takes care of that.</p>
<p>I ack the other notes. I hope the next push will feature not as raw code as this one. Also will run the benchmarks on it.</p>
</blockquote>



<a name="290556453"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%234466%20Out-of-band%20fuel%20metering/near/290556453" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.234466.20Out-of-band.20fuel.20metering.html#290556453">(Jul 22 2022 at 19:30)</a>:</h4>
<p>alexcrichton <a href="https://github.com/bytecodealliance/wasmtime/pull/4466#issuecomment-1192875253">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/4466">issue #4466</a>:</p>
<blockquote>
<p>Oh no worries! I mostly want to make sure I'm clear on expectations and such, it's totally fine to push up work-in-progress PRs.</p>
<p>Also wow that is some gnarly assembly. I... can see how it might work though! I suspect one day we're going to need to severly improve our trampoline story, even with "just maintain frame pointers" it was already complicated enough... In any case though not a blocker for this work, just something for us to ponder.</p>
</blockquote>



<a name="290772404"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%234466%20Out-of-band%20fuel%20metering/near/290772404" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.234466.20Out-of-band.20fuel.20metering.html#290772404">(Jul 25 2022 at 15:14)</a>:</h4>
<p>alexcrichton <a href="https://github.com/bytecodealliance/wasmtime/pull/4466#issuecomment-1194183452">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/4466">issue #4466</a>:</p>
<blockquote>
<p>One thing I just thought of I want to note before I forget about, right now "is this a wasm pc" is pretty crude where it just checks if the instruction pointer is in the code section of a loaded module (this is preexisting in Wasmtime) but I think that we'll want to enhance that because if an interrupt happens during an entry trampoline we can't guarantee that the fuel register is configured yet, so we'll want to make sure that the "is this a wasm pc" check may exclude trampolines.</p>
</blockquote>



<a name="290775793"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%234466%20Out-of-band%20fuel%20metering/near/290775793" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.234466.20Out-of-band.20fuel.20metering.html#290775793">(Jul 25 2022 at 15:36)</a>:</h4>
<p>pepyakin <a href="https://github.com/bytecodealliance/wasmtime/pull/4466#issuecomment-1194223074">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/4466">issue #4466</a>:</p>
<blockquote>
<p>Oh, yes, definitely. On top of that, the query should be a bit more smarter. It should only return true if <code>pc</code> is in a wasm module that defines r15 as fuel, not just any module. That should come.</p>
<p>I've been battling with the trampolines for quite some time now, and it does not seem good.</p>
<p>The problem is I am not sure how to make the system unwinder work through this trampoline. So at first, I was getting the SIGABRT from the unwinder since it couldn't find the CFA. I fixed that by replacing <code>cfi_def_cfa_offset 0</code> with <code>.cfi_def_cfa rsp, 0</code>. That kind of worked, but then the unwinder started getting stuck in the infinite loop. </p>
<p>I fixed that by slapping <code>.cfi_undefined 16</code> before the tail call. That worked but, expectedly, now the unwinder can't get past the trampolines, and the stack traces (e.g. created by anyhow) are chopped.</p>
<p>We need to annotate where we get the original return address to fix that. The return address is stored behind TLS. There is no way, we can come up with a DWARF expression that fetches it from the <code>VMRuntimeLimits</code>.</p>
</blockquote>



<a name="290775825"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%234466%20Out-of-band%20fuel%20metering/near/290775825" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.234466.20Out-of-band.20fuel.20metering.html#290775825">(Jul 25 2022 at 15:36)</a>:</h4>
<p>pepyakin edited a <a href="https://github.com/bytecodealliance/wasmtime/pull/4466#issuecomment-1194223074">comment</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/4466">issue #4466</a>:</p>
<blockquote>
<p>Oh, yes, definitely. On top of that, the query should be a bit more smarter. It should only return true if <code>pc</code> is in a wasm module that defines r15 as fuel, not just any module. That should come later.</p>
<p>I've been battling with the trampolines for quite some time now, and it does not seem good.</p>
<p>The problem is I am not sure how to make the system unwinder work through this trampoline. So at first, I was getting the SIGABRT from the unwinder since it couldn't find the CFA. I fixed that by replacing <code>cfi_def_cfa_offset 0</code> with <code>.cfi_def_cfa rsp, 0</code>. That kind of worked, but then the unwinder started getting stuck in the infinite loop. </p>
<p>I fixed that by slapping <code>.cfi_undefined 16</code> before the tail call. That worked but, expectedly, now the unwinder can't get past the trampolines, and the stack traces (e.g. created by anyhow) are chopped.</p>
<p>We need to annotate where we get the original return address to fix that. The return address is stored behind TLS. There is no way, we can come up with a DWARF expression that fetches it from the <code>VMRuntimeLimits</code>.</p>
</blockquote>



<a name="290779612"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%234466%20Out-of-band%20fuel%20metering/near/290779612" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.234466.20Out-of-band.20fuel.20metering.html#290779612">(Jul 25 2022 at 16:02)</a>:</h4>
<p>pepyakin <a href="https://github.com/bytecodealliance/wasmtime/pull/4466#issuecomment-1194286371">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/4466">issue #4466</a>:</p>
<blockquote>
<p>Ah, regarding the fuel register being initialized, I think it should already work. <a href="https://github.com/bytecodealliance/wasmtime/pull/4466/files#diff-9d82b907a78ab6fb3a70e80a5d999294511e55cda60bc01a2d643b078f3d9af7R260">Here</a> we ask for the <code>DefinedFunctionIndex</code> which is available only for functions defined by a wasm module and trampolines should be different.</p>
</blockquote>



<a name="290779670"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%234466%20Out-of-band%20fuel%20metering/near/290779670" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.234466.20Out-of-band.20fuel.20metering.html#290779670">(Jul 25 2022 at 16:02)</a>:</h4>
<p>pepyakin edited a <a href="https://github.com/bytecodealliance/wasmtime/pull/4466#issuecomment-1194286371">comment</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/4466">issue #4466</a>:</p>
<blockquote>
<p>Ah, regarding the fuel register being initialized, I think it should already work. <a href="https://github.com/bytecodealliance/wasmtime/pull/4466/files#diff-9d82b907a78ab6fb3a70e80a5d999294511e55cda60bc01a2d643b078f3d9af7R260">Here</a> we ask for the <code>DefinedFunctionIndex</code> which is available only for functions defined by a wasm module. If pc falls on a trampoline that would return <code>None</code>.</p>
</blockquote>



<a name="290822534"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%234466%20Out-of-band%20fuel%20metering/near/290822534" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.234466.20Out-of-band.20fuel.20metering.html#290822534">(Jul 25 2022 at 21:43)</a>:</h4>
<p>alexcrichton <a href="https://github.com/bytecodealliance/wasmtime/pull/4466#issuecomment-1194669363">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/4466">issue #4466</a>:</p>
<blockquote>
<p>I'm pretty sure our dwarf unwind information is not "async correct" where every single ip in a function guarantees a correct backtrace. With the fast-stack-walking branch and fp-based unwinds that may get better though.</p>
</blockquote>



<a name="290870619"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%234466%20Out-of-band%20fuel%20metering/near/290870619" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.234466.20Out-of-band.20fuel.20metering.html#290870619">(Jul 26 2022 at 09:58)</a>:</h4>
<p>pepyakin <a href="https://github.com/bytecodealliance/wasmtime/pull/4466#issuecomment-1195272919">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/4466">issue #4466</a>:</p>
<blockquote>
<blockquote>
<p>I'm pretty sure our dwarf unwind information is not "async correct" where every single ip in a function guarantees a correct backtrace. With the fast-stack-walking branch and fp-based unwinds that may get better though.</p>
</blockquote>
<p>Oh, sure, I remember that. It should be fine though since I was not planning on capturing the backtraces in the fuel interrupts, and I still keep in mind the landing pads idea.</p>
<p>The problem I am dealing with now is not about async traps. I should've been clearer on this. That SIGABRT would happen during capturing the stack trace iff the trampoline on the stack, and it went through the return address swizzling of the continuation.</p>
<p>I came up with a standalone minimized version of the problem which can be found under the spoiler:</p>
<p>&lt;details&gt;</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="c1">// extern crate backtrace;</span>

<span class="k">use</span><span class="w"> </span><span class="n">std</span>::<span class="n">arch</span><span class="p">;</span><span class="w"></span>
<span class="k">use</span><span class="w"> </span><span class="n">std</span>::<span class="n">mem</span><span class="p">;</span><span class="w"></span>

<span class="n">arch</span>::<span class="fm">global_asm!</span><span class="p">(</span><span class="w"></span>
<span class="w">    </span><span class="s">"</span>
<span class="s">    .p2align 4</span>
<span class="s">    .global trampoline</span>
<span class="s">    .type trampoline, @function</span>

<span class="s">    trampoline:</span>

<span class="s">    .cfi_startproc simple</span>
<span class="s">    .cfi_def_cfa rsp, 0</span>

<span class="s">    // move RDI, the original function, into r11</span>
<span class="s">    mov r11, rdi</span>

<span class="s">    // the return address pushed by the `call` instruction calling this trampoline</span>
<span class="s">    // is located at *rsp. Move the value to rdi.</span>
<span class="s">    mov rdi, [rsp]</span>

<span class="s">    // Then, replace the return value with the continuation at the label `cont`.</span>
<span class="s">    lea r10, cont[rip]</span>
<span class="s">    mov [rsp], r10</span>

<span class="s">    //</span>
<span class="s">    // Important!!</span>
<span class="s">    //</span>
<span class="s">    // Mark the register 16, aka the return address, as undefined. That stops the unwinder here.</span>
<span class="s">    // If that was not here, the unwinder would fall into an infinite loop.</span>
<span class="s">    //</span>
<span class="s">    // An unfortunate side-effect is the stack traces are also chopped here.</span>
<span class="s">    .cfi_undefined 16</span>

<span class="s">    // Finally, perform the jump.</span>
<span class="s">    jmp r11</span>

<span class="s">    cont:</span>

<span class="s">    jmp rax</span>

<span class="s">    .cfi_endproc</span>

<span class="s">    .size trampoline, .-trampoline</span>
<span class="s">    "</span><span class="w"></span>
<span class="p">);</span><span class="w"></span>

<span class="k">extern</span><span class="w"> </span><span class="s">"C"</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">fn</span> <span class="nf">trampoline</span><span class="p">();</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="k">type</span> <span class="nc">Func</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">extern</span><span class="w"> </span><span class="s">"C"</span><span class="w"> </span><span class="k">fn</span><span class="p">(</span><span class="o">*</span><span class="k">const</span><span class="w"> </span><span class="p">(),</span><span class="w"> </span><span class="kt">usize</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="o">*</span><span class="k">const</span><span class="w"> </span><span class="p">();</span><span class="w"></span>

<span class="cp">#[inline]</span><span class="w"></span>
<span class="k">unsafe</span><span class="w"> </span><span class="k">fn</span> <span class="nf">prepare_trampoline</span><span class="p">(</span><span class="n">dest</span>: <span class="nc">Func</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="p">(</span><span class="o">*</span><span class="k">const</span><span class="w"> </span><span class="p">(),</span><span class="w"> </span><span class="n">Func</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">dest</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">dest</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="o">*</span><span class="k">const</span><span class="w"> </span><span class="n">Func</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="o">*</span><span class="k">const</span><span class="w"> </span><span class="p">();</span><span class="w"></span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">func</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">mem</span>::<span class="n">transmute_copy</span><span class="p">(</span><span class="o">&amp;</span><span class="p">(</span><span class="n">trampoline</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="kt">usize</span><span class="p">));</span><span class="w"></span>

<span class="w">    </span><span class="p">(</span><span class="n">dest</span><span class="p">,</span><span class="w"> </span><span class="n">func</span><span class="p">)</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="k">fn</span> <span class="nf">main</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">unsafe</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="p">(</span><span class="n">dest</span><span class="p">,</span><span class="w"> </span><span class="n">f</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">prepare_trampoline</span><span class="p">(</span><span class="n">host_func</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="n">f</span><span class="p">(</span><span class="n">dest</span><span class="p">,</span><span class="w"> </span><span class="mi">48</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="k">extern</span><span class="w"> </span><span class="s">"C"</span><span class="w"> </span><span class="k">fn</span> <span class="nf">host_func</span><span class="p">(</span><span class="n">rdi</span>: <span class="o">*</span><span class="k">const</span><span class="w"> </span><span class="p">(),</span><span class="w"> </span><span class="n">rsi</span>: <span class="kt">usize</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="o">*</span><span class="k">const</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="fm">println!</span><span class="p">(</span><span class="s">"{}"</span><span class="p">,</span><span class="w"> </span><span class="n">rsi</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">count</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="n">backtrace</span>::<span class="n">trace</span><span class="p">(</span><span class="o">|</span><span class="n">frame</span><span class="o">|</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="n">ip</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">frame</span><span class="p">.</span><span class="n">ip</span><span class="p">();</span><span class="w"></span>
<span class="w">        </span><span class="fm">println!</span><span class="p">(</span><span class="s">"{:X}"</span><span class="p">,</span><span class="w"> </span><span class="n">ip</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="kt">usize</span><span class="p">);</span><span class="w"></span>

<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="n">count</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">100</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">            </span><span class="c1">// likely we stuck in a loop. Break into the debugger.</span>
<span class="w">            </span><span class="k">unsafe</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">                </span><span class="n">arch</span>::<span class="fm">asm!</span><span class="p">(</span><span class="s">"ud2"</span><span class="p">);</span><span class="w"></span>
<span class="w">            </span><span class="p">}</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"></span>
<span class="w">        </span><span class="n">count</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span><span class="w"></span>

<span class="w">        </span><span class="kc">true</span><span class="w"></span>
<span class="w">    </span><span class="p">});</span><span class="w"></span>

<span class="w">    </span><span class="c1">// we don't have such luxury in the real thing.</span>
<span class="w">    </span><span class="n">rdi</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>
<p>&lt;/details&gt;</p>
<p>If you remove the <code>.cfi_undefined 16</code> directive, the unwinder would get stuck in an infinite loop.<br>
If you remove the <code>.cfi_def_cfa rsp, 0</code> directive, or even change to <code>.cfi_def_cfa_offset 0</code> (Does this require attention in <a href="https://github.com/bytecodealliance/wasmtime/pull/4431">https://github.com/bytecodealliance/wasmtime/pull/4431</a>?) found in the original version, then you would get SIGABRT:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="o">*</span><span class="w"> </span><span class="n">thread</span><span class="w"> </span>#<span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">'</span><span class="na">cfi</span><span class="o">-</span><span class="n">dwarf</span><span class="o">'</span><span class="p">,</span><span class="w"> </span><span class="n">stop</span><span class="w"> </span><span class="n">reason</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">signal</span><span class="w"> </span><span class="n">SIGABRT</span><span class="w"></span>
<span class="w">  </span><span class="o">*</span><span class="w"> </span><span class="n">frame</span><span class="w"> </span>#<span class="mi">0</span>: <span class="mh">0x00007ffff7e3abaa</span><span class="w"> </span><span class="n">libc</span><span class="p">.</span><span class="n">so</span><span class="p">.</span><span class="mi">6</span><span class="err">`</span><span class="n">raise</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">202</span><span class="w"></span>
<span class="w">    </span><span class="n">frame</span><span class="w"> </span>#<span class="mi">1</span>: <span class="mh">0x00007ffff7e25523</span><span class="w"> </span><span class="n">libc</span><span class="p">.</span><span class="n">so</span><span class="p">.</span><span class="mi">6</span><span class="err">`</span><span class="n">abort</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">255</span><span class="w"></span>
<span class="w">    </span><span class="n">frame</span><span class="w"> </span>#<span class="mi">2</span>: <span class="mh">0x00007ffff7dd5b40</span><span class="w"> </span><span class="n">libgcc_s</span><span class="p">.</span><span class="n">so</span><span class="p">.</span><span class="mi">1</span><span class="err">`</span><span class="n">uw_update_context_1</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1008</span><span class="w"></span>
<span class="w">    </span><span class="n">frame</span><span class="w"> </span>#<span class="mi">3</span>: <span class="mh">0x00007ffff7dd5cd1</span><span class="w"> </span><span class="n">libgcc_s</span><span class="p">.</span><span class="n">so</span><span class="p">.</span><span class="mi">1</span><span class="err">`</span><span class="n">uw_update_context</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">17</span><span class="w"></span>
<span class="w">    </span><span class="n">frame</span><span class="w"> </span>#<span class="mi">4</span>: <span class="mh">0x00007ffff7dd68bd</span><span class="w"> </span><span class="n">libgcc_s</span><span class="p">.</span><span class="n">so</span><span class="p">.</span><span class="mi">1</span><span class="err">`</span><span class="n">_Unwind_Backtrace</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">93</span><span class="w"></span>
<span class="w">    </span><span class="n">frame</span><span class="w"> </span>#<span class="mi">5</span>: <span class="mh">0x000055555555cfa1</span><span class="w"> </span><span class="n">cfi</span><span class="o">-</span><span class="n">dwarf</span><span class="err">`</span><span class="n">backtrace</span>::<span class="n">backtrace</span>::<span class="n">trace_unsynchronized</span>::<span class="n">hf1601be64f8e51c8</span><span class="w"> </span><span class="p">[</span><span class="n">inlined</span><span class="p">]</span><span class="w"> </span><span class="n">backtrace</span>::<span class="n">backtrace</span>::<span class="n">libunwind</span>::<span class="n">trace</span>::<span class="n">h80afc20a98e10b83</span><span class="p">(</span><span class="n">cb</span><span class="o">=&amp;</span><span class="k">mut</span><span class="w"> </span><span class="k">dyn</span><span class="w"> </span><span class="n">core</span>::<span class="n">ops</span>::<span class="n">function</span>::<span class="nb">FnMut</span><span class="o">&lt;</span><span class="p">(</span><span class="o">&amp;</span><span class="n">backtrace</span>::<span class="n">backtrace</span>::<span class="n">Frame</span><span class="p">),</span><span class="w"> </span><span class="n">Output</span><span class="o">=</span><span class="kt">bool</span><span class="o">&gt;</span><span class="w"> </span><span class="o">@</span><span class="w"> </span><span class="mh">0x00007fffffff9d58</span><span class="p">)</span><span class="w"> </span><span class="n">at</span><span class="w"> </span><span class="n">libunwind</span><span class="p">.</span><span class="n">rs</span>:<span class="mi">93</span>:<span class="mi">5</span><span class="w"></span>
<span class="w">    </span><span class="n">frame</span><span class="w"> </span>#<span class="mi">6</span>: <span class="mh">0x000055555555cf8c</span><span class="w"> </span><span class="n">cfi</span><span class="o">-</span><span class="n">dwarf</span><span class="err">`</span><span class="n">backtrace</span>::<span class="n">backtrace</span>::<span class="n">trace_unsynchronized</span>::<span class="n">hf1601be64f8e51c8</span><span class="p">(</span><span class="n">cb</span><span class="o">=</span><span class="p">{</span><span class="n">closure_env</span>#<span class="mi">0</span><span class="p">}</span><span class="w"> </span><span class="o">@</span><span class="w"> </span><span class="mh">0x00007fffffff9d40</span><span class="p">)</span><span class="w"> </span><span class="n">at</span><span class="w"> </span><span class="k">mod</span><span class="p">.</span><span class="n">rs</span>:<span class="mi">66</span>:<span class="mi">5</span><span class="w"></span>
<span class="w">    </span><span class="n">frame</span><span class="w"> </span>#<span class="mi">7</span>: <span class="mh">0x000055555555d038</span><span class="w"> </span><span class="n">cfi</span><span class="o">-</span><span class="n">dwarf</span><span class="err">`</span><span class="n">backtrace</span>::<span class="n">backtrace</span>::<span class="n">trace</span>::<span class="n">h4ba2f0e531a2363e</span><span class="p">(</span><span class="n">cb</span><span class="o">=</span><span class="p">{</span><span class="n">closure_env</span>#<span class="mi">0</span><span class="p">}</span><span class="w"> </span><span class="o">@</span><span class="w"> </span><span class="mh">0x00007fffffff9da0</span><span class="p">)</span><span class="w"> </span><span class="n">at</span><span class="w"> </span><span class="k">mod</span><span class="p">.</span><span class="n">rs</span>:<span class="mi">53</span>:<span class="mi">14</span><span class="w"></span>
<span class="w">    </span><span class="n">frame</span><span class="w"> </span>#<span class="mi">8</span>: <span class="mh">0x000055555555d1d3</span><span class="w"> </span><span class="n">cfi</span><span class="o">-</span><span class="n">dwarf</span><span class="err">`</span><span class="n">cfi_dwarf</span>::<span class="n">host_func</span>::<span class="n">h89c8978f2a6c15a6</span><span class="p">(</span><span class="n">rdi</span><span class="o">=</span><span class="mh">0x000055555555d148</span><span class="p">,</span><span class="w"> </span><span class="n">rsi</span><span class="o">=</span><span class="mi">48</span><span class="p">)</span><span class="w"> </span><span class="n">at</span><span class="w"> </span><span class="n">main</span><span class="p">.</span><span class="n">rs</span>:<span class="mi">74</span>:<span class="mi">5</span><span class="w"></span>
</code></pre></div>
</blockquote>



<a name="290917202"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%234466%20Out-of-band%20fuel%20metering/near/290917202" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.234466.20Out-of-band.20fuel.20metering.html#290917202">(Jul 26 2022 at 16:14)</a>:</h4>
<p>alexcrichton <a href="https://github.com/bytecodealliance/wasmtime/pull/4466#issuecomment-1195691577">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/4466">issue #4466</a>:</p>
<blockquote>
<p>Oh right yeah with the trampoline you gisted above I was wondering how backtrace info would work out and it seems like it doesn't. I don't know how to solve that myself, the trampoline there is quite gnarly.</p>
</blockquote>



<a name="290921064"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%234466%20Out-of-band%20fuel%20metering/near/290921064" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.234466.20Out-of-band.20fuel.20metering.html#290921064">(Jul 26 2022 at 16:41)</a>:</h4>
<p>pepyakin <a href="https://github.com/bytecodealliance/wasmtime/pull/4466#issuecomment-1195721547">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/4466">issue #4466</a>:</p>
<blockquote>
<blockquote>
<p>Oh right yeah with the trampoline you gisted above I was wondering how backtrace info would work out and it seems like it doesn't. I don't know how to solve that myself, the trampoline there is quite gnarly.</p>
</blockquote>
<p>If wasmtime-flavoured ABIs enshrined the caller vmctx and guaranteed it so that it is still usable after the callee returns, it would've made things simpler: no need for reaching to tls for the original return address. The dwarf expression would require a few dereferences but otherwise seems to be doable.</p>
<p>If you (or anyone from BA) think that's acceptable, I can try to research this implementation strategy.</p>
<p>Otherwise, I think I ran out of ideas how to make this work.</p>
</blockquote>



<a name="290948000"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%234466%20Out-of-band%20fuel%20metering/near/290948000" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.234466.20Out-of-band.20fuel.20metering.html#290948000">(Jul 26 2022 at 19:59)</a>:</h4>
<p>alexcrichton <a href="https://github.com/bytecodealliance/wasmtime/pull/4466#issuecomment-1195920402">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/4466">issue #4466</a>:</p>
<blockquote>
<p>Yeah unfortunately I don't have a great answer myself on that. I feel like with this and the stacks PR our trampoline story is pretty lacking, but I don't know how best to rectify it. Short of that it may be that a pinned register won't work at all until we figure out a better story for trampolines. Ideally all the pinned register/fuel stuff would be part of cranelift-compiled trampolines and we wouldn't have to tinker with <code>global_asm!</code> blobs at all. We're definitely not in a place to easily be able to do that right now though.</p>
</blockquote>



<hr><p>Last updated: Jan 20 2025 at 06:04 UTC</p>
</html>