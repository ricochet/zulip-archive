<html>
<head><meta charset="utf-8"><title>wasmtime / PR #9495 Improve `atomic_rmw` lowering on `x86` · git-wasmtime · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/index.html">git-wasmtime</a></h2>
<h3>Topic: <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.239495.20Improve.20.60atomic_rmw.60.20lowering.20on.20.60x86.60.html">wasmtime / PR #9495 Improve `atomic_rmw` lowering on `x86`</a></h3>

<hr>

<base href="https://bytecodealliance.zulipchat.com">

<head><link href="https://bytecodealliance.github.io/zulip-archive/style.css" rel="stylesheet"></head>

<a name="478322727"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%239495%20Improve%20%60atomic_rmw%60%20lowering%20on%20%60x86%60/near/478322727" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.239495.20Improve.20.60atomic_rmw.60.20lowering.20on.20.60x86.60.html#478322727">(Oct 22 2024 at 16:17)</a>:</h4>
<p>beetrees opened <a href="https://github.com/bytecodealliance/wasmtime/pull/9495">PR #9495</a> from <code>beetrees:x64-better-atomics</code> to <code>bytecodealliance:main</code>:</p>
<blockquote>
<p><code>xchg</code> and <code>lock xadd</code> can be used in all cases for <code>Xchg</code>, <code>Add</code> and <code>Sub</code>, while various <code>lock</code>-prefixed arithmetic instructions can be used for <code>Add</code>, <code>Sub</code>, <code>And</code>, <code>Or</code> and <code>Xor</code> if the result value of <code>atomic_rmw</code> (the old value) isn't used.</p>
<p>Closes #2153</p>
</blockquote>



<a name="478322729"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%239495%20Improve%20%60atomic_rmw%60%20lowering%20on%20%60x86%60/near/478322729" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.239495.20Improve.20.60atomic_rmw.60.20lowering.20on.20.60x86.60.html#478322729">(Oct 22 2024 at 16:17)</a>:</h4>
<p><strong>beetrees</strong> requested <a href="https://github.com/abrown">abrown</a> for a review on <a href="https://github.com/bytecodealliance/wasmtime/pull/9495">PR #9495</a>.</p>



<a name="478322730"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%239495%20Improve%20%60atomic_rmw%60%20lowering%20on%20%60x86%60/near/478322730" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.239495.20Improve.20.60atomic_rmw.60.20lowering.20on.20.60x86.60.html#478322730">(Oct 22 2024 at 16:17)</a>:</h4>
<p><strong>beetrees</strong> requested <a href="https://github.com/orgs/bytecodealliance/teams/wasmtime-compiler-reviewers">wasmtime-compiler-reviewers</a> for a review on <a href="https://github.com/bytecodealliance/wasmtime/pull/9495">PR #9495</a>.</p>



<a name="478556524"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%239495%20Improve%20%60atomic_rmw%60%20lowering%20on%20%60x86%60/near/478556524" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.239495.20Improve.20.60atomic_rmw.60.20lowering.20on.20.60x86.60.html#478556524">(Oct 23 2024 at 18:16)</a>:</h4>
<p>abrown submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/9495#pullrequestreview-2389652451">PR review</a>:</p>
<blockquote>
<p>Thanks for the PR! This looks fine to me but I'm going to ask @cfallin to double-check a couple spots below.</p>
</blockquote>



<a name="478556525"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%239495%20Improve%20%60atomic_rmw%60%20lowering%20on%20%60x86%60/near/478556525" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.239495.20Improve.20.60atomic_rmw.60.20lowering.20on.20.60x86.60.html#478556525">(Oct 23 2024 at 18:16)</a>:</h4>
<p>abrown created <a href="https://github.com/bytecodealliance/wasmtime/pull/9495#discussion_r1813294128">PR review comment</a>:</p>
<blockquote>
<p>I believe this is correct but @cfallin do you want to double-check?</p>
</blockquote>



<a name="478556526"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%239495%20Improve%20%60atomic_rmw%60%20lowering%20on%20%60x86%60/near/478556526" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.239495.20Improve.20.60atomic_rmw.60.20lowering.20on.20.60x86.60.html#478556526">(Oct 23 2024 at 18:16)</a>:</h4>
<p>abrown created <a href="https://github.com/bytecodealliance/wasmtime/pull/9495#discussion_r1813304127">PR review comment</a>:</p>
<blockquote>
<p>Another note for @cfallin to check: this does in fact do what we would expect it to?</p>
</blockquote>



<a name="478560538"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%239495%20Improve%20%60atomic_rmw%60%20lowering%20on%20%60x86%60/near/478560538" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.239495.20Improve.20.60atomic_rmw.60.20lowering.20on.20.60x86.60.html#478560538">(Oct 23 2024 at 18:39)</a>:</h4>
<p>cfallin submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/9495#pullrequestreview-2389734047">PR review</a>:</p>
<blockquote>
<p>Thanks!</p>
</blockquote>



<a name="478560539"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%239495%20Improve%20%60atomic_rmw%60%20lowering%20on%20%60x86%60/near/478560539" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.239495.20Improve.20.60atomic_rmw.60.20lowering.20on.20.60x86.60.html#478560539">(Oct 23 2024 at 18:39)</a>:</h4>
<p>cfallin created <a href="https://github.com/bytecodealliance/wasmtime/pull/9495#discussion_r1813341511">PR review comment</a>:</p>
<blockquote>
<p>We try to avoid any <code>..</code> here so we don't miss new fields being added. Could we instead do <code>lock: _</code>?</p>
</blockquote>



<a name="478560540"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%239495%20Improve%20%60atomic_rmw%60%20lowering%20on%20%60x86%60/near/478560540" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.239495.20Improve.20.60atomic_rmw.60.20lowering.20on.20.60x86.60.html#478560540">(Oct 23 2024 at 18:39)</a>:</h4>
<p>cfallin created <a href="https://github.com/bytecodealliance/wasmtime/pull/9495#discussion_r1813337571">PR review comment</a>:</p>
<blockquote>
<p>Now that we don't use all <code>MachAtomicRmwOp</code> options in lowerings anymore, could we define a separate enum for x64 and translate into it at the rule-match step, so we don't have this problem of representable but invalid combinations?</p>
</blockquote>



<a name="478560541"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%239495%20Improve%20%60atomic_rmw%60%20lowering%20on%20%60x86%60/near/478560541" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.239495.20Improve.20.60atomic_rmw.60.20lowering.20on.20.60x86.60.html#478560541">(Oct 23 2024 at 18:39)</a>:</h4>
<p>cfallin created <a href="https://github.com/bytecodealliance/wasmtime/pull/9495#discussion_r1813341721">PR review comment</a>:</p>
<blockquote>
<p>Likewise here</p>
</blockquote>



<a name="478560542"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%239495%20Improve%20%60atomic_rmw%60%20lowering%20on%20%60x86%60/near/478560542" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.239495.20Improve.20.60atomic_rmw.60.20lowering.20on.20.60x86.60.html#478560542">(Oct 23 2024 at 18:39)</a>:</h4>
<p>cfallin created <a href="https://github.com/bytecodealliance/wasmtime/pull/9495#discussion_r1813339179">PR review comment</a>:</p>
<blockquote>
<p>Looks right to me!</p>
</blockquote>



<a name="478560543"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%239495%20Improve%20%60atomic_rmw%60%20lowering%20on%20%60x86%60/near/478560543" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.239495.20Improve.20.60atomic_rmw.60.20lowering.20on.20.60x86.60.html#478560543">(Oct 23 2024 at 18:39)</a>:</h4>
<p>cfallin created <a href="https://github.com/bytecodealliance/wasmtime/pull/9495#discussion_r1813341830">PR review comment</a>:</p>
<blockquote>
<p>Likewise here</p>
</blockquote>



<a name="478560544"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%239495%20Improve%20%60atomic_rmw%60%20lowering%20on%20%60x86%60/near/478560544" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.239495.20Improve.20.60atomic_rmw.60.20lowering.20on.20.60x86.60.html#478560544">(Oct 23 2024 at 18:39)</a>:</h4>
<p>cfallin created <a href="https://github.com/bytecodealliance/wasmtime/pull/9495#discussion_r1813340848">PR review comment</a>:</p>
<blockquote>
<p>Yes, I think so! We're doing a backward pass so we know for sure if a value is used or not, and this helper looks like it was added to be used for a similar purpose in a few other backends; perfectly valid to use it here to know if we can avoid producing the result.</p>
</blockquote>



<a name="478572831"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%239495%20Improve%20%60atomic_rmw%60%20lowering%20on%20%60x86%60/near/478572831" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.239495.20Improve.20.60atomic_rmw.60.20lowering.20on.20.60x86.60.html#478572831">(Oct 23 2024 at 19:55)</a>:</h4>
<p>beetrees updated <a href="https://github.com/bytecodealliance/wasmtime/pull/9495">PR #9495</a>.</p>



<a name="478573432"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%239495%20Improve%20%60atomic_rmw%60%20lowering%20on%20%60x86%60/near/478573432" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.239495.20Improve.20.60atomic_rmw.60.20lowering.20on.20.60x86.60.html#478573432">(Oct 23 2024 at 19:59)</a>:</h4>
<p>beetrees submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/9495#pullrequestreview-2390174217">PR review</a>.</p>



<a name="478573434"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%239495%20Improve%20%60atomic_rmw%60%20lowering%20on%20%60x86%60/near/478573434" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.239495.20Improve.20.60atomic_rmw.60.20lowering.20on.20.60x86.60.html#478573434">(Oct 23 2024 at 19:59)</a>:</h4>
<p>beetrees created <a href="https://github.com/bytecodealliance/wasmtime/pull/9495#discussion_r1813452665">PR review comment</a>:</p>
<blockquote>
<p>I've replaced <code>MachAtomicRmwOp</code> with the more specific <code>AtomicRmwSeqOp</code> and <code>Atomic128RmwSeqOp</code>. I then deleted <code>MachAtomicRmwOp</code> as it was now unused and essentially a duplicate of <code>AtomicRmwOp</code>.</p>
</blockquote>



<a name="478591230"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%239495%20Improve%20%60atomic_rmw%60%20lowering%20on%20%60x86%60/near/478591230" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.239495.20Improve.20.60atomic_rmw.60.20lowering.20on.20.60x86.60.html#478591230">(Oct 23 2024 at 22:07)</a>:</h4>
<p>abrown merged <a href="https://github.com/bytecodealliance/wasmtime/pull/9495">PR #9495</a>.</p>



<hr><p>Last updated: Jan 20 2025 at 06:04 UTC</p>
</html>