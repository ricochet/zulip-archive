<html>
<head><meta charset="utf-8"><title>wasmtime / issue #6074 wasmtime report import `streams` h... · git-wasmtime · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/index.html">git-wasmtime</a></h2>
<h3>Topic: <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.236074.20wasmtime.20report.20import.20.60streams.60.20h.2E.2E.2E.html">wasmtime / issue #6074 wasmtime report import `streams` h...</a></h3>

<hr>

<base href="https://bytecodealliance.zulipchat.com">

<head><link href="https://bytecodealliance.github.io/zulip-archive/style.css" rel="stylesheet"></head>

<a name="343318772"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%236074%20wasmtime%20report%20import%20%60streams%60%20h.../near/343318772" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.236074.20wasmtime.20report.20import.20.60streams.60.20h.2E.2E.2E.html#343318772">(Mar 21 2023 at 09:42)</a>:</h4>
<p>Sherlock-Holo opened <a href="https://github.com/bytecodealliance/wasmtime/issues/6074">issue #6074</a>:</p>
<blockquote>
<p>Thanks for filing a bug report! Please fill out the TODOs below.</p>
<p><strong>Note: if you want to report a security issue, please read our <a href="https://bytecodealliance.org/security">security policy</a>!</strong></p>
<h3>Test Case</h3>
<h4>wit file</h4>
<div class="codehilite" data-code-language="wit"><pre><span></span><code>default world http {
    import get: func(url: string) -&gt; result&lt;string, string&gt;
    export run: func(url: string) -&gt; result&lt;string, string&gt;
}
</code></pre></div>
<p>rust wasm code</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="n">wit_bindgen</span>::<span class="n">generate</span><span class="o">!</span><span class="p">(</span><span class="s">"world"</span><span class="p">);</span>

<span class="k">struct</span> <span class="nc">Runner</span><span class="p">;</span>

<span class="k">impl</span><span class="w"> </span><span class="n">Http</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">Runner</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">fn</span> <span class="nf">run</span><span class="p">(</span><span class="n">url</span>: <span class="nb">String</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nb">Result</span><span class="o">&lt;</span><span class="nb">String</span><span class="p">,</span><span class="w"> </span><span class="nb">String</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="n">resp</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">get</span><span class="p">(</span><span class="o">&amp;</span><span class="n">url</span><span class="p">)</span><span class="o">?</span><span class="p">;</span>

<span class="w">        </span><span class="nb">Ok</span><span class="p">(</span><span class="fm">format!</span><span class="p">(</span><span class="s">"wasm response: {resp}"</span><span class="p">))</span>
<span class="w">        </span><span class="c1">// Ok("wasm response: ".to_string() + &amp;resp)</span>
<span class="w">        </span><span class="c1">// Ok(resp)</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>

<span class="n">export_http</span><span class="o">!</span><span class="p">(</span><span class="n">Runner</span><span class="p">);</span>
</code></pre></div>
<h4>rust normal codes</h4>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="k">use</span><span class="w"> </span><span class="n">async_trait</span>::<span class="n">async_trait</span><span class="p">;</span>
<span class="k">use</span><span class="w"> </span><span class="n">wasmtime</span>::<span class="n">component</span>::<span class="p">{</span><span class="n">bindgen</span><span class="p">,</span><span class="w"> </span><span class="n">Component</span><span class="p">,</span><span class="w"> </span><span class="n">Linker</span><span class="p">};</span>
<span class="k">use</span><span class="w"> </span><span class="n">wasmtime</span>::<span class="p">{</span><span class="n">Config</span><span class="p">,</span><span class="w"> </span><span class="n">Engine</span><span class="p">,</span><span class="w"> </span><span class="n">Store</span><span class="p">};</span>

<span class="n">bindgen</span><span class="o">!</span><span class="p">({</span>
<span class="w">    </span><span class="n">path</span>: <span class="s">"../wit"</span><span class="p">,</span>
<span class="w">    </span><span class="k">async</span>: <span class="nc">true</span><span class="p">,</span>
<span class="p">});</span>

<span class="k">struct</span> <span class="nc">Function</span><span class="p">;</span>

<span class="k">impl</span><span class="w"> </span><span class="n">Function</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">async</span><span class="w"> </span><span class="k">fn</span> <span class="nf">inner_get</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="bp">self</span><span class="p">,</span><span class="w"> </span><span class="n">url</span>: <span class="kp">&amp;</span><span class="kt">str</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nb">Result</span><span class="o">&lt;</span><span class="nb">String</span><span class="p">,</span><span class="w"> </span><span class="nb">String</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="n">resp</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">reqwest</span>::<span class="n">get</span><span class="p">(</span><span class="n">url</span><span class="p">).</span><span class="k">await</span><span class="p">.</span><span class="n">map_err</span><span class="p">(</span><span class="o">|</span><span class="n">err</span><span class="o">|</span><span class="w"> </span><span class="n">err</span><span class="p">.</span><span class="n">to_string</span><span class="p">())</span><span class="o">?</span><span class="p">;</span>

<span class="w">        </span><span class="nb">Ok</span><span class="p">(</span><span class="n">resp</span><span class="p">.</span><span class="n">status</span><span class="p">().</span><span class="n">to_string</span><span class="p">())</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>

<span class="cp">#[async_trait]</span>
<span class="k">impl</span><span class="w"> </span><span class="n">HttpImports</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">Function</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">async</span><span class="w"> </span><span class="k">fn</span> <span class="nf">get</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="bp">self</span><span class="p">,</span><span class="w"> </span><span class="n">url</span>: <span class="nb">String</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nc">wasmtime</span>::<span class="nb">Result</span><span class="o">&lt;</span><span class="nb">Result</span><span class="o">&lt;</span><span class="nb">String</span><span class="p">,</span><span class="w"> </span><span class="nb">String</span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nb">Ok</span><span class="p">(</span><span class="bp">self</span><span class="p">.</span><span class="n">inner_get</span><span class="p">(</span><span class="o">&amp;</span><span class="n">url</span><span class="p">).</span><span class="k">await</span><span class="p">)</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>

<span class="cp">#[tokio::main(flavor = </span><span class="s">"current_thread"</span><span class="cp">)]</span>
<span class="k">async</span><span class="w"> </span><span class="k">fn</span> <span class="nf">main</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">config</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Config</span>::<span class="n">new</span><span class="p">();</span>
<span class="w">    </span><span class="n">config</span><span class="p">.</span><span class="n">wasm_component_model</span><span class="p">(</span><span class="kc">true</span><span class="p">).</span><span class="n">async_support</span><span class="p">(</span><span class="kc">true</span><span class="p">);</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">engine</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Engine</span>::<span class="n">new</span><span class="p">(</span><span class="o">&amp;</span><span class="n">config</span><span class="p">).</span><span class="n">unwrap</span><span class="p">();</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">component</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Component</span>::<span class="n">from_file</span><span class="p">(</span><span class="o">&amp;</span><span class="n">engine</span><span class="p">,</span><span class="w"> </span><span class="s">"../target/component.wasm"</span><span class="p">).</span><span class="n">unwrap</span><span class="p">();</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">linker</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Linker</span>::<span class="n">new</span><span class="p">(</span><span class="o">&amp;</span><span class="n">engine</span><span class="p">);</span>
<span class="w">    </span><span class="n">Http</span>::<span class="n">add_to_linker</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="n">linker</span><span class="p">,</span><span class="w"> </span><span class="o">|</span><span class="n">state</span>: <span class="kp">&amp;</span><span class="nc">mut</span><span class="w"> </span><span class="n">Function</span><span class="o">|</span><span class="w"> </span><span class="n">state</span><span class="p">).</span><span class="n">unwrap</span><span class="p">();</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">store</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Store</span>::<span class="n">new</span><span class="p">(</span><span class="o">&amp;</span><span class="n">engine</span><span class="p">,</span><span class="w"> </span><span class="n">Function</span><span class="p">);</span>

<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="p">(</span><span class="n">http</span><span class="p">,</span><span class="w"> </span><span class="n">_instance</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Http</span>::<span class="n">instantiate_async</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="n">store</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">component</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">linker</span><span class="p">)</span>
<span class="w">        </span><span class="p">.</span><span class="k">await</span>
<span class="w">        </span><span class="p">.</span><span class="n">unwrap</span><span class="p">();</span>

<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">result</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">http</span>
<span class="w">        </span><span class="p">.</span><span class="n">call_run</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="n">store</span><span class="p">,</span><span class="w"> </span><span class="s">"http://www.example.com"</span><span class="p">)</span>
<span class="w">        </span><span class="p">.</span><span class="k">await</span>
<span class="w">        </span><span class="p">.</span><span class="n">unwrap</span><span class="p">();</span>
<span class="w">    </span><span class="fm">println!</span><span class="p">(</span><span class="s">"{:?}"</span><span class="p">,</span><span class="w"> </span><span class="n">result</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div>
<h3>Steps to Reproduce</h3>
<p>I build the rust wasm codes with <code>cargo b -r</code>, the target is set on .cargo/config.toml</p>
<div class="codehilite" data-code-language="TOML"><pre><span></span><code><span class="k">[build]</span>
<span class="n">target</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">"wasm32-wasi"</span>
</code></pre></div>
<p>then I download the <a href="https://github.com/bytecodealliance/preview2-prototyping/releases/download/latest/wasi_snapshot_preview1.reactor.wasm">https://github.com/bytecodealliance/preview2-prototyping/releases/download/latest/wasi_snapshot_preview1.reactor.wasm</a> and rename it to <code>wasi_snapshot_preview1.wasm</code></p>
<p>then run <code>wasm-tools component new ../target/wasm32-wasi/release/wasm.wasm -o ../target/component.wasm --adapt ../wasi_snapshot_preview1.wasm</code> to compile the wasm file, no error</p>
<p>then I run the normal codes, it report error</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="n">thread</span><span class="w"> </span><span class="o">'</span><span class="na">main</span><span class="o">'</span><span class="w"> </span><span class="n">panicked</span><span class="w"> </span><span class="n">at</span><span class="w"> </span><span class="o">'</span><span class="na">called</span><span class="w"> </span><span class="err">`</span><span class="nb">Result</span>::<span class="n">unwrap</span><span class="p">()</span><span class="err">`</span><span class="w"> </span><span class="n">on</span><span class="w"> </span><span class="n">an</span><span class="w"> </span><span class="err">`</span><span class="nb">Err</span><span class="err">`</span><span class="w"> </span><span class="n">value</span>: <span class="nc">import</span><span class="w"> </span><span class="err">`</span><span class="n">streams</span><span class="err">`</span><span class="w"> </span><span class="n">has</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">wrong</span><span class="w"> </span><span class="k">type</span>

<span class="nc">Caused</span><span class="w"> </span><span class="n">by</span>:
    <span class="mi">0</span>: <span class="nc">instance</span><span class="w"> </span><span class="n">export</span><span class="w"> </span><span class="err">`</span><span class="nb">drop</span><span class="o">-</span><span class="n">input</span><span class="o">-</span><span class="n">stream</span><span class="err">`</span><span class="w"> </span><span class="n">has</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">wrong</span><span class="w"> </span><span class="k">type</span>
    <span class="mi">1</span>: <span class="nc">expected</span><span class="w"> </span><span class="n">func</span><span class="w"> </span><span class="n">found</span><span class="w"> </span><span class="n">nothing</span><span class="o">'</span><span class="p">,</span><span class="w"> </span><span class="n">runtime</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">main</span><span class="p">.</span><span class="n">rs</span>:<span class="mi">39</span>:<span class="mi">10</span>
<span class="n">note</span>: <span class="nc">run</span><span class="w"> </span><span class="n">with</span><span class="w"> </span><span class="err">`</span><span class="n">RUST_BACKTRACE</span><span class="o">=</span><span class="mi">1</span><span class="err">`</span><span class="w"> </span><span class="n">environment</span><span class="w"> </span><span class="n">variable</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">display</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="n">backtrace</span>
</code></pre></div>
<p>I run <code>wasm-tools component wit ../target/component.wasm</code> to dump the wit file, it shows</p>
<div class="codehilite" data-code-language="wit"><pre><span></span><code>interface streams {
  type input-stream = u32

  type output-stream = u32

  record stream-error {
  }

  drop-input-stream: func(this: input-stream)

  write: func(this: output-stream, buf: list&lt;u8&gt;) -&gt; result&lt;u64, stream-error&gt;

  drop-output-stream: func(this: output-stream)
}

interface filesystem {
  use self.streams.{output-stream}

  type descriptor = u32

  type filesize = u64

  write-via-stream: func(this: descriptor, offset: filesize) -&gt; output-stream

  append-via-stream: func(this: descriptor) -&gt; output-stream

  drop-descriptor: func(this: descriptor)
}

interface environment {
  get-environment: func() -&gt; list&lt;tuple&lt;string, string&gt;&gt;
}

interface exit {
  exit: func(status: result)
}

interface stderr {
  print: func(message: string)
}

default world component {
  import streams: self.streams
  import filesystem: self.filesystem
  import environment: self.environment
  import exit: self.exit
  import stderr: self.stderr
  import get: func(url: string) -&gt; result&lt;string, string&gt;
  export run: func(url: string) -&gt; result&lt;string, string&gt;
}
</code></pre></div>
<p>a lot of things, but if I remove the <code>Ok(format!("wasm response: {resp}"))</code> in the rust wasm codes, replace with <code>Ok(resp)</code>, dump again and it will shows</p>
<div class="codehilite" data-code-language="wit"><pre><span></span><code>default world component {
  import get: func(url: string) -&gt; result&lt;string, string&gt;
  export run: func(url: string) -&gt; result&lt;string, string&gt;
}
</code></pre></div>
<p>it looks like normal</p>
<h3>Expected Results</h3>
<p>works well</p>
<h3>Versions and Environment</h3>
<p>Wasmtime version or commit: wasmtime crate 7.0.0</p>
<p>Operating system: Archlinux</p>
<p>Architecture: x64<br>
</p>
</blockquote>



<a name="343318773"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%236074%20wasmtime%20report%20import%20%60streams%60%20h.../near/343318773" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.236074.20wasmtime.20report.20import.20.60streams.60.20h.2E.2E.2E.html#343318773">(Mar 21 2023 at 09:42)</a>:</h4>
<p>Sherlock-Holo labeled <a href="https://github.com/bytecodealliance/wasmtime/issues/6074">issue #6074</a>:</p>
<blockquote>
<p>Thanks for filing a bug report! Please fill out the TODOs below.</p>
<p><strong>Note: if you want to report a security issue, please read our <a href="https://bytecodealliance.org/security">security policy</a>!</strong></p>
<h3>Test Case</h3>
<h4>wit file</h4>
<div class="codehilite" data-code-language="wit"><pre><span></span><code>default world http {
    import get: func(url: string) -&gt; result&lt;string, string&gt;
    export run: func(url: string) -&gt; result&lt;string, string&gt;
}
</code></pre></div>
<p>rust wasm code</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="n">wit_bindgen</span>::<span class="n">generate</span><span class="o">!</span><span class="p">(</span><span class="s">"world"</span><span class="p">);</span>

<span class="k">struct</span> <span class="nc">Runner</span><span class="p">;</span>

<span class="k">impl</span><span class="w"> </span><span class="n">Http</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">Runner</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">fn</span> <span class="nf">run</span><span class="p">(</span><span class="n">url</span>: <span class="nb">String</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nb">Result</span><span class="o">&lt;</span><span class="nb">String</span><span class="p">,</span><span class="w"> </span><span class="nb">String</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="n">resp</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">get</span><span class="p">(</span><span class="o">&amp;</span><span class="n">url</span><span class="p">)</span><span class="o">?</span><span class="p">;</span>

<span class="w">        </span><span class="nb">Ok</span><span class="p">(</span><span class="fm">format!</span><span class="p">(</span><span class="s">"wasm response: {resp}"</span><span class="p">))</span>
<span class="w">        </span><span class="c1">// Ok("wasm response: ".to_string() + &amp;resp)</span>
<span class="w">        </span><span class="c1">// Ok(resp)</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>

<span class="n">export_http</span><span class="o">!</span><span class="p">(</span><span class="n">Runner</span><span class="p">);</span>
</code></pre></div>
<h4>rust normal codes</h4>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="k">use</span><span class="w"> </span><span class="n">async_trait</span>::<span class="n">async_trait</span><span class="p">;</span>
<span class="k">use</span><span class="w"> </span><span class="n">wasmtime</span>::<span class="n">component</span>::<span class="p">{</span><span class="n">bindgen</span><span class="p">,</span><span class="w"> </span><span class="n">Component</span><span class="p">,</span><span class="w"> </span><span class="n">Linker</span><span class="p">};</span>
<span class="k">use</span><span class="w"> </span><span class="n">wasmtime</span>::<span class="p">{</span><span class="n">Config</span><span class="p">,</span><span class="w"> </span><span class="n">Engine</span><span class="p">,</span><span class="w"> </span><span class="n">Store</span><span class="p">};</span>

<span class="n">bindgen</span><span class="o">!</span><span class="p">({</span>
<span class="w">    </span><span class="n">path</span>: <span class="s">"../wit"</span><span class="p">,</span>
<span class="w">    </span><span class="k">async</span>: <span class="nc">true</span><span class="p">,</span>
<span class="p">});</span>

<span class="k">struct</span> <span class="nc">Function</span><span class="p">;</span>

<span class="k">impl</span><span class="w"> </span><span class="n">Function</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">async</span><span class="w"> </span><span class="k">fn</span> <span class="nf">inner_get</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="bp">self</span><span class="p">,</span><span class="w"> </span><span class="n">url</span>: <span class="kp">&amp;</span><span class="kt">str</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nb">Result</span><span class="o">&lt;</span><span class="nb">String</span><span class="p">,</span><span class="w"> </span><span class="nb">String</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="n">resp</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">reqwest</span>::<span class="n">get</span><span class="p">(</span><span class="n">url</span><span class="p">).</span><span class="k">await</span><span class="p">.</span><span class="n">map_err</span><span class="p">(</span><span class="o">|</span><span class="n">err</span><span class="o">|</span><span class="w"> </span><span class="n">err</span><span class="p">.</span><span class="n">to_string</span><span class="p">())</span><span class="o">?</span><span class="p">;</span>

<span class="w">        </span><span class="nb">Ok</span><span class="p">(</span><span class="n">resp</span><span class="p">.</span><span class="n">status</span><span class="p">().</span><span class="n">to_string</span><span class="p">())</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>

<span class="cp">#[async_trait]</span>
<span class="k">impl</span><span class="w"> </span><span class="n">HttpImports</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">Function</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">async</span><span class="w"> </span><span class="k">fn</span> <span class="nf">get</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="bp">self</span><span class="p">,</span><span class="w"> </span><span class="n">url</span>: <span class="nb">String</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nc">wasmtime</span>::<span class="nb">Result</span><span class="o">&lt;</span><span class="nb">Result</span><span class="o">&lt;</span><span class="nb">String</span><span class="p">,</span><span class="w"> </span><span class="nb">String</span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nb">Ok</span><span class="p">(</span><span class="bp">self</span><span class="p">.</span><span class="n">inner_get</span><span class="p">(</span><span class="o">&amp;</span><span class="n">url</span><span class="p">).</span><span class="k">await</span><span class="p">)</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>

<span class="cp">#[tokio::main(flavor = </span><span class="s">"current_thread"</span><span class="cp">)]</span>
<span class="k">async</span><span class="w"> </span><span class="k">fn</span> <span class="nf">main</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">config</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Config</span>::<span class="n">new</span><span class="p">();</span>
<span class="w">    </span><span class="n">config</span><span class="p">.</span><span class="n">wasm_component_model</span><span class="p">(</span><span class="kc">true</span><span class="p">).</span><span class="n">async_support</span><span class="p">(</span><span class="kc">true</span><span class="p">);</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">engine</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Engine</span>::<span class="n">new</span><span class="p">(</span><span class="o">&amp;</span><span class="n">config</span><span class="p">).</span><span class="n">unwrap</span><span class="p">();</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">component</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Component</span>::<span class="n">from_file</span><span class="p">(</span><span class="o">&amp;</span><span class="n">engine</span><span class="p">,</span><span class="w"> </span><span class="s">"../target/component.wasm"</span><span class="p">).</span><span class="n">unwrap</span><span class="p">();</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">linker</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Linker</span>::<span class="n">new</span><span class="p">(</span><span class="o">&amp;</span><span class="n">engine</span><span class="p">);</span>
<span class="w">    </span><span class="n">Http</span>::<span class="n">add_to_linker</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="n">linker</span><span class="p">,</span><span class="w"> </span><span class="o">|</span><span class="n">state</span>: <span class="kp">&amp;</span><span class="nc">mut</span><span class="w"> </span><span class="n">Function</span><span class="o">|</span><span class="w"> </span><span class="n">state</span><span class="p">).</span><span class="n">unwrap</span><span class="p">();</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">store</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Store</span>::<span class="n">new</span><span class="p">(</span><span class="o">&amp;</span><span class="n">engine</span><span class="p">,</span><span class="w"> </span><span class="n">Function</span><span class="p">);</span>

<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="p">(</span><span class="n">http</span><span class="p">,</span><span class="w"> </span><span class="n">_instance</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Http</span>::<span class="n">instantiate_async</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="n">store</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">component</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">linker</span><span class="p">)</span>
<span class="w">        </span><span class="p">.</span><span class="k">await</span>
<span class="w">        </span><span class="p">.</span><span class="n">unwrap</span><span class="p">();</span>

<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">result</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">http</span>
<span class="w">        </span><span class="p">.</span><span class="n">call_run</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="n">store</span><span class="p">,</span><span class="w"> </span><span class="s">"http://www.example.com"</span><span class="p">)</span>
<span class="w">        </span><span class="p">.</span><span class="k">await</span>
<span class="w">        </span><span class="p">.</span><span class="n">unwrap</span><span class="p">();</span>
<span class="w">    </span><span class="fm">println!</span><span class="p">(</span><span class="s">"{:?}"</span><span class="p">,</span><span class="w"> </span><span class="n">result</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div>
<h3>Steps to Reproduce</h3>
<p>I build the rust wasm codes with <code>cargo b -r</code>, the target is set on .cargo/config.toml</p>
<div class="codehilite" data-code-language="TOML"><pre><span></span><code><span class="k">[build]</span>
<span class="n">target</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">"wasm32-wasi"</span>
</code></pre></div>
<p>then I download the <a href="https://github.com/bytecodealliance/preview2-prototyping/releases/download/latest/wasi_snapshot_preview1.reactor.wasm">https://github.com/bytecodealliance/preview2-prototyping/releases/download/latest/wasi_snapshot_preview1.reactor.wasm</a> and rename it to <code>wasi_snapshot_preview1.wasm</code></p>
<p>then run <code>wasm-tools component new ../target/wasm32-wasi/release/wasm.wasm -o ../target/component.wasm --adapt ../wasi_snapshot_preview1.wasm</code> to compile the wasm file, no error</p>
<p>then I run the normal codes, it report error</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="n">thread</span><span class="w"> </span><span class="o">'</span><span class="na">main</span><span class="o">'</span><span class="w"> </span><span class="n">panicked</span><span class="w"> </span><span class="n">at</span><span class="w"> </span><span class="o">'</span><span class="na">called</span><span class="w"> </span><span class="err">`</span><span class="nb">Result</span>::<span class="n">unwrap</span><span class="p">()</span><span class="err">`</span><span class="w"> </span><span class="n">on</span><span class="w"> </span><span class="n">an</span><span class="w"> </span><span class="err">`</span><span class="nb">Err</span><span class="err">`</span><span class="w"> </span><span class="n">value</span>: <span class="nc">import</span><span class="w"> </span><span class="err">`</span><span class="n">streams</span><span class="err">`</span><span class="w"> </span><span class="n">has</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">wrong</span><span class="w"> </span><span class="k">type</span>

<span class="nc">Caused</span><span class="w"> </span><span class="n">by</span>:
    <span class="mi">0</span>: <span class="nc">instance</span><span class="w"> </span><span class="n">export</span><span class="w"> </span><span class="err">`</span><span class="nb">drop</span><span class="o">-</span><span class="n">input</span><span class="o">-</span><span class="n">stream</span><span class="err">`</span><span class="w"> </span><span class="n">has</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">wrong</span><span class="w"> </span><span class="k">type</span>
    <span class="mi">1</span>: <span class="nc">expected</span><span class="w"> </span><span class="n">func</span><span class="w"> </span><span class="n">found</span><span class="w"> </span><span class="n">nothing</span><span class="o">'</span><span class="p">,</span><span class="w"> </span><span class="n">runtime</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">main</span><span class="p">.</span><span class="n">rs</span>:<span class="mi">39</span>:<span class="mi">10</span>
<span class="n">note</span>: <span class="nc">run</span><span class="w"> </span><span class="n">with</span><span class="w"> </span><span class="err">`</span><span class="n">RUST_BACKTRACE</span><span class="o">=</span><span class="mi">1</span><span class="err">`</span><span class="w"> </span><span class="n">environment</span><span class="w"> </span><span class="n">variable</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">display</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="n">backtrace</span>
</code></pre></div>
<p>I run <code>wasm-tools component wit ../target/component.wasm</code> to dump the wit file, it shows</p>
<div class="codehilite" data-code-language="wit"><pre><span></span><code>interface streams {
  type input-stream = u32

  type output-stream = u32

  record stream-error {
  }

  drop-input-stream: func(this: input-stream)

  write: func(this: output-stream, buf: list&lt;u8&gt;) -&gt; result&lt;u64, stream-error&gt;

  drop-output-stream: func(this: output-stream)
}

interface filesystem {
  use self.streams.{output-stream}

  type descriptor = u32

  type filesize = u64

  write-via-stream: func(this: descriptor, offset: filesize) -&gt; output-stream

  append-via-stream: func(this: descriptor) -&gt; output-stream

  drop-descriptor: func(this: descriptor)
}

interface environment {
  get-environment: func() -&gt; list&lt;tuple&lt;string, string&gt;&gt;
}

interface exit {
  exit: func(status: result)
}

interface stderr {
  print: func(message: string)
}

default world component {
  import streams: self.streams
  import filesystem: self.filesystem
  import environment: self.environment
  import exit: self.exit
  import stderr: self.stderr
  import get: func(url: string) -&gt; result&lt;string, string&gt;
  export run: func(url: string) -&gt; result&lt;string, string&gt;
}
</code></pre></div>
<p>a lot of things, but if I remove the <code>Ok(format!("wasm response: {resp}"))</code> in the rust wasm codes, replace with <code>Ok(resp)</code>, dump again and it will shows</p>
<div class="codehilite" data-code-language="wit"><pre><span></span><code>default world component {
  import get: func(url: string) -&gt; result&lt;string, string&gt;
  export run: func(url: string) -&gt; result&lt;string, string&gt;
}
</code></pre></div>
<p>it looks like normal</p>
<h3>Expected Results</h3>
<p>works well</p>
<h3>Versions and Environment</h3>
<p>Wasmtime version or commit: wasmtime crate 7.0.0</p>
<p>Operating system: Archlinux</p>
<p>Architecture: x64<br>
</p>
</blockquote>



<a name="343323135"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%236074%20wasmtime%20report%20import%20%60streams%60%20h.../near/343323135" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.236074.20wasmtime.20report.20import.20.60streams.60.20h.2E.2E.2E.html#343323135">(Mar 21 2023 at 10:03)</a>:</h4>
<p>bjorn3 <a href="https://github.com/bytecodealliance/wasmtime/issues/6074#issuecomment-1477559992">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/6074">issue #6074</a>:</p>
<blockquote>
<p>I think if you use wasi_snapshot_preview1.wasm you will need to provide an implementation of wasi_snapshot_preview2 on the host side. Wasmtime doesn't have an implementation of this yet afaik.</p>
</blockquote>



<a name="343340907"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%236074%20wasmtime%20report%20import%20%60streams%60%20h.../near/343340907" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.236074.20wasmtime.20report.20import.20.60streams.60.20h.2E.2E.2E.html#343340907">(Mar 21 2023 at 11:20)</a>:</h4>
<p>Sherlock-Holo <a href="https://github.com/bytecodealliance/wasmtime/issues/6074#issuecomment-1477662356">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/6074">issue #6074</a>:</p>
<blockquote>
<p>@bjorn3 could you tell me how to add the</p>
<blockquote>
<p>implementation of wasi_snapshot_preview2</p>
</blockquote>
<p>I try to use the <code>wasmtime::Linker</code></p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">linker</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Linker</span>::<span class="n">new</span><span class="p">(</span><span class="o">&amp;</span><span class="n">engine</span><span class="p">);</span>
<span class="kd">let</span><span class="w"> </span><span class="n">wasi_ctx</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">WasiCtxBuilder</span>::<span class="n">new</span><span class="p">()</span>
<span class="w">        </span><span class="p">.</span><span class="n">inherit_stdio</span><span class="p">()</span>
<span class="w">        </span><span class="p">.</span><span class="n">inherit_args</span><span class="p">()</span>
<span class="w">        </span><span class="p">.</span><span class="n">unwrap</span><span class="p">()</span>
<span class="w">        </span><span class="p">.</span><span class="n">inherit_env</span><span class="p">()</span>
<span class="w">        </span><span class="p">.</span><span class="n">unwrap</span><span class="p">()</span>
<span class="w">        </span><span class="p">.</span><span class="n">build</span><span class="p">();</span>
<span class="n">wasmtime_wasi</span>::<span class="n">add_to_linker</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="n">linker</span><span class="p">,</span><span class="w"> </span><span class="o">|</span><span class="n">state</span>: <span class="kp">&amp;</span><span class="nc">mut</span><span class="w"> </span><span class="n">Function</span><span class="o">|</span><span class="w"> </span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="n">state</span><span class="p">.</span><span class="n">wasi_ctx</span><span class="p">).</span><span class="n">unwrap</span><span class="p">();</span>
</code></pre></div>
<p>but run still report same error</p>
</blockquote>



<a name="343354978"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%236074%20wasmtime%20report%20import%20%60streams%60%20h.../near/343354978" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.236074.20wasmtime.20report.20import.20.60streams.60.20h.2E.2E.2E.html#343354978">(Mar 21 2023 at 12:22)</a>:</h4>
<p>bjorn3 <a href="https://github.com/bytecodealliance/wasmtime/issues/6074#issuecomment-1477746289">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/6074">issue #6074</a>:</p>
<blockquote>
<p>wasmtime_wasi is an implementation of wasi_snapshot_preview1, not the wasi_snapshot_preview2 you need.</p>
</blockquote>



<a name="343355660"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%236074%20wasmtime%20report%20import%20%60streams%60%20h.../near/343355660" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.236074.20wasmtime.20report.20import.20.60streams.60.20h.2E.2E.2E.html#343355660">(Mar 21 2023 at 12:24)</a>:</h4>
<p>Sherlock-Holo <a href="https://github.com/bytecodealliance/wasmtime/issues/6074#issuecomment-1477750000">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/6074">issue #6074</a>:</p>
<blockquote>
<p>so i can't use the component model feature to write normal rust wasm codes, until wasmtime support preview2 ?</p>
</blockquote>



<a name="343356383"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%236074%20wasmtime%20report%20import%20%60streams%60%20h.../near/343356383" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.236074.20wasmtime.20report.20import.20.60streams.60.20h.2E.2E.2E.html#343356383">(Mar 21 2023 at 12:27)</a>:</h4>
<p>Sherlock-Holo <a href="https://github.com/bytecodealliance/wasmtime/issues/6074#issuecomment-1477753724">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/6074">issue #6074</a>:</p>
<blockquote>
<p>but why if i return the resp directly, ot can works on wasmtime?</p>
</blockquote>



<a name="343358083"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%236074%20wasmtime%20report%20import%20%60streams%60%20h.../near/343358083" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.236074.20wasmtime.20report.20import.20.60streams.60.20h.2E.2E.2E.html#343358083">(Mar 21 2023 at 12:34)</a>:</h4>
<p>bjorn3 <a href="https://github.com/bytecodealliance/wasmtime/issues/6074#issuecomment-1477762584">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/6074">issue #6074</a>:</p>
<blockquote>
<blockquote>
<p>so i can't use the component model feature to write normal rust wasm codes, until wasmtime support preview2 ?</p>
</blockquote>
<p>Yeah, using wasi with wasm components requires wasi preview2. I just found that <a href="https://github.com/bytecodealliance/preview2-prototyping">https://github.com/bytecodealliance/preview2-prototyping</a> has host support for wasi preview2 in the host/ directory. Be aware that it depends on a specific commit of wasmtime, so you will need to specify the exact same version of wasmtime: <a href="https://github.com/bytecodealliance/preview2-prototyping/blob/b4eb2043b165971820e60f077076c9484de283ed/host/Cargo.toml#L14">https://github.com/bytecodealliance/preview2-prototyping/blob/b4eb2043b165971820e60f077076c9484de283ed/host/Cargo.toml#L14</a></p>
<blockquote>
<p>but why if i return the resp directly, ot can works on wasmtime?</p>
</blockquote>
<p>The wasi_snapshot_preview1.wasm adapter probably got skipped due to the inner wasm module not needing any of the wasi methods when directly returning the response. Printing the response requires wasi and thus the wasi_snapshot_preview1 -&gt; wasi_snapshot_preview2 adapter and in turn means the final wasm component needs wasi_snapshot_preview2.</p>
</blockquote>



<a name="343562112"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%236074%20wasmtime%20report%20import%20%60streams%60%20h.../near/343562112" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.236074.20wasmtime.20report.20import.20.60streams.60.20h.2E.2E.2E.html#343562112">(Mar 22 2023 at 02:06)</a>:</h4>
<p>Sherlock-Holo <a href="https://github.com/bytecodealliance/wasmtime/issues/6074#issuecomment-1478822253">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/6074">issue #6074</a>:</p>
<blockquote>
<p>I change to<br>
<code>wasmtime = { git = "https://github.com/bytecodealliance/wasmtime", rev = "5ae8575296d5b524cde42ad10badf8c89945105a", features = ["component-model"] }</code><br>
but still report error</p>
<blockquote>
<p>thread 'main' panicked at 'called <code>Result::unwrap()</code> on an <code>Err</code> value: import <code>streams</code> has the wrong type</p>
<p>Caused by:<br>
    0: instance export <code>drop-input-stream</code> has the wrong type<br>
    1: expected func found nothing', runtime/src/main.rs:42:10<br>
note: run with <code>RUST_BACKTRACE=1</code> environment variable to display a backtrace</p>
</blockquote>
<p>anything I miss?</p>
</blockquote>



<a name="343573370"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%236074%20wasmtime%20report%20import%20%60streams%60%20h.../near/343573370" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.236074.20wasmtime.20report.20import.20.60streams.60.20h.2E.2E.2E.html#343573370">(Mar 22 2023 at 04:17)</a>:</h4>
<p>pchickey <a href="https://github.com/bytecodealliance/wasmtime/issues/6074#issuecomment-1478897816">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/6074">issue #6074</a>:</p>
<blockquote>
<p>are you using the preview1.wasm adapter and host crate from the same revision of preview2-prototyping? use the host crate's <code>command::add_to_linker</code> on your <code>wasmtime::component::Linker</code> in order to provide the <code>drop-import-stream</code> export func that is reported missing there</p>
</blockquote>



<a name="343591930"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%236074%20wasmtime%20report%20import%20%60streams%60%20h.../near/343591930" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.236074.20wasmtime.20report.20import.20.60streams.60.20h.2E.2E.2E.html#343591930">(Mar 22 2023 at 07:16)</a>:</h4>
<p>Sherlock-Holo <a href="https://github.com/bytecodealliance/wasmtime/issues/6074#issuecomment-1479025653">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/6074">issue #6074</a>:</p>
<blockquote>
<p>I change the Cargo.toml to</p>
<div class="codehilite" data-code-language="TOML"><pre><span></span><code><span class="k">[package]</span>
<span class="n">name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">"runtime"</span>
<span class="n">version</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">"0.1.0"</span>
<span class="n">edition</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">"2021"</span>

<span class="c1"># See more keys and their definitions at https://doc.rust-lang.org/cargo/reference/manifest.html</span>

<span class="k">[dependencies]</span>
<span class="n">clap</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">version</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">"4"</span><span class="p">,</span><span class="w"> </span><span class="n">features</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span><span class="s">"derive"</span><span class="p">]</span><span class="w"> </span><span class="p">}</span>
<span class="n">tokio</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">version</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">"1"</span><span class="p">,</span><span class="w"> </span><span class="n">features</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span><span class="s">"rt"</span><span class="p">,</span><span class="w"> </span><span class="s">"macros"</span><span class="p">,</span><span class="w"> </span><span class="s">"time"</span><span class="p">]</span><span class="w"> </span><span class="p">}</span>
<span class="n">reqwest</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">"0.11"</span>
<span class="n">wasmtime</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">version</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">"7"</span><span class="p">,</span><span class="w"> </span><span class="n">features</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span><span class="s">"component-model"</span><span class="p">]</span><span class="w"> </span><span class="p">}</span>
<span class="c1">#wasmtime = { git = "https://github.com/bytecodealliance/wasmtime", rev = "5ae8575296d5b524cde42ad10badf8c89945105a", features = ["component-model"] }</span>
<span class="c1">#wasmtime = { git = "https://github.com/bytecodealliance/wasmtime", branch = "main", features = ["component-model"] }</span>
<span class="n">host</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">git</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">"https://github.com/bytecodealliance/preview2-prototyping"</span><span class="p">,</span><span class="w"> </span><span class="n">branch</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">"main"</span><span class="w"> </span><span class="p">}</span>
<span class="n">wasi-cap-std-sync</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">git</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">"https://github.com/bytecodealliance/preview2-prototyping"</span><span class="p">,</span><span class="w"> </span><span class="n">branch</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">"main"</span><span class="w"> </span><span class="p">}</span>
<span class="n">async-trait</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">"0.1"</span>
</code></pre></div>
<p>and add <code> command::add_to_linker(&amp;mut linker, |state: &amp;mut Function| &amp;mut state.wasi_ctx).unwrap();</code>, it works!</p>
<p>thanks for your help~</p>
</blockquote>



<a name="343601271"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%236074%20wasmtime%20report%20import%20%60streams%60%20h.../near/343601271" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.236074.20wasmtime.20report.20import.20.60streams.60.20h.2E.2E.2E.html#343601271">(Mar 22 2023 at 08:12)</a>:</h4>
<p>Sherlock-Holo closed <a href="https://github.com/bytecodealliance/wasmtime/issues/6074">issue #6074</a>:</p>
<blockquote>
<p>Thanks for filing a bug report! Please fill out the TODOs below.</p>
<p><strong>Note: if you want to report a security issue, please read our <a href="https://bytecodealliance.org/security">security policy</a>!</strong></p>
<h3>Test Case</h3>
<h4>wit file</h4>
<div class="codehilite" data-code-language="wit"><pre><span></span><code>default world http {
    import get: func(url: string) -&gt; result&lt;string, string&gt;
    export run: func(url: string) -&gt; result&lt;string, string&gt;
}
</code></pre></div>
<p>rust wasm code</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="n">wit_bindgen</span>::<span class="n">generate</span><span class="o">!</span><span class="p">(</span><span class="s">"world"</span><span class="p">);</span>

<span class="k">struct</span> <span class="nc">Runner</span><span class="p">;</span>

<span class="k">impl</span><span class="w"> </span><span class="n">Http</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">Runner</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">fn</span> <span class="nf">run</span><span class="p">(</span><span class="n">url</span>: <span class="nb">String</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nb">Result</span><span class="o">&lt;</span><span class="nb">String</span><span class="p">,</span><span class="w"> </span><span class="nb">String</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="n">resp</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">get</span><span class="p">(</span><span class="o">&amp;</span><span class="n">url</span><span class="p">)</span><span class="o">?</span><span class="p">;</span>

<span class="w">        </span><span class="nb">Ok</span><span class="p">(</span><span class="fm">format!</span><span class="p">(</span><span class="s">"wasm response: {resp}"</span><span class="p">))</span>
<span class="w">        </span><span class="c1">// Ok("wasm response: ".to_string() + &amp;resp)</span>
<span class="w">        </span><span class="c1">// Ok(resp)</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>

<span class="n">export_http</span><span class="o">!</span><span class="p">(</span><span class="n">Runner</span><span class="p">);</span>
</code></pre></div>
<h4>rust normal codes</h4>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="k">use</span><span class="w"> </span><span class="n">async_trait</span>::<span class="n">async_trait</span><span class="p">;</span>
<span class="k">use</span><span class="w"> </span><span class="n">wasmtime</span>::<span class="n">component</span>::<span class="p">{</span><span class="n">bindgen</span><span class="p">,</span><span class="w"> </span><span class="n">Component</span><span class="p">,</span><span class="w"> </span><span class="n">Linker</span><span class="p">};</span>
<span class="k">use</span><span class="w"> </span><span class="n">wasmtime</span>::<span class="p">{</span><span class="n">Config</span><span class="p">,</span><span class="w"> </span><span class="n">Engine</span><span class="p">,</span><span class="w"> </span><span class="n">Store</span><span class="p">};</span>

<span class="n">bindgen</span><span class="o">!</span><span class="p">({</span>
<span class="w">    </span><span class="n">path</span>: <span class="s">"../wit"</span><span class="p">,</span>
<span class="w">    </span><span class="k">async</span>: <span class="nc">true</span><span class="p">,</span>
<span class="p">});</span>

<span class="k">struct</span> <span class="nc">Function</span><span class="p">;</span>

<span class="k">impl</span><span class="w"> </span><span class="n">Function</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">async</span><span class="w"> </span><span class="k">fn</span> <span class="nf">inner_get</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="bp">self</span><span class="p">,</span><span class="w"> </span><span class="n">url</span>: <span class="kp">&amp;</span><span class="kt">str</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nb">Result</span><span class="o">&lt;</span><span class="nb">String</span><span class="p">,</span><span class="w"> </span><span class="nb">String</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="n">resp</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">reqwest</span>::<span class="n">get</span><span class="p">(</span><span class="n">url</span><span class="p">).</span><span class="k">await</span><span class="p">.</span><span class="n">map_err</span><span class="p">(</span><span class="o">|</span><span class="n">err</span><span class="o">|</span><span class="w"> </span><span class="n">err</span><span class="p">.</span><span class="n">to_string</span><span class="p">())</span><span class="o">?</span><span class="p">;</span>

<span class="w">        </span><span class="nb">Ok</span><span class="p">(</span><span class="n">resp</span><span class="p">.</span><span class="n">status</span><span class="p">().</span><span class="n">to_string</span><span class="p">())</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>

<span class="cp">#[async_trait]</span>
<span class="k">impl</span><span class="w"> </span><span class="n">HttpImports</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">Function</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">async</span><span class="w"> </span><span class="k">fn</span> <span class="nf">get</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="bp">self</span><span class="p">,</span><span class="w"> </span><span class="n">url</span>: <span class="nb">String</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nc">wasmtime</span>::<span class="nb">Result</span><span class="o">&lt;</span><span class="nb">Result</span><span class="o">&lt;</span><span class="nb">String</span><span class="p">,</span><span class="w"> </span><span class="nb">String</span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nb">Ok</span><span class="p">(</span><span class="bp">self</span><span class="p">.</span><span class="n">inner_get</span><span class="p">(</span><span class="o">&amp;</span><span class="n">url</span><span class="p">).</span><span class="k">await</span><span class="p">)</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>

<span class="cp">#[tokio::main(flavor = </span><span class="s">"current_thread"</span><span class="cp">)]</span>
<span class="k">async</span><span class="w"> </span><span class="k">fn</span> <span class="nf">main</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">config</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Config</span>::<span class="n">new</span><span class="p">();</span>
<span class="w">    </span><span class="n">config</span><span class="p">.</span><span class="n">wasm_component_model</span><span class="p">(</span><span class="kc">true</span><span class="p">).</span><span class="n">async_support</span><span class="p">(</span><span class="kc">true</span><span class="p">);</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">engine</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Engine</span>::<span class="n">new</span><span class="p">(</span><span class="o">&amp;</span><span class="n">config</span><span class="p">).</span><span class="n">unwrap</span><span class="p">();</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">component</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Component</span>::<span class="n">from_file</span><span class="p">(</span><span class="o">&amp;</span><span class="n">engine</span><span class="p">,</span><span class="w"> </span><span class="s">"../target/component.wasm"</span><span class="p">).</span><span class="n">unwrap</span><span class="p">();</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">linker</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Linker</span>::<span class="n">new</span><span class="p">(</span><span class="o">&amp;</span><span class="n">engine</span><span class="p">);</span>
<span class="w">    </span><span class="n">Http</span>::<span class="n">add_to_linker</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="n">linker</span><span class="p">,</span><span class="w"> </span><span class="o">|</span><span class="n">state</span>: <span class="kp">&amp;</span><span class="nc">mut</span><span class="w"> </span><span class="n">Function</span><span class="o">|</span><span class="w"> </span><span class="n">state</span><span class="p">).</span><span class="n">unwrap</span><span class="p">();</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">store</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Store</span>::<span class="n">new</span><span class="p">(</span><span class="o">&amp;</span><span class="n">engine</span><span class="p">,</span><span class="w"> </span><span class="n">Function</span><span class="p">);</span>

<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="p">(</span><span class="n">http</span><span class="p">,</span><span class="w"> </span><span class="n">_instance</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Http</span>::<span class="n">instantiate_async</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="n">store</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">component</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">linker</span><span class="p">)</span>
<span class="w">        </span><span class="p">.</span><span class="k">await</span>
<span class="w">        </span><span class="p">.</span><span class="n">unwrap</span><span class="p">();</span>

<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">result</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">http</span>
<span class="w">        </span><span class="p">.</span><span class="n">call_run</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="n">store</span><span class="p">,</span><span class="w"> </span><span class="s">"http://www.example.com"</span><span class="p">)</span>
<span class="w">        </span><span class="p">.</span><span class="k">await</span>
<span class="w">        </span><span class="p">.</span><span class="n">unwrap</span><span class="p">();</span>
<span class="w">    </span><span class="fm">println!</span><span class="p">(</span><span class="s">"{:?}"</span><span class="p">,</span><span class="w"> </span><span class="n">result</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div>
<h3>Steps to Reproduce</h3>
<p>I build the rust wasm codes with <code>cargo b -r</code>, the target is set on .cargo/config.toml</p>
<div class="codehilite" data-code-language="TOML"><pre><span></span><code><span class="k">[build]</span>
<span class="n">target</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">"wasm32-wasi"</span>
</code></pre></div>
<p>then I download the <a href="https://github.com/bytecodealliance/preview2-prototyping/releases/download/latest/wasi_snapshot_preview1.reactor.wasm">https://github.com/bytecodealliance/preview2-prototyping/releases/download/latest/wasi_snapshot_preview1.reactor.wasm</a> and rename it to <code>wasi_snapshot_preview1.wasm</code></p>
<p>then run <code>wasm-tools component new ../target/wasm32-wasi/release/wasm.wasm -o ../target/component.wasm --adapt ../wasi_snapshot_preview1.wasm</code> to compile the wasm file, no error</p>
<p>then I run the normal codes, it report error</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="n">thread</span><span class="w"> </span><span class="o">'</span><span class="na">main</span><span class="o">'</span><span class="w"> </span><span class="n">panicked</span><span class="w"> </span><span class="n">at</span><span class="w"> </span><span class="o">'</span><span class="na">called</span><span class="w"> </span><span class="err">`</span><span class="nb">Result</span>::<span class="n">unwrap</span><span class="p">()</span><span class="err">`</span><span class="w"> </span><span class="n">on</span><span class="w"> </span><span class="n">an</span><span class="w"> </span><span class="err">`</span><span class="nb">Err</span><span class="err">`</span><span class="w"> </span><span class="n">value</span>: <span class="nc">import</span><span class="w"> </span><span class="err">`</span><span class="n">streams</span><span class="err">`</span><span class="w"> </span><span class="n">has</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">wrong</span><span class="w"> </span><span class="k">type</span>

<span class="nc">Caused</span><span class="w"> </span><span class="n">by</span>:
    <span class="mi">0</span>: <span class="nc">instance</span><span class="w"> </span><span class="n">export</span><span class="w"> </span><span class="err">`</span><span class="nb">drop</span><span class="o">-</span><span class="n">input</span><span class="o">-</span><span class="n">stream</span><span class="err">`</span><span class="w"> </span><span class="n">has</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">wrong</span><span class="w"> </span><span class="k">type</span>
    <span class="mi">1</span>: <span class="nc">expected</span><span class="w"> </span><span class="n">func</span><span class="w"> </span><span class="n">found</span><span class="w"> </span><span class="n">nothing</span><span class="o">'</span><span class="p">,</span><span class="w"> </span><span class="n">runtime</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">main</span><span class="p">.</span><span class="n">rs</span>:<span class="mi">39</span>:<span class="mi">10</span>
<span class="n">note</span>: <span class="nc">run</span><span class="w"> </span><span class="n">with</span><span class="w"> </span><span class="err">`</span><span class="n">RUST_BACKTRACE</span><span class="o">=</span><span class="mi">1</span><span class="err">`</span><span class="w"> </span><span class="n">environment</span><span class="w"> </span><span class="n">variable</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">display</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="n">backtrace</span>
</code></pre></div>
<p>I run <code>wasm-tools component wit ../target/component.wasm</code> to dump the wit file, it shows</p>
<div class="codehilite" data-code-language="wit"><pre><span></span><code>interface streams {
  type input-stream = u32

  type output-stream = u32

  record stream-error {
  }

  drop-input-stream: func(this: input-stream)

  write: func(this: output-stream, buf: list&lt;u8&gt;) -&gt; result&lt;u64, stream-error&gt;

  drop-output-stream: func(this: output-stream)
}

interface filesystem {
  use self.streams.{output-stream}

  type descriptor = u32

  type filesize = u64

  write-via-stream: func(this: descriptor, offset: filesize) -&gt; output-stream

  append-via-stream: func(this: descriptor) -&gt; output-stream

  drop-descriptor: func(this: descriptor)
}

interface environment {
  get-environment: func() -&gt; list&lt;tuple&lt;string, string&gt;&gt;
}

interface exit {
  exit: func(status: result)
}

interface stderr {
  print: func(message: string)
}

default world component {
  import streams: self.streams
  import filesystem: self.filesystem
  import environment: self.environment
  import exit: self.exit
  import stderr: self.stderr
  import get: func(url: string) -&gt; result&lt;string, string&gt;
  export run: func(url: string) -&gt; result&lt;string, string&gt;
}
</code></pre></div>
<p>a lot of things, but if I remove the <code>Ok(format!("wasm response: {resp}"))</code> in the rust wasm codes, replace with <code>Ok(resp)</code>, dump again and it will shows</p>
<div class="codehilite" data-code-language="wit"><pre><span></span><code>default world component {
  import get: func(url: string) -&gt; result&lt;string, string&gt;
  export run: func(url: string) -&gt; result&lt;string, string&gt;
}
</code></pre></div>
<p>it looks like normal</p>
<h3>Expected Results</h3>
<p>works well</p>
<h3>Versions and Environment</h3>
<p>Wasmtime version or commit: wasmtime crate 7.0.0</p>
<p>Operating system: Archlinux</p>
<p>Architecture: x64<br>
</p>
</blockquote>



<a name="364380837"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%236074%20wasmtime%20report%20import%20%60streams%60%20h.../near/364380837" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.236074.20wasmtime.20report.20import.20.60streams.60.20h.2E.2E.2E.html#364380837">(Jun 07 2023 at 19:45)</a>:</h4>
<p>DougAnderson444 <a href="https://github.com/bytecodealliance/wasmtime/issues/6074#issuecomment-1581410083">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/6074">issue #6074</a>:</p>
<blockquote>
<p>I am still seeing this error, noting that a few things have changed since March</p>
<div class="codehilite" data-code-language="Bash"><pre><span></span><code>Error:<span class="w"> </span>import<span class="w"> </span><span class="sb">`</span>wasi:io/streams<span class="sb">`</span><span class="w"> </span>has<span class="w"> </span>the<span class="w"> </span>wrong<span class="w"> </span><span class="nb">type</span>

Caused<span class="w"> </span>by:
<span class="w">    </span><span class="m">0</span>:<span class="w"> </span>instance<span class="w"> </span><span class="nb">export</span><span class="w"> </span><span class="sb">`</span>drop-input-stream<span class="sb">`</span><span class="w"> </span>has<span class="w"> </span>the<span class="w"> </span>wrong<span class="w"> </span><span class="nb">type</span>
<span class="w">    </span><span class="m">1</span>:<span class="w"> </span>expected<span class="w"> </span>func<span class="w"> </span>found<span class="w"> </span>nothing
</code></pre></div>
<p>1) First I used <code>--adapt</code> as per <a href="https://github.com/bytecodealliance/wasmtime/tree/main/crates/wasi-preview1-component-adapter">the instructions</a></p>
<p>2) Next I also see that <code>preview2-prototyping</code> moved to <code>crates/wasi-preview1-component-adapter</code> so I also tried</p>
<div class="codehilite" data-code-language="TOML"><pre><span></span><code><span class="c1"># Cargo.toml</span>
<span class="k">[dev-dependencies]</span>
<span class="n">wasi-preview1-component-adapter</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">git</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">"https://github.com/bytecodealliance/wasmtime"</span><span class="p">,</span><span class="w"> </span><span class="n">default-features</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">false</span><span class="p">,</span><span class="w"> </span><span class="n">features</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span>
<span class="w">    </span><span class="s">"command"</span><span class="p">,</span>
<span class="p">]</span><span class="w"> </span><span class="p">}</span>
</code></pre></div>
<p>...in order to use the <code>command::add_to_linker</code> move, but the <code>feature</code> selection doesn't seem to be working as <code>command</code> isn't available?</p>
</blockquote>



<hr><p>Last updated: Jan 20 2025 at 06:04 UTC</p>
</html>