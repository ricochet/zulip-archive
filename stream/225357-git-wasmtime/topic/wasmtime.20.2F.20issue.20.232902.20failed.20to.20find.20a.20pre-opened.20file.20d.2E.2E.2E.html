<html>
<head><meta charset="utf-8"><title>wasmtime / issue #2902 failed to find a pre-opened file d... · git-wasmtime · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/index.html">git-wasmtime</a></h2>
<h3>Topic: <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.232902.20failed.20to.20find.20a.20pre-opened.20file.20d.2E.2E.2E.html">wasmtime / issue #2902 failed to find a pre-opened file d...</a></h3>

<hr>

<base href="https://bytecodealliance.zulipchat.com">

<head><link href="https://bytecodealliance.github.io/zulip-archive/style.css" rel="stylesheet"></head>

<a name="238453215"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%232902%20failed%20to%20find%20a%20pre-opened%20file%20d.../near/238453215" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.232902.20failed.20to.20find.20a.20pre-opened.20file.20d.2E.2E.2E.html#238453215">(May 12 2021 at 10:40)</a>:</h4>
<p>proohit labeled <a href="https://github.com/bytecodealliance/wasmtime/issues/2902">issue #2902</a>:</p>
<blockquote>
<h3>Test Case</h3>
<p>smartcore_wasi_lib.wasm - <a href="https://easyupload.io/7l8u6z">https://easyupload.io/7l8u6z</a><br>
<a href="https://github.com/bytecodealliance/wasmtime/files/6465558/test1.txt">test1.txt</a></p>
<h3>Steps to Reproduce</h3>
<p>Just run the wasm file in the same folder as <code>test1.txt</code>.</p>
<h3>Expected Results</h3>
<p>A new file inside <code>./</code> with the name <code>test2.txt</code> and the same contents as <code>test1.txt</code>.</p>
<h3>Actual Results</h3>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="cp">$</span><span class="w"> </span><span class="n">wasmtime</span><span class="w"> </span><span class="n">run</span><span class="w"> </span><span class="o">--</span><span class="n">dir</span><span class="o">=</span><span class="p">.</span><span class="w"> </span><span class="n">smartcore_wasi_lib</span><span class="p">.</span><span class="n">wasm</span><span class="w"> </span><span class="o">--</span><span class="n">invoke</span><span class="w"> </span><span class="n">load_model</span><span class="w"> </span><span class="n">test1</span><span class="p">.</span><span class="n">txt</span><span class="w"> </span><span class="n">test2</span><span class="p">.</span><span class="n">txt</span><span class="w"></span>
<span class="n">error</span><span class="w"> </span><span class="n">opening</span><span class="w"> </span><span class="n">input</span><span class="w"> </span><span class="n">test1</span><span class="p">.</span><span class="n">txt</span>: <span class="nc">failed</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">find</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="n">pre</span><span class="o">-</span><span class="n">opened</span><span class="w"> </span><span class="n">file</span><span class="w"> </span><span class="n">descriptor</span><span class="w"> </span><span class="n">through</span><span class="w"> </span><span class="n">which</span><span class="w"> </span><span class="s">"test1.txt"</span><span class="w"> </span><span class="n">could</span><span class="w"> </span><span class="n">be</span><span class="w"> </span><span class="n">opened</span><span class="w"></span>
</code></pre></div>
<h3>Versions and Environment</h3>
<p>Wasmtime version or commit: 0.26.0</p>
<p>Operating system: Ubuntu 20.04</p>
<p>Architecture: x86_64</p>
<h3>Extra Info</h3>
<p>This is the example for WASI from <a href="https://github.com/bytecodealliance/wasmtime/blob/main/docs/WASI-tutorial.md">https://github.com/bytecodealliance/wasmtime/blob/main/docs/WASI-tutorial.md</a></p>
<p>Here's the code:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="k">use</span><span class="w"> </span><span class="n">std</span>::<span class="n">fs</span><span class="p">;</span><span class="w"></span>
<span class="k">use</span><span class="w"> </span><span class="n">std</span>::<span class="n">io</span>::<span class="p">{</span><span class="n">Read</span><span class="p">,</span><span class="w"> </span><span class="n">Write</span><span class="p">};</span><span class="w"></span>
<span class="k">use</span><span class="w"> </span><span class="n">std</span>::<span class="n">env</span><span class="p">;</span><span class="w"></span>

<span class="k">fn</span> <span class="nf">process</span><span class="p">(</span><span class="n">input_fname</span>: <span class="kp">&amp;</span><span class="kt">str</span><span class="p">,</span><span class="w"> </span><span class="n">output_fname</span>: <span class="kp">&amp;</span><span class="kt">str</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nb">Result</span><span class="o">&lt;</span><span class="p">(),</span><span class="w"> </span><span class="nb">String</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">input_file</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">fs</span>::<span class="n">File</span>::<span class="n">open</span><span class="p">(</span><span class="n">input_fname</span><span class="p">)</span><span class="w"></span>
<span class="w">        </span><span class="p">.</span><span class="n">map_err</span><span class="p">(</span><span class="o">|</span><span class="n">err</span><span class="o">|</span><span class="w"> </span><span class="fm">format!</span><span class="p">(</span><span class="s">"error opening input {}: {}"</span><span class="p">,</span><span class="w"> </span><span class="n">input_fname</span><span class="p">,</span><span class="w"> </span><span class="n">err</span><span class="p">))</span><span class="o">?</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">contents</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">Vec</span>::<span class="n">new</span><span class="p">();</span><span class="w"></span>
<span class="w">    </span><span class="n">input_file</span><span class="w"></span>
<span class="w">        </span><span class="p">.</span><span class="n">read_to_end</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="n">contents</span><span class="p">)</span><span class="w"></span>
<span class="w">        </span><span class="p">.</span><span class="n">map_err</span><span class="p">(</span><span class="o">|</span><span class="n">err</span><span class="o">|</span><span class="w"> </span><span class="fm">format!</span><span class="p">(</span><span class="s">"read error: {}"</span><span class="p">,</span><span class="w"> </span><span class="n">err</span><span class="p">))</span><span class="o">?</span><span class="p">;</span><span class="w"></span>

<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">output_file</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">fs</span>::<span class="n">File</span>::<span class="n">create</span><span class="p">(</span><span class="n">output_fname</span><span class="p">)</span><span class="w"></span>
<span class="w">        </span><span class="p">.</span><span class="n">map_err</span><span class="p">(</span><span class="o">|</span><span class="n">err</span><span class="o">|</span><span class="w"> </span><span class="fm">format!</span><span class="p">(</span><span class="s">"error opening output {}: {}"</span><span class="p">,</span><span class="w"> </span><span class="n">output_fname</span><span class="p">,</span><span class="w"> </span><span class="n">err</span><span class="p">))</span><span class="o">?</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="n">output_file</span><span class="w"></span>
<span class="w">        </span><span class="p">.</span><span class="n">write_all</span><span class="p">(</span><span class="o">&amp;</span><span class="n">contents</span><span class="p">)</span><span class="w"></span>
<span class="w">        </span><span class="p">.</span><span class="n">map_err</span><span class="p">(</span><span class="o">|</span><span class="n">err</span><span class="o">|</span><span class="w"> </span><span class="fm">format!</span><span class="p">(</span><span class="s">"write error: {}"</span><span class="p">,</span><span class="w"> </span><span class="n">err</span><span class="p">))</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="cp">#[no_mangle]</span><span class="w"></span>
<span class="k">pub</span><span class="w"> </span><span class="k">fn</span> <span class="nf">load_model</span><span class="p">()</span><span class="w"> </span>-&gt; <span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">args</span>: <span class="nb">Vec</span><span class="o">&lt;</span><span class="nb">String</span><span class="o">&gt;</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">env</span>::<span class="n">args</span><span class="p">().</span><span class="n">collect</span><span class="p">();</span><span class="w"></span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">program</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">clone</span><span class="p">();</span><span class="w"></span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="n">args</span><span class="p">.</span><span class="n">len</span><span class="p">()</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">3</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="fm">eprintln!</span><span class="p">(</span><span class="s">"usage: {} &lt;input_file&gt; &lt;output_file&gt;"</span><span class="p">,</span><span class="w"> </span><span class="n">program</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="k">return</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="kd">let</span><span class="w"> </span><span class="nb">Err</span><span class="p">(</span><span class="n">err</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">process</span><span class="p">(</span><span class="o">&amp;</span><span class="n">args</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="w"> </span><span class="o">&amp;</span><span class="n">args</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="fm">eprintln!</span><span class="p">(</span><span class="s">"{}"</span><span class="p">,</span><span class="w"> </span><span class="n">err</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>
<p>And compiled via <code>cargo build --target=wasm32-wasi --release</code></p>
</blockquote>



<a name="238453216"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%232902%20failed%20to%20find%20a%20pre-opened%20file%20d.../near/238453216" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.232902.20failed.20to.20find.20a.20pre-opened.20file.20d.2E.2E.2E.html#238453216">(May 12 2021 at 10:40)</a>:</h4>
<p>proohit opened <a href="https://github.com/bytecodealliance/wasmtime/issues/2902">issue #2902</a>:</p>
<blockquote>
<h3>Test Case</h3>
<p>smartcore_wasi_lib.wasm - <a href="https://easyupload.io/7l8u6z">https://easyupload.io/7l8u6z</a><br>
<a href="https://github.com/bytecodealliance/wasmtime/files/6465558/test1.txt">test1.txt</a></p>
<h3>Steps to Reproduce</h3>
<p>Just run the wasm file in the same folder as <code>test1.txt</code>.</p>
<h3>Expected Results</h3>
<p>A new file inside <code>./</code> with the name <code>test2.txt</code> and the same contents as <code>test1.txt</code>.</p>
<h3>Actual Results</h3>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="cp">$</span><span class="w"> </span><span class="n">wasmtime</span><span class="w"> </span><span class="n">run</span><span class="w"> </span><span class="o">--</span><span class="n">dir</span><span class="o">=</span><span class="p">.</span><span class="w"> </span><span class="n">smartcore_wasi_lib</span><span class="p">.</span><span class="n">wasm</span><span class="w"> </span><span class="o">--</span><span class="n">invoke</span><span class="w"> </span><span class="n">load_model</span><span class="w"> </span><span class="n">test1</span><span class="p">.</span><span class="n">txt</span><span class="w"> </span><span class="n">test2</span><span class="p">.</span><span class="n">txt</span><span class="w"></span>
<span class="n">error</span><span class="w"> </span><span class="n">opening</span><span class="w"> </span><span class="n">input</span><span class="w"> </span><span class="n">test1</span><span class="p">.</span><span class="n">txt</span>: <span class="nc">failed</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">find</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="n">pre</span><span class="o">-</span><span class="n">opened</span><span class="w"> </span><span class="n">file</span><span class="w"> </span><span class="n">descriptor</span><span class="w"> </span><span class="n">through</span><span class="w"> </span><span class="n">which</span><span class="w"> </span><span class="s">"test1.txt"</span><span class="w"> </span><span class="n">could</span><span class="w"> </span><span class="n">be</span><span class="w"> </span><span class="n">opened</span><span class="w"></span>
</code></pre></div>
<h3>Versions and Environment</h3>
<p>Wasmtime version or commit: 0.26.0</p>
<p>Operating system: Ubuntu 20.04</p>
<p>Architecture: x86_64</p>
<h3>Extra Info</h3>
<p>This is the example for WASI from <a href="https://github.com/bytecodealliance/wasmtime/blob/main/docs/WASI-tutorial.md">https://github.com/bytecodealliance/wasmtime/blob/main/docs/WASI-tutorial.md</a></p>
<p>Here's the code:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="k">use</span><span class="w"> </span><span class="n">std</span>::<span class="n">fs</span><span class="p">;</span><span class="w"></span>
<span class="k">use</span><span class="w"> </span><span class="n">std</span>::<span class="n">io</span>::<span class="p">{</span><span class="n">Read</span><span class="p">,</span><span class="w"> </span><span class="n">Write</span><span class="p">};</span><span class="w"></span>
<span class="k">use</span><span class="w"> </span><span class="n">std</span>::<span class="n">env</span><span class="p">;</span><span class="w"></span>

<span class="k">fn</span> <span class="nf">process</span><span class="p">(</span><span class="n">input_fname</span>: <span class="kp">&amp;</span><span class="kt">str</span><span class="p">,</span><span class="w"> </span><span class="n">output_fname</span>: <span class="kp">&amp;</span><span class="kt">str</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nb">Result</span><span class="o">&lt;</span><span class="p">(),</span><span class="w"> </span><span class="nb">String</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">input_file</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">fs</span>::<span class="n">File</span>::<span class="n">open</span><span class="p">(</span><span class="n">input_fname</span><span class="p">)</span><span class="w"></span>
<span class="w">        </span><span class="p">.</span><span class="n">map_err</span><span class="p">(</span><span class="o">|</span><span class="n">err</span><span class="o">|</span><span class="w"> </span><span class="fm">format!</span><span class="p">(</span><span class="s">"error opening input {}: {}"</span><span class="p">,</span><span class="w"> </span><span class="n">input_fname</span><span class="p">,</span><span class="w"> </span><span class="n">err</span><span class="p">))</span><span class="o">?</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">contents</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">Vec</span>::<span class="n">new</span><span class="p">();</span><span class="w"></span>
<span class="w">    </span><span class="n">input_file</span><span class="w"></span>
<span class="w">        </span><span class="p">.</span><span class="n">read_to_end</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="n">contents</span><span class="p">)</span><span class="w"></span>
<span class="w">        </span><span class="p">.</span><span class="n">map_err</span><span class="p">(</span><span class="o">|</span><span class="n">err</span><span class="o">|</span><span class="w"> </span><span class="fm">format!</span><span class="p">(</span><span class="s">"read error: {}"</span><span class="p">,</span><span class="w"> </span><span class="n">err</span><span class="p">))</span><span class="o">?</span><span class="p">;</span><span class="w"></span>

<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">output_file</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">fs</span>::<span class="n">File</span>::<span class="n">create</span><span class="p">(</span><span class="n">output_fname</span><span class="p">)</span><span class="w"></span>
<span class="w">        </span><span class="p">.</span><span class="n">map_err</span><span class="p">(</span><span class="o">|</span><span class="n">err</span><span class="o">|</span><span class="w"> </span><span class="fm">format!</span><span class="p">(</span><span class="s">"error opening output {}: {}"</span><span class="p">,</span><span class="w"> </span><span class="n">output_fname</span><span class="p">,</span><span class="w"> </span><span class="n">err</span><span class="p">))</span><span class="o">?</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="n">output_file</span><span class="w"></span>
<span class="w">        </span><span class="p">.</span><span class="n">write_all</span><span class="p">(</span><span class="o">&amp;</span><span class="n">contents</span><span class="p">)</span><span class="w"></span>
<span class="w">        </span><span class="p">.</span><span class="n">map_err</span><span class="p">(</span><span class="o">|</span><span class="n">err</span><span class="o">|</span><span class="w"> </span><span class="fm">format!</span><span class="p">(</span><span class="s">"write error: {}"</span><span class="p">,</span><span class="w"> </span><span class="n">err</span><span class="p">))</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="cp">#[no_mangle]</span><span class="w"></span>
<span class="k">pub</span><span class="w"> </span><span class="k">fn</span> <span class="nf">load_model</span><span class="p">()</span><span class="w"> </span>-&gt; <span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">args</span>: <span class="nb">Vec</span><span class="o">&lt;</span><span class="nb">String</span><span class="o">&gt;</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">env</span>::<span class="n">args</span><span class="p">().</span><span class="n">collect</span><span class="p">();</span><span class="w"></span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">program</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">clone</span><span class="p">();</span><span class="w"></span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="n">args</span><span class="p">.</span><span class="n">len</span><span class="p">()</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">3</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="fm">eprintln!</span><span class="p">(</span><span class="s">"usage: {} &lt;input_file&gt; &lt;output_file&gt;"</span><span class="p">,</span><span class="w"> </span><span class="n">program</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="k">return</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="kd">let</span><span class="w"> </span><span class="nb">Err</span><span class="p">(</span><span class="n">err</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">process</span><span class="p">(</span><span class="o">&amp;</span><span class="n">args</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="w"> </span><span class="o">&amp;</span><span class="n">args</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="fm">eprintln!</span><span class="p">(</span><span class="s">"{}"</span><span class="p">,</span><span class="w"> </span><span class="n">err</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>
<p>And compiled via <code>cargo build --target=wasm32-wasi --release</code></p>
</blockquote>



<a name="238453453"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%232902%20failed%20to%20find%20a%20pre-opened%20file%20d.../near/238453453" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.232902.20failed.20to.20find.20a.20pre-opened.20file.20d.2E.2E.2E.html#238453453">(May 12 2021 at 10:43)</a>:</h4>
<p>proohit edited <a href="https://github.com/bytecodealliance/wasmtime/issues/2902">issue #2902</a>:</p>
<blockquote>
<h3>Test Case</h3>
<p>smartcore_wasi_lib.wasm - <a href="https://easyupload.io/7l8u6z">https://easyupload.io/7l8u6z</a><br>
<a href="https://github.com/bytecodealliance/wasmtime/files/6465558/test1.txt">test1.txt</a></p>
<h3>Steps to Reproduce</h3>
<p>Just run the wasm file in the same folder as <code>test1.txt</code>.<br>
<code>wasmtime run --dir=. smartcore_wasi_lib.wasm --invoke load_model test1.txt test2.txt</code></p>
<h3>Expected Results</h3>
<p>A new file inside <code>./</code> with the name <code>test2.txt</code> and the same contents as <code>test1.txt</code>.</p>
<h3>Actual Results</h3>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="cp">$</span><span class="w"> </span><span class="n">wasmtime</span><span class="w"> </span><span class="n">run</span><span class="w"> </span><span class="o">--</span><span class="n">dir</span><span class="o">=</span><span class="p">.</span><span class="w"> </span><span class="n">smartcore_wasi_lib</span><span class="p">.</span><span class="n">wasm</span><span class="w"> </span><span class="o">--</span><span class="n">invoke</span><span class="w"> </span><span class="n">load_model</span><span class="w"> </span><span class="n">test1</span><span class="p">.</span><span class="n">txt</span><span class="w"> </span><span class="n">test2</span><span class="p">.</span><span class="n">txt</span><span class="w"></span>
<span class="n">error</span><span class="w"> </span><span class="n">opening</span><span class="w"> </span><span class="n">input</span><span class="w"> </span><span class="n">test1</span><span class="p">.</span><span class="n">txt</span>: <span class="nc">failed</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">find</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="n">pre</span><span class="o">-</span><span class="n">opened</span><span class="w"> </span><span class="n">file</span><span class="w"> </span><span class="n">descriptor</span><span class="w"> </span><span class="n">through</span><span class="w"> </span><span class="n">which</span><span class="w"> </span><span class="s">"test1.txt"</span><span class="w"> </span><span class="n">could</span><span class="w"> </span><span class="n">be</span><span class="w"> </span><span class="n">opened</span><span class="w"></span>
</code></pre></div>
<h3>Versions and Environment</h3>
<p>Wasmtime version or commit: 0.26.0</p>
<p>Operating system: Ubuntu 20.04</p>
<p>Architecture: x86_64</p>
<h3>Extra Info</h3>
<p>This is the example for WASI from <a href="https://github.com/bytecodealliance/wasmtime/blob/main/docs/WASI-tutorial.md">https://github.com/bytecodealliance/wasmtime/blob/main/docs/WASI-tutorial.md</a></p>
<p>Here's the code:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="k">use</span><span class="w"> </span><span class="n">std</span>::<span class="n">fs</span><span class="p">;</span><span class="w"></span>
<span class="k">use</span><span class="w"> </span><span class="n">std</span>::<span class="n">io</span>::<span class="p">{</span><span class="n">Read</span><span class="p">,</span><span class="w"> </span><span class="n">Write</span><span class="p">};</span><span class="w"></span>
<span class="k">use</span><span class="w"> </span><span class="n">std</span>::<span class="n">env</span><span class="p">;</span><span class="w"></span>

<span class="k">fn</span> <span class="nf">process</span><span class="p">(</span><span class="n">input_fname</span>: <span class="kp">&amp;</span><span class="kt">str</span><span class="p">,</span><span class="w"> </span><span class="n">output_fname</span>: <span class="kp">&amp;</span><span class="kt">str</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nb">Result</span><span class="o">&lt;</span><span class="p">(),</span><span class="w"> </span><span class="nb">String</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">input_file</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">fs</span>::<span class="n">File</span>::<span class="n">open</span><span class="p">(</span><span class="n">input_fname</span><span class="p">)</span><span class="w"></span>
<span class="w">        </span><span class="p">.</span><span class="n">map_err</span><span class="p">(</span><span class="o">|</span><span class="n">err</span><span class="o">|</span><span class="w"> </span><span class="fm">format!</span><span class="p">(</span><span class="s">"error opening input {}: {}"</span><span class="p">,</span><span class="w"> </span><span class="n">input_fname</span><span class="p">,</span><span class="w"> </span><span class="n">err</span><span class="p">))</span><span class="o">?</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">contents</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">Vec</span>::<span class="n">new</span><span class="p">();</span><span class="w"></span>
<span class="w">    </span><span class="n">input_file</span><span class="w"></span>
<span class="w">        </span><span class="p">.</span><span class="n">read_to_end</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="n">contents</span><span class="p">)</span><span class="w"></span>
<span class="w">        </span><span class="p">.</span><span class="n">map_err</span><span class="p">(</span><span class="o">|</span><span class="n">err</span><span class="o">|</span><span class="w"> </span><span class="fm">format!</span><span class="p">(</span><span class="s">"read error: {}"</span><span class="p">,</span><span class="w"> </span><span class="n">err</span><span class="p">))</span><span class="o">?</span><span class="p">;</span><span class="w"></span>

<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">output_file</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">fs</span>::<span class="n">File</span>::<span class="n">create</span><span class="p">(</span><span class="n">output_fname</span><span class="p">)</span><span class="w"></span>
<span class="w">        </span><span class="p">.</span><span class="n">map_err</span><span class="p">(</span><span class="o">|</span><span class="n">err</span><span class="o">|</span><span class="w"> </span><span class="fm">format!</span><span class="p">(</span><span class="s">"error opening output {}: {}"</span><span class="p">,</span><span class="w"> </span><span class="n">output_fname</span><span class="p">,</span><span class="w"> </span><span class="n">err</span><span class="p">))</span><span class="o">?</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="n">output_file</span><span class="w"></span>
<span class="w">        </span><span class="p">.</span><span class="n">write_all</span><span class="p">(</span><span class="o">&amp;</span><span class="n">contents</span><span class="p">)</span><span class="w"></span>
<span class="w">        </span><span class="p">.</span><span class="n">map_err</span><span class="p">(</span><span class="o">|</span><span class="n">err</span><span class="o">|</span><span class="w"> </span><span class="fm">format!</span><span class="p">(</span><span class="s">"write error: {}"</span><span class="p">,</span><span class="w"> </span><span class="n">err</span><span class="p">))</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="cp">#[no_mangle]</span><span class="w"></span>
<span class="k">pub</span><span class="w"> </span><span class="k">fn</span> <span class="nf">load_model</span><span class="p">()</span><span class="w"> </span>-&gt; <span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">args</span>: <span class="nb">Vec</span><span class="o">&lt;</span><span class="nb">String</span><span class="o">&gt;</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">env</span>::<span class="n">args</span><span class="p">().</span><span class="n">collect</span><span class="p">();</span><span class="w"></span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">program</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">clone</span><span class="p">();</span><span class="w"></span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="n">args</span><span class="p">.</span><span class="n">len</span><span class="p">()</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">3</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="fm">eprintln!</span><span class="p">(</span><span class="s">"usage: {} &lt;input_file&gt; &lt;output_file&gt;"</span><span class="p">,</span><span class="w"> </span><span class="n">program</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="k">return</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="kd">let</span><span class="w"> </span><span class="nb">Err</span><span class="p">(</span><span class="n">err</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">process</span><span class="p">(</span><span class="o">&amp;</span><span class="n">args</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="w"> </span><span class="o">&amp;</span><span class="n">args</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="fm">eprintln!</span><span class="p">(</span><span class="s">"{}"</span><span class="p">,</span><span class="w"> </span><span class="n">err</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>
<p>And compiled via <code>cargo build --target=wasm32-wasi --release</code></p>
</blockquote>



<a name="238453694"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%232902%20failed%20to%20find%20a%20pre-opened%20file%20d.../near/238453694" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.232902.20failed.20to.20find.20a.20pre-opened.20file.20d.2E.2E.2E.html#238453694">(May 12 2021 at 10:46)</a>:</h4>
<p>bjorn3 <a href="https://github.com/bytecodealliance/wasmtime/issues/2902#issuecomment-839671657">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/2902">issue #2902</a>:</p>
<blockquote>
<p>Does it work if you specify <code>./test1.txt</code> and <code>./test2.txt</code>?</p>
</blockquote>



<a name="238457558"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%232902%20failed%20to%20find%20a%20pre-opened%20file%20d.../near/238457558" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.232902.20failed.20to.20find.20a.20pre-opened.20file.20d.2E.2E.2E.html#238457558">(May 12 2021 at 11:23)</a>:</h4>
<p>proohit <a href="https://github.com/bytecodealliance/wasmtime/issues/2902#issuecomment-839693579">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/2902">issue #2902</a>:</p>
<blockquote>
<p>Unfortunately not.. Same error:</p>
<p><div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="cp">$</span><span class="w"> </span><span class="n">wasmtime</span><span class="w"> </span><span class="n">run</span><span class="w"> </span><span class="o">--</span><span class="n">dir</span><span class="o">=</span><span class="p">.</span><span class="w"> </span><span class="n">smartcore_wasi_lib</span><span class="p">.</span><span class="n">wasm</span><span class="w"> </span><span class="o">--</span><span class="n">invoke</span><span class="w"> </span><span class="n">load_model</span><span class="w"> </span><span class="p">.</span><span class="o">/</span><span class="n">test1</span><span class="p">.</span><span class="n">txt</span><span class="w"> </span><span class="p">.</span><span class="o">/</span><span class="n">test2</span><span class="p">.</span><span class="n">txt</span><span class="w"></span>
<span class="n">error</span><span class="w"> </span><span class="n">opening</span><span class="w"> </span><span class="n">input</span><span class="w"> </span><span class="p">.</span><span class="o">/</span><span class="n">test1</span><span class="p">.</span><span class="n">txt</span>: <span class="nc">failed</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">find</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="n">pre</span><span class="o">-</span><span class="n">opened</span><span class="w"> </span><span class="n">file</span><span class="w"> </span><span class="n">descriptor</span><span class="w"> </span><span class="n">through</span><span class="w"> </span><span class="n">which</span><span class="w"> </span><span class="s">"./test1.txt"</span><span class="w"> </span><span class="n">could</span><span class="w"> </span><span class="n">be</span><span class="w"> </span><span class="n">opened</span><span class="w"></span>
</code></pre></div><br>
</p>
</blockquote>



<a name="238461762"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%232902%20failed%20to%20find%20a%20pre-opened%20file%20d.../near/238461762" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.232902.20failed.20to.20find.20a.20pre-opened.20file.20d.2E.2E.2E.html#238461762">(May 12 2021 at 12:01)</a>:</h4>
<p>bjorn3 <a href="https://github.com/bytecodealliance/wasmtime/issues/2902#issuecomment-839714102">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/2902">issue #2902</a>:</p>
<blockquote>
<p>Oh, I think I now what is going on. By using <code>load_model</code> as entry point, you are skipping wasi-libc's entry point which initializes libpreopen. As it isn't initialized, libpreopen doesn't know how to open files.</p>
</blockquote>



<a name="238463901"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%232902%20failed%20to%20find%20a%20pre-opened%20file%20d.../near/238463901" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.232902.20failed.20to.20find.20a.20pre-opened.20file.20d.2E.2E.2E.html#238463901">(May 12 2021 at 12:20)</a>:</h4>
<p>proohit <a href="https://github.com/bytecodealliance/wasmtime/issues/2902#issuecomment-839725453">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/2902">issue #2902</a>:</p>
<blockquote>
<p>Hmm, this project was meant for another use-case, where it is used as a lib. I was hoping to quickly test it with wasmtime. Is this on purpose that invoked functions skip other necessary entry points?</p>
</blockquote>



<a name="238471523"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%232902%20failed%20to%20find%20a%20pre-opened%20file%20d.../near/238471523" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.232902.20failed.20to.20find.20a.20pre-opened.20file.20d.2E.2E.2E.html#238471523">(May 12 2021 at 13:18)</a>:</h4>
<p>bjorn3 <a href="https://github.com/bytecodealliance/wasmtime/issues/2902#issuecomment-839765595">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/2902">issue #2902</a>:</p>
<blockquote>
<p>Wasi has two execution models:</p>
<ul>
<li>command: This is like an executable. There is a single entry point and after the entry point returns you must discard the whole instance. This entry point is the <code>_start</code> function declared in wasi-libc which in turn calls the user <code>main</code>.</li>
<li>reactor: This is like a library. There is first a call to <code>_initialize</code> declared in wasi-libc. After that it is possible to call any user defined function.</li>
</ul>
<p>To compile a reactor with rustc you need to use the unstable <code>-Z wasi-exec-model=reactor</code> flag. I am not sure if wasmtime cli supports reactors, but the api does, though it may be necessary to manually call <code>_initialize</code>. (not sure if wasmtime already automatically does this for your)</p>
<p><a href="https://github.com/WebAssembly/WASI/issues/13">https://github.com/WebAssembly/WASI/issues/13</a></p>
<p><a href="https://github.com/rust-lang/rust/pull/79997">https://github.com/rust-lang/rust/pull/79997</a></p>
</blockquote>



<a name="238490069"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%232902%20failed%20to%20find%20a%20pre-opened%20file%20d.../near/238490069" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.232902.20failed.20to.20find.20a.20pre-opened.20file.20d.2E.2E.2E.html#238490069">(May 12 2021 at 15:09)</a>:</h4>
<p>proohit <a href="https://github.com/bytecodealliance/wasmtime/issues/2902#issuecomment-839851434">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/2902">issue #2902</a>:</p>
<blockquote>
<p>Thanks for your valuable input! That was new to me and actually solved the problem!</p>
<p>Compiling the project with <code>cargo rustc --release --target wasm32-wasi -- -Z wasi-exec-model=reactor</code> did the trick. Now <code>wasmtime run --dir=. smartcore_wasi_lib.wasm --invoke load_model test1.txt test2.txt</code> results in <code>test2.txt</code>.</p>
</blockquote>



<a name="238490070"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%232902%20failed%20to%20find%20a%20pre-opened%20file%20d.../near/238490070" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.232902.20failed.20to.20find.20a.20pre-opened.20file.20d.2E.2E.2E.html#238490070">(May 12 2021 at 15:09)</a>:</h4>
<p>proohit closed <a href="https://github.com/bytecodealliance/wasmtime/issues/2902">issue #2902</a>:</p>
<blockquote>
<h3>Test Case</h3>
<p>smartcore_wasi_lib.wasm - <a href="https://easyupload.io/7l8u6z">https://easyupload.io/7l8u6z</a><br>
<a href="https://github.com/bytecodealliance/wasmtime/files/6465558/test1.txt">test1.txt</a></p>
<h3>Steps to Reproduce</h3>
<p>Just run the wasm file in the same folder as <code>test1.txt</code>.<br>
<code>wasmtime run --dir=. smartcore_wasi_lib.wasm --invoke load_model test1.txt test2.txt</code></p>
<h3>Expected Results</h3>
<p>A new file inside <code>./</code> with the name <code>test2.txt</code> and the same contents as <code>test1.txt</code>.</p>
<h3>Actual Results</h3>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="cp">$</span><span class="w"> </span><span class="n">wasmtime</span><span class="w"> </span><span class="n">run</span><span class="w"> </span><span class="o">--</span><span class="n">dir</span><span class="o">=</span><span class="p">.</span><span class="w"> </span><span class="n">smartcore_wasi_lib</span><span class="p">.</span><span class="n">wasm</span><span class="w"> </span><span class="o">--</span><span class="n">invoke</span><span class="w"> </span><span class="n">load_model</span><span class="w"> </span><span class="n">test1</span><span class="p">.</span><span class="n">txt</span><span class="w"> </span><span class="n">test2</span><span class="p">.</span><span class="n">txt</span><span class="w"></span>
<span class="n">error</span><span class="w"> </span><span class="n">opening</span><span class="w"> </span><span class="n">input</span><span class="w"> </span><span class="n">test1</span><span class="p">.</span><span class="n">txt</span>: <span class="nc">failed</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">find</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="n">pre</span><span class="o">-</span><span class="n">opened</span><span class="w"> </span><span class="n">file</span><span class="w"> </span><span class="n">descriptor</span><span class="w"> </span><span class="n">through</span><span class="w"> </span><span class="n">which</span><span class="w"> </span><span class="s">"test1.txt"</span><span class="w"> </span><span class="n">could</span><span class="w"> </span><span class="n">be</span><span class="w"> </span><span class="n">opened</span><span class="w"></span>
</code></pre></div>
<h3>Versions and Environment</h3>
<p>Wasmtime version or commit: 0.26.0</p>
<p>Operating system: Ubuntu 20.04</p>
<p>Architecture: x86_64</p>
<h3>Extra Info</h3>
<p>This is the example for WASI from <a href="https://github.com/bytecodealliance/wasmtime/blob/main/docs/WASI-tutorial.md">https://github.com/bytecodealliance/wasmtime/blob/main/docs/WASI-tutorial.md</a></p>
<p>Here's the code:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="k">use</span><span class="w"> </span><span class="n">std</span>::<span class="n">fs</span><span class="p">;</span><span class="w"></span>
<span class="k">use</span><span class="w"> </span><span class="n">std</span>::<span class="n">io</span>::<span class="p">{</span><span class="n">Read</span><span class="p">,</span><span class="w"> </span><span class="n">Write</span><span class="p">};</span><span class="w"></span>
<span class="k">use</span><span class="w"> </span><span class="n">std</span>::<span class="n">env</span><span class="p">;</span><span class="w"></span>

<span class="k">fn</span> <span class="nf">process</span><span class="p">(</span><span class="n">input_fname</span>: <span class="kp">&amp;</span><span class="kt">str</span><span class="p">,</span><span class="w"> </span><span class="n">output_fname</span>: <span class="kp">&amp;</span><span class="kt">str</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nb">Result</span><span class="o">&lt;</span><span class="p">(),</span><span class="w"> </span><span class="nb">String</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">input_file</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">fs</span>::<span class="n">File</span>::<span class="n">open</span><span class="p">(</span><span class="n">input_fname</span><span class="p">)</span><span class="w"></span>
<span class="w">        </span><span class="p">.</span><span class="n">map_err</span><span class="p">(</span><span class="o">|</span><span class="n">err</span><span class="o">|</span><span class="w"> </span><span class="fm">format!</span><span class="p">(</span><span class="s">"error opening input {}: {}"</span><span class="p">,</span><span class="w"> </span><span class="n">input_fname</span><span class="p">,</span><span class="w"> </span><span class="n">err</span><span class="p">))</span><span class="o">?</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">contents</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">Vec</span>::<span class="n">new</span><span class="p">();</span><span class="w"></span>
<span class="w">    </span><span class="n">input_file</span><span class="w"></span>
<span class="w">        </span><span class="p">.</span><span class="n">read_to_end</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="n">contents</span><span class="p">)</span><span class="w"></span>
<span class="w">        </span><span class="p">.</span><span class="n">map_err</span><span class="p">(</span><span class="o">|</span><span class="n">err</span><span class="o">|</span><span class="w"> </span><span class="fm">format!</span><span class="p">(</span><span class="s">"read error: {}"</span><span class="p">,</span><span class="w"> </span><span class="n">err</span><span class="p">))</span><span class="o">?</span><span class="p">;</span><span class="w"></span>

<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">output_file</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">fs</span>::<span class="n">File</span>::<span class="n">create</span><span class="p">(</span><span class="n">output_fname</span><span class="p">)</span><span class="w"></span>
<span class="w">        </span><span class="p">.</span><span class="n">map_err</span><span class="p">(</span><span class="o">|</span><span class="n">err</span><span class="o">|</span><span class="w"> </span><span class="fm">format!</span><span class="p">(</span><span class="s">"error opening output {}: {}"</span><span class="p">,</span><span class="w"> </span><span class="n">output_fname</span><span class="p">,</span><span class="w"> </span><span class="n">err</span><span class="p">))</span><span class="o">?</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="n">output_file</span><span class="w"></span>
<span class="w">        </span><span class="p">.</span><span class="n">write_all</span><span class="p">(</span><span class="o">&amp;</span><span class="n">contents</span><span class="p">)</span><span class="w"></span>
<span class="w">        </span><span class="p">.</span><span class="n">map_err</span><span class="p">(</span><span class="o">|</span><span class="n">err</span><span class="o">|</span><span class="w"> </span><span class="fm">format!</span><span class="p">(</span><span class="s">"write error: {}"</span><span class="p">,</span><span class="w"> </span><span class="n">err</span><span class="p">))</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="cp">#[no_mangle]</span><span class="w"></span>
<span class="k">pub</span><span class="w"> </span><span class="k">fn</span> <span class="nf">load_model</span><span class="p">()</span><span class="w"> </span>-&gt; <span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">args</span>: <span class="nb">Vec</span><span class="o">&lt;</span><span class="nb">String</span><span class="o">&gt;</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">env</span>::<span class="n">args</span><span class="p">().</span><span class="n">collect</span><span class="p">();</span><span class="w"></span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">program</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">clone</span><span class="p">();</span><span class="w"></span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="n">args</span><span class="p">.</span><span class="n">len</span><span class="p">()</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">3</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="fm">eprintln!</span><span class="p">(</span><span class="s">"usage: {} &lt;input_file&gt; &lt;output_file&gt;"</span><span class="p">,</span><span class="w"> </span><span class="n">program</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="k">return</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="kd">let</span><span class="w"> </span><span class="nb">Err</span><span class="p">(</span><span class="n">err</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">process</span><span class="p">(</span><span class="o">&amp;</span><span class="n">args</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="w"> </span><span class="o">&amp;</span><span class="n">args</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="fm">eprintln!</span><span class="p">(</span><span class="s">"{}"</span><span class="p">,</span><span class="w"> </span><span class="n">err</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>
<p>And compiled via <code>cargo build --target=wasm32-wasi --release</code></p>
</blockquote>



<a name="471825893"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%232902%20failed%20to%20find%20a%20pre-opened%20file%20d.../near/471825893" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.232902.20failed.20to.20find.20a.20pre-opened.20file.20d.2E.2E.2E.html#471825893">(Sep 20 2024 at 20:17)</a>:</h4>
<p>Timmmm <a href="https://github.com/bytecodealliance/wasmtime/issues/2902#issuecomment-2364555680">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/2902">issue #2902</a>:</p>
<blockquote>
<p>I'm also getting a very similar error. I'm building a very simple Rust WASI binary <em>not</em> in reactor mode, that tries to opens a file.</p>
<p>I start it in command mode via Node - see code below.</p>
<p>I get the same <code>failed to find a pre-opened file descriptor</code> error, but I don't want to switch to "reactor" (why didn't they call this "library"?) mode. I don't understand why this still happens though because surely I am using the <code>_start</code> entry point which should initialise this <code>libpreload</code> library?</p>
<p>(Sorry to slightly hijack this issue, but there's not much on the internet about this.)</p>
<p><div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="n">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">WASI</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="n">from</span><span class="w"> </span><span class="s">"node:wasi"</span><span class="p">;</span>
<span class="n">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">readFile</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="n">from</span><span class="w"> </span><span class="s">"node:fs/promises"</span><span class="p">;</span>
<span class="n">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">join</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="n">from</span><span class="w"> </span><span class="s">"node:path"</span><span class="p">;</span>

<span class="k">async</span><span class="w"> </span><span class="n">function</span><span class="w"> </span><span class="n">main</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">const</span><span class="w"> </span><span class="n">wasm</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="n">WebAssembly</span><span class="p">.</span><span class="n">compile</span><span class="p">(</span>
<span class="w">        </span><span class="k">await</span><span class="w"> </span><span class="n">readFile</span><span class="p">(</span><span class="n">join</span><span class="p">(</span><span class="n">__dirname</span><span class="p">,</span><span class="w"> </span><span class="s">"server.wasm"</span><span class="p">)),</span>
<span class="w">    </span><span class="p">);</span>
<span class="w">    </span><span class="k">const</span><span class="w"> </span><span class="n">wasi</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">new</span><span class="w"> </span><span class="n">WASI</span><span class="p">({</span>
<span class="w">        </span><span class="n">env</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">RUST_BACKTRACE</span><span class="p">:</span><span class="w"> </span><span class="s">"1"</span><span class="p">,</span>
<span class="w">        </span><span class="p">},</span>
<span class="w">        </span><span class="c1">// This option is mandatory.</span>
<span class="w">        </span><span class="n">version</span><span class="p">:</span><span class="w"> </span><span class="s">"preview1"</span><span class="p">,</span>
<span class="w">    </span><span class="p">});</span>
<span class="w">    </span><span class="k">const</span><span class="w"> </span><span class="n">instance</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="n">WebAssembly</span><span class="p">.</span><span class="n">instantiate</span><span class="p">(</span><span class="n">wasm</span><span class="p">,</span><span class="w"> </span><span class="o">&lt;</span><span class="n">WebAssembly</span><span class="p">.</span><span class="n">Imports</span><span class="o">&gt;</span><span class="n">wasi</span><span class="p">.</span><span class="n">getImportObject</span><span class="p">());</span>

<span class="w">    </span><span class="n">wasi</span><span class="p">.</span><span class="n">start</span><span class="p">(</span><span class="n">instance</span><span class="p">);</span>
<span class="p">}</span>

<span class="n">main</span><span class="p">();</span>
</code></pre></div><br>
</p>
</blockquote>



<a name="471826530"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%232902%20failed%20to%20find%20a%20pre-opened%20file%20d.../near/471826530" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.232902.20failed.20to.20find.20a.20pre-opened.20file.20d.2E.2E.2E.html#471826530">(Sep 20 2024 at 20:20)</a>:</h4>
<p>Timmmm <a href="https://github.com/bytecodealliance/wasmtime/issues/2902#issuecomment-2364560054">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/2902">issue #2902</a>:</p>
<blockquote>
<p>Oh wait... you just need to do this:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="w">    </span><span class="k">const</span><span class="w"> </span><span class="n">wasi</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">new</span><span class="w"> </span><span class="n">WASI</span><span class="p">({</span>
<span class="w">        </span><span class="n">env</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">RUST_BACKTRACE</span><span class="p">:</span><span class="w"> </span><span class="s">"1"</span><span class="p">,</span>
<span class="w">        </span><span class="p">},</span>
<span class="w">        </span><span class="c1">// This option is mandatory.</span>
<span class="w">        </span><span class="n">version</span><span class="p">:</span><span class="w"> </span><span class="s">"preview1"</span><span class="p">,</span>
<span class="w">        </span><span class="n">preopens</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="s">"/"</span><span class="p">:</span><span class="w"> </span><span class="s">"/"</span><span class="p">,</span>
<span class="w">        </span><span class="p">},</span>
<span class="w">    </span><span class="p">});</span>
</code></pre></div>
<p>Sorry for the noise!</p>
</blockquote>



<a name="471828899"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%232902%20failed%20to%20find%20a%20pre-opened%20file%20d.../near/471828899" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.232902.20failed.20to.20find.20a.20pre-opened.20file.20d.2E.2E.2E.html#471828899">(Sep 20 2024 at 20:35)</a>:</h4>
<p>Timmmm <a href="https://github.com/bytecodealliance/wasmtime/issues/2902#issuecomment-2364579976">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/2902">issue #2902</a>:</p>
<blockquote>
<p>For Windows you need this nonsense:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="w">            </span><span class="s">"/"</span><span class="p">:</span><span class="w"> </span><span class="s">"/"</span><span class="p">,</span>
<span class="w">            </span><span class="s">"a:/"</span><span class="p">:</span><span class="w"> </span><span class="s">"a:/"</span><span class="p">,</span>
<span class="w">            </span><span class="s">"b:/"</span><span class="p">:</span><span class="w"> </span><span class="s">"b:/"</span><span class="p">,</span>
<span class="w">            </span><span class="s">"c:/"</span><span class="p">:</span><span class="w"> </span><span class="s">"c:/"</span><span class="p">,</span>
<span class="w">            </span><span class="s">"d:/"</span><span class="p">:</span><span class="w"> </span><span class="s">"d:/"</span><span class="p">,</span>
<span class="o">..</span><span class="p">.</span>
</code></pre></div>
<p>(Or I guess narrow it down to a specific directory if your application allows that.)</p>
</blockquote>



<hr><p>Last updated: Jan 20 2025 at 06:04 UTC</p>
</html>