<html>
<head><meta charset="utf-8"><title>wasmtime / PR #9992 refactor: remove `OnceLock` · git-wasmtime · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/index.html">git-wasmtime</a></h2>
<h3>Topic: <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.239992.20refactor.3A.20remove.20.60OnceLock.60.html">wasmtime / PR #9992 refactor: remove `OnceLock`</a></h3>

<hr>

<base href="https://bytecodealliance.zulipchat.com">

<head><link href="https://bytecodealliance.github.io/zulip-archive/style.css" rel="stylesheet"></head>

<a name="493324099"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%239992%20refactor%3A%20remove%20%60OnceLock%60/near/493324099" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.239992.20refactor.3A.20remove.20.60OnceLock.60.html#493324099">(Jan 13 2025 at 11:18)</a>:</h4>
<p>JonasKruckenberg opened <a href="https://github.com/bytecodealliance/wasmtime/pull/9992">PR #9992</a> from <code>JonasKruckenberg:jonas/static-machine-env</code> to <code>bytecodealliance:main</code>:</p>
<blockquote>
<p>This PR is another attempt at #8489 (superseding it) this time by making the necessary changes in <code>regalloc2</code> (see <a href="https://github.com/bytecodealliance/regalloc2/pull/208">here</a>) to allow <code>MachineEnv</code> to be created in const expressions and therefore placed into statics without the need for lazy initialization (as mentioned in <a href="#narrow/channel/217117-cranelift/topic/Use.20in.20no_std/near/493078060">this comment</a>)<br>
This PR also makes the necessary changes in register creation functions to make them <code>const</code>.</p>
<p>While I agree with @cfallin that this is the "correct" move, it is slightly annoying that Rusts const limitation makes the static initializers so verbose where a <code>1..=16</code> range iterator was used previously :/</p>
</blockquote>



<a name="493324100"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%239992%20refactor%3A%20remove%20%60OnceLock%60/near/493324100" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.239992.20refactor.3A.20remove.20.60OnceLock.60.html#493324100">(Jan 13 2025 at 11:18)</a>:</h4>
<p><strong>JonasKruckenberg</strong> requested <a href="https://github.com/fitzgen">fitzgen</a> for a review on <a href="https://github.com/bytecodealliance/wasmtime/pull/9992">PR #9992</a>.</p>



<a name="493324101"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%239992%20refactor%3A%20remove%20%60OnceLock%60/near/493324101" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.239992.20refactor.3A.20remove.20.60OnceLock.60.html#493324101">(Jan 13 2025 at 11:18)</a>:</h4>
<p><strong>JonasKruckenberg</strong> requested <a href="https://github.com/orgs/bytecodealliance/teams/wasmtime-compiler-reviewers">wasmtime-compiler-reviewers</a> for a review on <a href="https://github.com/bytecodealliance/wasmtime/pull/9992">PR #9992</a>.</p>



<a name="493324102"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%239992%20refactor%3A%20remove%20%60OnceLock%60/near/493324102" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.239992.20refactor.3A.20remove.20.60OnceLock.60.html#493324102">(Jan 13 2025 at 11:18)</a>:</h4>
<p><strong>JonasKruckenberg</strong> requested <a href="https://github.com/orgs/bytecodealliance/teams/wasmtime-default-reviewers">wasmtime-default-reviewers</a> for a review on <a href="https://github.com/bytecodealliance/wasmtime/pull/9992">PR #9992</a>.</p>



<a name="493324208"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%239992%20refactor%3A%20remove%20%60OnceLock%60/near/493324208" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.239992.20refactor.3A.20remove.20.60OnceLock.60.html#493324208">(Jan 13 2025 at 11:19)</a>:</h4>
<p>JonasKruckenberg edited <a href="https://github.com/bytecodealliance/wasmtime/pull/9992">PR #9992</a>:</p>
<blockquote>
<p>This PR is another attempt at #8489 (superseding it) this time by making the necessary changes in <code>regalloc2</code> (see <a href="https://github.com/bytecodealliance/regalloc2/pull/208">here</a>) to allow <code>MachineEnv</code> to be created in const expressions and therefore placed into statics without the need for lazy initialization (as mentioned in <a href="#narrow/channel/217117-cranelift/topic/Use.20in.20no_std/near/493078060">this comment</a>)<br>
This PR also makes the necessary changes in register creation functions to make them <code>const</code>.</p>
<p>While I agree with @cfallin that this is the "correct" move, it is slightly annoying that Rusts const limitation makes the static initializers so verbose where a <code>1..=16</code> range iterator was used previously, any ideas here are welcome :/</p>
<p>Edit: marked the PR as draft until the regalloc2 upstream PR is merged</p>
</blockquote>



<a name="493324429"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%239992%20refactor%3A%20remove%20%60OnceLock%60/near/493324429" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.239992.20refactor.3A.20remove.20.60OnceLock.60.html#493324429">(Jan 13 2025 at 11:20)</a>:</h4>
<p>JonasKruckenberg updated <a href="https://github.com/bytecodealliance/wasmtime/pull/9992">PR #9992</a>.</p>



<a name="493435345"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%239992%20refactor%3A%20remove%20%60OnceLock%60/near/493435345" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.239992.20refactor.3A.20remove.20.60OnceLock.60.html#493435345">(Jan 13 2025 at 19:54)</a>:</h4>
<p><strong>cfallin</strong> requested <a href="https://github.com/cfallin">cfallin</a> for a review on <a href="https://github.com/bytecodealliance/wasmtime/pull/9992">PR #9992</a>.</p>



<a name="493440750"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%239992%20refactor%3A%20remove%20%60OnceLock%60/near/493440750" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.239992.20refactor.3A.20remove.20.60OnceLock.60.html#493440750">(Jan 13 2025 at 20:22)</a>:</h4>
<p>cfallin created <a href="https://github.com/bytecodealliance/wasmtime/pull/9992#discussion_r1913760913">PR review comment</a>:</p>
<blockquote>
<p>This probably goes in the <code>PINNED_MACHINE_ENV</code> above, no? (It's load-bearing there that we get it right, because we <em>excluded</em> the pinned register from allocation; the default environment is used when pinning is disabled so doesn't care what the pinned reg is)</p>
</blockquote>



<a name="493440751"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%239992%20refactor%3A%20remove%20%60OnceLock%60/near/493440751" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.239992.20refactor.3A.20remove.20.60OnceLock.60.html#493440751">(Jan 13 2025 at 20:22)</a>:</h4>
<p>cfallin created <a href="https://github.com/bytecodealliance/wasmtime/pull/9992#discussion_r1913762387">PR review comment</a>:</p>
<blockquote>
<p>Can you say more here -- I'm not that familiar with the current state of constification of everything; is there some feature this is waiting on to stabilize or...?</p>
</blockquote>



<a name="493440753"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%239992%20refactor%3A%20remove%20%60OnceLock%60/near/493440753" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.239992.20refactor.3A.20remove.20.60OnceLock.60.html#493440753">(Jan 13 2025 at 20:22)</a>:</h4>
<p>cfallin submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/9992#pullrequestreview-2547786420">PR review</a>:</p>
<blockquote>
<p>Thanks a bunch for working on this! This all looks like the shape I expected; I'm glad there were no other hidden snags. A few minor comments below but otherwise happy to see this merged once we get the RA2 PR merged and released.</p>
</blockquote>



<a name="493462348"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%239992%20refactor%3A%20remove%20%60OnceLock%60/near/493462348" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.239992.20refactor.3A.20remove.20.60OnceLock.60.html#493462348">(Jan 13 2025 at 22:22)</a>:</h4>
<p>JonasKruckenberg submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/9992#pullrequestreview-2548070867">PR review</a>.</p>



<a name="493462349"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%239992%20refactor%3A%20remove%20%60OnceLock%60/near/493462349" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.239992.20refactor.3A.20remove.20.60OnceLock.60.html#493462349">(Jan 13 2025 at 22:22)</a>:</h4>
<p>JonasKruckenberg created <a href="https://github.com/bytecodealliance/wasmtime/pull/9992#discussion_r1913878608">PR review comment</a>:</p>
<blockquote>
<p>well, the feature that would be waiting for is const associated functions in traits (therefore allowing <code>From::from</code> to be const) but that afaik is in "never type land". I can remove the note as it doesn't make much sense to hold our breath on it </p>
</blockquote>



<a name="493462655"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%239992%20refactor%3A%20remove%20%60OnceLock%60/near/493462655" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.239992.20refactor.3A.20remove.20.60OnceLock.60.html#493462655">(Jan 13 2025 at 22:24)</a>:</h4>
<p>cfallin submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/9992#pullrequestreview-2548074760">PR review</a>.</p>



<a name="493462656"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%239992%20refactor%3A%20remove%20%60OnceLock%60/near/493462656" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.239992.20refactor.3A.20remove.20.60OnceLock.60.html#493462656">(Jan 13 2025 at 22:24)</a>:</h4>
<p>cfallin created <a href="https://github.com/bytecodealliance/wasmtime/pull/9992#discussion_r1913880377">PR review comment</a>:</p>
<blockquote>
<p>Yeah, I think that's best -- usually when we have a FIXME we want it to be actionable, or at least give sufficient context so that we know what we're waiting on (i.e.: if someone else walked up to this code tomorrow, would they know what they need in order to fix it?). It's fine to evaluate questions like this once new Rust features land in the future.</p>
</blockquote>



<a name="493469724"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%239992%20refactor%3A%20remove%20%60OnceLock%60/near/493469724" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.239992.20refactor.3A.20remove.20.60OnceLock.60.html#493469724">(Jan 13 2025 at 23:05)</a>:</h4>
<p>JonasKruckenberg submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/9992#pullrequestreview-2548153749">PR review</a>.</p>



<a name="493469725"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%239992%20refactor%3A%20remove%20%60OnceLock%60/near/493469725" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.239992.20refactor.3A.20remove.20.60OnceLock.60.html#493469725">(Jan 13 2025 at 23:05)</a>:</h4>
<p>JonasKruckenberg created <a href="https://github.com/bytecodealliance/wasmtime/pull/9992#discussion_r1913914662">PR review comment</a>:</p>
<blockquote>
<p>the issue with constness is that theres no good way to detect constness workarounds after the fact (the whole reason for the const-hack comments) but usually you'd tie them to specific RFCs yeah</p>
</blockquote>



<a name="493469984"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%239992%20refactor%3A%20remove%20%60OnceLock%60/near/493469984" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.239992.20refactor.3A.20remove.20.60OnceLock.60.html#493469984">(Jan 13 2025 at 23:07)</a>:</h4>
<p>JonasKruckenberg edited <a href="https://github.com/bytecodealliance/wasmtime/pull/9992#discussion_r1913914662">PR review comment</a>.</p>



<a name="493470064"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%239992%20refactor%3A%20remove%20%60OnceLock%60/near/493470064" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.239992.20refactor.3A.20remove.20.60OnceLock.60.html#493470064">(Jan 13 2025 at 23:07)</a>:</h4>
<p>JonasKruckenberg edited <a href="https://github.com/bytecodealliance/wasmtime/pull/9992#discussion_r1913914662">PR review comment</a>.</p>



<a name="493479891"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%239992%20refactor%3A%20remove%20%60OnceLock%60/near/493479891" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.239992.20refactor.3A.20remove.20.60OnceLock.60.html#493479891">(Jan 14 2025 at 00:18)</a>:</h4>
<p>hanna-kruppe submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/9992#pullrequestreview-2548277902">PR review</a>.</p>



<a name="493479892"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%239992%20refactor%3A%20remove%20%60OnceLock%60/near/493479892" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.239992.20refactor.3A.20remove.20.60OnceLock.60.html#493479892">(Jan 14 2025 at 00:18)</a>:</h4>
<p>hanna-kruppe created <a href="https://github.com/bytecodealliance/wasmtime/pull/9992#discussion_r1913957201">PR review comment</a>:</p>
<blockquote>
<p>Relevant RFC fresh off the press: <a href="https://github.com/rust-lang/rfcs/pull/3762">https://github.com/rust-lang/rfcs/pull/3762</a></p>
</blockquote>



<hr><p>Last updated: Jan 20 2025 at 06:04 UTC</p>
</html>