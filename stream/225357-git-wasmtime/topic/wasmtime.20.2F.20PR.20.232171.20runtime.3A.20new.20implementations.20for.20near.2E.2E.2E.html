<html>
<head><meta charset="utf-8"><title>wasmtime / PR #2171 runtime: new implementations for near... · git-wasmtime · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/index.html">git-wasmtime</a></h2>
<h3>Topic: <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232171.20runtime.3A.20new.20implementations.20for.20near.2E.2E.2E.html">wasmtime / PR #2171 runtime: new implementations for near...</a></h3>

<hr>

<base href="https://bytecodealliance.zulipchat.com">

<head><link href="https://bytecodealliance.github.io/zulip-archive/style.css" rel="stylesheet"></head>

<a name="208395548"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232171%20runtime%3A%20new%20implementations%20for%20near.../near/208395548" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232171.20runtime.3A.20new.20implementations.20for.20near.2E.2E.2E.html#208395548">(Aug 28 2020 at 21:12)</a>:</h4>
<p>MaxGraey edited <a href="https://github.com/bytecodealliance/wasmtime/pull/2171">PR #2171</a> from <code>new-nearest-functions</code> to <code>main</code>:</p>
<blockquote>
<p>More efficient implementations for <code>wasmtime_f32_nearest</code> and <code>wasmtime_f64_nearest</code> based on musl's <code>rint</code> and <code>rintf</code> implementations.</p>
<p>new / old comparison: <a href="https://godbolt.org/z/Gxz3bP">https://godbolt.org/z/Gxz3bP</a></p>
</blockquote>



<a name="208398108"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232171%20runtime%3A%20new%20implementations%20for%20near.../near/208398108" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232171.20runtime.3A.20new.20implementations.20for.20near.2E.2E.2E.html#208398108">(Aug 28 2020 at 21:42)</a>:</h4>
<p>MaxGraey edited <a href="https://github.com/bytecodealliance/wasmtime/pull/2171">PR #2171</a> from <code>new-nearest-functions</code> to <code>main</code>:</p>
<blockquote>
<p>More efficient implementations for <code>wasmtime_f32_nearest</code> and <code>wasmtime_f64_nearest</code> based on musl's <code>rint</code> and <code>rintf</code> implementations.</p>
<p>new / old comparison: <a href="https://godbolt.org/z/Gxz3bP">https://godbolt.org/z/Gxz3bP</a></p>
<p>Also instruction's metrics for new approach with if / else branch for handling <code>-0.0</code>:</p>
<div class="codehilite"><pre><span></span><code><span class="n">Iterations</span>:        <span class="mi">100</span><span class="w"></span>
<span class="n">Instructions</span>:      <span class="mi">1900</span><span class="w"></span>
<span class="n">Total</span><span class="w"> </span><span class="n">Cycles</span>:      <span class="mi">1611</span><span class="w"></span>
<span class="n">Total</span><span class="w"> </span><span class="n">uOps</span>:        <span class="mi">2900</span><span class="w"></span>


<span class="n">Dispatch</span><span class="w"> </span><span class="n">Width</span>:    <span class="mi">6</span><span class="w"></span>
<span class="n">uOps</span><span class="w"> </span><span class="n">Per</span><span class="w"> </span><span class="n">Cycle</span>:    <span class="mf">1.80</span><span class="w"></span>
<span class="n">IPC</span>:               <span class="mf">1.18</span><span class="w"></span>
<span class="n">Block</span><span class="w"> </span><span class="n">RThroughput</span>: <span class="mf">4.8</span><span class="w"></span>
</code></pre></div>


<p>and with new approach but <a href="https://godbolt.org/z/sK93zd">using <code>copysign</code> at the end for handling <code>-0.0</code></a>:</p>
<div class="codehilite"><pre><span></span><code><span class="n">Iterations</span>:        <span class="mi">100</span><span class="w"></span>
<span class="n">Instructions</span>:      <span class="mi">1800</span><span class="w"></span>
<span class="n">Total</span><span class="w"> </span><span class="n">Cycles</span>:      <span class="mi">1308</span><span class="w"></span>
<span class="n">Total</span><span class="w"> </span><span class="n">uOps</span>:        <span class="mi">2200</span><span class="w"></span>

<span class="n">Dispatch</span><span class="w"> </span><span class="n">Width</span>:    <span class="mi">6</span><span class="w"></span>
<span class="n">uOps</span><span class="w"> </span><span class="n">Per</span><span class="w"> </span><span class="n">Cycle</span>:    <span class="mf">1.68</span><span class="w"></span>
<span class="n">IPC</span>:               <span class="mf">1.38</span><span class="w"></span>
<span class="n">Block</span><span class="w"> </span><span class="n">RThroughput</span>: <span class="mf">3.7</span><span class="w"></span>
</code></pre></div>


<p>So I guess second approach <code>with copysign</code> more preferable. wdyt?</p>
</blockquote>



<a name="208398924"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232171%20runtime%3A%20new%20implementations%20for%20near.../near/208398924" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232171.20runtime.3A.20new.20implementations.20for.20near.2E.2E.2E.html#208398924">(Aug 28 2020 at 21:53)</a>:</h4>
<p>MaxGraey updated <a href="https://github.com/bytecodealliance/wasmtime/pull/2171">PR #2171</a> from <code>new-nearest-functions</code> to <code>main</code>:</p>
<blockquote>
<p>More efficient implementations for <code>wasmtime_f32_nearest</code> and <code>wasmtime_f64_nearest</code> based on musl's <code>rint</code> and <code>rintf</code> implementations.</p>
<p>new / old comparison: <a href="https://godbolt.org/z/Gxz3bP">https://godbolt.org/z/Gxz3bP</a></p>
<p>Also instruction's metrics for new approach with if / else branch for handling <code>-0.0</code>:</p>
<div class="codehilite"><pre><span></span><code><span class="n">Iterations</span>:        <span class="mi">100</span><span class="w"></span>
<span class="n">Instructions</span>:      <span class="mi">1900</span><span class="w"></span>
<span class="n">Total</span><span class="w"> </span><span class="n">Cycles</span>:      <span class="mi">1611</span><span class="w"></span>
<span class="n">Total</span><span class="w"> </span><span class="n">uOps</span>:        <span class="mi">2900</span><span class="w"></span>


<span class="n">Dispatch</span><span class="w"> </span><span class="n">Width</span>:    <span class="mi">6</span><span class="w"></span>
<span class="n">uOps</span><span class="w"> </span><span class="n">Per</span><span class="w"> </span><span class="n">Cycle</span>:    <span class="mf">1.80</span><span class="w"></span>
<span class="n">IPC</span>:               <span class="mf">1.18</span><span class="w"></span>
<span class="n">Block</span><span class="w"> </span><span class="n">RThroughput</span>: <span class="mf">4.8</span><span class="w"></span>
</code></pre></div>


<p>and with new approach but <a href="https://godbolt.org/z/sK93zd">using <code>copysign</code> at the end for handling <code>-0.0</code></a>:</p>
<div class="codehilite"><pre><span></span><code><span class="n">Iterations</span>:        <span class="mi">100</span><span class="w"></span>
<span class="n">Instructions</span>:      <span class="mi">1800</span><span class="w"></span>
<span class="n">Total</span><span class="w"> </span><span class="n">Cycles</span>:      <span class="mi">1308</span><span class="w"></span>
<span class="n">Total</span><span class="w"> </span><span class="n">uOps</span>:        <span class="mi">2200</span><span class="w"></span>

<span class="n">Dispatch</span><span class="w"> </span><span class="n">Width</span>:    <span class="mi">6</span><span class="w"></span>
<span class="n">uOps</span><span class="w"> </span><span class="n">Per</span><span class="w"> </span><span class="n">Cycle</span>:    <span class="mf">1.68</span><span class="w"></span>
<span class="n">IPC</span>:               <span class="mf">1.38</span><span class="w"></span>
<span class="n">Block</span><span class="w"> </span><span class="n">RThroughput</span>: <span class="mf">3.7</span><span class="w"></span>
</code></pre></div>


<p>So I guess second approach <code>with copysign</code> more preferable. wdyt?</p>
</blockquote>



<a name="208399004"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232171%20runtime%3A%20new%20implementations%20for%20near.../near/208399004" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232171.20runtime.3A.20new.20implementations.20for.20near.2E.2E.2E.html#208399004">(Aug 28 2020 at 21:54)</a>:</h4>
<p>MaxGraey edited <a href="https://github.com/bytecodealliance/wasmtime/pull/2171">PR #2171</a> from <code>new-nearest-functions</code> to <code>main</code>:</p>
<blockquote>
<p>More efficient implementations for <code>wasmtime_f32_nearest</code> and <code>wasmtime_f64_nearest</code> based on musl's <code>rint</code> and <code>rintf</code> implementations.</p>
<p>new / old comparison: <a href="https://godbolt.org/z/Gxz3bP">https://godbolt.org/z/Gxz3bP</a></p>
<p>Also instruction's metrics for new approach with if / else branch for handling <code>-0.0</code>:</p>
<div class="codehilite"><pre><span></span><code><span class="n">Iterations</span>:        <span class="mi">100</span><span class="w"></span>
<span class="n">Instructions</span>:      <span class="mi">1900</span><span class="w"></span>
<span class="n">Total</span><span class="w"> </span><span class="n">Cycles</span>:      <span class="mi">1611</span><span class="w"></span>
<span class="n">Total</span><span class="w"> </span><span class="n">uOps</span>:        <span class="mi">2900</span><span class="w"></span>


<span class="n">Dispatch</span><span class="w"> </span><span class="n">Width</span>:    <span class="mi">6</span><span class="w"></span>
<span class="n">uOps</span><span class="w"> </span><span class="n">Per</span><span class="w"> </span><span class="n">Cycle</span>:    <span class="mf">1.80</span><span class="w"></span>
<span class="n">IPC</span>:               <span class="mf">1.18</span><span class="w"></span>
<span class="n">Block</span><span class="w"> </span><span class="n">RThroughput</span>: <span class="mf">4.8</span><span class="w"></span>
</code></pre></div>


<p>and with new approach but <a href="https://godbolt.org/z/sK93zd">using <code>copysign</code> at the end for handling <code>-0.0</code></a>:</p>
<div class="codehilite"><pre><span></span><code><span class="n">Iterations</span>:        <span class="mi">100</span><span class="w"></span>
<span class="n">Instructions</span>:      <span class="mi">1800</span><span class="w"></span>
<span class="n">Total</span><span class="w"> </span><span class="n">Cycles</span>:      <span class="mi">1308</span><span class="w"></span>
<span class="n">Total</span><span class="w"> </span><span class="n">uOps</span>:        <span class="mi">2200</span><span class="w"></span>

<span class="n">Dispatch</span><span class="w"> </span><span class="n">Width</span>:    <span class="mi">6</span><span class="w"></span>
<span class="n">uOps</span><span class="w"> </span><span class="n">Per</span><span class="w"> </span><span class="n">Cycle</span>:    <span class="mf">1.68</span><span class="w"></span>
<span class="n">IPC</span>:               <span class="mf">1.38</span><span class="w"></span>
<span class="n">Block</span><span class="w"> </span><span class="n">RThroughput</span>: <span class="mf">3.7</span><span class="w"></span>
</code></pre></div>


<p><strong>Upd</strong> So I chose the second approach</p>
</blockquote>



<a name="208399068"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232171%20runtime%3A%20new%20implementations%20for%20near.../near/208399068" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232171.20runtime.3A.20new.20implementations.20for.20near.2E.2E.2E.html#208399068">(Aug 28 2020 at 21:55)</a>:</h4>
<p>MaxGraey updated <a href="https://github.com/bytecodealliance/wasmtime/pull/2171">PR #2171</a> from <code>new-nearest-functions</code> to <code>main</code>:</p>
<blockquote>
<p>More efficient implementations for <code>wasmtime_f32_nearest</code> and <code>wasmtime_f64_nearest</code> based on musl's <code>rint</code> and <code>rintf</code> implementations.</p>
<p>new / old comparison: <a href="https://godbolt.org/z/Gxz3bP">https://godbolt.org/z/Gxz3bP</a></p>
<p>Also instruction's metrics for new approach with if / else branch for handling <code>-0.0</code>:</p>
<div class="codehilite"><pre><span></span><code><span class="n">Iterations</span>:        <span class="mi">100</span><span class="w"></span>
<span class="n">Instructions</span>:      <span class="mi">1900</span><span class="w"></span>
<span class="n">Total</span><span class="w"> </span><span class="n">Cycles</span>:      <span class="mi">1611</span><span class="w"></span>
<span class="n">Total</span><span class="w"> </span><span class="n">uOps</span>:        <span class="mi">2900</span><span class="w"></span>


<span class="n">Dispatch</span><span class="w"> </span><span class="n">Width</span>:    <span class="mi">6</span><span class="w"></span>
<span class="n">uOps</span><span class="w"> </span><span class="n">Per</span><span class="w"> </span><span class="n">Cycle</span>:    <span class="mf">1.80</span><span class="w"></span>
<span class="n">IPC</span>:               <span class="mf">1.18</span><span class="w"></span>
<span class="n">Block</span><span class="w"> </span><span class="n">RThroughput</span>: <span class="mf">4.8</span><span class="w"></span>
</code></pre></div>


<p>and with new approach but <a href="https://godbolt.org/z/sK93zd">using <code>copysign</code> at the end for handling <code>-0.0</code></a>:</p>
<div class="codehilite"><pre><span></span><code><span class="n">Iterations</span>:        <span class="mi">100</span><span class="w"></span>
<span class="n">Instructions</span>:      <span class="mi">1800</span><span class="w"></span>
<span class="n">Total</span><span class="w"> </span><span class="n">Cycles</span>:      <span class="mi">1308</span><span class="w"></span>
<span class="n">Total</span><span class="w"> </span><span class="n">uOps</span>:        <span class="mi">2200</span><span class="w"></span>

<span class="n">Dispatch</span><span class="w"> </span><span class="n">Width</span>:    <span class="mi">6</span><span class="w"></span>
<span class="n">uOps</span><span class="w"> </span><span class="n">Per</span><span class="w"> </span><span class="n">Cycle</span>:    <span class="mf">1.68</span><span class="w"></span>
<span class="n">IPC</span>:               <span class="mf">1.38</span><span class="w"></span>
<span class="n">Block</span><span class="w"> </span><span class="n">RThroughput</span>: <span class="mf">3.7</span><span class="w"></span>
</code></pre></div>


<p><strong>Upd</strong> So I chose the second approach</p>
</blockquote>



<a name="208400487"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232171%20runtime%3A%20new%20implementations%20for%20near.../near/208400487" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232171.20runtime.3A.20new.20implementations.20for.20near.2E.2E.2E.html#208400487">(Aug 28 2020 at 22:14)</a>:</h4>
<p>MaxGraey edited <a href="https://github.com/bytecodealliance/wasmtime/pull/2171">PR #2171</a> from <code>new-nearest-functions</code> to <code>main</code>:</p>
<blockquote>
<p>More efficient implementations for <code>wasmtime_f32_nearest</code> and <code>wasmtime_f64_nearest</code> based on musl's <code>rint</code> and <code>rintf</code> implementations.</p>
<p>new / old comparison: <a href="https://godbolt.org/z/Gxz3bP">https://godbolt.org/z/Gxz3bP</a></p>
<p>Also instruction's metrics for new approach with if / else branch for handling <code>-0.0</code>:</p>
<div class="codehilite"><pre><span></span><code><span class="n">Iterations</span>:        <span class="mi">100</span><span class="w"></span>
<span class="n">Instructions</span>:      <span class="mi">1900</span><span class="w"></span>
<span class="n">Total</span><span class="w"> </span><span class="n">Cycles</span>:      <span class="mi">1611</span><span class="w"></span>
<span class="n">Total</span><span class="w"> </span><span class="n">uOps</span>:        <span class="mi">2900</span><span class="w"></span>


<span class="n">Dispatch</span><span class="w"> </span><span class="n">Width</span>:    <span class="mi">6</span><span class="w"></span>
<span class="n">uOps</span><span class="w"> </span><span class="n">Per</span><span class="w"> </span><span class="n">Cycle</span>:    <span class="mf">1.80</span><span class="w"></span>
<span class="n">IPC</span>:               <span class="mf">1.18</span><span class="w"></span>
<span class="n">Block</span><span class="w"> </span><span class="n">RThroughput</span>: <span class="mf">4.8</span><span class="w"></span>
</code></pre></div>


<p>and with new approach but <a href="https://godbolt.org/z/sK93zd">using <code>copysign</code> at the end for handling <code>-0.0</code></a>:</p>
<div class="codehilite"><pre><span></span><code><span class="n">Iterations</span>:        <span class="mi">100</span><span class="w"></span>
<span class="n">Instructions</span>:      <span class="mi">1800</span><span class="w"></span>
<span class="n">Total</span><span class="w"> </span><span class="n">Cycles</span>:      <span class="mi">1308</span><span class="w"></span>
<span class="n">Total</span><span class="w"> </span><span class="n">uOps</span>:        <span class="mi">2200</span><span class="w"></span>

<span class="n">Dispatch</span><span class="w"> </span><span class="n">Width</span>:    <span class="mi">6</span><span class="w"></span>
<span class="n">uOps</span><span class="w"> </span><span class="n">Per</span><span class="w"> </span><span class="n">Cycle</span>:    <span class="mf">1.68</span><span class="w"></span>
<span class="n">IPC</span>:               <span class="mf">1.38</span><span class="w"></span>
<span class="n">Block</span><span class="w"> </span><span class="n">RThroughput</span>: <span class="mf">3.7</span><span class="w"></span>
</code></pre></div>


<p><strong>Upd</strong> So I chose the second approach. Also it <a href="https://godbolt.org/z/W3d7af">branchless on ARM</a></p>
</blockquote>



<a name="208401335"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232171%20runtime%3A%20new%20implementations%20for%20near.../near/208401335" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232171.20runtime.3A.20new.20implementations.20for.20near.2E.2E.2E.html#208401335">(Aug 28 2020 at 22:27)</a>:</h4>
<p>MaxGraey edited <a href="https://github.com/bytecodealliance/wasmtime/pull/2171">PR #2171</a> from <code>new-nearest-functions</code> to <code>main</code>:</p>
<blockquote>
<p>More efficient implementations for <code>wasmtime_f32_nearest</code> and <code>wasmtime_f64_nearest</code> based on musl's <code>rint</code> and <code>rintf</code> implementations.</p>
<p>new / old comparison: <a href="https://godbolt.org/z/Gxz3bP">https://godbolt.org/z/Gxz3bP</a></p>
<p>Also instruction's metrics for new approach with if / else branch for handling <code>-0.0</code>:</p>
<div class="codehilite"><pre><span></span><code><span class="n">Iterations</span>:        <span class="mi">100</span><span class="w"></span>
<span class="n">Instructions</span>:      <span class="mi">1900</span><span class="w"></span>
<span class="n">Total</span><span class="w"> </span><span class="n">Cycles</span>:      <span class="mi">1611</span><span class="w"></span>
<span class="n">Total</span><span class="w"> </span><span class="n">uOps</span>:        <span class="mi">2900</span><span class="w"></span>


<span class="n">Dispatch</span><span class="w"> </span><span class="n">Width</span>:    <span class="mi">6</span><span class="w"></span>
<span class="n">uOps</span><span class="w"> </span><span class="n">Per</span><span class="w"> </span><span class="n">Cycle</span>:    <span class="mf">1.80</span><span class="w"></span>
<span class="n">IPC</span>:               <span class="mf">1.18</span><span class="w"></span>
<span class="n">Block</span><span class="w"> </span><span class="n">RThroughput</span>: <span class="mf">4.8</span><span class="w"></span>
</code></pre></div>


<p>and with new approach but <a href="https://godbolt.org/z/sK93zd">using <code>copysign</code> at the end for handling <code>-0.0</code></a>:</p>
<div class="codehilite"><pre><span></span><code><span class="n">Iterations</span>:        <span class="mi">100</span><span class="w"></span>
<span class="n">Instructions</span>:      <span class="mi">1800</span><span class="w"></span>
<span class="n">Total</span><span class="w"> </span><span class="n">Cycles</span>:      <span class="mi">1308</span><span class="w"></span>
<span class="n">Total</span><span class="w"> </span><span class="n">uOps</span>:        <span class="mi">2200</span><span class="w"></span>

<span class="n">Dispatch</span><span class="w"> </span><span class="n">Width</span>:    <span class="mi">6</span><span class="w"></span>
<span class="n">uOps</span><span class="w"> </span><span class="n">Per</span><span class="w"> </span><span class="n">Cycle</span>:    <span class="mf">1.68</span><span class="w"></span>
<span class="n">IPC</span>:               <span class="mf">1.38</span><span class="w"></span>
<span class="n">Block</span><span class="w"> </span><span class="n">RThroughput</span>: <span class="mf">3.7</span><span class="w"></span>
</code></pre></div>


<p><strong>Upd</strong> So I chose the second approach. Also it <a href="https://godbolt.org/z/W3d7af">branchless on ARM32</a></p>
</blockquote>



<a name="208404488"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232171%20runtime%3A%20new%20implementations%20for%20near.../near/208404488" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232171.20runtime.3A.20new.20implementations.20for.20near.2E.2E.2E.html#208404488">(Aug 28 2020 at 23:13)</a>:</h4>
<p>MaxGraey edited <a href="https://github.com/bytecodealliance/wasmtime/pull/2171">PR #2171</a> from <code>new-nearest-functions</code> to <code>main</code>:</p>
<blockquote>
<p>More efficient implementations for <code>wasmtime_f32_nearest</code> and <code>wasmtime_f64_nearest</code> based on musl's <code>rint</code> and <code>rintf</code> implementations.</p>
<p>new / old comparison: <a href="https://godbolt.org/z/Gxz3bP">https://godbolt.org/z/Gxz3bP</a></p>
<p>Also instruction's metrics for new approach with if / else branch for handling <code>-0.0</code>:</p>
<div class="codehilite"><pre><span></span><code><span class="n">Iterations</span>:        <span class="mi">100</span><span class="w"></span>
<span class="n">Instructions</span>:      <span class="mi">1900</span><span class="w"></span>
<span class="n">Total</span><span class="w"> </span><span class="n">Cycles</span>:      <span class="mi">1611</span><span class="w"></span>
<span class="n">Total</span><span class="w"> </span><span class="n">uOps</span>:        <span class="mi">2900</span><span class="w"></span>


<span class="n">Dispatch</span><span class="w"> </span><span class="n">Width</span>:    <span class="mi">6</span><span class="w"></span>
<span class="n">uOps</span><span class="w"> </span><span class="n">Per</span><span class="w"> </span><span class="n">Cycle</span>:    <span class="mf">1.80</span><span class="w"></span>
<span class="n">IPC</span>:               <span class="mf">1.18</span><span class="w"></span>
<span class="n">Block</span><span class="w"> </span><span class="n">RThroughput</span>: <span class="mf">4.8</span><span class="w"></span>
</code></pre></div>


<p>and with new approach but <a href="https://godbolt.org/z/sK93zd">using <code>copysign</code> at the end for handling <code>-0.0</code></a>:</p>
<div class="codehilite"><pre><span></span><code><span class="n">Iterations</span>:        <span class="mi">100</span><span class="w"></span>
<span class="n">Instructions</span>:      <span class="mi">1800</span><span class="w"></span>
<span class="n">Total</span><span class="w"> </span><span class="n">Cycles</span>:      <span class="mi">1308</span><span class="w"></span>
<span class="n">Total</span><span class="w"> </span><span class="n">uOps</span>:        <span class="mi">2200</span><span class="w"></span>

<span class="n">Dispatch</span><span class="w"> </span><span class="n">Width</span>:    <span class="mi">6</span><span class="w"></span>
<span class="n">uOps</span><span class="w"> </span><span class="n">Per</span><span class="w"> </span><span class="n">Cycle</span>:    <span class="mf">1.68</span><span class="w"></span>
<span class="n">IPC</span>:               <span class="mf">1.38</span><span class="w"></span>
<span class="n">Block</span><span class="w"> </span><span class="n">RThroughput</span>: <span class="mf">3.7</span><span class="w"></span>
</code></pre></div>


<p><strong>Upd</strong> So I chose the second approach. Also it <a href="https://godbolt.org/z/W3d7af">branchless on ARM32</a></p>
<p>Another possible approach:</p>
<div class="codehilite"><pre><span></span><code><span class="k">pub</span><span class="w"> </span><span class="k">extern</span><span class="w"> </span><span class="s">&quot;C&quot;</span><span class="w"> </span><span class="k">fn</span> <span class="nf">nearest_new_3</span><span class="p">(</span><span class="n">x</span>: <span class="kt">f64</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="kt">f64</span> <span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">x</span><span class="p">.</span><span class="n">to_bits</span><span class="p">();</span><span class="w"></span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">e</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="mi">52</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="mh">0x7ff_</span><span class="k">u64</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="n">e</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="mh">0x3ff_</span><span class="k">u64</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">52</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">x</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="p">(</span><span class="n">x</span><span class="p">.</span><span class="n">abs</span><span class="p">()</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">TOINT</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">TOINT</span><span class="p">).</span><span class="n">copysign</span><span class="p">(</span><span class="n">x</span><span class="p">)</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>


</blockquote>



<a name="208404496"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232171%20runtime%3A%20new%20implementations%20for%20near.../near/208404496" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232171.20runtime.3A.20new.20implementations.20for.20near.2E.2E.2E.html#208404496">(Aug 28 2020 at 23:13)</a>:</h4>
<p>MaxGraey edited <a href="https://github.com/bytecodealliance/wasmtime/pull/2171">PR #2171</a> from <code>new-nearest-functions</code> to <code>main</code>:</p>
<blockquote>
<p>More efficient implementations for <code>wasmtime_f32_nearest</code> and <code>wasmtime_f64_nearest</code> based on musl's <code>rint</code> and <code>rintf</code> implementations.</p>
<p>new / old comparison: <a href="https://godbolt.org/z/Gxz3bP">https://godbolt.org/z/Gxz3bP</a></p>
<p>Also instruction's metrics for new approach with if / else branch for handling <code>-0.0</code>:</p>
<div class="codehilite"><pre><span></span><code><span class="n">Iterations</span>:        <span class="mi">100</span><span class="w"></span>
<span class="n">Instructions</span>:      <span class="mi">1900</span><span class="w"></span>
<span class="n">Total</span><span class="w"> </span><span class="n">Cycles</span>:      <span class="mi">1611</span><span class="w"></span>
<span class="n">Total</span><span class="w"> </span><span class="n">uOps</span>:        <span class="mi">2900</span><span class="w"></span>


<span class="n">Dispatch</span><span class="w"> </span><span class="n">Width</span>:    <span class="mi">6</span><span class="w"></span>
<span class="n">uOps</span><span class="w"> </span><span class="n">Per</span><span class="w"> </span><span class="n">Cycle</span>:    <span class="mf">1.80</span><span class="w"></span>
<span class="n">IPC</span>:               <span class="mf">1.18</span><span class="w"></span>
<span class="n">Block</span><span class="w"> </span><span class="n">RThroughput</span>: <span class="mf">4.8</span><span class="w"></span>
</code></pre></div>


<p>and with new approach but <a href="https://godbolt.org/z/sK93zd">using <code>copysign</code> at the end for handling <code>-0.0</code></a>:</p>
<div class="codehilite"><pre><span></span><code><span class="n">Iterations</span>:        <span class="mi">100</span><span class="w"></span>
<span class="n">Instructions</span>:      <span class="mi">1800</span><span class="w"></span>
<span class="n">Total</span><span class="w"> </span><span class="n">Cycles</span>:      <span class="mi">1308</span><span class="w"></span>
<span class="n">Total</span><span class="w"> </span><span class="n">uOps</span>:        <span class="mi">2200</span><span class="w"></span>

<span class="n">Dispatch</span><span class="w"> </span><span class="n">Width</span>:    <span class="mi">6</span><span class="w"></span>
<span class="n">uOps</span><span class="w"> </span><span class="n">Per</span><span class="w"> </span><span class="n">Cycle</span>:    <span class="mf">1.68</span><span class="w"></span>
<span class="n">IPC</span>:               <span class="mf">1.38</span><span class="w"></span>
<span class="n">Block</span><span class="w"> </span><span class="n">RThroughput</span>: <span class="mf">3.7</span><span class="w"></span>
</code></pre></div>


<p><strong>Upd</strong> So I chose the second approach. Also it <a href="https://godbolt.org/z/W3d7af">branchless on ARM32</a></p>
<p>Another possible approach:</p>
<div class="codehilite"><pre><span></span><code><span class="k">pub</span><span class="w"> </span><span class="k">extern</span><span class="w"> </span><span class="s">&quot;C&quot;</span><span class="w"> </span><span class="k">fn</span> <span class="nf">nearest</span><span class="p">(</span><span class="n">x</span>: <span class="kt">f64</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="kt">f64</span> <span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">x</span><span class="p">.</span><span class="n">to_bits</span><span class="p">();</span><span class="w"></span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">e</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="mi">52</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="mh">0x7ff_</span><span class="k">u64</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="n">e</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="mh">0x3ff_</span><span class="k">u64</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">52</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">x</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="p">(</span><span class="n">x</span><span class="p">.</span><span class="n">abs</span><span class="p">()</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">TOINT</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">TOINT</span><span class="p">).</span><span class="n">copysign</span><span class="p">(</span><span class="n">x</span><span class="p">)</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>


</blockquote>



<a name="208404504"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232171%20runtime%3A%20new%20implementations%20for%20near.../near/208404504" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232171.20runtime.3A.20new.20implementations.20for.20near.2E.2E.2E.html#208404504">(Aug 28 2020 at 23:13)</a>:</h4>
<p>MaxGraey edited <a href="https://github.com/bytecodealliance/wasmtime/pull/2171">PR #2171</a> from <code>new-nearest-functions</code> to <code>main</code>:</p>
<blockquote>
<p>More efficient implementations for <code>wasmtime_f32_nearest</code> and <code>wasmtime_f64_nearest</code> based on musl's <code>rint</code> and <code>rintf</code> implementations.</p>
<p>new / old comparison: <a href="https://godbolt.org/z/Gxz3bP">https://godbolt.org/z/Gxz3bP</a></p>
<p>Also instruction's metrics for new approach with if / else branch for handling <code>-0.0</code>:</p>
<div class="codehilite"><pre><span></span><code><span class="n">Iterations</span>:        <span class="mi">100</span><span class="w"></span>
<span class="n">Instructions</span>:      <span class="mi">1900</span><span class="w"></span>
<span class="n">Total</span><span class="w"> </span><span class="n">Cycles</span>:      <span class="mi">1611</span><span class="w"></span>
<span class="n">Total</span><span class="w"> </span><span class="n">uOps</span>:        <span class="mi">2900</span><span class="w"></span>


<span class="n">Dispatch</span><span class="w"> </span><span class="n">Width</span>:    <span class="mi">6</span><span class="w"></span>
<span class="n">uOps</span><span class="w"> </span><span class="n">Per</span><span class="w"> </span><span class="n">Cycle</span>:    <span class="mf">1.80</span><span class="w"></span>
<span class="n">IPC</span>:               <span class="mf">1.18</span><span class="w"></span>
<span class="n">Block</span><span class="w"> </span><span class="n">RThroughput</span>: <span class="mf">4.8</span><span class="w"></span>
</code></pre></div>


<p>and with new approach but <a href="https://godbolt.org/z/sK93zd">using <code>copysign</code> at the end for handling <code>-0.0</code></a>:</p>
<div class="codehilite"><pre><span></span><code><span class="n">Iterations</span>:        <span class="mi">100</span><span class="w"></span>
<span class="n">Instructions</span>:      <span class="mi">1800</span><span class="w"></span>
<span class="n">Total</span><span class="w"> </span><span class="n">Cycles</span>:      <span class="mi">1308</span><span class="w"></span>
<span class="n">Total</span><span class="w"> </span><span class="n">uOps</span>:        <span class="mi">2200</span><span class="w"></span>

<span class="n">Dispatch</span><span class="w"> </span><span class="n">Width</span>:    <span class="mi">6</span><span class="w"></span>
<span class="n">uOps</span><span class="w"> </span><span class="n">Per</span><span class="w"> </span><span class="n">Cycle</span>:    <span class="mf">1.68</span><span class="w"></span>
<span class="n">IPC</span>:               <span class="mf">1.38</span><span class="w"></span>
<span class="n">Block</span><span class="w"> </span><span class="n">RThroughput</span>: <span class="mf">3.7</span><span class="w"></span>
</code></pre></div>


<p><strong>Upd</strong> So I chose the second approach. Also it <a href="https://godbolt.org/z/W3d7af">branchless on ARM32</a></p>
<p>Another possible approach:</p>
<div class="codehilite"><pre><span></span><code><span class="k">pub</span><span class="w"> </span><span class="k">extern</span><span class="w"> </span><span class="s">&quot;C&quot;</span><span class="w"> </span><span class="k">fn</span> <span class="nf">nearest</span><span class="p">(</span><span class="n">x</span>: <span class="kt">f64</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="kt">f64</span> <span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">x</span><span class="p">.</span><span class="n">to_bits</span><span class="p">();</span><span class="w"></span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">e</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="mi">52</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="mh">0x7ff_</span><span class="k">u64</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="n">e</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="mh">0x3ff_</span><span class="k">u64</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">52</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">x</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="p">(</span><span class="n">x</span><span class="p">.</span><span class="n">abs</span><span class="p">()</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">TOINT_64</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">TOINT_64</span><span class="p">).</span><span class="n">copysign</span><span class="p">(</span><span class="n">x</span><span class="p">)</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>


</blockquote>



<a name="208404568"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232171%20runtime%3A%20new%20implementations%20for%20near.../near/208404568" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232171.20runtime.3A.20new.20implementations.20for.20near.2E.2E.2E.html#208404568">(Aug 28 2020 at 23:14)</a>:</h4>
<p>MaxGraey edited <a href="https://github.com/bytecodealliance/wasmtime/pull/2171">PR #2171</a> from <code>new-nearest-functions</code> to <code>main</code>:</p>
<blockquote>
<p>More efficient implementations for <code>wasmtime_f32_nearest</code> and <code>wasmtime_f64_nearest</code> based on musl's <code>rint</code> and <code>rintf</code> implementations.</p>
<p>new / old comparison: <a href="https://godbolt.org/z/Gxz3bP">https://godbolt.org/z/Gxz3bP</a></p>
<p>Also instruction's metrics for new approach with if / else branch for handling <code>-0.0</code>:</p>
<div class="codehilite"><pre><span></span><code><span class="n">Iterations</span>:        <span class="mi">100</span><span class="w"></span>
<span class="n">Instructions</span>:      <span class="mi">1900</span><span class="w"></span>
<span class="n">Total</span><span class="w"> </span><span class="n">Cycles</span>:      <span class="mi">1611</span><span class="w"></span>
<span class="n">Total</span><span class="w"> </span><span class="n">uOps</span>:        <span class="mi">2900</span><span class="w"></span>


<span class="n">Dispatch</span><span class="w"> </span><span class="n">Width</span>:    <span class="mi">6</span><span class="w"></span>
<span class="n">uOps</span><span class="w"> </span><span class="n">Per</span><span class="w"> </span><span class="n">Cycle</span>:    <span class="mf">1.80</span><span class="w"></span>
<span class="n">IPC</span>:               <span class="mf">1.18</span><span class="w"></span>
<span class="n">Block</span><span class="w"> </span><span class="n">RThroughput</span>: <span class="mf">4.8</span><span class="w"></span>
</code></pre></div>


<p>and with new approach but <a href="https://godbolt.org/z/sK93zd">using <code>copysign</code> at the end for handling <code>-0.0</code></a>:</p>
<div class="codehilite"><pre><span></span><code><span class="n">Iterations</span>:        <span class="mi">100</span><span class="w"></span>
<span class="n">Instructions</span>:      <span class="mi">1800</span><span class="w"></span>
<span class="n">Total</span><span class="w"> </span><span class="n">Cycles</span>:      <span class="mi">1308</span><span class="w"></span>
<span class="n">Total</span><span class="w"> </span><span class="n">uOps</span>:        <span class="mi">2200</span><span class="w"></span>

<span class="n">Dispatch</span><span class="w"> </span><span class="n">Width</span>:    <span class="mi">6</span><span class="w"></span>
<span class="n">uOps</span><span class="w"> </span><span class="n">Per</span><span class="w"> </span><span class="n">Cycle</span>:    <span class="mf">1.68</span><span class="w"></span>
<span class="n">IPC</span>:               <span class="mf">1.38</span><span class="w"></span>
<span class="n">Block</span><span class="w"> </span><span class="n">RThroughput</span>: <span class="mf">3.7</span><span class="w"></span>
</code></pre></div>


<p><strong>Upd</strong> So I chose the second approach. Also it <a href="https://godbolt.org/z/W3d7af">branchless on ARM32</a></p>
<p>Another possible approach:</p>
<div class="codehilite"><pre><span></span><code><span class="k">pub</span><span class="w"> </span><span class="k">extern</span><span class="w"> </span><span class="s">&quot;C&quot;</span><span class="w"> </span><span class="k">fn</span> <span class="nf">nearest</span><span class="p">(</span><span class="n">x</span>: <span class="kt">f64</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="kt">f64</span> <span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">x</span><span class="p">.</span><span class="n">to_bits</span><span class="p">();</span><span class="w"></span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">e</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="mi">52</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="mh">0x7ff_</span><span class="k">u64</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="n">e</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="mh">0x3ff_</span><span class="k">u64</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">52</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="n">x</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="p">(</span><span class="n">x</span><span class="p">.</span><span class="n">abs</span><span class="p">()</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">TOINT_64</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">TOINT_64</span><span class="p">).</span><span class="n">copysign</span><span class="p">(</span><span class="n">x</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>


</blockquote>



<a name="208424080"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232171%20runtime%3A%20new%20implementations%20for%20near.../near/208424080" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232171.20runtime.3A.20new.20implementations.20for.20near.2E.2E.2E.html#208424080">(Aug 29 2020 at 08:38)</a>:</h4>
<p>MaxGraey edited <a href="https://github.com/bytecodealliance/wasmtime/pull/2171">PR #2171</a> from <code>new-nearest-functions</code> to <code>main</code>:</p>
<blockquote>
<p>More efficient implementations for <code>wasmtime_f32_nearest</code> and <code>wasmtime_f64_nearest</code> based on musl's <code>rint</code> and <code>rintf</code> implementations.</p>
<p>new / old comparison: <a href="https://godbolt.org/z/Gxz3bP">https://godbolt.org/z/Gxz3bP</a></p>
<p>Also instruction's metrics for new approach with if / else branch for handling <code>-0.0</code>:</p>
<div class="codehilite"><pre><span></span><code><span class="n">Iterations</span>:        <span class="mi">100</span><span class="w"></span>
<span class="n">Instructions</span>:      <span class="mi">1900</span><span class="w"></span>
<span class="n">Total</span><span class="w"> </span><span class="n">Cycles</span>:      <span class="mi">1611</span><span class="w"></span>
<span class="n">Total</span><span class="w"> </span><span class="n">uOps</span>:        <span class="mi">2900</span><span class="w"></span>


<span class="n">Dispatch</span><span class="w"> </span><span class="n">Width</span>:    <span class="mi">6</span><span class="w"></span>
<span class="n">uOps</span><span class="w"> </span><span class="n">Per</span><span class="w"> </span><span class="n">Cycle</span>:    <span class="mf">1.80</span><span class="w"></span>
<span class="n">IPC</span>:               <span class="mf">1.18</span><span class="w"></span>
<span class="n">Block</span><span class="w"> </span><span class="n">RThroughput</span>: <span class="mf">4.8</span><span class="w"></span>
</code></pre></div>


<p>and with new approach but <a href="https://godbolt.org/z/sK93zd">using <code>copysign</code> at the end for handling <code>-0.0</code></a>:</p>
<div class="codehilite"><pre><span></span><code><span class="n">Iterations</span>:        <span class="mi">100</span><span class="w"></span>
<span class="n">Instructions</span>:      <span class="mi">1800</span><span class="w"></span>
<span class="n">Total</span><span class="w"> </span><span class="n">Cycles</span>:      <span class="mi">1308</span><span class="w"></span>
<span class="n">Total</span><span class="w"> </span><span class="n">uOps</span>:        <span class="mi">2200</span><span class="w"></span>

<span class="n">Dispatch</span><span class="w"> </span><span class="n">Width</span>:    <span class="mi">6</span><span class="w"></span>
<span class="n">uOps</span><span class="w"> </span><span class="n">Per</span><span class="w"> </span><span class="n">Cycle</span>:    <span class="mf">1.68</span><span class="w"></span>
<span class="n">IPC</span>:               <span class="mf">1.38</span><span class="w"></span>
<span class="n">Block</span><span class="w"> </span><span class="n">RThroughput</span>: <span class="mf">3.7</span><span class="w"></span>
</code></pre></div>


<p><strong>Upd</strong> So I chose the second approach. Also it <a href="https://godbolt.org/z/W3d7af">branchless on ARM32</a></p>
<p>Another possible approach:</p>
<div class="codehilite"><pre><span></span><code><span class="k">pub</span><span class="w"> </span><span class="k">extern</span><span class="w"> </span><span class="s">&quot;C&quot;</span><span class="w"> </span><span class="k">fn</span> <span class="nf">nearest</span><span class="p">(</span><span class="n">x</span>: <span class="kt">f64</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="kt">f64</span> <span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">x</span><span class="p">.</span><span class="n">to_bits</span><span class="p">();</span><span class="w"></span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">e</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="mi">52</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="mh">0x7ff_</span><span class="k">u64</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="n">e</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="mh">0x3ff_</span><span class="k">u64</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">52</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="n">x</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="p">(</span><span class="n">x</span><span class="p">.</span><span class="n">abs</span><span class="p">()</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">TOINT_64</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">TOINT_64</span><span class="p">).</span><span class="n">copysign</span><span class="p">(</span><span class="n">x</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>


<p>But this approach has <a href="https://godbolt.org/z/4Mor4a">lower IPC</a></p>
</blockquote>



<a name="208424089"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232171%20runtime%3A%20new%20implementations%20for%20near.../near/208424089" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232171.20runtime.3A.20new.20implementations.20for.20near.2E.2E.2E.html#208424089">(Aug 29 2020 at 08:39)</a>:</h4>
<p>MaxGraey edited <a href="https://github.com/bytecodealliance/wasmtime/pull/2171">PR #2171</a> from <code>new-nearest-functions</code> to <code>main</code>:</p>
<blockquote>
<p>More efficient implementations for <code>wasmtime_f32_nearest</code> and <code>wasmtime_f64_nearest</code> based on musl's <code>rint</code> and <code>rintf</code> implementations.</p>
<p>new / old comparison: <a href="https://godbolt.org/z/Gxz3bP">https://godbolt.org/z/Gxz3bP</a></p>
<p>Also instruction's metrics for new approach with if / else branch for handling <code>-0.0</code>:</p>
<div class="codehilite"><pre><span></span><code><span class="n">Iterations</span>:        <span class="mi">100</span><span class="w"></span>
<span class="n">Instructions</span>:      <span class="mi">1900</span><span class="w"></span>
<span class="n">Total</span><span class="w"> </span><span class="n">Cycles</span>:      <span class="mi">1611</span><span class="w"></span>
<span class="n">Total</span><span class="w"> </span><span class="n">uOps</span>:        <span class="mi">2900</span><span class="w"></span>


<span class="n">Dispatch</span><span class="w"> </span><span class="n">Width</span>:    <span class="mi">6</span><span class="w"></span>
<span class="n">uOps</span><span class="w"> </span><span class="n">Per</span><span class="w"> </span><span class="n">Cycle</span>:    <span class="mf">1.80</span><span class="w"></span>
<span class="n">IPC</span>:               <span class="mf">1.18</span><span class="w"></span>
<span class="n">Block</span><span class="w"> </span><span class="n">RThroughput</span>: <span class="mf">4.8</span><span class="w"></span>
</code></pre></div>


<p>and with new approach but <a href="https://godbolt.org/z/sK93zd">using <code>copysign</code> at the end for handling <code>-0.0</code></a>:</p>
<div class="codehilite"><pre><span></span><code><span class="n">Iterations</span>:        <span class="mi">100</span><span class="w"></span>
<span class="n">Instructions</span>:      <span class="mi">1800</span><span class="w"></span>
<span class="n">Total</span><span class="w"> </span><span class="n">Cycles</span>:      <span class="mi">1308</span><span class="w"></span>
<span class="n">Total</span><span class="w"> </span><span class="n">uOps</span>:        <span class="mi">2200</span><span class="w"></span>

<span class="n">Dispatch</span><span class="w"> </span><span class="n">Width</span>:    <span class="mi">6</span><span class="w"></span>
<span class="n">uOps</span><span class="w"> </span><span class="n">Per</span><span class="w"> </span><span class="n">Cycle</span>:    <span class="mf">1.68</span><span class="w"></span>
<span class="n">IPC</span>:               <span class="mf">1.38</span><span class="w"></span>
<span class="n">Block</span><span class="w"> </span><span class="n">RThroughput</span>: <span class="mf">3.7</span><span class="w"></span>
</code></pre></div>


<p><strong>Upd</strong> So I chose the second approach. Also it <a href="https://godbolt.org/z/W3d7af">branchless on ARM32</a></p>
<p><strong>Upd 2</strong><br>
Another possible approach:</p>
<div class="codehilite"><pre><span></span><code><span class="k">pub</span><span class="w"> </span><span class="k">extern</span><span class="w"> </span><span class="s">&quot;C&quot;</span><span class="w"> </span><span class="k">fn</span> <span class="nf">nearest</span><span class="p">(</span><span class="n">x</span>: <span class="kt">f64</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="kt">f64</span> <span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">x</span><span class="p">.</span><span class="n">to_bits</span><span class="p">();</span><span class="w"></span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">e</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="mi">52</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="mh">0x7ff_</span><span class="k">u64</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="n">e</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="mh">0x3ff_</span><span class="k">u64</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">52</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="n">x</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="p">(</span><span class="n">x</span><span class="p">.</span><span class="n">abs</span><span class="p">()</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">TOINT_64</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">TOINT_64</span><span class="p">).</span><span class="n">copysign</span><span class="p">(</span><span class="n">x</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>


<p>But this approach has <a href="https://godbolt.org/z/4Mor4a">lower IPC</a></p>
</blockquote>



<a name="208453798"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232171%20runtime%3A%20new%20implementations%20for%20near.../near/208453798" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232171.20runtime.3A.20new.20implementations.20for.20near.2E.2E.2E.html#208453798">(Aug 29 2020 at 21:01)</a>:</h4>
<p>MaxGraey edited <a href="https://github.com/bytecodealliance/wasmtime/pull/2171">PR #2171</a> from <code>new-nearest-functions</code> to <code>main</code>:</p>
<blockquote>
<p>More efficient implementations for <code>wasmtime_f32_nearest</code> and <code>wasmtime_f64_nearest</code> based on musl's <code>rint</code> and <code>rintf</code> implementations.</p>
<p>new / old comparison: <a href="https://godbolt.org/z/Gxz3bP">https://godbolt.org/z/Gxz3bP</a></p>
<p>Also instruction's metrics for new approach with if / else branch for handling <code>-0.0</code>:</p>
<div class="codehilite"><pre><span></span><code><span class="n">Iterations</span>:        <span class="mi">100</span><span class="w"></span>
<span class="n">Instructions</span>:      <span class="mi">1900</span><span class="w"></span>
<span class="n">Total</span><span class="w"> </span><span class="n">Cycles</span>:      <span class="mi">1611</span><span class="w"></span>
<span class="n">Total</span><span class="w"> </span><span class="n">uOps</span>:        <span class="mi">2900</span><span class="w"></span>


<span class="n">Dispatch</span><span class="w"> </span><span class="n">Width</span>:    <span class="mi">6</span><span class="w"></span>
<span class="n">uOps</span><span class="w"> </span><span class="n">Per</span><span class="w"> </span><span class="n">Cycle</span>:    <span class="mf">1.80</span><span class="w"></span>
<span class="n">IPC</span>:               <span class="mf">1.18</span><span class="w"></span>
<span class="n">Block</span><span class="w"> </span><span class="n">RThroughput</span>: <span class="mf">4.8</span><span class="w"></span>
</code></pre></div>


<p>and with new approach but <a href="https://godbolt.org/z/sK93zd">using <code>copysign</code> at the end for handling <code>-0.0</code></a>:</p>
<div class="codehilite"><pre><span></span><code><span class="n">Iterations</span>:        <span class="mi">100</span><span class="w"></span>
<span class="n">Instructions</span>:      <span class="mi">1800</span><span class="w"></span>
<span class="n">Total</span><span class="w"> </span><span class="n">Cycles</span>:      <span class="mi">1308</span><span class="w"></span>
<span class="n">Total</span><span class="w"> </span><span class="n">uOps</span>:        <span class="mi">2200</span><span class="w"></span>

<span class="n">Dispatch</span><span class="w"> </span><span class="n">Width</span>:    <span class="mi">6</span><span class="w"></span>
<span class="n">uOps</span><span class="w"> </span><span class="n">Per</span><span class="w"> </span><span class="n">Cycle</span>:    <span class="mf">1.68</span><span class="w"></span>
<span class="n">IPC</span>:               <span class="mf">1.38</span><span class="w"></span>
<span class="n">Block</span><span class="w"> </span><span class="n">RThroughput</span>: <span class="mf">3.7</span><span class="w"></span>
</code></pre></div>


<p><a href="https://github.com/bytecodealliance/wasmtime/pull/2171#issuecomment-683339394">Benchmark results</a></p>
<p><strong>Upd</strong> So I chose the second approach. Also it <a href="https://godbolt.org/z/W3d7af">branchless on ARM32</a></p>
<p><strong>Upd 2</strong><br>
Another possible approach:</p>
<div class="codehilite"><pre><span></span><code><span class="k">pub</span><span class="w"> </span><span class="k">extern</span><span class="w"> </span><span class="s">&quot;C&quot;</span><span class="w"> </span><span class="k">fn</span> <span class="nf">nearest</span><span class="p">(</span><span class="n">x</span>: <span class="kt">f64</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="kt">f64</span> <span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">x</span><span class="p">.</span><span class="n">to_bits</span><span class="p">();</span><span class="w"></span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">e</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="mi">52</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="mh">0x7ff_</span><span class="k">u64</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="n">e</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="mh">0x3ff_</span><span class="k">u64</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">52</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="n">x</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="p">(</span><span class="n">x</span><span class="p">.</span><span class="n">abs</span><span class="p">()</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">TOINT_64</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">TOINT_64</span><span class="p">).</span><span class="n">copysign</span><span class="p">(</span><span class="n">x</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>


<p>But this approach has <a href="https://godbolt.org/z/4Mor4a">lower IPC</a></p>
</blockquote>



<a name="208478395"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232171%20runtime%3A%20new%20implementations%20for%20near.../near/208478395" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232171.20runtime.3A.20new.20implementations.20for.20near.2E.2E.2E.html#208478395">(Aug 30 2020 at 10:23)</a>:</h4>
<p>MaxGraey updated <a href="https://github.com/bytecodealliance/wasmtime/pull/2171">PR #2171</a> from <code>new-nearest-functions</code> to <code>main</code>:</p>
<blockquote>
<p>More efficient implementations for <code>wasmtime_f32_nearest</code> and <code>wasmtime_f64_nearest</code> based on musl's <code>rint</code> and <code>rintf</code> implementations.</p>
<p>new / old comparison: <a href="https://godbolt.org/z/Gxz3bP">https://godbolt.org/z/Gxz3bP</a></p>
<p>Also instruction's metrics for new approach with if / else branch for handling <code>-0.0</code>:</p>
<div class="codehilite"><pre><span></span><code><span class="n">Iterations</span>:        <span class="mi">100</span><span class="w"></span>
<span class="n">Instructions</span>:      <span class="mi">1900</span><span class="w"></span>
<span class="n">Total</span><span class="w"> </span><span class="n">Cycles</span>:      <span class="mi">1611</span><span class="w"></span>
<span class="n">Total</span><span class="w"> </span><span class="n">uOps</span>:        <span class="mi">2900</span><span class="w"></span>


<span class="n">Dispatch</span><span class="w"> </span><span class="n">Width</span>:    <span class="mi">6</span><span class="w"></span>
<span class="n">uOps</span><span class="w"> </span><span class="n">Per</span><span class="w"> </span><span class="n">Cycle</span>:    <span class="mf">1.80</span><span class="w"></span>
<span class="n">IPC</span>:               <span class="mf">1.18</span><span class="w"></span>
<span class="n">Block</span><span class="w"> </span><span class="n">RThroughput</span>: <span class="mf">4.8</span><span class="w"></span>
</code></pre></div>


<p>and with new approach but <a href="https://godbolt.org/z/sK93zd">using <code>copysign</code> at the end for handling <code>-0.0</code></a>:</p>
<div class="codehilite"><pre><span></span><code><span class="n">Iterations</span>:        <span class="mi">100</span><span class="w"></span>
<span class="n">Instructions</span>:      <span class="mi">1800</span><span class="w"></span>
<span class="n">Total</span><span class="w"> </span><span class="n">Cycles</span>:      <span class="mi">1308</span><span class="w"></span>
<span class="n">Total</span><span class="w"> </span><span class="n">uOps</span>:        <span class="mi">2200</span><span class="w"></span>

<span class="n">Dispatch</span><span class="w"> </span><span class="n">Width</span>:    <span class="mi">6</span><span class="w"></span>
<span class="n">uOps</span><span class="w"> </span><span class="n">Per</span><span class="w"> </span><span class="n">Cycle</span>:    <span class="mf">1.68</span><span class="w"></span>
<span class="n">IPC</span>:               <span class="mf">1.38</span><span class="w"></span>
<span class="n">Block</span><span class="w"> </span><span class="n">RThroughput</span>: <span class="mf">3.7</span><span class="w"></span>
</code></pre></div>


<p><a href="https://github.com/bytecodealliance/wasmtime/pull/2171#issuecomment-683339394">Benchmark results</a></p>
<p><strong>Upd</strong> So I chose the second approach. Also it <a href="https://godbolt.org/z/W3d7af">branchless on ARM32</a></p>
<p><strong>Upd 2</strong><br>
Another possible approach:</p>
<div class="codehilite"><pre><span></span><code><span class="k">pub</span><span class="w"> </span><span class="k">extern</span><span class="w"> </span><span class="s">&quot;C&quot;</span><span class="w"> </span><span class="k">fn</span> <span class="nf">nearest</span><span class="p">(</span><span class="n">x</span>: <span class="kt">f64</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="kt">f64</span> <span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">x</span><span class="p">.</span><span class="n">to_bits</span><span class="p">();</span><span class="w"></span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">e</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="mi">52</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="mh">0x7ff_</span><span class="k">u64</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="n">e</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="mh">0x3ff_</span><span class="k">u64</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">52</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="n">x</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="p">(</span><span class="n">x</span><span class="p">.</span><span class="n">abs</span><span class="p">()</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">TOINT_64</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">TOINT_64</span><span class="p">).</span><span class="n">copysign</span><span class="p">(</span><span class="n">x</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>


<p>But this approach has <a href="https://godbolt.org/z/4Mor4a">lower IPC</a></p>
</blockquote>



<a name="208479521"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232171%20runtime%3A%20new%20implementations%20for%20near.../near/208479521" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232171.20runtime.3A.20new.20implementations.20for.20near.2E.2E.2E.html#208479521">(Aug 30 2020 at 10:57)</a>:</h4>
<p>MaxGraey updated <a href="https://github.com/bytecodealliance/wasmtime/pull/2171">PR #2171</a> from <code>new-nearest-functions</code> to <code>main</code>:</p>
<blockquote>
<p>More efficient implementations for <code>wasmtime_f32_nearest</code> and <code>wasmtime_f64_nearest</code> based on musl's <code>rint</code> and <code>rintf</code> implementations.</p>
<p>new / old comparison: <a href="https://godbolt.org/z/Gxz3bP">https://godbolt.org/z/Gxz3bP</a></p>
<p>Also instruction's metrics for new approach with if / else branch for handling <code>-0.0</code>:</p>
<div class="codehilite"><pre><span></span><code><span class="n">Iterations</span>:        <span class="mi">100</span><span class="w"></span>
<span class="n">Instructions</span>:      <span class="mi">1900</span><span class="w"></span>
<span class="n">Total</span><span class="w"> </span><span class="n">Cycles</span>:      <span class="mi">1611</span><span class="w"></span>
<span class="n">Total</span><span class="w"> </span><span class="n">uOps</span>:        <span class="mi">2900</span><span class="w"></span>


<span class="n">Dispatch</span><span class="w"> </span><span class="n">Width</span>:    <span class="mi">6</span><span class="w"></span>
<span class="n">uOps</span><span class="w"> </span><span class="n">Per</span><span class="w"> </span><span class="n">Cycle</span>:    <span class="mf">1.80</span><span class="w"></span>
<span class="n">IPC</span>:               <span class="mf">1.18</span><span class="w"></span>
<span class="n">Block</span><span class="w"> </span><span class="n">RThroughput</span>: <span class="mf">4.8</span><span class="w"></span>
</code></pre></div>


<p>and with new approach but <a href="https://godbolt.org/z/sK93zd">using <code>copysign</code> at the end for handling <code>-0.0</code></a>:</p>
<div class="codehilite"><pre><span></span><code><span class="n">Iterations</span>:        <span class="mi">100</span><span class="w"></span>
<span class="n">Instructions</span>:      <span class="mi">1800</span><span class="w"></span>
<span class="n">Total</span><span class="w"> </span><span class="n">Cycles</span>:      <span class="mi">1308</span><span class="w"></span>
<span class="n">Total</span><span class="w"> </span><span class="n">uOps</span>:        <span class="mi">2200</span><span class="w"></span>

<span class="n">Dispatch</span><span class="w"> </span><span class="n">Width</span>:    <span class="mi">6</span><span class="w"></span>
<span class="n">uOps</span><span class="w"> </span><span class="n">Per</span><span class="w"> </span><span class="n">Cycle</span>:    <span class="mf">1.68</span><span class="w"></span>
<span class="n">IPC</span>:               <span class="mf">1.38</span><span class="w"></span>
<span class="n">Block</span><span class="w"> </span><span class="n">RThroughput</span>: <span class="mf">3.7</span><span class="w"></span>
</code></pre></div>


<p><a href="https://github.com/bytecodealliance/wasmtime/pull/2171#issuecomment-683339394">Benchmark results</a></p>
<p><strong>Upd</strong> So I chose the second approach. Also it <a href="https://godbolt.org/z/W3d7af">branchless on ARM32</a></p>
<p><strong>Upd 2</strong><br>
Another possible approach:</p>
<div class="codehilite"><pre><span></span><code><span class="k">pub</span><span class="w"> </span><span class="k">extern</span><span class="w"> </span><span class="s">&quot;C&quot;</span><span class="w"> </span><span class="k">fn</span> <span class="nf">nearest</span><span class="p">(</span><span class="n">x</span>: <span class="kt">f64</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="kt">f64</span> <span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">x</span><span class="p">.</span><span class="n">to_bits</span><span class="p">();</span><span class="w"></span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">e</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="mi">52</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="mh">0x7ff_</span><span class="k">u64</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="n">e</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="mh">0x3ff_</span><span class="k">u64</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">52</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="n">x</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="p">(</span><span class="n">x</span><span class="p">.</span><span class="n">abs</span><span class="p">()</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">TOINT_64</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">TOINT_64</span><span class="p">).</span><span class="n">copysign</span><span class="p">(</span><span class="n">x</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>


<p>But this approach has <a href="https://godbolt.org/z/4Mor4a">lower IPC</a></p>
</blockquote>



<a name="208479732"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232171%20runtime%3A%20new%20implementations%20for%20near.../near/208479732" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232171.20runtime.3A.20new.20implementations.20for.20near.2E.2E.2E.html#208479732">(Aug 30 2020 at 11:02)</a>:</h4>
<p>MaxGraey updated <a href="https://github.com/bytecodealliance/wasmtime/pull/2171">PR #2171</a> from <code>new-nearest-functions</code> to <code>main</code>:</p>
<blockquote>
<p>More efficient implementations for <code>wasmtime_f32_nearest</code> and <code>wasmtime_f64_nearest</code> based on musl's <code>rint</code> and <code>rintf</code> implementations.</p>
<p>new / old comparison: <a href="https://godbolt.org/z/Gxz3bP">https://godbolt.org/z/Gxz3bP</a></p>
<p>Also instruction's metrics for new approach with if / else branch for handling <code>-0.0</code>:</p>
<div class="codehilite"><pre><span></span><code><span class="n">Iterations</span>:        <span class="mi">100</span><span class="w"></span>
<span class="n">Instructions</span>:      <span class="mi">1900</span><span class="w"></span>
<span class="n">Total</span><span class="w"> </span><span class="n">Cycles</span>:      <span class="mi">1611</span><span class="w"></span>
<span class="n">Total</span><span class="w"> </span><span class="n">uOps</span>:        <span class="mi">2900</span><span class="w"></span>


<span class="n">Dispatch</span><span class="w"> </span><span class="n">Width</span>:    <span class="mi">6</span><span class="w"></span>
<span class="n">uOps</span><span class="w"> </span><span class="n">Per</span><span class="w"> </span><span class="n">Cycle</span>:    <span class="mf">1.80</span><span class="w"></span>
<span class="n">IPC</span>:               <span class="mf">1.18</span><span class="w"></span>
<span class="n">Block</span><span class="w"> </span><span class="n">RThroughput</span>: <span class="mf">4.8</span><span class="w"></span>
</code></pre></div>


<p>and with new approach but <a href="https://godbolt.org/z/sK93zd">using <code>copysign</code> at the end for handling <code>-0.0</code></a>:</p>
<div class="codehilite"><pre><span></span><code><span class="n">Iterations</span>:        <span class="mi">100</span><span class="w"></span>
<span class="n">Instructions</span>:      <span class="mi">1800</span><span class="w"></span>
<span class="n">Total</span><span class="w"> </span><span class="n">Cycles</span>:      <span class="mi">1308</span><span class="w"></span>
<span class="n">Total</span><span class="w"> </span><span class="n">uOps</span>:        <span class="mi">2200</span><span class="w"></span>

<span class="n">Dispatch</span><span class="w"> </span><span class="n">Width</span>:    <span class="mi">6</span><span class="w"></span>
<span class="n">uOps</span><span class="w"> </span><span class="n">Per</span><span class="w"> </span><span class="n">Cycle</span>:    <span class="mf">1.68</span><span class="w"></span>
<span class="n">IPC</span>:               <span class="mf">1.38</span><span class="w"></span>
<span class="n">Block</span><span class="w"> </span><span class="n">RThroughput</span>: <span class="mf">3.7</span><span class="w"></span>
</code></pre></div>


<p><a href="https://github.com/bytecodealliance/wasmtime/pull/2171#issuecomment-683339394">Benchmark results</a></p>
<p><strong>Upd</strong> So I chose the second approach. Also it <a href="https://godbolt.org/z/W3d7af">branchless on ARM32</a></p>
<p><strong>Upd 2</strong><br>
Another possible approach:</p>
<div class="codehilite"><pre><span></span><code><span class="k">pub</span><span class="w"> </span><span class="k">extern</span><span class="w"> </span><span class="s">&quot;C&quot;</span><span class="w"> </span><span class="k">fn</span> <span class="nf">nearest</span><span class="p">(</span><span class="n">x</span>: <span class="kt">f64</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="kt">f64</span> <span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">x</span><span class="p">.</span><span class="n">to_bits</span><span class="p">();</span><span class="w"></span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">e</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="mi">52</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="mh">0x7ff_</span><span class="k">u64</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="n">e</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="mh">0x3ff_</span><span class="k">u64</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">52</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="n">x</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="p">(</span><span class="n">x</span><span class="p">.</span><span class="n">abs</span><span class="p">()</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">TOINT_64</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">TOINT_64</span><span class="p">).</span><span class="n">copysign</span><span class="p">(</span><span class="n">x</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>


<p>But this approach has <a href="https://godbolt.org/z/4Mor4a">lower IPC</a></p>
</blockquote>



<a name="208479799"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232171%20runtime%3A%20new%20implementations%20for%20near.../near/208479799" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232171.20runtime.3A.20new.20implementations.20for.20near.2E.2E.2E.html#208479799">(Aug 30 2020 at 11:04)</a>:</h4>
<p>MaxGraey edited <a href="https://github.com/bytecodealliance/wasmtime/pull/2171">PR #2171</a> from <code>new-nearest-functions</code> to <code>main</code>:</p>
<blockquote>
<p>More efficient implementations for <code>wasmtime_f32_nearest</code> and <code>wasmtime_f64_nearest</code> based on musl's <code>rint</code> and <code>rintf</code> implementations.</p>
<p>new / old comparison: <a href="https://godbolt.org/z/Gxz3bP">https://godbolt.org/z/Gxz3bP</a></p>
<p>Also instruction's metrics for new approach with if / else branch for handling <code>-0.0</code>:</p>
<div class="codehilite"><pre><span></span><code><span class="n">Iterations</span>:        <span class="mi">100</span><span class="w"></span>
<span class="n">Instructions</span>:      <span class="mi">1900</span><span class="w"></span>
<span class="n">Total</span><span class="w"> </span><span class="n">Cycles</span>:      <span class="mi">1611</span><span class="w"></span>
<span class="n">Total</span><span class="w"> </span><span class="n">uOps</span>:        <span class="mi">2900</span><span class="w"></span>


<span class="n">Dispatch</span><span class="w"> </span><span class="n">Width</span>:    <span class="mi">6</span><span class="w"></span>
<span class="n">uOps</span><span class="w"> </span><span class="n">Per</span><span class="w"> </span><span class="n">Cycle</span>:    <span class="mf">1.80</span><span class="w"></span>
<span class="n">IPC</span>:               <span class="mf">1.18</span><span class="w"></span>
<span class="n">Block</span><span class="w"> </span><span class="n">RThroughput</span>: <span class="mf">4.8</span><span class="w"></span>
</code></pre></div>


<p>and with new approach but <a href="https://godbolt.org/z/sK93zd">using <code>copysign</code> at the end for handling <code>-0.0</code></a>:</p>
<div class="codehilite"><pre><span></span><code><span class="n">Iterations</span>:        <span class="mi">100</span><span class="w"></span>
<span class="n">Instructions</span>:      <span class="mi">1800</span><span class="w"></span>
<span class="n">Total</span><span class="w"> </span><span class="n">Cycles</span>:      <span class="mi">1308</span><span class="w"></span>
<span class="n">Total</span><span class="w"> </span><span class="n">uOps</span>:        <span class="mi">2200</span><span class="w"></span>

<span class="n">Dispatch</span><span class="w"> </span><span class="n">Width</span>:    <span class="mi">6</span><span class="w"></span>
<span class="n">uOps</span><span class="w"> </span><span class="n">Per</span><span class="w"> </span><span class="n">Cycle</span>:    <span class="mf">1.68</span><span class="w"></span>
<span class="n">IPC</span>:               <span class="mf">1.38</span><span class="w"></span>
<span class="n">Block</span><span class="w"> </span><span class="n">RThroughput</span>: <span class="mf">3.7</span><span class="w"></span>
</code></pre></div>


<p><a href="https://github.com/bytecodealliance/wasmtime/pull/2171#issuecomment-683394965">Benchmark results</a></p>
<p><strong>Upd</strong> So I chose the second approach. Also it <a href="https://godbolt.org/z/W3d7af">branchless on ARM32</a></p>
<p><strong>Upd 2</strong><br>
Another possible approach:</p>
<div class="codehilite"><pre><span></span><code><span class="k">pub</span><span class="w"> </span><span class="k">extern</span><span class="w"> </span><span class="s">&quot;C&quot;</span><span class="w"> </span><span class="k">fn</span> <span class="nf">nearest</span><span class="p">(</span><span class="n">x</span>: <span class="kt">f64</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="kt">f64</span> <span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">x</span><span class="p">.</span><span class="n">to_bits</span><span class="p">();</span><span class="w"></span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">e</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="mi">52</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="mh">0x7ff_</span><span class="k">u64</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="n">e</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="mh">0x3ff_</span><span class="k">u64</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">52</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="n">x</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="p">(</span><span class="n">x</span><span class="p">.</span><span class="n">abs</span><span class="p">()</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">TOINT_64</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">TOINT_64</span><span class="p">).</span><span class="n">copysign</span><span class="p">(</span><span class="n">x</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>


<p>But this approach has <a href="https://godbolt.org/z/4Mor4a">lower IPC</a></p>
</blockquote>



<a name="208479987"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232171%20runtime%3A%20new%20implementations%20for%20near.../near/208479987" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232171.20runtime.3A.20new.20implementations.20for.20near.2E.2E.2E.html#208479987">(Aug 30 2020 at 11:09)</a>:</h4>
<p>MaxGraey updated <a href="https://github.com/bytecodealliance/wasmtime/pull/2171">PR #2171</a> from <code>new-nearest-functions</code> to <code>main</code>:</p>
<blockquote>
<p>More efficient implementations for <code>wasmtime_f32_nearest</code> and <code>wasmtime_f64_nearest</code> based on musl's <code>rint</code> and <code>rintf</code> implementations.</p>
<p>new / old comparison: <a href="https://godbolt.org/z/Gxz3bP">https://godbolt.org/z/Gxz3bP</a></p>
<p>Also instruction's metrics for new approach with if / else branch for handling <code>-0.0</code>:</p>
<div class="codehilite"><pre><span></span><code><span class="n">Iterations</span>:        <span class="mi">100</span><span class="w"></span>
<span class="n">Instructions</span>:      <span class="mi">1900</span><span class="w"></span>
<span class="n">Total</span><span class="w"> </span><span class="n">Cycles</span>:      <span class="mi">1611</span><span class="w"></span>
<span class="n">Total</span><span class="w"> </span><span class="n">uOps</span>:        <span class="mi">2900</span><span class="w"></span>


<span class="n">Dispatch</span><span class="w"> </span><span class="n">Width</span>:    <span class="mi">6</span><span class="w"></span>
<span class="n">uOps</span><span class="w"> </span><span class="n">Per</span><span class="w"> </span><span class="n">Cycle</span>:    <span class="mf">1.80</span><span class="w"></span>
<span class="n">IPC</span>:               <span class="mf">1.18</span><span class="w"></span>
<span class="n">Block</span><span class="w"> </span><span class="n">RThroughput</span>: <span class="mf">4.8</span><span class="w"></span>
</code></pre></div>


<p>and with new approach but <a href="https://godbolt.org/z/sK93zd">using <code>copysign</code> at the end for handling <code>-0.0</code></a>:</p>
<div class="codehilite"><pre><span></span><code><span class="n">Iterations</span>:        <span class="mi">100</span><span class="w"></span>
<span class="n">Instructions</span>:      <span class="mi">1800</span><span class="w"></span>
<span class="n">Total</span><span class="w"> </span><span class="n">Cycles</span>:      <span class="mi">1308</span><span class="w"></span>
<span class="n">Total</span><span class="w"> </span><span class="n">uOps</span>:        <span class="mi">2200</span><span class="w"></span>

<span class="n">Dispatch</span><span class="w"> </span><span class="n">Width</span>:    <span class="mi">6</span><span class="w"></span>
<span class="n">uOps</span><span class="w"> </span><span class="n">Per</span><span class="w"> </span><span class="n">Cycle</span>:    <span class="mf">1.68</span><span class="w"></span>
<span class="n">IPC</span>:               <span class="mf">1.38</span><span class="w"></span>
<span class="n">Block</span><span class="w"> </span><span class="n">RThroughput</span>: <span class="mf">3.7</span><span class="w"></span>
</code></pre></div>


<p><a href="https://github.com/bytecodealliance/wasmtime/pull/2171#issuecomment-683394965">Benchmark results</a></p>
<p><strong>Upd</strong> So I chose the second approach. Also it <a href="https://godbolt.org/z/W3d7af">branchless on ARM32</a></p>
<p><strong>Upd 2</strong><br>
Another possible approach:</p>
<div class="codehilite"><pre><span></span><code><span class="k">pub</span><span class="w"> </span><span class="k">extern</span><span class="w"> </span><span class="s">&quot;C&quot;</span><span class="w"> </span><span class="k">fn</span> <span class="nf">nearest</span><span class="p">(</span><span class="n">x</span>: <span class="kt">f64</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="kt">f64</span> <span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">x</span><span class="p">.</span><span class="n">to_bits</span><span class="p">();</span><span class="w"></span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">e</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="mi">52</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="mh">0x7ff_</span><span class="k">u64</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="n">e</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="mh">0x3ff_</span><span class="k">u64</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">52</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="n">x</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="p">(</span><span class="n">x</span><span class="p">.</span><span class="n">abs</span><span class="p">()</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">TOINT_64</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">TOINT_64</span><span class="p">).</span><span class="n">copysign</span><span class="p">(</span><span class="n">x</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>


<p>But this approach has <a href="https://godbolt.org/z/4Mor4a">lower IPC</a></p>
</blockquote>



<a name="208489285"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232171%20runtime%3A%20new%20implementations%20for%20near.../near/208489285" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232171.20runtime.3A.20new.20implementations.20for.20near.2E.2E.2E.html#208489285">(Aug 30 2020 at 15:10)</a>:</h4>
<p>sunfishcode submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/2171#pullrequestreview-478210815">PR Review</a>.</p>



<a name="208489286"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232171%20runtime%3A%20new%20implementations%20for%20near.../near/208489286" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232171.20runtime.3A.20new.20implementations.20for.20near.2E.2E.2E.html#208489286">(Aug 30 2020 at 15:10)</a>:</h4>
<p>sunfishcode submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/2171#pullrequestreview-478210815">PR Review</a>.</p>



<a name="208489287"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232171%20runtime%3A%20new%20implementations%20for%20near.../near/208489287" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232171.20runtime.3A.20new.20implementations.20for.20near.2E.2E.2E.html#208489287">(Aug 30 2020 at 15:10)</a>:</h4>
<p>sunfishcode created <a href="https://github.com/bytecodealliance/wasmtime/pull/2171#discussion_r479780724">PR Review Comment</a>:</p>
<blockquote>
<p>With copysign here, you could also replace the <code>if</code> above with just <code>x.abs() + TOINT_32 - TOINT_32</code>, letting the copysign restore the sign bit, so that we don't get branch mispredicts if inputs have a mix of signs.</p>
</blockquote>



<a name="208489288"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232171%20runtime%3A%20new%20implementations%20for%20near.../near/208489288" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232171.20runtime.3A.20new.20implementations.20for.20near.2E.2E.2E.html#208489288">(Aug 30 2020 at 15:10)</a>:</h4>
<p>sunfishcode created <a href="https://github.com/bytecodealliance/wasmtime/pull/2171#discussion_r479781285">PR Review Comment</a>:</p>
<blockquote>
<p>You could also check to see if it's faster to do the first <code>if</code> using <code>abs()</code> with a floating-point range check, instead of <code>to_bits()</code> with an integer range check.</p>
</blockquote>



<a name="208489559"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232171%20runtime%3A%20new%20implementations%20for%20near.../near/208489559" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232171.20runtime.3A.20new.20implementations.20for.20near.2E.2E.2E.html#208489559">(Aug 30 2020 at 15:16)</a>:</h4>
<p>MaxGraey submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/2171#pullrequestreview-478211716">PR Review</a>.</p>



<a name="208489560"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232171%20runtime%3A%20new%20implementations%20for%20near.../near/208489560" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232171.20runtime.3A.20new.20implementations.20for.20near.2E.2E.2E.html#208489560">(Aug 30 2020 at 15:16)</a>:</h4>
<p>MaxGraey created <a href="https://github.com/bytecodealliance/wasmtime/pull/2171#discussion_r479782042">PR Review Comment</a>:</p>
<blockquote>
<p>Yes, <code>x.abs() + TOINT_32 - TOINT_32</code> little bit faster. This variant has in <a href="https://gist.github.com/MaxGraey/a826c71909353e3a28a54e8a749c06ac#file-nearest_bench-rs-L72">benchmark</a>. But I'm not sure it will be great on ARM32: <a href="https://godbolt.org/z/jsMba8">https://godbolt.org/z/jsMba8</a>.</p>
</blockquote>



<a name="208489572"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232171%20runtime%3A%20new%20implementations%20for%20near.../near/208489572" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232171.20runtime.3A.20new.20implementations.20for.20near.2E.2E.2E.html#208489572">(Aug 30 2020 at 15:16)</a>:</h4>
<p>MaxGraey created <a href="https://github.com/bytecodealliance/wasmtime/pull/2171#discussion_r479782087">PR Review Comment</a>:</p>
<blockquote>
<p>That's make sense. Will add this case to benchmark</p>
</blockquote>



<a name="208489573"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232171%20runtime%3A%20new%20implementations%20for%20near.../near/208489573" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232171.20runtime.3A.20new.20implementations.20for.20near.2E.2E.2E.html#208489573">(Aug 30 2020 at 15:16)</a>:</h4>
<p>MaxGraey submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/2171#pullrequestreview-478211743">PR Review</a>.</p>



<a name="208490091"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232171%20runtime%3A%20new%20implementations%20for%20near.../near/208490091" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232171.20runtime.3A.20new.20implementations.20for.20near.2E.2E.2E.html#208490091">(Aug 30 2020 at 15:30)</a>:</h4>
<p>MaxGraey submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/2171#pullrequestreview-478212693">PR Review</a>.</p>



<a name="208490092"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232171%20runtime%3A%20new%20implementations%20for%20near.../near/208490092" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232171.20runtime.3A.20new.20implementations.20for.20near.2E.2E.2E.html#208490092">(Aug 30 2020 at 15:30)</a>:</h4>
<p>MaxGraey created <a href="https://github.com/bytecodealliance/wasmtime/pull/2171#discussion_r479783392">PR Review Comment</a>:</p>
<blockquote>
<p>Unfortunately it will be slower:</p>
<div class="codehilite"><pre><span></span><code><span class="n">test</span><span class="w"> </span><span class="n">nearest_abs_copysign</span><span class="w">              </span><span class="o">..</span><span class="p">.</span><span class="w"> </span><span class="n">bench</span>:      <span class="mi">35</span><span class="p">,</span><span class="mi">993</span><span class="w"> </span><span class="n">ns</span><span class="o">/</span><span class="n">iter</span><span class="w"> </span><span class="p">(</span><span class="o">+/-</span><span class="w"> </span><span class="mi">7</span><span class="p">,</span><span class="mi">475</span><span class="p">)</span><span class="w"></span>
<span class="n">test</span><span class="w"> </span><span class="n">nearest_abs_copysign_without_bits</span><span class="w"> </span><span class="o">..</span><span class="p">.</span><span class="w"> </span><span class="n">bench</span>:      <span class="mi">37</span><span class="p">,</span><span class="mi">380</span><span class="w"> </span><span class="n">ns</span><span class="o">/</span><span class="n">iter</span><span class="w"> </span><span class="p">(</span><span class="o">+/-</span><span class="w"> </span><span class="mi">16</span><span class="p">,</span><span class="mi">714</span><span class="p">)</span><span class="w">  </span><span class="p">;;</span><span class="w">   </span><span class="o">&lt;--</span><span class="w"> </span><span class="n">suggested</span><span class="w"></span>
<span class="n">test</span><span class="w"> </span><span class="n">nearest_branch</span><span class="w">                    </span><span class="o">..</span><span class="p">.</span><span class="w"> </span><span class="n">bench</span>:      <span class="mi">37</span><span class="p">,</span><span class="mi">300</span><span class="w"> </span><span class="n">ns</span><span class="o">/</span><span class="n">iter</span><span class="w"> </span><span class="p">(</span><span class="o">+/-</span><span class="w"> </span><span class="mi">7</span><span class="p">,</span><span class="mi">593</span><span class="p">)</span><span class="w"></span>
<span class="n">test</span><span class="w"> </span><span class="n">nearest_copysign</span><span class="w">                  </span><span class="o">..</span><span class="p">.</span><span class="w"> </span><span class="n">bench</span>:      <span class="mi">32</span><span class="p">,</span><span class="mi">348</span><span class="w"> </span><span class="n">ns</span><span class="o">/</span><span class="n">iter</span><span class="w"> </span><span class="p">(</span><span class="o">+/-</span><span class="w"> </span><span class="mi">4</span><span class="p">,</span><span class="mi">869</span><span class="p">)</span><span class="w">   </span><span class="p">;;</span><span class="w"> </span><span class="n">current</span><span class="w"></span>
<span class="n">test</span><span class="w"> </span><span class="n">nearest_original</span><span class="w">                  </span><span class="o">..</span><span class="p">.</span><span class="w"> </span><span class="n">bench</span>:      <span class="mi">99</span><span class="p">,</span><span class="mi">693</span><span class="w"> </span><span class="n">ns</span><span class="o">/</span><span class="n">iter</span><span class="w"> </span><span class="p">(</span><span class="o">+/-</span><span class="w"> </span><span class="mi">16</span><span class="p">,</span><span class="mi">491</span><span class="p">)</span><span class="w"></span>
<span class="n">test</span><span class="w"> </span><span class="n">nearest_sse41</span><span class="w">                     </span><span class="o">..</span><span class="p">.</span><span class="w"> </span><span class="n">bench</span>:      <span class="mi">40</span><span class="p">,</span><span class="mi">587</span><span class="w"> </span><span class="n">ns</span><span class="o">/</span><span class="n">iter</span><span class="w"> </span><span class="p">(</span><span class="o">+/-</span><span class="w"> </span><span class="mi">3</span><span class="p">,</span><span class="mi">854</span><span class="p">)</span><span class="w"></span>
</code></pre></div>


<p><a href="https://gist.github.com/MaxGraey/a826c71909353e3a28a54e8a749c06ac#file-nearest_bench-rs-L163">updated benchmark</a></p>
</blockquote>



<a name="208490100"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232171%20runtime%3A%20new%20implementations%20for%20near.../near/208490100" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232171.20runtime.3A.20new.20implementations.20for.20near.2E.2E.2E.html#208490100">(Aug 30 2020 at 15:30)</a>:</h4>
<p>MaxGraey edited <a href="https://github.com/bytecodealliance/wasmtime/pull/2171#discussion_r479783392">PR Review Comment</a>.</p>



<a name="208490122"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232171%20runtime%3A%20new%20implementations%20for%20near.../near/208490122" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232171.20runtime.3A.20new.20implementations.20for.20near.2E.2E.2E.html#208490122">(Aug 30 2020 at 15:31)</a>:</h4>
<p>MaxGraey edited <a href="https://github.com/bytecodealliance/wasmtime/pull/2171#discussion_r479783392">PR Review Comment</a>.</p>



<a name="208490621"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232171%20runtime%3A%20new%20implementations%20for%20near.../near/208490621" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232171.20runtime.3A.20new.20implementations.20for.20near.2E.2E.2E.html#208490621">(Aug 30 2020 at 15:44)</a>:</h4>
<p>sunfishcode submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/2171#pullrequestreview-478213723">PR Review</a>.</p>



<a name="208490622"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232171%20runtime%3A%20new%20implementations%20for%20near.../near/208490622" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232171.20runtime.3A.20new.20implementations.20for.20near.2E.2E.2E.html#208490622">(Aug 30 2020 at 15:44)</a>:</h4>
<p>sunfishcode created <a href="https://github.com/bytecodealliance/wasmtime/pull/2171#discussion_r479784819">PR Review Comment</a>:</p>
<blockquote>
<p>Ah, sorry I missed that you had benchmarked that already. I'm not very familiar with ARM32, but in that godbolt link, the only thing that sticks out to me as being slower is that the abs version doesn't have the early exit for inputs for which <code>nearest</code> is an identity operation. On other inputs, the abs version has fewer instructions.</p>
</blockquote>



<a name="208491126"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232171%20runtime%3A%20new%20implementations%20for%20near.../near/208491126" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232171.20runtime.3A.20new.20implementations.20for.20near.2E.2E.2E.html#208491126">(Aug 30 2020 at 15:56)</a>:</h4>
<p>MaxGraey submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/2171#pullrequestreview-478214608">PR Review</a>.</p>



<a name="208491127"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232171%20runtime%3A%20new%20implementations%20for%20near.../near/208491127" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232171.20runtime.3A.20new.20implementations.20for.20near.2E.2E.2E.html#208491127">(Aug 30 2020 at 15:56)</a>:</h4>
<p>MaxGraey created <a href="https://github.com/bytecodealliance/wasmtime/pull/2171#discussion_r479786081">PR Review Comment</a>:</p>
<blockquote>
<p>For second approach (wih abs) ARM has much more ALU / VFP switchings which in theory will be slower. Unfortunately llvm-mca doesn't work for arm targets yet. And I can't benchmark this </p>
</blockquote>



<a name="208491162"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232171%20runtime%3A%20new%20implementations%20for%20near.../near/208491162" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232171.20runtime.3A.20new.20implementations.20for.20near.2E.2E.2E.html#208491162">(Aug 30 2020 at 15:58)</a>:</h4>
<p>MaxGraey edited <a href="https://github.com/bytecodealliance/wasmtime/pull/2171#discussion_r479786081">PR Review Comment</a>.</p>



<a name="208491194"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232171%20runtime%3A%20new%20implementations%20for%20near.../near/208491194" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232171.20runtime.3A.20new.20implementations.20for.20near.2E.2E.2E.html#208491194">(Aug 30 2020 at 15:58)</a>:</h4>
<p>MaxGraey edited <a href="https://github.com/bytecodealliance/wasmtime/pull/2171#discussion_r479786081">PR Review Comment</a>.</p>



<a name="208493025"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232171%20runtime%3A%20new%20implementations%20for%20near.../near/208493025" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232171.20runtime.3A.20new.20implementations.20for.20near.2E.2E.2E.html#208493025">(Aug 30 2020 at 16:38)</a>:</h4>
<p>sunfishcode submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/2171#pullrequestreview-478217595">PR Review</a>.</p>



<a name="208493026"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232171%20runtime%3A%20new%20implementations%20for%20near.../near/208493026" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232171.20runtime.3A.20new.20implementations.20for.20near.2E.2E.2E.html#208493026">(Aug 30 2020 at 16:38)</a>:</h4>
<p>sunfishcode created <a href="https://github.com/bytecodealliance/wasmtime/pull/2171#discussion_r479790157">PR Review Comment</a>:</p>
<blockquote>
<p>Are you referring to the <code>vmov</code>s that move between d and r registers? I see the same number in both versions.</p>
</blockquote>



<a name="208495219"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232171%20runtime%3A%20new%20implementations%20for%20near.../near/208495219" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232171.20runtime.3A.20new.20implementations.20for.20near.2E.2E.2E.html#208495219">(Aug 30 2020 at 17:23)</a>:</h4>
<p>MaxGraey submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/2171#pullrequestreview-478220535">PR Review</a>.</p>



<a name="208495220"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232171%20runtime%3A%20new%20implementations%20for%20near.../near/208495220" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232171.20runtime.3A.20new.20implementations.20for.20near.2E.2E.2E.html#208495220">(Aug 30 2020 at 17:23)</a>:</h4>
<p>MaxGraey created <a href="https://github.com/bytecodealliance/wasmtime/pull/2171#discussion_r479794630">PR Review Comment</a>:</p>
<blockquote>
<p>Alright, I'll use <code>abs + copysign</code> approach. Thanks for review btw</p>
</blockquote>



<a name="208495309"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232171%20runtime%3A%20new%20implementations%20for%20near.../near/208495309" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232171.20runtime.3A.20new.20implementations.20for.20near.2E.2E.2E.html#208495309">(Aug 30 2020 at 17:25)</a>:</h4>
<p>MaxGraey updated <a href="https://github.com/bytecodealliance/wasmtime/pull/2171">PR #2171</a> from <code>new-nearest-functions</code> to <code>main</code>:</p>
<blockquote>
<p>More efficient implementations for <code>wasmtime_f32_nearest</code> and <code>wasmtime_f64_nearest</code> based on musl's <code>rint</code> and <code>rintf</code> implementations.</p>
<p>new / old comparison: <a href="https://godbolt.org/z/Gxz3bP">https://godbolt.org/z/Gxz3bP</a></p>
<p>Also instruction's metrics for new approach with if / else branch for handling <code>-0.0</code>:</p>
<div class="codehilite"><pre><span></span><code><span class="n">Iterations</span>:        <span class="mi">100</span><span class="w"></span>
<span class="n">Instructions</span>:      <span class="mi">1900</span><span class="w"></span>
<span class="n">Total</span><span class="w"> </span><span class="n">Cycles</span>:      <span class="mi">1611</span><span class="w"></span>
<span class="n">Total</span><span class="w"> </span><span class="n">uOps</span>:        <span class="mi">2900</span><span class="w"></span>


<span class="n">Dispatch</span><span class="w"> </span><span class="n">Width</span>:    <span class="mi">6</span><span class="w"></span>
<span class="n">uOps</span><span class="w"> </span><span class="n">Per</span><span class="w"> </span><span class="n">Cycle</span>:    <span class="mf">1.80</span><span class="w"></span>
<span class="n">IPC</span>:               <span class="mf">1.18</span><span class="w"></span>
<span class="n">Block</span><span class="w"> </span><span class="n">RThroughput</span>: <span class="mf">4.8</span><span class="w"></span>
</code></pre></div>


<p>and with new approach but <a href="https://godbolt.org/z/sK93zd">using <code>copysign</code> at the end for handling <code>-0.0</code></a>:</p>
<div class="codehilite"><pre><span></span><code><span class="n">Iterations</span>:        <span class="mi">100</span><span class="w"></span>
<span class="n">Instructions</span>:      <span class="mi">1800</span><span class="w"></span>
<span class="n">Total</span><span class="w"> </span><span class="n">Cycles</span>:      <span class="mi">1308</span><span class="w"></span>
<span class="n">Total</span><span class="w"> </span><span class="n">uOps</span>:        <span class="mi">2200</span><span class="w"></span>

<span class="n">Dispatch</span><span class="w"> </span><span class="n">Width</span>:    <span class="mi">6</span><span class="w"></span>
<span class="n">uOps</span><span class="w"> </span><span class="n">Per</span><span class="w"> </span><span class="n">Cycle</span>:    <span class="mf">1.68</span><span class="w"></span>
<span class="n">IPC</span>:               <span class="mf">1.38</span><span class="w"></span>
<span class="n">Block</span><span class="w"> </span><span class="n">RThroughput</span>: <span class="mf">3.7</span><span class="w"></span>
</code></pre></div>


<p><a href="https://github.com/bytecodealliance/wasmtime/pull/2171#issuecomment-683394965">Benchmark results</a></p>
<p><strong>Upd</strong> So I chose the second approach. Also it <a href="https://godbolt.org/z/W3d7af">branchless on ARM32</a></p>
<p><strong>Upd 2</strong><br>
Another possible approach:</p>
<div class="codehilite"><pre><span></span><code><span class="k">pub</span><span class="w"> </span><span class="k">extern</span><span class="w"> </span><span class="s">&quot;C&quot;</span><span class="w"> </span><span class="k">fn</span> <span class="nf">nearest</span><span class="p">(</span><span class="n">x</span>: <span class="kt">f64</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="kt">f64</span> <span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">x</span><span class="p">.</span><span class="n">to_bits</span><span class="p">();</span><span class="w"></span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">e</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="mi">52</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="mh">0x7ff_</span><span class="k">u64</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="n">e</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="mh">0x3ff_</span><span class="k">u64</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">52</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="n">x</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="p">(</span><span class="n">x</span><span class="p">.</span><span class="n">abs</span><span class="p">()</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">TOINT_64</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">TOINT_64</span><span class="p">).</span><span class="n">copysign</span><span class="p">(</span><span class="n">x</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>


<p>But this approach has <a href="https://godbolt.org/z/4Mor4a">lower IPC</a></p>
</blockquote>



<a name="208496260"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232171%20runtime%3A%20new%20implementations%20for%20near.../near/208496260" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232171.20runtime.3A.20new.20implementations.20for.20near.2E.2E.2E.html#208496260">(Aug 30 2020 at 17:44)</a>:</h4>
<p>MaxGraey updated <a href="https://github.com/bytecodealliance/wasmtime/pull/2171">PR #2171</a> from <code>new-nearest-functions</code> to <code>main</code>:</p>
<blockquote>
<p>More efficient implementations for <code>wasmtime_f32_nearest</code> and <code>wasmtime_f64_nearest</code> based on musl's <code>rint</code> and <code>rintf</code> implementations.</p>
<p>new / old comparison: <a href="https://godbolt.org/z/Gxz3bP">https://godbolt.org/z/Gxz3bP</a></p>
<p>Also instruction's metrics for new approach with if / else branch for handling <code>-0.0</code>:</p>
<div class="codehilite"><pre><span></span><code><span class="n">Iterations</span>:        <span class="mi">100</span><span class="w"></span>
<span class="n">Instructions</span>:      <span class="mi">1900</span><span class="w"></span>
<span class="n">Total</span><span class="w"> </span><span class="n">Cycles</span>:      <span class="mi">1611</span><span class="w"></span>
<span class="n">Total</span><span class="w"> </span><span class="n">uOps</span>:        <span class="mi">2900</span><span class="w"></span>


<span class="n">Dispatch</span><span class="w"> </span><span class="n">Width</span>:    <span class="mi">6</span><span class="w"></span>
<span class="n">uOps</span><span class="w"> </span><span class="n">Per</span><span class="w"> </span><span class="n">Cycle</span>:    <span class="mf">1.80</span><span class="w"></span>
<span class="n">IPC</span>:               <span class="mf">1.18</span><span class="w"></span>
<span class="n">Block</span><span class="w"> </span><span class="n">RThroughput</span>: <span class="mf">4.8</span><span class="w"></span>
</code></pre></div>


<p>and with new approach but <a href="https://godbolt.org/z/sK93zd">using <code>copysign</code> at the end for handling <code>-0.0</code></a>:</p>
<div class="codehilite"><pre><span></span><code><span class="n">Iterations</span>:        <span class="mi">100</span><span class="w"></span>
<span class="n">Instructions</span>:      <span class="mi">1800</span><span class="w"></span>
<span class="n">Total</span><span class="w"> </span><span class="n">Cycles</span>:      <span class="mi">1308</span><span class="w"></span>
<span class="n">Total</span><span class="w"> </span><span class="n">uOps</span>:        <span class="mi">2200</span><span class="w"></span>

<span class="n">Dispatch</span><span class="w"> </span><span class="n">Width</span>:    <span class="mi">6</span><span class="w"></span>
<span class="n">uOps</span><span class="w"> </span><span class="n">Per</span><span class="w"> </span><span class="n">Cycle</span>:    <span class="mf">1.68</span><span class="w"></span>
<span class="n">IPC</span>:               <span class="mf">1.38</span><span class="w"></span>
<span class="n">Block</span><span class="w"> </span><span class="n">RThroughput</span>: <span class="mf">3.7</span><span class="w"></span>
</code></pre></div>


<p><a href="https://github.com/bytecodealliance/wasmtime/pull/2171#issuecomment-683394965">Benchmark results</a></p>
<p><strong>Upd</strong> So I chose the second approach. Also it <a href="https://godbolt.org/z/W3d7af">branchless on ARM32</a></p>
<p><strong>Upd 2</strong><br>
Another possible approach:</p>
<div class="codehilite"><pre><span></span><code><span class="k">pub</span><span class="w"> </span><span class="k">extern</span><span class="w"> </span><span class="s">&quot;C&quot;</span><span class="w"> </span><span class="k">fn</span> <span class="nf">nearest</span><span class="p">(</span><span class="n">x</span>: <span class="kt">f64</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="kt">f64</span> <span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">x</span><span class="p">.</span><span class="n">to_bits</span><span class="p">();</span><span class="w"></span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">e</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="mi">52</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="mh">0x7ff_</span><span class="k">u64</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="n">e</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="mh">0x3ff_</span><span class="k">u64</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">52</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="n">x</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="p">(</span><span class="n">x</span><span class="p">.</span><span class="n">abs</span><span class="p">()</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">TOINT_64</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">TOINT_64</span><span class="p">).</span><span class="n">copysign</span><span class="p">(</span><span class="n">x</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>


<p>But this approach has <a href="https://godbolt.org/z/4Mor4a">lower IPC</a></p>
</blockquote>



<a name="208499180"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232171%20runtime%3A%20new%20implementations%20for%20near.../near/208499180" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232171.20runtime.3A.20new.20implementations.20for.20near.2E.2E.2E.html#208499180">(Aug 30 2020 at 18:59)</a>:</h4>
<p>MaxGraey updated <a href="https://github.com/bytecodealliance/wasmtime/pull/2171">PR #2171</a> from <code>new-nearest-functions</code> to <code>main</code>:</p>
<blockquote>
<p>More efficient implementations for <code>wasmtime_f32_nearest</code> and <code>wasmtime_f64_nearest</code> based on musl's <code>rint</code> and <code>rintf</code> implementations.</p>
<p>new / old comparison: <a href="https://godbolt.org/z/Gxz3bP">https://godbolt.org/z/Gxz3bP</a></p>
<p>Also instruction's metrics for new approach with if / else branch for handling <code>-0.0</code>:</p>
<div class="codehilite"><pre><span></span><code><span class="n">Iterations</span>:        <span class="mi">100</span><span class="w"></span>
<span class="n">Instructions</span>:      <span class="mi">1900</span><span class="w"></span>
<span class="n">Total</span><span class="w"> </span><span class="n">Cycles</span>:      <span class="mi">1611</span><span class="w"></span>
<span class="n">Total</span><span class="w"> </span><span class="n">uOps</span>:        <span class="mi">2900</span><span class="w"></span>


<span class="n">Dispatch</span><span class="w"> </span><span class="n">Width</span>:    <span class="mi">6</span><span class="w"></span>
<span class="n">uOps</span><span class="w"> </span><span class="n">Per</span><span class="w"> </span><span class="n">Cycle</span>:    <span class="mf">1.80</span><span class="w"></span>
<span class="n">IPC</span>:               <span class="mf">1.18</span><span class="w"></span>
<span class="n">Block</span><span class="w"> </span><span class="n">RThroughput</span>: <span class="mf">4.8</span><span class="w"></span>
</code></pre></div>


<p>and with new approach but <a href="https://godbolt.org/z/sK93zd">using <code>copysign</code> at the end for handling <code>-0.0</code></a>:</p>
<div class="codehilite"><pre><span></span><code><span class="n">Iterations</span>:        <span class="mi">100</span><span class="w"></span>
<span class="n">Instructions</span>:      <span class="mi">1800</span><span class="w"></span>
<span class="n">Total</span><span class="w"> </span><span class="n">Cycles</span>:      <span class="mi">1308</span><span class="w"></span>
<span class="n">Total</span><span class="w"> </span><span class="n">uOps</span>:        <span class="mi">2200</span><span class="w"></span>

<span class="n">Dispatch</span><span class="w"> </span><span class="n">Width</span>:    <span class="mi">6</span><span class="w"></span>
<span class="n">uOps</span><span class="w"> </span><span class="n">Per</span><span class="w"> </span><span class="n">Cycle</span>:    <span class="mf">1.68</span><span class="w"></span>
<span class="n">IPC</span>:               <span class="mf">1.38</span><span class="w"></span>
<span class="n">Block</span><span class="w"> </span><span class="n">RThroughput</span>: <span class="mf">3.7</span><span class="w"></span>
</code></pre></div>


<p><a href="https://github.com/bytecodealliance/wasmtime/pull/2171#issuecomment-683394965">Benchmark results</a></p>
<p><strong>Upd</strong> So I chose the second approach. Also it <a href="https://godbolt.org/z/W3d7af">branchless on ARM32</a></p>
<p><strong>Upd 2</strong><br>
Another possible approach:</p>
<div class="codehilite"><pre><span></span><code><span class="k">pub</span><span class="w"> </span><span class="k">extern</span><span class="w"> </span><span class="s">&quot;C&quot;</span><span class="w"> </span><span class="k">fn</span> <span class="nf">nearest</span><span class="p">(</span><span class="n">x</span>: <span class="kt">f64</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="kt">f64</span> <span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">x</span><span class="p">.</span><span class="n">to_bits</span><span class="p">();</span><span class="w"></span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">e</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="mi">52</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="mh">0x7ff_</span><span class="k">u64</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="n">e</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="mh">0x3ff_</span><span class="k">u64</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">52</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="n">x</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="p">(</span><span class="n">x</span><span class="p">.</span><span class="n">abs</span><span class="p">()</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">TOINT_64</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">TOINT_64</span><span class="p">).</span><span class="n">copysign</span><span class="p">(</span><span class="n">x</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>


<p>But this approach has <a href="https://godbolt.org/z/4Mor4a">lower IPC</a></p>
</blockquote>



<a name="208577789"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232171%20runtime%3A%20new%20implementations%20for%20near.../near/208577789" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232171.20runtime.3A.20new.20implementations.20for.20near.2E.2E.2E.html#208577789">(Aug 31 2020 at 16:02)</a>:</h4>
<p>MaxGraey updated <a href="https://github.com/bytecodealliance/wasmtime/pull/2171">PR #2171</a> from <code>new-nearest-functions</code> to <code>main</code>:</p>
<blockquote>
<p>More efficient implementations for <code>wasmtime_f32_nearest</code> and <code>wasmtime_f64_nearest</code> based on musl's <code>rint</code> and <code>rintf</code> implementations.</p>
<p>new / old comparison: <a href="https://godbolt.org/z/Gxz3bP">https://godbolt.org/z/Gxz3bP</a></p>
<p>Also instruction's metrics for new approach with if / else branch for handling <code>-0.0</code>:</p>
<div class="codehilite"><pre><span></span><code><span class="n">Iterations</span>:        <span class="mi">100</span><span class="w"></span>
<span class="n">Instructions</span>:      <span class="mi">1900</span><span class="w"></span>
<span class="n">Total</span><span class="w"> </span><span class="n">Cycles</span>:      <span class="mi">1611</span><span class="w"></span>
<span class="n">Total</span><span class="w"> </span><span class="n">uOps</span>:        <span class="mi">2900</span><span class="w"></span>


<span class="n">Dispatch</span><span class="w"> </span><span class="n">Width</span>:    <span class="mi">6</span><span class="w"></span>
<span class="n">uOps</span><span class="w"> </span><span class="n">Per</span><span class="w"> </span><span class="n">Cycle</span>:    <span class="mf">1.80</span><span class="w"></span>
<span class="n">IPC</span>:               <span class="mf">1.18</span><span class="w"></span>
<span class="n">Block</span><span class="w"> </span><span class="n">RThroughput</span>: <span class="mf">4.8</span><span class="w"></span>
</code></pre></div>


<p>and with new approach but <a href="https://godbolt.org/z/sK93zd">using <code>copysign</code> at the end for handling <code>-0.0</code></a>:</p>
<div class="codehilite"><pre><span></span><code><span class="n">Iterations</span>:        <span class="mi">100</span><span class="w"></span>
<span class="n">Instructions</span>:      <span class="mi">1800</span><span class="w"></span>
<span class="n">Total</span><span class="w"> </span><span class="n">Cycles</span>:      <span class="mi">1308</span><span class="w"></span>
<span class="n">Total</span><span class="w"> </span><span class="n">uOps</span>:        <span class="mi">2200</span><span class="w"></span>

<span class="n">Dispatch</span><span class="w"> </span><span class="n">Width</span>:    <span class="mi">6</span><span class="w"></span>
<span class="n">uOps</span><span class="w"> </span><span class="n">Per</span><span class="w"> </span><span class="n">Cycle</span>:    <span class="mf">1.68</span><span class="w"></span>
<span class="n">IPC</span>:               <span class="mf">1.38</span><span class="w"></span>
<span class="n">Block</span><span class="w"> </span><span class="n">RThroughput</span>: <span class="mf">3.7</span><span class="w"></span>
</code></pre></div>


<p><a href="https://github.com/bytecodealliance/wasmtime/pull/2171#issuecomment-683394965">Benchmark results</a></p>
<p><strong>Upd</strong> So I chose the second approach. Also it <a href="https://godbolt.org/z/W3d7af">branchless on ARM32</a></p>
<p><strong>Upd 2</strong><br>
Another possible approach:</p>
<div class="codehilite"><pre><span></span><code><span class="k">pub</span><span class="w"> </span><span class="k">extern</span><span class="w"> </span><span class="s">&quot;C&quot;</span><span class="w"> </span><span class="k">fn</span> <span class="nf">nearest</span><span class="p">(</span><span class="n">x</span>: <span class="kt">f64</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="kt">f64</span> <span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">x</span><span class="p">.</span><span class="n">to_bits</span><span class="p">();</span><span class="w"></span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">e</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="mi">52</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="mh">0x7ff_</span><span class="k">u64</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="n">e</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="mh">0x3ff_</span><span class="k">u64</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">52</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="n">x</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="p">(</span><span class="n">x</span><span class="p">.</span><span class="n">abs</span><span class="p">()</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">TOINT_64</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">TOINT_64</span><span class="p">).</span><span class="n">copysign</span><span class="p">(</span><span class="n">x</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>


<p>But this approach has <a href="https://godbolt.org/z/4Mor4a">lower IPC</a></p>
</blockquote>



<a name="208577855"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232171%20runtime%3A%20new%20implementations%20for%20near.../near/208577855" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232171.20runtime.3A.20new.20implementations.20for.20near.2E.2E.2E.html#208577855">(Aug 31 2020 at 16:02)</a>:</h4>
<p>MaxGraey updated <a href="https://github.com/bytecodealliance/wasmtime/pull/2171">PR #2171</a> from <code>new-nearest-functions</code> to <code>main</code>:</p>
<blockquote>
<p>More efficient implementations for <code>wasmtime_f32_nearest</code> and <code>wasmtime_f64_nearest</code> based on musl's <code>rint</code> and <code>rintf</code> implementations.</p>
<p>new / old comparison: <a href="https://godbolt.org/z/Gxz3bP">https://godbolt.org/z/Gxz3bP</a></p>
<p>Also instruction's metrics for new approach with if / else branch for handling <code>-0.0</code>:</p>
<div class="codehilite"><pre><span></span><code><span class="n">Iterations</span>:        <span class="mi">100</span><span class="w"></span>
<span class="n">Instructions</span>:      <span class="mi">1900</span><span class="w"></span>
<span class="n">Total</span><span class="w"> </span><span class="n">Cycles</span>:      <span class="mi">1611</span><span class="w"></span>
<span class="n">Total</span><span class="w"> </span><span class="n">uOps</span>:        <span class="mi">2900</span><span class="w"></span>


<span class="n">Dispatch</span><span class="w"> </span><span class="n">Width</span>:    <span class="mi">6</span><span class="w"></span>
<span class="n">uOps</span><span class="w"> </span><span class="n">Per</span><span class="w"> </span><span class="n">Cycle</span>:    <span class="mf">1.80</span><span class="w"></span>
<span class="n">IPC</span>:               <span class="mf">1.18</span><span class="w"></span>
<span class="n">Block</span><span class="w"> </span><span class="n">RThroughput</span>: <span class="mf">4.8</span><span class="w"></span>
</code></pre></div>


<p>and with new approach but <a href="https://godbolt.org/z/sK93zd">using <code>copysign</code> at the end for handling <code>-0.0</code></a>:</p>
<div class="codehilite"><pre><span></span><code><span class="n">Iterations</span>:        <span class="mi">100</span><span class="w"></span>
<span class="n">Instructions</span>:      <span class="mi">1800</span><span class="w"></span>
<span class="n">Total</span><span class="w"> </span><span class="n">Cycles</span>:      <span class="mi">1308</span><span class="w"></span>
<span class="n">Total</span><span class="w"> </span><span class="n">uOps</span>:        <span class="mi">2200</span><span class="w"></span>

<span class="n">Dispatch</span><span class="w"> </span><span class="n">Width</span>:    <span class="mi">6</span><span class="w"></span>
<span class="n">uOps</span><span class="w"> </span><span class="n">Per</span><span class="w"> </span><span class="n">Cycle</span>:    <span class="mf">1.68</span><span class="w"></span>
<span class="n">IPC</span>:               <span class="mf">1.38</span><span class="w"></span>
<span class="n">Block</span><span class="w"> </span><span class="n">RThroughput</span>: <span class="mf">3.7</span><span class="w"></span>
</code></pre></div>


<p><a href="https://github.com/bytecodealliance/wasmtime/pull/2171#issuecomment-683394965">Benchmark results</a></p>
<p><strong>Upd</strong> So I chose the second approach. Also it <a href="https://godbolt.org/z/W3d7af">branchless on ARM32</a></p>
<p><strong>Upd 2</strong><br>
Another possible approach:</p>
<div class="codehilite"><pre><span></span><code><span class="k">pub</span><span class="w"> </span><span class="k">extern</span><span class="w"> </span><span class="s">&quot;C&quot;</span><span class="w"> </span><span class="k">fn</span> <span class="nf">nearest</span><span class="p">(</span><span class="n">x</span>: <span class="kt">f64</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="kt">f64</span> <span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">x</span><span class="p">.</span><span class="n">to_bits</span><span class="p">();</span><span class="w"></span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">e</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="mi">52</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="mh">0x7ff_</span><span class="k">u64</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="n">e</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="mh">0x3ff_</span><span class="k">u64</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">52</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="n">x</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="p">(</span><span class="n">x</span><span class="p">.</span><span class="n">abs</span><span class="p">()</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">TOINT_64</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">TOINT_64</span><span class="p">).</span><span class="n">copysign</span><span class="p">(</span><span class="n">x</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>


<p>But this approach has <a href="https://godbolt.org/z/4Mor4a">lower IPC</a></p>
</blockquote>



<a name="208583959"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232171%20runtime%3A%20new%20implementations%20for%20near.../near/208583959" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232171.20runtime.3A.20new.20implementations.20for.20near.2E.2E.2E.html#208583959">(Aug 31 2020 at 16:39)</a>:</h4>
<p>sunfishcode merged <a href="https://github.com/bytecodealliance/wasmtime/pull/2171">PR #2171</a>.</p>



<hr><p>Last updated: Jan 20 2025 at 06:04 UTC</p>
</html>