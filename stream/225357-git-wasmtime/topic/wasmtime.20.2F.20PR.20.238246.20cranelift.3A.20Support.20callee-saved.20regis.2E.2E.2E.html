<html>
<head><meta charset="utf-8"><title>wasmtime / PR #8246 cranelift: Support callee-saved regis... · git-wasmtime · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/index.html">git-wasmtime</a></h2>
<h3>Topic: <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.238246.20cranelift.3A.20Support.20callee-saved.20regis.2E.2E.2E.html">wasmtime / PR #8246 cranelift: Support callee-saved regis...</a></h3>

<hr>

<base href="https://bytecodealliance.zulipchat.com">

<head><link href="https://bytecodealliance.github.io/zulip-archive/style.css" rel="stylesheet"></head>

<a name="429752675"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%238246%20cranelift%3A%20Support%20callee-saved%20regis.../near/429752675" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.238246.20cranelift.3A.20Support.20callee-saved.20regis.2E.2E.2E.html#429752675">(Mar 26 2024 at 22:58)</a>:</h4>
<p>elliottt opened <a href="https://github.com/bytecodealliance/wasmtime/pull/8246">PR #8246</a> from <code>elliottt:trevor/copy-callee-saves</code> to <code>bytecodealliance:main</code>:</p>
<blockquote>
<p>Rework the tail calling convention on x64 to support tail calls by changing the complication strategy in the following ways:</p>
<ol>
<li>Instead of making a shadow frame that we copy over the old one, instead determine if we need to grow or shrink the stack argument area and emit a special-purpose instruction to handle that case.</li>
<li>As we're now growing and shrinking the frame in a separate instruction sequence, emit arguments as moving to FP offsets instead of SP offsets, placing them where they'll need to go for the tail call being setup.</li>
<li>Finally, when emitting a <code>Inst::ReturnCall</code> in the x64 backend, reuse the <code>gen_clobber_save</code> and <code>gen_epilogue_frame_restore</code> functions to setup the frame and any callee-saved registers to the state expected by the callee we're jumping to.</li>
</ol>
<p>With these three changes in place, we modified the x64 abi for tail calls to include a list of callee-saved registers, and observed that we now save them in the prologue, and restore them right before jumping to the tail-callee.</p>
<p>&lt;!--<br>
Please make sure you include the following information:</p>
<ul>
<li>
<p>If this work has been discussed elsewhere, please include a link to that<br>
  conversation. If it was discussed in an issue, just mention "issue #...".</p>
</li>
<li>
<p>Explain why this change is needed. If the details are in an issue already,<br>
  this can be brief.</p>
</li>
</ul>
<p>Our development process is documented in the Wasmtime book:<br>
<a href="https://docs.wasmtime.dev/contributing-development-process.html">https://docs.wasmtime.dev/contributing-development-process.html</a></p>
<p>Please ensure all communication follows the code of conduct:<br>
<a href="https://github.com/bytecodealliance/wasmtime/blob/main/CODE_OF_CONDUCT.md">https://github.com/bytecodealliance/wasmtime/blob/main/CODE_OF_CONDUCT.md</a><br>
--&gt;</p>
</blockquote>



<a name="429752677"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%238246%20cranelift%3A%20Support%20callee-saved%20regis.../near/429752677" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.238246.20cranelift.3A.20Support.20callee-saved.20regis.2E.2E.2E.html#429752677">(Mar 26 2024 at 22:58)</a>:</h4>
<p><strong>elliottt</strong> requested <a href="https://github.com/fitzgen">fitzgen</a> for a review on <a href="https://github.com/bytecodealliance/wasmtime/pull/8246">PR #8246</a>.</p>



<a name="429752678"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%238246%20cranelift%3A%20Support%20callee-saved%20regis.../near/429752678" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.238246.20cranelift.3A.20Support.20callee-saved.20regis.2E.2E.2E.html#429752678">(Mar 26 2024 at 22:58)</a>:</h4>
<p><strong>elliottt</strong> requested <a href="https://github.com/orgs/bytecodealliance/teams/wasmtime-compiler-reviewers">wasmtime-compiler-reviewers</a> for a review on <a href="https://github.com/bytecodealliance/wasmtime/pull/8246">PR #8246</a>.</p>



<a name="429752751"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%238246%20cranelift%3A%20Support%20callee-saved%20regis.../near/429752751" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.238246.20cranelift.3A.20Support.20callee-saved.20regis.2E.2E.2E.html#429752751">(Mar 26 2024 at 22:58)</a>:</h4>
<p>elliottt edited <a href="https://github.com/bytecodealliance/wasmtime/pull/8246">PR #8246</a>:</p>
<blockquote>
<p>Rework the tail calling convention on x64 to support tail calls by changing the complication strategy in the following ways:</p>
<ol>
<li>Instead of making a shadow frame that we copy over the old one, instead determine if we need to grow or shrink the stack argument area and emit a special-purpose instruction to handle that case.</li>
<li>As we're now growing and shrinking the frame in a separate instruction sequence, emit arguments as moving to FP offsets instead of SP offsets, placing them where they'll need to go for the tail call being setup.</li>
<li>Finally, when emitting a <code>Inst::ReturnCall</code> in the x64 backend, reuse the <code>gen_clobber_save</code> and <code>gen_epilogue_frame_restore</code> functions to setup the frame and any callee-saved registers to the state expected by the callee we're jumping to.</li>
</ol>
<p>With these three changes in place, we modified the x64 abi for tail calls to include a list of callee-saved registers, and observed that we now save them in the prologue, and restore them right before jumping to the tail-callee.</p>
<p>Co-authored-by: Jamey Sharp &lt;<a href="mailto:jsharp@fastly.com">jsharp@fastly.com</a>&gt;</p>
<p>&lt;!--<br>
Please make sure you include the following information:</p>
<ul>
<li>
<p>If this work has been discussed elsewhere, please include a link to that<br>
  conversation. If it was discussed in an issue, just mention "issue #...".</p>
</li>
<li>
<p>Explain why this change is needed. If the details are in an issue already,<br>
  this can be brief.</p>
</li>
</ul>
<p>Our development process is documented in the Wasmtime book:<br>
<a href="https://docs.wasmtime.dev/contributing-development-process.html">https://docs.wasmtime.dev/contributing-development-process.html</a></p>
<p>Please ensure all communication follows the code of conduct:<br>
<a href="https://github.com/bytecodealliance/wasmtime/blob/main/CODE_OF_CONDUCT.md">https://github.com/bytecodealliance/wasmtime/blob/main/CODE_OF_CONDUCT.md</a><br>
--&gt;</p>
</blockquote>



<a name="429755576"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%238246%20cranelift%3A%20Support%20callee-saved%20regis.../near/429755576" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.238246.20cranelift.3A.20Support.20callee-saved.20regis.2E.2E.2E.html#429755576">(Mar 26 2024 at 23:25)</a>:</h4>
<p>elliottt updated <a href="https://github.com/bytecodealliance/wasmtime/pull/8246">PR #8246</a>.</p>



<a name="429755781"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%238246%20cranelift%3A%20Support%20callee-saved%20regis.../near/429755781" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.238246.20cranelift.3A.20Support.20callee-saved.20regis.2E.2E.2E.html#429755781">(Mar 26 2024 at 23:27)</a>:</h4>
<p>elliottt edited <a href="https://github.com/bytecodealliance/wasmtime/pull/8246">PR #8246</a>:</p>
<blockquote>
<p>Rework the tail calling convention on x64 to support tail calls by changing the complication strategy in the following ways:</p>
<ol>
<li>Instead of making a shadow frame that we copy over the old one, instead determine if we need to grow or shrink the stack argument area and emit a special-purpose instruction to handle that case.</li>
<li>As we're now growing and shrinking the frame in a separate instruction sequence, emit arguments as moving to FP offsets instead of SP offsets, placing them where they'll need to go for the tail call being setup.</li>
<li>Finally, when emitting a <code>Inst::ReturnCall</code> in the x64 backend, reuse the <code>gen_clobber_save</code> and <code>gen_epilogue_frame_restore</code> functions to setup the frame and any callee-saved registers to the state expected by the callee we're jumping to.</li>
</ol>
<p>With these three changes in place, we modified the x64 abi for tail calls to include a list of callee-saved registers, and observed that we now save them in the prologue, and restore them right before jumping to the tail-callee.</p>
<h2>TODO</h2>
<ul>
<li>[ ] Account for the extra space used by <code>GrowFrame</code> in the stack check</li>
<li>[ ] Revisit the use of <code>r14</code> for the stack limit in the <code>Tail</code> calling convention</li>
</ul>
<p>Co-authored-by: Jamey Sharp &lt;<a href="mailto:jsharp@fastly.com">jsharp@fastly.com</a>&gt;</p>
<p>&lt;!--<br>
Please make sure you include the following information:</p>
<ul>
<li>
<p>If this work has been discussed elsewhere, please include a link to that<br>
  conversation. If it was discussed in an issue, just mention "issue #...".</p>
</li>
<li>
<p>Explain why this change is needed. If the details are in an issue already,<br>
  this can be brief.</p>
</li>
</ul>
<p>Our development process is documented in the Wasmtime book:<br>
<a href="https://docs.wasmtime.dev/contributing-development-process.html">https://docs.wasmtime.dev/contributing-development-process.html</a></p>
<p>Please ensure all communication follows the code of conduct:<br>
<a href="https://github.com/bytecodealliance/wasmtime/blob/main/CODE_OF_CONDUCT.md">https://github.com/bytecodealliance/wasmtime/blob/main/CODE_OF_CONDUCT.md</a><br>
--&gt;</p>
</blockquote>



<a name="429757399"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%238246%20cranelift%3A%20Support%20callee-saved%20regis.../near/429757399" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.238246.20cranelift.3A.20Support.20callee-saved.20regis.2E.2E.2E.html#429757399">(Mar 26 2024 at 23:44)</a>:</h4>
<p>github-actions[bot] <a href="https://github.com/bytecodealliance/wasmtime/pull/8246#issuecomment-2021657848">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/8246">PR #8246</a>:</p>
<blockquote>
<h4>Subscribe to Label Action</h4>
<p>cc @cfallin, @fitzgen</p>
<p>&lt;details&gt;<br>
This issue or pull request has been labeled: "cranelift", "cranelift:area:aarch64", "cranelift:area:machinst", "cranelift:area:x64", "isle"</p>
<p>Thus the following users have been cc'd because of the following labels:</p>
<ul>
<li>cfallin: isle</li>
<li>fitzgen: isle</li>
</ul>
<p>To subscribe or unsubscribe from this label, edit the &lt;code&gt;.github/subscribe-to-label.json&lt;/code&gt; configuration file.</p>
<p><a href="https://github.com/bytecodealliance/subscribe-to-label-action">Learn more.</a><br>
&lt;/details&gt;</p>
</blockquote>



<a name="429763719"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%238246%20cranelift%3A%20Support%20callee-saved%20regis.../near/429763719" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.238246.20cranelift.3A.20Support.20callee-saved.20regis.2E.2E.2E.html#429763719">(Mar 27 2024 at 01:00)</a>:</h4>
<p>jameysharp submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/8246#pullrequestreview-1962018223">PR review</a>:</p>
<blockquote>
<p>I'm proud of the work Trevor and I did on this!</p>
<p>Here's a few quick comments edits after giving this another complete read-through.</p>
</blockquote>



<a name="429763721"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%238246%20cranelift%3A%20Support%20callee-saved%20regis.../near/429763721" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.238246.20cranelift.3A.20Support.20callee-saved.20regis.2E.2E.2E.html#429763721">(Mar 27 2024 at 01:00)</a>:</h4>
<p>jameysharp submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/8246#pullrequestreview-1962018223">PR review</a>:</p>
<blockquote>
<p>I'm proud of the work Trevor and I did on this!</p>
<p>Here's a few quick comments edits after giving this another complete read-through.</p>
</blockquote>



<a name="429763722"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%238246%20cranelift%3A%20Support%20callee-saved%20regis.../near/429763722" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.238246.20cranelift.3A.20Support.20callee-saved.20regis.2E.2E.2E.html#429763722">(Mar 27 2024 at 01:00)</a>:</h4>
<p>jameysharp created <a href="https://github.com/bytecodealliance/wasmtime/pull/8246#discussion_r1540287172">PR review comment</a>:</p>
<blockquote>
<p>Nitpick:</p>
<p><div class="codehilite" data-code-language="suggestion"><pre><span></span><code>            // pointer that are pushed on the stack already.
</code></pre></div><br>
</p>
</blockquote>



<a name="429763723"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%238246%20cranelift%3A%20Support%20callee-saved%20regis.../near/429763723" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.238246.20cranelift.3A.20Support.20callee-saved.20regis.2E.2E.2E.html#429763723">(Mar 27 2024 at 01:00)</a>:</h4>
<p>jameysharp created <a href="https://github.com/bytecodealliance/wasmtime/pull/8246#discussion_r1540288801">PR review comment</a>:</p>
<blockquote>
<p>After we wrote this we discovered the <code>fp_to_arg_offset</code> method which I now realize we could also use here instead of hard-coding 16. That might also be handy for generalizing this in shared code when we extend this work to other targets.</p>
</blockquote>



<a name="429763724"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%238246%20cranelift%3A%20Support%20callee-saved%20regis.../near/429763724" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.238246.20cranelift.3A.20Support.20callee-saved.20regis.2E.2E.2E.html#429763724">(Mar 27 2024 at 01:00)</a>:</h4>
<p>jameysharp created <a href="https://github.com/bytecodealliance/wasmtime/pull/8246#discussion_r1540286070">PR review comment</a>:</p>
<blockquote>
<p>We should update this comment. I guess this will do:</p>
<p><div class="codehilite" data-code-language="suggestion"><pre><span></span><code>        // Finally, do the actual tail call!
</code></pre></div><br>
</p>
</blockquote>



<a name="429764015"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%238246%20cranelift%3A%20Support%20callee-saved%20regis.../near/429764015" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.238246.20cranelift.3A.20Support.20callee-saved.20regis.2E.2E.2E.html#429764015">(Mar 27 2024 at 01:03)</a>:</h4>
<p>jameysharp <a href="https://github.com/bytecodealliance/wasmtime/pull/8246#issuecomment-2021737866">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/8246">PR #8246</a>:</p>
<blockquote>
<p>Also I see we have only one function in the precise-output compile filetests that exercises <code>grow_frame</code>, and none that exercise <code>shrink_frame</code>. I suppose we ought to extend the tests.</p>
</blockquote>



<a name="429777225"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%238246%20cranelift%3A%20Support%20callee-saved%20regis.../near/429777225" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.238246.20cranelift.3A.20Support.20callee-saved.20regis.2E.2E.2E.html#429777225">(Mar 27 2024 at 03:52)</a>:</h4>
<p>elliottt edited <a href="https://github.com/bytecodealliance/wasmtime/pull/8246">PR #8246</a>:</p>
<blockquote>
<p>Rework the tail calling convention on x64 to support tail calls by changing the compilation strategy in the following ways:</p>
<ol>
<li>Instead of making a shadow frame that we copy over the old one, instead determine if we need to grow or shrink the stack argument area and emit a special-purpose instruction to handle that case.</li>
<li>As we're now growing and shrinking the frame in a separate instruction sequence, emit arguments as moving to FP offsets instead of SP offsets, placing them where they'll need to go for the tail call being setup.</li>
<li>Finally, when emitting a <code>Inst::ReturnCall</code> in the x64 backend, reuse the <code>gen_clobber_save</code> and <code>gen_epilogue_frame_restore</code> functions to setup the frame and any callee-saved registers to the state expected by the callee we're jumping to.</li>
</ol>
<p>With these three changes in place, we modified the x64 abi for tail calls to include a list of callee-saved registers, and observed that we now save them in the prologue, and restore them right before jumping to the tail-callee.</p>
<h2>TODO</h2>
<ul>
<li>[ ] Account for the extra space used by <code>GrowFrame</code> in the stack check</li>
<li>[ ] Revisit the use of <code>r14</code> for the stack limit in the <code>Tail</code> calling convention</li>
</ul>
<p>Co-authored-by: Jamey Sharp &lt;<a href="mailto:jsharp@fastly.com">jsharp@fastly.com</a>&gt;</p>
<p>&lt;!--<br>
Please make sure you include the following information:</p>
<ul>
<li>
<p>If this work has been discussed elsewhere, please include a link to that<br>
  conversation. If it was discussed in an issue, just mention "issue #...".</p>
</li>
<li>
<p>Explain why this change is needed. If the details are in an issue already,<br>
  this can be brief.</p>
</li>
</ul>
<p>Our development process is documented in the Wasmtime book:<br>
<a href="https://docs.wasmtime.dev/contributing-development-process.html">https://docs.wasmtime.dev/contributing-development-process.html</a></p>
<p>Please ensure all communication follows the code of conduct:<br>
<a href="https://github.com/bytecodealliance/wasmtime/blob/main/CODE_OF_CONDUCT.md">https://github.com/bytecodealliance/wasmtime/blob/main/CODE_OF_CONDUCT.md</a><br>
--&gt;</p>
</blockquote>



<a name="429881921"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%238246%20cranelift%3A%20Support%20callee-saved%20regis.../near/429881921" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.238246.20cranelift.3A.20Support.20callee-saved.20regis.2E.2E.2E.html#429881921">(Mar 27 2024 at 15:04)</a>:</h4>
<p>fitzgen <a href="https://github.com/bytecodealliance/wasmtime/pull/8246#issuecomment-2023006882">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/8246">PR #8246</a>:</p>
<blockquote>
<p>Super excited for this! Going to start digging in.</p>
<p>Concurrently, would you mind running the default sightglass suite with vs without this change (when enabling the wasm tail calls proposal for both) to determine if this fully resolves <a href="https://github.com/bytecodealliance/wasmtime/issues/6759">https://github.com/bytecodealliance/wasmtime/issues/6759</a> ?</p>
</blockquote>



<a name="429883222"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%238246%20cranelift%3A%20Support%20callee-saved%20regis.../near/429883222" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.238246.20cranelift.3A.20Support.20callee-saved.20regis.2E.2E.2E.html#429883222">(Mar 27 2024 at 15:10)</a>:</h4>
<p>fitzgen <a href="https://github.com/bytecodealliance/wasmtime/pull/8246#issuecomment-2023020006">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/8246">PR #8246</a>:</p>
<blockquote>
<blockquote>
<p>Concurrently, would you mind running the default sightglass suite with vs without this change (when enabling the wasm tail calls proposal for both) to determine if this fully resolves #6759 ?</p>
</blockquote>
<p>Or I guess the comparison we really care about is</p>
<ul>
<li><code>main</code> with default wasm features, versus</li>
<li>this branch with wasm tail calls enabled</li>
</ul>
<p>This gives us the "wasmtime" vs "tail" calling conventions comparison we want.</p>
</blockquote>



<a name="429912035"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%238246%20cranelift%3A%20Support%20callee-saved%20regis.../near/429912035" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.238246.20cranelift.3A.20Support.20callee-saved.20regis.2E.2E.2E.html#429912035">(Mar 27 2024 at 17:27)</a>:</h4>
<p>fitzgen submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/8246#pullrequestreview-1963691200">PR review</a>:</p>
<blockquote>
<p>Thanks!! Lots of nitpicks, but generally really like this.</p>
<p>+1 to comment about more filetests and the lack of <code>shrink_frame</code> testing. Seems like it would be good to exercise the following cases, which it seems like we aren't already:</p>
<ul>
<li>tail call from a function with multiple stack args to a function with a single stack arg</li>
<li>tail call from a function with multiple stack args to a function with zero stack args</li>
<li>tail call from a function with a single stack arg to a function with multiple stack args</li>
<li>tail call from a function with zero stack args to a function with multiple stack args</li>
</ul>
</blockquote>



<a name="429912037"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%238246%20cranelift%3A%20Support%20callee-saved%20regis.../near/429912037" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.238246.20cranelift.3A.20Support.20callee-saved.20regis.2E.2E.2E.html#429912037">(Mar 27 2024 at 17:27)</a>:</h4>
<p>fitzgen submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/8246#pullrequestreview-1963691200">PR review</a>:</p>
<blockquote>
<p>Thanks!! Lots of nitpicks, but generally really like this.</p>
<p>+1 to comment about more filetests and the lack of <code>shrink_frame</code> testing. Seems like it would be good to exercise the following cases, which it seems like we aren't already:</p>
<ul>
<li>tail call from a function with multiple stack args to a function with a single stack arg</li>
<li>tail call from a function with multiple stack args to a function with zero stack args</li>
<li>tail call from a function with a single stack arg to a function with multiple stack args</li>
<li>tail call from a function with zero stack args to a function with multiple stack args</li>
</ul>
</blockquote>



<a name="429912038"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%238246%20cranelift%3A%20Support%20callee-saved%20regis.../near/429912038" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.238246.20cranelift.3A.20Support.20callee-saved.20regis.2E.2E.2E.html#429912038">(Mar 27 2024 at 17:27)</a>:</h4>
<p>fitzgen created <a href="https://github.com/bytecodealliance/wasmtime/pull/8246#discussion_r1541338773">PR review comment</a>:</p>
<blockquote>
<p>Is this doing more than just manipulating SP? I guess it also has to adjust FP and the return pointer to add more stack slots.</p>
<p>As written, the docs make it sound like this is doing the full "reconstruct the frame" thing, but I thought (and maybe I've gotten lost given all the different sequencing versions we've talked about for this stuff) we were planning on avoiding that from now on?</p>
<p>All this to say, I feel like the docs for this pseudo inst (and <code>ShrinkFrame</code> below) could be a bit more precise.</p>
</blockquote>



<a name="429912039"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%238246%20cranelift%3A%20Support%20callee-saved%20regis.../near/429912039" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.238246.20cranelift.3A.20Support.20callee-saved.20regis.2E.2E.2E.html#429912039">(Mar 27 2024 at 17:27)</a>:</h4>
<p>fitzgen created <a href="https://github.com/bytecodealliance/wasmtime/pull/8246#discussion_r1541478467">PR review comment</a>:</p>
<blockquote>
<p>This does not include stack arguments right? I think it is worth noting that in the comment.</p>
<p>(Sorry if these nitpicks on comments are too nitpicky. It's just that all this ABI code is so subtle and finicky and has to be Just Right, that I am constantly questioning everything, and if my questions aren't immediately answered in the comments I get really nervous that I am missing/overlooking something)</p>
</blockquote>



<a name="429912040"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%238246%20cranelift%3A%20Support%20callee-saved%20regis.../near/429912040" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.238246.20cranelift.3A.20Support.20callee-saved.20regis.2E.2E.2E.html#429912040">(Mar 27 2024 at 17:27)</a>:</h4>
<p>fitzgen created <a href="https://github.com/bytecodealliance/wasmtime/pull/8246#discussion_r1541471700">PR review comment</a>:</p>
<blockquote>
<p>Has this <code>TODO</code> been addressed?</p>
</blockquote>



<a name="429912041"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%238246%20cranelift%3A%20Support%20callee-saved%20regis.../near/429912041" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.238246.20cranelift.3A.20Support.20callee-saved.20regis.2E.2E.2E.html#429912041">(Mar 27 2024 at 17:27)</a>:</h4>
<p>fitzgen created <a href="https://github.com/bytecodealliance/wasmtime/pull/8246#discussion_r1541497979">PR review comment</a>:</p>
<blockquote>
<p>Ditto regarding naming here in <code>ShrinkFrame</code> as well.</p>
</blockquote>



<a name="429912042"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%238246%20cranelift%3A%20Support%20callee-saved%20regis.../near/429912042" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.238246.20cranelift.3A.20Support.20callee-saved.20regis.2E.2E.2E.html#429912042">(Mar 27 2024 at 17:27)</a>:</h4>
<p>fitzgen created <a href="https://github.com/bytecodealliance/wasmtime/pull/8246#discussion_r1541501124">PR review comment</a>:</p>
<blockquote>
<p>Same suggestion on rewording this comment the way I suggested for the corresponding comment in <code>GrowFrame</code>.</p>
</blockquote>



<a name="429912043"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%238246%20cranelift%3A%20Support%20callee-saved%20regis.../near/429912043" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.238246.20cranelift.3A.20Support.20callee-saved.20regis.2E.2E.2E.html#429912043">(Mar 27 2024 at 17:27)</a>:</h4>
<p>fitzgen created <a href="https://github.com/bytecodealliance/wasmtime/pull/8246#discussion_r1541499323">PR review comment</a>:</p>
<blockquote>
<p>Ditto regarding comment and whether args are included in the size and ditto regarding the hardcoding of <code>16</code> vs using <code>fp_to_arg_offset</code></p>
</blockquote>



<a name="429912044"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%238246%20cranelift%3A%20Support%20callee-saved%20regis.../near/429912044" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.238246.20cranelift.3A.20Support.20callee-saved.20regis.2E.2E.2E.html#429912044">(Mar 27 2024 at 17:27)</a>:</h4>
<p>fitzgen created <a href="https://github.com/bytecodealliance/wasmtime/pull/8246#discussion_r1541491277">PR review comment</a>:</p>
<blockquote>
<p><div class="codehilite" data-code-language="suggestion"><pre><span></span><code>            // Copy the `i`th word in the stack from `SP + amount + i * 8`
            // to `SP + i * 8`. Do this from lower to higher addresses to
            // avoid clobbering words we haven't copied yet.
</code></pre></div><br>
</p>
</blockquote>



<a name="429912045"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%238246%20cranelift%3A%20Support%20callee-saved%20regis.../near/429912045" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.238246.20cranelift.3A.20Support.20callee-saved.20regis.2E.2E.2E.html#429912045">(Mar 27 2024 at 17:27)</a>:</h4>
<p>fitzgen created <a href="https://github.com/bytecodealliance/wasmtime/pull/8246#discussion_r1541496385">PR review comment</a>:</p>
<blockquote>
<p>I think this snippet of code would be easier to read if we didn't name the readable- and writable-GPR versions of <code>tmp</code> as <code>src</code> and <code>dst</code>. This is essentially doing <code>mov tmp, [SP + N]; move [SP + M], tmp</code> but that isn't obvious to me as a reader.</p>
<p>If we renamed <code>src</code> to <code>readable_tmp</code> and <code>dst</code> to <code>writable_tmp</code> (or something, open to bikeshedding so long as it is clear they are naming the same register) I think this code would be much clearer, and that clarity is easily worth losing the struct literal field shorthand notation here.</p>
</blockquote>



<a name="429912046"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%238246%20cranelift%3A%20Support%20callee-saved%20regis.../near/429912046" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.238246.20cranelift.3A.20Support.20callee-saved.20regis.2E.2E.2E.html#429912046">(Mar 27 2024 at 17:27)</a>:</h4>
<p>fitzgen created <a href="https://github.com/bytecodealliance/wasmtime/pull/8246#discussion_r1541514612">PR review comment</a>:</p>
<blockquote>
<p>Likewise about frame pointers being enabled.</p>
</blockquote>



<a name="429912047"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%238246%20cranelift%3A%20Support%20callee-saved%20regis.../near/429912047" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.238246.20cranelift.3A.20Support.20callee-saved.20regis.2E.2E.2E.html#429912047">(Mar 27 2024 at 17:27)</a>:</h4>
<p>fitzgen created <a href="https://github.com/bytecodealliance/wasmtime/pull/8246#discussion_r1541515746">PR review comment</a>:</p>
<blockquote>
<p>FWIW, this is the kind of thing I'm referring to when I talk about diagrams being nice to have in <code>{Grow,Shrink}Frame</code>.</p>
</blockquote>



<a name="429912049"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%238246%20cranelift%3A%20Support%20callee-saved%20regis.../near/429912049" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.238246.20cranelift.3A.20Support.20callee-saved.20regis.2E.2E.2E.html#429912049">(Mar 27 2024 at 17:27)</a>:</h4>
<p>fitzgen created <a href="https://github.com/bytecodealliance/wasmtime/pull/8246#discussion_r1541508463">PR review comment</a>:</p>
<blockquote>
<p>Is this going to break return calls on non-x64 until we get around to poring these architectures to the new tail call strategy? I don't think this PR should regress any existing functionality.</p>
</blockquote>



<a name="429912050"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%238246%20cranelift%3A%20Support%20callee-saved%20regis.../near/429912050" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.238246.20cranelift.3A.20Support.20callee-saved.20regis.2E.2E.2E.html#429912050">(Mar 27 2024 at 17:27)</a>:</h4>
<p>fitzgen created <a href="https://github.com/bytecodealliance/wasmtime/pull/8246#discussion_r1541523555">PR review comment</a>:</p>
<blockquote>
<p>Can we document what base this is an offset from? SP right?</p>
</blockquote>



<a name="429912051"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%238246%20cranelift%3A%20Support%20callee-saved%20regis.../near/429912051" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.238246.20cranelift.3A.20Support.20callee-saved.20regis.2E.2E.2E.html#429912051">(Mar 27 2024 at 17:27)</a>:</h4>
<p>fitzgen created <a href="https://github.com/bytecodealliance/wasmtime/pull/8246#discussion_r1541518985">PR review comment</a>:</p>
<blockquote>
<p>Nice.</p>
</blockquote>



<a name="429912052"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%238246%20cranelift%3A%20Support%20callee-saved%20regis.../near/429912052" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.238246.20cranelift.3A.20Support.20callee-saved.20regis.2E.2E.2E.html#429912052">(Mar 27 2024 at 17:27)</a>:</h4>
<p>fitzgen created <a href="https://github.com/bytecodealliance/wasmtime/pull/8246#discussion_r1541532980">PR review comment</a>:</p>
<blockquote>
<p>Can we debug assert that we have frame pointers enabled here?</p>
</blockquote>



<a name="429912053"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%238246%20cranelift%3A%20Support%20callee-saved%20regis.../near/429912053" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.238246.20cranelift.3A.20Support.20callee-saved.20regis.2E.2E.2E.html#429912053">(Mar 27 2024 at 17:27)</a>:</h4>
<p>fitzgen created <a href="https://github.com/bytecodealliance/wasmtime/pull/8246#discussion_r1541511489">PR review comment</a>:</p>
<blockquote>
<p>Can we debug assert that frame pointers are enabled here? Or guard this on frame pointers being enabled?</p>
</blockquote>



<a name="429912054"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%238246%20cranelift%3A%20Support%20callee-saved%20regis.../near/429912054" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.238246.20cranelift.3A.20Support.20callee-saved.20regis.2E.2E.2E.html#429912054">(Mar 27 2024 at 17:27)</a>:</h4>
<p>fitzgen created <a href="https://github.com/bytecodealliance/wasmtime/pull/8246#discussion_r1541537860">PR review comment</a>:</p>
<blockquote>
<p>I guess the offset is either SP or FP depending on whether the call is a tail call or not? That is pretty subtle and seems relatively easy to mix up. Is there a reason we can't keep using <code>StackAMode</code> here? That would avoid mix ups because we would always have to match on the amode to determine whether we are dealing with SP or FP offsets. I think it would be fine to have <code>unreachable!()</code> arms in these matches if we always use SP for regular calls and FP for tail calls, but avoiding the mix-up footgun is nice.</p>
</blockquote>



<a name="429912055"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%238246%20cranelift%3A%20Support%20callee-saved%20regis.../near/429912055" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.238246.20cranelift.3A.20Support.20callee-saved.20regis.2E.2E.2E.html#429912055">(Mar 27 2024 at 17:27)</a>:</h4>
<p>fitzgen created <a href="https://github.com/bytecodealliance/wasmtime/pull/8246#discussion_r1541527824">PR review comment</a>:</p>
<blockquote>
<p>(And presumably this change is because we don't need the full generality of <code>StackAMode</code> anymore?)</p>
</blockquote>



<a name="429912056"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%238246%20cranelift%3A%20Support%20callee-saved%20regis.../near/429912056" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.238246.20cranelift.3A.20Support.20callee-saved.20regis.2E.2E.2E.html#429912056">(Mar 27 2024 at 17:27)</a>:</h4>
<p>fitzgen created <a href="https://github.com/bytecodealliance/wasmtime/pull/8246#discussion_r1541480252">PR review comment</a>:</p>
<blockquote>
<p>Diagrams of the stack frame, with labeled sections/slots, could help alleviate some of my fears/questions here. Y'all should know I'm a sucker for ASCII diagrams in comments by now :-p</p>
</blockquote>



<a name="429912057"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%238246%20cranelift%3A%20Support%20callee-saved%20regis.../near/429912057" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.238246.20cranelift.3A.20Support.20callee-saved.20regis.2E.2E.2E.html#429912057">(Mar 27 2024 at 17:27)</a>:</h4>
<p>fitzgen created <a href="https://github.com/bytecodealliance/wasmtime/pull/8246#discussion_r1541475431">PR review comment</a>:</p>
<blockquote>
<p>+1 for using <code>fp_to_arg_offset</code> and avoiding the hard coding here (or at least consolidating the hard coding in that method).</p>
</blockquote>



<a name="429912391"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%238246%20cranelift%3A%20Support%20callee-saved%20regis.../near/429912391" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.238246.20cranelift.3A.20Support.20callee-saved.20regis.2E.2E.2E.html#429912391">(Mar 27 2024 at 17:29)</a>:</h4>
<p>elliottt updated <a href="https://github.com/bytecodealliance/wasmtime/pull/8246">PR #8246</a>.</p>



<a name="429917437"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%238246%20cranelift%3A%20Support%20callee-saved%20regis.../near/429917437" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.238246.20cranelift.3A.20Support.20callee-saved.20regis.2E.2E.2E.html#429917437">(Mar 27 2024 at 17:58)</a>:</h4>
<p>jameysharp submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/8246#pullrequestreview-1964041400">PR review</a>.</p>



<a name="429917438"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%238246%20cranelift%3A%20Support%20callee-saved%20regis.../near/429917438" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.238246.20cranelift.3A.20Support.20callee-saved.20regis.2E.2E.2E.html#429917438">(Mar 27 2024 at 17:58)</a>:</h4>
<p>jameysharp submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/8246#pullrequestreview-1964041400">PR review</a>.</p>



<a name="429917439"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%238246%20cranelift%3A%20Support%20callee-saved%20regis.../near/429917439" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.238246.20cranelift.3A.20Support.20callee-saved.20regis.2E.2E.2E.html#429917439">(Mar 27 2024 at 17:58)</a>:</h4>
<p>jameysharp created <a href="https://github.com/bytecodealliance/wasmtime/pull/8246#discussion_r1541574817">PR review comment</a>:</p>
<blockquote>
<p>No. I haven't traced through enough to understand how we should influence the stack check yet.</p>
</blockquote>



<a name="429917440"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%238246%20cranelift%3A%20Support%20callee-saved%20regis.../near/429917440" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.238246.20cranelift.3A.20Support.20callee-saved.20regis.2E.2E.2E.html#429917440">(Mar 27 2024 at 17:58)</a>:</h4>
<p>jameysharp created <a href="https://github.com/bytecodealliance/wasmtime/pull/8246#discussion_r1541573573">PR review comment</a>:</p>
<blockquote>
<p><code>GrowFrame</code> does a memmove of everything in the frame except for the argument area, to make more room in the argument area. That includes all the stack slots, the callee-saved registers, and the saved FP and return address. To keep the stack pointers in sync with that change, it also subtracts the given amount from both the FP and SP registers. <code>ShrinkFrame</code> is the same but in the other direction.</p>
<p>Ulrich's suggestion in today's Cranelift meeting that we allocate the maximum necessary space during the prologue instead lets us get rid of this memmove and only maybe have to move the return address, but we want to land this version first.</p>
</blockquote>



<a name="429917441"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%238246%20cranelift%3A%20Support%20callee-saved%20regis.../near/429917441" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.238246.20cranelift.3A.20Support.20callee-saved.20regis.2E.2E.2E.html#429917441">(Mar 27 2024 at 17:58)</a>:</h4>
<p>jameysharp created <a href="https://github.com/bytecodealliance/wasmtime/pull/8246#discussion_r1541583490">PR review comment</a>:</p>
<blockquote>
<p>We haven't removed the assert in <code>emit_return_call_common_sequence</code> that frame pointers are enabled, but yeah, we should add that in both <code>ShrinkFrame</code> and <code>GrowFrame</code> as well.</p>
</blockquote>



<a name="429917442"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%238246%20cranelift%3A%20Support%20callee-saved%20regis.../near/429917442" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.238246.20cranelift.3A.20Support.20callee-saved.20regis.2E.2E.2E.html#429917442">(Mar 27 2024 at 17:58)</a>:</h4>
<p>jameysharp created <a href="https://github.com/bytecodealliance/wasmtime/pull/8246#discussion_r1541596873">PR review comment</a>:</p>
<blockquote>
<p>This offset always describes the number of bytes into the argument area. Whether we find the argument area relative to FP or SP depends on how <code>gen_arg</code>'s caller is set up, not on ABI details. That's why we switched away from encoding that decision here.</p>
</blockquote>



<a name="429917443"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%238246%20cranelift%3A%20Support%20callee-saved%20regis.../near/429917443" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.238246.20cranelift.3A.20Support.20callee-saved.20regis.2E.2E.2E.html#429917443">(Mar 27 2024 at 17:58)</a>:</h4>
<p>jameysharp created <a href="https://github.com/bytecodealliance/wasmtime/pull/8246#discussion_r1541560935">PR review comment</a>:</p>
<blockquote>
<p>Nope, we're using <code>Call</code> instead of <code>ReturnCall</code> here specifically to avoid breaking aarch64 and riscv64 until we can get around to applying similar changes to them. <code>from_func</code> was always using <code>Call</code> for the opcode before so passing that here now doesn't change what data structures that function constructs, and then we rely on the distinction in the new <code>is_tail_call</code> helper to ensure that the generated code isn't changed.</p>
</blockquote>



<a name="429927190"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%238246%20cranelift%3A%20Support%20callee-saved%20regis.../near/429927190" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.238246.20cranelift.3A.20Support.20callee-saved.20regis.2E.2E.2E.html#429927190">(Mar 27 2024 at 18:57)</a>:</h4>
<p>elliottt updated <a href="https://github.com/bytecodealliance/wasmtime/pull/8246">PR #8246</a>.</p>



<a name="429927343"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%238246%20cranelift%3A%20Support%20callee-saved%20regis.../near/429927343" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.238246.20cranelift.3A.20Support.20callee-saved.20regis.2E.2E.2E.html#429927343">(Mar 27 2024 at 18:58)</a>:</h4>
<p>elliottt updated <a href="https://github.com/bytecodealliance/wasmtime/pull/8246">PR #8246</a>.</p>



<a name="429938844"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%238246%20cranelift%3A%20Support%20callee-saved%20regis.../near/429938844" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.238246.20cranelift.3A.20Support.20callee-saved.20regis.2E.2E.2E.html#429938844">(Mar 27 2024 at 20:10)</a>:</h4>
<p>jameysharp submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/8246#pullrequestreview-1964650889">PR review</a>.</p>



<a name="429938845"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%238246%20cranelift%3A%20Support%20callee-saved%20regis.../near/429938845" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.238246.20cranelift.3A.20Support.20callee-saved.20regis.2E.2E.2E.html#429938845">(Mar 27 2024 at 20:10)</a>:</h4>
<p>jameysharp created <a href="https://github.com/bytecodealliance/wasmtime/pull/8246#discussion_r1541965387">PR review comment</a>:</p>
<blockquote>
<p>On all targets, the stack limit check is based solely on <code>stackslots_size</code> plus the number of spillslots. (And spillslots are always word-sized, I see, which I'm confused about, but that's not the point right now.)</p>
<p>As far as I can tell, this means the stack limit check never accounts for the size of a callee's argument or setup areas. So I guess we don't need to worry about it for tail calls either?</p>
</blockquote>



<a name="429940563"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%238246%20cranelift%3A%20Support%20callee-saved%20regis.../near/429940563" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.238246.20cranelift.3A.20Support.20callee-saved.20regis.2E.2E.2E.html#429940563">(Mar 27 2024 at 20:19)</a>:</h4>
<p>elliottt edited <a href="https://github.com/bytecodealliance/wasmtime/pull/8246">PR #8246</a>:</p>
<blockquote>
<p>Rework the tail calling convention on x64 to support tail calls by changing the compilation strategy in the following ways:</p>
<ol>
<li>Instead of making a shadow frame that we copy over the old one, instead determine if we need to grow or shrink the stack argument area and emit a special-purpose instruction to handle that case.</li>
<li>As we're now growing and shrinking the frame in a separate instruction sequence, emit arguments as moving to FP offsets instead of SP offsets, placing them where they'll need to go for the tail call being setup.</li>
<li>Finally, when emitting a <code>Inst::ReturnCall</code> in the x64 backend, reuse the <code>gen_clobber_save</code> and <code>gen_epilogue_frame_restore</code> functions to setup the frame and any callee-saved registers to the state expected by the callee we're jumping to.</li>
</ol>
<p>With these three changes in place, we modified the x64 abi for tail calls to include a list of callee-saved registers, and observed that we now save them in the prologue, and restore them right before jumping to the tail-callee.</p>
<h2>TODO</h2>
<ul>
<li>[ ] Account for the extra space used by <code>GrowFrame</code> in the stack check</li>
<li>[x] Revisit the use of <code>r14</code> for the stack limit in the <code>Tail</code> calling convention</li>
</ul>
<p>Co-authored-by: Jamey Sharp &lt;<a href="mailto:jsharp@fastly.com">jsharp@fastly.com</a>&gt;</p>
<p>&lt;!--<br>
Please make sure you include the following information:</p>
<ul>
<li>
<p>If this work has been discussed elsewhere, please include a link to that<br>
  conversation. If it was discussed in an issue, just mention "issue #...".</p>
</li>
<li>
<p>Explain why this change is needed. If the details are in an issue already,<br>
  this can be brief.</p>
</li>
</ul>
<p>Our development process is documented in the Wasmtime book:<br>
<a href="https://docs.wasmtime.dev/contributing-development-process.html">https://docs.wasmtime.dev/contributing-development-process.html</a></p>
<p>Please ensure all communication follows the code of conduct:<br>
<a href="https://github.com/bytecodealliance/wasmtime/blob/main/CODE_OF_CONDUCT.md">https://github.com/bytecodealliance/wasmtime/blob/main/CODE_OF_CONDUCT.md</a><br>
--&gt;</p>
</blockquote>



<a name="429943883"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%238246%20cranelift%3A%20Support%20callee-saved%20regis.../near/429943883" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.238246.20cranelift.3A.20Support.20callee-saved.20regis.2E.2E.2E.html#429943883">(Mar 27 2024 at 20:35)</a>:</h4>
<p>elliottt updated <a href="https://github.com/bytecodealliance/wasmtime/pull/8246">PR #8246</a>.</p>



<a name="429947581"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%238246%20cranelift%3A%20Support%20callee-saved%20regis.../near/429947581" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.238246.20cranelift.3A.20Support.20callee-saved.20regis.2E.2E.2E.html#429947581">(Mar 27 2024 at 20:53)</a>:</h4>
<p>elliottt submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/8246#pullrequestreview-1964749647">PR review</a>.</p>



<a name="429947584"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%238246%20cranelift%3A%20Support%20callee-saved%20regis.../near/429947584" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.238246.20cranelift.3A.20Support.20callee-saved.20regis.2E.2E.2E.html#429947584">(Mar 27 2024 at 20:53)</a>:</h4>
<p>elliottt created <a href="https://github.com/bytecodealliance/wasmtime/pull/8246#discussion_r1542030491">PR review comment</a>:</p>
<blockquote>
<p>I went with <code>tmp</code> and <code>tmp_w</code> like we had in the previous implementation <span aria-label="+1" class="emoji emoji-1f44d" role="img" title="+1">:+1:</span> </p>
</blockquote>



<a name="429948397"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%238246%20cranelift%3A%20Support%20callee-saved%20regis.../near/429948397" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.238246.20cranelift.3A.20Support.20callee-saved.20regis.2E.2E.2E.html#429948397">(Mar 27 2024 at 20:59)</a>:</h4>
<p>elliottt updated <a href="https://github.com/bytecodealliance/wasmtime/pull/8246">PR #8246</a>.</p>



<a name="429958913"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%238246%20cranelift%3A%20Support%20callee-saved%20regis.../near/429958913" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.238246.20cranelift.3A.20Support.20callee-saved.20regis.2E.2E.2E.html#429958913">(Mar 27 2024 at 22:22)</a>:</h4>
<p>elliottt updated <a href="https://github.com/bytecodealliance/wasmtime/pull/8246">PR #8246</a>.</p>



<a name="429961885"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%238246%20cranelift%3A%20Support%20callee-saved%20regis.../near/429961885" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.238246.20cranelift.3A.20Support.20callee-saved.20regis.2E.2E.2E.html#429961885">(Mar 27 2024 at 22:49)</a>:</h4>
<p>elliottt updated <a href="https://github.com/bytecodealliance/wasmtime/pull/8246">PR #8246</a>.</p>



<a name="429964743"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%238246%20cranelift%3A%20Support%20callee-saved%20regis.../near/429964743" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.238246.20cranelift.3A.20Support.20callee-saved.20regis.2E.2E.2E.html#429964743">(Mar 27 2024 at 23:16)</a>:</h4>
<p>fitzgen submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/8246#pullrequestreview-1964909352">PR review</a>:</p>
<blockquote>
<p>Looks great! Thanks! <span aria-label="tada" class="emoji emoji-1f389" role="img" title="tada">:tada:</span> </p>
<p>Excited for the benchmark results!</p>
</blockquote>



<a name="429964744"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%238246%20cranelift%3A%20Support%20callee-saved%20regis.../near/429964744" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.238246.20cranelift.3A.20Support.20callee-saved.20regis.2E.2E.2E.html#429964744">(Mar 27 2024 at 23:16)</a>:</h4>
<p>fitzgen created <a href="https://github.com/bytecodealliance/wasmtime/pull/8246#discussion_r1542142486">PR review comment</a>:</p>
<blockquote>
<p>Nice, thanks for these tests.</p>
</blockquote>



<a name="429964745"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%238246%20cranelift%3A%20Support%20callee-saved%20regis.../near/429964745" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.238246.20cranelift.3A.20Support.20callee-saved.20regis.2E.2E.2E.html#429964745">(Mar 27 2024 at 23:16)</a>:</h4>
<p>fitzgen submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/8246#pullrequestreview-1964909352">PR review</a>:</p>
<blockquote>
<p>Looks great! Thanks! <span aria-label="tada" class="emoji emoji-1f389" role="img" title="tada">:tada:</span> </p>
<p>Excited for the benchmark results!</p>
</blockquote>



<a name="429964746"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%238246%20cranelift%3A%20Support%20callee-saved%20regis.../near/429964746" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.238246.20cranelift.3A.20Support.20callee-saved.20regis.2E.2E.2E.html#429964746">(Mar 27 2024 at 23:16)</a>:</h4>
<p>fitzgen created <a href="https://github.com/bytecodealliance/wasmtime/pull/8246#discussion_r1542140114">PR review comment</a>:</p>
<blockquote>
<p>These comments are fantastic -- thanks!</p>
</blockquote>



<a name="429964933"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%238246%20cranelift%3A%20Support%20callee-saved%20regis.../near/429964933" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.238246.20cranelift.3A.20Support.20callee-saved.20regis.2E.2E.2E.html#429964933">(Mar 27 2024 at 23:18)</a>:</h4>
<p>elliottt <a href="https://github.com/bytecodealliance/wasmtime/pull/8246#issuecomment-2024139787">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/8246">PR #8246</a>:</p>
<blockquote>
<p>Here are the execution benchmarks for <code>spidermonkey</code>, <code>bz2</code>, and <code>pulldown-cmark</code> relative to the current tail calls implementation on main:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="n">execution</span><span class="w"> </span>:: <span class="nc">instructions</span><span class="o">-</span><span class="n">retired</span><span class="w"> </span>:: <span class="nc">benchmarks</span><span class="o">/</span><span class="n">spidermonkey</span><span class="o">/</span><span class="n">benchmark</span><span class="p">.</span><span class="n">wasm</span>

<span class="w">  </span><span class="err">Δ</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">204255214.50</span><span class="w"> </span><span class="err">±</span><span class="w"> </span><span class="mf">513219.80</span><span class="w"> </span><span class="p">(</span><span class="n">confidence</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">99</span><span class="o">%</span><span class="p">)</span>

<span class="w">  </span><span class="n">tail</span><span class="o">-</span><span class="n">calls</span><span class="p">.</span><span class="n">so</span><span class="w"> </span><span class="n">is</span><span class="w"> </span><span class="mf">1.08</span><span class="n">x</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="mf">1.08</span><span class="n">x</span><span class="w"> </span><span class="n">faster</span><span class="w"> </span><span class="n">than</span><span class="w"> </span><span class="n">main</span><span class="p">.</span><span class="n">so</span><span class="o">!</span>

<span class="w">  </span><span class="p">[</span><span class="mi">2862185961</span><span class="w"> </span><span class="mf">2862312218.75</span><span class="w"> </span><span class="mi">2862598037</span><span class="p">]</span><span class="w"> </span><span class="n">main</span><span class="p">.</span><span class="n">so</span>
<span class="w">  </span><span class="p">[</span><span class="mi">2657985419</span><span class="w"> </span><span class="mf">2658057004.25</span><span class="w"> </span><span class="mi">2658128352</span><span class="p">]</span><span class="w"> </span><span class="n">tail</span><span class="o">-</span><span class="n">calls</span><span class="p">.</span><span class="n">so</span>

<span class="n">execution</span><span class="w"> </span>:: <span class="nc">instructions</span><span class="o">-</span><span class="n">retired</span><span class="w"> </span>:: <span class="nc">benchmarks</span><span class="o">/</span><span class="n">bz2</span><span class="o">/</span><span class="n">benchmark</span><span class="p">.</span><span class="n">wasm</span>

<span class="w">  </span><span class="err">Δ</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">13264568.75</span><span class="w"> </span><span class="err">±</span><span class="w"> </span><span class="mf">1.43</span><span class="w"> </span><span class="p">(</span><span class="n">confidence</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">99</span><span class="o">%</span><span class="p">)</span>

<span class="w">  </span><span class="n">tail</span><span class="o">-</span><span class="n">calls</span><span class="p">.</span><span class="n">so</span><span class="w"> </span><span class="n">is</span><span class="w"> </span><span class="mf">1.06</span><span class="n">x</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="mf">1.06</span><span class="n">x</span><span class="w"> </span><span class="n">faster</span><span class="w"> </span><span class="n">than</span><span class="w"> </span><span class="n">main</span><span class="p">.</span><span class="n">so</span><span class="o">!</span>

<span class="w">  </span><span class="p">[</span><span class="mi">239534828</span><span class="w"> </span><span class="mf">239534828.25</span><span class="w"> </span><span class="mi">239534829</span><span class="p">]</span><span class="w"> </span><span class="n">main</span><span class="p">.</span><span class="n">so</span>
<span class="w">  </span><span class="p">[</span><span class="mi">226270259</span><span class="w"> </span><span class="mf">226270259.50</span><span class="w"> </span><span class="mi">226270260</span><span class="p">]</span><span class="w"> </span><span class="n">tail</span><span class="o">-</span><span class="n">calls</span><span class="p">.</span><span class="n">so</span>

<span class="n">execution</span><span class="w"> </span>:: <span class="nc">instructions</span><span class="o">-</span><span class="n">retired</span><span class="w"> </span>:: <span class="nc">benchmarks</span><span class="o">/</span><span class="n">pulldown</span><span class="o">-</span><span class="n">cmark</span><span class="o">/</span><span class="n">benchmark</span><span class="p">.</span><span class="n">wasm</span>

<span class="w">  </span><span class="err">Δ</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">391358.50</span><span class="w"> </span><span class="err">±</span><span class="w"> </span><span class="mf">894.30</span><span class="w"> </span><span class="p">(</span><span class="n">confidence</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">99</span><span class="o">%</span><span class="p">)</span>

<span class="w">  </span><span class="n">tail</span><span class="o">-</span><span class="n">calls</span><span class="p">.</span><span class="n">so</span><span class="w"> </span><span class="n">is</span><span class="w"> </span><span class="mf">1.02</span><span class="n">x</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="mf">1.02</span><span class="n">x</span><span class="w"> </span><span class="n">faster</span><span class="w"> </span><span class="n">than</span><span class="w"> </span><span class="n">main</span><span class="p">.</span><span class="n">so</span><span class="o">!</span>

<span class="w">  </span><span class="p">[</span><span class="mi">20465937</span><span class="w"> </span><span class="mf">20466114.00</span><span class="w"> </span><span class="mi">20466584</span><span class="p">]</span><span class="w"> </span><span class="n">main</span><span class="p">.</span><span class="n">so</span>
<span class="w">  </span><span class="p">[</span><span class="mi">20074442</span><span class="w"> </span><span class="mf">20074755.50</span><span class="w"> </span><span class="mi">20075106</span><span class="p">]</span><span class="w"> </span><span class="n">tail</span><span class="o">-</span><span class="n">calls</span><span class="p">.</span><span class="n">so</span>
</code></pre></div>
<p>Running the same benchmarks on main without tail calls and this branch with tail calls separately, yields the following results:</p>
<h3>main</h3>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="n">execution</span>
<span class="w">  </span><span class="n">benchmarks</span><span class="o">/</span><span class="n">bz2</span><span class="o">/</span><span class="n">benchmark</span><span class="p">.</span><span class="n">wasm</span>
<span class="w">    </span><span class="n">instructions</span><span class="o">-</span><span class="n">retired</span>
<span class="w">      </span><span class="p">[</span><span class="mi">226286674</span><span class="w"> </span><span class="mf">226286674.00</span><span class="w"> </span><span class="mi">226286674</span><span class="p">]</span><span class="w"> </span><span class="o">/</span><span class="n">home</span><span class="o">/</span><span class="n">trevor</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">main</span><span class="p">.</span><span class="n">so</span>
<span class="w">  </span><span class="n">benchmarks</span><span class="o">/</span><span class="n">pulldown</span><span class="o">-</span><span class="n">cmark</span><span class="o">/</span><span class="n">benchmark</span><span class="p">.</span><span class="n">wasm</span>
<span class="w">    </span><span class="n">instructions</span><span class="o">-</span><span class="n">retired</span>
<span class="w">      </span><span class="p">[</span><span class="mi">20080325</span><span class="w"> </span><span class="mf">20080512.75</span><span class="w"> </span><span class="mi">20080999</span><span class="p">]</span><span class="w"> </span><span class="o">/</span><span class="n">home</span><span class="o">/</span><span class="n">trevor</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">main</span><span class="p">.</span><span class="n">so</span>
<span class="w">  </span><span class="n">benchmarks</span><span class="o">/</span><span class="n">spidermonkey</span><span class="o">/</span><span class="n">benchmark</span><span class="p">.</span><span class="n">wasm</span>
<span class="w">    </span><span class="n">instructions</span><span class="o">-</span><span class="n">retired</span>
<span class="w">      </span><span class="p">[</span><span class="mi">2659583881</span><span class="w"> </span><span class="mf">2659624337.75</span><span class="w"> </span><span class="mi">2659672231</span><span class="p">]</span><span class="w"> </span><span class="o">/</span><span class="n">home</span><span class="o">/</span><span class="n">trevor</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">main</span><span class="p">.</span><span class="n">so</span>
</code></pre></div>
<h3>this branch</h3>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="n">execution</span>
<span class="w">  </span><span class="n">benchmarks</span><span class="o">/</span><span class="n">bz2</span><span class="o">/</span><span class="n">benchmark</span><span class="p">.</span><span class="n">wasm</span>
<span class="w">    </span><span class="n">instructions</span><span class="o">-</span><span class="n">retired</span>
<span class="w">      </span><span class="p">[</span><span class="mi">226270259</span><span class="w"> </span><span class="mf">226270259.50</span><span class="w"> </span><span class="mi">226270260</span><span class="p">]</span><span class="w"> </span><span class="o">/</span><span class="n">home</span><span class="o">/</span><span class="n">trevor</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">tail</span><span class="o">-</span><span class="n">calls</span><span class="p">.</span><span class="n">so</span>
<span class="w">  </span><span class="n">benchmarks</span><span class="o">/</span><span class="n">pulldown</span><span class="o">-</span><span class="n">cmark</span><span class="o">/</span><span class="n">benchmark</span><span class="p">.</span><span class="n">wasm</span>
<span class="w">    </span><span class="n">instructions</span><span class="o">-</span><span class="n">retired</span>
<span class="w">      </span><span class="p">[</span><span class="mi">20074405</span><span class="w"> </span><span class="mf">20074419.00</span><span class="w"> </span><span class="mi">20074445</span><span class="p">]</span><span class="w"> </span><span class="o">/</span><span class="n">home</span><span class="o">/</span><span class="n">trevor</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">tail</span><span class="o">-</span><span class="n">calls</span><span class="p">.</span><span class="n">so</span>
<span class="w">  </span><span class="n">benchmarks</span><span class="o">/</span><span class="n">spidermonkey</span><span class="o">/</span><span class="n">benchmark</span><span class="p">.</span><span class="n">wasm</span>
<span class="w">    </span><span class="n">instructions</span><span class="o">-</span><span class="n">retired</span>
<span class="w">      </span><span class="p">[</span><span class="mi">2657979471</span><span class="w"> </span><span class="mf">2658099662.50</span><span class="w"> </span><span class="mi">2658220755</span><span class="p">]</span><span class="w"> </span><span class="o">/</span><span class="n">home</span><span class="o">/</span><span class="n">trevor</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">tail</span><span class="o">-</span><span class="n">calls</span><span class="p">.</span><span class="n">so</span>
</code></pre></div>
<p>It's exciting to see that the max for the tail-calls branch is smaller than the min of main for spidermonkey, though even if that's spurious they're still in the same ballpark <span aria-label="tada" class="emoji emoji-1f389" role="img" title="tada">:tada:</span> </p>
</blockquote>



<a name="429965054"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%238246%20cranelift%3A%20Support%20callee-saved%20regis.../near/429965054" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.238246.20cranelift.3A.20Support.20callee-saved.20regis.2E.2E.2E.html#429965054">(Mar 27 2024 at 23:19)</a>:</h4>
<p>jameysharp edited <a href="https://github.com/bytecodealliance/wasmtime/pull/8246">PR #8246</a>:</p>
<blockquote>
<p>Rework the tail calling convention on x64 to support tail calls by changing the compilation strategy in the following ways:</p>
<ol>
<li>Instead of making a shadow frame that we copy over the old one, instead determine if we need to grow or shrink the stack argument area and emit a special-purpose instruction to handle that case.</li>
<li>As we're now growing and shrinking the frame in a separate instruction sequence, emit arguments as moving to FP offsets instead of SP offsets, placing them where they'll need to go for the tail call being setup.</li>
<li>Finally, when emitting a <code>Inst::ReturnCall</code> in the x64 backend, reuse the <code>gen_clobber_save</code> and <code>gen_epilogue_frame_restore</code> functions to setup the frame and any callee-saved registers to the state expected by the callee we're jumping to.</li>
</ol>
<p>With these three changes in place, we modified the x64 abi for tail calls to include a list of callee-saved registers, and observed that we now save them in the prologue, and restore them right before jumping to the tail-callee.</p>
<h2>TODO</h2>
<ul>
<li>[x] Account for the extra space used by <code>GrowFrame</code> in the stack check</li>
<li>[x] Revisit the use of <code>r14</code> for the stack limit in the <code>Tail</code> calling convention</li>
</ul>
<p>Co-authored-by: Jamey Sharp &lt;<a href="mailto:jsharp@fastly.com">jsharp@fastly.com</a>&gt;</p>
<p>&lt;!--<br>
Please make sure you include the following information:</p>
<ul>
<li>
<p>If this work has been discussed elsewhere, please include a link to that<br>
  conversation. If it was discussed in an issue, just mention "issue #...".</p>
</li>
<li>
<p>Explain why this change is needed. If the details are in an issue already,<br>
  this can be brief.</p>
</li>
</ul>
<p>Our development process is documented in the Wasmtime book:<br>
<a href="https://docs.wasmtime.dev/contributing-development-process.html">https://docs.wasmtime.dev/contributing-development-process.html</a></p>
<p>Please ensure all communication follows the code of conduct:<br>
<a href="https://github.com/bytecodealliance/wasmtime/blob/main/CODE_OF_CONDUCT.md">https://github.com/bytecodealliance/wasmtime/blob/main/CODE_OF_CONDUCT.md</a><br>
--&gt;</p>
</blockquote>



<a name="429965284"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%238246%20cranelift%3A%20Support%20callee-saved%20regis.../near/429965284" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.238246.20cranelift.3A.20Support.20callee-saved.20regis.2E.2E.2E.html#429965284">(Mar 27 2024 at 23:22)</a>:</h4>
<p>fitzgen <a href="https://github.com/bytecodealliance/wasmtime/pull/8246#issuecomment-2024144099">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/8246">PR #8246</a>:</p>
<blockquote>
<p>Ship it!</p>
</blockquote>



<a name="429967949"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%238246%20cranelift%3A%20Support%20callee-saved%20regis.../near/429967949" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.238246.20cranelift.3A.20Support.20callee-saved.20regis.2E.2E.2E.html#429967949">(Mar 27 2024 at 23:50)</a>:</h4>
<p>elliottt merged <a href="https://github.com/bytecodealliance/wasmtime/pull/8246">PR #8246</a>.</p>



<hr><p>Last updated: Jan 20 2025 at 06:04 UTC</p>
</html>