<html>
<head><meta charset="utf-8"><title>wasmtime / PR #3239 Convert compilation artifacts to just... · git-wasmtime · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/index.html">git-wasmtime</a></h2>
<h3>Topic: <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.233239.20Convert.20compilation.20artifacts.20to.20just.2E.2E.2E.html">wasmtime / PR #3239 Convert compilation artifacts to just...</a></h3>

<hr>

<base href="https://bytecodealliance.zulipchat.com">

<head><link href="https://bytecodealliance.github.io/zulip-archive/style.css" rel="stylesheet"></head>

<a name="250624934"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%233239%20Convert%20compilation%20artifacts%20to%20just.../near/250624934" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.233239.20Convert.20compilation.20artifacts.20to.20just.2E.2E.2E.html#250624934">(Aug 25 2021 at 14:05)</a>:</h4>
<p>alexcrichton opened <a href="https://github.com/bytecodealliance/wasmtime/pull/3239">PR #3239</a> from <code>artifact-only-bytes</code> to <code>main</code>:</p>
<blockquote>
<p>This commit strips the <code>CompilationArtifacts</code> type down to simply a list<br>
of bytes. This moves all extra metadata elsewhere to live within the<br>
list of bytes itself as <code>bincode</code>-encoded information.</p>
<p>Small affordance is made to avoid an in-process<br>
serialize-then-deserialize round-trip for use cases like <code>Module::new</code>,<br>
but otherwise this is mostly just moving some data around.</p>
<p>&lt;!--</p>
<p>Please ensure that the following steps are all taken care of before submitting<br>
the PR.</p>
<ul>
<li>
<p>[ ] This has been discussed in issue #..., or if not, please tell us why<br>
  here.</p>
</li>
<li>
<p>[ ] A short description of what this does, why it is needed; if the<br>
  description becomes long, the matter should probably be discussed in an issue<br>
  first.</p>
</li>
<li>
<p>[ ] This PR contains test cases, if meaningful.</p>
</li>
<li>[ ] A reviewer from the core maintainer team has been assigned for this PR.<br>
  If you don't know who could review this, please indicate so. The list of<br>
  suggested reviewers on the right can help you.</li>
</ul>
<p>Please ensure all communication adheres to the <a href="https://github.com/bytecodealliance/wasmtime/blob/master/CODE_OF_CONDUCT.md">code of
conduct</a>.<br>
--&gt;<br>
</p>
</blockquote>



<a name="250624957"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%233239%20Convert%20compilation%20artifacts%20to%20just.../near/250624957" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.233239.20Convert.20compilation.20artifacts.20to.20just.2E.2E.2E.html#250624957">(Aug 25 2021 at 14:05)</a>:</h4>
<p>alexcrichton edited <a href="https://github.com/bytecodealliance/wasmtime/pull/3239">PR #3239</a> from <code>artifact-only-bytes</code> to <code>main</code>:</p>
<blockquote>
<p>This commit strips the <code>CompilationArtifacts</code> type down to simply a list<br>
of bytes. This moves all extra metadata elsewhere to live within the<br>
list of bytes itself as <code>bincode</code>-encoded information.</p>
<p>Small affordance is made to avoid an in-process<br>
serialize-then-deserialize round-trip for use cases like <code>Module::new</code>,<br>
but otherwise this is mostly just moving some data around.</p>
<p>cc #3230</p>
<p>&lt;!--</p>
<p>Please ensure that the following steps are all taken care of before submitting<br>
the PR.</p>
<ul>
<li>
<p>[ ] This has been discussed in issue #..., or if not, please tell us why<br>
  here.</p>
</li>
<li>
<p>[ ] A short description of what this does, why it is needed; if the<br>
  description becomes long, the matter should probably be discussed in an issue<br>
  first.</p>
</li>
<li>
<p>[ ] This PR contains test cases, if meaningful.</p>
</li>
<li>[ ] A reviewer from the core maintainer team has been assigned for this PR.<br>
  If you don't know who could review this, please indicate so. The list of<br>
  suggested reviewers on the right can help you.</li>
</ul>
<p>Please ensure all communication adheres to the <a href="https://github.com/bytecodealliance/wasmtime/blob/master/CODE_OF_CONDUCT.md">code of
conduct</a>.<br>
--&gt;<br>
</p>
</blockquote>



<a name="250625029"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%233239%20Convert%20compilation%20artifacts%20to%20just.../near/250625029" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.233239.20Convert.20compilation.20artifacts.20to.20just.2E.2E.2E.html#250625029">(Aug 25 2021 at 14:06)</a>:</h4>
<p><strong>alexcrichton</strong> requested <a href="https://github.com/peterhuene">peterhuene</a> for a review on <a href="https://github.com/bytecodealliance/wasmtime/pull/3239">PR #3239</a>.</p>



<a name="250629706"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%233239%20Convert%20compilation%20artifacts%20to%20just.../near/250629706" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.233239.20Convert.20compilation.20artifacts.20to.20just.2E.2E.2E.html#250629706">(Aug 25 2021 at 14:40)</a>:</h4>
<p>bjorn3 submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/3239#pullrequestreview-738447752">PR review</a>.</p>



<a name="250629707"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%233239%20Convert%20compilation%20artifacts%20to%20just.../near/250629707" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.233239.20Convert.20compilation.20artifacts.20to.20just.2E.2E.2E.html#250629707">(Aug 25 2021 at 14:40)</a>:</h4>
<p>bjorn3 created <a href="https://github.com/bytecodealliance/wasmtime/pull/3239#discussion_r695822380">PR review comment</a>:</p>
<blockquote>
<p><code>MADV_DONTNEED</code> could be used. For shared (file or anonymous) mappings this will cause the pages to be discarded and repopulated with the backing storage when you try to read it again. For private anonymous mappings it will repopulate with zero-pages when you try to read it again. So if you use <code>MADV_DONTNEED</code> when you have a shared mapping of the ELF image from a file but don't use it when you have an private anonymous mapping for non-precompiled modules I think you should be fine. You can't use it in the later case as the module may be instantiated more than once.</p>
</blockquote>



<a name="250630001"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%233239%20Convert%20compilation%20artifacts%20to%20just.../near/250630001" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.233239.20Convert.20compilation.20artifacts.20to.20just.2E.2E.2E.html#250630001">(Aug 25 2021 at 14:43)</a>:</h4>
<p>bjorn3 submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/3239#pullrequestreview-738450816">PR review</a>.</p>



<a name="250630002"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%233239%20Convert%20compilation%20artifacts%20to%20just.../near/250630002" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.233239.20Convert.20compilation.20artifacts.20to.20just.2E.2E.2E.html#250630002">(Aug 25 2021 at 14:43)</a>:</h4>
<p>bjorn3 created <a href="https://github.com/bytecodealliance/wasmtime/pull/3239#discussion_r695824679">PR review comment</a>:</p>
<blockquote>
<div class="codehilite" data-code-language="suggestion"><pre><span></span><code>const ELF_WASM_DATA: &amp;'static str = ".rodata.wasm";
</code></pre></div>
<p>This is a non-writeable section.</p>
</blockquote>



<a name="250630057"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%233239%20Convert%20compilation%20artifacts%20to%20just.../near/250630057" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.233239.20Convert.20compilation.20artifacts.20to.20just.2E.2E.2E.html#250630057">(Aug 25 2021 at 14:43)</a>:</h4>
<p>bjorn3 edited <a href="https://github.com/bytecodealliance/wasmtime/pull/3239#discussion_r695824679">PR review comment</a>.</p>



<a name="250793948"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%233239%20Convert%20compilation%20artifacts%20to%20just.../near/250793948" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.233239.20Convert.20compilation.20artifacts.20to.20just.2E.2E.2E.html#250793948">(Aug 26 2021 at 15:48)</a>:</h4>
<p>alexcrichton updated <a href="https://github.com/bytecodealliance/wasmtime/pull/3239">PR #3239</a> from <code>artifact-only-bytes</code> to <code>main</code>.</p>



<a name="250846165"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%233239%20Convert%20compilation%20artifacts%20to%20just.../near/250846165" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.233239.20Convert.20compilation.20artifacts.20to.20just.2E.2E.2E.html#250846165">(Aug 26 2021 at 21:54)</a>:</h4>
<p>alexcrichton updated <a href="https://github.com/bytecodealliance/wasmtime/pull/3239">PR #3239</a> from <code>artifact-only-bytes</code> to <code>main</code>.</p>



<a name="250861157"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%233239%20Convert%20compilation%20artifacts%20to%20just.../near/250861157" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.233239.20Convert.20compilation.20artifacts.20to.20just.2E.2E.2E.html#250861157">(Aug 27 2021 at 00:29)</a>:</h4>
<p>peterhuene submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/3239#pullrequestreview-740040101">PR review</a>.</p>



<a name="250861158"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%233239%20Convert%20compilation%20artifacts%20to%20just.../near/250861158" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.233239.20Convert.20compilation.20artifacts.20to.20just.2E.2E.2E.html#250861158">(Aug 27 2021 at 00:29)</a>:</h4>
<p>peterhuene created <a href="https://github.com/bytecodealliance/wasmtime/pull/3239#discussion_r697063983">PR review comment</a>:</p>
<blockquote>
<p>As far as I'm aware, this behavior of <code>MADV_DONTNEED</code> is Linux-specific and can't be relied upon for macOS.</p>
<p>That said, I don't think we need to optimize for <code>data.drop</code> just yet.</p>
</blockquote>



<a name="250861190"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%233239%20Convert%20compilation%20artifacts%20to%20just.../near/250861190" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.233239.20Convert.20compilation.20artifacts.20to.20just.2E.2E.2E.html#250861190">(Aug 27 2021 at 00:30)</a>:</h4>
<p>peterhuene submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/3239#pullrequestreview-740040388">PR review</a>.</p>



<a name="250862312"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%233239%20Convert%20compilation%20artifacts%20to%20just.../near/250862312" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.233239.20Convert.20compilation.20artifacts.20to.20just.2E.2E.2E.html#250862312">(Aug 27 2021 at 00:44)</a>:</h4>
<p>peterhuene edited <a href="https://github.com/bytecodealliance/wasmtime/pull/3239#discussion_r697063983">PR review comment</a>.</p>



<a name="250870824"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%233239%20Convert%20compilation%20artifacts%20to%20just.../near/250870824" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.233239.20Convert.20compilation.20artifacts.20to.20just.2E.2E.2E.html#250870824">(Aug 27 2021 at 02:16)</a>:</h4>
<p>alexcrichton updated <a href="https://github.com/bytecodealliance/wasmtime/pull/3239">PR #3239</a> from <code>artifact-only-bytes</code> to <code>main</code>.</p>



<a name="250870844"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%233239%20Convert%20compilation%20artifacts%20to%20just.../near/250870844" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.233239.20Convert.20compilation.20artifacts.20to.20just.2E.2E.2E.html#250870844">(Aug 27 2021 at 02:17)</a>:</h4>
<p>alexcrichton merged <a href="https://github.com/bytecodealliance/wasmtime/pull/3239">PR #3239</a>.</p>



<a name="250915243"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%233239%20Convert%20compilation%20artifacts%20to%20just.../near/250915243" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.233239.20Convert.20compilation.20artifacts.20to.20just.2E.2E.2E.html#250915243">(Aug 27 2021 at 11:07)</a>:</h4>
<p>bjorn3 submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/3239#pullrequestreview-740407121">PR review</a>.</p>



<a name="250915245"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%233239%20Convert%20compilation%20artifacts%20to%20just.../near/250915245" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.233239.20Convert.20compilation.20artifacts.20to.20just.2E.2E.2E.html#250915245">(Aug 27 2021 at 11:07)</a>:</h4>
<p>bjorn3 created <a href="https://github.com/bytecodealliance/wasmtime/pull/3239#discussion_r697355577">PR review comment</a>:</p>
<blockquote>
<p>The posix specification says the following about <code>posix_madvise</code>:</p>
<p><a href="https://pubs.opengroup.org/onlinepubs/9699919799/functions/posix_madvise.html">https://pubs.opengroup.org/onlinepubs/9699919799/functions/posix_madvise.html</a></p>
<blockquote>
<p>The posix_madvise() function shall have no effect on the semantics of access to memory in the specified range, although it may affect the performance of access.</p>
</blockquote>
<p>This matches how linux behaves when using <code>MADV_DONTNEED</code> with <code>madvise()</code> on shared mappings, so at least for shared mappings it should be fine, right?</p>
</blockquote>



<a name="250974176"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%233239%20Convert%20compilation%20artifacts%20to%20just.../near/250974176" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.233239.20Convert.20compilation.20artifacts.20to.20just.2E.2E.2E.html#250974176">(Aug 27 2021 at 18:28)</a>:</h4>
<p>peterhuene submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/3239#pullrequestreview-740790480">PR review</a>.</p>



<a name="250974177"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%233239%20Convert%20compilation%20artifacts%20to%20just.../near/250974177" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.233239.20Convert.20compilation.20artifacts.20to.20just.2E.2E.2E.html#250974177">(Aug 27 2021 at 18:28)</a>:</h4>
<p>peterhuene created <a href="https://github.com/bytecodealliance/wasmtime/pull/3239#discussion_r697641158">PR review comment</a>:</p>
<blockquote>
<p>The POSIX semantics are entirely advisory; as far as I know only Linux will immediately discard the pages for <code>MADV_DONTNEED</code>.</p>
<p>I'm uncertain if it has any effect on macOS or if it lazily discards the pages on memory pressure, but my understanding (which isn't necessarily correct, I might add) is that macOS doesn't implement immediate discarding like Linux does.</p>
<p>I think we should definitely circle back on this should it be that the data segments being resident is a problem for users (it hasn't been thus far, at least).</p>
</blockquote>



<hr><p>Last updated: Jan 20 2025 at 06:04 UTC</p>
</html>