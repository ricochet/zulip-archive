<html>
<head><meta charset="utf-8"><title>wasmtime / issue #8706 Changing an immediate operand from... · git-wasmtime · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/index.html">git-wasmtime</a></h2>
<h3>Topic: <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.238706.20Changing.20an.20immediate.20operand.20from.2E.2E.2E.html">wasmtime / issue #8706 Changing an immediate operand from...</a></h3>

<hr>

<base href="https://bytecodealliance.zulipchat.com">

<head><link href="https://bytecodealliance.github.io/zulip-archive/style.css" rel="stylesheet"></head>

<a name="441279766"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%238706%20Changing%20an%20immediate%20operand%20from.../near/441279766" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.238706.20Changing.20an.20immediate.20operand.20from.2E.2E.2E.html#441279766">(May 29 2024 at 16:53)</a>:</h4>
<p>hungryzzz opened <a href="https://github.com/bytecodealliance/wasmtime/issues/8706">issue #8706</a>:</p>
<blockquote>
<h3>Test Cases</h3>
<p><a href="https://github.com/bytecodealliance/wasmtime/files/15487475/cases.zip">cases.zip</a></p>
<h3>Steps to Reproduce</h3>
<p>Hi, I run the attached two cases(<code>good.wasm</code>&amp;<code>bad.wasm</code>) in <code>Wasmtime</code> and <code>WasmEdge</code>(AOT), and collect their execution time respectively (measured by <code>time</code> tool).</p>
<div class="codehilite" data-code-language="Bash"><pre><span></span><code><span class="c1"># command to collect execution time of wasmtime</span>
wasmtime<span class="w"> </span>compile<span class="w"> </span>bad.wasm<span class="w"> </span>-o<span class="w"> </span>bad.cwasm
<span class="nb">time</span><span class="w"> </span>wasmtime<span class="w"> </span>run<span class="w"> </span>--allow-precompiled<span class="w"> </span>bad.cwasm

<span class="c1"># command to collect execution time of wasmedge</span>
wasmedgec<span class="w"> </span>bad.wasm<span class="w"> </span>bad-wasmedge-aot.wasm
<span class="nb">time</span><span class="w"> </span>wasmedge<span class="w"> </span>bad-wasmedge-aot.wasm
</code></pre></div>
<h3>Expected Results &amp; Actual Results</h3>
<p>For <code>good.wasm</code>, the execution time in different runtimes are as follows:</p>
<ul>
<li>Wasmtime: 1.42s</li>
<li>WasmEdge: 1.05s</li>
</ul>
<p>For <code>bad.wasm</code>, the execution time in different runtimes are as follows:</p>
<ul>
<li>Wasmtime: 3.29s</li>
<li>WasmEdge: 0.91s</li>
</ul>
<p>The difference between the attached two cases is as follow, i.e., changing one of the operand of <code>i32.and</code> from <code>0</code> to <code>1</code>. The difference and bring 1.8s performance decreasing on <code>Wasmtime</code> but has no negative effect on <code>WasmEdge</code>.</p>
<div class="codehilite" data-code-language="Bash"><pre><span></span><code>➜<span class="w">  </span>cases<span class="w"> </span>diff<span class="w"> </span>good.wat<span class="w"> </span>bad.wat
35c35
&lt;<span class="w">             </span>i32.const<span class="w"> </span><span class="m">0</span>
---
&gt;<span class="w">             </span>i32.const<span class="w"> </span><span class="m">1</span>
</code></pre></div>
<div class="codehilite" data-code-language="WebAssembly"><pre><span></span><code><span class="c1">;; part of good.wat</span>
  <span class="k">if</span>
    <span class="nb">i32.const</span> <span class="mi">1</span>
    <span class="nb">local.set</span> <span class="mi">2</span>
    <span class="nb">i32.const</span> <span class="mi">1</span>
    <span class="nb">local.get</span> <span class="mi">0</span>
    <span class="nb">i32.const</span> <span class="mi">0</span> <span class="c1">;; here</span>
    <span class="nb">i32.and</span>
    <span class="nb">i32.add</span>
    <span class="nb">local.set</span> <span class="mi">6</span>
    <span class="nb">br</span> <span class="mi">1</span>

<span class="c1">;; part of bad.wat</span>
<span class="k">if</span>
  <span class="nb">i32.const</span> <span class="mi">1</span>
  <span class="nb">local.set</span> <span class="mi">2</span>
  <span class="nb">i32.const</span> <span class="mi">1</span>
  <span class="nb">local.get</span> <span class="mi">0</span>
  <span class="nb">i32.const</span> <span class="mi">1</span> <span class="c1">;; here</span>
  <span class="nb">i32.and</span>
  <span class="nb">i32.add</span>
  <span class="nb">local.set</span> <span class="mi">6</span>
  <span class="nb">br</span> <span class="mi">1</span>
</code></pre></div>
<p>I check the machine code generated by <code>Wasmtime</code> and <code>WasmEdge</code> respectively, the instruction numbers of <code>func2</code>(the difference is in it) are as follows:</p>
<ul>
<li>
<p><code>WasmEdge</code></p>
<ul>
<li><code>good.wasm</code>: 89</li>
<li><code>bad.wasm</code>: 92</li>
<li>diff: 3</li>
</ul>
</li>
<li>
<p><code>Wasmtime</code></p>
<ul>
<li><code>good.wasm</code>: 132</li>
<li><code>bad.wasm</code>: 157</li>
<li>diff: 25</li>
</ul>
</li>
</ul>
<p>I think maybe the difference may affect the data analysis during optimization, but I really confuse why the instructions number of generated machine code could change so much, and I think maybe the extra instructions in <code>bad.wasm</code> make it slower than the good one.<br>
I also use Perf tool to profile the hotspots in <code>Wasmtime</code> but I cannot find something useful.</p>
<h3>Versions and Environment</h3>
<ul>
<li>Wasmtime version or commit: 7f7064c74</li>
<li>Operating system: Linux ringzzz-OptiPlex-Micro-Plus-7010 6.5.0-18-generic</li>
<li>Architecture: Intel(R) Core(TM) i5-13500<br>
</li>
</ul>
</blockquote>



<a name="441280039"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%238706%20Changing%20an%20immediate%20operand%20from.../near/441280039" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.238706.20Changing.20an.20immediate.20operand.20from.2E.2E.2E.html#441280039">(May 29 2024 at 16:55)</a>:</h4>
<p>hungryzzz edited <a href="https://github.com/bytecodealliance/wasmtime/issues/8706">issue #8706</a>:</p>
<blockquote>
<h3>Test Cases</h3>
<p><a href="https://github.com/bytecodealliance/wasmtime/files/15487475/cases.zip">cases.zip</a></p>
<h3>Steps to Reproduce</h3>
<p>Hi, I run the attached two cases(<code>good.wasm</code>&amp;<code>bad.wasm</code>) in <code>Wasmtime</code> and <code>WasmEdge</code>(AOT), and collect their execution time respectively (measured by <code>time</code> tool).</p>
<div class="codehilite" data-code-language="Bash"><pre><span></span><code><span class="c1"># command to collect execution time of wasmtime</span>
wasmtime<span class="w"> </span>compile<span class="w"> </span>bad.wasm<span class="w"> </span>-o<span class="w"> </span>bad.cwasm
<span class="nb">time</span><span class="w"> </span>wasmtime<span class="w"> </span>run<span class="w"> </span>--allow-precompiled<span class="w"> </span>bad.cwasm

<span class="c1"># command to collect execution time of wasmedge</span>
wasmedgec<span class="w"> </span>bad.wasm<span class="w"> </span>bad-wasmedge-aot.wasm
<span class="nb">time</span><span class="w"> </span>wasmedge<span class="w"> </span>bad-wasmedge-aot.wasm
</code></pre></div>
<h3>Expected Results &amp; Actual Results</h3>
<p>For <code>good.wasm</code>, the execution time in different runtimes are as follows:</p>
<ul>
<li>Wasmtime: 1.42s</li>
<li>WasmEdge: 1.05s</li>
</ul>
<p>For <code>bad.wasm</code>, the execution time in different runtimes are as follows:</p>
<ul>
<li>Wasmtime: 3.29s</li>
<li>WasmEdge: 0.91s</li>
</ul>
<p>The difference between the attached two cases is as follow, i.e., changing one of the operand of <code>i32.and</code> from <code>0</code> to <code>1</code>. The difference and bring 1.8s performance decreasing on <code>Wasmtime</code> but has no negative effect on <code>WasmEdge</code>.</p>
<div class="codehilite" data-code-language="Bash"><pre><span></span><code>➜<span class="w">  </span>cases<span class="w"> </span>diff<span class="w"> </span>good.wat<span class="w"> </span>bad.wat
35c35
&lt;<span class="w">             </span>i32.const<span class="w"> </span><span class="m">0</span>
---
&gt;<span class="w">             </span>i32.const<span class="w"> </span><span class="m">1</span>
</code></pre></div>
<div class="codehilite" data-code-language="WebAssembly"><pre><span></span><code><span class="c1">;; part of good.wat</span>
  <span class="k">if</span>
    <span class="nb">i32.const</span> <span class="mi">1</span>
    <span class="nb">local.set</span> <span class="mi">2</span>
    <span class="nb">i32.const</span> <span class="mi">1</span>
    <span class="nb">local.get</span> <span class="mi">0</span>
    <span class="nb">i32.const</span> <span class="mi">0</span> <span class="c1">;; here</span>
    <span class="nb">i32.and</span>
    <span class="nb">i32.add</span>
    <span class="nb">local.set</span> <span class="mi">6</span>
    <span class="nb">br</span> <span class="mi">1</span>

<span class="c1">;; part of bad.wat</span>
<span class="k">if</span>
  <span class="nb">i32.const</span> <span class="mi">1</span>
  <span class="nb">local.set</span> <span class="mi">2</span>
  <span class="nb">i32.const</span> <span class="mi">1</span>
  <span class="nb">local.get</span> <span class="mi">0</span>
  <span class="nb">i32.const</span> <span class="mi">1</span> <span class="c1">;; here</span>
  <span class="nb">i32.and</span>
  <span class="nb">i32.add</span>
  <span class="nb">local.set</span> <span class="mi">6</span>
  <span class="nb">br</span> <span class="mi">1</span>
</code></pre></div>
<p>I check the machine code generated by <code>Wasmtime</code> and <code>WasmEdge</code> respectively, the instruction numbers of <code>func2</code>(the difference is in it) are as follows:</p>
<ul>
<li>
<p><code>WasmEdge</code></p>
<ul>
<li><code>good.wasm</code>: 89</li>
<li><code>bad.wasm</code>: 92</li>
<li>diff: 3</li>
</ul>
</li>
<li>
<p><code>Wasmtime</code></p>
<ul>
<li><code>good.wasm</code>: 132</li>
<li><code>bad.wasm</code>: 157</li>
<li>diff: 25</li>
</ul>
</li>
</ul>
<p>I think maybe the difference may affect the data flow analysis during optimization so maybe some optimization decisions are different , but I really confuse why the instructions number of generated machine code could change so much, and I think maybe the extra instructions in <code>bad.wasm</code> make it slower than the good one.<br>
I also use Perf tool to profile the hotspots in <code>Wasmtime</code> but I cannot find something useful.</p>
<h3>Versions and Environment</h3>
<ul>
<li>Wasmtime version or commit: 7f7064c74</li>
<li>Operating system: Linux ringzzz-OptiPlex-Micro-Plus-7010 6.5.0-18-generic</li>
<li>Architecture: Intel(R) Core(TM) i5-13500<br>
</li>
</ul>
</blockquote>



<a name="441280121"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%238706%20Changing%20an%20immediate%20operand%20from.../near/441280121" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.238706.20Changing.20an.20immediate.20operand.20from.2E.2E.2E.html#441280121">(May 29 2024 at 16:56)</a>:</h4>
<p>hungryzzz edited <a href="https://github.com/bytecodealliance/wasmtime/issues/8706">issue #8706</a>:</p>
<blockquote>
<h3>Test Cases</h3>
<p><a href="https://github.com/bytecodealliance/wasmtime/files/15487475/cases.zip">cases.zip</a></p>
<h3>Steps to Reproduce</h3>
<p>Hi, I run the attached two cases(<code>good.wasm</code>&amp;<code>bad.wasm</code>) in <code>Wasmtime</code> and <code>WasmEdge</code>(AOT), and collect their execution time respectively (measured by <code>time</code> tool).</p>
<div class="codehilite" data-code-language="Bash"><pre><span></span><code><span class="c1"># command to collect execution time of wasmtime</span>
wasmtime<span class="w"> </span>compile<span class="w"> </span>bad.wasm<span class="w"> </span>-o<span class="w"> </span>bad.cwasm
<span class="nb">time</span><span class="w"> </span>wasmtime<span class="w"> </span>run<span class="w"> </span>--allow-precompiled<span class="w"> </span>bad.cwasm

<span class="c1"># command to collect execution time of wasmedge</span>
wasmedgec<span class="w"> </span>bad.wasm<span class="w"> </span>bad-wasmedge-aot.wasm
<span class="nb">time</span><span class="w"> </span>wasmedge<span class="w"> </span>bad-wasmedge-aot.wasm
</code></pre></div>
<h3>Expected Results &amp; Actual Results</h3>
<p>For <code>good.wasm</code>, the execution time in different runtimes are as follows:</p>
<ul>
<li>Wasmtime: 1.42s</li>
<li>WasmEdge: 1.05s</li>
</ul>
<p>For <code>bad.wasm</code>, the execution time in different runtimes are as follows:</p>
<ul>
<li>Wasmtime: 3.29s</li>
<li>WasmEdge: 0.91s</li>
</ul>
<p>The difference between the attached two cases is as follow, i.e., changing one of the operand of <code>i32.and</code> from <code>0</code> to <code>1</code>. The difference and bring 1.8s performance decreasing on <code>Wasmtime</code> but has no negative effect on <code>WasmEdge</code>.</p>
<div class="codehilite" data-code-language="Bash"><pre><span></span><code>➜<span class="w">  </span>cases<span class="w"> </span>diff<span class="w"> </span>good.wat<span class="w"> </span>bad.wat
35c35
&lt;<span class="w">             </span>i32.const<span class="w"> </span><span class="m">0</span>
---
&gt;<span class="w">             </span>i32.const<span class="w"> </span><span class="m">1</span>
</code></pre></div>
<div class="codehilite" data-code-language="WebAssembly"><pre><span></span><code><span class="c1">;; part of good.wat</span>
  <span class="k">if</span>
    <span class="nb">i32.const</span> <span class="mi">1</span>
    <span class="nb">local.set</span> <span class="mi">2</span>
    <span class="nb">i32.const</span> <span class="mi">1</span>
    <span class="nb">local.get</span> <span class="mi">0</span>
    <span class="nb">i32.const</span> <span class="mi">0</span> <span class="c1">;; here</span>
    <span class="nb">i32.and</span>
    <span class="nb">i32.add</span>
    <span class="nb">local.set</span> <span class="mi">6</span>
    <span class="nb">br</span> <span class="mi">1</span>

<span class="c1">;; part of bad.wat</span>
<span class="k">if</span>
  <span class="nb">i32.const</span> <span class="mi">1</span>
  <span class="nb">local.set</span> <span class="mi">2</span>
  <span class="nb">i32.const</span> <span class="mi">1</span>
  <span class="nb">local.get</span> <span class="mi">0</span>
  <span class="nb">i32.const</span> <span class="mi">1</span> <span class="c1">;; here</span>
  <span class="nb">i32.and</span>
  <span class="nb">i32.add</span>
  <span class="nb">local.set</span> <span class="mi">6</span>
  <span class="nb">br</span> <span class="mi">1</span>
</code></pre></div>
<p>I check the machine code generated by <code>Wasmtime</code> and <code>WasmEdge</code> respectively, the instruction numbers of <code>func2</code>(the difference is in it) are as follows:</p>
<ul>
<li>
<p><code>WasmEdge</code></p>
<ul>
<li><code>good.wasm</code>: 89</li>
<li><code>bad.wasm</code>: 92</li>
<li>diff: 3</li>
</ul>
</li>
<li>
<p><code>Wasmtime</code></p>
<ul>
<li><code>good.wasm</code>: 132</li>
<li><code>bad.wasm</code>: 157</li>
<li>diff: 25</li>
</ul>
</li>
</ul>
<p>I think maybe the difference affect the data flow analysis during optimization so maybe some optimization decisions are different , but I really confuse why the instructions number of generated machine code could change so much, and I think maybe the extra instructions in <code>bad.wasm</code> make it slower than the good one.<br>
I also use Perf tool to profile the hotspots in <code>Wasmtime</code> but I cannot find something useful.</p>
<h3>Versions and Environment</h3>
<ul>
<li>Wasmtime version or commit: 7f7064c74</li>
<li>Operating system: Linux ringzzz-OptiPlex-Micro-Plus-7010 6.5.0-18-generic</li>
<li>Architecture: Intel(R) Core(TM) i5-13500<br>
</li>
</ul>
</blockquote>



<a name="441282028"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%238706%20Changing%20an%20immediate%20operand%20from.../near/441282028" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.238706.20Changing.20an.20immediate.20operand.20from.2E.2E.2E.html#441282028">(May 29 2024 at 17:07)</a>:</h4>
<p>cfallin <a href="https://github.com/bytecodealliance/wasmtime/issues/8706#issuecomment-2137890172">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/8706">issue #8706</a>:</p>
<blockquote>
<p>Hi @hungryzzz -- while we appreciate these reports, they seem to be generated by some infrastructure and "mass-produced", so to speak, so to help us out, it may be good to do a little bit more work. In particular: for each performance-delta report (including this one), would you be able to reduce the report to assembly, show us the difference in generated assembly, and write a microbenchmark in assembly that isolates the performance effect and shows it to be valid (as I <a href="https://github.com/bytecodealliance/wasmtime/issues/8648#issuecomment-2118130278">mentioned in a previous comment on a very similar issue</a>)?</p>
</blockquote>



<a name="444180075"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%238706%20Changing%20an%20immediate%20operand%20from.../near/444180075" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.238706.20Changing.20an.20immediate.20operand.20from.2E.2E.2E.html#444180075">(Jun 12 2024 at 08:42)</a>:</h4>
<p>hungryzzz <a href="https://github.com/bytecodealliance/wasmtime/issues/8706#issuecomment-2162442813">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/8706">issue #8706</a>:</p>
<blockquote>
<p>Hi @cfallin, I write a microbenchmark in assembly based on the generated machine code of <code>good.wasm</code> and <code>bad.wasm</code>. And I also provide a comparison report show the differences of the machine code.<br>
The microbenchmark and report are attached in <a href="https://github.com/user-attachments/files/15801278/reports.zip">reports.zip</a>. Thank you!</p>
<p><div class="codehilite" data-code-language="Bash"><pre><span></span><code><span class="c1"># The execution times of `asm_good` and `asm_bad` are as follows:</span>
➜<span class="w">  </span>binary-asm<span class="w"> </span><span class="nb">time</span><span class="w"> </span>./asm_good
./asm_good<span class="w">  </span><span class="m">1</span>.52s<span class="w"> </span>user<span class="w"> </span><span class="m">0</span>.00s<span class="w"> </span>system<span class="w"> </span><span class="m">99</span>%<span class="w"> </span>cpu<span class="w"> </span><span class="m">1</span>.524<span class="w"> </span>total
➜<span class="w">  </span>binary-asm<span class="w"> </span><span class="nb">time</span><span class="w"> </span>./asm_bad
./asm_bad<span class="w">  </span><span class="m">3</span>.00s<span class="w"> </span>user<span class="w"> </span><span class="m">0</span>.00s<span class="w"> </span>system<span class="w"> </span><span class="m">99</span>%<span class="w"> </span>cpu<span class="w"> </span><span class="m">3</span>.004<span class="w"> </span>total
</code></pre></div><br>
</p>
</blockquote>



<a name="444298180"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%238706%20Changing%20an%20immediate%20operand%20from.../near/444298180" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.238706.20Changing.20an.20immediate.20operand.20from.2E.2E.2E.html#444298180">(Jun 12 2024 at 18:01)</a>:</h4>
<p>cfallin <a href="https://github.com/bytecodealliance/wasmtime/issues/8706#issuecomment-2163620109">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/8706">issue #8706</a>:</p>
<blockquote>
<p>Thanks @hungryzzz. Unfortunately there's still a nontrivial diff, I guess I had hoped for a little more investigation to point to exactly what the microarchitectural difference was; take the two inner loops, transform one into the other one step at a time, see where the cliff happens, that sort of thing. To be more direct: most folks here (at least those working on Cranelift full-time) don't have time to dig into a performance anomaly of several hundred lines of assembly with unclear prioritization (i.e., found via fuzzing rather than via real-use-case report) so for this effort to be successful you'll have to do a little more of the investigation yourself and point to what we can change. Sorry and thanks!</p>
</blockquote>



<a name="444309190"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%238706%20Changing%20an%20immediate%20operand%20from.../near/444309190" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.238706.20Changing.20an.20immediate.20operand.20from.2E.2E.2E.html#444309190">(Jun 12 2024 at 18:57)</a>:</h4>
<p>iximeow <a href="https://github.com/bytecodealliance/wasmtime/issues/8706#issuecomment-2163707305">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/8706">issue #8706</a>:</p>
<blockquote>
<p>@hungryzzz another point to keep in mind, the diff represented by <code>report.html</code> understates the true difference between <code>asm_good</code> and <code>asm_bad</code>: in addition to the additional instructions in <code>asm_bad</code>, many of the instructions that are <code>mov</code> in both are actually <code>mov %reg, offset(%rsp)</code> in <code>asm_bad</code>, where they were register-register movs on the right. i skimmed <code>asm_good.c</code> and <code>asm_bad.c</code> and the additional saves and loads from the stack seem to be the vast majority of the difference between these two.</p>
<p>incidentally, these run in about the same time on a Ryzen 9 3950X and i'm downright shocked at the IPC it managed. here's <code>asm_bad.c</code> with almost 5.5 IPC (!):</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="p">[</span><span class="mi">11</span><span class="p">:</span><span class="mi">44</span><span class="p">:</span><span class="mi">28</span><span class="p">]</span><span class="w"> </span><span class="p">#</span><span class="w"> </span><span class="n">iximeow</span><span class="p">:</span><span class="o">~/</span><span class="n">reports</span><span class="o">&gt;</span><span class="w"> </span><span class="n">sudo</span><span class="w"> </span><span class="n">perf</span><span class="w"> </span><span class="n">stat</span><span class="w"> </span><span class="o">-</span><span class="n">e</span><span class="w"> </span><span class="n">cycles</span><span class="w"> </span><span class="o">-</span><span class="n">e</span><span class="w"> </span><span class="n">instructions</span><span class="w"> </span><span class="o">-</span><span class="n">e</span><span class="w"> </span><span class="n">L1</span><span class="o">-</span><span class="n">dcache</span><span class="o">-</span><span class="n">loads</span><span class="w"> </span><span class="err">\</span>
<span class="w">  </span><span class="o">-</span><span class="n">e</span><span class="w"> </span><span class="n">L1</span><span class="o">-</span><span class="n">dcache</span><span class="o">-</span><span class="n">misses</span><span class="w"> </span><span class="o">-</span><span class="n">e</span><span class="w"> </span><span class="n">stalled</span><span class="o">-</span><span class="n">cycles</span><span class="o">-</span><span class="n">frontend</span><span class="w"> </span><span class="o">-</span><span class="n">e</span><span class="w"> </span><span class="n">stalled</span><span class="o">-</span><span class="n">cycles</span><span class="o">-</span><span class="n">backend</span><span class="w"> </span><span class="err">\</span>
<span class="w">  </span><span class="p">.</span><span class="o">/</span><span class="n">bad</span>

<span class="w"> </span><span class="n">Performance</span><span class="w"> </span><span class="n">counter</span><span class="w"> </span><span class="n">stats</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="o">'</span><span class="p">.</span><span class="o">/</span><span class="n">bad</span><span class="o">'</span><span class="p">:</span>

<span class="w">    </span><span class="mi">17</span><span class="p">,</span><span class="mi">220</span><span class="p">,</span><span class="mi">141</span><span class="p">,</span><span class="mi">631</span><span class="w">      </span><span class="n">cycles</span><span class="w">                                                        </span><span class="p">(</span><span class="mf">83.31</span><span class="o">%</span><span class="p">)</span>
<span class="w">    </span><span class="mi">94</span><span class="p">,</span><span class="mi">551</span><span class="p">,</span><span class="mi">730</span><span class="p">,</span><span class="mi">488</span><span class="w">      </span><span class="n">instructions</span><span class="w">              </span><span class="p">#</span><span class="w">    </span><span class="mf">5.49</span><span class="w">  </span><span class="n">insn</span><span class="w"> </span><span class="n">per</span><span class="w"> </span><span class="n">cycle</span>
<span class="w">                                                  </span><span class="p">#</span><span class="w">    </span><span class="mf">0.05</span><span class="w">  </span><span class="n">stalled</span><span class="w"> </span><span class="n">cycles</span><span class="w"> </span><span class="n">per</span><span class="w"> </span><span class="n">insn</span><span class="w">  </span><span class="p">(</span><span class="mf">83.35</span><span class="o">%</span><span class="p">)</span>
<span class="w">    </span><span class="mi">12</span><span class="p">,</span><span class="mi">890</span><span class="p">,</span><span class="mi">324</span><span class="p">,</span><span class="mi">509</span><span class="w">      </span><span class="n">L1</span><span class="o">-</span><span class="n">dcache</span><span class="o">-</span><span class="n">loads</span><span class="w">                                               </span><span class="p">(</span><span class="mf">83.36</span><span class="o">%</span><span class="p">)</span>
<span class="w">           </span><span class="mi">270</span><span class="p">,</span><span class="mi">501</span><span class="w">      </span><span class="n">L1</span><span class="o">-</span><span class="n">dcache</span><span class="o">-</span><span class="n">misses</span><span class="w">          </span><span class="p">#</span><span class="w">    </span><span class="mf">0.00</span><span class="o">%</span><span class="w"> </span><span class="n">of</span><span class="w"> </span><span class="n">all</span><span class="w"> </span><span class="n">L1</span><span class="o">-</span><span class="n">dcache</span><span class="w"> </span><span class="n">hits</span><span class="w">    </span><span class="p">(</span><span class="mf">83.36</span><span class="o">%</span><span class="p">)</span>
<span class="w">           </span><span class="mi">756</span><span class="p">,</span><span class="mi">707</span><span class="w">      </span><span class="n">stalled</span><span class="o">-</span><span class="n">cycles</span><span class="o">-</span><span class="n">frontend</span><span class="w">   </span><span class="p">#</span><span class="w">    </span><span class="mf">0.00</span><span class="o">%</span><span class="w"> </span><span class="n">frontend</span><span class="w"> </span><span class="n">cycles</span><span class="w"> </span><span class="n">idle</span><span class="w">     </span><span class="p">(</span><span class="mf">83.35</span><span class="o">%</span><span class="p">)</span>
<span class="w">     </span><span class="mi">4</span><span class="p">,</span><span class="mi">303</span><span class="p">,</span><span class="mi">679</span><span class="p">,</span><span class="mi">448</span><span class="w">      </span><span class="n">stalled</span><span class="o">-</span><span class="n">cycles</span><span class="o">-</span><span class="n">backend</span><span class="w">    </span><span class="p">#</span><span class="w">   </span><span class="mf">24.99</span><span class="o">%</span><span class="w"> </span><span class="n">backend</span><span class="w"> </span><span class="n">cycles</span><span class="w"> </span><span class="n">idle</span><span class="w">      </span><span class="p">(</span><span class="mf">83.27</span><span class="o">%</span><span class="p">)</span>

<span class="w">       </span><span class="mf">3.869444889</span><span class="w"> </span><span class="n">seconds</span><span class="w"> </span><span class="n">time</span><span class="w"> </span><span class="n">elapsed</span>

<span class="w">       </span><span class="mf">3.867886000</span><span class="w"> </span><span class="n">seconds</span><span class="w"> </span><span class="n">user</span>
<span class="w">       </span><span class="mf">0.000000000</span><span class="w"> </span><span class="n">seconds</span><span class="w"> </span><span class="n">sys</span>
</code></pre></div>
<p>vs <code>asm_good.c</code> which runs half as many instructions in almost the same total time:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="p">[</span><span class="mi">11</span><span class="p">:</span><span class="mi">45</span><span class="p">:</span><span class="mi">00</span><span class="p">]</span><span class="w"> </span><span class="p">#</span><span class="w"> </span><span class="n">iximeow</span><span class="p">:</span><span class="o">~/</span><span class="n">reports</span><span class="o">&gt;</span><span class="w"> </span><span class="n">sudo</span><span class="w"> </span><span class="n">perf</span><span class="w"> </span><span class="n">stat</span><span class="w"> </span><span class="o">-</span><span class="n">e</span><span class="w"> </span><span class="n">cycles</span><span class="w"> </span><span class="o">-</span><span class="n">e</span><span class="w"> </span><span class="n">instructions</span><span class="w"> </span><span class="o">-</span><span class="n">e</span><span class="w"> </span><span class="n">L1</span><span class="o">-</span><span class="n">dcache</span><span class="o">-</span><span class="n">loads</span><span class="w"> </span><span class="o">-</span><span class="n">e</span><span class="w"> </span><span class="n">L1</span><span class="o">-</span><span class="n">dcache</span><span class="o">-</span><span class="n">misses</span><span class="w"> </span><span class="err">\</span>
<span class="w">  </span><span class="o">-</span><span class="n">e</span><span class="w"> </span><span class="n">stalled</span><span class="o">-</span><span class="n">cycles</span><span class="o">-</span><span class="n">frontend</span><span class="w"> </span><span class="o">-</span><span class="n">e</span><span class="w"> </span><span class="n">stalled</span><span class="o">-</span><span class="n">cycles</span><span class="o">-</span><span class="n">backend</span><span class="w"> </span><span class="err">\</span>
<span class="w">  </span><span class="p">.</span><span class="o">/</span><span class="n">good</span>

<span class="w"> </span><span class="n">Performance</span><span class="w"> </span><span class="n">counter</span><span class="w"> </span><span class="n">stats</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="o">'</span><span class="p">.</span><span class="o">/</span><span class="n">good</span><span class="o">'</span><span class="p">:</span>

<span class="w">    </span><span class="mi">17</span><span class="p">,</span><span class="mi">212</span><span class="p">,</span><span class="mi">385</span><span class="p">,</span><span class="mi">161</span><span class="w">      </span><span class="n">cycles</span><span class="w">                                                        </span><span class="p">(</span><span class="mf">83.29</span><span class="o">%</span><span class="p">)</span>
<span class="w">    </span><span class="mi">47</span><span class="p">,</span><span class="mi">256</span><span class="p">,</span><span class="mi">102</span><span class="p">,</span><span class="mi">329</span><span class="w">      </span><span class="n">instructions</span><span class="w">              </span><span class="p">#</span><span class="w">    </span><span class="mf">2.75</span><span class="w">  </span><span class="n">insn</span><span class="w"> </span><span class="n">per</span><span class="w"> </span><span class="n">cycle</span>
<span class="w">                                                  </span><span class="p">#</span><span class="w">    </span><span class="mf">0.00</span><span class="w">  </span><span class="n">stalled</span><span class="w"> </span><span class="n">cycles</span><span class="w"> </span><span class="n">per</span><span class="w"> </span><span class="n">insn</span><span class="w">  </span><span class="p">(</span><span class="mf">83.29</span><span class="o">%</span><span class="p">)</span>
<span class="w">         </span><span class="mi">3</span><span class="p">,</span><span class="mi">791</span><span class="p">,</span><span class="mi">613</span><span class="w">      </span><span class="n">L1</span><span class="o">-</span><span class="n">dcache</span><span class="o">-</span><span class="n">loads</span><span class="w">                                               </span><span class="p">(</span><span class="mf">83.30</span><span class="o">%</span><span class="p">)</span>
<span class="w">           </span><span class="mi">134</span><span class="p">,</span><span class="mi">600</span><span class="w">      </span><span class="n">L1</span><span class="o">-</span><span class="n">dcache</span><span class="o">-</span><span class="n">misses</span><span class="w">          </span><span class="p">#</span><span class="w">    </span><span class="mf">3.55</span><span class="o">%</span><span class="w"> </span><span class="n">of</span><span class="w"> </span><span class="n">all</span><span class="w"> </span><span class="n">L1</span><span class="o">-</span><span class="n">dcache</span><span class="w"> </span><span class="n">hits</span><span class="w">    </span><span class="p">(</span><span class="mf">83.40</span><span class="o">%</span><span class="p">)</span>
<span class="w">           </span><span class="mi">645</span><span class="p">,</span><span class="mi">951</span><span class="w">      </span><span class="n">stalled</span><span class="o">-</span><span class="n">cycles</span><span class="o">-</span><span class="n">frontend</span><span class="w">   </span><span class="p">#</span><span class="w">    </span><span class="mf">0.00</span><span class="o">%</span><span class="w"> </span><span class="n">frontend</span><span class="w"> </span><span class="n">cycles</span><span class="w"> </span><span class="n">idle</span><span class="w">     </span><span class="p">(</span><span class="mf">83.39</span><span class="o">%</span><span class="p">)</span>
<span class="w">         </span><span class="mi">8</span><span class="p">,</span><span class="mi">859</span><span class="p">,</span><span class="mi">964</span><span class="w">      </span><span class="n">stalled</span><span class="o">-</span><span class="n">cycles</span><span class="o">-</span><span class="n">backend</span><span class="w">    </span><span class="p">#</span><span class="w">    </span><span class="mf">0.05</span><span class="o">%</span><span class="w"> </span><span class="n">backend</span><span class="w"> </span><span class="n">cycles</span><span class="w"> </span><span class="n">idle</span><span class="w">      </span><span class="p">(</span><span class="mf">83.32</span><span class="o">%</span><span class="p">)</span>

<span class="w">       </span><span class="mf">3.975132228</span><span class="w"> </span><span class="n">seconds</span><span class="w"> </span><span class="n">time</span><span class="w"> </span><span class="n">elapsed</span>

<span class="w">       </span><span class="mf">3.969715000</span><span class="w"> </span><span class="n">seconds</span><span class="w"> </span><span class="n">user</span>
<span class="w">       </span><span class="mf">0.003997000</span><span class="w"> </span><span class="n">seconds</span><span class="w"> </span><span class="n">sys</span>
</code></pre></div>
<p>i suspect an iterative transformation from one loop to the other probably won't be super illuminating: something like "movs to and from the stack are slow on some machines, and as you add more it gets more slow". but @hungryzzz another approach that would certainly help here is if you can reduce the input wasm program down - if the program were 30 instructions and switching the constant from 0 to 1 still produces significantly different codegen, that's much easier to investigate.</p>
</blockquote>



<a name="444498317"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%238706%20Changing%20an%20immediate%20operand%20from.../near/444498317" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.238706.20Changing.20an.20immediate.20operand.20from.2E.2E.2E.html#444498317">(Jun 13 2024 at 15:45)</a>:</h4>
<p>hungryzzz <a href="https://github.com/bytecodealliance/wasmtime/issues/8706#issuecomment-2166054955">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/8706">issue #8706</a>:</p>
<blockquote>
<p>Hi, when I try to delete part of the code in the above bad case, I find many small deletion cannot replay this bug, so I think I cannot reduce the bad case to a shorter one.</p>
<p>But I find another interesting thing during the reduction. I comment out the following part of the code as this branch must be triggered, and execution times are quite different after this deletion.</p>
<ul>
<li><code>bad.wasm</code>: 3.33s</li>
<li>after deletion (called <code>good.wasm</code> in the attached file): 1.80s</li>
</ul>
<p>And still I find the generated machine codes are quite difference which are attached. So I guess maybe some analysis during compilation are wrong, resulting the suboptimal code generation. But actually I don't know how to inspect further for this. If you need more investigation, I am willing to do that under your suggestions. </p>
<div class="codehilite" data-code-language="WebAssembly"><pre><span></span><code><span class="k">block</span>
    <span class="c1">;; i32.const 1</span>
    <span class="c1">;; if</span>
      <span class="nb">local.get</span> <span class="mi">6</span>
      <span class="nb">local.set</span> <span class="mi">5</span>
      <span class="c1">;; br 1</span>
    <span class="c1">;; end</span>
<span class="k">end</span>
</code></pre></div>
<p><a href="https://github.com/user-attachments/files/15823469/new.zip">new.zip</a></p>
</blockquote>



<a name="444499051"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%238706%20Changing%20an%20immediate%20operand%20from.../near/444499051" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.238706.20Changing.20an.20immediate.20operand.20from.2E.2E.2E.html#444499051">(Jun 13 2024 at 15:49)</a>:</h4>
<p>hungryzzz edited a <a href="https://github.com/bytecodealliance/wasmtime/issues/8706#issuecomment-2166054955">comment</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/8706">issue #8706</a>:</p>
<blockquote>
<p>Hi, when I try to delete part of the code in the above bad case, I find many small deletion cannot replay this bug, so I think I cannot reduce the bad case to a shorter one.</p>
<p>But I find another interesting thing during the reduction. I comment out the following part of the code as this branch must be triggered. However, execution times are quite different after this deletion.</p>
<ul>
<li><code>bad.wasm</code>: 3.33s</li>
<li>after deletion (called <code>good.wasm</code> in the attached file): 1.80s</li>
</ul>
<p>And still I find the generated machine codes are quite difference which are attached. So I guess maybe some analysis during compilation are wrong, resulting the suboptimal code generation. But actually I don't know how to inspect further for this. If you need more investigation, I am willing to do that under your suggestions. </p>
<div class="codehilite" data-code-language="WebAssembly"><pre><span></span><code><span class="k">block</span>
    <span class="c1">;; i32.const 1</span>
    <span class="c1">;; if</span>
      <span class="nb">local.get</span> <span class="mi">6</span>
      <span class="nb">local.set</span> <span class="mi">5</span>
      <span class="c1">;; br 1</span>
    <span class="c1">;; end</span>
<span class="k">end</span>
</code></pre></div>
<p><a href="https://github.com/user-attachments/files/15823469/new.zip">new.zip</a></p>
</blockquote>



<a name="444502569"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%238706%20Changing%20an%20immediate%20operand%20from.../near/444502569" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.238706.20Changing.20an.20immediate.20operand.20from.2E.2E.2E.html#444502569">(Jun 13 2024 at 16:03)</a>:</h4>
<p>cfallin <a href="https://github.com/bytecodealliance/wasmtime/issues/8706#issuecomment-2166106065">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/8706">issue #8706</a>:</p>
<blockquote>
<p>Ah, if making that assignment from local 6 to local 5 unconditional causes the performance delta to disappear, likely what is happening here is that you're seeing the lack of constant-branch folding in Cranelift. That's not a "wrong analysis", that's just an optimization we haven't implemented yet (and it's somewhat nontrivial to do in our egraph mid-end, though we have ideas). It's entirely possible that that could cascade into other optimizations (GVN, ...?) applying or not applying, causing more register pressure and the spills you're seeing.</p>
</blockquote>



<a name="444505788"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%238706%20Changing%20an%20immediate%20operand%20from.../near/444505788" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.238706.20Changing.20an.20immediate.20operand.20from.2E.2E.2E.html#444505788">(Jun 13 2024 at 16:17)</a>:</h4>
<p>hungryzzz <a href="https://github.com/bytecodealliance/wasmtime/issues/8706#issuecomment-2166138133">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/8706">issue #8706</a>:</p>
<blockquote>
<p>So the only way to validate the guessing is to implement the constant-branch folding in Cranelift, right? But how to explain the performance difference shown at first?</p>
</blockquote>



<a name="444514413"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%238706%20Changing%20an%20immediate%20operand%20from.../near/444514413" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.238706.20Changing.20an.20immediate.20operand.20from.2E.2E.2E.html#444514413">(Jun 13 2024 at 16:58)</a>:</h4>
<p>cfallin <a href="https://github.com/bytecodealliance/wasmtime/issues/8706#issuecomment-2166267051">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/8706">issue #8706</a>:</p>
<blockquote>
<p>The direct cause of the perf delta seems to be the additional spills, as @iximeow pointed out.</p>
</blockquote>



<a name="444695504"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%238706%20Changing%20an%20immediate%20operand%20from.../near/444695504" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.238706.20Changing.20an.20immediate.20operand.20from.2E.2E.2E.html#444695504">(Jun 14 2024 at 13:00)</a>:</h4>
<p>hungryzzz <a href="https://github.com/bytecodealliance/wasmtime/issues/8706#issuecomment-2167987449">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/8706">issue #8706</a>:</p>
<blockquote>
<p>I got it, thank you! But I still cannot understand the two cases shown at first would have such difference machine code...so I continue to do some changes in the <code>bad.wasm</code> and I get another strange finding.</p>
<p>This time I change a value which will be set to the global variable [1] from <code>-65537</code> to <code>65536</code>, and their executiom times are also quite different.</p>
<ul>
<li>bad.wasm: 3.26s</li>
<li>after change (called good.wasm in the attached file): 1.80s</li>
</ul>
<div class="codehilite" data-code-language="Bash"><pre><span></span><code>➜<span class="w">  </span>cases<span class="w"> </span>diff<span class="w"> </span>bad.wat<span class="w"> </span>good.wat
124c124
&lt;<span class="w">             </span>i32.const<span class="w"> </span>-65537
---
&gt;<span class="w">             </span>i32.const<span class="w"> </span><span class="m">65536</span>
</code></pre></div>
<p>I have some confusions and findings about these cases:<br>
1. Originally, I thought maybe the changed control flows bring additional spills in <code>bad.wasm</code>. However, the global variable[1] will not be used in program (I don't find <code>global.get 1</code>), so I think they should have nearly the same generated code.<br>
2. I try to change <code>-65537</code> to another negtive numbers, such as <code>-1</code>, <code>-2</code>, and the execution times are the same as the <strong>bad</strong> one. However, once I change it to some positive numbers, such as <code>65536</code>, <code>100</code>, and the executiom times are good. So I also try to change another number in the program to some negtive number, and the execution time is bad.<br>
3. I run these two cases in <code>wasmer</code> which also uses <code>Cranelift</code> as their compiler (but they use old version), but the executime times of <code>wasmer</code> before and after the changes are the same.<br>
- <code>bad.wasm</code>(<code>wasmer</code>): 2.70s<br>
- after change(<code>wasmer</code>): 2.69s</p>
<p>Therefore, I still think there is something wrong during the compilation of <code>bad.wasm</code>. But still, I don't know how to do further investigation.<br>
The attached files are the new <code>good.wasm</code> and the <code>report.html</code>.</p>
<p><a href="https://github.com/user-attachments/files/15838381/new.zip">new.zip</a></p>
</blockquote>



<a name="444695612"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%238706%20Changing%20an%20immediate%20operand%20from.../near/444695612" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.238706.20Changing.20an.20immediate.20operand.20from.2E.2E.2E.html#444695612">(Jun 14 2024 at 13:00)</a>:</h4>
<p>hungryzzz edited a <a href="https://github.com/bytecodealliance/wasmtime/issues/8706#issuecomment-2167987449">comment</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/8706">issue #8706</a>:</p>
<blockquote>
<p>I got it, thank you! But I still cannot understand the two cases shown at first would have such difference machine code...so I continue to do some changes in the <code>bad.wasm</code> and I get another strange case.</p>
<p>This time I change a value which will be set to the global variable [1] from <code>-65537</code> to <code>65536</code>, and their executiom times are also quite different.</p>
<ul>
<li>bad.wasm: 3.26s</li>
<li>after change (called good.wasm in the attached file): 1.80s</li>
</ul>
<div class="codehilite" data-code-language="Bash"><pre><span></span><code>➜<span class="w">  </span>cases<span class="w"> </span>diff<span class="w"> </span>bad.wat<span class="w"> </span>good.wat
124c124
&lt;<span class="w">             </span>i32.const<span class="w"> </span>-65537
---
&gt;<span class="w">             </span>i32.const<span class="w"> </span><span class="m">65536</span>
</code></pre></div>
<p>I have some confusions and findings about these cases:<br>
1. Originally, I thought maybe the changed control flows bring additional spills in <code>bad.wasm</code>. However, the global variable[1] will not be used in program (I don't find <code>global.get 1</code>), so I think they should have nearly the same generated code.<br>
2. I try to change <code>-65537</code> to another negtive numbers, such as <code>-1</code>, <code>-2</code>, and the execution times are the same as the <strong>bad</strong> one. However, once I change it to some positive numbers, such as <code>65536</code>, <code>100</code>, and the executiom times are good. So I also try to change another number in the program to some negtive number, and the execution time is bad.<br>
3. I run these two cases in <code>wasmer</code> which also uses <code>Cranelift</code> as their compiler (but they use old version), but the executime times of <code>wasmer</code> before and after the changes are the same.<br>
- <code>bad.wasm</code>(<code>wasmer</code>): 2.70s<br>
- after change(<code>wasmer</code>): 2.69s</p>
<p>Therefore, I still think there is something wrong during the compilation of <code>bad.wasm</code>. But still, I don't know how to do further investigation.<br>
The attached files are the new <code>good.wasm</code> and the <code>report.html</code>.</p>
<p><a href="https://github.com/user-attachments/files/15838381/new.zip">new.zip</a></p>
</blockquote>



<a name="444696018"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%238706%20Changing%20an%20immediate%20operand%20from.../near/444696018" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.238706.20Changing.20an.20immediate.20operand.20from.2E.2E.2E.html#444696018">(Jun 14 2024 at 13:02)</a>:</h4>
<p>hungryzzz edited a <a href="https://github.com/bytecodealliance/wasmtime/issues/8706#issuecomment-2167987449">comment</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/8706">issue #8706</a>:</p>
<blockquote>
<p>I got it, thank you! But I still cannot understand the two cases shown at first would have such difference machine code...so I continue to do some changes in the <code>bad.wasm</code> and I get another strange case.</p>
<p>This time I change a value which will be set to the global variable [1] from <code>-65537</code> to <code>65536</code>, and their executiom times are also quite different.</p>
<ul>
<li>bad.wasm: 3.26s</li>
<li>after change (called good.wasm in the attached file): 1.80s</li>
</ul>
<div class="codehilite" data-code-language="Bash"><pre><span></span><code>➜<span class="w">  </span>cases<span class="w"> </span>diff<span class="w"> </span>bad.wat<span class="w"> </span>good.wat
124c124
&lt;<span class="w">             </span>i32.const<span class="w"> </span>-65537
---
&gt;<span class="w">             </span>i32.const<span class="w"> </span><span class="m">65536</span>
</code></pre></div>
<div class="codehilite" data-code-language="WebAssembly"><pre><span></span><code><span class="c1">;; part of bad.wat</span>
<span class="nb">i32.const</span> <span class="mf">-65537</span>
<span class="nb">global.set</span> <span class="mi">1</span>

<span class="c1">;; part of good.wat</span>
<span class="nb">i32.const</span> <span class="mf">65536</span>
<span class="nb">global.set</span> <span class="mi">1</span>
</code></pre></div>
<p>I have some confusions and findings about these cases:<br>
1. Originally, I thought maybe the changed control flows bring additional spills in <code>bad.wasm</code>. However, the global variable[1] will not be used in program (I don't find <code>global.get 1</code>), so I think they should have nearly the same generated code.<br>
2. I try to change <code>-65537</code> to another negtive numbers, such as <code>-1</code>, <code>-2</code>, and the execution times are the same as the <strong>bad</strong> one. However, once I change it to some positive numbers, such as <code>65536</code>, <code>100</code>, and the executiom times are good. So I also try to change another number in the program to some negtive number, and the execution time is bad.<br>
3. I run these two cases in <code>wasmer</code> which also uses <code>Cranelift</code> as their compiler (but they use old version), but the executime times of <code>wasmer</code> before and after the changes are the same.<br>
- <code>bad.wasm</code>(<code>wasmer</code>): 2.70s<br>
- after change(<code>wasmer</code>): 2.69s</p>
<p>Therefore, I still think there is something wrong during the compilation of <code>bad.wasm</code>. But still, I don't know how to do further investigation.<br>
The attached files are the new <code>good.wasm</code> and the <code>report.html</code>.</p>
<p><a href="https://github.com/user-attachments/files/15838381/new.zip">new.zip</a></p>
</blockquote>



<a name="444696173"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%238706%20Changing%20an%20immediate%20operand%20from.../near/444696173" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.238706.20Changing.20an.20immediate.20operand.20from.2E.2E.2E.html#444696173">(Jun 14 2024 at 13:03)</a>:</h4>
<p>hungryzzz edited a <a href="https://github.com/bytecodealliance/wasmtime/issues/8706#issuecomment-2167987449">comment</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/8706">issue #8706</a>:</p>
<blockquote>
<p>I got it, thank you! But I still cannot understand the two cases shown at first would have such difference machine code...so I continue to do some changes in the <code>bad.wasm</code> and I get another strange case.</p>
<p>This time I change a value which will be set to the global variable [1] from <code>-65537</code> to <code>65536</code>, and their executiom times are also quite different.</p>
<ul>
<li><code>bad.wasm</code>: 3.26s</li>
<li>after change (called <code>good.wasm</code> in the attached file): 1.80s</li>
</ul>
<div class="codehilite" data-code-language="Bash"><pre><span></span><code>➜<span class="w">  </span>cases<span class="w"> </span>diff<span class="w"> </span>bad.wat<span class="w"> </span>good.wat
124c124
&lt;<span class="w">             </span>i32.const<span class="w"> </span>-65537
---
&gt;<span class="w">             </span>i32.const<span class="w"> </span><span class="m">65536</span>
</code></pre></div>
<div class="codehilite" data-code-language="WebAssembly"><pre><span></span><code><span class="c1">;; part of bad.wat</span>
<span class="nb">i32.const</span> <span class="mf">-65537</span>
<span class="nb">global.set</span> <span class="mi">1</span>

<span class="c1">;; part of good.wat</span>
<span class="nb">i32.const</span> <span class="mf">65536</span>
<span class="nb">global.set</span> <span class="mi">1</span>
</code></pre></div>
<p>I have some confusions and findings about these cases:<br>
1. Originally, I thought maybe the changed control flows bring additional spills in <code>bad.wasm</code>. However, the global variable[1] will not be used in program (I don't find <code>global.get 1</code>), so I think they should have nearly the same generated code.<br>
2. I try to change <code>-65537</code> to another negtive numbers, such as <code>-1</code>, <code>-2</code>, and the execution times are the same as the <strong>bad</strong> one. However, once I change it to some positive numbers, such as <code>65536</code>, <code>100</code>, and the executiom times are good. So I also try to change another number in the program to some negtive number, and the execution time is bad.<br>
3. I run these two cases in <code>wasmer</code> which also uses <code>Cranelift</code> as their compiler (but they use old version), but the executime times of <code>wasmer</code> before and after the changes are the same.<br>
- <code>bad.wasm</code>(<code>wasmer</code>): 2.70s<br>
- after change(<code>wasmer</code>): 2.69s</p>
<p>Therefore, I still think there is something wrong during the compilation of <code>bad.wasm</code>. But still, I don't know how to do further investigation.<br>
The attached files are the new <code>good.wasm</code> and the <code>report.html</code>.</p>
<p><a href="https://github.com/user-attachments/files/15838381/new.zip">new.zip</a></p>
</blockquote>



<a name="444696512"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%238706%20Changing%20an%20immediate%20operand%20from.../near/444696512" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.238706.20Changing.20an.20immediate.20operand.20from.2E.2E.2E.html#444696512">(Jun 14 2024 at 13:05)</a>:</h4>
<p>hungryzzz edited a <a href="https://github.com/bytecodealliance/wasmtime/issues/8706#issuecomment-2167987449">comment</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/8706">issue #8706</a>:</p>
<blockquote>
<p>I got it, thank you! But I still cannot understand the two cases shown at first would have such difference machine code...so I continue to do some changes in the <code>bad.wasm</code> and I get another strange case.</p>
<p>This time I change a value which will be set to the global variable [1] from <code>-65537</code> to <code>65536</code>, and their executiom times are also quite different.</p>
<ul>
<li><code>bad.wasm</code>: 3.26s</li>
<li>after change (called <code>good.wasm</code> in the attached file): 1.80s</li>
</ul>
<div class="codehilite" data-code-language="Bash"><pre><span></span><code>➜<span class="w">  </span>cases<span class="w"> </span>diff<span class="w"> </span>bad.wat<span class="w"> </span>good.wat
124c124
&lt;<span class="w">             </span>i32.const<span class="w"> </span>-65537
---
&gt;<span class="w">             </span>i32.const<span class="w"> </span><span class="m">65536</span>
</code></pre></div>
<div class="codehilite" data-code-language="WebAssembly"><pre><span></span><code><span class="c1">;; part of bad.wat</span>
<span class="nb">i32.const</span> <span class="mf">-65537</span>
<span class="nb">global.set</span> <span class="mi">1</span>

<span class="c1">;; part of good.wat</span>
<span class="nb">i32.const</span> <span class="mf">65536</span>
<span class="nb">global.set</span> <span class="mi">1</span>
</code></pre></div>
<p>I have some confusions and findings about these cases:<br>
1. Originally, I thought maybe the changed control flows bring additional spills in <code>bad.wasm</code>. However, the global variable[1] will not be used in program (I don't find <code>global.get 1</code>), so I think they should have nearly the same generated code.<br>
2. I try to change <code>-65537</code> to another negtive numbers, such as <code>-1</code>, <code>-2</code>, and the execution times are the same as the <strong>bad</strong> one. However, once I change it to some positive numbers, such as <code>65536</code>, <code>100</code>, and the executiom times are good. So I also try to change another number in the program to some negtive number, and the execution time is bad.<br>
3. I run these two cases in <code>wasmer</code> which also uses <code>Cranelift</code> as their compiler (they use old version one), the executime times of <code>wasmer</code> before and after the changes are the same.<br>
- <code>bad.wasm</code>(<code>wasmer</code>): 2.70s<br>
- after change(<code>wasmer</code>): 2.69s</p>
<p>Therefore, I still think there is something wrong during the compilation of <code>bad.wasm</code>. But still, I don't know how to do further investigation.<br>
The attached files are the new <code>good.wasm</code> and the <code>report.html</code>.</p>
<p><a href="https://github.com/user-attachments/files/15838381/new.zip">new.zip</a></p>
</blockquote>



<a name="444730800"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%238706%20Changing%20an%20immediate%20operand%20from.../near/444730800" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.238706.20Changing.20an.20immediate.20operand.20from.2E.2E.2E.html#444730800">(Jun 14 2024 at 15:53)</a>:</h4>
<p>hungryzzz edited a <a href="https://github.com/bytecodealliance/wasmtime/issues/8706#issuecomment-2167987449">comment</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/8706">issue #8706</a>:</p>
<blockquote>
<p>I got it, thank you! But I still cannot understand the two cases shown at first would have such difference machine code...so I continue to do some changes in the <code>bad.wasm</code> and I get another strange case.</p>
<p>This time I change a value which will be set to the global variable [1] from <code>-65537</code> to <code>65536</code>, and their executiom times are also quite different.</p>
<ul>
<li><code>bad.wasm</code>: 3.26s</li>
<li>after change (called <code>good.wasm</code> in the attached file): 1.80s</li>
</ul>
<div class="codehilite" data-code-language="Bash"><pre><span></span><code>➜<span class="w">  </span>cases<span class="w"> </span>diff<span class="w"> </span>bad.wat<span class="w"> </span>good.wat
124c124
&lt;<span class="w">             </span>i32.const<span class="w"> </span>-65537
---
&gt;<span class="w">             </span>i32.const<span class="w"> </span><span class="m">65536</span>
</code></pre></div>
<div class="codehilite" data-code-language="WebAssembly"><pre><span></span><code><span class="c1">;; part of bad.wat</span>
<span class="nb">i32.const</span> <span class="mf">-65537</span>
<span class="nb">global.set</span> <span class="mi">1</span>

<span class="c1">;; part of good.wat</span>
<span class="nb">i32.const</span> <span class="mf">65536</span>
<span class="nb">global.set</span> <span class="mi">1</span>
</code></pre></div>
<p>I have some confusions and findings about these cases:<br>
1. Originally, I thought maybe the changed control flows bring additional spills in <code>bad.wasm</code>. However, the global variable[1] will not be used in program (I don't find <code>global.get 1</code>), so I think they should have nearly the same generated code.<br>
2. I try to change <code>-65537</code> to another negtive numbers, such as <code>-1</code>, <code>-2</code>, and the execution times are the same as the <strong>bad</strong> one. However, once I change it to some positive numbers, such as <code>65536</code>, <code>100</code>, and the executiom times are good. So I also try to change another number in the program to some negtive number, and the execution time is bad.<br>
3. I run these two cases in <code>wasmer</code> which also uses <code>Cranelift</code> as their compiler (they use old version one, <code>0.91.1</code>), the executime times of <code>wasmer</code> before and after the changes are the same.<br>
- <code>bad.wasm</code>(<code>wasmer</code>): 2.70s<br>
- after change(<code>wasmer</code>): 2.69s</p>
<p>Therefore, I still think there is something wrong during the compilation of <code>bad.wasm</code>. But still, I don't know how to do further investigation.<br>
The attached files are the new <code>good.wasm</code> and the <code>report.html</code>.</p>
<p><a href="https://github.com/user-attachments/files/15838381/new.zip">new.zip</a></p>
</blockquote>



<a name="444835445"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%238706%20Changing%20an%20immediate%20operand%20from.../near/444835445" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.238706.20Changing.20an.20immediate.20operand.20from.2E.2E.2E.html#444835445">(Jun 15 2024 at 06:39)</a>:</h4>
<p>hungryzzz <a href="https://github.com/bytecodealliance/wasmtime/issues/8706#issuecomment-2169163351">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/8706">issue #8706</a>:</p>
<blockquote>
<p>Hi, I  go though the generated machine codes and I think I know something about the performance difference.</p>
<p>I find that if the value which will be set to global variable[1] is a negtive number, then the compiler will use two instructions to represent the <code>global.set</code>, i.e., first moving <code>$0xfffeffff</code> to a register <code>%r10d</code> then moving the register to the specified memory address. And if the value is a positive number, then the compiler will use only one instruction to do it, i.e., directly moving the <code>$0x10000</code> to the specified address. Because the first one needs one more register, additional spills are needed.<br>
By the way, I check the machine code generated by <code>WasmEdge</code>, it use <code>movl $0xfffeffff,0xa0(%rdi)</code> to execute the <code>bad.wasm</code>.</p>
<div class="codehilite" data-code-language="Bash"><pre><span></span><code><span class="c1"># part of the machine code of bad.wasm</span>
<span class="m">104</span><span class="w"> </span><span class="p">|</span><span class="w">  </span>mov<span class="w"> </span><span class="nv">$0</span>xfffeffff,%r10d
<span class="m">105</span><span class="w"> </span><span class="p">|</span><span class="w">  </span>mov<span class="w"> </span>%r10d,0xa0<span class="o">(</span>%rdi<span class="o">)</span>

<span class="c1"># part of the machine code of good.wasm</span>
<span class="m">95</span><span class="w"> </span><span class="p">|</span><span class="w">  </span>movl<span class="w"> </span><span class="nv">$0</span>x10000,0xa0<span class="o">(</span>%rdi<span class="o">)</span>
</code></pre></div>
<p>After the above all investigation, I guess the root cause of  all the performance differences is the different register allocation algorithm used by <code>Wasmtime</code> and others. I think maybe slightly changes on the <code>bad.wasm</code> will cause more requirements for register, then resutling in the additional spills to the stack.</p>
</blockquote>



<a name="444835732"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%238706%20Changing%20an%20immediate%20operand%20from.../near/444835732" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.238706.20Changing.20an.20immediate.20operand.20from.2E.2E.2E.html#444835732">(Jun 15 2024 at 06:44)</a>:</h4>
<p>hungryzzz edited a <a href="https://github.com/bytecodealliance/wasmtime/issues/8706#issuecomment-2169163351">comment</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/8706">issue #8706</a>:</p>
<blockquote>
<p>Hi, I  go though the generated machine codes and I think I know something about the performance difference.</p>
<p>I find that if the value which will be set to global variable[1] is a negtive number, then the compiler will use two instructions to represent the <code>global.set</code>, i.e., first moving <code>$0xfffeffff</code> to a register <code>%r10d</code> then moving the register to the specified memory address. And if the value is a positive number, then the compiler will use only one instruction to do it, i.e., directly moving the <code>$0x10000</code> to the specified address. Because the first one needs one more register, additional spills are needed.<br>
By the way, I check the machine code generated by <code>WasmEdge</code>, it use like <code>movl $0xfffeffff,0xa0(%rdi)</code> to execute the <code>bad.wasm</code>.</p>
<div class="codehilite" data-code-language="Bash"><pre><span></span><code><span class="c1"># part of the machine code of bad.wasm</span>
<span class="m">104</span><span class="w"> </span><span class="p">|</span><span class="w">  </span>mov<span class="w"> </span><span class="nv">$0</span>xfffeffff,%r10d
<span class="m">105</span><span class="w"> </span><span class="p">|</span><span class="w">  </span>mov<span class="w"> </span>%r10d,0xa0<span class="o">(</span>%rdi<span class="o">)</span>

<span class="c1"># part of the machine code of good.wasm</span>
<span class="m">95</span><span class="w"> </span><span class="p">|</span><span class="w">  </span>movl<span class="w"> </span><span class="nv">$0</span>x10000,0xa0<span class="o">(</span>%rdi<span class="o">)</span>
</code></pre></div>
<p>After the above all investigation, I guess the root cause of  all the performance differences is the different register allocation algorithm used by <code>Wasmtime</code> and others. I think maybe slightly changes on the <code>bad.wasm</code> will cause more requirements for register, then resutling in the additional spills to the stack.</p>
</blockquote>



<a name="444835857"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%238706%20Changing%20an%20immediate%20operand%20from.../near/444835857" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.238706.20Changing.20an.20immediate.20operand.20from.2E.2E.2E.html#444835857">(Jun 15 2024 at 06:46)</a>:</h4>
<p>hungryzzz edited a <a href="https://github.com/bytecodealliance/wasmtime/issues/8706#issuecomment-2169163351">comment</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/8706">issue #8706</a>:</p>
<blockquote>
<p>@cfallin Hi, I  go though the generated machine codes and I think I know something about the performance difference.</p>
<p>I find that if the value which will be set to global variable[1] is a negtive number, then the compiler will use two instructions to represent the <code>global.set</code>, i.e., first moving <code>$0xfffeffff</code> to a register <code>%r10d</code> then moving the register to the specified memory address. And if the value is a positive number, then the compiler will use only one instruction to do it, i.e., directly moving the <code>$0x10000</code> to the specified address. Because the first one needs one more register, additional spills are needed.<br>
By the way, I check the machine code generated by <code>WasmEdge</code>, it use like <code>movl $0xfffeffff,0xa0(%rdi)</code> to execute the <code>bad.wasm</code>.</p>
<div class="codehilite" data-code-language="Bash"><pre><span></span><code><span class="c1"># part of the machine code of bad.wasm</span>
<span class="m">104</span><span class="w"> </span><span class="p">|</span><span class="w">  </span>mov<span class="w"> </span><span class="nv">$0</span>xfffeffff,%r10d
<span class="m">105</span><span class="w"> </span><span class="p">|</span><span class="w">  </span>mov<span class="w"> </span>%r10d,0xa0<span class="o">(</span>%rdi<span class="o">)</span>

<span class="c1"># part of the machine code of good.wasm</span>
<span class="m">95</span><span class="w"> </span><span class="p">|</span><span class="w">  </span>movl<span class="w"> </span><span class="nv">$0</span>x10000,0xa0<span class="o">(</span>%rdi<span class="o">)</span>
</code></pre></div>
<p>After the above all investigation, I guess the root cause of  all the performance differences is the different register allocation algorithm used by <code>Wasmtime</code> and others. I think maybe slightly changes on the <code>bad.wasm</code> will cause more requirements for register, then resutling in the additional spills to the stack.</p>
</blockquote>



<a name="445038908"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%238706%20Changing%20an%20immediate%20operand%20from.../near/445038908" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.238706.20Changing.20an.20immediate.20operand.20from.2E.2E.2E.html#445038908">(Jun 17 2024 at 01:25)</a>:</h4>
<p>cfallin <a href="https://github.com/bytecodealliance/wasmtime/issues/8706#issuecomment-2172002441">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/8706">issue #8706</a>:</p>
<blockquote>
<p>Ah, interesting, there may be something odd about the way we lower stores-of-immediates in the x64 backend that precludes this case -- @abrown do you think you'd be willing to take a look at this? (If true it should be reproducible with a small CLIF test that stores a constant <code>0x10000</code> or <code>0xfffeffff</code> to some given address)</p>
</blockquote>



<a name="445498375"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%238706%20Changing%20an%20immediate%20operand%20from.../near/445498375" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.238706.20Changing.20an.20immediate.20operand.20from.2E.2E.2E.html#445498375">(Jun 19 2024 at 02:55)</a>:</h4>
<p>abrown <a href="https://github.com/bytecodealliance/wasmtime/issues/8706#issuecomment-2177448709">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/8706">issue #8706</a>:</p>
<blockquote>
<p>Sure, I can put this on the TODO list but no promises about when I get to it!</p>
</blockquote>



<a name="445758876"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%238706%20Changing%20an%20immediate%20operand%20from.../near/445758876" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.238706.20Changing.20an.20immediate.20operand.20from.2E.2E.2E.html#445758876">(Jun 20 2024 at 04:46)</a>:</h4>
<p>hungryzzz <a href="https://github.com/bytecodealliance/wasmtime/issues/8706#issuecomment-2179797151">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/8706">issue #8706</a>:</p>
<blockquote>
<p>@alexcrichton Hi, I pulled your PR and found it can fix the above case, thank you! But could I ask why positive and negative numbers are stored in different ways in memory before this PR? And how do you fix it? (I tried to understand these when I went through the PR but failed...) Thanks again! </p>
</blockquote>



<a name="445878016"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%238706%20Changing%20an%20immediate%20operand%20from.../near/445878016" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.238706.20Changing.20an.20immediate.20operand.20from.2E.2E.2E.html#445878016">(Jun 20 2024 at 15:17)</a>:</h4>
<p>cfallin <a href="https://github.com/bytecodealliance/wasmtime/issues/8706#issuecomment-2180959671">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/8706">issue #8706</a>:</p>
<blockquote>
<p>@hungryzzz the issue was a missed case in the instruction lowering. x86-64 has a store instruction (a form of <code>mov</code>) that can store arbitrary 32-bit values to the destination; however, we weren't matching signed-negative 32-bit values in our existing lowering rules, so we fell back to the slower path of "put the value in a register then store it". Alex's PR fixed the rule match (left-hand side) to catch that case as well.</p>
</blockquote>



<a name="445878511"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%238706%20Changing%20an%20immediate%20operand%20from.../near/445878511" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.238706.20Changing.20an.20immediate.20operand.20from.2E.2E.2E.html#445878511">(Jun 20 2024 at 15:19)</a>:</h4>
<p>hungryzzz <a href="https://github.com/bytecodealliance/wasmtime/issues/8706#issuecomment-2180964231">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/8706">issue #8706</a>:</p>
<blockquote>
<p>Got it! Thanks a lot!</p>
</blockquote>



<a name="446091238"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%238706%20Changing%20an%20immediate%20operand%20from.../near/446091238" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.238706.20Changing.20an.20immediate.20operand.20from.2E.2E.2E.html#446091238">(Jun 21 2024 at 14:10)</a>:</h4>
<p>hungryzzz <a href="https://github.com/bytecodealliance/wasmtime/issues/8706#issuecomment-2182831430">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/8706">issue #8706</a>:</p>
<blockquote>
<p>Hi, I am also wondering why only the one register requirement leads to so many additional spills? If requiring more registers, would it get worse? Thank you very much! (I really hope that my questions would not spend too much of your time...)</p>
</blockquote>



<a name="446110225"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%238706%20Changing%20an%20immediate%20operand%20from.../near/446110225" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.238706.20Changing.20an.20immediate.20operand.20from.2E.2E.2E.html#446110225">(Jun 21 2024 at 15:48)</a>:</h4>
<p>cfallin <a href="https://github.com/bytecodealliance/wasmtime/issues/8706#issuecomment-2183005091">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/8706">issue #8706</a>:</p>
<blockquote>
<p>@hungryzzz we're happy to help with questions like these, but the Bytecode Alliance <a href="https://bytecodealliance.zulipchat.com/">Zulip</a> is probably easier for such discussions (that are really about how compilers work rather than resolving this particular issue).</p>
<p>With Alex's fix in #8842 are we ok to close this issue or do you see any more performance deltas?</p>
</blockquote>



<a name="446226403"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%238706%20Changing%20an%20immediate%20operand%20from.../near/446226403" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.238706.20Changing.20an.20immediate.20operand.20from.2E.2E.2E.html#446226403">(Jun 22 2024 at 05:54)</a>:</h4>
<p>hungryzzz closed <a href="https://github.com/bytecodealliance/wasmtime/issues/8706">issue #8706</a>:</p>
<blockquote>
<h3>Test Cases</h3>
<p><a href="https://github.com/bytecodealliance/wasmtime/files/15487475/cases.zip">cases.zip</a></p>
<h3>Steps to Reproduce</h3>
<p>Hi, I run the attached two cases(<code>good.wasm</code>&amp;<code>bad.wasm</code>) in <code>Wasmtime</code> and <code>WasmEdge</code>(AOT), and collect their execution time respectively (measured by <code>time</code> tool).</p>
<div class="codehilite" data-code-language="Bash"><pre><span></span><code><span class="c1"># command to collect execution time of wasmtime</span>
wasmtime<span class="w"> </span>compile<span class="w"> </span>bad.wasm<span class="w"> </span>-o<span class="w"> </span>bad.cwasm
<span class="nb">time</span><span class="w"> </span>wasmtime<span class="w"> </span>run<span class="w"> </span>--allow-precompiled<span class="w"> </span>bad.cwasm

<span class="c1"># command to collect execution time of wasmedge</span>
wasmedgec<span class="w"> </span>bad.wasm<span class="w"> </span>bad-wasmedge-aot.wasm
<span class="nb">time</span><span class="w"> </span>wasmedge<span class="w"> </span>bad-wasmedge-aot.wasm
</code></pre></div>
<h3>Expected Results &amp; Actual Results</h3>
<p>For <code>good.wasm</code>, the execution time in different runtimes are as follows:</p>
<ul>
<li>Wasmtime: 1.42s</li>
<li>WasmEdge: 1.05s</li>
</ul>
<p>For <code>bad.wasm</code>, the execution time in different runtimes are as follows:</p>
<ul>
<li>Wasmtime: 3.29s</li>
<li>WasmEdge: 0.91s</li>
</ul>
<p>The difference between the attached two cases is as follow, i.e., changing one of the operand of <code>i32.and</code> from <code>0</code> to <code>1</code>. The difference and bring 1.8s performance decreasing on <code>Wasmtime</code> but has no negative effect on <code>WasmEdge</code>.</p>
<div class="codehilite" data-code-language="Bash"><pre><span></span><code>➜<span class="w">  </span>cases<span class="w"> </span>diff<span class="w"> </span>good.wat<span class="w"> </span>bad.wat
35c35
&lt;<span class="w">             </span>i32.const<span class="w"> </span><span class="m">0</span>
---
&gt;<span class="w">             </span>i32.const<span class="w"> </span><span class="m">1</span>
</code></pre></div>
<div class="codehilite" data-code-language="WebAssembly"><pre><span></span><code><span class="c1">;; part of good.wat</span>
  <span class="k">if</span>
    <span class="nb">i32.const</span> <span class="mi">1</span>
    <span class="nb">local.set</span> <span class="mi">2</span>
    <span class="nb">i32.const</span> <span class="mi">1</span>
    <span class="nb">local.get</span> <span class="mi">0</span>
    <span class="nb">i32.const</span> <span class="mi">0</span> <span class="c1">;; here</span>
    <span class="nb">i32.and</span>
    <span class="nb">i32.add</span>
    <span class="nb">local.set</span> <span class="mi">6</span>
    <span class="nb">br</span> <span class="mi">1</span>

<span class="c1">;; part of bad.wat</span>
<span class="k">if</span>
  <span class="nb">i32.const</span> <span class="mi">1</span>
  <span class="nb">local.set</span> <span class="mi">2</span>
  <span class="nb">i32.const</span> <span class="mi">1</span>
  <span class="nb">local.get</span> <span class="mi">0</span>
  <span class="nb">i32.const</span> <span class="mi">1</span> <span class="c1">;; here</span>
  <span class="nb">i32.and</span>
  <span class="nb">i32.add</span>
  <span class="nb">local.set</span> <span class="mi">6</span>
  <span class="nb">br</span> <span class="mi">1</span>
</code></pre></div>
<p>I check the machine code generated by <code>Wasmtime</code> and <code>WasmEdge</code> respectively, the instruction numbers of <code>func2</code>(the difference is in it) are as follows:</p>
<ul>
<li>
<p><code>WasmEdge</code></p>
<ul>
<li><code>good.wasm</code>: 89</li>
<li><code>bad.wasm</code>: 92</li>
<li>diff: 3</li>
</ul>
</li>
<li>
<p><code>Wasmtime</code></p>
<ul>
<li><code>good.wasm</code>: 132</li>
<li><code>bad.wasm</code>: 157</li>
<li>diff: 25</li>
</ul>
</li>
</ul>
<p>I think maybe the difference affect the data flow analysis during optimization so maybe some optimization decisions are different , but I really confuse why the instructions number of generated machine code could change so much, and I think maybe the extra instructions in <code>bad.wasm</code> make it slower than the good one.<br>
I also use Perf tool to profile the hotspots in <code>Wasmtime</code> but I cannot find something useful.</p>
<h3>Versions and Environment</h3>
<ul>
<li>Wasmtime version or commit: 7f7064c74</li>
<li>Operating system: Linux ringzzz-OptiPlex-Micro-Plus-7010 6.5.0-18-generic</li>
<li>Architecture: Intel(R) Core(TM) i5-13500<br>
</li>
</ul>
</blockquote>



<a name="446226405"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%238706%20Changing%20an%20immediate%20operand%20from.../near/446226405" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.238706.20Changing.20an.20immediate.20operand.20from.2E.2E.2E.html#446226405">(Jun 22 2024 at 05:54)</a>:</h4>
<p>hungryzzz <a href="https://github.com/bytecodealliance/wasmtime/issues/8706#issuecomment-2183823625">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/8706">issue #8706</a>:</p>
<blockquote>
<p>The performance anomaly has been fixed, thanks a lot!</p>
</blockquote>



<hr><p>Last updated: Jan 20 2025 at 06:04 UTC</p>
</html>