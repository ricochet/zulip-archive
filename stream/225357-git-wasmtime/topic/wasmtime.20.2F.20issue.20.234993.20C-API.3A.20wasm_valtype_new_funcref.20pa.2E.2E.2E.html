<html>
<head><meta charset="utf-8"><title>wasmtime / issue #4993 C-API: wasm_valtype_new_funcref pa... · git-wasmtime · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/index.html">git-wasmtime</a></h2>
<h3>Topic: <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.234993.20C-API.3A.20wasm_valtype_new_funcref.20pa.2E.2E.2E.html">wasmtime / issue #4993 C-API: wasm_valtype_new_funcref pa...</a></h3>

<hr>

<base href="https://bytecodealliance.zulipchat.com">

<head><link href="https://bytecodealliance.github.io/zulip-archive/style.css" rel="stylesheet"></head>

<a name="301875350"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%234993%20C-API%3A%20wasm_valtype_new_funcref%20pa.../near/301875350" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.234993.20C-API.3A.20wasm_valtype_new_funcref.20pa.2E.2E.2E.html#301875350">(Oct 01 2022 at 23:17)</a>:</h4>
<p>amusingimpala75 opened <a href="https://github.com/bytecodealliance/wasmtime/issues/4993">issue #4993</a>:</p>
<blockquote>
<h3>Expected behaviour:</h3>
<p><code>wasm_valtype_new_funcref()</code> or <code>wasm_valtype_new(WASM_FUNCREF)</code> return a <code>wasm_valtype_t *</code> with a FuncRef type.</p>
<h3>Actual behaviour:</h3>
<p>errors with</p>
<blockquote>
<p>thread '&lt; unnamed&gt;' panicked at 'unexpected kind: 129', crates/c-api/src/types/val.rs:40:14</p>
</blockquote>
<p>and terminates</p>
</blockquote>



<a name="301875724"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%234993%20C-API%3A%20wasm_valtype_new_funcref%20pa.../near/301875724" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.234993.20C-API.3A.20wasm_valtype_new_funcref.20pa.2E.2E.2E.html#301875724">(Oct 01 2022 at 23:22)</a>:</h4>
<p>bjorn3 <a href="https://github.com/bytecodealliance/wasmtime/issues/4993#issuecomment-1264506828">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/4993">issue #4993</a>:</p>
<blockquote>
<p>There is no wasm_valtype_new_funcref function in wasmtime. As for WASM_FUNCREF it exists and should be handled at <a href="https://github.com/bytecodealliance/wasmtime/blob/3fa545bd89d6e18e6e85eab57499ee9c9f5032f2/crates/c-api/src/types/val.rs?q=WASM_FUNCREF#L38">https://github.com/bytecodealliance/wasmtime/blob/3fa545bd89d6e18e6e85eab57499ee9c9f5032f2/crates/c-api/src/types/val.rs?q=WASM_FUNCREF#L38</a>. Are you using the latest wasmtime version?</p>
</blockquote>



<a name="301876184"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%234993%20C-API%3A%20wasm_valtype_new_funcref%20pa.../near/301876184" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.234993.20C-API.3A.20wasm_valtype_new_funcref.20pa.2E.2E.2E.html#301876184">(Oct 01 2022 at 23:29)</a>:</h4>
<p>amusingimpala75 <a href="https://github.com/bytecodealliance/wasmtime/issues/4993#issuecomment-1264507827">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/4993">issue #4993</a>:</p>
<blockquote>
<p>wasmtime-v1.0.1-aarch64-macos-c-api</p>
</blockquote>



<a name="301876259"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%234993%20C-API%3A%20wasm_valtype_new_funcref%20pa.../near/301876259" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.234993.20C-API.3A.20wasm_valtype_new_funcref.20pa.2E.2E.2E.html#301876259">(Oct 01 2022 at 23:30)</a>:</h4>
<p>amusingimpala75 <a href="https://github.com/bytecodealliance/wasmtime/issues/4993#issuecomment-1264507985">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/4993">issue #4993</a>:</p>
<blockquote>
<p>also include/wasm.h defines an inline <code>wasm_valtype_new_funcref()</code> which just defers to <code>wasm_valtype_new(WASM_FUNCREF)</code>.</p>
</blockquote>



<a name="301980523"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%234993%20C-API%3A%20wasm_valtype_new_funcref%20pa.../near/301980523" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.234993.20C-API.3A.20wasm_valtype_new_funcref.20pa.2E.2E.2E.html#301980523">(Oct 02 2022 at 23:03)</a>:</h4>
<p>amusingimpala75 <a href="https://github.com/bytecodealliance/wasmtime/issues/4993#issuecomment-1264754022">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/4993">issue #4993</a>:</p>
<blockquote>
<p>externref does not work either.</p>
</blockquote>



<a name="302087168"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%234993%20C-API%3A%20wasm_valtype_new_funcref%20pa.../near/302087168" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.234993.20C-API.3A.20wasm_valtype_new_funcref.20pa.2E.2E.2E.html#302087168">(Oct 03 2022 at 15:28)</a>:</h4>
<p>alexcrichton <a href="https://github.com/bytecodealliance/wasmtime/issues/4993#issuecomment-1265642351">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/4993">issue #4993</a>:</p>
<blockquote>
<p>Thanks for the report, but this looks like something may be going wrong on your end somewhere, although I'm not sure where. The error message</p>
<blockquote>
<p><code>thread '&lt; unnamed&gt;' panicked at 'unexpected kind: 129', crates/c-api/src/types/val.rs:40:14</code></p>
</blockquote>
<p>says that 129 wasn't expected but that's the value of <code>WASM_FUNCREF</code> which is in the <code>match</code> arm. This may mean that while you think you're using 1.0.1 you're using an older binary by accident or something like that (or a completely different binary?)</p>
<p>I've tested this locally with the Python bindings for the C API and these functions work and return the expected result.</p>
</blockquote>



<a name="302087298"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%234993%20C-API%3A%20wasm_valtype_new_funcref%20pa.../near/302087298" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.234993.20C-API.3A.20wasm_valtype_new_funcref.20pa.2E.2E.2E.html#302087298">(Oct 03 2022 at 15:28)</a>:</h4>
<p>alexcrichton <a href="https://github.com/bytecodealliance/wasmtime/issues/4993#issuecomment-1265643346">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/4993">issue #4993</a>:</p>
<blockquote>
<p>Although now that I think this could also be an aarch64-macos ABI-specific issue, unfortunately though I do not have access to such hardware to test myself.</p>
</blockquote>



<a name="302112996"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%234993%20C-API%3A%20wasm_valtype_new_funcref%20pa.../near/302112996" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.234993.20C-API.3A.20wasm_valtype_new_funcref.20pa.2E.2E.2E.html#302112996">(Oct 03 2022 at 17:39)</a>:</h4>
<p>bjorn3 <a href="https://github.com/bytecodealliance/wasmtime/issues/4993#issuecomment-1265805991">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/4993">issue #4993</a>:</p>
<blockquote>
<p>Could this be <a href="https://github.com/rust-lang/rust/issues/97463">https://github.com/rust-lang/rust/issues/97463</a>?</p>
</blockquote>



<a name="302160973"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%234993%20C-API%3A%20wasm_valtype_new_funcref%20pa.../near/302160973" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.234993.20C-API.3A.20wasm_valtype_new_funcref.20pa.2E.2E.2E.html#302160973">(Oct 03 2022 at 22:38)</a>:</h4>
<p>amusingimpala75 <a href="https://github.com/bytecodealliance/wasmtime/issues/4993#issuecomment-1266144494">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/4993">issue #4993</a>:</p>
<blockquote>
<p>I have not used Wasmtime previously, so it is not a stale binary problem.<br>
Yeah, it just doesn’t make sense because WASM_FUNCREF is clearly being evaluated as 129 from <a href="http://vals.rs">vals.rs</a>, but then a direct comparison to that variable in the rust function fails, so I suspect it might be the ABI problem. </p>
</blockquote>



<a name="302288213"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%234993%20C-API%3A%20wasm_valtype_new_funcref%20pa.../near/302288213" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.234993.20C-API.3A.20wasm_valtype_new_funcref.20pa.2E.2E.2E.html#302288213">(Oct 04 2022 at 15:32)</a>:</h4>
<p>alexcrichton <a href="https://github.com/bytecodealliance/wasmtime/issues/4993#issuecomment-1267190337">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/4993">issue #4993</a>:</p>
<blockquote>
<p>Ok this is definitely an ABI issue. On an aarch64 linux system which I presume is similar enough ABI-wise to macos:</p>
<div class="codehilite" data-code-language="C"><pre><span></span><code><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;stdint.h&gt;</span><span class="cp"></span>

<span class="k">extern</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">the_imported_func</span><span class="p">(</span><span class="kt">uint8_t</span><span class="w"> </span><span class="n">a</span><span class="p">);</span><span class="w"></span>

<span class="kt">void</span><span class="w"> </span><span class="nf">foo</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="n">the_imported_func</span><span class="p">(</span><span class="mi">129</span><span class="p">);</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>
<p>yields:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="cp">$</span><span class="w"> </span><span class="n">cc</span><span class="w"> </span><span class="o">-</span><span class="n">c</span><span class="w"> </span><span class="n">foo</span><span class="p">.</span><span class="n">c</span><span class="w"> </span><span class="o">-</span><span class="n">I</span><span class="w"> </span><span class="p">.</span><span class="o">/</span><span class="n">wasm</span><span class="o">-</span><span class="n">c</span><span class="o">-</span><span class="n">api</span><span class="o">/</span><span class="n">include</span><span class="w"> </span><span class="o">-</span><span class="n">O</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">objdump</span><span class="w"> </span><span class="o">-</span><span class="n">S</span><span class="w"> </span><span class="n">foo</span><span class="p">.</span><span class="n">o</span><span class="w"></span>

<span class="n">foo</span><span class="p">.</span><span class="n">o</span>:     <span class="nc">file</span><span class="w"> </span><span class="n">format</span><span class="w"> </span><span class="n">elf64</span><span class="o">-</span><span class="n">littleaarch64</span><span class="w"></span>


<span class="n">Disassembly</span><span class="w"> </span><span class="n">of</span><span class="w"> </span><span class="n">section</span><span class="w"> </span><span class="p">.</span><span class="n">text</span>:

<span class="mi">0000000000000000</span><span class="w"> </span><span class="o">&lt;</span><span class="n">foo</span><span class="o">&gt;</span>:
   <span class="mi">0</span>:   <span class="nc">a9bf7bfd</span><span class="w">        </span><span class="n">stp</span><span class="w">     </span><span class="n">x29</span><span class="p">,</span><span class="w"> </span><span class="n">x30</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="n">sp</span><span class="p">,</span><span class="w"> </span>#<span class="o">-</span><span class="mi">16</span><span class="p">]</span><span class="o">!</span><span class="w"></span>
<span class="w">   </span><span class="mi">4</span>:   <span class="mi">910003</span><span class="n">fd</span><span class="w">        </span><span class="n">mov</span><span class="w">     </span><span class="n">x29</span><span class="p">,</span><span class="w"> </span><span class="n">sp</span><span class="w"></span>
<span class="w">   </span><span class="mi">8</span>:   <span class="mi">12800</span><span class="n">fc0</span><span class="w">        </span><span class="n">mov</span><span class="w">     </span><span class="n">w0</span><span class="p">,</span><span class="w"> </span>#<span class="mh">0xffffff81</span><span class="w">                 </span><span class="c1">// #-127</span>
<span class="w">   </span><span class="n">c</span>:   <span class="mi">94000000</span><span class="w">        </span><span class="n">bl</span><span class="w">      </span><span class="mi">0</span><span class="w"> </span><span class="o">&lt;</span><span class="n">the_imported_func</span><span class="o">&gt;</span><span class="w"></span>
<span class="w">  </span><span class="mi">10</span>:   <span class="nc">a8c17bfd</span><span class="w">        </span><span class="n">ldp</span><span class="w">     </span><span class="n">x29</span><span class="p">,</span><span class="w"> </span><span class="n">x30</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="n">sp</span><span class="p">],</span><span class="w"> </span>#<span class="mi">16</span><span class="w"></span>
<span class="w">  </span><span class="mi">14</span>:   <span class="nc">d65f03c0</span><span class="w">        </span><span class="n">ret</span><span class="w"></span>
</code></pre></div>
<p>where at <code>8</code> the operand is being sign extended from 8 to 32-bits.</p>
<p>On Rust stable:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="cp">#[no_mangle]</span><span class="w"></span>
<span class="k">pub</span><span class="w"> </span><span class="k">extern</span><span class="w"> </span><span class="s">"C"</span><span class="w"> </span><span class="k">fn</span> <span class="nf">wat</span><span class="p">(</span><span class="n">a</span>: <span class="kt">u8</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="kt">bool</span> <span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">a</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">129</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>
<p>yields:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="cp">$</span><span class="w"> </span><span class="n">rustc</span><span class="w"> </span><span class="n">foo</span><span class="p">.</span><span class="n">rs</span><span class="w"> </span><span class="o">-</span><span class="n">O</span><span class="w"> </span><span class="o">--</span><span class="k">crate</span><span class="o">-</span><span class="k">type</span> <span class="nc">cdylib</span><span class="w"> </span><span class="o">--</span><span class="n">emit</span><span class="w"> </span><span class="n">obj</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">objdump</span><span class="w"> </span><span class="o">-</span><span class="n">S</span><span class="w"> </span><span class="n">foo</span><span class="p">.</span><span class="n">o</span><span class="w"></span>

<span class="n">foo</span><span class="p">.</span><span class="n">o</span>:     <span class="nc">file</span><span class="w"> </span><span class="n">format</span><span class="w"> </span><span class="n">elf64</span><span class="o">-</span><span class="n">littleaarch64</span><span class="w"></span>


<span class="n">Disassembly</span><span class="w"> </span><span class="n">of</span><span class="w"> </span><span class="n">section</span><span class="w"> </span><span class="p">.</span><span class="n">text</span><span class="p">.</span><span class="n">wat</span>:

<span class="mi">0000000000000000</span><span class="w"> </span><span class="o">&lt;</span><span class="n">wat</span><span class="o">&gt;</span>:
   <span class="mi">0</span>:   <span class="mi">7102041</span><span class="n">f</span><span class="w">        </span><span class="n">cmp</span><span class="w">     </span><span class="n">w0</span><span class="p">,</span><span class="w"> </span>#<span class="mh">0x81</span><span class="w"></span>
<span class="w">   </span><span class="mi">4</span>:   <span class="mi">1</span><span class="n">a9f17e0</span><span class="w">        </span><span class="n">cset</span><span class="w">    </span><span class="n">w0</span><span class="p">,</span><span class="w"> </span><span class="n">eq</span><span class="w">  </span><span class="c1">// eq = none</span>
<span class="w">   </span><span class="mi">8</span>:   <span class="nc">d65f03c0</span><span class="w">        </span><span class="n">ret</span><span class="w"></span>
</code></pre></div>
<p>where the comparison is a 32-bit comparison hence the failure.</p>
<p>On nightly Rust, however:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="cp">$</span><span class="w"> </span><span class="n">rustc</span><span class="w"> </span><span class="o">+</span><span class="n">nightly</span><span class="w"> </span><span class="n">foo</span><span class="p">.</span><span class="n">rs</span><span class="w"> </span><span class="o">-</span><span class="n">O</span><span class="w"> </span><span class="o">--</span><span class="k">crate</span><span class="o">-</span><span class="k">type</span> <span class="nc">cdylib</span><span class="w"> </span><span class="o">--</span><span class="n">emit</span><span class="w"> </span><span class="n">obj</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">objdump</span><span class="w"> </span><span class="o">-</span><span class="n">S</span><span class="w"> </span><span class="n">foo</span><span class="p">.</span><span class="n">o</span><span class="w"></span>

<span class="n">foo</span><span class="p">.</span><span class="n">o</span>:     <span class="nc">file</span><span class="w"> </span><span class="n">format</span><span class="w"> </span><span class="n">elf64</span><span class="o">-</span><span class="n">littleaarch64</span><span class="w"></span>


<span class="n">Disassembly</span><span class="w"> </span><span class="n">of</span><span class="w"> </span><span class="n">section</span><span class="w"> </span><span class="p">.</span><span class="n">text</span><span class="p">.</span><span class="n">wat</span>:

<span class="mi">0000000000000000</span><span class="w"> </span><span class="o">&lt;</span><span class="n">wat</span><span class="o">&gt;</span>:
   <span class="mi">0</span>:   <span class="mi">12001</span><span class="n">c08</span><span class="w">        </span><span class="n">and</span><span class="w">     </span><span class="n">w8</span><span class="p">,</span><span class="w"> </span><span class="n">w0</span><span class="p">,</span><span class="w"> </span>#<span class="mh">0xff</span><span class="w"></span>
<span class="w">   </span><span class="mi">4</span>:   <span class="mi">7102051</span><span class="n">f</span><span class="w">        </span><span class="n">cmp</span><span class="w">     </span><span class="n">w8</span><span class="p">,</span><span class="w"> </span>#<span class="mh">0x81</span><span class="w"></span>
<span class="w">   </span><span class="mi">8</span>:   <span class="mi">1</span><span class="n">a9f17e0</span><span class="w">        </span><span class="n">cset</span><span class="w">    </span><span class="n">w0</span><span class="p">,</span><span class="w"> </span><span class="n">eq</span><span class="w">  </span><span class="c1">// eq = none</span>
<span class="w">   </span><span class="n">c</span>:   <span class="nc">d65f03c0</span><span class="w">        </span><span class="n">ret</span><span class="w"></span>
</code></pre></div>
<p>Here the <code>and</code> fixes the issue.</p>
<p>So @amusingimpala75 I think you'll need to compile with nightly Rust for now instead of using the precompiled artifacts for AArch64 macos for the time being.</p>
</blockquote>



<a name="302288652"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%234993%20C-API%3A%20wasm_valtype_new_funcref%20pa.../near/302288652" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.234993.20C-API.3A.20wasm_valtype_new_funcref.20pa.2E.2E.2E.html#302288652">(Oct 04 2022 at 15:34)</a>:</h4>
<p>alexcrichton <a href="https://github.com/bytecodealliance/wasmtime/issues/4993#issuecomment-1267192777">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/4993">issue #4993</a>:</p>
<blockquote>
<p>Given that this is a rustc bug and otherwise <code>wasm.h</code> isn't something we can modify, I'm going to close this. This can be worked around with nightly Rust-compiled artifacts and looks like it will get fixed with time as that makes its way to stable.</p>
</blockquote>



<a name="302288654"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%234993%20C-API%3A%20wasm_valtype_new_funcref%20pa.../near/302288654" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.234993.20C-API.3A.20wasm_valtype_new_funcref.20pa.2E.2E.2E.html#302288654">(Oct 04 2022 at 15:34)</a>:</h4>
<p>alexcrichton closed <a href="https://github.com/bytecodealliance/wasmtime/issues/4993">issue #4993</a>:</p>
<blockquote>
<h3>Expected behaviour:</h3>
<p><code>wasm_valtype_new_funcref()</code> or <code>wasm_valtype_new(WASM_FUNCREF)</code> return a <code>wasm_valtype_t *</code> with a FuncRef type.</p>
<h3>Actual behaviour:</h3>
<p>errors with</p>
<blockquote>
<p>thread '&lt; unnamed&gt;' panicked at 'unexpected kind: 129', crates/c-api/src/types/val.rs:40:14</p>
</blockquote>
<p>and terminates</p>
</blockquote>



<a name="302370716"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%234993%20C-API%3A%20wasm_valtype_new_funcref%20pa.../near/302370716" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.234993.20C-API.3A.20wasm_valtype_new_funcref.20pa.2E.2E.2E.html#302370716">(Oct 05 2022 at 00:42)</a>:</h4>
<p>amusingimpala75 <a href="https://github.com/bytecodealliance/wasmtime/issues/4993#issuecomment-1267771262">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/4993">issue #4993</a>:</p>
<blockquote>
<p>I have now tried building the c-api with +nightly (1.66.0-nightly, from Oct 3), and it is producing a binary with a different hash, but it still will not work, creating the same error. I've never really fiddled with Rust before, so maybe I just do not know what I am doing.</p>
</blockquote>



<a name="302371901"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%234993%20C-API%3A%20wasm_valtype_new_funcref%20pa.../near/302371901" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.234993.20C-API.3A.20wasm_valtype_new_funcref.20pa.2E.2E.2E.html#302371901">(Oct 05 2022 at 00:59)</a>:</h4>
<p>amusingimpala75 <a href="https://github.com/bytecodealliance/wasmtime/issues/4993#issuecomment-1267782128">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/4993">issue #4993</a>:</p>
<blockquote>
<p>Nevermind, I just have to use the debug build, not the release build.</p>
</blockquote>



<hr><p>Last updated: Jan 20 2025 at 06:04 UTC</p>
</html>