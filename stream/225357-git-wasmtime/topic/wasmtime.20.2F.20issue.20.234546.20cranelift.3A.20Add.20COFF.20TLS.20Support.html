<html>
<head><meta charset="utf-8"><title>wasmtime / issue #4546 cranelift: Add COFF TLS Support · git-wasmtime · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/index.html">git-wasmtime</a></h2>
<h3>Topic: <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.234546.20cranelift.3A.20Add.20COFF.20TLS.20Support.html">wasmtime / issue #4546 cranelift: Add COFF TLS Support</a></h3>

<hr>

<base href="https://bytecodealliance.zulipchat.com">

<head><link href="https://bytecodealliance.github.io/zulip-archive/style.css" rel="stylesheet"></head>

<a name="291196309"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%234546%20cranelift%3A%20Add%20COFF%20TLS%20Support/near/291196309" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.234546.20cranelift.3A.20Add.20COFF.20TLS.20Support.html#291196309">(Jul 28 2022 at 14:16)</a>:</h4>
<p>bjorn3 <a href="https://github.com/bytecodealliance/wasmtime/pull/4546#issuecomment-1198201375">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/4546">issue #4546</a>:</p>
<blockquote>
<blockquote>
<p>Do we need to mark the gs register as used?</p>
</blockquote>
<p>The gs register is not allocatable by regalloc, so it doesn't need to be marked as usable.</p>
</blockquote>



<a name="291201063"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%234546%20cranelift%3A%20Add%20COFF%20TLS%20Support/near/291201063" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.234546.20cranelift.3A.20Add.20COFF.20TLS.20Support.html#291201063">(Jul 28 2022 at 14:31)</a>:</h4>
<p>bjorn3 <a href="https://github.com/bytecodealliance/wasmtime/pull/4546#issuecomment-1198221741">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/4546">issue #4546</a>:</p>
<blockquote>
<p>Thanks a lot for working on this!</p>
</blockquote>



<a name="291201427"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%234546%20cranelift%3A%20Add%20COFF%20TLS%20Support/near/291201427" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.234546.20cranelift.3A.20Add.20COFF.20TLS.20Support.html#291201427">(Jul 28 2022 at 14:34)</a>:</h4>
<p>bjorn3 <a href="https://github.com/bytecodealliance/wasmtime/pull/4546#issuecomment-1198225180">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/4546">issue #4546</a>:</p>
<blockquote>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="cp">#![feature(thread_local)]</span><span class="w">                                                                                                                          </span><span class="mi">1</span><span class="w"> </span><span class="err">↵</span><span class="w"> </span><span class="n">bjorn</span><span class="o">@</span><span class="n">laptopbjorn</span><span class="o">-</span><span class="n">lenovo</span><span class="w"></span>

<span class="k">use</span><span class="w"> </span><span class="n">std</span>::<span class="n">cell</span>::<span class="n">Cell</span><span class="p">;</span><span class="w"></span>

<span class="cp">#[thread_local]</span><span class="w"></span>
<span class="k">pub</span><span class="w"> </span><span class="k">static</span><span class="w"> </span><span class="n">FOO</span>: <span class="nc">Cell</span><span class="o">&lt;</span><span class="kt">u8</span><span class="o">&gt;</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Cell</span>::<span class="n">new</span><span class="p">(</span><span class="mi">42</span><span class="p">);</span><span class="w"></span>
<span class="k">pub</span><span class="w"> </span><span class="k">static</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">BAR</span>: <span class="kt">u8</span> <span class="o">=</span><span class="w"> </span><span class="mi">43</span><span class="p">;</span><span class="w"></span>
<span class="k">pub</span><span class="w"> </span><span class="k">fn</span> <span class="nf">get_foo</span><span class="p">()</span><span class="w"> </span>-&gt; <span class="kt">u8</span> <span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">FOO</span><span class="p">.</span><span class="n">get</span><span class="p">()</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="k">pub</span><span class="w"> </span><span class="k">fn</span> <span class="nf">set_foo</span><span class="p">(</span><span class="n">foo</span>: <span class="kt">u8</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">FOO</span><span class="p">.</span><span class="n">set</span><span class="p">(</span><span class="n">foo</span><span class="p">)</span><span class="w"></span>
<span class="p">}</span><span class="o">'</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">rustc</span><span class="w"> </span><span class="o">+</span><span class="n">nightly</span><span class="w"> </span><span class="o">--</span><span class="n">target</span><span class="w"> </span><span class="n">x86_64</span><span class="o">-</span><span class="n">pc</span><span class="o">-</span><span class="n">windows</span><span class="o">-</span><span class="n">msvc</span><span class="w"> </span><span class="o">--</span><span class="n">emit</span><span class="w"> </span><span class="n">obj</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="o">--</span><span class="k">crate</span><span class="o">-</span><span class="k">type</span> <span class="nc">lib</span><span class="w"> </span><span class="o">-</span><span class="n">O</span><span class="w"></span>
</code></pre></div>
<p>produces an object file for which <code>objdump -dr</code> gives:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="n">rust_out</span><span class="p">.</span><span class="n">o</span>:     <span class="nc">file</span><span class="w"> </span><span class="n">format</span><span class="w"> </span><span class="n">pe</span><span class="o">-</span><span class="n">x86</span><span class="o">-</span><span class="mi">64</span><span class="w"></span>


<span class="n">Disassembly</span><span class="w"> </span><span class="n">of</span><span class="w"> </span><span class="n">section</span><span class="w"> </span><span class="p">.</span><span class="n">text</span>:

<span class="mi">0000000000000000</span><span class="w"> </span><span class="o">&lt;</span><span class="n">_ZN8rust_out7get_foo17h9e4ed845564f4123E</span><span class="o">&gt;</span>:
   <span class="mi">0</span>:   <span class="mi">8</span><span class="n">b</span><span class="w"> </span><span class="mi">05</span><span class="w"> </span><span class="mi">00</span><span class="w"> </span><span class="mi">00</span><span class="w"> </span><span class="mi">00</span><span class="w"> </span><span class="mi">00</span><span class="w">       </span><span class="n">mov</span><span class="w">    </span><span class="mh">0x0</span><span class="p">(</span><span class="o">%</span><span class="n">rip</span><span class="p">),</span><span class="o">%</span><span class="n">eax</span><span class="w">        </span>#<span class="w"> </span><span class="mi">6</span><span class="w"> </span><span class="o">&lt;</span><span class="n">_ZN8rust_out7get_foo17h9e4ed845564f4123E</span><span class="o">+</span><span class="mh">0x6</span><span class="o">&gt;</span><span class="w"></span>
<span class="w">                        </span><span class="mi">2</span>: <span class="nc">R_X86_64_PC32</span><span class="w">        </span><span class="n">_tls_index</span><span class="w"></span>
<span class="w">   </span><span class="mi">6</span>:   <span class="mi">65</span><span class="w"> </span><span class="mi">48</span><span class="w"> </span><span class="mi">8</span><span class="n">b</span><span class="w"> </span><span class="mi">0</span><span class="n">c</span><span class="w"> </span><span class="mi">25</span><span class="w"> </span><span class="mi">58</span><span class="w"> </span><span class="mi">00</span><span class="w">    </span><span class="n">mov</span><span class="w">    </span><span class="o">%</span><span class="n">gs</span>:<span class="mh">0x58</span><span class="p">,</span><span class="o">%</span><span class="n">rcx</span><span class="w"></span>
<span class="w">   </span><span class="n">d</span>:   <span class="mi">00</span><span class="w"> </span><span class="mi">00</span><span class="w"></span>
<span class="w">   </span><span class="n">f</span>:   <span class="mi">48</span><span class="w"> </span><span class="mi">8</span><span class="n">b</span><span class="w"> </span><span class="mi">04</span><span class="w"> </span><span class="n">c1</span><span class="w">             </span><span class="n">mov</span><span class="w">    </span><span class="p">(</span><span class="o">%</span><span class="n">rcx</span><span class="p">,</span><span class="o">%</span><span class="n">rax</span><span class="p">,</span><span class="mi">8</span><span class="p">),</span><span class="o">%</span><span class="n">rax</span><span class="w"></span>
<span class="w">  </span><span class="mi">13</span>:   <span class="mi">8</span><span class="n">a</span><span class="w"> </span><span class="mi">80</span><span class="w"> </span><span class="mi">00</span><span class="w"> </span><span class="mi">00</span><span class="w"> </span><span class="mi">00</span><span class="w"> </span><span class="mi">00</span><span class="w">       </span><span class="n">mov</span><span class="w">    </span><span class="mh">0x0</span><span class="p">(</span><span class="o">%</span><span class="n">rax</span><span class="p">),</span><span class="o">%</span><span class="n">al</span><span class="w"></span>
<span class="w">                        </span><span class="mi">15</span>: <span class="nc">secrel32</span><span class="w">    </span><span class="n">_ZN8rust_out3FOO17he424d0489633cb80E</span><span class="w"></span>
<span class="w">  </span><span class="mi">19</span>:   <span class="nc">c3</span><span class="w">                      </span><span class="n">retq</span><span class="w"></span>

<span class="n">Disassembly</span><span class="w"> </span><span class="n">of</span><span class="w"> </span><span class="n">section</span><span class="w"> </span><span class="p">.</span><span class="n">text</span>:

<span class="mi">0000000000000000</span><span class="w"> </span><span class="o">&lt;</span><span class="n">_ZN8rust_out7set_foo17hb5fb9735547d2b58E</span><span class="o">&gt;</span>:
   <span class="mi">0</span>:   <span class="mi">8</span><span class="n">b</span><span class="w"> </span><span class="mi">05</span><span class="w"> </span><span class="mi">00</span><span class="w"> </span><span class="mi">00</span><span class="w"> </span><span class="mi">00</span><span class="w"> </span><span class="mi">00</span><span class="w">       </span><span class="n">mov</span><span class="w">    </span><span class="mh">0x0</span><span class="p">(</span><span class="o">%</span><span class="n">rip</span><span class="p">),</span><span class="o">%</span><span class="n">eax</span><span class="w">        </span>#<span class="w"> </span><span class="mi">6</span><span class="w"> </span><span class="o">&lt;</span><span class="n">_ZN8rust_out7set_foo17hb5fb9735547d2b58E</span><span class="o">+</span><span class="mh">0x6</span><span class="o">&gt;</span><span class="w"></span>
<span class="w">                        </span><span class="mi">2</span>: <span class="nc">R_X86_64_PC32</span><span class="w">        </span><span class="n">_tls_index</span><span class="w"></span>
<span class="w">   </span><span class="mi">6</span>:   <span class="mi">65</span><span class="w"> </span><span class="mi">48</span><span class="w"> </span><span class="mi">8</span><span class="n">b</span><span class="w"> </span><span class="mi">14</span><span class="w"> </span><span class="mi">25</span><span class="w"> </span><span class="mi">58</span><span class="w"> </span><span class="mi">00</span><span class="w">    </span><span class="n">mov</span><span class="w">    </span><span class="o">%</span><span class="n">gs</span>:<span class="mh">0x58</span><span class="p">,</span><span class="o">%</span><span class="n">rdx</span><span class="w"></span>
<span class="w">   </span><span class="n">d</span>:   <span class="mi">00</span><span class="w"> </span><span class="mi">00</span><span class="w"></span>
<span class="w">   </span><span class="n">f</span>:   <span class="mi">48</span><span class="w"> </span><span class="mi">8</span><span class="n">b</span><span class="w"> </span><span class="mi">04</span><span class="w"> </span><span class="n">c2</span><span class="w">             </span><span class="n">mov</span><span class="w">    </span><span class="p">(</span><span class="o">%</span><span class="n">rdx</span><span class="p">,</span><span class="o">%</span><span class="n">rax</span><span class="p">,</span><span class="mi">8</span><span class="p">),</span><span class="o">%</span><span class="n">rax</span><span class="w"></span>
<span class="w">  </span><span class="mi">13</span>:   <span class="mi">88</span><span class="w"> </span><span class="mi">88</span><span class="w"> </span><span class="mi">00</span><span class="w"> </span><span class="mi">00</span><span class="w"> </span><span class="mi">00</span><span class="w"> </span><span class="mi">00</span><span class="w">       </span><span class="n">mov</span><span class="w">    </span><span class="o">%</span><span class="n">cl</span><span class="p">,</span><span class="mh">0x0</span><span class="p">(</span><span class="o">%</span><span class="n">rax</span><span class="p">)</span><span class="w"></span>
<span class="w">                        </span><span class="mi">15</span>: <span class="nc">secrel32</span><span class="w">    </span><span class="n">_ZN8rust_out3FOO17he424d0489633cb80E</span><span class="w"></span>
<span class="w">  </span><span class="mi">19</span>:   <span class="nc">c3</span><span class="w">                      </span><span class="n">retq</span><span class="w"></span>
</code></pre></div>
<p>and <code>objdump --syms</code>:</p>
<p><div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="n">rust_out</span><span class="p">.</span><span class="n">o</span>:     <span class="nc">file</span><span class="w"> </span><span class="n">format</span><span class="w"> </span><span class="n">pe</span><span class="o">-</span><span class="n">x86</span><span class="o">-</span><span class="mi">64</span><span class="w"></span>

<span class="n">SYMBOL</span><span class="w"> </span><span class="n">TABLE</span>:
<span class="p">[</span><span class="w">  </span><span class="mi">0</span><span class="p">](</span><span class="n">sec</span><span class="w">  </span><span class="mi">1</span><span class="p">)(</span><span class="n">fl</span><span class="w"> </span><span class="mh">0x00</span><span class="p">)(</span><span class="n">ty</span><span class="w">   </span><span class="mi">0</span><span class="p">)(</span><span class="n">scl</span><span class="w">   </span><span class="mi">3</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="n">nx</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="mh">0x0000000000000000</span><span class="w"> </span><span class="p">.</span><span class="n">text</span><span class="w"></span>
<span class="n">AUX</span><span class="w"> </span><span class="n">scnlen</span><span class="w"> </span><span class="mh">0x0</span><span class="w"> </span><span class="n">nreloc</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="n">nlnno</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="n">checksum</span><span class="w"> </span><span class="mh">0x0</span><span class="w"> </span><span class="n">assoc</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="n">comdat</span><span class="w"> </span><span class="mi">0</span><span class="w"></span>
<span class="p">[</span><span class="w">  </span><span class="mi">2</span><span class="p">](</span><span class="n">sec</span><span class="w">  </span><span class="mi">2</span><span class="p">)(</span><span class="n">fl</span><span class="w"> </span><span class="mh">0x00</span><span class="p">)(</span><span class="n">ty</span><span class="w">   </span><span class="mi">0</span><span class="p">)(</span><span class="n">scl</span><span class="w">   </span><span class="mi">3</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="n">nx</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="mh">0x0000000000000000</span><span class="w"> </span><span class="p">.</span><span class="n">data</span><span class="w"></span>
<span class="n">AUX</span><span class="w"> </span><span class="n">scnlen</span><span class="w"> </span><span class="mh">0x0</span><span class="w"> </span><span class="n">nreloc</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="n">nlnno</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="n">checksum</span><span class="w"> </span><span class="mh">0x0</span><span class="w"> </span><span class="n">assoc</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="n">comdat</span><span class="w"> </span><span class="mi">0</span><span class="w"></span>
<span class="p">[</span><span class="w">  </span><span class="mi">4</span><span class="p">](</span><span class="n">sec</span><span class="w">  </span><span class="mi">3</span><span class="p">)(</span><span class="n">fl</span><span class="w"> </span><span class="mh">0x00</span><span class="p">)(</span><span class="n">ty</span><span class="w">   </span><span class="mi">0</span><span class="p">)(</span><span class="n">scl</span><span class="w">   </span><span class="mi">3</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="n">nx</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="mh">0x0000000000000000</span><span class="w"> </span><span class="p">.</span><span class="n">bss</span><span class="w"></span>
<span class="n">AUX</span><span class="w"> </span><span class="n">scnlen</span><span class="w"> </span><span class="mh">0x0</span><span class="w"> </span><span class="n">nreloc</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="n">nlnno</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="n">checksum</span><span class="w"> </span><span class="mh">0x0</span><span class="w"> </span><span class="n">assoc</span><span class="w"> </span><span class="mi">3</span><span class="w"> </span><span class="n">comdat</span><span class="w"> </span><span class="mi">0</span><span class="w"></span>
<span class="p">[</span><span class="w">  </span><span class="mi">6</span><span class="p">](</span><span class="n">sec</span><span class="w">  </span><span class="mi">4</span><span class="p">)(</span><span class="n">fl</span><span class="w"> </span><span class="mh">0x00</span><span class="p">)(</span><span class="n">ty</span><span class="w">   </span><span class="mi">0</span><span class="p">)(</span><span class="n">scl</span><span class="w">   </span><span class="mi">3</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="n">nx</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="mh">0x0000000000000000</span><span class="w"> </span><span class="p">.</span><span class="n">text</span><span class="w"></span>
<span class="n">AUX</span><span class="w"> </span><span class="n">scnlen</span><span class="w"> </span><span class="mh">0x1a</span><span class="w"> </span><span class="n">nreloc</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="n">nlnno</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="n">checksum</span><span class="w"> </span><span class="mh">0xa84d5eee</span><span class="w"> </span><span class="n">assoc</span><span class="w"> </span><span class="mi">4</span><span class="w"> </span><span class="n">comdat</span><span class="w"> </span><span class="mi">1</span><span class="w"></span>
<span class="p">[</span><span class="w">  </span><span class="mi">8</span><span class="p">](</span><span class="n">sec</span><span class="w">  </span><span class="mi">4</span><span class="p">)(</span><span class="n">fl</span><span class="w"> </span><span class="mh">0x00</span><span class="p">)(</span><span class="n">ty</span><span class="w">  </span><span class="mi">20</span><span class="p">)(</span><span class="n">scl</span><span class="w">   </span><span class="mi">2</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="n">nx</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="mh">0x0000000000000000</span><span class="w"> </span><span class="n">_ZN8rust_out7get_foo17h9e4ed845564f4123E</span><span class="w"></span>
<span class="p">[</span><span class="w">  </span><span class="mi">9</span><span class="p">](</span><span class="n">sec</span><span class="w">  </span><span class="mi">5</span><span class="p">)(</span><span class="n">fl</span><span class="w"> </span><span class="mh">0x00</span><span class="p">)(</span><span class="n">ty</span><span class="w">   </span><span class="mi">0</span><span class="p">)(</span><span class="n">scl</span><span class="w">   </span><span class="mi">3</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="n">nx</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="mh">0x0000000000000000</span><span class="w"> </span><span class="p">.</span><span class="n">text</span><span class="w"></span>
<span class="n">AUX</span><span class="w"> </span><span class="n">scnlen</span><span class="w"> </span><span class="mh">0x1a</span><span class="w"> </span><span class="n">nreloc</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="n">nlnno</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="n">checksum</span><span class="w"> </span><span class="mh">0xac4f1caa</span><span class="w"> </span><span class="n">assoc</span><span class="w"> </span><span class="mi">5</span><span class="w"> </span><span class="n">comdat</span><span class="w"> </span><span class="mi">1</span><span class="w"></span>
<span class="p">[</span><span class="w"> </span><span class="mi">11</span><span class="p">](</span><span class="n">sec</span><span class="w">  </span><span class="mi">5</span><span class="p">)(</span><span class="n">fl</span><span class="w"> </span><span class="mh">0x00</span><span class="p">)(</span><span class="n">ty</span><span class="w">  </span><span class="mi">20</span><span class="p">)(</span><span class="n">scl</span><span class="w">   </span><span class="mi">2</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="n">nx</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="mh">0x0000000000000000</span><span class="w"> </span><span class="n">_ZN8rust_out7set_foo17hb5fb9735547d2b58E</span><span class="w"></span>
<span class="p">[</span><span class="w"> </span><span class="mi">12</span><span class="p">](</span><span class="n">sec</span><span class="w">  </span><span class="mi">6</span><span class="p">)(</span><span class="n">fl</span><span class="w"> </span><span class="mh">0x00</span><span class="p">)(</span><span class="n">ty</span><span class="w">   </span><span class="mi">0</span><span class="p">)(</span><span class="n">scl</span><span class="w">   </span><span class="mi">3</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="n">nx</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="mh">0x0000000000000000</span><span class="w"> </span><span class="p">.</span><span class="n">tls</span><span class="cp">$</span><span class="w"></span>
<span class="n">AUX</span><span class="w"> </span><span class="n">scnlen</span><span class="w"> </span><span class="mh">0x1</span><span class="w"> </span><span class="n">nreloc</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="n">nlnno</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="n">checksum</span><span class="w"> </span><span class="mh">0xdbbbc9d6</span><span class="w"> </span><span class="n">assoc</span><span class="w"> </span><span class="mi">6</span><span class="w"> </span><span class="n">comdat</span><span class="w"> </span><span class="mi">1</span><span class="w"></span>
<span class="p">[</span><span class="w"> </span><span class="mi">14</span><span class="p">](</span><span class="n">sec</span><span class="w">  </span><span class="mi">6</span><span class="p">)(</span><span class="n">fl</span><span class="w"> </span><span class="mh">0x00</span><span class="p">)(</span><span class="n">ty</span><span class="w">   </span><span class="mi">0</span><span class="p">)(</span><span class="n">scl</span><span class="w">   </span><span class="mi">2</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="n">nx</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="mh">0x0000000000000000</span><span class="w"> </span><span class="n">_ZN8rust_out3FOO17he424d0489633cb80E</span><span class="w"></span>
<span class="p">[</span><span class="w"> </span><span class="mi">15</span><span class="p">](</span><span class="n">sec</span><span class="w">  </span><span class="mi">7</span><span class="p">)(</span><span class="n">fl</span><span class="w"> </span><span class="mh">0x00</span><span class="p">)(</span><span class="n">ty</span><span class="w">   </span><span class="mi">0</span><span class="p">)(</span><span class="n">scl</span><span class="w">   </span><span class="mi">3</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="n">nx</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="mh">0x0000000000000000</span><span class="w"> </span><span class="p">.</span><span class="n">data</span><span class="w"></span>
<span class="n">AUX</span><span class="w"> </span><span class="n">scnlen</span><span class="w"> </span><span class="mh">0x1</span><span class="w"> </span><span class="n">nreloc</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="n">nlnno</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="n">checksum</span><span class="w"> </span><span class="mh">0xacbcf940</span><span class="w"> </span><span class="n">assoc</span><span class="w"> </span><span class="mi">7</span><span class="w"> </span><span class="n">comdat</span><span class="w"> </span><span class="mi">1</span><span class="w"></span>
<span class="p">[</span><span class="w"> </span><span class="mi">17</span><span class="p">](</span><span class="n">sec</span><span class="w">  </span><span class="mi">7</span><span class="p">)(</span><span class="n">fl</span><span class="w"> </span><span class="mh">0x00</span><span class="p">)(</span><span class="n">ty</span><span class="w">   </span><span class="mi">0</span><span class="p">)(</span><span class="n">scl</span><span class="w">   </span><span class="mi">2</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="n">nx</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="mh">0x0000000000000000</span><span class="w"> </span><span class="n">_ZN8rust_out3BAR17hab28e85eef212a9aE</span><span class="w"></span>
<span class="p">[</span><span class="w"> </span><span class="mi">18</span><span class="p">](</span><span class="n">sec</span><span class="w">  </span><span class="mi">8</span><span class="p">)(</span><span class="n">fl</span><span class="w"> </span><span class="mh">0x00</span><span class="p">)(</span><span class="n">ty</span><span class="w">   </span><span class="mi">0</span><span class="p">)(</span><span class="n">scl</span><span class="w">   </span><span class="mi">3</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="n">nx</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="mh">0x0000000000000000</span><span class="w"> </span><span class="p">.</span><span class="n">data</span><span class="w"></span>
<span class="n">AUX</span><span class="w"> </span><span class="n">scnlen</span><span class="w"> </span><span class="mh">0x8</span><span class="w"> </span><span class="n">nreloc</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="n">nlnno</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="n">checksum</span><span class="w"> </span><span class="mh">0x0</span><span class="w"> </span><span class="n">assoc</span><span class="w"> </span><span class="mi">8</span><span class="w"> </span><span class="n">comdat</span><span class="w"> </span><span class="mi">1</span><span class="w"></span>
<span class="p">[</span><span class="w"> </span><span class="mi">20</span><span class="p">](</span><span class="n">sec</span><span class="w">  </span><span class="mi">8</span><span class="p">)(</span><span class="n">fl</span><span class="w"> </span><span class="mh">0x00</span><span class="p">)(</span><span class="n">ty</span><span class="w">   </span><span class="mi">0</span><span class="p">)(</span><span class="n">scl</span><span class="w">   </span><span class="mi">2</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="n">nx</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="mh">0x0000000000000000</span><span class="w"> </span><span class="n">__imp__ZN8rust_out3FOO17he424d0489633cb80E</span><span class="w"></span>
<span class="p">[</span><span class="w"> </span><span class="mi">21</span><span class="p">](</span><span class="n">sec</span><span class="w">  </span><span class="mi">9</span><span class="p">)(</span><span class="n">fl</span><span class="w"> </span><span class="mh">0x00</span><span class="p">)(</span><span class="n">ty</span><span class="w">   </span><span class="mi">0</span><span class="p">)(</span><span class="n">scl</span><span class="w">   </span><span class="mi">3</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="n">nx</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="mh">0x0000000000000000</span><span class="w"> </span><span class="p">.</span><span class="n">data</span><span class="w"></span>
<span class="n">AUX</span><span class="w"> </span><span class="n">scnlen</span><span class="w"> </span><span class="mh">0x8</span><span class="w"> </span><span class="n">nreloc</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="n">nlnno</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="n">checksum</span><span class="w"> </span><span class="mh">0x0</span><span class="w"> </span><span class="n">assoc</span><span class="w"> </span><span class="mi">9</span><span class="w"> </span><span class="n">comdat</span><span class="w"> </span><span class="mi">1</span><span class="w"></span>
<span class="p">[</span><span class="w"> </span><span class="mi">23</span><span class="p">](</span><span class="n">sec</span><span class="w">  </span><span class="mi">9</span><span class="p">)(</span><span class="n">fl</span><span class="w"> </span><span class="mh">0x00</span><span class="p">)(</span><span class="n">ty</span><span class="w">   </span><span class="mi">0</span><span class="p">)(</span><span class="n">scl</span><span class="w">   </span><span class="mi">2</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="n">nx</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="mh">0x0000000000000000</span><span class="w"> </span><span class="n">__imp__ZN8rust_out3BAR17hab28e85eef212a9aE</span><span class="w"></span>
<span class="p">[</span><span class="w"> </span><span class="mi">24</span><span class="p">](</span><span class="n">sec</span><span class="w"> </span><span class="o">-</span><span class="mi">1</span><span class="p">)(</span><span class="n">fl</span><span class="w"> </span><span class="mh">0x00</span><span class="p">)(</span><span class="n">ty</span><span class="w">   </span><span class="mi">0</span><span class="p">)(</span><span class="n">scl</span><span class="w">   </span><span class="mi">3</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="n">nx</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="mh">0x0000000000000000</span><span class="w"> </span><span class="o">@</span><span class="n">feat</span><span class="p">.</span><span class="mi">00</span><span class="w"></span>
<span class="p">[</span><span class="w"> </span><span class="mi">25</span><span class="p">](</span><span class="n">sec</span><span class="w">  </span><span class="mi">0</span><span class="p">)(</span><span class="n">fl</span><span class="w"> </span><span class="mh">0x00</span><span class="p">)(</span><span class="n">ty</span><span class="w">   </span><span class="mi">0</span><span class="p">)(</span><span class="n">scl</span><span class="w">   </span><span class="mi">2</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="n">nx</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="mh">0x0000000000000000</span><span class="w"> </span><span class="n">_tls_index</span><span class="w"></span>
<span class="p">[</span><span class="w"> </span><span class="mi">26</span><span class="p">](</span><span class="n">sec</span><span class="w"> </span><span class="o">-</span><span class="mi">2</span><span class="p">)(</span><span class="n">fl</span><span class="w"> </span><span class="mh">0x00</span><span class="p">)(</span><span class="n">ty</span><span class="w">   </span><span class="mi">0</span><span class="p">)(</span><span class="n">scl</span><span class="w"> </span><span class="mi">103</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="n">nx</span><span class="w"> </span><span class="mi">2</span><span class="p">)</span><span class="w"> </span><span class="mh">0x0000000000000000</span><span class="w"> </span><span class="n">rust_out</span><span class="p">.</span><span class="n">cb515bd7</span><span class="o">-</span><span class="w"></span>
<span class="n">File</span><span class="w"></span>
<span class="n">File</span><span class="w"></span>
</code></pre></div><br>
</p>
</blockquote>



<a name="291226675"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%234546%20cranelift%3A%20Add%20COFF%20TLS%20Support/near/291226675" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.234546.20cranelift.3A.20Add.20COFF.20TLS.20Support.html#291226675">(Jul 28 2022 at 17:34)</a>:</h4>
<p>bjorn3 <a href="https://github.com/bytecodealliance/wasmtime/pull/4546#issuecomment-1198440767">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/4546">issue #4546</a>:</p>
<blockquote>
<p>I managed to run a small tls example on windows! <span aria-label="tada" class="emoji emoji-1f389" role="img" title="tada">:tada:</span></p>
<p><div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="cp">#![feature(thread_local)]</span><span class="w"></span>
<span class="k">use</span><span class="w"> </span><span class="n">std</span>::<span class="n">cell</span>::<span class="n">Cell</span><span class="p">;</span><span class="w"></span>
<span class="cp">#[thread_local]</span><span class="w"></span>
<span class="k">static</span><span class="w"> </span><span class="n">FOO</span>: <span class="nc">Cell</span><span class="o">&lt;</span><span class="kt">u8</span><span class="o">&gt;</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Cell</span>::<span class="n">new</span><span class="p">(</span><span class="mi">42</span><span class="p">);</span><span class="w"></span>
<span class="k">fn</span> <span class="nf">main</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="fm">assert_eq!</span><span class="p">(</span><span class="n">FOO</span><span class="p">.</span><span class="n">get</span><span class="p">(),</span><span class="w"> </span><span class="mi">42</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="n">std</span>::<span class="n">thread</span>::<span class="n">spawn</span><span class="p">(</span><span class="o">||</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="n">FOO</span><span class="p">.</span><span class="n">set</span><span class="p">(</span><span class="mi">43</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="fm">assert_eq!</span><span class="p">(</span><span class="n">FOO</span><span class="p">.</span><span class="n">get</span><span class="p">(),</span><span class="w"> </span><span class="mi">43</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="p">}).</span><span class="n">join</span><span class="p">();</span><span class="w"></span>
<span class="w">    </span><span class="fm">assert_eq!</span><span class="p">(</span><span class="n">FOO</span><span class="p">.</span><span class="n">get</span><span class="p">(),</span><span class="w"> </span><span class="mi">42</span><span class="p">);</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div><br>
</p>
</blockquote>



<a name="291227177"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%234546%20cranelift%3A%20Add%20COFF%20TLS%20Support/near/291227177" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.234546.20cranelift.3A.20Add.20COFF.20TLS.20Support.html#291227177">(Jul 28 2022 at 17:39)</a>:</h4>
<p>afonso360 <a href="https://github.com/bytecodealliance/wasmtime/pull/4546#issuecomment-1198444592">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/4546">issue #4546</a>:</p>
<blockquote>
<blockquote>
<p>I managed to run a small tls example on windows! <span aria-label="tada" class="emoji emoji-1f389" role="img" title="tada">:tada:</span></p>
</blockquote>
<p>That's really cool! I'm going to try an compile <code>cg_clif</code> with this, to see where it breaks next. I suspect we don't have a very complete TLS implementation.</p>
</blockquote>



<a name="291228741"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%234546%20cranelift%3A%20Add%20COFF%20TLS%20Support/near/291228741" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.234546.20cranelift.3A.20Add.20COFF.20TLS.20Support.html#291228741">(Jul 28 2022 at 17:53)</a>:</h4>
<p>afonso360 edited a <a href="https://github.com/bytecodealliance/wasmtime/pull/4546#issuecomment-1198444592">comment</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/4546">issue #4546</a>:</p>
<blockquote>
<blockquote>
<p>I managed to run a small tls example on windows! <span aria-label="tada" class="emoji emoji-1f389" role="img" title="tada">:tada:</span></p>
</blockquote>
<p>That's really cool! I'm going to try and compile <code>cg_clif</code> with this, to see where it breaks next. I suspect we don't have a very complete TLS implementation.</p>
</blockquote>



<a name="292827483"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%234546%20cranelift%3A%20Add%20COFF%20TLS%20Support/near/292827483" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.234546.20cranelift.3A.20Add.20COFF.20TLS.20Support.html#292827483">(Aug 10 2022 at 20:26)</a>:</h4>
<p>afonso360 <a href="https://github.com/bytecodealliance/wasmtime/pull/4546#issuecomment-1211231223">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/4546">issue #4546</a>:</p>
<blockquote>
<p>Rebased this on top of <code>main</code>. I've also renamed the <code>TlsIndex</code> symbol to <code>CoffTlsIndex</code>.</p>
<p>With this rebase we've also lost the lookup function. But we can add it later if we need it in the JIT, is this okay @bjorn3 ?</p>
</blockquote>



<a name="292827707"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%234546%20cranelift%3A%20Add%20COFF%20TLS%20Support/near/292827707" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.234546.20cranelift.3A.20Add.20COFF.20TLS.20Support.html#292827707">(Aug 10 2022 at 20:28)</a>:</h4>
<p>afonso360 edited a <a href="https://github.com/bytecodealliance/wasmtime/pull/4546#issuecomment-1211231223">comment</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/4546">issue #4546</a>:</p>
<blockquote>
<p>Rebased this on top of <code>main</code>. I've also renamed the <code>TlsIndex</code> symbol to <code>CoffTlsIndex</code>.</p>
<p>With this rebase we've also lost the lookup function. But we can add it later when we need it in the JIT, is this okay @bjorn3 ?</p>
</blockquote>



<a name="292827863"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%234546%20cranelift%3A%20Add%20COFF%20TLS%20Support/near/292827863" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.234546.20cranelift.3A.20Add.20COFF.20TLS.20Support.html#292827863">(Aug 10 2022 at 20:29)</a>:</h4>
<p>bjorn3 <a href="https://github.com/bytecodealliance/wasmtime/pull/4546#issuecomment-1211234179">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/4546">issue #4546</a>:</p>
<blockquote>
<p>Fine with me.</p>
</blockquote>



<a name="292853633"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%234546%20cranelift%3A%20Add%20COFF%20TLS%20Support/near/292853633" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.234546.20cranelift.3A.20Add.20COFF.20TLS.20Support.html#292853633">(Aug 11 2022 at 00:46)</a>:</h4>
<p>jameysharp <a href="https://github.com/bytecodealliance/wasmtime/pull/4546#issuecomment-1211443771">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/4546">issue #4546</a>:</p>
<blockquote>
<p>Do you both feel this is ready for merge, then? I've glanced over it and it looks reasonable to me, but I'm not at all familiar with how thread-local storage works on any platform.</p>
</blockquote>



<a name="292871084"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%234546%20cranelift%3A%20Add%20COFF%20TLS%20Support/near/292871084" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.234546.20cranelift.3A.20Add.20COFF.20TLS.20Support.html#292871084">(Aug 11 2022 at 05:56)</a>:</h4>
<p>afonso360 <a href="https://github.com/bytecodealliance/wasmtime/pull/4546#issuecomment-1211578750">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/4546">issue #4546</a>:</p>
<blockquote>
<p>Yes, this should be ready to merge!</p>
</blockquote>



<hr><p>Last updated: Jan 20 2025 at 06:04 UTC</p>
</html>