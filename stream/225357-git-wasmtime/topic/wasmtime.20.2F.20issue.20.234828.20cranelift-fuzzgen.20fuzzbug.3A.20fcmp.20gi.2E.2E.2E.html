<html>
<head><meta charset="utf-8"><title>wasmtime / issue #4828 cranelift-fuzzgen fuzzbug: fcmp gi... · git-wasmtime · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/index.html">git-wasmtime</a></h2>
<h3>Topic: <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.234828.20cranelift-fuzzgen.20fuzzbug.3A.20fcmp.20gi.2E.2E.2E.html">wasmtime / issue #4828 cranelift-fuzzgen fuzzbug: fcmp gi...</a></h3>

<hr>

<base href="https://bytecodealliance.zulipchat.com">

<head><link href="https://bytecodealliance.github.io/zulip-archive/style.css" rel="stylesheet"></head>

<a name="296242064"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%234828%20cranelift-fuzzgen%20fuzzbug%3A%20fcmp%20gi.../near/296242064" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.234828.20cranelift-fuzzgen.20fuzzbug.3A.20fcmp.20gi.2E.2E.2E.html#296242064">(Aug 31 2022 at 00:53)</a>:</h4>
<p>jameysharp opened <a href="https://github.com/bytecodealliance/wasmtime/issues/4828">issue #4828</a>:</p>
<blockquote>
<p>Original report: <a href="https://oss-fuzz.com/testcase-detail/5662899036618752">https://oss-fuzz.com/testcase-detail/5662899036618752</a></p>
<p>&lt;details&gt;<br>
&lt;summary&gt;Test case input&lt;/summary&gt;</p>
<p>&lt;!-- Please base64-encode the input that libFuzzer generated, and paste it in the code-block below. This is required for us to reproduce the issue. --&gt;</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="n">YWlzY3RuIG8BXQAAe</span><span class="o">/</span><span class="n">HfLJGaiKD4</span><span class="o">/</span><span class="n">wAA6bZjQHhAcB7</span><span class="c1">//wAHAAAA6bYgJgAB6fgAAAABAABK//8A</span>
<span class="n">ABgAAAD</span><span class="c1">/////f///////////////////////////////////////////////////////////////</span>
<span class="c1">/////////////////ydV1sbWP9aCKgKCtgoFAGUAAAAAAAAAm/4p2gFG8J19fQAAAAAAAAAAAAAA</span>
<span class="n">AAAAAAAAAAAAAAAAAABlAWzzxkbacCrdpP</span><span class="c1">//AAAAAAD6/wBDQ0P///////////////////////8A</span>
<span class="n">ZcYNRyYxRvSWnfAyAAAAADsgAakAfX0AAP</span><span class="o">+</span><span class="n">udf8AAA8AAAAAAPr</span><span class="o">/</span><span class="n">AENDQ0NDm5ubm5ubm5ubm5ub</span><span class="w"></span>
<span class="n">m5ubm5ubm5ubm5ubfX3zfZubfQ</span><span class="o">==</span><span class="w"></span>
</code></pre></div>
<p>&lt;/details&gt;</p>
<p>I've minimized this to the following CLIF test:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="n">test</span><span class="w"> </span><span class="n">interpret</span><span class="w"></span>
<span class="n">test</span><span class="w"> </span><span class="n">run</span><span class="w"></span>
<span class="n">target</span><span class="w"> </span><span class="n">aarch64</span><span class="w"></span>
<span class="n">target</span><span class="w"> </span><span class="n">s390x</span><span class="w"></span>
<span class="n">target</span><span class="w"> </span><span class="n">x86_64</span><span class="w"></span>

<span class="n">function</span><span class="w"> </span><span class="o">%</span><span class="k">fn</span><span class="p">(</span><span class="kt">f64</span><span class="w"> </span><span class="n">uext</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nc">b1</span><span class="w"> </span><span class="n">system_v</span><span class="w"> </span><span class="p">{</span><span class="w"></span>

<span class="n">block0</span><span class="p">(</span><span class="n">v3</span>: <span class="kt">f64</span><span class="p">)</span>:
    <span class="nc">v78</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">fcmp</span><span class="w"> </span><span class="n">le</span><span class="w"> </span><span class="n">v3</span><span class="p">,</span><span class="w"> </span><span class="n">v3</span><span class="w"></span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">v78</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="p">;</span><span class="w"> </span><span class="n">run</span>: <span class="o">%</span><span class="k">fn</span><span class="p">(</span><span class="o">-</span><span class="n">NaN</span>:<span class="mh">0x7ffffffffffff</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="kc">false</span><span class="w"></span>
</code></pre></div>
<p>On x86-64, this call returns <code>false</code>; but on the interpreter it returns <code>true</code>. Those two implementations have disagreed at least back to June, so this doesn't seem to be due to any recent changes.</p>
<p>I wasn't sure what the "right" answer is here so I wrote a quick wasm program for which wasmtime generates this CLIF instruction.</p>
<p>&lt;details&gt;<br>
&lt;summary&gt;Equivalent wasm&lt;/summary&gt;</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="p">(</span><span class="n">module</span><span class="w"></span>
<span class="w">  </span><span class="p">(</span><span class="n">func</span><span class="w"> </span><span class="cp">$fn</span><span class="w"> </span><span class="p">(</span><span class="n">param</span><span class="w"> </span><span class="kt">f64</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="n">local</span><span class="p">.</span><span class="n">get</span><span class="w"> </span><span class="mi">0</span><span class="w"></span>
<span class="w">    </span><span class="n">local</span><span class="p">.</span><span class="n">get</span><span class="w"> </span><span class="mi">0</span><span class="w"></span>
<span class="w">    </span><span class="kt">f64</span><span class="p">.</span><span class="n">le</span><span class="w"></span>
<span class="w">    </span><span class="k">if</span><span class="w"></span>
<span class="w">      </span><span class="n">unreachable</span><span class="w"></span>
<span class="w">    </span><span class="n">end</span><span class="w"></span>
<span class="w">  </span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="p">(</span><span class="n">func</span><span class="w"> </span><span class="cp">$test</span><span class="w"></span>
<span class="w">    </span><span class="kt">f64</span><span class="p">.</span><span class="k">const</span><span class="w"> </span><span class="o">-</span><span class="n">nan</span>:<span class="mh">0x7ffffffffffff</span><span class="w"></span>
<span class="w">    </span><span class="n">call</span><span class="w"> </span><span class="cp">$fn</span><span class="w"></span>
<span class="w">  </span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="p">(</span><span class="n">export</span><span class="w"> </span><span class="s">"test"</span><span class="w"> </span><span class="p">(</span><span class="n">func</span><span class="w"> </span><span class="cp">$test</span><span class="p">))</span><span class="w"></span>
<span class="p">)</span><span class="w"></span>
</code></pre></div>
<p>&lt;/details&gt;</p>
<p>This program doesn't trap either on wasmtime compiling for x86-64, or on wabt's wasm-interp, so I gather the Cranelift interpreter is the one giving the wrong answer here.</p>
<p>@afonso360, can you look into this?</p>
<p>I guess we should extend <code>cranelift/filetests/filetests/runtests/fcmp.clif</code> with NaN tests, and also start running that test file on the interpreter.</p>
</blockquote>



<a name="296242065"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%234828%20cranelift-fuzzgen%20fuzzbug%3A%20fcmp%20gi.../near/296242065" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.234828.20cranelift-fuzzgen.20fuzzbug.3A.20fcmp.20gi.2E.2E.2E.html#296242065">(Aug 31 2022 at 00:53)</a>:</h4>
<p>jameysharp labeled <a href="https://github.com/bytecodealliance/wasmtime/issues/4828">issue #4828</a>:</p>
<blockquote>
<p>Original report: <a href="https://oss-fuzz.com/testcase-detail/5662899036618752">https://oss-fuzz.com/testcase-detail/5662899036618752</a></p>
<p>&lt;details&gt;<br>
&lt;summary&gt;Test case input&lt;/summary&gt;</p>
<p>&lt;!-- Please base64-encode the input that libFuzzer generated, and paste it in the code-block below. This is required for us to reproduce the issue. --&gt;</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="n">YWlzY3RuIG8BXQAAe</span><span class="o">/</span><span class="n">HfLJGaiKD4</span><span class="o">/</span><span class="n">wAA6bZjQHhAcB7</span><span class="c1">//wAHAAAA6bYgJgAB6fgAAAABAABK//8A</span>
<span class="n">ABgAAAD</span><span class="c1">/////f///////////////////////////////////////////////////////////////</span>
<span class="c1">/////////////////ydV1sbWP9aCKgKCtgoFAGUAAAAAAAAAm/4p2gFG8J19fQAAAAAAAAAAAAAA</span>
<span class="n">AAAAAAAAAAAAAAAAAABlAWzzxkbacCrdpP</span><span class="c1">//AAAAAAD6/wBDQ0P///////////////////////8A</span>
<span class="n">ZcYNRyYxRvSWnfAyAAAAADsgAakAfX0AAP</span><span class="o">+</span><span class="n">udf8AAA8AAAAAAPr</span><span class="o">/</span><span class="n">AENDQ0NDm5ubm5ubm5ubm5ub</span><span class="w"></span>
<span class="n">m5ubm5ubm5ubm5ubfX3zfZubfQ</span><span class="o">==</span><span class="w"></span>
</code></pre></div>
<p>&lt;/details&gt;</p>
<p>I've minimized this to the following CLIF test:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="n">test</span><span class="w"> </span><span class="n">interpret</span><span class="w"></span>
<span class="n">test</span><span class="w"> </span><span class="n">run</span><span class="w"></span>
<span class="n">target</span><span class="w"> </span><span class="n">aarch64</span><span class="w"></span>
<span class="n">target</span><span class="w"> </span><span class="n">s390x</span><span class="w"></span>
<span class="n">target</span><span class="w"> </span><span class="n">x86_64</span><span class="w"></span>

<span class="n">function</span><span class="w"> </span><span class="o">%</span><span class="k">fn</span><span class="p">(</span><span class="kt">f64</span><span class="w"> </span><span class="n">uext</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nc">b1</span><span class="w"> </span><span class="n">system_v</span><span class="w"> </span><span class="p">{</span><span class="w"></span>

<span class="n">block0</span><span class="p">(</span><span class="n">v3</span>: <span class="kt">f64</span><span class="p">)</span>:
    <span class="nc">v78</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">fcmp</span><span class="w"> </span><span class="n">le</span><span class="w"> </span><span class="n">v3</span><span class="p">,</span><span class="w"> </span><span class="n">v3</span><span class="w"></span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">v78</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="p">;</span><span class="w"> </span><span class="n">run</span>: <span class="o">%</span><span class="k">fn</span><span class="p">(</span><span class="o">-</span><span class="n">NaN</span>:<span class="mh">0x7ffffffffffff</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="kc">false</span><span class="w"></span>
</code></pre></div>
<p>On x86-64, this call returns <code>false</code>; but on the interpreter it returns <code>true</code>. Those two implementations have disagreed at least back to June, so this doesn't seem to be due to any recent changes.</p>
<p>I wasn't sure what the "right" answer is here so I wrote a quick wasm program for which wasmtime generates this CLIF instruction.</p>
<p>&lt;details&gt;<br>
&lt;summary&gt;Equivalent wasm&lt;/summary&gt;</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="p">(</span><span class="n">module</span><span class="w"></span>
<span class="w">  </span><span class="p">(</span><span class="n">func</span><span class="w"> </span><span class="cp">$fn</span><span class="w"> </span><span class="p">(</span><span class="n">param</span><span class="w"> </span><span class="kt">f64</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="n">local</span><span class="p">.</span><span class="n">get</span><span class="w"> </span><span class="mi">0</span><span class="w"></span>
<span class="w">    </span><span class="n">local</span><span class="p">.</span><span class="n">get</span><span class="w"> </span><span class="mi">0</span><span class="w"></span>
<span class="w">    </span><span class="kt">f64</span><span class="p">.</span><span class="n">le</span><span class="w"></span>
<span class="w">    </span><span class="k">if</span><span class="w"></span>
<span class="w">      </span><span class="n">unreachable</span><span class="w"></span>
<span class="w">    </span><span class="n">end</span><span class="w"></span>
<span class="w">  </span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="p">(</span><span class="n">func</span><span class="w"> </span><span class="cp">$test</span><span class="w"></span>
<span class="w">    </span><span class="kt">f64</span><span class="p">.</span><span class="k">const</span><span class="w"> </span><span class="o">-</span><span class="n">nan</span>:<span class="mh">0x7ffffffffffff</span><span class="w"></span>
<span class="w">    </span><span class="n">call</span><span class="w"> </span><span class="cp">$fn</span><span class="w"></span>
<span class="w">  </span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="p">(</span><span class="n">export</span><span class="w"> </span><span class="s">"test"</span><span class="w"> </span><span class="p">(</span><span class="n">func</span><span class="w"> </span><span class="cp">$test</span><span class="p">))</span><span class="w"></span>
<span class="p">)</span><span class="w"></span>
</code></pre></div>
<p>&lt;/details&gt;</p>
<p>This program doesn't trap either on wasmtime compiling for x86-64, or on wabt's wasm-interp, so I gather the Cranelift interpreter is the one giving the wrong answer here.</p>
<p>@afonso360, can you look into this?</p>
<p>I guess we should extend <code>cranelift/filetests/filetests/runtests/fcmp.clif</code> with NaN tests, and also start running that test file on the interpreter.</p>
</blockquote>



<a name="296242066"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%234828%20cranelift-fuzzgen%20fuzzbug%3A%20fcmp%20gi.../near/296242066" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.234828.20cranelift-fuzzgen.20fuzzbug.3A.20fcmp.20gi.2E.2E.2E.html#296242066">(Aug 31 2022 at 00:53)</a>:</h4>
<p>jameysharp labeled <a href="https://github.com/bytecodealliance/wasmtime/issues/4828">issue #4828</a>:</p>
<blockquote>
<p>Original report: <a href="https://oss-fuzz.com/testcase-detail/5662899036618752">https://oss-fuzz.com/testcase-detail/5662899036618752</a></p>
<p>&lt;details&gt;<br>
&lt;summary&gt;Test case input&lt;/summary&gt;</p>
<p>&lt;!-- Please base64-encode the input that libFuzzer generated, and paste it in the code-block below. This is required for us to reproduce the issue. --&gt;</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="n">YWlzY3RuIG8BXQAAe</span><span class="o">/</span><span class="n">HfLJGaiKD4</span><span class="o">/</span><span class="n">wAA6bZjQHhAcB7</span><span class="c1">//wAHAAAA6bYgJgAB6fgAAAABAABK//8A</span>
<span class="n">ABgAAAD</span><span class="c1">/////f///////////////////////////////////////////////////////////////</span>
<span class="c1">/////////////////ydV1sbWP9aCKgKCtgoFAGUAAAAAAAAAm/4p2gFG8J19fQAAAAAAAAAAAAAA</span>
<span class="n">AAAAAAAAAAAAAAAAAABlAWzzxkbacCrdpP</span><span class="c1">//AAAAAAD6/wBDQ0P///////////////////////8A</span>
<span class="n">ZcYNRyYxRvSWnfAyAAAAADsgAakAfX0AAP</span><span class="o">+</span><span class="n">udf8AAA8AAAAAAPr</span><span class="o">/</span><span class="n">AENDQ0NDm5ubm5ubm5ubm5ub</span><span class="w"></span>
<span class="n">m5ubm5ubm5ubm5ubfX3zfZubfQ</span><span class="o">==</span><span class="w"></span>
</code></pre></div>
<p>&lt;/details&gt;</p>
<p>I've minimized this to the following CLIF test:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="n">test</span><span class="w"> </span><span class="n">interpret</span><span class="w"></span>
<span class="n">test</span><span class="w"> </span><span class="n">run</span><span class="w"></span>
<span class="n">target</span><span class="w"> </span><span class="n">aarch64</span><span class="w"></span>
<span class="n">target</span><span class="w"> </span><span class="n">s390x</span><span class="w"></span>
<span class="n">target</span><span class="w"> </span><span class="n">x86_64</span><span class="w"></span>

<span class="n">function</span><span class="w"> </span><span class="o">%</span><span class="k">fn</span><span class="p">(</span><span class="kt">f64</span><span class="w"> </span><span class="n">uext</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nc">b1</span><span class="w"> </span><span class="n">system_v</span><span class="w"> </span><span class="p">{</span><span class="w"></span>

<span class="n">block0</span><span class="p">(</span><span class="n">v3</span>: <span class="kt">f64</span><span class="p">)</span>:
    <span class="nc">v78</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">fcmp</span><span class="w"> </span><span class="n">le</span><span class="w"> </span><span class="n">v3</span><span class="p">,</span><span class="w"> </span><span class="n">v3</span><span class="w"></span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">v78</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="p">;</span><span class="w"> </span><span class="n">run</span>: <span class="o">%</span><span class="k">fn</span><span class="p">(</span><span class="o">-</span><span class="n">NaN</span>:<span class="mh">0x7ffffffffffff</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="kc">false</span><span class="w"></span>
</code></pre></div>
<p>On x86-64, this call returns <code>false</code>; but on the interpreter it returns <code>true</code>. Those two implementations have disagreed at least back to June, so this doesn't seem to be due to any recent changes.</p>
<p>I wasn't sure what the "right" answer is here so I wrote a quick wasm program for which wasmtime generates this CLIF instruction.</p>
<p>&lt;details&gt;<br>
&lt;summary&gt;Equivalent wasm&lt;/summary&gt;</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="p">(</span><span class="n">module</span><span class="w"></span>
<span class="w">  </span><span class="p">(</span><span class="n">func</span><span class="w"> </span><span class="cp">$fn</span><span class="w"> </span><span class="p">(</span><span class="n">param</span><span class="w"> </span><span class="kt">f64</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="n">local</span><span class="p">.</span><span class="n">get</span><span class="w"> </span><span class="mi">0</span><span class="w"></span>
<span class="w">    </span><span class="n">local</span><span class="p">.</span><span class="n">get</span><span class="w"> </span><span class="mi">0</span><span class="w"></span>
<span class="w">    </span><span class="kt">f64</span><span class="p">.</span><span class="n">le</span><span class="w"></span>
<span class="w">    </span><span class="k">if</span><span class="w"></span>
<span class="w">      </span><span class="n">unreachable</span><span class="w"></span>
<span class="w">    </span><span class="n">end</span><span class="w"></span>
<span class="w">  </span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="p">(</span><span class="n">func</span><span class="w"> </span><span class="cp">$test</span><span class="w"></span>
<span class="w">    </span><span class="kt">f64</span><span class="p">.</span><span class="k">const</span><span class="w"> </span><span class="o">-</span><span class="n">nan</span>:<span class="mh">0x7ffffffffffff</span><span class="w"></span>
<span class="w">    </span><span class="n">call</span><span class="w"> </span><span class="cp">$fn</span><span class="w"></span>
<span class="w">  </span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="p">(</span><span class="n">export</span><span class="w"> </span><span class="s">"test"</span><span class="w"> </span><span class="p">(</span><span class="n">func</span><span class="w"> </span><span class="cp">$test</span><span class="p">))</span><span class="w"></span>
<span class="p">)</span><span class="w"></span>
</code></pre></div>
<p>&lt;/details&gt;</p>
<p>This program doesn't trap either on wasmtime compiling for x86-64, or on wabt's wasm-interp, so I gather the Cranelift interpreter is the one giving the wrong answer here.</p>
<p>@afonso360, can you look into this?</p>
<p>I guess we should extend <code>cranelift/filetests/filetests/runtests/fcmp.clif</code> with NaN tests, and also start running that test file on the interpreter.</p>
</blockquote>



<a name="296403317"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%234828%20cranelift-fuzzgen%20fuzzbug%3A%20fcmp%20gi.../near/296403317" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.234828.20cranelift-fuzzgen.20fuzzbug.3A.20fcmp.20gi.2E.2E.2E.html#296403317">(Aug 31 2022 at 16:36)</a>:</h4>
<p>akirilov-arm <a href="https://github.com/bytecodealliance/wasmtime/issues/4828#issuecomment-1233169620">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/4828">issue #4828</a>:</p>
<blockquote>
<p>AFAIK all comparisons involving a NaN (including those when both operands are NaNs) should return false, except for inequality.</p>
</blockquote>



<a name="296405013"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%234828%20cranelift-fuzzgen%20fuzzbug%3A%20fcmp%20gi.../near/296405013" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.234828.20cranelift-fuzzgen.20fuzzbug.3A.20fcmp.20gi.2E.2E.2E.html#296405013">(Aug 31 2022 at 16:45)</a>:</h4>
<p>afonso360 <a href="https://github.com/bytecodealliance/wasmtime/issues/4828#issuecomment-1233178264">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/4828">issue #4828</a>:</p>
<blockquote>
<p>That is true for the regular comparisons, however there are some <code>FloatCC::Unordered*</code> that invert that and always return true on NaN's.</p>
</blockquote>



<a name="296405677"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%234828%20cranelift-fuzzgen%20fuzzbug%3A%20fcmp%20gi.../near/296405677" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.234828.20cranelift-fuzzgen.20fuzzbug.3A.20fcmp.20gi.2E.2E.2E.html#296405677">(Aug 31 2022 at 16:49)</a>:</h4>
<p>afonso360 edited a <a href="https://github.com/bytecodealliance/wasmtime/issues/4828#issuecomment-1233178264">comment</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/4828">issue #4828</a>:</p>
<blockquote>
<p>That is true for the regular comparisons, however there are some <code>FloatCC::Unordered*</code> that invert that and always return true on NaN's. That isn't the case here, this is a Ordered comparison, so we should be returning false as jamey mentions.</p>
</blockquote>



<a name="296405725"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%234828%20cranelift-fuzzgen%20fuzzbug%3A%20fcmp%20gi.../near/296405725" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.234828.20cranelift-fuzzgen.20fuzzbug.3A.20fcmp.20gi.2E.2E.2E.html#296405725">(Aug 31 2022 at 16:49)</a>:</h4>
<p>afonso360 edited a <a href="https://github.com/bytecodealliance/wasmtime/issues/4828#issuecomment-1233178264">comment</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/4828">issue #4828</a>:</p>
<blockquote>
<p>That is true for the regular comparisons, however there are some <code>FloatCC::Unordered*</code> that invert that and always return true on NaN's. That isn't the case here, this is a Ordered comparison, so we should be returning <code>false</code> as jamey mentions.</p>
</blockquote>



<a name="296405867"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%234828%20cranelift-fuzzgen%20fuzzbug%3A%20fcmp%20gi.../near/296405867" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.234828.20cranelift-fuzzgen.20fuzzbug.3A.20fcmp.20gi.2E.2E.2E.html#296405867">(Aug 31 2022 at 16:50)</a>:</h4>
<p>afonso360 edited a <a href="https://github.com/bytecodealliance/wasmtime/issues/4828#issuecomment-1233178264">comment</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/4828">issue #4828</a>:</p>
<blockquote>
<p>That is true for the regular comparisons, however there are some <code>FloatCC::Unordered*</code> that invert that and always return true on NaN's. That isn't the case here, this is a Ordered comparison, so we should be returning <code>false</code> as jameysharp mentions.</p>
</blockquote>



<a name="296847066"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%234828%20cranelift-fuzzgen%20fuzzbug%3A%20fcmp%20gi.../near/296847066" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.234828.20cranelift-fuzzgen.20fuzzbug.3A.20fcmp.20gi.2E.2E.2E.html#296847066">(Sep 02 2022 at 15:47)</a>:</h4>
<p>akirilov-arm labeled <a href="https://github.com/bytecodealliance/wasmtime/issues/4828">issue #4828</a>:</p>
<blockquote>
<p>Original report: <a href="https://oss-fuzz.com/testcase-detail/5662899036618752">https://oss-fuzz.com/testcase-detail/5662899036618752</a></p>
<p>&lt;details&gt;<br>
&lt;summary&gt;Test case input&lt;/summary&gt;</p>
<p>&lt;!-- Please base64-encode the input that libFuzzer generated, and paste it in the code-block below. This is required for us to reproduce the issue. --&gt;</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="n">YWlzY3RuIG8BXQAAe</span><span class="o">/</span><span class="n">HfLJGaiKD4</span><span class="o">/</span><span class="n">wAA6bZjQHhAcB7</span><span class="c1">//wAHAAAA6bYgJgAB6fgAAAABAABK//8A</span>
<span class="n">ABgAAAD</span><span class="c1">/////f///////////////////////////////////////////////////////////////</span>
<span class="c1">/////////////////ydV1sbWP9aCKgKCtgoFAGUAAAAAAAAAm/4p2gFG8J19fQAAAAAAAAAAAAAA</span>
<span class="n">AAAAAAAAAAAAAAAAAABlAWzzxkbacCrdpP</span><span class="c1">//AAAAAAD6/wBDQ0P///////////////////////8A</span>
<span class="n">ZcYNRyYxRvSWnfAyAAAAADsgAakAfX0AAP</span><span class="o">+</span><span class="n">udf8AAA8AAAAAAPr</span><span class="o">/</span><span class="n">AENDQ0NDm5ubm5ubm5ubm5ub</span><span class="w"></span>
<span class="n">m5ubm5ubm5ubm5ubfX3zfZubfQ</span><span class="o">==</span><span class="w"></span>
</code></pre></div>
<p>&lt;/details&gt;</p>
<p>I've minimized this to the following CLIF test:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="n">test</span><span class="w"> </span><span class="n">interpret</span><span class="w"></span>
<span class="n">test</span><span class="w"> </span><span class="n">run</span><span class="w"></span>
<span class="n">target</span><span class="w"> </span><span class="n">aarch64</span><span class="w"></span>
<span class="n">target</span><span class="w"> </span><span class="n">s390x</span><span class="w"></span>
<span class="n">target</span><span class="w"> </span><span class="n">x86_64</span><span class="w"></span>

<span class="n">function</span><span class="w"> </span><span class="o">%</span><span class="k">fn</span><span class="p">(</span><span class="kt">f64</span><span class="w"> </span><span class="n">uext</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nc">b1</span><span class="w"> </span><span class="n">system_v</span><span class="w"> </span><span class="p">{</span><span class="w"></span>

<span class="n">block0</span><span class="p">(</span><span class="n">v3</span>: <span class="kt">f64</span><span class="p">)</span>:
    <span class="nc">v78</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">fcmp</span><span class="w"> </span><span class="n">le</span><span class="w"> </span><span class="n">v3</span><span class="p">,</span><span class="w"> </span><span class="n">v3</span><span class="w"></span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">v78</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="p">;</span><span class="w"> </span><span class="n">run</span>: <span class="o">%</span><span class="k">fn</span><span class="p">(</span><span class="o">-</span><span class="n">NaN</span>:<span class="mh">0x7ffffffffffff</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="kc">false</span><span class="w"></span>
</code></pre></div>
<p>On x86-64, this call returns <code>false</code>; but on the interpreter it returns <code>true</code>. Those two implementations have disagreed at least back to June, so this doesn't seem to be due to any recent changes.</p>
<p>I wasn't sure what the "right" answer is here so I wrote a quick wasm program for which wasmtime generates this CLIF instruction.</p>
<p>&lt;details&gt;<br>
&lt;summary&gt;Equivalent wasm&lt;/summary&gt;</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="p">(</span><span class="n">module</span><span class="w"></span>
<span class="w">  </span><span class="p">(</span><span class="n">func</span><span class="w"> </span><span class="cp">$fn</span><span class="w"> </span><span class="p">(</span><span class="n">param</span><span class="w"> </span><span class="kt">f64</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="n">local</span><span class="p">.</span><span class="n">get</span><span class="w"> </span><span class="mi">0</span><span class="w"></span>
<span class="w">    </span><span class="n">local</span><span class="p">.</span><span class="n">get</span><span class="w"> </span><span class="mi">0</span><span class="w"></span>
<span class="w">    </span><span class="kt">f64</span><span class="p">.</span><span class="n">le</span><span class="w"></span>
<span class="w">    </span><span class="k">if</span><span class="w"></span>
<span class="w">      </span><span class="n">unreachable</span><span class="w"></span>
<span class="w">    </span><span class="n">end</span><span class="w"></span>
<span class="w">  </span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="p">(</span><span class="n">func</span><span class="w"> </span><span class="cp">$test</span><span class="w"></span>
<span class="w">    </span><span class="kt">f64</span><span class="p">.</span><span class="k">const</span><span class="w"> </span><span class="o">-</span><span class="n">nan</span>:<span class="mh">0x7ffffffffffff</span><span class="w"></span>
<span class="w">    </span><span class="n">call</span><span class="w"> </span><span class="cp">$fn</span><span class="w"></span>
<span class="w">  </span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="p">(</span><span class="n">export</span><span class="w"> </span><span class="s">"test"</span><span class="w"> </span><span class="p">(</span><span class="n">func</span><span class="w"> </span><span class="cp">$test</span><span class="p">))</span><span class="w"></span>
<span class="p">)</span><span class="w"></span>
</code></pre></div>
<p>&lt;/details&gt;</p>
<p>This program doesn't trap either on wasmtime compiling for x86-64, or on wabt's wasm-interp, so I gather the Cranelift interpreter is the one giving the wrong answer here.</p>
<p>@afonso360, can you look into this?</p>
<p>I guess we should extend <code>cranelift/filetests/filetests/runtests/fcmp.clif</code> with NaN tests, and also start running that test file on the interpreter.</p>
</blockquote>



<a name="296867172"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%234828%20cranelift-fuzzgen%20fuzzbug%3A%20fcmp%20gi.../near/296867172" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.234828.20cranelift-fuzzgen.20fuzzbug.3A.20fcmp.20gi.2E.2E.2E.html#296867172">(Sep 02 2022 at 17:42)</a>:</h4>
<p>jameysharp closed <a href="https://github.com/bytecodealliance/wasmtime/issues/4828">issue #4828</a>:</p>
<blockquote>
<p>Original report: <a href="https://oss-fuzz.com/testcase-detail/5662899036618752">https://oss-fuzz.com/testcase-detail/5662899036618752</a></p>
<p>&lt;details&gt;<br>
&lt;summary&gt;Test case input&lt;/summary&gt;</p>
<p>&lt;!-- Please base64-encode the input that libFuzzer generated, and paste it in the code-block below. This is required for us to reproduce the issue. --&gt;</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="n">YWlzY3RuIG8BXQAAe</span><span class="o">/</span><span class="n">HfLJGaiKD4</span><span class="o">/</span><span class="n">wAA6bZjQHhAcB7</span><span class="c1">//wAHAAAA6bYgJgAB6fgAAAABAABK//8A</span>
<span class="n">ABgAAAD</span><span class="c1">/////f///////////////////////////////////////////////////////////////</span>
<span class="c1">/////////////////ydV1sbWP9aCKgKCtgoFAGUAAAAAAAAAm/4p2gFG8J19fQAAAAAAAAAAAAAA</span>
<span class="n">AAAAAAAAAAAAAAAAAABlAWzzxkbacCrdpP</span><span class="c1">//AAAAAAD6/wBDQ0P///////////////////////8A</span>
<span class="n">ZcYNRyYxRvSWnfAyAAAAADsgAakAfX0AAP</span><span class="o">+</span><span class="n">udf8AAA8AAAAAAPr</span><span class="o">/</span><span class="n">AENDQ0NDm5ubm5ubm5ubm5ub</span><span class="w"></span>
<span class="n">m5ubm5ubm5ubm5ubfX3zfZubfQ</span><span class="o">==</span><span class="w"></span>
</code></pre></div>
<p>&lt;/details&gt;</p>
<p>I've minimized this to the following CLIF test:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="n">test</span><span class="w"> </span><span class="n">interpret</span><span class="w"></span>
<span class="n">test</span><span class="w"> </span><span class="n">run</span><span class="w"></span>
<span class="n">target</span><span class="w"> </span><span class="n">aarch64</span><span class="w"></span>
<span class="n">target</span><span class="w"> </span><span class="n">s390x</span><span class="w"></span>
<span class="n">target</span><span class="w"> </span><span class="n">x86_64</span><span class="w"></span>

<span class="n">function</span><span class="w"> </span><span class="o">%</span><span class="k">fn</span><span class="p">(</span><span class="kt">f64</span><span class="w"> </span><span class="n">uext</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nc">b1</span><span class="w"> </span><span class="n">system_v</span><span class="w"> </span><span class="p">{</span><span class="w"></span>

<span class="n">block0</span><span class="p">(</span><span class="n">v3</span>: <span class="kt">f64</span><span class="p">)</span>:
    <span class="nc">v78</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">fcmp</span><span class="w"> </span><span class="n">le</span><span class="w"> </span><span class="n">v3</span><span class="p">,</span><span class="w"> </span><span class="n">v3</span><span class="w"></span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">v78</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="p">;</span><span class="w"> </span><span class="n">run</span>: <span class="o">%</span><span class="k">fn</span><span class="p">(</span><span class="o">-</span><span class="n">NaN</span>:<span class="mh">0x7ffffffffffff</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="kc">false</span><span class="w"></span>
</code></pre></div>
<p>On x86-64, this call returns <code>false</code>; but on the interpreter it returns <code>true</code>. Those two implementations have disagreed at least back to June, so this doesn't seem to be due to any recent changes.</p>
<p>I wasn't sure what the "right" answer is here so I wrote a quick wasm program for which wasmtime generates this CLIF instruction.</p>
<p>&lt;details&gt;<br>
&lt;summary&gt;Equivalent wasm&lt;/summary&gt;</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="p">(</span><span class="n">module</span><span class="w"></span>
<span class="w">  </span><span class="p">(</span><span class="n">func</span><span class="w"> </span><span class="cp">$fn</span><span class="w"> </span><span class="p">(</span><span class="n">param</span><span class="w"> </span><span class="kt">f64</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="n">local</span><span class="p">.</span><span class="n">get</span><span class="w"> </span><span class="mi">0</span><span class="w"></span>
<span class="w">    </span><span class="n">local</span><span class="p">.</span><span class="n">get</span><span class="w"> </span><span class="mi">0</span><span class="w"></span>
<span class="w">    </span><span class="kt">f64</span><span class="p">.</span><span class="n">le</span><span class="w"></span>
<span class="w">    </span><span class="k">if</span><span class="w"></span>
<span class="w">      </span><span class="n">unreachable</span><span class="w"></span>
<span class="w">    </span><span class="n">end</span><span class="w"></span>
<span class="w">  </span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="p">(</span><span class="n">func</span><span class="w"> </span><span class="cp">$test</span><span class="w"></span>
<span class="w">    </span><span class="kt">f64</span><span class="p">.</span><span class="k">const</span><span class="w"> </span><span class="o">-</span><span class="n">nan</span>:<span class="mh">0x7ffffffffffff</span><span class="w"></span>
<span class="w">    </span><span class="n">call</span><span class="w"> </span><span class="cp">$fn</span><span class="w"></span>
<span class="w">  </span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="p">(</span><span class="n">export</span><span class="w"> </span><span class="s">"test"</span><span class="w"> </span><span class="p">(</span><span class="n">func</span><span class="w"> </span><span class="cp">$test</span><span class="p">))</span><span class="w"></span>
<span class="p">)</span><span class="w"></span>
</code></pre></div>
<p>&lt;/details&gt;</p>
<p>This program doesn't trap either on wasmtime compiling for x86-64, or on wabt's wasm-interp, so I gather the Cranelift interpreter is the one giving the wrong answer here.</p>
<p>@afonso360, can you look into this?</p>
<p>I guess we should extend <code>cranelift/filetests/filetests/runtests/fcmp.clif</code> with NaN tests, and also start running that test file on the interpreter.</p>
</blockquote>



<hr><p>Last updated: Jan 20 2025 at 06:04 UTC</p>
</html>