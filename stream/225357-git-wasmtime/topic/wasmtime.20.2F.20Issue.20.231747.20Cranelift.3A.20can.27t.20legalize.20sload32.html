<html>
<head><meta charset="utf-8"><title>wasmtime / Issue #1747 Cranelift: can&#x27;t legalize sload32 · git-wasmtime · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/index.html">git-wasmtime</a></h2>
<h3>Topic: <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20Issue.20.231747.20Cranelift.3A.20can.27t.20legalize.20sload32.html">wasmtime / Issue #1747 Cranelift: can&#x27;t legalize sload32</a></h3>

<hr>

<base href="https://bytecodealliance.zulipchat.com">

<head><link href="https://bytecodealliance.github.io/zulip-archive/style.css" rel="stylesheet"></head>

<a name="198430760"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20Issue%20%231747%20Cranelift%3A%20can%27t%20legalize%20sload32/near/198430760" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20Issue.20.231747.20Cranelift.3A.20can.27t.20legalize.20sload32.html#198430760">(May 22 2020 at 11:26)</a>:</h4>
<p>whitequark opened <a href="https://github.com/bytecodealliance/wasmtime/issues/1747">Issue #1747</a>:</p>
<blockquote>
<p>I've minimized a test case that currently fails on 32-bit platforms:</p>
<div class="codehilite"><pre><span></span><code>target i686

function u0:1516(i32) -&gt; i32 system_v {
block0(v0: i32):
    v1 = load.i32 notrap aligned readonly v0
    ;v2 = load.i32 v1
    ;v3 = sextend.i64 v2
    v3 = sload32 v1
    v4, v5 = isplit v3
    return v4
}
</code></pre></div>


<p>I've tried writing a legalizer for it that would produce the commented instructions but it doesn't do anything (same lack of result for expand, widen, narrow). What gives?</p>
<div class="codehilite"><pre><span></span><code><span class="gd">--- a/cranelift/codegen/meta/src/shared/legalize.rs</span>
<span class="gi">+++ b/cranelift/codegen/meta/src/shared/legalize.rs</span>
<span class="gu">@@ -107,6 +107,7 @@ pub(crate) fn define(insts: &amp;InstructionGroup, imm: &amp;Immediates) -&gt; TransformGro</span>
     let sdiv_imm = insts.by_name(&quot;sdiv_imm&quot;);
     let select = insts.by_name(&quot;select&quot;);
     let sextend = insts.by_name(&quot;sextend&quot;);

<span class="gi">+    let sload32 = insts.by_name(&quot;sload32&quot;);</span>
     let sshr = insts.by_name(&quot;sshr&quot;);
     let sshr_imm = insts.by_name(&quot;sshr_imm&quot;);
     let srem = insts.by_name(&quot;srem&quot;);
<span class="gu">@@ -213,6 +214,14 @@ pub(crate) fn define(insts: &amp;InstructionGroup, imm: &amp;Immediates) -&gt; TransformGro</span>
     // embedded as part of arguments), so use a custom legalization for now.
     narrow.custom_legalize(iconst, &quot;narrow_iconst&quot;);


<span class="gi">+    expand.legalize(</span>
<span class="gi">+        def!(a = sload32.I64(flags, ptr, offset)),</span>
<span class="gi">+        vec![</span>
<span class="gi">+            def!(b = load.I32(flags, ptr, offset)),</span>
<span class="gi">+            def!(a = sextend.I64(b)),</span>
<span class="gi">+        ]</span>
<span class="gi">+    );</span>
<span class="gi">+</span>
     for &amp;(ty, ty_half) in &amp;[(I128, I64), (I64, I32)] {
         let inst = uextend.bind(ty).bind(ty_half);
         narrow.legalize(
</code></pre></div>


</blockquote>



<a name="198430761"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20Issue%20%231747%20Cranelift%3A%20can%27t%20legalize%20sload32/near/198430761" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20Issue.20.231747.20Cranelift.3A.20can.27t.20legalize.20sload32.html#198430761">(May 22 2020 at 11:26)</a>:</h4>
<p>whitequark labeled <a href="https://github.com/bytecodealliance/wasmtime/issues/1747">Issue #1747</a>:</p>
<blockquote>
<p>I've minimized a test case that currently fails on 32-bit platforms:</p>
<div class="codehilite"><pre><span></span><code>target i686

function u0:1516(i32) -&gt; i32 system_v {
block0(v0: i32):
    v1 = load.i32 notrap aligned readonly v0
    ;v2 = load.i32 v1
    ;v3 = sextend.i64 v2
    v3 = sload32 v1
    v4, v5 = isplit v3
    return v4
}
</code></pre></div>


<p>I've tried writing a legalizer for it that would produce the commented instructions but it doesn't do anything (same lack of result for expand, widen, narrow). What gives?</p>
<div class="codehilite"><pre><span></span><code><span class="gd">--- a/cranelift/codegen/meta/src/shared/legalize.rs</span>
<span class="gi">+++ b/cranelift/codegen/meta/src/shared/legalize.rs</span>
<span class="gu">@@ -107,6 +107,7 @@ pub(crate) fn define(insts: &amp;InstructionGroup, imm: &amp;Immediates) -&gt; TransformGro</span>
     let sdiv_imm = insts.by_name(&quot;sdiv_imm&quot;);
     let select = insts.by_name(&quot;select&quot;);
     let sextend = insts.by_name(&quot;sextend&quot;);

<span class="gi">+    let sload32 = insts.by_name(&quot;sload32&quot;);</span>
     let sshr = insts.by_name(&quot;sshr&quot;);
     let sshr_imm = insts.by_name(&quot;sshr_imm&quot;);
     let srem = insts.by_name(&quot;srem&quot;);
<span class="gu">@@ -213,6 +214,14 @@ pub(crate) fn define(insts: &amp;InstructionGroup, imm: &amp;Immediates) -&gt; TransformGro</span>
     // embedded as part of arguments), so use a custom legalization for now.
     narrow.custom_legalize(iconst, &quot;narrow_iconst&quot;);


<span class="gi">+    expand.legalize(</span>
<span class="gi">+        def!(a = sload32.I64(flags, ptr, offset)),</span>
<span class="gi">+        vec![</span>
<span class="gi">+            def!(b = load.I32(flags, ptr, offset)),</span>
<span class="gi">+            def!(a = sextend.I64(b)),</span>
<span class="gi">+        ]</span>
<span class="gi">+    );</span>
<span class="gi">+</span>
     for &amp;(ty, ty_half) in &amp;[(I128, I64), (I64, I32)] {
         let inst = uextend.bind(ty).bind(ty_half);
         narrow.legalize(
</code></pre></div>


</blockquote>



<a name="198430762"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20Issue%20%231747%20Cranelift%3A%20can%27t%20legalize%20sload32/near/198430762" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20Issue.20.231747.20Cranelift.3A.20can.27t.20legalize.20sload32.html#198430762">(May 22 2020 at 11:26)</a>:</h4>
<p>whitequark labeled <a href="https://github.com/bytecodealliance/wasmtime/issues/1747">Issue #1747</a>:</p>
<blockquote>
<p>I've minimized a test case that currently fails on 32-bit platforms:</p>
<div class="codehilite"><pre><span></span><code>target i686

function u0:1516(i32) -&gt; i32 system_v {
block0(v0: i32):
    v1 = load.i32 notrap aligned readonly v0
    ;v2 = load.i32 v1
    ;v3 = sextend.i64 v2
    v3 = sload32 v1
    v4, v5 = isplit v3
    return v4
}
</code></pre></div>


<p>I've tried writing a legalizer for it that would produce the commented instructions but it doesn't do anything (same lack of result for expand, widen, narrow). What gives?</p>
<div class="codehilite"><pre><span></span><code><span class="gd">--- a/cranelift/codegen/meta/src/shared/legalize.rs</span>
<span class="gi">+++ b/cranelift/codegen/meta/src/shared/legalize.rs</span>
<span class="gu">@@ -107,6 +107,7 @@ pub(crate) fn define(insts: &amp;InstructionGroup, imm: &amp;Immediates) -&gt; TransformGro</span>
     let sdiv_imm = insts.by_name(&quot;sdiv_imm&quot;);
     let select = insts.by_name(&quot;select&quot;);
     let sextend = insts.by_name(&quot;sextend&quot;);

<span class="gi">+    let sload32 = insts.by_name(&quot;sload32&quot;);</span>
     let sshr = insts.by_name(&quot;sshr&quot;);
     let sshr_imm = insts.by_name(&quot;sshr_imm&quot;);
     let srem = insts.by_name(&quot;srem&quot;);
<span class="gu">@@ -213,6 +214,14 @@ pub(crate) fn define(insts: &amp;InstructionGroup, imm: &amp;Immediates) -&gt; TransformGro</span>
     // embedded as part of arguments), so use a custom legalization for now.
     narrow.custom_legalize(iconst, &quot;narrow_iconst&quot;);


<span class="gi">+    expand.legalize(</span>
<span class="gi">+        def!(a = sload32.I64(flags, ptr, offset)),</span>
<span class="gi">+        vec![</span>
<span class="gi">+            def!(b = load.I32(flags, ptr, offset)),</span>
<span class="gi">+            def!(a = sextend.I64(b)),</span>
<span class="gi">+        ]</span>
<span class="gi">+    );</span>
<span class="gi">+</span>
     for &amp;(ty, ty_half) in &amp;[(I128, I64), (I64, I32)] {
         let inst = uextend.bind(ty).bind(ty_half);
         narrow.legalize(
</code></pre></div>


</blockquote>



<a name="198430772"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20Issue%20%231747%20Cranelift%3A%20can%27t%20legalize%20sload32/near/198430772" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20Issue.20.231747.20Cranelift.3A.20can.27t.20legalize.20sload32.html#198430772">(May 22 2020 at 11:26)</a>:</h4>
<p>github-actions[bot] <a href="https://github.com/bytecodealliance/wasmtime/issues/1747#issuecomment-632643228">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/1747">Issue #1747</a>:</p>
<blockquote>
<h4>Subscribe to Label Action</h4>
<p>cc @bnjbvr</p>
<p>&lt;details&gt;<br>
This issue or pull request has been labeled: "cranelift"</p>
<p>Thus the following users have been cc'd because of the following labels:</p>
<ul>
<li>bnjbvr: cranelift</li>
</ul>
<p>To subscribe or unsubscribe from this label, edit the &lt;code&gt;.github/subscribe-to-label.json&lt;/code&gt; configuration file.</p>
<p><a href="https://github.com/bytecodealliance/subscribe-to-label-action">Learn more.</a><br>
&lt;/details&gt;</p>
</blockquote>



<a name="198430896"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20Issue%20%231747%20Cranelift%3A%20can%27t%20legalize%20sload32/near/198430896" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20Issue.20.231747.20Cranelift.3A.20can.27t.20legalize.20sload32.html#198430896">(May 22 2020 at 11:28)</a>:</h4>
<p>whitequark <a href="https://github.com/bytecodealliance/wasmtime/issues/1747#issuecomment-632643767">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/1747">Issue #1747</a>:</p>
<blockquote>
<p>cc @iximeow perhaps?</p>
</blockquote>



<a name="198431582"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20Issue%20%231747%20Cranelift%3A%20can%27t%20legalize%20sload32/near/198431582" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20Issue.20.231747.20Cranelift.3A.20can.27t.20legalize.20sload32.html#198431582">(May 22 2020 at 11:37)</a>:</h4>
<p>bjorn3 <a href="https://github.com/bytecodealliance/wasmtime/issues/1747#issuecomment-632647617">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/1747">Issue #1747</a>:</p>
<blockquote>
<p>It should probably be in <code>narrow</code>. <code>narrow</code> is used for types bigger than the native pointer size:</p>
</blockquote>



<a name="198431630"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20Issue%20%231747%20Cranelift%3A%20can%27t%20legalize%20sload32/near/198431630" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20Issue.20.231747.20Cranelift.3A.20can.27t.20legalize.20sload32.html#198431630">(May 22 2020 at 11:38)</a>:</h4>
<p>bjorn3 edited a <a href="https://github.com/bytecodealliance/wasmtime/issues/1747#issuecomment-632647617">comment</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/1747">Issue #1747</a>:</p>
<blockquote>
<p>It should probably be in <code>narrow</code>. <code>narrow</code> is used for types bigger than the native pointer size:</p>
<p><a href="https://github.com/bytecodealliance/wasmtime/blob/26ee986c2f99bb339f171267731f9108890044ab/cranelift/codegen/meta/src/isa/x86/mod.rs#L40-L59">https://github.com/bytecodealliance/wasmtime/blob/26ee986c2f99bb339f171267731f9108890044ab/cranelift/codegen/meta/src/isa/x86/mod.rs#L40-L59</a></p>
</blockquote>



<a name="198431773"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20Issue%20%231747%20Cranelift%3A%20can%27t%20legalize%20sload32/near/198431773" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20Issue.20.231747.20Cranelift.3A.20can.27t.20legalize.20sload32.html#198431773">(May 22 2020 at 11:40)</a>:</h4>
<p>whitequark edited <a href="https://github.com/bytecodealliance/wasmtime/issues/1747">Issue #1747</a>:</p>
<blockquote>
<p>I've minimized a test case that currently fails on 32-bit platforms:</p>
<div class="codehilite"><pre><span></span><code>target i686

function u0:1516(i32) -&gt; i32 system_v {
block0(v0: i32):
    v1 = load.i32 notrap aligned readonly v0
    ;v2 = load.i32 v1
    ;v3 = sextend.i64 v2
    v3 = sload32 v1
    v4, v5 = isplit v3
    return v4
}
</code></pre></div>


<p>I've tried writing a legalizer for it that would produce the commented instructions but it doesn't do anything (same lack of result for expand, widen, narrow). What gives?</p>
<div class="codehilite"><pre><span></span><code><span class="gd">--- a/cranelift/codegen/meta/src/shared/legalize.rs</span>
<span class="gi">+++ b/cranelift/codegen/meta/src/shared/legalize.rs</span>
<span class="gu">@@ -107,6 +107,7 @@ pub(crate) fn define(insts: &amp;InstructionGroup, imm: &amp;Immediates) -&gt; TransformGro</span>
     let sdiv_imm = insts.by_name(&quot;sdiv_imm&quot;);
     let select = insts.by_name(&quot;select&quot;);
     let sextend = insts.by_name(&quot;sextend&quot;);

<span class="gi">+    let sload32 = insts.by_name(&quot;sload32&quot;);</span>
     let sshr = insts.by_name(&quot;sshr&quot;);
     let sshr_imm = insts.by_name(&quot;sshr_imm&quot;);
     let srem = insts.by_name(&quot;srem&quot;);
<span class="gu">@@ -213,6 +214,14 @@ pub(crate) fn define(insts: &amp;InstructionGroup, imm: &amp;Immediates) -&gt; TransformGro</span>
     // embedded as part of arguments), so use a custom legalization for now.
     narrow.custom_legalize(iconst, &quot;narrow_iconst&quot;);


<span class="gi">+    narrow.legalize(</span>
<span class="gi">+        def!(a = sload32.I64(flags, ptr, offset)),</span>
<span class="gi">+        vec![</span>
<span class="gi">+            def!(b = load.I32(flags, ptr, offset)),</span>
<span class="gi">+            def!(a = sextend.I64(b)),</span>
<span class="gi">+        ]</span>
<span class="gi">+    );</span>
<span class="gi">+</span>
     for &amp;(ty, ty_half) in &amp;[(I128, I64), (I64, I32)] {
         let inst = uextend.bind(ty).bind(ty_half);
         narrow.legalize(
</code></pre></div>


</blockquote>



<a name="198431775"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20Issue%20%231747%20Cranelift%3A%20can%27t%20legalize%20sload32/near/198431775" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20Issue.20.231747.20Cranelift.3A.20can.27t.20legalize.20sload32.html#198431775">(May 22 2020 at 11:40)</a>:</h4>
<p>whitequark <a href="https://github.com/bytecodealliance/wasmtime/issues/1747#issuecomment-632648680">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/1747">Issue #1747</a>:</p>
<blockquote>
<p>Sure, I tried that first, it doesn't work there either. Or am I doing it wrong?</p>
</blockquote>



<a name="198920005"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20Issue%20%231747%20Cranelift%3A%20can%27t%20legalize%20sload32/near/198920005" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20Issue.20.231747.20Cranelift.3A.20can.27t.20legalize.20sload32.html#198920005">(May 27 2020 at 16:52)</a>:</h4>
<p>abrown <a href="https://github.com/bytecodealliance/wasmtime/issues/1747#issuecomment-634797751">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/1747">Issue #1747</a>:</p>
<blockquote>
<p>Looks right to me; what is the error you are getting when you run the snippet?</p>
</blockquote>



<a name="198963588"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20Issue%20%231747%20Cranelift%3A%20can%27t%20legalize%20sload32/near/198963588" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20Issue.20.231747.20Cranelift.3A.20can.27t.20legalize.20sload32.html#198963588">(May 27 2020 at 22:52)</a>:</h4>
<p>whitequark <a href="https://github.com/bytecodealliance/wasmtime/issues/1747#issuecomment-634985285">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/1747">Issue #1747</a>:</p>
<blockquote>
<blockquote>
<p>what is the error you are getting when you run the snippet?</p>
</blockquote>
<p>There is no error. It just doesn't legalize anything.</p>
</blockquote>



<a name="198963600"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20Issue%20%231747%20Cranelift%3A%20can%27t%20legalize%20sload32/near/198963600" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20Issue.20.231747.20Cranelift.3A.20can.27t.20legalize.20sload32.html#198963600">(May 27 2020 at 22:52)</a>:</h4>
<p>whitequark edited a <a href="https://github.com/bytecodealliance/wasmtime/issues/1747#issuecomment-634985285">comment</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/1747">Issue #1747</a>:</p>
<blockquote>
<blockquote>
<p>what is the error you are getting when you run the snippet?</p>
</blockquote>
<p>There is no error. It just doesn't legalize anything. The output is the same as if I don't apply the patch.</p>
</blockquote>



<a name="199041492"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20Issue%20%231747%20Cranelift%3A%20can%27t%20legalize%20sload32/near/199041492" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20Issue.20.231747.20Cranelift.3A.20can.27t.20legalize.20sload32.html#199041492">(May 28 2020 at 15:53)</a>:</h4>
<p>abrown <a href="https://github.com/bytecodealliance/wasmtime/issues/1747#issuecomment-635435365">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/1747">Issue #1747</a>:</p>
<blockquote>
<p>Oh, I see now. What about this theory: <code>v1 = load.i32 ...</code> makes <code>v1</code> an <code>i32</code> but your legalization is for <code>a = sload32.I64(flags, ptr, offset)</code>--so maybe the legalization is looking for an <code>i64</code> but the snippet provides an <code>i32</code>? Or something like along those lines?</p>
</blockquote>



<a name="199137583"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20Issue%20%231747%20Cranelift%3A%20can%27t%20legalize%20sload32/near/199137583" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20Issue.20.231747.20Cranelift.3A.20can.27t.20legalize.20sload32.html#199137583">(May 29 2020 at 10:40)</a>:</h4>
<p>whitequark <a href="https://github.com/bytecodealliance/wasmtime/issues/1747#issuecomment-635903723">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/1747">Issue #1747</a>:</p>
<blockquote>
<p>@abrown Sorry, my original minimized testcase was not minimized enough and so it was a bit misleading. Take a look at this:</p>
<div class="codehilite"><pre><span></span><code>target i686

function u0:1516(i32) -&gt; i32 system_v {
block0(v0: i32):
    ;v1 = load.i32 v0
    ;v2 = sextend.i64 v1
    v2 = sload32 v0
    v3, v4 = isplit v2
    return v3
}
</code></pre></div>


<p>Does this illustrate the problem better?</p>
</blockquote>



<a name="199143341"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20Issue%20%231747%20Cranelift%3A%20can%27t%20legalize%20sload32/near/199143341" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20Issue.20.231747.20Cranelift.3A.20can.27t.20legalize.20sload32.html#199143341">(May 29 2020 at 11:51)</a>:</h4>
<p>bjorn3 <a href="https://github.com/bytecodealliance/wasmtime/issues/1747#issuecomment-635930492">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/1747">Issue #1747</a>:</p>
<blockquote>
<blockquote>
<p><code>diff
+    narrow.legalize(
+        def!(a = sload32.I64(flags, ptr, offset)),
+        vec![
+            def!(b = load.I32(flags, ptr, offset)),
+            def!(a = sextend.I64(b)),
+        ]
+    );
</code></p>
</blockquote>
<p>What @abrown is talking about is that the <code>I64</code> part of <code>sload32.I64</code> forces <code>ptr</code> to be an <code>i64</code>, not the output value.</p>
</blockquote>



<a name="199143362"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20Issue%20%231747%20Cranelift%3A%20can%27t%20legalize%20sload32/near/199143362" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20Issue.20.231747.20Cranelift.3A.20can.27t.20legalize.20sload32.html#199143362">(May 29 2020 at 11:51)</a>:</h4>
<p>bjorn3 edited a <a href="https://github.com/bytecodealliance/wasmtime/issues/1747#issuecomment-635930492">comment</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/1747">Issue #1747</a>:</p>
<blockquote>
<blockquote>
<p><code>diff
+    narrow.legalize(
+        def!(a = sload32.I64(flags, ptr, offset)),
+        vec![
+            def!(b = load.I32(flags, ptr, offset)),
+            def!(a = sextend.I64(b)),
+        ]
+    );
</code></p>
</blockquote>
<p>What @abrown is talking about is that the <code>I64</code> part of <code>sload32.I64</code> maybe forces <code>ptr</code> to be an <code>i64</code>, not the output value.</p>
</blockquote>



<a name="199143405"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20Issue%20%231747%20Cranelift%3A%20can%27t%20legalize%20sload32/near/199143405" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20Issue.20.231747.20Cranelift.3A.20can.27t.20legalize.20sload32.html#199143405">(May 29 2020 at 11:52)</a>:</h4>
<p>bjorn3 edited a <a href="https://github.com/bytecodealliance/wasmtime/issues/1747#issuecomment-635930492">comment</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/1747">Issue #1747</a>:</p>
<blockquote>
<blockquote>
<p><code>diff
+    narrow.legalize(
+        def!(a = sload32.I64(flags, ptr, offset)),
+        vec![
+            def!(b = load.I32(flags, ptr, offset)),
+            def!(a = sextend.I64(b)),
+        ]
+    );
</code></p>
</blockquote>
<p>What @abrown is talking about is that the <code>I64</code> part of <code>sload32.I64</code> maybe forces <code>ptr</code> to be an <code>i64</code>, and not the output value.</p>
</blockquote>



<a name="199143475"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20Issue%20%231747%20Cranelift%3A%20can%27t%20legalize%20sload32/near/199143475" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20Issue.20.231747.20Cranelift.3A.20can.27t.20legalize.20sload32.html#199143475">(May 29 2020 at 11:53)</a>:</h4>
<p>whitequark <a href="https://github.com/bytecodealliance/wasmtime/issues/1747#issuecomment-635930992">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/1747">Issue #1747</a>:</p>
<blockquote>
<p>Oh... I totally misunderstood how it works. Sorry!</p>
</blockquote>



<a name="199143619"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20Issue%20%231747%20Cranelift%3A%20can%27t%20legalize%20sload32/near/199143619" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20Issue.20.231747.20Cranelift.3A.20can.27t.20legalize.20sload32.html#199143619">(May 29 2020 at 11:55)</a>:</h4>
<p>bjorn3 <a href="https://github.com/bytecodealliance/wasmtime/issues/1747#issuecomment-635931856">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/1747">Issue #1747</a>:</p>
<blockquote>
<p>Nope</p>
<p><a href="https://github.com/bytecodealliance/wasmtime/blob/01f46d02383be038465d86d5c2e22e2d2454d3ec/cranelift/wasm/src/code_translator.rs#L1819">https://github.com/bytecodealliance/wasmtime/blob/01f46d02383be038465d86d5c2e22e2d2454d3ec/cranelift/wasm/src/code_translator.rs#L1819</a></p>
<p>it seems that the <code>I64</code> part is really the output type and not the pointer type.</p>
</blockquote>



<a name="199185992"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20Issue%20%231747%20Cranelift%3A%20can%27t%20legalize%20sload32/near/199185992" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20Issue.20.231747.20Cranelift.3A.20can.27t.20legalize.20sload32.html#199185992">(May 29 2020 at 17:33)</a>:</h4>
<p>whitequark <a href="https://github.com/bytecodealliance/wasmtime/issues/1747#issuecomment-636095065">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/1747">Issue #1747</a>:</p>
<blockquote>
<p>Bizarrely, it works for stores:</p>
<div class="codehilite"><pre><span></span><code>    narrow.legalize(
        def!(istore32.I64(flags, a, ptr, offset)),
        vec![
            def!((al, ah) = isplit(a)),
            def!(store.I32(flags, al, ptr, offset)),
        ]
    );
</code></pre></div>


<div class="codehilite"><pre><span></span><code>target i686

function u0:0(i32, i32, i32) {
block0(v0: i32, v1: i32, v2: i32):
    v3 = iconcat v1, v2
    istore32.i64 v3, v0
    return
}
</code></pre></div>


</blockquote>



<a name="199187078"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20Issue%20%231747%20Cranelift%3A%20can%27t%20legalize%20sload32/near/199187078" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20Issue.20.231747.20Cranelift.3A.20can.27t.20legalize.20sload32.html#199187078">(May 29 2020 at 17:41)</a>:</h4>
<p>whitequark <a href="https://github.com/bytecodealliance/wasmtime/issues/1747#issuecomment-636098907">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/1747">Issue #1747</a>:</p>
<blockquote>
<p>Ahh I know what happens. The problem is that <code>isplit.i64</code> is not legal and so the legalizer never actually looks at <code>sload32.i64</code> at all. It looks like it's not easily possible to encode that in the meta language, how would I proceed?</p>
</blockquote>



<a name="199199684"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20Issue%20%231747%20Cranelift%3A%20can%27t%20legalize%20sload32/near/199199684" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20Issue.20.231747.20Cranelift.3A.20can.27t.20legalize.20sload32.html#199199684">(May 29 2020 at 19:20)</a>:</h4>
<p>bjorn3 <a href="https://github.com/bytecodealliance/wasmtime/issues/1747#issuecomment-636143579">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/1747">Issue #1747</a>:</p>
<blockquote>
<div class="codehilite"><pre><span></span><code><span class="k">if</span><span class="w"> </span><span class="n">pos</span><span class="p">.</span><span class="n">func</span><span class="p">.</span><span class="n">dfg</span><span class="p">.</span><span class="n">value_type</span><span class="p">(</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">ir</span>::<span class="n">types</span>::<span class="n">I64</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
</code></pre></div>


<p>this is an excerpt from the <code>sload32</code> legalization. It seems that it <strong>does</strong> check the pointer type.</p>
</blockquote>



<a name="199199841"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20Issue%20%231747%20Cranelift%3A%20can%27t%20legalize%20sload32/near/199199841" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20Issue.20.231747.20Cranelift.3A.20can.27t.20legalize.20sload32.html#199199841">(May 29 2020 at 19:21)</a>:</h4>
<p>whitequark <a href="https://github.com/bytecodealliance/wasmtime/issues/1747#issuecomment-636144089">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/1747">Issue #1747</a>:</p>
<blockquote>
<p>That seems like a bug then? But I'm not sure where.</p>
</blockquote>



<a name="199201097"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20Issue%20%231747%20Cranelift%3A%20can%27t%20legalize%20sload32/near/199201097" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20Issue.20.231747.20Cranelift.3A.20can.27t.20legalize.20sload32.html#199201097">(May 29 2020 at 19:31)</a>:</h4>
<p>bjorn3 <a href="https://github.com/bytecodealliance/wasmtime/issues/1747#issuecomment-636148449">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/1747">Issue #1747</a>:</p>
<blockquote>
<p>It seems that the ctrl typevar of <code>sload32</code> is actually the pointer size. The output type is always <code>i64</code>. This means that you should use <code>sload32.i32</code> when you have a 32bit pointer and <code>sload32.i64</code> when you have a 64bit pointer.</p>
<div class="codehilite"><pre><span></span><code><span class="kd">let</span><span class="w"> </span><span class="n">iAddr</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&amp;</span><span class="n">TypeVar</span>::<span class="n">new</span><span class="p">(</span><span class="w"></span>
<span class="w">    </span><span class="s">&quot;iAddr&quot;</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="s">&quot;An integer address type&quot;</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="n">TypeSetBuilder</span>::<span class="n">new</span><span class="p">().</span><span class="n">ints</span><span class="p">(</span><span class="mi">32</span><span class="o">..</span><span class="mi">64</span><span class="p">).</span><span class="n">build</span><span class="p">(),</span><span class="w"></span>
<span class="p">);</span><span class="w"></span>
<span class="c1">// ...</span>
<span class="kd">let</span><span class="w"> </span><span class="n">p</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&amp;</span><span class="n">Operand</span>::<span class="n">new</span><span class="p">(</span><span class="s">&quot;p&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">iAddr</span><span class="p">);</span><span class="w"></span>
<span class="c1">// ...</span>
<span class="kd">let</span><span class="w"> </span><span class="n">iExt32</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&amp;</span><span class="n">TypeVar</span>::<span class="n">new</span><span class="p">(</span><span class="w"></span>
<span class="w">    </span><span class="s">&quot;iExt32&quot;</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="s">&quot;An integer type with more than 32 bits&quot;</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="n">TypeSetBuilder</span>::<span class="n">new</span><span class="p">().</span><span class="n">ints</span><span class="p">(</span><span class="mi">64</span><span class="o">..</span><span class="mi">64</span><span class="p">).</span><span class="n">build</span><span class="p">(),</span><span class="w"></span>
<span class="p">);</span><span class="w"></span>
<span class="kd">let</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&amp;</span><span class="n">Operand</span>::<span class="n">new</span><span class="p">(</span><span class="s">&quot;x&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">iExt32</span><span class="p">);</span><span class="w"></span>
<span class="kd">let</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&amp;</span><span class="n">Operand</span>::<span class="n">new</span><span class="p">(</span><span class="s">&quot;a&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">iExt32</span><span class="p">);</span><span class="w"></span>
<span class="c1">// ...</span>
<span class="n">ig</span><span class="p">.</span><span class="n">push</span><span class="p">(</span><span class="w"></span>
<span class="w">    </span><span class="n">Inst</span>::<span class="n">new</span><span class="p">(</span><span class="w"></span>
<span class="w">        </span><span class="s">&quot;sload32&quot;</span><span class="p">,</span><span class="w"></span>
<span class="w">        </span><span class="n">r</span><span class="err">#</span><span class="s">&quot;</span>
<span class="s">    Load 32 bits from memory at ``p + Offset`` and sign-extend.</span>

<span class="s">    This is equivalent to ``load.i32`` followed by ``sextend``.</span>
<span class="s">    &quot;</span><span class="err">#</span><span class="p">,</span><span class="w"></span>
<span class="w">        </span><span class="o">&amp;</span><span class="n">formats</span><span class="p">.</span><span class="n">load</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="p">.</span><span class="n">operands_in</span><span class="p">(</span><span class="n">vec</span><span class="o">!</span><span class="p">[</span><span class="n">MemFlags</span><span class="p">,</span><span class="w"> </span><span class="n">p</span><span class="p">,</span><span class="w"> </span><span class="n">Offset</span><span class="p">])</span><span class="w"></span>
<span class="w">    </span><span class="p">.</span><span class="n">operands_out</span><span class="p">(</span><span class="n">vec</span><span class="o">!</span><span class="p">[</span><span class="n">a</span><span class="p">])</span><span class="w"></span>
<span class="w">    </span><span class="p">.</span><span class="n">can_load</span><span class="p">(</span><span class="kc">true</span><span class="p">),</span><span class="w"></span>
<span class="p">);</span><span class="w"></span>
</code></pre></div>


<p>Only <code>p</code> and <code>a</code> are values. <code>p</code> can be <code>i32</code> or <code>i64</code>, but <code>a</code> can only be <code>i64</code>.</p>
</blockquote>



<a name="199201247"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20Issue%20%231747%20Cranelift%3A%20can%27t%20legalize%20sload32/near/199201247" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20Issue.20.231747.20Cranelift.3A.20can.27t.20legalize.20sload32.html#199201247">(May 29 2020 at 19:33)</a>:</h4>
<p>bjorn3 <a href="https://github.com/bytecodealliance/wasmtime/issues/1747#issuecomment-636148942">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/1747">Issue #1747</a>:</p>
<blockquote>
<p>Using <code>sload.I32</code> in the legalization and moving it to <code>expand</code> fixes it.</p>
</blockquote>



<a name="199202106"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20Issue%20%231747%20Cranelift%3A%20can%27t%20legalize%20sload32/near/199202106" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20Issue.20.231747.20Cranelift.3A.20can.27t.20legalize.20sload32.html#199202106">(May 29 2020 at 19:40)</a>:</h4>
<p>whitequark <a href="https://github.com/bytecodealliance/wasmtime/issues/1747#issuecomment-636152094">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/1747">Issue #1747</a>:</p>
<blockquote>
<p>Thanks!</p>
</blockquote>



<a name="214010929"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20Issue%20%231747%20Cranelift%3A%20can%27t%20legalize%20sload32/near/214010929" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20Issue.20.231747.20Cranelift.3A.20can.27t.20legalize.20sload32.html#214010929">(Oct 21 2020 at 06:01)</a>:</h4>
<p>whitequark <a href="https://github.com/bytecodealliance/wasmtime/issues/1747#issuecomment-713325072">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/1747">Issue #1747</a>:</p>
<blockquote>
<p>I believe #1794 has fixed but didn't close this issue because of some CI weirdness.</p>
</blockquote>



<a name="214010930"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20Issue%20%231747%20Cranelift%3A%20can%27t%20legalize%20sload32/near/214010930" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20Issue.20.231747.20Cranelift.3A.20can.27t.20legalize.20sload32.html#214010930">(Oct 21 2020 at 06:01)</a>:</h4>
<p>whitequark closed <a href="https://github.com/bytecodealliance/wasmtime/issues/1747">Issue #1747</a>:</p>
<blockquote>
<p>I've minimized a test case that currently fails on 32-bit platforms:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="n">target</span><span class="w"> </span><span class="n">i686</span><span class="w"></span>

<span class="n">function</span><span class="w"> </span><span class="n">u0</span>:<span class="mi">1516</span><span class="p">(</span><span class="kt">i32</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="kt">i32</span> <span class="nc">system_v</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="n">block0</span><span class="p">(</span><span class="n">v0</span>: <span class="kt">i32</span><span class="p">)</span>:
    <span class="nc">v1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">load</span><span class="p">.</span><span class="kt">i32</span><span class="w"> </span><span class="n">notrap</span><span class="w"> </span><span class="n">aligned</span><span class="w"> </span><span class="n">readonly</span><span class="w"> </span><span class="n">v0</span><span class="w"></span>
<span class="w">    </span><span class="p">;</span><span class="n">v2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">load</span><span class="p">.</span><span class="kt">i32</span><span class="w"> </span><span class="n">v1</span><span class="w"></span>
<span class="w">    </span><span class="p">;</span><span class="n">v3</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">sextend</span><span class="p">.</span><span class="kt">i64</span><span class="w"> </span><span class="n">v2</span><span class="w"></span>
<span class="w">    </span><span class="n">v3</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">sload32</span><span class="w"> </span><span class="n">v1</span><span class="w"></span>
<span class="w">    </span><span class="n">v4</span><span class="p">,</span><span class="w"> </span><span class="n">v5</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">isplit</span><span class="w"> </span><span class="n">v3</span><span class="w"></span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">v4</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>

<p>I've tried writing a legalizer for it that would produce the commented instructions but it doesn't do anything (same lack of result for expand, widen, narrow). What gives?</p>
<div class="codehilite" data-code-language="Diff"><pre><span></span><code><span class="gd">--- a/cranelift/codegen/meta/src/shared/legalize.rs</span>
<span class="gi">+++ b/cranelift/codegen/meta/src/shared/legalize.rs</span>
<span class="gu">@@ -107,6 +107,7 @@ pub(crate) fn define(insts: &amp;InstructionGroup, imm: &amp;Immediates) -&gt; TransformGro</span>
     let sdiv_imm = insts.by_name("sdiv_imm");
     let select = insts.by_name("select");
     let sextend = insts.by_name("sextend");
<span class="gi">+    let sload32 = insts.by_name("sload32");</span>
     let sshr = insts.by_name("sshr");
     let sshr_imm = insts.by_name("sshr_imm");
     let srem = insts.by_name("srem");
<span class="gu">@@ -213,6 +214,14 @@ pub(crate) fn define(insts: &amp;InstructionGroup, imm: &amp;Immediates) -&gt; TransformGro</span>
     // embedded as part of arguments), so use a custom legalization for now.
     narrow.custom_legalize(iconst, "narrow_iconst");

<span class="gi">+    narrow.legalize(</span>
<span class="gi">+        def!(a = sload32.I64(flags, ptr, offset)),</span>
<span class="gi">+        vec![</span>
<span class="gi">+            def!(b = load.I32(flags, ptr, offset)),</span>
<span class="gi">+            def!(a = sextend.I64(b)),</span>
<span class="gi">+        ]</span>
<span class="gi">+    );</span>
<span class="gi">+</span>
     for &amp;(ty, ty_half) in &amp;[(I128, I64), (I64, I32)] {
         let inst = uextend.bind(ty).bind(ty_half);
         narrow.legalize(
</code></pre></div>

</blockquote>



<hr><p>Last updated: Jan 20 2025 at 06:04 UTC</p>
</html>