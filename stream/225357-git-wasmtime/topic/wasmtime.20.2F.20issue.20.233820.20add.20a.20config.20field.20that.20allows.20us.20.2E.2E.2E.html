<html>
<head><meta charset="utf-8"><title>wasmtime / issue #3820 add a config field that allows us ... · git-wasmtime · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/index.html">git-wasmtime</a></h2>
<h3>Topic: <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.233820.20add.20a.20config.20field.20that.20allows.20us.20.2E.2E.2E.html">wasmtime / issue #3820 add a config field that allows us ...</a></h3>

<hr>

<base href="https://bytecodealliance.zulipchat.com">

<head><link href="https://bytecodealliance.github.io/zulip-archive/style.css" rel="stylesheet"></head>

<a name="272202379"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%233820%20add%20a%20config%20field%20that%20allows%20us%20.../near/272202379" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.233820.20add.20a.20config.20field.20that.20allows.20us.20.2E.2E.2E.html#272202379">(Feb 17 2022 at 01:13)</a>:</h4>
<p>github-actions[bot] <a href="https://github.com/bytecodealliance/wasmtime/pull/3820#issuecomment-1042469818">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/3820">issue #3820</a>:</p>
<blockquote>
<h4>Subscribe to Label Action</h4>
<p>cc @peterhuene</p>
<p>&lt;details&gt;<br>
This issue or pull request has been labeled: "wasmtime:api", "wasmtime:config"</p>
<p>Thus the following users have been cc'd because of the following labels:</p>
<ul>
<li>peterhuene: wasmtime:api</li>
</ul>
<p>To subscribe or unsubscribe from this label, edit the &lt;code&gt;.github/subscribe-to-label.json&lt;/code&gt; configuration file.</p>
<p><a href="https://github.com/bytecodealliance/subscribe-to-label-action">Learn more.</a><br>
&lt;/details&gt;</p>
</blockquote>



<a name="272202387"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%233820%20add%20a%20config%20field%20that%20allows%20us%20.../near/272202387" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.233820.20add.20a.20config.20field.20that.20allows.20us.20.2E.2E.2E.html#272202387">(Feb 17 2022 at 01:13)</a>:</h4>
<p>github-actions[bot] <a href="https://github.com/bytecodealliance/wasmtime/pull/3820#issuecomment-1042469899">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/3820">issue #3820</a>:</p>
<blockquote>
<h4>Label Messager: wasmtime:config</h4>
<p>It looks like you are changing Wasmtime's configuration options. Make sure to<br>
complete this check list:</p>
<ul>
<li>
<p>[ ] If you added a new <code>Config</code> method, you wrote extensive documentation for<br>
      it.</p>
<p>&lt;details&gt;</p>
<p>Our documentation should be of the following form:</p>
<p>```text<br>
Short, simple summary sentence.</p>
<p>More details. These details can be multiple paragraphs. There should be<br>
information about not just the method, but its parameters and results as<br>
well.</p>
<p>Is this method fallible? If so, when can it return an error?</p>
<p>Can this method panic? If so, when does it panic?</p>
<h1>Example</h1>
<p>Optional example here.<br>
```</p>
<p>&lt;/details&gt;</p>
</li>
<li>
<p>[ ] If you added a new <code>Config</code> method, or modified an existing one, you<br>
  ensured that this configuration is exercised by the fuzz targets.</p>
<p>&lt;details&gt;</p>
<p>For example, if you expose a new strategy for allocating the next instance<br>
slot inside the pooling allocator, you should ensure that at least one of our<br>
fuzz targets exercises that new strategy.</p>
<p>Often, all that is required of you is to ensure that there is a knob for this<br>
configuration option in [<code>wasmtime_fuzzing::Config</code>][fuzzing-config] (or one<br>
of its nested <code>struct</code>s).</p>
<p>Rarely, this may require authoring a new fuzz target to specifically test this<br>
configuration. See [our docs on fuzzing][fuzzing-docs] for more details.</p>
<p>&lt;/details&gt;</p>
</li>
<li>
<p>[ ] If you are enabling a configuration option by default, make sure that it<br>
  has been fuzzed for at least two weeks before turning it on by default.</p>
</li>
</ul>
<p>[fuzzing-config]: <a href="https://github.com/bytecodealliance/wasmtime/blob/ca0e8d0a1d8cefc0496dba2f77a670571d8fdcab/crates/fuzzing/src/generators.rs#L182-L194">https://github.com/bytecodealliance/wasmtime/blob/ca0e8d0a1d8cefc0496dba2f77a670571d8fdcab/crates/fuzzing/src/generators.rs#L182-L194</a><br>
[fuzzing-docs]: <a href="https://docs.wasmtime.dev/contributing-fuzzing.html">https://docs.wasmtime.dev/contributing-fuzzing.html</a></p>
<hr>
<p>&lt;details&gt;</p>
<p>To modify this label's message, edit the &lt;code&gt;.github/label-messager/wasmtime-config.md&lt;/code&gt; file.</p>
<p>To add new label messages or remove existing label messages, edit the<br>
&lt;code&gt;.github/label-messager.json&lt;/code&gt; configuration file.</p>
<p><a href="https://github.com/bytecodealliance/label-messager-action">Learn more.</a></p>
<p>&lt;/details&gt;</p>
</blockquote>



<a name="272251441"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%233820%20add%20a%20config%20field%20that%20allows%20us%20.../near/272251441" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.233820.20add.20a.20config.20field.20that.20allows.20us.20.2E.2E.2E.html#272251441">(Feb 17 2022 at 12:26)</a>:</h4>
<p>tschneidereit <a href="https://github.com/bytecodealliance/wasmtime/pull/3820#issuecomment-1042897351">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/3820">issue #3820</a>:</p>
<blockquote>
<blockquote>
<p>Even if we mlock the original Module into memory we might still run the risk that the kernel page cache doesn't have entries for the module's memory image.</p>
</blockquote>
<p>@alexcrichton by this, do you mean that the very first time a module is instantiated / a particular mapped page is accessed in an instance, it needs to be mapped in from disk?</p>
<p>If so, that's the intended behavior for this patch: basically, the idea is to not have to read all pages of all modules at startup, with the associated increases in startup time and RSS. Instead, we'd still map pages in lazily, but once we have them, we keep them around for sure.</p>
<p>Eagerly mapping in pages is a separate thing that we might also want to introduce support for, but I think it's best to have these be separate.</p>
</blockquote>



<a name="272272340"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%233820%20add%20a%20config%20field%20that%20allows%20us%20.../near/272272340" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.233820.20add.20a.20config.20field.20that.20allows.20us.20.2E.2E.2E.html#272272340">(Feb 17 2022 at 15:05)</a>:</h4>
<p>alexcrichton <a href="https://github.com/bytecodealliance/wasmtime/pull/3820#issuecomment-1043047002">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/3820">issue #3820</a>:</p>
<blockquote>
<p>Ah I see. I did indeed mean during instantiation and while I don't think we want to eagerly pay the cost of initializing memory (as that defeats the original purpose of lazy init) there could be a theoretical case made for the first page fault on each page should be not as slow as going to disk. That being said I don't think we can guarantee that because we can't guarantee membership in the kernel's page cache with <code>mlock</code>.</p>
<p>If we still want to lazily page things in, though, then I think this may want to use <code>mlock2</code> with <code>MLOCK_ONFAULT</code> because currently it uses <code>mlock</code> which I believe guarantees that everything is resident after <code>mlock</code> returns so it would have rss and startup time implications.</p>
</blockquote>



<a name="272303230"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%233820%20add%20a%20config%20field%20that%20allows%20us%20.../near/272303230" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.233820.20add.20a.20config.20field.20that.20allows.20us.20.2E.2E.2E.html#272303230">(Feb 17 2022 at 18:32)</a>:</h4>
<p>sunfishcode <a href="https://github.com/bytecodealliance/wasmtime/pull/3820#issuecomment-1043282013">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/3820">issue #3820</a>:</p>
<blockquote>
<p>The macOS failure here is because <code>mlock_with</code> / <code>mlock2</code> is only available on Linux.</p>
</blockquote>



<a name="272398816"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%233820%20add%20a%20config%20field%20that%20allows%20us%20.../near/272398816" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.233820.20add.20a.20config.20field.20that.20allows.20us.20.2E.2E.2E.html#272398816">(Feb 18 2022 at 13:05)</a>:</h4>
<p>bjorn3 <a href="https://github.com/bytecodealliance/wasmtime/pull/3820#issuecomment-1044499092">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/3820">issue #3820</a>:</p>
<blockquote>
<p>What would exactly be the benefit of this change? Once a module is instantiated and run, all necessary pages should already be in memory, right? The only thing that can kick them back out again is a low memory condition, in which case <code>mlock</code> would require the kernel to evict other pages even if they are used more frequently.</p>
</blockquote>



<a name="272417301"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%233820%20add%20a%20config%20field%20that%20allows%20us%20.../near/272417301" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.233820.20add.20a.20config.20field.20that.20allows.20us.20.2E.2E.2E.html#272417301">(Feb 18 2022 at 15:44)</a>:</h4>
<p>tschneidereit <a href="https://github.com/bytecodealliance/wasmtime/pull/3820#issuecomment-1044725867">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/3820">issue #3820</a>:</p>
<blockquote>
<p>@bjorn3 you're right that in most contexts this doesn't make much sense. It can be useful however in settings where the goal is to have close to full memory usage at all times, but with most data being evictable because it's just there for caching purposes. In such a setting, there's often more information available on the application level than on the kernel level about which data is more important to retain, and this is an attempt to make use of that information in a better way.</p>
</blockquote>



<a name="275734395"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%233820%20add%20a%20config%20field%20that%20allows%20us%20.../near/275734395" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.233820.20add.20a.20config.20field.20that.20allows.20us.20.2E.2E.2E.html#275734395">(Mar 17 2022 at 22:05)</a>:</h4>
<p>alexcrichton <a href="https://github.com/bytecodealliance/wasmtime/pull/3820#issuecomment-1071601956">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/3820">issue #3820</a>:</p>
<blockquote>
<p>As a heads up @pchickey I just pushed to this branch. I rebased it and tweaked things a bit, but this is still not in a landable state I think.</p>
</blockquote>



<hr><p>Last updated: Jan 20 2025 at 06:04 UTC</p>
</html>