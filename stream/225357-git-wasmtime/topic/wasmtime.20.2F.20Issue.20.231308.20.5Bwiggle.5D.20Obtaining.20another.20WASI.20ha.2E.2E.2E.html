<html>
<head><meta charset="utf-8"><title>wasmtime / Issue #1308 [wiggle] Obtaining another WASI ha... · git-wasmtime · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/index.html">git-wasmtime</a></h2>
<h3>Topic: <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20Issue.20.231308.20.5Bwiggle.5D.20Obtaining.20another.20WASI.20ha.2E.2E.2E.html">wasmtime / Issue #1308 [wiggle] Obtaining another WASI ha...</a></h3>

<hr>

<base href="https://bytecodealliance.zulipchat.com">

<head><link href="https://bytecodealliance.github.io/zulip-archive/style.css" rel="stylesheet"></head>

<a name="190485691"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20Issue%20%231308%20%5Bwiggle%5D%20Obtaining%20another%20WASI%20ha.../near/190485691" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20Issue.20.231308.20.5Bwiggle.5D.20Obtaining.20another.20WASI.20ha.2E.2E.2E.html#190485691">(Mar 13 2020 at 09:41)</a>:</h4>
<p>kubkon opened <a href="https://github.com/bytecodealliance/wasmtime/issues/1308" target="_blank" title="https://github.com/bytecodealliance/wasmtime/issues/1308">Issue #1308</a> (assigned to pchickey):</p>
<blockquote>
<p>As in the title, pre-<code>wiggle</code>, we didn't really deal with a concept of WASI handle, and file descriptor was simply a type alias. Now, with <code>wiggle</code>, we can and should handle "handles" properly.</p>
<p>My question now is, how should we obtain a handle from another one in <code>wasi-common</code>? Until now (when <code>Fd</code> was a simple type alias) we did:</p>
<div class="codehilite"><pre><span></span><span class="kd">let</span><span class="w"> </span><span class="n">new_fd</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="kd">let</span><span class="w"> </span><span class="nb">Some</span><span class="p">(</span><span class="n">fd</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">old_fd</span><span class="p">.</span><span class="n">checked_add</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">fd</span><span class="w"></span>
<span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">   </span><span class="n">Overflow</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>


<p>Since <code>Fd</code> is now a "supertype", it's no longer that obvious what to do. My initial thought was to provide an unsafe accessor to the underlying value in <code>wiggle</code>, i.e., something like:</p>
<div class="codehilite"><pre><span></span><span class="k">pub</span><span class="w"> </span><span class="k">struct</span> <span class="nc">Fd</span><span class="p">(</span><span class="kt">u32</span><span class="p">);</span><span class="w"></span>
<span class="k">impl</span><span class="w"> </span><span class="n">Fd</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="k">unsafe</span><span class="w"> </span><span class="k">fn</span> <span class="nf">inner</span><span class="p">(</span><span class="o">&amp;</span><span class="bp">self</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="kt">u32</span> <span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="bp">self</span><span class="p">.</span><span class="mi">0</span><span class="w"></span>
<span class="w">   </span><span class="p">}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>


<p>Then, we could re-use most of the code in <code>wasi-common</code> to obtain a new handle as follows:</p>
<div class="codehilite"><pre><span></span><span class="kd">let</span><span class="w"> </span><span class="n">new_fd</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="kd">let</span><span class="w"> </span><span class="nb">Some</span><span class="p">(</span><span class="n">raw</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">unsafe</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">old_fd</span><span class="p">.</span><span class="n">inner</span><span class="p">()</span><span class="w"> </span><span class="p">}.</span><span class="n">checked_add</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">Fd</span>::<span class="n">from</span><span class="p">(</span><span class="n">raw</span><span class="p">)</span><span class="w"></span>
<span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">Overflow</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>


<p>I'm wondering though if you guys reckon there is a better, cleaner way of dealing with this? Perhaps a method on the handle type, <code>next() -&gt; Self</code> say, that will return another valid handle. But then, I guess it won't necessarily possess a notion of valid means without having access to the current WASI context object, right?</p>
<p>cc @alexcrichton I thought might be of interest for you as well.</p>
</blockquote>



<a name="190485692"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20Issue%20%231308%20%5Bwiggle%5D%20Obtaining%20another%20WASI%20ha.../near/190485692" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20Issue.20.231308.20.5Bwiggle.5D.20Obtaining.20another.20WASI.20ha.2E.2E.2E.html#190485692">(Mar 13 2020 at 09:41)</a>:</h4>
<p>kubkon assigned <a href="https://github.com/bytecodealliance/wasmtime/issues/1308" target="_blank" title="https://github.com/bytecodealliance/wasmtime/issues/1308">Issue #1308</a> (assigned to pchickey):</p>
<blockquote>
<p>As in the title, pre-<code>wiggle</code>, we didn't really deal with a concept of WASI handle, and file descriptor was simply a type alias. Now, with <code>wiggle</code>, we can and should handle "handles" properly.</p>
<p>My question now is, how should we obtain a handle from another one in <code>wasi-common</code>? Until now (when <code>Fd</code> was a simple type alias) we did:</p>
<div class="codehilite"><pre><span></span><span class="kd">let</span><span class="w"> </span><span class="n">new_fd</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="kd">let</span><span class="w"> </span><span class="nb">Some</span><span class="p">(</span><span class="n">fd</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">old_fd</span><span class="p">.</span><span class="n">checked_add</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">fd</span><span class="w"></span>
<span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">   </span><span class="n">Overflow</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>


<p>Since <code>Fd</code> is now a "supertype", it's no longer that obvious what to do. My initial thought was to provide an unsafe accessor to the underlying value in <code>wiggle</code>, i.e., something like:</p>
<div class="codehilite"><pre><span></span><span class="k">pub</span><span class="w"> </span><span class="k">struct</span> <span class="nc">Fd</span><span class="p">(</span><span class="kt">u32</span><span class="p">);</span><span class="w"></span>
<span class="k">impl</span><span class="w"> </span><span class="n">Fd</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="k">unsafe</span><span class="w"> </span><span class="k">fn</span> <span class="nf">inner</span><span class="p">(</span><span class="o">&amp;</span><span class="bp">self</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="kt">u32</span> <span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="bp">self</span><span class="p">.</span><span class="mi">0</span><span class="w"></span>
<span class="w">   </span><span class="p">}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>


<p>Then, we could re-use most of the code in <code>wasi-common</code> to obtain a new handle as follows:</p>
<div class="codehilite"><pre><span></span><span class="kd">let</span><span class="w"> </span><span class="n">new_fd</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="kd">let</span><span class="w"> </span><span class="nb">Some</span><span class="p">(</span><span class="n">raw</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">unsafe</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">old_fd</span><span class="p">.</span><span class="n">inner</span><span class="p">()</span><span class="w"> </span><span class="p">}.</span><span class="n">checked_add</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">Fd</span>::<span class="n">from</span><span class="p">(</span><span class="n">raw</span><span class="p">)</span><span class="w"></span>
<span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">Overflow</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>


<p>I'm wondering though if you guys reckon there is a better, cleaner way of dealing with this? Perhaps a method on the handle type, <code>next() -&gt; Self</code> say, that will return another valid handle. But then, I guess it won't necessarily possess a notion of valid means without having access to the current WASI context object, right?</p>
<p>cc @alexcrichton I thought might be of interest for you as well.</p>
</blockquote>



<a name="190485693"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20Issue%20%231308%20%5Bwiggle%5D%20Obtaining%20another%20WASI%20ha.../near/190485693" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20Issue.20.231308.20.5Bwiggle.5D.20Obtaining.20another.20WASI.20ha.2E.2E.2E.html#190485693">(Mar 13 2020 at 09:41)</a>:</h4>
<p>kubkon assigned <a href="https://github.com/bytecodealliance/wasmtime/issues/1308" target="_blank" title="https://github.com/bytecodealliance/wasmtime/issues/1308">Issue #1308</a> (assigned to pchickey):</p>
<blockquote>
<p>As in the title, pre-<code>wiggle</code>, we didn't really deal with a concept of WASI handle, and file descriptor was simply a type alias. Now, with <code>wiggle</code>, we can and should handle "handles" properly.</p>
<p>My question now is, how should we obtain a handle from another one in <code>wasi-common</code>? Until now (when <code>Fd</code> was a simple type alias) we did:</p>
<div class="codehilite"><pre><span></span><span class="kd">let</span><span class="w"> </span><span class="n">new_fd</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="kd">let</span><span class="w"> </span><span class="nb">Some</span><span class="p">(</span><span class="n">fd</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">old_fd</span><span class="p">.</span><span class="n">checked_add</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">fd</span><span class="w"></span>
<span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">   </span><span class="n">Overflow</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>


<p>Since <code>Fd</code> is now a "supertype", it's no longer that obvious what to do. My initial thought was to provide an unsafe accessor to the underlying value in <code>wiggle</code>, i.e., something like:</p>
<div class="codehilite"><pre><span></span><span class="k">pub</span><span class="w"> </span><span class="k">struct</span> <span class="nc">Fd</span><span class="p">(</span><span class="kt">u32</span><span class="p">);</span><span class="w"></span>
<span class="k">impl</span><span class="w"> </span><span class="n">Fd</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="k">unsafe</span><span class="w"> </span><span class="k">fn</span> <span class="nf">inner</span><span class="p">(</span><span class="o">&amp;</span><span class="bp">self</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="kt">u32</span> <span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="bp">self</span><span class="p">.</span><span class="mi">0</span><span class="w"></span>
<span class="w">   </span><span class="p">}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>


<p>Then, we could re-use most of the code in <code>wasi-common</code> to obtain a new handle as follows:</p>
<div class="codehilite"><pre><span></span><span class="kd">let</span><span class="w"> </span><span class="n">new_fd</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="kd">let</span><span class="w"> </span><span class="nb">Some</span><span class="p">(</span><span class="n">raw</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">unsafe</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">old_fd</span><span class="p">.</span><span class="n">inner</span><span class="p">()</span><span class="w"> </span><span class="p">}.</span><span class="n">checked_add</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">Fd</span>::<span class="n">from</span><span class="p">(</span><span class="n">raw</span><span class="p">)</span><span class="w"></span>
<span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">Overflow</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>


<p>I'm wondering though if you guys reckon there is a better, cleaner way of dealing with this? Perhaps a method on the handle type, <code>next() -&gt; Self</code> say, that will return another valid handle. But then, I guess it won't necessarily possess a notion of valid means without having access to the current WASI context object, right?</p>
<p>cc @alexcrichton I thought might be of interest for you as well.</p>
</blockquote>



<a name="190485694"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20Issue%20%231308%20%5Bwiggle%5D%20Obtaining%20another%20WASI%20ha.../near/190485694" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20Issue.20.231308.20.5Bwiggle.5D.20Obtaining.20another.20WASI.20ha.2E.2E.2E.html#190485694">(Mar 13 2020 at 09:41)</a>:</h4>
<p>kubkon labeled <a href="https://github.com/bytecodealliance/wasmtime/issues/1308" target="_blank" title="https://github.com/bytecodealliance/wasmtime/issues/1308">Issue #1308</a> (assigned to pchickey):</p>
<blockquote>
<p>As in the title, pre-<code>wiggle</code>, we didn't really deal with a concept of WASI handle, and file descriptor was simply a type alias. Now, with <code>wiggle</code>, we can and should handle "handles" properly.</p>
<p>My question now is, how should we obtain a handle from another one in <code>wasi-common</code>? Until now (when <code>Fd</code> was a simple type alias) we did:</p>
<div class="codehilite"><pre><span></span><span class="kd">let</span><span class="w"> </span><span class="n">new_fd</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="kd">let</span><span class="w"> </span><span class="nb">Some</span><span class="p">(</span><span class="n">fd</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">old_fd</span><span class="p">.</span><span class="n">checked_add</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">fd</span><span class="w"></span>
<span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">   </span><span class="n">Overflow</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>


<p>Since <code>Fd</code> is now a "supertype", it's no longer that obvious what to do. My initial thought was to provide an unsafe accessor to the underlying value in <code>wiggle</code>, i.e., something like:</p>
<div class="codehilite"><pre><span></span><span class="k">pub</span><span class="w"> </span><span class="k">struct</span> <span class="nc">Fd</span><span class="p">(</span><span class="kt">u32</span><span class="p">);</span><span class="w"></span>
<span class="k">impl</span><span class="w"> </span><span class="n">Fd</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="k">unsafe</span><span class="w"> </span><span class="k">fn</span> <span class="nf">inner</span><span class="p">(</span><span class="o">&amp;</span><span class="bp">self</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="kt">u32</span> <span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="bp">self</span><span class="p">.</span><span class="mi">0</span><span class="w"></span>
<span class="w">   </span><span class="p">}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>


<p>Then, we could re-use most of the code in <code>wasi-common</code> to obtain a new handle as follows:</p>
<div class="codehilite"><pre><span></span><span class="kd">let</span><span class="w"> </span><span class="n">new_fd</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="kd">let</span><span class="w"> </span><span class="nb">Some</span><span class="p">(</span><span class="n">raw</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">unsafe</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">old_fd</span><span class="p">.</span><span class="n">inner</span><span class="p">()</span><span class="w"> </span><span class="p">}.</span><span class="n">checked_add</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">Fd</span>::<span class="n">from</span><span class="p">(</span><span class="n">raw</span><span class="p">)</span><span class="w"></span>
<span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">Overflow</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>


<p>I'm wondering though if you guys reckon there is a better, cleaner way of dealing with this? Perhaps a method on the handle type, <code>next() -&gt; Self</code> say, that will return another valid handle. But then, I guess it won't necessarily possess a notion of valid means without having access to the current WASI context object, right?</p>
<p>cc @alexcrichton I thought might be of interest for you as well.</p>
</blockquote>



<a name="190485695"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20Issue%20%231308%20%5Bwiggle%5D%20Obtaining%20another%20WASI%20ha.../near/190485695" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20Issue.20.231308.20.5Bwiggle.5D.20Obtaining.20another.20WASI.20ha.2E.2E.2E.html#190485695">(Mar 13 2020 at 09:41)</a>:</h4>
<p>kubkon labeled <a href="https://github.com/bytecodealliance/wasmtime/issues/1308" target="_blank" title="https://github.com/bytecodealliance/wasmtime/issues/1308">Issue #1308</a> (assigned to pchickey):</p>
<blockquote>
<p>As in the title, pre-<code>wiggle</code>, we didn't really deal with a concept of WASI handle, and file descriptor was simply a type alias. Now, with <code>wiggle</code>, we can and should handle "handles" properly.</p>
<p>My question now is, how should we obtain a handle from another one in <code>wasi-common</code>? Until now (when <code>Fd</code> was a simple type alias) we did:</p>
<div class="codehilite"><pre><span></span><span class="kd">let</span><span class="w"> </span><span class="n">new_fd</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="kd">let</span><span class="w"> </span><span class="nb">Some</span><span class="p">(</span><span class="n">fd</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">old_fd</span><span class="p">.</span><span class="n">checked_add</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">fd</span><span class="w"></span>
<span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">   </span><span class="n">Overflow</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>


<p>Since <code>Fd</code> is now a "supertype", it's no longer that obvious what to do. My initial thought was to provide an unsafe accessor to the underlying value in <code>wiggle</code>, i.e., something like:</p>
<div class="codehilite"><pre><span></span><span class="k">pub</span><span class="w"> </span><span class="k">struct</span> <span class="nc">Fd</span><span class="p">(</span><span class="kt">u32</span><span class="p">);</span><span class="w"></span>
<span class="k">impl</span><span class="w"> </span><span class="n">Fd</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="k">unsafe</span><span class="w"> </span><span class="k">fn</span> <span class="nf">inner</span><span class="p">(</span><span class="o">&amp;</span><span class="bp">self</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="kt">u32</span> <span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="bp">self</span><span class="p">.</span><span class="mi">0</span><span class="w"></span>
<span class="w">   </span><span class="p">}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>


<p>Then, we could re-use most of the code in <code>wasi-common</code> to obtain a new handle as follows:</p>
<div class="codehilite"><pre><span></span><span class="kd">let</span><span class="w"> </span><span class="n">new_fd</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="kd">let</span><span class="w"> </span><span class="nb">Some</span><span class="p">(</span><span class="n">raw</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">unsafe</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">old_fd</span><span class="p">.</span><span class="n">inner</span><span class="p">()</span><span class="w"> </span><span class="p">}.</span><span class="n">checked_add</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">Fd</span>::<span class="n">from</span><span class="p">(</span><span class="n">raw</span><span class="p">)</span><span class="w"></span>
<span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">Overflow</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>


<p>I'm wondering though if you guys reckon there is a better, cleaner way of dealing with this? Perhaps a method on the handle type, <code>next() -&gt; Self</code> say, that will return another valid handle. But then, I guess it won't necessarily possess a notion of valid means without having access to the current WASI context object, right?</p>
<p>cc @alexcrichton I thought might be of interest for you as well.</p>
</blockquote>



<a name="190485696"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20Issue%20%231308%20%5Bwiggle%5D%20Obtaining%20another%20WASI%20ha.../near/190485696" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20Issue.20.231308.20.5Bwiggle.5D.20Obtaining.20another.20WASI.20ha.2E.2E.2E.html#190485696">(Mar 13 2020 at 09:41)</a>:</h4>
<p>kubkon labeled <a href="https://github.com/bytecodealliance/wasmtime/issues/1308" target="_blank" title="https://github.com/bytecodealliance/wasmtime/issues/1308">Issue #1308</a> (assigned to pchickey):</p>
<blockquote>
<p>As in the title, pre-<code>wiggle</code>, we didn't really deal with a concept of WASI handle, and file descriptor was simply a type alias. Now, with <code>wiggle</code>, we can and should handle "handles" properly.</p>
<p>My question now is, how should we obtain a handle from another one in <code>wasi-common</code>? Until now (when <code>Fd</code> was a simple type alias) we did:</p>
<div class="codehilite"><pre><span></span><span class="kd">let</span><span class="w"> </span><span class="n">new_fd</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="kd">let</span><span class="w"> </span><span class="nb">Some</span><span class="p">(</span><span class="n">fd</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">old_fd</span><span class="p">.</span><span class="n">checked_add</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">fd</span><span class="w"></span>
<span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">   </span><span class="n">Overflow</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>


<p>Since <code>Fd</code> is now a "supertype", it's no longer that obvious what to do. My initial thought was to provide an unsafe accessor to the underlying value in <code>wiggle</code>, i.e., something like:</p>
<div class="codehilite"><pre><span></span><span class="k">pub</span><span class="w"> </span><span class="k">struct</span> <span class="nc">Fd</span><span class="p">(</span><span class="kt">u32</span><span class="p">);</span><span class="w"></span>
<span class="k">impl</span><span class="w"> </span><span class="n">Fd</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="k">unsafe</span><span class="w"> </span><span class="k">fn</span> <span class="nf">inner</span><span class="p">(</span><span class="o">&amp;</span><span class="bp">self</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="kt">u32</span> <span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="bp">self</span><span class="p">.</span><span class="mi">0</span><span class="w"></span>
<span class="w">   </span><span class="p">}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>


<p>Then, we could re-use most of the code in <code>wasi-common</code> to obtain a new handle as follows:</p>
<div class="codehilite"><pre><span></span><span class="kd">let</span><span class="w"> </span><span class="n">new_fd</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="kd">let</span><span class="w"> </span><span class="nb">Some</span><span class="p">(</span><span class="n">raw</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">unsafe</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">old_fd</span><span class="p">.</span><span class="n">inner</span><span class="p">()</span><span class="w"> </span><span class="p">}.</span><span class="n">checked_add</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">Fd</span>::<span class="n">from</span><span class="p">(</span><span class="n">raw</span><span class="p">)</span><span class="w"></span>
<span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">Overflow</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>


<p>I'm wondering though if you guys reckon there is a better, cleaner way of dealing with this? Perhaps a method on the handle type, <code>next() -&gt; Self</code> say, that will return another valid handle. But then, I guess it won't necessarily possess a notion of valid means without having access to the current WASI context object, right?</p>
<p>cc @alexcrichton I thought might be of interest for you as well.</p>
</blockquote>



<a name="190520462"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20Issue%20%231308%20%5Bwiggle%5D%20Obtaining%20another%20WASI%20ha.../near/190520462" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20Issue.20.231308.20.5Bwiggle.5D.20Obtaining.20another.20WASI.20ha.2E.2E.2E.html#190520462">(Mar 13 2020 at 16:00)</a>:</h4>
<p>sunfishcode <a href="https://github.com/bytecodealliance/wasmtime/issues/1308#issuecomment-598794770" target="_blank" title="https://github.com/bytecodealliance/wasmtime/issues/1308#issuecomment-598794770">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/1308" target="_blank" title="https://github.com/bytecodealliance/wasmtime/issues/1308">Issue #1308</a>:</p>
<blockquote>
<p>In an application which opens and closes many handles, we'll want to be able to reuse handle values. To support this, we'll need to move away from "add one to a handle" and toward "ask the context for a free handle", and have the context reuse closed handles.</p>
</blockquote>



<a name="190523364"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20Issue%20%231308%20%5Bwiggle%5D%20Obtaining%20another%20WASI%20ha.../near/190523364" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20Issue.20.231308.20.5Bwiggle.5D.20Obtaining.20another.20WASI.20ha.2E.2E.2E.html#190523364">(Mar 13 2020 at 16:21)</a>:</h4>
<p>alexcrichton <a href="https://github.com/bytecodealliance/wasmtime/issues/1308#issuecomment-598804250" target="_blank" title="https://github.com/bytecodealliance/wasmtime/issues/1308#issuecomment-598804250">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/1308" target="_blank" title="https://github.com/bytecodealliance/wasmtime/issues/1308">Issue #1308</a>:</p>
<blockquote>
<p>I'd imagine the same as @sunfishcode where it seems like the underlying code should best be changed to something that doesn't require this sort of addition. It sounds like an <code>FdSet</code> which has something like an <code>allocate</code> and <code>deallocate</code> method which tracks all the indices is probably what's best here?</p>
</blockquote>



<a name="190543817"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20Issue%20%231308%20%5Bwiggle%5D%20Obtaining%20another%20WASI%20ha.../near/190543817" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20Issue.20.231308.20.5Bwiggle.5D.20Obtaining.20another.20WASI.20ha.2E.2E.2E.html#190543817">(Mar 13 2020 at 19:16)</a>:</h4>
<p>kubkon <a href="https://github.com/bytecodealliance/wasmtime/issues/1308#issuecomment-598874940" target="_blank" title="https://github.com/bytecodealliance/wasmtime/issues/1308#issuecomment-598874940">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/1308" target="_blank" title="https://github.com/bytecodealliance/wasmtime/issues/1308">Issue #1308</a>:</p>
<blockquote>
<p>I’m glad I run it past both of you! It makes perfect sense for the context to provide next available handle.</p>
<p>Since this is essentially required to swap <code>wig</code> for <code>wiggle</code>, I’m gonna provide a draft PR of how I’d see this work and we can carry on our discussion there. Does that make sense to y’all?</p>
</blockquote>



<a name="190544515"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20Issue%20%231308%20%5Bwiggle%5D%20Obtaining%20another%20WASI%20ha.../near/190544515" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20Issue.20.231308.20.5Bwiggle.5D.20Obtaining.20another.20WASI.20ha.2E.2E.2E.html#190544515">(Mar 13 2020 at 19:23)</a>:</h4>
<p>sunfishcode <a href="https://github.com/bytecodealliance/wasmtime/issues/1308#issuecomment-598877105" target="_blank" title="https://github.com/bytecodealliance/wasmtime/issues/1308#issuecomment-598877105">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/1308" target="_blank" title="https://github.com/bytecodealliance/wasmtime/issues/1308">Issue #1308</a>:</p>
<blockquote>
<p>Makes sense!</p>
</blockquote>



<a name="190920802"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20Issue%20%231308%20%5Bwiggle%5D%20Obtaining%20another%20WASI%20ha.../near/190920802" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20Issue.20.231308.20.5Bwiggle.5D.20Obtaining.20another.20WASI.20ha.2E.2E.2E.html#190920802">(Mar 17 2020 at 22:47)</a>:</h4>
<p>kubkon <a href="https://github.com/bytecodealliance/wasmtime/issues/1308#issuecomment-600337589" target="_blank" title="https://github.com/bytecodealliance/wasmtime/issues/1308#issuecomment-600337589">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/1308" target="_blank" title="https://github.com/bytecodealliance/wasmtime/issues/1308">Issue #1308</a>:</p>
<blockquote>
<p>I’m gonna go ahead and close this one since we’ve solved the issue in #1329.</p>
</blockquote>



<a name="190920803"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20Issue%20%231308%20%5Bwiggle%5D%20Obtaining%20another%20WASI%20ha.../near/190920803" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20Issue.20.231308.20.5Bwiggle.5D.20Obtaining.20another.20WASI.20ha.2E.2E.2E.html#190920803">(Mar 17 2020 at 22:47)</a>:</h4>
<p>kubkon closed <a href="https://github.com/bytecodealliance/wasmtime/issues/1308" target="_blank" title="https://github.com/bytecodealliance/wasmtime/issues/1308">Issue #1308</a> (assigned to pchickey):</p>
<blockquote>
<p>As in the title, pre-<code>wiggle</code>, we didn't really deal with a concept of WASI handle, and file descriptor was simply a type alias. Now, with <code>wiggle</code>, we can and should handle "handles" properly.</p>
<p>My question now is, how should we obtain a handle from another one in <code>wasi-common</code>? Until now (when <code>Fd</code> was a simple type alias) we did:</p>
<div class="codehilite"><pre><span></span><span class="kd">let</span><span class="w"> </span><span class="n">new_fd</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="kd">let</span><span class="w"> </span><span class="nb">Some</span><span class="p">(</span><span class="n">fd</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">old_fd</span><span class="p">.</span><span class="n">checked_add</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">fd</span><span class="w"></span>
<span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">   </span><span class="n">Overflow</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>


<p>Since <code>Fd</code> is now a "supertype", it's no longer that obvious what to do. My initial thought was to provide an unsafe accessor to the underlying value in <code>wiggle</code>, i.e., something like:</p>
<div class="codehilite"><pre><span></span><span class="k">pub</span><span class="w"> </span><span class="k">struct</span> <span class="nc">Fd</span><span class="p">(</span><span class="kt">u32</span><span class="p">);</span><span class="w"></span>
<span class="k">impl</span><span class="w"> </span><span class="n">Fd</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="k">unsafe</span><span class="w"> </span><span class="k">fn</span> <span class="nf">inner</span><span class="p">(</span><span class="o">&amp;</span><span class="bp">self</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="kt">u32</span> <span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="bp">self</span><span class="p">.</span><span class="mi">0</span><span class="w"></span>
<span class="w">   </span><span class="p">}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>


<p>Then, we could re-use most of the code in <code>wasi-common</code> to obtain a new handle as follows:</p>
<div class="codehilite"><pre><span></span><span class="kd">let</span><span class="w"> </span><span class="n">new_fd</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="kd">let</span><span class="w"> </span><span class="nb">Some</span><span class="p">(</span><span class="n">raw</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">unsafe</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">old_fd</span><span class="p">.</span><span class="n">inner</span><span class="p">()</span><span class="w"> </span><span class="p">}.</span><span class="n">checked_add</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">Fd</span>::<span class="n">from</span><span class="p">(</span><span class="n">raw</span><span class="p">)</span><span class="w"></span>
<span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">Overflow</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>


<p>I'm wondering though if you guys reckon there is a better, cleaner way of dealing with this? Perhaps a method on the handle type, <code>next() -&gt; Self</code> say, that will return another valid handle. But then, I guess it won't necessarily possess a notion of valid means without having access to the current WASI context object, right?</p>
<p>cc @alexcrichton I thought might be of interest for you as well.</p>
</blockquote>



<hr><p>Last updated: Jan 20 2025 at 06:04 UTC</p>
</html>