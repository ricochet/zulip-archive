<html>
<head><meta charset="utf-8"><title>wasmtime / PR #8596 riscv64: Improve pattern matching rul... · git-wasmtime · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/index.html">git-wasmtime</a></h2>
<h3>Topic: <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.238596.20riscv64.3A.20Improve.20pattern.20matching.20rul.2E.2E.2E.html">wasmtime / PR #8596 riscv64: Improve pattern matching rul...</a></h3>

<hr>

<base href="https://bytecodealliance.zulipchat.com">

<head><link href="https://bytecodealliance.github.io/zulip-archive/style.css" rel="stylesheet"></head>

<a name="438103317"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%238596%20riscv64%3A%20Improve%20pattern%20matching%20rul.../near/438103317" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.238596.20riscv64.3A.20Improve.20pattern.20matching.20rul.2E.2E.2E.html#438103317">(May 11 2024 at 11:38)</a>:</h4>
<p>afonso360 opened <a href="https://github.com/bytecodealliance/wasmtime/pull/8596">PR #8596</a> from <code>afonso360:riscv-fma-v3</code> to <code>bytecodealliance:main</code>:</p>
<blockquote>
<p>This commit reworks our FMA pattern matching to be slightly less verbose. It additionally adds the <code>(fma x (splat y) z)</code> pattern for vectors, which can be proven to be equivalent to <code>(splat x)</code>.</p>
<p>&lt;!--<br>
Please make sure you include the following information:</p>
<ul>
<li>
<p>If this work has been discussed elsewhere, please include a link to that<br>
  conversation. If it was discussed in an issue, just mention "issue #...".</p>
</li>
<li>
<p>Explain why this change is needed. If the details are in an issue already,<br>
  this can be brief.</p>
</li>
</ul>
<p>Our development process is documented in the Wasmtime book:<br>
<a href="https://docs.wasmtime.dev/contributing-development-process.html">https://docs.wasmtime.dev/contributing-development-process.html</a></p>
<p>Please ensure all communication follows the code of conduct:<br>
<a href="https://github.com/bytecodealliance/wasmtime/blob/main/CODE_OF_CONDUCT.md">https://github.com/bytecodealliance/wasmtime/blob/main/CODE_OF_CONDUCT.md</a><br>
--&gt;</p>
</blockquote>



<a name="438103319"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%238596%20riscv64%3A%20Improve%20pattern%20matching%20rul.../near/438103319" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.238596.20riscv64.3A.20Improve.20pattern.20matching.20rul.2E.2E.2E.html#438103319">(May 11 2024 at 11:38)</a>:</h4>
<p><strong>afonso360</strong> requested <a href="https://github.com/fitzgen">fitzgen</a> for a review on <a href="https://github.com/bytecodealliance/wasmtime/pull/8596">PR #8596</a>.</p>



<a name="438103321"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%238596%20riscv64%3A%20Improve%20pattern%20matching%20rul.../near/438103321" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.238596.20riscv64.3A.20Improve.20pattern.20matching.20rul.2E.2E.2E.html#438103321">(May 11 2024 at 11:38)</a>:</h4>
<p><strong>afonso360</strong> requested <a href="https://github.com/orgs/bytecodealliance/teams/wasmtime-compiler-reviewers">wasmtime-compiler-reviewers</a> for a review on <a href="https://github.com/bytecodealliance/wasmtime/pull/8596">PR #8596</a>.</p>



<a name="438103553"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%238596%20riscv64%3A%20Improve%20pattern%20matching%20rul.../near/438103553" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.238596.20riscv64.3A.20Improve.20pattern.20matching.20rul.2E.2E.2E.html#438103553">(May 11 2024 at 11:42)</a>:</h4>
<p>afonso360 edited <a href="https://github.com/bytecodealliance/wasmtime/pull/8596">PR #8596</a>:</p>
<blockquote>
<p><span aria-label="wave" class="emoji emoji-1f44b" role="img" title="wave">:wave:</span> Hey,</p>
<p>This PR reworks our FMA pattern matching to be slightly less verbose using the suggestions provided by @jameysharp on <a href="https://github.com/bytecodealliance/wasmtime/pull/8588#issuecomment-2103773727">https://github.com/bytecodealliance/wasmtime/pull/8588#issuecomment-2103773727</a>.</p>
<p>It additionally adds the <code>(fma x (splat y) z)</code> pattern for vectors, which can be proven to be equivalent to <code>(splat x)</code>. See <a href="https://github.com/bytecodealliance/wasmtime/pull/8588#issuecomment-2105622411">https://github.com/bytecodealliance/wasmtime/pull/8588#issuecomment-2105622411</a>. I've only added ISA tests for these patterns since it turns out they are already present in the SIMD FMA runtests.</p>
<p>I think all of the patterns matched here are sound although I can't formally prove all of them.  This comment <a href="https://github.com/bytecodealliance/wasmtime/pull/8588#issuecomment-2105622411">https://github.com/bytecodealliance/wasmtime/pull/8588#issuecomment-2105622411</a> describes most of the validations that I did.</p>
</blockquote>



<a name="438103570"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%238596%20riscv64%3A%20Improve%20pattern%20matching%20rul.../near/438103570" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.238596.20riscv64.3A.20Improve.20pattern.20matching.20rul.2E.2E.2E.html#438103570">(May 11 2024 at 11:43)</a>:</h4>
<p>afonso360 edited <a href="https://github.com/bytecodealliance/wasmtime/pull/8596">PR #8596</a>:</p>
<blockquote>
<p><span aria-label="wave" class="emoji emoji-1f44b" role="img" title="wave">:wave:</span> Hey,</p>
<p>This PR reworks our FMA pattern matching to be slightly less verbose using the suggestions provided by @jameysharp on <a href="https://github.com/bytecodealliance/wasmtime/pull/8588#issuecomment-2103773727">https://github.com/bytecodealliance/wasmtime/pull/8588#issuecomment-2103773727</a>.</p>
<p>It additionally adds the <code>(fma x (splat y) z)</code> pattern for vectors, which can be proven to be equivalent to <code>(fma (splat x) y z)</code>. See <a href="https://github.com/bytecodealliance/wasmtime/pull/8588#issuecomment-2105622411">https://github.com/bytecodealliance/wasmtime/pull/8588#issuecomment-2105622411</a>. I've only added ISA tests for these patterns since it turns out they are already present in the SIMD FMA runtests.</p>
<p>I think all of the patterns matched here are sound although I can't formally prove all of them.  This comment <a href="https://github.com/bytecodealliance/wasmtime/pull/8588#issuecomment-2105622411">https://github.com/bytecodealliance/wasmtime/pull/8588#issuecomment-2105622411</a> describes most of the validations that I did.</p>
</blockquote>



<a name="438103627"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%238596%20riscv64%3A%20Improve%20pattern%20matching%20rul.../near/438103627" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.238596.20riscv64.3A.20Improve.20pattern.20matching.20rul.2E.2E.2E.html#438103627">(May 11 2024 at 11:44)</a>:</h4>
<p>afonso360 edited <a href="https://github.com/bytecodealliance/wasmtime/pull/8596">PR #8596</a>:</p>
<blockquote>
<p><span aria-label="wave" class="emoji emoji-1f44b" role="img" title="wave">:wave:</span> Hey,</p>
<p>This PR reworks our FMA pattern matching to be slightly less verbose using the suggestions provided by @jameysharp on <a href="https://github.com/bytecodealliance/wasmtime/pull/8588#issuecomment-2103773727">https://github.com/bytecodealliance/wasmtime/pull/8588#issuecomment-2103773727</a>.</p>
<p>It additionally adds the <code>(fma x (splat y) z)</code> pattern for vectors, which can be proven to be equivalent to <code>(fma y (splat x) z)</code>. See <a href="https://github.com/bytecodealliance/wasmtime/pull/8588#issuecomment-2105622411">https://github.com/bytecodealliance/wasmtime/pull/8588#issuecomment-2105622411</a>. I've only added ISA tests for these patterns since it turns out they are already present in the SIMD FMA runtests.</p>
<p>I think all of the patterns matched here are sound although I can't formally prove all of them.  This comment <a href="https://github.com/bytecodealliance/wasmtime/pull/8588#issuecomment-2105622411">https://github.com/bytecodealliance/wasmtime/pull/8588#issuecomment-2105622411</a> describes most of the validations that I did.</p>
</blockquote>



<a name="438103643"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%238596%20riscv64%3A%20Improve%20pattern%20matching%20rul.../near/438103643" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.238596.20riscv64.3A.20Improve.20pattern.20matching.20rul.2E.2E.2E.html#438103643">(May 11 2024 at 11:44)</a>:</h4>
<p>afonso360 edited <a href="https://github.com/bytecodealliance/wasmtime/pull/8596">PR #8596</a>.</p>



<a name="438111919"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%238596%20riscv64%3A%20Improve%20pattern%20matching%20rul.../near/438111919" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.238596.20riscv64.3A.20Improve.20pattern.20matching.20rul.2E.2E.2E.html#438111919">(May 11 2024 at 14:08)</a>:</h4>
<p><strong>fitzgen</strong> requested <a href="https://github.com/jameysharp">jameysharp</a> for a review on <a href="https://github.com/bytecodealliance/wasmtime/pull/8596">PR #8596</a>.</p>



<a name="438111930"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%238596%20riscv64%3A%20Improve%20pattern%20matching%20rul.../near/438111930" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.238596.20riscv64.3A.20Improve.20pattern.20matching.20rul.2E.2E.2E.html#438111930">(May 11 2024 at 14:08)</a>:</h4>
<p>fitzgen <a href="https://github.com/bytecodealliance/wasmtime/pull/8596#issuecomment-2105821683">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/8596">PR #8596</a>:</p>
<blockquote>
<p>Redirecting to @jameysharp since it seems like he has more context here.</p>
</blockquote>



<a name="438210843"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%238596%20riscv64%3A%20Improve%20pattern%20matching%20rul.../near/438210843" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.238596.20riscv64.3A.20Improve.20pattern.20matching.20rul.2E.2E.2E.html#438210843">(May 12 2024 at 20:40)</a>:</h4>
<p>jameysharp submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/8596#pullrequestreview-2051450066">PR review</a>:</p>
<blockquote>
<p>Fantastic, I love that this worked out, and I really appreciate the effort you put into using Alive2 to check which of my guesses were correct. Too bad about signed zeroes…</p>
<p>By the way, this motivated me to write up #8599, which would make this kind of pattern easier to write someday.</p>
</blockquote>



<a name="438210844"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%238596%20riscv64%3A%20Improve%20pattern%20matching%20rul.../near/438210844" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.238596.20riscv64.3A.20Improve.20pattern.20matching.20rul.2E.2E.2E.html#438210844">(May 12 2024 at 20:40)</a>:</h4>
<p>jameysharp submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/8596#pullrequestreview-2051450066">PR review</a>:</p>
<blockquote>
<p>Fantastic, I love that this worked out, and I really appreciate the effort you put into using Alive2 to check which of my guesses were correct. Too bad about signed zeroes…</p>
<p>By the way, this motivated me to write up #8599, which would make this kind of pattern easier to write someday.</p>
</blockquote>



<a name="438210845"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%238596%20riscv64%3A%20Improve%20pattern%20matching%20rul.../near/438210845" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.238596.20riscv64.3A.20Improve.20pattern.20matching.20rul.2E.2E.2E.html#438210845">(May 12 2024 at 20:40)</a>:</h4>
<p>jameysharp created <a href="https://github.com/bytecodealliance/wasmtime/pull/8596#discussion_r1597709833">PR review comment</a>:</p>
<blockquote>
<p>Interesting, why does this rule need a priority?</p>
</blockquote>



<a name="438212165"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%238596%20riscv64%3A%20Improve%20pattern%20matching%20rul.../near/438212165" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.238596.20riscv64.3A.20Improve.20pattern.20matching.20rul.2E.2E.2E.html#438212165">(May 12 2024 at 21:05)</a>:</h4>
<p>afonso360 submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/8596#pullrequestreview-2051453184">PR review</a>.</p>



<a name="438212166"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%238596%20riscv64%3A%20Improve%20pattern%20matching%20rul.../near/438212166" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.238596.20riscv64.3A.20Improve.20pattern.20matching.20rul.2E.2E.2E.html#438212166">(May 12 2024 at 21:05)</a>:</h4>
<p>afonso360 created <a href="https://github.com/bytecodealliance/wasmtime/pull/8596#discussion_r1597713863">PR review comment</a>:</p>
<blockquote>
<p>Oops, it shouldn't. I was debugging some stuff and forgot to remove it.</p>
</blockquote>



<a name="438212270"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%238596%20riscv64%3A%20Improve%20pattern%20matching%20rul.../near/438212270" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.238596.20riscv64.3A.20Improve.20pattern.20matching.20rul.2E.2E.2E.html#438212270">(May 12 2024 at 21:06)</a>:</h4>
<p>afonso360 updated <a href="https://github.com/bytecodealliance/wasmtime/pull/8596">PR #8596</a>.</p>



<a name="438212295"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%238596%20riscv64%3A%20Improve%20pattern%20matching%20rul.../near/438212295" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.238596.20riscv64.3A.20Improve.20pattern.20matching.20rul.2E.2E.2E.html#438212295">(May 12 2024 at 21:07)</a>:</h4>
<p>afonso360 has enabled auto merge for <a href="https://github.com/bytecodealliance/wasmtime/pull/8596">PR #8596</a>.</p>



<a name="438214585"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%238596%20riscv64%3A%20Improve%20pattern%20matching%20rul.../near/438214585" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.238596.20riscv64.3A.20Improve.20pattern.20matching.20rul.2E.2E.2E.html#438214585">(May 12 2024 at 21:48)</a>:</h4>
<p>afonso360 merged <a href="https://github.com/bytecodealliance/wasmtime/pull/8596">PR #8596</a>.</p>



<hr><p>Last updated: Jan 20 2025 at 06:04 UTC</p>
</html>