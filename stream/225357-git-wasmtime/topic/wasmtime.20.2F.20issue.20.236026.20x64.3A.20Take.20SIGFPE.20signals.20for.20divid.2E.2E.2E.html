<html>
<head><meta charset="utf-8"><title>wasmtime / issue #6026 x64: Take SIGFPE signals for divid... · git-wasmtime · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/index.html">git-wasmtime</a></h2>
<h3>Topic: <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.236026.20x64.3A.20Take.20SIGFPE.20signals.20for.20divid.2E.2E.2E.html">wasmtime / issue #6026 x64: Take SIGFPE signals for divid...</a></h3>

<hr>

<base href="https://bytecodealliance.zulipchat.com">

<head><link href="https://bytecodealliance.github.io/zulip-archive/style.css" rel="stylesheet"></head>

<a name="342139985"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%236026%20x64%3A%20Take%20SIGFPE%20signals%20for%20divid.../near/342139985" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.236026.20x64.3A.20Take.20SIGFPE.20signals.20for.20divid.2E.2E.2E.html#342139985">(Mar 15 2023 at 18:44)</a>:</h4>
<p>github-actions[bot] <a href="https://github.com/bytecodealliance/wasmtime/pull/6026#issuecomment-1470583722">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/6026">issue #6026</a>:</p>
<blockquote>
<h4>Subscribe to Label Action</h4>
<p>cc @peterhuene</p>
<p>&lt;details&gt;<br>
This issue or pull request has been labeled: "cranelift", "cranelift:area:x64", "wasmtime:api"</p>
<p>Thus the following users have been cc'd because of the following labels:</p>
<ul>
<li>peterhuene: wasmtime:api</li>
</ul>
<p>To subscribe or unsubscribe from this label, edit the &lt;code&gt;.github/subscribe-to-label.json&lt;/code&gt; configuration file.</p>
<p><a href="https://github.com/bytecodealliance/subscribe-to-label-action">Learn more.</a><br>
&lt;/details&gt;</p>
</blockquote>



<a name="342177742"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%236026%20x64%3A%20Take%20SIGFPE%20signals%20for%20divid.../near/342177742" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.236026.20x64.3A.20Take.20SIGFPE.20signals.20for.20divid.2E.2E.2E.html#342177742">(Mar 15 2023 at 22:18)</a>:</h4>
<p>alexcrichton <a href="https://github.com/bytecodealliance/wasmtime/pull/6026#issuecomment-1470920590">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/6026">issue #6026</a>:</p>
<blockquote>
<blockquote>
<p>if you want to branch-fold away the avoid_div_traps=true case as part of this PR </p>
</blockquote>
<p>Nah I think it makes sense to go ahead and do that here, and I feel it pretty nicely simplified the rules!</p>
</blockquote>



<a name="342177921"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%236026%20x64%3A%20Take%20SIGFPE%20signals%20for%20divid.../near/342177921" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.236026.20x64.3A.20Take.20SIGFPE.20signals.20for.20divid.2E.2E.2E.html#342177921">(Mar 15 2023 at 22:19)</a>:</h4>
<p>alexcrichton <a href="https://github.com/bytecodealliance/wasmtime/pull/6026#issuecomment-1470921812">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/6026">issue #6026</a>:</p>
<blockquote>
<p>One minor non-optimal bit about this PR is that currently I've represented the trap as <code>TrapCode</code> inside of the div instructions, but it arguably should be <code>Option&lt;TrapCode&gt;</code> and <code>None</code> for cases such as divide-by-constant-that-isn't-zero. Dealing with <code>Option</code> is a bit of a hassle in ISLE right now though and the only "cost" of this is a slightly larger trap metadata section which doesn't seem like it'll break the bank or cause any major issues in the meantime.</p>
</blockquote>



<a name="358558840"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%236026%20x64%3A%20Take%20SIGFPE%20signals%20for%20divid.../near/358558840" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.236026.20x64.3A.20Take.20SIGFPE.20signals.20for.20divid.2E.2E.2E.html#358558840">(May 15 2023 at 19:53)</a>:</h4>
<p>thibaultcha <a href="https://github.com/bytecodealliance/wasmtime/pull/6026#issuecomment-1548483595">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/6026">issue #6026</a>:</p>
<blockquote>
<p>After upgrading to Wasmtime 8.0.0, how can we revert back to the previous behavior? This patch causes Valgrind to complain about SIGFPE when before 8.0.0 everything was just fine.</p>
</blockquote>



<a name="358559569"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%236026%20x64%3A%20Take%20SIGFPE%20signals%20for%20divid.../near/358559569" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.236026.20x64.3A.20Take.20SIGFPE.20signals.20for.20divid.2E.2E.2E.html#358559569">(May 15 2023 at 19:57)</a>:</h4>
<p>thibaultcha edited a <a href="https://github.com/bytecodealliance/wasmtime/pull/6026#issuecomment-1548483595">comment</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/6026">issue #6026</a>:</p>
<blockquote>
<p>After upgrading to Wasmtime 8.0.0, how can we revert back to the previous behavior? This patch causes Valgrind to complain about SIGFPE when before 8.0.0 everything was just fine. Just to be clear we don't want to raise SIGFPE when Wasmtime encounters a div by 0, we want it to throw a trap as usual and nothing more.</p>
</blockquote>



<a name="358564772"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%236026%20x64%3A%20Take%20SIGFPE%20signals%20for%20divid.../near/358564772" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.236026.20x64.3A.20Take.20SIGFPE.20signals.20for.20divid.2E.2E.2E.html#358564772">(May 15 2023 at 20:26)</a>:</h4>
<p>cfallin <a href="https://github.com/bytecodealliance/wasmtime/pull/6026#issuecomment-1548527409">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/6026">issue #6026</a>:</p>
<blockquote>
<p>@thibaultcha there isn't really a good way to do that; this PR removed the code-paths that support inline checks rather than relying on signals, because it vastly simplifies things and we judged that it would be fine to use SIGFPE handling instead for the embedding scenarios we support.</p>
<p>It's possible we could revert this whole PR, but that does have a maintenance cost, so it would be useful to know more about the requirements of your case. Is the issue mainly Valgrind warnings (and if so, is there a way to define a suppression for them)? Or is there something more fundamental about your embedding environment where signals are not acceptable?</p>
</blockquote>



<a name="358581194"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%236026%20x64%3A%20Take%20SIGFPE%20signals%20for%20divid.../near/358581194" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.236026.20x64.3A.20Take.20SIGFPE.20signals.20for.20divid.2E.2E.2E.html#358581194">(May 15 2023 at 22:18)</a>:</h4>
<p>alexcrichton <a href="https://github.com/bytecodealliance/wasmtime/pull/6026#issuecomment-1548689146">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/6026">issue #6026</a>:</p>
<blockquote>
<p>Out of curiosity, if SIGFPE is causing problems how does valgrind handle wasm performing out-of-bounds memory loads? Those are done with guard pages and signal handling right now, so if those are working then I'd expecte SIGFPE to work as well. Or are you perhaps configuring wasm to have no signals by using dynamic memory with explicit bounds checks?</p>
<p>(I'm also curious about what Chris mentioned in terms of suppressions and info about signals, too)</p>
</blockquote>



<a name="358861766"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%236026%20x64%3A%20Take%20SIGFPE%20signals%20for%20divid.../near/358861766" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.236026.20x64.3A.20Take.20SIGFPE.20signals.20for.20divid.2E.2E.2E.html#358861766">(May 16 2023 at 22:54)</a>:</h4>
<p>thibaultcha <a href="https://github.com/bytecodealliance/wasmtime/pull/6026#issuecomment-1550458941">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/6026">issue #6026</a>:</p>
<blockquote>
<p>It seems we have sorted it out! It wasn't my intention to ask for a revert this patch; it was rather that since I read:</p>
<blockquote>
<p>Wasmtime would configure avoid_div_traps=true</p>
</blockquote>
<p>I was initially wondering if we as users could revert this setting to get back to the previous behavior and fix our issue.</p>
<p>We found that a Valgrind flag does the trick for this test and allows us to correctly handle <code>SIGFPE</code> with the new cranelift behavior: <code>--vex-iropt-register-updates=allregs-at-each-insn</code>.</p>
<p>Thank you both for the replies!</p>
</blockquote>



<a name="358864439"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%236026%20x64%3A%20Take%20SIGFPE%20signals%20for%20divid.../near/358864439" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.236026.20x64.3A.20Take.20SIGFPE.20signals.20for.20divid.2E.2E.2E.html#358864439">(May 16 2023 at 23:19)</a>:</h4>
<p>cfallin <a href="https://github.com/bytecodealliance/wasmtime/pull/6026#issuecomment-1550478150">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/6026">issue #6026</a>:</p>
<blockquote>
<p>Great! I'm glad you've got a solution and let us know if you have any other issues.</p>
<p>We're always happy to take PRs to docs if you feel like there's a place where a Valgrind-related tip might have helped you (but no pressure at all, of course); otherwise at least these comments should be searchable if others hit the same thing in the future.</p>
</blockquote>



<a name="358865689"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%236026%20x64%3A%20Take%20SIGFPE%20signals%20for%20divid.../near/358865689" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.236026.20x64.3A.20Take.20SIGFPE.20signals.20for.20divid.2E.2E.2E.html#358865689">(May 16 2023 at 23:33)</a>:</h4>
<p>thibaultcha edited a <a href="https://github.com/bytecodealliance/wasmtime/pull/6026#issuecomment-1550458941">comment</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/6026">issue #6026</a>:</p>
<blockquote>
<p>It seems we have sorted it out! It wasn't my intention to ask for a revert this patch; it was rather that since I read:</p>
<blockquote>
<p>Wasmtime would configure avoid_div_traps=true</p>
</blockquote>
<p>I was initially wondering if we as users could revert this setting to get back to the previous behavior and fix our issue.</p>
<p>We found that a Valgrind flag does the trick for this test and allows us to correctly handle SIGFPE with the new cranelift behavior: <code>--vex-iropt-register-updates=allregs-at-each-insn</code>.</p>
<p>Thank you both for the replies!</p>
</blockquote>



<hr><p>Last updated: Jan 20 2025 at 06:04 UTC</p>
</html>