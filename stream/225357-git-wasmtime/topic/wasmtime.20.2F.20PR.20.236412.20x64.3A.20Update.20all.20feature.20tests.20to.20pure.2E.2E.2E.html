<html>
<head><meta charset="utf-8"><title>wasmtime / PR #6412 x64: Update all feature tests to pure... · git-wasmtime · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/index.html">git-wasmtime</a></h2>
<h3>Topic: <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.236412.20x64.3A.20Update.20all.20feature.20tests.20to.20pure.2E.2E.2E.html">wasmtime / PR #6412 x64: Update all feature tests to pure...</a></h3>

<hr>

<base href="https://bytecodealliance.zulipchat.com">

<head><link href="https://bytecodealliance.github.io/zulip-archive/style.css" rel="stylesheet"></head>

<a name="359473428"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%236412%20x64%3A%20Update%20all%20feature%20tests%20to%20pure.../near/359473428" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.236412.20x64.3A.20Update.20all.20feature.20tests.20to.20pure.2E.2E.2E.html#359473428">(May 18 2023 at 18:49)</a>:</h4>
<p>alexcrichton opened <a href="https://github.com/bytecodealliance/wasmtime/pull/6412">PR #6412</a> from <code>alexcrichton:x64-feature-names</code> to <code>bytecodealliance:main</code>:</p>
<blockquote>
<p>Many of the tests for lowering features use <code>extractor</code>s I think since when they were added that was the only option. Nowadays a <code>pure constructor</code> with <code>if-let</code> feels more natural for this, so this commit updates all existing extractors used to test features to use a <code>pure constructor</code> instead. This additionally updates the names to match the cranelift codegen setting name to ensure that a consistent name is used.</p>
<p>&lt;!--<br>
Please make sure you include the following information:</p>
<ul>
<li>
<p>If this work has been discussed elsewhere, please include a link to that<br>
  conversation. If it was discussed in an issue, just mention "issue #...".</p>
</li>
<li>
<p>Explain why this change is needed. If the details are in an issue already,<br>
  this can be brief.</p>
</li>
</ul>
<p>Our development process is documented in the Wasmtime book:<br>
<a href="https://docs.wasmtime.dev/contributing-development-process.html">https://docs.wasmtime.dev/contributing-development-process.html</a></p>
<p>Please ensure all communication follows the code of conduct:<br>
<a href="https://github.com/bytecodealliance/wasmtime/blob/main/CODE_OF_CONDUCT.md">https://github.com/bytecodealliance/wasmtime/blob/main/CODE_OF_CONDUCT.md</a><br>
--&gt;</p>
</blockquote>



<a name="359473443"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%236412%20x64%3A%20Update%20all%20feature%20tests%20to%20pure.../near/359473443" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.236412.20x64.3A.20Update.20all.20feature.20tests.20to.20pure.2E.2E.2E.html#359473443">(May 18 2023 at 18:49)</a>:</h4>
<p><strong>alexcrichton</strong> has marked <a href="https://github.com/bytecodealliance/wasmtime/pull/6412">PR #6412</a> as ready for review.</p>



<a name="359473445"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%236412%20x64%3A%20Update%20all%20feature%20tests%20to%20pure.../near/359473445" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.236412.20x64.3A.20Update.20all.20feature.20tests.20to.20pure.2E.2E.2E.html#359473445">(May 18 2023 at 18:49)</a>:</h4>
<p><strong>alexcrichton</strong> requested <a href="https://github.com/jameysharp">jameysharp</a> for a review on <a href="https://github.com/bytecodealliance/wasmtime/pull/6412">PR #6412</a>.</p>



<a name="359473447"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%236412%20x64%3A%20Update%20all%20feature%20tests%20to%20pure.../near/359473447" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.236412.20x64.3A.20Update.20all.20feature.20tests.20to.20pure.2E.2E.2E.html#359473447">(May 18 2023 at 18:49)</a>:</h4>
<p><strong>alexcrichton</strong> requested <a href="https://github.com/orgs/bytecodealliance/teams/wasmtime-compiler-reviewers">wasmtime-compiler-reviewers</a> for a review on <a href="https://github.com/bytecodealliance/wasmtime/pull/6412">PR #6412</a>.</p>



<a name="359475451"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%236412%20x64%3A%20Update%20all%20feature%20tests%20to%20pure.../near/359475451" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.236412.20x64.3A.20Update.20all.20feature.20tests.20to.20pure.2E.2E.2E.html#359475451">(May 18 2023 at 18:59)</a>:</h4>
<p>abrown submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/6412#pullrequestreview-1433286137">PR review</a>.</p>



<a name="359479815"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%236412%20x64%3A%20Update%20all%20feature%20tests%20to%20pure.../near/359479815" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.236412.20x64.3A.20Update.20all.20feature.20tests.20to.20pure.2E.2E.2E.html#359479815">(May 18 2023 at 19:26)</a>:</h4>
<p>fitzgen submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/6412#pullrequestreview-1433324545">PR review</a>:</p>
<blockquote>
<p>Nice, yes this stuff did indeed come before pure constructors and <code>if-let</code>.</p>
</blockquote>



<a name="359480077"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%236412%20x64%3A%20Update%20all%20feature%20tests%20to%20pure.../near/359480077" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.236412.20x64.3A.20Update.20all.20feature.20tests.20to.20pure.2E.2E.2E.html#359480077">(May 18 2023 at 19:27)</a>:</h4>
<p>jameysharp submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/6412#pullrequestreview-1433317526">PR review</a>:</p>
<blockquote>
<p>Excellent idea. Among other things, this gives ISLE a lot more freedom to schedule these feature tests with respect to other pattern matches, since it no longer believes there's a data dependency on the type. I like to <code>diff</code> the ISLE-generated source before and after changes like this just because I think it's interesting to see how the schedule changes.</p>
<p>I'd love to see some Sightglass figures for the compile phase. It should be no worse, and possibly better, but ISLE uses a pretty simple greedy heuristic for match ordering so anything is possible.</p>
</blockquote>



<a name="359480078"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%236412%20x64%3A%20Update%20all%20feature%20tests%20to%20pure.../near/359480078" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.236412.20x64.3A.20Update.20all.20feature.20tests.20to.20pure.2E.2E.2E.html#359480078">(May 18 2023 at 19:27)</a>:</h4>
<p>jameysharp submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/6412#pullrequestreview-1433317526">PR review</a>:</p>
<blockquote>
<p>Excellent idea. Among other things, this gives ISLE a lot more freedom to schedule these feature tests with respect to other pattern matches, since it no longer believes there's a data dependency on the type. I like to <code>diff</code> the ISLE-generated source before and after changes like this just because I think it's interesting to see how the schedule changes.</p>
<p>I'd love to see some Sightglass figures for the compile phase. It should be no worse, and possibly better, but ISLE uses a pretty simple greedy heuristic for match ordering so anything is possible.</p>
</blockquote>



<a name="359480079"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%236412%20x64%3A%20Update%20all%20feature%20tests%20to%20pure.../near/359480079" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.236412.20x64.3A.20Update.20all.20feature.20tests.20to.20pure.2E.2E.2E.html#359480079">(May 18 2023 at 19:27)</a>:</h4>
<p>jameysharp created <a href="https://github.com/bytecodealliance/wasmtime/pull/6412#discussion_r1198215799">PR review comment</a>:</p>
<blockquote>
<p>I have a preference for using pattern-matches rather than priorities whenever possible.</p>
<p>In this case I could be convinced the other way: do_ctz is more general and still works even if use_bmi1 is enabled, so semantically the priorities make sense; and it probably doesn't make much difference in terms of LLVM's output.</p>
<p>But in general, priorities are kinda weird action-at-a-distance, and they can impede ISLE optimizations.</p>
</blockquote>



<a name="359487065"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%236412%20x64%3A%20Update%20all%20feature%20tests%20to%20pure.../near/359487065" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.236412.20x64.3A.20Update.20all.20feature.20tests.20to.20pure.2E.2E.2E.html#359487065">(May 18 2023 at 20:08)</a>:</h4>
<p>fitzgen merged <a href="https://github.com/bytecodealliance/wasmtime/pull/6412">PR #6412</a>.</p>



<a name="359501170"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%236412%20x64%3A%20Update%20all%20feature%20tests%20to%20pure.../near/359501170" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.236412.20x64.3A.20Update.20all.20feature.20tests.20to.20pure.2E.2E.2E.html#359501170">(May 18 2023 at 21:30)</a>:</h4>
<p>alexcrichton created <a href="https://github.com/bytecodealliance/wasmtime/pull/6412#discussion_r1198325544">PR review comment</a>:</p>
<blockquote>
<p>Ah true! I did this as a drive-by fix since this was the only location (plus one other here in this PR) that explicitly matched <code>$false</code> where all other locations which have feature-specific lowerings only match on <code>$true</code>. Do you know how hard it would be to remove the need for priorities here? For example something like auto-prioritizing "some <code>if-let</code>" over "no <code>if-let</code>" and then requiring an explicit priority if two rules have <code>if-let</code>? Basically some way to automatically handle this case with good codegen and no priorities.</p>
</blockquote>



<a name="359512951"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%236412%20x64%3A%20Update%20all%20feature%20tests%20to%20pure.../near/359512951" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.236412.20x64.3A.20Update.20all.20feature.20tests.20to.20pure.2E.2E.2E.html#359512951">(May 18 2023 at 22:59)</a>:</h4>
<p>jameysharp created <a href="https://github.com/bytecodealliance/wasmtime/pull/6412#discussion_r1198377864">PR review comment</a>:</p>
<blockquote>
<p>ISLE used to treat more "specific" rules as implicitly higher priority, but we've been moving away from this kind of implicit priority scheme because it was hard for rule authors to reason about. We have all the code needed to implement it in ISLE if we wanted to, though; it's just an application of the subset-overlap check.</p>
<p>If you use <code>if-let</code> in both rules, matching against <code>$true</code> and <code>$false</code> explicitly, you'll get good codegen without priorities, and the overlap check will understand that the two rules are mutually exclusive. But as I said that's a little unfortunate here where the <code>$false</code> case would still be correct if the <code>$true</code> case is removed. So maybe this is just fine as-is.</p>
</blockquote>



<a name="359674289"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%236412%20x64%3A%20Update%20all%20feature%20tests%20to%20pure.../near/359674289" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.236412.20x64.3A.20Update.20all.20feature.20tests.20to.20pure.2E.2E.2E.html#359674289">(May 19 2023 at 14:12)</a>:</h4>
<p>alexcrichton created <a href="https://github.com/bytecodealliance/wasmtime/pull/6412#discussion_r1199012240">PR review comment</a>:</p>
<blockquote>
<p>Yeah I realize the implicit priority scheme had its own issues but my hope was that "zero <code>if-let</code>" vs "one or more <code>if-let</code>" is pretty clear in terms of priority to not need an explicit disambiguation. So not the full "which <code>if-let</code> is more specific", just a zero-vs-nonzero check. My hope is that the idiom of "write a rule with <code>if-let</code>" ideally wouldn't require explicit priorities and could be handled in the common case because it's nice to not have to update all other lowerings when a more explicit one is added.<br>
</p>
</blockquote>



<hr><p>Last updated: Jan 20 2025 at 06:04 UTC</p>
</html>