<html>
<head><meta charset="utf-8"><title>wasmtime / PR #5460 support select_spectre_guard and sele... · git-wasmtime · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/index.html">git-wasmtime</a></h2>
<h3>Topic: <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.235460.20support.20select_spectre_guard.20and.20sele.2E.2E.2E.html">wasmtime / PR #5460 support select_spectre_guard and sele...</a></h3>

<hr>

<base href="https://bytecodealliance.zulipchat.com">

<head><link href="https://bytecodealliance.github.io/zulip-archive/style.css" rel="stylesheet"></head>

<a name="316353828"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%235460%20support%20select_spectre_guard%20and%20sele.../near/316353828" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.235460.20support.20select_spectre_guard.20and.20sele.2E.2E.2E.html#316353828">(Dec 16 2022 at 20:26)</a>:</h4>
<p>cfallin edited <a href="https://github.com/bytecodealliance/wasmtime/pull/5460">PR #5460</a> from <code>x64-select-spectre-guard-i128</code> to <code>main</code>:</p>
<blockquote>
<p>Fixes #5452.</p>
<p>&lt;!--</p>
<p>Please ensure that the following steps are all taken care of before submitting<br>
the PR.</p>
<ul>
<li>
<p>[ ] This has been discussed in issue #..., or if not, please tell us why<br>
  here.</p>
</li>
<li>
<p>[ ] A short description of what this does, why it is needed; if the<br>
  description becomes long, the matter should probably be discussed in an issue<br>
  first.</p>
</li>
<li>
<p>[ ] This PR contains test cases, if meaningful.</p>
</li>
<li>[ ] A reviewer from the core maintainer team has been assigned for this PR.<br>
  If you don't know who could review this, please indicate so. The list of<br>
  suggested reviewers on the right can help you.</li>
</ul>
<p>Please ensure all communication adheres to the <a href="https://github.com/bytecodealliance/wasmtime/blob/master/CODE_OF_CONDUCT.md">code of
conduct</a>.<br>
--&gt;<br>
</p>
</blockquote>



<a name="316353889"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%235460%20support%20select_spectre_guard%20and%20sele.../near/316353889" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.235460.20support.20select_spectre_guard.20and.20sele.2E.2E.2E.html#316353889">(Dec 16 2022 at 20:27)</a>:</h4>
<p>cfallin edited <a href="https://github.com/bytecodealliance/wasmtime/pull/5460">PR #5460</a> from <code>x64-select-spectre-guard-i128</code> to <code>main</code>:</p>
<blockquote>
<p>Fixes #5452.<br>
Fixes #5453.</p>
<p>On riscv64, there is apparently an autoconversion from <code>ValueRegs</code> to<br>
<code>Reg</code> that takes just the low register [0], and removing this conversion<br>
causes 48 errors. As a result of this, <code>select</code> with an <code>i128</code> condition<br>
was silently miscompiling, testing only the low 64 bits. We should<br>
remove this autoconversion to ensure we aren't missing any other silent<br>
truncations, but for now this PR just adds the explicit <code>I128</code> logic for<br>
<code>select</code> / <code>select_spectre_guard</code>.</p>
<p>[0] <a href="https://github.com/bytecodealliance/wasmtime/blob/d9fdbfd50e653f93403405e4c4fd56cb77d034ae/cranelift/codegen/src/isa/riscv64/inst.isle#L1762">https://github.com/bytecodealliance/wasmtime/blob/d9fdbfd50e653f93403405e4c4fd56cb77d034ae/cranelift/codegen/src/isa/riscv64/inst.isle#L1762</a></p>
</blockquote>



<a name="316353915"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%235460%20support%20select_spectre_guard%20and%20sele.../near/316353915" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.235460.20support.20select_spectre_guard.20and.20sele.2E.2E.2E.html#316353915">(Dec 16 2022 at 20:27)</a>:</h4>
<p>cfallin submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/5460#pullrequestreview-1221419319">PR review</a>.</p>



<a name="316353916"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%235460%20support%20select_spectre_guard%20and%20sele.../near/316353916" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.235460.20support.20select_spectre_guard.20and.20sele.2E.2E.2E.html#316353916">(Dec 16 2022 at 20:27)</a>:</h4>
<p>cfallin created <a href="https://github.com/bytecodealliance/wasmtime/pull/5460#discussion_r1051130678">PR review comment</a>:</p>
<blockquote>
<p>Updated!</p>
</blockquote>



<a name="316355866"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%235460%20support%20select_spectre_guard%20and%20sele.../near/316355866" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.235460.20support.20select_spectre_guard.20and.20sele.2E.2E.2E.html#316355866">(Dec 16 2022 at 20:40)</a>:</h4>
<p>jameysharp submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/5460#pullrequestreview-1221426187">PR review</a>.</p>



<a name="316355867"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%235460%20support%20select_spectre_guard%20and%20sele.../near/316355867" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.235460.20support.20select_spectre_guard.20and.20sele.2E.2E.2E.html#316355867">(Dec 16 2022 at 20:40)</a>:</h4>
<p>jameysharp submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/5460#pullrequestreview-1221426187">PR review</a>.</p>



<a name="316355868"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%235460%20support%20select_spectre_guard%20and%20sele.../near/316355868" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.235460.20support.20select_spectre_guard.20and.20sele.2E.2E.2E.html#316355868">(Dec 16 2022 at 20:40)</a>:</h4>
<p>jameysharp created <a href="https://github.com/bytecodealliance/wasmtime/pull/5460#discussion_r1051135606">PR review comment</a>:</p>
<blockquote>
<p>If I'm not mistaken, I think you're fixing #5200 as well here.</p>
</blockquote>



<a name="316355869"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%235460%20support%20select_spectre_guard%20and%20sele.../near/316355869" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.235460.20support.20select_spectre_guard.20and.20sele.2E.2E.2E.html#316355869">(Dec 16 2022 at 20:40)</a>:</h4>
<p>jameysharp created <a href="https://github.com/bytecodealliance/wasmtime/pull/5460#discussion_r1051135233">PR review comment</a>:</p>
<blockquote>
<p>If I'm not mistaken, I think you're fixing #5199 as well here.</p>
</blockquote>



<a name="316356964"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%235460%20support%20select_spectre_guard%20and%20sele.../near/316356964" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.235460.20support.20select_spectre_guard.20and.20sele.2E.2E.2E.html#316356964">(Dec 16 2022 at 20:47)</a>:</h4>
<p>cfallin updated <a href="https://github.com/bytecodealliance/wasmtime/pull/5460">PR #5460</a> from <code>x64-select-spectre-guard-i128</code> to <code>main</code>.</p>



<a name="316357002"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%235460%20support%20select_spectre_guard%20and%20sele.../near/316357002" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.235460.20support.20select_spectre_guard.20and.20sele.2E.2E.2E.html#316357002">(Dec 16 2022 at 20:47)</a>:</h4>
<p>cfallin edited <a href="https://github.com/bytecodealliance/wasmtime/pull/5460">PR #5460</a> from <code>x64-select-spectre-guard-i128</code> to <code>main</code>:</p>
<blockquote>
<p>Fixes #5199.<br>
Fixes #5200.<br>
Fixes #5452.<br>
Fixes #5453.</p>
<p>On riscv64, there is apparently an autoconversion from <code>ValueRegs</code> to<br>
<code>Reg</code> that takes just the low register [0], and removing this conversion<br>
causes 48 errors. As a result of this, <code>select</code> with an <code>i128</code> condition<br>
was silently miscompiling, testing only the low 64 bits. We should<br>
remove this autoconversion to ensure we aren't missing any other silent<br>
truncations, but for now this PR just adds the explicit <code>I128</code> logic for<br>
<code>select</code> / <code>select_spectre_guard</code>.</p>
<p>[0] <a href="https://github.com/bytecodealliance/wasmtime/blob/d9fdbfd50e653f93403405e4c4fd56cb77d034ae/cranelift/codegen/src/isa/riscv64/inst.isle#L1762">https://github.com/bytecodealliance/wasmtime/blob/d9fdbfd50e653f93403405e4c4fd56cb77d034ae/cranelift/codegen/src/isa/riscv64/inst.isle#L1762</a></p>
</blockquote>



<a name="316357013"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%235460%20support%20select_spectre_guard%20and%20sele.../near/316357013" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.235460.20support.20select_spectre_guard.20and.20sele.2E.2E.2E.html#316357013">(Dec 16 2022 at 20:47)</a>:</h4>
<p>cfallin submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/5460#pullrequestreview-1221445974">PR review</a>.</p>



<a name="316357014"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%235460%20support%20select_spectre_guard%20and%20sele.../near/316357014" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.235460.20support.20select_spectre_guard.20and.20sele.2E.2E.2E.html#316357014">(Dec 16 2022 at 20:47)</a>:</h4>
<p>cfallin created <a href="https://github.com/bytecodealliance/wasmtime/pull/5460#discussion_r1051142376">PR review comment</a>:</p>
<blockquote>
<p>Updated!</p>
</blockquote>



<a name="316357019"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%235460%20support%20select_spectre_guard%20and%20sele.../near/316357019" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.235460.20support.20select_spectre_guard.20and.20sele.2E.2E.2E.html#316357019">(Dec 16 2022 at 20:47)</a>:</h4>
<p>cfallin created <a href="https://github.com/bytecodealliance/wasmtime/pull/5460#discussion_r1051142421">PR review comment</a>:</p>
<blockquote>
<p>Updated description, thanks!</p>
</blockquote>



<a name="316357020"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%235460%20support%20select_spectre_guard%20and%20sele.../near/316357020" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.235460.20support.20select_spectre_guard.20and.20sele.2E.2E.2E.html#316357020">(Dec 16 2022 at 20:47)</a>:</h4>
<p>cfallin submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/5460#pullrequestreview-1221446162">PR review</a>.</p>



<a name="316357156"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%235460%20support%20select_spectre_guard%20and%20sele.../near/316357156" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.235460.20support.20select_spectre_guard.20and.20sele.2E.2E.2E.html#316357156">(Dec 16 2022 at 20:48)</a>:</h4>
<p>jameysharp submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/5460#pullrequestreview-1221447857">PR review</a>.</p>



<a name="316370796"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%235460%20support%20select_spectre_guard%20and%20sele.../near/316370796" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.235460.20support.20select_spectre_guard.20and.20sele.2E.2E.2E.html#316370796">(Dec 16 2022 at 22:18)</a>:</h4>
<p>cfallin merged <a href="https://github.com/bytecodealliance/wasmtime/pull/5460">PR #5460</a>.</p>



<hr><p>Last updated: Jan 20 2025 at 06:04 UTC</p>
</html>