<html>
<head><meta charset="utf-8"><title>wasmtime / PR #4347 Implement `canon lower` of a `canon l... · git-wasmtime · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/index.html">git-wasmtime</a></h2>
<h3>Topic: <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.234347.20Implement.20.60canon.20lower.60.20of.20a.20.60canon.20l.2E.2E.2E.html">wasmtime / PR #4347 Implement `canon lower` of a `canon l...</a></h3>

<hr>

<base href="https://bytecodealliance.zulipchat.com">

<head><link href="https://bytecodealliance.github.io/zulip-archive/style.css" rel="stylesheet"></head>

<a name="287762429"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%234347%20Implement%20%60canon%20lower%60%20of%20a%20%60canon%20l.../near/287762429" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.234347.20Implement.20.60canon.20lower.60.20of.20a.20.60canon.20l.2E.2E.2E.html#287762429">(Jun 28 2022 at 19:11)</a>:</h4>
<p>alexcrichton opened <a href="https://github.com/bytecodealliance/wasmtime/pull/4347">PR #4347</a> from <code>component-lift-then-lower</code> to <code>main</code>:</p>
<blockquote>
<p>This commit implements the "degenerate" logic for implementing a<br>
function within a component that is lifted and then immediately lowered<br>
again. In this situation the lowered function will immediately generate<br>
a trap and doesn't need to implement anything else.</p>
<p>The implementation in this commit is somewhat heavyweight but I think is<br>
probably justified moreso in future additions to the component model<br>
rather than what exactly is here right now. It's not expected that this<br>
"always trap" functionality will really be used all that often since it<br>
would generally mean a buggy component, but the functionality plumbed<br>
through here is hopefully going to be useful for implementing<br>
component-to-component adapter trampolines.</p>
<p>Specifically this commit implements a strategy where the <code>canon.lower</code>'d<br>
function is generated by Cranelift and simply has a single trap<br>
instruction when called, doing nothing else. The main complexity comes<br>
from juggling around all the data associated with these functions,<br>
primarily plumbing through the traps into the <code>ModuleRegistry</code> to<br>
ensure that the global <code>is_wasm_trap_pc</code> function returns <code>true</code> and at<br>
runtime when we lookup information about the trap it's all readily<br>
available (e.g. translating the trapping pc to a <code>TrapCode</code>).</p>
<p>&lt;!--</p>
<p>Please ensure that the following steps are all taken care of before submitting<br>
the PR.</p>
<ul>
<li>
<p>[ ] This has been discussed in issue #..., or if not, please tell us why<br>
  here.</p>
</li>
<li>
<p>[ ] A short description of what this does, why it is needed; if the<br>
  description becomes long, the matter should probably be discussed in an issue<br>
  first.</p>
</li>
<li>
<p>[ ] This PR contains test cases, if meaningful.</p>
</li>
<li>[ ] A reviewer from the core maintainer team has been assigned for this PR.<br>
  If you don't know who could review this, please indicate so. The list of<br>
  suggested reviewers on the right can help you.</li>
</ul>
<p>Please ensure all communication adheres to the <a href="https://github.com/bytecodealliance/wasmtime/blob/master/CODE_OF_CONDUCT.md">code of
conduct</a>.<br>
--&gt;<br>
</p>
</blockquote>



<a name="287762432"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%234347%20Implement%20%60canon%20lower%60%20of%20a%20%60canon%20l.../near/287762432" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.234347.20Implement.20.60canon.20lower.60.20of.20a.20.60canon.20l.2E.2E.2E.html#287762432">(Jun 28 2022 at 19:11)</a>:</h4>
<p><strong>alexcrichton</strong> requested <a href="https://github.com/fitzgen">fitzgen</a> for a review on <a href="https://github.com/bytecodealliance/wasmtime/pull/4347">PR #4347</a>.</p>



<a name="287764554"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%234347%20Implement%20%60canon%20lower%60%20of%20a%20%60canon%20l.../near/287764554" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.234347.20Implement.20.60canon.20lower.60.20of.20a.20.60canon.20l.2E.2E.2E.html#287764554">(Jun 28 2022 at 19:28)</a>:</h4>
<p>alexcrichton updated <a href="https://github.com/bytecodealliance/wasmtime/pull/4347">PR #4347</a> from <code>component-lift-then-lower</code> to <code>main</code>.</p>



<a name="287773679"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%234347%20Implement%20%60canon%20lower%60%20of%20a%20%60canon%20l.../near/287773679" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.234347.20Implement.20.60canon.20lower.60.20of.20a.20.60canon.20l.2E.2E.2E.html#287773679">(Jun 28 2022 at 20:47)</a>:</h4>
<p>alexcrichton updated <a href="https://github.com/bytecodealliance/wasmtime/pull/4347">PR #4347</a> from <code>component-lift-then-lower</code> to <code>main</code>.</p>



<a name="287783279"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%234347%20Implement%20%60canon%20lower%60%20of%20a%20%60canon%20l.../near/287783279" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.234347.20Implement.20.60canon.20lower.60.20of.20a.20.60canon.20l.2E.2E.2E.html#287783279">(Jun 28 2022 at 22:15)</a>:</h4>
<p>fitzgen submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/4347#pullrequestreview-1022515455">PR review</a>.</p>



<a name="287783280"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%234347%20Implement%20%60canon%20lower%60%20of%20a%20%60canon%20l.../near/287783280" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.234347.20Implement.20.60canon.20lower.60.20of.20a.20.60canon.20l.2E.2E.2E.html#287783280">(Jun 28 2022 at 22:15)</a>:</h4>
<p>fitzgen submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/4347#pullrequestreview-1022515455">PR review</a>.</p>



<a name="287783281"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%234347%20Implement%20%60canon%20lower%60%20of%20a%20%60canon%20l.../near/287783281" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.234347.20Implement.20.60canon.20lower.60.20of.20a.20.60canon.20l.2E.2E.2E.html#287783281">(Jun 28 2022 at 22:15)</a>:</h4>
<p>fitzgen created <a href="https://github.com/bytecodealliance/wasmtime/pull/4347#discussion_r909036675">PR review comment</a>:</p>
<blockquote>
<p>I guess this is a pretty rare edge case, most components will have zero, not somthing we need to worry about optimizing.</p>
</blockquote>



<a name="287783282"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%234347%20Implement%20%60canon%20lower%60%20of%20a%20%60canon%20l.../near/287783282" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.234347.20Implement.20.60canon.20lower.60.20of.20a.20.60canon.20l.2E.2E.2E.html#287783282">(Jun 28 2022 at 22:15)</a>:</h4>
<p>fitzgen created <a href="https://github.com/bytecodealliance/wasmtime/pull/4347#discussion_r909027786">PR review comment</a>:</p>
<blockquote>
<p>Can we compile a single always-trap function per signature?</p>
</blockquote>



<a name="287869614"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%234347%20Implement%20%60canon%20lower%60%20of%20a%20%60canon%20l.../near/287869614" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.234347.20Implement.20.60canon.20lower.60.20of.20a.20.60canon.20l.2E.2E.2E.html#287869614">(Jun 29 2022 at 15:12)</a>:</h4>
<p>alexcrichton submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/4347#pullrequestreview-1023561356">PR review</a>.</p>



<a name="287869615"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%234347%20Implement%20%60canon%20lower%60%20of%20a%20%60canon%20l.../near/287869615" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.234347.20Implement.20.60canon.20lower.60.20of.20a.20.60canon.20l.2E.2E.2E.html#287869615">(Jun 29 2022 at 15:12)</a>:</h4>
<p>alexcrichton created <a href="https://github.com/bytecodealliance/wasmtime/pull/4347#discussion_r910073502">PR review comment</a>:</p>
<blockquote>
<p>Nah yeah that makes sense and is easy enough to do. I've added deduplication at the "inliner" layer so byt the time it reaches the compilation in cranelift everything is already deduplicated.</p>
</blockquote>



<a name="287875486"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%234347%20Implement%20%60canon%20lower%60%20of%20a%20%60canon%20l.../near/287875486" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.234347.20Implement.20.60canon.20lower.60.20of.20a.20.60canon.20l.2E.2E.2E.html#287875486">(Jun 29 2022 at 15:48)</a>:</h4>
<p>alexcrichton updated <a href="https://github.com/bytecodealliance/wasmtime/pull/4347">PR #4347</a> from <code>component-lift-then-lower</code> to <code>main</code>.</p>



<a name="287875494"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%234347%20Implement%20%60canon%20lower%60%20of%20a%20%60canon%20l.../near/287875494" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.234347.20Implement.20.60canon.20lower.60.20of.20a.20.60canon.20l.2E.2E.2E.html#287875494">(Jun 29 2022 at 15:48)</a>:</h4>
<p>alexcrichton has enabled auto merge for <a href="https://github.com/bytecodealliance/wasmtime/pull/4347">PR #4347</a>.</p>



<a name="287882680"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%234347%20Implement%20%60canon%20lower%60%20of%20a%20%60canon%20l.../near/287882680" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.234347.20Implement.20.60canon.20lower.60.20of.20a.20.60canon.20l.2E.2E.2E.html#287882680">(Jun 29 2022 at 16:35)</a>:</h4>
<p>alexcrichton merged <a href="https://github.com/bytecodealliance/wasmtime/pull/4347">PR #4347</a>.</p>



<hr><p>Last updated: Jan 20 2025 at 06:04 UTC</p>
</html>