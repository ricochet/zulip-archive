<html>
<head><meta charset="utf-8"><title>wasmtime / issue #5111 Add Config::fuel_cost to customize... · git-wasmtime · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/index.html">git-wasmtime</a></h2>
<h3>Topic: <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.235111.20Add.20Config.3A.3Afuel_cost.20to.20customize.2E.2E.2E.html">wasmtime / issue #5111 Add Config::fuel_cost to customize...</a></h3>

<hr>

<base href="https://bytecodealliance.zulipchat.com">

<head><link href="https://bytecodealliance.github.io/zulip-archive/style.css" rel="stylesheet"></head>

<a name="305926566"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%235111%20Add%20Config%3A%3Afuel_cost%20to%20customize.../near/305926566" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.235111.20Add.20Config.3A.3Afuel_cost.20to.20customize.2E.2E.2E.html#305926566">(Oct 24 2022 at 22:52)</a>:</h4>
<p>github-actions[bot] <a href="https://github.com/bytecodealliance/wasmtime/pull/5111#issuecomment-1289731878">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/5111">issue #5111</a>:</p>
<blockquote>
<h4>Subscribe to Label Action</h4>
<p>cc @peterhuene</p>
<p>&lt;details&gt;<br>
This issue or pull request has been labeled: "wasmtime:api", "wasmtime:config"</p>
<p>Thus the following users have been cc'd because of the following labels:</p>
<ul>
<li>peterhuene: wasmtime:api</li>
</ul>
<p>To subscribe or unsubscribe from this label, edit the &lt;code&gt;.github/subscribe-to-label.json&lt;/code&gt; configuration file.</p>
<p><a href="https://github.com/bytecodealliance/subscribe-to-label-action">Learn more.</a><br>
&lt;/details&gt;</p>
</blockquote>



<a name="305926579"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%235111%20Add%20Config%3A%3Afuel_cost%20to%20customize.../near/305926579" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.235111.20Add.20Config.3A.3Afuel_cost.20to.20customize.2E.2E.2E.html#305926579">(Oct 24 2022 at 22:52)</a>:</h4>
<p>github-actions[bot] <a href="https://github.com/bytecodealliance/wasmtime/pull/5111#issuecomment-1289732019">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/5111">issue #5111</a>:</p>
<blockquote>
<h4>Label Messager: wasmtime:config</h4>
<p>It looks like you are changing Wasmtime's configuration options. Make sure to<br>
complete this check list:</p>
<ul>
<li>
<p>[ ] If you added a new <code>Config</code> method, you wrote extensive documentation for<br>
      it.</p>
<p>&lt;details&gt;</p>
<p>Our documentation should be of the following form:</p>
<p>```text<br>
Short, simple summary sentence.</p>
<p>More details. These details can be multiple paragraphs. There should be<br>
information about not just the method, but its parameters and results as<br>
well.</p>
<p>Is this method fallible? If so, when can it return an error?</p>
<p>Can this method panic? If so, when does it panic?</p>
<h1>Example</h1>
<p>Optional example here.<br>
```</p>
<p>&lt;/details&gt;</p>
</li>
<li>
<p>[ ] If you added a new <code>Config</code> method, or modified an existing one, you<br>
  ensured that this configuration is exercised by the fuzz targets.</p>
<p>&lt;details&gt;</p>
<p>For example, if you expose a new strategy for allocating the next instance<br>
slot inside the pooling allocator, you should ensure that at least one of our<br>
fuzz targets exercises that new strategy.</p>
<p>Often, all that is required of you is to ensure that there is a knob for this<br>
configuration option in [<code>wasmtime_fuzzing::Config</code>][fuzzing-config] (or one<br>
of its nested <code>struct</code>s).</p>
<p>Rarely, this may require authoring a new fuzz target to specifically test this<br>
configuration. See [our docs on fuzzing][fuzzing-docs] for more details.</p>
<p>&lt;/details&gt;</p>
</li>
<li>
<p>[ ] If you are enabling a configuration option by default, make sure that it<br>
  has been fuzzed for at least two weeks before turning it on by default.</p>
</li>
</ul>
<p>[fuzzing-config]: <a href="https://github.com/bytecodealliance/wasmtime/blob/ca0e8d0a1d8cefc0496dba2f77a670571d8fdcab/crates/fuzzing/src/generators.rs#L182-L194">https://github.com/bytecodealliance/wasmtime/blob/ca0e8d0a1d8cefc0496dba2f77a670571d8fdcab/crates/fuzzing/src/generators.rs#L182-L194</a><br>
[fuzzing-docs]: <a href="https://docs.wasmtime.dev/contributing-fuzzing.html">https://docs.wasmtime.dev/contributing-fuzzing.html</a></p>
<hr>
<p>&lt;details&gt;</p>
<p>To modify this label's message, edit the &lt;code&gt;.github/label-messager/wasmtime-config.md&lt;/code&gt; file.</p>
<p>To add new label messages or remove existing label messages, edit the<br>
&lt;code&gt;.github/label-messager.json&lt;/code&gt; configuration file.</p>
<p><a href="https://github.com/bytecodealliance/label-messager-action">Learn more.</a></p>
<p>&lt;/details&gt;</p>
</blockquote>



<a name="306345687"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%235111%20Add%20Config%3A%3Afuel_cost%20to%20customize.../near/306345687" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.235111.20Add.20Config.3A.3Afuel_cost.20to.20customize.2E.2E.2E.html#306345687">(Oct 26 2022 at 22:43)</a>:</h4>
<p>coolreader18 <a href="https://github.com/bytecodealliance/wasmtime/pull/5111#issuecomment-1292743214">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/5111">issue #5111</a>:</p>
<blockquote>
<p>Hmm, should I use saturating_add for adding <code>self.fuel_cost += fuel_cost()</code>? An overflow there would probably be bad, I assume.</p>
</blockquote>



<a name="306657864"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%235111%20Add%20Config%3A%3Afuel_cost%20to%20customize.../near/306657864" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.235111.20Add.20Config.3A.3Afuel_cost.20to.20customize.2E.2E.2E.html#306657864">(Oct 28 2022 at 13:36)</a>:</h4>
<p>pepyakin <a href="https://github.com/bytecodealliance/wasmtime/pull/5111#issuecomment-1295010512">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/5111">issue #5111</a>:</p>
<blockquote>
<p>I wonder how this interacts with the AOT compilation.</p>
<p>Consider that the user creates the engine with a specific fuel cost function, then loads a module, and then serializes it into a file.</p>
<p>Then, perhaps in another version of the program, changes the fuel cost function and loads the previously serialized module. However, the fuel behavior that the loaded module exhibits will be different from the configured fuel costs. I would argue that this is an unexpected behavior. At the very least, I would expect to get an error during the module loading.</p>
<p>To do so, the metadata for the compiled artifact should embed the module costs, but that's not really possible with a closure. </p>
<p>It seems to me that the costs schedule would better be represented, <em>conceptually</em>, by a <code>BTreeMap&lt;Opcode, u32&gt;</code>. That way, you could serialize and embed them into the compiled artifact.</p>
</blockquote>



<a name="307126715"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%235111%20Add%20Config%3A%3Afuel_cost%20to%20customize.../near/307126715" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.235111.20Add.20Config.3A.3Afuel_cost.20to.20customize.2E.2E.2E.html#307126715">(Oct 31 2022 at 14:49)</a>:</h4>
<p>alexcrichton <a href="https://github.com/bytecodealliance/wasmtime/pull/5111#issuecomment-1297204170">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/5111">issue #5111</a>:</p>
<blockquote>
<p>Thanks for the PR here! Could you expand a bit more on the use case that you're envisioning for this? This is a pretty low-level degree of control to give from an embedding API around fuel and feels like a relatively large addition with the enum addition here (not that there's a better way to model this that I know of). I'm curious though if there's perhaps an alternative solution which doesn't expose such low-level control of the fuel costs, but there may not be.</p>
<p>I would also be slightly concerned about the AOT-story here since in theory the costs all need to be equivalent, but that can also be "patched" by returning an error and disabling serialization if this <code>Config</code> field is configured.</p>
</blockquote>



<a name="307358029"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%235111%20Add%20Config%3A%3Afuel_cost%20to%20customize.../near/307358029" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.235111.20Add.20Config.3A.3Afuel_cost.20to.20customize.2E.2E.2E.html#307358029">(Nov 01 2022 at 16:58)</a>:</h4>
<p>coolreader18 <a href="https://github.com/bytecodealliance/wasmtime/pull/5111#issuecomment-1298833597">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/5111">issue #5111</a>:</p>
<blockquote>
<p>Oh, I missed that <code>Module::deserialize</code> checks that the engine configs are the same; those are good points about AOT. Maybe <code>fuel_cost()</code> could take a data structure like rust-unic's <a href="https://docs.rs/unic-char-property/0.9.0/unic_char_property/tables/enum.CharDataTable.html"><code>CharDataTable</code></a> or something.</p>
<p>In any case, the motivating use case was switching an existing runtime from wasmer, which has cost customization by default as part of its metering instrumentation and so we were utilizing that. I suppose it is worth looking into how valuable that actually is, when obviously the wasm doesn't map one-to-one to machine code anyway...</p>
</blockquote>



<a name="307795428"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%235111%20Add%20Config%3A%3Afuel_cost%20to%20customize.../near/307795428" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.235111.20Add.20Config.3A.3Afuel_cost.20to.20customize.2E.2E.2E.html#307795428">(Nov 03 2022 at 17:08)</a>:</h4>
<p>alexcrichton <a href="https://github.com/bytecodealliance/wasmtime/pull/5111#issuecomment-1302419157">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/5111">issue #5111</a>:</p>
<blockquote>
<p>Ok makes sense. I think we could have a compiled representation of the costs but that's somewhat overkill and probably not worth implementing. That's one reason why I was wondering what the purpose was for changing costs because if the default wasn't suitable for your use case one option is to either change the defaults or otherwise have various discrete cost modes which would avoid serializing large maps.</p>
</blockquote>



<a name="308477486"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%235111%20Add%20Config%3A%3Afuel_cost%20to%20customize.../near/308477486" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.235111.20Add.20Config.3A.3Afuel_cost.20to.20customize.2E.2E.2E.html#308477486">(Nov 07 2022 at 21:32)</a>:</h4>
<p>coolreader18 <a href="https://github.com/bytecodealliance/wasmtime/pull/5111#issuecomment-1306224655">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/5111">issue #5111</a>:</p>
<blockquote>
<p>That makes sense, I'll look at sketching out a simpler (configuration-wise) solution to this or probably just reworking fuel usage in our codebase. Thank you for your help!</p>
</blockquote>



<a name="308478724"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%235111%20Add%20Config%3A%3Afuel_cost%20to%20customize.../near/308478724" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.235111.20Add.20Config.3A.3Afuel_cost.20to.20customize.2E.2E.2E.html#308478724">(Nov 07 2022 at 21:41)</a>:</h4>
<p>jameysharp <a href="https://github.com/bytecodealliance/wasmtime/pull/5111#issuecomment-1306236054">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/5111">issue #5111</a>:</p>
<blockquote>
<p>In case you haven't already seen it, I'll mention that Wasmtime's "<a href="https://docs.rs/wasmtime/latest/wasmtime/struct.Config.html#method.epoch_interruption">epoch interruption</a>" may be a good alternative to fuel, depending on what you're using it for. From the documentation:</p>
<blockquote>
<p>In general, epoch-based interruption results in faster execution. This difference is sometimes significant: in some measurements, up to 2-3x. This is because epoch-based interruption does less work: it only watches for a global rarely-changing counter to increment, rather than keeping a local frequently-changing counter and comparing it to a deadline.</p>
<p>Fuel, in contrast, should be used when deterministic yielding or trapping is needed. For example, if it is required that the same function call with the same starting state will always either complete or trap with an out-of-fuel error, deterministically, then fuel with a fixed bound should be used.</p>
</blockquote>
</blockquote>



<hr><p>Last updated: Jan 20 2025 at 06:04 UTC</p>
</html>