<html>
<head><meta charset="utf-8"><title>wasmtime / PR #8590 Wasmtime(pooling allocator): Batch de... · git-wasmtime · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/index.html">git-wasmtime</a></h2>
<h3>Topic: <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.238590.20Wasmtime.28pooling.20allocator.29.3A.20Batch.20de.2E.2E.2E.html">wasmtime / PR #8590 Wasmtime(pooling allocator): Batch de...</a></h3>

<hr>

<base href="https://bytecodealliance.zulipchat.com">

<head><link href="https://bytecodealliance.github.io/zulip-archive/style.css" rel="stylesheet"></head>

<a name="437888856"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%238590%20Wasmtime%28pooling%20allocator%29%3A%20Batch%20de.../near/437888856" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.238590.20Wasmtime.28pooling.20allocator.29.3A.20Batch.20de.2E.2E.2E.html#437888856">(May 09 2024 at 21:22)</a>:</h4>
<p>fitzgen opened <a href="https://github.com/bytecodealliance/wasmtime/pull/8590">PR #8590</a> from <code>fitzgen:decommit-queue</code> to <code>bytecodealliance:main</code>:</p>
<blockquote>
<p>This introduces a <code>DecommitQueue</code> for batching decommits together in the pooling allocator:</p>
<ul>
<li>
<p>Deallocating a memory/table/stack enqueues their associated regions of memory for decommit; it no longer immediately returns the associated slot to the pool's free list. If the queue's length has reached the configured batch size, then we flush the queue by running all the decommits, and finally returning the memory/table/stack slots to their respective pools and free lists.</p>
</li>
<li>
<p>Additionally, if allocating a new memory/table/stack fails because the free list is empty (aka we've reached the max concurrently-allocated limit for this entity) then we fall back to a slow path before propagating the error. This slow path flushes the decommit queue and then retries allocation, hoping that the queue flush reclaimed slots and made them available for this fallback allocation attempt. This involved defining a new <code>PoolConcurrencyLimitError</code> to match on, which is also exposed in the public embedder API.</p>
</li>
</ul>
<p>It is also worth noting that we <em>always</em> use this new decommit queue now. To keep the existing behavior, where e.g. a memory's decommits happen immediately on deallocation, you can use a batch size of one. This effectively disables queuing, forcing all decommits to be flushed immediately.</p>
<p>The default decommit batch size is one.</p>
<p>This commit, with batch size of one, consistently gives me an increase on <code>wasmtime serve</code>'s requests-per-second versus its parent commit, as measured by <code>benches/wasmtime-serve-rps.sh</code>. I get ~39K RPS on this commit compared to ~35K RPS on the parent commit. This is quite puzzling to me. I was expecting no change, and hoping there wouldn't be a regression. I was not expecting a speed up. I cannot explain this result at this time.</p>
<p>&lt;!--<br>
Please make sure you include the following information:</p>
<ul>
<li>
<p>If this work has been discussed elsewhere, please include a link to that<br>
  conversation. If it was discussed in an issue, just mention "issue #...".</p>
</li>
<li>
<p>Explain why this change is needed. If the details are in an issue already,<br>
  this can be brief.</p>
</li>
</ul>
<p>Our development process is documented in the Wasmtime book:<br>
<a href="https://docs.wasmtime.dev/contributing-development-process.html">https://docs.wasmtime.dev/contributing-development-process.html</a></p>
<p>Please ensure all communication follows the code of conduct:<br>
<a href="https://github.com/bytecodealliance/wasmtime/blob/main/CODE_OF_CONDUCT.md">https://github.com/bytecodealliance/wasmtime/blob/main/CODE_OF_CONDUCT.md</a><br>
--&gt;</p>
</blockquote>



<a name="437888862"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%238590%20Wasmtime%28pooling%20allocator%29%3A%20Batch%20de.../near/437888862" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.238590.20Wasmtime.28pooling.20allocator.29.3A.20Batch.20de.2E.2E.2E.html#437888862">(May 09 2024 at 21:22)</a>:</h4>
<p><strong>fitzgen</strong> requested <a href="https://github.com/alexcrichton">alexcrichton</a> for a review on <a href="https://github.com/bytecodealliance/wasmtime/pull/8590">PR #8590</a>.</p>



<a name="437888863"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%238590%20Wasmtime%28pooling%20allocator%29%3A%20Batch%20de.../near/437888863" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.238590.20Wasmtime.28pooling.20allocator.29.3A.20Batch.20de.2E.2E.2E.html#437888863">(May 09 2024 at 21:22)</a>:</h4>
<p><strong>fitzgen</strong> requested <a href="https://github.com/orgs/bytecodealliance/teams/wasmtime-fuzz-reviewers">wasmtime-fuzz-reviewers</a> for a review on <a href="https://github.com/bytecodealliance/wasmtime/pull/8590">PR #8590</a>.</p>



<a name="437888864"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%238590%20Wasmtime%28pooling%20allocator%29%3A%20Batch%20de.../near/437888864" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.238590.20Wasmtime.28pooling.20allocator.29.3A.20Batch.20de.2E.2E.2E.html#437888864">(May 09 2024 at 21:22)</a>:</h4>
<p><strong>fitzgen</strong> requested <a href="https://github.com/orgs/bytecodealliance/teams/wasmtime-core-reviewers">wasmtime-core-reviewers</a> for a review on <a href="https://github.com/bytecodealliance/wasmtime/pull/8590">PR #8590</a>.</p>



<a name="437888865"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%238590%20Wasmtime%28pooling%20allocator%29%3A%20Batch%20de.../near/437888865" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.238590.20Wasmtime.28pooling.20allocator.29.3A.20Batch.20de.2E.2E.2E.html#437888865">(May 09 2024 at 21:22)</a>:</h4>
<p><strong>fitzgen</strong> requested <a href="https://github.com/orgs/bytecodealliance/teams/wasmtime-default-reviewers">wasmtime-default-reviewers</a> for a review on <a href="https://github.com/bytecodealliance/wasmtime/pull/8590">PR #8590</a>.</p>



<a name="437889107"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%238590%20Wasmtime%28pooling%20allocator%29%3A%20Batch%20de.../near/437889107" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.238590.20Wasmtime.28pooling.20allocator.29.3A.20Batch.20de.2E.2E.2E.html#437889107">(May 09 2024 at 21:24)</a>:</h4>
<p>fitzgen updated <a href="https://github.com/bytecodealliance/wasmtime/pull/8590">PR #8590</a>.</p>



<a name="437891209"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%238590%20Wasmtime%28pooling%20allocator%29%3A%20Batch%20de.../near/437891209" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.238590.20Wasmtime.28pooling.20allocator.29.3A.20Batch.20de.2E.2E.2E.html#437891209">(May 09 2024 at 21:41)</a>:</h4>
<p>fitzgen updated <a href="https://github.com/bytecodealliance/wasmtime/pull/8590">PR #8590</a>.</p>



<a name="437894022"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%238590%20Wasmtime%28pooling%20allocator%29%3A%20Batch%20de.../near/437894022" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.238590.20Wasmtime.28pooling.20allocator.29.3A.20Batch.20de.2E.2E.2E.html#437894022">(May 09 2024 at 22:04)</a>:</h4>
<p>alexcrichton submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/8590#pullrequestreview-2048880638">PR review</a>:</p>
<blockquote>
<p>Thanks and looks good! I've got some thoughts on refactorings below, but otherwise can you additionally add some tests that exercise the if-empty-then-flush-and-try-again path? Basically a test that fails if that path isn't there but succeeds if it is.</p>
<blockquote>
<p>This is quite puzzling to me. I was expecting no change, and hoping there wouldn't be a regression. I was not expecting a speed up. I cannot explain this result at this time.</p>
</blockquote>
<p>I think I've seen things to this effect historically where very-close-together <code>madvise</code>s are slightly more optimal sometimes. The theory is that the kernel didn't have a chance to run any other threads between two calls to <code>madvise</code> so the second one can skip IPIs since the kernel dynamically knows that no other cores need to be shot down, but that's only a guess.</p>
</blockquote>



<a name="437894023"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%238590%20Wasmtime%28pooling%20allocator%29%3A%20Batch%20de.../near/437894023" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.238590.20Wasmtime.28pooling.20allocator.29.3A.20Batch.20de.2E.2E.2E.html#437894023">(May 09 2024 at 22:04)</a>:</h4>
<p>alexcrichton submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/8590#pullrequestreview-2048880638">PR review</a>:</p>
<blockquote>
<p>Thanks and looks good! I've got some thoughts on refactorings below, but otherwise can you additionally add some tests that exercise the if-empty-then-flush-and-try-again path? Basically a test that fails if that path isn't there but succeeds if it is.</p>
<blockquote>
<p>This is quite puzzling to me. I was expecting no change, and hoping there wouldn't be a regression. I was not expecting a speed up. I cannot explain this result at this time.</p>
</blockquote>
<p>I think I've seen things to this effect historically where very-close-together <code>madvise</code>s are slightly more optimal sometimes. The theory is that the kernel didn't have a chance to run any other threads between two calls to <code>madvise</code> so the second one can skip IPIs since the kernel dynamically knows that no other cores need to be shot down, but that's only a guess.</p>
</blockquote>



<a name="437894025"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%238590%20Wasmtime%28pooling%20allocator%29%3A%20Batch%20de.../near/437894025" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.238590.20Wasmtime.28pooling.20allocator.29.3A.20Batch.20de.2E.2E.2E.html#437894025">(May 09 2024 at 22:04)</a>:</h4>
<p>alexcrichton created <a href="https://github.com/bytecodealliance/wasmtime/pull/8590#discussion_r1596013817">PR review comment</a>:</p>
<blockquote>
<p>Given that this happens under a lock and needs to happen as quickly as possible could this avoid the <code>sysconf</code> on each call?</p>
</blockquote>



<a name="437894027"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%238590%20Wasmtime%28pooling%20allocator%29%3A%20Batch%20de.../near/437894027" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.238590.20Wasmtime.28pooling.20allocator.29.3A.20Batch.20de.2E.2E.2E.html#437894027">(May 09 2024 at 22:04)</a>:</h4>
<p>alexcrichton created <a href="https://github.com/bytecodealliance/wasmtime/pull/8590#discussion_r1596012328">PR review comment</a>:</p>
<blockquote>
<p>Given the size of <code>DecommitQueue</code> can a newtype be made for <code>libc::iovec</code> which has these impls?</p>
</blockquote>



<a name="437894028"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%238590%20Wasmtime%28pooling%20allocator%29%3A%20Batch%20de.../near/437894028" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.238590.20Wasmtime.28pooling.20allocator.29.3A.20Batch.20de.2E.2E.2E.html#437894028">(May 09 2024 at 22:04)</a>:</h4>
<p>alexcrichton created <a href="https://github.com/bytecodealliance/wasmtime/pull/8590#discussion_r1596013012">PR review comment</a>:</p>
<blockquote>
<p>Can this API fail? And if so could <code>batch_size</code> be used as-is?</p>
</blockquote>



<a name="437894029"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%238590%20Wasmtime%28pooling%20allocator%29%3A%20Batch%20de.../near/437894029" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.238590.20Wasmtime.28pooling.20allocator.29.3A.20Batch.20de.2E.2E.2E.html#437894029">(May 09 2024 at 22:04)</a>:</h4>
<p>alexcrichton created <a href="https://github.com/bytecodealliance/wasmtime/pull/8590#discussion_r1596020402">PR review comment</a>:</p>
<blockquote>
<p>Instead of passing around a closure here and in the <code>*_pool.rs</code> files below would you be ok adding a small abstraction which has <code>&amp;mut DecommitQueue</code> internally along with the <code>bool</code> that <code>pooling.rs</code> is tracking?</p>
</blockquote>



<a name="437894030"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%238590%20Wasmtime%28pooling%20allocator%29%3A%20Batch%20de.../near/437894030" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.238590.20Wasmtime.28pooling.20allocator.29.3A.20Batch.20de.2E.2E.2E.html#437894030">(May 09 2024 at 22:04)</a>:</h4>
<p>alexcrichton created <a href="https://github.com/bytecodealliance/wasmtime/pull/8590#discussion_r1596013366">PR review comment</a>:</p>
<blockquote>
<p>This is probably going to need #[cfg] or move into the sys module to handle windows/macos/miri as well</p>
</blockquote>



<a name="437894031"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%238590%20Wasmtime%28pooling%20allocator%29%3A%20Batch%20de.../near/437894031" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.238590.20Wasmtime.28pooling.20allocator.29.3A.20Batch.20de.2E.2E.2E.html#437894031">(May 09 2024 at 22:04)</a>:</h4>
<p>alexcrichton created <a href="https://github.com/bytecodealliance/wasmtime/pull/8590#discussion_r1596022786">PR review comment</a>:</p>
<blockquote>
<p>Could you add a helper method for this? Something like:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="k">fn</span> <span class="nf">allocate_and_maybe_decommit</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span><span class="p">(</span><span class="o">&amp;</span><span class="bp">self</span><span class="p">,</span><span class="w"> </span><span class="n">f</span>: <span class="nc">impl</span><span class="w"> </span><span class="nb">Fn</span><span class="p">()</span><span class="w"> </span>-&gt; <span class="nb">Result</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nb">Result</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="o">..</span><span class="p">.</span><span class="w"> </span><span class="p">}</span>
</code></pre></div>
<p>to avoid copying this in a few places? Also it might be worth having <code>flush_decommit_queue</code> return whether it actually did anything and skip the re-allocate if the flush didn't flush.</p>
</blockquote>



<a name="437894033"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%238590%20Wasmtime%28pooling%20allocator%29%3A%20Batch%20de.../near/437894033" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.238590.20Wasmtime.28pooling.20allocator.29.3A.20Batch.20de.2E.2E.2E.html#437894033">(May 09 2024 at 22:04)</a>:</h4>
<p>alexcrichton created <a href="https://github.com/bytecodealliance/wasmtime/pull/8590#discussion_r1596031131">PR review comment</a>:</p>
<blockquote>
<p>Hm actually on second thought I have a different idea. The duplication in the three deallocate methods in <code>pooling.rs</code> is pretty subtle and feels sort of hard to get right. It also has the subtelty of the <code>Mutex&lt;DeallocationQueue&gt;</code> is held across function calls, such as this one, and it's getting to the point where it's easy to get into issues of lock ordering issues or deadlocks. For example in <code>deallocate_fiber_stack</code> the deallocation queue lock may be held across <code>self.stacks.deallocate</code> which internally acquires a different lock.</p>
<p>This leads me to a different way to model this which might be a bit less error-prone. This <code>decommit</code> argument could be replaced by a structure with <code>SmallVec</code>s inside of it where it's pushed onto. Once this step has completed there's a general method for "clear out this thing with small vectors or, if empty, do the deallocation immediately" or something like that. That would keep the critical section as small as possible while I think also making it a bit clearer how to reuse/shape code using it perhaps?</p>
</blockquote>



<a name="437897170"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%238590%20Wasmtime%28pooling%20allocator%29%3A%20Batch%20de.../near/437897170" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.238590.20Wasmtime.28pooling.20allocator.29.3A.20Batch.20de.2E.2E.2E.html#437897170">(May 09 2024 at 22:34)</a>:</h4>
<p>fitzgen updated <a href="https://github.com/bytecodealliance/wasmtime/pull/8590">PR #8590</a>.</p>



<a name="437898162"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%238590%20Wasmtime%28pooling%20allocator%29%3A%20Batch%20de.../near/437898162" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.238590.20Wasmtime.28pooling.20allocator.29.3A.20Batch.20de.2E.2E.2E.html#437898162">(May 09 2024 at 22:44)</a>:</h4>
<p>jameysharp submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/8590#pullrequestreview-2048955849">PR review</a>.</p>



<a name="437898163"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%238590%20Wasmtime%28pooling%20allocator%29%3A%20Batch%20de.../near/437898163" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.238590.20Wasmtime.28pooling.20allocator.29.3A.20Batch.20de.2E.2E.2E.html#437898163">(May 09 2024 at 22:44)</a>:</h4>
<p>jameysharp created <a href="https://github.com/bytecodealliance/wasmtime/pull/8590#discussion_r1596066043">PR review comment</a>:</p>
<blockquote>
<p>On glibc, <code>sysconf(_SC_IOV_MAX)</code> returns a compile-time constant, so I don't think we should worry about its speed: <a href="https://github.com/bminor/glibc/blob/dd5f891c1ad9f1b43b9db93afe2a55cbb7a6194e/sysdeps/posix/sysconf.c#L412-L418">https://github.com/bminor/glibc/blob/dd5f891c1ad9f1b43b9db93afe2a55cbb7a6194e/sysdeps/posix/sysconf.c#L412-L418</a></p>
</blockquote>



<a name="437909265"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%238590%20Wasmtime%28pooling%20allocator%29%3A%20Batch%20de.../near/437909265" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.238590.20Wasmtime.28pooling.20allocator.29.3A.20Batch.20de.2E.2E.2E.html#437909265">(May 10 2024 at 01:03)</a>:</h4>
<p>github-actions[bot] <a href="https://github.com/bytecodealliance/wasmtime/pull/8590#issuecomment-2103669249">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/8590">PR #8590</a>:</p>
<blockquote>
<h4>Subscribe to Label Action</h4>
<p>cc @fitzgen</p>
<p>&lt;details&gt;<br>
This issue or pull request has been labeled: "fuzzing", "wasmtime:api", "wasmtime:config"</p>
<p>Thus the following users have been cc'd because of the following labels:</p>
<ul>
<li>fitzgen: fuzzing</li>
</ul>
<p>To subscribe or unsubscribe from this label, edit the &lt;code&gt;.github/subscribe-to-label.json&lt;/code&gt; configuration file.</p>
<p><a href="https://github.com/bytecodealliance/subscribe-to-label-action">Learn more.</a><br>
&lt;/details&gt;</p>
</blockquote>



<a name="437909311"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%238590%20Wasmtime%28pooling%20allocator%29%3A%20Batch%20de.../near/437909311" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.238590.20Wasmtime.28pooling.20allocator.29.3A.20Batch.20de.2E.2E.2E.html#437909311">(May 10 2024 at 01:04)</a>:</h4>
<p>github-actions[bot] <a href="https://github.com/bytecodealliance/wasmtime/pull/8590#issuecomment-2103669434">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/8590">PR #8590</a>:</p>
<blockquote>
<h4>Label Messager: wasmtime:config</h4>
<p>It looks like you are changing Wasmtime's configuration options. Make sure to<br>
complete this check list:</p>
<ul>
<li>
<p>[ ] If you added a new <code>Config</code> method, you wrote extensive documentation for<br>
      it.</p>
<p>&lt;details&gt;</p>
<p>Our documentation should be of the following form:</p>
<p>```text<br>
Short, simple summary sentence.</p>
<p>More details. These details can be multiple paragraphs. There should be<br>
information about not just the method, but its parameters and results as<br>
well.</p>
<p>Is this method fallible? If so, when can it return an error?</p>
<p>Can this method panic? If so, when does it panic?</p>
<h1>Example</h1>
<p>Optional example here.<br>
```</p>
<p>&lt;/details&gt;</p>
</li>
<li>
<p>[ ] If you added a new <code>Config</code> method, or modified an existing one, you<br>
  ensured that this configuration is exercised by the fuzz targets.</p>
<p>&lt;details&gt;</p>
<p>For example, if you expose a new strategy for allocating the next instance<br>
slot inside the pooling allocator, you should ensure that at least one of our<br>
fuzz targets exercises that new strategy.</p>
<p>Often, all that is required of you is to ensure that there is a knob for this<br>
configuration option in [<code>wasmtime_fuzzing::Config</code>][fuzzing-config] (or one<br>
of its nested <code>struct</code>s).</p>
<p>Rarely, this may require authoring a new fuzz target to specifically test this<br>
configuration. See [our docs on fuzzing][fuzzing-docs] for more details.</p>
<p>&lt;/details&gt;</p>
</li>
<li>
<p>[ ] If you are enabling a configuration option by default, make sure that it<br>
  has been fuzzed for at least two weeks before turning it on by default.</p>
</li>
</ul>
<p>[fuzzing-config]: <a href="https://github.com/bytecodealliance/wasmtime/blob/ca0e8d0a1d8cefc0496dba2f77a670571d8fdcab/crates/fuzzing/src/generators.rs#L182-L194">https://github.com/bytecodealliance/wasmtime/blob/ca0e8d0a1d8cefc0496dba2f77a670571d8fdcab/crates/fuzzing/src/generators.rs#L182-L194</a><br>
[fuzzing-docs]: <a href="https://docs.wasmtime.dev/contributing-fuzzing.html">https://docs.wasmtime.dev/contributing-fuzzing.html</a></p>
<hr>
<p>&lt;details&gt;</p>
<p>To modify this label's message, edit the &lt;code&gt;.github/label-messager/wasmtime-config.md&lt;/code&gt; file.</p>
<p>To add new label messages or remove existing label messages, edit the<br>
&lt;code&gt;.github/label-messager.json&lt;/code&gt; configuration file.</p>
<p><a href="https://github.com/bytecodealliance/label-messager-action">Learn more.</a></p>
<p>&lt;/details&gt;</p>
</blockquote>



<a name="437948846"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%238590%20Wasmtime%28pooling%20allocator%29%3A%20Batch%20de.../near/437948846" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.238590.20Wasmtime.28pooling.20allocator.29.3A.20Batch.20de.2E.2E.2E.html#437948846">(May 10 2024 at 08:58)</a>:</h4>
<p>jameysharp submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/8590#pullrequestreview-2049641589">PR review</a>.</p>



<a name="437948847"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%238590%20Wasmtime%28pooling%20allocator%29%3A%20Batch%20de.../near/437948847" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.238590.20Wasmtime.28pooling.20allocator.29.3A.20Batch.20de.2E.2E.2E.html#437948847">(May 10 2024 at 08:58)</a>:</h4>
<p>jameysharp created <a href="https://github.com/bytecodealliance/wasmtime/pull/8590#discussion_r1596484061">PR review comment</a>:</p>
<blockquote>
<p>I think the least-code way to do what you're suggesting is to pass an empty <code>DecommitQueue</code> into e.g. <code>image.clear_and_remain_ready</code> and unconditionally call <code>push_memory</code> on it; then pass it to a common method.</p>
<p>That method should check if its raw iovec queue is empty, and if so, immediately flush it, which will call <code>self.memories.deallocate</code> on the only memory pushed into it. Otherwise, take the lock and append its contents to the global <code>DecommitQueue</code>, and then if that queue is full, immediately flush that.</p>
<p>Having the ability to append one <code>DecommitQueue</code> into another might be nice for maintaining thread-local queues or something too, someday.</p>
<p>Also it might make sense to move the <code>batch_size</code> field to <code>PoolingInstanceAllocator</code>. We don't need to check it during <code>enqueue_raw</code>, especially with this proposed change, so we might as well store it alongside all the other data we need access to during flush.</p>
</blockquote>



<a name="437949637"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%238590%20Wasmtime%28pooling%20allocator%29%3A%20Batch%20de.../near/437949637" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.238590.20Wasmtime.28pooling.20allocator.29.3A.20Batch.20de.2E.2E.2E.html#437949637">(May 10 2024 at 09:04)</a>:</h4>
<p>jameysharp submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/8590#pullrequestreview-2049656367">PR review</a>.</p>



<a name="437949638"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%238590%20Wasmtime%28pooling%20allocator%29%3A%20Batch%20de.../near/437949638" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.238590.20Wasmtime.28pooling.20allocator.29.3A.20Batch.20de.2E.2E.2E.html#437949638">(May 10 2024 at 09:04)</a>:</h4>
<p>jameysharp created <a href="https://github.com/bytecodealliance/wasmtime/pull/8590#discussion_r1596493592">PR review comment</a>:</p>
<blockquote>
<p>I gather you're suggesting the closure parameter would be, for example:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="o">||</span><span class="w"> </span><span class="bp">self</span><span class="p">.</span><span class="n">memories</span><span class="p">.</span><span class="n">allocate</span><span class="p">(</span><span class="n">request</span><span class="p">,</span><span class="w"> </span><span class="n">memory_plan</span><span class="p">,</span><span class="w"> </span><span class="n">memory_index</span><span class="p">)</span>
</code></pre></div>
<p>That makes sense to me!</p>
</blockquote>



<a name="438001792"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%238590%20Wasmtime%28pooling%20allocator%29%3A%20Batch%20de.../near/438001792" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.238590.20Wasmtime.28pooling.20allocator.29.3A.20Batch.20de.2E.2E.2E.html#438001792">(May 10 2024 at 15:33)</a>:</h4>
<p>fitzgen submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/8590#pullrequestreview-2050331571">PR review</a>.</p>



<a name="438001793"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%238590%20Wasmtime%28pooling%20allocator%29%3A%20Batch%20de.../near/438001793" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.238590.20Wasmtime.28pooling.20allocator.29.3A.20Batch.20de.2E.2E.2E.html#438001793">(May 10 2024 at 15:33)</a>:</h4>
<p>fitzgen created <a href="https://github.com/bytecodealliance/wasmtime/pull/8590#discussion_r1596906821">PR review comment</a>:</p>
<blockquote>
<p>We have to handle the case where the batch size is larger than <code>IOV_MAX</code> anyways, since a single wasm memory can push two memory regions to decommit and so we can always blow our target batch size. Therefore, I think we should just remove this bit, and allow the batch decommit to break things up into smaller chunks if it must, since it has to have that logic anyways.</p>
</blockquote>



<a name="438002249"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%238590%20Wasmtime%28pooling%20allocator%29%3A%20Batch%20de.../near/438002249" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.238590.20Wasmtime.28pooling.20allocator.29.3A.20Batch.20de.2E.2E.2E.html#438002249">(May 10 2024 at 15:36)</a>:</h4>
<p>fitzgen updated <a href="https://github.com/bytecodealliance/wasmtime/pull/8590">PR #8590</a>.</p>



<a name="438003025"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%238590%20Wasmtime%28pooling%20allocator%29%3A%20Batch%20de.../near/438003025" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.238590.20Wasmtime.28pooling.20allocator.29.3A.20Batch.20de.2E.2E.2E.html#438003025">(May 10 2024 at 15:41)</a>:</h4>
<p>alexcrichton submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/8590#pullrequestreview-2050344516">PR review</a>.</p>



<a name="438003034"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%238590%20Wasmtime%28pooling%20allocator%29%3A%20Batch%20de.../near/438003034" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.238590.20Wasmtime.28pooling.20allocator.29.3A.20Batch.20de.2E.2E.2E.html#438003034">(May 10 2024 at 15:41)</a>:</h4>
<p>alexcrichton created <a href="https://github.com/bytecodealliance/wasmtime/pull/8590#discussion_r1596914681">PR review comment</a>:</p>
<blockquote>
<p>Sounds good to me <span aria-label="+1" class="emoji emoji-1f44d" role="img" title="+1">:+1:</span> </p>
</blockquote>



<a name="438005496"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%238590%20Wasmtime%28pooling%20allocator%29%3A%20Batch%20de.../near/438005496" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.238590.20Wasmtime.28pooling.20allocator.29.3A.20Batch.20de.2E.2E.2E.html#438005496">(May 10 2024 at 15:56)</a>:</h4>
<p>fitzgen updated <a href="https://github.com/bytecodealliance/wasmtime/pull/8590">PR #8590</a>.</p>



<a name="438041728"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%238590%20Wasmtime%28pooling%20allocator%29%3A%20Batch%20de.../near/438041728" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.238590.20Wasmtime.28pooling.20allocator.29.3A.20Batch.20de.2E.2E.2E.html#438041728">(May 10 2024 at 20:26)</a>:</h4>
<p>fitzgen updated <a href="https://github.com/bytecodealliance/wasmtime/pull/8590">PR #8590</a>.</p>



<a name="438052216"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%238590%20Wasmtime%28pooling%20allocator%29%3A%20Batch%20de.../near/438052216" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.238590.20Wasmtime.28pooling.20allocator.29.3A.20Batch.20de.2E.2E.2E.html#438052216">(May 10 2024 at 22:01)</a>:</h4>
<p>fitzgen <a href="https://github.com/bytecodealliance/wasmtime/pull/8590#issuecomment-2105321182">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/8590">PR #8590</a>:</p>
<blockquote>
<p>@alexcrichton I think this is ready for re-review!</p>
</blockquote>



<a name="438053084"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%238590%20Wasmtime%28pooling%20allocator%29%3A%20Batch%20de.../near/438053084" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.238590.20Wasmtime.28pooling.20allocator.29.3A.20Batch.20de.2E.2E.2E.html#438053084">(May 10 2024 at 22:09)</a>:</h4>
<p>fitzgen edited a <a href="https://github.com/bytecodealliance/wasmtime/pull/8590#issuecomment-2103669434">comment</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/8590">PR #8590</a>:</p>
<blockquote>
<h4>Label Messager: wasmtime:config</h4>
<p>It looks like you are changing Wasmtime's configuration options. Make sure to<br>
complete this check list:</p>
<ul>
<li>
<p>[x] If you added a new <code>Config</code> method, you wrote extensive documentation for<br>
      it.</p>
<p>&lt;details&gt;</p>
<p>Our documentation should be of the following form:</p>
<p>```text<br>
Short, simple summary sentence.</p>
<p>More details. These details can be multiple paragraphs. There should be<br>
information about not just the method, but its parameters and results as<br>
well.</p>
<p>Is this method fallible? If so, when can it return an error?</p>
<p>Can this method panic? If so, when does it panic?</p>
<h1>Example</h1>
<p>Optional example here.<br>
```</p>
<p>&lt;/details&gt;</p>
</li>
<li>
<p>[ ] If you added a new <code>Config</code> method, or modified an existing one, you<br>
  ensured that this configuration is exercised by the fuzz targets.</p>
<p>&lt;details&gt;</p>
<p>For example, if you expose a new strategy for allocating the next instance<br>
slot inside the pooling allocator, you should ensure that at least one of our<br>
fuzz targets exercises that new strategy.</p>
<p>Often, all that is required of you is to ensure that there is a knob for this<br>
configuration option in [<code>wasmtime_fuzzing::Config</code>][fuzzing-config] (or one<br>
of its nested <code>struct</code>s).</p>
<p>Rarely, this may require authoring a new fuzz target to specifically test this<br>
configuration. See [our docs on fuzzing][fuzzing-docs] for more details.</p>
<p>&lt;/details&gt;</p>
</li>
<li>
<p>[ ] If you are enabling a configuration option by default, make sure that it<br>
  has been fuzzed for at least two weeks before turning it on by default.</p>
</li>
</ul>
<p>[fuzzing-config]: <a href="https://github.com/bytecodealliance/wasmtime/blob/ca0e8d0a1d8cefc0496dba2f77a670571d8fdcab/crates/fuzzing/src/generators.rs#L182-L194">https://github.com/bytecodealliance/wasmtime/blob/ca0e8d0a1d8cefc0496dba2f77a670571d8fdcab/crates/fuzzing/src/generators.rs#L182-L194</a><br>
[fuzzing-docs]: <a href="https://docs.wasmtime.dev/contributing-fuzzing.html">https://docs.wasmtime.dev/contributing-fuzzing.html</a></p>
<hr>
<p>&lt;details&gt;</p>
<p>To modify this label's message, edit the &lt;code&gt;.github/label-messager/wasmtime-config.md&lt;/code&gt; file.</p>
<p>To add new label messages or remove existing label messages, edit the<br>
&lt;code&gt;.github/label-messager.json&lt;/code&gt; configuration file.</p>
<p><a href="https://github.com/bytecodealliance/label-messager-action">Learn more.</a></p>
<p>&lt;/details&gt;</p>
</blockquote>



<a name="438053088"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%238590%20Wasmtime%28pooling%20allocator%29%3A%20Batch%20de.../near/438053088" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.238590.20Wasmtime.28pooling.20allocator.29.3A.20Batch.20de.2E.2E.2E.html#438053088">(May 10 2024 at 22:09)</a>:</h4>
<p>fitzgen edited a <a href="https://github.com/bytecodealliance/wasmtime/pull/8590#issuecomment-2103669434">comment</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/8590">PR #8590</a>:</p>
<blockquote>
<h4>Label Messager: wasmtime:config</h4>
<p>It looks like you are changing Wasmtime's configuration options. Make sure to<br>
complete this check list:</p>
<ul>
<li>
<p>[x] If you added a new <code>Config</code> method, you wrote extensive documentation for<br>
      it.</p>
<p>&lt;details&gt;</p>
<p>Our documentation should be of the following form:</p>
<p>```text<br>
Short, simple summary sentence.</p>
<p>More details. These details can be multiple paragraphs. There should be<br>
information about not just the method, but its parameters and results as<br>
well.</p>
<p>Is this method fallible? If so, when can it return an error?</p>
<p>Can this method panic? If so, when does it panic?</p>
<h1>Example</h1>
<p>Optional example here.<br>
```</p>
<p>&lt;/details&gt;</p>
</li>
<li>
<p>[x] If you added a new <code>Config</code> method, or modified an existing one, you<br>
  ensured that this configuration is exercised by the fuzz targets.</p>
<p>&lt;details&gt;</p>
<p>For example, if you expose a new strategy for allocating the next instance<br>
slot inside the pooling allocator, you should ensure that at least one of our<br>
fuzz targets exercises that new strategy.</p>
<p>Often, all that is required of you is to ensure that there is a knob for this<br>
configuration option in [<code>wasmtime_fuzzing::Config</code>][fuzzing-config] (or one<br>
of its nested <code>struct</code>s).</p>
<p>Rarely, this may require authoring a new fuzz target to specifically test this<br>
configuration. See [our docs on fuzzing][fuzzing-docs] for more details.</p>
<p>&lt;/details&gt;</p>
</li>
<li>
<p>[ ] If you are enabling a configuration option by default, make sure that it<br>
  has been fuzzed for at least two weeks before turning it on by default.</p>
</li>
</ul>
<p>[fuzzing-config]: <a href="https://github.com/bytecodealliance/wasmtime/blob/ca0e8d0a1d8cefc0496dba2f77a670571d8fdcab/crates/fuzzing/src/generators.rs#L182-L194">https://github.com/bytecodealliance/wasmtime/blob/ca0e8d0a1d8cefc0496dba2f77a670571d8fdcab/crates/fuzzing/src/generators.rs#L182-L194</a><br>
[fuzzing-docs]: <a href="https://docs.wasmtime.dev/contributing-fuzzing.html">https://docs.wasmtime.dev/contributing-fuzzing.html</a></p>
<hr>
<p>&lt;details&gt;</p>
<p>To modify this label's message, edit the &lt;code&gt;.github/label-messager/wasmtime-config.md&lt;/code&gt; file.</p>
<p>To add new label messages or remove existing label messages, edit the<br>
&lt;code&gt;.github/label-messager.json&lt;/code&gt; configuration file.</p>
<p><a href="https://github.com/bytecodealliance/label-messager-action">Learn more.</a></p>
<p>&lt;/details&gt;</p>
</blockquote>



<a name="438053092"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%238590%20Wasmtime%28pooling%20allocator%29%3A%20Batch%20de.../near/438053092" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.238590.20Wasmtime.28pooling.20allocator.29.3A.20Batch.20de.2E.2E.2E.html#438053092">(May 10 2024 at 22:09)</a>:</h4>
<p>fitzgen edited a <a href="https://github.com/bytecodealliance/wasmtime/pull/8590#issuecomment-2103669434">comment</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/8590">PR #8590</a>:</p>
<blockquote>
<h4>Label Messager: wasmtime:config</h4>
<p>It looks like you are changing Wasmtime's configuration options. Make sure to<br>
complete this check list:</p>
<ul>
<li>
<p>[x] If you added a new <code>Config</code> method, you wrote extensive documentation for<br>
      it.</p>
<p>&lt;details&gt;</p>
<p>Our documentation should be of the following form:</p>
<p>```text<br>
Short, simple summary sentence.</p>
<p>More details. These details can be multiple paragraphs. There should be<br>
information about not just the method, but its parameters and results as<br>
well.</p>
<p>Is this method fallible? If so, when can it return an error?</p>
<p>Can this method panic? If so, when does it panic?</p>
<h1>Example</h1>
<p>Optional example here.<br>
```</p>
<p>&lt;/details&gt;</p>
</li>
<li>
<p>[x] If you added a new <code>Config</code> method, or modified an existing one, you<br>
  ensured that this configuration is exercised by the fuzz targets.</p>
<p>&lt;details&gt;</p>
<p>For example, if you expose a new strategy for allocating the next instance<br>
slot inside the pooling allocator, you should ensure that at least one of our<br>
fuzz targets exercises that new strategy.</p>
<p>Often, all that is required of you is to ensure that there is a knob for this<br>
configuration option in [<code>wasmtime_fuzzing::Config</code>][fuzzing-config] (or one<br>
of its nested <code>struct</code>s).</p>
<p>Rarely, this may require authoring a new fuzz target to specifically test this<br>
configuration. See [our docs on fuzzing][fuzzing-docs] for more details.</p>
<p>&lt;/details&gt;</p>
</li>
<li>
<p>[x] If you are enabling a configuration option by default, make sure that it<br>
  has been fuzzed for at least two weeks before turning it on by default.</p>
</li>
</ul>
<p>[fuzzing-config]: <a href="https://github.com/bytecodealliance/wasmtime/blob/ca0e8d0a1d8cefc0496dba2f77a670571d8fdcab/crates/fuzzing/src/generators.rs#L182-L194">https://github.com/bytecodealliance/wasmtime/blob/ca0e8d0a1d8cefc0496dba2f77a670571d8fdcab/crates/fuzzing/src/generators.rs#L182-L194</a><br>
[fuzzing-docs]: <a href="https://docs.wasmtime.dev/contributing-fuzzing.html">https://docs.wasmtime.dev/contributing-fuzzing.html</a></p>
<hr>
<p>&lt;details&gt;</p>
<p>To modify this label's message, edit the &lt;code&gt;.github/label-messager/wasmtime-config.md&lt;/code&gt; file.</p>
<p>To add new label messages or remove existing label messages, edit the<br>
&lt;code&gt;.github/label-messager.json&lt;/code&gt; configuration file.</p>
<p><a href="https://github.com/bytecodealliance/label-messager-action">Learn more.</a></p>
<p>&lt;/details&gt;</p>
</blockquote>



<a name="438057807"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%238590%20Wasmtime%28pooling%20allocator%29%3A%20Batch%20de.../near/438057807" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.238590.20Wasmtime.28pooling.20allocator.29.3A.20Batch.20de.2E.2E.2E.html#438057807">(May 10 2024 at 22:54)</a>:</h4>
<p>alexcrichton submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/8590#pullrequestreview-2050960897">PR review</a>:</p>
<blockquote>
<p>Nice!</p>
</blockquote>



<a name="438068646"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%238590%20Wasmtime%28pooling%20allocator%29%3A%20Batch%20de.../near/438068646" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.238590.20Wasmtime.28pooling.20allocator.29.3A.20Batch.20de.2E.2E.2E.html#438068646">(May 11 2024 at 01:30)</a>:</h4>
<p>jameysharp <a href="https://github.com/bytecodealliance/wasmtime/pull/8590#issuecomment-2105434566">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/8590">PR #8590</a>:</p>
<blockquote>
<p>Looks like the reason CI is failing is that we can only use <code>libc::iovec</code> on <code>cfg(unix)</code>. Elsewhere I guess we should define an alternative <code>struct iovec</code> with the same fields? We need it to match system ABI if we use it in syscalls but on non-Unix (non-Linux, even) any pair of pointer and length will do.</p>
</blockquote>



<a name="438396968"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%238590%20Wasmtime%28pooling%20allocator%29%3A%20Batch%20de.../near/438396968" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.238590.20Wasmtime.28pooling.20allocator.29.3A.20Batch.20de.2E.2E.2E.html#438396968">(May 13 2024 at 16:00)</a>:</h4>
<p>fitzgen updated <a href="https://github.com/bytecodealliance/wasmtime/pull/8590">PR #8590</a>.</p>



<a name="438397029"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%238590%20Wasmtime%28pooling%20allocator%29%3A%20Batch%20de.../near/438397029" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.238590.20Wasmtime.28pooling.20allocator.29.3A.20Batch.20de.2E.2E.2E.html#438397029">(May 13 2024 at 16:01)</a>:</h4>
<p>fitzgen has enabled auto merge for <a href="https://github.com/bytecodealliance/wasmtime/pull/8590">PR #8590</a>.</p>



<a name="438420028"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%238590%20Wasmtime%28pooling%20allocator%29%3A%20Batch%20de.../near/438420028" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.238590.20Wasmtime.28pooling.20allocator.29.3A.20Batch.20de.2E.2E.2E.html#438420028">(May 13 2024 at 18:07)</a>:</h4>
<p>fitzgen updated <a href="https://github.com/bytecodealliance/wasmtime/pull/8590">PR #8590</a>.</p>



<a name="438421435"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%238590%20Wasmtime%28pooling%20allocator%29%3A%20Batch%20de.../near/438421435" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.238590.20Wasmtime.28pooling.20allocator.29.3A.20Batch.20de.2E.2E.2E.html#438421435">(May 13 2024 at 18:16)</a>:</h4>
<p>fitzgen has enabled auto merge for <a href="https://github.com/bytecodealliance/wasmtime/pull/8590">PR #8590</a>.</p>



<a name="438424414"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%238590%20Wasmtime%28pooling%20allocator%29%3A%20Batch%20de.../near/438424414" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.238590.20Wasmtime.28pooling.20allocator.29.3A.20Batch.20de.2E.2E.2E.html#438424414">(May 13 2024 at 18:36)</a>:</h4>
<p>fitzgen updated <a href="https://github.com/bytecodealliance/wasmtime/pull/8590">PR #8590</a>.</p>



<a name="438424436"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%238590%20Wasmtime%28pooling%20allocator%29%3A%20Batch%20de.../near/438424436" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.238590.20Wasmtime.28pooling.20allocator.29.3A.20Batch.20de.2E.2E.2E.html#438424436">(May 13 2024 at 18:36)</a>:</h4>
<p>fitzgen has enabled auto merge for <a href="https://github.com/bytecodealliance/wasmtime/pull/8590">PR #8590</a>.</p>



<a name="438431531"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%238590%20Wasmtime%28pooling%20allocator%29%3A%20Batch%20de.../near/438431531" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.238590.20Wasmtime.28pooling.20allocator.29.3A.20Batch.20de.2E.2E.2E.html#438431531">(May 13 2024 at 19:22)</a>:</h4>
<p>fitzgen updated <a href="https://github.com/bytecodealliance/wasmtime/pull/8590">PR #8590</a>.</p>



<a name="438431557"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%238590%20Wasmtime%28pooling%20allocator%29%3A%20Batch%20de.../near/438431557" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.238590.20Wasmtime.28pooling.20allocator.29.3A.20Batch.20de.2E.2E.2E.html#438431557">(May 13 2024 at 19:22)</a>:</h4>
<p>fitzgen has enabled auto merge for <a href="https://github.com/bytecodealliance/wasmtime/pull/8590">PR #8590</a>.</p>



<a name="438440934"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%238590%20Wasmtime%28pooling%20allocator%29%3A%20Batch%20de.../near/438440934" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.238590.20Wasmtime.28pooling.20allocator.29.3A.20Batch.20de.2E.2E.2E.html#438440934">(May 13 2024 at 20:20)</a>:</h4>
<p>fitzgen updated <a href="https://github.com/bytecodealliance/wasmtime/pull/8590">PR #8590</a>.</p>



<a name="438461358"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%238590%20Wasmtime%28pooling%20allocator%29%3A%20Batch%20de.../near/438461358" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.238590.20Wasmtime.28pooling.20allocator.29.3A.20Batch.20de.2E.2E.2E.html#438461358">(May 13 2024 at 22:31)</a>:</h4>
<p>fitzgen updated <a href="https://github.com/bytecodealliance/wasmtime/pull/8590">PR #8590</a>.</p>



<a name="438472292"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%238590%20Wasmtime%28pooling%20allocator%29%3A%20Batch%20de.../near/438472292" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.238590.20Wasmtime.28pooling.20allocator.29.3A.20Batch.20de.2E.2E.2E.html#438472292">(May 14 2024 at 00:01)</a>:</h4>
<p>fitzgen updated <a href="https://github.com/bytecodealliance/wasmtime/pull/8590">PR #8590</a>.</p>



<a name="438476632"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%238590%20Wasmtime%28pooling%20allocator%29%3A%20Batch%20de.../near/438476632" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.238590.20Wasmtime.28pooling.20allocator.29.3A.20Batch.20de.2E.2E.2E.html#438476632">(May 14 2024 at 00:46)</a>:</h4>
<p>fitzgen merged <a href="https://github.com/bytecodealliance/wasmtime/pull/8590">PR #8590</a>.</p>



<hr><p>Last updated: Jan 20 2025 at 06:04 UTC</p>
</html>