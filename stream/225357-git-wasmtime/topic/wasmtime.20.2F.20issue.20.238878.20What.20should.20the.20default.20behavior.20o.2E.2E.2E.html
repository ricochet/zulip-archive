<html>
<head><meta charset="utf-8"><title>wasmtime / issue #8878 What should the default behavior o... · git-wasmtime · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/index.html">git-wasmtime</a></h2>
<h3>Topic: <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.238878.20What.20should.20the.20default.20behavior.20o.2E.2E.2E.html">wasmtime / issue #8878 What should the default behavior o...</a></h3>

<hr>

<base href="https://bytecodealliance.zulipchat.com">

<head><link href="https://bytecodealliance.github.io/zulip-archive/style.css" rel="stylesheet"></head>

<a name="447333355"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%238878%20What%20should%20the%20default%20behavior%20o.../near/447333355" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.238878.20What.20should.20the.20default.20behavior.20o.2E.2E.2E.html#447333355">(Jun 26 2024 at 20:50)</a>:</h4>
<p>alexcrichton opened <a href="https://github.com/bytecodealliance/wasmtime/issues/8878">issue #8878</a>:</p>
<blockquote>
<p>My changes in <a href="https://github.com/bytecodealliance/wasmtime/pull/8861">https://github.com/bytecodealliance/wasmtime/pull/8861</a> introduced a change in the default behavior of <code>wasmtime serve</code>. Notably this program:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="k">use</span><span class="w"> </span><span class="n">wasi</span><span class="p">::</span><span class="n">http</span><span class="p">::</span><span class="n">types</span><span class="p">::</span><span class="o">*</span><span class="p">;</span>

<span class="k">struct</span><span class="w"> </span><span class="nc">T</span><span class="p">;</span>

<span class="n">wasi</span><span class="p">::</span><span class="n">http</span><span class="p">::</span><span class="n">proxy</span><span class="p">::</span><span class="n">export</span><span class="o">!</span><span class="p">(</span><span class="n">T</span><span class="p">);</span>

<span class="k">impl</span><span class="w"> </span><span class="n">wasi</span><span class="p">::</span><span class="n">exports</span><span class="p">::</span><span class="n">wasi</span><span class="p">::</span><span class="n">http</span><span class="p">::</span><span class="n">incoming_handler</span><span class="p">::</span><span class="n">Guest</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">T</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">fn</span><span class="w"> </span><span class="nf">handle</span><span class="p">(</span><span class="n">request</span><span class="p">:</span><span class="w"> </span><span class="nc">IncomingRequest</span><span class="p">,</span><span class="w"> </span><span class="n">outparam</span><span class="p">:</span><span class="w"> </span><span class="nc">ResponseOutparam</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="fm">println!</span><span class="p">(</span><span class="s">"request.method = {:?}"</span><span class="p">,</span><span class="w"> </span><span class="n">request</span><span class="p">.</span><span class="n">method</span><span class="p">());</span>
<span class="w">        </span><span class="fm">println!</span><span class="p">(</span><span class="s">"request.scheme = {:?}"</span><span class="p">,</span><span class="w"> </span><span class="n">request</span><span class="p">.</span><span class="n">scheme</span><span class="p">());</span>
<span class="w">        </span><span class="fm">println!</span><span class="p">(</span><span class="s">"request.authority = {:?}"</span><span class="p">,</span><span class="w"> </span><span class="n">request</span><span class="p">.</span><span class="n">authority</span><span class="p">());</span>

<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="n">resp</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">OutgoingResponse</span><span class="p">::</span><span class="n">new</span><span class="p">(</span><span class="n">Fields</span><span class="p">::</span><span class="n">new</span><span class="p">());</span>
<span class="w">        </span><span class="n">ResponseOutparam</span><span class="p">::</span><span class="n">set</span><span class="p">(</span><span class="n">outparam</span><span class="p">,</span><span class="w"> </span><span class="nb">Ok</span><span class="p">(</span><span class="n">resp</span><span class="p">));</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
<p><a href="https://github.com/user-attachments/files/15995214/wat.wasm.gz">(compiled component)</a></p>
<p>When run with <code>wasmtime serve</code> and hit with <code>curl http://localhost:8080</code> it prints:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="n">Serving</span><span class="w"> </span><span class="n">HTTP</span><span class="w"> </span><span class="n">on</span><span class="w"> </span><span class="n">http</span><span class="p">:</span><span class="c1">//0.0.0.0:8080/</span>
<span class="n">stdout</span><span class="w"> </span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="w"> </span><span class="p">::</span><span class="w"> </span><span class="nc">request</span><span class="p">.</span><span class="n">method</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Method</span><span class="p">::</span><span class="n">Get</span>
<span class="n">stdout</span><span class="w"> </span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="w"> </span><span class="p">::</span><span class="w"> </span><span class="nc">request</span><span class="p">.</span><span class="n">scheme</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">Some</span><span class="p">(</span><span class="n">Scheme</span><span class="p">::</span><span class="n">Http</span><span class="p">)</span>
<span class="n">stdout</span><span class="w"> </span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="w"> </span><span class="p">::</span><span class="w"> </span><span class="nc">request</span><span class="p">.</span><span class="n">authority</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">Some</span><span class="p">(</span><span class="s">"localhost:8080"</span><span class="p">)</span>
</code></pre></div>
<p>On <code>main</code>, however, it prints</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="n">Serving</span><span class="w"> </span><span class="n">HTTP</span><span class="w"> </span><span class="n">on</span><span class="w"> </span><span class="n">http</span><span class="p">:</span><span class="c1">//0.0.0.0:8080/</span>
<span class="n">stdout</span><span class="w"> </span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="w"> </span><span class="p">::</span><span class="w"> </span><span class="nc">request</span><span class="p">.</span><span class="n">method</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Method</span><span class="p">::</span><span class="n">Get</span>
<span class="n">stdout</span><span class="w"> </span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="w"> </span><span class="p">::</span><span class="w"> </span><span class="nc">request</span><span class="p">.</span><span class="n">scheme</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">None</span>
<span class="n">stdout</span><span class="w"> </span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="w"> </span><span class="p">::</span><span class="w"> </span><span class="nc">request</span><span class="p">.</span><span class="n">authority</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">None</span>
</code></pre></div>
<p>This regression is due to <a href="https://github.com/bytecodealliance/wasmtime/pull/8861/files#diff-7da576f5c8e7ffe1f4d334844eec78ed27e092a9bacdad959a54468904d870b2L414">these changes</a> because I didn't understand what they were doing.</p>
<p>Now why wasn't this caught by the test suite? I tried writing a test for this and it passed, but apparently it's due to our usage of <br>
<code>hyper::Request::builder().uri("http://localhost/")</code> in the test suite. That creates an HTTP requests that looks like:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="n">GET</span><span class="w"> </span><span class="n">http</span><span class="p">:</span><span class="c1">//localhost/ HTTP/1.1</span>
<span class="o">..</span><span class="p">.</span>
</code></pre></div>
<p>where using <code>curl</code> on the command line generates:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="n">GET</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">HTTP</span><span class="o">/</span><span class="mf">1.1</span>
<span class="o">..</span><span class="p">.</span>
</code></pre></div>
<p>That leads me to this issue. What should <code>scheme</code> and <code>authority</code> report in these two cases for <code>wasmtime serve</code> by default? The previous behavior means that <code>GET /</code> could not be distinguished from <code>GET http://localhost/</code> which naively seems like what <code>scheme</code> and <code>authority</code> are trying to map to.</p>
<p>Is the previous behavior of <code>wasmtime serve</code> buggy? Is the current behavior buggy? Should the spec be clarified?</p>
<p>cc @elliottt @pchickey </p>
</blockquote>



<a name="447333887"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%238878%20What%20should%20the%20default%20behavior%20o.../near/447333887" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.238878.20What.20should.20the.20default.20behavior.20o.2E.2E.2E.html#447333887">(Jun 26 2024 at 20:52)</a>:</h4>
<p>alexcrichton <a href="https://github.com/bytecodealliance/wasmtime/issues/8878#issuecomment-2192609107">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/8878">issue #8878</a>:</p>
<blockquote>
<p>I'll note that the difference can be seen with:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="cp">$</span><span class="w"> </span><span class="n">curl</span><span class="w"> </span><span class="o">-</span><span class="n">v</span><span class="w"> </span><span class="o">--</span><span class="n">request</span><span class="o">-</span><span class="n">target</span><span class="w"> </span><span class="n">http</span><span class="p">:</span><span class="c1">//localhost/ http://localhost:8080</span>
</code></pre></div>
<p>vs </p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="cp">$</span><span class="w"> </span><span class="n">curl</span><span class="w"> </span><span class="o">-</span><span class="n">v</span><span class="w"> </span><span class="n">http</span><span class="p">:</span><span class="c1">//localhost:8080</span>
</code></pre></div>
<p>in terms of how the headers are set. The former is basically what our test suite does while the latter is what the <code>curl</code> command line does by default.</p>
</blockquote>



<a name="447340859"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%238878%20What%20should%20the%20default%20behavior%20o.../near/447340859" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.238878.20What.20should.20the.20default.20behavior.20o.2E.2E.2E.html#447340859">(Jun 26 2024 at 21:34)</a>:</h4>
<p>lann <a href="https://github.com/bytecodealliance/wasmtime/issues/8878#issuecomment-2192662391">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/8878">issue #8878</a>:</p>
<blockquote>
<p>The former (full URL in request) is incorrect; that form is only applicable to CONNECT methods.</p>
</blockquote>



<a name="447340906"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%238878%20What%20should%20the%20default%20behavior%20o.../near/447340906" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.238878.20What.20should.20the.20default.20behavior.20o.2E.2E.2E.html#447340906">(Jun 26 2024 at 21:34)</a>:</h4>
<p>lann edited a <a href="https://github.com/bytecodealliance/wasmtime/issues/8878#issuecomment-2192662391">comment</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/8878">issue #8878</a>:</p>
<blockquote>
<p>The former (full URL in first line of the request) is incorrect; that form is only applicable to CONNECT methods.</p>
</blockquote>



<a name="447340937"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%238878%20What%20should%20the%20default%20behavior%20o.../near/447340937" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.238878.20What.20should.20the.20default.20behavior.20o.2E.2E.2E.html#447340937">(Jun 26 2024 at 21:34)</a>:</h4>
<p>lann edited a <a href="https://github.com/bytecodealliance/wasmtime/issues/8878#issuecomment-2192662391">comment</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/8878">issue #8878</a>:</p>
<blockquote>
<p>The former (full URL in first line of the request) is incorrect; that form is only applicable to the CONNECT method and HTTP/1.0 iirc..</p>
</blockquote>



<a name="447340942"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%238878%20What%20should%20the%20default%20behavior%20o.../near/447340942" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.238878.20What.20should.20the.20default.20behavior.20o.2E.2E.2E.html#447340942">(Jun 26 2024 at 21:34)</a>:</h4>
<p>lann edited a <a href="https://github.com/bytecodealliance/wasmtime/issues/8878#issuecomment-2192662391">comment</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/8878">issue #8878</a>:</p>
<blockquote>
<p>The former (full URL in first line of the request) is incorrect; that form is only applicable to the CONNECT method and HTTP/1.0 iirc.</p>
</blockquote>



<a name="447341477"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%238878%20What%20should%20the%20default%20behavior%20o.../near/447341477" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.238878.20What.20should.20the.20default.20behavior.20o.2E.2E.2E.html#447341477">(Jun 26 2024 at 21:39)</a>:</h4>
<p>lann <a href="https://github.com/bytecodealliance/wasmtime/issues/8878#issuecomment-2192670175">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/8878">issue #8878</a>:</p>
<blockquote>
<p>The former (full URL in request) is incorrect; that form is only applicable to CONNECT methods.</p>
<p>Edit: looks like I might be wrong about it being incorrect per se; it might just be very uncommon.</p>
</blockquote>



<a name="447341548"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%238878%20What%20should%20the%20default%20behavior%20o.../near/447341548" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.238878.20What.20should.20the.20default.20behavior.20o.2E.2E.2E.html#447341548">(Jun 26 2024 at 21:39)</a>:</h4>
<p>lann edited a <a href="https://github.com/bytecodealliance/wasmtime/issues/8878#issuecomment-2192670175">comment</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/8878">issue #8878</a>:</p>
<blockquote>
<p>The former (full URL in request) is incorrect; that form is only applicable to CONNECT methods.</p>
<p>Edit: looks like I might be wrong about it being incorrect per se; it might just be very uncommon.</p>
<p><a href="https://www.rfc-editor.org/rfc/rfc2616#section-5.1.2">https://www.rfc-editor.org/rfc/rfc2616#section-5.1.2</a></p>
</blockquote>



<a name="447346274"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%238878%20What%20should%20the%20default%20behavior%20o.../near/447346274" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.238878.20What.20should.20the.20default.20behavior.20o.2E.2E.2E.html#447346274">(Jun 26 2024 at 22:15)</a>:</h4>
<p>alexcrichton <a href="https://github.com/bytecodealliance/wasmtime/issues/8878#issuecomment-2192710598">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/8878">issue #8878</a>:</p>
<blockquote>
<p>That makes sense, and means we should probably update our tests, but I guess I'm also curious still what the behavior here should be. For example why do <code>scheme</code> and <code>authority</code> return an <code>Option</code> at the WIT level? Are they intended to map to this or is it expected that they're effectively always <code>Some</code>?</p>
</blockquote>



<a name="447349943"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%238878%20What%20should%20the%20default%20behavior%20o.../near/447349943" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.238878.20What.20should.20the.20default.20behavior.20o.2E.2E.2E.html#447349943">(Jun 26 2024 at 22:45)</a>:</h4>
<p>lann <a href="https://github.com/bytecodealliance/wasmtime/issues/8878#issuecomment-2192740901">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/8878">issue #8878</a>:</p>
<blockquote>
<p><code>scheme</code> is derived from out of band info: whether the request came in over TLS or not</p>
</blockquote>



<a name="447350326"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%238878%20What%20should%20the%20default%20behavior%20o.../near/447350326" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.238878.20What.20should.20the.20default.20behavior.20o.2E.2E.2E.html#447350326">(Jun 26 2024 at 22:48)</a>:</h4>
<p>lann edited a <a href="https://github.com/bytecodealliance/wasmtime/issues/8878#issuecomment-2192740901">comment</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/8878">issue #8878</a>:</p>
<blockquote>
<p><code>scheme</code> is derived from out of band info: whether the request came in over TLS or not.<br>
<code>authority</code> was optional in http/1.0 which I believe is why hyper makes it optional. I don't know if that is the reason here though.</p>
</blockquote>



<a name="447439774"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%238878%20What%20should%20the%20default%20behavior%20o.../near/447439774" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.238878.20What.20should.20the.20default.20behavior.20o.2E.2E.2E.html#447439774">(Jun 27 2024 at 10:13)</a>:</h4>
<p>tschneidereit <a href="https://github.com/bytecodealliance/wasmtime/issues/8878#issuecomment-2194307082">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/8878">issue #8878</a>:</p>
<blockquote>
<p>my take is that we should have wasi:http either always provide an authority, or provide the <code>host</code> header. Otherwise there's no standard way for content to learn about the authority it's called under. I know that @lukewagner concluded that we must never provide the <code>host</code> header. If that stands, I conversely think that we must continue providing the authority for incoming requests.</p>
<p>In effect, that means that for incoming requests what content sees is always the <code>absoluteURI</code> form, which the RFC seems to indicate is the way forward, too:</p>
<blockquote>
<p>To allow for transition to absoluteURIs in all requests in future<br>
   versions of HTTP, all HTTP/1.1 servers MUST accept the absoluteURI<br>
   form in requests, even though HTTP/1.1 clients will only generate<br>
   them in requests to proxies.</p>
</blockquote>
</blockquote>



<a name="447463872"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%238878%20What%20should%20the%20default%20behavior%20o.../near/447463872" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.238878.20What.20should.20the.20default.20behavior.20o.2E.2E.2E.html#447463872">(Jun 27 2024 at 12:22)</a>:</h4>
<p>lann <a href="https://github.com/bytecodealliance/wasmtime/issues/8878#issuecomment-2194542766">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/8878">issue #8878</a>:</p>
<blockquote>
<p>Don't pay too much attention to the 1.1 spec for future direction. HTTP/2 makes authority even more special by splitting it into a "pseudo-header".</p>
</blockquote>



<a name="447470887"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%238878%20What%20should%20the%20default%20behavior%20o.../near/447470887" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.238878.20What.20should.20the.20default.20behavior.20o.2E.2E.2E.html#447470887">(Jun 27 2024 at 12:54)</a>:</h4>
<p>lann edited a <a href="https://github.com/bytecodealliance/wasmtime/issues/8878#issuecomment-2194542766">comment</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/8878">issue #8878</a>:</p>
<blockquote>
<p>Don't pay too much attention to the 1.1 spec for future direction. HTTP/2 makes authority even more special by (usually) splitting it into a "pseudo-header".</p>
</blockquote>



<a name="447471149"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%238878%20What%20should%20the%20default%20behavior%20o.../near/447471149" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.238878.20What.20should.20the.20default.20behavior.20o.2E.2E.2E.html#447471149">(Jun 27 2024 at 12:55)</a>:</h4>
<p>lann edited a <a href="https://github.com/bytecodealliance/wasmtime/issues/8878#issuecomment-2194542766">comment</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/8878">issue #8878</a>:</p>
<blockquote>
<p>Don't pay too much attention to the 1.1 spec for future direction. HTTP/2 and /3 make authority even more special by (usually) splitting it into a "pseudo-header": <a href="https://httpwg.org/http-core/draft-ietf-httpbis-semantics-latest.html#field.host">https://httpwg.org/http-core/draft-ietf-httpbis-semantics-latest.html#field.host</a></p>
</blockquote>



<a name="447476814"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%238878%20What%20should%20the%20default%20behavior%20o.../near/447476814" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.238878.20What.20should.20the.20default.20behavior.20o.2E.2E.2E.html#447476814">(Jun 27 2024 at 13:22)</a>:</h4>
<p>alexcrichton <a href="https://github.com/bytecodealliance/wasmtime/issues/8878#issuecomment-2194683015">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/8878">issue #8878</a>:</p>
<blockquote>
<p>The <a href="https://github.com/bytecodealliance/wasmtime/blob/761f044efbb6d7465b88d723619168919b30ce0b/src/commands/serve.rs#L417-L428">previous logic</a> for scheme and authority were:</p>
<ul>
<li>Scheme: If the HTTP request used an "absolute URI" then the scheme comes from that, otherwise it's hardcoded as Http</li>
<li>Authority: If the HTTP request used an "absolute URI" use the hostname, otherwise if the "Host: " header is provided use that, otherwise consider it an invalid http request and don't even invoke wasm.</li>
</ul>
<p>Given that <code>wasmtime serve</code> does not itself support HTTPS, should the scheme always be HTTP in this case regardless of what the "absolute URI" says? Similarly <code>wasmtime serve</code> has no support for multi-domain hosting or anything like that so is it correct to lookup the authority based on the request?</p>
<p>A related but orthogonal question is that right now the in-memory store for this information is <code>hyper::Request&lt;T&gt;</code> and I'm not sure if that's the right choice here either. </p>
<p>Basically I'm still personally very confused about what the desired behavior is and how we would go about implementing it.</p>
</blockquote>



<a name="447835907"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%238878%20What%20should%20the%20default%20behavior%20o.../near/447835907" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.238878.20What.20should.20the.20default.20behavior.20o.2E.2E.2E.html#447835907">(Jun 28 2024 at 17:52)</a>:</h4>
<p>lukewagner <a href="https://github.com/bytecodealliance/wasmtime/issues/8878#issuecomment-2197396060">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/8878">issue #8878</a>:</p>
<blockquote>
<p>Great question.  First of all, from asking some HTTP folks, I believe it is the case that we could tighten the spec wording to say that for methods other than CONNECT and OPTIONS, there must <em>always</em> be an <code>authority</code> (i.e., the return value is <code>some</code>).  Apparently, CONNECT and OPTIONS have an unfortunate <code>*</code> option that simply has no authority.</p>
<p>Next, my understanding from RFC 9110 is that the <code>authority</code> either comes from the <code>:authority</code> pseudo-header in H/2/3 or the <code>Host</code> header in H/1, and if both are present, they are not allowed to disagree (and this is Web-compatible).  Thus, I think what WASI HTTP should say is that:</p>
<ul>
<li><code>Host</code> is in the definitely-forbidden headers list</li>
<li>The <code>request.authority</code> field is derived in a transport-dependent manner (and required to be present for non-CONNECT/OPTIONS)</li>
</ul>
<p>This allows the host implementation to do the transport-appropriate thing for requests coming in or out over the wire.</p>
</blockquote>



<a name="449976578"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%238878%20What%20should%20the%20default%20behavior%20o.../near/449976578" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.238878.20What.20should.20the.20default.20behavior.20o.2E.2E.2E.html#449976578">(Jul 08 2024 at 20:34)</a>:</h4>
<p>alexcrichton <a href="https://github.com/bytecodealliance/wasmtime/issues/8878#issuecomment-2215229355">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/8878">issue #8878</a>:</p>
<blockquote>
<p>Ok so for the use case of <code>wasmtime serve</code> specifically:</p>
<ul>
<li><code>[method]incoming-request.scheme</code> is always <code>some(http)</code> because we don't implement https yet</li>
<li><code>[method]incoming-request.authority</code> uses the incoming URI's host if it's there (probably only for CONNECT and OPTIONS). Otherwise it uses <code>Host</code>, otherwise it returns .... None? <code>"127.0.0.1"</code>? The value of <code>--addr</code>?</li>
</ul>
<p>This all indicates to me that <a href="https://docs.rs/wasmtime-wasi-http/latest/wasmtime_wasi_http/trait.WasiHttpView.html#method.new_incoming_request"><code>new_incoming_request</code></a> should take both a <code>scheme</code> and an <code>authority</code> argument rather than inferring these from the <code>Request</code> as well?</p>
<p>(sorry I'm really looking for guidance/second opinions here, I don't know why things were originally constructed the way they are or if they're just how things got shaken out)</p>
</blockquote>



<a name="449980465"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%238878%20What%20should%20the%20default%20behavior%20o.../near/449980465" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.238878.20What.20should.20the.20default.20behavior.20o.2E.2E.2E.html#449980465">(Jul 08 2024 at 21:01)</a>:</h4>
<p>lann <a href="https://github.com/bytecodealliance/wasmtime/issues/8878#issuecomment-2215294745">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/8878">issue #8878</a>:</p>
<blockquote>
<blockquote>
<p>otherwise it returns .... None?</p>
</blockquote>
<p>Do we want/need to support HTTP/1.0? afaik <code>host</code> is mandatory for 1.1</p>
</blockquote>



<a name="449981408"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%238878%20What%20should%20the%20default%20behavior%20o.../near/449981408" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.238878.20What.20should.20the.20default.20behavior.20o.2E.2E.2E.html#449981408">(Jul 08 2024 at 21:04)</a>:</h4>
<p>lann edited a <a href="https://github.com/bytecodealliance/wasmtime/issues/8878#issuecomment-2215294745">comment</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/8878">issue #8878</a>:</p>
<blockquote>
<blockquote>
<p>otherwise it returns .... None?</p>
</blockquote>
<p>Do we want/need to support HTTP/1.0? afaik <code>host</code> is mandatory for 1.1; we could just 400 if a request has no host/authority.</p>
</blockquote>



<a name="449981686"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%238878%20What%20should%20the%20default%20behavior%20o.../near/449981686" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.238878.20What.20should.20the.20default.20behavior.20o.2E.2E.2E.html#449981686">(Jul 08 2024 at 21:05)</a>:</h4>
<p>lann edited a <a href="https://github.com/bytecodealliance/wasmtime/issues/8878#issuecomment-2215294745">comment</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/8878">issue #8878</a>:</p>
<blockquote>
<blockquote>
<p>otherwise it returns .... None?</p>
</blockquote>
<p>Do we want/need to support HTTP/1.0? afaik <code>host</code> is mandatory for 1.1; we could just 400 if a request has no host/authority.</p>
<p>Alternatively, it appears that it is valid for <code>host</code> to be empty, so a 1.0 request without <code>host</code> could just imply that.</p>
</blockquote>



<a name="449981777"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%238878%20What%20should%20the%20default%20behavior%20o.../near/449981777" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.238878.20What.20should.20the.20default.20behavior.20o.2E.2E.2E.html#449981777">(Jul 08 2024 at 21:05)</a>:</h4>
<p>lann edited a <a href="https://github.com/bytecodealliance/wasmtime/issues/8878#issuecomment-2215294745">comment</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/8878">issue #8878</a>:</p>
<blockquote>
<blockquote>
<p>otherwise it returns .... None?</p>
</blockquote>
<p>Do we want/need to support HTTP/1.0? afaik <code>host</code> is mandatory for 1.1; we could just 400 if a request has no host/authority.</p>
<p>Alternatively, it appears that it is valid for <code>host</code> to be empty, so an HTTP/1.0 request without <code>host</code> could just imply that.</p>
</blockquote>



<a name="449986998"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%238878%20What%20should%20the%20default%20behavior%20o.../near/449986998" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.238878.20What.20should.20the.20default.20behavior.20o.2E.2E.2E.html#449986998">(Jul 08 2024 at 21:38)</a>:</h4>
<p>alexcrichton <a href="https://github.com/bytecodealliance/wasmtime/issues/8878#issuecomment-2215392465">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/8878">issue #8878</a>:</p>
<blockquote>
<p>Ah ok I didn't realize that was a 1.0 thing. Sounds like it should search for <code>Host</code> as a header in the host-side <code>hyper::Request</code> for the authority if it's not present in the URI. I try to make a PR with these changes tomorrow.</p>
</blockquote>



<a name="450010062"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%238878%20What%20should%20the%20default%20behavior%20o.../near/450010062" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.238878.20What.20should.20the.20default.20behavior.20o.2E.2E.2E.html#450010062">(Jul 08 2024 at 23:58)</a>:</h4>
<p>lukewagner <a href="https://github.com/bytecodealliance/wasmtime/issues/8878#issuecomment-2215583213">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/8878">issue #8878</a>:</p>
<blockquote>
<p>The impression that I got talking to an HTTP server maintainer is that it's web-compatible to require the <code>Host</code> field (rejecting if it's absent in HTTP 1.0 or 1.1) and that allowing an empty <code>authority</code> in cases other than CONNECT/OPTIONS can transitively lead to security issues (random googling found <a href="https://medium.com/the-volatile-triad/hacking-the-blank-host-header-trick-e280efbaf274">this</a> e.g.).  Similarly, RFC 9110 (which also intends to be Web-compatible) says that there <a href="https://www.rfc-editor.org/rfc/rfc9110#name-host-and-authority">MUST</a> be a <code>Host</code> header (when there is no <code>:authority</code> pseudo-header) without making an exception for HTTP 1.0.  Thus, I'd suggest making it an error in <code>wasmtime serve</code> if there is no <code>Host</code> in HTTP 1.0, at least to start with, and see if anyone complains.</p>
</blockquote>



<a name="450231758"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%238878%20What%20should%20the%20default%20behavior%20o.../near/450231758" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.238878.20What.20should.20the.20default.20behavior.20o.2E.2E.2E.html#450231758">(Jul 09 2024 at 17:11)</a>:</h4>
<p>alexcrichton closed <a href="https://github.com/bytecodealliance/wasmtime/issues/8878">issue #8878</a>:</p>
<blockquote>
<p>My changes in <a href="https://github.com/bytecodealliance/wasmtime/pull/8861">https://github.com/bytecodealliance/wasmtime/pull/8861</a> introduced a change in the default behavior of <code>wasmtime serve</code>. Notably this program:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="k">use</span><span class="w"> </span><span class="n">wasi</span><span class="p">::</span><span class="n">http</span><span class="p">::</span><span class="n">types</span><span class="p">::</span><span class="o">*</span><span class="p">;</span>

<span class="k">struct</span><span class="w"> </span><span class="nc">T</span><span class="p">;</span>

<span class="n">wasi</span><span class="p">::</span><span class="n">http</span><span class="p">::</span><span class="n">proxy</span><span class="p">::</span><span class="n">export</span><span class="o">!</span><span class="p">(</span><span class="n">T</span><span class="p">);</span>

<span class="k">impl</span><span class="w"> </span><span class="n">wasi</span><span class="p">::</span><span class="n">exports</span><span class="p">::</span><span class="n">wasi</span><span class="p">::</span><span class="n">http</span><span class="p">::</span><span class="n">incoming_handler</span><span class="p">::</span><span class="n">Guest</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">T</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">fn</span><span class="w"> </span><span class="nf">handle</span><span class="p">(</span><span class="n">request</span><span class="p">:</span><span class="w"> </span><span class="nc">IncomingRequest</span><span class="p">,</span><span class="w"> </span><span class="n">outparam</span><span class="p">:</span><span class="w"> </span><span class="nc">ResponseOutparam</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="fm">println!</span><span class="p">(</span><span class="s">"request.method = {:?}"</span><span class="p">,</span><span class="w"> </span><span class="n">request</span><span class="p">.</span><span class="n">method</span><span class="p">());</span>
<span class="w">        </span><span class="fm">println!</span><span class="p">(</span><span class="s">"request.scheme = {:?}"</span><span class="p">,</span><span class="w"> </span><span class="n">request</span><span class="p">.</span><span class="n">scheme</span><span class="p">());</span>
<span class="w">        </span><span class="fm">println!</span><span class="p">(</span><span class="s">"request.authority = {:?}"</span><span class="p">,</span><span class="w"> </span><span class="n">request</span><span class="p">.</span><span class="n">authority</span><span class="p">());</span>

<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="n">resp</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">OutgoingResponse</span><span class="p">::</span><span class="n">new</span><span class="p">(</span><span class="n">Fields</span><span class="p">::</span><span class="n">new</span><span class="p">());</span>
<span class="w">        </span><span class="n">ResponseOutparam</span><span class="p">::</span><span class="n">set</span><span class="p">(</span><span class="n">outparam</span><span class="p">,</span><span class="w"> </span><span class="nb">Ok</span><span class="p">(</span><span class="n">resp</span><span class="p">));</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
<p><a href="https://github.com/user-attachments/files/15995214/wat.wasm.gz">(compiled component)</a></p>
<p>When run with <code>wasmtime serve</code> and hit with <code>curl http://localhost:8080</code> it prints:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="n">Serving</span><span class="w"> </span><span class="n">HTTP</span><span class="w"> </span><span class="n">on</span><span class="w"> </span><span class="n">http</span><span class="p">:</span><span class="c1">//0.0.0.0:8080/</span>
<span class="n">stdout</span><span class="w"> </span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="w"> </span><span class="p">::</span><span class="w"> </span><span class="nc">request</span><span class="p">.</span><span class="n">method</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Method</span><span class="p">::</span><span class="n">Get</span>
<span class="n">stdout</span><span class="w"> </span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="w"> </span><span class="p">::</span><span class="w"> </span><span class="nc">request</span><span class="p">.</span><span class="n">scheme</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">Some</span><span class="p">(</span><span class="n">Scheme</span><span class="p">::</span><span class="n">Http</span><span class="p">)</span>
<span class="n">stdout</span><span class="w"> </span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="w"> </span><span class="p">::</span><span class="w"> </span><span class="nc">request</span><span class="p">.</span><span class="n">authority</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">Some</span><span class="p">(</span><span class="s">"localhost:8080"</span><span class="p">)</span>
</code></pre></div>
<p>On <code>main</code>, however, it prints</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="n">Serving</span><span class="w"> </span><span class="n">HTTP</span><span class="w"> </span><span class="n">on</span><span class="w"> </span><span class="n">http</span><span class="p">:</span><span class="c1">//0.0.0.0:8080/</span>
<span class="n">stdout</span><span class="w"> </span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="w"> </span><span class="p">::</span><span class="w"> </span><span class="nc">request</span><span class="p">.</span><span class="n">method</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Method</span><span class="p">::</span><span class="n">Get</span>
<span class="n">stdout</span><span class="w"> </span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="w"> </span><span class="p">::</span><span class="w"> </span><span class="nc">request</span><span class="p">.</span><span class="n">scheme</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">None</span>
<span class="n">stdout</span><span class="w"> </span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="w"> </span><span class="p">::</span><span class="w"> </span><span class="nc">request</span><span class="p">.</span><span class="n">authority</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">None</span>
</code></pre></div>
<p>This regression is due to <a href="https://github.com/bytecodealliance/wasmtime/pull/8861/files#diff-7da576f5c8e7ffe1f4d334844eec78ed27e092a9bacdad959a54468904d870b2L414">these changes</a> because I didn't understand what they were doing.</p>
<p>Now why wasn't this caught by the test suite? I tried writing a test for this and it passed, but apparently it's due to our usage of <br>
<code>hyper::Request::builder().uri("http://localhost/")</code> in the test suite. That creates an HTTP requests that looks like:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="n">GET</span><span class="w"> </span><span class="n">http</span><span class="p">:</span><span class="c1">//localhost/ HTTP/1.1</span>
<span class="o">..</span><span class="p">.</span>
</code></pre></div>
<p>where using <code>curl</code> on the command line generates:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="n">GET</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">HTTP</span><span class="o">/</span><span class="mf">1.1</span>
<span class="o">..</span><span class="p">.</span>
</code></pre></div>
<p>That leads me to this issue. What should <code>scheme</code> and <code>authority</code> report in these two cases for <code>wasmtime serve</code> by default? The previous behavior means that <code>GET /</code> could not be distinguished from <code>GET http://localhost/</code> which naively seems like what <code>scheme</code> and <code>authority</code> are trying to map to.</p>
<p>Is the previous behavior of <code>wasmtime serve</code> buggy? Is the current behavior buggy? Should the spec be clarified?</p>
<p>cc @elliottt @pchickey </p>
</blockquote>



<hr><p>Last updated: Jan 20 2025 at 06:04 UTC</p>
</html>