<html>
<head><meta charset="utf-8"><title>wasmtime / issue #9685 Bug in loading Extern Function nam... · git-wasmtime · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/index.html">git-wasmtime</a></h2>
<h3>Topic: <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.239685.20Bug.20in.20loading.20Extern.20Function.20nam.2E.2E.2E.html">wasmtime / issue #9685 Bug in loading Extern Function nam...</a></h3>

<hr>

<base href="https://bytecodealliance.zulipchat.com">

<head><link href="https://bytecodealliance.github.io/zulip-archive/style.css" rel="stylesheet"></head>

<a name="484479946"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%239685%20Bug%20in%20loading%20Extern%20Function%20nam.../near/484479946" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.239685.20Bug.20in.20loading.20Extern.20Function.20nam.2E.2E.2E.html#484479946">(Nov 26 2024 at 10:29)</a>:</h4>
<p>AlaaAlHallaq opened <a href="https://github.com/bytecodealliance/wasmtime/issues/9685">issue #9685</a>:</p>
<blockquote>
<p><a href="https://github.com/bytecodealliance/wasmtime/blob/2b3fe80b65c4943428ec1d587bf35740cd977401/cranelift/codegen/src/ir/extname.rs#L199">https://github.com/bytecodealliance/wasmtime/blob/2b3fe80b65c4943428ec1d587bf35740cd977401/cranelift/codegen/src/ir/extname.rs#L199</a></p>
<p>when I tried to load mpfrp wasm file compiled and used by nodejs package <a href="https://github.com/Daninet/gmp-wasm">gmp-wasm</a>:<br>
the following panic stack trace occure:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="n">thread</span><span class="w"> </span><span class="o">'&lt;</span><span class="n">unnamed</span><span class="o">&gt;'</span><span class="w"> </span><span class="n">panicked</span><span class="w"> </span><span class="n">at</span><span class="w"> </span><span class="o">/</span><span class="n">Users</span><span class="o">/</span><span class="n">alaahallaq</span><span class="o">/</span><span class="p">.</span><span class="n">cargo</span><span class="o">/</span><span class="n">registry</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">index</span><span class="p">.</span><span class="n">crates</span><span class="p">.</span><span class="n">io</span><span class="o">-</span><span class="mi">6</span><span class="n">f17d22bba15001f</span><span class="o">/</span><span class="n">cranelift</span><span class="o">-</span><span class="n">codegen</span><span class="o">-</span><span class="mf">0.110.2</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">ir</span><span class="o">/</span><span class="n">extname</span><span class="p">.</span><span class="n">rs</span><span class="p">:</span><span class="mi">199</span><span class="p">:</span><span class="mi">58</span><span class="p">:</span>
<span class="nc">index</span><span class="w"> </span><span class="n">out</span><span class="w"> </span><span class="n">of</span><span class="w"> </span><span class="n">bounds</span><span class="p">:</span><span class="w"> </span><span class="nc">the</span><span class="w"> </span><span class="n">len</span><span class="w"> </span><span class="n">is</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="n">but</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">index</span><span class="w"> </span><span class="n">is</span><span class="w"> </span><span class="mi">191</span>
<span class="n">stack</span><span class="w"> </span><span class="n">backtrace</span><span class="p">:</span>
<span class="w">   </span><span class="mi">0</span><span class="p">:</span><span class="w"> </span><span class="nc">_rust_begin_unwind</span>
<span class="w">   </span><span class="mi">1</span><span class="p">:</span><span class="w"> </span><span class="nc">core</span><span class="p">::</span><span class="n">panicking</span><span class="p">::</span><span class="n">panic_fmt</span>
<span class="w">   </span><span class="mi">2</span><span class="p">:</span><span class="w"> </span><span class="nc">core</span><span class="p">::</span><span class="n">panicking</span><span class="p">::</span><span class="n">panic_bounds_check</span>
<span class="w">   </span><span class="mi">3</span><span class="p">:</span><span class="w"> </span><span class="o">&lt;</span><span class="kt">usize</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">core</span><span class="p">::</span><span class="n">slice</span><span class="p">::</span><span class="n">index</span><span class="p">::</span><span class="n">SliceIndex</span><span class="o">&lt;</span><span class="p">[</span><span class="n">T</span><span class="p">]</span><span class="o">&gt;&gt;</span><span class="p">::</span><span class="n">index</span>
<span class="w">   </span><span class="mi">4</span><span class="p">:</span><span class="w"> </span><span class="o">&lt;</span><span class="n">alloc</span><span class="p">::</span><span class="n">vec</span><span class="p">::</span><span class="nb">Vec</span><span class="o">&lt;</span><span class="n">T</span><span class="p">,</span><span class="n">A</span><span class="o">&gt;</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">core</span><span class="p">::</span><span class="n">ops</span><span class="p">::</span><span class="n">index</span><span class="p">::</span><span class="n">Index</span><span class="o">&lt;</span><span class="n">I</span><span class="o">&gt;&gt;</span><span class="p">::</span><span class="n">index</span>
<span class="w">   </span><span class="mi">5</span><span class="p">:</span><span class="w"> </span><span class="o">&lt;</span><span class="n">cranelift_entity</span><span class="p">::</span><span class="n">primary</span><span class="p">::</span><span class="n">PrimaryMap</span><span class="o">&lt;</span><span class="n">K</span><span class="p">,</span><span class="n">V</span><span class="o">&gt;</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">core</span><span class="p">::</span><span class="n">ops</span><span class="p">::</span><span class="n">index</span><span class="p">::</span><span class="n">Index</span><span class="o">&lt;</span><span class="n">K</span><span class="o">&gt;&gt;</span><span class="p">::</span><span class="n">index</span>
<span class="w">   </span><span class="mi">6</span><span class="p">:</span><span class="w"> </span><span class="o">&lt;</span><span class="n">cranelift_codegen</span><span class="p">::</span><span class="n">ir</span><span class="p">::</span><span class="n">extname</span><span class="p">::</span><span class="n">DisplayableExternalName</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">core</span><span class="p">::</span><span class="n">fmt</span><span class="p">::</span><span class="n">Display</span><span class="o">&gt;</span><span class="p">::</span><span class="n">fmt</span>
<span class="w">   </span><span class="mi">7</span><span class="p">:</span><span class="w"> </span><span class="nc">core</span><span class="p">::</span><span class="n">fmt</span><span class="p">::</span><span class="n">write</span>
<span class="w">   </span><span class="mi">8</span><span class="p">:</span><span class="w"> </span><span class="nc">core</span><span class="p">::</span><span class="n">fmt</span><span class="p">::</span><span class="n">Formatter</span><span class="p">::</span><span class="n">write_fmt</span>
<span class="w">   </span><span class="mi">9</span><span class="p">:</span><span class="w"> </span><span class="o">&lt;</span><span class="n">cranelift_codegen</span><span class="p">::</span><span class="n">ir</span><span class="p">::</span><span class="n">extfunc</span><span class="p">::</span><span class="n">DisplayableExtFuncData</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">core</span><span class="p">::</span><span class="n">fmt</span><span class="p">::</span><span class="n">Display</span><span class="o">&gt;</span><span class="p">::</span><span class="n">fmt</span>
<span class="w">  </span><span class="mi">10</span><span class="p">:</span><span class="w"> </span><span class="o">&lt;&amp;</span><span class="n">T</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">core</span><span class="p">::</span><span class="n">fmt</span><span class="p">::</span><span class="n">Display</span><span class="o">&gt;</span><span class="p">::</span><span class="n">fmt</span>
<span class="w">  </span><span class="mi">11</span><span class="p">:</span><span class="w"> </span><span class="nc">core</span><span class="p">::</span><span class="n">fmt</span><span class="p">::</span><span class="n">write</span>
<span class="w">  </span><span class="mi">12</span><span class="p">:</span><span class="w"> </span><span class="o">&lt;</span><span class="n">core</span><span class="p">::</span><span class="n">fmt</span><span class="p">::</span><span class="n">Formatter</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">core</span><span class="p">::</span><span class="n">fmt</span><span class="p">::</span><span class="n">Write</span><span class="o">&gt;</span><span class="p">::</span><span class="n">write_fmt</span>
<span class="w">  </span><span class="mi">13</span><span class="p">:</span><span class="w"> </span><span class="nc">cranelift_codegen</span><span class="p">::</span><span class="n">write</span><span class="p">::</span><span class="n">FuncWriter</span><span class="p">::</span><span class="n">super_entity_definition</span>
<span class="w">  </span><span class="mi">14</span><span class="p">:</span><span class="w"> </span><span class="nc">cranelift_codegen</span><span class="p">::</span><span class="n">write</span><span class="p">::</span><span class="n">FuncWriter</span><span class="p">::</span><span class="n">write_entity_definition</span>
<span class="w">  </span><span class="mi">15</span><span class="p">:</span><span class="w"> </span><span class="nc">cranelift_codegen</span><span class="p">::</span><span class="n">write</span><span class="p">::</span><span class="n">FuncWriter</span><span class="p">::</span><span class="n">super_preamble</span>
<span class="w">  </span><span class="mi">16</span><span class="p">:</span><span class="w"> </span><span class="nc">cranelift_codegen</span><span class="p">::</span><span class="n">write</span><span class="p">::</span><span class="n">FuncWriter</span><span class="p">::</span><span class="n">write_preamble</span>
<span class="w">  </span><span class="mi">17</span><span class="p">:</span><span class="w"> </span><span class="nc">cranelift_codegen</span><span class="p">::</span><span class="n">write</span><span class="p">::</span><span class="n">decorate_function</span>
<span class="w">  </span><span class="mi">18</span><span class="p">:</span><span class="w"> </span><span class="nc">cranelift_codegen</span><span class="p">::</span><span class="n">write</span><span class="p">::</span><span class="n">write_function</span>
<span class="w">  </span><span class="mi">19</span><span class="p">:</span><span class="w"> </span><span class="o">&lt;</span><span class="n">cranelift_codegen</span><span class="p">::</span><span class="n">ir</span><span class="p">::</span><span class="n">function</span><span class="p">::</span><span class="n">DisplayFunction</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">core</span><span class="p">::</span><span class="n">fmt</span><span class="p">::</span><span class="n">Display</span><span class="o">&gt;</span><span class="p">::</span><span class="n">fmt</span>
<span class="w">  </span><span class="mi">20</span><span class="p">:</span><span class="w"> </span><span class="nc">core</span><span class="p">::</span><span class="n">fmt</span><span class="p">::</span><span class="n">write</span>
<span class="w">  </span><span class="mi">21</span><span class="p">:</span><span class="w"> </span><span class="o">&lt;&amp;</span><span class="n">T</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">core</span><span class="p">::</span><span class="n">fmt</span><span class="p">::</span><span class="n">Display</span><span class="o">&gt;</span><span class="p">::</span><span class="n">fmt</span>
<span class="w">  </span><span class="mi">22</span><span class="p">:</span><span class="w"> </span><span class="nc">core</span><span class="p">::</span><span class="n">fmt</span><span class="p">::</span><span class="n">write</span>
<span class="w">  </span><span class="mi">23</span><span class="p">:</span><span class="w"> </span><span class="nc">alloc</span><span class="p">::</span><span class="n">fmt</span><span class="p">::</span><span class="n">format</span><span class="p">::</span><span class="n">format_inner</span>
<span class="w">  </span><span class="mi">24</span><span class="p">:</span><span class="w"> </span><span class="nc">alloc</span><span class="p">::</span><span class="n">fmt</span><span class="p">::</span><span class="n">format</span><span class="p">::{{</span><span class="n">closure</span><span class="p">}}</span>
<span class="w">  </span><span class="mi">25</span><span class="p">:</span><span class="w"> </span><span class="nc">core</span><span class="p">::</span><span class="n">option</span><span class="p">::</span><span class="nb">Option</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span><span class="p">::</span><span class="n">map_or_else</span>
<span class="w">  </span><span class="mi">26</span><span class="p">:</span><span class="w"> </span><span class="nc">alloc</span><span class="p">::</span><span class="n">fmt</span><span class="p">::</span><span class="n">format</span>
<span class="w">  </span><span class="mi">27</span><span class="p">:</span><span class="w"> </span><span class="o">&lt;</span><span class="n">oslog</span><span class="p">::</span><span class="n">logger</span><span class="p">::</span><span class="n">OsLogger</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">log</span><span class="p">::</span><span class="n">Log</span><span class="o">&gt;</span><span class="p">::</span><span class="n">log</span>
<span class="w">  </span><span class="mi">28</span><span class="p">:</span><span class="w"> </span><span class="nc">log</span><span class="p">::</span><span class="n">__private_api</span><span class="p">::</span><span class="n">log_impl</span>
<span class="w">  </span><span class="mi">29</span><span class="p">:</span><span class="w"> </span><span class="nc">log</span><span class="p">::</span><span class="n">__private_api</span><span class="p">::</span><span class="n">log</span>
<span class="w">  </span><span class="mi">30</span><span class="p">:</span><span class="w"> </span><span class="nc">cranelift_codegen</span><span class="p">::</span><span class="n">context</span><span class="p">::</span><span class="n">Context</span><span class="p">::</span><span class="n">optimize</span>
<span class="w">  </span><span class="mi">31</span><span class="p">:</span><span class="w"> </span><span class="nc">cranelift_codegen</span><span class="p">::</span><span class="n">context</span><span class="p">::</span><span class="n">Context</span><span class="p">::</span><span class="n">compile_stencil</span>
<span class="w">  </span><span class="mi">32</span><span class="p">:</span><span class="w"> </span><span class="nc">cranelift_codegen</span><span class="p">::</span><span class="n">context</span><span class="p">::</span><span class="n">Context</span><span class="p">::</span><span class="n">compile</span>
<span class="w">  </span><span class="mi">33</span><span class="p">:</span><span class="w"> </span><span class="nc">cranelift_codegen</span><span class="p">::</span><span class="n">context</span><span class="p">::</span><span class="n">Context</span><span class="p">::</span><span class="n">compile_and_emit</span>
<span class="w">  </span><span class="mi">34</span><span class="p">:</span><span class="w"> </span><span class="o">&lt;</span><span class="n">wasmer_compiler_cranelift</span><span class="p">::</span><span class="n">compiler</span><span class="p">::</span><span class="n">CraneliftCompiler</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">wasmer_compiler</span><span class="p">::</span><span class="n">compiler</span><span class="p">::</span><span class="n">Compiler</span><span class="o">&gt;</span><span class="p">::</span><span class="n">compile_module</span><span class="p">::{{</span><span class="n">closure</span><span class="p">}}</span>
<span class="w">  </span><span class="mi">35</span><span class="p">:</span><span class="w"> </span><span class="nc">core</span><span class="p">::</span><span class="n">ops</span><span class="p">::</span><span class="n">function</span><span class="p">::</span><span class="n">impls</span><span class="p">::</span><span class="o">&lt;</span><span class="k">impl</span><span class="w"> </span><span class="n">core</span><span class="p">::</span><span class="n">ops</span><span class="p">::</span><span class="n">function</span><span class="p">::</span><span class="nb">Fn</span><span class="o">&lt;</span><span class="n">A</span><span class="o">&gt;</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="o">&amp;</span><span class="n">F</span><span class="o">&gt;</span><span class="p">::</span><span class="n">call</span>
<span class="w">  </span><span class="mi">36</span><span class="p">:</span><span class="w"> </span><span class="o">&lt;</span><span class="n">rayon</span><span class="p">::</span><span class="n">iter</span><span class="p">::</span><span class="n">map_with</span><span class="p">::</span><span class="n">MapWithFolder</span><span class="o">&lt;</span><span class="n">C</span><span class="p">,</span><span class="n">U</span><span class="p">,</span><span class="n">F</span><span class="o">&gt;</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">rayon</span><span class="p">::</span><span class="n">iter</span><span class="p">::</span><span class="n">plumbing</span><span class="p">::</span><span class="n">Folder</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;&gt;</span><span class="p">::</span><span class="n">consume_iter</span><span class="p">::</span><span class="n">with</span><span class="p">::{{</span><span class="n">closure</span><span class="p">}}</span>
<span class="w">  </span><span class="mi">37</span><span class="p">:</span><span class="w"> </span><span class="nc">core</span><span class="p">::</span><span class="n">ops</span><span class="p">::</span><span class="n">function</span><span class="p">::</span><span class="n">impls</span><span class="p">::</span><span class="o">&lt;</span><span class="k">impl</span><span class="w"> </span><span class="n">core</span><span class="p">::</span><span class="n">ops</span><span class="p">::</span><span class="n">function</span><span class="p">::</span><span class="nb">FnOnce</span><span class="o">&lt;</span><span class="n">A</span><span class="o">&gt;</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="n">F</span><span class="o">&gt;</span><span class="p">::</span><span class="n">call_once</span>
<span class="w">  </span><span class="mi">38</span><span class="p">:</span><span class="w"> </span><span class="o">&lt;</span><span class="n">core</span><span class="p">::</span><span class="n">iter</span><span class="p">::</span><span class="n">adapters</span><span class="p">::</span><span class="n">map</span><span class="p">::</span><span class="n">Map</span><span class="o">&lt;</span><span class="n">I</span><span class="p">,</span><span class="n">F</span><span class="o">&gt;</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">core</span><span class="p">::</span><span class="n">iter</span><span class="p">::</span><span class="n">traits</span><span class="p">::</span><span class="n">iterator</span><span class="p">::</span><span class="nb">Iterator</span><span class="o">&gt;</span><span class="p">::</span><span class="n">next</span>
<span class="w">  </span><span class="mi">39</span><span class="p">:</span><span class="w"> </span><span class="o">&lt;</span><span class="n">core</span><span class="p">::</span><span class="n">iter</span><span class="p">::</span><span class="n">adapters</span><span class="p">::</span><span class="n">map</span><span class="p">::</span><span class="n">Map</span><span class="o">&lt;</span><span class="n">I</span><span class="p">,</span><span class="n">F</span><span class="o">&gt;</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">core</span><span class="p">::</span><span class="n">iter</span><span class="p">::</span><span class="n">traits</span><span class="p">::</span><span class="n">iterator</span><span class="p">::</span><span class="nb">Iterator</span><span class="o">&gt;</span><span class="p">::</span><span class="n">next</span>
<span class="w">  </span><span class="mi">40</span><span class="p">:</span><span class="w"> </span><span class="o">&lt;</span><span class="n">core</span><span class="p">::</span><span class="n">iter</span><span class="p">::</span><span class="n">adapters</span><span class="p">::</span><span class="n">take_while</span><span class="p">::</span><span class="n">TakeWhile</span><span class="o">&lt;</span><span class="n">I</span><span class="p">,</span><span class="n">P</span><span class="o">&gt;</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">core</span><span class="p">::</span><span class="n">iter</span><span class="p">::</span><span class="n">traits</span><span class="p">::</span><span class="n">iterator</span><span class="p">::</span><span class="nb">Iterator</span><span class="o">&gt;</span><span class="p">::</span><span class="n">next</span>
<span class="w">  </span><span class="mi">41</span><span class="p">:</span><span class="w"> </span><span class="o">&lt;</span><span class="n">core</span><span class="p">::</span><span class="n">iter</span><span class="p">::</span><span class="n">adapters</span><span class="p">::</span><span class="n">map</span><span class="p">::</span><span class="n">Map</span><span class="o">&lt;</span><span class="n">I</span><span class="p">,</span><span class="n">F</span><span class="o">&gt;</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">core</span><span class="p">::</span><span class="n">iter</span><span class="p">::</span><span class="n">traits</span><span class="p">::</span><span class="n">iterator</span><span class="p">::</span><span class="nb">Iterator</span><span class="o">&gt;</span><span class="p">::</span><span class="n">next</span>
<span class="w">  </span><span class="mi">42</span><span class="p">:</span><span class="w"> </span><span class="nc">alloc</span><span class="p">::</span><span class="n">vec</span><span class="p">::</span><span class="nb">Vec</span><span class="o">&lt;</span><span class="n">T</span><span class="p">,</span><span class="n">A</span><span class="o">&gt;</span><span class="p">::</span><span class="n">extend_desugared</span>
<span class="w">  </span><span class="mi">43</span><span class="p">:</span><span class="w"> </span><span class="o">&lt;</span><span class="n">alloc</span><span class="p">::</span><span class="n">vec</span><span class="p">::</span><span class="nb">Vec</span><span class="o">&lt;</span><span class="n">T</span><span class="p">,</span><span class="n">A</span><span class="o">&gt;</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">alloc</span><span class="p">::</span><span class="n">vec</span><span class="p">::</span><span class="n">spec_extend</span><span class="p">::</span><span class="n">SpecExtend</span><span class="o">&lt;</span><span class="n">T</span><span class="p">,</span><span class="n">I</span><span class="o">&gt;&gt;</span><span class="p">::</span><span class="n">spec_extend</span>
<span class="w">  </span><span class="mi">44</span><span class="p">:</span><span class="w"> </span><span class="o">&lt;</span><span class="n">alloc</span><span class="p">::</span><span class="n">vec</span><span class="p">::</span><span class="nb">Vec</span><span class="o">&lt;</span><span class="n">T</span><span class="p">,</span><span class="n">A</span><span class="o">&gt;</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">core</span><span class="p">::</span><span class="n">iter</span><span class="p">::</span><span class="n">traits</span><span class="p">::</span><span class="n">collect</span><span class="p">::</span><span class="nb">Extend</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;&gt;</span><span class="p">::</span><span class="n">extend</span>
<span class="w">  </span><span class="mi">45</span><span class="p">:</span><span class="w"> </span><span class="o">&lt;</span><span class="n">rayon</span><span class="p">::</span><span class="n">iter</span><span class="p">::</span><span class="n">extend</span><span class="p">::</span><span class="n">ListVecFolder</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">rayon</span><span class="p">::</span><span class="n">iter</span><span class="p">::</span><span class="n">plumbing</span><span class="p">::</span><span class="n">Folder</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;&gt;</span><span class="p">::</span><span class="n">consume_iter</span>
<span class="w">  </span><span class="mi">46</span><span class="p">:</span><span class="w"> </span><span class="o">&lt;</span><span class="n">rayon</span><span class="p">::</span><span class="n">iter</span><span class="p">::</span><span class="n">while_some</span><span class="p">::</span><span class="n">WhileSomeFolder</span><span class="o">&lt;</span><span class="n">C</span><span class="o">&gt;</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">rayon</span><span class="p">::</span><span class="n">iter</span><span class="p">::</span><span class="n">plumbing</span><span class="p">::</span><span class="n">Folder</span><span class="o">&lt;</span><span class="n">core</span><span class="p">::</span><span class="n">option</span><span class="p">::</span><span class="nb">Option</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;&gt;&gt;</span><span class="p">::</span><span class="n">consume_iter</span>
<span class="w">  </span><span class="mi">47</span><span class="p">:</span><span class="w"> </span><span class="o">&lt;</span><span class="n">rayon</span><span class="p">::</span><span class="n">iter</span><span class="p">::</span><span class="n">map</span><span class="p">::</span><span class="n">MapFolder</span><span class="o">&lt;</span><span class="n">C</span><span class="p">,</span><span class="n">F</span><span class="o">&gt;</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">rayon</span><span class="p">::</span><span class="n">iter</span><span class="p">::</span><span class="n">plumbing</span><span class="p">::</span><span class="n">Folder</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;&gt;</span><span class="p">::</span><span class="n">consume_iter</span>
<span class="w">  </span><span class="mi">48</span><span class="p">:</span><span class="w"> </span><span class="o">&lt;</span><span class="n">rayon</span><span class="p">::</span><span class="n">iter</span><span class="p">::</span><span class="n">map_with</span><span class="p">::</span><span class="n">MapWithFolder</span><span class="o">&lt;</span><span class="n">C</span><span class="p">,</span><span class="n">U</span><span class="p">,</span><span class="n">F</span><span class="o">&gt;</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">rayon</span><span class="p">::</span><span class="n">iter</span><span class="p">::</span><span class="n">plumbing</span><span class="p">::</span><span class="n">Folder</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;&gt;</span><span class="p">::</span><span class="n">consume_iter</span>
<span class="w">  </span><span class="mi">49</span><span class="p">:</span><span class="w"> </span><span class="nc">rayon</span><span class="p">::</span><span class="n">iter</span><span class="p">::</span><span class="n">plumbing</span><span class="p">::</span><span class="n">Producer</span><span class="p">::</span><span class="n">fold_with</span>
<span class="w">  </span><span class="mi">50</span><span class="p">:</span><span class="w"> </span><span class="nc">rayon</span><span class="p">::</span><span class="n">iter</span><span class="p">::</span><span class="n">plumbing</span><span class="p">::</span><span class="n">bridge_producer_consumer</span><span class="p">::</span><span class="n">helper</span>
<span class="w">  </span><span class="mi">51</span><span class="p">:</span><span class="w"> </span><span class="nc">rayon</span><span class="p">::</span><span class="n">iter</span><span class="p">::</span><span class="n">plumbing</span><span class="p">::</span><span class="n">bridge_producer_consumer</span><span class="p">::</span><span class="n">helper</span><span class="p">::{{</span><span class="n">closure</span><span class="p">}}</span>
<span class="w">  </span><span class="mi">52</span><span class="p">:</span><span class="w"> </span><span class="nc">rayon_core</span><span class="p">::</span><span class="n">join</span><span class="p">::</span><span class="n">join_context</span><span class="p">::</span><span class="n">call_b</span><span class="p">::{{</span><span class="n">closure</span><span class="p">}}</span>
<span class="w">  </span><span class="mi">53</span><span class="p">:</span><span class="w"> </span><span class="nc">rayon_core</span><span class="p">::</span><span class="n">job</span><span class="p">::</span><span class="n">JobResult</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span><span class="p">::</span><span class="n">call</span><span class="p">::{{</span><span class="n">closure</span><span class="p">}}</span>
<span class="w">  </span><span class="mi">54</span><span class="p">:</span><span class="w"> </span><span class="o">&lt;</span><span class="n">core</span><span class="p">::</span><span class="n">panic</span><span class="p">::</span><span class="n">unwind_safe</span><span class="p">::</span><span class="n">AssertUnwindSafe</span><span class="o">&lt;</span><span class="n">F</span><span class="o">&gt;</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">core</span><span class="p">::</span><span class="n">ops</span><span class="p">::</span><span class="n">function</span><span class="p">::</span><span class="nb">FnOnce</span><span class="o">&lt;</span><span class="p">()</span><span class="o">&gt;&gt;</span><span class="p">::</span><span class="n">call_once</span>
<span class="w">  </span><span class="mi">55</span><span class="p">:</span><span class="w"> </span><span class="nc">std</span><span class="p">::</span><span class="n">panicking</span><span class="p">::</span><span class="kr">try</span><span class="p">::</span><span class="n">do_call</span>
<span class="w">  </span><span class="mi">56</span><span class="p">:</span><span class="w"> </span><span class="nc">___rust_try</span>
<span class="w">  </span><span class="mi">57</span><span class="p">:</span><span class="w"> </span><span class="nc">std</span><span class="p">::</span><span class="n">panic</span><span class="p">::</span><span class="n">catch_unwind</span>
<span class="w">  </span><span class="mi">58</span><span class="p">:</span><span class="w"> </span><span class="nc">rayon_core</span><span class="p">::</span><span class="n">unwind</span><span class="p">::</span><span class="n">halt_unwinding</span>
<span class="w">  </span><span class="mi">59</span><span class="p">:</span><span class="w"> </span><span class="nc">rayon_core</span><span class="p">::</span><span class="n">job</span><span class="p">::</span><span class="n">JobResult</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span><span class="p">::</span><span class="n">call</span>
<span class="w">  </span><span class="mi">60</span><span class="p">:</span><span class="w"> </span><span class="o">&lt;</span><span class="n">rayon_core</span><span class="p">::</span><span class="n">job</span><span class="p">::</span><span class="n">StackJob</span><span class="o">&lt;</span><span class="n">L</span><span class="p">,</span><span class="n">F</span><span class="p">,</span><span class="n">R</span><span class="o">&gt;</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">rayon_core</span><span class="p">::</span><span class="n">job</span><span class="p">::</span><span class="n">Job</span><span class="o">&gt;</span><span class="p">::</span><span class="n">execute</span>
<span class="w">  </span><span class="mi">61</span><span class="p">:</span><span class="w"> </span><span class="nc">rayon_core</span><span class="p">::</span><span class="n">job</span><span class="p">::</span><span class="n">JobRef</span><span class="p">::</span><span class="n">execute</span>
<span class="w">  </span><span class="mi">62</span><span class="p">:</span><span class="w"> </span><span class="nc">rayon_core</span><span class="p">::</span><span class="n">registry</span><span class="p">::</span><span class="n">WorkerThread</span><span class="p">::</span><span class="n">execute</span>
<span class="w">  </span><span class="mi">63</span><span class="p">:</span><span class="w"> </span><span class="nc">rayon_core</span><span class="p">::</span><span class="n">registry</span><span class="p">::</span><span class="n">WorkerThread</span><span class="p">::</span><span class="n">wait_until_cold</span>
<span class="w">  </span><span class="mi">64</span><span class="p">:</span><span class="w"> </span><span class="nc">rayon_core</span><span class="p">::</span><span class="n">registry</span><span class="p">::</span><span class="n">WorkerThread</span><span class="p">::</span><span class="n">wait_until</span>
<span class="w">  </span><span class="mi">65</span><span class="p">:</span><span class="w"> </span><span class="nc">rayon_core</span><span class="p">::</span><span class="n">join</span><span class="p">::</span><span class="n">join_recover_from_panic</span>
<span class="w">  </span><span class="mi">66</span><span class="p">:</span><span class="w"> </span><span class="nc">rayon_core</span><span class="p">::</span><span class="n">join</span><span class="p">::</span><span class="n">join_context</span><span class="p">::{{</span><span class="n">closure</span><span class="p">}}</span>
<span class="w">  </span><span class="mi">67</span><span class="p">:</span><span class="w"> </span><span class="nc">rayon_core</span><span class="p">::</span><span class="n">registry</span><span class="p">::</span><span class="n">in_worker</span>
<span class="w">  </span><span class="mi">68</span><span class="p">:</span><span class="w"> </span><span class="nc">rayon_core</span><span class="p">::</span><span class="n">join</span><span class="p">::</span><span class="n">join_context</span>
<span class="w">  </span><span class="mi">69</span><span class="p">:</span><span class="w"> </span><span class="nc">rayon</span><span class="p">::</span><span class="n">iter</span><span class="p">::</span><span class="n">plumbing</span><span class="p">::</span><span class="n">bridge_producer_consumer</span><span class="p">::</span><span class="n">helper</span>
<span class="w">  </span><span class="mi">70</span><span class="p">:</span><span class="w"> </span><span class="nc">rayon</span><span class="p">::</span><span class="n">iter</span><span class="p">::</span><span class="n">plumbing</span><span class="p">::</span><span class="n">bridge_producer_consumer</span><span class="p">::</span><span class="n">helper</span><span class="p">::{{</span><span class="n">closure</span><span class="p">}}</span>
<span class="w">  </span><span class="mi">71</span><span class="p">:</span><span class="w"> </span><span class="nc">rayon_core</span><span class="p">::</span><span class="n">join</span><span class="p">::</span><span class="n">join_context</span><span class="p">::</span><span class="n">call_b</span><span class="p">::{{</span><span class="n">closure</span><span class="p">}}</span>
<span class="w">  </span><span class="mi">72</span><span class="p">:</span><span class="w"> </span><span class="nc">rayon_core</span><span class="p">::</span><span class="n">job</span><span class="p">::</span><span class="n">JobResult</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span><span class="p">::</span><span class="n">call</span><span class="p">::{{</span><span class="n">closure</span><span class="p">}}</span>
<span class="w">  </span><span class="mi">73</span><span class="p">:</span><span class="w"> </span><span class="o">&lt;</span><span class="n">core</span><span class="p">::</span><span class="n">panic</span><span class="p">::</span><span class="n">unwind_safe</span><span class="p">::</span><span class="n">AssertUnwindSafe</span><span class="o">&lt;</span><span class="n">F</span><span class="o">&gt;</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">core</span><span class="p">::</span><span class="n">ops</span><span class="p">::</span><span class="n">function</span><span class="p">::</span><span class="nb">FnOnce</span><span class="o">&lt;</span><span class="p">()</span><span class="o">&gt;&gt;</span><span class="p">::</span><span class="n">call_once</span>
<span class="w">  </span><span class="mi">74</span><span class="p">:</span><span class="w"> </span><span class="nc">std</span><span class="p">::</span><span class="n">panicking</span><span class="p">::</span><span class="kr">try</span><span class="p">::</span><span class="n">do_call</span>
<span class="w">  </span><span class="mi">75</span><span class="p">:</span><span class="w"> </span><span class="nc">___rust_try</span>
<span class="w">  </span><span class="mi">76</span><span class="p">:</span><span class="w"> </span><span class="nc">std</span><span class="p">::</span><span class="n">panic</span><span class="p">::</span><span class="n">catch_unwind</span>
<span class="w">  </span><span class="mi">77</span><span class="p">:</span><span class="w"> </span><span class="nc">rayon_core</span><span class="p">::</span><span class="n">unwind</span><span class="p">::</span><span class="n">halt_unwinding</span>
<span class="w">  </span><span class="mi">78</span><span class="p">:</span><span class="w"> </span><span class="nc">rayon_core</span><span class="p">::</span><span class="n">job</span><span class="p">::</span><span class="n">JobResult</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span><span class="p">::</span><span class="n">call</span>
<span class="w">  </span><span class="mi">79</span><span class="p">:</span><span class="w"> </span><span class="o">&lt;</span><span class="n">rayon_core</span><span class="p">::</span><span class="n">job</span><span class="p">::</span><span class="n">StackJob</span><span class="o">&lt;</span><span class="n">L</span><span class="p">,</span><span class="n">F</span><span class="p">,</span><span class="n">R</span><span class="o">&gt;</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">rayon_core</span><span class="p">::</span><span class="n">job</span><span class="p">::</span><span class="n">Job</span><span class="o">&gt;</span><span class="p">::</span><span class="n">execute</span>
<span class="w">  </span><span class="mi">80</span><span class="p">:</span><span class="w"> </span><span class="nc">rayon_core</span><span class="p">::</span><span class="n">job</span><span class="p">::</span><span class="n">JobRef</span><span class="p">::</span><span class="n">execute</span>
<span class="w">  </span><span class="mi">81</span><span class="p">:</span><span class="w"> </span><span class="nc">rayon_core</span><span class="p">::</span><span class="n">registry</span><span class="p">::</span><span class="n">WorkerThread</span><span class="p">::</span><span class="n">execute</span>
<span class="w">  </span><span class="mi">82</span><span class="p">:</span><span class="w"> </span><span class="nc">rayon_core</span><span class="p">::</span><span class="n">registry</span><span class="p">::</span><span class="n">WorkerThread</span><span class="p">::</span><span class="n">wait_until_cold</span>
<span class="w">  </span><span class="mi">83</span><span class="p">:</span><span class="w"> </span><span class="nc">rayon_core</span><span class="p">::</span><span class="n">registry</span><span class="p">::</span><span class="n">WorkerThread</span><span class="p">::</span><span class="n">wait_until</span>
<span class="w">  </span><span class="mi">84</span><span class="p">:</span><span class="w"> </span><span class="nc">rayon_core</span><span class="p">::</span><span class="n">join</span><span class="p">::</span><span class="n">join_recover_from_panic</span>
<span class="w">  </span><span class="mi">85</span><span class="p">:</span><span class="w"> </span><span class="nc">rayon_core</span><span class="p">::</span><span class="n">join</span><span class="p">::</span><span class="n">join_context</span><span class="p">::{{</span><span class="n">closure</span><span class="p">}}</span>
<span class="w">  </span><span class="mi">86</span><span class="p">:</span><span class="w"> </span><span class="nc">rayon_core</span><span class="p">::</span><span class="n">registry</span><span class="p">::</span><span class="n">in_worker</span>
<span class="w">  </span><span class="mi">87</span><span class="p">:</span><span class="w"> </span><span class="nc">rayon_core</span><span class="p">::</span><span class="n">join</span><span class="p">::</span><span class="n">join_context</span>
<span class="w">  </span><span class="mi">88</span><span class="p">:</span><span class="w"> </span><span class="nc">rayon</span><span class="p">::</span><span class="n">iter</span><span class="p">::</span><span class="n">plumbing</span><span class="p">::</span><span class="n">bridge_producer_consumer</span><span class="p">::</span><span class="n">helper</span>
<span class="w">  </span><span class="mi">89</span><span class="p">:</span><span class="w"> </span><span class="nc">rayon</span><span class="p">::</span><span class="n">iter</span><span class="p">::</span><span class="n">plumbing</span><span class="p">::</span><span class="n">bridge_producer_consumer</span><span class="p">::</span><span class="n">helper</span><span class="p">::{{</span><span class="n">closure</span><span class="p">}}</span>
<span class="w">  </span><span class="mi">90</span><span class="p">:</span><span class="w"> </span><span class="nc">rayon_core</span><span class="p">::</span><span class="n">join</span><span class="p">::</span><span class="n">join_context</span><span class="p">::</span><span class="n">call_a</span><span class="p">::{{</span><span class="n">closure</span><span class="p">}}</span>
</code></pre></div>
<p>I noticed that the issue can be bypassed  if I lowered the log level of crate <code>log</code> from Debug to Warn.</p>
<p>I propose to double check the <code>user_named_funcs</code> length</p>
</blockquote>



<a name="484545165"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%239685%20Bug%20in%20loading%20Extern%20Function%20nam.../near/484545165" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.239685.20Bug.20in.20loading.20Extern.20Function.20nam.2E.2E.2E.html#484545165">(Nov 26 2024 at 15:52)</a>:</h4>
<p>alexcrichton <a href="https://github.com/bytecodealliance/wasmtime/issues/9685#issuecomment-2501227652">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/9685">issue #9685</a>:</p>
<blockquote>
<p>Could you inclue the steps necessary to reproduce this issue? For example can you link to or upload the wasm file you're using? What log level is needed? What command is used to trigger this? (etc)</p>
</blockquote>



<a name="484549586"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%239685%20Bug%20in%20loading%20Extern%20Function%20nam.../near/484549586" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.239685.20Bug.20in.20loading.20Extern.20Function.20nam.2E.2E.2E.html#484549586">(Nov 26 2024 at 16:14)</a>:</h4>
<p>bjorn3 <a href="https://github.com/bytecodealliance/wasmtime/issues/9685#issuecomment-2501279399">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/9685">issue #9685</a>:</p>
<blockquote>
<p>It looks like Wasmer generates a UserExternalNameRef out of thin air without registering it with <code>func.params()</code>: <a href="https://github.com/wasmerio/wasmer/blob/f5c417258dd54316c3983b47cbdc754aea32f2ff/lib/compiler-cranelift/src/func_environ.rs#L32">https://github.com/wasmerio/wasmer/blob/f5c417258dd54316c3983b47cbdc754aea32f2ff/lib/compiler-cranelift/src/func_environ.rs#L32</a>, <a href="https://github.com/wasmerio/wasmer/blob/f5c417258dd54316c3983b47cbdc754aea32f2ff/lib/compiler-cranelift/src/func_environ.rs#L1261-L1268">https://github.com/wasmerio/wasmer/blob/f5c417258dd54316c3983b47cbdc754aea32f2ff/lib/compiler-cranelift/src/func_environ.rs#L1261-L1268</a> rather than using <code>func.declare_imported_user_function()</code>. For comparison this is what Wasmtime does: <a href="https://github.com/bytecodealliance/wasmtime/blob/2b3fe80b65c4943428ec1d587bf35740cd977401/crates/cranelift/src/compiler.rs#L1022-L1034">https://github.com/bytecodealliance/wasmtime/blob/2b3fe80b65c4943428ec1d587bf35740cd977401/crates/cranelift/src/compiler.rs#L1022-L1034</a></p>
</blockquote>



<a name="484561565"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%239685%20Bug%20in%20loading%20Extern%20Function%20nam.../near/484561565" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.239685.20Bug.20in.20loading.20Extern.20Function.20nam.2E.2E.2E.html#484561565">(Nov 26 2024 at 17:17)</a>:</h4>
<p>AlaaAlHallaq <a href="https://github.com/bytecodealliance/wasmtime/issues/9685#issuecomment-2501510089">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/9685">issue #9685</a>:</p>
<blockquote>
<p>@bjorn3 I think you are right !<br>
@alexcrichton : I will attach the file &amp; the direct sample code of wasmer should trigger this bug using version 5.0.0-5.0.2, but a <code>logger</code> (with debug or trace level) should be configured to trigger this issue:</p>
<p><a href="https://github.com/user-attachments/files/17923127/frp.wasm.zip">frp.wasm.zip</a></p>
<p>Sample code to trigger the issue:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="k">use</span><span class="w"> </span><span class="n">std</span><span class="p">::{</span><span class="n">fs</span><span class="p">::</span><span class="n">File</span><span class="p">,</span><span class="w"> </span><span class="n">io</span><span class="p">::</span><span class="n">Read</span><span class="p">};</span>

<span class="k">use</span><span class="w"> </span><span class="n">wasmer</span><span class="p">::</span><span class="o">*</span><span class="p">;</span>
<span class="k">mod</span><span class="w"> </span><span class="nn">encoded</span><span class="p">;</span>
<span class="k">use</span><span class="w"> </span><span class="n">log</span><span class="p">::{</span><span class="n">Metadata</span><span class="p">,</span><span class="w"> </span><span class="n">Record</span><span class="p">};</span>

<span class="k">struct</span><span class="w"> </span><span class="nc">SimpleLogger</span><span class="p">;</span>
<span class="k">use</span><span class="w"> </span><span class="n">log</span><span class="p">::{</span><span class="n">LevelFilter</span><span class="p">,</span><span class="w"> </span><span class="n">SetLoggerError</span><span class="p">};</span>

<span class="k">fn</span><span class="w"> </span><span class="nf">main</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">setup_logger</span><span class="p">().</span><span class="n">unwrap</span><span class="p">();</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="p">(</span><span class="k">mut</span><span class="w"> </span><span class="n">store</span><span class="p">,</span><span class="w"> </span><span class="n">instance</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="n">compiler</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Cranelift</span><span class="p">::</span><span class="n">new</span><span class="p">();</span>
<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">store</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Store</span><span class="p">::</span><span class="n">new</span><span class="p">(</span><span class="n">compiler</span><span class="p">);</span>

<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="n">data</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">file</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">File</span><span class="p">::</span><span class="n">open</span><span class="p">(</span><span class="s">"PATH/to/frp.wasm"</span><span class="p">).</span><span class="n">unwrap</span><span class="p">();</span>
<span class="w">            </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">vec</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">Vec</span><span class="p">::</span><span class="n">new</span><span class="p">();</span>
<span class="w">            </span><span class="n">file</span><span class="p">.</span><span class="n">read_to_end</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="n">vec</span><span class="p">).</span><span class="n">unwrap</span><span class="p">();</span>
<span class="w">            </span><span class="n">vec</span>
<span class="w">        </span><span class="p">};</span>
<span class="w">        </span><span class="c1">// this is where the panic is triggered, while compiling the wasm file.</span>
<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="n">module</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">wasmer</span><span class="p">::</span><span class="n">Module</span><span class="p">::</span><span class="n">from_binary</span><span class="p">(</span><span class="o">&amp;</span><span class="n">store</span><span class="p">,</span><span class="w"> </span><span class="n">data</span><span class="p">.</span><span class="n">as_slice</span><span class="p">()).</span><span class="n">unwrap</span><span class="p">();</span>

<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">imports</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Imports</span><span class="p">::</span><span class="n">new</span><span class="p">();</span>
<span class="w">        </span><span class="n">define_imports</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="n">store</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="n">imports</span><span class="p">);</span>
<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="n">instance</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Instance</span><span class="p">::</span><span class="n">new</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="n">store</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">module</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="n">imports</span><span class="p">).</span><span class="n">unwrap</span><span class="p">();</span>
<span class="w">        </span><span class="p">(</span><span class="n">store</span><span class="p">,</span><span class="w"> </span><span class="n">instance</span><span class="p">)</span>
<span class="w">    </span><span class="p">};</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">initialize</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">instance</span><span class="p">.</span><span class="n">exports</span><span class="p">.</span><span class="n">get_function</span><span class="p">(</span><span class="s">"_initialize"</span><span class="p">).</span><span class="n">unwrap</span><span class="p">();</span>
<span class="w">    </span><span class="n">initialize</span><span class="p">.</span><span class="n">call</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="n">store</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="p">[]).</span><span class="n">unwrap</span><span class="p">();</span>

<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">mpfr_t</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">instance</span><span class="p">.</span><span class="n">exports</span><span class="p">.</span><span class="n">get_function</span><span class="p">(</span><span class="s">"r_t"</span><span class="p">).</span><span class="n">unwrap</span><span class="p">();</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">v</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">mpfr_t</span><span class="p">.</span><span class="n">call</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="n">store</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="p">[]).</span><span class="n">unwrap</span><span class="p">();</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">vr</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">v</span><span class="p">.</span><span class="n">as_ref</span><span class="p">();</span>
<span class="w">    </span><span class="fm">println!</span><span class="p">(</span><span class="s">"==&gt; init is :{:?}"</span><span class="p">,</span><span class="w"> </span><span class="n">vr</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span><span class="w"> </span><span class="n">LOGGER</span><span class="p">:</span><span class="w"> </span><span class="nc">SimpleLogger</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">SimpleLogger</span><span class="p">;</span>

<span class="k">pub</span><span class="w"> </span><span class="k">fn</span><span class="w"> </span><span class="nf">setup_logger</span><span class="p">()</span><span class="w"> </span><span class="p">-&gt;</span><span class="w"> </span><span class="nb">Result</span><span class="o">&lt;</span><span class="p">(),</span><span class="w"> </span><span class="n">SetLoggerError</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">log</span><span class="p">::</span><span class="n">set_logger</span><span class="p">(</span><span class="o">&amp;</span><span class="n">LOGGER</span><span class="p">).</span><span class="n">map</span><span class="p">(</span><span class="o">|</span><span class="p">()</span><span class="o">|</span><span class="w"> </span><span class="n">log</span><span class="p">::</span><span class="n">set_max_level</span><span class="p">(</span><span class="n">LevelFilter</span><span class="p">::</span><span class="n">Trace</span><span class="p">))</span>
<span class="p">}</span>
<span class="k">impl</span><span class="w"> </span><span class="n">log</span><span class="p">::</span><span class="n">Log</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">SimpleLogger</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">fn</span><span class="w"> </span><span class="nf">enabled</span><span class="p">(</span><span class="o">&amp;</span><span class="bp">self</span><span class="p">,</span><span class="w"> </span><span class="n">metadata</span><span class="p">:</span><span class="w"> </span><span class="kp">&amp;</span><span class="nc">Metadata</span><span class="p">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w"> </span><span class="kt">bool</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="c1">//metadata.level() &lt;= Level::Info</span>
<span class="w">        </span><span class="kc">true</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="k">fn</span><span class="w"> </span><span class="nf">log</span><span class="p">(</span><span class="o">&amp;</span><span class="bp">self</span><span class="p">,</span><span class="w"> </span><span class="n">record</span><span class="p">:</span><span class="w"> </span><span class="kp">&amp;</span><span class="nc">Record</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="bp">self</span><span class="p">.</span><span class="n">enabled</span><span class="p">(</span><span class="n">record</span><span class="p">.</span><span class="n">metadata</span><span class="p">())</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="fm">println!</span><span class="p">(</span><span class="s">"{} - {}"</span><span class="p">,</span><span class="w"> </span><span class="n">record</span><span class="p">.</span><span class="n">level</span><span class="p">(),</span><span class="w"> </span><span class="n">record</span><span class="p">.</span><span class="n">args</span><span class="p">());</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="k">fn</span><span class="w"> </span><span class="nf">flush</span><span class="p">(</span><span class="o">&amp;</span><span class="bp">self</span><span class="p">)</span><span class="w"> </span><span class="p">{}</span>
<span class="p">}</span>

<span class="k">fn</span><span class="w"> </span><span class="nf">define_imports</span><span class="p">(</span><span class="n">store</span><span class="p">:</span><span class="w"> </span><span class="kp">&amp;</span><span class="nc">mut</span><span class="w"> </span><span class="n">Store</span><span class="p">,</span><span class="w"> </span><span class="n">imports</span><span class="p">:</span><span class="w"> </span><span class="kp">&amp;</span><span class="nc">mut</span><span class="w"> </span><span class="n">Imports</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">define_function</span><span class="p">(</span>
<span class="w">        </span><span class="s">"wasi_snapshot_preview1"</span><span class="p">.</span><span class="n">to_string</span><span class="p">(),</span>
<span class="w">        </span><span class="s">"fd_seek"</span><span class="p">.</span><span class="n">to_string</span><span class="p">(),</span>
<span class="w">        </span><span class="n">imports</span><span class="p">,</span>
<span class="w">        </span><span class="n">store</span><span class="p">,</span>
<span class="w">        </span><span class="p">(),</span>
<span class="w">        </span><span class="n">FunctionType</span><span class="p">::</span><span class="n">new</span><span class="p">(</span>
<span class="w">            </span><span class="fm">vec!</span><span class="p">[</span><span class="n">Type</span><span class="p">::</span><span class="n">I32</span><span class="p">,</span><span class="w"> </span><span class="n">Type</span><span class="p">::</span><span class="n">I64</span><span class="p">,</span><span class="w"> </span><span class="n">Type</span><span class="p">::</span><span class="n">I32</span><span class="p">,</span><span class="w"> </span><span class="n">Type</span><span class="p">::</span><span class="n">I32</span><span class="p">],</span>
<span class="w">            </span><span class="fm">vec!</span><span class="p">[</span><span class="n">Type</span><span class="p">::</span><span class="n">I32</span><span class="p">],</span>
<span class="w">        </span><span class="p">),</span>
<span class="w">        </span><span class="o">|</span><span class="n">env</span><span class="p">,</span><span class="w"> </span><span class="n">args</span><span class="o">|</span><span class="w"> </span><span class="nb">Result</span><span class="p">::</span><span class="nb">Ok</span><span class="p">(</span><span class="fm">vec!</span><span class="p">[</span><span class="n">Value</span><span class="p">::</span><span class="n">I32</span><span class="p">(</span><span class="mi">0</span><span class="p">)]),</span>
<span class="w">    </span><span class="p">);</span>

<span class="w">    </span><span class="n">define_function</span><span class="p">(</span>
<span class="w">        </span><span class="s">"wasi_snapshot_preview1"</span><span class="p">.</span><span class="n">to_string</span><span class="p">(),</span>
<span class="w">        </span><span class="s">"fd_write"</span><span class="p">.</span><span class="n">to_string</span><span class="p">(),</span>
<span class="w">        </span><span class="n">imports</span><span class="p">,</span>
<span class="w">        </span><span class="n">store</span><span class="p">,</span>
<span class="w">        </span><span class="p">(),</span>
<span class="w">        </span><span class="n">FunctionType</span><span class="p">::</span><span class="n">new</span><span class="p">(</span>
<span class="w">            </span><span class="fm">vec!</span><span class="p">[</span><span class="n">Type</span><span class="p">::</span><span class="n">I32</span><span class="p">,</span><span class="w"> </span><span class="n">Type</span><span class="p">::</span><span class="n">I32</span><span class="p">,</span><span class="w"> </span><span class="n">Type</span><span class="p">::</span><span class="n">I32</span><span class="p">,</span><span class="w"> </span><span class="n">Type</span><span class="p">::</span><span class="n">I32</span><span class="p">],</span>
<span class="w">            </span><span class="fm">vec!</span><span class="p">[</span><span class="n">Type</span><span class="p">::</span><span class="n">I32</span><span class="p">],</span>
<span class="w">        </span><span class="p">),</span>
<span class="w">        </span><span class="o">|</span><span class="n">env</span><span class="p">,</span><span class="w"> </span><span class="n">args</span><span class="o">|</span><span class="w"> </span><span class="nb">Result</span><span class="p">::</span><span class="nb">Ok</span><span class="p">(</span><span class="fm">vec!</span><span class="p">[</span><span class="n">Value</span><span class="p">::</span><span class="n">I32</span><span class="p">(</span><span class="mi">0</span><span class="p">)]),</span>
<span class="w">    </span><span class="p">);</span>

<span class="w">    </span><span class="n">define_function</span><span class="p">(</span>
<span class="w">        </span><span class="s">"wasi_snapshot_preview1"</span><span class="p">.</span><span class="n">to_string</span><span class="p">(),</span>
<span class="w">        </span><span class="s">"fd_close"</span><span class="p">.</span><span class="n">to_string</span><span class="p">(),</span>
<span class="w">        </span><span class="n">imports</span><span class="p">,</span>
<span class="w">        </span><span class="n">store</span><span class="p">,</span>
<span class="w">        </span><span class="p">(),</span>
<span class="w">        </span><span class="n">FunctionType</span><span class="p">::</span><span class="n">new</span><span class="p">(</span><span class="fm">vec!</span><span class="p">[</span><span class="n">Type</span><span class="p">::</span><span class="n">I32</span><span class="p">],</span><span class="w"> </span><span class="fm">vec!</span><span class="p">[</span><span class="n">Type</span><span class="p">::</span><span class="n">I32</span><span class="p">]),</span>
<span class="w">        </span><span class="o">|</span><span class="n">env</span><span class="p">,</span><span class="w"> </span><span class="n">args</span><span class="o">|</span><span class="w"> </span><span class="nb">Result</span><span class="p">::</span><span class="nb">Ok</span><span class="p">(</span><span class="fm">vec!</span><span class="p">[</span><span class="n">Value</span><span class="p">::</span><span class="n">I32</span><span class="p">(</span><span class="mi">0</span><span class="p">)]),</span>
<span class="w">    </span><span class="p">);</span>
<span class="w">    </span><span class="n">define_function</span><span class="p">(</span>
<span class="w">        </span><span class="s">"wasi_snapshot_preview1"</span><span class="p">.</span><span class="n">to_string</span><span class="p">(),</span>
<span class="w">        </span><span class="s">"proc_exit"</span><span class="p">.</span><span class="n">to_string</span><span class="p">(),</span>
<span class="w">        </span><span class="n">imports</span><span class="p">,</span>
<span class="w">        </span><span class="n">store</span><span class="p">,</span>
<span class="w">        </span><span class="p">(),</span>
<span class="w">        </span><span class="n">FunctionType</span><span class="p">::</span><span class="n">new</span><span class="p">(</span><span class="fm">vec!</span><span class="p">[</span><span class="n">Type</span><span class="p">::</span><span class="n">I32</span><span class="p">],</span><span class="w"> </span><span class="fm">vec!</span><span class="p">[]),</span>
<span class="w">        </span><span class="o">|</span><span class="n">env</span><span class="p">,</span><span class="w"> </span><span class="n">args</span><span class="o">|</span><span class="w"> </span><span class="nb">Result</span><span class="p">::</span><span class="nb">Ok</span><span class="p">(</span><span class="fm">vec!</span><span class="p">[</span><span class="n">Value</span><span class="p">::</span><span class="n">I32</span><span class="p">(</span><span class="mi">0</span><span class="p">)]),</span>
<span class="w">    </span><span class="p">);</span>
<span class="w">    </span><span class="n">define_function</span><span class="p">(</span>
<span class="w">        </span><span class="s">"env"</span><span class="p">.</span><span class="n">to_string</span><span class="p">(),</span>
<span class="w">        </span><span class="s">"emscripten_notify_memory_growth"</span><span class="p">.</span><span class="n">to_string</span><span class="p">(),</span>
<span class="w">        </span><span class="n">imports</span><span class="p">,</span>
<span class="w">        </span><span class="n">store</span><span class="p">,</span>
<span class="w">        </span><span class="p">(),</span>
<span class="w">        </span><span class="n">FunctionType</span><span class="p">::</span><span class="n">new</span><span class="p">(</span><span class="fm">vec!</span><span class="p">[</span><span class="n">Type</span><span class="p">::</span><span class="n">I32</span><span class="p">],</span><span class="w"> </span><span class="fm">vec!</span><span class="p">[]),</span>
<span class="w">        </span><span class="o">|</span><span class="n">env</span><span class="p">,</span><span class="w"> </span><span class="n">args</span><span class="o">|</span><span class="w"> </span><span class="nb">Result</span><span class="p">::</span><span class="nb">Ok</span><span class="p">(</span><span class="fm">vec!</span><span class="p">[</span><span class="n">Value</span><span class="p">::</span><span class="n">I32</span><span class="p">(</span><span class="mi">0</span><span class="p">)]),</span>
<span class="w">    </span><span class="p">);</span>
<span class="p">}</span>
<span class="k">fn</span><span class="w"> </span><span class="nf">define_function</span><span class="o">&lt;</span><span class="n">F</span><span class="p">,</span><span class="w"> </span><span class="n">T</span><span class="o">&gt;</span><span class="p">(</span>
<span class="w">    </span><span class="n">ns</span><span class="p">:</span><span class="w"> </span><span class="nb">String</span><span class="p">,</span>
<span class="w">    </span><span class="n">name</span><span class="p">:</span><span class="w"> </span><span class="nb">String</span><span class="p">,</span>
<span class="w">    </span><span class="n">imports</span><span class="p">:</span><span class="w"> </span><span class="kp">&amp;</span><span class="nc">mut</span><span class="w"> </span><span class="n">Imports</span><span class="p">,</span>
<span class="w">    </span><span class="n">store</span><span class="p">:</span><span class="w"> </span><span class="kp">&amp;</span><span class="nc">mut</span><span class="w"> </span><span class="n">Store</span><span class="p">,</span>
<span class="w">    </span><span class="n">data</span><span class="p">:</span><span class="w"> </span><span class="nc">T</span><span class="p">,</span>
<span class="w">    </span><span class="n">ty</span><span class="p">:</span><span class="w"> </span><span class="nc">FunctionType</span><span class="p">,</span>
<span class="w">    </span><span class="n">f</span><span class="p">:</span><span class="w"> </span><span class="nc">F</span><span class="p">,</span>
<span class="p">)</span><span class="w"> </span><span class="k">where</span>
<span class="w">    </span><span class="n">F</span><span class="p">:</span><span class="w"> </span><span class="nb">Fn</span><span class="p">(</span><span class="n">FunctionEnvMut</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="p">[</span><span class="n">Value</span><span class="p">])</span><span class="w"> </span><span class="p">-&gt;</span><span class="w"> </span><span class="nb">Result</span><span class="o">&lt;</span><span class="nb">Vec</span><span class="o">&lt;</span><span class="n">Value</span><span class="o">&gt;</span><span class="p">,</span><span class="w"> </span><span class="n">RuntimeError</span><span class="o">&gt;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="o">'</span><span class="nb">static</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nb">Send</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nb">Sync</span><span class="p">,</span>
<span class="w">    </span><span class="n">T</span><span class="p">:</span><span class="w"> </span><span class="o">'</span><span class="nb">static</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nb">Send</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nb">Sync</span><span class="p">,</span>
<span class="p">{</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">env</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">FunctionEnv</span><span class="p">::</span><span class="n">new</span><span class="p">(</span><span class="n">store</span><span class="p">,</span><span class="w"> </span><span class="n">data</span><span class="p">);</span>
<span class="w">    </span><span class="n">imports</span><span class="p">.</span><span class="n">define</span><span class="p">(</span>
<span class="w">        </span><span class="n">ns</span><span class="p">.</span><span class="n">as_str</span><span class="p">(),</span>
<span class="w">        </span><span class="n">name</span><span class="p">.</span><span class="n">as_str</span><span class="p">(),</span>
<span class="w">        </span><span class="n">Function</span><span class="p">::</span><span class="n">new_with_env</span><span class="p">(</span><span class="n">store</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">env</span><span class="p">,</span><span class="w"> </span><span class="n">ty</span><span class="p">,</span><span class="w"> </span><span class="n">f</span><span class="p">),</span>
<span class="w">    </span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div>
</blockquote>



<a name="484561628"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%239685%20Bug%20in%20loading%20Extern%20Function%20nam.../near/484561628" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.239685.20Bug.20in.20loading.20Extern.20Function.20nam.2E.2E.2E.html#484561628">(Nov 26 2024 at 17:17)</a>:</h4>
<p>AlaaAlHallaq edited a <a href="https://github.com/bytecodealliance/wasmtime/issues/9685#issuecomment-2501510089">comment</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/9685">issue #9685</a>:</p>
<blockquote>
<p>@bjorn3 I think you are right !<br>
@alexcrichton : I will attach the file &amp; the direct sample code of wasmer should trigger this bug using version 5.0.0-5.0.2, but a <code>logger</code> (with debug or trace level) should be configured to trigger this issue:</p>
<p><a href="https://github.com/user-attachments/files/17923127/frp.wasm.zip">frp.wasm.zip</a></p>
<p>Sample code to trigger the issue:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="k">use</span><span class="w"> </span><span class="n">std</span><span class="p">::{</span><span class="n">fs</span><span class="p">::</span><span class="n">File</span><span class="p">,</span><span class="w"> </span><span class="n">io</span><span class="p">::</span><span class="n">Read</span><span class="p">};</span>

<span class="k">use</span><span class="w"> </span><span class="n">wasmer</span><span class="p">::</span><span class="o">*</span><span class="p">;</span>
<span class="k">mod</span><span class="w"> </span><span class="nn">encoded</span><span class="p">;</span>
<span class="k">use</span><span class="w"> </span><span class="n">log</span><span class="p">::{</span><span class="n">Metadata</span><span class="p">,</span><span class="w"> </span><span class="n">Record</span><span class="p">};</span>

<span class="k">struct</span><span class="w"> </span><span class="nc">SimpleLogger</span><span class="p">;</span>
<span class="k">use</span><span class="w"> </span><span class="n">log</span><span class="p">::{</span><span class="n">LevelFilter</span><span class="p">,</span><span class="w"> </span><span class="n">SetLoggerError</span><span class="p">};</span>

<span class="k">fn</span><span class="w"> </span><span class="nf">main</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">setup_logger</span><span class="p">().</span><span class="n">unwrap</span><span class="p">();</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="p">(</span><span class="k">mut</span><span class="w"> </span><span class="n">store</span><span class="p">,</span><span class="w"> </span><span class="n">instance</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="n">compiler</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Cranelift</span><span class="p">::</span><span class="n">new</span><span class="p">();</span>
<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">store</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Store</span><span class="p">::</span><span class="n">new</span><span class="p">(</span><span class="n">compiler</span><span class="p">);</span>

<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="n">data</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">file</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">File</span><span class="p">::</span><span class="n">open</span><span class="p">(</span><span class="s">"PATH/to/frp.wasm"</span><span class="p">).</span><span class="n">unwrap</span><span class="p">();</span>
<span class="w">            </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">vec</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">Vec</span><span class="p">::</span><span class="n">new</span><span class="p">();</span>
<span class="w">            </span><span class="n">file</span><span class="p">.</span><span class="n">read_to_end</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="n">vec</span><span class="p">).</span><span class="n">unwrap</span><span class="p">();</span>
<span class="w">            </span><span class="n">vec</span>
<span class="w">        </span><span class="p">};</span>
<span class="w">        </span><span class="c1">// this is where the panic is triggered, while compiling the wasm file.</span>
<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="n">module</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">wasmer</span><span class="p">::</span><span class="n">Module</span><span class="p">::</span><span class="n">from_binary</span><span class="p">(</span><span class="o">&amp;</span><span class="n">store</span><span class="p">,</span><span class="w"> </span><span class="n">data</span><span class="p">.</span><span class="n">as_slice</span><span class="p">()).</span><span class="n">unwrap</span><span class="p">();</span>

<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">imports</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Imports</span><span class="p">::</span><span class="n">new</span><span class="p">();</span>
<span class="w">        </span><span class="n">define_imports</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="n">store</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="n">imports</span><span class="p">);</span>
<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="n">instance</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Instance</span><span class="p">::</span><span class="n">new</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="n">store</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">module</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="n">imports</span><span class="p">).</span><span class="n">unwrap</span><span class="p">();</span>
<span class="w">        </span><span class="p">(</span><span class="n">store</span><span class="p">,</span><span class="w"> </span><span class="n">instance</span><span class="p">)</span>
<span class="w">    </span><span class="p">};</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">initialize</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">instance</span><span class="p">.</span><span class="n">exports</span><span class="p">.</span><span class="n">get_function</span><span class="p">(</span><span class="s">"_initialize"</span><span class="p">).</span><span class="n">unwrap</span><span class="p">();</span>
<span class="w">    </span><span class="n">initialize</span><span class="p">.</span><span class="n">call</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="n">store</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="p">[]).</span><span class="n">unwrap</span><span class="p">();</span>

<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">mpfr_t</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">instance</span><span class="p">.</span><span class="n">exports</span><span class="p">.</span><span class="n">get_function</span><span class="p">(</span><span class="s">"r_t"</span><span class="p">).</span><span class="n">unwrap</span><span class="p">();</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">v</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">mpfr_t</span><span class="p">.</span><span class="n">call</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="n">store</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="p">[]).</span><span class="n">unwrap</span><span class="p">();</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">vr</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">v</span><span class="p">.</span><span class="n">as_ref</span><span class="p">();</span>
<span class="w">    </span><span class="fm">println!</span><span class="p">(</span><span class="s">"==&gt; init is :{:?}"</span><span class="p">,</span><span class="w"> </span><span class="n">vr</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span><span class="w"> </span><span class="n">LOGGER</span><span class="p">:</span><span class="w"> </span><span class="nc">SimpleLogger</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">SimpleLogger</span><span class="p">;</span>

<span class="k">pub</span><span class="w"> </span><span class="k">fn</span><span class="w"> </span><span class="nf">setup_logger</span><span class="p">()</span><span class="w"> </span><span class="p">-&gt;</span><span class="w"> </span><span class="nb">Result</span><span class="o">&lt;</span><span class="p">(),</span><span class="w"> </span><span class="n">SetLoggerError</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">log</span><span class="p">::</span><span class="n">set_logger</span><span class="p">(</span><span class="o">&amp;</span><span class="n">LOGGER</span><span class="p">).</span><span class="n">map</span><span class="p">(</span><span class="o">|</span><span class="p">()</span><span class="o">|</span><span class="w"> </span><span class="n">log</span><span class="p">::</span><span class="n">set_max_level</span><span class="p">(</span><span class="n">LevelFilter</span><span class="p">::</span><span class="n">Trace</span><span class="p">))</span>
<span class="p">}</span>
<span class="k">impl</span><span class="w"> </span><span class="n">log</span><span class="p">::</span><span class="n">Log</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">SimpleLogger</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">fn</span><span class="w"> </span><span class="nf">enabled</span><span class="p">(</span><span class="o">&amp;</span><span class="bp">self</span><span class="p">,</span><span class="w"> </span><span class="n">metadata</span><span class="p">:</span><span class="w"> </span><span class="kp">&amp;</span><span class="nc">Metadata</span><span class="p">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w"> </span><span class="kt">bool</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="c1">//metadata.level() &lt;= Level::Info</span>
<span class="w">        </span><span class="kc">true</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="k">fn</span><span class="w"> </span><span class="nf">log</span><span class="p">(</span><span class="o">&amp;</span><span class="bp">self</span><span class="p">,</span><span class="w"> </span><span class="n">record</span><span class="p">:</span><span class="w"> </span><span class="kp">&amp;</span><span class="nc">Record</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="bp">self</span><span class="p">.</span><span class="n">enabled</span><span class="p">(</span><span class="n">record</span><span class="p">.</span><span class="n">metadata</span><span class="p">())</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="fm">println!</span><span class="p">(</span><span class="s">"{} - {}"</span><span class="p">,</span><span class="w"> </span><span class="n">record</span><span class="p">.</span><span class="n">level</span><span class="p">(),</span><span class="w"> </span><span class="n">record</span><span class="p">.</span><span class="n">args</span><span class="p">());</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="k">fn</span><span class="w"> </span><span class="nf">flush</span><span class="p">(</span><span class="o">&amp;</span><span class="bp">self</span><span class="p">)</span><span class="w"> </span><span class="p">{}</span>
<span class="p">}</span>

<span class="k">fn</span><span class="w"> </span><span class="nf">define_imports</span><span class="p">(</span><span class="n">store</span><span class="p">:</span><span class="w"> </span><span class="kp">&amp;</span><span class="nc">mut</span><span class="w"> </span><span class="n">Store</span><span class="p">,</span><span class="w"> </span><span class="n">imports</span><span class="p">:</span><span class="w"> </span><span class="kp">&amp;</span><span class="nc">mut</span><span class="w"> </span><span class="n">Imports</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">define_function</span><span class="p">(</span>
<span class="w">        </span><span class="s">"wasi_snapshot_preview1"</span><span class="p">.</span><span class="n">to_string</span><span class="p">(),</span>
<span class="w">        </span><span class="s">"fd_seek"</span><span class="p">.</span><span class="n">to_string</span><span class="p">(),</span>
<span class="w">        </span><span class="n">imports</span><span class="p">,</span>
<span class="w">        </span><span class="n">store</span><span class="p">,</span>
<span class="w">        </span><span class="p">(),</span>
<span class="w">        </span><span class="n">FunctionType</span><span class="p">::</span><span class="n">new</span><span class="p">(</span>
<span class="w">            </span><span class="fm">vec!</span><span class="p">[</span><span class="n">Type</span><span class="p">::</span><span class="n">I32</span><span class="p">,</span><span class="w"> </span><span class="n">Type</span><span class="p">::</span><span class="n">I64</span><span class="p">,</span><span class="w"> </span><span class="n">Type</span><span class="p">::</span><span class="n">I32</span><span class="p">,</span><span class="w"> </span><span class="n">Type</span><span class="p">::</span><span class="n">I32</span><span class="p">],</span>
<span class="w">            </span><span class="fm">vec!</span><span class="p">[</span><span class="n">Type</span><span class="p">::</span><span class="n">I32</span><span class="p">],</span>
<span class="w">        </span><span class="p">),</span>
<span class="w">        </span><span class="o">|</span><span class="n">env</span><span class="p">,</span><span class="w"> </span><span class="n">args</span><span class="o">|</span><span class="w"> </span><span class="nb">Result</span><span class="p">::</span><span class="nb">Ok</span><span class="p">(</span><span class="fm">vec!</span><span class="p">[</span><span class="n">Value</span><span class="p">::</span><span class="n">I32</span><span class="p">(</span><span class="mi">0</span><span class="p">)]),</span>
<span class="w">    </span><span class="p">);</span>

<span class="w">    </span><span class="n">define_function</span><span class="p">(</span>
<span class="w">        </span><span class="s">"wasi_snapshot_preview1"</span><span class="p">.</span><span class="n">to_string</span><span class="p">(),</span>
<span class="w">        </span><span class="s">"fd_write"</span><span class="p">.</span><span class="n">to_string</span><span class="p">(),</span>
<span class="w">        </span><span class="n">imports</span><span class="p">,</span>
<span class="w">        </span><span class="n">store</span><span class="p">,</span>
<span class="w">        </span><span class="p">(),</span>
<span class="w">        </span><span class="n">FunctionType</span><span class="p">::</span><span class="n">new</span><span class="p">(</span>
<span class="w">            </span><span class="fm">vec!</span><span class="p">[</span><span class="n">Type</span><span class="p">::</span><span class="n">I32</span><span class="p">,</span><span class="w"> </span><span class="n">Type</span><span class="p">::</span><span class="n">I32</span><span class="p">,</span><span class="w"> </span><span class="n">Type</span><span class="p">::</span><span class="n">I32</span><span class="p">,</span><span class="w"> </span><span class="n">Type</span><span class="p">::</span><span class="n">I32</span><span class="p">],</span>
<span class="w">            </span><span class="fm">vec!</span><span class="p">[</span><span class="n">Type</span><span class="p">::</span><span class="n">I32</span><span class="p">],</span>
<span class="w">        </span><span class="p">),</span>
<span class="w">        </span><span class="o">|</span><span class="n">env</span><span class="p">,</span><span class="w"> </span><span class="n">args</span><span class="o">|</span><span class="w"> </span><span class="nb">Result</span><span class="p">::</span><span class="nb">Ok</span><span class="p">(</span><span class="fm">vec!</span><span class="p">[</span><span class="n">Value</span><span class="p">::</span><span class="n">I32</span><span class="p">(</span><span class="mi">0</span><span class="p">)]),</span>
<span class="w">    </span><span class="p">);</span>

<span class="w">    </span><span class="n">define_function</span><span class="p">(</span>
<span class="w">        </span><span class="s">"wasi_snapshot_preview1"</span><span class="p">.</span><span class="n">to_string</span><span class="p">(),</span>
<span class="w">        </span><span class="s">"fd_close"</span><span class="p">.</span><span class="n">to_string</span><span class="p">(),</span>
<span class="w">        </span><span class="n">imports</span><span class="p">,</span>
<span class="w">        </span><span class="n">store</span><span class="p">,</span>
<span class="w">        </span><span class="p">(),</span>
<span class="w">        </span><span class="n">FunctionType</span><span class="p">::</span><span class="n">new</span><span class="p">(</span><span class="fm">vec!</span><span class="p">[</span><span class="n">Type</span><span class="p">::</span><span class="n">I32</span><span class="p">],</span><span class="w"> </span><span class="fm">vec!</span><span class="p">[</span><span class="n">Type</span><span class="p">::</span><span class="n">I32</span><span class="p">]),</span>
<span class="w">        </span><span class="o">|</span><span class="n">env</span><span class="p">,</span><span class="w"> </span><span class="n">args</span><span class="o">|</span><span class="w"> </span><span class="nb">Result</span><span class="p">::</span><span class="nb">Ok</span><span class="p">(</span><span class="fm">vec!</span><span class="p">[</span><span class="n">Value</span><span class="p">::</span><span class="n">I32</span><span class="p">(</span><span class="mi">0</span><span class="p">)]),</span>
<span class="w">    </span><span class="p">);</span>
<span class="w">    </span><span class="n">define_function</span><span class="p">(</span>
<span class="w">        </span><span class="s">"wasi_snapshot_preview1"</span><span class="p">.</span><span class="n">to_string</span><span class="p">(),</span>
<span class="w">        </span><span class="s">"proc_exit"</span><span class="p">.</span><span class="n">to_string</span><span class="p">(),</span>
<span class="w">        </span><span class="n">imports</span><span class="p">,</span>
<span class="w">        </span><span class="n">store</span><span class="p">,</span>
<span class="w">        </span><span class="p">(),</span>
<span class="w">        </span><span class="n">FunctionType</span><span class="p">::</span><span class="n">new</span><span class="p">(</span><span class="fm">vec!</span><span class="p">[</span><span class="n">Type</span><span class="p">::</span><span class="n">I32</span><span class="p">],</span><span class="w"> </span><span class="fm">vec!</span><span class="p">[]),</span>
<span class="w">        </span><span class="o">|</span><span class="n">env</span><span class="p">,</span><span class="w"> </span><span class="n">args</span><span class="o">|</span><span class="w"> </span><span class="nb">Result</span><span class="p">::</span><span class="nb">Ok</span><span class="p">(</span><span class="fm">vec!</span><span class="p">[</span><span class="n">Value</span><span class="p">::</span><span class="n">I32</span><span class="p">(</span><span class="mi">0</span><span class="p">)]),</span>
<span class="w">    </span><span class="p">);</span>
<span class="w">    </span><span class="n">define_function</span><span class="p">(</span>
<span class="w">        </span><span class="s">"env"</span><span class="p">.</span><span class="n">to_string</span><span class="p">(),</span>
<span class="w">        </span><span class="s">"emscripten_notify_memory_growth"</span><span class="p">.</span><span class="n">to_string</span><span class="p">(),</span>
<span class="w">        </span><span class="n">imports</span><span class="p">,</span>
<span class="w">        </span><span class="n">store</span><span class="p">,</span>
<span class="w">        </span><span class="p">(),</span>
<span class="w">        </span><span class="n">FunctionType</span><span class="p">::</span><span class="n">new</span><span class="p">(</span><span class="fm">vec!</span><span class="p">[</span><span class="n">Type</span><span class="p">::</span><span class="n">I32</span><span class="p">],</span><span class="w"> </span><span class="fm">vec!</span><span class="p">[]),</span>
<span class="w">        </span><span class="o">|</span><span class="n">env</span><span class="p">,</span><span class="w"> </span><span class="n">args</span><span class="o">|</span><span class="w"> </span><span class="nb">Result</span><span class="p">::</span><span class="nb">Ok</span><span class="p">(</span><span class="fm">vec!</span><span class="p">[</span><span class="n">Value</span><span class="p">::</span><span class="n">I32</span><span class="p">(</span><span class="mi">0</span><span class="p">)]),</span>
<span class="w">    </span><span class="p">);</span>
<span class="p">}</span>
<span class="k">fn</span><span class="w"> </span><span class="nf">define_function</span><span class="o">&lt;</span><span class="n">F</span><span class="p">,</span><span class="w"> </span><span class="n">T</span><span class="o">&gt;</span><span class="p">(</span>
<span class="w">    </span><span class="n">ns</span><span class="p">:</span><span class="w"> </span><span class="nb">String</span><span class="p">,</span>
<span class="w">    </span><span class="n">name</span><span class="p">:</span><span class="w"> </span><span class="nb">String</span><span class="p">,</span>
<span class="w">    </span><span class="n">imports</span><span class="p">:</span><span class="w"> </span><span class="kp">&amp;</span><span class="nc">mut</span><span class="w"> </span><span class="n">Imports</span><span class="p">,</span>
<span class="w">    </span><span class="n">store</span><span class="p">:</span><span class="w"> </span><span class="kp">&amp;</span><span class="nc">mut</span><span class="w"> </span><span class="n">Store</span><span class="p">,</span>
<span class="w">    </span><span class="n">data</span><span class="p">:</span><span class="w"> </span><span class="nc">T</span><span class="p">,</span>
<span class="w">    </span><span class="n">ty</span><span class="p">:</span><span class="w"> </span><span class="nc">FunctionType</span><span class="p">,</span>
<span class="w">    </span><span class="n">f</span><span class="p">:</span><span class="w"> </span><span class="nc">F</span><span class="p">,</span>
<span class="p">)</span><span class="w"> </span><span class="k">where</span>
<span class="w">    </span><span class="n">F</span><span class="p">:</span><span class="w"> </span><span class="nb">Fn</span><span class="p">(</span><span class="n">FunctionEnvMut</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="p">[</span><span class="n">Value</span><span class="p">])</span><span class="w"> </span><span class="p">-&gt;</span><span class="w"> </span><span class="nb">Result</span><span class="o">&lt;</span><span class="nb">Vec</span><span class="o">&lt;</span><span class="n">Value</span><span class="o">&gt;</span><span class="p">,</span><span class="w"> </span><span class="n">RuntimeError</span><span class="o">&gt;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="o">'</span><span class="nb">static</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nb">Send</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nb">Sync</span><span class="p">,</span>
<span class="w">    </span><span class="n">T</span><span class="p">:</span><span class="w"> </span><span class="o">'</span><span class="nb">static</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nb">Send</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nb">Sync</span><span class="p">,</span>
<span class="p">{</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">env</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">FunctionEnv</span><span class="p">::</span><span class="n">new</span><span class="p">(</span><span class="n">store</span><span class="p">,</span><span class="w"> </span><span class="n">data</span><span class="p">);</span>
<span class="w">    </span><span class="n">imports</span><span class="p">.</span><span class="n">define</span><span class="p">(</span>
<span class="w">        </span><span class="n">ns</span><span class="p">.</span><span class="n">as_str</span><span class="p">(),</span>
<span class="w">        </span><span class="n">name</span><span class="p">.</span><span class="n">as_str</span><span class="p">(),</span>
<span class="w">        </span><span class="n">Function</span><span class="p">::</span><span class="n">new_with_env</span><span class="p">(</span><span class="n">store</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">env</span><span class="p">,</span><span class="w"> </span><span class="n">ty</span><span class="p">,</span><span class="w"> </span><span class="n">f</span><span class="p">),</span>
<span class="w">    </span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div>
</blockquote>



<a name="484561734"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%239685%20Bug%20in%20loading%20Extern%20Function%20nam.../near/484561734" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.239685.20Bug.20in.20loading.20Extern.20Function.20nam.2E.2E.2E.html#484561734">(Nov 26 2024 at 17:18)</a>:</h4>
<p>AlaaAlHallaq edited a <a href="https://github.com/bytecodealliance/wasmtime/issues/9685#issuecomment-2501510089">comment</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/9685">issue #9685</a>:</p>
<blockquote>
<p>@bjorn3 I think you are right !<br>
@alexcrichton : I will attach the file &amp; the direct sample code of wasmer should trigger this bug using version 5.0.0-5.0.2, but a <code>logger</code> (with debug or trace level) should be configured to trigger this issue:</p>
<p><a href="https://github.com/user-attachments/files/17923127/frp.wasm.zip">frp.wasm.zip</a></p>
<p>Sample code to trigger the issue:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="k">use</span><span class="w"> </span><span class="n">std</span><span class="p">::{</span><span class="n">fs</span><span class="p">::</span><span class="n">File</span><span class="p">,</span><span class="w"> </span><span class="n">io</span><span class="p">::</span><span class="n">Read</span><span class="p">};</span>

<span class="k">use</span><span class="w"> </span><span class="n">wasmer</span><span class="p">::</span><span class="o">*</span><span class="p">;</span>
<span class="k">use</span><span class="w"> </span><span class="n">log</span><span class="p">::{</span><span class="n">Metadata</span><span class="p">,</span><span class="w"> </span><span class="n">Record</span><span class="p">};</span>

<span class="k">struct</span><span class="w"> </span><span class="nc">SimpleLogger</span><span class="p">;</span>
<span class="k">use</span><span class="w"> </span><span class="n">log</span><span class="p">::{</span><span class="n">LevelFilter</span><span class="p">,</span><span class="w"> </span><span class="n">SetLoggerError</span><span class="p">};</span>

<span class="k">fn</span><span class="w"> </span><span class="nf">main</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">setup_logger</span><span class="p">().</span><span class="n">unwrap</span><span class="p">();</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="p">(</span><span class="k">mut</span><span class="w"> </span><span class="n">store</span><span class="p">,</span><span class="w"> </span><span class="n">instance</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="n">compiler</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Cranelift</span><span class="p">::</span><span class="n">new</span><span class="p">();</span>
<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">store</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Store</span><span class="p">::</span><span class="n">new</span><span class="p">(</span><span class="n">compiler</span><span class="p">);</span>

<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="n">data</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">file</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">File</span><span class="p">::</span><span class="n">open</span><span class="p">(</span><span class="s">"PATH/to/frp.wasm"</span><span class="p">).</span><span class="n">unwrap</span><span class="p">();</span>
<span class="w">            </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">vec</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">Vec</span><span class="p">::</span><span class="n">new</span><span class="p">();</span>
<span class="w">            </span><span class="n">file</span><span class="p">.</span><span class="n">read_to_end</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="n">vec</span><span class="p">).</span><span class="n">unwrap</span><span class="p">();</span>
<span class="w">            </span><span class="n">vec</span>
<span class="w">        </span><span class="p">};</span>
<span class="w">        </span><span class="c1">// this is where the panic is triggered, while compiling the wasm file.</span>
<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="n">module</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">wasmer</span><span class="p">::</span><span class="n">Module</span><span class="p">::</span><span class="n">from_binary</span><span class="p">(</span><span class="o">&amp;</span><span class="n">store</span><span class="p">,</span><span class="w"> </span><span class="n">data</span><span class="p">.</span><span class="n">as_slice</span><span class="p">()).</span><span class="n">unwrap</span><span class="p">();</span>

<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">imports</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Imports</span><span class="p">::</span><span class="n">new</span><span class="p">();</span>
<span class="w">        </span><span class="n">define_imports</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="n">store</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="n">imports</span><span class="p">);</span>
<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="n">instance</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Instance</span><span class="p">::</span><span class="n">new</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="n">store</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">module</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="n">imports</span><span class="p">).</span><span class="n">unwrap</span><span class="p">();</span>
<span class="w">        </span><span class="p">(</span><span class="n">store</span><span class="p">,</span><span class="w"> </span><span class="n">instance</span><span class="p">)</span>
<span class="w">    </span><span class="p">};</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">initialize</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">instance</span><span class="p">.</span><span class="n">exports</span><span class="p">.</span><span class="n">get_function</span><span class="p">(</span><span class="s">"_initialize"</span><span class="p">).</span><span class="n">unwrap</span><span class="p">();</span>
<span class="w">    </span><span class="n">initialize</span><span class="p">.</span><span class="n">call</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="n">store</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="p">[]).</span><span class="n">unwrap</span><span class="p">();</span>

<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">mpfr_t</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">instance</span><span class="p">.</span><span class="n">exports</span><span class="p">.</span><span class="n">get_function</span><span class="p">(</span><span class="s">"r_t"</span><span class="p">).</span><span class="n">unwrap</span><span class="p">();</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">v</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">mpfr_t</span><span class="p">.</span><span class="n">call</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="n">store</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="p">[]).</span><span class="n">unwrap</span><span class="p">();</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">vr</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">v</span><span class="p">.</span><span class="n">as_ref</span><span class="p">();</span>
<span class="w">    </span><span class="fm">println!</span><span class="p">(</span><span class="s">"==&gt; init is :{:?}"</span><span class="p">,</span><span class="w"> </span><span class="n">vr</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span><span class="w"> </span><span class="n">LOGGER</span><span class="p">:</span><span class="w"> </span><span class="nc">SimpleLogger</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">SimpleLogger</span><span class="p">;</span>

<span class="k">pub</span><span class="w"> </span><span class="k">fn</span><span class="w"> </span><span class="nf">setup_logger</span><span class="p">()</span><span class="w"> </span><span class="p">-&gt;</span><span class="w"> </span><span class="nb">Result</span><span class="o">&lt;</span><span class="p">(),</span><span class="w"> </span><span class="n">SetLoggerError</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">log</span><span class="p">::</span><span class="n">set_logger</span><span class="p">(</span><span class="o">&amp;</span><span class="n">LOGGER</span><span class="p">).</span><span class="n">map</span><span class="p">(</span><span class="o">|</span><span class="p">()</span><span class="o">|</span><span class="w"> </span><span class="n">log</span><span class="p">::</span><span class="n">set_max_level</span><span class="p">(</span><span class="n">LevelFilter</span><span class="p">::</span><span class="n">Trace</span><span class="p">))</span>
<span class="p">}</span>
<span class="k">impl</span><span class="w"> </span><span class="n">log</span><span class="p">::</span><span class="n">Log</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">SimpleLogger</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">fn</span><span class="w"> </span><span class="nf">enabled</span><span class="p">(</span><span class="o">&amp;</span><span class="bp">self</span><span class="p">,</span><span class="w"> </span><span class="n">metadata</span><span class="p">:</span><span class="w"> </span><span class="kp">&amp;</span><span class="nc">Metadata</span><span class="p">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w"> </span><span class="kt">bool</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="c1">//metadata.level() &lt;= Level::Info</span>
<span class="w">        </span><span class="kc">true</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="k">fn</span><span class="w"> </span><span class="nf">log</span><span class="p">(</span><span class="o">&amp;</span><span class="bp">self</span><span class="p">,</span><span class="w"> </span><span class="n">record</span><span class="p">:</span><span class="w"> </span><span class="kp">&amp;</span><span class="nc">Record</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="bp">self</span><span class="p">.</span><span class="n">enabled</span><span class="p">(</span><span class="n">record</span><span class="p">.</span><span class="n">metadata</span><span class="p">())</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="fm">println!</span><span class="p">(</span><span class="s">"{} - {}"</span><span class="p">,</span><span class="w"> </span><span class="n">record</span><span class="p">.</span><span class="n">level</span><span class="p">(),</span><span class="w"> </span><span class="n">record</span><span class="p">.</span><span class="n">args</span><span class="p">());</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="k">fn</span><span class="w"> </span><span class="nf">flush</span><span class="p">(</span><span class="o">&amp;</span><span class="bp">self</span><span class="p">)</span><span class="w"> </span><span class="p">{}</span>
<span class="p">}</span>

<span class="k">fn</span><span class="w"> </span><span class="nf">define_imports</span><span class="p">(</span><span class="n">store</span><span class="p">:</span><span class="w"> </span><span class="kp">&amp;</span><span class="nc">mut</span><span class="w"> </span><span class="n">Store</span><span class="p">,</span><span class="w"> </span><span class="n">imports</span><span class="p">:</span><span class="w"> </span><span class="kp">&amp;</span><span class="nc">mut</span><span class="w"> </span><span class="n">Imports</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">define_function</span><span class="p">(</span>
<span class="w">        </span><span class="s">"wasi_snapshot_preview1"</span><span class="p">.</span><span class="n">to_string</span><span class="p">(),</span>
<span class="w">        </span><span class="s">"fd_seek"</span><span class="p">.</span><span class="n">to_string</span><span class="p">(),</span>
<span class="w">        </span><span class="n">imports</span><span class="p">,</span>
<span class="w">        </span><span class="n">store</span><span class="p">,</span>
<span class="w">        </span><span class="p">(),</span>
<span class="w">        </span><span class="n">FunctionType</span><span class="p">::</span><span class="n">new</span><span class="p">(</span>
<span class="w">            </span><span class="fm">vec!</span><span class="p">[</span><span class="n">Type</span><span class="p">::</span><span class="n">I32</span><span class="p">,</span><span class="w"> </span><span class="n">Type</span><span class="p">::</span><span class="n">I64</span><span class="p">,</span><span class="w"> </span><span class="n">Type</span><span class="p">::</span><span class="n">I32</span><span class="p">,</span><span class="w"> </span><span class="n">Type</span><span class="p">::</span><span class="n">I32</span><span class="p">],</span>
<span class="w">            </span><span class="fm">vec!</span><span class="p">[</span><span class="n">Type</span><span class="p">::</span><span class="n">I32</span><span class="p">],</span>
<span class="w">        </span><span class="p">),</span>
<span class="w">        </span><span class="o">|</span><span class="n">env</span><span class="p">,</span><span class="w"> </span><span class="n">args</span><span class="o">|</span><span class="w"> </span><span class="nb">Result</span><span class="p">::</span><span class="nb">Ok</span><span class="p">(</span><span class="fm">vec!</span><span class="p">[</span><span class="n">Value</span><span class="p">::</span><span class="n">I32</span><span class="p">(</span><span class="mi">0</span><span class="p">)]),</span>
<span class="w">    </span><span class="p">);</span>

<span class="w">    </span><span class="n">define_function</span><span class="p">(</span>
<span class="w">        </span><span class="s">"wasi_snapshot_preview1"</span><span class="p">.</span><span class="n">to_string</span><span class="p">(),</span>
<span class="w">        </span><span class="s">"fd_write"</span><span class="p">.</span><span class="n">to_string</span><span class="p">(),</span>
<span class="w">        </span><span class="n">imports</span><span class="p">,</span>
<span class="w">        </span><span class="n">store</span><span class="p">,</span>
<span class="w">        </span><span class="p">(),</span>
<span class="w">        </span><span class="n">FunctionType</span><span class="p">::</span><span class="n">new</span><span class="p">(</span>
<span class="w">            </span><span class="fm">vec!</span><span class="p">[</span><span class="n">Type</span><span class="p">::</span><span class="n">I32</span><span class="p">,</span><span class="w"> </span><span class="n">Type</span><span class="p">::</span><span class="n">I32</span><span class="p">,</span><span class="w"> </span><span class="n">Type</span><span class="p">::</span><span class="n">I32</span><span class="p">,</span><span class="w"> </span><span class="n">Type</span><span class="p">::</span><span class="n">I32</span><span class="p">],</span>
<span class="w">            </span><span class="fm">vec!</span><span class="p">[</span><span class="n">Type</span><span class="p">::</span><span class="n">I32</span><span class="p">],</span>
<span class="w">        </span><span class="p">),</span>
<span class="w">        </span><span class="o">|</span><span class="n">env</span><span class="p">,</span><span class="w"> </span><span class="n">args</span><span class="o">|</span><span class="w"> </span><span class="nb">Result</span><span class="p">::</span><span class="nb">Ok</span><span class="p">(</span><span class="fm">vec!</span><span class="p">[</span><span class="n">Value</span><span class="p">::</span><span class="n">I32</span><span class="p">(</span><span class="mi">0</span><span class="p">)]),</span>
<span class="w">    </span><span class="p">);</span>

<span class="w">    </span><span class="n">define_function</span><span class="p">(</span>
<span class="w">        </span><span class="s">"wasi_snapshot_preview1"</span><span class="p">.</span><span class="n">to_string</span><span class="p">(),</span>
<span class="w">        </span><span class="s">"fd_close"</span><span class="p">.</span><span class="n">to_string</span><span class="p">(),</span>
<span class="w">        </span><span class="n">imports</span><span class="p">,</span>
<span class="w">        </span><span class="n">store</span><span class="p">,</span>
<span class="w">        </span><span class="p">(),</span>
<span class="w">        </span><span class="n">FunctionType</span><span class="p">::</span><span class="n">new</span><span class="p">(</span><span class="fm">vec!</span><span class="p">[</span><span class="n">Type</span><span class="p">::</span><span class="n">I32</span><span class="p">],</span><span class="w"> </span><span class="fm">vec!</span><span class="p">[</span><span class="n">Type</span><span class="p">::</span><span class="n">I32</span><span class="p">]),</span>
<span class="w">        </span><span class="o">|</span><span class="n">env</span><span class="p">,</span><span class="w"> </span><span class="n">args</span><span class="o">|</span><span class="w"> </span><span class="nb">Result</span><span class="p">::</span><span class="nb">Ok</span><span class="p">(</span><span class="fm">vec!</span><span class="p">[</span><span class="n">Value</span><span class="p">::</span><span class="n">I32</span><span class="p">(</span><span class="mi">0</span><span class="p">)]),</span>
<span class="w">    </span><span class="p">);</span>
<span class="w">    </span><span class="n">define_function</span><span class="p">(</span>
<span class="w">        </span><span class="s">"wasi_snapshot_preview1"</span><span class="p">.</span><span class="n">to_string</span><span class="p">(),</span>
<span class="w">        </span><span class="s">"proc_exit"</span><span class="p">.</span><span class="n">to_string</span><span class="p">(),</span>
<span class="w">        </span><span class="n">imports</span><span class="p">,</span>
<span class="w">        </span><span class="n">store</span><span class="p">,</span>
<span class="w">        </span><span class="p">(),</span>
<span class="w">        </span><span class="n">FunctionType</span><span class="p">::</span><span class="n">new</span><span class="p">(</span><span class="fm">vec!</span><span class="p">[</span><span class="n">Type</span><span class="p">::</span><span class="n">I32</span><span class="p">],</span><span class="w"> </span><span class="fm">vec!</span><span class="p">[]),</span>
<span class="w">        </span><span class="o">|</span><span class="n">env</span><span class="p">,</span><span class="w"> </span><span class="n">args</span><span class="o">|</span><span class="w"> </span><span class="nb">Result</span><span class="p">::</span><span class="nb">Ok</span><span class="p">(</span><span class="fm">vec!</span><span class="p">[</span><span class="n">Value</span><span class="p">::</span><span class="n">I32</span><span class="p">(</span><span class="mi">0</span><span class="p">)]),</span>
<span class="w">    </span><span class="p">);</span>
<span class="w">    </span><span class="n">define_function</span><span class="p">(</span>
<span class="w">        </span><span class="s">"env"</span><span class="p">.</span><span class="n">to_string</span><span class="p">(),</span>
<span class="w">        </span><span class="s">"emscripten_notify_memory_growth"</span><span class="p">.</span><span class="n">to_string</span><span class="p">(),</span>
<span class="w">        </span><span class="n">imports</span><span class="p">,</span>
<span class="w">        </span><span class="n">store</span><span class="p">,</span>
<span class="w">        </span><span class="p">(),</span>
<span class="w">        </span><span class="n">FunctionType</span><span class="p">::</span><span class="n">new</span><span class="p">(</span><span class="fm">vec!</span><span class="p">[</span><span class="n">Type</span><span class="p">::</span><span class="n">I32</span><span class="p">],</span><span class="w"> </span><span class="fm">vec!</span><span class="p">[]),</span>
<span class="w">        </span><span class="o">|</span><span class="n">env</span><span class="p">,</span><span class="w"> </span><span class="n">args</span><span class="o">|</span><span class="w"> </span><span class="nb">Result</span><span class="p">::</span><span class="nb">Ok</span><span class="p">(</span><span class="fm">vec!</span><span class="p">[</span><span class="n">Value</span><span class="p">::</span><span class="n">I32</span><span class="p">(</span><span class="mi">0</span><span class="p">)]),</span>
<span class="w">    </span><span class="p">);</span>
<span class="p">}</span>
<span class="k">fn</span><span class="w"> </span><span class="nf">define_function</span><span class="o">&lt;</span><span class="n">F</span><span class="p">,</span><span class="w"> </span><span class="n">T</span><span class="o">&gt;</span><span class="p">(</span>
<span class="w">    </span><span class="n">ns</span><span class="p">:</span><span class="w"> </span><span class="nb">String</span><span class="p">,</span>
<span class="w">    </span><span class="n">name</span><span class="p">:</span><span class="w"> </span><span class="nb">String</span><span class="p">,</span>
<span class="w">    </span><span class="n">imports</span><span class="p">:</span><span class="w"> </span><span class="kp">&amp;</span><span class="nc">mut</span><span class="w"> </span><span class="n">Imports</span><span class="p">,</span>
<span class="w">    </span><span class="n">store</span><span class="p">:</span><span class="w"> </span><span class="kp">&amp;</span><span class="nc">mut</span><span class="w"> </span><span class="n">Store</span><span class="p">,</span>
<span class="w">    </span><span class="n">data</span><span class="p">:</span><span class="w"> </span><span class="nc">T</span><span class="p">,</span>
<span class="w">    </span><span class="n">ty</span><span class="p">:</span><span class="w"> </span><span class="nc">FunctionType</span><span class="p">,</span>
<span class="w">    </span><span class="n">f</span><span class="p">:</span><span class="w"> </span><span class="nc">F</span><span class="p">,</span>
<span class="p">)</span><span class="w"> </span><span class="k">where</span>
<span class="w">    </span><span class="n">F</span><span class="p">:</span><span class="w"> </span><span class="nb">Fn</span><span class="p">(</span><span class="n">FunctionEnvMut</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="p">[</span><span class="n">Value</span><span class="p">])</span><span class="w"> </span><span class="p">-&gt;</span><span class="w"> </span><span class="nb">Result</span><span class="o">&lt;</span><span class="nb">Vec</span><span class="o">&lt;</span><span class="n">Value</span><span class="o">&gt;</span><span class="p">,</span><span class="w"> </span><span class="n">RuntimeError</span><span class="o">&gt;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="o">'</span><span class="nb">static</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nb">Send</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nb">Sync</span><span class="p">,</span>
<span class="w">    </span><span class="n">T</span><span class="p">:</span><span class="w"> </span><span class="o">'</span><span class="nb">static</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nb">Send</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nb">Sync</span><span class="p">,</span>
<span class="p">{</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">env</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">FunctionEnv</span><span class="p">::</span><span class="n">new</span><span class="p">(</span><span class="n">store</span><span class="p">,</span><span class="w"> </span><span class="n">data</span><span class="p">);</span>
<span class="w">    </span><span class="n">imports</span><span class="p">.</span><span class="n">define</span><span class="p">(</span>
<span class="w">        </span><span class="n">ns</span><span class="p">.</span><span class="n">as_str</span><span class="p">(),</span>
<span class="w">        </span><span class="n">name</span><span class="p">.</span><span class="n">as_str</span><span class="p">(),</span>
<span class="w">        </span><span class="n">Function</span><span class="p">::</span><span class="n">new_with_env</span><span class="p">(</span><span class="n">store</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">env</span><span class="p">,</span><span class="w"> </span><span class="n">ty</span><span class="p">,</span><span class="w"> </span><span class="n">f</span><span class="p">),</span>
<span class="w">    </span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div>
</blockquote>



<a name="484576257"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%239685%20Bug%20in%20loading%20Extern%20Function%20nam.../near/484576257" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.239685.20Bug.20in.20loading.20Extern.20Function.20nam.2E.2E.2E.html#484576257">(Nov 26 2024 at 18:51)</a>:</h4>
<p>alexcrichton <a href="https://github.com/bytecodealliance/wasmtime/issues/9685#issuecomment-2501693656">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/9685">issue #9685</a>:</p>
<blockquote>
<p>Ah if you're using wasmer we don't provide support for that here. Can you raise the issue with them instead? It may be a problem with how they're integrating with Cranelift like @bjorn3 mentioned</p>
</blockquote>



<a name="484579429"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%239685%20Bug%20in%20loading%20Extern%20Function%20nam.../near/484579429" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.239685.20Bug.20in.20loading.20Extern.20Function.20nam.2E.2E.2E.html#484579429">(Nov 26 2024 at 19:12)</a>:</h4>
<p>AlaaAlHallaq <a href="https://github.com/bytecodealliance/wasmtime/issues/9685#issuecomment-2501730180">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/9685">issue #9685</a>:</p>
<blockquote>
<p>Ok thanks will pass what @bjorn3 wrote there.</p>
</blockquote>



<a name="484579547"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%239685%20Bug%20in%20loading%20Extern%20Function%20nam.../near/484579547" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.239685.20Bug.20in.20loading.20Extern.20Function.20nam.2E.2E.2E.html#484579547">(Nov 26 2024 at 19:13)</a>:</h4>
<p>AlaaAlHallaq closed <a href="https://github.com/bytecodealliance/wasmtime/issues/9685">issue #9685</a>:</p>
<blockquote>
<p><a href="https://github.com/bytecodealliance/wasmtime/blob/2b3fe80b65c4943428ec1d587bf35740cd977401/cranelift/codegen/src/ir/extname.rs#L199">https://github.com/bytecodealliance/wasmtime/blob/2b3fe80b65c4943428ec1d587bf35740cd977401/cranelift/codegen/src/ir/extname.rs#L199</a></p>
<p>when I tried to load mpfrp wasm file compiled and used by nodejs package <a href="https://github.com/Daninet/gmp-wasm">gmp-wasm</a>:<br>
the following panic stack trace occure:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="n">thread</span><span class="w"> </span><span class="o">'&lt;</span><span class="n">unnamed</span><span class="o">&gt;'</span><span class="w"> </span><span class="n">panicked</span><span class="w"> </span><span class="n">at</span><span class="w"> </span><span class="o">/</span><span class="n">Users</span><span class="o">/</span><span class="n">alaahallaq</span><span class="o">/</span><span class="p">.</span><span class="n">cargo</span><span class="o">/</span><span class="n">registry</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">index</span><span class="p">.</span><span class="n">crates</span><span class="p">.</span><span class="n">io</span><span class="o">-</span><span class="mi">6</span><span class="n">f17d22bba15001f</span><span class="o">/</span><span class="n">cranelift</span><span class="o">-</span><span class="n">codegen</span><span class="o">-</span><span class="mf">0.110.2</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">ir</span><span class="o">/</span><span class="n">extname</span><span class="p">.</span><span class="n">rs</span><span class="p">:</span><span class="mi">199</span><span class="p">:</span><span class="mi">58</span><span class="p">:</span>
<span class="nc">index</span><span class="w"> </span><span class="n">out</span><span class="w"> </span><span class="n">of</span><span class="w"> </span><span class="n">bounds</span><span class="p">:</span><span class="w"> </span><span class="nc">the</span><span class="w"> </span><span class="n">len</span><span class="w"> </span><span class="n">is</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="n">but</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">index</span><span class="w"> </span><span class="n">is</span><span class="w"> </span><span class="mi">191</span>
<span class="n">stack</span><span class="w"> </span><span class="n">backtrace</span><span class="p">:</span>
<span class="w">   </span><span class="mi">0</span><span class="p">:</span><span class="w"> </span><span class="nc">_rust_begin_unwind</span>
<span class="w">   </span><span class="mi">1</span><span class="p">:</span><span class="w"> </span><span class="nc">core</span><span class="p">::</span><span class="n">panicking</span><span class="p">::</span><span class="n">panic_fmt</span>
<span class="w">   </span><span class="mi">2</span><span class="p">:</span><span class="w"> </span><span class="nc">core</span><span class="p">::</span><span class="n">panicking</span><span class="p">::</span><span class="n">panic_bounds_check</span>
<span class="w">   </span><span class="mi">3</span><span class="p">:</span><span class="w"> </span><span class="o">&lt;</span><span class="kt">usize</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">core</span><span class="p">::</span><span class="n">slice</span><span class="p">::</span><span class="n">index</span><span class="p">::</span><span class="n">SliceIndex</span><span class="o">&lt;</span><span class="p">[</span><span class="n">T</span><span class="p">]</span><span class="o">&gt;&gt;</span><span class="p">::</span><span class="n">index</span>
<span class="w">   </span><span class="mi">4</span><span class="p">:</span><span class="w"> </span><span class="o">&lt;</span><span class="n">alloc</span><span class="p">::</span><span class="n">vec</span><span class="p">::</span><span class="nb">Vec</span><span class="o">&lt;</span><span class="n">T</span><span class="p">,</span><span class="n">A</span><span class="o">&gt;</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">core</span><span class="p">::</span><span class="n">ops</span><span class="p">::</span><span class="n">index</span><span class="p">::</span><span class="n">Index</span><span class="o">&lt;</span><span class="n">I</span><span class="o">&gt;&gt;</span><span class="p">::</span><span class="n">index</span>
<span class="w">   </span><span class="mi">5</span><span class="p">:</span><span class="w"> </span><span class="o">&lt;</span><span class="n">cranelift_entity</span><span class="p">::</span><span class="n">primary</span><span class="p">::</span><span class="n">PrimaryMap</span><span class="o">&lt;</span><span class="n">K</span><span class="p">,</span><span class="n">V</span><span class="o">&gt;</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">core</span><span class="p">::</span><span class="n">ops</span><span class="p">::</span><span class="n">index</span><span class="p">::</span><span class="n">Index</span><span class="o">&lt;</span><span class="n">K</span><span class="o">&gt;&gt;</span><span class="p">::</span><span class="n">index</span>
<span class="w">   </span><span class="mi">6</span><span class="p">:</span><span class="w"> </span><span class="o">&lt;</span><span class="n">cranelift_codegen</span><span class="p">::</span><span class="n">ir</span><span class="p">::</span><span class="n">extname</span><span class="p">::</span><span class="n">DisplayableExternalName</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">core</span><span class="p">::</span><span class="n">fmt</span><span class="p">::</span><span class="n">Display</span><span class="o">&gt;</span><span class="p">::</span><span class="n">fmt</span>
<span class="w">   </span><span class="mi">7</span><span class="p">:</span><span class="w"> </span><span class="nc">core</span><span class="p">::</span><span class="n">fmt</span><span class="p">::</span><span class="n">write</span>
<span class="w">   </span><span class="mi">8</span><span class="p">:</span><span class="w"> </span><span class="nc">core</span><span class="p">::</span><span class="n">fmt</span><span class="p">::</span><span class="n">Formatter</span><span class="p">::</span><span class="n">write_fmt</span>
<span class="w">   </span><span class="mi">9</span><span class="p">:</span><span class="w"> </span><span class="o">&lt;</span><span class="n">cranelift_codegen</span><span class="p">::</span><span class="n">ir</span><span class="p">::</span><span class="n">extfunc</span><span class="p">::</span><span class="n">DisplayableExtFuncData</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">core</span><span class="p">::</span><span class="n">fmt</span><span class="p">::</span><span class="n">Display</span><span class="o">&gt;</span><span class="p">::</span><span class="n">fmt</span>
<span class="w">  </span><span class="mi">10</span><span class="p">:</span><span class="w"> </span><span class="o">&lt;&amp;</span><span class="n">T</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">core</span><span class="p">::</span><span class="n">fmt</span><span class="p">::</span><span class="n">Display</span><span class="o">&gt;</span><span class="p">::</span><span class="n">fmt</span>
<span class="w">  </span><span class="mi">11</span><span class="p">:</span><span class="w"> </span><span class="nc">core</span><span class="p">::</span><span class="n">fmt</span><span class="p">::</span><span class="n">write</span>
<span class="w">  </span><span class="mi">12</span><span class="p">:</span><span class="w"> </span><span class="o">&lt;</span><span class="n">core</span><span class="p">::</span><span class="n">fmt</span><span class="p">::</span><span class="n">Formatter</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">core</span><span class="p">::</span><span class="n">fmt</span><span class="p">::</span><span class="n">Write</span><span class="o">&gt;</span><span class="p">::</span><span class="n">write_fmt</span>
<span class="w">  </span><span class="mi">13</span><span class="p">:</span><span class="w"> </span><span class="nc">cranelift_codegen</span><span class="p">::</span><span class="n">write</span><span class="p">::</span><span class="n">FuncWriter</span><span class="p">::</span><span class="n">super_entity_definition</span>
<span class="w">  </span><span class="mi">14</span><span class="p">:</span><span class="w"> </span><span class="nc">cranelift_codegen</span><span class="p">::</span><span class="n">write</span><span class="p">::</span><span class="n">FuncWriter</span><span class="p">::</span><span class="n">write_entity_definition</span>
<span class="w">  </span><span class="mi">15</span><span class="p">:</span><span class="w"> </span><span class="nc">cranelift_codegen</span><span class="p">::</span><span class="n">write</span><span class="p">::</span><span class="n">FuncWriter</span><span class="p">::</span><span class="n">super_preamble</span>
<span class="w">  </span><span class="mi">16</span><span class="p">:</span><span class="w"> </span><span class="nc">cranelift_codegen</span><span class="p">::</span><span class="n">write</span><span class="p">::</span><span class="n">FuncWriter</span><span class="p">::</span><span class="n">write_preamble</span>
<span class="w">  </span><span class="mi">17</span><span class="p">:</span><span class="w"> </span><span class="nc">cranelift_codegen</span><span class="p">::</span><span class="n">write</span><span class="p">::</span><span class="n">decorate_function</span>
<span class="w">  </span><span class="mi">18</span><span class="p">:</span><span class="w"> </span><span class="nc">cranelift_codegen</span><span class="p">::</span><span class="n">write</span><span class="p">::</span><span class="n">write_function</span>
<span class="w">  </span><span class="mi">19</span><span class="p">:</span><span class="w"> </span><span class="o">&lt;</span><span class="n">cranelift_codegen</span><span class="p">::</span><span class="n">ir</span><span class="p">::</span><span class="n">function</span><span class="p">::</span><span class="n">DisplayFunction</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">core</span><span class="p">::</span><span class="n">fmt</span><span class="p">::</span><span class="n">Display</span><span class="o">&gt;</span><span class="p">::</span><span class="n">fmt</span>
<span class="w">  </span><span class="mi">20</span><span class="p">:</span><span class="w"> </span><span class="nc">core</span><span class="p">::</span><span class="n">fmt</span><span class="p">::</span><span class="n">write</span>
<span class="w">  </span><span class="mi">21</span><span class="p">:</span><span class="w"> </span><span class="o">&lt;&amp;</span><span class="n">T</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">core</span><span class="p">::</span><span class="n">fmt</span><span class="p">::</span><span class="n">Display</span><span class="o">&gt;</span><span class="p">::</span><span class="n">fmt</span>
<span class="w">  </span><span class="mi">22</span><span class="p">:</span><span class="w"> </span><span class="nc">core</span><span class="p">::</span><span class="n">fmt</span><span class="p">::</span><span class="n">write</span>
<span class="w">  </span><span class="mi">23</span><span class="p">:</span><span class="w"> </span><span class="nc">alloc</span><span class="p">::</span><span class="n">fmt</span><span class="p">::</span><span class="n">format</span><span class="p">::</span><span class="n">format_inner</span>
<span class="w">  </span><span class="mi">24</span><span class="p">:</span><span class="w"> </span><span class="nc">alloc</span><span class="p">::</span><span class="n">fmt</span><span class="p">::</span><span class="n">format</span><span class="p">::{{</span><span class="n">closure</span><span class="p">}}</span>
<span class="w">  </span><span class="mi">25</span><span class="p">:</span><span class="w"> </span><span class="nc">core</span><span class="p">::</span><span class="n">option</span><span class="p">::</span><span class="nb">Option</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span><span class="p">::</span><span class="n">map_or_else</span>
<span class="w">  </span><span class="mi">26</span><span class="p">:</span><span class="w"> </span><span class="nc">alloc</span><span class="p">::</span><span class="n">fmt</span><span class="p">::</span><span class="n">format</span>
<span class="w">  </span><span class="mi">27</span><span class="p">:</span><span class="w"> </span><span class="o">&lt;</span><span class="n">oslog</span><span class="p">::</span><span class="n">logger</span><span class="p">::</span><span class="n">OsLogger</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">log</span><span class="p">::</span><span class="n">Log</span><span class="o">&gt;</span><span class="p">::</span><span class="n">log</span>
<span class="w">  </span><span class="mi">28</span><span class="p">:</span><span class="w"> </span><span class="nc">log</span><span class="p">::</span><span class="n">__private_api</span><span class="p">::</span><span class="n">log_impl</span>
<span class="w">  </span><span class="mi">29</span><span class="p">:</span><span class="w"> </span><span class="nc">log</span><span class="p">::</span><span class="n">__private_api</span><span class="p">::</span><span class="n">log</span>
<span class="w">  </span><span class="mi">30</span><span class="p">:</span><span class="w"> </span><span class="nc">cranelift_codegen</span><span class="p">::</span><span class="n">context</span><span class="p">::</span><span class="n">Context</span><span class="p">::</span><span class="n">optimize</span>
<span class="w">  </span><span class="mi">31</span><span class="p">:</span><span class="w"> </span><span class="nc">cranelift_codegen</span><span class="p">::</span><span class="n">context</span><span class="p">::</span><span class="n">Context</span><span class="p">::</span><span class="n">compile_stencil</span>
<span class="w">  </span><span class="mi">32</span><span class="p">:</span><span class="w"> </span><span class="nc">cranelift_codegen</span><span class="p">::</span><span class="n">context</span><span class="p">::</span><span class="n">Context</span><span class="p">::</span><span class="n">compile</span>
<span class="w">  </span><span class="mi">33</span><span class="p">:</span><span class="w"> </span><span class="nc">cranelift_codegen</span><span class="p">::</span><span class="n">context</span><span class="p">::</span><span class="n">Context</span><span class="p">::</span><span class="n">compile_and_emit</span>
<span class="w">  </span><span class="mi">34</span><span class="p">:</span><span class="w"> </span><span class="o">&lt;</span><span class="n">wasmer_compiler_cranelift</span><span class="p">::</span><span class="n">compiler</span><span class="p">::</span><span class="n">CraneliftCompiler</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">wasmer_compiler</span><span class="p">::</span><span class="n">compiler</span><span class="p">::</span><span class="n">Compiler</span><span class="o">&gt;</span><span class="p">::</span><span class="n">compile_module</span><span class="p">::{{</span><span class="n">closure</span><span class="p">}}</span>
<span class="w">  </span><span class="mi">35</span><span class="p">:</span><span class="w"> </span><span class="nc">core</span><span class="p">::</span><span class="n">ops</span><span class="p">::</span><span class="n">function</span><span class="p">::</span><span class="n">impls</span><span class="p">::</span><span class="o">&lt;</span><span class="k">impl</span><span class="w"> </span><span class="n">core</span><span class="p">::</span><span class="n">ops</span><span class="p">::</span><span class="n">function</span><span class="p">::</span><span class="nb">Fn</span><span class="o">&lt;</span><span class="n">A</span><span class="o">&gt;</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="o">&amp;</span><span class="n">F</span><span class="o">&gt;</span><span class="p">::</span><span class="n">call</span>
<span class="w">  </span><span class="mi">36</span><span class="p">:</span><span class="w"> </span><span class="o">&lt;</span><span class="n">rayon</span><span class="p">::</span><span class="n">iter</span><span class="p">::</span><span class="n">map_with</span><span class="p">::</span><span class="n">MapWithFolder</span><span class="o">&lt;</span><span class="n">C</span><span class="p">,</span><span class="n">U</span><span class="p">,</span><span class="n">F</span><span class="o">&gt;</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">rayon</span><span class="p">::</span><span class="n">iter</span><span class="p">::</span><span class="n">plumbing</span><span class="p">::</span><span class="n">Folder</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;&gt;</span><span class="p">::</span><span class="n">consume_iter</span><span class="p">::</span><span class="n">with</span><span class="p">::{{</span><span class="n">closure</span><span class="p">}}</span>
<span class="w">  </span><span class="mi">37</span><span class="p">:</span><span class="w"> </span><span class="nc">core</span><span class="p">::</span><span class="n">ops</span><span class="p">::</span><span class="n">function</span><span class="p">::</span><span class="n">impls</span><span class="p">::</span><span class="o">&lt;</span><span class="k">impl</span><span class="w"> </span><span class="n">core</span><span class="p">::</span><span class="n">ops</span><span class="p">::</span><span class="n">function</span><span class="p">::</span><span class="nb">FnOnce</span><span class="o">&lt;</span><span class="n">A</span><span class="o">&gt;</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="n">F</span><span class="o">&gt;</span><span class="p">::</span><span class="n">call_once</span>
<span class="w">  </span><span class="mi">38</span><span class="p">:</span><span class="w"> </span><span class="o">&lt;</span><span class="n">core</span><span class="p">::</span><span class="n">iter</span><span class="p">::</span><span class="n">adapters</span><span class="p">::</span><span class="n">map</span><span class="p">::</span><span class="n">Map</span><span class="o">&lt;</span><span class="n">I</span><span class="p">,</span><span class="n">F</span><span class="o">&gt;</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">core</span><span class="p">::</span><span class="n">iter</span><span class="p">::</span><span class="n">traits</span><span class="p">::</span><span class="n">iterator</span><span class="p">::</span><span class="nb">Iterator</span><span class="o">&gt;</span><span class="p">::</span><span class="n">next</span>
<span class="w">  </span><span class="mi">39</span><span class="p">:</span><span class="w"> </span><span class="o">&lt;</span><span class="n">core</span><span class="p">::</span><span class="n">iter</span><span class="p">::</span><span class="n">adapters</span><span class="p">::</span><span class="n">map</span><span class="p">::</span><span class="n">Map</span><span class="o">&lt;</span><span class="n">I</span><span class="p">,</span><span class="n">F</span><span class="o">&gt;</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">core</span><span class="p">::</span><span class="n">iter</span><span class="p">::</span><span class="n">traits</span><span class="p">::</span><span class="n">iterator</span><span class="p">::</span><span class="nb">Iterator</span><span class="o">&gt;</span><span class="p">::</span><span class="n">next</span>
<span class="w">  </span><span class="mi">40</span><span class="p">:</span><span class="w"> </span><span class="o">&lt;</span><span class="n">core</span><span class="p">::</span><span class="n">iter</span><span class="p">::</span><span class="n">adapters</span><span class="p">::</span><span class="n">take_while</span><span class="p">::</span><span class="n">TakeWhile</span><span class="o">&lt;</span><span class="n">I</span><span class="p">,</span><span class="n">P</span><span class="o">&gt;</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">core</span><span class="p">::</span><span class="n">iter</span><span class="p">::</span><span class="n">traits</span><span class="p">::</span><span class="n">iterator</span><span class="p">::</span><span class="nb">Iterator</span><span class="o">&gt;</span><span class="p">::</span><span class="n">next</span>
<span class="w">  </span><span class="mi">41</span><span class="p">:</span><span class="w"> </span><span class="o">&lt;</span><span class="n">core</span><span class="p">::</span><span class="n">iter</span><span class="p">::</span><span class="n">adapters</span><span class="p">::</span><span class="n">map</span><span class="p">::</span><span class="n">Map</span><span class="o">&lt;</span><span class="n">I</span><span class="p">,</span><span class="n">F</span><span class="o">&gt;</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">core</span><span class="p">::</span><span class="n">iter</span><span class="p">::</span><span class="n">traits</span><span class="p">::</span><span class="n">iterator</span><span class="p">::</span><span class="nb">Iterator</span><span class="o">&gt;</span><span class="p">::</span><span class="n">next</span>
<span class="w">  </span><span class="mi">42</span><span class="p">:</span><span class="w"> </span><span class="nc">alloc</span><span class="p">::</span><span class="n">vec</span><span class="p">::</span><span class="nb">Vec</span><span class="o">&lt;</span><span class="n">T</span><span class="p">,</span><span class="n">A</span><span class="o">&gt;</span><span class="p">::</span><span class="n">extend_desugared</span>
<span class="w">  </span><span class="mi">43</span><span class="p">:</span><span class="w"> </span><span class="o">&lt;</span><span class="n">alloc</span><span class="p">::</span><span class="n">vec</span><span class="p">::</span><span class="nb">Vec</span><span class="o">&lt;</span><span class="n">T</span><span class="p">,</span><span class="n">A</span><span class="o">&gt;</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">alloc</span><span class="p">::</span><span class="n">vec</span><span class="p">::</span><span class="n">spec_extend</span><span class="p">::</span><span class="n">SpecExtend</span><span class="o">&lt;</span><span class="n">T</span><span class="p">,</span><span class="n">I</span><span class="o">&gt;&gt;</span><span class="p">::</span><span class="n">spec_extend</span>
<span class="w">  </span><span class="mi">44</span><span class="p">:</span><span class="w"> </span><span class="o">&lt;</span><span class="n">alloc</span><span class="p">::</span><span class="n">vec</span><span class="p">::</span><span class="nb">Vec</span><span class="o">&lt;</span><span class="n">T</span><span class="p">,</span><span class="n">A</span><span class="o">&gt;</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">core</span><span class="p">::</span><span class="n">iter</span><span class="p">::</span><span class="n">traits</span><span class="p">::</span><span class="n">collect</span><span class="p">::</span><span class="nb">Extend</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;&gt;</span><span class="p">::</span><span class="n">extend</span>
<span class="w">  </span><span class="mi">45</span><span class="p">:</span><span class="w"> </span><span class="o">&lt;</span><span class="n">rayon</span><span class="p">::</span><span class="n">iter</span><span class="p">::</span><span class="n">extend</span><span class="p">::</span><span class="n">ListVecFolder</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">rayon</span><span class="p">::</span><span class="n">iter</span><span class="p">::</span><span class="n">plumbing</span><span class="p">::</span><span class="n">Folder</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;&gt;</span><span class="p">::</span><span class="n">consume_iter</span>
<span class="w">  </span><span class="mi">46</span><span class="p">:</span><span class="w"> </span><span class="o">&lt;</span><span class="n">rayon</span><span class="p">::</span><span class="n">iter</span><span class="p">::</span><span class="n">while_some</span><span class="p">::</span><span class="n">WhileSomeFolder</span><span class="o">&lt;</span><span class="n">C</span><span class="o">&gt;</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">rayon</span><span class="p">::</span><span class="n">iter</span><span class="p">::</span><span class="n">plumbing</span><span class="p">::</span><span class="n">Folder</span><span class="o">&lt;</span><span class="n">core</span><span class="p">::</span><span class="n">option</span><span class="p">::</span><span class="nb">Option</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;&gt;&gt;</span><span class="p">::</span><span class="n">consume_iter</span>
<span class="w">  </span><span class="mi">47</span><span class="p">:</span><span class="w"> </span><span class="o">&lt;</span><span class="n">rayon</span><span class="p">::</span><span class="n">iter</span><span class="p">::</span><span class="n">map</span><span class="p">::</span><span class="n">MapFolder</span><span class="o">&lt;</span><span class="n">C</span><span class="p">,</span><span class="n">F</span><span class="o">&gt;</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">rayon</span><span class="p">::</span><span class="n">iter</span><span class="p">::</span><span class="n">plumbing</span><span class="p">::</span><span class="n">Folder</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;&gt;</span><span class="p">::</span><span class="n">consume_iter</span>
<span class="w">  </span><span class="mi">48</span><span class="p">:</span><span class="w"> </span><span class="o">&lt;</span><span class="n">rayon</span><span class="p">::</span><span class="n">iter</span><span class="p">::</span><span class="n">map_with</span><span class="p">::</span><span class="n">MapWithFolder</span><span class="o">&lt;</span><span class="n">C</span><span class="p">,</span><span class="n">U</span><span class="p">,</span><span class="n">F</span><span class="o">&gt;</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">rayon</span><span class="p">::</span><span class="n">iter</span><span class="p">::</span><span class="n">plumbing</span><span class="p">::</span><span class="n">Folder</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;&gt;</span><span class="p">::</span><span class="n">consume_iter</span>
<span class="w">  </span><span class="mi">49</span><span class="p">:</span><span class="w"> </span><span class="nc">rayon</span><span class="p">::</span><span class="n">iter</span><span class="p">::</span><span class="n">plumbing</span><span class="p">::</span><span class="n">Producer</span><span class="p">::</span><span class="n">fold_with</span>
<span class="w">  </span><span class="mi">50</span><span class="p">:</span><span class="w"> </span><span class="nc">rayon</span><span class="p">::</span><span class="n">iter</span><span class="p">::</span><span class="n">plumbing</span><span class="p">::</span><span class="n">bridge_producer_consumer</span><span class="p">::</span><span class="n">helper</span>
<span class="w">  </span><span class="mi">51</span><span class="p">:</span><span class="w"> </span><span class="nc">rayon</span><span class="p">::</span><span class="n">iter</span><span class="p">::</span><span class="n">plumbing</span><span class="p">::</span><span class="n">bridge_producer_consumer</span><span class="p">::</span><span class="n">helper</span><span class="p">::{{</span><span class="n">closure</span><span class="p">}}</span>
<span class="w">  </span><span class="mi">52</span><span class="p">:</span><span class="w"> </span><span class="nc">rayon_core</span><span class="p">::</span><span class="n">join</span><span class="p">::</span><span class="n">join_context</span><span class="p">::</span><span class="n">call_b</span><span class="p">::{{</span><span class="n">closure</span><span class="p">}}</span>
<span class="w">  </span><span class="mi">53</span><span class="p">:</span><span class="w"> </span><span class="nc">rayon_core</span><span class="p">::</span><span class="n">job</span><span class="p">::</span><span class="n">JobResult</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span><span class="p">::</span><span class="n">call</span><span class="p">::{{</span><span class="n">closure</span><span class="p">}}</span>
<span class="w">  </span><span class="mi">54</span><span class="p">:</span><span class="w"> </span><span class="o">&lt;</span><span class="n">core</span><span class="p">::</span><span class="n">panic</span><span class="p">::</span><span class="n">unwind_safe</span><span class="p">::</span><span class="n">AssertUnwindSafe</span><span class="o">&lt;</span><span class="n">F</span><span class="o">&gt;</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">core</span><span class="p">::</span><span class="n">ops</span><span class="p">::</span><span class="n">function</span><span class="p">::</span><span class="nb">FnOnce</span><span class="o">&lt;</span><span class="p">()</span><span class="o">&gt;&gt;</span><span class="p">::</span><span class="n">call_once</span>
<span class="w">  </span><span class="mi">55</span><span class="p">:</span><span class="w"> </span><span class="nc">std</span><span class="p">::</span><span class="n">panicking</span><span class="p">::</span><span class="kr">try</span><span class="p">::</span><span class="n">do_call</span>
<span class="w">  </span><span class="mi">56</span><span class="p">:</span><span class="w"> </span><span class="nc">___rust_try</span>
<span class="w">  </span><span class="mi">57</span><span class="p">:</span><span class="w"> </span><span class="nc">std</span><span class="p">::</span><span class="n">panic</span><span class="p">::</span><span class="n">catch_unwind</span>
<span class="w">  </span><span class="mi">58</span><span class="p">:</span><span class="w"> </span><span class="nc">rayon_core</span><span class="p">::</span><span class="n">unwind</span><span class="p">::</span><span class="n">halt_unwinding</span>
<span class="w">  </span><span class="mi">59</span><span class="p">:</span><span class="w"> </span><span class="nc">rayon_core</span><span class="p">::</span><span class="n">job</span><span class="p">::</span><span class="n">JobResult</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span><span class="p">::</span><span class="n">call</span>
<span class="w">  </span><span class="mi">60</span><span class="p">:</span><span class="w"> </span><span class="o">&lt;</span><span class="n">rayon_core</span><span class="p">::</span><span class="n">job</span><span class="p">::</span><span class="n">StackJob</span><span class="o">&lt;</span><span class="n">L</span><span class="p">,</span><span class="n">F</span><span class="p">,</span><span class="n">R</span><span class="o">&gt;</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">rayon_core</span><span class="p">::</span><span class="n">job</span><span class="p">::</span><span class="n">Job</span><span class="o">&gt;</span><span class="p">::</span><span class="n">execute</span>
<span class="w">  </span><span class="mi">61</span><span class="p">:</span><span class="w"> </span><span class="nc">rayon_core</span><span class="p">::</span><span class="n">job</span><span class="p">::</span><span class="n">JobRef</span><span class="p">::</span><span class="n">execute</span>
<span class="w">  </span><span class="mi">62</span><span class="p">:</span><span class="w"> </span><span class="nc">rayon_core</span><span class="p">::</span><span class="n">registry</span><span class="p">::</span><span class="n">WorkerThread</span><span class="p">::</span><span class="n">execute</span>
<span class="w">  </span><span class="mi">63</span><span class="p">:</span><span class="w"> </span><span class="nc">rayon_core</span><span class="p">::</span><span class="n">registry</span><span class="p">::</span><span class="n">WorkerThread</span><span class="p">::</span><span class="n">wait_until_cold</span>
<span class="w">  </span><span class="mi">64</span><span class="p">:</span><span class="w"> </span><span class="nc">rayon_core</span><span class="p">::</span><span class="n">registry</span><span class="p">::</span><span class="n">WorkerThread</span><span class="p">::</span><span class="n">wait_until</span>
<span class="w">  </span><span class="mi">65</span><span class="p">:</span><span class="w"> </span><span class="nc">rayon_core</span><span class="p">::</span><span class="n">join</span><span class="p">::</span><span class="n">join_recover_from_panic</span>
<span class="w">  </span><span class="mi">66</span><span class="p">:</span><span class="w"> </span><span class="nc">rayon_core</span><span class="p">::</span><span class="n">join</span><span class="p">::</span><span class="n">join_context</span><span class="p">::{{</span><span class="n">closure</span><span class="p">}}</span>
<span class="w">  </span><span class="mi">67</span><span class="p">:</span><span class="w"> </span><span class="nc">rayon_core</span><span class="p">::</span><span class="n">registry</span><span class="p">::</span><span class="n">in_worker</span>
<span class="w">  </span><span class="mi">68</span><span class="p">:</span><span class="w"> </span><span class="nc">rayon_core</span><span class="p">::</span><span class="n">join</span><span class="p">::</span><span class="n">join_context</span>
<span class="w">  </span><span class="mi">69</span><span class="p">:</span><span class="w"> </span><span class="nc">rayon</span><span class="p">::</span><span class="n">iter</span><span class="p">::</span><span class="n">plumbing</span><span class="p">::</span><span class="n">bridge_producer_consumer</span><span class="p">::</span><span class="n">helper</span>
<span class="w">  </span><span class="mi">70</span><span class="p">:</span><span class="w"> </span><span class="nc">rayon</span><span class="p">::</span><span class="n">iter</span><span class="p">::</span><span class="n">plumbing</span><span class="p">::</span><span class="n">bridge_producer_consumer</span><span class="p">::</span><span class="n">helper</span><span class="p">::{{</span><span class="n">closure</span><span class="p">}}</span>
<span class="w">  </span><span class="mi">71</span><span class="p">:</span><span class="w"> </span><span class="nc">rayon_core</span><span class="p">::</span><span class="n">join</span><span class="p">::</span><span class="n">join_context</span><span class="p">::</span><span class="n">call_b</span><span class="p">::{{</span><span class="n">closure</span><span class="p">}}</span>
<span class="w">  </span><span class="mi">72</span><span class="p">:</span><span class="w"> </span><span class="nc">rayon_core</span><span class="p">::</span><span class="n">job</span><span class="p">::</span><span class="n">JobResult</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span><span class="p">::</span><span class="n">call</span><span class="p">::{{</span><span class="n">closure</span><span class="p">}}</span>
<span class="w">  </span><span class="mi">73</span><span class="p">:</span><span class="w"> </span><span class="o">&lt;</span><span class="n">core</span><span class="p">::</span><span class="n">panic</span><span class="p">::</span><span class="n">unwind_safe</span><span class="p">::</span><span class="n">AssertUnwindSafe</span><span class="o">&lt;</span><span class="n">F</span><span class="o">&gt;</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">core</span><span class="p">::</span><span class="n">ops</span><span class="p">::</span><span class="n">function</span><span class="p">::</span><span class="nb">FnOnce</span><span class="o">&lt;</span><span class="p">()</span><span class="o">&gt;&gt;</span><span class="p">::</span><span class="n">call_once</span>
<span class="w">  </span><span class="mi">74</span><span class="p">:</span><span class="w"> </span><span class="nc">std</span><span class="p">::</span><span class="n">panicking</span><span class="p">::</span><span class="kr">try</span><span class="p">::</span><span class="n">do_call</span>
<span class="w">  </span><span class="mi">75</span><span class="p">:</span><span class="w"> </span><span class="nc">___rust_try</span>
<span class="w">  </span><span class="mi">76</span><span class="p">:</span><span class="w"> </span><span class="nc">std</span><span class="p">::</span><span class="n">panic</span><span class="p">::</span><span class="n">catch_unwind</span>
<span class="w">  </span><span class="mi">77</span><span class="p">:</span><span class="w"> </span><span class="nc">rayon_core</span><span class="p">::</span><span class="n">unwind</span><span class="p">::</span><span class="n">halt_unwinding</span>
<span class="w">  </span><span class="mi">78</span><span class="p">:</span><span class="w"> </span><span class="nc">rayon_core</span><span class="p">::</span><span class="n">job</span><span class="p">::</span><span class="n">JobResult</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span><span class="p">::</span><span class="n">call</span>
<span class="w">  </span><span class="mi">79</span><span class="p">:</span><span class="w"> </span><span class="o">&lt;</span><span class="n">rayon_core</span><span class="p">::</span><span class="n">job</span><span class="p">::</span><span class="n">StackJob</span><span class="o">&lt;</span><span class="n">L</span><span class="p">,</span><span class="n">F</span><span class="p">,</span><span class="n">R</span><span class="o">&gt;</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">rayon_core</span><span class="p">::</span><span class="n">job</span><span class="p">::</span><span class="n">Job</span><span class="o">&gt;</span><span class="p">::</span><span class="n">execute</span>
<span class="w">  </span><span class="mi">80</span><span class="p">:</span><span class="w"> </span><span class="nc">rayon_core</span><span class="p">::</span><span class="n">job</span><span class="p">::</span><span class="n">JobRef</span><span class="p">::</span><span class="n">execute</span>
<span class="w">  </span><span class="mi">81</span><span class="p">:</span><span class="w"> </span><span class="nc">rayon_core</span><span class="p">::</span><span class="n">registry</span><span class="p">::</span><span class="n">WorkerThread</span><span class="p">::</span><span class="n">execute</span>
<span class="w">  </span><span class="mi">82</span><span class="p">:</span><span class="w"> </span><span class="nc">rayon_core</span><span class="p">::</span><span class="n">registry</span><span class="p">::</span><span class="n">WorkerThread</span><span class="p">::</span><span class="n">wait_until_cold</span>
<span class="w">  </span><span class="mi">83</span><span class="p">:</span><span class="w"> </span><span class="nc">rayon_core</span><span class="p">::</span><span class="n">registry</span><span class="p">::</span><span class="n">WorkerThread</span><span class="p">::</span><span class="n">wait_until</span>
<span class="w">  </span><span class="mi">84</span><span class="p">:</span><span class="w"> </span><span class="nc">rayon_core</span><span class="p">::</span><span class="n">join</span><span class="p">::</span><span class="n">join_recover_from_panic</span>
<span class="w">  </span><span class="mi">85</span><span class="p">:</span><span class="w"> </span><span class="nc">rayon_core</span><span class="p">::</span><span class="n">join</span><span class="p">::</span><span class="n">join_context</span><span class="p">::{{</span><span class="n">closure</span><span class="p">}}</span>
<span class="w">  </span><span class="mi">86</span><span class="p">:</span><span class="w"> </span><span class="nc">rayon_core</span><span class="p">::</span><span class="n">registry</span><span class="p">::</span><span class="n">in_worker</span>
<span class="w">  </span><span class="mi">87</span><span class="p">:</span><span class="w"> </span><span class="nc">rayon_core</span><span class="p">::</span><span class="n">join</span><span class="p">::</span><span class="n">join_context</span>
<span class="w">  </span><span class="mi">88</span><span class="p">:</span><span class="w"> </span><span class="nc">rayon</span><span class="p">::</span><span class="n">iter</span><span class="p">::</span><span class="n">plumbing</span><span class="p">::</span><span class="n">bridge_producer_consumer</span><span class="p">::</span><span class="n">helper</span>
<span class="w">  </span><span class="mi">89</span><span class="p">:</span><span class="w"> </span><span class="nc">rayon</span><span class="p">::</span><span class="n">iter</span><span class="p">::</span><span class="n">plumbing</span><span class="p">::</span><span class="n">bridge_producer_consumer</span><span class="p">::</span><span class="n">helper</span><span class="p">::{{</span><span class="n">closure</span><span class="p">}}</span>
<span class="w">  </span><span class="mi">90</span><span class="p">:</span><span class="w"> </span><span class="nc">rayon_core</span><span class="p">::</span><span class="n">join</span><span class="p">::</span><span class="n">join_context</span><span class="p">::</span><span class="n">call_a</span><span class="p">::{{</span><span class="n">closure</span><span class="p">}}</span>
</code></pre></div>
<p>I noticed that the issue can be bypassed  if I lowered the log level of crate <code>log</code> from Debug to Warn.</p>
<p>I propose to double check the <code>user_named_funcs</code> length</p>
</blockquote>



<hr><p>Last updated: Jan 20 2025 at 06:04 UTC</p>
</html>