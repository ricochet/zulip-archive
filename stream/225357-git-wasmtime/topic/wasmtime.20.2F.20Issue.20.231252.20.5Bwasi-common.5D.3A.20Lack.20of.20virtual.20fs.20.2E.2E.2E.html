<html>
<head><meta charset="utf-8"><title>wasmtime / Issue #1252 [wasi-common]: Lack of virtual fs ... · git-wasmtime · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/index.html">git-wasmtime</a></h2>
<h3>Topic: <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20Issue.20.231252.20.5Bwasi-common.5D.3A.20Lack.20of.20virtual.20fs.20.2E.2E.2E.html">wasmtime / Issue #1252 [wasi-common]: Lack of virtual fs ...</a></h3>

<hr>

<base href="https://bytecodealliance.zulipchat.com">

<head><link href="https://bytecodealliance.github.io/zulip-archive/style.css" rel="stylesheet"></head>

<a name="189963247"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20Issue%20%231252%20%5Bwasi-common%5D%3A%20Lack%20of%20virtual%20fs%20.../near/189963247" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20Issue.20.231252.20.5Bwasi-common.5D.3A.20Lack.20of.20virtual.20fs.20.2E.2E.2E.html#189963247">(Mar 07 2020 at 08:55)</a>:</h4>
<p>kubkon opened <a href="https://github.com/bytecodealliance/wasmtime/issues/1252" target="_blank" title="https://github.com/bytecodealliance/wasmtime/issues/1252">Issue #1252</a>:</p>
<blockquote>
<p>Apologies that this didn't click earlier, but is it intentional that we do not support virtual fs in snapshot0 aka wasi_unstable? #701 landed (hooray!) but after careful re-examination I've noticed it never touched any of the old snapshot code. It's not a deal breaker per se unless we perceive anybody in the future wanting to use virtual fs with the old WASI ABI.</p>
<p>The thing that really worries me though is that I've noticed both snapshots (wasi_unstable and wasi_snapshot_preview1) really diverge and in places where they supposedly shouldn't. Virtual fs is one of those places (but there are more!). My question here is, given that <code>wiggle</code> is hopefully round the corner (I plan to have a fully working port in the coming week), @pchickey and I can start figuring out a way of polyfilling syscall logic to different ABI snapshots which would make the out-of-sync issue essentially disappear (to a degree ofc!).</p>
<p>Also, I remember having a discussion about this with @alexcrichton sometime in the past. I think we ought to really figure out a way of testing _all_ supported by Wasmtime WASI snapshots to avoid this type of errors in the future.</p>
<p>Oh man, what started as a simple question, ended up as an essay. Apologies!</p>
<p>cc @iximeow </p>
</blockquote>



<a name="189963248"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20Issue%20%231252%20%5Bwasi-common%5D%3A%20Lack%20of%20virtual%20fs%20.../near/189963248" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20Issue.20.231252.20.5Bwasi-common.5D.3A.20Lack.20of.20virtual.20fs.20.2E.2E.2E.html#189963248">(Mar 07 2020 at 08:55)</a>:</h4>
<p>kubkon labeled <a href="https://github.com/bytecodealliance/wasmtime/issues/1252" target="_blank" title="https://github.com/bytecodealliance/wasmtime/issues/1252">Issue #1252</a>:</p>
<blockquote>
<p>Apologies that this didn't click earlier, but is it intentional that we do not support virtual fs in snapshot0 aka wasi_unstable? #701 landed (hooray!) but after careful re-examination I've noticed it never touched any of the old snapshot code. It's not a deal breaker per se unless we perceive anybody in the future wanting to use virtual fs with the old WASI ABI.</p>
<p>The thing that really worries me though is that I've noticed both snapshots (wasi_unstable and wasi_snapshot_preview1) really diverge and in places where they supposedly shouldn't. Virtual fs is one of those places (but there are more!). My question here is, given that <code>wiggle</code> is hopefully round the corner (I plan to have a fully working port in the coming week), @pchickey and I can start figuring out a way of polyfilling syscall logic to different ABI snapshots which would make the out-of-sync issue essentially disappear (to a degree ofc!).</p>
<p>Also, I remember having a discussion about this with @alexcrichton sometime in the past. I think we ought to really figure out a way of testing _all_ supported by Wasmtime WASI snapshots to avoid this type of errors in the future.</p>
<p>Oh man, what started as a simple question, ended up as an essay. Apologies!</p>
<p>cc @iximeow </p>
</blockquote>



<a name="189963249"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20Issue%20%231252%20%5Bwasi-common%5D%3A%20Lack%20of%20virtual%20fs%20.../near/189963249" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20Issue.20.231252.20.5Bwasi-common.5D.3A.20Lack.20of.20virtual.20fs.20.2E.2E.2E.html#189963249">(Mar 07 2020 at 08:55)</a>:</h4>
<p>kubkon labeled <a href="https://github.com/bytecodealliance/wasmtime/issues/1252" target="_blank" title="https://github.com/bytecodealliance/wasmtime/issues/1252">Issue #1252</a>:</p>
<blockquote>
<p>Apologies that this didn't click earlier, but is it intentional that we do not support virtual fs in snapshot0 aka wasi_unstable? #701 landed (hooray!) but after careful re-examination I've noticed it never touched any of the old snapshot code. It's not a deal breaker per se unless we perceive anybody in the future wanting to use virtual fs with the old WASI ABI.</p>
<p>The thing that really worries me though is that I've noticed both snapshots (wasi_unstable and wasi_snapshot_preview1) really diverge and in places where they supposedly shouldn't. Virtual fs is one of those places (but there are more!). My question here is, given that <code>wiggle</code> is hopefully round the corner (I plan to have a fully working port in the coming week), @pchickey and I can start figuring out a way of polyfilling syscall logic to different ABI snapshots which would make the out-of-sync issue essentially disappear (to a degree ofc!).</p>
<p>Also, I remember having a discussion about this with @alexcrichton sometime in the past. I think we ought to really figure out a way of testing _all_ supported by Wasmtime WASI snapshots to avoid this type of errors in the future.</p>
<p>Oh man, what started as a simple question, ended up as an essay. Apologies!</p>
<p>cc @iximeow </p>
</blockquote>



<a name="189963717"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20Issue%20%231252%20%5Bwasi-common%5D%3A%20Lack%20of%20virtual%20fs%20.../near/189963717" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20Issue.20.231252.20.5Bwasi-common.5D.3A.20Lack.20of.20virtual.20fs.20.2E.2E.2E.html#189963717">(Mar 07 2020 at 09:11)</a>:</h4>
<p>kubkon <a href="https://github.com/bytecodealliance/wasmtime/issues/1252#issuecomment-596065418" target="_blank" title="https://github.com/bytecodealliance/wasmtime/issues/1252#issuecomment-596065418">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/1252" target="_blank" title="https://github.com/bytecodealliance/wasmtime/issues/1252">Issue #1252</a>:</p>
<blockquote>
<p>Also, while we're here. @sunfishcode @alexcrichton @pchickey do you guys think we should introduce <code>wiggle</code> in _both_ snapshots, or target only the current one (wasi_snapshot_preview1), and after we figure out the polyfill mechanics, backport to wasi_unstable?</p>
</blockquote>



<a name="190080152"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20Issue%20%231252%20%5Bwasi-common%5D%3A%20Lack%20of%20virtual%20fs%20.../near/190080152" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20Issue.20.231252.20.5Bwasi-common.5D.3A.20Lack.20of.20virtual.20fs.20.2E.2E.2E.html#190080152">(Mar 09 2020 at 15:20)</a>:</h4>
<p>iximeow <a href="https://github.com/bytecodealliance/wasmtime/issues/1252#issuecomment-596595518" target="_blank" title="https://github.com/bytecodealliance/wasmtime/issues/1252#issuecomment-596595518">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/1252" target="_blank" title="https://github.com/bytecodealliance/wasmtime/issues/1252">Issue #1252</a>:</p>
<blockquote>
<p>On the topic of virtual fs in in snapshot0 specifically.. I simply didn't think about it. I can't imagine a reason snapshot0 should not be able to use snapshot0. @pchickey mentioned that lucet-wasi has been on snapshot0 for a bit while <code>wiggle</code> has gotten built out, but at one point while I was building it out I definitely had it using virtual files, so I'm highly suspicious of my understanding of.. something, somewhere.</p>
</blockquote>



<a name="190080941"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20Issue%20%231252%20%5Bwasi-common%5D%3A%20Lack%20of%20virtual%20fs%20.../near/190080941" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20Issue.20.231252.20.5Bwasi-common.5D.3A.20Lack.20of.20virtual.20fs.20.2E.2E.2E.html#190080941">(Mar 09 2020 at 15:27)</a>:</h4>
<p>kubkon <a href="https://github.com/bytecodealliance/wasmtime/issues/1252#issuecomment-596599487" target="_blank" title="https://github.com/bytecodealliance/wasmtime/issues/1252#issuecomment-596599487">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/1252" target="_blank" title="https://github.com/bytecodealliance/wasmtime/issues/1252">Issue #1252</a>:</p>
<blockquote>
<p>Right, OK. I thought I'd double check with you before doing any further refactoring etc. So now the real question is whether we want to backport its functionality as-is to snapshot0 (and this involves a lot of nasty copy-pasting here and there), or if we can wait a little bit for <code>wiggle</code> to make entrance, figure out the polyfill mechanism between different snapshots, and then backporting is given to us for free. Thoughts? :-)</p>
</blockquote>



<a name="190104433"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20Issue%20%231252%20%5Bwasi-common%5D%3A%20Lack%20of%20virtual%20fs%20.../near/190104433" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20Issue.20.231252.20.5Bwasi-common.5D.3A.20Lack.20of.20virtual.20fs.20.2E.2E.2E.html#190104433">(Mar 09 2020 at 18:53)</a>:</h4>
<p>pchickey <a href="https://github.com/bytecodealliance/wasmtime/issues/1252#issuecomment-596719724" target="_blank" title="https://github.com/bytecodealliance/wasmtime/issues/1252#issuecomment-596719724">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/1252" target="_blank" title="https://github.com/bytecodealliance/wasmtime/issues/1252">Issue #1252</a>:</p>
<blockquote>
<p>The path I was thinking we'd follow here is:</p>
<ol>
<li>
<p>Land wiggle support in snapshot 1 only. Keep the snapshot 0 tree intact, including using the old <code>wig</code> tool. Since its entirely different code, this should be pretty easy, right?</p>
</li>
<li>
<p>Teach wiggle about the witx polyfill feature for calculating type &amp; func call equivalency. For polyfilled modules, let wiggle_generate spit out a <code>mod snapshot_0 { mod types { &lt;ts&gt; } &lt;funcs&gt; }</code> where we fill in equivalent types with aliases (e.g. <code>type Foo = super::super::snapshot_1::types::Foo</code>) and equivalent function calls with calls to the snapshot_1 version as well. Require the user provide manual implementations for all non-equivalent function calls.</p>
</li>
<li>
<p>Land that wiggle feature in wasi-common, deleting snapshot 0 subtree and wig.</p>
</li>
</ol>
</blockquote>



<a name="190105009"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20Issue%20%231252%20%5Bwasi-common%5D%3A%20Lack%20of%20virtual%20fs%20.../near/190105009" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20Issue.20.231252.20.5Bwasi-common.5D.3A.20Lack.20of.20virtual.20fs.20.2E.2E.2E.html#190105009">(Mar 09 2020 at 18:58)</a>:</h4>
<p>pchickey edited a <a href="https://github.com/bytecodealliance/wasmtime/issues/1252#issuecomment-596719724" target="_blank" title="https://github.com/bytecodealliance/wasmtime/issues/1252#issuecomment-596719724">comment</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/1252" target="_blank" title="https://github.com/bytecodealliance/wasmtime/issues/1252">Issue #1252</a>:</p>
<blockquote>
<p>The path I was thinking we'd follow here is:</p>
<ol>
<li>
<p>Land wiggle support in snapshot 1 only. Keep the snapshot 0 tree intact, including using the old <code>wig</code> tool. Since its entirely different code, this should be pretty easy, right?</p>
</li>
<li>
<p>Teach wiggle about the witx polyfill feature for calculating type &amp; func call equivalency. For polyfilled modules, let wiggle_generate spit out a <code>mod snapshot_0 { mod types { &lt;ts&gt; } &lt;funcs&gt; }</code> where we fill in equivalent types with aliases (e.g. <code>type Foo = super::super::snapshot_1::types::Foo</code>), non-equivalent types with their definition. Fill in the equivalent function calls with the same code we generate in snapshot 1 - validate the inputs, and call the snapshot 1 trait method. The non-equivalent function calls will call a snapshot 0 trait method. The user is responsible for implementing these non-automatic methods in the snapshot 0 trait just like they are the snapshot 1 trait.</p>
</li>
<li>
<p>Land that wiggle feature in wasi-common, deleting snapshot 0 subtree and wig.</p>
</li>
</ol>
</blockquote>



<a name="190116395"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20Issue%20%231252%20%5Bwasi-common%5D%3A%20Lack%20of%20virtual%20fs%20.../near/190116395" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20Issue.20.231252.20.5Bwasi-common.5D.3A.20Lack.20of.20virtual.20fs.20.2E.2E.2E.html#190116395">(Mar 09 2020 at 20:51)</a>:</h4>
<p>kubkon <a href="https://github.com/bytecodealliance/wasmtime/issues/1252#issuecomment-596773125" target="_blank" title="https://github.com/bytecodealliance/wasmtime/issues/1252#issuecomment-596773125">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/1252" target="_blank" title="https://github.com/bytecodealliance/wasmtime/issues/1252">Issue #1252</a>:</p>
<blockquote>
<p>This plan sounds good to me! @sunfishcode I'd love to hear your thoughts on this as well!</p>
</blockquote>



<a name="190117290"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20Issue%20%231252%20%5Bwasi-common%5D%3A%20Lack%20of%20virtual%20fs%20.../near/190117290" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20Issue.20.231252.20.5Bwasi-common.5D.3A.20Lack.20of.20virtual.20fs.20.2E.2E.2E.html#190117290">(Mar 09 2020 at 21:01)</a>:</h4>
<p>sunfishcode <a href="https://github.com/bytecodealliance/wasmtime/issues/1252#issuecomment-596777385" target="_blank" title="https://github.com/bytecodealliance/wasmtime/issues/1252#issuecomment-596777385">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/1252" target="_blank" title="https://github.com/bytecodealliance/wasmtime/issues/1252">Issue #1252</a>:</p>
<blockquote>
<p>That sounds reasonable to me! And of course, it continues to make sense to factor out code into yanix/winx and into modules which aren't per-snapshot (currently we just have sandboxed_tty_writer) so that for the cases where we do have to use manual code, we can share as much as possible.</p>
</blockquote>



<a name="190117806"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20Issue%20%231252%20%5Bwasi-common%5D%3A%20Lack%20of%20virtual%20fs%20.../near/190117806" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20Issue.20.231252.20.5Bwasi-common.5D.3A.20Lack.20of.20virtual.20fs.20.2E.2E.2E.html#190117806">(Mar 09 2020 at 21:06)</a>:</h4>
<p>kubkon <a href="https://github.com/bytecodealliance/wasmtime/issues/1252#issuecomment-596779418" target="_blank" title="https://github.com/bytecodealliance/wasmtime/issues/1252#issuecomment-596779418">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/1252" target="_blank" title="https://github.com/bytecodealliance/wasmtime/issues/1252">Issue #1252</a>:</p>
<blockquote>
<p>Just an FYI that after #1253 lands, I'll restart my efforts at porting <code>wiggle</code> into <code>wasi-common</code>. If everything goes well, I'm really hopeful to have it fully working by the end of this week at the latest. This would mean we could start looking at polyfills soon.</p>
</blockquote>



<hr><p>Last updated: Jan 20 2025 at 06:04 UTC</p>
</html>