<html>
<head><meta charset="utf-8"><title>wasmtime / PR #1607 Rework aarch64 stack frame implementa... · git-wasmtime · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/index.html">git-wasmtime</a></h2>
<h3>Topic: <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231607.20Rework.20aarch64.20stack.20frame.20implementa.2E.2E.2E.html">wasmtime / PR #1607 Rework aarch64 stack frame implementa...</a></h3>

<hr>

<base href="https://bytecodealliance.zulipchat.com">

<head><link href="https://bytecodealliance.github.io/zulip-archive/style.css" rel="stylesheet"></head>

<a name="195477545"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231607%20Rework%20aarch64%20stack%20frame%20implementa.../near/195477545" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231607.20Rework.20aarch64.20stack.20frame.20implementa.2E.2E.2E.html#195477545">(Apr 27 2020 at 21:29)</a>:</h4>
<p>cfallin opened <a href="https://github.com/bytecodealliance/wasmtime/pull/1607" title="https://github.com/bytecodealliance/wasmtime/pull/1607">PR #1607</a> from <code>aarch64-stack-frame</code> to <code>master</code>:</p>
<blockquote>
<p>This PR changes the aarch64 ABI implementation to use positive offsets<br>
from SP, rather than negative offsets from FP, to refer to spill slots<br>
and stack-local storage. This allows for better addressing-mode options,<br>
and hence slightly better code: e.g., the unsigned scaled 12-bit offset<br>
mode can be used to reach anywhere in a 32KB frame without extra<br>
address-construction instructions, whereas negative offsets are limited<br>
to a signed 9-bit unscaled mode (-256 bytes).</p>
<p>To enable this, the PR introduces a notion of "nominal SP offsets" as a<br>
virtual addressing mode, lowered during the emission pass. The offsets<br>
are relative to "SP after adjusting downward to allocate stack/spill<br>
slots", but before pushing clobbers. This allows the addressing-mode<br>
expressions to be generated before register allocation (or during it,<br>
for spill/reload sequences).</p>
<p>To convert these offsets into <em>true</em> offsets from SP, we need to track<br>
how much further SP is moved downward, and compensate for this. We do so<br>
with "virtual SP offset adjustment" pseudo-instructions: these are seen<br>
by the emission pass, and result in no instruction (0 byte output), but<br>
update state that is now threaded through each instruction emission in<br>
turn. In this way, we can push e.g. stack args for a call and adjust<br>
the virtual SP offset, allowing reloads from nominal-SP-relative<br>
spillslots while we do the argument setup with "real SP offsets" at the<br>
same time.</p>
<p>As part of this PR, I also adjust how temporaries are used: I realized<br>
(thanks to a comment in @alexcrichton's stack-limit PR) that x16 and x17<br>
are the "interprocedural veneer temporaries", free to use within a<br>
function body. These are now are spilltmp and "tmp2".</p>
<p>&lt;!--</p>
<p>Please ensure that the following steps are all taken care of before submitting<br>
the PR.</p>
<ul>
<li>
<p>[ ] This has been discussed in issue #..., or if not, please tell us why<br>
  here.</p>
</li>
<li>
<p>[ ] A short description of what this does, why it is needed; if the<br>
  description becomes long, the matter should probably be discussed in an issue<br>
  first.</p>
</li>
<li>
<p>[ ] This PR contains test cases, if meaningful.</p>
</li>
<li>[ ] A reviewer from the core maintainer team has been assigned for this PR.<br>
  If you don't know who could review this, please indicate so. The list of<br>
  suggested reviewers on the right can help you.</li>
</ul>
<p>Please ensure all communication adheres to the <a href="https://github.com/bytecodealliance/wasmtime/blob/master/CODE_OF_CONDUCT.md" title="https://github.com/bytecodealliance/wasmtime/blob/master/CODE_OF_CONDUCT.md">code of
conduct</a>.<br>
--&gt;</p>
</blockquote>



<a name="195477557"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231607%20Rework%20aarch64%20stack%20frame%20implementa.../near/195477557" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231607.20Rework.20aarch64.20stack.20frame.20implementa.2E.2E.2E.html#195477557">(Apr 27 2020 at 21:29)</a>:</h4>
<p><strong>cfallin</strong> requested <a href="https://github.com/bnjbvr" title="https://github.com/bnjbvr">bnjbvr</a> for a review on <a href="https://github.com/bytecodealliance/wasmtime/pull/1607" title="https://github.com/bytecodealliance/wasmtime/pull/1607">PR #1607</a>.</p>



<a name="195477572"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231607%20Rework%20aarch64%20stack%20frame%20implementa.../near/195477572" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231607.20Rework.20aarch64.20stack.20frame.20implementa.2E.2E.2E.html#195477572">(Apr 27 2020 at 21:29)</a>:</h4>
<p><strong>cfallin</strong> requested <a href="https://github.com/bnjbvr" title="https://github.com/bnjbvr">bnjbvr</a> and <a href="https://github.com/julian-seward1" title="https://github.com/julian-seward1">julian-seward1</a> for a review on <a href="https://github.com/bytecodealliance/wasmtime/pull/1607" title="https://github.com/bytecodealliance/wasmtime/pull/1607">PR #1607</a>.</p>



<a name="195725388"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231607%20Rework%20aarch64%20stack%20frame%20implementa.../near/195725388" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231607.20Rework.20aarch64.20stack.20frame.20implementa.2E.2E.2E.html#195725388">(Apr 29 2020 at 15:16)</a>:</h4>
<p>bnjbvr submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/1607#pullrequestreview-402767371" title="https://github.com/bytecodealliance/wasmtime/pull/1607#pullrequestreview-402767371">PR Review</a>.</p>



<a name="195725391"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231607%20Rework%20aarch64%20stack%20frame%20implementa.../near/195725391" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231607.20Rework.20aarch64.20stack.20frame.20implementa.2E.2E.2E.html#195725391">(Apr 29 2020 at 15:16)</a>:</h4>
<p>bnjbvr created <a href="https://github.com/bytecodealliance/wasmtime/pull/1607#discussion_r417393809" title="https://github.com/bytecodealliance/wasmtime/pull/1607#discussion_r417393809">PR Review Comment</a>:</p>
<blockquote>
<p>nit: between</p>
</blockquote>



<a name="195725392"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231607%20Rework%20aarch64%20stack%20frame%20implementa.../near/195725392" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231607.20Rework.20aarch64.20stack.20frame.20implementa.2E.2E.2E.html#195725392">(Apr 29 2020 at 15:16)</a>:</h4>
<p>bnjbvr submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/1607#pullrequestreview-402767371" title="https://github.com/bytecodealliance/wasmtime/pull/1607#pullrequestreview-402767371">PR Review</a>.</p>



<a name="195725393"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231607%20Rework%20aarch64%20stack%20frame%20implementa.../near/195725393" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231607.20Rework.20aarch64.20stack.20frame.20implementa.2E.2E.2E.html#195725393">(Apr 29 2020 at 15:16)</a>:</h4>
<p>bnjbvr created <a href="https://github.com/bytecodealliance/wasmtime/pull/1607#discussion_r417394070" title="https://github.com/bytecodealliance/wasmtime/pull/1607#discussion_r417394070">PR Review Comment</a>:</p>
<blockquote>
<p>nit: something is off with this comment?</p>
</blockquote>



<a name="195725394"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231607%20Rework%20aarch64%20stack%20frame%20implementa.../near/195725394" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231607.20Rework.20aarch64.20stack.20frame.20implementa.2E.2E.2E.html#195725394">(Apr 29 2020 at 15:16)</a>:</h4>
<p>bnjbvr created <a href="https://github.com/bytecodealliance/wasmtime/pull/1607#discussion_r417394300" title="https://github.com/bytecodealliance/wasmtime/pull/1607#discussion_r417394300">PR Review Comment</a>:</p>
<blockquote>
<p>nit: this is using x17 here</p>
</blockquote>



<a name="195725480"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231607%20Rework%20aarch64%20stack%20frame%20implementa.../near/195725480" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231607.20Rework.20aarch64.20stack.20frame.20implementa.2E.2E.2E.html#195725480">(Apr 29 2020 at 15:17)</a>:</h4>
<p><strong>bnjbvr</strong> requested <a href="https://github.com/bnjbvr" title="https://github.com/bnjbvr">bnjbvr</a> and <a href="https://github.com/julian-seward1" title="https://github.com/julian-seward1">julian-seward1</a> for a review on <a href="https://github.com/bytecodealliance/wasmtime/pull/1607" title="https://github.com/bytecodealliance/wasmtime/pull/1607">PR #1607</a>.</p>



<a name="195732989"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231607%20Rework%20aarch64%20stack%20frame%20implementa.../near/195732989" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231607.20Rework.20aarch64.20stack.20frame.20implementa.2E.2E.2E.html#195732989">(Apr 29 2020 at 16:05)</a>:</h4>
<p>cfallin updated <a href="https://github.com/bytecodealliance/wasmtime/pull/1607" title="https://github.com/bytecodealliance/wasmtime/pull/1607">PR #1607</a> from <code>aarch64-stack-frame</code> to <code>master</code>:</p>
<blockquote>
<p>This PR changes the aarch64 ABI implementation to use positive offsets<br>
from SP, rather than negative offsets from FP, to refer to spill slots<br>
and stack-local storage. This allows for better addressing-mode options,<br>
and hence slightly better code: e.g., the unsigned scaled 12-bit offset<br>
mode can be used to reach anywhere in a 32KB frame without extra<br>
address-construction instructions, whereas negative offsets are limited<br>
to a signed 9-bit unscaled mode (-256 bytes).</p>
<p>To enable this, the PR introduces a notion of "nominal SP offsets" as a<br>
virtual addressing mode, lowered during the emission pass. The offsets<br>
are relative to "SP after adjusting downward to allocate stack/spill<br>
slots", but before pushing clobbers. This allows the addressing-mode<br>
expressions to be generated before register allocation (or during it,<br>
for spill/reload sequences).</p>
<p>To convert these offsets into <em>true</em> offsets from SP, we need to track<br>
how much further SP is moved downward, and compensate for this. We do so<br>
with "virtual SP offset adjustment" pseudo-instructions: these are seen<br>
by the emission pass, and result in no instruction (0 byte output), but<br>
update state that is now threaded through each instruction emission in<br>
turn. In this way, we can push e.g. stack args for a call and adjust<br>
the virtual SP offset, allowing reloads from nominal-SP-relative<br>
spillslots while we do the argument setup with "real SP offsets" at the<br>
same time.</p>
<p>As part of this PR, I also adjust how temporaries are used: I realized<br>
(thanks to a comment in @alexcrichton's stack-limit PR) that x16 and x17<br>
are the "interprocedural veneer temporaries", free to use within a<br>
function body. These are now are spilltmp and "tmp2".</p>
<p>&lt;!--</p>
<p>Please ensure that the following steps are all taken care of before submitting<br>
the PR.</p>
<ul>
<li>
<p>[ ] This has been discussed in issue #..., or if not, please tell us why<br>
  here.</p>
</li>
<li>
<p>[ ] A short description of what this does, why it is needed; if the<br>
  description becomes long, the matter should probably be discussed in an issue<br>
  first.</p>
</li>
<li>
<p>[ ] This PR contains test cases, if meaningful.</p>
</li>
<li>[ ] A reviewer from the core maintainer team has been assigned for this PR.<br>
  If you don't know who could review this, please indicate so. The list of<br>
  suggested reviewers on the right can help you.</li>
</ul>
<p>Please ensure all communication adheres to the <a href="https://github.com/bytecodealliance/wasmtime/blob/master/CODE_OF_CONDUCT.md" title="https://github.com/bytecodealliance/wasmtime/blob/master/CODE_OF_CONDUCT.md">code of
conduct</a>.<br>
--&gt;</p>
</blockquote>



<a name="195914578"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231607%20Rework%20aarch64%20stack%20frame%20implementa.../near/195914578" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231607.20Rework.20aarch64.20stack.20frame.20implementa.2E.2E.2E.html#195914578">(Apr 30 2020 at 23:21)</a>:</h4>
<p>cfallin updated <a href="https://github.com/bytecodealliance/wasmtime/pull/1607" title="https://github.com/bytecodealliance/wasmtime/pull/1607">PR #1607</a> from <code>aarch64-stack-frame</code> to <code>master</code>:</p>
<blockquote>
<p>This PR changes the aarch64 ABI implementation to use positive offsets<br>
from SP, rather than negative offsets from FP, to refer to spill slots<br>
and stack-local storage. This allows for better addressing-mode options,<br>
and hence slightly better code: e.g., the unsigned scaled 12-bit offset<br>
mode can be used to reach anywhere in a 32KB frame without extra<br>
address-construction instructions, whereas negative offsets are limited<br>
to a signed 9-bit unscaled mode (-256 bytes).</p>
<p>To enable this, the PR introduces a notion of "nominal SP offsets" as a<br>
virtual addressing mode, lowered during the emission pass. The offsets<br>
are relative to "SP after adjusting downward to allocate stack/spill<br>
slots", but before pushing clobbers. This allows the addressing-mode<br>
expressions to be generated before register allocation (or during it,<br>
for spill/reload sequences).</p>
<p>To convert these offsets into <em>true</em> offsets from SP, we need to track<br>
how much further SP is moved downward, and compensate for this. We do so<br>
with "virtual SP offset adjustment" pseudo-instructions: these are seen<br>
by the emission pass, and result in no instruction (0 byte output), but<br>
update state that is now threaded through each instruction emission in<br>
turn. In this way, we can push e.g. stack args for a call and adjust<br>
the virtual SP offset, allowing reloads from nominal-SP-relative<br>
spillslots while we do the argument setup with "real SP offsets" at the<br>
same time.</p>
<p>As part of this PR, I also adjust how temporaries are used: I realized<br>
(thanks to a comment in @alexcrichton's stack-limit PR) that x16 and x17<br>
are the "interprocedural veneer temporaries", free to use within a<br>
function body. These are now are spilltmp and "tmp2".</p>
<p>&lt;!--</p>
<p>Please ensure that the following steps are all taken care of before submitting<br>
the PR.</p>
<ul>
<li>
<p>[ ] This has been discussed in issue #..., or if not, please tell us why<br>
  here.</p>
</li>
<li>
<p>[ ] A short description of what this does, why it is needed; if the<br>
  description becomes long, the matter should probably be discussed in an issue<br>
  first.</p>
</li>
<li>
<p>[ ] This PR contains test cases, if meaningful.</p>
</li>
<li>[ ] A reviewer from the core maintainer team has been assigned for this PR.<br>
  If you don't know who could review this, please indicate so. The list of<br>
  suggested reviewers on the right can help you.</li>
</ul>
<p>Please ensure all communication adheres to the <a href="https://github.com/bytecodealliance/wasmtime/blob/master/CODE_OF_CONDUCT.md" title="https://github.com/bytecodealliance/wasmtime/blob/master/CODE_OF_CONDUCT.md">code of
conduct</a>.<br>
--&gt;</p>
</blockquote>



<a name="196286062"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231607%20Rework%20aarch64%20stack%20frame%20implementa.../near/196286062" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231607.20Rework.20aarch64.20stack.20frame.20implementa.2E.2E.2E.html#196286062">(May 05 2020 at 09:35)</a>:</h4>
<p>bnjbvr submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/1607#pullrequestreview-405603293" title="https://github.com/bytecodealliance/wasmtime/pull/1607#pullrequestreview-405603293">PR Review</a>.</p>



<a name="196286063"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231607%20Rework%20aarch64%20stack%20frame%20implementa.../near/196286063" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231607.20Rework.20aarch64.20stack.20frame.20implementa.2E.2E.2E.html#196286063">(May 05 2020 at 09:35)</a>:</h4>
<p>bnjbvr submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/1607#pullrequestreview-405603293" title="https://github.com/bytecodealliance/wasmtime/pull/1607#pullrequestreview-405603293">PR Review</a>.</p>



<a name="196286065"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231607%20Rework%20aarch64%20stack%20frame%20implementa.../near/196286065" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231607.20Rework.20aarch64.20stack.20frame.20implementa.2E.2E.2E.html#196286065">(May 05 2020 at 09:35)</a>:</h4>
<p>bnjbvr created <a href="https://github.com/bytecodealliance/wasmtime/pull/1607#discussion_r419958329" title="https://github.com/bytecodealliance/wasmtime/pull/1607#discussion_r419958329">PR Review Comment</a>:</p>
<blockquote>
<p>stylistic nit: can you invert the order of the operands here, please? it's really an additional offset to the <code>fp_to_arg_offset</code>, and would read less Yoda-like.</p>
</blockquote>



<a name="196286066"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231607%20Rework%20aarch64%20stack%20frame%20implementa.../near/196286066" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231607.20Rework.20aarch64.20stack.20frame.20implementa.2E.2E.2E.html#196286066">(May 05 2020 at 09:35)</a>:</h4>
<p>bnjbvr created <a href="https://github.com/bytecodealliance/wasmtime/pull/1607#discussion_r419958400" title="https://github.com/bytecodealliance/wasmtime/pull/1607#discussion_r419958400">PR Review Comment</a>:</p>
<blockquote>
<p>ditto</p>
</blockquote>



<a name="196286068"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231607%20Rework%20aarch64%20stack%20frame%20implementa.../near/196286068" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231607.20Rework.20aarch64.20stack.20frame.20implementa.2E.2E.2E.html#196286068">(May 05 2020 at 09:35)</a>:</h4>
<p>bnjbvr created <a href="https://github.com/bytecodealliance/wasmtime/pull/1607#discussion_r419961230" title="https://github.com/bytecodealliance/wasmtime/pull/1607#discussion_r419961230">PR Review Comment</a>:</p>
<blockquote>
<p>Was it intentional to keep the <code>debug!</code> statements here? I imagine they were quite useful during development but would be spamming the console otherwise. (ditto a few times below)</p>
</blockquote>



<a name="196286069"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231607%20Rework%20aarch64%20stack%20frame%20implementa.../near/196286069" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231607.20Rework.20aarch64.20stack.20frame.20implementa.2E.2E.2E.html#196286069">(May 05 2020 at 09:35)</a>:</h4>
<p>bnjbvr created <a href="https://github.com/bytecodealliance/wasmtime/pull/1607#discussion_r419959403" title="https://github.com/bytecodealliance/wasmtime/pull/1607#discussion_r419959403">PR Review Comment</a>:</p>
<blockquote>
<p>Can you add a doc-comment link to <code>MemArg::NominalSPOffset</code>, which ought to be the central place for documenting what a nominal-SP is?</p>
<p>ditto twice below</p>
</blockquote>



<a name="196286071"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231607%20Rework%20aarch64%20stack%20frame%20implementa.../near/196286071" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231607.20Rework.20aarch64.20stack.20frame.20implementa.2E.2E.2E.html#196286071">(May 05 2020 at 09:35)</a>:</h4>
<p>bnjbvr created <a href="https://github.com/bytecodealliance/wasmtime/pull/1607#discussion_r419965609" title="https://github.com/bytecodealliance/wasmtime/pull/1607#discussion_r419965609">PR Review Comment</a>:</p>
<blockquote>
<p>nit: remove <code>----</code> before and after text</p>
</blockquote>



<a name="196286072"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231607%20Rework%20aarch64%20stack%20frame%20implementa.../near/196286072" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231607.20Rework.20aarch64.20stack.20frame.20implementa.2E.2E.2E.html#196286072">(May 05 2020 at 09:35)</a>:</h4>
<p>bnjbvr created <a href="https://github.com/bytecodealliance/wasmtime/pull/1607#discussion_r419965378" title="https://github.com/bytecodealliance/wasmtime/pull/1607#discussion_r419965378">PR Review Comment</a>:</p>
<blockquote>
<p>Since this comment will be largely read by everyone who runs into this kind of <code>MemArg</code>, it should be more precise. Can you explain what's above and below (closer to FP and further away from FP, to avoid the possible double interpretation of above/below)? Maybe draw some ASCII art to show a stack example and draw where the nominal SP is?</p>
</blockquote>



<a name="196286073"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231607%20Rework%20aarch64%20stack%20frame%20implementa.../near/196286073" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231607.20Rework.20aarch64.20stack.20frame.20implementa.2E.2E.2E.html#196286073">(May 05 2020 at 09:35)</a>:</h4>
<p>bnjbvr created <a href="https://github.com/bytecodealliance/wasmtime/pull/1607#discussion_r419965642" title="https://github.com/bytecodealliance/wasmtime/pull/1607#discussion_r419965642">PR Review Comment</a>:</p>
<blockquote>
<p>ditto</p>
</blockquote>



<a name="196286074"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231607%20Rework%20aarch64%20stack%20frame%20implementa.../near/196286074" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231607.20Rework.20aarch64.20stack.20frame.20implementa.2E.2E.2E.html#196286074">(May 05 2020 at 09:35)</a>:</h4>
<p>bnjbvr created <a href="https://github.com/bytecodealliance/wasmtime/pull/1607#discussion_r419970247" title="https://github.com/bytecodealliance/wasmtime/pull/1607#discussion_r419970247">PR Review Comment</a>:</p>
<blockquote>
<p>As said below, I think this comment should be placed closer to <code>MemArg::NominalSPOffset</code>, with a drawing of what it should look like.</p>
</blockquote>



<a name="196286075"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231607%20Rework%20aarch64%20stack%20frame%20implementa.../near/196286075" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231607.20Rework.20aarch64.20stack.20frame.20implementa.2E.2E.2E.html#196286075">(May 05 2020 at 09:35)</a>:</h4>
<p>bnjbvr created <a href="https://github.com/bytecodealliance/wasmtime/pull/1607#discussion_r419967463" title="https://github.com/bytecodealliance/wasmtime/pull/1607#discussion_r419967463">PR Review Comment</a>:</p>
<blockquote>
<p>nit: maybe remove this comment? the <code>MemArg</code> enum variant below + above comment make it pretty clear it's an offset from nominal-sp.</p>
</blockquote>



<a name="196286076"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231607%20Rework%20aarch64%20stack%20frame%20implementa.../near/196286076" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231607.20Rework.20aarch64.20stack.20frame.20implementa.2E.2E.2E.html#196286076">(May 05 2020 at 09:35)</a>:</h4>
<p>bnjbvr created <a href="https://github.com/bytecodealliance/wasmtime/pull/1607#discussion_r419971368" title="https://github.com/bytecodealliance/wasmtime/pull/1607#discussion_r419971368">PR Review Comment</a>:</p>
<blockquote>
<p>nit: can you name this <code>sp_adjustment</code> and also rename <code>amt</code> into <code>amount</code>?</p>
</blockquote>



<a name="196286077"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231607%20Rework%20aarch64%20stack%20frame%20implementa.../near/196286077" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231607.20Rework.20aarch64.20stack.20frame.20implementa.2E.2E.2E.html#196286077">(May 05 2020 at 09:35)</a>:</h4>
<p>bnjbvr created <a href="https://github.com/bytecodealliance/wasmtime/pull/1607#discussion_r419969063" title="https://github.com/bytecodealliance/wasmtime/pull/1607#discussion_r419969063">PR Review Comment</a>:</p>
<blockquote>
<p>preexisting: while you're around, can you make this a doc comment please?</p>
</blockquote>



<a name="196286078"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231607%20Rework%20aarch64%20stack%20frame%20implementa.../near/196286078" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231607.20Rework.20aarch64.20stack.20frame.20implementa.2E.2E.2E.html#196286078">(May 05 2020 at 09:35)</a>:</h4>
<p>bnjbvr created <a href="https://github.com/bytecodealliance/wasmtime/pull/1607#discussion_r419975348" title="https://github.com/bytecodealliance/wasmtime/pull/1607#discussion_r419975348">PR Review Comment</a>:</p>
<blockquote>
<p>This comment is less precise than the previous one, can you tweak it to tell what this number includes?</p>
</blockquote>



<a name="196286079"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231607%20Rework%20aarch64%20stack%20frame%20implementa.../near/196286079" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231607.20Rework.20aarch64.20stack.20frame.20implementa.2E.2E.2E.html#196286079">(May 05 2020 at 09:35)</a>:</h4>
<p>bnjbvr created <a href="https://github.com/bytecodealliance/wasmtime/pull/1607#discussion_r419976385" title="https://github.com/bytecodealliance/wasmtime/pull/1607#discussion_r419976385">PR Review Comment</a>:</p>
<blockquote>
<p>nit: can you put this before the <code>emit</code> function which uses it, to make reading of this code more linear?</p>
</blockquote>



<a name="196286505"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231607%20Rework%20aarch64%20stack%20frame%20implementa.../near/196286505" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231607.20Rework.20aarch64.20stack.20frame.20implementa.2E.2E.2E.html#196286505">(May 05 2020 at 09:40)</a>:</h4>
<p>bjorn3 submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/1607#pullrequestreview-405634047" title="https://github.com/bytecodealliance/wasmtime/pull/1607#pullrequestreview-405634047">PR Review</a>.</p>



<a name="196286507"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231607%20Rework%20aarch64%20stack%20frame%20implementa.../near/196286507" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231607.20Rework.20aarch64.20stack.20frame.20implementa.2E.2E.2E.html#196286507">(May 05 2020 at 09:40)</a>:</h4>
<p>bjorn3 created <a href="https://github.com/bytecodealliance/wasmtime/pull/1607#discussion_r419984021" title="https://github.com/bytecodealliance/wasmtime/pull/1607#discussion_r419984021">PR Review Comment</a>:</p>
<blockquote>
<p>It can become a <code>trace!</code>.</p>
</blockquote>



<a name="196342923"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231607%20Rework%20aarch64%20stack%20frame%20implementa.../near/196342923" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231607.20Rework.20aarch64.20stack.20frame.20implementa.2E.2E.2E.html#196342923">(May 05 2020 at 17:58)</a>:</h4>
<p>cfallin updated <a href="https://github.com/bytecodealliance/wasmtime/pull/1607" title="https://github.com/bytecodealliance/wasmtime/pull/1607">PR #1607</a> from <code>aarch64-stack-frame</code> to <code>master</code>:</p>
<blockquote>
<p>This PR changes the aarch64 ABI implementation to use positive offsets<br>
from SP, rather than negative offsets from FP, to refer to spill slots<br>
and stack-local storage. This allows for better addressing-mode options,<br>
and hence slightly better code: e.g., the unsigned scaled 12-bit offset<br>
mode can be used to reach anywhere in a 32KB frame without extra<br>
address-construction instructions, whereas negative offsets are limited<br>
to a signed 9-bit unscaled mode (-256 bytes).</p>
<p>To enable this, the PR introduces a notion of "nominal SP offsets" as a<br>
virtual addressing mode, lowered during the emission pass. The offsets<br>
are relative to "SP after adjusting downward to allocate stack/spill<br>
slots", but before pushing clobbers. This allows the addressing-mode<br>
expressions to be generated before register allocation (or during it,<br>
for spill/reload sequences).</p>
<p>To convert these offsets into <em>true</em> offsets from SP, we need to track<br>
how much further SP is moved downward, and compensate for this. We do so<br>
with "virtual SP offset adjustment" pseudo-instructions: these are seen<br>
by the emission pass, and result in no instruction (0 byte output), but<br>
update state that is now threaded through each instruction emission in<br>
turn. In this way, we can push e.g. stack args for a call and adjust<br>
the virtual SP offset, allowing reloads from nominal-SP-relative<br>
spillslots while we do the argument setup with "real SP offsets" at the<br>
same time.</p>
<p>As part of this PR, I also adjust how temporaries are used: I realized<br>
(thanks to a comment in @alexcrichton's stack-limit PR) that x16 and x17<br>
are the "interprocedural veneer temporaries", free to use within a<br>
function body. These are now are spilltmp and "tmp2".</p>
<p>&lt;!--</p>
<p>Please ensure that the following steps are all taken care of before submitting<br>
the PR.</p>
<ul>
<li>
<p>[ ] This has been discussed in issue #..., or if not, please tell us why<br>
  here.</p>
</li>
<li>
<p>[ ] A short description of what this does, why it is needed; if the<br>
  description becomes long, the matter should probably be discussed in an issue<br>
  first.</p>
</li>
<li>
<p>[ ] This PR contains test cases, if meaningful.</p>
</li>
<li>[ ] A reviewer from the core maintainer team has been assigned for this PR.<br>
  If you don't know who could review this, please indicate so. The list of<br>
  suggested reviewers on the right can help you.</li>
</ul>
<p>Please ensure all communication adheres to the <a href="https://github.com/bytecodealliance/wasmtime/blob/master/CODE_OF_CONDUCT.md" title="https://github.com/bytecodealliance/wasmtime/blob/master/CODE_OF_CONDUCT.md">code of
conduct</a>.<br>
--&gt;</p>
</blockquote>



<a name="196343050"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231607%20Rework%20aarch64%20stack%20frame%20implementa.../near/196343050" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231607.20Rework.20aarch64.20stack.20frame.20implementa.2E.2E.2E.html#196343050">(May 05 2020 at 17:58)</a>:</h4>
<p>cfallin submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/1607#pullrequestreview-406027054" title="https://github.com/bytecodealliance/wasmtime/pull/1607#pullrequestreview-406027054">PR Review</a>.</p>



<a name="196343051"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231607%20Rework%20aarch64%20stack%20frame%20implementa.../near/196343051" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231607.20Rework.20aarch64.20stack.20frame.20implementa.2E.2E.2E.html#196343051">(May 05 2020 at 17:58)</a>:</h4>
<p>cfallin created <a href="https://github.com/bytecodealliance/wasmtime/pull/1607#discussion_r420301465" title="https://github.com/bytecodealliance/wasmtime/pull/1607#discussion_r420301465">PR Review Comment</a>:</p>
<blockquote>
<p>Done! Added a diagram in the main module comment for <code>abi.rs</code>; hopefully things are clearer now.</p>
</blockquote>



<a name="196345990"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231607%20Rework%20aarch64%20stack%20frame%20implementa.../near/196345990" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231607.20Rework.20aarch64.20stack.20frame.20implementa.2E.2E.2E.html#196345990">(May 05 2020 at 18:23)</a>:</h4>
<p>cfallin updated <a href="https://github.com/bytecodealliance/wasmtime/pull/1607" title="https://github.com/bytecodealliance/wasmtime/pull/1607">PR #1607</a> from <code>aarch64-stack-frame</code> to <code>master</code>:</p>
<blockquote>
<p>This PR changes the aarch64 ABI implementation to use positive offsets<br>
from SP, rather than negative offsets from FP, to refer to spill slots<br>
and stack-local storage. This allows for better addressing-mode options,<br>
and hence slightly better code: e.g., the unsigned scaled 12-bit offset<br>
mode can be used to reach anywhere in a 32KB frame without extra<br>
address-construction instructions, whereas negative offsets are limited<br>
to a signed 9-bit unscaled mode (-256 bytes).</p>
<p>To enable this, the PR introduces a notion of "nominal SP offsets" as a<br>
virtual addressing mode, lowered during the emission pass. The offsets<br>
are relative to "SP after adjusting downward to allocate stack/spill<br>
slots", but before pushing clobbers. This allows the addressing-mode<br>
expressions to be generated before register allocation (or during it,<br>
for spill/reload sequences).</p>
<p>To convert these offsets into <em>true</em> offsets from SP, we need to track<br>
how much further SP is moved downward, and compensate for this. We do so<br>
with "virtual SP offset adjustment" pseudo-instructions: these are seen<br>
by the emission pass, and result in no instruction (0 byte output), but<br>
update state that is now threaded through each instruction emission in<br>
turn. In this way, we can push e.g. stack args for a call and adjust<br>
the virtual SP offset, allowing reloads from nominal-SP-relative<br>
spillslots while we do the argument setup with "real SP offsets" at the<br>
same time.</p>
<p>As part of this PR, I also adjust how temporaries are used: I realized<br>
(thanks to a comment in @alexcrichton's stack-limit PR) that x16 and x17<br>
are the "interprocedural veneer temporaries", free to use within a<br>
function body. These are now are spilltmp and "tmp2".</p>
<p>&lt;!--</p>
<p>Please ensure that the following steps are all taken care of before submitting<br>
the PR.</p>
<ul>
<li>
<p>[ ] This has been discussed in issue #..., or if not, please tell us why<br>
  here.</p>
</li>
<li>
<p>[ ] A short description of what this does, why it is needed; if the<br>
  description becomes long, the matter should probably be discussed in an issue<br>
  first.</p>
</li>
<li>
<p>[ ] This PR contains test cases, if meaningful.</p>
</li>
<li>[ ] A reviewer from the core maintainer team has been assigned for this PR.<br>
  If you don't know who could review this, please indicate so. The list of<br>
  suggested reviewers on the right can help you.</li>
</ul>
<p>Please ensure all communication adheres to the <a href="https://github.com/bytecodealliance/wasmtime/blob/master/CODE_OF_CONDUCT.md" title="https://github.com/bytecodealliance/wasmtime/blob/master/CODE_OF_CONDUCT.md">code of
conduct</a>.<br>
--&gt;</p>
</blockquote>



<a name="196362377"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231607%20Rework%20aarch64%20stack%20frame%20implementa.../near/196362377" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231607.20Rework.20aarch64.20stack.20frame.20implementa.2E.2E.2E.html#196362377">(May 05 2020 at 20:26)</a>:</h4>
<p>cfallin updated <a href="https://github.com/bytecodealliance/wasmtime/pull/1607" title="https://github.com/bytecodealliance/wasmtime/pull/1607">PR #1607</a> from <code>aarch64-stack-frame</code> to <code>master</code>:</p>
<blockquote>
<p>This PR changes the aarch64 ABI implementation to use positive offsets<br>
from SP, rather than negative offsets from FP, to refer to spill slots<br>
and stack-local storage. This allows for better addressing-mode options,<br>
and hence slightly better code: e.g., the unsigned scaled 12-bit offset<br>
mode can be used to reach anywhere in a 32KB frame without extra<br>
address-construction instructions, whereas negative offsets are limited<br>
to a signed 9-bit unscaled mode (-256 bytes).</p>
<p>To enable this, the PR introduces a notion of "nominal SP offsets" as a<br>
virtual addressing mode, lowered during the emission pass. The offsets<br>
are relative to "SP after adjusting downward to allocate stack/spill<br>
slots", but before pushing clobbers. This allows the addressing-mode<br>
expressions to be generated before register allocation (or during it,<br>
for spill/reload sequences).</p>
<p>To convert these offsets into <em>true</em> offsets from SP, we need to track<br>
how much further SP is moved downward, and compensate for this. We do so<br>
with "virtual SP offset adjustment" pseudo-instructions: these are seen<br>
by the emission pass, and result in no instruction (0 byte output), but<br>
update state that is now threaded through each instruction emission in<br>
turn. In this way, we can push e.g. stack args for a call and adjust<br>
the virtual SP offset, allowing reloads from nominal-SP-relative<br>
spillslots while we do the argument setup with "real SP offsets" at the<br>
same time.</p>
<p>As part of this PR, I also adjust how temporaries are used: I realized<br>
(thanks to a comment in @alexcrichton's stack-limit PR) that x16 and x17<br>
are the "interprocedural veneer temporaries", free to use within a<br>
function body. These are now are spilltmp and "tmp2".</p>
<p>&lt;!--</p>
<p>Please ensure that the following steps are all taken care of before submitting<br>
the PR.</p>
<ul>
<li>
<p>[ ] This has been discussed in issue #..., or if not, please tell us why<br>
  here.</p>
</li>
<li>
<p>[ ] A short description of what this does, why it is needed; if the<br>
  description becomes long, the matter should probably be discussed in an issue<br>
  first.</p>
</li>
<li>
<p>[ ] This PR contains test cases, if meaningful.</p>
</li>
<li>[ ] A reviewer from the core maintainer team has been assigned for this PR.<br>
  If you don't know who could review this, please indicate so. The list of<br>
  suggested reviewers on the right can help you.</li>
</ul>
<p>Please ensure all communication adheres to the <a href="https://github.com/bytecodealliance/wasmtime/blob/master/CODE_OF_CONDUCT.md" title="https://github.com/bytecodealliance/wasmtime/blob/master/CODE_OF_CONDUCT.md">code of
conduct</a>.<br>
--&gt;</p>
</blockquote>



<a name="196365746"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231607%20Rework%20aarch64%20stack%20frame%20implementa.../near/196365746" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231607.20Rework.20aarch64.20stack.20frame.20implementa.2E.2E.2E.html#196365746">(May 05 2020 at 20:51)</a>:</h4>
<p>cfallin updated <a href="https://github.com/bytecodealliance/wasmtime/pull/1607" title="https://github.com/bytecodealliance/wasmtime/pull/1607">PR #1607</a> from <code>aarch64-stack-frame</code> to <code>master</code>:</p>
<blockquote>
<p>This PR changes the aarch64 ABI implementation to use positive offsets<br>
from SP, rather than negative offsets from FP, to refer to spill slots<br>
and stack-local storage. This allows for better addressing-mode options,<br>
and hence slightly better code: e.g., the unsigned scaled 12-bit offset<br>
mode can be used to reach anywhere in a 32KB frame without extra<br>
address-construction instructions, whereas negative offsets are limited<br>
to a signed 9-bit unscaled mode (-256 bytes).</p>
<p>To enable this, the PR introduces a notion of "nominal SP offsets" as a<br>
virtual addressing mode, lowered during the emission pass. The offsets<br>
are relative to "SP after adjusting downward to allocate stack/spill<br>
slots", but before pushing clobbers. This allows the addressing-mode<br>
expressions to be generated before register allocation (or during it,<br>
for spill/reload sequences).</p>
<p>To convert these offsets into <em>true</em> offsets from SP, we need to track<br>
how much further SP is moved downward, and compensate for this. We do so<br>
with "virtual SP offset adjustment" pseudo-instructions: these are seen<br>
by the emission pass, and result in no instruction (0 byte output), but<br>
update state that is now threaded through each instruction emission in<br>
turn. In this way, we can push e.g. stack args for a call and adjust<br>
the virtual SP offset, allowing reloads from nominal-SP-relative<br>
spillslots while we do the argument setup with "real SP offsets" at the<br>
same time.</p>
<p>As part of this PR, I also adjust how temporaries are used: I realized<br>
(thanks to a comment in @alexcrichton's stack-limit PR) that x16 and x17<br>
are the "interprocedural veneer temporaries", free to use within a<br>
function body. These are now are spilltmp and "tmp2".</p>
<p>&lt;!--</p>
<p>Please ensure that the following steps are all taken care of before submitting<br>
the PR.</p>
<ul>
<li>
<p>[ ] This has been discussed in issue #..., or if not, please tell us why<br>
  here.</p>
</li>
<li>
<p>[ ] A short description of what this does, why it is needed; if the<br>
  description becomes long, the matter should probably be discussed in an issue<br>
  first.</p>
</li>
<li>
<p>[ ] This PR contains test cases, if meaningful.</p>
</li>
<li>[ ] A reviewer from the core maintainer team has been assigned for this PR.<br>
  If you don't know who could review this, please indicate so. The list of<br>
  suggested reviewers on the right can help you.</li>
</ul>
<p>Please ensure all communication adheres to the <a href="https://github.com/bytecodealliance/wasmtime/blob/master/CODE_OF_CONDUCT.md" title="https://github.com/bytecodealliance/wasmtime/blob/master/CODE_OF_CONDUCT.md">code of
conduct</a>.<br>
--&gt;</p>
</blockquote>



<a name="196631848"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231607%20Rework%20aarch64%20stack%20frame%20implementa.../near/196631848" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231607.20Rework.20aarch64.20stack.20frame.20implementa.2E.2E.2E.html#196631848">(May 06 2020 at 13:12)</a>:</h4>
<p>bnjbvr submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/1607#pullrequestreview-406596734" title="https://github.com/bytecodealliance/wasmtime/pull/1607#pullrequestreview-406596734">PR Review</a>.</p>



<a name="196631849"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231607%20Rework%20aarch64%20stack%20frame%20implementa.../near/196631849" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231607.20Rework.20aarch64.20stack.20frame.20implementa.2E.2E.2E.html#196631849">(May 06 2020 at 13:12)</a>:</h4>
<p>bnjbvr submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/1607#pullrequestreview-406596734" title="https://github.com/bytecodealliance/wasmtime/pull/1607#pullrequestreview-406596734">PR Review</a>.</p>



<a name="196631850"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231607%20Rework%20aarch64%20stack%20frame%20implementa.../near/196631850" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231607.20Rework.20aarch64.20stack.20frame.20implementa.2E.2E.2E.html#196631850">(May 06 2020 at 13:12)</a>:</h4>
<p>bnjbvr created <a href="https://github.com/bytecodealliance/wasmtime/pull/1607#discussion_r420778156" title="https://github.com/bytecodealliance/wasmtime/pull/1607#discussion_r420778156">PR Review Comment</a>:</p>
<blockquote>
<p>This is actually unused in this PR, so it could be removed? (unless you plan to use it soon later)</p>
<p>(<code>pub(crate)</code> would show you a warning if it's effectively unused)</p>
</blockquote>



<a name="196659839"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231607%20Rework%20aarch64%20stack%20frame%20implementa.../near/196659839" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231607.20Rework.20aarch64.20stack.20frame.20implementa.2E.2E.2E.html#196659839">(May 06 2020 at 16:24)</a>:</h4>
<p>cfallin updated <a href="https://github.com/bytecodealliance/wasmtime/pull/1607" title="https://github.com/bytecodealliance/wasmtime/pull/1607">PR #1607</a> from <code>aarch64-stack-frame</code> to <code>master</code>:</p>
<blockquote>
<p>This PR changes the aarch64 ABI implementation to use positive offsets<br>
from SP, rather than negative offsets from FP, to refer to spill slots<br>
and stack-local storage. This allows for better addressing-mode options,<br>
and hence slightly better code: e.g., the unsigned scaled 12-bit offset<br>
mode can be used to reach anywhere in a 32KB frame without extra<br>
address-construction instructions, whereas negative offsets are limited<br>
to a signed 9-bit unscaled mode (-256 bytes).</p>
<p>To enable this, the PR introduces a notion of "nominal SP offsets" as a<br>
virtual addressing mode, lowered during the emission pass. The offsets<br>
are relative to "SP after adjusting downward to allocate stack/spill<br>
slots", but before pushing clobbers. This allows the addressing-mode<br>
expressions to be generated before register allocation (or during it,<br>
for spill/reload sequences).</p>
<p>To convert these offsets into <em>true</em> offsets from SP, we need to track<br>
how much further SP is moved downward, and compensate for this. We do so<br>
with "virtual SP offset adjustment" pseudo-instructions: these are seen<br>
by the emission pass, and result in no instruction (0 byte output), but<br>
update state that is now threaded through each instruction emission in<br>
turn. In this way, we can push e.g. stack args for a call and adjust<br>
the virtual SP offset, allowing reloads from nominal-SP-relative<br>
spillslots while we do the argument setup with "real SP offsets" at the<br>
same time.</p>
<p>As part of this PR, I also adjust how temporaries are used: I realized<br>
(thanks to a comment in @alexcrichton's stack-limit PR) that x16 and x17<br>
are the "interprocedural veneer temporaries", free to use within a<br>
function body. These are now are spilltmp and "tmp2".</p>
<p>&lt;!--</p>
<p>Please ensure that the following steps are all taken care of before submitting<br>
the PR.</p>
<ul>
<li>
<p>[ ] This has been discussed in issue #..., or if not, please tell us why<br>
  here.</p>
</li>
<li>
<p>[ ] A short description of what this does, why it is needed; if the<br>
  description becomes long, the matter should probably be discussed in an issue<br>
  first.</p>
</li>
<li>
<p>[ ] This PR contains test cases, if meaningful.</p>
</li>
<li>[ ] A reviewer from the core maintainer team has been assigned for this PR.<br>
  If you don't know who could review this, please indicate so. The list of<br>
  suggested reviewers on the right can help you.</li>
</ul>
<p>Please ensure all communication adheres to the <a href="https://github.com/bytecodealliance/wasmtime/blob/master/CODE_OF_CONDUCT.md" title="https://github.com/bytecodealliance/wasmtime/blob/master/CODE_OF_CONDUCT.md">code of
conduct</a>.<br>
--&gt;</p>
</blockquote>



<a name="196661174"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231607%20Rework%20aarch64%20stack%20frame%20implementa.../near/196661174" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231607.20Rework.20aarch64.20stack.20frame.20implementa.2E.2E.2E.html#196661174">(May 06 2020 at 16:34)</a>:</h4>
<p>cfallin submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/1607#pullrequestreview-406789259" title="https://github.com/bytecodealliance/wasmtime/pull/1607#pullrequestreview-406789259">PR Review</a>.</p>



<a name="196661175"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231607%20Rework%20aarch64%20stack%20frame%20implementa.../near/196661175" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231607.20Rework.20aarch64.20stack.20frame.20implementa.2E.2E.2E.html#196661175">(May 06 2020 at 16:34)</a>:</h4>
<p>cfallin created <a href="https://github.com/bytecodealliance/wasmtime/pull/1607#discussion_r420930153" title="https://github.com/bytecodealliance/wasmtime/pull/1607#discussion_r420930153">PR Review Comment</a>:</p>
<blockquote>
<p>Removed, thanks!</p>
</blockquote>



<a name="196669066"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231607%20Rework%20aarch64%20stack%20frame%20implementa.../near/196669066" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231607.20Rework.20aarch64.20stack.20frame.20implementa.2E.2E.2E.html#196669066">(May 06 2020 at 17:29)</a>:</h4>
<p>cfallin merged <a href="https://github.com/bytecodealliance/wasmtime/pull/1607" title="https://github.com/bytecodealliance/wasmtime/pull/1607">PR #1607</a>.</p>



<hr><p>Last updated: Jan 20 2025 at 06:04 UTC</p>
</html>