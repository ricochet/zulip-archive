<html>
<head><meta charset="utf-8"><title>wasmtime / PR #8139 cranelift: Optimize select_spectre_gu... · git-wasmtime · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/index.html">git-wasmtime</a></h2>
<h3>Topic: <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.238139.20cranelift.3A.20Optimize.20select_spectre_gu.2E.2E.2E.html">wasmtime / PR #8139 cranelift: Optimize select_spectre_gu...</a></h3>

<hr>

<base href="https://bytecodealliance.zulipchat.com">

<head><link href="https://bytecodealliance.github.io/zulip-archive/style.css" rel="stylesheet"></head>

<a name="426625646"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%238139%20cranelift%3A%20Optimize%20select_spectre_gu.../near/426625646" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.238139.20cranelift.3A.20Optimize.20select_spectre_gu.2E.2E.2E.html#426625646">(Mar 14 2024 at 20:45)</a>:</h4>
<p>jameysharp opened <a href="https://github.com/bytecodealliance/wasmtime/pull/8139">PR #8139</a> from <code>jameysharp:optimize-spectre</code> to <code>bytecodealliance:main</code>:</p>
<blockquote>
<p>This commit makes two changes to our treatment of<br>
<code>select_spectre_guard</code>.</p>
<p>First, stop annotating this instruction as having any side effects. We only care that if its value result is used, then it's computed without branching on the condition input. We don't otherwise care when the value is computed, or if it's computed at all.</p>
<p>Second, introduce some carefully selected ISLE egraph rewrites for this instruction. These particular rewrites are those where we can statically determine which SSA value will be the result of the instruction. Since there is no actual choice involved, there's no way to accidentally introduce a branch on the condition input.</p>
</blockquote>



<a name="426625647"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%238139%20cranelift%3A%20Optimize%20select_spectre_gu.../near/426625647" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.238139.20cranelift.3A.20Optimize.20select_spectre_gu.2E.2E.2E.html#426625647">(Mar 14 2024 at 20:45)</a>:</h4>
<p><strong>jameysharp</strong> requested <a href="https://github.com/fitzgen">fitzgen</a> for a review on <a href="https://github.com/bytecodealliance/wasmtime/pull/8139">PR #8139</a>.</p>



<a name="426625648"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%238139%20cranelift%3A%20Optimize%20select_spectre_gu.../near/426625648" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.238139.20cranelift.3A.20Optimize.20select_spectre_gu.2E.2E.2E.html#426625648">(Mar 14 2024 at 20:45)</a>:</h4>
<p><strong>jameysharp</strong> requested <a href="https://github.com/orgs/bytecodealliance/teams/wasmtime-compiler-reviewers">wasmtime-compiler-reviewers</a> for a review on <a href="https://github.com/bytecodealliance/wasmtime/pull/8139">PR #8139</a>.</p>



<a name="426625812"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%238139%20cranelift%3A%20Optimize%20select_spectre_gu.../near/426625812" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.238139.20cranelift.3A.20Optimize.20select_spectre_gu.2E.2E.2E.html#426625812">(Mar 14 2024 at 20:46)</a>:</h4>
<p>jameysharp <a href="https://github.com/bytecodealliance/wasmtime/pull/8139#issuecomment-1998456743">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/8139">PR #8139</a>:</p>
<blockquote>
<p>Perhaps @cfallin should review this? I was talking about it with him yesterday.</p>
</blockquote>



<a name="426630163"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%238139%20cranelift%3A%20Optimize%20select_spectre_gu.../near/426630163" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.238139.20cranelift.3A.20Optimize.20select_spectre_gu.2E.2E.2E.html#426630163">(Mar 14 2024 at 21:13)</a>:</h4>
<p><strong>cfallin</strong> requested <a href="https://github.com/cfallin">cfallin</a> for a review on <a href="https://github.com/bytecodealliance/wasmtime/pull/8139">PR #8139</a>.</p>



<a name="426630187"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%238139%20cranelift%3A%20Optimize%20select_spectre_gu.../near/426630187" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.238139.20cranelift.3A.20Optimize.20select_spectre_gu.2E.2E.2E.html#426630187">(Mar 14 2024 at 21:13)</a>:</h4>
<p>cfallin <a href="https://github.com/bytecodealliance/wasmtime/pull/8139#issuecomment-1998493034">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/8139">PR #8139</a>:</p>
<blockquote>
<p>Sure, happy to take a look.</p>
</blockquote>



<a name="426631607"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%238139%20cranelift%3A%20Optimize%20select_spectre_gu.../near/426631607" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.238139.20cranelift.3A.20Optimize.20select_spectre_gu.2E.2E.2E.html#426631607">(Mar 14 2024 at 21:23)</a>:</h4>
<p>cfallin submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/8139#pullrequestreview-1937744712">PR review</a>:</p>
<blockquote>
<p>This rewrite looks good to me; thanks for thinking through and discussing this yesterday!</p>
<p>A few things I think we'll want:</p>
<ul>
<li>Could we have an egraph filetest showing each case?</li>
<li>I think it would be good to document (or update documentation about) the semantics of <code>select_spectre_guard</code> and the corresponding justification, a little more than the comments here. In particular:<ul>
<li>The instruction definition's description still says the op is guaranteed not to be removed. That's not true anymore (in fact that's the point of this PR!); can we update to say something about not picking the wrong input even under a mis-speculated branch (as you do in the comment in the ISLE rewrites)?</li>
<li>Let's note in the ISLE rewrites that removing <code>select_spectre_guard</code>, if semantically correct for the functional result, always meets this speculation condition: by removing an op we are only ever going to remove computation that could be speculated, we're never adding new speculation.</li>
<li>Finally, can we add a comment in around the instruction description noting that the op is pure because our reasoning about speculation safety tells us it's always safe to remove if functionally correct, and safe to merge with another functionally identical op.</li>
</ul>
</li>
</ul>
<p>Thanks!</p>
</blockquote>



<a name="426634518"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%238139%20cranelift%3A%20Optimize%20select_spectre_gu.../near/426634518" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.238139.20cranelift.3A.20Optimize.20select_spectre_gu.2E.2E.2E.html#426634518">(Mar 14 2024 at 21:44)</a>:</h4>
<p>github-actions[bot] <a href="https://github.com/bytecodealliance/wasmtime/pull/8139#issuecomment-1998533195">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/8139">PR #8139</a>:</p>
<blockquote>
<h4>Subscribe to Label Action</h4>
<p>cc @cfallin, @fitzgen</p>
<p>&lt;details&gt;<br>
This issue or pull request has been labeled: "cranelift", "cranelift:meta", "isle"</p>
<p>Thus the following users have been cc'd because of the following labels:</p>
<ul>
<li>cfallin: isle</li>
<li>fitzgen: isle</li>
</ul>
<p>To subscribe or unsubscribe from this label, edit the &lt;code&gt;.github/subscribe-to-label.json&lt;/code&gt; configuration file.</p>
<p><a href="https://github.com/bytecodealliance/subscribe-to-label-action">Learn more.</a><br>
&lt;/details&gt;</p>
</blockquote>



<a name="427624987"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%238139%20cranelift%3A%20Optimize%20select_spectre_gu.../near/427624987" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.238139.20cranelift.3A.20Optimize.20select_spectre_gu.2E.2E.2E.html#427624987">(Mar 19 2024 at 05:56)</a>:</h4>
<p>jameysharp updated <a href="https://github.com/bytecodealliance/wasmtime/pull/8139">PR #8139</a>.</p>



<a name="427624988"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%238139%20cranelift%3A%20Optimize%20select_spectre_gu.../near/427624988" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.238139.20cranelift.3A.20Optimize.20select_spectre_gu.2E.2E.2E.html#427624988">(Mar 19 2024 at 05:56)</a>:</h4>
<p><strong>jameysharp</strong> requested <a href="https://github.com/orgs/bytecodealliance/teams/wasmtime-core-reviewers">wasmtime-core-reviewers</a> for a review on <a href="https://github.com/bytecodealliance/wasmtime/pull/8139">PR #8139</a>.</p>



<a name="427625152"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%238139%20cranelift%3A%20Optimize%20select_spectre_gu.../near/427625152" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.238139.20cranelift.3A.20Optimize.20select_spectre_gu.2E.2E.2E.html#427625152">(Mar 19 2024 at 05:58)</a>:</h4>
<p>jameysharp <a href="https://github.com/bytecodealliance/wasmtime/pull/8139#issuecomment-2005840353">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/8139">PR #8139</a>:</p>
<blockquote>
<p>I think I've addressed all your comments about documentation, Chris, and I'd appreciate feedback on that aspect. I still need to write filetests exercising these new rules, but at least now we can see that this has a positive effect on the typed-funcref tests, as expected.</p>
</blockquote>



<a name="427785750"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%238139%20cranelift%3A%20Optimize%20select_spectre_gu.../near/427785750" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.238139.20cranelift.3A.20Optimize.20select_spectre_gu.2E.2E.2E.html#427785750">(Mar 19 2024 at 18:18)</a>:</h4>
<p>cfallin submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/8139#pullrequestreview-1947037314">PR review</a>:</p>
<blockquote>
<p>New doc comments look great -- thanks!</p>
</blockquote>



<a name="428024235"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%238139%20cranelift%3A%20Optimize%20select_spectre_gu.../near/428024235" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.238139.20cranelift.3A.20Optimize.20select_spectre_gu.2E.2E.2E.html#428024235">(Mar 20 2024 at 22:16)</a>:</h4>
<p>jameysharp updated <a href="https://github.com/bytecodealliance/wasmtime/pull/8139">PR #8139</a>.</p>



<a name="428024245"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%238139%20cranelift%3A%20Optimize%20select_spectre_gu.../near/428024245" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.238139.20cranelift.3A.20Optimize.20select_spectre_gu.2E.2E.2E.html#428024245">(Mar 20 2024 at 22:16)</a>:</h4>
<p>jameysharp has enabled auto merge for <a href="https://github.com/bytecodealliance/wasmtime/pull/8139">PR #8139</a>.</p>



<a name="428029050"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%238139%20cranelift%3A%20Optimize%20select_spectre_gu.../near/428029050" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.238139.20cranelift.3A.20Optimize.20select_spectre_gu.2E.2E.2E.html#428029050">(Mar 20 2024 at 22:59)</a>:</h4>
<p>jameysharp merged <a href="https://github.com/bytecodealliance/wasmtime/pull/8139">PR #8139</a>.</p>



<hr><p>Last updated: Jan 20 2025 at 06:04 UTC</p>
</html>