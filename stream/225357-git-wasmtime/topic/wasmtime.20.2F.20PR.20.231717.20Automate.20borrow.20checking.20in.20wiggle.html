<html>
<head><meta charset="utf-8"><title>wasmtime / PR #1717 Automate borrow checking in wiggle · git-wasmtime · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/index.html">git-wasmtime</a></h2>
<h3>Topic: <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231717.20Automate.20borrow.20checking.20in.20wiggle.html">wasmtime / PR #1717 Automate borrow checking in wiggle</a></h3>

<hr>

<base href="https://bytecodealliance.zulipchat.com">

<head><link href="https://bytecodealliance.github.io/zulip-archive/style.css" rel="stylesheet"></head>

<a name="197752361"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231717%20Automate%20borrow%20checking%20in%20wiggle/near/197752361" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231717.20Automate.20borrow.20checking.20in.20wiggle.html#197752361">(May 15 2020 at 21:07)</a>:</h4>
<p>pchickey opened <a href="https://github.com/bytecodealliance/wasmtime/pull/1717">PR #1717</a> from <code>pch/wiggle_auto_borrow_checking</code> to <code>master</code>:</p>
<blockquote>
<p>WIP</p>
<p>&lt;!--</p>
<p>Please ensure that the following steps are all taken care of before submitting<br>
the PR.</p>
<ul>
<li>
<p>[ ] This has been discussed in issue #..., or if not, please tell us why<br>
  here.</p>
</li>
<li>
<p>[ ] A short description of what this does, why it is needed; if the<br>
  description becomes long, the matter should probably be discussed in an issue<br>
  first.</p>
</li>
<li>
<p>[ ] This PR contains test cases, if meaningful.</p>
</li>
<li>[ ] A reviewer from the core maintainer team has been assigned for this PR.<br>
  If you don't know who could review this, please indicate so. The list of<br>
  suggested reviewers on the right can help you.</li>
</ul>
<p>Please ensure all communication adheres to the <a href="https://github.com/bytecodealliance/wasmtime/blob/master/CODE_OF_CONDUCT.md">code of
conduct</a>.<br>
--&gt;</p>
</blockquote>



<a name="197752420"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231717%20Automate%20borrow%20checking%20in%20wiggle/near/197752420" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231717.20Automate.20borrow.20checking.20in.20wiggle.html#197752420">(May 15 2020 at 21:07)</a>:</h4>
<p>pchickey updated <a href="https://github.com/bytecodealliance/wasmtime/pull/1717">PR #1717</a> from <code>pch/wiggle_auto_borrow_checking</code> to <code>master</code>:</p>
<blockquote>
<p>WIP</p>
<p>&lt;!--</p>
<p>Please ensure that the following steps are all taken care of before submitting<br>
the PR.</p>
<ul>
<li>
<p>[ ] This has been discussed in issue #..., or if not, please tell us why<br>
  here.</p>
</li>
<li>
<p>[ ] A short description of what this does, why it is needed; if the<br>
  description becomes long, the matter should probably be discussed in an issue<br>
  first.</p>
</li>
<li>
<p>[ ] This PR contains test cases, if meaningful.</p>
</li>
<li>[ ] A reviewer from the core maintainer team has been assigned for this PR.<br>
  If you don't know who could review this, please indicate so. The list of<br>
  suggested reviewers on the right can help you.</li>
</ul>
<p>Please ensure all communication adheres to the <a href="https://github.com/bytecodealliance/wasmtime/blob/master/CODE_OF_CONDUCT.md">code of
conduct</a>.<br>
--&gt;</p>
</blockquote>



<a name="197979227"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231717%20Automate%20borrow%20checking%20in%20wiggle/near/197979227" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231717.20Automate.20borrow.20checking.20in.20wiggle.html#197979227">(May 18 2020 at 18:45)</a>:</h4>
<p>pchickey updated <a href="https://github.com/bytecodealliance/wasmtime/pull/1717">PR #1717</a> from <code>pch/wiggle_auto_borrow_checking</code> to <code>master</code>:</p>
<blockquote>
<p>WIP</p>
<p>&lt;!--</p>
<p>Please ensure that the following steps are all taken care of before submitting<br>
the PR.</p>
<ul>
<li>
<p>[ ] This has been discussed in issue #..., or if not, please tell us why<br>
  here.</p>
</li>
<li>
<p>[ ] A short description of what this does, why it is needed; if the<br>
  description becomes long, the matter should probably be discussed in an issue<br>
  first.</p>
</li>
<li>
<p>[ ] This PR contains test cases, if meaningful.</p>
</li>
<li>[ ] A reviewer from the core maintainer team has been assigned for this PR.<br>
  If you don't know who could review this, please indicate so. The list of<br>
  suggested reviewers on the right can help you.</li>
</ul>
<p>Please ensure all communication adheres to the <a href="https://github.com/bytecodealliance/wasmtime/blob/master/CODE_OF_CONDUCT.md">code of
conduct</a>.<br>
--&gt;</p>
</blockquote>



<a name="198015944"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231717%20Automate%20borrow%20checking%20in%20wiggle/near/198015944" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231717.20Automate.20borrow.20checking.20in.20wiggle.html#198015944">(May 19 2020 at 02:06)</a>:</h4>
<p>pchickey updated <a href="https://github.com/bytecodealliance/wasmtime/pull/1717">PR #1717</a> from <code>pch/wiggle_auto_borrow_checking</code> to <code>master</code>:</p>
<blockquote>
<p>WIP</p>
<p>&lt;!--</p>
<p>Please ensure that the following steps are all taken care of before submitting<br>
the PR.</p>
<ul>
<li>
<p>[ ] This has been discussed in issue #..., or if not, please tell us why<br>
  here.</p>
</li>
<li>
<p>[ ] A short description of what this does, why it is needed; if the<br>
  description becomes long, the matter should probably be discussed in an issue<br>
  first.</p>
</li>
<li>
<p>[ ] This PR contains test cases, if meaningful.</p>
</li>
<li>[ ] A reviewer from the core maintainer team has been assigned for this PR.<br>
  If you don't know who could review this, please indicate so. The list of<br>
  suggested reviewers on the right can help you.</li>
</ul>
<p>Please ensure all communication adheres to the <a href="https://github.com/bytecodealliance/wasmtime/blob/master/CODE_OF_CONDUCT.md">code of
conduct</a>.<br>
--&gt;</p>
</blockquote>



<a name="198016015"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231717%20Automate%20borrow%20checking%20in%20wiggle/near/198016015" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231717.20Automate.20borrow.20checking.20in.20wiggle.html#198016015">(May 19 2020 at 02:08)</a>:</h4>
<p>pchickey updated <a href="https://github.com/bytecodealliance/wasmtime/pull/1717">PR #1717</a> from <code>pch/wiggle_auto_borrow_checking</code> to <code>master</code>:</p>
<blockquote>
<p>WIP</p>
<p>&lt;!--</p>
<p>Please ensure that the following steps are all taken care of before submitting<br>
the PR.</p>
<ul>
<li>
<p>[ ] This has been discussed in issue #..., or if not, please tell us why<br>
  here.</p>
</li>
<li>
<p>[ ] A short description of what this does, why it is needed; if the<br>
  description becomes long, the matter should probably be discussed in an issue<br>
  first.</p>
</li>
<li>
<p>[ ] This PR contains test cases, if meaningful.</p>
</li>
<li>[ ] A reviewer from the core maintainer team has been assigned for this PR.<br>
  If you don't know who could review this, please indicate so. The list of<br>
  suggested reviewers on the right can help you.</li>
</ul>
<p>Please ensure all communication adheres to the <a href="https://github.com/bytecodealliance/wasmtime/blob/master/CODE_OF_CONDUCT.md">code of
conduct</a>.<br>
--&gt;</p>
</blockquote>



<a name="198016167"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231717%20Automate%20borrow%20checking%20in%20wiggle/near/198016167" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231717.20Automate.20borrow.20checking.20in.20wiggle.html#198016167">(May 19 2020 at 02:13)</a>:</h4>
<p>pchickey updated <a href="https://github.com/bytecodealliance/wasmtime/pull/1717">PR #1717</a> from <code>pch/wiggle_auto_borrow_checking</code> to <code>master</code>:</p>
<blockquote>
<p>WIP</p>
<p>&lt;!--</p>
<p>Please ensure that the following steps are all taken care of before submitting<br>
the PR.</p>
<ul>
<li>
<p>[ ] This has been discussed in issue #..., or if not, please tell us why<br>
  here.</p>
</li>
<li>
<p>[ ] A short description of what this does, why it is needed; if the<br>
  description becomes long, the matter should probably be discussed in an issue<br>
  first.</p>
</li>
<li>
<p>[ ] This PR contains test cases, if meaningful.</p>
</li>
<li>[ ] A reviewer from the core maintainer team has been assigned for this PR.<br>
  If you don't know who could review this, please indicate so. The list of<br>
  suggested reviewers on the right can help you.</li>
</ul>
<p>Please ensure all communication adheres to the <a href="https://github.com/bytecodealliance/wasmtime/blob/master/CODE_OF_CONDUCT.md">code of
conduct</a>.<br>
--&gt;</p>
</blockquote>



<a name="198143507"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231717%20Automate%20borrow%20checking%20in%20wiggle/near/198143507" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231717.20Automate.20borrow.20checking.20in.20wiggle.html#198143507">(May 20 2020 at 00:35)</a>:</h4>
<p>pchickey updated <a href="https://github.com/bytecodealliance/wasmtime/pull/1717">PR #1717</a> from <code>pch/wiggle_auto_borrow_checking</code> to <code>master</code>:</p>
<blockquote>
<p>WIP</p>
<p>&lt;!--</p>
<p>Please ensure that the following steps are all taken care of before submitting<br>
the PR.</p>
<ul>
<li>
<p>[ ] This has been discussed in issue #..., or if not, please tell us why<br>
  here.</p>
</li>
<li>
<p>[ ] A short description of what this does, why it is needed; if the<br>
  description becomes long, the matter should probably be discussed in an issue<br>
  first.</p>
</li>
<li>
<p>[ ] This PR contains test cases, if meaningful.</p>
</li>
<li>[ ] A reviewer from the core maintainer team has been assigned for this PR.<br>
  If you don't know who could review this, please indicate so. The list of<br>
  suggested reviewers on the right can help you.</li>
</ul>
<p>Please ensure all communication adheres to the <a href="https://github.com/bytecodealliance/wasmtime/blob/master/CODE_OF_CONDUCT.md">code of
conduct</a>.<br>
--&gt;</p>
</blockquote>



<a name="198145289"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231717%20Automate%20borrow%20checking%20in%20wiggle/near/198145289" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231717.20Automate.20borrow.20checking.20in.20wiggle.html#198145289">(May 20 2020 at 01:13)</a>:</h4>
<p>pchickey updated <a href="https://github.com/bytecodealliance/wasmtime/pull/1717">PR #1717</a> from <code>pch/wiggle_auto_borrow_checking</code> to <code>master</code>:</p>
<blockquote>
<p>WIP</p>
<p>&lt;!--</p>
<p>Please ensure that the following steps are all taken care of before submitting<br>
the PR.</p>
<ul>
<li>
<p>[ ] This has been discussed in issue #..., or if not, please tell us why<br>
  here.</p>
</li>
<li>
<p>[ ] A short description of what this does, why it is needed; if the<br>
  description becomes long, the matter should probably be discussed in an issue<br>
  first.</p>
</li>
<li>
<p>[ ] This PR contains test cases, if meaningful.</p>
</li>
<li>[ ] A reviewer from the core maintainer team has been assigned for this PR.<br>
  If you don't know who could review this, please indicate so. The list of<br>
  suggested reviewers on the right can help you.</li>
</ul>
<p>Please ensure all communication adheres to the <a href="https://github.com/bytecodealliance/wasmtime/blob/master/CODE_OF_CONDUCT.md">code of
conduct</a>.<br>
--&gt;</p>
</blockquote>



<a name="198225288"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231717%20Automate%20borrow%20checking%20in%20wiggle/near/198225288" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231717.20Automate.20borrow.20checking.20in.20wiggle.html#198225288">(May 20 2020 at 16:44)</a>:</h4>
<p>pchickey updated <a href="https://github.com/bytecodealliance/wasmtime/pull/1717">PR #1717</a> from <code>pch/wiggle_auto_borrow_checking</code> to <code>master</code>:</p>
<blockquote>
<p>WIP</p>
<p>&lt;!--</p>
<p>Please ensure that the following steps are all taken care of before submitting<br>
the PR.</p>
<ul>
<li>
<p>[ ] This has been discussed in issue #..., or if not, please tell us why<br>
  here.</p>
</li>
<li>
<p>[ ] A short description of what this does, why it is needed; if the<br>
  description becomes long, the matter should probably be discussed in an issue<br>
  first.</p>
</li>
<li>
<p>[ ] This PR contains test cases, if meaningful.</p>
</li>
<li>[ ] A reviewer from the core maintainer team has been assigned for this PR.<br>
  If you don't know who could review this, please indicate so. The list of<br>
  suggested reviewers on the right can help you.</li>
</ul>
<p>Please ensure all communication adheres to the <a href="https://github.com/bytecodealliance/wasmtime/blob/master/CODE_OF_CONDUCT.md">code of
conduct</a>.<br>
--&gt;</p>
</blockquote>



<a name="198245970"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231717%20Automate%20borrow%20checking%20in%20wiggle/near/198245970" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231717.20Automate.20borrow.20checking.20in.20wiggle.html#198245970">(May 20 2020 at 19:29)</a>:</h4>
<p>pchickey updated <a href="https://github.com/bytecodealliance/wasmtime/pull/1717">PR #1717</a> from <code>pch/wiggle_auto_borrow_checking</code> to <code>master</code>:</p>
<blockquote>
<p>WIP</p>
<p>&lt;!--</p>
<p>Please ensure that the following steps are all taken care of before submitting<br>
the PR.</p>
<ul>
<li>
<p>[ ] This has been discussed in issue #..., or if not, please tell us why<br>
  here.</p>
</li>
<li>
<p>[ ] A short description of what this does, why it is needed; if the<br>
  description becomes long, the matter should probably be discussed in an issue<br>
  first.</p>
</li>
<li>
<p>[ ] This PR contains test cases, if meaningful.</p>
</li>
<li>[ ] A reviewer from the core maintainer team has been assigned for this PR.<br>
  If you don't know who could review this, please indicate so. The list of<br>
  suggested reviewers on the right can help you.</li>
</ul>
<p>Please ensure all communication adheres to the <a href="https://github.com/bytecodealliance/wasmtime/blob/master/CODE_OF_CONDUCT.md">code of
conduct</a>.<br>
--&gt;</p>
</blockquote>



<a name="198249026"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231717%20Automate%20borrow%20checking%20in%20wiggle/near/198249026" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231717.20Automate.20borrow.20checking.20in.20wiggle.html#198249026">(May 20 2020 at 19:55)</a>:</h4>
<p>pchickey updated <a href="https://github.com/bytecodealliance/wasmtime/pull/1717">PR #1717</a> from <code>pch/wiggle_auto_borrow_checking</code> to <code>master</code>:</p>
<blockquote>
<p>WIP</p>
<p>&lt;!--</p>
<p>Please ensure that the following steps are all taken care of before submitting<br>
the PR.</p>
<ul>
<li>
<p>[ ] This has been discussed in issue #..., or if not, please tell us why<br>
  here.</p>
</li>
<li>
<p>[ ] A short description of what this does, why it is needed; if the<br>
  description becomes long, the matter should probably be discussed in an issue<br>
  first.</p>
</li>
<li>
<p>[ ] This PR contains test cases, if meaningful.</p>
</li>
<li>[ ] A reviewer from the core maintainer team has been assigned for this PR.<br>
  If you don't know who could review this, please indicate so. The list of<br>
  suggested reviewers on the right can help you.</li>
</ul>
<p>Please ensure all communication adheres to the <a href="https://github.com/bytecodealliance/wasmtime/blob/master/CODE_OF_CONDUCT.md">code of
conduct</a>.<br>
--&gt;</p>
</blockquote>



<a name="198273473"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231717%20Automate%20borrow%20checking%20in%20wiggle/near/198273473" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231717.20Automate.20borrow.20checking.20in.20wiggle.html#198273473">(May 21 2020 at 00:18)</a>:</h4>
<p>pchickey edited <a href="https://github.com/bytecodealliance/wasmtime/pull/1717">PR #1717</a> from <code>pch/wiggle_auto_borrow_checking</code> to <code>master</code>:</p>
<blockquote>
<p>This PR re-designs the Wiggle library to automate borrow-checking of slices and strs that reside in WebAssembly memory. This reduces the burden of writing <code>unsafe</code> on Wiggle users, and places all <code>unsafe</code> at the boundary between the Wasm runtime and Wiggle, rather than requiring it inside the implementation of the Wiggle traits.</p>
<p>In short, the <code>GuestPtr::as_raw</code> methods have been replaced with runtime borrow-checked smart pointers. <code>GuestPtr::as_raw</code> gave raw pointers into guest memory and require the user to manually thread around a <code>GuestBorrows</code> instance and use <code>unsafe</code> to turn those raw pointers into references.</p>
<p>This PR deletes the <code>GuestBorrows</code> type and instead defines a <code>BorrowChecker</code> type that understands both borrows and drops (unborrows). Instead of having the user pass the BorrowChecker to all of the sites where it is needed, it gets passed to the Wiggle ABI-level function once (this, along with construction, is taken care of by <code>wig</code>) and each <code>GuestPtr</code> has an internal shared ref to it. The user doesn't ever handle borrowing or unborrowing directly - those methods are private to the crate and are taken care of by <code>GuestPtr</code>, plus the <code>GuestSlice</code> and <code>GuestStr</code> drop impls. Each pointer makes the borrow checker accessible via <code>GuestPtr::borrow_checker(&amp;self) -&gt; &amp;BorrowChecker</code>, which is useful for inspecting <code>BorrowChecker::has_outstanding_borrows(&amp;self) -&gt; bool</code>.</p>
<p>The <code>GuestPtr::as_raw</code> methods are replaced by <code>GuestPtr::as_slice</code> on <code>GuestPtr&lt;[T]&gt;</code> and <code>GuestPtr::as_str</code> on <code>GuestPtr&lt;str&gt;</code>. These new methods return a <code>GuestSlice&lt;T&gt;</code> and <code>GuestStr</code>, respectively. These are just basic "smart pointers" in that they contain a <code>&amp;mut</code> ref to the memory that is borrowed, impl <code>Deref</code> and <code>DerefMut</code>, and have a <code>Drop</code> impl which tells the <code>BorrowChecker</code> that the memory is no longer borrowed.</p>
<p>Additionally, each <code>GuestPtr::read</code> and <code>write</code> verifies that the target of that read or write is not borrowed, which is safer than Wiggle was before, where the user had to manually borrow any GuestPtr (with no way to unborrow it afterwards!) before reading or writing it while another borrow was outstanding.</p>
<p>In addition to the changes in <code>wiggle</code>, this PR updates <code>wig</code> and <code>wasi-common</code> for the new interfaces.</p>
<p>Many thanks to @alexcrichton who helped me with the design and implementation of this PR.</p>
<p>&lt;!--</p>
<p>Please ensure that the following steps are all taken care of before submitting<br>
the PR.</p>
<ul>
<li>
<p>[ ] This has been discussed in issue #..., or if not, please tell us why<br>
  here.</p>
</li>
<li>
<p>[ ] A short description of what this does, why it is needed; if the<br>
  description becomes long, the matter should probably be discussed in an issue<br>
  first.</p>
</li>
<li>
<p>[ ] This PR contains test cases, if meaningful.</p>
</li>
<li>[ ] A reviewer from the core maintainer team has been assigned for this PR.<br>
  If you don't know who could review this, please indicate so. The list of<br>
  suggested reviewers on the right can help you.</li>
</ul>
<p>Please ensure all communication adheres to the <a href="https://github.com/bytecodealliance/wasmtime/blob/master/CODE_OF_CONDUCT.md">code of
conduct</a>.<br>
--&gt;</p>
</blockquote>



<a name="198273487"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231717%20Automate%20borrow%20checking%20in%20wiggle/near/198273487" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231717.20Automate.20borrow.20checking.20in.20wiggle.html#198273487">(May 21 2020 at 00:18)</a>:</h4>
<p><strong>pchickey</strong> requested <a href="https://github.com/alexcrichton">alexcrichton</a> for a review on <a href="https://github.com/bytecodealliance/wasmtime/pull/1717">PR #1717</a>.</p>



<a name="198273492"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231717%20Automate%20borrow%20checking%20in%20wiggle/near/198273492" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231717.20Automate.20borrow.20checking.20in.20wiggle.html#198273492">(May 21 2020 at 00:18)</a>:</h4>
<p><strong>pchickey</strong> requested <a href="https://github.com/alexcrichton">alexcrichton</a> and <a href="https://github.com/kubkon">kubkon</a> for a review on <a href="https://github.com/bytecodealliance/wasmtime/pull/1717">PR #1717</a>.</p>



<a name="198342566"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231717%20Automate%20borrow%20checking%20in%20wiggle/near/198342566" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231717.20Automate.20borrow.20checking.20in.20wiggle.html#198342566">(May 21 2020 at 16:26)</a>:</h4>
<p>kubkon submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/1717#pullrequestreview-416283019">PR Review</a>.</p>



<a name="198342569"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231717%20Automate%20borrow%20checking%20in%20wiggle/near/198342569" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231717.20Automate.20borrow.20checking.20in.20wiggle.html#198342569">(May 21 2020 at 16:26)</a>:</h4>
<p>kubkon created <a href="https://github.com/bytecodealliance/wasmtime/pull/1717#discussion_r428753155">PR Review Comment</a>:</p>
<blockquote>
<p>Is that necessary? Could we scope it instead to do auto-dropping?</p>
</blockquote>



<a name="198342570"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231717%20Automate%20borrow%20checking%20in%20wiggle/near/198342570" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231717.20Automate.20borrow.20checking.20in.20wiggle.html#198342570">(May 21 2020 at 16:26)</a>:</h4>
<p>kubkon created <a href="https://github.com/bytecodealliance/wasmtime/pull/1717#discussion_r428758101">PR Review Comment</a>:</p>
<blockquote>
<p>I know it's not saving us much, but just FWIW, I think this one-liner should also work:</p>
<div class="codehilite"><pre><span></span><code><span class="n">trace</span><span class="o">!</span><span class="p">(</span><span class="s">&quot;     | old_path=&#39;{}&#39;&quot;</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;*</span><span class="n">old_path</span><span class="p">.</span><span class="n">as_str</span><span class="p">()</span><span class="o">?</span><span class="p">);</span><span class="w"></span>
</code></pre></div>


</blockquote>



<a name="198342571"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231717%20Automate%20borrow%20checking%20in%20wiggle/near/198342571" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231717.20Automate.20borrow.20checking.20in.20wiggle.html#198342571">(May 21 2020 at 16:26)</a>:</h4>
<p>kubkon created <a href="https://github.com/bytecodealliance/wasmtime/pull/1717#discussion_r428759269">PR Review Comment</a>:</p>
<blockquote>
<p>Is <code>BorrowCheckerOOM</code> meant to signify an out-of-memory error? If that's the case, I'd suggest we be more verbose and spell the full thing out here: <code>BorrowCheckerOutOfMemory</code>. It hopefully will be less confusing for the newcomers.</p>
</blockquote>



<a name="198342572"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231717%20Automate%20borrow%20checking%20in%20wiggle/near/198342572" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231717.20Automate.20borrow.20checking.20in.20wiggle.html#198342572">(May 21 2020 at 16:26)</a>:</h4>
<p>kubkon submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/1717#pullrequestreview-416283019">PR Review</a>.</p>



<a name="198342573"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231717%20Automate%20borrow%20checking%20in%20wiggle/near/198342573" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231717.20Automate.20borrow.20checking.20in.20wiggle.html#198342573">(May 21 2020 at 16:26)</a>:</h4>
<p>kubkon created <a href="https://github.com/bytecodealliance/wasmtime/pull/1717#discussion_r428756947">PR Review Comment</a>:</p>
<blockquote>
<p>So the cool thing about the previous approach was that we didn't have to do iterate twice over the same array, which we unfortunately do now. I haven't look in-depth into <code>GuestSlice</code>, so I'm not sure how to go about managing lifetimes here yet, but would it be possible to store <code>io::IoSliceMut</code> in the first pass rather than do the conversion from <code>GuestSlice</code> to <code>&amp;mut [u8]</code> here?</p>
</blockquote>



<a name="198342574"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231717%20Automate%20borrow%20checking%20in%20wiggle/near/198342574" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231717.20Automate.20borrow.20checking.20in.20wiggle.html#198342574">(May 21 2020 at 16:26)</a>:</h4>
<p>kubkon created <a href="https://github.com/bytecodealliance/wasmtime/pull/1717#discussion_r428761313">PR Review Comment</a>:</p>
<blockquote>
<p>Given that the invariant is we have only one instance of <code>BorrowChecker</code> per Wasm memory, would it make sense to somehow orchestrate the use of <code>Once</code> here to enforce that? Or would that be an overkill?</p>
</blockquote>



<a name="198342575"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231717%20Automate%20borrow%20checking%20in%20wiggle/near/198342575" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231717.20Automate.20borrow.20checking.20in.20wiggle.html#198342575">(May 21 2020 at 16:26)</a>:</h4>
<p>kubkon created <a href="https://github.com/bytecodealliance/wasmtime/pull/1717#discussion_r428764647">PR Review Comment</a>:</p>
<blockquote>
<p>I might have missed it, but do we actually handle the case here where, if we handed out all available handles, but then the user unborrows some region, we actually still trip with <code>BorrowCheckerOOM</code> on the next call to <code>self.new_handle()</code> since the unborrowed handle is never returned back to the pool? Or do we actually take care of it and I just missed it?</p>
</blockquote>



<a name="198342577"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231717%20Automate%20borrow%20checking%20in%20wiggle/near/198342577" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231717.20Automate.20borrow.20checking.20in.20wiggle.html#198342577">(May 21 2020 at 16:26)</a>:</h4>
<p>kubkon created <a href="https://github.com/bytecodealliance/wasmtime/pull/1717#discussion_r428764960">PR Review Comment</a>:</p>
<blockquote>
<p>Oh and btw, it might also be good to add this scenario as a test case.</p>
</blockquote>



<a name="198342619"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231717%20Automate%20borrow%20checking%20in%20wiggle/near/198342619" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231717.20Automate.20borrow.20checking.20in.20wiggle.html#198342619">(May 21 2020 at 16:27)</a>:</h4>
<p>kubkon submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/1717#pullrequestreview-416283019">PR Review</a>.</p>



<a name="198358509"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231717%20Automate%20borrow%20checking%20in%20wiggle/near/198358509" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231717.20Automate.20borrow.20checking.20in.20wiggle.html#198358509">(May 21 2020 at 18:33)</a>:</h4>
<p>alexcrichton submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/1717#pullrequestreview-416391950">PR Review</a>.</p>



<a name="198358510"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231717%20Automate%20borrow%20checking%20in%20wiggle/near/198358510" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231717.20Automate.20borrow.20checking.20in.20wiggle.html#198358510">(May 21 2020 at 18:33)</a>:</h4>
<p>alexcrichton created <a href="https://github.com/bytecodealliance/wasmtime/pull/1717#discussion_r428837190">PR Review Comment</a>:</p>
<blockquote>
<p>I think <code>guest_slices</code> could presumably be <code>Vec&lt;IoSliceMut&gt;</code> here, right? I don't think there's any intrinsic reason a second iteration is required?</p>
</blockquote>



<a name="198358643"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231717%20Automate%20borrow%20checking%20in%20wiggle/near/198358643" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231717.20Automate.20borrow.20checking.20in.20wiggle.html#198358643">(May 21 2020 at 18:34)</a>:</h4>
<p>kubkon submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/1717#pullrequestreview-416392721">PR Review</a>.</p>



<a name="198358644"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231717%20Automate%20borrow%20checking%20in%20wiggle/near/198358644" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231717.20Automate.20borrow.20checking.20in.20wiggle.html#198358644">(May 21 2020 at 18:34)</a>:</h4>
<p>kubkon created <a href="https://github.com/bytecodealliance/wasmtime/pull/1717#discussion_r428837737">PR Review Comment</a>:</p>
<blockquote>
<p>Yep, that'd be ideal.</p>
</blockquote>



<a name="198358828"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231717%20Automate%20borrow%20checking%20in%20wiggle/near/198358828" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231717.20Automate.20borrow.20checking.20in.20wiggle.html#198358828">(May 21 2020 at 18:36)</a>:</h4>
<p>alexcrichton submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/1717#pullrequestreview-416393920">PR Review</a>.</p>



<a name="198358829"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231717%20Automate%20borrow%20checking%20in%20wiggle/near/198358829" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231717.20Automate.20borrow.20checking.20in.20wiggle.html#198358829">(May 21 2020 at 18:36)</a>:</h4>
<p>alexcrichton created <a href="https://github.com/bytecodealliance/wasmtime/pull/1717#discussion_r428838679">PR Review Comment</a>:</p>
<blockquote>
<p>FWIW this makes <code>sizeof(GuestPtr&lt;T&gt;)</code> to be 4 words large (2 pointers for mem, 1 for bc, one for <code>pointer</code>).</p>
<p>It might be best to package up with:</p>
<div class="codehilite"><pre><span></span><code><span class="k">pub</span><span class="w"> </span><span class="k">struct</span> <span class="nc">BikeshedMe</span><span class="o">&lt;</span><span class="na">&#39;a</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">mem</span>: <span class="kp">&amp;</span><span class="na">&#39;a</span><span class="w"> </span><span class="p">(</span><span class="k">dyn</span><span class="w"> </span><span class="n">GuestMemory</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="na">&#39;a</span><span class="p">),</span><span class="w"></span>
<span class="w">    </span><span class="n">bc</span>: <span class="kp">&amp;</span><span class="na">&#39;a</span><span class="w"> </span><span class="n">BorrowChecker</span><span class="p">,</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="k">pub</span><span class="w"> </span><span class="k">struct</span> <span class="nc">GuestPtr</span><span class="o">&lt;</span><span class="na">&#39;a</span><span class="p">,</span><span class="w"> </span><span class="n">T</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">data</span>: <span class="kp">&amp;</span><span class="na">&#39;a</span><span class="w"> </span><span class="n">BikeshedMe</span><span class="o">&lt;</span><span class="na">&#39;a</span><span class="o">&gt;</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="n">pointer</span>: <span class="nc">T</span>::<span class="n">Pointer</span><span class="p">,</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>


<p>(and have <code>GuestPtr::new</code> take <code>&amp;BikeshedMe</code>)</p>
</blockquote>



<a name="198359111"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231717%20Automate%20borrow%20checking%20in%20wiggle/near/198359111" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231717.20Automate.20borrow.20checking.20in.20wiggle.html#198359111">(May 21 2020 at 18:38)</a>:</h4>
<p>kubkon submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/1717#pullrequestreview-416395466">PR Review</a>.</p>



<a name="198359112"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231717%20Automate%20borrow%20checking%20in%20wiggle/near/198359112" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231717.20Automate.20borrow.20checking.20in.20wiggle.html#198359112">(May 21 2020 at 18:38)</a>:</h4>
<p>kubkon created <a href="https://github.com/bytecodealliance/wasmtime/pull/1717#discussion_r428839935">PR Review Comment</a>:</p>
<blockquote>
<p>Oh, that's a cool suggestion! <span aria-label="+1" class="emoji emoji-1f44d" role="img" title="+1">:+1:</span></p>
</blockquote>



<a name="198359450"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231717%20Automate%20borrow%20checking%20in%20wiggle/near/198359450" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231717.20Automate.20borrow.20checking.20in.20wiggle.html#198359450">(May 21 2020 at 18:41)</a>:</h4>
<p>alexcrichton submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/1717#pullrequestreview-416397436">PR Review</a>.</p>



<a name="198360316"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231717%20Automate%20borrow%20checking%20in%20wiggle/near/198360316" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231717.20Automate.20borrow.20checking.20in.20wiggle.html#198360316">(May 21 2020 at 18:48)</a>:</h4>
<p>pchickey submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/1717#pullrequestreview-416402572">PR Review</a>.</p>



<a name="198360317"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231717%20Automate%20borrow%20checking%20in%20wiggle/near/198360317" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231717.20Automate.20borrow.20checking.20in.20wiggle.html#198360317">(May 21 2020 at 18:48)</a>:</h4>
<p>pchickey created <a href="https://github.com/bytecodealliance/wasmtime/pull/1717#discussion_r428845385">PR Review Comment</a>:</p>
<blockquote>
<p>this doesn't turn out to be necessary at all, idk what I was thinking. thanks for catching it.</p>
</blockquote>



<a name="198360894"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231717%20Automate%20borrow%20checking%20in%20wiggle/near/198360894" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231717.20Automate.20borrow.20checking.20in.20wiggle.html#198360894">(May 21 2020 at 18:53)</a>:</h4>
<p>pchickey submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/1717#pullrequestreview-416406035">PR Review</a>.</p>



<a name="198360895"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231717%20Automate%20borrow%20checking%20in%20wiggle/near/198360895" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231717.20Automate.20borrow.20checking.20in.20wiggle.html#198360895">(May 21 2020 at 18:53)</a>:</h4>
<p>pchickey created <a href="https://github.com/bytecodealliance/wasmtime/pull/1717#discussion_r428848085">PR Review Comment</a>:</p>
<blockquote>
<p>This is the trickiest thing I had to deal with with these changes. For safety, we need the <code>GuestSlice</code> to stay alive for at least as long as any <code>&amp;mut [u8]</code> we get from it (Deref trait enforces this). I couldn't find any other mechanism to collect all of the <code>GuestSlice</code>s (creating them does the borrow check) and then use them as <code>&amp;mut [u8]</code> without iterating through them twice. I agree its not great, but the number of vectors hopefully won't be big enough that this becomes a big performance hit. If it does become a problem, we could perhaps find a faster mechanism that involves some manual <code>unsafe</code>, but I'd prefer not to cross that bridge yet.</p>
</blockquote>



<a name="198360996"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231717%20Automate%20borrow%20checking%20in%20wiggle/near/198360996" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231717.20Automate.20borrow.20checking.20in.20wiggle.html#198360996">(May 21 2020 at 18:54)</a>:</h4>
<p>pchickey submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/1717#pullrequestreview-416406427">PR Review</a>.</p>



<a name="198360997"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231717%20Automate%20borrow%20checking%20in%20wiggle/near/198360997" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231717.20Automate.20borrow.20checking.20in.20wiggle.html#198360997">(May 21 2020 at 18:54)</a>:</h4>
<p>pchickey created <a href="https://github.com/bytecodealliance/wasmtime/pull/1717#discussion_r428848393">PR Review Comment</a>:</p>
<blockquote>
<p>We need it in the next line as a &amp;str, too</p>
</blockquote>



<a name="198361044"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231717%20Automate%20borrow%20checking%20in%20wiggle/near/198361044" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231717.20Automate.20borrow.20checking.20in.20wiggle.html#198361044">(May 21 2020 at 18:54)</a>:</h4>
<p>pchickey edited <a href="https://github.com/bytecodealliance/wasmtime/pull/1717#discussion_r428848393">PR Review Comment</a>.</p>



<a name="198361065"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231717%20Automate%20borrow%20checking%20in%20wiggle/near/198361065" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231717.20Automate.20borrow.20checking.20in.20wiggle.html#198361065">(May 21 2020 at 18:55)</a>:</h4>
<p>pchickey submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/1717#pullrequestreview-416406837">PR Review</a>.</p>



<a name="198361067"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231717%20Automate%20borrow%20checking%20in%20wiggle/near/198361067" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231717.20Automate.20borrow.20checking.20in.20wiggle.html#198361067">(May 21 2020 at 18:55)</a>:</h4>
<p>pchickey created <a href="https://github.com/bytecodealliance/wasmtime/pull/1717#discussion_r428848710">PR Review Comment</a>:</p>
<blockquote>
<p><code>BorrowCheckerOutOfHandles</code> is the right way to spell it, thanks</p>
</blockquote>



<a name="198361309"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231717%20Automate%20borrow%20checking%20in%20wiggle/near/198361309" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231717.20Automate.20borrow.20checking.20in.20wiggle.html#198361309">(May 21 2020 at 18:57)</a>:</h4>
<p>pchickey submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/1717#pullrequestreview-416408157">PR Review</a>.</p>



<a name="198361310"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231717%20Automate%20borrow%20checking%20in%20wiggle/near/198361310" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231717.20Automate.20borrow.20checking.20in.20wiggle.html#198361310">(May 21 2020 at 18:57)</a>:</h4>
<p>pchickey created <a href="https://github.com/bytecodealliance/wasmtime/pull/1717#discussion_r428849758">PR Review Comment</a>:</p>
<blockquote>
<p>I believe <code>Once</code> is for one-time-globally, we actually do want to create a new one of these for each wasm instance we create, and at an even smaller scale for each hostcall if we can guarantee that is equivalent (no recursive calls, basically)</p>
</blockquote>



<a name="198361902"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231717%20Automate%20borrow%20checking%20in%20wiggle/near/198361902" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231717.20Automate.20borrow.20checking.20in.20wiggle.html#198361902">(May 21 2020 at 19:01)</a>:</h4>
<p>pchickey submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/1717#pullrequestreview-416410959">PR Review</a>.</p>



<a name="198361907"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231717%20Automate%20borrow%20checking%20in%20wiggle/near/198361907" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231717.20Automate.20borrow.20checking.20in.20wiggle.html#198361907">(May 21 2020 at 19:01)</a>:</h4>
<p>pchickey created <a href="https://github.com/bytecodealliance/wasmtime/pull/1717#discussion_r428852022">PR Review Comment</a>:</p>
<blockquote>
<p>Yes, this datastructure isnt smart enough to recycle handles, because I didn't want to incur the bookkeeping cost for what should only happen in a pathological scenario of user code - if you were to <code>{ borrow(r1); loop { h2 = borrow(r2); unborrow(h2) } }</code> you'd eventually run out of handles. I can add a test that shows this bad behavior is present, with a note that we might want to try to fix it.</p>
<p>If we recycled all unborrowed handles, it would be impossible to run out because the bound of <code>usize</code> handles is at least as big as the 32 bit memory space described by <code>Region</code>.</p>
</blockquote>



<a name="198362084"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231717%20Automate%20borrow%20checking%20in%20wiggle/near/198362084" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231717.20Automate.20borrow.20checking.20in.20wiggle.html#198362084">(May 21 2020 at 19:02)</a>:</h4>
<p>pchickey submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/1717#pullrequestreview-416411786">PR Review</a>.</p>



<a name="198362086"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231717%20Automate%20borrow%20checking%20in%20wiggle/near/198362086" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231717.20Automate.20borrow.20checking.20in.20wiggle.html#198362086">(May 21 2020 at 19:02)</a>:</h4>
<p>pchickey created <a href="https://github.com/bytecodealliance/wasmtime/pull/1717#discussion_r428852646">PR Review Comment</a>:</p>
<blockquote>
<p>Good point, I prefer your second solution that makes it a method on GuestMemory - the same code is responsible for constructing and passing each.</p>
</blockquote>



<a name="198362381"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231717%20Automate%20borrow%20checking%20in%20wiggle/near/198362381" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231717.20Automate.20borrow.20checking.20in.20wiggle.html#198362381">(May 21 2020 at 19:04)</a>:</h4>
<p>kubkon submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/1717#pullrequestreview-416413463">PR Review</a>.</p>



<a name="198362382"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231717%20Automate%20borrow%20checking%20in%20wiggle/near/198362382" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231717.20Automate.20borrow.20checking.20in.20wiggle.html#198362382">(May 21 2020 at 19:04)</a>:</h4>
<p>kubkon created <a href="https://github.com/bytecodealliance/wasmtime/pull/1717#discussion_r428853940">PR Review Comment</a>:</p>
<blockquote>
<p>Ah, right, makes sense. I forgot we can have multiple Wasm memories at once.</p>
</blockquote>



<a name="198362565"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231717%20Automate%20borrow%20checking%20in%20wiggle/near/198362565" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231717.20Automate.20borrow.20checking.20in.20wiggle.html#198362565">(May 21 2020 at 19:06)</a>:</h4>
<p>kubkon submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/1717#pullrequestreview-416414552">PR Review</a>.</p>



<a name="198362566"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231717%20Automate%20borrow%20checking%20in%20wiggle/near/198362566" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231717.20Automate.20borrow.20checking.20in.20wiggle.html#198362566">(May 21 2020 at 19:06)</a>:</h4>
<p>kubkon created <a href="https://github.com/bytecodealliance/wasmtime/pull/1717#discussion_r428854775">PR Review Comment</a>:</p>
<blockquote>
<p>Yep, that's a good point on the number of handles. I noticed this since we've faced the same problem with the <code>FdPool</code> in <code>wasi-common</code>, there handles being actual WASI file descriptors. Anyhow, a test case demonstrating the behaviour plus a comment sounds great to me!</p>
</blockquote>



<a name="198363163"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231717%20Automate%20borrow%20checking%20in%20wiggle/near/198363163" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231717.20Automate.20borrow.20checking.20in.20wiggle.html#198363163">(May 21 2020 at 19:11)</a>:</h4>
<p>pchickey submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/1717#pullrequestreview-416417663">PR Review</a>.</p>



<a name="198363164"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231717%20Automate%20borrow%20checking%20in%20wiggle/near/198363164" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231717.20Automate.20borrow.20checking.20in.20wiggle.html#198363164">(May 21 2020 at 19:11)</a>:</h4>
<p>pchickey created <a href="https://github.com/bytecodealliance/wasmtime/pull/1717#discussion_r428857178">PR Review Comment</a>:</p>
<blockquote>
<p>I wrote a test for this (requires 2^64 iterations) and it ran for more than 60 seconds before I killed it, so I don't want to include it in the test suite. I'll leave a description of the behavior as a comment.</p>
</blockquote>



<a name="198364508"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231717%20Automate%20borrow%20checking%20in%20wiggle/near/198364508" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231717.20Automate.20borrow.20checking.20in.20wiggle.html#198364508">(May 21 2020 at 19:23)</a>:</h4>
<p>pchickey updated <a href="https://github.com/bytecodealliance/wasmtime/pull/1717">PR #1717</a> from <code>pch/wiggle_auto_borrow_checking</code> to <code>master</code>:</p>
<blockquote>
<p>This PR re-designs the Wiggle library to automate borrow-checking of slices and strs that reside in WebAssembly memory. This reduces the burden of writing <code>unsafe</code> on Wiggle users, and places all <code>unsafe</code> at the boundary between the Wasm runtime and Wiggle, rather than requiring it inside the implementation of the Wiggle traits.</p>
<p>In short, the <code>GuestPtr::as_raw</code> methods have been replaced with runtime borrow-checked smart pointers. <code>GuestPtr::as_raw</code> gave raw pointers into guest memory and require the user to manually thread around a <code>GuestBorrows</code> instance and use <code>unsafe</code> to turn those raw pointers into references.</p>
<p>This PR deletes the <code>GuestBorrows</code> type and instead defines a <code>BorrowChecker</code> type that understands both borrows and drops (unborrows). Instead of having the user pass the BorrowChecker to all of the sites where it is needed, it gets passed to the Wiggle ABI-level function once (this, along with construction, is taken care of by <code>wig</code>) and each <code>GuestPtr</code> has an internal shared ref to it. The user doesn't ever handle borrowing or unborrowing directly - those methods are private to the crate and are taken care of by <code>GuestPtr</code>, plus the <code>GuestSlice</code> and <code>GuestStr</code> drop impls. Each pointer makes the borrow checker accessible via <code>GuestPtr::borrow_checker(&amp;self) -&gt; &amp;BorrowChecker</code>, which is useful for inspecting <code>BorrowChecker::has_outstanding_borrows(&amp;self) -&gt; bool</code>.</p>
<p>The <code>GuestPtr::as_raw</code> methods are replaced by <code>GuestPtr::as_slice</code> on <code>GuestPtr&lt;[T]&gt;</code> and <code>GuestPtr::as_str</code> on <code>GuestPtr&lt;str&gt;</code>. These new methods return a <code>GuestSlice&lt;T&gt;</code> and <code>GuestStr</code>, respectively. These are just basic "smart pointers" in that they contain a <code>&amp;mut</code> ref to the memory that is borrowed, impl <code>Deref</code> and <code>DerefMut</code>, and have a <code>Drop</code> impl which tells the <code>BorrowChecker</code> that the memory is no longer borrowed.</p>
<p>Additionally, each <code>GuestPtr::read</code> and <code>write</code> verifies that the target of that read or write is not borrowed, which is safer than Wiggle was before, where the user had to manually borrow any GuestPtr (with no way to unborrow it afterwards!) before reading or writing it while another borrow was outstanding.</p>
<p>In addition to the changes in <code>wiggle</code>, this PR updates <code>wig</code> and <code>wasi-common</code> for the new interfaces.</p>
<p>Many thanks to @alexcrichton who helped me with the design and implementation of this PR.</p>
<p>&lt;!--</p>
<p>Please ensure that the following steps are all taken care of before submitting<br>
the PR.</p>
<ul>
<li>
<p>[ ] This has been discussed in issue #..., or if not, please tell us why<br>
  here.</p>
</li>
<li>
<p>[ ] A short description of what this does, why it is needed; if the<br>
  description becomes long, the matter should probably be discussed in an issue<br>
  first.</p>
</li>
<li>
<p>[ ] This PR contains test cases, if meaningful.</p>
</li>
<li>[ ] A reviewer from the core maintainer team has been assigned for this PR.<br>
  If you don't know who could review this, please indicate so. The list of<br>
  suggested reviewers on the right can help you.</li>
</ul>
<p>Please ensure all communication adheres to the <a href="https://github.com/bytecodealliance/wasmtime/blob/master/CODE_OF_CONDUCT.md">code of
conduct</a>.<br>
--&gt;</p>
</blockquote>



<a name="198366660"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231717%20Automate%20borrow%20checking%20in%20wiggle/near/198366660" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231717.20Automate.20borrow.20checking.20in.20wiggle.html#198366660">(May 21 2020 at 19:41)</a>:</h4>
<p>pchickey updated <a href="https://github.com/bytecodealliance/wasmtime/pull/1717">PR #1717</a> from <code>pch/wiggle_auto_borrow_checking</code> to <code>master</code>:</p>
<blockquote>
<p>This PR re-designs the Wiggle library to automate borrow-checking of slices and strs that reside in WebAssembly memory. This reduces the burden of writing <code>unsafe</code> on Wiggle users, and places all <code>unsafe</code> at the boundary between the Wasm runtime and Wiggle, rather than requiring it inside the implementation of the Wiggle traits.</p>
<p>In short, the <code>GuestPtr::as_raw</code> methods have been replaced with runtime borrow-checked smart pointers. <code>GuestPtr::as_raw</code> gave raw pointers into guest memory and require the user to manually thread around a <code>GuestBorrows</code> instance and use <code>unsafe</code> to turn those raw pointers into references.</p>
<p>This PR deletes the <code>GuestBorrows</code> type and instead defines a <code>BorrowChecker</code> type that understands both borrows and drops (unborrows). Instead of having the user pass the BorrowChecker to all of the sites where it is needed, it gets passed to the Wiggle ABI-level function once (this, along with construction, is taken care of by <code>wig</code>) and each <code>GuestPtr</code> has an internal shared ref to it. The user doesn't ever handle borrowing or unborrowing directly - those methods are private to the crate and are taken care of by <code>GuestPtr</code>, plus the <code>GuestSlice</code> and <code>GuestStr</code> drop impls. Each pointer makes the borrow checker accessible via <code>GuestPtr::borrow_checker(&amp;self) -&gt; &amp;BorrowChecker</code>, which is useful for inspecting <code>BorrowChecker::has_outstanding_borrows(&amp;self) -&gt; bool</code>.</p>
<p>The <code>GuestPtr::as_raw</code> methods are replaced by <code>GuestPtr::as_slice</code> on <code>GuestPtr&lt;[T]&gt;</code> and <code>GuestPtr::as_str</code> on <code>GuestPtr&lt;str&gt;</code>. These new methods return a <code>GuestSlice&lt;T&gt;</code> and <code>GuestStr</code>, respectively. These are just basic "smart pointers" in that they contain a <code>&amp;mut</code> ref to the memory that is borrowed, impl <code>Deref</code> and <code>DerefMut</code>, and have a <code>Drop</code> impl which tells the <code>BorrowChecker</code> that the memory is no longer borrowed.</p>
<p>Additionally, each <code>GuestPtr::read</code> and <code>write</code> verifies that the target of that read or write is not borrowed, which is safer than Wiggle was before, where the user had to manually borrow any GuestPtr (with no way to unborrow it afterwards!) before reading or writing it while another borrow was outstanding.</p>
<p>In addition to the changes in <code>wiggle</code>, this PR updates <code>wig</code> and <code>wasi-common</code> for the new interfaces.</p>
<p>Many thanks to @alexcrichton who helped me with the design and implementation of this PR.</p>
<p>&lt;!--</p>
<p>Please ensure that the following steps are all taken care of before submitting<br>
the PR.</p>
<ul>
<li>
<p>[ ] This has been discussed in issue #..., or if not, please tell us why<br>
  here.</p>
</li>
<li>
<p>[ ] A short description of what this does, why it is needed; if the<br>
  description becomes long, the matter should probably be discussed in an issue<br>
  first.</p>
</li>
<li>
<p>[ ] This PR contains test cases, if meaningful.</p>
</li>
<li>[ ] A reviewer from the core maintainer team has been assigned for this PR.<br>
  If you don't know who could review this, please indicate so. The list of<br>
  suggested reviewers on the right can help you.</li>
</ul>
<p>Please ensure all communication adheres to the <a href="https://github.com/bytecodealliance/wasmtime/blob/master/CODE_OF_CONDUCT.md">code of
conduct</a>.<br>
--&gt;</p>
</blockquote>



<a name="198371134"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231717%20Automate%20borrow%20checking%20in%20wiggle/near/198371134" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231717.20Automate.20borrow.20checking.20in.20wiggle.html#198371134">(May 21 2020 at 20:14)</a>:</h4>
<p>kubkon submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/1717#pullrequestreview-416458702">PR Review</a>.</p>



<a name="198371135"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231717%20Automate%20borrow%20checking%20in%20wiggle/near/198371135" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231717.20Automate.20borrow.20checking.20in.20wiggle.html#198371135">(May 21 2020 at 20:14)</a>:</h4>
<p>kubkon created <a href="https://github.com/bytecodealliance/wasmtime/pull/1717#discussion_r428889101">PR Review Comment</a>:</p>
<blockquote>
<p>Oh sorry, I thought you’d spoof the test by doing a borrow, followed by an unborrow, and then manually fast forward next available handle to the limit and assert this fails whereas it shouldn’t since there was at least one unborrow registered. Having said that I reckon a comment will do nicely for now.</p>
</blockquote>



<a name="198371203"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231717%20Automate%20borrow%20checking%20in%20wiggle/near/198371203" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231717.20Automate.20borrow.20checking.20in.20wiggle.html#198371203">(May 21 2020 at 20:15)</a>:</h4>
<p>kubkon submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/1717#pullrequestreview-416459087">PR Review</a>.</p>



<a name="198379176"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231717%20Automate%20borrow%20checking%20in%20wiggle/near/198379176" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231717.20Automate.20borrow.20checking.20in.20wiggle.html#198379176">(May 21 2020 at 21:22)</a>:</h4>
<p>pchickey updated <a href="https://github.com/bytecodealliance/wasmtime/pull/1717">PR #1717</a> from <code>pch/wiggle_auto_borrow_checking</code> to <code>master</code>:</p>
<blockquote>
<p>This PR re-designs the Wiggle library to automate borrow-checking of slices and strs that reside in WebAssembly memory. This reduces the burden of writing <code>unsafe</code> on Wiggle users, and places all <code>unsafe</code> at the boundary between the Wasm runtime and Wiggle, rather than requiring it inside the implementation of the Wiggle traits.</p>
<p>In short, the <code>GuestPtr::as_raw</code> methods have been replaced with runtime borrow-checked smart pointers. <code>GuestPtr::as_raw</code> gave raw pointers into guest memory and require the user to manually thread around a <code>GuestBorrows</code> instance and use <code>unsafe</code> to turn those raw pointers into references.</p>
<p>This PR deletes the <code>GuestBorrows</code> type and instead defines a <code>BorrowChecker</code> type that understands both borrows and drops (unborrows). Instead of having the user pass the BorrowChecker to all of the sites where it is needed, it gets passed to the Wiggle ABI-level function once (this, along with construction, is taken care of by <code>wig</code>) and each <code>GuestPtr</code> has an internal shared ref to it. The user doesn't ever handle borrowing or unborrowing directly - those methods are private to the crate and are taken care of by <code>GuestPtr</code>, plus the <code>GuestSlice</code> and <code>GuestStr</code> drop impls. Each pointer makes the borrow checker accessible via <code>GuestPtr::borrow_checker(&amp;self) -&gt; &amp;BorrowChecker</code>, which is useful for inspecting <code>BorrowChecker::has_outstanding_borrows(&amp;self) -&gt; bool</code>.</p>
<p>The <code>GuestPtr::as_raw</code> methods are replaced by <code>GuestPtr::as_slice</code> on <code>GuestPtr&lt;[T]&gt;</code> and <code>GuestPtr::as_str</code> on <code>GuestPtr&lt;str&gt;</code>. These new methods return a <code>GuestSlice&lt;T&gt;</code> and <code>GuestStr</code>, respectively. These are just basic "smart pointers" in that they contain a <code>&amp;mut</code> ref to the memory that is borrowed, impl <code>Deref</code> and <code>DerefMut</code>, and have a <code>Drop</code> impl which tells the <code>BorrowChecker</code> that the memory is no longer borrowed.</p>
<p>Additionally, each <code>GuestPtr::read</code> and <code>write</code> verifies that the target of that read or write is not borrowed, which is safer than Wiggle was before, where the user had to manually borrow any GuestPtr (with no way to unborrow it afterwards!) before reading or writing it while another borrow was outstanding.</p>
<p>In addition to the changes in <code>wiggle</code>, this PR updates <code>wig</code> and <code>wasi-common</code> for the new interfaces.</p>
<p>Many thanks to @alexcrichton who helped me with the design and implementation of this PR.</p>
<p>&lt;!--</p>
<p>Please ensure that the following steps are all taken care of before submitting<br>
the PR.</p>
<ul>
<li>
<p>[ ] This has been discussed in issue #..., or if not, please tell us why<br>
  here.</p>
</li>
<li>
<p>[ ] A short description of what this does, why it is needed; if the<br>
  description becomes long, the matter should probably be discussed in an issue<br>
  first.</p>
</li>
<li>
<p>[ ] This PR contains test cases, if meaningful.</p>
</li>
<li>[ ] A reviewer from the core maintainer team has been assigned for this PR.<br>
  If you don't know who could review this, please indicate so. The list of<br>
  suggested reviewers on the right can help you.</li>
</ul>
<p>Please ensure all communication adheres to the <a href="https://github.com/bytecodealliance/wasmtime/blob/master/CODE_OF_CONDUCT.md">code of
conduct</a>.<br>
--&gt;</p>
</blockquote>



<a name="198387431"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231717%20Automate%20borrow%20checking%20in%20wiggle/near/198387431" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231717.20Automate.20borrow.20checking.20in.20wiggle.html#198387431">(May 21 2020 at 22:48)</a>:</h4>
<p>pchickey updated <a href="https://github.com/bytecodealliance/wasmtime/pull/1717">PR #1717</a> from <code>pch/wiggle_auto_borrow_checking</code> to <code>master</code>:</p>
<blockquote>
<p>This PR re-designs the Wiggle library to automate borrow-checking of slices and strs that reside in WebAssembly memory. This reduces the burden of writing <code>unsafe</code> on Wiggle users, and places all <code>unsafe</code> at the boundary between the Wasm runtime and Wiggle, rather than requiring it inside the implementation of the Wiggle traits.</p>
<p>In short, the <code>GuestPtr::as_raw</code> methods have been replaced with runtime borrow-checked smart pointers. <code>GuestPtr::as_raw</code> gave raw pointers into guest memory and require the user to manually thread around a <code>GuestBorrows</code> instance and use <code>unsafe</code> to turn those raw pointers into references.</p>
<p>This PR deletes the <code>GuestBorrows</code> type and instead defines a <code>BorrowChecker</code> type that understands both borrows and drops (unborrows). Instead of having the user pass the BorrowChecker to all of the sites where it is needed, it gets passed to the Wiggle ABI-level function once (this, along with construction, is taken care of by <code>wig</code>) and each <code>GuestPtr</code> has an internal shared ref to it. The user doesn't ever handle borrowing or unborrowing directly - those methods are private to the crate and are taken care of by <code>GuestPtr</code>, plus the <code>GuestSlice</code> and <code>GuestStr</code> drop impls. Each pointer makes the borrow checker accessible via <code>GuestPtr::borrow_checker(&amp;self) -&gt; &amp;BorrowChecker</code>, which is useful for inspecting <code>BorrowChecker::has_outstanding_borrows(&amp;self) -&gt; bool</code>.</p>
<p>The <code>GuestPtr::as_raw</code> methods are replaced by <code>GuestPtr::as_slice</code> on <code>GuestPtr&lt;[T]&gt;</code> and <code>GuestPtr::as_str</code> on <code>GuestPtr&lt;str&gt;</code>. These new methods return a <code>GuestSlice&lt;T&gt;</code> and <code>GuestStr</code>, respectively. These are just basic "smart pointers" in that they contain a <code>&amp;mut</code> ref to the memory that is borrowed, impl <code>Deref</code> and <code>DerefMut</code>, and have a <code>Drop</code> impl which tells the <code>BorrowChecker</code> that the memory is no longer borrowed.</p>
<p>Additionally, each <code>GuestPtr::read</code> and <code>write</code> verifies that the target of that read or write is not borrowed, which is safer than Wiggle was before, where the user had to manually borrow any GuestPtr (with no way to unborrow it afterwards!) before reading or writing it while another borrow was outstanding.</p>
<p>In addition to the changes in <code>wiggle</code>, this PR updates <code>wig</code> and <code>wasi-common</code> for the new interfaces.</p>
<p>Many thanks to @alexcrichton who helped me with the design and implementation of this PR.</p>
<p>&lt;!--</p>
<p>Please ensure that the following steps are all taken care of before submitting<br>
the PR.</p>
<ul>
<li>
<p>[ ] This has been discussed in issue #..., or if not, please tell us why<br>
  here.</p>
</li>
<li>
<p>[ ] A short description of what this does, why it is needed; if the<br>
  description becomes long, the matter should probably be discussed in an issue<br>
  first.</p>
</li>
<li>
<p>[ ] This PR contains test cases, if meaningful.</p>
</li>
<li>[ ] A reviewer from the core maintainer team has been assigned for this PR.<br>
  If you don't know who could review this, please indicate so. The list of<br>
  suggested reviewers on the right can help you.</li>
</ul>
<p>Please ensure all communication adheres to the <a href="https://github.com/bytecodealliance/wasmtime/blob/master/CODE_OF_CONDUCT.md">code of
conduct</a>.<br>
--&gt;</p>
</blockquote>



<a name="198463740"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231717%20Automate%20borrow%20checking%20in%20wiggle/near/198463740" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231717.20Automate.20borrow.20checking.20in.20wiggle.html#198463740">(May 22 2020 at 16:35)</a>:</h4>
<p>pchickey merged <a href="https://github.com/bytecodealliance/wasmtime/pull/1717">PR #1717</a>.</p>



<hr><p>Last updated: Jan 20 2025 at 06:04 UTC</p>
</html>