<html>
<head><meta charset="utf-8"><title>wasmtime / issue #6759 Cranelift: Get the `tail` calling ... · git-wasmtime · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/index.html">git-wasmtime</a></h2>
<h3>Topic: <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.236759.20Cranelift.3A.20Get.20the.20.60tail.60.20calling.20.2E.2E.2E.html">wasmtime / issue #6759 Cranelift: Get the `tail` calling ...</a></h3>

<hr>

<base href="https://bytecodealliance.zulipchat.com">

<head><link href="https://bytecodealliance.github.io/zulip-archive/style.css" rel="stylesheet"></head>

<a name="377393306"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%236759%20Cranelift%3A%20Get%20the%20%60tail%60%20calling%20.../near/377393306" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.236759.20Cranelift.3A.20Get.20the.20.60tail.60.20calling.20.2E.2E.2E.html#377393306">(Jul 21 2023 at 18:28)</a>:</h4>
<p>fitzgen opened <a href="https://github.com/bytecodealliance/wasmtime/issues/6759">issue #6759</a>:</p>
<blockquote>
<p>That is, regular calls with the <code>tail</code> calling convention should be as fast as regular calls with the <code>fast</code> calling convention.</p>
<p><a href="https://github.com/bytecodealliance/wasmtime/issues/1065#issuecomment-1624395771">https://github.com/bytecodealliance/wasmtime/issues/1065#issuecomment-1624395771</a></p>
<blockquote>
<p>So @jameysharp and I did a little profiling/investigation of switching the internal Wasm calling convention over to tail on our sightglass benchmarks. I was really expecting this to have no measurable change, but unfortunately it looks like it has a ~7% overhead on bz2 and spidermonkey.wasm and ~1% overhead on pulldown-cmark. This is surprising! We think this means that we ~frequently call functions that don't have enough register pressure to clobber all callee-save registers, and since tail only has caller-save registers and zero callee-save registers, we are doing more spills than we used to. Enough more that it is really measurable.</p>
</blockquote>
<p>Here are the histograms of number of clobbered callee-save registers in a function for some of our benchmarks:</p>
<p>&lt;details&gt;</p>
<h3>pulldown-cmark</h3>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code>#<span class="w"> </span><span class="n">Number</span><span class="w"> </span><span class="n">of</span><span class="w"> </span><span class="n">samples</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">757</span>
#<span class="w"> </span><span class="n">Min</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span>
#<span class="w"> </span><span class="n">Max</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">5</span>
#
#<span class="w"> </span><span class="n">Mean</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">1.9682959048877162</span>
#<span class="w"> </span><span class="n">Standard</span><span class="w"> </span><span class="n">deviation</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">2.4428038716280174</span>
#<span class="w"> </span><span class="n">Variance</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">5.967290755240832</span>
#
#<span class="w"> </span><span class="n">Each</span><span class="w"> </span><span class="err">∎</span><span class="w"> </span><span class="n">is</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="n">count</span><span class="w"> </span><span class="n">of</span><span class="w"> </span><span class="mi">9</span>
#
<span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="o">..</span><span class="w">  </span><span class="mi">1</span><span class="w"> </span><span class="p">[</span><span class="w"> </span><span class="mi">459</span><span class="w"> </span><span class="p">]</span>: <span class="err">∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎</span>
<span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="o">..</span><span class="w">  </span><span class="mi">2</span><span class="w"> </span><span class="p">[</span><span class="w">   </span><span class="mi">0</span><span class="w"> </span><span class="p">]</span>:
 <span class="mi">2</span><span class="w"> </span><span class="o">..</span><span class="w">  </span><span class="mi">3</span><span class="w"> </span><span class="p">[</span><span class="w">   </span><span class="mi">0</span><span class="w"> </span><span class="p">]</span>:
 <span class="mi">3</span><span class="w"> </span><span class="o">..</span><span class="w">  </span><span class="mi">4</span><span class="w"> </span><span class="p">[</span><span class="w">   </span><span class="mi">0</span><span class="w"> </span><span class="p">]</span>:
 <span class="mi">4</span><span class="w"> </span><span class="o">..</span><span class="w">  </span><span class="mi">5</span><span class="w"> </span><span class="p">[</span><span class="w">   </span><span class="mi">0</span><span class="w"> </span><span class="p">]</span>:
 <span class="mi">5</span><span class="w"> </span><span class="o">..</span><span class="w">  </span><span class="mi">6</span><span class="w"> </span><span class="p">[</span><span class="w"> </span><span class="mi">298</span><span class="w"> </span><span class="p">]</span>: <span class="err">∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎</span>
<span class="w"> </span><span class="mi">6</span><span class="w"> </span><span class="o">..</span><span class="w">  </span><span class="mi">7</span><span class="w"> </span><span class="p">[</span><span class="w">   </span><span class="mi">0</span><span class="w"> </span><span class="p">]</span>:
 <span class="mi">7</span><span class="w"> </span><span class="o">..</span><span class="w">  </span><span class="mi">8</span><span class="w"> </span><span class="p">[</span><span class="w">   </span><span class="mi">0</span><span class="w"> </span><span class="p">]</span>:
 <span class="mi">8</span><span class="w"> </span><span class="o">..</span><span class="w">  </span><span class="mi">9</span><span class="w"> </span><span class="p">[</span><span class="w">   </span><span class="mi">0</span><span class="w"> </span><span class="p">]</span>:
 <span class="mi">9</span><span class="w"> </span><span class="o">..</span><span class="w"> </span><span class="mi">10</span><span class="w"> </span><span class="p">[</span><span class="w">   </span><span class="mi">0</span><span class="w"> </span><span class="p">]</span>:
</code></pre></div>
<h3>spidermonkey</h3>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code>#<span class="w"> </span><span class="n">Number</span><span class="w"> </span><span class="n">of</span><span class="w"> </span><span class="n">samples</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">18279</span>
#<span class="w"> </span><span class="n">Min</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span>
#<span class="w"> </span><span class="n">Max</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">5</span>
#
#<span class="w"> </span><span class="n">Mean</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">1.8119153126538674</span>
#<span class="w"> </span><span class="n">Standard</span><span class="w"> </span><span class="n">deviation</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">2.4034432514706436</span>
#<span class="w"> </span><span class="n">Variance</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">5.77653946303978</span>
#
#<span class="w"> </span><span class="n">Each</span><span class="w"> </span><span class="err">∎</span><span class="w"> </span><span class="n">is</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="n">count</span><span class="w"> </span><span class="n">of</span><span class="w"> </span><span class="mi">233</span>
#
<span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="o">..</span><span class="w">  </span><span class="mi">1</span><span class="w"> </span><span class="p">[</span><span class="w"> </span><span class="mi">11655</span><span class="w"> </span><span class="p">]</span>: <span class="err">∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎</span>
<span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="o">..</span><span class="w">  </span><span class="mi">2</span><span class="w"> </span><span class="p">[</span><span class="w">     </span><span class="mi">0</span><span class="w"> </span><span class="p">]</span>:
 <span class="mi">2</span><span class="w"> </span><span class="o">..</span><span class="w">  </span><span class="mi">3</span><span class="w"> </span><span class="p">[</span><span class="w">     </span><span class="mi">0</span><span class="w"> </span><span class="p">]</span>:
 <span class="mi">3</span><span class="w"> </span><span class="o">..</span><span class="w">  </span><span class="mi">4</span><span class="w"> </span><span class="p">[</span><span class="w">     </span><span class="mi">0</span><span class="w"> </span><span class="p">]</span>:
 <span class="mi">4</span><span class="w"> </span><span class="o">..</span><span class="w">  </span><span class="mi">5</span><span class="w"> </span><span class="p">[</span><span class="w">     </span><span class="mi">0</span><span class="w"> </span><span class="p">]</span>:
 <span class="mi">5</span><span class="w"> </span><span class="o">..</span><span class="w">  </span><span class="mi">6</span><span class="w"> </span><span class="p">[</span><span class="w">  </span><span class="mi">6624</span><span class="w"> </span><span class="p">]</span>: <span class="err">∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎</span>
<span class="w"> </span><span class="mi">6</span><span class="w"> </span><span class="o">..</span><span class="w">  </span><span class="mi">7</span><span class="w"> </span><span class="p">[</span><span class="w">     </span><span class="mi">0</span><span class="w"> </span><span class="p">]</span>:
 <span class="mi">7</span><span class="w"> </span><span class="o">..</span><span class="w">  </span><span class="mi">8</span><span class="w"> </span><span class="p">[</span><span class="w">     </span><span class="mi">0</span><span class="w"> </span><span class="p">]</span>:
 <span class="mi">8</span><span class="w"> </span><span class="o">..</span><span class="w">  </span><span class="mi">9</span><span class="w"> </span><span class="p">[</span><span class="w">     </span><span class="mi">0</span><span class="w"> </span><span class="p">]</span>:
 <span class="mi">9</span><span class="w"> </span><span class="o">..</span><span class="w"> </span><span class="mi">10</span><span class="w"> </span><span class="p">[</span><span class="w">     </span><span class="mi">0</span><span class="w"> </span><span class="p">]</span>:
</code></pre></div>
<h3>bz2</h3>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code>#<span class="w"> </span><span class="n">Number</span><span class="w"> </span><span class="n">of</span><span class="w"> </span><span class="n">samples</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">127</span>
#<span class="w"> </span><span class="n">Min</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span>
#<span class="w"> </span><span class="n">Max</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">5</span>
#
#<span class="w"> </span><span class="n">Mean</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.5511811023622047</span>
#<span class="w"> </span><span class="n">Standard</span><span class="w"> </span><span class="n">deviation</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">1.5659198268780583</span>
#<span class="w"> </span><span class="n">Variance</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">2.452104904209808</span>
#
#<span class="w"> </span><span class="n">Each</span><span class="w"> </span><span class="err">∎</span><span class="w"> </span><span class="n">is</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="n">count</span><span class="w"> </span><span class="n">of</span><span class="w"> </span><span class="mi">2</span>
#
<span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="o">..</span><span class="w">  </span><span class="mi">1</span><span class="w"> </span><span class="p">[</span><span class="w"> </span><span class="mi">113</span><span class="w"> </span><span class="p">]</span>: <span class="err">∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎</span>
<span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="o">..</span><span class="w">  </span><span class="mi">2</span><span class="w"> </span><span class="p">[</span><span class="w">   </span><span class="mi">0</span><span class="w"> </span><span class="p">]</span>:
 <span class="mi">2</span><span class="w"> </span><span class="o">..</span><span class="w">  </span><span class="mi">3</span><span class="w"> </span><span class="p">[</span><span class="w">   </span><span class="mi">0</span><span class="w"> </span><span class="p">]</span>:
 <span class="mi">3</span><span class="w"> </span><span class="o">..</span><span class="w">  </span><span class="mi">4</span><span class="w"> </span><span class="p">[</span><span class="w">   </span><span class="mi">0</span><span class="w"> </span><span class="p">]</span>:
 <span class="mi">4</span><span class="w"> </span><span class="o">..</span><span class="w">  </span><span class="mi">5</span><span class="w"> </span><span class="p">[</span><span class="w">   </span><span class="mi">0</span><span class="w"> </span><span class="p">]</span>:
 <span class="mi">5</span><span class="w"> </span><span class="o">..</span><span class="w">  </span><span class="mi">6</span><span class="w"> </span><span class="p">[</span><span class="w">  </span><span class="mi">14</span><span class="w"> </span><span class="p">]</span>: <span class="err">∎∎∎∎∎∎∎</span>
<span class="w"> </span><span class="mi">6</span><span class="w"> </span><span class="o">..</span><span class="w">  </span><span class="mi">7</span><span class="w"> </span><span class="p">[</span><span class="w">   </span><span class="mi">0</span><span class="w"> </span><span class="p">]</span>:
 <span class="mi">7</span><span class="w"> </span><span class="o">..</span><span class="w">  </span><span class="mi">8</span><span class="w"> </span><span class="p">[</span><span class="w">   </span><span class="mi">0</span><span class="w"> </span><span class="p">]</span>:
 <span class="mi">8</span><span class="w"> </span><span class="o">..</span><span class="w">  </span><span class="mi">9</span><span class="w"> </span><span class="p">[</span><span class="w">   </span><span class="mi">0</span><span class="w"> </span><span class="p">]</span>:
 <span class="mi">9</span><span class="w"> </span><span class="o">..</span><span class="w"> </span><span class="mi">10</span><span class="w"> </span><span class="p">[</span><span class="w">   </span><span class="mi">0</span><span class="w"> </span><span class="p">]</span>:
</code></pre></div>
<p>&lt;/details&gt;</p>
<p>I think we just need to support callee-save registers in the <code>tail</code> calling convention. For simplicity, we can probably just match sys-v / the default native calling convention. A little unfortunate, as it means that chains of tail calls will be saving and restoring callee-save registers that the next function isn't going to use (won't be used again till the chain completes) but we definitely can't pessimize regular calls for the sake of tail call chains.</p>
</blockquote>



<a name="377393308"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%236759%20Cranelift%3A%20Get%20the%20%60tail%60%20calling%20.../near/377393308" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.236759.20Cranelift.3A.20Get.20the.20.60tail.60.20calling.20.2E.2E.2E.html#377393308">(Jul 21 2023 at 18:28)</a>:</h4>
<p><a href="https://github.com/fitzgen">fitzgen</a> added the <a href="https://api.github.com/repos/bytecodealliance/wasmtime/labels/cranelift">cranelift</a> label to <a href="https://github.com/bytecodealliance/wasmtime/issues/6759">Issue #6759</a>.</p>



<a name="377393309"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%236759%20Cranelift%3A%20Get%20the%20%60tail%60%20calling%20.../near/377393309" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.236759.20Cranelift.3A.20Get.20the.20.60tail.60.20calling.20.2E.2E.2E.html#377393309">(Jul 21 2023 at 18:28)</a>:</h4>
<p><a href="https://github.com/fitzgen">fitzgen</a> added the <a href="https://api.github.com/repos/bytecodealliance/wasmtime/labels/cranelift:goal:optimize-speed">cranelift:goal:optimize-speed</a> label to <a href="https://github.com/bytecodealliance/wasmtime/issues/6759">Issue #6759</a>.</p>



<a name="377397803"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%236759%20Cranelift%3A%20Get%20the%20%60tail%60%20calling%20.../near/377397803" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.236759.20Cranelift.3A.20Get.20the.20.60tail.60.20calling.20.2E.2E.2E.html#377397803">(Jul 21 2023 at 18:45)</a>:</h4>
<p>fitzgen edited <a href="https://github.com/bytecodealliance/wasmtime/issues/6759">issue #6759</a>:</p>
<blockquote>
<p>That is, regular calls with the <code>tail</code> calling convention should be as fast as regular calls with the <code>fast</code> calling convention.</p>
<p><a href="https://github.com/bytecodealliance/wasmtime/issues/1065#issuecomment-1624395771">https://github.com/bytecodealliance/wasmtime/issues/1065#issuecomment-1624395771</a></p>
<blockquote>
<p>So @jameysharp and I did a little profiling/investigation of switching the internal Wasm calling convention over to tail on our sightglass benchmarks. I was really expecting this to have no measurable change, but unfortunately it looks like it has a ~7% overhead on bz2 and spidermonkey.wasm and ~1% overhead on pulldown-cmark. This is surprising! We think this means that we ~frequently call functions that don't have enough register pressure to clobber all callee-save registers, and since tail only has caller-save registers and zero callee-save registers, we are doing more spills than we used to. Enough more that it is really measurable.</p>
</blockquote>
<p>Here are the histograms of number of clobbered callee-save registers in a function for some of our benchmarks:</p>
<p>&lt;details&gt;</p>
<h3>pulldown-cmark</h3>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code>#<span class="w"> </span><span class="n">Number</span><span class="w"> </span><span class="n">of</span><span class="w"> </span><span class="n">samples</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">757</span>
#<span class="w"> </span><span class="n">Min</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span>
#<span class="w"> </span><span class="n">Max</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">5</span>
#
#<span class="w"> </span><span class="n">Mean</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">1.9682959048877162</span>
#<span class="w"> </span><span class="n">Standard</span><span class="w"> </span><span class="n">deviation</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">2.4428038716280174</span>
#<span class="w"> </span><span class="n">Variance</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">5.967290755240832</span>
#
#<span class="w"> </span><span class="n">Each</span><span class="w"> </span><span class="err">∎</span><span class="w"> </span><span class="n">is</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="n">count</span><span class="w"> </span><span class="n">of</span><span class="w"> </span><span class="mi">9</span>
#
<span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="o">..</span><span class="w">  </span><span class="mi">1</span><span class="w"> </span><span class="p">[</span><span class="w"> </span><span class="mi">459</span><span class="w"> </span><span class="p">]</span>: <span class="err">∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎</span>
<span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="o">..</span><span class="w">  </span><span class="mi">2</span><span class="w"> </span><span class="p">[</span><span class="w">   </span><span class="mi">0</span><span class="w"> </span><span class="p">]</span>:
 <span class="mi">2</span><span class="w"> </span><span class="o">..</span><span class="w">  </span><span class="mi">3</span><span class="w"> </span><span class="p">[</span><span class="w">   </span><span class="mi">0</span><span class="w"> </span><span class="p">]</span>:
 <span class="mi">3</span><span class="w"> </span><span class="o">..</span><span class="w">  </span><span class="mi">4</span><span class="w"> </span><span class="p">[</span><span class="w">   </span><span class="mi">0</span><span class="w"> </span><span class="p">]</span>:
 <span class="mi">4</span><span class="w"> </span><span class="o">..</span><span class="w">  </span><span class="mi">5</span><span class="w"> </span><span class="p">[</span><span class="w">   </span><span class="mi">0</span><span class="w"> </span><span class="p">]</span>:
 <span class="mi">5</span><span class="w"> </span><span class="o">..</span><span class="w">  </span><span class="mi">6</span><span class="w"> </span><span class="p">[</span><span class="w"> </span><span class="mi">298</span><span class="w"> </span><span class="p">]</span>: <span class="err">∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎</span>
<span class="w"> </span><span class="mi">6</span><span class="w"> </span><span class="o">..</span><span class="w">  </span><span class="mi">7</span><span class="w"> </span><span class="p">[</span><span class="w">   </span><span class="mi">0</span><span class="w"> </span><span class="p">]</span>:
 <span class="mi">7</span><span class="w"> </span><span class="o">..</span><span class="w">  </span><span class="mi">8</span><span class="w"> </span><span class="p">[</span><span class="w">   </span><span class="mi">0</span><span class="w"> </span><span class="p">]</span>:
 <span class="mi">8</span><span class="w"> </span><span class="o">..</span><span class="w">  </span><span class="mi">9</span><span class="w"> </span><span class="p">[</span><span class="w">   </span><span class="mi">0</span><span class="w"> </span><span class="p">]</span>:
 <span class="mi">9</span><span class="w"> </span><span class="o">..</span><span class="w"> </span><span class="mi">10</span><span class="w"> </span><span class="p">[</span><span class="w">   </span><span class="mi">0</span><span class="w"> </span><span class="p">]</span>:
</code></pre></div>
<h3>spidermonkey</h3>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code>#<span class="w"> </span><span class="n">Number</span><span class="w"> </span><span class="n">of</span><span class="w"> </span><span class="n">samples</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">18279</span>
#<span class="w"> </span><span class="n">Min</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span>
#<span class="w"> </span><span class="n">Max</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">5</span>
#
#<span class="w"> </span><span class="n">Mean</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">1.8119153126538674</span>
#<span class="w"> </span><span class="n">Standard</span><span class="w"> </span><span class="n">deviation</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">2.4034432514706436</span>
#<span class="w"> </span><span class="n">Variance</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">5.77653946303978</span>
#
#<span class="w"> </span><span class="n">Each</span><span class="w"> </span><span class="err">∎</span><span class="w"> </span><span class="n">is</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="n">count</span><span class="w"> </span><span class="n">of</span><span class="w"> </span><span class="mi">233</span>
#
<span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="o">..</span><span class="w">  </span><span class="mi">1</span><span class="w"> </span><span class="p">[</span><span class="w"> </span><span class="mi">11655</span><span class="w"> </span><span class="p">]</span>: <span class="err">∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎</span>
<span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="o">..</span><span class="w">  </span><span class="mi">2</span><span class="w"> </span><span class="p">[</span><span class="w">     </span><span class="mi">0</span><span class="w"> </span><span class="p">]</span>:
 <span class="mi">2</span><span class="w"> </span><span class="o">..</span><span class="w">  </span><span class="mi">3</span><span class="w"> </span><span class="p">[</span><span class="w">     </span><span class="mi">0</span><span class="w"> </span><span class="p">]</span>:
 <span class="mi">3</span><span class="w"> </span><span class="o">..</span><span class="w">  </span><span class="mi">4</span><span class="w"> </span><span class="p">[</span><span class="w">     </span><span class="mi">0</span><span class="w"> </span><span class="p">]</span>:
 <span class="mi">4</span><span class="w"> </span><span class="o">..</span><span class="w">  </span><span class="mi">5</span><span class="w"> </span><span class="p">[</span><span class="w">     </span><span class="mi">0</span><span class="w"> </span><span class="p">]</span>:
 <span class="mi">5</span><span class="w"> </span><span class="o">..</span><span class="w">  </span><span class="mi">6</span><span class="w"> </span><span class="p">[</span><span class="w">  </span><span class="mi">6624</span><span class="w"> </span><span class="p">]</span>: <span class="err">∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎</span>
<span class="w"> </span><span class="mi">6</span><span class="w"> </span><span class="o">..</span><span class="w">  </span><span class="mi">7</span><span class="w"> </span><span class="p">[</span><span class="w">     </span><span class="mi">0</span><span class="w"> </span><span class="p">]</span>:
 <span class="mi">7</span><span class="w"> </span><span class="o">..</span><span class="w">  </span><span class="mi">8</span><span class="w"> </span><span class="p">[</span><span class="w">     </span><span class="mi">0</span><span class="w"> </span><span class="p">]</span>:
 <span class="mi">8</span><span class="w"> </span><span class="o">..</span><span class="w">  </span><span class="mi">9</span><span class="w"> </span><span class="p">[</span><span class="w">     </span><span class="mi">0</span><span class="w"> </span><span class="p">]</span>:
 <span class="mi">9</span><span class="w"> </span><span class="o">..</span><span class="w"> </span><span class="mi">10</span><span class="w"> </span><span class="p">[</span><span class="w">     </span><span class="mi">0</span><span class="w"> </span><span class="p">]</span>:
</code></pre></div>
<h3>bz2</h3>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code>#<span class="w"> </span><span class="n">Number</span><span class="w"> </span><span class="n">of</span><span class="w"> </span><span class="n">samples</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">127</span>
#<span class="w"> </span><span class="n">Min</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span>
#<span class="w"> </span><span class="n">Max</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">5</span>
#
#<span class="w"> </span><span class="n">Mean</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.5511811023622047</span>
#<span class="w"> </span><span class="n">Standard</span><span class="w"> </span><span class="n">deviation</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">1.5659198268780583</span>
#<span class="w"> </span><span class="n">Variance</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">2.452104904209808</span>
#
#<span class="w"> </span><span class="n">Each</span><span class="w"> </span><span class="err">∎</span><span class="w"> </span><span class="n">is</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="n">count</span><span class="w"> </span><span class="n">of</span><span class="w"> </span><span class="mi">2</span>
#
<span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="o">..</span><span class="w">  </span><span class="mi">1</span><span class="w"> </span><span class="p">[</span><span class="w"> </span><span class="mi">113</span><span class="w"> </span><span class="p">]</span>: <span class="err">∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎</span>
<span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="o">..</span><span class="w">  </span><span class="mi">2</span><span class="w"> </span><span class="p">[</span><span class="w">   </span><span class="mi">0</span><span class="w"> </span><span class="p">]</span>:
 <span class="mi">2</span><span class="w"> </span><span class="o">..</span><span class="w">  </span><span class="mi">3</span><span class="w"> </span><span class="p">[</span><span class="w">   </span><span class="mi">0</span><span class="w"> </span><span class="p">]</span>:
 <span class="mi">3</span><span class="w"> </span><span class="o">..</span><span class="w">  </span><span class="mi">4</span><span class="w"> </span><span class="p">[</span><span class="w">   </span><span class="mi">0</span><span class="w"> </span><span class="p">]</span>:
 <span class="mi">4</span><span class="w"> </span><span class="o">..</span><span class="w">  </span><span class="mi">5</span><span class="w"> </span><span class="p">[</span><span class="w">   </span><span class="mi">0</span><span class="w"> </span><span class="p">]</span>:
 <span class="mi">5</span><span class="w"> </span><span class="o">..</span><span class="w">  </span><span class="mi">6</span><span class="w"> </span><span class="p">[</span><span class="w">  </span><span class="mi">14</span><span class="w"> </span><span class="p">]</span>: <span class="err">∎∎∎∎∎∎∎</span>
<span class="w"> </span><span class="mi">6</span><span class="w"> </span><span class="o">..</span><span class="w">  </span><span class="mi">7</span><span class="w"> </span><span class="p">[</span><span class="w">   </span><span class="mi">0</span><span class="w"> </span><span class="p">]</span>:
 <span class="mi">7</span><span class="w"> </span><span class="o">..</span><span class="w">  </span><span class="mi">8</span><span class="w"> </span><span class="p">[</span><span class="w">   </span><span class="mi">0</span><span class="w"> </span><span class="p">]</span>:
 <span class="mi">8</span><span class="w"> </span><span class="o">..</span><span class="w">  </span><span class="mi">9</span><span class="w"> </span><span class="p">[</span><span class="w">   </span><span class="mi">0</span><span class="w"> </span><span class="p">]</span>:
 <span class="mi">9</span><span class="w"> </span><span class="o">..</span><span class="w"> </span><span class="mi">10</span><span class="w"> </span><span class="p">[</span><span class="w">   </span><span class="mi">0</span><span class="w"> </span><span class="p">]</span>:
</code></pre></div>
<p>&lt;/details&gt;</p>
<p>I think we just need to support callee-save registers in the <code>tail</code> calling convention. For simplicity, we can probably just match sys-v / the default native calling convention. A little unfortunate, as it means that chains of tail calls will be saving and restoring callee-save registers that the next function isn't going to use (won't be used again till the chain completes) but we definitely can't pessimize regular calls for the sake of tail call chains.<br>
```[tasklist]</p>
<h3>Tasks</h3>
<p><div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="o">~~~</span>
</code></pre></div><br>
</p>
</blockquote>



<a name="377397839"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%236759%20Cranelift%3A%20Get%20the%20%60tail%60%20calling%20.../near/377397839" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.236759.20Cranelift.3A.20Get.20the.20.60tail.60.20calling.20.2E.2E.2E.html#377397839">(Jul 21 2023 at 18:46)</a>:</h4>
<p>fitzgen edited <a href="https://github.com/bytecodealliance/wasmtime/issues/6759">issue #6759</a>:</p>
<blockquote>
<p>That is, regular calls with the <code>tail</code> calling convention should be as fast as regular calls with the <code>fast</code> calling convention.</p>
<p><a href="https://github.com/bytecodealliance/wasmtime/issues/1065#issuecomment-1624395771">https://github.com/bytecodealliance/wasmtime/issues/1065#issuecomment-1624395771</a></p>
<blockquote>
<p>So @jameysharp and I did a little profiling/investigation of switching the internal Wasm calling convention over to tail on our sightglass benchmarks. I was really expecting this to have no measurable change, but unfortunately it looks like it has a ~7% overhead on bz2 and spidermonkey.wasm and ~1% overhead on pulldown-cmark. This is surprising! We think this means that we ~frequently call functions that don't have enough register pressure to clobber all callee-save registers, and since tail only has caller-save registers and zero callee-save registers, we are doing more spills than we used to. Enough more that it is really measurable.</p>
</blockquote>
<p>Here are the histograms of number of clobbered callee-save registers in a function for some of our benchmarks:</p>
<p>&lt;details&gt;</p>
<h3>pulldown-cmark</h3>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code>#<span class="w"> </span><span class="n">Number</span><span class="w"> </span><span class="n">of</span><span class="w"> </span><span class="n">samples</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">757</span>
#<span class="w"> </span><span class="n">Min</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span>
#<span class="w"> </span><span class="n">Max</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">5</span>
#
#<span class="w"> </span><span class="n">Mean</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">1.9682959048877162</span>
#<span class="w"> </span><span class="n">Standard</span><span class="w"> </span><span class="n">deviation</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">2.4428038716280174</span>
#<span class="w"> </span><span class="n">Variance</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">5.967290755240832</span>
#
#<span class="w"> </span><span class="n">Each</span><span class="w"> </span><span class="err">∎</span><span class="w"> </span><span class="n">is</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="n">count</span><span class="w"> </span><span class="n">of</span><span class="w"> </span><span class="mi">9</span>
#
<span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="o">..</span><span class="w">  </span><span class="mi">1</span><span class="w"> </span><span class="p">[</span><span class="w"> </span><span class="mi">459</span><span class="w"> </span><span class="p">]</span>: <span class="err">∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎</span>
<span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="o">..</span><span class="w">  </span><span class="mi">2</span><span class="w"> </span><span class="p">[</span><span class="w">   </span><span class="mi">0</span><span class="w"> </span><span class="p">]</span>:
 <span class="mi">2</span><span class="w"> </span><span class="o">..</span><span class="w">  </span><span class="mi">3</span><span class="w"> </span><span class="p">[</span><span class="w">   </span><span class="mi">0</span><span class="w"> </span><span class="p">]</span>:
 <span class="mi">3</span><span class="w"> </span><span class="o">..</span><span class="w">  </span><span class="mi">4</span><span class="w"> </span><span class="p">[</span><span class="w">   </span><span class="mi">0</span><span class="w"> </span><span class="p">]</span>:
 <span class="mi">4</span><span class="w"> </span><span class="o">..</span><span class="w">  </span><span class="mi">5</span><span class="w"> </span><span class="p">[</span><span class="w">   </span><span class="mi">0</span><span class="w"> </span><span class="p">]</span>:
 <span class="mi">5</span><span class="w"> </span><span class="o">..</span><span class="w">  </span><span class="mi">6</span><span class="w"> </span><span class="p">[</span><span class="w"> </span><span class="mi">298</span><span class="w"> </span><span class="p">]</span>: <span class="err">∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎</span>
<span class="w"> </span><span class="mi">6</span><span class="w"> </span><span class="o">..</span><span class="w">  </span><span class="mi">7</span><span class="w"> </span><span class="p">[</span><span class="w">   </span><span class="mi">0</span><span class="w"> </span><span class="p">]</span>:
 <span class="mi">7</span><span class="w"> </span><span class="o">..</span><span class="w">  </span><span class="mi">8</span><span class="w"> </span><span class="p">[</span><span class="w">   </span><span class="mi">0</span><span class="w"> </span><span class="p">]</span>:
 <span class="mi">8</span><span class="w"> </span><span class="o">..</span><span class="w">  </span><span class="mi">9</span><span class="w"> </span><span class="p">[</span><span class="w">   </span><span class="mi">0</span><span class="w"> </span><span class="p">]</span>:
 <span class="mi">9</span><span class="w"> </span><span class="o">..</span><span class="w"> </span><span class="mi">10</span><span class="w"> </span><span class="p">[</span><span class="w">   </span><span class="mi">0</span><span class="w"> </span><span class="p">]</span>:
</code></pre></div>
<h3>spidermonkey</h3>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code>#<span class="w"> </span><span class="n">Number</span><span class="w"> </span><span class="n">of</span><span class="w"> </span><span class="n">samples</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">18279</span>
#<span class="w"> </span><span class="n">Min</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span>
#<span class="w"> </span><span class="n">Max</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">5</span>
#
#<span class="w"> </span><span class="n">Mean</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">1.8119153126538674</span>
#<span class="w"> </span><span class="n">Standard</span><span class="w"> </span><span class="n">deviation</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">2.4034432514706436</span>
#<span class="w"> </span><span class="n">Variance</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">5.77653946303978</span>
#
#<span class="w"> </span><span class="n">Each</span><span class="w"> </span><span class="err">∎</span><span class="w"> </span><span class="n">is</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="n">count</span><span class="w"> </span><span class="n">of</span><span class="w"> </span><span class="mi">233</span>
#
<span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="o">..</span><span class="w">  </span><span class="mi">1</span><span class="w"> </span><span class="p">[</span><span class="w"> </span><span class="mi">11655</span><span class="w"> </span><span class="p">]</span>: <span class="err">∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎</span>
<span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="o">..</span><span class="w">  </span><span class="mi">2</span><span class="w"> </span><span class="p">[</span><span class="w">     </span><span class="mi">0</span><span class="w"> </span><span class="p">]</span>:
 <span class="mi">2</span><span class="w"> </span><span class="o">..</span><span class="w">  </span><span class="mi">3</span><span class="w"> </span><span class="p">[</span><span class="w">     </span><span class="mi">0</span><span class="w"> </span><span class="p">]</span>:
 <span class="mi">3</span><span class="w"> </span><span class="o">..</span><span class="w">  </span><span class="mi">4</span><span class="w"> </span><span class="p">[</span><span class="w">     </span><span class="mi">0</span><span class="w"> </span><span class="p">]</span>:
 <span class="mi">4</span><span class="w"> </span><span class="o">..</span><span class="w">  </span><span class="mi">5</span><span class="w"> </span><span class="p">[</span><span class="w">     </span><span class="mi">0</span><span class="w"> </span><span class="p">]</span>:
 <span class="mi">5</span><span class="w"> </span><span class="o">..</span><span class="w">  </span><span class="mi">6</span><span class="w"> </span><span class="p">[</span><span class="w">  </span><span class="mi">6624</span><span class="w"> </span><span class="p">]</span>: <span class="err">∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎</span>
<span class="w"> </span><span class="mi">6</span><span class="w"> </span><span class="o">..</span><span class="w">  </span><span class="mi">7</span><span class="w"> </span><span class="p">[</span><span class="w">     </span><span class="mi">0</span><span class="w"> </span><span class="p">]</span>:
 <span class="mi">7</span><span class="w"> </span><span class="o">..</span><span class="w">  </span><span class="mi">8</span><span class="w"> </span><span class="p">[</span><span class="w">     </span><span class="mi">0</span><span class="w"> </span><span class="p">]</span>:
 <span class="mi">8</span><span class="w"> </span><span class="o">..</span><span class="w">  </span><span class="mi">9</span><span class="w"> </span><span class="p">[</span><span class="w">     </span><span class="mi">0</span><span class="w"> </span><span class="p">]</span>:
 <span class="mi">9</span><span class="w"> </span><span class="o">..</span><span class="w"> </span><span class="mi">10</span><span class="w"> </span><span class="p">[</span><span class="w">     </span><span class="mi">0</span><span class="w"> </span><span class="p">]</span>:
</code></pre></div>
<h3>bz2</h3>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code>#<span class="w"> </span><span class="n">Number</span><span class="w"> </span><span class="n">of</span><span class="w"> </span><span class="n">samples</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">127</span>
#<span class="w"> </span><span class="n">Min</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span>
#<span class="w"> </span><span class="n">Max</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">5</span>
#
#<span class="w"> </span><span class="n">Mean</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.5511811023622047</span>
#<span class="w"> </span><span class="n">Standard</span><span class="w"> </span><span class="n">deviation</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">1.5659198268780583</span>
#<span class="w"> </span><span class="n">Variance</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">2.452104904209808</span>
#
#<span class="w"> </span><span class="n">Each</span><span class="w"> </span><span class="err">∎</span><span class="w"> </span><span class="n">is</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="n">count</span><span class="w"> </span><span class="n">of</span><span class="w"> </span><span class="mi">2</span>
#
<span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="o">..</span><span class="w">  </span><span class="mi">1</span><span class="w"> </span><span class="p">[</span><span class="w"> </span><span class="mi">113</span><span class="w"> </span><span class="p">]</span>: <span class="err">∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎</span>
<span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="o">..</span><span class="w">  </span><span class="mi">2</span><span class="w"> </span><span class="p">[</span><span class="w">   </span><span class="mi">0</span><span class="w"> </span><span class="p">]</span>:
 <span class="mi">2</span><span class="w"> </span><span class="o">..</span><span class="w">  </span><span class="mi">3</span><span class="w"> </span><span class="p">[</span><span class="w">   </span><span class="mi">0</span><span class="w"> </span><span class="p">]</span>:
 <span class="mi">3</span><span class="w"> </span><span class="o">..</span><span class="w">  </span><span class="mi">4</span><span class="w"> </span><span class="p">[</span><span class="w">   </span><span class="mi">0</span><span class="w"> </span><span class="p">]</span>:
 <span class="mi">4</span><span class="w"> </span><span class="o">..</span><span class="w">  </span><span class="mi">5</span><span class="w"> </span><span class="p">[</span><span class="w">   </span><span class="mi">0</span><span class="w"> </span><span class="p">]</span>:
 <span class="mi">5</span><span class="w"> </span><span class="o">..</span><span class="w">  </span><span class="mi">6</span><span class="w"> </span><span class="p">[</span><span class="w">  </span><span class="mi">14</span><span class="w"> </span><span class="p">]</span>: <span class="err">∎∎∎∎∎∎∎</span>
<span class="w"> </span><span class="mi">6</span><span class="w"> </span><span class="o">..</span><span class="w">  </span><span class="mi">7</span><span class="w"> </span><span class="p">[</span><span class="w">   </span><span class="mi">0</span><span class="w"> </span><span class="p">]</span>:
 <span class="mi">7</span><span class="w"> </span><span class="o">..</span><span class="w">  </span><span class="mi">8</span><span class="w"> </span><span class="p">[</span><span class="w">   </span><span class="mi">0</span><span class="w"> </span><span class="p">]</span>:
 <span class="mi">8</span><span class="w"> </span><span class="o">..</span><span class="w">  </span><span class="mi">9</span><span class="w"> </span><span class="p">[</span><span class="w">   </span><span class="mi">0</span><span class="w"> </span><span class="p">]</span>:
 <span class="mi">9</span><span class="w"> </span><span class="o">..</span><span class="w"> </span><span class="mi">10</span><span class="w"> </span><span class="p">[</span><span class="w">   </span><span class="mi">0</span><span class="w"> </span><span class="p">]</span>:
</code></pre></div>
<p>&lt;/details&gt;</p>
<p>I think we just need to support callee-save registers in the <code>tail</code> calling convention. For simplicity, we can probably just match sys-v / the default native calling convention. A little unfortunate, as it means that chains of tail calls will be saving and restoring callee-save registers that the next function isn't going to use (won't be used again till the chain completes) but we definitely can't pessimize regular calls for the sake of tail call chains.</p>
</blockquote>



<a name="437914046"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%236759%20Cranelift%3A%20Get%20the%20%60tail%60%20calling%20.../near/437914046" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.236759.20Cranelift.3A.20Get.20the.20.60tail.60.20calling.20.2E.2E.2E.html#437914046">(May 10 2024 at 02:15)</a>:</h4>
<p>alexcrichton closed <a href="https://github.com/bytecodealliance/wasmtime/issues/6759">issue #6759</a>:</p>
<blockquote>
<p>That is, regular calls with the <code>tail</code> calling convention should be as fast as regular calls with the <code>fast</code> calling convention.</p>
<p><a href="https://github.com/bytecodealliance/wasmtime/issues/1065#issuecomment-1624395771">https://github.com/bytecodealliance/wasmtime/issues/1065#issuecomment-1624395771</a></p>
<blockquote>
<p>So @jameysharp and I did a little profiling/investigation of switching the internal Wasm calling convention over to tail on our sightglass benchmarks. I was really expecting this to have no measurable change, but unfortunately it looks like it has a ~7% overhead on bz2 and spidermonkey.wasm and ~1% overhead on pulldown-cmark. This is surprising! We think this means that we ~frequently call functions that don't have enough register pressure to clobber all callee-save registers, and since tail only has caller-save registers and zero callee-save registers, we are doing more spills than we used to. Enough more that it is really measurable.</p>
</blockquote>
<p>Here are the histograms of number of clobbered callee-save registers in a function for some of our benchmarks:</p>
<p>&lt;details&gt;</p>
<h3>pulldown-cmark</h3>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code>#<span class="w"> </span><span class="n">Number</span><span class="w"> </span><span class="n">of</span><span class="w"> </span><span class="n">samples</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">757</span>
#<span class="w"> </span><span class="n">Min</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span>
#<span class="w"> </span><span class="n">Max</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">5</span>
#
#<span class="w"> </span><span class="n">Mean</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">1.9682959048877162</span>
#<span class="w"> </span><span class="n">Standard</span><span class="w"> </span><span class="n">deviation</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">2.4428038716280174</span>
#<span class="w"> </span><span class="n">Variance</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">5.967290755240832</span>
#
#<span class="w"> </span><span class="n">Each</span><span class="w"> </span><span class="err">∎</span><span class="w"> </span><span class="n">is</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="n">count</span><span class="w"> </span><span class="n">of</span><span class="w"> </span><span class="mi">9</span>
#
<span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="o">..</span><span class="w">  </span><span class="mi">1</span><span class="w"> </span><span class="p">[</span><span class="w"> </span><span class="mi">459</span><span class="w"> </span><span class="p">]</span>: <span class="err">∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎</span>
<span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="o">..</span><span class="w">  </span><span class="mi">2</span><span class="w"> </span><span class="p">[</span><span class="w">   </span><span class="mi">0</span><span class="w"> </span><span class="p">]</span>:
 <span class="mi">2</span><span class="w"> </span><span class="o">..</span><span class="w">  </span><span class="mi">3</span><span class="w"> </span><span class="p">[</span><span class="w">   </span><span class="mi">0</span><span class="w"> </span><span class="p">]</span>:
 <span class="mi">3</span><span class="w"> </span><span class="o">..</span><span class="w">  </span><span class="mi">4</span><span class="w"> </span><span class="p">[</span><span class="w">   </span><span class="mi">0</span><span class="w"> </span><span class="p">]</span>:
 <span class="mi">4</span><span class="w"> </span><span class="o">..</span><span class="w">  </span><span class="mi">5</span><span class="w"> </span><span class="p">[</span><span class="w">   </span><span class="mi">0</span><span class="w"> </span><span class="p">]</span>:
 <span class="mi">5</span><span class="w"> </span><span class="o">..</span><span class="w">  </span><span class="mi">6</span><span class="w"> </span><span class="p">[</span><span class="w"> </span><span class="mi">298</span><span class="w"> </span><span class="p">]</span>: <span class="err">∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎</span>
<span class="w"> </span><span class="mi">6</span><span class="w"> </span><span class="o">..</span><span class="w">  </span><span class="mi">7</span><span class="w"> </span><span class="p">[</span><span class="w">   </span><span class="mi">0</span><span class="w"> </span><span class="p">]</span>:
 <span class="mi">7</span><span class="w"> </span><span class="o">..</span><span class="w">  </span><span class="mi">8</span><span class="w"> </span><span class="p">[</span><span class="w">   </span><span class="mi">0</span><span class="w"> </span><span class="p">]</span>:
 <span class="mi">8</span><span class="w"> </span><span class="o">..</span><span class="w">  </span><span class="mi">9</span><span class="w"> </span><span class="p">[</span><span class="w">   </span><span class="mi">0</span><span class="w"> </span><span class="p">]</span>:
 <span class="mi">9</span><span class="w"> </span><span class="o">..</span><span class="w"> </span><span class="mi">10</span><span class="w"> </span><span class="p">[</span><span class="w">   </span><span class="mi">0</span><span class="w"> </span><span class="p">]</span>:
</code></pre></div>
<h3>spidermonkey</h3>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code>#<span class="w"> </span><span class="n">Number</span><span class="w"> </span><span class="n">of</span><span class="w"> </span><span class="n">samples</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">18279</span>
#<span class="w"> </span><span class="n">Min</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span>
#<span class="w"> </span><span class="n">Max</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">5</span>
#
#<span class="w"> </span><span class="n">Mean</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">1.8119153126538674</span>
#<span class="w"> </span><span class="n">Standard</span><span class="w"> </span><span class="n">deviation</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">2.4034432514706436</span>
#<span class="w"> </span><span class="n">Variance</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">5.77653946303978</span>
#
#<span class="w"> </span><span class="n">Each</span><span class="w"> </span><span class="err">∎</span><span class="w"> </span><span class="n">is</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="n">count</span><span class="w"> </span><span class="n">of</span><span class="w"> </span><span class="mi">233</span>
#
<span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="o">..</span><span class="w">  </span><span class="mi">1</span><span class="w"> </span><span class="p">[</span><span class="w"> </span><span class="mi">11655</span><span class="w"> </span><span class="p">]</span>: <span class="err">∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎</span>
<span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="o">..</span><span class="w">  </span><span class="mi">2</span><span class="w"> </span><span class="p">[</span><span class="w">     </span><span class="mi">0</span><span class="w"> </span><span class="p">]</span>:
 <span class="mi">2</span><span class="w"> </span><span class="o">..</span><span class="w">  </span><span class="mi">3</span><span class="w"> </span><span class="p">[</span><span class="w">     </span><span class="mi">0</span><span class="w"> </span><span class="p">]</span>:
 <span class="mi">3</span><span class="w"> </span><span class="o">..</span><span class="w">  </span><span class="mi">4</span><span class="w"> </span><span class="p">[</span><span class="w">     </span><span class="mi">0</span><span class="w"> </span><span class="p">]</span>:
 <span class="mi">4</span><span class="w"> </span><span class="o">..</span><span class="w">  </span><span class="mi">5</span><span class="w"> </span><span class="p">[</span><span class="w">     </span><span class="mi">0</span><span class="w"> </span><span class="p">]</span>:
 <span class="mi">5</span><span class="w"> </span><span class="o">..</span><span class="w">  </span><span class="mi">6</span><span class="w"> </span><span class="p">[</span><span class="w">  </span><span class="mi">6624</span><span class="w"> </span><span class="p">]</span>: <span class="err">∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎</span>
<span class="w"> </span><span class="mi">6</span><span class="w"> </span><span class="o">..</span><span class="w">  </span><span class="mi">7</span><span class="w"> </span><span class="p">[</span><span class="w">     </span><span class="mi">0</span><span class="w"> </span><span class="p">]</span>:
 <span class="mi">7</span><span class="w"> </span><span class="o">..</span><span class="w">  </span><span class="mi">8</span><span class="w"> </span><span class="p">[</span><span class="w">     </span><span class="mi">0</span><span class="w"> </span><span class="p">]</span>:
 <span class="mi">8</span><span class="w"> </span><span class="o">..</span><span class="w">  </span><span class="mi">9</span><span class="w"> </span><span class="p">[</span><span class="w">     </span><span class="mi">0</span><span class="w"> </span><span class="p">]</span>:
 <span class="mi">9</span><span class="w"> </span><span class="o">..</span><span class="w"> </span><span class="mi">10</span><span class="w"> </span><span class="p">[</span><span class="w">     </span><span class="mi">0</span><span class="w"> </span><span class="p">]</span>:
</code></pre></div>
<h3>bz2</h3>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code>#<span class="w"> </span><span class="n">Number</span><span class="w"> </span><span class="n">of</span><span class="w"> </span><span class="n">samples</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">127</span>
#<span class="w"> </span><span class="n">Min</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span>
#<span class="w"> </span><span class="n">Max</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">5</span>
#
#<span class="w"> </span><span class="n">Mean</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.5511811023622047</span>
#<span class="w"> </span><span class="n">Standard</span><span class="w"> </span><span class="n">deviation</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">1.5659198268780583</span>
#<span class="w"> </span><span class="n">Variance</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">2.452104904209808</span>
#
#<span class="w"> </span><span class="n">Each</span><span class="w"> </span><span class="err">∎</span><span class="w"> </span><span class="n">is</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="n">count</span><span class="w"> </span><span class="n">of</span><span class="w"> </span><span class="mi">2</span>
#
<span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="o">..</span><span class="w">  </span><span class="mi">1</span><span class="w"> </span><span class="p">[</span><span class="w"> </span><span class="mi">113</span><span class="w"> </span><span class="p">]</span>: <span class="err">∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎</span>
<span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="o">..</span><span class="w">  </span><span class="mi">2</span><span class="w"> </span><span class="p">[</span><span class="w">   </span><span class="mi">0</span><span class="w"> </span><span class="p">]</span>:
 <span class="mi">2</span><span class="w"> </span><span class="o">..</span><span class="w">  </span><span class="mi">3</span><span class="w"> </span><span class="p">[</span><span class="w">   </span><span class="mi">0</span><span class="w"> </span><span class="p">]</span>:
 <span class="mi">3</span><span class="w"> </span><span class="o">..</span><span class="w">  </span><span class="mi">4</span><span class="w"> </span><span class="p">[</span><span class="w">   </span><span class="mi">0</span><span class="w"> </span><span class="p">]</span>:
 <span class="mi">4</span><span class="w"> </span><span class="o">..</span><span class="w">  </span><span class="mi">5</span><span class="w"> </span><span class="p">[</span><span class="w">   </span><span class="mi">0</span><span class="w"> </span><span class="p">]</span>:
 <span class="mi">5</span><span class="w"> </span><span class="o">..</span><span class="w">  </span><span class="mi">6</span><span class="w"> </span><span class="p">[</span><span class="w">  </span><span class="mi">14</span><span class="w"> </span><span class="p">]</span>: <span class="err">∎∎∎∎∎∎∎</span>
<span class="w"> </span><span class="mi">6</span><span class="w"> </span><span class="o">..</span><span class="w">  </span><span class="mi">7</span><span class="w"> </span><span class="p">[</span><span class="w">   </span><span class="mi">0</span><span class="w"> </span><span class="p">]</span>:
 <span class="mi">7</span><span class="w"> </span><span class="o">..</span><span class="w">  </span><span class="mi">8</span><span class="w"> </span><span class="p">[</span><span class="w">   </span><span class="mi">0</span><span class="w"> </span><span class="p">]</span>:
 <span class="mi">8</span><span class="w"> </span><span class="o">..</span><span class="w">  </span><span class="mi">9</span><span class="w"> </span><span class="p">[</span><span class="w">   </span><span class="mi">0</span><span class="w"> </span><span class="p">]</span>:
 <span class="mi">9</span><span class="w"> </span><span class="o">..</span><span class="w"> </span><span class="mi">10</span><span class="w"> </span><span class="p">[</span><span class="w">   </span><span class="mi">0</span><span class="w"> </span><span class="p">]</span>:
</code></pre></div>
<p>&lt;/details&gt;</p>
<p>I think we just need to support callee-save registers in the <code>tail</code> calling convention. For simplicity, we can probably just match sys-v / the default native calling convention. A little unfortunate, as it means that chains of tail calls will be saving and restoring callee-save registers that the next function isn't going to use (won't be used again till the chain completes) but we definitely can't pessimize regular calls for the sake of tail call chains.</p>
</blockquote>



<a name="437914047"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%236759%20Cranelift%3A%20Get%20the%20%60tail%60%20calling%20.../near/437914047" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.236759.20Cranelift.3A.20Get.20the.20.60tail.60.20calling.20.2E.2E.2E.html#437914047">(May 10 2024 at 02:15)</a>:</h4>
<p>alexcrichton <a href="https://github.com/bytecodealliance/wasmtime/issues/6759#issuecomment-2103726369">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/6759">issue #6759</a>:</p>
<blockquote>
<p>I believe that this is done now, so closing.</p>
</blockquote>



<hr><p>Last updated: Jan 20 2025 at 06:04 UTC</p>
</html>