<html>
<head><meta charset="utf-8"><title>wasmtime / issue #8216 Cranelift: riscv64 having memory s... · git-wasmtime · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/index.html">git-wasmtime</a></h2>
<h3>Topic: <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.238216.20Cranelift.3A.20riscv64.20having.20memory.20s.2E.2E.2E.html">wasmtime / issue #8216 Cranelift: riscv64 having memory s...</a></h3>

<hr>

<base href="https://bytecodealliance.zulipchat.com">

<head><link href="https://bytecodealliance.github.io/zulip-archive/style.css" rel="stylesheet"></head>

<a name="428273266"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%238216%20Cranelift%3A%20riscv64%20having%20memory%20s.../near/428273266" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.238216.20Cranelift.3A.20riscv64.20having.20memory.20s.2E.2E.2E.html#428273266">(Mar 22 2024 at 07:26)</a>:</h4>
<p><a href="https://github.com/candymate">candymate</a> added the bug label to <a href="https://github.com/bytecodealliance/wasmtime/issues/8216">Issue #8216</a>.</p>



<a name="428273267"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%238216%20Cranelift%3A%20riscv64%20having%20memory%20s.../near/428273267" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.238216.20Cranelift.3A.20riscv64.20having.20memory.20s.2E.2E.2E.html#428273267">(Mar 22 2024 at 07:26)</a>:</h4>
<p><a href="https://github.com/candymate">candymate</a> added the fuzz-bug label to <a href="https://github.com/bytecodealliance/wasmtime/issues/8216">Issue #8216</a>.</p>



<a name="428273269"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%238216%20Cranelift%3A%20riscv64%20having%20memory%20s.../near/428273269" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.238216.20Cranelift.3A.20riscv64.20having.20memory.20s.2E.2E.2E.html#428273269">(Mar 22 2024 at 07:26)</a>:</h4>
<p>candymate opened <a href="https://github.com/bytecodealliance/wasmtime/issues/8216">issue #8216</a>:</p>
<blockquote>
<h3>Test Case</h3>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="c1">// main.rs</span>
<span class="k">use</span><span class="w"> </span><span class="n">wasmtime</span>::<span class="o">*</span><span class="p">;</span>

<span class="k">fn</span> <span class="nf">main</span><span class="p">()</span><span class="w"> </span>-&gt; <span class="nb">Result</span><span class="o">&lt;</span><span class="p">()</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">config</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Config</span>::<span class="n">default</span><span class="p">();</span>
<span class="w">    </span><span class="n">config</span><span class="p">.</span><span class="n">strategy</span><span class="p">(</span><span class="n">Strategy</span>::<span class="n">Cranelift</span><span class="p">);</span>
<span class="w">    </span><span class="n">config</span><span class="p">.</span><span class="n">cranelift_opt_level</span><span class="p">(</span><span class="n">OptLevel</span>::<span class="nb">None</span><span class="p">);</span>

<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">engine</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Engine</span>::<span class="n">new</span><span class="p">(</span><span class="o">&amp;</span><span class="n">config</span><span class="p">)</span><span class="o">?</span><span class="p">;</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">wat</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">r#"</span>
<span class="s">    (module</span>
<span class="s">        (type (;0;) (func (param) (result)))</span>
<span class="s">        (import "mem" "mem" (memory (;0;) 1))</span>
<span class="s">        (func (;0;) (type 0) (param) (result)</span>
<span class="s">          i32.const 65521</span>
<span class="s">          v128.const i32x4 0xffffffff 0xffffffff 0xffffffff 0xffffffff</span>
<span class="s">          v128.store align=1)</span>
<span class="s">        (export "main" (func 0)))</span>
<span class="s">    "#</span><span class="p">;</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">module</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Module</span>::<span class="n">new</span><span class="p">(</span><span class="o">&amp;</span><span class="n">engine</span><span class="p">,</span><span class="w"> </span><span class="n">wat</span><span class="p">)</span><span class="o">?</span><span class="p">;</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">store</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Store</span>::<span class="n">new</span><span class="p">(</span><span class="o">&amp;</span><span class="n">engine</span><span class="p">,</span><span class="w"> </span><span class="p">());</span>

<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">memory_ty</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">MemoryType</span>::<span class="n">new</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="nb">None</span><span class="p">);</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">memory</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Memory</span>::<span class="n">new</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="n">store</span><span class="p">,</span><span class="w"> </span><span class="n">memory_ty</span><span class="p">.</span><span class="n">clone</span><span class="p">())</span><span class="o">?</span><span class="p">;</span>

<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">instance</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Instance</span>::<span class="n">new</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="n">store</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">module</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="p">[</span><span class="n">memory</span><span class="p">.</span><span class="n">into</span><span class="p">()])</span><span class="o">?</span><span class="p">;</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">main</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">instance</span><span class="p">.</span><span class="n">get_func</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="n">store</span><span class="p">,</span><span class="w"> </span><span class="s">"main"</span><span class="p">)</span>
<span class="w">        </span><span class="p">.</span><span class="n">expect</span><span class="p">(</span><span class="s">"`main` was not an exported function"</span><span class="p">);</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">params</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="fm">vec!</span><span class="p">[];</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">results</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="fm">vec!</span><span class="p">[];</span>
<span class="w">    </span><span class="fm">println!</span><span class="p">(</span><span class="s">"Opt level None: {:?}"</span><span class="p">,</span><span class="w"> </span><span class="n">main</span><span class="p">.</span><span class="n">call</span><span class="p">(</span>
<span class="w">        </span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="n">store</span><span class="p">,</span>
<span class="w">        </span><span class="o">&amp;</span><span class="n">params</span><span class="p">,</span>
<span class="w">        </span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="n">results</span>
<span class="w">    </span><span class="p">));</span>
<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="mi">65521</span><span class="o">..</span><span class="mi">65536</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="fm">print!</span><span class="p">(</span><span class="s">"{} "</span><span class="p">,</span><span class="w"> </span><span class="n">memory</span><span class="p">.</span><span class="n">data</span><span class="p">(</span><span class="o">&amp;</span><span class="n">store</span><span class="p">)[</span><span class="n">i</span><span class="p">]);</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="fm">println!</span><span class="p">(</span><span class="s">""</span><span class="p">);</span>

<span class="w">    </span><span class="nb">Ok</span><span class="p">(())</span>
<span class="p">}</span>
</code></pre></div>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="p">[</span><span class="n">package</span><span class="p">]</span>
<span class="n">name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">"wasmtime-wrapper"</span>
<span class="n">version</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">"0.1.0"</span>
<span class="n">edition</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">"2021"</span>

#<span class="w"> </span><span class="n">See</span><span class="w"> </span><span class="n">more</span><span class="w"> </span><span class="n">keys</span><span class="w"> </span><span class="n">and</span><span class="w"> </span><span class="n">their</span><span class="w"> </span><span class="n">definitions</span><span class="w"> </span><span class="n">at</span><span class="w"> </span><span class="n">https</span>:<span class="c1">//doc.rust-lang.org/cargo/reference/manifest.html</span>

<span class="p">[</span><span class="n">dependencies</span><span class="p">]</span>
#<span class="w"> </span><span class="n">wasmtime</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">"19.0.0"</span>
<span class="n">wasmtime</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">path</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">"../wasmtime/crates/wasmtime"</span><span class="w"> </span><span class="p">}</span><span class="w"> </span>#<span class="w"> </span><span class="n">commit</span>: <span class="mi">6</span><span class="n">c5184809db3a92de4ee0c718c403bedc9a9ff4f</span><span class="w"> </span><span class="p">(</span><span class="n">current</span><span class="w"> </span><span class="n">latest</span><span class="p">,</span><span class="w"> </span><span class="n">Date</span>:   <span class="nc">Thu</span><span class="w"> </span><span class="n">Mar</span><span class="w"> </span><span class="mi">21</span><span class="w"> </span><span class="mi">18</span>:<span class="mi">24</span>:<span class="mi">49</span><span class="w"> </span><span class="mi">2024</span><span class="w"> </span><span class="o">-</span><span class="mi">0700</span><span class="p">)</span>
</code></pre></div>
<h3>Steps to reproduce</h3>
<p>Compare the following executions:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="n">cargo</span><span class="w"> </span><span class="n">run</span><span class="w"> </span><span class="o">--</span><span class="n">release</span>
<span class="n">cargo</span><span class="w"> </span><span class="n">run</span><span class="w"> </span><span class="o">--</span><span class="n">release</span><span class="w"> </span><span class="o">--</span><span class="n">target</span><span class="o">=</span><span class="n">riscv64gc</span><span class="o">-</span><span class="n">unknown</span><span class="o">-</span><span class="n">linux</span><span class="o">-</span><span class="n">gnu</span>
</code></pre></div>
<p>QEMU run options (riscv64) I'm currently using is the following:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="n">qemu</span><span class="o">-</span><span class="n">riscv64</span><span class="w"> </span><span class="o">-</span><span class="n">cpu</span><span class="w"> </span><span class="n">rv64</span><span class="p">,</span><span class="n">v</span><span class="o">=</span><span class="kc">true</span><span class="p">,</span><span class="n">vlen</span><span class="o">=</span><span class="mi">128</span><span class="p">,</span><span class="n">vext_spec</span><span class="o">=</span><span class="n">v1</span><span class="p">.</span><span class="mi">0</span><span class="p">,</span><span class="n">zba</span><span class="o">=</span><span class="kc">true</span><span class="p">,</span><span class="n">zbb</span><span class="o">=</span><span class="kc">true</span><span class="p">,</span><span class="n">zbs</span><span class="o">=</span><span class="kc">true</span><span class="p">,</span><span class="n">zbc</span><span class="o">=</span><span class="kc">true</span><span class="p">,</span><span class="n">zbkb</span><span class="o">=</span><span class="kc">true</span><span class="p">,</span><span class="n">zcb</span><span class="o">=</span><span class="kc">true</span><span class="p">,</span><span class="n">zicond</span><span class="o">=</span><span class="kc">true</span><span class="w"> </span><span class="o">-</span><span class="n">L</span><span class="w"> </span><span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">riscv64</span><span class="o">-</span><span class="n">linux</span><span class="o">-</span><span class="n">gnu</span><span class="w"> </span><span class="o">-</span><span class="n">E</span><span class="w"> </span><span class="n">LD_LIBRARY_PATH</span><span class="o">=/</span><span class="n">usr</span><span class="o">/</span><span class="n">riscv64</span><span class="o">-</span><span class="n">linux</span><span class="o">-</span><span class="n">gnu</span><span class="o">/</span><span class="n">lib</span><span class="w"> </span><span class="o">-</span><span class="n">E</span><span class="w"> </span><span class="n">WASMTIME_TEST_NO_HOG_MEMORY</span><span class="o">=</span><span class="mi">1</span><span class="w"> </span><span class="n">target</span><span class="o">/</span><span class="n">riscv64gc</span><span class="o">-</span><span class="n">unknown</span><span class="o">-</span><span class="n">linux</span><span class="o">-</span><span class="n">gnu</span><span class="o">/</span><span class="n">release</span><span class="o">/</span><span class="n">wasmtime</span><span class="o">-</span><span class="n">wrapper</span>
</code></pre></div>
<h3>Expected Results</h3>
<p>RISC-V result should not leave side-effect when trapping. By looking at the <a href="https://webassembly.github.io/spec/core/exec/instructions.html#t-mathsf-xref-syntax-instructions-syntax-instr-memory-mathsf-store-xref-syntax-instructions-syntax-memarg-mathit-memarg-and-t-mathsf-xref-syntax-instructions-syntax-instr-memory-mathsf-store-n-xref-syntax-instructions-syntax-memarg-mathit-memarg">spec</a>, we can know that <code>store</code> instruction should check first if the memory address (offset + byte-width) is valid, then perform the memory operation.</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="n">Opt</span><span class="w"> </span><span class="n">level</span><span class="w"> </span><span class="nb">None</span>: <span class="nb">Err</span><span class="p">(</span><span class="n">error</span><span class="w"> </span><span class="k">while</span><span class="w"> </span><span class="n">executing</span><span class="w"> </span><span class="n">at</span><span class="w"> </span><span class="n">wasm</span><span class="w"> </span><span class="n">backtrace</span>:
    <span class="mi">0</span>:   <span class="mh">0x45</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="o">&lt;</span><span class="n">unknown</span><span class="o">&gt;!&lt;</span><span class="n">wasm</span><span class="w"> </span><span class="n">function</span><span class="w"> </span><span class="mi">0</span><span class="o">&gt;</span>

<span class="n">Caused</span><span class="w"> </span><span class="n">by</span>:
    <span class="mi">0</span>: <span class="nc">memory</span><span class="w"> </span><span class="n">fault</span><span class="w"> </span><span class="n">at</span><span class="w"> </span><span class="n">wasm</span><span class="w"> </span><span class="n">address</span><span class="w"> </span><span class="mh">0x10000</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="n">linear</span><span class="w"> </span><span class="n">memory</span><span class="w"> </span><span class="n">of</span><span class="w"> </span><span class="n">size</span><span class="w"> </span><span class="mh">0x10000</span>
<span class="w">    </span><span class="mi">1</span>: <span class="nc">wasm</span><span class="w"> </span><span class="n">trap</span>: <span class="nc">out</span><span class="w"> </span><span class="n">of</span><span class="w"> </span><span class="n">bounds</span><span class="w"> </span><span class="n">memory</span><span class="w"> </span><span class="n">access</span><span class="p">)</span>
<span class="mi">0</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="mi">0</span>
</code></pre></div>
<h3>Actual Results</h3>
<p>RISC-V leaves memory side-effects when the program traps due to invalid memory address. The PoC code posted above leaves 15 bytes of 255 at the end of the memory. (indices from 65521 to 65535)</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="n">Opt</span><span class="w"> </span><span class="n">level</span><span class="w"> </span><span class="nb">None</span>: <span class="nb">Err</span><span class="p">(</span><span class="n">error</span><span class="w"> </span><span class="k">while</span><span class="w"> </span><span class="n">executing</span><span class="w"> </span><span class="n">at</span><span class="w"> </span><span class="n">wasm</span><span class="w"> </span><span class="n">backtrace</span>:
    <span class="mi">0</span>:   <span class="mh">0x45</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="o">&lt;</span><span class="n">unknown</span><span class="o">&gt;!&lt;</span><span class="n">wasm</span><span class="w"> </span><span class="n">function</span><span class="w"> </span><span class="mi">0</span><span class="o">&gt;</span>

<span class="n">Caused</span><span class="w"> </span><span class="n">by</span>:
    <span class="mi">0</span>: <span class="nc">memory</span><span class="w"> </span><span class="n">fault</span><span class="w"> </span><span class="n">at</span><span class="w"> </span><span class="n">wasm</span><span class="w"> </span><span class="n">address</span><span class="w"> </span><span class="mh">0x10000</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="n">linear</span><span class="w"> </span><span class="n">memory</span><span class="w"> </span><span class="n">of</span><span class="w"> </span><span class="n">size</span><span class="w"> </span><span class="mh">0x10000</span>
<span class="w">    </span><span class="mi">1</span>: <span class="nc">wasm</span><span class="w"> </span><span class="n">trap</span>: <span class="nc">out</span><span class="w"> </span><span class="n">of</span><span class="w"> </span><span class="n">bounds</span><span class="w"> </span><span class="n">memory</span><span class="w"> </span><span class="n">access</span><span class="p">)</span>
<span class="mi">255</span><span class="w"> </span><span class="mi">255</span><span class="w"> </span><span class="mi">255</span><span class="w"> </span><span class="mi">255</span><span class="w"> </span><span class="mi">255</span><span class="w"> </span><span class="mi">255</span><span class="w"> </span><span class="mi">255</span><span class="w"> </span><span class="mi">255</span><span class="w"> </span><span class="mi">255</span><span class="w"> </span><span class="mi">255</span><span class="w"> </span><span class="mi">255</span><span class="w"> </span><span class="mi">255</span><span class="w"> </span><span class="mi">255</span><span class="w"> </span><span class="mi">255</span><span class="w"> </span><span class="mi">255</span>
</code></pre></div>
<h3>Versions and Environment</h3>
<ul>
<li>wasmtime version<ul>
<li>commit: 6c5184809db3a92de4ee0c718c403bedc9a9ff4f(current latest, Date: Thu Mar 21 18:24:49 2024 -0700)</li>
<li>However, also checked on v19.0.0</li>
</ul>
</li>
<li>Operating system &amp; architecture: Ubuntu 22.04.3 LTS, Arch: x86_64</li>
<li>QEMU version: <code>qemu-riscv64 version 8.2.1 (v8.2.1)</code></li>
</ul>
<h3>Extra Info</h3>
<ul>
<li>Works fine on other architectures (x86_64, aarch64, s390x)</li>
<li>RISC-V is not the tier 1 platform, so releasing this bug as public (not a security bug)<br>
</li>
</ul>
</blockquote>



<a name="428320951"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%238216%20Cranelift%3A%20riscv64%20having%20memory%20s.../near/428320951" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.238216.20Cranelift.3A.20riscv64.20having.20memory.20s.2E.2E.2E.html#428320951">(Mar 22 2024 at 12:38)</a>:</h4>
<p>afonso360 <a href="https://github.com/bytecodealliance/wasmtime/issues/8216#issuecomment-2015005347">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/8216">issue #8216</a>:</p>
<blockquote>
<p>If I'm not mistaken this is the same as <a href="https://github.com/bytecodealliance/wasmtime/issues/7237">https://github.com/bytecodealliance/wasmtime/issues/7237</a>, right? We are writing to an unaligned address, crossing a page boundary and one of the pages triggers a fault.</p>
</blockquote>



<a name="428321331"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%238216%20Cranelift%3A%20riscv64%20having%20memory%20s.../near/428321331" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.238216.20Cranelift.3A.20riscv64.20having.20memory.20s.2E.2E.2E.html#428321331">(Mar 22 2024 at 12:40)</a>:</h4>
<p>afonso360 edited a <a href="https://github.com/bytecodealliance/wasmtime/issues/8216#issuecomment-2015005347">comment</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/8216">issue #8216</a>:</p>
<blockquote>
<p>If I'm not mistaken this is the same as <a href="https://github.com/bytecodealliance/wasmtime/issues/7237">https://github.com/bytecodealliance/wasmtime/issues/7237</a>, right? We are writing to an unaligned address, crossing a page boundary and one of the pages triggers a fault.</p>
<p>I'm surprised that it works on AArch64 since that one is also supposed to be affected by this.</p>
</blockquote>



<a name="428344959"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%238216%20Cranelift%3A%20riscv64%20having%20memory%20s.../near/428344959" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.238216.20Cranelift.3A.20riscv64.20having.20memory.20s.2E.2E.2E.html#428344959">(Mar 22 2024 at 14:42)</a>:</h4>
<p>alexcrichton closed <a href="https://github.com/bytecodealliance/wasmtime/issues/8216">issue #8216</a>:</p>
<blockquote>
<h3>Test Case</h3>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="c1">// main.rs</span>
<span class="k">use</span><span class="w"> </span><span class="n">wasmtime</span>::<span class="o">*</span><span class="p">;</span>

<span class="k">fn</span> <span class="nf">main</span><span class="p">()</span><span class="w"> </span>-&gt; <span class="nb">Result</span><span class="o">&lt;</span><span class="p">()</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">config</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Config</span>::<span class="n">default</span><span class="p">();</span>
<span class="w">    </span><span class="n">config</span><span class="p">.</span><span class="n">strategy</span><span class="p">(</span><span class="n">Strategy</span>::<span class="n">Cranelift</span><span class="p">);</span>
<span class="w">    </span><span class="n">config</span><span class="p">.</span><span class="n">cranelift_opt_level</span><span class="p">(</span><span class="n">OptLevel</span>::<span class="nb">None</span><span class="p">);</span>

<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">engine</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Engine</span>::<span class="n">new</span><span class="p">(</span><span class="o">&amp;</span><span class="n">config</span><span class="p">)</span><span class="o">?</span><span class="p">;</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">wat</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">r#"</span>
<span class="s">    (module</span>
<span class="s">        (type (;0;) (func (param) (result)))</span>
<span class="s">        (import "mem" "mem" (memory (;0;) 1))</span>
<span class="s">        (func (;0;) (type 0) (param) (result)</span>
<span class="s">          i32.const 65521</span>
<span class="s">          v128.const i32x4 0xffffffff 0xffffffff 0xffffffff 0xffffffff</span>
<span class="s">          v128.store align=1)</span>
<span class="s">        (export "main" (func 0)))</span>
<span class="s">    "#</span><span class="p">;</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">module</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Module</span>::<span class="n">new</span><span class="p">(</span><span class="o">&amp;</span><span class="n">engine</span><span class="p">,</span><span class="w"> </span><span class="n">wat</span><span class="p">)</span><span class="o">?</span><span class="p">;</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">store</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Store</span>::<span class="n">new</span><span class="p">(</span><span class="o">&amp;</span><span class="n">engine</span><span class="p">,</span><span class="w"> </span><span class="p">());</span>

<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">memory_ty</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">MemoryType</span>::<span class="n">new</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="nb">None</span><span class="p">);</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">memory</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Memory</span>::<span class="n">new</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="n">store</span><span class="p">,</span><span class="w"> </span><span class="n">memory_ty</span><span class="p">.</span><span class="n">clone</span><span class="p">())</span><span class="o">?</span><span class="p">;</span>

<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">instance</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Instance</span>::<span class="n">new</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="n">store</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">module</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="p">[</span><span class="n">memory</span><span class="p">.</span><span class="n">into</span><span class="p">()])</span><span class="o">?</span><span class="p">;</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">main</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">instance</span><span class="p">.</span><span class="n">get_func</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="n">store</span><span class="p">,</span><span class="w"> </span><span class="s">"main"</span><span class="p">)</span>
<span class="w">        </span><span class="p">.</span><span class="n">expect</span><span class="p">(</span><span class="s">"`main` was not an exported function"</span><span class="p">);</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">params</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="fm">vec!</span><span class="p">[];</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">results</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="fm">vec!</span><span class="p">[];</span>
<span class="w">    </span><span class="fm">println!</span><span class="p">(</span><span class="s">"Opt level None: {:?}"</span><span class="p">,</span><span class="w"> </span><span class="n">main</span><span class="p">.</span><span class="n">call</span><span class="p">(</span>
<span class="w">        </span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="n">store</span><span class="p">,</span>
<span class="w">        </span><span class="o">&amp;</span><span class="n">params</span><span class="p">,</span>
<span class="w">        </span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="n">results</span>
<span class="w">    </span><span class="p">));</span>
<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="mi">65521</span><span class="o">..</span><span class="mi">65536</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="fm">print!</span><span class="p">(</span><span class="s">"{} "</span><span class="p">,</span><span class="w"> </span><span class="n">memory</span><span class="p">.</span><span class="n">data</span><span class="p">(</span><span class="o">&amp;</span><span class="n">store</span><span class="p">)[</span><span class="n">i</span><span class="p">]);</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="fm">println!</span><span class="p">(</span><span class="s">""</span><span class="p">);</span>

<span class="w">    </span><span class="nb">Ok</span><span class="p">(())</span>
<span class="p">}</span>
</code></pre></div>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="p">[</span><span class="n">package</span><span class="p">]</span>
<span class="n">name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">"wasmtime-wrapper"</span>
<span class="n">version</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">"0.1.0"</span>
<span class="n">edition</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">"2021"</span>

#<span class="w"> </span><span class="n">See</span><span class="w"> </span><span class="n">more</span><span class="w"> </span><span class="n">keys</span><span class="w"> </span><span class="n">and</span><span class="w"> </span><span class="n">their</span><span class="w"> </span><span class="n">definitions</span><span class="w"> </span><span class="n">at</span><span class="w"> </span><span class="n">https</span>:<span class="c1">//doc.rust-lang.org/cargo/reference/manifest.html</span>

<span class="p">[</span><span class="n">dependencies</span><span class="p">]</span>
#<span class="w"> </span><span class="n">wasmtime</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">"19.0.0"</span>
<span class="n">wasmtime</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">path</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">"../wasmtime/crates/wasmtime"</span><span class="w"> </span><span class="p">}</span><span class="w"> </span>#<span class="w"> </span><span class="n">commit</span>: <span class="mi">6</span><span class="n">c5184809db3a92de4ee0c718c403bedc9a9ff4f</span><span class="w"> </span><span class="p">(</span><span class="n">current</span><span class="w"> </span><span class="n">latest</span><span class="p">,</span><span class="w"> </span><span class="n">Date</span>:   <span class="nc">Thu</span><span class="w"> </span><span class="n">Mar</span><span class="w"> </span><span class="mi">21</span><span class="w"> </span><span class="mi">18</span>:<span class="mi">24</span>:<span class="mi">49</span><span class="w"> </span><span class="mi">2024</span><span class="w"> </span><span class="o">-</span><span class="mi">0700</span><span class="p">)</span>
</code></pre></div>
<h3>Steps to reproduce</h3>
<p>Compare the following executions:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="n">cargo</span><span class="w"> </span><span class="n">run</span><span class="w"> </span><span class="o">--</span><span class="n">release</span>
<span class="n">cargo</span><span class="w"> </span><span class="n">run</span><span class="w"> </span><span class="o">--</span><span class="n">release</span><span class="w"> </span><span class="o">--</span><span class="n">target</span><span class="o">=</span><span class="n">riscv64gc</span><span class="o">-</span><span class="n">unknown</span><span class="o">-</span><span class="n">linux</span><span class="o">-</span><span class="n">gnu</span>
</code></pre></div>
<p>QEMU run options (riscv64) I'm currently using is the following:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="n">qemu</span><span class="o">-</span><span class="n">riscv64</span><span class="w"> </span><span class="o">-</span><span class="n">cpu</span><span class="w"> </span><span class="n">rv64</span><span class="p">,</span><span class="n">v</span><span class="o">=</span><span class="kc">true</span><span class="p">,</span><span class="n">vlen</span><span class="o">=</span><span class="mi">128</span><span class="p">,</span><span class="n">vext_spec</span><span class="o">=</span><span class="n">v1</span><span class="p">.</span><span class="mi">0</span><span class="p">,</span><span class="n">zba</span><span class="o">=</span><span class="kc">true</span><span class="p">,</span><span class="n">zbb</span><span class="o">=</span><span class="kc">true</span><span class="p">,</span><span class="n">zbs</span><span class="o">=</span><span class="kc">true</span><span class="p">,</span><span class="n">zbc</span><span class="o">=</span><span class="kc">true</span><span class="p">,</span><span class="n">zbkb</span><span class="o">=</span><span class="kc">true</span><span class="p">,</span><span class="n">zcb</span><span class="o">=</span><span class="kc">true</span><span class="p">,</span><span class="n">zicond</span><span class="o">=</span><span class="kc">true</span><span class="w"> </span><span class="o">-</span><span class="n">L</span><span class="w"> </span><span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">riscv64</span><span class="o">-</span><span class="n">linux</span><span class="o">-</span><span class="n">gnu</span><span class="w"> </span><span class="o">-</span><span class="n">E</span><span class="w"> </span><span class="n">LD_LIBRARY_PATH</span><span class="o">=/</span><span class="n">usr</span><span class="o">/</span><span class="n">riscv64</span><span class="o">-</span><span class="n">linux</span><span class="o">-</span><span class="n">gnu</span><span class="o">/</span><span class="n">lib</span><span class="w"> </span><span class="o">-</span><span class="n">E</span><span class="w"> </span><span class="n">WASMTIME_TEST_NO_HOG_MEMORY</span><span class="o">=</span><span class="mi">1</span><span class="w"> </span><span class="n">target</span><span class="o">/</span><span class="n">riscv64gc</span><span class="o">-</span><span class="n">unknown</span><span class="o">-</span><span class="n">linux</span><span class="o">-</span><span class="n">gnu</span><span class="o">/</span><span class="n">release</span><span class="o">/</span><span class="n">wasmtime</span><span class="o">-</span><span class="n">wrapper</span>
</code></pre></div>
<h3>Expected Results</h3>
<p>RISC-V result should not leave side-effect when trapping. By looking at the <a href="https://webassembly.github.io/spec/core/exec/instructions.html#t-mathsf-xref-syntax-instructions-syntax-instr-memory-mathsf-store-xref-syntax-instructions-syntax-memarg-mathit-memarg-and-t-mathsf-xref-syntax-instructions-syntax-instr-memory-mathsf-store-n-xref-syntax-instructions-syntax-memarg-mathit-memarg">spec</a>, we can know that <code>store</code> instruction should check first if the memory address (offset + byte-width) is valid, then perform the memory operation.</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="n">Opt</span><span class="w"> </span><span class="n">level</span><span class="w"> </span><span class="nb">None</span>: <span class="nb">Err</span><span class="p">(</span><span class="n">error</span><span class="w"> </span><span class="k">while</span><span class="w"> </span><span class="n">executing</span><span class="w"> </span><span class="n">at</span><span class="w"> </span><span class="n">wasm</span><span class="w"> </span><span class="n">backtrace</span>:
    <span class="mi">0</span>:   <span class="mh">0x45</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="o">&lt;</span><span class="n">unknown</span><span class="o">&gt;!&lt;</span><span class="n">wasm</span><span class="w"> </span><span class="n">function</span><span class="w"> </span><span class="mi">0</span><span class="o">&gt;</span>

<span class="n">Caused</span><span class="w"> </span><span class="n">by</span>:
    <span class="mi">0</span>: <span class="nc">memory</span><span class="w"> </span><span class="n">fault</span><span class="w"> </span><span class="n">at</span><span class="w"> </span><span class="n">wasm</span><span class="w"> </span><span class="n">address</span><span class="w"> </span><span class="mh">0x10000</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="n">linear</span><span class="w"> </span><span class="n">memory</span><span class="w"> </span><span class="n">of</span><span class="w"> </span><span class="n">size</span><span class="w"> </span><span class="mh">0x10000</span>
<span class="w">    </span><span class="mi">1</span>: <span class="nc">wasm</span><span class="w"> </span><span class="n">trap</span>: <span class="nc">out</span><span class="w"> </span><span class="n">of</span><span class="w"> </span><span class="n">bounds</span><span class="w"> </span><span class="n">memory</span><span class="w"> </span><span class="n">access</span><span class="p">)</span>
<span class="mi">0</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="mi">0</span>
</code></pre></div>
<h3>Actual Results</h3>
<p>RISC-V leaves memory side-effects when the program traps due to invalid memory address. The PoC code posted above leaves 15 bytes of 255 at the end of the memory. (indices from 65521 to 65535)</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="n">Opt</span><span class="w"> </span><span class="n">level</span><span class="w"> </span><span class="nb">None</span>: <span class="nb">Err</span><span class="p">(</span><span class="n">error</span><span class="w"> </span><span class="k">while</span><span class="w"> </span><span class="n">executing</span><span class="w"> </span><span class="n">at</span><span class="w"> </span><span class="n">wasm</span><span class="w"> </span><span class="n">backtrace</span>:
    <span class="mi">0</span>:   <span class="mh">0x45</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="o">&lt;</span><span class="n">unknown</span><span class="o">&gt;!&lt;</span><span class="n">wasm</span><span class="w"> </span><span class="n">function</span><span class="w"> </span><span class="mi">0</span><span class="o">&gt;</span>

<span class="n">Caused</span><span class="w"> </span><span class="n">by</span>:
    <span class="mi">0</span>: <span class="nc">memory</span><span class="w"> </span><span class="n">fault</span><span class="w"> </span><span class="n">at</span><span class="w"> </span><span class="n">wasm</span><span class="w"> </span><span class="n">address</span><span class="w"> </span><span class="mh">0x10000</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="n">linear</span><span class="w"> </span><span class="n">memory</span><span class="w"> </span><span class="n">of</span><span class="w"> </span><span class="n">size</span><span class="w"> </span><span class="mh">0x10000</span>
<span class="w">    </span><span class="mi">1</span>: <span class="nc">wasm</span><span class="w"> </span><span class="n">trap</span>: <span class="nc">out</span><span class="w"> </span><span class="n">of</span><span class="w"> </span><span class="n">bounds</span><span class="w"> </span><span class="n">memory</span><span class="w"> </span><span class="n">access</span><span class="p">)</span>
<span class="mi">255</span><span class="w"> </span><span class="mi">255</span><span class="w"> </span><span class="mi">255</span><span class="w"> </span><span class="mi">255</span><span class="w"> </span><span class="mi">255</span><span class="w"> </span><span class="mi">255</span><span class="w"> </span><span class="mi">255</span><span class="w"> </span><span class="mi">255</span><span class="w"> </span><span class="mi">255</span><span class="w"> </span><span class="mi">255</span><span class="w"> </span><span class="mi">255</span><span class="w"> </span><span class="mi">255</span><span class="w"> </span><span class="mi">255</span><span class="w"> </span><span class="mi">255</span><span class="w"> </span><span class="mi">255</span>
</code></pre></div>
<h3>Versions and Environment</h3>
<ul>
<li>wasmtime version<ul>
<li>commit: 6c5184809db3a92de4ee0c718c403bedc9a9ff4f(current latest, Date: Thu Mar 21 18:24:49 2024 -0700)</li>
<li>However, also checked on v19.0.0</li>
</ul>
</li>
<li>Operating system &amp; architecture: Ubuntu 22.04.3 LTS, Arch: x86_64</li>
<li>QEMU version: <code>qemu-riscv64 version 8.2.1 (v8.2.1)</code></li>
</ul>
<h3>Extra Info</h3>
<ul>
<li>Works fine on other architectures (x86_64, aarch64, s390x)</li>
<li>RISC-V is not the tier 1 platform, so releasing this bug as public (not a security bug)<br>
</li>
</ul>
</blockquote>



<a name="428344962"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%238216%20Cranelift%3A%20riscv64%20having%20memory%20s.../near/428344962" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.238216.20Cranelift.3A.20riscv64.20having.20memory.20s.2E.2E.2E.html#428344962">(Mar 22 2024 at 14:42)</a>:</h4>
<p>alexcrichton <a href="https://github.com/bytecodealliance/wasmtime/issues/8216#issuecomment-2015253662">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/8216">issue #8216</a>:</p>
<blockquote>
<p>I would agree with @afonso360, but thanks regardless @candymate!</p>
<p>I'm going to close this in favor of that issue, and I'll also drop a link to <a href="https://github.com/WebAssembly/design/issues/1490">https://github.com/WebAssembly/design/issues/1490</a> which is upstream spec discussion on this topic too.</p>
</blockquote>



<hr><p>Last updated: Jan 20 2025 at 06:04 UTC</p>
</html>