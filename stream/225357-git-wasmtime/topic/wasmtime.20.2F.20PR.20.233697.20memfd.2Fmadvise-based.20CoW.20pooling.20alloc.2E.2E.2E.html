<html>
<head><meta charset="utf-8"><title>wasmtime / PR #3697 memfd/madvise-based CoW pooling alloc... · git-wasmtime · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/index.html">git-wasmtime</a></h2>
<h3>Topic: <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.233697.20memfd.2Fmadvise-based.20CoW.20pooling.20alloc.2E.2E.2E.html">wasmtime / PR #3697 memfd/madvise-based CoW pooling alloc...</a></h3>

<hr>

<base href="https://bytecodealliance.zulipchat.com">

<head><link href="https://bytecodealliance.github.io/zulip-archive/style.css" rel="stylesheet"></head>

<a name="268481422"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%233697%20memfd/madvise-based%20CoW%20pooling%20alloc.../near/268481422" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.233697.20memfd.2Fmadvise-based.20CoW.20pooling.20alloc.2E.2E.2E.html#268481422">(Jan 19 2022 at 01:32)</a>:</h4>
<p>cfallin opened <a href="https://github.com/bytecodealliance/wasmtime/pull/3697">PR #3697</a> from <code>memfd-cow</code> to <code>main</code>:</p>
<blockquote>
<p>Add a pooling allocator mode based on copy-on-write mappings of memfds.</p>
<p>As first suggested by Jan on the Zulip here [1], a cheap and effective<br>
way to obtain copy-on-write semantics of a "backing image" for a Wasm<br>
memory is to mmap a file with <code>MAP_PRIVATE</code>. The <code>memfd</code> mechanism<br>
provided by the Linux kernel allows us to create anonymous,<br>
in-memory-only files that we can use for this mapping, so we can<br>
construct the image contents on-the-fly then effectively create a CoW<br>
overlay. Furthermore, and importantly, <code>madvise(MADV_DONTNEED, ...)</code><br>
will discard the CoW overlay, returning the mapping to its original<br>
state.</p>
<p>By itself this is almost enough for a very fast<br>
instantiation-termination loop of the same image over and over,<br>
without changing the address space mapping at all (which is<br>
expensive). The only missing bit is how to implement<br>
heap <em>growth</em>. But here memfds can help us again: if we create another<br>
anonymous file and map it where the extended parts of the heap would<br>
go, we can take advantage of the fact that a <code>mmap()</code> mapping can<br>
be <em>larger than the file itself</em>, with accesses beyond the end<br>
generating a <code>SIGBUS</code>, and the fact that we can cheaply resize the<br>
file with <code>ftruncate</code>, even after a mapping exists. So we can map the<br>
"heap extension" file once with the maximum memory-slot size and grow<br>
the memfd itself as <code>memory.grow</code> operations occur.</p>
<p>The above CoW technique and heap-growth technique together allow us a<br>
fastpath of <code>madvise()</code> and <code>ftruncate()</code> only when we re-instantiate<br>
the same module over and over, as long as we can reuse the same<br>
slot. This fastpath avoids all whole-process address-space locks in<br>
the Linux kernel, which should mean it is highly scalable. It also<br>
avoids the cost of copying data on read, as the <code>uffd</code> heap backend<br>
does when servicing pagefaults; the kernel's own optimized CoW<br>
logic (same as used by all file mmaps) is used instead.</p>
<p>There are still a few loose ends in this PR, which I intend to tie up<br>
before merging:</p>
<ul>
<li>
<p>There is no <code>InstanceAllocationStrategy</code> yet that attempts to<br>
  actually reuse instance slots; that should be added ASAP. For testing<br>
  so far, I have just instantiated the same one module repeatedly (so<br>
  reuse naturally occurs).</p>
</li>
<li>
<p>The guard-page strategy is slightly wrong; I need to implement the<br>
  pre-heap guard region as well. This will be done by performing<br>
  another mapping once, to reserve the whole address range, then<br>
  mmap'ing the image and extension file on top at appropriate<br>
  offsets (2GiB, 2GiB plus image size).</p>
</li>
</ul>
<p>Thanks to Jan on Zulip (are you also @koute from #3691?) for the initial<br>
idea/inspiration! This PR is meant to demonstrate my thoughts on how<br>
to build the feature and spawn discussion; now that we see both approaches<br>
hopefully we can work out a way to meet the needs of both of our use-cases.</p>
<p>[1] <a href="#narrow/stream/206238-general/topic/Copy.20on.20write.20based.20instance.20reuse/near/266657772">https://bytecodealliance.zulipchat.com/#narrow/stream/206238-general/topic/Copy.20on.20write.20based.20instance.20reuse/near/266657772</a></p>
</blockquote>



<a name="268481445"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%233697%20memfd/madvise-based%20CoW%20pooling%20alloc.../near/268481445" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.233697.20memfd.2Fmadvise-based.20CoW.20pooling.20alloc.2E.2E.2E.html#268481445">(Jan 19 2022 at 01:33)</a>:</h4>
<p><strong>cfallin</strong> requested <a href="https://github.com/alexcrichton">alexcrichton</a> for a review on <a href="https://github.com/bytecodealliance/wasmtime/pull/3697">PR #3697</a>.</p>



<a name="268481446"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%233697%20memfd/madvise-based%20CoW%20pooling%20alloc.../near/268481446" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.233697.20memfd.2Fmadvise-based.20CoW.20pooling.20alloc.2E.2E.2E.html#268481446">(Jan 19 2022 at 01:33)</a>:</h4>
<p><strong>cfallin</strong> requested <a href="https://github.com/peterhuene">peterhuene</a> for a review on <a href="https://github.com/bytecodealliance/wasmtime/pull/3697">PR #3697</a>.</p>



<a name="268481843"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%233697%20memfd/madvise-based%20CoW%20pooling%20alloc.../near/268481843" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.233697.20memfd.2Fmadvise-based.20CoW.20pooling.20alloc.2E.2E.2E.html#268481843">(Jan 19 2022 at 01:39)</a>:</h4>
<p>cfallin updated <a href="https://github.com/bytecodealliance/wasmtime/pull/3697">PR #3697</a> from <code>memfd-cow</code> to <code>main</code>.</p>



<a name="268783015"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%233697%20memfd/madvise-based%20CoW%20pooling%20alloc.../near/268783015" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.233697.20memfd.2Fmadvise-based.20CoW.20pooling.20alloc.2E.2E.2E.html#268783015">(Jan 21 2022 at 01:16)</a>:</h4>
<p>cfallin updated <a href="https://github.com/bytecodealliance/wasmtime/pull/3697">PR #3697</a> from <code>memfd-cow</code> to <code>main</code>.</p>



<a name="268785750"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%233697%20memfd/madvise-based%20CoW%20pooling%20alloc.../near/268785750" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.233697.20memfd.2Fmadvise-based.20CoW.20pooling.20alloc.2E.2E.2E.html#268785750">(Jan 21 2022 at 01:53)</a>:</h4>
<p>cfallin updated <a href="https://github.com/bytecodealliance/wasmtime/pull/3697">PR #3697</a> from <code>memfd-cow</code> to <code>main</code>.</p>



<a name="268940105"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%233697%20memfd/madvise-based%20CoW%20pooling%20alloc.../near/268940105" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.233697.20memfd.2Fmadvise-based.20CoW.20pooling.20alloc.2E.2E.2E.html#268940105">(Jan 22 2022 at 06:05)</a>:</h4>
<p>cfallin updated <a href="https://github.com/bytecodealliance/wasmtime/pull/3697">PR #3697</a> from <code>memfd-cow</code> to <code>main</code>.</p>



<a name="268940587"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%233697%20memfd/madvise-based%20CoW%20pooling%20alloc.../near/268940587" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.233697.20memfd.2Fmadvise-based.20CoW.20pooling.20alloc.2E.2E.2E.html#268940587">(Jan 22 2022 at 06:19)</a>:</h4>
<p>cfallin updated <a href="https://github.com/bytecodealliance/wasmtime/pull/3697">PR #3697</a> from <code>memfd-cow</code> to <code>main</code>.</p>



<a name="268941450"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%233697%20memfd/madvise-based%20CoW%20pooling%20alloc.../near/268941450" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.233697.20memfd.2Fmadvise-based.20CoW.20pooling.20alloc.2E.2E.2E.html#268941450">(Jan 22 2022 at 06:43)</a>:</h4>
<p>cfallin updated <a href="https://github.com/bytecodealliance/wasmtime/pull/3697">PR #3697</a> from <code>memfd-cow</code> to <code>main</code>.</p>



<a name="269190131"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%233697%20memfd/madvise-based%20CoW%20pooling%20alloc.../near/269190131" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.233697.20memfd.2Fmadvise-based.20CoW.20pooling.20alloc.2E.2E.2E.html#269190131">(Jan 25 2022 at 00:00)</a>:</h4>
<p>cfallin updated <a href="https://github.com/bytecodealliance/wasmtime/pull/3697">PR #3697</a> from <code>memfd-cow</code> to <code>main</code>.</p>



<a name="269190737"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%233697%20memfd/madvise-based%20CoW%20pooling%20alloc.../near/269190737" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.233697.20memfd.2Fmadvise-based.20CoW.20pooling.20alloc.2E.2E.2E.html#269190737">(Jan 25 2022 at 00:07)</a>:</h4>
<p>cfallin updated <a href="https://github.com/bytecodealliance/wasmtime/pull/3697">PR #3697</a> from <code>memfd-cow</code> to <code>main</code>.</p>



<a name="269193981"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%233697%20memfd/madvise-based%20CoW%20pooling%20alloc.../near/269193981" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.233697.20memfd.2Fmadvise-based.20CoW.20pooling.20alloc.2E.2E.2E.html#269193981">(Jan 25 2022 at 00:50)</a>:</h4>
<p>cfallin updated <a href="https://github.com/bytecodealliance/wasmtime/pull/3697">PR #3697</a> from <code>memfd-cow</code> to <code>main</code>.</p>



<a name="269194014"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%233697%20memfd/madvise-based%20CoW%20pooling%20alloc.../near/269194014" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.233697.20memfd.2Fmadvise-based.20CoW.20pooling.20alloc.2E.2E.2E.html#269194014">(Jan 25 2022 at 00:51)</a>:</h4>
<p>cfallin updated <a href="https://github.com/bytecodealliance/wasmtime/pull/3697">PR #3697</a> from <code>memfd-cow</code> to <code>main</code>.</p>



<a name="269195321"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%233697%20memfd/madvise-based%20CoW%20pooling%20alloc.../near/269195321" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.233697.20memfd.2Fmadvise-based.20CoW.20pooling.20alloc.2E.2E.2E.html#269195321">(Jan 25 2022 at 01:09)</a>:</h4>
<p>cfallin updated <a href="https://github.com/bytecodealliance/wasmtime/pull/3697">PR #3697</a> from <code>memfd-cow</code> to <code>main</code>.</p>



<a name="269195544"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%233697%20memfd/madvise-based%20CoW%20pooling%20alloc.../near/269195544" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.233697.20memfd.2Fmadvise-based.20CoW.20pooling.20alloc.2E.2E.2E.html#269195544">(Jan 25 2022 at 01:13)</a>:</h4>
<p>cfallin updated <a href="https://github.com/bytecodealliance/wasmtime/pull/3697">PR #3697</a> from <code>memfd-cow</code> to <code>main</code>.</p>



<a name="269216766"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%233697%20memfd/madvise-based%20CoW%20pooling%20alloc.../near/269216766" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.233697.20memfd.2Fmadvise-based.20CoW.20pooling.20alloc.2E.2E.2E.html#269216766">(Jan 25 2022 at 07:07)</a>:</h4>
<p>cfallin updated <a href="https://github.com/bytecodealliance/wasmtime/pull/3697">PR #3697</a> from <code>memfd-cow</code> to <code>main</code>.</p>



<a name="269221047"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%233697%20memfd/madvise-based%20CoW%20pooling%20alloc.../near/269221047" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.233697.20memfd.2Fmadvise-based.20CoW.20pooling.20alloc.2E.2E.2E.html#269221047">(Jan 25 2022 at 08:06)</a>:</h4>
<p>cfallin updated <a href="https://github.com/bytecodealliance/wasmtime/pull/3697">PR #3697</a> from <code>memfd-cow</code> to <code>main</code>.</p>



<a name="269306442"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%233697%20memfd/madvise-based%20CoW%20pooling%20alloc.../near/269306442" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.233697.20memfd.2Fmadvise-based.20CoW.20pooling.20alloc.2E.2E.2E.html#269306442">(Jan 25 2022 at 19:01)</a>:</h4>
<p>cfallin updated <a href="https://github.com/bytecodealliance/wasmtime/pull/3697">PR #3697</a> from <code>memfd-cow</code> to <code>main</code>.</p>



<a name="269306614"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%233697%20memfd/madvise-based%20CoW%20pooling%20alloc.../near/269306614" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.233697.20memfd.2Fmadvise-based.20CoW.20pooling.20alloc.2E.2E.2E.html#269306614">(Jan 25 2022 at 19:02)</a>:</h4>
<p>cfallin updated <a href="https://github.com/bytecodealliance/wasmtime/pull/3697">PR #3697</a> from <code>memfd-cow</code> to <code>main</code>.</p>



<a name="269314287"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%233697%20memfd/madvise-based%20CoW%20pooling%20alloc.../near/269314287" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.233697.20memfd.2Fmadvise-based.20CoW.20pooling.20alloc.2E.2E.2E.html#269314287">(Jan 25 2022 at 19:53)</a>:</h4>
<p>cfallin updated <a href="https://github.com/bytecodealliance/wasmtime/pull/3697">PR #3697</a> from <code>memfd-cow</code> to <code>main</code>.</p>



<a name="269331400"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%233697%20memfd/madvise-based%20CoW%20pooling%20alloc.../near/269331400" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.233697.20memfd.2Fmadvise-based.20CoW.20pooling.20alloc.2E.2E.2E.html#269331400">(Jan 25 2022 at 22:01)</a>:</h4>
<p>cfallin updated <a href="https://github.com/bytecodealliance/wasmtime/pull/3697">PR #3697</a> from <code>memfd-cow</code> to <code>main</code>.</p>



<a name="269332546"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%233697%20memfd/madvise-based%20CoW%20pooling%20alloc.../near/269332546" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.233697.20memfd.2Fmadvise-based.20CoW.20pooling.20alloc.2E.2E.2E.html#269332546">(Jan 25 2022 at 22:10)</a>:</h4>
<p>cfallin updated <a href="https://github.com/bytecodealliance/wasmtime/pull/3697">PR #3697</a> from <code>memfd-cow</code> to <code>main</code>.</p>



<a name="269334002"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%233697%20memfd/madvise-based%20CoW%20pooling%20alloc.../near/269334002" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.233697.20memfd.2Fmadvise-based.20CoW.20pooling.20alloc.2E.2E.2E.html#269334002">(Jan 25 2022 at 22:20)</a>:</h4>
<p>cfallin updated <a href="https://github.com/bytecodealliance/wasmtime/pull/3697">PR #3697</a> from <code>memfd-cow</code> to <code>main</code>.</p>



<a name="269340256"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%233697%20memfd/madvise-based%20CoW%20pooling%20alloc.../near/269340256" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.233697.20memfd.2Fmadvise-based.20CoW.20pooling.20alloc.2E.2E.2E.html#269340256">(Jan 25 2022 at 23:20)</a>:</h4>
<p>cfallin updated <a href="https://github.com/bytecodealliance/wasmtime/pull/3697">PR #3697</a> from <code>memfd-cow</code> to <code>main</code>.</p>



<a name="269639977"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%233697%20memfd/madvise-based%20CoW%20pooling%20alloc.../near/269639977" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.233697.20memfd.2Fmadvise-based.20CoW.20pooling.20alloc.2E.2E.2E.html#269639977">(Jan 27 2022 at 21:23)</a>:</h4>
<p>cfallin updated <a href="https://github.com/bytecodealliance/wasmtime/pull/3697">PR #3697</a> from <code>memfd-cow</code> to <code>main</code>.</p>



<a name="269641201"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%233697%20memfd/madvise-based%20CoW%20pooling%20alloc.../near/269641201" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.233697.20memfd.2Fmadvise-based.20CoW.20pooling.20alloc.2E.2E.2E.html#269641201">(Jan 27 2022 at 21:32)</a>:</h4>
<p>cfallin updated <a href="https://github.com/bytecodealliance/wasmtime/pull/3697">PR #3697</a> from <code>memfd-cow</code> to <code>main</code>.</p>



<a name="269641971"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%233697%20memfd/madvise-based%20CoW%20pooling%20alloc.../near/269641971" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.233697.20memfd.2Fmadvise-based.20CoW.20pooling.20alloc.2E.2E.2E.html#269641971">(Jan 27 2022 at 21:36)</a>:</h4>
<p>cfallin updated <a href="https://github.com/bytecodealliance/wasmtime/pull/3697">PR #3697</a> from <code>memfd-cow</code> to <code>main</code>.</p>



<a name="269642174"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%233697%20memfd/madvise-based%20CoW%20pooling%20alloc.../near/269642174" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.233697.20memfd.2Fmadvise-based.20CoW.20pooling.20alloc.2E.2E.2E.html#269642174">(Jan 27 2022 at 21:38)</a>:</h4>
<p><strong>cfallin</strong> has marked <a href="https://github.com/bytecodealliance/wasmtime/pull/3697">PR #3697</a> as ready for review.</p>



<a name="269650068"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%233697%20memfd/madvise-based%20CoW%20pooling%20alloc.../near/269650068" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.233697.20memfd.2Fmadvise-based.20CoW.20pooling.20alloc.2E.2E.2E.html#269650068">(Jan 27 2022 at 22:31)</a>:</h4>
<p>alexcrichton submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/3697#pullrequestreview-863020027">PR review</a>.</p>



<a name="269650069"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%233697%20memfd/madvise-based%20CoW%20pooling%20alloc.../near/269650069" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.233697.20memfd.2Fmadvise-based.20CoW.20pooling.20alloc.2E.2E.2E.html#269650069">(Jan 27 2022 at 22:31)</a>:</h4>
<p>alexcrichton submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/3697#pullrequestreview-863020027">PR review</a>.</p>



<a name="269650070"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%233697%20memfd/madvise-based%20CoW%20pooling%20alloc.../near/269650070" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.233697.20memfd.2Fmadvise-based.20CoW.20pooling.20alloc.2E.2E.2E.html#269650070">(Jan 27 2022 at 22:31)</a>:</h4>
<p>alexcrichton created <a href="https://github.com/bytecodealliance/wasmtime/pull/3697#discussion_r792239489">PR review comment</a>:</p>
<blockquote>
<p>Personally with conditional compilation things my goal would be to minimize the number of <code>#[cfg]</code> necessary, so to that end I think this might be a bit nicer have the body of <code>is_memfd_with_image</code> conditionally defined instead of consumers being conditionally defined.</p>
<p>Otherwise afterwards if we're worried about performance here I think it's best to use <code>if cfg!(...)</code> to handle performance issues. Without <code>#[cfg]</code> we can subvert lints like the <code>drop(module)</code> below and also ensure that this compiles all the time instead of in only one configuration.</p>
</blockquote>



<a name="269650071"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%233697%20memfd/madvise-based%20CoW%20pooling%20alloc.../near/269650071" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.233697.20memfd.2Fmadvise-based.20CoW.20pooling.20alloc.2E.2E.2E.html#269650071">(Jan 27 2022 at 22:31)</a>:</h4>
<p>alexcrichton created <a href="https://github.com/bytecodealliance/wasmtime/pull/3697#discussion_r792242224">PR review comment</a>:</p>
<blockquote>
<p>This isn't applicable to this location in particular, but is there any reason to have this feature conditional? Naturally it's Linux-specific no matter what but I'm not sure why we wouldn't want to turn it on by default on Linux. Or otherwise this ideally seems like a <code>Config</code> option which is checked at runtime with compile-time abilities to compile it out if truly necessary. (I'm not sure if it's required we get this to an able-to-be-compiled-out-state though, we don't have really any restrictions on our runtime footprint at this time)</p>
</blockquote>



<a name="269650072"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%233697%20memfd/madvise-based%20CoW%20pooling%20alloc.../near/269650072" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.233697.20memfd.2Fmadvise-based.20CoW.20pooling.20alloc.2E.2E.2E.html#269650072">(Jan 27 2022 at 22:31)</a>:</h4>
<p>alexcrichton created <a href="https://github.com/bytecodealliance/wasmtime/pull/3697#discussion_r792839156">PR review comment</a>:</p>
<blockquote>
<p>Would you be ok splitting the benchmark bits out to a separate PR? </p>
</blockquote>



<a name="269650073"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%233697%20memfd/madvise-based%20CoW%20pooling%20alloc.../near/269650073" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.233697.20memfd.2Fmadvise-based.20CoW.20pooling.20alloc.2E.2E.2E.html#269650073">(Jan 27 2022 at 22:31)</a>:</h4>
<p>alexcrichton created <a href="https://github.com/bytecodealliance/wasmtime/pull/3697#discussion_r792840195">PR review comment</a>:</p>
<blockquote>
<p>Mind folding this into the block above with s/Test uffd functionality on Linux/Test Linux-specific functionality/</p>
</blockquote>



<a name="269650074"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%233697%20memfd/madvise-based%20CoW%20pooling%20alloc.../near/269650074" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.233697.20memfd.2Fmadvise-based.20CoW.20pooling.20alloc.2E.2E.2E.html#269650074">(Jan 27 2022 at 22:31)</a>:</h4>
<p>alexcrichton created <a href="https://github.com/bytecodealliance/wasmtime/pull/3697#discussion_r792240578">PR review comment</a>:</p>
<blockquote>
<p>I think you'll want to reset the <code>info</code> field a line or two above this line as well.</p>
</blockquote>



<a name="269650075"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%233697%20memfd/madvise-based%20CoW%20pooling%20alloc.../near/269650075" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.233697.20memfd.2Fmadvise-based.20CoW.20pooling.20alloc.2E.2E.2E.html#269650075">(Jan 27 2022 at 22:31)</a>:</h4>
<p>alexcrichton created <a href="https://github.com/bytecodealliance/wasmtime/pull/3697#discussion_r792246996">PR review comment</a>:</p>
<blockquote>
<p>For this with now multiple-methods of creating memories I think it might be best to have something like:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="k">match</span><span class="w"> </span><span class="o">&amp;</span><span class="n">memory</span><span class="p">.</span><span class="n">kind</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span>#<span class="p">{</span><span class="n">cfg</span><span class="p">(</span><span class="n">feature</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">"uffd"</span><span class="p">)]</span><span class="w"></span>
<span class="w">    </span><span class="n">MemoryKind</span>::<span class="n">Uffd</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">something</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="n">something</span><span class="p">.</span><span class="n">reset_guard_pages</span><span class="p">(),</span><span class="w"></span>
<span class="w">    </span>#<span class="p">{</span><span class="n">cfg</span><span class="p">(</span><span class="n">feature</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">"memfd-allocator"</span><span class="p">)]</span><span class="w"></span>
<span class="w">    </span><span class="n">MemoryKind</span>::<span class="n">Memfd</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">something</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="n">something</span><span class="p">.</span><span class="n">clear_and_remain_ready</span><span class="p">();</span><span class="w"></span>
<span class="w">        </span><span class="k">continue</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="n">MemoryKind</span>::<span class="n">Mmap</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="cm">/* ... */</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>
<p>(or something along those lines)</p>
</blockquote>



<a name="269650076"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%233697%20memfd/madvise-based%20CoW%20pooling%20alloc.../near/269650076" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.233697.20memfd.2Fmadvise-based.20CoW.20pooling.20alloc.2E.2E.2E.html#269650076">(Jan 27 2022 at 22:31)</a>:</h4>
<p>alexcrichton created <a href="https://github.com/bytecodealliance/wasmtime/pull/3697#discussion_r792843557">PR review comment</a>:</p>
<blockquote>
<p>Could you add some docs to what these fields are?</p>
</blockquote>



<a name="269650077"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%233697%20memfd/madvise-based%20CoW%20pooling%20alloc.../near/269650077" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.233697.20memfd.2Fmadvise-based.20CoW.20pooling.20alloc.2E.2E.2E.html#269650077">(Jan 27 2022 at 22:31)</a>:</h4>
<p>alexcrichton created <a href="https://github.com/bytecodealliance/wasmtime/pull/3697#discussion_r792841093">PR review comment</a>:</p>
<blockquote>
<p>I'm sure you were planning on already doing this, but to ensure there's a note here as well I think it'd be best to split out the <code>VMCallerCheckedAnyfunc</code> changes to a separate PR</p>
</blockquote>



<a name="269650078"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%233697%20memfd/madvise-based%20CoW%20pooling%20alloc.../near/269650078" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.233697.20memfd.2Fmadvise-based.20CoW.20pooling.20alloc.2E.2E.2E.html#269650078">(Jan 27 2022 at 22:31)</a>:</h4>
<p>alexcrichton created <a href="https://github.com/bytecodealliance/wasmtime/pull/3697#discussion_r792844251">PR review comment</a>:</p>
<blockquote>
<p>I think Rust-convention-wise this would be <code>Fd</code> rather than <code>FD</code> (e.g. <code>Http</code> instead of <code>HTTP</code>)</p>
</blockquote>



<a name="269650080"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%233697%20memfd/madvise-based%20CoW%20pooling%20alloc.../near/269650080" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.233697.20memfd.2Fmadvise-based.20CoW.20pooling.20alloc.2E.2E.2E.html#269650080">(Jan 27 2022 at 22:31)</a>:</h4>
<p>alexcrichton created <a href="https://github.com/bytecodealliance/wasmtime/pull/3697#discussion_r792845565">PR review comment</a>:</p>
<blockquote>
<p>The <code>UnsafeCell</code> here and the <code>unsafe impl Send</code> are a bit worrisome to be. </p>
<p>How would you feel about a scheme where this was something like <code>AtomicPtr&lt;MemFDSlot&gt;</code> and we transferred ownership dynamically between a pool and the <code>Memory</code> that holds it? That way we could have what I think would be pretty cheap runtime asserts that the ownership here all works out and no risk of accidental races on this.</p>
</blockquote>



<a name="269650081"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%233697%20memfd/madvise-based%20CoW%20pooling%20alloc.../near/269650081" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.233697.20memfd.2Fmadvise-based.20CoW.20pooling.20alloc.2E.2E.2E.html#269650081">(Jan 27 2022 at 22:31)</a>:</h4>
<p>alexcrichton created <a href="https://github.com/bytecodealliance/wasmtime/pull/3697#discussion_r792846107">PR review comment</a>:</p>
<blockquote>
<p>I think a better name for this might be <code>unwrap_mmap</code> to signal the panic, but if this is dead code it's probably safe to remove to (or is the <code>#[allow]</code> just for a <code>#[cfg]</code>?)</p>
</blockquote>



<a name="269650082"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%233697%20memfd/madvise-based%20CoW%20pooling%20alloc.../near/269650082" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.233697.20memfd.2Fmadvise-based.20CoW.20pooling.20alloc.2E.2E.2E.html#269650082">(Jan 27 2022 at 22:31)</a>:</h4>
<p>alexcrichton created <a href="https://github.com/bytecodealliance/wasmtime/pull/3697#discussion_r792856568">PR review comment</a>:</p>
<blockquote>
<p>FWIW it's methods like this that make me pretty uncomfortable about the <code>UnsafeCell</code> and how I think it would be better to have an <code>AtomicPtr</code> or similar which is always used to transfer ownership to a single owner at a time. Promiting from a <code>&amp;self</code> to <code>&amp;mut MemFDSlot</code> is pretty scary here and easy to get lost when reading other code.</p>
</blockquote>



<a name="269650083"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%233697%20memfd/madvise-based%20CoW%20pooling%20alloc.../near/269650083" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.233697.20memfd.2Fmadvise-based.20CoW.20pooling.20alloc.2E.2E.2E.html#269650083">(Jan 27 2022 at 22:31)</a>:</h4>
<p>alexcrichton created <a href="https://github.com/bytecodealliance/wasmtime/pull/3697#discussion_r792848135">PR review comment</a>:</p>
<blockquote>
<p>I think I've mentioned this before, but personally I feel like this would be better to not have so different between memfd-and-not. It seems like it might be simpler to still have one giant mmap for the entire memory pool and then memfd just does fancy stuff internally with everything as <code>MAP_FIXED</code>. </p>
<p>If instead we think it's better to have an mmap-per-slot then I think that the pooling allocator today to switch to that strategy. Basically I think it might be a bit more consistent to have this be the same across memfd and not.</p>
</blockquote>



<a name="269650084"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%233697%20memfd/madvise-based%20CoW%20pooling%20alloc.../near/269650084" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.233697.20memfd.2Fmadvise-based.20CoW.20pooling.20alloc.2E.2E.2E.html#269650084">(Jan 27 2022 at 22:31)</a>:</h4>
<p>alexcrichton created <a href="https://github.com/bytecodealliance/wasmtime/pull/3697#discussion_r792858371">PR review comment</a>:</p>
<blockquote>
<p>Personally I've found that it's a pretty annoying thing to keep perfect-dead-code-warnings with lots of platform-specific code. I typically solve it by having "esoteric" configurations have this at the top of the crate:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="cp">#![cfg_attr(feature = </span><span class="s">"memfd-allocator"</span><span class="cp">, allow(dead_code))]</span><span class="w"></span>
</code></pre></div>
<p>to deal with it at the beginning and not worry about it later. Basically I don't think we care much about dead code in configured situations, only in the default case do we largely care about removing dead code.</p>
</blockquote>



<a name="269650085"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%233697%20memfd/madvise-based%20CoW%20pooling%20alloc.../near/269650085" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.233697.20memfd.2Fmadvise-based.20CoW.20pooling.20alloc.2E.2E.2E.html#269650085">(Jan 27 2022 at 22:31)</a>:</h4>
<p>alexcrichton created <a href="https://github.com/bytecodealliance/wasmtime/pull/3697#discussion_r792863392">PR review comment</a>:</p>
<blockquote>
<p>I think this method is used to guard against initialization loops during instantiation, but this feels like they're asking/answering different questions. I believe that <code>image</code> is none if the heap is empty, right? I think this may want a different method name or the callers use a different scheme for calling this or something like that. I suspect that the end-result is the same (if you have an empty heap you probably have 0 initializers), but it feels a bit confusing reading this now seeing what might be a disconnect.</p>
</blockquote>



<a name="269650086"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%233697%20memfd/madvise-based%20CoW%20pooling%20alloc.../near/269650086" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.233697.20memfd.2Fmadvise-based.20CoW.20pooling.20alloc.2E.2E.2E.html#269650086">(Jan 27 2022 at 22:31)</a>:</h4>
<p>alexcrichton created <a href="https://github.com/bytecodealliance/wasmtime/pull/3697#discussion_r792860247">PR review comment</a>:</p>
<blockquote>
<p>Personally I wouldn't mind the duplication in this method and <code>from_open_file</code>. I feel like seeing the <code>mmap</code> call is a bit more readable without having to have comments for all the parameters.</p>
</blockquote>



<a name="269650087"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%233697%20memfd/madvise-based%20CoW%20pooling%20alloc.../near/269650087" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.233697.20memfd.2Fmadvise-based.20CoW.20pooling.20alloc.2E.2E.2E.html#269650087">(Jan 27 2022 at 22:31)</a>:</h4>
<p>alexcrichton created <a href="https://github.com/bytecodealliance/wasmtime/pull/3697#discussion_r792865945">PR review comment</a>:</p>
<blockquote>
<p>I think this may be able to be removed now?</p>
</blockquote>



<a name="269650088"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%233697%20memfd/madvise-based%20CoW%20pooling%20alloc.../near/269650088" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.233697.20memfd.2Fmadvise-based.20CoW.20pooling.20alloc.2E.2E.2E.html#269650088">(Jan 27 2022 at 22:31)</a>:</h4>
<p>alexcrichton created <a href="https://github.com/bytecodealliance/wasmtime/pull/3697#discussion_r792867892">PR review comment</a>:</p>
<blockquote>
<p>Looking through this I don't think there's a method for removing from <code>MemFdRegistry</code>? I think it'd be pretty easy to add though and just needs a hook in <code>Drop for ModuleInner</code> or w/e we have in <code>Module</code></p>
</blockquote>



<a name="269650089"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%233697%20memfd/madvise-based%20CoW%20pooling%20alloc.../near/269650089" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.233697.20memfd.2Fmadvise-based.20CoW.20pooling.20alloc.2E.2E.2E.html#269650089">(Jan 27 2022 at 22:31)</a>:</h4>
<p>alexcrichton created <a href="https://github.com/bytecodealliance/wasmtime/pull/3697#discussion_r792868961">PR review comment</a>:</p>
<blockquote>
<p>This method and logic feels really similar to the <code>to_paged</code> method on <code>MemoryInitialization</code>, could some of this be offloaded to <code>impl MemoryInitialization { .. }</code> to try to share some bits and pieces if possible?</p>
</blockquote>



<a name="269650090"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%233697%20memfd/madvise-based%20CoW%20pooling%20alloc.../near/269650090" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.233697.20memfd.2Fmadvise-based.20CoW.20pooling.20alloc.2E.2E.2E.html#269650090">(Jan 27 2022 at 22:31)</a>:</h4>
<p>alexcrichton created <a href="https://github.com/bytecodealliance/wasmtime/pull/3697#discussion_r792869598">PR review comment</a>:</p>
<blockquote>
<p>Personally I like to use:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="kd">let</span><span class="w"> </span><span class="n">defined_memory</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">match</span><span class="w"> </span><span class="o">..</span><span class="p">.</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="nb">Some</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="n">e</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="nb">None</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="k">continue</span><span class="p">,</span><span class="w"></span>
<span class="p">};</span><span class="w"></span>
<span class="c1">// ...</span>
</code></pre></div>
<p>to avoid an extra level of indentation.</p>
</blockquote>



<a name="269650091"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%233697%20memfd/madvise-based%20CoW%20pooling%20alloc.../near/269650091" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.233697.20memfd.2Fmadvise-based.20CoW.20pooling.20alloc.2E.2E.2E.html#269650091">(Jan 27 2022 at 22:31)</a>:</h4>
<p>alexcrichton created <a href="https://github.com/bytecodealliance/wasmtime/pull/3697#discussion_r792871898">PR review comment</a>:</p>
<blockquote>
<p>I'm wary of casts like this but I feel like this sort of validation has already happened elsewhere when we loaded the module. I think though that if this were moved to <code>impl MemoryInitialization</code> it may make it easier to share this with other pieces and comment in one place that the cast is fine.</p>
</blockquote>



<a name="269650092"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%233697%20memfd/madvise-based%20CoW%20pooling%20alloc.../near/269650092" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.233697.20memfd.2Fmadvise-based.20CoW.20pooling.20alloc.2E.2E.2E.html#269650092">(Jan 27 2022 at 22:31)</a>:</h4>
<p>alexcrichton created <a href="https://github.com/bytecodealliance/wasmtime/pull/3697#discussion_r792870972">PR review comment</a>:</p>
<blockquote>
<p>Given that this set is almost always 1 could this perhaps be <code>PrimaryMap&lt;Index, bool&gt;</code> to be a bit more efficient?</p>
</blockquote>



<a name="269650093"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%233697%20memfd/madvise-based%20CoW%20pooling%20alloc.../near/269650093" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.233697.20memfd.2Fmadvise-based.20CoW.20pooling.20alloc.2E.2E.2E.html#269650093">(Jan 27 2022 at 22:31)</a>:</h4>
<p>alexcrichton created <a href="https://github.com/bytecodealliance/wasmtime/pull/3697#discussion_r792860576">PR review comment</a>:</p>
<blockquote>
<p>I think this ends up not being used nowadays, right? If so I think it'd be fine to remove it.</p>
</blockquote>



<a name="269650094"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%233697%20memfd/madvise-based%20CoW%20pooling%20alloc.../near/269650094" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.233697.20memfd.2Fmadvise-based.20CoW.20pooling.20alloc.2E.2E.2E.html#269650094">(Jan 27 2022 at 22:31)</a>:</h4>
<p>alexcrichton created <a href="https://github.com/bytecodealliance/wasmtime/pull/3697#discussion_r792870370">PR review comment</a>:</p>
<blockquote>
<p>I've since forgotten what <code>base</code> is so reading this I'm sort of naively assuming that it's a <code>global.get</code> or something like that. Could this loop have some more comments about why paraticular segments are skipped?</p>
</blockquote>



<a name="269650095"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%233697%20memfd/madvise-based%20CoW%20pooling%20alloc.../near/269650095" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.233697.20memfd.2Fmadvise-based.20CoW.20pooling.20alloc.2E.2E.2E.html#269650095">(Jan 27 2022 at 22:31)</a>:</h4>
<p>alexcrichton created <a href="https://github.com/bytecodealliance/wasmtime/pull/3697#discussion_r792872341">PR review comment</a>:</p>
<blockquote>
<p>I think this might be a good helper method to add on <code>MemoryPlan</code> or similar to avoid casts/multiplies inline here</p>
</blockquote>



<a name="269650096"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%233697%20memfd/madvise-based%20CoW%20pooling%20alloc.../near/269650096" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.233697.20memfd.2Fmadvise-based.20CoW.20pooling.20alloc.2E.2E.2E.html#269650096">(Jan 27 2022 at 22:31)</a>:</h4>
<p>alexcrichton created <a href="https://github.com/bytecodealliance/wasmtime/pull/3697#discussion_r792874214">PR review comment</a>:</p>
<blockquote>
<p>It seems like the purpose of this loop is to calculate what to pass in to <code>set_len</code>, but is that the only purpose of the loop? If so I thought that <code>write_at</code> would automatically resize the file for us? Otherwise could we keep track of the current size and automatically call <code>set_len</code> before a <code>write_at</code> below to avoid having this double loop?</p>
</blockquote>



<a name="269650097"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%233697%20memfd/madvise-based%20CoW%20pooling%20alloc.../near/269650097" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.233697.20memfd.2Fmadvise-based.20CoW.20pooling.20alloc.2E.2E.2E.html#269650097">(Jan 27 2022 at 22:31)</a>:</h4>
<p>alexcrichton created <a href="https://github.com/bytecodealliance/wasmtime/pull/3697#discussion_r792874716">PR review comment</a>:</p>
<blockquote>
<p>To confirm, this is cloexec-by-default, right?</p>
</blockquote>



<a name="269650098"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%233697%20memfd/madvise-based%20CoW%20pooling%20alloc.../near/269650098" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.233697.20memfd.2Fmadvise-based.20CoW.20pooling.20alloc.2E.2E.2E.html#269650098">(Jan 27 2022 at 22:31)</a>:</h4>
<p>alexcrichton created <a href="https://github.com/bytecodealliance/wasmtime/pull/3697#discussion_r792874506">PR review comment</a>:</p>
<blockquote>
<p>Why do we deal with seals on the memfd?</p>
</blockquote>



<a name="269650099"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%233697%20memfd/madvise-based%20CoW%20pooling%20alloc.../near/269650099" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.233697.20memfd.2Fmadvise-based.20CoW.20pooling.20alloc.2E.2E.2E.html#269650099">(Jan 27 2022 at 22:31)</a>:</h4>
<p>alexcrichton created <a href="https://github.com/bytecodealliance/wasmtime/pull/3697#discussion_r792876208">PR review comment</a>:</p>
<blockquote>
<p>Is this required? (I'm not sure of mmap's behavior of non-page-aligned files or if it's like more fast this way)</p>
</blockquote>



<a name="269650100"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%233697%20memfd/madvise-based%20CoW%20pooling%20alloc.../near/269650100" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.233697.20memfd.2Fmadvise-based.20CoW.20pooling.20alloc.2E.2E.2E.html#269650100">(Jan 27 2022 at 22:31)</a>:</h4>
<p>alexcrichton created <a href="https://github.com/bytecodealliance/wasmtime/pull/3697#discussion_r792240953">PR review comment</a>:</p>
<blockquote>
<p>This actually brings up an interesting maintainability hazard though. We're sort of manually destroying things here but I think it might actually be best to <code>std::ptr::drop_in_place</code> if we can followed by a <code>std::ptr::write</code> if you're up for trying out such a refactoring.</p>
</blockquote>



<a name="269650101"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%233697%20memfd/madvise-based%20CoW%20pooling%20alloc.../near/269650101" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.233697.20memfd.2Fmadvise-based.20CoW.20pooling.20alloc.2E.2E.2E.html#269650101">(Jan 27 2022 at 22:31)</a>:</h4>
<p>alexcrichton created <a href="https://github.com/bytecodealliance/wasmtime/pull/3697#discussion_r792245584">PR review comment</a>:</p>
<blockquote>
<p>I realize though that some of my questions are equally applicable to uffd which is a compile time feature as well. I don't think we have the best compile-time story there either, so it's not necessarily required to solve this here and now.</p>
</blockquote>



<a name="269651828"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%233697%20memfd/madvise-based%20CoW%20pooling%20alloc.../near/269651828" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.233697.20memfd.2Fmadvise-based.20CoW.20pooling.20alloc.2E.2E.2E.html#269651828">(Jan 27 2022 at 22:45)</a>:</h4>
<p>cfallin submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/3697#pullrequestreview-865519084">PR review</a>.</p>



<a name="269651829"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%233697%20memfd/madvise-based%20CoW%20pooling%20alloc.../near/269651829" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.233697.20memfd.2Fmadvise-based.20CoW.20pooling.20alloc.2E.2E.2E.html#269651829">(Jan 27 2022 at 22:45)</a>:</h4>
<p>cfallin created <a href="https://github.com/bytecodealliance/wasmtime/pull/3697#discussion_r794063767">PR review comment</a>:</p>
<blockquote>
<p>The main reason for conditionals at all is that the memfd allocator essentially takes over the pooling allocator, and the pooling allocator also works (IIUC) at least on macOS, maybe on other platforms too.</p>
<p>We could definitely do all of the conditional switching dynamically, of course; that's probably the right answer long-term. I think I was just mainly following uffd's lead here. I'm happy to do this refactor as a followup if you'd like!</p>
</blockquote>



<a name="269651936"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%233697%20memfd/madvise-based%20CoW%20pooling%20alloc.../near/269651936" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.233697.20memfd.2Fmadvise-based.20CoW.20pooling.20alloc.2E.2E.2E.html#269651936">(Jan 27 2022 at 22:46)</a>:</h4>
<p>cfallin created <a href="https://github.com/bytecodealliance/wasmtime/pull/3697#discussion_r794064158">PR review comment</a>:</p>
<blockquote>
<p>Done (#3733)</p>
</blockquote>



<a name="269651937"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%233697%20memfd/madvise-based%20CoW%20pooling%20alloc.../near/269651937" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.233697.20memfd.2Fmadvise-based.20CoW.20pooling.20alloc.2E.2E.2E.html#269651937">(Jan 27 2022 at 22:46)</a>:</h4>
<p>cfallin submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/3697#pullrequestreview-865519595">PR review</a>.</p>



<a name="269652448"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%233697%20memfd/madvise-based%20CoW%20pooling%20alloc.../near/269652448" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.233697.20memfd.2Fmadvise-based.20CoW.20pooling.20alloc.2E.2E.2E.html#269652448">(Jan 27 2022 at 22:50)</a>:</h4>
<p>cfallin submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/3697#pullrequestreview-865522724">PR review</a>.</p>



<a name="269652450"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%233697%20memfd/madvise-based%20CoW%20pooling%20alloc.../near/269652450" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.233697.20memfd.2Fmadvise-based.20CoW.20pooling.20alloc.2E.2E.2E.html#269652450">(Jan 27 2022 at 22:50)</a>:</h4>
<p>cfallin created <a href="https://github.com/bytecodealliance/wasmtime/pull/3697#discussion_r794066506">PR review comment</a>:</p>
<blockquote>
<p>My thinking was mainly as an additional security mitigation layer: this image is the starting point for all instantiations, so if we somehow had a bug that e.g. allowed an instance to directly write to it, or if some other security vulnerability allowed an attacker to direct a write to an arbitrary open fd, then all new instances would be affected. As long as the API exists, why not use it to make the thing read-only?</p>
<p>(I'm happy to add a comment noting this reasoning!)</p>
</blockquote>



<a name="269653668"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%233697%20memfd/madvise-based%20CoW%20pooling%20alloc.../near/269653668" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.233697.20memfd.2Fmadvise-based.20CoW.20pooling.20alloc.2E.2E.2E.html#269653668">(Jan 27 2022 at 23:00)</a>:</h4>
<p>cfallin updated <a href="https://github.com/bytecodealliance/wasmtime/pull/3697">PR #3697</a> from <code>memfd-cow</code> to <code>main</code>.</p>



<a name="269653716"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%233697%20memfd/madvise-based%20CoW%20pooling%20alloc.../near/269653716" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.233697.20memfd.2Fmadvise-based.20CoW.20pooling.20alloc.2E.2E.2E.html#269653716">(Jan 27 2022 at 23:01)</a>:</h4>
<p>cfallin submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/3697#pullrequestreview-865530360">PR review</a>.</p>



<a name="269653718"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%233697%20memfd/madvise-based%20CoW%20pooling%20alloc.../near/269653718" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.233697.20memfd.2Fmadvise-based.20CoW.20pooling.20alloc.2E.2E.2E.html#269653718">(Jan 27 2022 at 23:01)</a>:</h4>
<p>cfallin created <a href="https://github.com/bytecodealliance/wasmtime/pull/3697#discussion_r794071848">PR review comment</a>:</p>
<blockquote>
<p>Done! (#3736)</p>
</blockquote>



<a name="269659901"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%233697%20memfd/madvise-based%20CoW%20pooling%20alloc.../near/269659901" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.233697.20memfd.2Fmadvise-based.20CoW.20pooling.20alloc.2E.2E.2E.html#269659901">(Jan 27 2022 at 23:54)</a>:</h4>
<p>cfallin updated <a href="https://github.com/bytecodealliance/wasmtime/pull/3697">PR #3697</a> from <code>memfd-cow</code> to <code>main</code>.</p>



<a name="269659933"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%233697%20memfd/madvise-based%20CoW%20pooling%20alloc.../near/269659933" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.233697.20memfd.2Fmadvise-based.20CoW.20pooling.20alloc.2E.2E.2E.html#269659933">(Jan 27 2022 at 23:55)</a>:</h4>
<p>cfallin submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/3697#pullrequestreview-865562305">PR review</a>.</p>



<a name="269659934"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%233697%20memfd/madvise-based%20CoW%20pooling%20alloc.../near/269659934" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.233697.20memfd.2Fmadvise-based.20CoW.20pooling.20alloc.2E.2E.2E.html#269659934">(Jan 27 2022 at 23:55)</a>:</h4>
<p>cfallin created <a href="https://github.com/bytecodealliance/wasmtime/pull/3697#discussion_r794096301">PR review comment</a>:</p>
<blockquote>
<p>Fixed, good point!</p>
</blockquote>



<a name="269660301"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%233697%20memfd/madvise-based%20CoW%20pooling%20alloc.../near/269660301" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.233697.20memfd.2Fmadvise-based.20CoW.20pooling.20alloc.2E.2E.2E.html#269660301">(Jan 27 2022 at 23:58)</a>:</h4>
<p>cfallin submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/3697#pullrequestreview-865563933">PR review</a>.</p>



<a name="269660302"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%233697%20memfd/madvise-based%20CoW%20pooling%20alloc.../near/269660302" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.233697.20memfd.2Fmadvise-based.20CoW.20pooling.20alloc.2E.2E.2E.html#269660302">(Jan 27 2022 at 23:58)</a>:</h4>
<p>cfallin created <a href="https://github.com/bytecodealliance/wasmtime/pull/3697#discussion_r794097576">PR review comment</a>:</p>
<blockquote>
<p>Ah, yes. I went looking for <code>info</code> and realized this was part of the lazy-anyfunc changes that have been split off. But that just proves the point more: it's entirely unobvious in the other PR that this would need to change, and a review of that PR could have easily missed it.</p>
<p>I think the invariant of keeping <code>Instance</code>s initialized-but-empty and "hot-patching" the fields was probably intended to keep the <code>PrimaryMap</code>s from being freed/allocated on each instantiation -- at least that's one benefit I see -- but I agree that the risk here is probably greater than the reward, and actually aligns with some of the points above re: instantiation from scratch vs. erasing state to reuse, just on a micro scale.</p>
<p>I went ahead and refactored so that the instances remain uninitialized memory until instantiation, and are <code>drop_in_place()</code>'d on termination. Good catch!</p>
</blockquote>



<a name="269660336"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%233697%20memfd/madvise-based%20CoW%20pooling%20alloc.../near/269660336" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.233697.20memfd.2Fmadvise-based.20CoW.20pooling.20alloc.2E.2E.2E.html#269660336">(Jan 27 2022 at 23:58)</a>:</h4>
<p>cfallin submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/3697#pullrequestreview-865564049">PR review</a>.</p>



<a name="269660337"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%233697%20memfd/madvise-based%20CoW%20pooling%20alloc.../near/269660337" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.233697.20memfd.2Fmadvise-based.20CoW.20pooling.20alloc.2E.2E.2E.html#269660337">(Jan 27 2022 at 23:58)</a>:</h4>
<p>cfallin created <a href="https://github.com/bytecodealliance/wasmtime/pull/3697#discussion_r794097672">PR review comment</a>:</p>
<blockquote>
<p>Done!</p>
</blockquote>



<a name="269660345"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%233697%20memfd/madvise-based%20CoW%20pooling%20alloc.../near/269660345" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.233697.20memfd.2Fmadvise-based.20CoW.20pooling.20alloc.2E.2E.2E.html#269660345">(Jan 27 2022 at 23:58)</a>:</h4>
<p>cfallin submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/3697#pullrequestreview-865564110">PR review</a>.</p>



<a name="269660346"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%233697%20memfd/madvise-based%20CoW%20pooling%20alloc.../near/269660346" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.233697.20memfd.2Fmadvise-based.20CoW.20pooling.20alloc.2E.2E.2E.html#269660346">(Jan 27 2022 at 23:58)</a>:</h4>
<p>cfallin created <a href="https://github.com/bytecodealliance/wasmtime/pull/3697#discussion_r794097717">PR review comment</a>:</p>
<blockquote>
<p>Added!</p>
</blockquote>



<a name="269660360"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%233697%20memfd/madvise-based%20CoW%20pooling%20alloc.../near/269660360" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.233697.20memfd.2Fmadvise-based.20CoW.20pooling.20alloc.2E.2E.2E.html#269660360">(Jan 27 2022 at 23:59)</a>:</h4>
<p>cfallin submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/3697#pullrequestreview-865564199">PR review</a>.</p>



<a name="269660362"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%233697%20memfd/madvise-based%20CoW%20pooling%20alloc.../near/269660362" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.233697.20memfd.2Fmadvise-based.20CoW.20pooling.20alloc.2E.2E.2E.html#269660362">(Jan 27 2022 at 23:59)</a>:</h4>
<p>cfallin created <a href="https://github.com/bytecodealliance/wasmtime/pull/3697#discussion_r794097764">PR review comment</a>:</p>
<blockquote>
<p>Renamed.</p>
</blockquote>



<a name="269661720"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%233697%20memfd/madvise-based%20CoW%20pooling%20alloc.../near/269661720" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.233697.20memfd.2Fmadvise-based.20CoW.20pooling.20alloc.2E.2E.2E.html#269661720">(Jan 28 2022 at 00:10)</a>:</h4>
<p>cfallin updated <a href="https://github.com/bytecodealliance/wasmtime/pull/3697">PR #3697</a> from <code>memfd-cow</code> to <code>main</code>.</p>



<a name="269661723"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%233697%20memfd/madvise-based%20CoW%20pooling%20alloc.../near/269661723" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.233697.20memfd.2Fmadvise-based.20CoW.20pooling.20alloc.2E.2E.2E.html#269661723">(Jan 28 2022 at 00:10)</a>:</h4>
<p>cfallin submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/3697#pullrequestreview-865570038">PR review</a>.</p>



<a name="269661725"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%233697%20memfd/madvise-based%20CoW%20pooling%20alloc.../near/269661725" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.233697.20memfd.2Fmadvise-based.20CoW.20pooling.20alloc.2E.2E.2E.html#269661725">(Jan 28 2022 at 00:10)</a>:</h4>
<p>cfallin created <a href="https://github.com/bytecodealliance/wasmtime/pull/3697#discussion_r794102059">PR review comment</a>:</p>
<blockquote>
<p>Done.</p>
</blockquote>



<a name="269661758"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%233697%20memfd/madvise-based%20CoW%20pooling%20alloc.../near/269661758" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.233697.20memfd.2Fmadvise-based.20CoW.20pooling.20alloc.2E.2E.2E.html#269661758">(Jan 28 2022 at 00:10)</a>:</h4>
<p>cfallin submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/3697#pullrequestreview-865570241">PR review</a>.</p>



<a name="269661759"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%233697%20memfd/madvise-based%20CoW%20pooling%20alloc.../near/269661759" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.233697.20memfd.2Fmadvise-based.20CoW.20pooling.20alloc.2E.2E.2E.html#269661759">(Jan 28 2022 at 00:10)</a>:</h4>
<p>cfallin created <a href="https://github.com/bytecodealliance/wasmtime/pull/3697#discussion_r794102226">PR review comment</a>:</p>
<blockquote>
<p>Yup, that's exactly it (content depending on globals, which could vary based in imported modules). Added a comment.</p>
</blockquote>



<a name="269661763"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%233697%20memfd/madvise-based%20CoW%20pooling%20alloc.../near/269661763" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.233697.20memfd.2Fmadvise-based.20CoW.20pooling.20alloc.2E.2E.2E.html#269661763">(Jan 28 2022 at 00:10)</a>:</h4>
<p>cfallin submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/3697#pullrequestreview-865570321">PR review</a>.</p>



<a name="269661764"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%233697%20memfd/madvise-based%20CoW%20pooling%20alloc.../near/269661764" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.233697.20memfd.2Fmadvise-based.20CoW.20pooling.20alloc.2E.2E.2E.html#269661764">(Jan 28 2022 at 00:10)</a>:</h4>
<p>cfallin created <a href="https://github.com/bytecodealliance/wasmtime/pull/3697#discussion_r794102298">PR review comment</a>:</p>
<blockquote>
<p>Done.</p>
</blockquote>



<a name="269661792"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%233697%20memfd/madvise-based%20CoW%20pooling%20alloc.../near/269661792" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.233697.20memfd.2Fmadvise-based.20CoW.20pooling.20alloc.2E.2E.2E.html#269661792">(Jan 28 2022 at 00:11)</a>:</h4>
<p>cfallin submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/3697#pullrequestreview-865570468">PR review</a>.</p>



<a name="269661793"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%233697%20memfd/madvise-based%20CoW%20pooling%20alloc.../near/269661793" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.233697.20memfd.2Fmadvise-based.20CoW.20pooling.20alloc.2E.2E.2E.html#269661793">(Jan 28 2022 at 00:11)</a>:</h4>
<p>cfallin created <a href="https://github.com/bytecodealliance/wasmtime/pull/3697#discussion_r794102439">PR review comment</a>:</p>
<blockquote>
<p>Yep! Re-enabled test.</p>
</blockquote>



<a name="269661955"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%233697%20memfd/madvise-based%20CoW%20pooling%20alloc.../near/269661955" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.233697.20memfd.2Fmadvise-based.20CoW.20pooling.20alloc.2E.2E.2E.html#269661955">(Jan 28 2022 at 00:12)</a>:</h4>
<p>cfallin submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/3697#pullrequestreview-865571306">PR review</a>.</p>



<a name="269661956"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%233697%20memfd/madvise-based%20CoW%20pooling%20alloc.../near/269661956" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.233697.20memfd.2Fmadvise-based.20CoW.20pooling.20alloc.2E.2E.2E.html#269661956">(Jan 28 2022 at 00:12)</a>:</h4>
<p>cfallin created <a href="https://github.com/bytecodealliance/wasmtime/pull/3697#discussion_r794103013">PR review comment</a>:</p>
<blockquote>
<p>The other purpose of the loop is to look for any reasons we can't use a memfd (dynamically-placed segments, out-of-bounds segments) before we commit to one. I suppose we could allocate one and then throw it away if we see an error... actually I'll try that, it seems like a sensible optimization.</p>
</blockquote>



<a name="269662269"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%233697%20memfd/madvise-based%20CoW%20pooling%20alloc.../near/269662269" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.233697.20memfd.2Fmadvise-based.20CoW.20pooling.20alloc.2E.2E.2E.html#269662269">(Jan 28 2022 at 00:16)</a>:</h4>
<p>cfallin updated <a href="https://github.com/bytecodealliance/wasmtime/pull/3697">PR #3697</a> from <code>memfd-cow</code> to <code>main</code>.</p>



<a name="269662276"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%233697%20memfd/madvise-based%20CoW%20pooling%20alloc.../near/269662276" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.233697.20memfd.2Fmadvise-based.20CoW.20pooling.20alloc.2E.2E.2E.html#269662276">(Jan 28 2022 at 00:16)</a>:</h4>
<p>cfallin submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/3697#pullrequestreview-865573042">PR review</a>.</p>



<a name="269662278"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%233697%20memfd/madvise-based%20CoW%20pooling%20alloc.../near/269662278" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.233697.20memfd.2Fmadvise-based.20CoW.20pooling.20alloc.2E.2E.2E.html#269662278">(Jan 28 2022 at 00:16)</a>:</h4>
<p>cfallin created <a href="https://github.com/bytecodealliance/wasmtime/pull/3697#discussion_r794104320">PR review comment</a>:</p>
<blockquote>
<p>Added comment saying basically the above.</p>
</blockquote>



<a name="269662384"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%233697%20memfd/madvise-based%20CoW%20pooling%20alloc.../near/269662384" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.233697.20memfd.2Fmadvise-based.20CoW.20pooling.20alloc.2E.2E.2E.html#269662384">(Jan 28 2022 at 00:17)</a>:</h4>
<p>cfallin submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/3697#pullrequestreview-865573661">PR review</a>.</p>



<a name="269662386"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%233697%20memfd/madvise-based%20CoW%20pooling%20alloc.../near/269662386" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.233697.20memfd.2Fmadvise-based.20CoW.20pooling.20alloc.2E.2E.2E.html#269662386">(Jan 28 2022 at 00:17)</a>:</h4>
<p>cfallin created <a href="https://github.com/bytecodealliance/wasmtime/pull/3697#discussion_r794104837">PR review comment</a>:</p>
<blockquote>
<p>Indeed, <a href="https://docs.rs/memfd/0.4.1/src/memfd/memfd.rs.html#94">it appears so</a>.</p>
</blockquote>



<a name="269667993"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%233697%20memfd/madvise-based%20CoW%20pooling%20alloc.../near/269667993" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.233697.20memfd.2Fmadvise-based.20CoW.20pooling.20alloc.2E.2E.2E.html#269667993">(Jan 28 2022 at 01:17)</a>:</h4>
<p>cfallin updated <a href="https://github.com/bytecodealliance/wasmtime/pull/3697">PR #3697</a> from <code>memfd-cow</code> to <code>main</code>.</p>



<a name="269668067"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%233697%20memfd/madvise-based%20CoW%20pooling%20alloc.../near/269668067" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.233697.20memfd.2Fmadvise-based.20CoW.20pooling.20alloc.2E.2E.2E.html#269668067">(Jan 28 2022 at 01:17)</a>:</h4>
<p>cfallin submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/3697#pullrequestreview-865606774">PR review</a>.</p>



<a name="269668069"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%233697%20memfd/madvise-based%20CoW%20pooling%20alloc.../near/269668069" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.233697.20memfd.2Fmadvise-based.20CoW.20pooling.20alloc.2E.2E.2E.html#269668069">(Jan 28 2022 at 01:17)</a>:</h4>
<p>cfallin created <a href="https://github.com/bytecodealliance/wasmtime/pull/3697#discussion_r794132872">PR review comment</a>:</p>
<blockquote>
<p>Just refactored to make this the case again -- much simpler now. Thanks for pushing in this direction!</p>
</blockquote>



<a name="269668362"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%233697%20memfd/madvise-based%20CoW%20pooling%20alloc.../near/269668362" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.233697.20memfd.2Fmadvise-based.20CoW.20pooling.20alloc.2E.2E.2E.html#269668362">(Jan 28 2022 at 01:20)</a>:</h4>
<p>cfallin submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/3697#pullrequestreview-865609065">PR review</a>.</p>



<a name="269668363"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%233697%20memfd/madvise-based%20CoW%20pooling%20alloc.../near/269668363" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.233697.20memfd.2Fmadvise-based.20CoW.20pooling.20alloc.2E.2E.2E.html#269668363">(Jan 28 2022 at 01:20)</a>:</h4>
<p>cfallin created <a href="https://github.com/bytecodealliance/wasmtime/pull/3697#discussion_r794135764">PR review comment</a>:</p>
<blockquote>
<p>Yup, I agree. FWIW my original thinking was that we already had the same mutable-access-to-slot thing going on implicitly, because the pooling and uffd allocators were making syscalls to mutate individual slots and relying on higher-level instance mutual exclusion for safety. The difference is just that we didn't have an actual Rust object embodying the slot and actions on it previously.</p>
<p>In any case, the "take ownership and return it" pattern is much nicer; I feel better with this additional level of checking/safety. I ended up doing this with a mutex per slot, just for simplicity and to avoid gratuitous unsafe code and manual box&lt;-&gt;raw handling; that's probably acceptable overhead but I'm happy to refactor to actual atomic-exchange magic if not.</p>
</blockquote>



<a name="269668629"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%233697%20memfd/madvise-based%20CoW%20pooling%20alloc.../near/269668629" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.233697.20memfd.2Fmadvise-based.20CoW.20pooling.20alloc.2E.2E.2E.html#269668629">(Jan 28 2022 at 01:24)</a>:</h4>
<p>cfallin submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/3697#pullrequestreview-865610543">PR review</a>.</p>



<a name="269668630"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%233697%20memfd/madvise-based%20CoW%20pooling%20alloc.../near/269668630" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.233697.20memfd.2Fmadvise-based.20CoW.20pooling.20alloc.2E.2E.2E.html#269668630">(Jan 28 2022 at 01:24)</a>:</h4>
<p>cfallin created <a href="https://github.com/bytecodealliance/wasmtime/pull/3697#discussion_r794136891">PR review comment</a>:</p>
<blockquote>
<p>I added a comment here to explain what's going on -- I had actually already forgotten the subtleties and had to debug a wee bit, but it turns out that this is important for handling invalid data initializers (e.g. out-of-bounds) properly. The invariant is that the memfd-construction code may reject creating a memfd for certain reasons, e.g. dynamically-placed segments, or out-of-bounds segments, or whatever else we need to reject. The MemFD mechanism may still handle the memory, and it may be initialized normally by writing into the anon-mmap memory; so really what we want is exactly "are we using an already-prepared image" and if not, we do the initializers. Added a better doc-comment here to explain.</p>
</blockquote>



<a name="269668718"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%233697%20memfd/madvise-based%20CoW%20pooling%20alloc.../near/269668718" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.233697.20memfd.2Fmadvise-based.20CoW.20pooling.20alloc.2E.2E.2E.html#269668718">(Jan 28 2022 at 01:24)</a>:</h4>
<p>cfallin submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/3697#pullrequestreview-865610822">PR review</a>.</p>



<a name="269668719"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%233697%20memfd/madvise-based%20CoW%20pooling%20alloc.../near/269668719" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.233697.20memfd.2Fmadvise-based.20CoW.20pooling.20alloc.2E.2E.2E.html#269668719">(Jan 28 2022 at 01:24)</a>:</h4>
<p>cfallin created <a href="https://github.com/bytecodealliance/wasmtime/pull/3697#discussion_r794137134">PR review comment</a>:</p>
<blockquote>
<p>Good point, I had forgotten about that! That would be a nice surprise in a long-running process. Added a drop-handler that removes from the registry as suggested.</p>
</blockquote>



<a name="269668778"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%233697%20memfd/madvise-based%20CoW%20pooling%20alloc.../near/269668778" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.233697.20memfd.2Fmadvise-based.20CoW.20pooling.20alloc.2E.2E.2E.html#269668778">(Jan 28 2022 at 01:25)</a>:</h4>
<p>cfallin updated <a href="https://github.com/bytecodealliance/wasmtime/pull/3697">PR #3697</a> from <code>memfd-cow</code> to <code>main</code>.</p>



<a name="269668870"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%233697%20memfd/madvise-based%20CoW%20pooling%20alloc.../near/269668870" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.233697.20memfd.2Fmadvise-based.20CoW.20pooling.20alloc.2E.2E.2E.html#269668870">(Jan 28 2022 at 01:26)</a>:</h4>
<p>cfallin submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/3697#pullrequestreview-865611632">PR review</a>.</p>



<a name="269668871"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%233697%20memfd/madvise-based%20CoW%20pooling%20alloc.../near/269668871" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.233697.20memfd.2Fmadvise-based.20CoW.20pooling.20alloc.2E.2E.2E.html#269668871">(Jan 28 2022 at 01:26)</a>:</h4>
<p>cfallin created <a href="https://github.com/bytecodealliance/wasmtime/pull/3697#discussion_r794137764">PR review comment</a>:</p>
<blockquote>
<p>I think it's probably a good idea; IIRC the Linux semantics are that an mmap of a non-page-aligned-size file sees zeroes for the remainder of the last page, but that may be weird/nonportable behavior.</p>
</blockquote>



<a name="269668906"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%233697%20memfd/madvise-based%20CoW%20pooling%20alloc.../near/269668906" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.233697.20memfd.2Fmadvise-based.20CoW.20pooling.20alloc.2E.2E.2E.html#269668906">(Jan 28 2022 at 01:26)</a>:</h4>
<p>cfallin submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/3697#pullrequestreview-865611855">PR review</a>.</p>



<a name="269668907"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%233697%20memfd/madvise-based%20CoW%20pooling%20alloc.../near/269668907" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.233697.20memfd.2Fmadvise-based.20CoW.20pooling.20alloc.2E.2E.2E.html#269668907">(Jan 28 2022 at 01:26)</a>:</h4>
<p>cfallin created <a href="https://github.com/bytecodealliance/wasmtime/pull/3697#discussion_r794137948">PR review comment</a>:</p>
<blockquote>
<p>Fixed as per comment below!</p>
</blockquote>



<a name="269675436"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%233697%20memfd/madvise-based%20CoW%20pooling%20alloc.../near/269675436" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.233697.20memfd.2Fmadvise-based.20CoW.20pooling.20alloc.2E.2E.2E.html#269675436">(Jan 28 2022 at 02:08)</a>:</h4>
<p>cfallin updated <a href="https://github.com/bytecodealliance/wasmtime/pull/3697">PR #3697</a> from <code>memfd-cow</code> to <code>main</code>.</p>



<a name="269675754"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%233697%20memfd/madvise-based%20CoW%20pooling%20alloc.../near/269675754" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.233697.20memfd.2Fmadvise-based.20CoW.20pooling.20alloc.2E.2E.2E.html#269675754">(Jan 28 2022 at 02:09)</a>:</h4>
<p>cfallin submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/3697#pullrequestreview-865630215">PR review</a>.</p>



<a name="269675756"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%233697%20memfd/madvise-based%20CoW%20pooling%20alloc.../near/269675756" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.233697.20memfd.2Fmadvise-based.20CoW.20pooling.20alloc.2E.2E.2E.html#269675756">(Jan 28 2022 at 02:09)</a>:</h4>
<p>cfallin created <a href="https://github.com/bytecodealliance/wasmtime/pull/3697#discussion_r794152691">PR review comment</a>:</p>
<blockquote>
<p>I put some of the bounds checks in <code>MemoryInitializer</code>; a lot of the other logic is sort of just-different-enough to make it tricky to share. Maybe with more thought a "visitor" sort of interface to the image implied by memory initializers could be built; that feels slightly out of scope here though, to me at least (happy to push more on it if you'd like).</p>
</blockquote>



<a name="269675902"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%233697%20memfd/madvise-based%20CoW%20pooling%20alloc.../near/269675902" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.233697.20memfd.2Fmadvise-based.20CoW.20pooling.20alloc.2E.2E.2E.html#269675902">(Jan 28 2022 at 02:10)</a>:</h4>
<p>cfallin created <a href="https://github.com/bytecodealliance/wasmtime/pull/3697#discussion_r794152893">PR review comment</a>:</p>
<blockquote>
<p>Yup, good idea, I moved the bounds checks to helpers on the MemoryInitializer.</p>
</blockquote>



<a name="269675904"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%233697%20memfd/madvise-based%20CoW%20pooling%20alloc.../near/269675904" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.233697.20memfd.2Fmadvise-based.20CoW.20pooling.20alloc.2E.2E.2E.html#269675904">(Jan 28 2022 at 02:10)</a>:</h4>
<p>cfallin submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/3697#pullrequestreview-865630404">PR review</a>.</p>



<a name="269676008"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%233697%20memfd/madvise-based%20CoW%20pooling%20alloc.../near/269676008" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.233697.20memfd.2Fmadvise-based.20CoW.20pooling.20alloc.2E.2E.2E.html#269676008">(Jan 28 2022 at 02:10)</a>:</h4>
<p>cfallin submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/3697#pullrequestreview-865630574">PR review</a>.</p>



<a name="269676009"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%233697%20memfd/madvise-based%20CoW%20pooling%20alloc.../near/269676009" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.233697.20memfd.2Fmadvise-based.20CoW.20pooling.20alloc.2E.2E.2E.html#269676009">(Jan 28 2022 at 02:10)</a>:</h4>
<p>cfallin created <a href="https://github.com/bytecodealliance/wasmtime/pull/3697#discussion_r794153024">PR review comment</a>:</p>
<blockquote>
<p>OK, so I refactored this and it's not <em>significantly</em> simpler, but it is at least a little more straightforward.</p>
</blockquote>



<a name="269676062"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%233697%20memfd/madvise-based%20CoW%20pooling%20alloc.../near/269676062" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.233697.20memfd.2Fmadvise-based.20CoW.20pooling.20alloc.2E.2E.2E.html#269676062">(Jan 28 2022 at 02:10)</a>:</h4>
<p>cfallin submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/3697#pullrequestreview-865630650">PR review</a>.</p>



<a name="269676064"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%233697%20memfd/madvise-based%20CoW%20pooling%20alloc.../near/269676064" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.233697.20memfd.2Fmadvise-based.20CoW.20pooling.20alloc.2E.2E.2E.html#269676064">(Jan 28 2022 at 02:10)</a>:</h4>
<p>cfallin created <a href="https://github.com/bytecodealliance/wasmtime/pull/3697#discussion_r794153100">PR review comment</a>:</p>
<blockquote>
<p>Yup, good idea!</p>
</blockquote>



<a name="269677149"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%233697%20memfd/madvise-based%20CoW%20pooling%20alloc.../near/269677149" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.233697.20memfd.2Fmadvise-based.20CoW.20pooling.20alloc.2E.2E.2E.html#269677149">(Jan 28 2022 at 02:14)</a>:</h4>
<p>cfallin updated <a href="https://github.com/bytecodealliance/wasmtime/pull/3697">PR #3697</a> from <code>memfd-cow</code> to <code>main</code>.</p>



<a name="269677163"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%233697%20memfd/madvise-based%20CoW%20pooling%20alloc.../near/269677163" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.233697.20memfd.2Fmadvise-based.20CoW.20pooling.20alloc.2E.2E.2E.html#269677163">(Jan 28 2022 at 02:14)</a>:</h4>
<p>cfallin submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/3697#pullrequestreview-865632325">PR review</a>.</p>



<a name="269677166"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%233697%20memfd/madvise-based%20CoW%20pooling%20alloc.../near/269677166" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.233697.20memfd.2Fmadvise-based.20CoW.20pooling.20alloc.2E.2E.2E.html#269677166">(Jan 28 2022 at 02:14)</a>:</h4>
<p>cfallin created <a href="https://github.com/bytecodealliance/wasmtime/pull/3697#discussion_r794154410">PR review comment</a>:</p>
<blockquote>
<p>Done!</p>
</blockquote>



<a name="269677722"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%233697%20memfd/madvise-based%20CoW%20pooling%20alloc.../near/269677722" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.233697.20memfd.2Fmadvise-based.20CoW.20pooling.20alloc.2E.2E.2E.html#269677722">(Jan 28 2022 at 02:20)</a>:</h4>
<p>cfallin submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/3697#pullrequestreview-865634590">PR review</a>.</p>



<a name="269677723"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%233697%20memfd/madvise-based%20CoW%20pooling%20alloc.../near/269677723" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.233697.20memfd.2Fmadvise-based.20CoW.20pooling.20alloc.2E.2E.2E.html#269677723">(Jan 28 2022 at 02:20)</a>:</h4>
<p>cfallin created <a href="https://github.com/bytecodealliance/wasmtime/pull/3697#discussion_r794156261">PR review comment</a>:</p>
<blockquote>
<p>I like that approach, but I think it's a significant refactor of the code, including uffd code, because it's often not just a simple "approach A does this block, approach B does that block", but e.g. uffd or memfd adds just one variation.</p>
<p>I think this might make sense to do in a followup "remove all the static config by feature flags" PR -- I could both put uffd and memfd under dynamic config flags, and clean up the conditional compilation stuff at the same time. Would you mind if I punted until that?</p>
</blockquote>



<a name="269757971"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%233697%20memfd/madvise-based%20CoW%20pooling%20alloc.../near/269757971" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.233697.20memfd.2Fmadvise-based.20CoW.20pooling.20alloc.2E.2E.2E.html#269757971">(Jan 28 2022 at 16:00)</a>:</h4>
<p>alexcrichton submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/3697#pullrequestreview-866263030">PR review</a>.</p>



<a name="269757972"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%233697%20memfd/madvise-based%20CoW%20pooling%20alloc.../near/269757972" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.233697.20memfd.2Fmadvise-based.20CoW.20pooling.20alloc.2E.2E.2E.html#269757972">(Jan 28 2022 at 16:00)</a>:</h4>
<p>alexcrichton submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/3697#pullrequestreview-866263030">PR review</a>.</p>



<a name="269757973"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%233697%20memfd/madvise-based%20CoW%20pooling%20alloc.../near/269757973" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.233697.20memfd.2Fmadvise-based.20CoW.20pooling.20alloc.2E.2E.2E.html#269757973">(Jan 28 2022 at 16:00)</a>:</h4>
<p>alexcrichton created <a href="https://github.com/bytecodealliance/wasmtime/pull/3697#discussion_r794580662">PR review comment</a>:</p>
<blockquote>
<p>Could this be merged with <code>new_static</code> and it grows various arguments to match the contents of <code>Memory::Static</code>?</p>
<p>IIRC the <code>let base = match maximum { ... }</code> was non-trivial and I forgot it the first time I wrote something awhile back, so having it not-duplicated I think would be best.</p>
<p>If there's issues with <code>MemFdSlot</code> being conditionally defined I think it would be reasonable to have something like:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="cp">#[cfg(not(feature = </span><span class="s">"memfd-allocator"</span><span class="cp">))]</span><span class="w"></span>
<span class="k">enum</span> <span class="nc">MemFdSlot</span><span class="w"> </span><span class="p">{}</span><span class="w"></span>
</code></pre></div>
<p>which should make <code>Option&lt;MemFdSlot&gt;</code> a 0-sized struct and statically assert we don't try to actually create one. </p>
</blockquote>



<a name="269757974"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%233697%20memfd/madvise-based%20CoW%20pooling%20alloc.../near/269757974" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.233697.20memfd.2Fmadvise-based.20CoW.20pooling.20alloc.2E.2E.2E.html#269757974">(Jan 28 2022 at 16:00)</a>:</h4>
<p>alexcrichton created <a href="https://github.com/bytecodealliance/wasmtime/pull/3697#discussion_r794603695">PR review comment</a>:</p>
<blockquote>
<p>Could this use <code>u64::try_from(...).unwrap()</code>?</p>
<p>I realize it's much wordier but when it comes to dealing with memory I personally prefer to use fallible conversions for everything that's not necessarily immediately trivially obvious that it's a successful conversion (ideally having no <code>as</code> conversions at all but that's not always possible)</p>
</blockquote>



<a name="269757975"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%233697%20memfd/madvise-based%20CoW%20pooling%20alloc.../near/269757975" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.233697.20memfd.2Fmadvise-based.20CoW.20pooling.20alloc.2E.2E.2E.html#269757975">(Jan 28 2022 at 16:00)</a>:</h4>
<p>alexcrichton created <a href="https://github.com/bytecodealliance/wasmtime/pull/3697#discussion_r794592801">PR review comment</a>:</p>
<blockquote>
<p>I think we can actually avoid saving this internally since initialization below should I think take into account the specific module being instantiated. For example there's a call to <code>PrimaryMap::with_capacity(self.module_limits.memories as usize)</code> but that's not necessary if the module being instantiated has fewer memories than the limits.</p>
<p>I think this could probably be achieved by extracting <a href="https://github.com/bytecodealliance/wasmtime/blob/90bfa123e095371691c43679ae7c8f11380d8bf6/crates/runtime/src/instance/allocator.rs#L693-L711">this logic</a> to a helpe method and using that instead of the <code>initialize</code> method below perhaps?</p>
</blockquote>



<a name="269757976"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%233697%20memfd/madvise-based%20CoW%20pooling%20alloc.../near/269757976" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.233697.20memfd.2Fmadvise-based.20CoW.20pooling.20alloc.2E.2E.2E.html#269757976">(Jan 28 2022 at 16:00)</a>:</h4>
<p>alexcrichton created <a href="https://github.com/bytecodealliance/wasmtime/pull/3697#discussion_r794602375">PR review comment</a>:</p>
<blockquote>
<p>Along the same lines as the seals elsewhere, perhaps this could have a seal for writing to guarantee it's always zero? (IIRC the seal for writing doesn't affect shrinking/growth)</p>
</blockquote>



<a name="269757977"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%233697%20memfd/madvise-based%20CoW%20pooling%20alloc.../near/269757977" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.233697.20memfd.2Fmadvise-based.20CoW.20pooling.20alloc.2E.2E.2E.html#269757977">(Jan 28 2022 at 16:00)</a>:</h4>
<p>alexcrichton created <a href="https://github.com/bytecodealliance/wasmtime/pull/3697#discussion_r794588080">PR review comment</a>:</p>
<blockquote>
<p>The comment here about "Try to unregister" feels a bit misleading because this seems like there's less of an attempt here and more of a "this had better be gone" sort of feeling.</p>
<p>Additionally I'm not sure now that I think about it that this is the right place for this destructor. And actually now that I think for a moment I'm a bit confused about this design.</p>
<p>This design currently has a "registry" in an engine of memfds-per-module, but it seems like an alternative (and perhaps simpler?) design would be to store memfd information here in the <code>Module</code> itself. I see now that during the first instantiation of a module we create the memfd image if memfd is enabled, but it seems like that work would be best done at module-creation-time if memfd is enabled.</p>
<p>WIth per-module memfd information I think that would remove the need for a registry entirely?</p>
</blockquote>



<a name="269757978"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%233697%20memfd/madvise-based%20CoW%20pooling%20alloc.../near/269757978" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.233697.20memfd.2Fmadvise-based.20CoW.20pooling.20alloc.2E.2E.2E.html#269757978">(Jan 28 2022 at 16:00)</a>:</h4>
<p>alexcrichton created <a href="https://github.com/bytecodealliance/wasmtime/pull/3697#discussion_r794619617">PR review comment</a>:</p>
<blockquote>
<p>While I don't think this is really an issue this feels morally to me like the size here shouldn't include the guard size. I naively expect that the <code>MemFdSlot</code> is only responsible for the linear memory, and the guard pages are concerns of other layers of the stack.</p>
</blockquote>



<a name="269757979"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%233697%20memfd/madvise-based%20CoW%20pooling%20alloc.../near/269757979" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.233697.20memfd.2Fmadvise-based.20CoW.20pooling.20alloc.2E.2E.2E.html#269757979">(Jan 28 2022 at 16:00)</a>:</h4>
<p>alexcrichton created <a href="https://github.com/bytecodealliance/wasmtime/pull/3697#discussion_r794611606">PR review comment</a>:</p>
<blockquote>
<p>I commented below about error cases, but I think this is one error we're definitely not going to want to ignore. If the <code>madvise</code> fails for whatever reason I think that would definitely leak contents of memory between module instantiations which we don't want. On error here it seems like we should either panic to assert it's not actually happening or we discard the slot so the mappings are entirely redone on reuse.</p>
</blockquote>



<a name="269757980"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%233697%20memfd/madvise-based%20CoW%20pooling%20alloc.../near/269757980" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.233697.20memfd.2Fmadvise-based.20CoW.20pooling.20alloc.2E.2E.2E.html#269757980">(Jan 28 2022 at 16:00)</a>:</h4>
<p>alexcrichton created <a href="https://github.com/bytecodealliance/wasmtime/pull/3697#discussion_r794608867">PR review comment</a>:</p>
<blockquote>
<p>I understand the theoretical design behind this, but out of curiosity have you been able to benchmark the difference between <code>ftruncate</code> and just-map-anonymous-memory? </p>
</blockquote>



<a name="269757981"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%233697%20memfd/madvise-based%20CoW%20pooling%20alloc.../near/269757981" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.233697.20memfd.2Fmadvise-based.20CoW.20pooling.20alloc.2E.2E.2E.html#269757981">(Jan 28 2022 at 16:00)</a>:</h4>
<p>alexcrichton created <a href="https://github.com/bytecodealliance/wasmtime/pull/3697#discussion_r794604273">PR review comment</a>:</p>
<blockquote>
<p>FWIW you can avoid the "syntax salt" here with:</p>
<p><div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="w">         </span><span class="k">if</span><span class="w"> </span><span class="kd">let</span><span class="w"> </span><span class="nb">Some</span><span class="p">(</span><span class="n">existing_image</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&amp;</span><span class="bp">self</span><span class="p">.</span><span class="n">image</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
</code></pre></div><br>
</p>
</blockquote>



<a name="269757982"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%233697%20memfd/madvise-based%20CoW%20pooling%20alloc.../near/269757982" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.233697.20memfd.2Fmadvise-based.20CoW.20pooling.20alloc.2E.2E.2E.html#269757982">(Jan 28 2022 at 16:00)</a>:</h4>
<p>alexcrichton created <a href="https://github.com/bytecodealliance/wasmtime/pull/3697#discussion_r794620400">PR review comment</a>:</p>
<blockquote>
<p>One possible simplification is that we could remove this field and have the extension file always mapped for the entire size of the wasm heap. That way we wouldn't need to do subtraction or anything in the <code>set_heap_limit</code> method and could instead simply forward to <code>.set_len()</code>?</p>
</blockquote>



<a name="269757983"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%233697%20memfd/madvise-based%20CoW%20pooling%20alloc.../near/269757983" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.233697.20memfd.2Fmadvise-based.20CoW.20pooling.20alloc.2E.2E.2E.html#269757983">(Jan 28 2022 at 16:00)</a>:</h4>
<p>alexcrichton created <a href="https://github.com/bytecodealliance/wasmtime/pull/3697#discussion_r794610628">PR review comment</a>:</p>
<blockquote>
<p>Reading over this one concern I just had was "what happens if an error is returned and this flag isn't set?" </p>
<p>It looks like the <code>MemFdSlot</code> structure will be discarded and recreated the next time that it's requested (because <code>MemFdSlot</code> creation is lazy). To confirm, is that intended? </p>
<p>One possible idea I had is there could be a <code>Drop for MemFdSlot</code> which checks <code>self.dirty</code> and unmaps the information if it's there (and also setting <code>self.dirty = true</code> at the top of this function instead of at the end). I'm not sure if that really buys much benefit though.</p>
<p>In any case I was curious if you'd thought about the error case here and the impact it might have?</p>
</blockquote>



<a name="269757984"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%233697%20memfd/madvise-based%20CoW%20pooling%20alloc.../near/269757984" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.233697.20memfd.2Fmadvise-based.20CoW.20pooling.20alloc.2E.2E.2E.html#269757984">(Jan 28 2022 at 16:00)</a>:</h4>
<p>alexcrichton created <a href="https://github.com/bytecodealliance/wasmtime/pull/3697#discussion_r794622425">PR review comment</a>:</p>
<blockquote>
<p>I had a big comment about how this didn't seem to handle trailing zeros after the image, only leading zeros, which I ended up deleting because I believe that this does handle it and I just missed it in the documentation. </p>
<p>Could this explicitly call out the orderings the mmaps are done to indicate how overlapping regions are handled and the cow image will naturally be flanked by zero'd memory as necessary?</p>
</blockquote>



<a name="269757985"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%233697%20memfd/madvise-based%20CoW%20pooling%20alloc.../near/269757985" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.233697.20memfd.2Fmadvise-based.20CoW.20pooling.20alloc.2E.2E.2E.html#269757985">(Jan 28 2022 at 16:00)</a>:</h4>
<p>alexcrichton created <a href="https://github.com/bytecodealliance/wasmtime/pull/3697#discussion_r794629498">PR review comment</a>:</p>
<blockquote>
<p>If possible this is another place that I think would be best to share with the preexisting <code>set_instance_memories</code> method. It seems like this wants to share a fair bit of the logic and only tweaks things by acquiring a memfd slot, and that seems like it could be done in a more surgical #[cfg]'d fashion instead of duplicating the whole method.</p>
</blockquote>



<a name="269757986"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%233697%20memfd/madvise-based%20CoW%20pooling%20alloc.../near/269757986" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.233697.20memfd.2Fmadvise-based.20CoW.20pooling.20alloc.2E.2E.2E.html#269757986">(Jan 28 2022 at 16:00)</a>:</h4>
<p>alexcrichton created <a href="https://github.com/bytecodealliance/wasmtime/pull/3697#discussion_r794595130">PR review comment</a>:</p>
<blockquote>
<p>Could this use <code>memory_plans.iter()</code> and ... I forget the method name but I'm sure we have one to convert from <code>MemoryIndex</code> to <code>DefinedMemoryIndex</code> ... to avoid using <code>from_u32</code>?</p>
</blockquote>



<a name="269757987"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%233697%20memfd/madvise-based%20CoW%20pooling%20alloc.../near/269757987" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.233697.20memfd.2Fmadvise-based.20CoW.20pooling.20alloc.2E.2E.2E.html#269757987">(Jan 28 2022 at 16:00)</a>:</h4>
<p>alexcrichton created <a href="https://github.com/bytecodealliance/wasmtime/pull/3697#discussion_r794589168">PR review comment</a>:</p>
<blockquote>
<p>That all sounds like really solid reasoning to me, thanks for the comment!</p>
</blockquote>



<a name="269757988"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%233697%20memfd/madvise-based%20CoW%20pooling%20alloc.../near/269757988" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.233697.20memfd.2Fmadvise-based.20CoW.20pooling.20alloc.2E.2E.2E.html#269757988">(Jan 28 2022 at 16:00)</a>:</h4>
<p>alexcrichton created <a href="https://github.com/bytecodealliance/wasmtime/pull/3697#discussion_r794624686">PR review comment</a>:</p>
<blockquote>
<p>Reading over this again I realize that this feels a bit out-of-sync with uffd because uffd also wants to skip memory initialization but this "skip the init" check is in a different location than the uffd one.</p>
<p>Could the check for uffd get moved over to <a href="https://github.com/bytecodealliance/wasmtime/blob/921fb6c73e4443ac534e9d4477d9f8cab318c166/crates/runtime/src/instance/allocator/pooling.rs#L1299-L1326">https://github.com/bytecodealliance/wasmtime/blob/921fb6c73e4443ac534e9d4477d9f8cab318c166/crates/runtime/src/instance/allocator/pooling.rs#L1299-L1326</a> so "skip memory init" is only in one location?</p>
</blockquote>



<a name="269757990"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%233697%20memfd/madvise-based%20CoW%20pooling%20alloc.../near/269757990" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.233697.20memfd.2Fmadvise-based.20CoW.20pooling.20alloc.2E.2E.2E.html#269757990">(Jan 28 2022 at 16:00)</a>:</h4>
<p>alexcrichton created <a href="https://github.com/bytecodealliance/wasmtime/pull/3697#discussion_r794627868">PR review comment</a>:</p>
<blockquote>
<p>Oh also one thing I forgot from earlier, I feel like this wants to do the same thing as uffd ("just call madvise") but it's done in a different fashion. I think that this location (which currently madvise's manually and then <code>continue</code>s to skip further logic) would be a good place to try to better unify what uffd and memfd are doing. Ideally this could fall through to the shared call to <code>decommit_memory_pages</code> or something like that, or otherwise make it more clear that uffd and memfd are doing roughly similar things.</p>
</blockquote>



<a name="269757991"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%233697%20memfd/madvise-based%20CoW%20pooling%20alloc.../near/269757991" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.233697.20memfd.2Fmadvise-based.20CoW.20pooling.20alloc.2E.2E.2E.html#269757991">(Jan 28 2022 at 16:00)</a>:</h4>
<p>alexcrichton created <a href="https://github.com/bytecodealliance/wasmtime/pull/3697#discussion_r794582112">PR review comment</a>:</p>
<blockquote>
<p>I actually think that having this conditionally-defined type would be useful for other things as well, it would remove all the <code>#[cfg]</code> below with something like:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="k">impl</span><span class="w"> </span><span class="n">MemFdSlot</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">fn</span> <span class="nf">has_image</span><span class="p">(</span><span class="o">&amp;</span><span class="bp">self</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="kt">bool</span> <span class="p">{</span><span class="w"> </span><span class="k">match</span><span class="w"> </span><span class="bp">self</span><span class="w"> </span><span class="p">{}</span><span class="w"> </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="k">fn</span> <span class="nf">set_heap_limit</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="bp">self</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nb">Result</span><span class="o">&lt;</span><span class="p">()</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="k">match</span><span class="w"> </span><span class="bp">self</span><span class="w"> </span><span class="p">{}</span><span class="w"> </span><span class="p">}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>
<p>(etc)</p>
</blockquote>



<a name="269757992"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%233697%20memfd/madvise-based%20CoW%20pooling%20alloc.../near/269757992" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.233697.20memfd.2Fmadvise-based.20CoW.20pooling.20alloc.2E.2E.2E.html#269757992">(Jan 28 2022 at 16:00)</a>:</h4>
<p>alexcrichton created <a href="https://github.com/bytecodealliance/wasmtime/pull/3697#discussion_r794588684">PR review comment</a>:</p>
<blockquote>
<p>One other benefit of moving information out of the <code>Engine</code> is that it would avoid bouncing on a lock every time an instantiation is made which can be somewhat expensive </p>
</blockquote>



<a name="269757994"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%233697%20memfd/madvise-based%20CoW%20pooling%20alloc.../near/269757994" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.233697.20memfd.2Fmadvise-based.20CoW.20pooling.20alloc.2E.2E.2E.html#269757994">(Jan 28 2022 at 16:00)</a>:</h4>
<p>alexcrichton created <a href="https://github.com/bytecodealliance/wasmtime/pull/3697#discussion_r794624989">PR review comment</a>:</p>
<blockquote>
<p>(I think this also means the change below to <code>initialize_instance</code> can be reverted as well)</p>
</blockquote>



<a name="269809905"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%233697%20memfd/madvise-based%20CoW%20pooling%20alloc.../near/269809905" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.233697.20memfd.2Fmadvise-based.20CoW.20pooling.20alloc.2E.2E.2E.html#269809905">(Jan 28 2022 at 22:11)</a>:</h4>
<p>cfallin submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/3697#pullrequestreview-866754950">PR review</a>.</p>



<a name="269809906"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%233697%20memfd/madvise-based%20CoW%20pooling%20alloc.../near/269809906" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.233697.20memfd.2Fmadvise-based.20CoW.20pooling.20alloc.2E.2E.2E.html#269809906">(Jan 28 2022 at 22:11)</a>:</h4>
<p>cfallin created <a href="https://github.com/bytecodealliance/wasmtime/pull/3697#discussion_r794922088">PR review comment</a>:</p>
<blockquote>
<p>Ah, this refactor is so much nicer. I did this for <code>MemFdSlot</code> and also the <code>ModuleMemFds</code> below (just a zero-sized type if memfd support is not included).</p>
</blockquote>



<a name="269809950"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%233697%20memfd/madvise-based%20CoW%20pooling%20alloc.../near/269809950" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.233697.20memfd.2Fmadvise-based.20CoW.20pooling.20alloc.2E.2E.2E.html#269809950">(Jan 28 2022 at 22:11)</a>:</h4>
<p>cfallin submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/3697#pullrequestreview-866755233">PR review</a>.</p>



<a name="269809951"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%233697%20memfd/madvise-based%20CoW%20pooling%20alloc.../near/269809951" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.233697.20memfd.2Fmadvise-based.20CoW.20pooling.20alloc.2E.2E.2E.html#269809951">(Jan 28 2022 at 22:11)</a>:</h4>
<p>cfallin created <a href="https://github.com/bytecodealliance/wasmtime/pull/3697#discussion_r794922337">PR review comment</a>:</p>
<blockquote>
<p>Good point -- there actually was no need for a registry system at all. I've made the <code>wasmtime::Module</code> own the memfd images. Thanks!</p>
</blockquote>



<a name="269811806"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%233697%20memfd/madvise-based%20CoW%20pooling%20alloc.../near/269811806" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.233697.20memfd.2Fmadvise-based.20CoW.20pooling.20alloc.2E.2E.2E.html#269811806">(Jan 28 2022 at 22:25)</a>:</h4>
<p>cfallin updated <a href="https://github.com/bytecodealliance/wasmtime/pull/3697">PR #3697</a> from <code>memfd-cow</code> to <code>main</code>.</p>



<a name="269816890"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%233697%20memfd/madvise-based%20CoW%20pooling%20alloc.../near/269816890" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.233697.20memfd.2Fmadvise-based.20CoW.20pooling.20alloc.2E.2E.2E.html#269816890">(Jan 28 2022 at 23:17)</a>:</h4>
<p>cfallin updated <a href="https://github.com/bytecodealliance/wasmtime/pull/3697">PR #3697</a> from <code>memfd-cow</code> to <code>main</code>.</p>



<a name="269816951"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%233697%20memfd/madvise-based%20CoW%20pooling%20alloc.../near/269816951" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.233697.20memfd.2Fmadvise-based.20CoW.20pooling.20alloc.2E.2E.2E.html#269816951">(Jan 28 2022 at 23:18)</a>:</h4>
<p>cfallin submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/3697#pullrequestreview-866790200">PR review</a>.</p>



<a name="269816952"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%233697%20memfd/madvise-based%20CoW%20pooling%20alloc.../near/269816952" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.233697.20memfd.2Fmadvise-based.20CoW.20pooling.20alloc.2E.2E.2E.html#269816952">(Jan 28 2022 at 23:18)</a>:</h4>
<p>cfallin created <a href="https://github.com/bytecodealliance/wasmtime/pull/3697#discussion_r794949319">PR review comment</a>:</p>
<blockquote>
<p>Done -- extracted a common core between this and the on-demand allocator to build a raw <code>Instance</code>.</p>
</blockquote>



<a name="269816980"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%233697%20memfd/madvise-based%20CoW%20pooling%20alloc.../near/269816980" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.233697.20memfd.2Fmadvise-based.20CoW.20pooling.20alloc.2E.2E.2E.html#269816980">(Jan 28 2022 at 23:18)</a>:</h4>
<p>cfallin submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/3697#pullrequestreview-866790412">PR review</a>.</p>



<a name="269816981"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%233697%20memfd/madvise-based%20CoW%20pooling%20alloc.../near/269816981" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.233697.20memfd.2Fmadvise-based.20CoW.20pooling.20alloc.2E.2E.2E.html#269816981">(Jan 28 2022 at 23:18)</a>:</h4>
<p>cfallin created <a href="https://github.com/bytecodealliance/wasmtime/pull/3697#discussion_r794949488">PR review comment</a>:</p>
<blockquote>
<p>Ah, yes, I'm using <code>.values()</code> here but the default <code>.iter()</code> on a <code>PrimaryMap</code> gives us an iterator that actually just gives the keys (the strong index type) directly. Much nicer.</p>
</blockquote>



<a name="269816989"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%233697%20memfd/madvise-based%20CoW%20pooling%20alloc.../near/269816989" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.233697.20memfd.2Fmadvise-based.20CoW.20pooling.20alloc.2E.2E.2E.html#269816989">(Jan 28 2022 at 23:18)</a>:</h4>
<p>cfallin submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/3697#pullrequestreview-866790455">PR review</a>.</p>



<a name="269816990"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%233697%20memfd/madvise-based%20CoW%20pooling%20alloc.../near/269816990" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.233697.20memfd.2Fmadvise-based.20CoW.20pooling.20alloc.2E.2E.2E.html#269816990">(Jan 28 2022 at 23:18)</a>:</h4>
<p>cfallin created <a href="https://github.com/bytecodealliance/wasmtime/pull/3697#discussion_r794949517">PR review comment</a>:</p>
<blockquote>
<p>Done!</p>
</blockquote>



<a name="269817008"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%233697%20memfd/madvise-based%20CoW%20pooling%20alloc.../near/269817008" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.233697.20memfd.2Fmadvise-based.20CoW.20pooling.20alloc.2E.2E.2E.html#269817008">(Jan 28 2022 at 23:18)</a>:</h4>
<p>cfallin submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/3697#pullrequestreview-866790513">PR review</a>.</p>



<a name="269817009"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%233697%20memfd/madvise-based%20CoW%20pooling%20alloc.../near/269817009" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.233697.20memfd.2Fmadvise-based.20CoW.20pooling.20alloc.2E.2E.2E.html#269817009">(Jan 28 2022 at 23:18)</a>:</h4>
<p>cfallin created <a href="https://github.com/bytecodealliance/wasmtime/pull/3697#discussion_r794949551">PR review comment</a>:</p>
<blockquote>
<p>Done!</p>
</blockquote>



<a name="269817205"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%233697%20memfd/madvise-based%20CoW%20pooling%20alloc.../near/269817205" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.233697.20memfd.2Fmadvise-based.20CoW.20pooling.20alloc.2E.2E.2E.html#269817205">(Jan 28 2022 at 23:20)</a>:</h4>
<p>cfallin updated <a href="https://github.com/bytecodealliance/wasmtime/pull/3697">PR #3697</a> from <code>memfd-cow</code> to <code>main</code>.</p>



<a name="269817268"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%233697%20memfd/madvise-based%20CoW%20pooling%20alloc.../near/269817268" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.233697.20memfd.2Fmadvise-based.20CoW.20pooling.20alloc.2E.2E.2E.html#269817268">(Jan 28 2022 at 23:21)</a>:</h4>
<p>cfallin submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/3697#pullrequestreview-866791625">PR review</a>.</p>



<a name="269817269"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%233697%20memfd/madvise-based%20CoW%20pooling%20alloc.../near/269817269" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.233697.20memfd.2Fmadvise-based.20CoW.20pooling.20alloc.2E.2E.2E.html#269817269">(Jan 28 2022 at 23:21)</a>:</h4>
<p>cfallin created <a href="https://github.com/bytecodealliance/wasmtime/pull/3697#discussion_r794950364">PR review comment</a>:</p>
<blockquote>
<p>That's my old-school (pre-2016 or something?) Rust showing... but then look who I'm talking to :-)</p>
<p>(I actually kinda like the explicitness and the lack of magic in the pattern-matching with precise matching <code>&amp;</code>s and <code>ref</code>s, but maybe my brain's internal typechecker is just weird...)</p>
</blockquote>



<a name="269818160"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%233697%20memfd/madvise-based%20CoW%20pooling%20alloc.../near/269818160" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.233697.20memfd.2Fmadvise-based.20CoW.20pooling.20alloc.2E.2E.2E.html#269818160">(Jan 28 2022 at 23:31)</a>:</h4>
<p>cfallin updated <a href="https://github.com/bytecodealliance/wasmtime/pull/3697">PR #3697</a> from <code>memfd-cow</code> to <code>main</code>.</p>



<a name="269818316"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%233697%20memfd/madvise-based%20CoW%20pooling%20alloc.../near/269818316" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.233697.20memfd.2Fmadvise-based.20CoW.20pooling.20alloc.2E.2E.2E.html#269818316">(Jan 28 2022 at 23:33)</a>:</h4>
<p>cfallin submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/3697#pullrequestreview-866796370">PR review</a>.</p>



<a name="269818317"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%233697%20memfd/madvise-based%20CoW%20pooling%20alloc.../near/269818317" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.233697.20memfd.2Fmadvise-based.20CoW.20pooling.20alloc.2E.2E.2E.html#269818317">(Jan 28 2022 at 23:33)</a>:</h4>
<p>cfallin created <a href="https://github.com/bytecodealliance/wasmtime/pull/3697#discussion_r794954117">PR review comment</a>:</p>
<blockquote>
<p>That's a very good point. I think the safest answer to this is that if some mmap error occurs within the big mmap used by the pooling allocator for all memories, all bets are off and our only safe/secure option is to panic the process. Otherwise, unless we can carefully reason about why the remapping failed, we have a slot that is permanently unusable, so the system is degraded (slots die over time due to errors and we have no way of replacing them). And we have no way to return an error from an individual instantiation that means "I not only failed allocation but blew up the allocator... please throw everything away and start over". So, replaced with <code>.expect()</code>. If you have other ideas here though I'm very curious!</p>
</blockquote>



<a name="269818595"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%233697%20memfd/madvise-based%20CoW%20pooling%20alloc.../near/269818595" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.233697.20memfd.2Fmadvise-based.20CoW.20pooling.20alloc.2E.2E.2E.html#269818595">(Jan 28 2022 at 23:36)</a>:</h4>
<p>cfallin submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/3697#pullrequestreview-866797638">PR review</a>.</p>



<a name="269818596"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%233697%20memfd/madvise-based%20CoW%20pooling%20alloc.../near/269818596" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.233697.20memfd.2Fmadvise-based.20CoW.20pooling.20alloc.2E.2E.2E.html#269818596">(Jan 28 2022 at 23:36)</a>:</h4>
<p>cfallin created <a href="https://github.com/bytecodealliance/wasmtime/pull/3697#discussion_r794955048">PR review comment</a>:</p>
<blockquote>
<p>I have not; avoided that due to the use of the global mmap lock by <code>mprotect()</code>, taking the fact that we <em>should</em> avoid that on received wisdom / experience from earlier pooling-allocator folks. It would be interesting to see exactly how much it matters for different workloads, and there is indeed a tradeoff (in that the CoW-of-memfd memory is slower, as we've discovered).</p>
</blockquote>



<a name="269818918"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%233697%20memfd/madvise-based%20CoW%20pooling%20alloc.../near/269818918" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.233697.20memfd.2Fmadvise-based.20CoW.20pooling.20alloc.2E.2E.2E.html#269818918">(Jan 28 2022 at 23:40)</a>:</h4>
<p>cfallin submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/3697#pullrequestreview-866798916">PR review</a>.</p>



<a name="269818920"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%233697%20memfd/madvise-based%20CoW%20pooling%20alloc.../near/269818920" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.233697.20memfd.2Fmadvise-based.20CoW.20pooling.20alloc.2E.2E.2E.html#269818920">(Jan 28 2022 at 23:40)</a>:</h4>
<p>cfallin created <a href="https://github.com/bytecodealliance/wasmtime/pull/3697#discussion_r794956142">PR review comment</a>:</p>
<blockquote>
<p>As above, made this panic the process if it fails, since such a failure leaves the whole pooling allocator in an unknown state.</p>
<p>Re: uffd -- this gets to the bigger question of how much we can share, but: given that (i) <em>just</em> enough stuff differs in the details between what memfd does and uffd does, and (ii) uffd may go away if memfd works better, I'm somewhat hesitant to refactor to try to share more logic when it's not an easy/simple change. It starts to get into the territory of "clean up uffd", which feels out-of-scope for this PR.  My experience with trying to share too much logic as well is that sometimes it becomes hard to see through all the conditionals, and it can actually be simpler to maintain when the two disjoint approaches are kept separate. (See e.g. Cranelift backends and separate instruction lowering rules, vs. big mess of conditional logic. Not exactly the same, but similar in spirit.)</p>
</blockquote>



<a name="269818982"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%233697%20memfd/madvise-based%20CoW%20pooling%20alloc.../near/269818982" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.233697.20memfd.2Fmadvise-based.20CoW.20pooling.20alloc.2E.2E.2E.html#269818982">(Jan 28 2022 at 23:41)</a>:</h4>
<p>cfallin submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/3697#pullrequestreview-866799218">PR review</a>.</p>



<a name="269818983"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%233697%20memfd/madvise-based%20CoW%20pooling%20alloc.../near/269818983" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.233697.20memfd.2Fmadvise-based.20CoW.20pooling.20alloc.2E.2E.2E.html#269818983">(Jan 28 2022 at 23:41)</a>:</h4>
<p>cfallin created <a href="https://github.com/bytecodealliance/wasmtime/pull/3697#discussion_r794956373">PR review comment</a>:</p>
<blockquote>
<p>Yeah, I agree in principle; this is just following how the rest of the pooling allocator works. Could definitely be cleaned up in a followup.</p>
</blockquote>



<a name="269819127"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%233697%20memfd/madvise-based%20CoW%20pooling%20alloc.../near/269819127" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.233697.20memfd.2Fmadvise-based.20CoW.20pooling.20alloc.2E.2E.2E.html#269819127">(Jan 28 2022 at 23:43)</a>:</h4>
<p>cfallin created <a href="https://github.com/bytecodealliance/wasmtime/pull/3697#discussion_r794956835">PR review comment</a>:</p>
<blockquote>
<p>We could, yeah; the reason I did it this way was to avoid potentially wasting resources. (The part of the file shadowed by the initial heap size will be a "hole", but there may still be a small resource cost in tracking per-page info or things like that.)</p>
</blockquote>



<a name="269819128"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%233697%20memfd/madvise-based%20CoW%20pooling%20alloc.../near/269819128" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.233697.20memfd.2Fmadvise-based.20CoW.20pooling.20alloc.2E.2E.2E.html#269819128">(Jan 28 2022 at 23:43)</a>:</h4>
<p>cfallin submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/3697#pullrequestreview-866799815">PR review</a>.</p>



<a name="269819189"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%233697%20memfd/madvise-based%20CoW%20pooling%20alloc.../near/269819189" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.233697.20memfd.2Fmadvise-based.20CoW.20pooling.20alloc.2E.2E.2E.html#269819189">(Jan 28 2022 at 23:44)</a>:</h4>
<p>cfallin submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/3697#pullrequestreview-866800103">PR review</a>.</p>



<a name="269819190"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%233697%20memfd/madvise-based%20CoW%20pooling%20alloc.../near/269819190" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.233697.20memfd.2Fmadvise-based.20CoW.20pooling.20alloc.2E.2E.2E.html#269819190">(Jan 28 2022 at 23:44)</a>:</h4>
<p>cfallin created <a href="https://github.com/bytecodealliance/wasmtime/pull/3697#discussion_r794957057">PR review comment</a>:</p>
<blockquote>
<p>As mentioned above, I'm a little wary of this PR becoming "let's refactor and clean up all of uffd while we're at it". If we have issues with uffd's design, perhaps we could save them for another PR?</p>
</blockquote>



<a name="269819274"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%233697%20memfd/madvise-based%20CoW%20pooling%20alloc.../near/269819274" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.233697.20memfd.2Fmadvise-based.20CoW.20pooling.20alloc.2E.2E.2E.html#269819274">(Jan 28 2022 at 23:44)</a>:</h4>
<p>cfallin submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/3697#pullrequestreview-866800343">PR review</a>.</p>



<a name="269819275"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%233697%20memfd/madvise-based%20CoW%20pooling%20alloc.../near/269819275" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.233697.20memfd.2Fmadvise-based.20CoW.20pooling.20alloc.2E.2E.2E.html#269819275">(Jan 28 2022 at 23:44)</a>:</h4>
<p>cfallin created <a href="https://github.com/bytecodealliance/wasmtime/pull/3697#discussion_r794957231">PR review comment</a>:</p>
<blockquote>
<p>I unified this with the above, given the conditional-at-the-lowest-level strategy you outlined -- thanks a bunch for that, it's much cleaner now!</p>
</blockquote>



<a name="269819523"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%233697%20memfd/madvise-based%20CoW%20pooling%20alloc.../near/269819523" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.233697.20memfd.2Fmadvise-based.20CoW.20pooling.20alloc.2E.2E.2E.html#269819523">(Jan 28 2022 at 23:47)</a>:</h4>
<p>cfallin submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/3697#pullrequestreview-866801305">PR review</a>.</p>



<a name="269819524"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%233697%20memfd/madvise-based%20CoW%20pooling%20alloc.../near/269819524" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.233697.20memfd.2Fmadvise-based.20CoW.20pooling.20alloc.2E.2E.2E.html#269819524">(Jan 28 2022 at 23:47)</a>:</h4>
<p>cfallin created <a href="https://github.com/bytecodealliance/wasmtime/pull/3697#discussion_r794958075">PR review comment</a>:</p>
<blockquote>
<p>Done!</p>
</blockquote>



<a name="269819526"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%233697%20memfd/madvise-based%20CoW%20pooling%20alloc.../near/269819526" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.233697.20memfd.2Fmadvise-based.20CoW.20pooling.20alloc.2E.2E.2E.html#269819526">(Jan 28 2022 at 23:47)</a>:</h4>
<p>cfallin updated <a href="https://github.com/bytecodealliance/wasmtime/pull/3697">PR #3697</a> from <code>memfd-cow</code> to <code>main</code>.</p>



<a name="269819830"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%233697%20memfd/madvise-based%20CoW%20pooling%20alloc.../near/269819830" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.233697.20memfd.2Fmadvise-based.20CoW.20pooling.20alloc.2E.2E.2E.html#269819830">(Jan 28 2022 at 23:50)</a>:</h4>
<p>cfallin updated <a href="https://github.com/bytecodealliance/wasmtime/pull/3697">PR #3697</a> from <code>memfd-cow</code> to <code>main</code>.</p>



<a name="269822996"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%233697%20memfd/madvise-based%20CoW%20pooling%20alloc.../near/269822996" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.233697.20memfd.2Fmadvise-based.20CoW.20pooling.20alloc.2E.2E.2E.html#269822996">(Jan 29 2022 at 00:23)</a>:</h4>
<p>cfallin updated <a href="https://github.com/bytecodealliance/wasmtime/pull/3697">PR #3697</a> from <code>memfd-cow</code> to <code>main</code>.</p>



<a name="270053897"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%233697%20memfd/madvise-based%20CoW%20pooling%20alloc.../near/270053897" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.233697.20memfd.2Fmadvise-based.20CoW.20pooling.20alloc.2E.2E.2E.html#270053897">(Jan 31 2022 at 15:55)</a>:</h4>
<p>alexcrichton submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/3697#pullrequestreview-868058501">PR review</a>.</p>



<a name="270053899"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%233697%20memfd/madvise-based%20CoW%20pooling%20alloc.../near/270053899" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.233697.20memfd.2Fmadvise-based.20CoW.20pooling.20alloc.2E.2E.2E.html#270053899">(Jan 31 2022 at 15:55)</a>:</h4>
<p>alexcrichton created <a href="https://github.com/bytecodealliance/wasmtime/pull/3697#discussion_r795811516">PR review comment</a>:</p>
<blockquote>
<p>Oh I'm happy to panic the process in these cases, I just wasn't sure what the intention was. I agree that panicking is the best option here.</p>
</blockquote>



<a name="270054626"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%233697%20memfd/madvise-based%20CoW%20pooling%20alloc.../near/270054626" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.233697.20memfd.2Fmadvise-based.20CoW.20pooling.20alloc.2E.2E.2E.html#270054626">(Jan 31 2022 at 15:59)</a>:</h4>
<p>alexcrichton submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/3697#pullrequestreview-868064160">PR review</a>.</p>



<a name="270054627"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%233697%20memfd/madvise-based%20CoW%20pooling%20alloc.../near/270054627" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.233697.20memfd.2Fmadvise-based.20CoW.20pooling.20alloc.2E.2E.2E.html#270054627">(Jan 31 2022 at 15:59)</a>:</h4>
<p>alexcrichton created <a href="https://github.com/bytecodealliance/wasmtime/pull/3697#discussion_r795815519">PR review comment</a>:</p>
<blockquote>
<p>Nah I think that makes sense to not clean up uffd while you're here, but this feels like a relatively easy thing to do in that there's already a location for uffd where we skip memory initialization, and intentionally not using that location (when I think it works right?) for memfd feels odd</p>
</blockquote>



<a name="270059355"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%233697%20memfd/madvise-based%20CoW%20pooling%20alloc.../near/270059355" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.233697.20memfd.2Fmadvise-based.20CoW.20pooling.20alloc.2E.2E.2E.html#270059355">(Jan 31 2022 at 16:23)</a>:</h4>
<p>alexcrichton submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/3697#pullrequestreview-868067971">PR review</a>.</p>



<a name="270059356"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%233697%20memfd/madvise-based%20CoW%20pooling%20alloc.../near/270059356" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.233697.20memfd.2Fmadvise-based.20CoW.20pooling.20alloc.2E.2E.2E.html#270059356">(Jan 31 2022 at 16:23)</a>:</h4>
<p>alexcrichton submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/3697#pullrequestreview-868067971">PR review</a>.</p>



<a name="270059358"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%233697%20memfd/madvise-based%20CoW%20pooling%20alloc.../near/270059358" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.233697.20memfd.2Fmadvise-based.20CoW.20pooling.20alloc.2E.2E.2E.html#270059358">(Jan 31 2022 at 16:23)</a>:</h4>
<p>alexcrichton created <a href="https://github.com/bytecodealliance/wasmtime/pull/3697#discussion_r795818194">PR review comment</a>:</p>
<blockquote>
<p>I think the <code>.expect</code> can be removed here and the <code>base</code> check above removed in favor of moving the <code>match</code> to here?</p>
</blockquote>



<a name="270059359"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%233697%20memfd/madvise-based%20CoW%20pooling%20alloc.../near/270059359" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.233697.20memfd.2Fmadvise-based.20CoW.20pooling.20alloc.2E.2E.2E.html#270059359">(Jan 31 2022 at 16:23)</a>:</h4>
<p>alexcrichton created <a href="https://github.com/bytecodealliance/wasmtime/pull/3697#discussion_r795819776">PR review comment</a>:</p>
<blockquote>
<p>If this is still necessary then I think this should be done at a lower level where it's more obvious which field causes the automatic inference to not work and a comment can say why this is needed.</p>
</blockquote>



<a name="270059360"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%233697%20memfd/madvise-based%20CoW%20pooling%20alloc.../near/270059360" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.233697.20memfd.2Fmadvise-based.20CoW.20pooling.20alloc.2E.2E.2E.html#270059360">(Jan 31 2022 at 16:23)</a>:</h4>
<p>alexcrichton created <a href="https://github.com/bytecodealliance/wasmtime/pull/3697#discussion_r795830087">PR review comment</a>:</p>
<blockquote>
<p>This organization seems a bit odd where I would expect the "dummy" implementation and the real implementation to live roughly in the same area, similarly they would also theoretically mirror the dummy/real implementation of <code>ModuleMemFds</code>. Could there perhaps be <code>crates/runtime/src/memfd.rs</code> and <code>crates/runtime/src/memfd_disabled.rs</code> which have all the structs and all the dummy structs?</p>
<p>(unsure if this <code>MemFdSlot</code> needs to be defined in this file)</p>
</blockquote>



<a name="270059361"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%233697%20memfd/madvise-based%20CoW%20pooling%20alloc.../near/270059361" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.233697.20memfd.2Fmadvise-based.20CoW.20pooling.20alloc.2E.2E.2E.html#270059361">(Jan 31 2022 at 16:23)</a>:</h4>
<p>alexcrichton created <a href="https://github.com/bytecodealliance/wasmtime/pull/3697#discussion_r795824679">PR review comment</a>:</p>
<blockquote>
<p>I think where possible it's best to replace this with something like <code>match self {}</code> which the compiler will allow since <code>self</code> is an empty enum and is a good way of showing that this is statically not reachable.</p>
</blockquote>



<a name="270059362"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%233697%20memfd/madvise-based%20CoW%20pooling%20alloc.../near/270059362" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.233697.20memfd.2Fmadvise-based.20CoW.20pooling.20alloc.2E.2E.2E.html#270059362">(Jan 31 2022 at 16:23)</a>:</h4>
<p>alexcrichton created <a href="https://github.com/bytecodealliance/wasmtime/pull/3697#discussion_r795827060">PR review comment</a>:</p>
<blockquote>
<p>Well to some extent I don't really think this needs a major refactoring. While ideally we have <code>MemoryKind</code> variants or something like that what we have today in this PR is two <code>Memory</code> variants where one has fields which configures uffd or memfd if they're enabled. I think that this logic in this particular loop can still be structured as "here's an arm for each case" as opposed to "memfd is special and gets the early-<code>continue</code>". I was originally confused reading this loop because the loop always ends with <code>madvise</code>  and it sort of seems like memfd doesn't end with <code>madvise</code> when it in fact does.</p>
</blockquote>



<a name="270059363"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%233697%20memfd/madvise-based%20CoW%20pooling%20alloc.../near/270059363" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.233697.20memfd.2Fmadvise-based.20CoW.20pooling.20alloc.2E.2E.2E.html#270059363">(Jan 31 2022 at 16:23)</a>:</h4>
<p>alexcrichton created <a href="https://github.com/bytecodealliance/wasmtime/pull/3697#discussion_r795833797">PR review comment</a>:</p>
<blockquote>
<p>I feel like our error handling here is sort of half-measures in the sense that if this initialization fails then an abort happens but if <code>Memory::new_static</code> fails below it's bubbled up and handled. In an error below (or later for a memory afterwards) it seems like it would still result in dropping the <code>MemFdSlot</code> which itself doesn't do any cleanup and leaves the slot in a somewhat indeterminate state?</p>
<p>In some sense this may not be the end of the world really about having an indeterminate state because allocation of a memfd slot here always redoes the entire mapping for the entire memory, so if something is "leaked" it's only temporary in the sense that no wasm will be using that slot?</p>
</blockquote>



<a name="270083015"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%233697%20memfd/madvise-based%20CoW%20pooling%20alloc.../near/270083015" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.233697.20memfd.2Fmadvise-based.20CoW.20pooling.20alloc.2E.2E.2E.html#270083015">(Jan 31 2022 at 18:45)</a>:</h4>
<p>cfallin updated <a href="https://github.com/bytecodealliance/wasmtime/pull/3697">PR #3697</a> from <code>memfd-cow</code> to <code>main</code>.</p>



<a name="270083035"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%233697%20memfd/madvise-based%20CoW%20pooling%20alloc.../near/270083035" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.233697.20memfd.2Fmadvise-based.20CoW.20pooling.20alloc.2E.2E.2E.html#270083035">(Jan 31 2022 at 18:45)</a>:</h4>
<p>cfallin updated <a href="https://github.com/bytecodealliance/wasmtime/pull/3697">PR #3697</a> from <code>memfd-cow</code> to <code>main</code>.</p>



<a name="270083044"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%233697%20memfd/madvise-based%20CoW%20pooling%20alloc.../near/270083044" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.233697.20memfd.2Fmadvise-based.20CoW.20pooling.20alloc.2E.2E.2E.html#270083044">(Jan 31 2022 at 18:45)</a>:</h4>
<p>cfallin submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/3697#pullrequestreview-868276788">PR review</a>.</p>



<a name="270083045"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%233697%20memfd/madvise-based%20CoW%20pooling%20alloc.../near/270083045" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.233697.20memfd.2Fmadvise-based.20CoW.20pooling.20alloc.2E.2E.2E.html#270083045">(Jan 31 2022 at 18:45)</a>:</h4>
<p>cfallin created <a href="https://github.com/bytecodealliance/wasmtime/pull/3697#discussion_r795963240">PR review comment</a>:</p>
<blockquote>
<p>Done!</p>
</blockquote>



<a name="270083103"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%233697%20memfd/madvise-based%20CoW%20pooling%20alloc.../near/270083103" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.233697.20memfd.2Fmadvise-based.20CoW.20pooling.20alloc.2E.2E.2E.html#270083103">(Jan 31 2022 at 18:46)</a>:</h4>
<p>cfallin submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/3697#pullrequestreview-868277486">PR review</a>.</p>



<a name="270083105"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%233697%20memfd/madvise-based%20CoW%20pooling%20alloc.../near/270083105" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.233697.20memfd.2Fmadvise-based.20CoW.20pooling.20alloc.2E.2E.2E.html#270083105">(Jan 31 2022 at 18:46)</a>:</h4>
<p>cfallin created <a href="https://github.com/bytecodealliance/wasmtime/pull/3697#discussion_r795963544">PR review comment</a>:</p>
<blockquote>
<p>Ah, it no longer is, now that we're taking the more idiomatic pass-ownership-of-<code>MemFdSlot</code> approach. Removed!</p>
</blockquote>



<a name="270083156"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%233697%20memfd/madvise-based%20CoW%20pooling%20alloc.../near/270083156" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.233697.20memfd.2Fmadvise-based.20CoW.20pooling.20alloc.2E.2E.2E.html#270083156">(Jan 31 2022 at 18:46)</a>:</h4>
<p>cfallin submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/3697#pullrequestreview-868277580">PR review</a>.</p>



<a name="270083157"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%233697%20memfd/madvise-based%20CoW%20pooling%20alloc.../near/270083157" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.233697.20memfd.2Fmadvise-based.20CoW.20pooling.20alloc.2E.2E.2E.html#270083157">(Jan 31 2022 at 18:46)</a>:</h4>
<p>cfallin created <a href="https://github.com/bytecodealliance/wasmtime/pull/3697#discussion_r795963619">PR review comment</a>:</p>
<blockquote>
<p>Done!</p>
</blockquote>



<a name="270083220"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%233697%20memfd/madvise-based%20CoW%20pooling%20alloc.../near/270083220" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.233697.20memfd.2Fmadvise-based.20CoW.20pooling.20alloc.2E.2E.2E.html#270083220">(Jan 31 2022 at 18:46)</a>:</h4>
<p>cfallin submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/3697#pullrequestreview-868278209">PR review</a>.</p>



<a name="270083221"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%233697%20memfd/madvise-based%20CoW%20pooling%20alloc.../near/270083221" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.233697.20memfd.2Fmadvise-based.20CoW.20pooling.20alloc.2E.2E.2E.html#270083221">(Jan 31 2022 at 18:46)</a>:</h4>
<p>cfallin created <a href="https://github.com/bytecodealliance/wasmtime/pull/3697#discussion_r795964028">PR review comment</a>:</p>
<blockquote>
<p>Ah, right, this wasn't nearly as much a refactor as I thought; sorry! Done.</p>
</blockquote>



<a name="270083330"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%233697%20memfd/madvise-based%20CoW%20pooling%20alloc.../near/270083330" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.233697.20memfd.2Fmadvise-based.20CoW.20pooling.20alloc.2E.2E.2E.html#270083330">(Jan 31 2022 at 18:47)</a>:</h4>
<p>cfallin submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/3697#pullrequestreview-868278998">PR review</a>.</p>



<a name="270083333"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%233697%20memfd/madvise-based%20CoW%20pooling%20alloc.../near/270083333" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.233697.20memfd.2Fmadvise-based.20CoW.20pooling.20alloc.2E.2E.2E.html#270083333">(Jan 31 2022 at 18:47)</a>:</h4>
<p>cfallin created <a href="https://github.com/bytecodealliance/wasmtime/pull/3697#discussion_r795964780">PR review comment</a>:</p>
<blockquote>
<p>Done! This cleans up things sigificantly; <a href="http://pooling.rs">pooling.rs</a> has almost no memfd-conditional stuff left.</p>
</blockquote>



<a name="270084367"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%233697%20memfd/madvise-based%20CoW%20pooling%20alloc.../near/270084367" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.233697.20memfd.2Fmadvise-based.20CoW.20pooling.20alloc.2E.2E.2E.html#270084367">(Jan 31 2022 at 18:52)</a>:</h4>
<p>cfallin submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/3697#pullrequestreview-868283921">PR review</a>.</p>



<a name="270084370"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%233697%20memfd/madvise-based%20CoW%20pooling%20alloc.../near/270084370" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.233697.20memfd.2Fmadvise-based.20CoW.20pooling.20alloc.2E.2E.2E.html#270084370">(Jan 31 2022 at 18:52)</a>:</h4>
<p>cfallin created <a href="https://github.com/bytecodealliance/wasmtime/pull/3697#discussion_r795968906">PR review comment</a>:</p>
<blockquote>
<p>That's a good point. On thinking about this further:</p>
<ul>
<li>
<p>If instantiation bails out after we've initialized the MemFdSlot (which can happen, e.g., if the resource-limiter says "no") then it's most idiomatic to just drop the slot object and let the pool create a new one later.</p>
</li>
<li>
<p>The most important thing -- the only thing I can think of that would absolutely require us to panic the process -- is that we don't let some other mmap ASLR its way into a gap in the pooling allocator's region if we leave a hole somewhere during instantiation. But we already avoid that, to prevent exactly that race condition; so even if the MemFdSlot fails, say, the second of 3 mmaps, we are still covering/reserving the whole range.</p>
</li>
<li>
<p>Given that, I think it's fine to drop the MemFdSlot at any point.</p>
</li>
<li>
<p>For an extra layer of {sanity, avoiding resource leaks e.g. keeping a memfd image alive, defense-in-depth-don't-map-more-than-we-need}, it is still nice to try to remove a stale mapping. I've written a <code>Drop</code> handler for <code>MemFdSlot</code> that does this in a best-effort way: it tries to map anonymous memory with <code>PROT_NONE</code> over the whole slot. It uses <code>NORESERVE</code> to make this more likely to succeed. But if it doesn't, the error is explicitly ignored (with a comment in the source to describe why safe): nothing is <em>supposed</em> to touch the slot anyway until the next <code>MemFdSlot</code> is created for it, and if mapping something into the slot fails again later for the new <code>MemFdSlot</code>, then it has the proper avenues to bubble up the error at that time.</p>
</li>
</ul>
<p>Does that seem reasonable?</p>
</blockquote>



<a name="270088438"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%233697%20memfd/madvise-based%20CoW%20pooling%20alloc.../near/270088438" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.233697.20memfd.2Fmadvise-based.20CoW.20pooling.20alloc.2E.2E.2E.html#270088438">(Jan 31 2022 at 19:15)</a>:</h4>
<p>cfallin updated <a href="https://github.com/bytecodealliance/wasmtime/pull/3697">PR #3697</a> from <code>memfd-cow</code> to <code>main</code>.</p>



<a name="270090946"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%233697%20memfd/madvise-based%20CoW%20pooling%20alloc.../near/270090946" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.233697.20memfd.2Fmadvise-based.20CoW.20pooling.20alloc.2E.2E.2E.html#270090946">(Jan 31 2022 at 19:31)</a>:</h4>
<p>cfallin submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/3697#pullrequestreview-868327835">PR review</a>.</p>



<a name="270090947"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%233697%20memfd/madvise-based%20CoW%20pooling%20alloc.../near/270090947" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.233697.20memfd.2Fmadvise-based.20CoW.20pooling.20alloc.2E.2E.2E.html#270090947">(Jan 31 2022 at 19:31)</a>:</h4>
<p>cfallin created <a href="https://github.com/bytecodealliance/wasmtime/pull/3697#discussion_r795999087">PR review comment</a>:</p>
<blockquote>
<p>I tried cleaning this up a bit, but it's really subtle and I'm getting lost in the corner cases of paged-vs-segment initialization mode, bulk memory and the need to trap at just the right point. In any case it's not a simple refactor. I can spend a few more hours on understanding this and unraveling it if we think we need it but it feels sort of pointless if we're possibly going to remove uffd soon :-)</p>
</blockquote>



<a name="270103006"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%233697%20memfd/madvise-based%20CoW%20pooling%20alloc.../near/270103006" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.233697.20memfd.2Fmadvise-based.20CoW.20pooling.20alloc.2E.2E.2E.html#270103006">(Jan 31 2022 at 20:54)</a>:</h4>
<p>cfallin updated <a href="https://github.com/bytecodealliance/wasmtime/pull/3697">PR #3697</a> from <code>memfd-cow</code> to <code>main</code>.</p>



<a name="270112103"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%233697%20memfd/madvise-based%20CoW%20pooling%20alloc.../near/270112103" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.233697.20memfd.2Fmadvise-based.20CoW.20pooling.20alloc.2E.2E.2E.html#270112103">(Jan 31 2022 at 22:00)</a>:</h4>
<p>cfallin updated <a href="https://github.com/bytecodealliance/wasmtime/pull/3697">PR #3697</a> from <code>memfd-cow</code> to <code>main</code>.</p>



<a name="270123397"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%233697%20memfd/madvise-based%20CoW%20pooling%20alloc.../near/270123397" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.233697.20memfd.2Fmadvise-based.20CoW.20pooling.20alloc.2E.2E.2E.html#270123397">(Jan 31 2022 at 23:18)</a>:</h4>
<p>alexcrichton submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/3697#pullrequestreview-868452845">PR review</a>.</p>



<a name="270123398"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%233697%20memfd/madvise-based%20CoW%20pooling%20alloc.../near/270123398" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.233697.20memfd.2Fmadvise-based.20CoW.20pooling.20alloc.2E.2E.2E.html#270123398">(Jan 31 2022 at 23:18)</a>:</h4>
<p>alexcrichton created <a href="https://github.com/bytecodealliance/wasmtime/pull/3697#discussion_r796135883">PR review comment</a>:</p>
<blockquote>
<p>as a minor nit the traits in rustix seem like you could probably pass <code>image.fd.as_file()</code> below as the <code>fd</code> argument rather than creating a new <code>BorrowedFd</code> structure (although I haven't used rustix, just a hunch)</p>
</blockquote>



<a name="270123399"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%233697%20memfd/madvise-based%20CoW%20pooling%20alloc.../near/270123399" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.233697.20memfd.2Fmadvise-based.20CoW.20pooling.20alloc.2E.2E.2E.html#270123399">(Jan 31 2022 at 23:18)</a>:</h4>
<p>alexcrichton created <a href="https://github.com/bytecodealliance/wasmtime/pull/3697#discussion_r796089624">PR review comment</a>:</p>
<blockquote>
<p>One thing I think we might want to do here is to have an explicit flag (off by default) which disables this destructor behavior and we could set the flag from the pool to skip this since it's all about to get unmapped anyway.</p>
<p>Otherwise though the difference between this destructor and <code>instantiate</code> got me thinking. I think that there's a bug right now that can leak the initial memory from one module to another? When a slot is reused all the memory is accessible but reset back to the previous image, but the new anonymous mapping for the new heap might be smaller than the previous image, and subsequent heap grows simply mprotect the preexisting pages into existence, which I think means that the previous module's memory image may leak into the next.</p>
<p>Otherwise though I'd naively expect that the destructor here shares common code with the <code>instantiate</code> step (when the hot path isn't taken) where there's a step to clear out all vma mappings with this map anonymous call (although I don't entirely know what the the difference is with an mmap that has <code>NORESERVE</code> vs <code>PROT_NONE</code>) </p>
</blockquote>



<a name="270123400"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%233697%20memfd/madvise-based%20CoW%20pooling%20alloc.../near/270123400" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.233697.20memfd.2Fmadvise-based.20CoW.20pooling.20alloc.2E.2E.2E.html#270123400">(Jan 31 2022 at 23:18)</a>:</h4>
<p>alexcrichton submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/3697#pullrequestreview-868452845">PR review</a>.</p>



<a name="270123401"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%233697%20memfd/madvise-based%20CoW%20pooling%20alloc.../near/270123401" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.233697.20memfd.2Fmadvise-based.20CoW.20pooling.20alloc.2E.2E.2E.html#270123401">(Jan 31 2022 at 23:18)</a>:</h4>
<p>alexcrichton created <a href="https://github.com/bytecodealliance/wasmtime/pull/3697#discussion_r796136132">PR review comment</a>:</p>
<blockquote>
<p>as a minor nit I was originally thinking that this and <code>runtime/src/memfd.rs</code> would be the same file, in further effort to reduce the number of <code>#[cfg]</code> necessary</p>
</blockquote>



<a name="270123402"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%233697%20memfd/madvise-based%20CoW%20pooling%20alloc.../near/270123402" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.233697.20memfd.2Fmadvise-based.20CoW.20pooling.20alloc.2E.2E.2E.html#270123402">(Jan 31 2022 at 23:18)</a>:</h4>
<p>alexcrichton created <a href="https://github.com/bytecodealliance/wasmtime/pull/3697#discussion_r796139248">PR review comment</a>:</p>
<blockquote>
<p>Unlike the <code>Static</code> variant of memory I think we might be able to skip the storage here entirely (and also make the <code>instantiate</code> a litte faster below with fewer syscalls) since with a runtime memory all memfd really is is the initial mapping of the cow image overlaid on top of the underlying anonymous mapping. In that sense I think we can skip most of the logic of <code>MemFdSlot</code> and avoid storing redundant data.</p>
<p>Now that being said I think the implementation here is correct and will work well regardless. I think it'd be fine for a follow-up to clean this up a bit. </p>
</blockquote>



<a name="270123404"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%233697%20memfd/madvise-based%20CoW%20pooling%20alloc.../near/270123404" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.233697.20memfd.2Fmadvise-based.20CoW.20pooling.20alloc.2E.2E.2E.html#270123404">(Jan 31 2022 at 23:18)</a>:</h4>
<p>alexcrichton created <a href="https://github.com/bytecodealliance/wasmtime/pull/3697#discussion_r796142270">PR review comment</a>:</p>
<blockquote>
<p>Given where this PR now is and the trajectory of this feature, I think this is good to have as an optional dependency but I think it should be enabled by default and probably just called <code>memfd</code> (enabled-by-default probably from the <code>wasmtime</code> crate, not here). Especially with this making such a drastric difference for the on-demand allocator it seems like using <code>memfd</code> is a no-brainer.</p>
<p>To make this tweak as well as improve the portability here (right now if you enable <code>memfd</code> on Windows it'd probably just fail to compile) I think a few small changes are all that's needed. To be clear though this is icing on the cake and it's totally fine to do this as a follow-up, but I think the steps would be:</p>
<ul>
<li>Remove the <code>memfd-allocator</code></li>
<li>Add a <code>memfd</code> feature to the <code>wasmtime</code> crate that forwards to <code>wasmtime-runtime/memfd</code></li>
<li>Add <code>memfd</code> to the default feature set of the <code>wasmtime</code> crate</li>
<li>Add a <code>crates/runtime/build.rs</code> that detects that the target's os is Linux (by looking at <code>CARGO_CFG_TARGET_OS</code>) and that the <code>memfd</code> feature is active (by looking at <code>CARGO_FEATURE_MEMFD</code>), and if both are present then printing <code>println!("cargo:rustc-cfg=memfd")</code></li>
<li>Change all <code>cfg(feature = "memfd-allocator")</code> in the crate to <code>cfg(memfd)</code></li>
</ul>
<p>With that I think we'll have on-by-default memfd for Linux-only, with the opt-in ability to turn it off. Again though it's fine to defer this to a future PR.</p>
<p>As I type all this out though I also would question maybe we don't even need a feature for this. I suppose one thing that could come up is that if you have a million modules in a process that's a million file descriptors which can blow kernel limits, but other than that I'm not sure why anyone would explicitly want to disable memfd.</p>
</blockquote>



<a name="270125839"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%233697%20memfd/madvise-based%20CoW%20pooling%20alloc.../near/270125839" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.233697.20memfd.2Fmadvise-based.20CoW.20pooling.20alloc.2E.2E.2E.html#270125839">(Jan 31 2022 at 23:43)</a>:</h4>
<p>cfallin submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/3697#pullrequestreview-868545169">PR review</a>.</p>



<a name="270125840"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%233697%20memfd/madvise-based%20CoW%20pooling%20alloc.../near/270125840" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.233697.20memfd.2Fmadvise-based.20CoW.20pooling.20alloc.2E.2E.2E.html#270125840">(Jan 31 2022 at 23:43)</a>:</h4>
<p>cfallin created <a href="https://github.com/bytecodealliance/wasmtime/pull/3697#discussion_r796159354">PR review comment</a>:</p>
<blockquote>
<p>Ah, so I <em>think</em> this bug does not exist, because on <code>instantiate</code>, in the different-module case, we remap all memory from the start of heap up to <code>static_size</code> (in practice 6GiB) with anonymous zeroes (<a href="https://github.com/bytecodealliance/wasmtime/pull/3697/files#diff-1dfa6bf73de63a505980e54c117396b2afb02acda2e4490b750f94f12d12c150R133-R137">here</a>) -- this will wipe all previous mappings. We then <code>mprotect</code> everything beyond the initial heap size to <code>PROT_NONE</code>.</p>
<p>Re: the other bits (sharing clearing logic) that's a good point though and I'll clean this up a bit!</p>
</blockquote>



<a name="270128606"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%233697%20memfd/madvise-based%20CoW%20pooling%20alloc.../near/270128606" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.233697.20memfd.2Fmadvise-based.20CoW.20pooling.20alloc.2E.2E.2E.html#270128606">(Feb 01 2022 at 00:07)</a>:</h4>
<p>cfallin submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/3697#pullrequestreview-868557904">PR review</a>.</p>



<a name="270128609"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%233697%20memfd/madvise-based%20CoW%20pooling%20alloc.../near/270128609" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.233697.20memfd.2Fmadvise-based.20CoW.20pooling.20alloc.2E.2E.2E.html#270128609">(Feb 01 2022 at 00:07)</a>:</h4>
<p>cfallin created <a href="https://github.com/bytecodealliance/wasmtime/pull/3697#discussion_r796169372">PR review comment</a>:</p>
<blockquote>
<p>... and, actually there was a bug, but a bit more subtle: the initial anonymous mmap was surrounded by <code>if initial_size &gt; 0</code> rather than a hypothetical <code>if static_size &gt; 0</code>. The former may be false if the memory starts with zero size then grows; the latter is always true in any valid config (so we can make it unconditional). Thanks for poking at this!</p>
</blockquote>



<a name="270128995"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%233697%20memfd/madvise-based%20CoW%20pooling%20alloc.../near/270128995" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.233697.20memfd.2Fmadvise-based.20CoW.20pooling.20alloc.2E.2E.2E.html#270128995">(Feb 01 2022 at 00:11)</a>:</h4>
<p>cfallin submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/3697#pullrequestreview-868560002">PR review</a>.</p>



<a name="270128996"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%233697%20memfd/madvise-based%20CoW%20pooling%20alloc.../near/270128996" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.233697.20memfd.2Fmadvise-based.20CoW.20pooling.20alloc.2E.2E.2E.html#270128996">(Feb 01 2022 at 00:11)</a>:</h4>
<p>cfallin created <a href="https://github.com/bytecodealliance/wasmtime/pull/3697#discussion_r796171036">PR review comment</a>:</p>
<blockquote>
<p>I played with this a bit, and it's a good thought! I think though it may be safer to go through the <code>MemFdSlot</code> for heap growth specifically in case we choose to implement some other technique (such as ftruncate on a second memfd) in the future. At least if I'm reading your suggestion right, otherwise, we'd use the <code>MemFdSlot</code>'s <code>instantiate</code> logic to set up the actual CoW mapping then throw it away (without its dtor running) and rely on the implicit alignment of the <code>mprotect</code>-growth strategy between memfd and the usual dynamic memory.</p>
<p>Re: syscalls on instantiate, we could indeed avoid one if we give the <code>MemFdSlot</code> a "no fixed mapping" mode, but then it takes responsibility for the pre-guard too, which complicates the pooling implementation somewhat. I'll think a bit more about this though.</p>
</blockquote>



<a name="270129019"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%233697%20memfd/madvise-based%20CoW%20pooling%20alloc.../near/270129019" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.233697.20memfd.2Fmadvise-based.20CoW.20pooling.20alloc.2E.2E.2E.html#270129019">(Feb 01 2022 at 00:11)</a>:</h4>
<p>cfallin updated <a href="https://github.com/bytecodealliance/wasmtime/pull/3697">PR #3697</a> from <code>memfd-cow</code> to <code>main</code>.</p>



<a name="270129022"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%233697%20memfd/madvise-based%20CoW%20pooling%20alloc.../near/270129022" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.233697.20memfd.2Fmadvise-based.20CoW.20pooling.20alloc.2E.2E.2E.html#270129022">(Feb 01 2022 at 00:11)</a>:</h4>
<p>cfallin submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/3697#pullrequestreview-868560169">PR review</a>.</p>



<a name="270129024"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%233697%20memfd/madvise-based%20CoW%20pooling%20alloc.../near/270129024" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.233697.20memfd.2Fmadvise-based.20CoW.20pooling.20alloc.2E.2E.2E.html#270129024">(Feb 01 2022 at 00:11)</a>:</h4>
<p>cfallin created <a href="https://github.com/bytecodealliance/wasmtime/pull/3697#discussion_r796171168">PR review comment</a>:</p>
<blockquote>
<p>Good call, thanks!</p>
</blockquote>



<a name="270129035"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%233697%20memfd/madvise-based%20CoW%20pooling%20alloc.../near/270129035" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.233697.20memfd.2Fmadvise-based.20CoW.20pooling.20alloc.2E.2E.2E.html#270129035">(Feb 01 2022 at 00:11)</a>:</h4>
<p>cfallin submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/3697#pullrequestreview-868560229">PR review</a>.</p>



<a name="270129036"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%233697%20memfd/madvise-based%20CoW%20pooling%20alloc.../near/270129036" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.233697.20memfd.2Fmadvise-based.20CoW.20pooling.20alloc.2E.2E.2E.html#270129036">(Feb 01 2022 at 00:11)</a>:</h4>
<p>cfallin created <a href="https://github.com/bytecodealliance/wasmtime/pull/3697#discussion_r796171203">PR review comment</a>:</p>
<blockquote>
<p>Fixed!</p>
</blockquote>



<a name="270132004"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%233697%20memfd/madvise-based%20CoW%20pooling%20alloc.../near/270132004" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.233697.20memfd.2Fmadvise-based.20CoW.20pooling.20alloc.2E.2E.2E.html#270132004">(Feb 01 2022 at 00:40)</a>:</h4>
<p>cfallin updated <a href="https://github.com/bytecodealliance/wasmtime/pull/3697">PR #3697</a> from <code>memfd-cow</code> to <code>main</code>.</p>



<a name="270132048"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%233697%20memfd/madvise-based%20CoW%20pooling%20alloc.../near/270132048" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.233697.20memfd.2Fmadvise-based.20CoW.20pooling.20alloc.2E.2E.2E.html#270132048">(Feb 01 2022 at 00:41)</a>:</h4>
<p>cfallin submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/3697#pullrequestreview-868574472">PR review</a>.</p>



<a name="270132049"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%233697%20memfd/madvise-based%20CoW%20pooling%20alloc.../near/270132049" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.233697.20memfd.2Fmadvise-based.20CoW.20pooling.20alloc.2E.2E.2E.html#270132049">(Feb 01 2022 at 00:41)</a>:</h4>
<p>cfallin created <a href="https://github.com/bytecodealliance/wasmtime/pull/3697#discussion_r796182865">PR review comment</a>:</p>
<blockquote>
<p>Yes, good point; I've moved everything into one <code>memfd.rs</code> in <code>runtime/src/</code> (and <code>memfd_disabled.rs</code> alongside it).</p>
</blockquote>



<a name="270134466"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%233697%20memfd/madvise-based%20CoW%20pooling%20alloc.../near/270134466" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.233697.20memfd.2Fmadvise-based.20CoW.20pooling.20alloc.2E.2E.2E.html#270134466">(Feb 01 2022 at 01:05)</a>:</h4>
<p>cfallin updated <a href="https://github.com/bytecodealliance/wasmtime/pull/3697">PR #3697</a> from <code>memfd-cow</code> to <code>main</code>.</p>



<a name="270134733"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%233697%20memfd/madvise-based%20CoW%20pooling%20alloc.../near/270134733" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.233697.20memfd.2Fmadvise-based.20CoW.20pooling.20alloc.2E.2E.2E.html#270134733">(Feb 01 2022 at 01:07)</a>:</h4>
<p>cfallin submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/3697#pullrequestreview-868586791">PR review</a>.</p>



<a name="270134734"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%233697%20memfd/madvise-based%20CoW%20pooling%20alloc.../near/270134734" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.233697.20memfd.2Fmadvise-based.20CoW.20pooling.20alloc.2E.2E.2E.html#270134734">(Feb 01 2022 at 01:07)</a>:</h4>
<p>cfallin created <a href="https://github.com/bytecodealliance/wasmtime/pull/3697#discussion_r796192844">PR review comment</a>:</p>
<blockquote>
<p>I've gone ahead and done all of this; the default build now will use memfd, validated by building the <code>wasmtime</code> binary and strace'ing an execution. Waiting for CI to see if moving <code>memfd</code> out of the target-only deps into the main deps will work on non-Linux, but I am hoping it will (the crate's got a toplevel <code>#![cfg(target_os ...)]</code> that should make it a no-op on other platforms...?).</p>
</blockquote>



<a name="270135299"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%233697%20memfd/madvise-based%20CoW%20pooling%20alloc.../near/270135299" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.233697.20memfd.2Fmadvise-based.20CoW.20pooling.20alloc.2E.2E.2E.html#270135299">(Feb 01 2022 at 01:13)</a>:</h4>
<p>cfallin updated <a href="https://github.com/bytecodealliance/wasmtime/pull/3697">PR #3697</a> from <code>memfd-cow</code> to <code>main</code>.</p>



<a name="270155416"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%233697%20memfd/madvise-based%20CoW%20pooling%20alloc.../near/270155416" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.233697.20memfd.2Fmadvise-based.20CoW.20pooling.20alloc.2E.2E.2E.html#270155416">(Feb 01 2022 at 05:26)</a>:</h4>
<p>cfallin updated <a href="https://github.com/bytecodealliance/wasmtime/pull/3697">PR #3697</a> from <code>memfd-cow</code> to <code>main</code>.</p>



<a name="270158214"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%233697%20memfd/madvise-based%20CoW%20pooling%20alloc.../near/270158214" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.233697.20memfd.2Fmadvise-based.20CoW.20pooling.20alloc.2E.2E.2E.html#270158214">(Feb 01 2022 at 06:12)</a>:</h4>
<p>cfallin updated <a href="https://github.com/bytecodealliance/wasmtime/pull/3697">PR #3697</a> from <code>memfd-cow</code> to <code>main</code>.</p>



<a name="270159945"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%233697%20memfd/madvise-based%20CoW%20pooling%20alloc.../near/270159945" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.233697.20memfd.2Fmadvise-based.20CoW.20pooling.20alloc.2E.2E.2E.html#270159945">(Feb 01 2022 at 06:39)</a>:</h4>
<p>cfallin updated <a href="https://github.com/bytecodealliance/wasmtime/pull/3697">PR #3697</a> from <code>memfd-cow</code> to <code>main</code>.</p>



<a name="270276590"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%233697%20memfd/madvise-based%20CoW%20pooling%20alloc.../near/270276590" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.233697.20memfd.2Fmadvise-based.20CoW.20pooling.20alloc.2E.2E.2E.html#270276590">(Feb 01 2022 at 20:05)</a>:</h4>
<p>alexcrichton submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/3697#pullrequestreview-869291462">PR review</a>.</p>



<a name="270276591"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%233697%20memfd/madvise-based%20CoW%20pooling%20alloc.../near/270276591" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.233697.20memfd.2Fmadvise-based.20CoW.20pooling.20alloc.2E.2E.2E.html#270276591">(Feb 01 2022 at 20:05)</a>:</h4>
<p>alexcrichton created <a href="https://github.com/bytecodealliance/wasmtime/pull/3697#discussion_r796710036">PR review comment</a>:</p>
<blockquote>
<p>Since there's a <code>pooling-allocator</code> feature below I think that this and <code>memfd</code> can probably be removed from the feature set here, but adding <code>pooling-allocator</code> to the default set of features seems pretty reasonable to me.</p>
</blockquote>



<a name="270276592"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%233697%20memfd/madvise-based%20CoW%20pooling%20alloc.../near/270276592" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.233697.20memfd.2Fmadvise-based.20CoW.20pooling.20alloc.2E.2E.2E.html#270276592">(Feb 01 2022 at 20:05)</a>:</h4>
<p>alexcrichton created <a href="https://github.com/bytecodealliance/wasmtime/pull/3697#discussion_r796956173">PR review comment</a>:</p>
<blockquote>
<p>One of my worries is that there's a fair bit of tricky state with handling linear memories and having that duplicated across a few locations I think is not ideal. The <code>MemFdSlot</code> tries to take over a fair bit of the management of the memory which is also tracked by the runtime <code>Memory</code>. We discussed this a bit in person as well, but to reiterate here I think it might be good to investigate a bit to figure out whether some functions below could grow an extra parameter or two instead of storing the state internally so it could be passed in by the "source of truth". </p>
<p>I don't have a great idea though for whether this is possible, so I'll leave it up to your discretion about whether it ends up working out or not.</p>
</blockquote>



<a name="270276593"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%233697%20memfd/madvise-based%20CoW%20pooling%20alloc.../near/270276593" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.233697.20memfd.2Fmadvise-based.20CoW.20pooling.20alloc.2E.2E.2E.html#270276593">(Feb 01 2022 at 20:05)</a>:</h4>
<p>alexcrichton created <a href="https://github.com/bytecodealliance/wasmtime/pull/3697#discussion_r796709164">PR review comment</a>:</p>
<blockquote>
<p>Since memfd can be used without the pooling allocator now is this condition still necessary? (other than disabling memfd when uffd is enabled)</p>
</blockquote>



<a name="270276594"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%233697%20memfd/madvise-based%20CoW%20pooling%20alloc.../near/270276594" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.233697.20memfd.2Fmadvise-based.20CoW.20pooling.20alloc.2E.2E.2E.html#270276594">(Feb 01 2022 at 20:05)</a>:</h4>
<p>alexcrichton submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/3697#pullrequestreview-869291462">PR review</a>.</p>



<a name="270276595"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%233697%20memfd/madvise-based%20CoW%20pooling%20alloc.../near/270276595" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.233697.20memfd.2Fmadvise-based.20CoW.20pooling.20alloc.2E.2E.2E.html#270276595">(Feb 01 2022 at 20:05)</a>:</h4>
<p>alexcrichton created <a href="https://github.com/bytecodealliance/wasmtime/pull/3697#discussion_r796714657">PR review comment</a>:</p>
<blockquote>
<p>Out of curiosity with the current <code>#[cfg]</code> system is this still necessary? With memfd on-by-default now this otherwise runs the risk of suppressing, by default, dead code warnings. (I think though that with the current organization the warnings here should be much less and/or easier to deal with)</p>
</blockquote>



<a name="270276596"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%233697%20memfd/madvise-based%20CoW%20pooling%20alloc.../near/270276596" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.233697.20memfd.2Fmadvise-based.20CoW.20pooling.20alloc.2E.2E.2E.html#270276596">(Feb 01 2022 at 20:05)</a>:</h4>
<p>alexcrichton created <a href="https://github.com/bytecodealliance/wasmtime/pull/3697#discussion_r796747566">PR review comment</a>:</p>
<blockquote>
<p>I think that this path may still perform a few extra syscalls that aren't necesary, and in local benchmarking this isn't super-significant in the profile but it still seems nontrivial (~5% ish). </p>
<p>The <code>MemFdSlot::instantiate</code> method will mmap the whole memory as read/write, overwriting the <code>Mmap::accessible_reserved</code> above followed by <code>mmap.make_accessible()</code>. The <code>mmap</code> for the cow image is then done, finally followed by an <code>mprotect</code> to make everything past the end inaccessible. I think that the only mmap needed in this case, without replacing the above calls to <code>Mmap</code>, is the one for the cow image.</p>
<p>This is probably still faster than what we have today, though, so if you'd prefer this can get deferred to later.</p>
</blockquote>



<a name="270276597"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%233697%20memfd/madvise-based%20CoW%20pooling%20alloc.../near/270276597" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.233697.20memfd.2Fmadvise-based.20CoW.20pooling.20alloc.2E.2E.2E.html#270276597">(Feb 01 2022 at 20:05)</a>:</h4>
<p>alexcrichton created <a href="https://github.com/bytecodealliance/wasmtime/pull/3697#discussion_r796716027">PR review comment</a>:</p>
<blockquote>
<p>It's guaranteed that both <code>offset</code> and <code>len</code> are multiples of page sizes, right? (just confirming)</p>
</blockquote>



<a name="270276598"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%233697%20memfd/madvise-based%20CoW%20pooling%20alloc.../near/270276598" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.233697.20memfd.2Fmadvise-based.20CoW.20pooling.20alloc.2E.2E.2E.html#270276598">(Feb 01 2022 at 20:05)</a>:</h4>
<p>alexcrichton created <a href="https://github.com/bytecodealliance/wasmtime/pull/3697#discussion_r796957506">PR review comment</a>:</p>
<blockquote>
<p>Random thought that just occured to me, since we're doing fd equality matching here do we actually still need a compiled module id? I originally thought that was going to be used for this but now that I look at this again I see it not being used. I forget though if the compiled module id is actually used for anything else at this point in time though.</p>
</blockquote>



<a name="270276599"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%233697%20memfd/madvise-based%20CoW%20pooling%20alloc.../near/270276599" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.233697.20memfd.2Fmadvise-based.20CoW.20pooling.20alloc.2E.2E.2E.html#270276599">(Feb 01 2022 at 20:05)</a>:</h4>
<p>alexcrichton created <a href="https://github.com/bytecodealliance/wasmtime/pull/3697#discussion_r796713450">PR review comment</a>:</p>
<blockquote>
<p>I think this could actually use <code>.get_mut()</code> to bypass the <code>.lock()</code> since we've got mutable access to the contents at this point.</p>
</blockquote>



<a name="270276600"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%233697%20memfd/madvise-based%20CoW%20pooling%20alloc.../near/270276600" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.233697.20memfd.2Fmadvise-based.20CoW.20pooling.20alloc.2E.2E.2E.html#270276600">(Feb 01 2022 at 20:05)</a>:</h4>
<p>alexcrichton created <a href="https://github.com/bytecodealliance/wasmtime/pull/3697#discussion_r796726030">PR review comment</a>:</p>
<blockquote>
<p>I think this is fine to be a safe function since this isn't related to Rust's memory safety and is more of a defense-in-depth mechanism.</p>
</blockquote>



<a name="270276601"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%233697%20memfd/madvise-based%20CoW%20pooling%20alloc.../near/270276601" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.233697.20memfd.2Fmadvise-based.20CoW.20pooling.20alloc.2E.2E.2E.html#270276601">(Feb 01 2022 at 20:05)</a>:</h4>
<p>alexcrichton created <a href="https://github.com/bytecodealliance/wasmtime/pull/3697#discussion_r796723183">PR review comment</a>:</p>
<blockquote>
<p>I think <code>pooling-allocator</code> can be dropped here?</p>
</blockquote>



<a name="270281199"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%233697%20memfd/madvise-based%20CoW%20pooling%20alloc.../near/270281199" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.233697.20memfd.2Fmadvise-based.20CoW.20pooling.20alloc.2E.2E.2E.html#270281199">(Feb 01 2022 at 20:35)</a>:</h4>
<p>cfallin submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/3697#pullrequestreview-869800133">PR review</a>.</p>



<a name="270281200"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%233697%20memfd/madvise-based%20CoW%20pooling%20alloc.../near/270281200" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.233697.20memfd.2Fmadvise-based.20CoW.20pooling.20alloc.2E.2E.2E.html#270281200">(Feb 01 2022 at 20:35)</a>:</h4>
<p>cfallin created <a href="https://github.com/bytecodealliance/wasmtime/pull/3697#discussion_r796992203">PR review comment</a>:</p>
<blockquote>
<p>It's used in the followup affinity PR (#3738) as otherwise there's an ID-reuse problem... strictly speaking that's just a heuristic so we could use fds there too and accept a false affinity sometimes. IMHO they're pretty cheap to maintain so maybe it's ok...?</p>
</blockquote>



<a name="270282494"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%233697%20memfd/madvise-based%20CoW%20pooling%20alloc.../near/270282494" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.233697.20memfd.2Fmadvise-based.20CoW.20pooling.20alloc.2E.2E.2E.html#270282494">(Feb 01 2022 at 20:45)</a>:</h4>
<p>alexcrichton submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/3697#pullrequestreview-869808757">PR review</a>.</p>



<a name="270282495"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%233697%20memfd/madvise-based%20CoW%20pooling%20alloc.../near/270282495" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.233697.20memfd.2Fmadvise-based.20CoW.20pooling.20alloc.2E.2E.2E.html#270282495">(Feb 01 2022 at 20:45)</a>:</h4>
<p>alexcrichton created <a href="https://github.com/bytecodealliance/wasmtime/pull/3697#discussion_r797001206">PR review comment</a>:</p>
<blockquote>
<p>Ah right, and nah yeah let's leave them in. Only worthwhile if they could be removed entirely, but using for affinity makes sense!</p>
</blockquote>



<a name="270305386"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%233697%20memfd/madvise-based%20CoW%20pooling%20alloc.../near/270305386" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.233697.20memfd.2Fmadvise-based.20CoW.20pooling.20alloc.2E.2E.2E.html#270305386">(Feb 01 2022 at 23:18)</a>:</h4>
<p>cfallin submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/3697#pullrequestreview-869934907">PR review</a>.</p>



<a name="270305387"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%233697%20memfd/madvise-based%20CoW%20pooling%20alloc.../near/270305387" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.233697.20memfd.2Fmadvise-based.20CoW.20pooling.20alloc.2E.2E.2E.html#270305387">(Feb 01 2022 at 23:18)</a>:</h4>
<p>cfallin created <a href="https://github.com/bytecodealliance/wasmtime/pull/3697#discussion_r797136113">PR review comment</a>:</p>
<blockquote>
<p>Ah, these were necessary to actually see commandline <code>wasmtime</code> use memfd I think -- the <code>default-features = false</code> otherwise turns everything off. (If there's a better way to arrange this then let me know -- I'm actually not sure I fully grok why <code>default-features = false</code> is right for the CLI tool)</p>
</blockquote>



<a name="270308892"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%233697%20memfd/madvise-based%20CoW%20pooling%20alloc.../near/270308892" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.233697.20memfd.2Fmadvise-based.20CoW.20pooling.20alloc.2E.2E.2E.html#270308892">(Feb 01 2022 at 23:49)</a>:</h4>
<p>cfallin updated <a href="https://github.com/bytecodealliance/wasmtime/pull/3697">PR #3697</a> from <code>memfd-cow</code> to <code>main</code>.</p>



<a name="270308982"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%233697%20memfd/madvise-based%20CoW%20pooling%20alloc.../near/270308982" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.233697.20memfd.2Fmadvise-based.20CoW.20pooling.20alloc.2E.2E.2E.html#270308982">(Feb 01 2022 at 23:50)</a>:</h4>
<p>cfallin submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/3697#pullrequestreview-869953260">PR review</a>.</p>



<a name="270308984"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%233697%20memfd/madvise-based%20CoW%20pooling%20alloc.../near/270308984" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.233697.20memfd.2Fmadvise-based.20CoW.20pooling.20alloc.2E.2E.2E.html#270308984">(Feb 01 2022 at 23:50)</a>:</h4>
<p>cfallin created <a href="https://github.com/bytecodealliance/wasmtime/pull/3697#discussion_r797159056">PR review comment</a>:</p>
<blockquote>
<p>Good point, no longer needed! Removed.</p>
</blockquote>



<a name="270309015"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%233697%20memfd/madvise-based%20CoW%20pooling%20alloc.../near/270309015" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.233697.20memfd.2Fmadvise-based.20CoW.20pooling.20alloc.2E.2E.2E.html#270309015">(Feb 01 2022 at 23:51)</a>:</h4>
<p>cfallin submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/3697#pullrequestreview-869953438">PR review</a>.</p>



<a name="270309016"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%233697%20memfd/madvise-based%20CoW%20pooling%20alloc.../near/270309016" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.233697.20memfd.2Fmadvise-based.20CoW.20pooling.20alloc.2E.2E.2E.html#270309016">(Feb 01 2022 at 23:51)</a>:</h4>
<p>cfallin created <a href="https://github.com/bytecodealliance/wasmtime/pull/3697#discussion_r797159261">PR review comment</a>:</p>
<blockquote>
<p>Ah, I wasn't aware of that bit of <code>Mutex</code>'s API, thanks!</p>
</blockquote>



<a name="270309030"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%233697%20memfd/madvise-based%20CoW%20pooling%20alloc.../near/270309030" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.233697.20memfd.2Fmadvise-based.20CoW.20pooling.20alloc.2E.2E.2E.html#270309030">(Feb 01 2022 at 23:51)</a>:</h4>
<p>cfallin submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/3697#pullrequestreview-869953522">PR review</a>.</p>



<a name="270309031"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%233697%20memfd/madvise-based%20CoW%20pooling%20alloc.../near/270309031" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.233697.20memfd.2Fmadvise-based.20CoW.20pooling.20alloc.2E.2E.2E.html#270309031">(Feb 01 2022 at 23:51)</a>:</h4>
<p>cfallin created <a href="https://github.com/bytecodealliance/wasmtime/pull/3697#discussion_r797159362">PR review comment</a>:</p>
<blockquote>
<p>Seems not to be, removed!</p>
</blockquote>



<a name="270309033"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%233697%20memfd/madvise-based%20CoW%20pooling%20alloc.../near/270309033" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.233697.20memfd.2Fmadvise-based.20CoW.20pooling.20alloc.2E.2E.2E.html#270309033">(Feb 01 2022 at 23:51)</a>:</h4>
<p>cfallin submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/3697#pullrequestreview-869953585">PR review</a>.</p>



<a name="270309034"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%233697%20memfd/madvise-based%20CoW%20pooling%20alloc.../near/270309034" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.233697.20memfd.2Fmadvise-based.20CoW.20pooling.20alloc.2E.2E.2E.html#270309034">(Feb 01 2022 at 23:51)</a>:</h4>
<p>cfallin created <a href="https://github.com/bytecodealliance/wasmtime/pull/3697#discussion_r797159430">PR review comment</a>:</p>
<blockquote>
<p>Yes; added doc-comment notes to make this explicit and asserts where the <code>MemoryMemFd</code> is built. Thanks!</p>
</blockquote>



<a name="270309056"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%233697%20memfd/madvise-based%20CoW%20pooling%20alloc.../near/270309056" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.233697.20memfd.2Fmadvise-based.20CoW.20pooling.20alloc.2E.2E.2E.html#270309056">(Feb 01 2022 at 23:51)</a>:</h4>
<p>cfallin submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/3697#pullrequestreview-869953745">PR review</a>.</p>



<a name="270309057"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%233697%20memfd/madvise-based%20CoW%20pooling%20alloc.../near/270309057" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.233697.20memfd.2Fmadvise-based.20CoW.20pooling.20alloc.2E.2E.2E.html#270309057">(Feb 01 2022 at 23:51)</a>:</h4>
<p>cfallin created <a href="https://github.com/bytecodealliance/wasmtime/pull/3697#discussion_r797159664">PR review comment</a>:</p>
<blockquote>
<p>Indeed!</p>
</blockquote>



<a name="270309071"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%233697%20memfd/madvise-based%20CoW%20pooling%20alloc.../near/270309071" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.233697.20memfd.2Fmadvise-based.20CoW.20pooling.20alloc.2E.2E.2E.html#270309071">(Feb 01 2022 at 23:51)</a>:</h4>
<p>cfallin submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/3697#pullrequestreview-869953809">PR review</a>.</p>



<a name="270309072"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%233697%20memfd/madvise-based%20CoW%20pooling%20alloc.../near/270309072" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.233697.20memfd.2Fmadvise-based.20CoW.20pooling.20alloc.2E.2E.2E.html#270309072">(Feb 01 2022 at 23:51)</a>:</h4>
<p>cfallin created <a href="https://github.com/bytecodealliance/wasmtime/pull/3697#discussion_r797159745">PR review comment</a>:</p>
<blockquote>
<p>Good point, changed.</p>
</blockquote>



<a name="270309363"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%233697%20memfd/madvise-based%20CoW%20pooling%20alloc.../near/270309363" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.233697.20memfd.2Fmadvise-based.20CoW.20pooling.20alloc.2E.2E.2E.html#270309363">(Feb 01 2022 at 23:54)</a>:</h4>
<p>cfallin submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/3697#pullrequestreview-869954999">PR review</a>.</p>



<a name="270309366"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%233697%20memfd/madvise-based%20CoW%20pooling%20alloc.../near/270309366" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.233697.20memfd.2Fmadvise-based.20CoW.20pooling.20alloc.2E.2E.2E.html#270309366">(Feb 01 2022 at 23:54)</a>:</h4>
<p>cfallin created <a href="https://github.com/bytecodealliance/wasmtime/pull/3697#discussion_r797161570">PR review comment</a>:</p>
<blockquote>
<p>I've updated this so that the extra mmap no longer occurs. The basic idea is actually a slightly more general optimization: if there is no <code>image</code> (this can happen any time a memory with no data segments uses a <code>MemFdSlot</code>), then the whole slot is just the anon-zeroes mmap, and we don't need to wipe it clear with a new one. This is true when the <code>MemFdSlot</code> is first created as well: it has an <code>image</code> of <code>None</code> and we require the caller to have created a backing mmap already (as both the dynamic linear memory and the pooling allocator do).</p>
</blockquote>



<a name="270313870"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%233697%20memfd/madvise-based%20CoW%20pooling%20alloc.../near/270313870" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.233697.20memfd.2Fmadvise-based.20CoW.20pooling.20alloc.2E.2E.2E.html#270313870">(Feb 02 2022 at 00:37)</a>:</h4>
<p>cfallin updated <a href="https://github.com/bytecodealliance/wasmtime/pull/3697">PR #3697</a> from <code>memfd-cow</code> to <code>main</code>.</p>



<a name="270406563"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%233697%20memfd/madvise-based%20CoW%20pooling%20alloc.../near/270406563" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.233697.20memfd.2Fmadvise-based.20CoW.20pooling.20alloc.2E.2E.2E.html#270406563">(Feb 02 2022 at 15:54)</a>:</h4>
<p>alexcrichton submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/3697#pullrequestreview-870742351">PR review</a>.</p>



<a name="270406564"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%233697%20memfd/madvise-based%20CoW%20pooling%20alloc.../near/270406564" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.233697.20memfd.2Fmadvise-based.20CoW.20pooling.20alloc.2E.2E.2E.html#270406564">(Feb 02 2022 at 15:54)</a>:</h4>
<p>alexcrichton submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/3697#pullrequestreview-870742351">PR review</a>.</p>



<a name="270406566"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%233697%20memfd/madvise-based%20CoW%20pooling%20alloc.../near/270406566" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.233697.20memfd.2Fmadvise-based.20CoW.20pooling.20alloc.2E.2E.2E.html#270406566">(Feb 02 2022 at 15:54)</a>:</h4>
<p>alexcrichton created <a href="https://github.com/bytecodealliance/wasmtime/pull/3697#discussion_r797749336">PR review comment</a>:</p>
<blockquote>
<p>Now that I think about it, mind adding some debug asserts here that <code>image.offset + image.len</code> fits within <code>initial_size_bytes</code>?</p>
</blockquote>



<a name="270406567"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%233697%20memfd/madvise-based%20CoW%20pooling%20alloc.../near/270406567" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.233697.20memfd.2Fmadvise-based.20CoW.20pooling.20alloc.2E.2E.2E.html#270406567">(Feb 02 2022 at 15:54)</a>:</h4>
<p>alexcrichton created <a href="https://github.com/bytecodealliance/wasmtime/pull/3697#discussion_r797751349">PR review comment</a>:</p>
<blockquote>
<p>One thought I had reading over this, is this strictly necessary? For example if we didn't track <code>initial_size</code> and instead only tracked <code>cur_size</code> then we could leave the entire mapping as zero here and on reuse we'd hit the <code>if initial_size_bytes &lt; self.initial_size</code> case (although afterwards it'd be <code>self.cur_size</code>).</p>
<p>I don't think that'd actually result in any fewer syscalls happening in any cases though.</p>
</blockquote>



<a name="270406569"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%233697%20memfd/madvise-based%20CoW%20pooling%20alloc.../near/270406569" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.233697.20memfd.2Fmadvise-based.20CoW.20pooling.20alloc.2E.2E.2E.html#270406569">(Feb 02 2022 at 15:54)</a>:</h4>
<p>alexcrichton created <a href="https://github.com/bytecodealliance/wasmtime/pull/3697#discussion_r797752102">PR review comment</a>:</p>
<blockquote>
<p>I think now the <code>prot</code> flag is always <code>ProtFlags::empty()</code> so this could perhaps be renamed to <code>reset_with_anon_memory</code> or something like that? (with no arguments)</p>
</blockquote>



<a name="270406570"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%233697%20memfd/madvise-based%20CoW%20pooling%20alloc.../near/270406570" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.233697.20memfd.2Fmadvise-based.20CoW.20pooling.20alloc.2E.2E.2E.html#270406570">(Feb 02 2022 at 15:54)</a>:</h4>
<p>alexcrichton created <a href="https://github.com/bytecodealliance/wasmtime/pull/3697#discussion_r797748584">PR review comment</a>:</p>
<blockquote>
<p>I think this should be <code>self.initial_size - initial_size_bytes</code>, right?</p>
<p>In that this is just making the previously-larger heap inaccessible after the base?</p>
</blockquote>



<a name="270406571"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%233697%20memfd/madvise-based%20CoW%20pooling%20alloc.../near/270406571" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.233697.20memfd.2Fmadvise-based.20CoW.20pooling.20alloc.2E.2E.2E.html#270406571">(Feb 02 2022 at 15:54)</a>:</h4>
<p>alexcrichton created <a href="https://github.com/bytecodealliance/wasmtime/pull/3697#discussion_r797753308">PR review comment</a>:</p>
<blockquote>
<p>Oh actually this may not work out, I can see how a grown heap would then, on resue, re-<code>mmap</code> the CoW overlay.</p>
</blockquote>



<a name="270426543"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%233697%20memfd/madvise-based%20CoW%20pooling%20alloc.../near/270426543" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.233697.20memfd.2Fmadvise-based.20CoW.20pooling.20alloc.2E.2E.2E.html#270426543">(Feb 02 2022 at 17:39)</a>:</h4>
<p><strong>acfoltzer</strong> requested <a href="https://github.com/acfoltzer">acfoltzer</a> for a review on <a href="https://github.com/bytecodealliance/wasmtime/pull/3697">PR #3697</a>.</p>



<a name="270430926"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%233697%20memfd/madvise-based%20CoW%20pooling%20alloc.../near/270430926" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.233697.20memfd.2Fmadvise-based.20CoW.20pooling.20alloc.2E.2E.2E.html#270430926">(Feb 02 2022 at 18:03)</a>:</h4>
<p>cfallin updated <a href="https://github.com/bytecodealliance/wasmtime/pull/3697">PR #3697</a> from <code>memfd-cow</code> to <code>main</code>.</p>



<a name="270430933"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%233697%20memfd/madvise-based%20CoW%20pooling%20alloc.../near/270430933" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.233697.20memfd.2Fmadvise-based.20CoW.20pooling.20alloc.2E.2E.2E.html#270430933">(Feb 02 2022 at 18:03)</a>:</h4>
<p>cfallin submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/3697#pullrequestreview-870924654">PR review</a>.</p>



<a name="270430934"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%233697%20memfd/madvise-based%20CoW%20pooling%20alloc.../near/270430934" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.233697.20memfd.2Fmadvise-based.20CoW.20pooling.20alloc.2E.2E.2E.html#270430934">(Feb 02 2022 at 18:03)</a>:</h4>
<p>cfallin created <a href="https://github.com/bytecodealliance/wasmtime/pull/3697#discussion_r797879911">PR review comment</a>:</p>
<blockquote>
<p>I think it's correct, but it's pretty subtle so I added some more comments with a figure showing the before-and-after mmap state. Basically we have 0..self.initial_size accessible, and we want only 0..initial_size_bytes (the new, smaller size) accessible, so we make inaccessible the range initial_size_bytes..self.initial_size.</p>
</blockquote>



<a name="270430974"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%233697%20memfd/madvise-based%20CoW%20pooling%20alloc.../near/270430974" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.233697.20memfd.2Fmadvise-based.20CoW.20pooling.20alloc.2E.2E.2E.html#270430974">(Feb 02 2022 at 18:03)</a>:</h4>
<p>cfallin submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/3697#pullrequestreview-870924853">PR review</a>.</p>



<a name="270430976"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%233697%20memfd/madvise-based%20CoW%20pooling%20alloc.../near/270430976" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.233697.20memfd.2Fmadvise-based.20CoW.20pooling.20alloc.2E.2E.2E.html#270430976">(Feb 02 2022 at 18:03)</a>:</h4>
<p>cfallin created <a href="https://github.com/bytecodealliance/wasmtime/pull/3697#discussion_r797880053">PR review comment</a>:</p>
<blockquote>
<p>Done! (And I made it a release assert rather than debug-only, as this feels important enough and we use release asserts elsewhere in this file)</p>
</blockquote>



<a name="270430990"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%233697%20memfd/madvise-based%20CoW%20pooling%20alloc.../near/270430990" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.233697.20memfd.2Fmadvise-based.20CoW.20pooling.20alloc.2E.2E.2E.html#270430990">(Feb 02 2022 at 18:03)</a>:</h4>
<p>cfallin submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/3697#pullrequestreview-870924954">PR review</a>.</p>



<a name="270430991"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%233697%20memfd/madvise-based%20CoW%20pooling%20alloc.../near/270430991" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.233697.20memfd.2Fmadvise-based.20CoW.20pooling.20alloc.2E.2E.2E.html#270430991">(Feb 02 2022 at 18:03)</a>:</h4>
<p>cfallin created <a href="https://github.com/bytecodealliance/wasmtime/pull/3697#discussion_r797880121">PR review comment</a>:</p>
<blockquote>
<p>Done!</p>
</blockquote>



<a name="270431583"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%233697%20memfd/madvise-based%20CoW%20pooling%20alloc.../near/270431583" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.233697.20memfd.2Fmadvise-based.20CoW.20pooling.20alloc.2E.2E.2E.html#270431583">(Feb 02 2022 at 18:07)</a>:</h4>
<p>alexcrichton submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/3697#pullrequestreview-870928709">PR review</a>.</p>



<a name="270431584"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%233697%20memfd/madvise-based%20CoW%20pooling%20alloc.../near/270431584" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.233697.20memfd.2Fmadvise-based.20CoW.20pooling.20alloc.2E.2E.2E.html#270431584">(Feb 02 2022 at 18:07)</a>:</h4>
<p>alexcrichton created <a href="https://github.com/bytecodealliance/wasmtime/pull/3697#discussion_r797882761">PR review comment</a>:</p>
<blockquote>
<p>But this parameter is the length parameter, not an end, so isn't the length of what we're changing to PROT_NONE <code>self.initial_size - initial_size_bytes</code> since the new heap is smaller?</p>
</blockquote>



<a name="270431791"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%233697%20memfd/madvise-based%20CoW%20pooling%20alloc.../near/270431791" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.233697.20memfd.2Fmadvise-based.20CoW.20pooling.20alloc.2E.2E.2E.html#270431791">(Feb 02 2022 at 18:08)</a>:</h4>
<p>alexcrichton submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/3697#pullrequestreview-870929958">PR review</a>.</p>



<a name="270431792"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%233697%20memfd/madvise-based%20CoW%20pooling%20alloc.../near/270431792" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.233697.20memfd.2Fmadvise-based.20CoW.20pooling.20alloc.2E.2E.2E.html#270431792">(Feb 02 2022 at 18:08)</a>:</h4>
<p>alexcrichton created <a href="https://github.com/bytecodealliance/wasmtime/pull/3697#discussion_r797883645">PR review comment</a>:</p>
<blockquote>
<p>Something I just realized for this case, I think that <code>self.image</code> should be set to <code>None</code> if we don't take this path through the <code>if</code>, right?</p>
</blockquote>



<a name="270434293"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%233697%20memfd/madvise-based%20CoW%20pooling%20alloc.../near/270434293" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.233697.20memfd.2Fmadvise-based.20CoW.20pooling.20alloc.2E.2E.2E.html#270434293">(Feb 02 2022 at 18:25)</a>:</h4>
<p>cfallin submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/3697#pullrequestreview-870950095">PR review</a>.</p>



<a name="270434295"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%233697%20memfd/madvise-based%20CoW%20pooling%20alloc.../near/270434295" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.233697.20memfd.2Fmadvise-based.20CoW.20pooling.20alloc.2E.2E.2E.html#270434295">(Feb 02 2022 at 18:25)</a>:</h4>
<p>cfallin created <a href="https://github.com/bytecodealliance/wasmtime/pull/3697#discussion_r797899289">PR review comment</a>:</p>
<blockquote>
<p>Eek, indeed. This "oh wait one more case" on the core code is making me nervous enough that I'm gonna go figure out how to test this more thoroughly (so far it's been just "every other test uses this as a backend").</p>
</blockquote>



<a name="270434985"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%233697%20memfd/madvise-based%20CoW%20pooling%20alloc.../near/270434985" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.233697.20memfd.2Fmadvise-based.20CoW.20pooling.20alloc.2E.2E.2E.html#270434985">(Feb 02 2022 at 18:30)</a>:</h4>
<p>alexcrichton created <a href="https://github.com/bytecodealliance/wasmtime/pull/3697#discussion_r797903281">PR review comment</a>:</p>
<blockquote>
<p>Internally it might be a bit more robust to use <code>Range&lt;usize&gt;</code> instead of <code>start: usize, len: usize</code> perhaps, but otherwise I don't think this was a functionality bug since it's more that it could theoretically trip the preexisting assert in setting page protections. </p>
</blockquote>



<a name="270434986"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%233697%20memfd/madvise-based%20CoW%20pooling%20alloc.../near/270434986" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.233697.20memfd.2Fmadvise-based.20CoW.20pooling.20alloc.2E.2E.2E.html#270434986">(Feb 02 2022 at 18:30)</a>:</h4>
<p>alexcrichton submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/3697#pullrequestreview-870955159">PR review</a>.</p>



<a name="270443879"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%233697%20memfd/madvise-based%20CoW%20pooling%20alloc.../near/270443879" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.233697.20memfd.2Fmadvise-based.20CoW.20pooling.20alloc.2E.2E.2E.html#270443879">(Feb 02 2022 at 19:30)</a>:</h4>
<p>cfallin submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/3697#pullrequestreview-871012608">PR review</a>.</p>



<a name="270443880"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%233697%20memfd/madvise-based%20CoW%20pooling%20alloc.../near/270443880" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.233697.20memfd.2Fmadvise-based.20CoW.20pooling.20alloc.2E.2E.2E.html#270443880">(Feb 02 2022 at 19:30)</a>:</h4>
<p>cfallin created <a href="https://github.com/bytecodealliance/wasmtime/pull/3697#discussion_r797946332">PR review comment</a>:</p>
<blockquote>
<p>Ah, it actually can lead to incorrect behavior, or at least I managed to hit it with the tests I just added: if we don't clear <code>image</code> when we instantiate with no image, then the stale state remains, and on the <em>next</em> instantiation we may falsely think that we have this image mapped in when we don't (anymore).</p>
<p>In any case, fixed and tests added; thank you for finding this!</p>
</blockquote>



<a name="270444320"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%233697%20memfd/madvise-based%20CoW%20pooling%20alloc.../near/270444320" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.233697.20memfd.2Fmadvise-based.20CoW.20pooling.20alloc.2E.2E.2E.html#270444320">(Feb 02 2022 at 19:33)</a>:</h4>
<p>cfallin updated <a href="https://github.com/bytecodealliance/wasmtime/pull/3697">PR #3697</a> from <code>memfd-cow</code> to <code>main</code>.</p>



<a name="270445272"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%233697%20memfd/madvise-based%20CoW%20pooling%20alloc.../near/270445272" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.233697.20memfd.2Fmadvise-based.20CoW.20pooling.20alloc.2E.2E.2E.html#270445272">(Feb 02 2022 at 19:39)</a>:</h4>
<p>alexcrichton created <a href="https://github.com/bytecodealliance/wasmtime/pull/3697#discussion_r797952150">PR review comment</a>:</p>
<blockquote>
<p>oh oops I thought I was responding to <a href="https://github.com/bytecodealliance/wasmtime/pull/3697#discussion_r797879911">https://github.com/bytecodealliance/wasmtime/pull/3697#discussion_r797879911</a> here, but I clearly am not, so disregard that last comment here!</p>
</blockquote>



<a name="270445273"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%233697%20memfd/madvise-based%20CoW%20pooling%20alloc.../near/270445273" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.233697.20memfd.2Fmadvise-based.20CoW.20pooling.20alloc.2E.2E.2E.html#270445273">(Feb 02 2022 at 19:39)</a>:</h4>
<p>alexcrichton submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/3697#pullrequestreview-871021619">PR review</a>.</p>



<a name="270445630"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%233697%20memfd/madvise-based%20CoW%20pooling%20alloc.../near/270445630" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.233697.20memfd.2Fmadvise-based.20CoW.20pooling.20alloc.2E.2E.2E.html#270445630">(Feb 02 2022 at 19:41)</a>:</h4>
<p>cfallin updated <a href="https://github.com/bytecodealliance/wasmtime/pull/3697">PR #3697</a> from <code>memfd-cow</code> to <code>main</code>.</p>



<a name="270445817"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%233697%20memfd/madvise-based%20CoW%20pooling%20alloc.../near/270445817" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.233697.20memfd.2Fmadvise-based.20CoW.20pooling.20alloc.2E.2E.2E.html#270445817">(Feb 02 2022 at 19:42)</a>:</h4>
<p>cfallin submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/3697#pullrequestreview-871025066">PR review</a>.</p>



<a name="270445818"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%233697%20memfd/madvise-based%20CoW%20pooling%20alloc.../near/270445818" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.233697.20memfd.2Fmadvise-based.20CoW.20pooling.20alloc.2E.2E.2E.html#270445818">(Feb 02 2022 at 19:42)</a>:</h4>
<p>cfallin created <a href="https://github.com/bytecodealliance/wasmtime/pull/3697#discussion_r797954498">PR review comment</a>:</p>
<blockquote>
<p>Ah yes, I see now; pushed an update that modifies <code>set_protection</code> to use <code>Range</code> instead and this is indeed much clearer!</p>
</blockquote>



<a name="270451777"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%233697%20memfd/madvise-based%20CoW%20pooling%20alloc.../near/270451777" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.233697.20memfd.2Fmadvise-based.20CoW.20pooling.20alloc.2E.2E.2E.html#270451777">(Feb 02 2022 at 20:25)</a>:</h4>
<p>cfallin updated <a href="https://github.com/bytecodealliance/wasmtime/pull/3697">PR #3697</a> from <code>memfd-cow</code> to <code>main</code>.</p>



<a name="270457219"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%233697%20memfd/madvise-based%20CoW%20pooling%20alloc.../near/270457219" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.233697.20memfd.2Fmadvise-based.20CoW.20pooling.20alloc.2E.2E.2E.html#270457219">(Feb 02 2022 at 21:04)</a>:</h4>
<p>cfallin merged <a href="https://github.com/bytecodealliance/wasmtime/pull/3697">PR #3697</a>.</p>



<hr><p>Last updated: Jan 20 2025 at 06:04 UTC</p>
</html>