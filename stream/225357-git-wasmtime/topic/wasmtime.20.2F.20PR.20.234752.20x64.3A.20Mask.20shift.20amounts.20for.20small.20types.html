<html>
<head><meta charset="utf-8"><title>wasmtime / PR #4752 x64: Mask shift amounts for small types · git-wasmtime · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/index.html">git-wasmtime</a></h2>
<h3>Topic: <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.234752.20x64.3A.20Mask.20shift.20amounts.20for.20small.20types.html">wasmtime / PR #4752 x64: Mask shift amounts for small types</a></h3>

<hr>

<base href="https://bytecodealliance.zulipchat.com">

<head><link href="https://bytecodealliance.github.io/zulip-archive/style.css" rel="stylesheet"></head>

<a name="294876875"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%234752%20x64%3A%20Mask%20shift%20amounts%20for%20small%20types/near/294876875" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.234752.20x64.3A.20Mask.20shift.20amounts.20for.20small.20types.html#294876875">(Aug 23 2022 at 14:29)</a>:</h4>
<p>afonso360 opened <a href="https://github.com/bytecodealliance/wasmtime/pull/4752">PR #4752</a> from <code>x64-fix-shifts</code> to <code>main</code>:</p>
<blockquote>
<p>This was reported by @bjorn3 in <a href="https://github.com/bjorn3/rustc_codegen_cranelift/pull/1268#issuecomment-1223916783">https://github.com/bjorn3/rustc_codegen_cranelift/pull/1268#issuecomment-1223916783</a> when we tried to remove the explicit shift amount masking done by <code>cg_clif</code>.</p>
<p>As a consequence of this fix, #4699 is also fixed, which is nice!</p>
<p>This PR also does some other housekeeping:</p>
<ul>
<li>Enables <code>i128</code> shifts in the fuzzer</li>
<li>Enables the <code>i128-shifts-small-types.clif</code> runtests and moves them to <code>i128-shifts.clif</code></li>
<li>Adds run tests that trigger the issue above (which is similar, but not the same as the <code>i128</code> one)</li>
<li>Adds compile tests for all forms of <code>ishl</code>/<code>sshr</code>/<code>ushr</code></li>
</ul>
<p>Fixes: #4699<br>
cc: @elliottt</p>
</blockquote>



<a name="294904059"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%234752%20x64%3A%20Mask%20shift%20amounts%20for%20small%20types/near/294904059" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.234752.20x64.3A.20Mask.20shift.20amounts.20for.20small.20types.html#294904059">(Aug 23 2022 at 16:28)</a>:</h4>
<p>elliottt submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/4752#pullrequestreview-1082450538">PR review</a>.</p>



<a name="294904060"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%234752%20x64%3A%20Mask%20shift%20amounts%20for%20small%20types/near/294904060" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.234752.20x64.3A.20Mask.20shift.20amounts.20for.20small.20types.html#294904060">(Aug 23 2022 at 16:28)</a>:</h4>
<p>elliottt submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/4752#pullrequestreview-1082450538">PR review</a>.</p>



<a name="294904061"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%234752%20x64%3A%20Mask%20shift%20amounts%20for%20small%20types/near/294904061" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.234752.20x64.3A.20Mask.20shift.20amounts.20for.20small.20types.html#294904061">(Aug 23 2022 at 16:28)</a>:</h4>
<p>elliottt created <a href="https://github.com/bytecodealliance/wasmtime/pull/4752#discussion_r952820974">PR review comment</a>:</p>
<blockquote>
<p>Was this priority necessary for correct output? I think it should be fine to omit it.</p>
</blockquote>



<a name="294906163"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%234752%20x64%3A%20Mask%20shift%20amounts%20for%20small%20types/near/294906163" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.234752.20x64.3A.20Mask.20shift.20amounts.20for.20small.20types.html#294906163">(Aug 23 2022 at 16:40)</a>:</h4>
<p>afonso360 submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/4752#pullrequestreview-1082509043">PR review</a>.</p>



<a name="294906164"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%234752%20x64%3A%20Mask%20shift%20amounts%20for%20small%20types/near/294906164" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.234752.20x64.3A.20Mask.20shift.20amounts.20for.20small.20types.html#294906164">(Aug 23 2022 at 16:40)</a>:</h4>
<p>afonso360 created <a href="https://github.com/bytecodealliance/wasmtime/pull/4752#discussion_r952870231">PR review comment</a>:</p>
<blockquote>
<p>Not really, but I've had issues with priorities, so now I'm a bit paranoid about it. I'll remove it</p>
</blockquote>



<a name="294906812"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%234752%20x64%3A%20Mask%20shift%20amounts%20for%20small%20types/near/294906812" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.234752.20x64.3A.20Mask.20shift.20amounts.20for.20small.20types.html#294906812">(Aug 23 2022 at 16:44)</a>:</h4>
<p>afonso360 updated <a href="https://github.com/bytecodealliance/wasmtime/pull/4752">PR #4752</a> from <code>x64-fix-shifts</code> to <code>main</code>.</p>



<a name="294907528"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%234752%20x64%3A%20Mask%20shift%20amounts%20for%20small%20types/near/294907528" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.234752.20x64.3A.20Mask.20shift.20amounts.20for.20small.20types.html#294907528">(Aug 23 2022 at 16:48)</a>:</h4>
<p>afonso360 updated <a href="https://github.com/bytecodealliance/wasmtime/pull/4752">PR #4752</a> from <code>x64-fix-shifts</code> to <code>main</code>.</p>



<a name="294910970"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%234752%20x64%3A%20Mask%20shift%20amounts%20for%20small%20types/near/294910970" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.234752.20x64.3A.20Mask.20shift.20amounts.20for.20small.20types.html#294910970">(Aug 23 2022 at 17:07)</a>:</h4>
<p>jameysharp has enabled auto merge for <a href="https://github.com/bytecodealliance/wasmtime/pull/4752">PR #4752</a>.</p>



<a name="294926087"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%234752%20x64%3A%20Mask%20shift%20amounts%20for%20small%20types/near/294926087" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.234752.20x64.3A.20Mask.20shift.20amounts.20for.20small.20types.html#294926087">(Aug 23 2022 at 18:39)</a>:</h4>
<p>jameysharp submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/4752#pullrequestreview-1082667322">PR review</a>.</p>



<a name="294926088"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%234752%20x64%3A%20Mask%20shift%20amounts%20for%20small%20types/near/294926088" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.234752.20x64.3A.20Mask.20shift.20amounts.20for.20small.20types.html#294926088">(Aug 23 2022 at 18:39)</a>:</h4>
<p>jameysharp created <a href="https://github.com/bytecodealliance/wasmtime/pull/4752#discussion_r952989053">PR review comment</a>:</p>
<blockquote>
<p>I want to see if I understand why this PR fixes this issue. Could you confirm or correct my interpretation?</p>
<p>It looks like there are two bugs in <code>put_masked_in_imm8_gpr</code>, and I gather that these bugs aren't present in the similar-looking ISLE rules.</p>
<p>If the shift amount is not defined by an <code>iconst</code> instruction, then this function doesn't mask it at all...? The only thing it does is, if the shift amount needs two registers because it's an i128, then it only takes the lower 64-bit register.</p>
<p>If it is a constant, then it's masked by <code>(1 &lt;&lt; ty.bits()) - 1</code>. So for an 8-bit LHS, the shift amount is used modulo 256, but it's actually supposed to be modulo 8. For a 64-bit LHS the shift amount is effectively not masked at all. By contrast, the <code>shift_mask</code> function just returns <code>ty.lane_bits() - 1</code> so it gets this right. (And also handles vector types correctly, I guess?)</p>
<p>I guess the reason these bugs weren't obvious sooner is that wasm only uses i32 and i64 types, and x86 already masks 32-bit and 64-bit shift amounts to 5 and 6 bits, respectively. But narrower 8-bit and 16-bit shifts are also masked to 5 bits on x86, so those were wrong.</p>
<p>Now that I think I understand this, I'm wondering how hard it is in ISLE to avoid emitting the <code>and</code> instruction when the type is i32 or i64.</p>
</blockquote>



<a name="294926307"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%234752%20x64%3A%20Mask%20shift%20amounts%20for%20small%20types/near/294926307" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.234752.20x64.3A.20Mask.20shift.20amounts.20for.20small.20types.html#294926307">(Aug 23 2022 at 18:40)</a>:</h4>
<p>jameysharp has disabled auto merge for <a href="https://github.com/bytecodealliance/wasmtime/pull/4752">PR #4752</a>.</p>



<a name="294928471"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%234752%20x64%3A%20Mask%20shift%20amounts%20for%20small%20types/near/294928471" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.234752.20x64.3A.20Mask.20shift.20amounts.20for.20small.20types.html#294928471">(Aug 23 2022 at 18:55)</a>:</h4>
<p>afonso360 submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/4752#pullrequestreview-1082686384">PR review</a>.</p>



<a name="294928472"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%234752%20x64%3A%20Mask%20shift%20amounts%20for%20small%20types/near/294928472" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.234752.20x64.3A.20Mask.20shift.20amounts.20for.20small.20types.html#294928472">(Aug 23 2022 at 18:55)</a>:</h4>
<p>afonso360 created <a href="https://github.com/bytecodealliance/wasmtime/pull/4752#discussion_r953002503">PR review comment</a>:</p>
<blockquote>
<blockquote>
<p>If the shift amount is not defined by an iconst instruction, then this function doesn't mask it at all...? The only thing it does is, if the shift amount needs two registers because it's an i128, then it only takes the lower 64-bit register.</p>
</blockquote>
<p>Yes, the source of the issue I was trying to fix was exactly this.</p>
<blockquote>
<p>It looks like there are two bugs in put_masked_in_imm8_gpr, and I gather that these bugs aren't present in the similar-looking ISLE rules.</p>
</blockquote>
<p>Wow! I was just trying to fix the unmasked non const one, didn't actually realize that the const case didn't do the right thing either!</p>
<p>We should probably add some <code>shift_imm</code> test cases as well.</p>
<blockquote>
<p>Now that I think I understand this, I'm wondering how hard it is in ISLE to avoid emitting the and instruction when the type is i32 or i64.</p>
</blockquote>
<p>I think that's a good improvement, i'll push it soon.</p>
</blockquote>



<a name="294929122"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%234752%20x64%3A%20Mask%20shift%20amounts%20for%20small%20types/near/294929122" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.234752.20x64.3A.20Mask.20shift.20amounts.20for.20small.20types.html#294929122">(Aug 23 2022 at 19:00)</a>:</h4>
<p>afonso360 edited <a href="https://github.com/bytecodealliance/wasmtime/pull/4752#discussion_r953002503">PR review comment</a>.</p>



<a name="295014389"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%234752%20x64%3A%20Mask%20shift%20amounts%20for%20small%20types/near/295014389" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.234752.20x64.3A.20Mask.20shift.20amounts.20for.20small.20types.html#295014389">(Aug 24 2022 at 10:05)</a>:</h4>
<p>afonso360 updated <a href="https://github.com/bytecodealliance/wasmtime/pull/4752">PR #4752</a> from <code>x64-fix-shifts</code> to <code>main</code>.</p>



<a name="295014685"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%234752%20x64%3A%20Mask%20shift%20amounts%20for%20small%20types/near/295014685" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.234752.20x64.3A.20Mask.20shift.20amounts.20for.20small.20types.html#295014685">(Aug 24 2022 at 10:06)</a>:</h4>
<p>afonso360 submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/4752#pullrequestreview-1083520199">PR review</a>.</p>



<a name="295014686"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%234752%20x64%3A%20Mask%20shift%20amounts%20for%20small%20types/near/295014686" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.234752.20x64.3A.20Mask.20shift.20amounts.20for.20small.20types.html#295014686">(Aug 24 2022 at 10:06)</a>:</h4>
<p>afonso360 created <a href="https://github.com/bytecodealliance/wasmtime/pull/4752#discussion_r953606870">PR review comment</a>:</p>
<blockquote>
<p>And it turns out the const case was also wrong. Great Catch!</p>
</blockquote>



<a name="295016652"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%234752%20x64%3A%20Mask%20shift%20amounts%20for%20small%20types/near/295016652" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.234752.20x64.3A.20Mask.20shift.20amounts.20for.20small.20types.html#295016652">(Aug 24 2022 at 10:21)</a>:</h4>
<p>afonso360 updated <a href="https://github.com/bytecodealliance/wasmtime/pull/4752">PR #4752</a> from <code>x64-fix-shifts</code> to <code>main</code>.</p>



<a name="295093714"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%234752%20x64%3A%20Mask%20shift%20amounts%20for%20small%20types/near/295093714" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.234752.20x64.3A.20Mask.20shift.20amounts.20for.20small.20types.html#295093714">(Aug 24 2022 at 17:31)</a>:</h4>
<p>jameysharp merged <a href="https://github.com/bytecodealliance/wasmtime/pull/4752">PR #4752</a>.</p>



<hr><p>Last updated: Jan 20 2025 at 06:04 UTC</p>
</html>