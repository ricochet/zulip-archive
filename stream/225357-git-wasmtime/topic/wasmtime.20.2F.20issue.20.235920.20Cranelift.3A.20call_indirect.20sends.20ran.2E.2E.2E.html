<html>
<head><meta charset="utf-8"><title>wasmtime / issue #5920 Cranelift: call_indirect sends ran... · git-wasmtime · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/index.html">git-wasmtime</a></h2>
<h3>Topic: <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.235920.20Cranelift.3A.20call_indirect.20sends.20ran.2E.2E.2E.html">wasmtime / issue #5920 Cranelift: call_indirect sends ran...</a></h3>

<hr>

<base href="https://bytecodealliance.zulipchat.com">

<head><link href="https://bytecodealliance.github.io/zulip-archive/style.css" rel="stylesheet"></head>

<a name="339346687"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%235920%20Cranelift%3A%20call_indirect%20sends%20ran.../near/339346687" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.235920.20Cranelift.3A.20call_indirect.20sends.20ran.2E.2E.2E.html#339346687">(Mar 03 2023 at 13:36)</a>:</h4>
<p>salmmanfred opened <a href="https://github.com/bytecodealliance/wasmtime/issues/5920">issue #5920</a>:</p>
<blockquote>
<p>Thanks for filing an issue! Please fill out the TODOs below.</p>
<h3><code>.clif</code> Test Case</h3>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="k">use</span><span class="w"> </span><span class="n">cranelift</span>::<span class="n">codegen</span>::<span class="n">ir</span>::<span class="p">{</span><span class="n">UserFuncName</span><span class="p">,</span><span class="w"> </span><span class="n">FuncRef</span><span class="p">};</span>
<span class="k">use</span><span class="w"> </span><span class="n">cranelift</span>::<span class="n">frontend</span>::<span class="p">{</span><span class="n">FunctionBuilder</span><span class="p">,</span><span class="w"> </span><span class="n">FunctionBuilderContext</span><span class="p">};</span>
<span class="k">use</span><span class="w"> </span><span class="n">cranelift</span>::<span class="n">codegen</span>::<span class="p">{</span>
<span class="w">    </span><span class="n">ir</span>::<span class="p">{</span><span class="n">types</span>::<span class="n">I64</span><span class="p">,</span><span class="w"> </span><span class="n">AbiParam</span><span class="p">,</span><span class="w"> </span><span class="n">Function</span><span class="p">,</span><span class="w"> </span><span class="n">Signature</span><span class="p">},</span>
<span class="w">    </span><span class="n">isa</span>::<span class="n">CallConv</span><span class="p">,</span>
<span class="p">};</span>
<span class="k">use</span><span class="w"> </span><span class="n">cranelift</span>::<span class="n">prelude</span>::<span class="p">{</span><span class="n">InstBuilder</span><span class="p">,</span><span class="w"> </span><span class="n">types</span><span class="p">,</span><span class="w"> </span><span class="n">ExtFuncData</span><span class="p">,</span><span class="w"> </span><span class="n">MemFlags</span><span class="p">,</span><span class="w"> </span><span class="n">EntityRef</span><span class="p">};</span>

<span class="k">use</span><span class="w"> </span><span class="n">cranelift</span>::<span class="n">codegen</span>::<span class="p">{</span><span class="n">isa</span><span class="p">,</span><span class="w"> </span><span class="n">settings</span><span class="p">,</span><span class="w"> </span><span class="n">Context</span><span class="p">};</span>
<span class="k">use</span><span class="w"> </span><span class="n">cranelift_jit</span>::<span class="p">{</span><span class="n">JITModule</span><span class="p">,</span><span class="w"> </span><span class="n">JITBuilder</span><span class="p">};</span>
<span class="k">use</span><span class="w"> </span><span class="n">target_lexicon</span>::<span class="n">Triple</span><span class="p">;</span>
<span class="k">use</span><span class="w"> </span><span class="n">cranelift_module</span>::<span class="p">{</span><span class="n">DataContext</span><span class="p">,</span><span class="w"> </span><span class="n">Linkage</span><span class="p">,</span><span class="w"> </span><span class="n">Module</span><span class="p">};</span>
<span class="k">use</span><span class="w"> </span><span class="n">core</span>::<span class="n">fmt</span>::<span class="n">write</span><span class="p">;</span>

<span class="k">fn</span> <span class="nf">pr</span><span class="p">(</span><span class="n">t</span>: <span class="kt">i64</span><span class="p">,</span><span class="n">b</span>:<span class="kt">i64</span><span class="p">,</span><span class="n">c</span>:<span class="kt">i64</span><span class="p">,</span><span class="n">d</span>:<span class="kt">i64</span><span class="p">){</span>

<span class="w">        </span><span class="fm">println!</span><span class="p">(</span><span class="s">"{t},{},{},{}"</span><span class="p">,</span><span class="n">b</span><span class="p">,</span><span class="n">c</span><span class="p">,</span><span class="n">d</span><span class="p">);</span>
<span class="w">    </span><span class="c1">//println!("{:?}",*t);</span>

<span class="p">}</span>

<span class="k">pub</span><span class="w"> </span><span class="k">fn</span> <span class="nf">test_compile</span><span class="p">(){</span>

<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">builder</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">settings</span>::<span class="n">builder</span><span class="p">();</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">flags</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">settings</span>::<span class="n">Flags</span>::<span class="n">new</span><span class="p">(</span><span class="n">builder</span><span class="p">);</span>

<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">isa</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">match</span><span class="w"> </span><span class="n">isa</span>::<span class="n">lookup</span><span class="p">(</span><span class="n">Triple</span>::<span class="n">host</span><span class="p">())</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nb">Err</span><span class="p">(</span><span class="n">err</span><span class="p">)</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="fm">panic!</span><span class="p">(</span><span class="s">"Error looking up target: {}"</span><span class="p">,</span><span class="w"> </span><span class="n">err</span><span class="p">),</span>
<span class="w">        </span><span class="nb">Ok</span><span class="p">(</span><span class="n">isa_builder</span><span class="p">)</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="n">isa_builder</span><span class="p">.</span><span class="n">finish</span><span class="p">(</span><span class="n">flags</span><span class="p">).</span><span class="n">unwrap</span><span class="p">(),</span>
<span class="w">    </span><span class="p">};</span>



<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">sig</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Signature</span>::<span class="n">new</span><span class="p">(</span><span class="n">CallConv</span>::<span class="n">SystemV</span><span class="p">);</span>
<span class="w">    </span><span class="n">sig</span><span class="p">.</span><span class="n">params</span><span class="p">.</span><span class="n">push</span><span class="p">(</span><span class="n">AbiParam</span>::<span class="n">new</span><span class="p">(</span><span class="n">I64</span><span class="p">));</span>


<span class="w">    </span><span class="n">sig</span><span class="p">.</span><span class="n">returns</span><span class="p">.</span><span class="n">push</span><span class="p">(</span><span class="n">AbiParam</span>::<span class="n">new</span><span class="p">(</span><span class="n">I64</span><span class="p">));</span>
<span class="w">    </span><span class="n">sig</span><span class="p">.</span><span class="n">returns</span><span class="p">.</span><span class="n">push</span><span class="p">(</span><span class="n">AbiParam</span>::<span class="n">new</span><span class="p">(</span><span class="n">I64</span><span class="p">));</span>
<span class="w">    </span><span class="n">sig</span><span class="p">.</span><span class="n">returns</span><span class="p">.</span><span class="n">push</span><span class="p">(</span><span class="n">AbiParam</span>::<span class="n">new</span><span class="p">(</span><span class="n">I64</span><span class="p">));</span>


<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">func</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Function</span>::<span class="n">with_name_signature</span><span class="p">(</span><span class="n">UserFuncName</span>::<span class="n">default</span><span class="p">(),</span><span class="w"> </span><span class="n">sig</span><span class="p">);</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">func_ctx</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">FunctionBuilderContext</span>::<span class="n">new</span><span class="p">();</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">builder</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">FunctionBuilder</span>::<span class="n">new</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="n">func</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="n">func_ctx</span><span class="p">);</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">pointer_type</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">isa</span><span class="p">.</span><span class="n">pointer_type</span><span class="p">();</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">block</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">builder</span><span class="p">.</span><span class="n">create_block</span><span class="p">();</span>
<span class="w">    </span><span class="n">builder</span><span class="p">.</span><span class="n">seal_block</span><span class="p">(</span><span class="n">block</span><span class="p">);</span>

<span class="w">    </span><span class="n">builder</span><span class="p">.</span><span class="n">append_block_params_for_function_params</span><span class="p">(</span><span class="n">block</span><span class="p">);</span>
<span class="w">    </span><span class="n">builder</span><span class="p">.</span><span class="n">switch_to_block</span><span class="p">(</span><span class="n">block</span><span class="p">);</span>


<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="p">(</span><span class="n">write_sig</span><span class="p">,</span><span class="w"> </span><span class="n">write_address</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">write_sig</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Signature</span>::<span class="n">new</span><span class="p">(</span><span class="n">CallConv</span>::<span class="n">SystemV</span><span class="p">);</span>
<span class="w">        </span><span class="n">write_sig</span><span class="p">.</span><span class="n">params</span><span class="p">.</span><span class="n">push</span><span class="p">(</span><span class="n">AbiParam</span>::<span class="n">new</span><span class="p">(</span><span class="n">types</span>::<span class="n">I64</span><span class="p">));</span>
<span class="w">        </span><span class="n">write_sig</span><span class="p">.</span><span class="n">params</span><span class="p">.</span><span class="n">push</span><span class="p">(</span><span class="n">AbiParam</span>::<span class="n">new</span><span class="p">(</span><span class="n">types</span>::<span class="n">I64</span><span class="p">));</span>
<span class="w">        </span><span class="n">write_sig</span><span class="p">.</span><span class="n">params</span><span class="p">.</span><span class="n">push</span><span class="p">(</span><span class="n">AbiParam</span>::<span class="n">new</span><span class="p">(</span><span class="n">types</span>::<span class="n">I64</span><span class="p">));</span>
<span class="w">        </span><span class="n">write_sig</span><span class="p">.</span><span class="n">params</span><span class="p">.</span><span class="n">push</span><span class="p">(</span><span class="n">AbiParam</span>::<span class="n">new</span><span class="p">(</span><span class="n">types</span>::<span class="n">I64</span><span class="p">));</span>


<span class="w">       </span><span class="c1">// write_sig.returns.push(AbiParam::new(pointer_type));</span>
<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="n">write_sig</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">builder</span><span class="p">.</span><span class="n">import_signature</span><span class="p">(</span><span class="n">write_sig</span><span class="p">);</span>

<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="n">write_address</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pr</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="o">*</span><span class="k">const</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="kt">i64</span><span class="p">;</span>
<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="n">write_address</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">builder</span><span class="p">.</span><span class="n">ins</span><span class="p">().</span><span class="n">iconst</span><span class="p">(</span><span class="n">pointer_type</span><span class="p">,</span><span class="w"> </span><span class="n">write_address</span><span class="p">);</span>
<span class="w">        </span><span class="p">(</span><span class="n">write_sig</span><span class="p">,</span><span class="w"> </span><span class="n">write_address</span><span class="p">)</span>
<span class="w">    </span><span class="p">};</span>








<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">arg</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">builder</span><span class="p">.</span><span class="n">block_params</span><span class="p">(</span><span class="n">block</span><span class="p">)[</span><span class="mi">0</span><span class="p">];</span>


<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">plus_one</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">builder</span><span class="p">.</span><span class="n">ins</span><span class="p">().</span><span class="n">iadd_imm</span><span class="p">(</span><span class="n">arg</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">);</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">plus_two</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">builder</span><span class="p">.</span><span class="n">ins</span><span class="p">().</span><span class="n">iadd_imm</span><span class="p">(</span><span class="n">arg</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="p">);</span>


<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">plus_three</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">builder</span><span class="p">.</span><span class="n">ins</span><span class="p">().</span><span class="n">iadd</span><span class="p">(</span><span class="n">plus_one</span><span class="p">,</span><span class="n">plus_two</span><span class="p">);</span>





<span class="w">    </span><span class="n">builder</span><span class="p">.</span><span class="n">ins</span><span class="p">().</span><span class="n">call_indirect</span><span class="p">(</span><span class="n">write_sig</span><span class="p">,</span><span class="n">write_address</span><span class="p">,</span><span class="o">&amp;</span><span class="p">[</span><span class="n">plus_three</span><span class="p">,</span><span class="n">plus_three</span><span class="p">,</span><span class="n">plus_three</span><span class="p">,</span><span class="n">plus_three</span><span class="p">]);</span>
<span class="w">   </span><span class="c1">// builder.ins().store(mem_flags, cell_value, plus_three, 0);</span>

<span class="w">    </span><span class="n">builder</span><span class="p">.</span><span class="n">ins</span><span class="p">().</span><span class="n">return_</span><span class="p">(</span><span class="o">&amp;</span><span class="p">[</span><span class="n">plus_three</span><span class="p">,</span><span class="n">plus_three</span><span class="p">,</span><span class="n">plus_three</span><span class="p">]);</span>

<span class="w">    </span><span class="n">builder</span><span class="p">.</span><span class="n">finalize</span><span class="p">();</span>
<span class="w">    </span><span class="fm">println!</span><span class="p">(</span><span class="s">"{}"</span><span class="p">,</span><span class="w"> </span><span class="n">func</span><span class="p">.</span><span class="n">display</span><span class="p">());</span>





<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">ctx</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Context</span>::<span class="n">for_function</span><span class="p">(</span><span class="n">func</span><span class="p">);</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">code</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ctx</span><span class="p">.</span><span class="n">compile</span><span class="p">(</span><span class="o">&amp;*</span><span class="n">isa</span><span class="p">).</span><span class="n">unwrap</span><span class="p">();</span>

<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">buffer</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">memmap2</span>::<span class="n">MmapOptions</span>::<span class="n">new</span><span class="p">()</span>
<span class="w">        </span><span class="p">.</span><span class="n">len</span><span class="p">(</span><span class="n">code</span><span class="p">.</span><span class="n">buffer</span><span class="p">.</span><span class="n">data</span><span class="p">().</span><span class="n">len</span><span class="p">())</span>
<span class="w">        </span><span class="p">.</span><span class="n">map_anon</span><span class="p">()</span>
<span class="w">        </span><span class="p">.</span><span class="n">unwrap</span><span class="p">();</span>

<span class="w">    </span><span class="n">buffer</span><span class="p">.</span><span class="n">copy_from_slice</span><span class="p">(</span><span class="n">code</span><span class="p">.</span><span class="n">code_buffer</span><span class="p">());</span>

<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">buffer</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">buffer</span><span class="p">.</span><span class="n">make_exec</span><span class="p">().</span><span class="n">unwrap</span><span class="p">();</span>

<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">unsafe</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="n">code_fn</span>: <span class="nc">unsafe</span><span class="w"> </span><span class="k">extern</span><span class="w"> </span><span class="s">"sysv64"</span><span class="w"> </span><span class="k">fn</span><span class="p">(</span><span class="kt">usize</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="kt">usize</span> <span class="o">=</span>
<span class="w">            </span><span class="n">std</span>::<span class="n">mem</span>::<span class="n">transmute</span><span class="p">(</span><span class="n">buffer</span><span class="p">.</span><span class="n">as_ptr</span><span class="p">());</span>

<span class="w">        </span><span class="n">code_fn</span><span class="p">(</span><span class="mi">55</span><span class="p">)</span>
<span class="w">    </span><span class="p">};</span>

<span class="w">    </span><span class="fm">println!</span><span class="p">(</span><span class="s">"out: {}"</span><span class="p">,</span><span class="w"> </span><span class="n">x</span><span class="p">);</span>


<span class="p">}</span>
</code></pre></div>
<h3>Expected Results</h3>
<p>The pr should print out 113 4 times</p>
<h3>Actual Results</h3>
<p>The pr function prints out random values <br>
when you have the pr set up to only have 3 I64s<br>
the middle I64 is always correct <br>
when there is 2 or less I64s there are no correct results </p>
<p>when you have 4 I64s there are 2 correct and 2 wrong results. <br>
I have not tried added more I64 arguments </p>
<p>![bild](<a href="https://user-images.githubusercontent.com/32799244/222733355-ca869c9a-4e20-4752-99bf-53a4e14a2273.png">https://user-images.githubusercontent.com/32799244/222733355-ca869c9a-4e20-4752-99bf-53a4e14a2273.png</a>)</p>
<h3>Versions and Environment</h3>
<p>Cranelift version or commit: 0.93.0</p>
<p>Operating system: Windows 10 19042.1288</p>
<p>Architecture: X86</p>
<h3>Extra Info</h3>
<p>Im quite new to cranelift but this just does not make sense im unsure if I messed something up when experimenting but to me this seems like a bug. </p>
</blockquote>



<a name="339346688"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%235920%20Cranelift%3A%20call_indirect%20sends%20ran.../near/339346688" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.235920.20Cranelift.3A.20call_indirect.20sends.20ran.2E.2E.2E.html#339346688">(Mar 03 2023 at 13:36)</a>:</h4>
<p>salmmanfred labeled <a href="https://github.com/bytecodealliance/wasmtime/issues/5920">issue #5920</a>:</p>
<blockquote>
<p>Thanks for filing an issue! Please fill out the TODOs below.</p>
<h3><code>.clif</code> Test Case</h3>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="k">use</span><span class="w"> </span><span class="n">cranelift</span>::<span class="n">codegen</span>::<span class="n">ir</span>::<span class="p">{</span><span class="n">UserFuncName</span><span class="p">,</span><span class="w"> </span><span class="n">FuncRef</span><span class="p">};</span>
<span class="k">use</span><span class="w"> </span><span class="n">cranelift</span>::<span class="n">frontend</span>::<span class="p">{</span><span class="n">FunctionBuilder</span><span class="p">,</span><span class="w"> </span><span class="n">FunctionBuilderContext</span><span class="p">};</span>
<span class="k">use</span><span class="w"> </span><span class="n">cranelift</span>::<span class="n">codegen</span>::<span class="p">{</span>
<span class="w">    </span><span class="n">ir</span>::<span class="p">{</span><span class="n">types</span>::<span class="n">I64</span><span class="p">,</span><span class="w"> </span><span class="n">AbiParam</span><span class="p">,</span><span class="w"> </span><span class="n">Function</span><span class="p">,</span><span class="w"> </span><span class="n">Signature</span><span class="p">},</span>
<span class="w">    </span><span class="n">isa</span>::<span class="n">CallConv</span><span class="p">,</span>
<span class="p">};</span>
<span class="k">use</span><span class="w"> </span><span class="n">cranelift</span>::<span class="n">prelude</span>::<span class="p">{</span><span class="n">InstBuilder</span><span class="p">,</span><span class="w"> </span><span class="n">types</span><span class="p">,</span><span class="w"> </span><span class="n">ExtFuncData</span><span class="p">,</span><span class="w"> </span><span class="n">MemFlags</span><span class="p">,</span><span class="w"> </span><span class="n">EntityRef</span><span class="p">};</span>

<span class="k">use</span><span class="w"> </span><span class="n">cranelift</span>::<span class="n">codegen</span>::<span class="p">{</span><span class="n">isa</span><span class="p">,</span><span class="w"> </span><span class="n">settings</span><span class="p">,</span><span class="w"> </span><span class="n">Context</span><span class="p">};</span>
<span class="k">use</span><span class="w"> </span><span class="n">cranelift_jit</span>::<span class="p">{</span><span class="n">JITModule</span><span class="p">,</span><span class="w"> </span><span class="n">JITBuilder</span><span class="p">};</span>
<span class="k">use</span><span class="w"> </span><span class="n">target_lexicon</span>::<span class="n">Triple</span><span class="p">;</span>
<span class="k">use</span><span class="w"> </span><span class="n">cranelift_module</span>::<span class="p">{</span><span class="n">DataContext</span><span class="p">,</span><span class="w"> </span><span class="n">Linkage</span><span class="p">,</span><span class="w"> </span><span class="n">Module</span><span class="p">};</span>
<span class="k">use</span><span class="w"> </span><span class="n">core</span>::<span class="n">fmt</span>::<span class="n">write</span><span class="p">;</span>

<span class="k">fn</span> <span class="nf">pr</span><span class="p">(</span><span class="n">t</span>: <span class="kt">i64</span><span class="p">,</span><span class="n">b</span>:<span class="kt">i64</span><span class="p">,</span><span class="n">c</span>:<span class="kt">i64</span><span class="p">,</span><span class="n">d</span>:<span class="kt">i64</span><span class="p">){</span>

<span class="w">        </span><span class="fm">println!</span><span class="p">(</span><span class="s">"{t},{},{},{}"</span><span class="p">,</span><span class="n">b</span><span class="p">,</span><span class="n">c</span><span class="p">,</span><span class="n">d</span><span class="p">);</span>
<span class="w">    </span><span class="c1">//println!("{:?}",*t);</span>

<span class="p">}</span>

<span class="k">pub</span><span class="w"> </span><span class="k">fn</span> <span class="nf">test_compile</span><span class="p">(){</span>

<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">builder</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">settings</span>::<span class="n">builder</span><span class="p">();</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">flags</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">settings</span>::<span class="n">Flags</span>::<span class="n">new</span><span class="p">(</span><span class="n">builder</span><span class="p">);</span>

<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">isa</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">match</span><span class="w"> </span><span class="n">isa</span>::<span class="n">lookup</span><span class="p">(</span><span class="n">Triple</span>::<span class="n">host</span><span class="p">())</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nb">Err</span><span class="p">(</span><span class="n">err</span><span class="p">)</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="fm">panic!</span><span class="p">(</span><span class="s">"Error looking up target: {}"</span><span class="p">,</span><span class="w"> </span><span class="n">err</span><span class="p">),</span>
<span class="w">        </span><span class="nb">Ok</span><span class="p">(</span><span class="n">isa_builder</span><span class="p">)</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="n">isa_builder</span><span class="p">.</span><span class="n">finish</span><span class="p">(</span><span class="n">flags</span><span class="p">).</span><span class="n">unwrap</span><span class="p">(),</span>
<span class="w">    </span><span class="p">};</span>



<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">sig</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Signature</span>::<span class="n">new</span><span class="p">(</span><span class="n">CallConv</span>::<span class="n">SystemV</span><span class="p">);</span>
<span class="w">    </span><span class="n">sig</span><span class="p">.</span><span class="n">params</span><span class="p">.</span><span class="n">push</span><span class="p">(</span><span class="n">AbiParam</span>::<span class="n">new</span><span class="p">(</span><span class="n">I64</span><span class="p">));</span>


<span class="w">    </span><span class="n">sig</span><span class="p">.</span><span class="n">returns</span><span class="p">.</span><span class="n">push</span><span class="p">(</span><span class="n">AbiParam</span>::<span class="n">new</span><span class="p">(</span><span class="n">I64</span><span class="p">));</span>
<span class="w">    </span><span class="n">sig</span><span class="p">.</span><span class="n">returns</span><span class="p">.</span><span class="n">push</span><span class="p">(</span><span class="n">AbiParam</span>::<span class="n">new</span><span class="p">(</span><span class="n">I64</span><span class="p">));</span>
<span class="w">    </span><span class="n">sig</span><span class="p">.</span><span class="n">returns</span><span class="p">.</span><span class="n">push</span><span class="p">(</span><span class="n">AbiParam</span>::<span class="n">new</span><span class="p">(</span><span class="n">I64</span><span class="p">));</span>


<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">func</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Function</span>::<span class="n">with_name_signature</span><span class="p">(</span><span class="n">UserFuncName</span>::<span class="n">default</span><span class="p">(),</span><span class="w"> </span><span class="n">sig</span><span class="p">);</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">func_ctx</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">FunctionBuilderContext</span>::<span class="n">new</span><span class="p">();</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">builder</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">FunctionBuilder</span>::<span class="n">new</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="n">func</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="n">func_ctx</span><span class="p">);</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">pointer_type</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">isa</span><span class="p">.</span><span class="n">pointer_type</span><span class="p">();</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">block</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">builder</span><span class="p">.</span><span class="n">create_block</span><span class="p">();</span>
<span class="w">    </span><span class="n">builder</span><span class="p">.</span><span class="n">seal_block</span><span class="p">(</span><span class="n">block</span><span class="p">);</span>

<span class="w">    </span><span class="n">builder</span><span class="p">.</span><span class="n">append_block_params_for_function_params</span><span class="p">(</span><span class="n">block</span><span class="p">);</span>
<span class="w">    </span><span class="n">builder</span><span class="p">.</span><span class="n">switch_to_block</span><span class="p">(</span><span class="n">block</span><span class="p">);</span>


<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="p">(</span><span class="n">write_sig</span><span class="p">,</span><span class="w"> </span><span class="n">write_address</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">write_sig</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Signature</span>::<span class="n">new</span><span class="p">(</span><span class="n">CallConv</span>::<span class="n">SystemV</span><span class="p">);</span>
<span class="w">        </span><span class="n">write_sig</span><span class="p">.</span><span class="n">params</span><span class="p">.</span><span class="n">push</span><span class="p">(</span><span class="n">AbiParam</span>::<span class="n">new</span><span class="p">(</span><span class="n">types</span>::<span class="n">I64</span><span class="p">));</span>
<span class="w">        </span><span class="n">write_sig</span><span class="p">.</span><span class="n">params</span><span class="p">.</span><span class="n">push</span><span class="p">(</span><span class="n">AbiParam</span>::<span class="n">new</span><span class="p">(</span><span class="n">types</span>::<span class="n">I64</span><span class="p">));</span>
<span class="w">        </span><span class="n">write_sig</span><span class="p">.</span><span class="n">params</span><span class="p">.</span><span class="n">push</span><span class="p">(</span><span class="n">AbiParam</span>::<span class="n">new</span><span class="p">(</span><span class="n">types</span>::<span class="n">I64</span><span class="p">));</span>
<span class="w">        </span><span class="n">write_sig</span><span class="p">.</span><span class="n">params</span><span class="p">.</span><span class="n">push</span><span class="p">(</span><span class="n">AbiParam</span>::<span class="n">new</span><span class="p">(</span><span class="n">types</span>::<span class="n">I64</span><span class="p">));</span>


<span class="w">       </span><span class="c1">// write_sig.returns.push(AbiParam::new(pointer_type));</span>
<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="n">write_sig</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">builder</span><span class="p">.</span><span class="n">import_signature</span><span class="p">(</span><span class="n">write_sig</span><span class="p">);</span>

<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="n">write_address</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pr</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="o">*</span><span class="k">const</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="kt">i64</span><span class="p">;</span>
<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="n">write_address</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">builder</span><span class="p">.</span><span class="n">ins</span><span class="p">().</span><span class="n">iconst</span><span class="p">(</span><span class="n">pointer_type</span><span class="p">,</span><span class="w"> </span><span class="n">write_address</span><span class="p">);</span>
<span class="w">        </span><span class="p">(</span><span class="n">write_sig</span><span class="p">,</span><span class="w"> </span><span class="n">write_address</span><span class="p">)</span>
<span class="w">    </span><span class="p">};</span>








<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">arg</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">builder</span><span class="p">.</span><span class="n">block_params</span><span class="p">(</span><span class="n">block</span><span class="p">)[</span><span class="mi">0</span><span class="p">];</span>


<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">plus_one</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">builder</span><span class="p">.</span><span class="n">ins</span><span class="p">().</span><span class="n">iadd_imm</span><span class="p">(</span><span class="n">arg</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">);</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">plus_two</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">builder</span><span class="p">.</span><span class="n">ins</span><span class="p">().</span><span class="n">iadd_imm</span><span class="p">(</span><span class="n">arg</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="p">);</span>


<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">plus_three</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">builder</span><span class="p">.</span><span class="n">ins</span><span class="p">().</span><span class="n">iadd</span><span class="p">(</span><span class="n">plus_one</span><span class="p">,</span><span class="n">plus_two</span><span class="p">);</span>





<span class="w">    </span><span class="n">builder</span><span class="p">.</span><span class="n">ins</span><span class="p">().</span><span class="n">call_indirect</span><span class="p">(</span><span class="n">write_sig</span><span class="p">,</span><span class="n">write_address</span><span class="p">,</span><span class="o">&amp;</span><span class="p">[</span><span class="n">plus_three</span><span class="p">,</span><span class="n">plus_three</span><span class="p">,</span><span class="n">plus_three</span><span class="p">,</span><span class="n">plus_three</span><span class="p">]);</span>
<span class="w">   </span><span class="c1">// builder.ins().store(mem_flags, cell_value, plus_three, 0);</span>

<span class="w">    </span><span class="n">builder</span><span class="p">.</span><span class="n">ins</span><span class="p">().</span><span class="n">return_</span><span class="p">(</span><span class="o">&amp;</span><span class="p">[</span><span class="n">plus_three</span><span class="p">,</span><span class="n">plus_three</span><span class="p">,</span><span class="n">plus_three</span><span class="p">]);</span>

<span class="w">    </span><span class="n">builder</span><span class="p">.</span><span class="n">finalize</span><span class="p">();</span>
<span class="w">    </span><span class="fm">println!</span><span class="p">(</span><span class="s">"{}"</span><span class="p">,</span><span class="w"> </span><span class="n">func</span><span class="p">.</span><span class="n">display</span><span class="p">());</span>





<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">ctx</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Context</span>::<span class="n">for_function</span><span class="p">(</span><span class="n">func</span><span class="p">);</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">code</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ctx</span><span class="p">.</span><span class="n">compile</span><span class="p">(</span><span class="o">&amp;*</span><span class="n">isa</span><span class="p">).</span><span class="n">unwrap</span><span class="p">();</span>

<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">buffer</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">memmap2</span>::<span class="n">MmapOptions</span>::<span class="n">new</span><span class="p">()</span>
<span class="w">        </span><span class="p">.</span><span class="n">len</span><span class="p">(</span><span class="n">code</span><span class="p">.</span><span class="n">buffer</span><span class="p">.</span><span class="n">data</span><span class="p">().</span><span class="n">len</span><span class="p">())</span>
<span class="w">        </span><span class="p">.</span><span class="n">map_anon</span><span class="p">()</span>
<span class="w">        </span><span class="p">.</span><span class="n">unwrap</span><span class="p">();</span>

<span class="w">    </span><span class="n">buffer</span><span class="p">.</span><span class="n">copy_from_slice</span><span class="p">(</span><span class="n">code</span><span class="p">.</span><span class="n">code_buffer</span><span class="p">());</span>

<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">buffer</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">buffer</span><span class="p">.</span><span class="n">make_exec</span><span class="p">().</span><span class="n">unwrap</span><span class="p">();</span>

<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">unsafe</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="n">code_fn</span>: <span class="nc">unsafe</span><span class="w"> </span><span class="k">extern</span><span class="w"> </span><span class="s">"sysv64"</span><span class="w"> </span><span class="k">fn</span><span class="p">(</span><span class="kt">usize</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="kt">usize</span> <span class="o">=</span>
<span class="w">            </span><span class="n">std</span>::<span class="n">mem</span>::<span class="n">transmute</span><span class="p">(</span><span class="n">buffer</span><span class="p">.</span><span class="n">as_ptr</span><span class="p">());</span>

<span class="w">        </span><span class="n">code_fn</span><span class="p">(</span><span class="mi">55</span><span class="p">)</span>
<span class="w">    </span><span class="p">};</span>

<span class="w">    </span><span class="fm">println!</span><span class="p">(</span><span class="s">"out: {}"</span><span class="p">,</span><span class="w"> </span><span class="n">x</span><span class="p">);</span>


<span class="p">}</span>
</code></pre></div>
<h3>Expected Results</h3>
<p>The pr should print out 113 4 times</p>
<h3>Actual Results</h3>
<p>The pr function prints out random values <br>
when you have the pr set up to only have 3 I64s<br>
the middle I64 is always correct <br>
when there is 2 or less I64s there are no correct results </p>
<p>when you have 4 I64s there are 2 correct and 2 wrong results. <br>
I have not tried added more I64 arguments </p>
<p>![bild](<a href="https://user-images.githubusercontent.com/32799244/222733355-ca869c9a-4e20-4752-99bf-53a4e14a2273.png">https://user-images.githubusercontent.com/32799244/222733355-ca869c9a-4e20-4752-99bf-53a4e14a2273.png</a>)</p>
<h3>Versions and Environment</h3>
<p>Cranelift version or commit: 0.93.0</p>
<p>Operating system: Windows 10 19042.1288</p>
<p>Architecture: X86</p>
<h3>Extra Info</h3>
<p>Im quite new to cranelift but this just does not make sense im unsure if I messed something up when experimenting but to me this seems like a bug. </p>
</blockquote>



<a name="339346689"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%235920%20Cranelift%3A%20call_indirect%20sends%20ran.../near/339346689" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.235920.20Cranelift.3A.20call_indirect.20sends.20ran.2E.2E.2E.html#339346689">(Mar 03 2023 at 13:36)</a>:</h4>
<p>salmmanfred labeled <a href="https://github.com/bytecodealliance/wasmtime/issues/5920">issue #5920</a>:</p>
<blockquote>
<p>Thanks for filing an issue! Please fill out the TODOs below.</p>
<h3><code>.clif</code> Test Case</h3>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="k">use</span><span class="w"> </span><span class="n">cranelift</span>::<span class="n">codegen</span>::<span class="n">ir</span>::<span class="p">{</span><span class="n">UserFuncName</span><span class="p">,</span><span class="w"> </span><span class="n">FuncRef</span><span class="p">};</span>
<span class="k">use</span><span class="w"> </span><span class="n">cranelift</span>::<span class="n">frontend</span>::<span class="p">{</span><span class="n">FunctionBuilder</span><span class="p">,</span><span class="w"> </span><span class="n">FunctionBuilderContext</span><span class="p">};</span>
<span class="k">use</span><span class="w"> </span><span class="n">cranelift</span>::<span class="n">codegen</span>::<span class="p">{</span>
<span class="w">    </span><span class="n">ir</span>::<span class="p">{</span><span class="n">types</span>::<span class="n">I64</span><span class="p">,</span><span class="w"> </span><span class="n">AbiParam</span><span class="p">,</span><span class="w"> </span><span class="n">Function</span><span class="p">,</span><span class="w"> </span><span class="n">Signature</span><span class="p">},</span>
<span class="w">    </span><span class="n">isa</span>::<span class="n">CallConv</span><span class="p">,</span>
<span class="p">};</span>
<span class="k">use</span><span class="w"> </span><span class="n">cranelift</span>::<span class="n">prelude</span>::<span class="p">{</span><span class="n">InstBuilder</span><span class="p">,</span><span class="w"> </span><span class="n">types</span><span class="p">,</span><span class="w"> </span><span class="n">ExtFuncData</span><span class="p">,</span><span class="w"> </span><span class="n">MemFlags</span><span class="p">,</span><span class="w"> </span><span class="n">EntityRef</span><span class="p">};</span>

<span class="k">use</span><span class="w"> </span><span class="n">cranelift</span>::<span class="n">codegen</span>::<span class="p">{</span><span class="n">isa</span><span class="p">,</span><span class="w"> </span><span class="n">settings</span><span class="p">,</span><span class="w"> </span><span class="n">Context</span><span class="p">};</span>
<span class="k">use</span><span class="w"> </span><span class="n">cranelift_jit</span>::<span class="p">{</span><span class="n">JITModule</span><span class="p">,</span><span class="w"> </span><span class="n">JITBuilder</span><span class="p">};</span>
<span class="k">use</span><span class="w"> </span><span class="n">target_lexicon</span>::<span class="n">Triple</span><span class="p">;</span>
<span class="k">use</span><span class="w"> </span><span class="n">cranelift_module</span>::<span class="p">{</span><span class="n">DataContext</span><span class="p">,</span><span class="w"> </span><span class="n">Linkage</span><span class="p">,</span><span class="w"> </span><span class="n">Module</span><span class="p">};</span>
<span class="k">use</span><span class="w"> </span><span class="n">core</span>::<span class="n">fmt</span>::<span class="n">write</span><span class="p">;</span>

<span class="k">fn</span> <span class="nf">pr</span><span class="p">(</span><span class="n">t</span>: <span class="kt">i64</span><span class="p">,</span><span class="n">b</span>:<span class="kt">i64</span><span class="p">,</span><span class="n">c</span>:<span class="kt">i64</span><span class="p">,</span><span class="n">d</span>:<span class="kt">i64</span><span class="p">){</span>

<span class="w">        </span><span class="fm">println!</span><span class="p">(</span><span class="s">"{t},{},{},{}"</span><span class="p">,</span><span class="n">b</span><span class="p">,</span><span class="n">c</span><span class="p">,</span><span class="n">d</span><span class="p">);</span>
<span class="w">    </span><span class="c1">//println!("{:?}",*t);</span>

<span class="p">}</span>

<span class="k">pub</span><span class="w"> </span><span class="k">fn</span> <span class="nf">test_compile</span><span class="p">(){</span>

<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">builder</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">settings</span>::<span class="n">builder</span><span class="p">();</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">flags</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">settings</span>::<span class="n">Flags</span>::<span class="n">new</span><span class="p">(</span><span class="n">builder</span><span class="p">);</span>

<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">isa</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">match</span><span class="w"> </span><span class="n">isa</span>::<span class="n">lookup</span><span class="p">(</span><span class="n">Triple</span>::<span class="n">host</span><span class="p">())</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nb">Err</span><span class="p">(</span><span class="n">err</span><span class="p">)</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="fm">panic!</span><span class="p">(</span><span class="s">"Error looking up target: {}"</span><span class="p">,</span><span class="w"> </span><span class="n">err</span><span class="p">),</span>
<span class="w">        </span><span class="nb">Ok</span><span class="p">(</span><span class="n">isa_builder</span><span class="p">)</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="n">isa_builder</span><span class="p">.</span><span class="n">finish</span><span class="p">(</span><span class="n">flags</span><span class="p">).</span><span class="n">unwrap</span><span class="p">(),</span>
<span class="w">    </span><span class="p">};</span>



<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">sig</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Signature</span>::<span class="n">new</span><span class="p">(</span><span class="n">CallConv</span>::<span class="n">SystemV</span><span class="p">);</span>
<span class="w">    </span><span class="n">sig</span><span class="p">.</span><span class="n">params</span><span class="p">.</span><span class="n">push</span><span class="p">(</span><span class="n">AbiParam</span>::<span class="n">new</span><span class="p">(</span><span class="n">I64</span><span class="p">));</span>


<span class="w">    </span><span class="n">sig</span><span class="p">.</span><span class="n">returns</span><span class="p">.</span><span class="n">push</span><span class="p">(</span><span class="n">AbiParam</span>::<span class="n">new</span><span class="p">(</span><span class="n">I64</span><span class="p">));</span>
<span class="w">    </span><span class="n">sig</span><span class="p">.</span><span class="n">returns</span><span class="p">.</span><span class="n">push</span><span class="p">(</span><span class="n">AbiParam</span>::<span class="n">new</span><span class="p">(</span><span class="n">I64</span><span class="p">));</span>
<span class="w">    </span><span class="n">sig</span><span class="p">.</span><span class="n">returns</span><span class="p">.</span><span class="n">push</span><span class="p">(</span><span class="n">AbiParam</span>::<span class="n">new</span><span class="p">(</span><span class="n">I64</span><span class="p">));</span>


<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">func</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Function</span>::<span class="n">with_name_signature</span><span class="p">(</span><span class="n">UserFuncName</span>::<span class="n">default</span><span class="p">(),</span><span class="w"> </span><span class="n">sig</span><span class="p">);</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">func_ctx</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">FunctionBuilderContext</span>::<span class="n">new</span><span class="p">();</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">builder</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">FunctionBuilder</span>::<span class="n">new</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="n">func</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="n">func_ctx</span><span class="p">);</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">pointer_type</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">isa</span><span class="p">.</span><span class="n">pointer_type</span><span class="p">();</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">block</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">builder</span><span class="p">.</span><span class="n">create_block</span><span class="p">();</span>
<span class="w">    </span><span class="n">builder</span><span class="p">.</span><span class="n">seal_block</span><span class="p">(</span><span class="n">block</span><span class="p">);</span>

<span class="w">    </span><span class="n">builder</span><span class="p">.</span><span class="n">append_block_params_for_function_params</span><span class="p">(</span><span class="n">block</span><span class="p">);</span>
<span class="w">    </span><span class="n">builder</span><span class="p">.</span><span class="n">switch_to_block</span><span class="p">(</span><span class="n">block</span><span class="p">);</span>


<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="p">(</span><span class="n">write_sig</span><span class="p">,</span><span class="w"> </span><span class="n">write_address</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">write_sig</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Signature</span>::<span class="n">new</span><span class="p">(</span><span class="n">CallConv</span>::<span class="n">SystemV</span><span class="p">);</span>
<span class="w">        </span><span class="n">write_sig</span><span class="p">.</span><span class="n">params</span><span class="p">.</span><span class="n">push</span><span class="p">(</span><span class="n">AbiParam</span>::<span class="n">new</span><span class="p">(</span><span class="n">types</span>::<span class="n">I64</span><span class="p">));</span>
<span class="w">        </span><span class="n">write_sig</span><span class="p">.</span><span class="n">params</span><span class="p">.</span><span class="n">push</span><span class="p">(</span><span class="n">AbiParam</span>::<span class="n">new</span><span class="p">(</span><span class="n">types</span>::<span class="n">I64</span><span class="p">));</span>
<span class="w">        </span><span class="n">write_sig</span><span class="p">.</span><span class="n">params</span><span class="p">.</span><span class="n">push</span><span class="p">(</span><span class="n">AbiParam</span>::<span class="n">new</span><span class="p">(</span><span class="n">types</span>::<span class="n">I64</span><span class="p">));</span>
<span class="w">        </span><span class="n">write_sig</span><span class="p">.</span><span class="n">params</span><span class="p">.</span><span class="n">push</span><span class="p">(</span><span class="n">AbiParam</span>::<span class="n">new</span><span class="p">(</span><span class="n">types</span>::<span class="n">I64</span><span class="p">));</span>


<span class="w">       </span><span class="c1">// write_sig.returns.push(AbiParam::new(pointer_type));</span>
<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="n">write_sig</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">builder</span><span class="p">.</span><span class="n">import_signature</span><span class="p">(</span><span class="n">write_sig</span><span class="p">);</span>

<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="n">write_address</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pr</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="o">*</span><span class="k">const</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="kt">i64</span><span class="p">;</span>
<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="n">write_address</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">builder</span><span class="p">.</span><span class="n">ins</span><span class="p">().</span><span class="n">iconst</span><span class="p">(</span><span class="n">pointer_type</span><span class="p">,</span><span class="w"> </span><span class="n">write_address</span><span class="p">);</span>
<span class="w">        </span><span class="p">(</span><span class="n">write_sig</span><span class="p">,</span><span class="w"> </span><span class="n">write_address</span><span class="p">)</span>
<span class="w">    </span><span class="p">};</span>








<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">arg</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">builder</span><span class="p">.</span><span class="n">block_params</span><span class="p">(</span><span class="n">block</span><span class="p">)[</span><span class="mi">0</span><span class="p">];</span>


<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">plus_one</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">builder</span><span class="p">.</span><span class="n">ins</span><span class="p">().</span><span class="n">iadd_imm</span><span class="p">(</span><span class="n">arg</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">);</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">plus_two</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">builder</span><span class="p">.</span><span class="n">ins</span><span class="p">().</span><span class="n">iadd_imm</span><span class="p">(</span><span class="n">arg</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="p">);</span>


<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">plus_three</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">builder</span><span class="p">.</span><span class="n">ins</span><span class="p">().</span><span class="n">iadd</span><span class="p">(</span><span class="n">plus_one</span><span class="p">,</span><span class="n">plus_two</span><span class="p">);</span>





<span class="w">    </span><span class="n">builder</span><span class="p">.</span><span class="n">ins</span><span class="p">().</span><span class="n">call_indirect</span><span class="p">(</span><span class="n">write_sig</span><span class="p">,</span><span class="n">write_address</span><span class="p">,</span><span class="o">&amp;</span><span class="p">[</span><span class="n">plus_three</span><span class="p">,</span><span class="n">plus_three</span><span class="p">,</span><span class="n">plus_three</span><span class="p">,</span><span class="n">plus_three</span><span class="p">]);</span>
<span class="w">   </span><span class="c1">// builder.ins().store(mem_flags, cell_value, plus_three, 0);</span>

<span class="w">    </span><span class="n">builder</span><span class="p">.</span><span class="n">ins</span><span class="p">().</span><span class="n">return_</span><span class="p">(</span><span class="o">&amp;</span><span class="p">[</span><span class="n">plus_three</span><span class="p">,</span><span class="n">plus_three</span><span class="p">,</span><span class="n">plus_three</span><span class="p">]);</span>

<span class="w">    </span><span class="n">builder</span><span class="p">.</span><span class="n">finalize</span><span class="p">();</span>
<span class="w">    </span><span class="fm">println!</span><span class="p">(</span><span class="s">"{}"</span><span class="p">,</span><span class="w"> </span><span class="n">func</span><span class="p">.</span><span class="n">display</span><span class="p">());</span>





<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">ctx</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Context</span>::<span class="n">for_function</span><span class="p">(</span><span class="n">func</span><span class="p">);</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">code</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ctx</span><span class="p">.</span><span class="n">compile</span><span class="p">(</span><span class="o">&amp;*</span><span class="n">isa</span><span class="p">).</span><span class="n">unwrap</span><span class="p">();</span>

<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">buffer</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">memmap2</span>::<span class="n">MmapOptions</span>::<span class="n">new</span><span class="p">()</span>
<span class="w">        </span><span class="p">.</span><span class="n">len</span><span class="p">(</span><span class="n">code</span><span class="p">.</span><span class="n">buffer</span><span class="p">.</span><span class="n">data</span><span class="p">().</span><span class="n">len</span><span class="p">())</span>
<span class="w">        </span><span class="p">.</span><span class="n">map_anon</span><span class="p">()</span>
<span class="w">        </span><span class="p">.</span><span class="n">unwrap</span><span class="p">();</span>

<span class="w">    </span><span class="n">buffer</span><span class="p">.</span><span class="n">copy_from_slice</span><span class="p">(</span><span class="n">code</span><span class="p">.</span><span class="n">code_buffer</span><span class="p">());</span>

<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">buffer</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">buffer</span><span class="p">.</span><span class="n">make_exec</span><span class="p">().</span><span class="n">unwrap</span><span class="p">();</span>

<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">unsafe</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="n">code_fn</span>: <span class="nc">unsafe</span><span class="w"> </span><span class="k">extern</span><span class="w"> </span><span class="s">"sysv64"</span><span class="w"> </span><span class="k">fn</span><span class="p">(</span><span class="kt">usize</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="kt">usize</span> <span class="o">=</span>
<span class="w">            </span><span class="n">std</span>::<span class="n">mem</span>::<span class="n">transmute</span><span class="p">(</span><span class="n">buffer</span><span class="p">.</span><span class="n">as_ptr</span><span class="p">());</span>

<span class="w">        </span><span class="n">code_fn</span><span class="p">(</span><span class="mi">55</span><span class="p">)</span>
<span class="w">    </span><span class="p">};</span>

<span class="w">    </span><span class="fm">println!</span><span class="p">(</span><span class="s">"out: {}"</span><span class="p">,</span><span class="w"> </span><span class="n">x</span><span class="p">);</span>


<span class="p">}</span>
</code></pre></div>
<h3>Expected Results</h3>
<p>The pr should print out 113 4 times</p>
<h3>Actual Results</h3>
<p>The pr function prints out random values <br>
when you have the pr set up to only have 3 I64s<br>
the middle I64 is always correct <br>
when there is 2 or less I64s there are no correct results </p>
<p>when you have 4 I64s there are 2 correct and 2 wrong results. <br>
I have not tried added more I64 arguments </p>
<p>![bild](<a href="https://user-images.githubusercontent.com/32799244/222733355-ca869c9a-4e20-4752-99bf-53a4e14a2273.png">https://user-images.githubusercontent.com/32799244/222733355-ca869c9a-4e20-4752-99bf-53a4e14a2273.png</a>)</p>
<h3>Versions and Environment</h3>
<p>Cranelift version or commit: 0.93.0</p>
<p>Operating system: Windows 10 19042.1288</p>
<p>Architecture: X86</p>
<h3>Extra Info</h3>
<p>Im quite new to cranelift but this just does not make sense im unsure if I messed something up when experimenting but to me this seems like a bug. </p>
</blockquote>



<a name="339346783"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%235920%20Cranelift%3A%20call_indirect%20sends%20ran.../near/339346783" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.235920.20Cranelift.3A.20call_indirect.20sends.20ran.2E.2E.2E.html#339346783">(Mar 03 2023 at 13:36)</a>:</h4>
<p>salmmanfred edited <a href="https://github.com/bytecodealliance/wasmtime/issues/5920">issue #5920</a>:</p>
<blockquote>
<p>Thanks for filing an issue! Please fill out the TODOs below.</p>
<h3>The Code</h3>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="k">use</span><span class="w"> </span><span class="n">cranelift</span>::<span class="n">codegen</span>::<span class="n">ir</span>::<span class="p">{</span><span class="n">UserFuncName</span><span class="p">,</span><span class="w"> </span><span class="n">FuncRef</span><span class="p">};</span>
<span class="k">use</span><span class="w"> </span><span class="n">cranelift</span>::<span class="n">frontend</span>::<span class="p">{</span><span class="n">FunctionBuilder</span><span class="p">,</span><span class="w"> </span><span class="n">FunctionBuilderContext</span><span class="p">};</span>
<span class="k">use</span><span class="w"> </span><span class="n">cranelift</span>::<span class="n">codegen</span>::<span class="p">{</span>
<span class="w">    </span><span class="n">ir</span>::<span class="p">{</span><span class="n">types</span>::<span class="n">I64</span><span class="p">,</span><span class="w"> </span><span class="n">AbiParam</span><span class="p">,</span><span class="w"> </span><span class="n">Function</span><span class="p">,</span><span class="w"> </span><span class="n">Signature</span><span class="p">},</span>
<span class="w">    </span><span class="n">isa</span>::<span class="n">CallConv</span><span class="p">,</span>
<span class="p">};</span>
<span class="k">use</span><span class="w"> </span><span class="n">cranelift</span>::<span class="n">prelude</span>::<span class="p">{</span><span class="n">InstBuilder</span><span class="p">,</span><span class="w"> </span><span class="n">types</span><span class="p">,</span><span class="w"> </span><span class="n">ExtFuncData</span><span class="p">,</span><span class="w"> </span><span class="n">MemFlags</span><span class="p">,</span><span class="w"> </span><span class="n">EntityRef</span><span class="p">};</span>

<span class="k">use</span><span class="w"> </span><span class="n">cranelift</span>::<span class="n">codegen</span>::<span class="p">{</span><span class="n">isa</span><span class="p">,</span><span class="w"> </span><span class="n">settings</span><span class="p">,</span><span class="w"> </span><span class="n">Context</span><span class="p">};</span>
<span class="k">use</span><span class="w"> </span><span class="n">cranelift_jit</span>::<span class="p">{</span><span class="n">JITModule</span><span class="p">,</span><span class="w"> </span><span class="n">JITBuilder</span><span class="p">};</span>
<span class="k">use</span><span class="w"> </span><span class="n">target_lexicon</span>::<span class="n">Triple</span><span class="p">;</span>
<span class="k">use</span><span class="w"> </span><span class="n">cranelift_module</span>::<span class="p">{</span><span class="n">DataContext</span><span class="p">,</span><span class="w"> </span><span class="n">Linkage</span><span class="p">,</span><span class="w"> </span><span class="n">Module</span><span class="p">};</span>
<span class="k">use</span><span class="w"> </span><span class="n">core</span>::<span class="n">fmt</span>::<span class="n">write</span><span class="p">;</span>

<span class="k">fn</span> <span class="nf">pr</span><span class="p">(</span><span class="n">t</span>: <span class="kt">i64</span><span class="p">,</span><span class="n">b</span>:<span class="kt">i64</span><span class="p">,</span><span class="n">c</span>:<span class="kt">i64</span><span class="p">,</span><span class="n">d</span>:<span class="kt">i64</span><span class="p">){</span>

<span class="w">        </span><span class="fm">println!</span><span class="p">(</span><span class="s">"{t},{},{},{}"</span><span class="p">,</span><span class="n">b</span><span class="p">,</span><span class="n">c</span><span class="p">,</span><span class="n">d</span><span class="p">);</span>
<span class="w">    </span><span class="c1">//println!("{:?}",*t);</span>

<span class="p">}</span>

<span class="k">pub</span><span class="w"> </span><span class="k">fn</span> <span class="nf">test_compile</span><span class="p">(){</span>

<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">builder</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">settings</span>::<span class="n">builder</span><span class="p">();</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">flags</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">settings</span>::<span class="n">Flags</span>::<span class="n">new</span><span class="p">(</span><span class="n">builder</span><span class="p">);</span>

<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">isa</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">match</span><span class="w"> </span><span class="n">isa</span>::<span class="n">lookup</span><span class="p">(</span><span class="n">Triple</span>::<span class="n">host</span><span class="p">())</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nb">Err</span><span class="p">(</span><span class="n">err</span><span class="p">)</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="fm">panic!</span><span class="p">(</span><span class="s">"Error looking up target: {}"</span><span class="p">,</span><span class="w"> </span><span class="n">err</span><span class="p">),</span>
<span class="w">        </span><span class="nb">Ok</span><span class="p">(</span><span class="n">isa_builder</span><span class="p">)</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="n">isa_builder</span><span class="p">.</span><span class="n">finish</span><span class="p">(</span><span class="n">flags</span><span class="p">).</span><span class="n">unwrap</span><span class="p">(),</span>
<span class="w">    </span><span class="p">};</span>



<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">sig</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Signature</span>::<span class="n">new</span><span class="p">(</span><span class="n">CallConv</span>::<span class="n">SystemV</span><span class="p">);</span>
<span class="w">    </span><span class="n">sig</span><span class="p">.</span><span class="n">params</span><span class="p">.</span><span class="n">push</span><span class="p">(</span><span class="n">AbiParam</span>::<span class="n">new</span><span class="p">(</span><span class="n">I64</span><span class="p">));</span>


<span class="w">    </span><span class="n">sig</span><span class="p">.</span><span class="n">returns</span><span class="p">.</span><span class="n">push</span><span class="p">(</span><span class="n">AbiParam</span>::<span class="n">new</span><span class="p">(</span><span class="n">I64</span><span class="p">));</span>
<span class="w">    </span><span class="n">sig</span><span class="p">.</span><span class="n">returns</span><span class="p">.</span><span class="n">push</span><span class="p">(</span><span class="n">AbiParam</span>::<span class="n">new</span><span class="p">(</span><span class="n">I64</span><span class="p">));</span>
<span class="w">    </span><span class="n">sig</span><span class="p">.</span><span class="n">returns</span><span class="p">.</span><span class="n">push</span><span class="p">(</span><span class="n">AbiParam</span>::<span class="n">new</span><span class="p">(</span><span class="n">I64</span><span class="p">));</span>


<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">func</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Function</span>::<span class="n">with_name_signature</span><span class="p">(</span><span class="n">UserFuncName</span>::<span class="n">default</span><span class="p">(),</span><span class="w"> </span><span class="n">sig</span><span class="p">);</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">func_ctx</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">FunctionBuilderContext</span>::<span class="n">new</span><span class="p">();</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">builder</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">FunctionBuilder</span>::<span class="n">new</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="n">func</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="n">func_ctx</span><span class="p">);</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">pointer_type</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">isa</span><span class="p">.</span><span class="n">pointer_type</span><span class="p">();</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">block</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">builder</span><span class="p">.</span><span class="n">create_block</span><span class="p">();</span>
<span class="w">    </span><span class="n">builder</span><span class="p">.</span><span class="n">seal_block</span><span class="p">(</span><span class="n">block</span><span class="p">);</span>

<span class="w">    </span><span class="n">builder</span><span class="p">.</span><span class="n">append_block_params_for_function_params</span><span class="p">(</span><span class="n">block</span><span class="p">);</span>
<span class="w">    </span><span class="n">builder</span><span class="p">.</span><span class="n">switch_to_block</span><span class="p">(</span><span class="n">block</span><span class="p">);</span>


<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="p">(</span><span class="n">write_sig</span><span class="p">,</span><span class="w"> </span><span class="n">write_address</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">write_sig</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Signature</span>::<span class="n">new</span><span class="p">(</span><span class="n">CallConv</span>::<span class="n">SystemV</span><span class="p">);</span>
<span class="w">        </span><span class="n">write_sig</span><span class="p">.</span><span class="n">params</span><span class="p">.</span><span class="n">push</span><span class="p">(</span><span class="n">AbiParam</span>::<span class="n">new</span><span class="p">(</span><span class="n">types</span>::<span class="n">I64</span><span class="p">));</span>
<span class="w">        </span><span class="n">write_sig</span><span class="p">.</span><span class="n">params</span><span class="p">.</span><span class="n">push</span><span class="p">(</span><span class="n">AbiParam</span>::<span class="n">new</span><span class="p">(</span><span class="n">types</span>::<span class="n">I64</span><span class="p">));</span>
<span class="w">        </span><span class="n">write_sig</span><span class="p">.</span><span class="n">params</span><span class="p">.</span><span class="n">push</span><span class="p">(</span><span class="n">AbiParam</span>::<span class="n">new</span><span class="p">(</span><span class="n">types</span>::<span class="n">I64</span><span class="p">));</span>
<span class="w">        </span><span class="n">write_sig</span><span class="p">.</span><span class="n">params</span><span class="p">.</span><span class="n">push</span><span class="p">(</span><span class="n">AbiParam</span>::<span class="n">new</span><span class="p">(</span><span class="n">types</span>::<span class="n">I64</span><span class="p">));</span>


<span class="w">       </span><span class="c1">// write_sig.returns.push(AbiParam::new(pointer_type));</span>
<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="n">write_sig</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">builder</span><span class="p">.</span><span class="n">import_signature</span><span class="p">(</span><span class="n">write_sig</span><span class="p">);</span>

<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="n">write_address</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pr</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="o">*</span><span class="k">const</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="kt">i64</span><span class="p">;</span>
<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="n">write_address</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">builder</span><span class="p">.</span><span class="n">ins</span><span class="p">().</span><span class="n">iconst</span><span class="p">(</span><span class="n">pointer_type</span><span class="p">,</span><span class="w"> </span><span class="n">write_address</span><span class="p">);</span>
<span class="w">        </span><span class="p">(</span><span class="n">write_sig</span><span class="p">,</span><span class="w"> </span><span class="n">write_address</span><span class="p">)</span>
<span class="w">    </span><span class="p">};</span>








<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">arg</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">builder</span><span class="p">.</span><span class="n">block_params</span><span class="p">(</span><span class="n">block</span><span class="p">)[</span><span class="mi">0</span><span class="p">];</span>


<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">plus_one</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">builder</span><span class="p">.</span><span class="n">ins</span><span class="p">().</span><span class="n">iadd_imm</span><span class="p">(</span><span class="n">arg</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">);</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">plus_two</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">builder</span><span class="p">.</span><span class="n">ins</span><span class="p">().</span><span class="n">iadd_imm</span><span class="p">(</span><span class="n">arg</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="p">);</span>


<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">plus_three</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">builder</span><span class="p">.</span><span class="n">ins</span><span class="p">().</span><span class="n">iadd</span><span class="p">(</span><span class="n">plus_one</span><span class="p">,</span><span class="n">plus_two</span><span class="p">);</span>





<span class="w">    </span><span class="n">builder</span><span class="p">.</span><span class="n">ins</span><span class="p">().</span><span class="n">call_indirect</span><span class="p">(</span><span class="n">write_sig</span><span class="p">,</span><span class="n">write_address</span><span class="p">,</span><span class="o">&amp;</span><span class="p">[</span><span class="n">plus_three</span><span class="p">,</span><span class="n">plus_three</span><span class="p">,</span><span class="n">plus_three</span><span class="p">,</span><span class="n">plus_three</span><span class="p">]);</span>
<span class="w">   </span><span class="c1">// builder.ins().store(mem_flags, cell_value, plus_three, 0);</span>

<span class="w">    </span><span class="n">builder</span><span class="p">.</span><span class="n">ins</span><span class="p">().</span><span class="n">return_</span><span class="p">(</span><span class="o">&amp;</span><span class="p">[</span><span class="n">plus_three</span><span class="p">,</span><span class="n">plus_three</span><span class="p">,</span><span class="n">plus_three</span><span class="p">]);</span>

<span class="w">    </span><span class="n">builder</span><span class="p">.</span><span class="n">finalize</span><span class="p">();</span>
<span class="w">    </span><span class="fm">println!</span><span class="p">(</span><span class="s">"{}"</span><span class="p">,</span><span class="w"> </span><span class="n">func</span><span class="p">.</span><span class="n">display</span><span class="p">());</span>





<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">ctx</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Context</span>::<span class="n">for_function</span><span class="p">(</span><span class="n">func</span><span class="p">);</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">code</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ctx</span><span class="p">.</span><span class="n">compile</span><span class="p">(</span><span class="o">&amp;*</span><span class="n">isa</span><span class="p">).</span><span class="n">unwrap</span><span class="p">();</span>

<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">buffer</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">memmap2</span>::<span class="n">MmapOptions</span>::<span class="n">new</span><span class="p">()</span>
<span class="w">        </span><span class="p">.</span><span class="n">len</span><span class="p">(</span><span class="n">code</span><span class="p">.</span><span class="n">buffer</span><span class="p">.</span><span class="n">data</span><span class="p">().</span><span class="n">len</span><span class="p">())</span>
<span class="w">        </span><span class="p">.</span><span class="n">map_anon</span><span class="p">()</span>
<span class="w">        </span><span class="p">.</span><span class="n">unwrap</span><span class="p">();</span>

<span class="w">    </span><span class="n">buffer</span><span class="p">.</span><span class="n">copy_from_slice</span><span class="p">(</span><span class="n">code</span><span class="p">.</span><span class="n">code_buffer</span><span class="p">());</span>

<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">buffer</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">buffer</span><span class="p">.</span><span class="n">make_exec</span><span class="p">().</span><span class="n">unwrap</span><span class="p">();</span>

<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">unsafe</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="n">code_fn</span>: <span class="nc">unsafe</span><span class="w"> </span><span class="k">extern</span><span class="w"> </span><span class="s">"sysv64"</span><span class="w"> </span><span class="k">fn</span><span class="p">(</span><span class="kt">usize</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="kt">usize</span> <span class="o">=</span>
<span class="w">            </span><span class="n">std</span>::<span class="n">mem</span>::<span class="n">transmute</span><span class="p">(</span><span class="n">buffer</span><span class="p">.</span><span class="n">as_ptr</span><span class="p">());</span>

<span class="w">        </span><span class="n">code_fn</span><span class="p">(</span><span class="mi">55</span><span class="p">)</span>
<span class="w">    </span><span class="p">};</span>

<span class="w">    </span><span class="fm">println!</span><span class="p">(</span><span class="s">"out: {}"</span><span class="p">,</span><span class="w"> </span><span class="n">x</span><span class="p">);</span>


<span class="p">}</span>
</code></pre></div>
<h3>Expected Results</h3>
<p>The pr should print out 113 4 times</p>
<h3>Actual Results</h3>
<p>The pr function prints out random values <br>
when you have the pr set up to only have 3 I64s<br>
the middle I64 is always correct <br>
when there is 2 or less I64s there are no correct results </p>
<p>when you have 4 I64s there are 2 correct and 2 wrong results. <br>
I have not tried added more I64 arguments </p>
<p>![bild](<a href="https://user-images.githubusercontent.com/32799244/222733355-ca869c9a-4e20-4752-99bf-53a4e14a2273.png">https://user-images.githubusercontent.com/32799244/222733355-ca869c9a-4e20-4752-99bf-53a4e14a2273.png</a>)</p>
<h3>Versions and Environment</h3>
<p>Cranelift version or commit: 0.93.0</p>
<p>Operating system: Windows 10 19042.1288</p>
<p>Architecture: X86</p>
<h3>Extra Info</h3>
<p>Im quite new to cranelift but this just does not make sense im unsure if I messed something up when experimenting but to me this seems like a bug. </p>
</blockquote>



<a name="339347039"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%235920%20Cranelift%3A%20call_indirect%20sends%20ran.../near/339347039" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.235920.20Cranelift.3A.20call_indirect.20sends.20ran.2E.2E.2E.html#339347039">(Mar 03 2023 at 13:37)</a>:</h4>
<p>salmmanfred edited <a href="https://github.com/bytecodealliance/wasmtime/issues/5920">issue #5920</a>:</p>
<blockquote>
<h3>The Code</h3>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="k">use</span><span class="w"> </span><span class="n">cranelift</span>::<span class="n">codegen</span>::<span class="n">ir</span>::<span class="p">{</span><span class="n">UserFuncName</span><span class="p">,</span><span class="w"> </span><span class="n">FuncRef</span><span class="p">};</span>
<span class="k">use</span><span class="w"> </span><span class="n">cranelift</span>::<span class="n">frontend</span>::<span class="p">{</span><span class="n">FunctionBuilder</span><span class="p">,</span><span class="w"> </span><span class="n">FunctionBuilderContext</span><span class="p">};</span>
<span class="k">use</span><span class="w"> </span><span class="n">cranelift</span>::<span class="n">codegen</span>::<span class="p">{</span>
<span class="w">    </span><span class="n">ir</span>::<span class="p">{</span><span class="n">types</span>::<span class="n">I64</span><span class="p">,</span><span class="w"> </span><span class="n">AbiParam</span><span class="p">,</span><span class="w"> </span><span class="n">Function</span><span class="p">,</span><span class="w"> </span><span class="n">Signature</span><span class="p">},</span>
<span class="w">    </span><span class="n">isa</span>::<span class="n">CallConv</span><span class="p">,</span>
<span class="p">};</span>
<span class="k">use</span><span class="w"> </span><span class="n">cranelift</span>::<span class="n">prelude</span>::<span class="p">{</span><span class="n">InstBuilder</span><span class="p">,</span><span class="w"> </span><span class="n">types</span><span class="p">,</span><span class="w"> </span><span class="n">ExtFuncData</span><span class="p">,</span><span class="w"> </span><span class="n">MemFlags</span><span class="p">,</span><span class="w"> </span><span class="n">EntityRef</span><span class="p">};</span>

<span class="k">use</span><span class="w"> </span><span class="n">cranelift</span>::<span class="n">codegen</span>::<span class="p">{</span><span class="n">isa</span><span class="p">,</span><span class="w"> </span><span class="n">settings</span><span class="p">,</span><span class="w"> </span><span class="n">Context</span><span class="p">};</span>
<span class="k">use</span><span class="w"> </span><span class="n">cranelift_jit</span>::<span class="p">{</span><span class="n">JITModule</span><span class="p">,</span><span class="w"> </span><span class="n">JITBuilder</span><span class="p">};</span>
<span class="k">use</span><span class="w"> </span><span class="n">target_lexicon</span>::<span class="n">Triple</span><span class="p">;</span>
<span class="k">use</span><span class="w"> </span><span class="n">cranelift_module</span>::<span class="p">{</span><span class="n">DataContext</span><span class="p">,</span><span class="w"> </span><span class="n">Linkage</span><span class="p">,</span><span class="w"> </span><span class="n">Module</span><span class="p">};</span>
<span class="k">use</span><span class="w"> </span><span class="n">core</span>::<span class="n">fmt</span>::<span class="n">write</span><span class="p">;</span>

<span class="k">fn</span> <span class="nf">pr</span><span class="p">(</span><span class="n">t</span>: <span class="kt">i64</span><span class="p">,</span><span class="n">b</span>:<span class="kt">i64</span><span class="p">,</span><span class="n">c</span>:<span class="kt">i64</span><span class="p">,</span><span class="n">d</span>:<span class="kt">i64</span><span class="p">){</span>

<span class="w">        </span><span class="fm">println!</span><span class="p">(</span><span class="s">"{t},{},{},{}"</span><span class="p">,</span><span class="n">b</span><span class="p">,</span><span class="n">c</span><span class="p">,</span><span class="n">d</span><span class="p">);</span>
<span class="w">    </span><span class="c1">//println!("{:?}",*t);</span>

<span class="p">}</span>

<span class="k">pub</span><span class="w"> </span><span class="k">fn</span> <span class="nf">test_compile</span><span class="p">(){</span>

<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">builder</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">settings</span>::<span class="n">builder</span><span class="p">();</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">flags</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">settings</span>::<span class="n">Flags</span>::<span class="n">new</span><span class="p">(</span><span class="n">builder</span><span class="p">);</span>

<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">isa</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">match</span><span class="w"> </span><span class="n">isa</span>::<span class="n">lookup</span><span class="p">(</span><span class="n">Triple</span>::<span class="n">host</span><span class="p">())</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nb">Err</span><span class="p">(</span><span class="n">err</span><span class="p">)</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="fm">panic!</span><span class="p">(</span><span class="s">"Error looking up target: {}"</span><span class="p">,</span><span class="w"> </span><span class="n">err</span><span class="p">),</span>
<span class="w">        </span><span class="nb">Ok</span><span class="p">(</span><span class="n">isa_builder</span><span class="p">)</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="n">isa_builder</span><span class="p">.</span><span class="n">finish</span><span class="p">(</span><span class="n">flags</span><span class="p">).</span><span class="n">unwrap</span><span class="p">(),</span>
<span class="w">    </span><span class="p">};</span>



<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">sig</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Signature</span>::<span class="n">new</span><span class="p">(</span><span class="n">CallConv</span>::<span class="n">SystemV</span><span class="p">);</span>
<span class="w">    </span><span class="n">sig</span><span class="p">.</span><span class="n">params</span><span class="p">.</span><span class="n">push</span><span class="p">(</span><span class="n">AbiParam</span>::<span class="n">new</span><span class="p">(</span><span class="n">I64</span><span class="p">));</span>


<span class="w">    </span><span class="n">sig</span><span class="p">.</span><span class="n">returns</span><span class="p">.</span><span class="n">push</span><span class="p">(</span><span class="n">AbiParam</span>::<span class="n">new</span><span class="p">(</span><span class="n">I64</span><span class="p">));</span>
<span class="w">    </span><span class="n">sig</span><span class="p">.</span><span class="n">returns</span><span class="p">.</span><span class="n">push</span><span class="p">(</span><span class="n">AbiParam</span>::<span class="n">new</span><span class="p">(</span><span class="n">I64</span><span class="p">));</span>
<span class="w">    </span><span class="n">sig</span><span class="p">.</span><span class="n">returns</span><span class="p">.</span><span class="n">push</span><span class="p">(</span><span class="n">AbiParam</span>::<span class="n">new</span><span class="p">(</span><span class="n">I64</span><span class="p">));</span>


<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">func</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Function</span>::<span class="n">with_name_signature</span><span class="p">(</span><span class="n">UserFuncName</span>::<span class="n">default</span><span class="p">(),</span><span class="w"> </span><span class="n">sig</span><span class="p">);</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">func_ctx</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">FunctionBuilderContext</span>::<span class="n">new</span><span class="p">();</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">builder</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">FunctionBuilder</span>::<span class="n">new</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="n">func</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="n">func_ctx</span><span class="p">);</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">pointer_type</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">isa</span><span class="p">.</span><span class="n">pointer_type</span><span class="p">();</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">block</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">builder</span><span class="p">.</span><span class="n">create_block</span><span class="p">();</span>
<span class="w">    </span><span class="n">builder</span><span class="p">.</span><span class="n">seal_block</span><span class="p">(</span><span class="n">block</span><span class="p">);</span>

<span class="w">    </span><span class="n">builder</span><span class="p">.</span><span class="n">append_block_params_for_function_params</span><span class="p">(</span><span class="n">block</span><span class="p">);</span>
<span class="w">    </span><span class="n">builder</span><span class="p">.</span><span class="n">switch_to_block</span><span class="p">(</span><span class="n">block</span><span class="p">);</span>


<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="p">(</span><span class="n">write_sig</span><span class="p">,</span><span class="w"> </span><span class="n">write_address</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">write_sig</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Signature</span>::<span class="n">new</span><span class="p">(</span><span class="n">CallConv</span>::<span class="n">SystemV</span><span class="p">);</span>
<span class="w">        </span><span class="n">write_sig</span><span class="p">.</span><span class="n">params</span><span class="p">.</span><span class="n">push</span><span class="p">(</span><span class="n">AbiParam</span>::<span class="n">new</span><span class="p">(</span><span class="n">types</span>::<span class="n">I64</span><span class="p">));</span>
<span class="w">        </span><span class="n">write_sig</span><span class="p">.</span><span class="n">params</span><span class="p">.</span><span class="n">push</span><span class="p">(</span><span class="n">AbiParam</span>::<span class="n">new</span><span class="p">(</span><span class="n">types</span>::<span class="n">I64</span><span class="p">));</span>
<span class="w">        </span><span class="n">write_sig</span><span class="p">.</span><span class="n">params</span><span class="p">.</span><span class="n">push</span><span class="p">(</span><span class="n">AbiParam</span>::<span class="n">new</span><span class="p">(</span><span class="n">types</span>::<span class="n">I64</span><span class="p">));</span>
<span class="w">        </span><span class="n">write_sig</span><span class="p">.</span><span class="n">params</span><span class="p">.</span><span class="n">push</span><span class="p">(</span><span class="n">AbiParam</span>::<span class="n">new</span><span class="p">(</span><span class="n">types</span>::<span class="n">I64</span><span class="p">));</span>


<span class="w">       </span><span class="c1">// write_sig.returns.push(AbiParam::new(pointer_type));</span>
<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="n">write_sig</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">builder</span><span class="p">.</span><span class="n">import_signature</span><span class="p">(</span><span class="n">write_sig</span><span class="p">);</span>

<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="n">write_address</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pr</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="o">*</span><span class="k">const</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="kt">i64</span><span class="p">;</span>
<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="n">write_address</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">builder</span><span class="p">.</span><span class="n">ins</span><span class="p">().</span><span class="n">iconst</span><span class="p">(</span><span class="n">pointer_type</span><span class="p">,</span><span class="w"> </span><span class="n">write_address</span><span class="p">);</span>
<span class="w">        </span><span class="p">(</span><span class="n">write_sig</span><span class="p">,</span><span class="w"> </span><span class="n">write_address</span><span class="p">)</span>
<span class="w">    </span><span class="p">};</span>








<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">arg</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">builder</span><span class="p">.</span><span class="n">block_params</span><span class="p">(</span><span class="n">block</span><span class="p">)[</span><span class="mi">0</span><span class="p">];</span>


<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">plus_one</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">builder</span><span class="p">.</span><span class="n">ins</span><span class="p">().</span><span class="n">iadd_imm</span><span class="p">(</span><span class="n">arg</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">);</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">plus_two</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">builder</span><span class="p">.</span><span class="n">ins</span><span class="p">().</span><span class="n">iadd_imm</span><span class="p">(</span><span class="n">arg</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="p">);</span>


<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">plus_three</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">builder</span><span class="p">.</span><span class="n">ins</span><span class="p">().</span><span class="n">iadd</span><span class="p">(</span><span class="n">plus_one</span><span class="p">,</span><span class="n">plus_two</span><span class="p">);</span>





<span class="w">    </span><span class="n">builder</span><span class="p">.</span><span class="n">ins</span><span class="p">().</span><span class="n">call_indirect</span><span class="p">(</span><span class="n">write_sig</span><span class="p">,</span><span class="n">write_address</span><span class="p">,</span><span class="o">&amp;</span><span class="p">[</span><span class="n">plus_three</span><span class="p">,</span><span class="n">plus_three</span><span class="p">,</span><span class="n">plus_three</span><span class="p">,</span><span class="n">plus_three</span><span class="p">]);</span>
<span class="w">   </span><span class="c1">// builder.ins().store(mem_flags, cell_value, plus_three, 0);</span>

<span class="w">    </span><span class="n">builder</span><span class="p">.</span><span class="n">ins</span><span class="p">().</span><span class="n">return_</span><span class="p">(</span><span class="o">&amp;</span><span class="p">[</span><span class="n">plus_three</span><span class="p">,</span><span class="n">plus_three</span><span class="p">,</span><span class="n">plus_three</span><span class="p">]);</span>

<span class="w">    </span><span class="n">builder</span><span class="p">.</span><span class="n">finalize</span><span class="p">();</span>
<span class="w">    </span><span class="fm">println!</span><span class="p">(</span><span class="s">"{}"</span><span class="p">,</span><span class="w"> </span><span class="n">func</span><span class="p">.</span><span class="n">display</span><span class="p">());</span>





<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">ctx</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Context</span>::<span class="n">for_function</span><span class="p">(</span><span class="n">func</span><span class="p">);</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">code</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ctx</span><span class="p">.</span><span class="n">compile</span><span class="p">(</span><span class="o">&amp;*</span><span class="n">isa</span><span class="p">).</span><span class="n">unwrap</span><span class="p">();</span>

<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">buffer</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">memmap2</span>::<span class="n">MmapOptions</span>::<span class="n">new</span><span class="p">()</span>
<span class="w">        </span><span class="p">.</span><span class="n">len</span><span class="p">(</span><span class="n">code</span><span class="p">.</span><span class="n">buffer</span><span class="p">.</span><span class="n">data</span><span class="p">().</span><span class="n">len</span><span class="p">())</span>
<span class="w">        </span><span class="p">.</span><span class="n">map_anon</span><span class="p">()</span>
<span class="w">        </span><span class="p">.</span><span class="n">unwrap</span><span class="p">();</span>

<span class="w">    </span><span class="n">buffer</span><span class="p">.</span><span class="n">copy_from_slice</span><span class="p">(</span><span class="n">code</span><span class="p">.</span><span class="n">code_buffer</span><span class="p">());</span>

<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">buffer</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">buffer</span><span class="p">.</span><span class="n">make_exec</span><span class="p">().</span><span class="n">unwrap</span><span class="p">();</span>

<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">unsafe</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="n">code_fn</span>: <span class="nc">unsafe</span><span class="w"> </span><span class="k">extern</span><span class="w"> </span><span class="s">"sysv64"</span><span class="w"> </span><span class="k">fn</span><span class="p">(</span><span class="kt">usize</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="kt">usize</span> <span class="o">=</span>
<span class="w">            </span><span class="n">std</span>::<span class="n">mem</span>::<span class="n">transmute</span><span class="p">(</span><span class="n">buffer</span><span class="p">.</span><span class="n">as_ptr</span><span class="p">());</span>

<span class="w">        </span><span class="n">code_fn</span><span class="p">(</span><span class="mi">55</span><span class="p">)</span>
<span class="w">    </span><span class="p">};</span>

<span class="w">    </span><span class="fm">println!</span><span class="p">(</span><span class="s">"out: {}"</span><span class="p">,</span><span class="w"> </span><span class="n">x</span><span class="p">);</span>


<span class="p">}</span>
</code></pre></div>
<h3>Expected Results</h3>
<p>The pr should print out 113 4 times</p>
<h3>Actual Results</h3>
<p>The pr function prints out random values <br>
when you have the pr set up to only have 3 I64s<br>
the middle I64 is always correct <br>
when there is 2 or less I64s there are no correct results </p>
<p>when you have 4 I64s there are 2 correct and 2 wrong results. <br>
I have not tried added more I64 arguments </p>
<p>![bild](<a href="https://user-images.githubusercontent.com/32799244/222733355-ca869c9a-4e20-4752-99bf-53a4e14a2273.png">https://user-images.githubusercontent.com/32799244/222733355-ca869c9a-4e20-4752-99bf-53a4e14a2273.png</a>)</p>
<h3>Versions and Environment</h3>
<p>Cranelift version or commit: 0.93.0</p>
<p>Operating system: Windows 10 19042.1288</p>
<p>Architecture: X86</p>
<h3>Extra Info</h3>
<p>Im quite new to cranelift but this just does not make sense im unsure if I messed something up when experimenting but to me this seems like a bug. </p>
</blockquote>



<a name="339436694"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%235920%20Cranelift%3A%20call_indirect%20sends%20ran.../near/339436694" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.235920.20Cranelift.3A.20call_indirect.20sends.20ran.2E.2E.2E.html#339436694">(Mar 03 2023 at 20:19)</a>:</h4>
<p>bjorn3 <a href="https://github.com/bytecodealliance/wasmtime/issues/5920#issuecomment-1454081311">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/5920">issue #5920</a>:</p>
<blockquote>
<p><code>pr</code> needs to be <code>extern "sysv"</code> as that is what you use when calling it. By the way I would suggest using cranelift-jit instead of manually writing code to handle jitting.</p>
</blockquote>



<a name="339540899"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%235920%20Cranelift%3A%20call_indirect%20sends%20ran.../near/339540899" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.235920.20Cranelift.3A.20call_indirect.20sends.20ran.2E.2E.2E.html#339540899">(Mar 04 2023 at 12:00)</a>:</h4>
<p>salmmanfred <a href="https://github.com/bytecodealliance/wasmtime/issues/5920#issuecomment-1454715663">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/5920">issue #5920</a>:</p>
<blockquote>
<p>Currently only experimenting, but its working now with extern. Thanks! </p>
</blockquote>



<a name="339540901"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%235920%20Cranelift%3A%20call_indirect%20sends%20ran.../near/339540901" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.235920.20Cranelift.3A.20call_indirect.20sends.20ran.2E.2E.2E.html#339540901">(Mar 04 2023 at 12:00)</a>:</h4>
<p>salmmanfred closed <a href="https://github.com/bytecodealliance/wasmtime/issues/5920">issue #5920</a>:</p>
<blockquote>
<h3>The Code</h3>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="k">use</span><span class="w"> </span><span class="n">cranelift</span>::<span class="n">codegen</span>::<span class="n">ir</span>::<span class="p">{</span><span class="n">UserFuncName</span><span class="p">,</span><span class="w"> </span><span class="n">FuncRef</span><span class="p">};</span>
<span class="k">use</span><span class="w"> </span><span class="n">cranelift</span>::<span class="n">frontend</span>::<span class="p">{</span><span class="n">FunctionBuilder</span><span class="p">,</span><span class="w"> </span><span class="n">FunctionBuilderContext</span><span class="p">};</span>
<span class="k">use</span><span class="w"> </span><span class="n">cranelift</span>::<span class="n">codegen</span>::<span class="p">{</span>
<span class="w">    </span><span class="n">ir</span>::<span class="p">{</span><span class="n">types</span>::<span class="n">I64</span><span class="p">,</span><span class="w"> </span><span class="n">AbiParam</span><span class="p">,</span><span class="w"> </span><span class="n">Function</span><span class="p">,</span><span class="w"> </span><span class="n">Signature</span><span class="p">},</span>
<span class="w">    </span><span class="n">isa</span>::<span class="n">CallConv</span><span class="p">,</span>
<span class="p">};</span>
<span class="k">use</span><span class="w"> </span><span class="n">cranelift</span>::<span class="n">prelude</span>::<span class="p">{</span><span class="n">InstBuilder</span><span class="p">,</span><span class="w"> </span><span class="n">types</span><span class="p">,</span><span class="w"> </span><span class="n">ExtFuncData</span><span class="p">,</span><span class="w"> </span><span class="n">MemFlags</span><span class="p">,</span><span class="w"> </span><span class="n">EntityRef</span><span class="p">};</span>

<span class="k">use</span><span class="w"> </span><span class="n">cranelift</span>::<span class="n">codegen</span>::<span class="p">{</span><span class="n">isa</span><span class="p">,</span><span class="w"> </span><span class="n">settings</span><span class="p">,</span><span class="w"> </span><span class="n">Context</span><span class="p">};</span>
<span class="k">use</span><span class="w"> </span><span class="n">cranelift_jit</span>::<span class="p">{</span><span class="n">JITModule</span><span class="p">,</span><span class="w"> </span><span class="n">JITBuilder</span><span class="p">};</span>
<span class="k">use</span><span class="w"> </span><span class="n">target_lexicon</span>::<span class="n">Triple</span><span class="p">;</span>
<span class="k">use</span><span class="w"> </span><span class="n">cranelift_module</span>::<span class="p">{</span><span class="n">DataContext</span><span class="p">,</span><span class="w"> </span><span class="n">Linkage</span><span class="p">,</span><span class="w"> </span><span class="n">Module</span><span class="p">};</span>
<span class="k">use</span><span class="w"> </span><span class="n">core</span>::<span class="n">fmt</span>::<span class="n">write</span><span class="p">;</span>

<span class="k">fn</span> <span class="nf">pr</span><span class="p">(</span><span class="n">t</span>: <span class="kt">i64</span><span class="p">,</span><span class="n">b</span>:<span class="kt">i64</span><span class="p">,</span><span class="n">c</span>:<span class="kt">i64</span><span class="p">,</span><span class="n">d</span>:<span class="kt">i64</span><span class="p">){</span>

<span class="w">        </span><span class="fm">println!</span><span class="p">(</span><span class="s">"{t},{},{},{}"</span><span class="p">,</span><span class="n">b</span><span class="p">,</span><span class="n">c</span><span class="p">,</span><span class="n">d</span><span class="p">);</span>
<span class="w">    </span><span class="c1">//println!("{:?}",*t);</span>

<span class="p">}</span>

<span class="k">pub</span><span class="w"> </span><span class="k">fn</span> <span class="nf">test_compile</span><span class="p">(){</span>

<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">builder</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">settings</span>::<span class="n">builder</span><span class="p">();</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">flags</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">settings</span>::<span class="n">Flags</span>::<span class="n">new</span><span class="p">(</span><span class="n">builder</span><span class="p">);</span>

<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">isa</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">match</span><span class="w"> </span><span class="n">isa</span>::<span class="n">lookup</span><span class="p">(</span><span class="n">Triple</span>::<span class="n">host</span><span class="p">())</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nb">Err</span><span class="p">(</span><span class="n">err</span><span class="p">)</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="fm">panic!</span><span class="p">(</span><span class="s">"Error looking up target: {}"</span><span class="p">,</span><span class="w"> </span><span class="n">err</span><span class="p">),</span>
<span class="w">        </span><span class="nb">Ok</span><span class="p">(</span><span class="n">isa_builder</span><span class="p">)</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="n">isa_builder</span><span class="p">.</span><span class="n">finish</span><span class="p">(</span><span class="n">flags</span><span class="p">).</span><span class="n">unwrap</span><span class="p">(),</span>
<span class="w">    </span><span class="p">};</span>



<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">sig</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Signature</span>::<span class="n">new</span><span class="p">(</span><span class="n">CallConv</span>::<span class="n">SystemV</span><span class="p">);</span>
<span class="w">    </span><span class="n">sig</span><span class="p">.</span><span class="n">params</span><span class="p">.</span><span class="n">push</span><span class="p">(</span><span class="n">AbiParam</span>::<span class="n">new</span><span class="p">(</span><span class="n">I64</span><span class="p">));</span>


<span class="w">    </span><span class="n">sig</span><span class="p">.</span><span class="n">returns</span><span class="p">.</span><span class="n">push</span><span class="p">(</span><span class="n">AbiParam</span>::<span class="n">new</span><span class="p">(</span><span class="n">I64</span><span class="p">));</span>
<span class="w">    </span><span class="n">sig</span><span class="p">.</span><span class="n">returns</span><span class="p">.</span><span class="n">push</span><span class="p">(</span><span class="n">AbiParam</span>::<span class="n">new</span><span class="p">(</span><span class="n">I64</span><span class="p">));</span>
<span class="w">    </span><span class="n">sig</span><span class="p">.</span><span class="n">returns</span><span class="p">.</span><span class="n">push</span><span class="p">(</span><span class="n">AbiParam</span>::<span class="n">new</span><span class="p">(</span><span class="n">I64</span><span class="p">));</span>


<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">func</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Function</span>::<span class="n">with_name_signature</span><span class="p">(</span><span class="n">UserFuncName</span>::<span class="n">default</span><span class="p">(),</span><span class="w"> </span><span class="n">sig</span><span class="p">);</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">func_ctx</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">FunctionBuilderContext</span>::<span class="n">new</span><span class="p">();</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">builder</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">FunctionBuilder</span>::<span class="n">new</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="n">func</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="n">func_ctx</span><span class="p">);</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">pointer_type</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">isa</span><span class="p">.</span><span class="n">pointer_type</span><span class="p">();</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">block</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">builder</span><span class="p">.</span><span class="n">create_block</span><span class="p">();</span>
<span class="w">    </span><span class="n">builder</span><span class="p">.</span><span class="n">seal_block</span><span class="p">(</span><span class="n">block</span><span class="p">);</span>

<span class="w">    </span><span class="n">builder</span><span class="p">.</span><span class="n">append_block_params_for_function_params</span><span class="p">(</span><span class="n">block</span><span class="p">);</span>
<span class="w">    </span><span class="n">builder</span><span class="p">.</span><span class="n">switch_to_block</span><span class="p">(</span><span class="n">block</span><span class="p">);</span>


<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="p">(</span><span class="n">write_sig</span><span class="p">,</span><span class="w"> </span><span class="n">write_address</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">write_sig</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Signature</span>::<span class="n">new</span><span class="p">(</span><span class="n">CallConv</span>::<span class="n">SystemV</span><span class="p">);</span>
<span class="w">        </span><span class="n">write_sig</span><span class="p">.</span><span class="n">params</span><span class="p">.</span><span class="n">push</span><span class="p">(</span><span class="n">AbiParam</span>::<span class="n">new</span><span class="p">(</span><span class="n">types</span>::<span class="n">I64</span><span class="p">));</span>
<span class="w">        </span><span class="n">write_sig</span><span class="p">.</span><span class="n">params</span><span class="p">.</span><span class="n">push</span><span class="p">(</span><span class="n">AbiParam</span>::<span class="n">new</span><span class="p">(</span><span class="n">types</span>::<span class="n">I64</span><span class="p">));</span>
<span class="w">        </span><span class="n">write_sig</span><span class="p">.</span><span class="n">params</span><span class="p">.</span><span class="n">push</span><span class="p">(</span><span class="n">AbiParam</span>::<span class="n">new</span><span class="p">(</span><span class="n">types</span>::<span class="n">I64</span><span class="p">));</span>
<span class="w">        </span><span class="n">write_sig</span><span class="p">.</span><span class="n">params</span><span class="p">.</span><span class="n">push</span><span class="p">(</span><span class="n">AbiParam</span>::<span class="n">new</span><span class="p">(</span><span class="n">types</span>::<span class="n">I64</span><span class="p">));</span>


<span class="w">       </span><span class="c1">// write_sig.returns.push(AbiParam::new(pointer_type));</span>
<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="n">write_sig</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">builder</span><span class="p">.</span><span class="n">import_signature</span><span class="p">(</span><span class="n">write_sig</span><span class="p">);</span>

<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="n">write_address</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pr</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="o">*</span><span class="k">const</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="kt">i64</span><span class="p">;</span>
<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="n">write_address</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">builder</span><span class="p">.</span><span class="n">ins</span><span class="p">().</span><span class="n">iconst</span><span class="p">(</span><span class="n">pointer_type</span><span class="p">,</span><span class="w"> </span><span class="n">write_address</span><span class="p">);</span>
<span class="w">        </span><span class="p">(</span><span class="n">write_sig</span><span class="p">,</span><span class="w"> </span><span class="n">write_address</span><span class="p">)</span>
<span class="w">    </span><span class="p">};</span>








<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">arg</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">builder</span><span class="p">.</span><span class="n">block_params</span><span class="p">(</span><span class="n">block</span><span class="p">)[</span><span class="mi">0</span><span class="p">];</span>


<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">plus_one</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">builder</span><span class="p">.</span><span class="n">ins</span><span class="p">().</span><span class="n">iadd_imm</span><span class="p">(</span><span class="n">arg</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">);</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">plus_two</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">builder</span><span class="p">.</span><span class="n">ins</span><span class="p">().</span><span class="n">iadd_imm</span><span class="p">(</span><span class="n">arg</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="p">);</span>


<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">plus_three</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">builder</span><span class="p">.</span><span class="n">ins</span><span class="p">().</span><span class="n">iadd</span><span class="p">(</span><span class="n">plus_one</span><span class="p">,</span><span class="n">plus_two</span><span class="p">);</span>





<span class="w">    </span><span class="n">builder</span><span class="p">.</span><span class="n">ins</span><span class="p">().</span><span class="n">call_indirect</span><span class="p">(</span><span class="n">write_sig</span><span class="p">,</span><span class="n">write_address</span><span class="p">,</span><span class="o">&amp;</span><span class="p">[</span><span class="n">plus_three</span><span class="p">,</span><span class="n">plus_three</span><span class="p">,</span><span class="n">plus_three</span><span class="p">,</span><span class="n">plus_three</span><span class="p">]);</span>
<span class="w">   </span><span class="c1">// builder.ins().store(mem_flags, cell_value, plus_three, 0);</span>

<span class="w">    </span><span class="n">builder</span><span class="p">.</span><span class="n">ins</span><span class="p">().</span><span class="n">return_</span><span class="p">(</span><span class="o">&amp;</span><span class="p">[</span><span class="n">plus_three</span><span class="p">,</span><span class="n">plus_three</span><span class="p">,</span><span class="n">plus_three</span><span class="p">]);</span>

<span class="w">    </span><span class="n">builder</span><span class="p">.</span><span class="n">finalize</span><span class="p">();</span>
<span class="w">    </span><span class="fm">println!</span><span class="p">(</span><span class="s">"{}"</span><span class="p">,</span><span class="w"> </span><span class="n">func</span><span class="p">.</span><span class="n">display</span><span class="p">());</span>





<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">ctx</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Context</span>::<span class="n">for_function</span><span class="p">(</span><span class="n">func</span><span class="p">);</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">code</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ctx</span><span class="p">.</span><span class="n">compile</span><span class="p">(</span><span class="o">&amp;*</span><span class="n">isa</span><span class="p">).</span><span class="n">unwrap</span><span class="p">();</span>

<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">buffer</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">memmap2</span>::<span class="n">MmapOptions</span>::<span class="n">new</span><span class="p">()</span>
<span class="w">        </span><span class="p">.</span><span class="n">len</span><span class="p">(</span><span class="n">code</span><span class="p">.</span><span class="n">buffer</span><span class="p">.</span><span class="n">data</span><span class="p">().</span><span class="n">len</span><span class="p">())</span>
<span class="w">        </span><span class="p">.</span><span class="n">map_anon</span><span class="p">()</span>
<span class="w">        </span><span class="p">.</span><span class="n">unwrap</span><span class="p">();</span>

<span class="w">    </span><span class="n">buffer</span><span class="p">.</span><span class="n">copy_from_slice</span><span class="p">(</span><span class="n">code</span><span class="p">.</span><span class="n">code_buffer</span><span class="p">());</span>

<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">buffer</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">buffer</span><span class="p">.</span><span class="n">make_exec</span><span class="p">().</span><span class="n">unwrap</span><span class="p">();</span>

<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">unsafe</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="n">code_fn</span>: <span class="nc">unsafe</span><span class="w"> </span><span class="k">extern</span><span class="w"> </span><span class="s">"sysv64"</span><span class="w"> </span><span class="k">fn</span><span class="p">(</span><span class="kt">usize</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="kt">usize</span> <span class="o">=</span>
<span class="w">            </span><span class="n">std</span>::<span class="n">mem</span>::<span class="n">transmute</span><span class="p">(</span><span class="n">buffer</span><span class="p">.</span><span class="n">as_ptr</span><span class="p">());</span>

<span class="w">        </span><span class="n">code_fn</span><span class="p">(</span><span class="mi">55</span><span class="p">)</span>
<span class="w">    </span><span class="p">};</span>

<span class="w">    </span><span class="fm">println!</span><span class="p">(</span><span class="s">"out: {}"</span><span class="p">,</span><span class="w"> </span><span class="n">x</span><span class="p">);</span>


<span class="p">}</span>
</code></pre></div>
<h3>Expected Results</h3>
<p>The pr should print out 113 4 times</p>
<h3>Actual Results</h3>
<p>The pr function prints out random values <br>
when you have the pr set up to only have 3 I64s<br>
the middle I64 is always correct <br>
when there is 2 or less I64s there are no correct results </p>
<p>when you have 4 I64s there are 2 correct and 2 wrong results. <br>
I have not tried added more I64 arguments </p>
<p>![bild](<a href="https://user-images.githubusercontent.com/32799244/222733355-ca869c9a-4e20-4752-99bf-53a4e14a2273.png">https://user-images.githubusercontent.com/32799244/222733355-ca869c9a-4e20-4752-99bf-53a4e14a2273.png</a>)</p>
<h3>Versions and Environment</h3>
<p>Cranelift version or commit: 0.93.0</p>
<p>Operating system: Windows 10 19042.1288</p>
<p>Architecture: X86</p>
<h3>Extra Info</h3>
<p>Im quite new to cranelift but this just does not make sense im unsure if I messed something up when experimenting but to me this seems like a bug. </p>
</blockquote>



<hr><p>Last updated: Jan 20 2025 at 06:04 UTC</p>
</html>