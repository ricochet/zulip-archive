<html>
<head><meta charset="utf-8"><title>wasmtime / Issue #1980 Support x86 in new instruction sel... · git-wasmtime · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/index.html">git-wasmtime</a></h2>
<h3>Topic: <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20Issue.20.231980.20Support.20x86.20in.20new.20instruction.20sel.2E.2E.2E.html">wasmtime / Issue #1980 Support x86 in new instruction sel...</a></h3>

<hr>

<base href="https://bytecodealliance.zulipchat.com">

<head><link href="https://bytecodealliance.github.io/zulip-archive/style.css" rel="stylesheet"></head>

<a name="202914815"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20Issue%20%231980%20Support%20x86%20in%20new%20instruction%20sel.../near/202914815" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20Issue.20.231980.20Support.20x86.20in.20new.20instruction.20sel.2E.2E.2E.html#202914815">(Jul 05 2020 at 10:08)</a>:</h4>
<p>tschneidereit labeled <a href="https://github.com/bytecodealliance/wasmtime/issues/1980">Issue #1980</a>:</p>
<blockquote>
<p>We don't currently have fully working x86 support, but we have a backend in-tree that's largely completely. However, it uses the old instructions selection framework, and as described in #1936, Cranelift is in the process of switching to a new one. While the old framework won't be removed until quite a bit later, that means that not much work will go into it anymore, and that any investments into backends based on it will become obsolete.</p>
<p>We should investigate the best approach to supporting x86 in the new framework.</p>
<p>There's active work going on to implement x64 support in the new framework, but no current effort around x86. In #1789 @whitequark mentions that she'd be happy to contribute to x86 support in the new framework, but only if the general support for targeting x86 exists.</p>
<p>@bnjbvr @julian-seward1, can you comment on what the best approach to take here would be? I understand that this isn't something that's high on your priority list, so as a first step we should just get a clearer picture of what this could look like, and the effort required.</p>
</blockquote>



<a name="202914816"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20Issue%20%231980%20Support%20x86%20in%20new%20instruction%20sel.../near/202914816" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20Issue.20.231980.20Support.20x86.20in.20new.20instruction.20sel.2E.2E.2E.html#202914816">(Jul 05 2020 at 10:08)</a>:</h4>
<p>tschneidereit opened <a href="https://github.com/bytecodealliance/wasmtime/issues/1980">Issue #1980</a>:</p>
<blockquote>
<p>We don't currently have fully working x86 support, but we have a backend in-tree that's largely completely. However, it uses the old instructions selection framework, and as described in #1936, Cranelift is in the process of switching to a new one. While the old framework won't be removed until quite a bit later, that means that not much work will go into it anymore, and that any investments into backends based on it will become obsolete.</p>
<p>We should investigate the best approach to supporting x86 in the new framework.</p>
<p>There's active work going on to implement x64 support in the new framework, but no current effort around x86. In #1789 @whitequark mentions that she'd be happy to contribute to x86 support in the new framework, but only if the general support for targeting x86 exists.</p>
<p>@bnjbvr @julian-seward1, can you comment on what the best approach to take here would be? I understand that this isn't something that's high on your priority list, so as a first step we should just get a clearer picture of what this could look like, and the effort required.</p>
</blockquote>



<a name="202914817"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20Issue%20%231980%20Support%20x86%20in%20new%20instruction%20sel.../near/202914817" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20Issue.20.231980.20Support.20x86.20in.20new.20instruction.20sel.2E.2E.2E.html#202914817">(Jul 05 2020 at 10:08)</a>:</h4>
<p>tschneidereit labeled <a href="https://github.com/bytecodealliance/wasmtime/issues/1980">Issue #1980</a>:</p>
<blockquote>
<p>We don't currently have fully working x86 support, but we have a backend in-tree that's largely completely. However, it uses the old instructions selection framework, and as described in #1936, Cranelift is in the process of switching to a new one. While the old framework won't be removed until quite a bit later, that means that not much work will go into it anymore, and that any investments into backends based on it will become obsolete.</p>
<p>We should investigate the best approach to supporting x86 in the new framework.</p>
<p>There's active work going on to implement x64 support in the new framework, but no current effort around x86. In #1789 @whitequark mentions that she'd be happy to contribute to x86 support in the new framework, but only if the general support for targeting x86 exists.</p>
<p>@bnjbvr @julian-seward1, can you comment on what the best approach to take here would be? I understand that this isn't something that's high on your priority list, so as a first step we should just get a clearer picture of what this could look like, and the effort required.</p>
</blockquote>



<a name="202914818"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20Issue%20%231980%20Support%20x86%20in%20new%20instruction%20sel.../near/202914818" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20Issue.20.231980.20Support.20x86.20in.20new.20instruction.20sel.2E.2E.2E.html#202914818">(Jul 05 2020 at 10:08)</a>:</h4>
<p>tschneidereit labeled <a href="https://github.com/bytecodealliance/wasmtime/issues/1980">Issue #1980</a>:</p>
<blockquote>
<p>We don't currently have fully working x86 support, but we have a backend in-tree that's largely completely. However, it uses the old instructions selection framework, and as described in #1936, Cranelift is in the process of switching to a new one. While the old framework won't be removed until quite a bit later, that means that not much work will go into it anymore, and that any investments into backends based on it will become obsolete.</p>
<p>We should investigate the best approach to supporting x86 in the new framework.</p>
<p>There's active work going on to implement x64 support in the new framework, but no current effort around x86. In #1789 @whitequark mentions that she'd be happy to contribute to x86 support in the new framework, but only if the general support for targeting x86 exists.</p>
<p>@bnjbvr @julian-seward1, can you comment on what the best approach to take here would be? I understand that this isn't something that's high on your priority list, so as a first step we should just get a clearer picture of what this could look like, and the effort required.</p>
</blockquote>



<a name="203261749"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20Issue%20%231980%20Support%20x86%20in%20new%20instruction%20sel.../near/203261749" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20Issue.20.231980.20Support.20x86.20in.20new.20instruction.20sel.2E.2E.2E.html#203261749">(Jul 08 2020 at 12:37)</a>:</h4>
<p>bnjbvr <a href="https://github.com/bytecodealliance/wasmtime/issues/1980#issuecomment-655492495">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/1980">Issue #1980</a>:</p>
<blockquote>
<p>Thanks for opening an issue!</p>
<h2>Sharing code</h2>
<p>The current encoding machinery is sufficient to support all the x86 32 and 64 bits instructions up to SSE4.2 (i.e., nothing has been done for VEX yet). Most encodings can be reused on 32 bits (of course, without the 64-bit mode); some specific encodings and addressing modes are not available in 32-bits mode (e.g. RIP-relative addressing).</p>
<p>Ideally, most of the encoding code could be shared between the two architectures, with an <code>Inst</code> enum for instructions that are common to both architectures; each of x86_64 and x86-32bits would then have their own <code>Inst</code> enum as well, with a particular <code>Shared</code> variant that would be dynamically dispatch most queries / calls to the shared <code>Inst</code> enum. It would mean that the 64-bits and 32-bits backends would have special code to handle the shared encodings (e.g. when printing out the instructions and registers, when handling supported operand sizes,...) so it might become a bit messy. Moreover, the code for these two architectures would be scattered in more places. Spidermonkey has tried to enforce code sharing between these two architectures, and it's made the code difficult to follow sometimes (it tends to force low-level abstractions that add unnecessary layers to the code). But we wouldn't need to duplicate work.</p>
<p>Alternatively, we could just duplicate all the Inst variants, so that each target has precisely what it can do. Even if this implies some code duplication, this should stay reasonably well-contained over time: code emitting encodings tends to remain stable over time, once it's been written (and maybe fixed once or twice).</p>
<p>Since this encoding code is still in the process of being written, it might be good to wait for stabilization before jumping into implementing a new target derived from it.</p>
<h2>Legalizing IR</h2>
<p>At this point, there's not a good story for transforming sequences of operations involving types that are not natively supported by the platform: be it i128 or aarch64/x64, or i64 on on x86 32 bits. We'd probably need something like lightweight legalizations to make this maintainable over time.</p>
<p>## ABIs</p>
<p>32-bits ABIs would be one more work item to do, since the ABIs are quite different. This isn't quite complicated, but it requires careful testing to be sure not to make an error there.</p>
<p>In a nutshell, there's nothing that's too complicated. I'm not quite sure of the best way to share code yet.</p>
</blockquote>



<a name="205056062"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20Issue%20%231980%20Support%20x86%20in%20new%20instruction%20sel.../near/205056062" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20Issue.20.231980.20Support.20x86.20in.20new.20instruction.20sel.2E.2E.2E.html#205056062">(Jul 26 2020 at 15:24)</a>:</h4>
<p>guest271314 <a href="https://github.com/bytecodealliance/wasmtime/issues/1980#issuecomment-664001702">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/1980">Issue #1980</a>:</p>
<blockquote>
<blockquote>
<p>Error: Sorry! Wasmtime currently only provides pre-built binaries for x86_64 architectures.</p>
</blockquote>
</blockquote>



<a name="205057523"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20Issue%20%231980%20Support%20x86%20in%20new%20instruction%20sel.../near/205057523" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20Issue.20.231980.20Support.20x86.20in.20new.20instruction.20sel.2E.2E.2E.html#205057523">(Jul 26 2020 at 16:09)</a>:</h4>
<p>guest271314 <a href="https://github.com/bytecodealliance/wasmtime/issues/1980#issuecomment-664006995">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/1980">Issue #1980</a>:</p>
<blockquote>
<p>It would be helpful and informative if the README.md at <a href="https://github.com/bytecodealliance/wasmtime">https://github.com/bytecodealliance/wasmtime</a> including an unambiguous and conspicuous header and language that states x86 32 bit architecture is not (currently) supported, so that users do not run</p>
<p><code>$ curl https://wasmtime.dev/install.sh -sSf | bash</code></p>
<p>or try <a href="https://wasi.dev/polyfill/">https://wasi.dev/polyfill/</a> using instructions at <a href="https://github.com/bytecodealliance/wasmtime/blob/main/docs/WASI-tutorial.md">https://github.com/bytecodealliance/wasmtime/blob/main/docs/WASI-tutorial.md</a> expecting the code to work.</p>
</blockquote>



<a name="211140525"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20Issue%20%231980%20Support%20x86%20in%20new%20instruction%20sel.../near/211140525" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20Issue.20.231980.20Support.20x86.20in.20new.20instruction.20sel.2E.2E.2E.html#211140525">(Sep 24 2020 at 14:38)</a>:</h4>
<p>bnjbvr labeled <a href="https://github.com/bytecodealliance/wasmtime/issues/1980">Issue #1980</a>:</p>
<blockquote>
<p>We don't currently have fully working x86 support, but we have a backend in-tree that's largely completely. However, it uses the old instructions selection framework, and as described in #1936, Cranelift is in the process of switching to a new one. While the old framework won't be removed until quite a bit later, that means that not much work will go into it anymore, and that any investments into backends based on it will become obsolete.</p>
<p>We should investigate the best approach to supporting x86 in the new framework.</p>
<p>There's active work going on to implement x64 support in the new framework, but no current effort around x86. In #1789 @whitequark mentions that she'd be happy to contribute to x86 support in the new framework, but only if the general support for targeting x86 exists.</p>
<p>@bnjbvr @julian-seward1, can you comment on what the best approach to take here would be? I understand that this isn't something that's high on your priority list, so as a first step we should just get a clearer picture of what this could look like, and the effort required.</p>
</blockquote>



<a name="211140556"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20Issue%20%231980%20Support%20x86%20in%20new%20instruction%20sel.../near/211140556" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20Issue.20.231980.20Support.20x86.20in.20new.20instruction.20sel.2E.2E.2E.html#211140556">(Sep 24 2020 at 14:39)</a>:</h4>
<p>github-actions[bot] <a href="https://github.com/bytecodealliance/wasmtime/issues/1980#issuecomment-698387659">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/1980">Issue #1980</a>:</p>
<blockquote>
<h4>Subscribe to Label Action</h4>
<p>cc @bnjbvr</p>
<p>&lt;details&gt;<br>
This issue or pull request has been labeled: "cranelift"</p>
<p>Thus the following users have been cc'd because of the following labels:</p>
<ul>
<li>bnjbvr: cranelift</li>
</ul>
<p>To subscribe or unsubscribe from this label, edit the &lt;code&gt;.github/subscribe-to-label.json&lt;/code&gt; configuration file.</p>
<p><a href="https://github.com/bytecodealliance/subscribe-to-label-action">Learn more.</a><br>
&lt;/details&gt;</p>
</blockquote>



<a name="231134297"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20Issue%20%231980%20Support%20x86%20in%20new%20instruction%20sel.../near/231134297" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20Issue.20.231980.20Support.20x86.20in.20new.20instruction.20sel.2E.2E.2E.html#231134297">(Mar 20 2021 at 09:18)</a>:</h4>
<p>bjorn3 <a href="https://github.com/bytecodealliance/wasmtime/issues/1980#issuecomment-803277343">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/1980">Issue #1980</a>:</p>
<blockquote>
<p>I think this can be closed.</p>
</blockquote>



<a name="231135088"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20Issue%20%231980%20Support%20x86%20in%20new%20instruction%20sel.../near/231135088" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20Issue.20.231980.20Support.20x86.20in.20new.20instruction.20sel.2E.2E.2E.html#231135088">(Mar 20 2021 at 09:34)</a>:</h4>
<p>whitequark <a href="https://github.com/bytecodealliance/wasmtime/issues/1980#issuecomment-803279603">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/1980">Issue #1980</a>:</p>
<blockquote>
<p>How can I test 32-bit x86 support? <code>--target i686-unknown-linux-gnu</code> doesn't seem to work for example:</p>
<p><div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="n">thread</span><span class="w"> </span><span class="o">'</span><span class="na">main</span><span class="o">'</span><span class="w"> </span><span class="n">panicked</span><span class="w"> </span><span class="n">at</span><span class="w"> </span><span class="o">'</span><span class="na">host</span><span class="w"> </span><span class="n">machine</span><span class="w"> </span><span class="n">is</span><span class="w"> </span><span class="n">not</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="n">supported</span><span class="w"> </span><span class="n">target</span>: <span class="s">"unsupported architecture"</span><span class="o">'</span><span class="p">,</span><span class="w"> </span><span class="n">crates</span><span class="o">/</span><span class="n">jit</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">native</span><span class="p">.</span><span class="n">rs</span>:<span class="mi">6</span>:<span class="mi">33</span><span class="w"></span>
</code></pre></div><br>
</p>
</blockquote>



<a name="231135125"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20Issue%20%231980%20Support%20x86%20in%20new%20instruction%20sel.../near/231135125" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20Issue.20.231980.20Support.20x86.20in.20new.20instruction.20sel.2E.2E.2E.html#231135125">(Mar 20 2021 at 09:35)</a>:</h4>
<p>bjorn3 <a href="https://github.com/bytecodealliance/wasmtime/issues/1980#issuecomment-803279735">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/1980">Issue #1980</a>:</p>
<blockquote>
<p>The new x64 backend doesn't have 32bit support yet.</p>
</blockquote>



<a name="231135288"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20Issue%20%231980%20Support%20x86%20in%20new%20instruction%20sel.../near/231135288" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20Issue.20.231980.20Support.20x86.20in.20new.20instruction.20sel.2E.2E.2E.html#231135288">(Mar 20 2021 at 09:39)</a>:</h4>
<p>whitequark <a href="https://github.com/bytecodealliance/wasmtime/issues/1980#issuecomment-803280182">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/1980">Issue #1980</a>:</p>
<blockquote>
<p>That's exactly what this issue is about, no?</p>
</blockquote>



<a name="231135916"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20Issue%20%231980%20Support%20x86%20in%20new%20instruction%20sel.../near/231135916" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20Issue.20.231980.20Support.20x86.20in.20new.20instruction.20sel.2E.2E.2E.html#231135916">(Mar 20 2021 at 09:52)</a>:</h4>
<p>bjorn3 <a href="https://github.com/bytecodealliance/wasmtime/issues/1980#issuecomment-803281517">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/1980">Issue #1980</a>:</p>
<blockquote>
<p>Oops, interpreted x86 as x86_64 instead of 32bit x86.</p>
</blockquote>



<hr><p>Last updated: Jan 20 2025 at 06:04 UTC</p>
</html>