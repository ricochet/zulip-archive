<html>
<head><meta charset="utf-8"><title>wasmtime / issue #7310 Multithread application traps with... · git-wasmtime · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/index.html">git-wasmtime</a></h2>
<h3>Topic: <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.237310.20Multithread.20application.20traps.20with.2E.2E.2E.html">wasmtime / issue #7310 Multithread application traps with...</a></h3>

<hr>

<base href="https://bytecodealliance.zulipchat.com">

<head><link href="https://bytecodealliance.github.io/zulip-archive/style.css" rel="stylesheet"></head>

<a name="397655598"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%237310%20Multithread%20application%20traps%20with.../near/397655598" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.237310.20Multithread.20application.20traps.20with.2E.2E.2E.html#397655598">(Oct 20 2023 at 08:17)</a>:</h4>
<p><a href="https://github.com/dbaeumer">dbaeumer</a> added the bug label to <a href="https://github.com/bytecodealliance/wasmtime/issues/7310">Issue #7310</a>.</p>



<a name="397655600"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%237310%20Multithread%20application%20traps%20with.../near/397655600" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.237310.20Multithread.20application.20traps.20with.2E.2E.2E.html#397655600">(Oct 20 2023 at 08:18)</a>:</h4>
<p>dbaeumer opened <a href="https://github.com/bytecodealliance/wasmtime/issues/7310">issue #7310</a>:</p>
<blockquote>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="n">Error</span>: <span class="nc">error</span><span class="w"> </span><span class="k">while</span><span class="w"> </span><span class="n">executing</span><span class="w"> </span><span class="n">at</span><span class="w"> </span><span class="n">wasm</span><span class="w"> </span><span class="n">backtrace</span>:
    <span class="mi">0</span>: <span class="mh">0x1eda65</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="o">&lt;</span><span class="n">unknown</span><span class="o">&gt;!</span><span class="n">core</span>::<span class="n">sync</span>::<span class="n">atomic</span>::<span class="n">atomic_compare_exchange</span>::<span class="n">he4db91b5677645c3</span>
<span class="w">    </span><span class="mi">1</span>: <span class="mh">0x1a2511</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="o">&lt;</span><span class="n">unknown</span><span class="o">&gt;!</span><span class="n">core</span>::<span class="n">sync</span>::<span class="n">atomic</span>::<span class="n">AtomicUsize</span>::<span class="n">compare_exchange</span>::<span class="n">h10d76addb394aeb4</span>
<span class="w">    </span><span class="mi">2</span>: <span class="mh">0x191b87</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="o">&lt;</span><span class="n">unknown</span><span class="o">&gt;!</span><span class="n">crossbeam_channel</span>::<span class="n">context</span>::<span class="n">Context</span>::<span class="n">try_select</span>::<span class="n">hedc42d580d0f5209</span>
<span class="w">    </span><span class="mi">3</span>: <span class="mh">0x1c08f6</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="o">&lt;</span><span class="n">unknown</span><span class="o">&gt;!</span><span class="n">crossbeam_channel</span>::<span class="n">waker</span>::<span class="n">Waker</span>::<span class="n">try_select</span>::<span class="p">{{</span><span class="n">closure</span><span class="p">}}</span>::<span class="n">h861e99c8443efe4d</span>
<span class="w">    </span><span class="mi">4</span>: <span class="mh">0x188745</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="o">&lt;</span><span class="n">unknown</span><span class="o">&gt;!&lt;</span><span class="n">core</span>::<span class="n">slice</span>::<span class="n">iter</span>::<span class="n">Iter</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">core</span>::<span class="n">iter</span>::<span class="n">traits</span>::<span class="n">iterator</span>::<span class="nb">Iterator</span><span class="o">&gt;</span>::<span class="n">position</span>::<span class="n">hd056e06b364e3e44</span>
<span class="w">    </span><span class="mi">5</span>: <span class="mh">0x1c0784</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="o">&lt;</span><span class="n">unknown</span><span class="o">&gt;!</span><span class="n">crossbeam_channel</span>::<span class="n">waker</span>::<span class="n">Waker</span>::<span class="n">try_select</span>::<span class="n">h8c5edd4b2c5fd9da</span>
<span class="w">    </span><span class="mi">6</span>: <span class="mh">0x18a9a8</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="o">&lt;</span><span class="n">unknown</span><span class="o">&gt;!</span><span class="n">crossbeam_channel</span>::<span class="n">flavors</span>::<span class="n">zero</span>::<span class="n">Channel</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span>::<span class="n">send</span>::<span class="n">h8a671c75a1062370</span>
<span class="w">    </span><span class="mi">7</span>: <span class="mh">0x1e0917</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="o">&lt;</span><span class="n">unknown</span><span class="o">&gt;!</span><span class="n">crossbeam_channel</span>::<span class="n">channel</span>::<span class="n">Sender</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span>::<span class="n">send</span>::<span class="n">hd7006c022325632f</span>
<span class="w">    </span><span class="mi">8</span>: <span class="mh">0x1c972c</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="o">&lt;</span><span class="n">unknown</span><span class="o">&gt;!</span><span class="n">lsp_server</span>::<span class="n">stdio</span>::<span class="n">stdio_transport</span>::<span class="p">{{</span><span class="n">closure</span><span class="p">}}</span>::<span class="n">h95daef3273f8dae0</span>
<span class="w">    </span><span class="mi">9</span>: <span class="mh">0x195d98</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="o">&lt;</span><span class="n">unknown</span><span class="o">&gt;!</span><span class="n">std</span>::<span class="n">sys_common</span>::<span class="n">backtrace</span>::<span class="n">__rust_begin_short_backtrace</span>::<span class="n">hae1a61c1cb243dba</span>
<span class="w">   </span><span class="mi">10</span>: <span class="mh">0x17d215</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="o">&lt;</span><span class="n">unknown</span><span class="o">&gt;!</span><span class="n">std</span>::<span class="n">thread</span>::<span class="n">Builder</span>::<span class="n">spawn_unchecked_</span>::<span class="p">{{</span><span class="n">closure</span><span class="p">}}</span>::<span class="p">{{</span><span class="n">closure</span><span class="p">}}</span>::<span class="n">h8f84e616a49c3966</span>
<span class="w">   </span><span class="mi">11</span>: <span class="mh">0x188a17</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="o">&lt;</span><span class="n">unknown</span><span class="o">&gt;!&lt;</span><span class="n">core</span>::<span class="n">panic</span>::<span class="n">unwind_safe</span>::<span class="n">AssertUnwindSafe</span><span class="o">&lt;</span><span class="n">F</span><span class="o">&gt;</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">core</span>::<span class="n">ops</span>::<span class="n">function</span>::<span class="nb">FnOnce</span><span class="o">&lt;</span><span class="p">()</span><span class="o">&gt;&gt;</span>::<span class="n">call_once</span>::<span class="n">h8419b25b3e5d3010</span>
<span class="w">   </span><span class="mi">12</span>: <span class="mh">0x1ae909</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="o">&lt;</span><span class="n">unknown</span><span class="o">&gt;!</span><span class="n">std</span>::<span class="n">panicking</span>::<span class="kr">try</span>::<span class="n">do_call</span>::<span class="n">hc2efa2fef97ee73a</span>
<span class="w">   </span><span class="mi">13</span>: <span class="mh">0x1ae7e9</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="o">&lt;</span><span class="n">unknown</span><span class="o">&gt;!</span><span class="n">std</span>::<span class="n">panicking</span>::<span class="kr">try</span>::<span class="n">hb437d11b30ef124c</span>
<span class="w">   </span><span class="mi">14</span>: <span class="mh">0x17cd7a</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="o">&lt;</span><span class="n">unknown</span><span class="o">&gt;!</span><span class="n">std</span>::<span class="n">thread</span>::<span class="n">Builder</span>::<span class="n">spawn_unchecked_</span>::<span class="p">{{</span><span class="n">closure</span><span class="p">}}</span>::<span class="n">h48ecccc2f2bc6ed7</span>
<span class="w">   </span><span class="mi">15</span>: <span class="mh">0x1b5bf2</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="o">&lt;</span><span class="n">unknown</span><span class="o">&gt;!</span><span class="n">core</span>::<span class="n">ops</span>::<span class="n">function</span>::<span class="nb">FnOnce</span>::<span class="n">call_once</span><span class="p">{{</span><span class="n">vtable</span><span class="p">.</span><span class="n">shim</span><span class="p">}}</span>::<span class="n">hea4d8be1b607e767</span>
<span class="w">   </span><span class="mi">16</span>: <span class="mh">0x2a310b</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="o">&lt;</span><span class="n">unknown</span><span class="o">&gt;!</span><span class="n">std</span>::<span class="n">sys</span>::<span class="n">wasi</span>::<span class="n">thread</span>::<span class="n">Thread</span>::<span class="n">new</span>::<span class="n">thread_start</span>::<span class="n">h59449041806aed76</span>
<span class="w">   </span><span class="mi">17</span>: <span class="mh">0x2a7673</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="o">&lt;</span><span class="n">unknown</span><span class="o">&gt;!</span><span class="n">__wasi_thread_start_C</span>
<span class="w">   </span><span class="mi">18</span>: <span class="mh">0x2a81ee</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="o">&lt;</span><span class="n">unknown</span><span class="o">&gt;!</span><span class="n">wasi_thread_start</span>
<span class="n">note</span>: <span class="nc">using</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="err">`</span><span class="n">WASMTIME_BACKTRACE_DETAILS</span><span class="o">=</span><span class="mi">1</span><span class="err">`</span><span class="w"> </span><span class="n">environment</span><span class="w"> </span><span class="n">variable</span><span class="w"> </span><span class="n">may</span><span class="w"> </span><span class="n">show</span><span class="w"> </span><span class="n">more</span><span class="w"> </span><span class="n">debugging</span><span class="w"> </span><span class="n">information</span>

<span class="n">Caused</span><span class="w"> </span><span class="n">by</span>:
    <span class="nc">wasm</span><span class="w"> </span><span class="n">trap</span>: <span class="nc">unaligned</span><span class="w"> </span><span class="n">atomic</span>
</code></pre></div>
<h3>Steps to Reproduce</h3>
<ul>
<li>clone <a href="https://github.com/dbaeumer/wasm-lsp-server.git">https://github.com/dbaeumer/wasm-lsp-server.git</a></li>
<li>run <code>npm run build:wasm</code></li>
<li>run <code>npm run test:wasm</code></li>
</ul>
<h3>Expected Results</h3>
<ul>
<li>run <code>npm run build:exe</code></li>
<li>run <code>npm run test:exe</code></li>
</ul>
<p>wasm lsp server handles messages correctly</p>
<h3>Actual Results</h3>
<p>You get the above stack trace</p>
<h3>Versions and Environment</h3>
<p>Wasmtime: <code>wasmtime-cli 13.0.0</code><br>
Rustc: rustc 1.75.0-nightly (4578435e1 2023-10-19)</p>
<p>Operating system: Ubuntu 20.04</p>
<p>Architecture: x64</p>
</blockquote>



<a name="397656076"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%237310%20Multithread%20application%20traps%20with.../near/397656076" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.237310.20Multithread.20application.20traps.20with.2E.2E.2E.html#397656076">(Oct 20 2023 at 08:20)</a>:</h4>
<p>dbaeumer edited <a href="https://github.com/bytecodealliance/wasmtime/issues/7310">issue #7310</a>:</p>
<blockquote>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="n">Error</span>: <span class="nc">error</span><span class="w"> </span><span class="k">while</span><span class="w"> </span><span class="n">executing</span><span class="w"> </span><span class="n">at</span><span class="w"> </span><span class="n">wasm</span><span class="w"> </span><span class="n">backtrace</span>:
    <span class="mi">0</span>: <span class="mh">0x1eda65</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="o">&lt;</span><span class="n">unknown</span><span class="o">&gt;!</span><span class="n">core</span>::<span class="n">sync</span>::<span class="n">atomic</span>::<span class="n">atomic_compare_exchange</span>::<span class="n">he4db91b5677645c3</span>
<span class="w">    </span><span class="mi">1</span>: <span class="mh">0x1a2511</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="o">&lt;</span><span class="n">unknown</span><span class="o">&gt;!</span><span class="n">core</span>::<span class="n">sync</span>::<span class="n">atomic</span>::<span class="n">AtomicUsize</span>::<span class="n">compare_exchange</span>::<span class="n">h10d76addb394aeb4</span>
<span class="w">    </span><span class="mi">2</span>: <span class="mh">0x191b87</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="o">&lt;</span><span class="n">unknown</span><span class="o">&gt;!</span><span class="n">crossbeam_channel</span>::<span class="n">context</span>::<span class="n">Context</span>::<span class="n">try_select</span>::<span class="n">hedc42d580d0f5209</span>
<span class="w">    </span><span class="mi">3</span>: <span class="mh">0x1c08f6</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="o">&lt;</span><span class="n">unknown</span><span class="o">&gt;!</span><span class="n">crossbeam_channel</span>::<span class="n">waker</span>::<span class="n">Waker</span>::<span class="n">try_select</span>::<span class="p">{{</span><span class="n">closure</span><span class="p">}}</span>::<span class="n">h861e99c8443efe4d</span>
<span class="w">    </span><span class="mi">4</span>: <span class="mh">0x188745</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="o">&lt;</span><span class="n">unknown</span><span class="o">&gt;!&lt;</span><span class="n">core</span>::<span class="n">slice</span>::<span class="n">iter</span>::<span class="n">Iter</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">core</span>::<span class="n">iter</span>::<span class="n">traits</span>::<span class="n">iterator</span>::<span class="nb">Iterator</span><span class="o">&gt;</span>::<span class="n">position</span>::<span class="n">hd056e06b364e3e44</span>
<span class="w">    </span><span class="mi">5</span>: <span class="mh">0x1c0784</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="o">&lt;</span><span class="n">unknown</span><span class="o">&gt;!</span><span class="n">crossbeam_channel</span>::<span class="n">waker</span>::<span class="n">Waker</span>::<span class="n">try_select</span>::<span class="n">h8c5edd4b2c5fd9da</span>
<span class="w">    </span><span class="mi">6</span>: <span class="mh">0x18a9a8</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="o">&lt;</span><span class="n">unknown</span><span class="o">&gt;!</span><span class="n">crossbeam_channel</span>::<span class="n">flavors</span>::<span class="n">zero</span>::<span class="n">Channel</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span>::<span class="n">send</span>::<span class="n">h8a671c75a1062370</span>
<span class="w">    </span><span class="mi">7</span>: <span class="mh">0x1e0917</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="o">&lt;</span><span class="n">unknown</span><span class="o">&gt;!</span><span class="n">crossbeam_channel</span>::<span class="n">channel</span>::<span class="n">Sender</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span>::<span class="n">send</span>::<span class="n">hd7006c022325632f</span>
<span class="w">    </span><span class="mi">8</span>: <span class="mh">0x1c972c</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="o">&lt;</span><span class="n">unknown</span><span class="o">&gt;!</span><span class="n">lsp_server</span>::<span class="n">stdio</span>::<span class="n">stdio_transport</span>::<span class="p">{{</span><span class="n">closure</span><span class="p">}}</span>::<span class="n">h95daef3273f8dae0</span>
<span class="w">    </span><span class="mi">9</span>: <span class="mh">0x195d98</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="o">&lt;</span><span class="n">unknown</span><span class="o">&gt;!</span><span class="n">std</span>::<span class="n">sys_common</span>::<span class="n">backtrace</span>::<span class="n">__rust_begin_short_backtrace</span>::<span class="n">hae1a61c1cb243dba</span>
<span class="w">   </span><span class="mi">10</span>: <span class="mh">0x17d215</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="o">&lt;</span><span class="n">unknown</span><span class="o">&gt;!</span><span class="n">std</span>::<span class="n">thread</span>::<span class="n">Builder</span>::<span class="n">spawn_unchecked_</span>::<span class="p">{{</span><span class="n">closure</span><span class="p">}}</span>::<span class="p">{{</span><span class="n">closure</span><span class="p">}}</span>::<span class="n">h8f84e616a49c3966</span>
<span class="w">   </span><span class="mi">11</span>: <span class="mh">0x188a17</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="o">&lt;</span><span class="n">unknown</span><span class="o">&gt;!&lt;</span><span class="n">core</span>::<span class="n">panic</span>::<span class="n">unwind_safe</span>::<span class="n">AssertUnwindSafe</span><span class="o">&lt;</span><span class="n">F</span><span class="o">&gt;</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">core</span>::<span class="n">ops</span>::<span class="n">function</span>::<span class="nb">FnOnce</span><span class="o">&lt;</span><span class="p">()</span><span class="o">&gt;&gt;</span>::<span class="n">call_once</span>::<span class="n">h8419b25b3e5d3010</span>
<span class="w">   </span><span class="mi">12</span>: <span class="mh">0x1ae909</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="o">&lt;</span><span class="n">unknown</span><span class="o">&gt;!</span><span class="n">std</span>::<span class="n">panicking</span>::<span class="kr">try</span>::<span class="n">do_call</span>::<span class="n">hc2efa2fef97ee73a</span>
<span class="w">   </span><span class="mi">13</span>: <span class="mh">0x1ae7e9</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="o">&lt;</span><span class="n">unknown</span><span class="o">&gt;!</span><span class="n">std</span>::<span class="n">panicking</span>::<span class="kr">try</span>::<span class="n">hb437d11b30ef124c</span>
<span class="w">   </span><span class="mi">14</span>: <span class="mh">0x17cd7a</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="o">&lt;</span><span class="n">unknown</span><span class="o">&gt;!</span><span class="n">std</span>::<span class="n">thread</span>::<span class="n">Builder</span>::<span class="n">spawn_unchecked_</span>::<span class="p">{{</span><span class="n">closure</span><span class="p">}}</span>::<span class="n">h48ecccc2f2bc6ed7</span>
<span class="w">   </span><span class="mi">15</span>: <span class="mh">0x1b5bf2</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="o">&lt;</span><span class="n">unknown</span><span class="o">&gt;!</span><span class="n">core</span>::<span class="n">ops</span>::<span class="n">function</span>::<span class="nb">FnOnce</span>::<span class="n">call_once</span><span class="p">{{</span><span class="n">vtable</span><span class="p">.</span><span class="n">shim</span><span class="p">}}</span>::<span class="n">hea4d8be1b607e767</span>
<span class="w">   </span><span class="mi">16</span>: <span class="mh">0x2a310b</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="o">&lt;</span><span class="n">unknown</span><span class="o">&gt;!</span><span class="n">std</span>::<span class="n">sys</span>::<span class="n">wasi</span>::<span class="n">thread</span>::<span class="n">Thread</span>::<span class="n">new</span>::<span class="n">thread_start</span>::<span class="n">h59449041806aed76</span>
<span class="w">   </span><span class="mi">17</span>: <span class="mh">0x2a7673</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="o">&lt;</span><span class="n">unknown</span><span class="o">&gt;!</span><span class="n">__wasi_thread_start_C</span>
<span class="w">   </span><span class="mi">18</span>: <span class="mh">0x2a81ee</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="o">&lt;</span><span class="n">unknown</span><span class="o">&gt;!</span><span class="n">wasi_thread_start</span>
<span class="n">note</span>: <span class="nc">using</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="err">`</span><span class="n">WASMTIME_BACKTRACE_DETAILS</span><span class="o">=</span><span class="mi">1</span><span class="err">`</span><span class="w"> </span><span class="n">environment</span><span class="w"> </span><span class="n">variable</span><span class="w"> </span><span class="n">may</span><span class="w"> </span><span class="n">show</span><span class="w"> </span><span class="n">more</span><span class="w"> </span><span class="n">debugging</span><span class="w"> </span><span class="n">information</span>

<span class="n">Caused</span><span class="w"> </span><span class="n">by</span>:
    <span class="nc">wasm</span><span class="w"> </span><span class="n">trap</span>: <span class="nc">unaligned</span><span class="w"> </span><span class="n">atomic</span>
</code></pre></div>
<h3>Steps to Reproduce</h3>
<ul>
<li>clone <a href="https://github.com/dbaeumer/wasm-lsp-server.git">https://github.com/dbaeumer/wasm-lsp-server.git</a></li>
<li>run <code>npm run build:wasm</code></li>
<li>run <code>npm run test:wasm</code></li>
</ul>
<h3>Expected Results</h3>
<ul>
<li>run <code>npm run build:exe</code></li>
<li>run <code>npm run test:exe</code></li>
</ul>
<p>wasm lsp server handles messages correctly</p>
<h3>Actual Results</h3>
<p>You get the above stack trace</p>
<h3>Versions and Environment</h3>
<p>Wasmtime: <code>wasmtime-cli 13.0.0</code><br>
Rustc: rustc 1.75.0-nightly (4578435e1 2023-10-19) &amp; rustc 1.73.0</p>
<p>Operating system: Ubuntu 20.04</p>
<p>Architecture: x64</p>
</blockquote>



<a name="397735709"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%237310%20Multithread%20application%20traps%20with.../near/397735709" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.237310.20Multithread.20application.20traps.20with.2E.2E.2E.html#397735709">(Oct 20 2023 at 15:34)</a>:</h4>
<p>alexcrichton <a href="https://github.com/bytecodealliance/wasmtime/issues/7310#issuecomment-1772965017">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/7310">issue #7310</a>:</p>
<blockquote>
<p>Thanks for the report! I believe that Wasmtime is working correctly here because with some local debugging I found that the atomic is indeed not aligned correctly.</p>
<p>Further debugging showed that when built in release mode the server works well. My guess is that you're running into a stack overflow here which would become a segfault in native code but is not caught in WebAssembly code. Release mode typically takes less stack space which is probably why it works in release mode and not in debug mode.</p>
</blockquote>



<a name="397735710"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%237310%20Multithread%20application%20traps%20with.../near/397735710" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.237310.20Multithread.20application.20traps.20with.2E.2E.2E.html#397735710">(Oct 20 2023 at 15:34)</a>:</h4>
<p>alexcrichton closed <a href="https://github.com/bytecodealliance/wasmtime/issues/7310">issue #7310</a>:</p>
<blockquote>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="n">Error</span>: <span class="nc">error</span><span class="w"> </span><span class="k">while</span><span class="w"> </span><span class="n">executing</span><span class="w"> </span><span class="n">at</span><span class="w"> </span><span class="n">wasm</span><span class="w"> </span><span class="n">backtrace</span>:
    <span class="mi">0</span>: <span class="mh">0x1eda65</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="o">&lt;</span><span class="n">unknown</span><span class="o">&gt;!</span><span class="n">core</span>::<span class="n">sync</span>::<span class="n">atomic</span>::<span class="n">atomic_compare_exchange</span>::<span class="n">he4db91b5677645c3</span>
<span class="w">    </span><span class="mi">1</span>: <span class="mh">0x1a2511</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="o">&lt;</span><span class="n">unknown</span><span class="o">&gt;!</span><span class="n">core</span>::<span class="n">sync</span>::<span class="n">atomic</span>::<span class="n">AtomicUsize</span>::<span class="n">compare_exchange</span>::<span class="n">h10d76addb394aeb4</span>
<span class="w">    </span><span class="mi">2</span>: <span class="mh">0x191b87</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="o">&lt;</span><span class="n">unknown</span><span class="o">&gt;!</span><span class="n">crossbeam_channel</span>::<span class="n">context</span>::<span class="n">Context</span>::<span class="n">try_select</span>::<span class="n">hedc42d580d0f5209</span>
<span class="w">    </span><span class="mi">3</span>: <span class="mh">0x1c08f6</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="o">&lt;</span><span class="n">unknown</span><span class="o">&gt;!</span><span class="n">crossbeam_channel</span>::<span class="n">waker</span>::<span class="n">Waker</span>::<span class="n">try_select</span>::<span class="p">{{</span><span class="n">closure</span><span class="p">}}</span>::<span class="n">h861e99c8443efe4d</span>
<span class="w">    </span><span class="mi">4</span>: <span class="mh">0x188745</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="o">&lt;</span><span class="n">unknown</span><span class="o">&gt;!&lt;</span><span class="n">core</span>::<span class="n">slice</span>::<span class="n">iter</span>::<span class="n">Iter</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">core</span>::<span class="n">iter</span>::<span class="n">traits</span>::<span class="n">iterator</span>::<span class="nb">Iterator</span><span class="o">&gt;</span>::<span class="n">position</span>::<span class="n">hd056e06b364e3e44</span>
<span class="w">    </span><span class="mi">5</span>: <span class="mh">0x1c0784</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="o">&lt;</span><span class="n">unknown</span><span class="o">&gt;!</span><span class="n">crossbeam_channel</span>::<span class="n">waker</span>::<span class="n">Waker</span>::<span class="n">try_select</span>::<span class="n">h8c5edd4b2c5fd9da</span>
<span class="w">    </span><span class="mi">6</span>: <span class="mh">0x18a9a8</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="o">&lt;</span><span class="n">unknown</span><span class="o">&gt;!</span><span class="n">crossbeam_channel</span>::<span class="n">flavors</span>::<span class="n">zero</span>::<span class="n">Channel</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span>::<span class="n">send</span>::<span class="n">h8a671c75a1062370</span>
<span class="w">    </span><span class="mi">7</span>: <span class="mh">0x1e0917</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="o">&lt;</span><span class="n">unknown</span><span class="o">&gt;!</span><span class="n">crossbeam_channel</span>::<span class="n">channel</span>::<span class="n">Sender</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span>::<span class="n">send</span>::<span class="n">hd7006c022325632f</span>
<span class="w">    </span><span class="mi">8</span>: <span class="mh">0x1c972c</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="o">&lt;</span><span class="n">unknown</span><span class="o">&gt;!</span><span class="n">lsp_server</span>::<span class="n">stdio</span>::<span class="n">stdio_transport</span>::<span class="p">{{</span><span class="n">closure</span><span class="p">}}</span>::<span class="n">h95daef3273f8dae0</span>
<span class="w">    </span><span class="mi">9</span>: <span class="mh">0x195d98</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="o">&lt;</span><span class="n">unknown</span><span class="o">&gt;!</span><span class="n">std</span>::<span class="n">sys_common</span>::<span class="n">backtrace</span>::<span class="n">__rust_begin_short_backtrace</span>::<span class="n">hae1a61c1cb243dba</span>
<span class="w">   </span><span class="mi">10</span>: <span class="mh">0x17d215</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="o">&lt;</span><span class="n">unknown</span><span class="o">&gt;!</span><span class="n">std</span>::<span class="n">thread</span>::<span class="n">Builder</span>::<span class="n">spawn_unchecked_</span>::<span class="p">{{</span><span class="n">closure</span><span class="p">}}</span>::<span class="p">{{</span><span class="n">closure</span><span class="p">}}</span>::<span class="n">h8f84e616a49c3966</span>
<span class="w">   </span><span class="mi">11</span>: <span class="mh">0x188a17</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="o">&lt;</span><span class="n">unknown</span><span class="o">&gt;!&lt;</span><span class="n">core</span>::<span class="n">panic</span>::<span class="n">unwind_safe</span>::<span class="n">AssertUnwindSafe</span><span class="o">&lt;</span><span class="n">F</span><span class="o">&gt;</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">core</span>::<span class="n">ops</span>::<span class="n">function</span>::<span class="nb">FnOnce</span><span class="o">&lt;</span><span class="p">()</span><span class="o">&gt;&gt;</span>::<span class="n">call_once</span>::<span class="n">h8419b25b3e5d3010</span>
<span class="w">   </span><span class="mi">12</span>: <span class="mh">0x1ae909</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="o">&lt;</span><span class="n">unknown</span><span class="o">&gt;!</span><span class="n">std</span>::<span class="n">panicking</span>::<span class="kr">try</span>::<span class="n">do_call</span>::<span class="n">hc2efa2fef97ee73a</span>
<span class="w">   </span><span class="mi">13</span>: <span class="mh">0x1ae7e9</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="o">&lt;</span><span class="n">unknown</span><span class="o">&gt;!</span><span class="n">std</span>::<span class="n">panicking</span>::<span class="kr">try</span>::<span class="n">hb437d11b30ef124c</span>
<span class="w">   </span><span class="mi">14</span>: <span class="mh">0x17cd7a</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="o">&lt;</span><span class="n">unknown</span><span class="o">&gt;!</span><span class="n">std</span>::<span class="n">thread</span>::<span class="n">Builder</span>::<span class="n">spawn_unchecked_</span>::<span class="p">{{</span><span class="n">closure</span><span class="p">}}</span>::<span class="n">h48ecccc2f2bc6ed7</span>
<span class="w">   </span><span class="mi">15</span>: <span class="mh">0x1b5bf2</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="o">&lt;</span><span class="n">unknown</span><span class="o">&gt;!</span><span class="n">core</span>::<span class="n">ops</span>::<span class="n">function</span>::<span class="nb">FnOnce</span>::<span class="n">call_once</span><span class="p">{{</span><span class="n">vtable</span><span class="p">.</span><span class="n">shim</span><span class="p">}}</span>::<span class="n">hea4d8be1b607e767</span>
<span class="w">   </span><span class="mi">16</span>: <span class="mh">0x2a310b</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="o">&lt;</span><span class="n">unknown</span><span class="o">&gt;!</span><span class="n">std</span>::<span class="n">sys</span>::<span class="n">wasi</span>::<span class="n">thread</span>::<span class="n">Thread</span>::<span class="n">new</span>::<span class="n">thread_start</span>::<span class="n">h59449041806aed76</span>
<span class="w">   </span><span class="mi">17</span>: <span class="mh">0x2a7673</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="o">&lt;</span><span class="n">unknown</span><span class="o">&gt;!</span><span class="n">__wasi_thread_start_C</span>
<span class="w">   </span><span class="mi">18</span>: <span class="mh">0x2a81ee</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="o">&lt;</span><span class="n">unknown</span><span class="o">&gt;!</span><span class="n">wasi_thread_start</span>
<span class="n">note</span>: <span class="nc">using</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="err">`</span><span class="n">WASMTIME_BACKTRACE_DETAILS</span><span class="o">=</span><span class="mi">1</span><span class="err">`</span><span class="w"> </span><span class="n">environment</span><span class="w"> </span><span class="n">variable</span><span class="w"> </span><span class="n">may</span><span class="w"> </span><span class="n">show</span><span class="w"> </span><span class="n">more</span><span class="w"> </span><span class="n">debugging</span><span class="w"> </span><span class="n">information</span>

<span class="n">Caused</span><span class="w"> </span><span class="n">by</span>:
    <span class="nc">wasm</span><span class="w"> </span><span class="n">trap</span>: <span class="nc">unaligned</span><span class="w"> </span><span class="n">atomic</span>
</code></pre></div>
<h3>Steps to Reproduce</h3>
<ul>
<li>clone <a href="https://github.com/dbaeumer/wasm-lsp-server.git">https://github.com/dbaeumer/wasm-lsp-server.git</a></li>
<li>run <code>npm run build:wasm</code></li>
<li>run <code>npm run test:wasm</code></li>
</ul>
<h3>Expected Results</h3>
<ul>
<li>run <code>npm run build:exe</code></li>
<li>run <code>npm run test:exe</code></li>
</ul>
<p>wasm lsp server handles messages correctly</p>
<h3>Actual Results</h3>
<p>You get the above stack trace</p>
<h3>Versions and Environment</h3>
<p>Wasmtime: <code>wasmtime-cli 13.0.0</code><br>
Rustc: rustc 1.75.0-nightly (4578435e1 2023-10-19) &amp; rustc 1.73.0</p>
<p>Operating system: Ubuntu 20.04</p>
<p>Architecture: x64</p>
</blockquote>



<a name="397738505"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%237310%20Multithread%20application%20traps%20with.../near/397738505" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.237310.20Multithread.20application.20traps.20with.2E.2E.2E.html#397738505">(Oct 20 2023 at 15:50)</a>:</h4>
<p>dbaeumer <a href="https://github.com/bytecodealliance/wasmtime/issues/7310#issuecomment-1772987734">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/7310">issue #7310</a>:</p>
<blockquote>
<p>@alexcrichton thanks for the pointer. Will use release mode instead.</p>
</blockquote>



<hr><p>Last updated: Jan 20 2025 at 06:04 UTC</p>
</html>