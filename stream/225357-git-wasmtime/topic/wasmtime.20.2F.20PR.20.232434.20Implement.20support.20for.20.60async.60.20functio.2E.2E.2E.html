<html>
<head><meta charset="utf-8"><title>wasmtime / PR #2434 Implement support for `async` functio... · git-wasmtime · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/index.html">git-wasmtime</a></h2>
<h3>Topic: <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232434.20Implement.20support.20for.20.60async.60.20functio.2E.2E.2E.html">wasmtime / PR #2434 Implement support for `async` functio...</a></h3>

<hr>

<base href="https://bytecodealliance.zulipchat.com">

<head><link href="https://bytecodealliance.github.io/zulip-archive/style.css" rel="stylesheet"></head>

<a name="217343913"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232434%20Implement%20support%20for%20%60async%60%20functio.../near/217343913" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232434.20Implement.20support.20for.20.60async.60.20functio.2E.2E.2E.html#217343913">(Nov 19 2020 at 23:17)</a>:</h4>
<p>alexcrichton opened <a href="https://github.com/bytecodealliance/wasmtime/pull/2434">PR #2434</a> from <code>async</code> to <code>main</code>:</p>
<blockquote>
<p>This is an implementation of [RFC 2] in Wasmtime which is to support<br>
<code>async</code>-defined host functions. At a high level support is added by<br>
executing WebAssembly code that might invoke an asynchronous host<br>
function on a separate native stack. When the host function's future is<br>
not ready we switch back to the main native stack to continue execution.</p>
<p>There's a whole bunch of details in this commit, and it's a bit much to<br>
go over them all here in this commit message. The most important changes<br>
here are:</p>
<ul>
<li>
<p>A new <code>wasmtime-fiber</code> crate has been written to manage the low-level<br>
  details of stack-switching. Unixes use <code>mmap</code> to allocate a stack and<br>
  Windows uses the native fibers implementation. We'll surely want to<br>
  refactor this to move stack allocation elsewhere in the future. Fibers<br>
  are intended to be relatively general with a lot of type paremters to<br>
  fling values back and forth across suspension points. The whole crate<br>
  is a giant wad of <code>unsafe</code> unfortunately and involves handwritten<br>
  assembly with custom dwarf CFI directives to boot. Definitely deserves<br>
  a close eye in review!</p>
</li>
<li>
<p>The <code>Store</code> type has two new methods -- <code>block_on</code> and <code>on_fiber</code><br>
  which bridge between the async and non-async worlds. Lots of unsafe<br>
  fiddly bits here as we're trying to communicate context pointers<br>
  between disparate portions of the code. Extra eyes and care in review<br>
  is greatly appreciated.</p>
</li>
<li>
<p>The APIs for binding <code>async</code> functions are unfortunately pretty ugly<br>
  in <code>Func</code>. This is mostly due to language limitations and compiler<br>
  bugs (I believe) in Rust. Instead of <code>Func::wrap</code> we have a<br>
<code>Func::wrapN_async</code> family of methods, and we've also got a whole<br>
  bunch of <code>Func::getN_async</code> methods now too. It may be worth<br>
  rethinking the API of <code>Func</code> to try to make the documentation page<br>
  actually grok'able.</p>
</li>
</ul>
<p>This isn't super heavily tested but the various test should suffice for<br>
engaging hopefully nearly all the infrastructure in one form or another.<br>
This is just the start though!</p>
<p>[RFC 2]: <a href="https://github.com/bytecodealliance/rfcs/pull/2">https://github.com/bytecodealliance/rfcs/pull/2</a></p>
<p>&lt;!--</p>
<p>Please ensure that the following steps are all taken care of before submitting<br>
the PR.</p>
<ul>
<li>
<p>[ ] This has been discussed in issue #..., or if not, please tell us why<br>
  here.</p>
</li>
<li>
<p>[ ] A short description of what this does, why it is needed; if the<br>
  description becomes long, the matter should probably be discussed in an issue<br>
  first.</p>
</li>
<li>
<p>[ ] This PR contains test cases, if meaningful.</p>
</li>
<li>[ ] A reviewer from the core maintainer team has been assigned for this PR.<br>
  If you don't know who could review this, please indicate so. The list of<br>
  suggested reviewers on the right can help you.</li>
</ul>
<p>Please ensure all communication adheres to the <a href="https://github.com/bytecodealliance/wasmtime/blob/master/CODE_OF_CONDUCT.md">code of
conduct</a>.<br>
--&gt;</p>
</blockquote>



<a name="217344083"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232434%20Implement%20support%20for%20%60async%60%20functio.../near/217344083" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232434.20Implement.20support.20for.20.60async.60.20functio.2E.2E.2E.html#217344083">(Nov 19 2020 at 23:19)</a>:</h4>
<p>alexcrichton updated <a href="https://github.com/bytecodealliance/wasmtime/pull/2434">PR #2434</a> from <code>async</code> to <code>main</code>:</p>
<blockquote>
<p>This is an implementation of [RFC 2] in Wasmtime which is to support<br>
<code>async</code>-defined host functions. At a high level support is added by<br>
executing WebAssembly code that might invoke an asynchronous host<br>
function on a separate native stack. When the host function's future is<br>
not ready we switch back to the main native stack to continue execution.</p>
<p>There's a whole bunch of details in this commit, and it's a bit much to<br>
go over them all here in this commit message. The most important changes<br>
here are:</p>
<ul>
<li>
<p>A new <code>wasmtime-fiber</code> crate has been written to manage the low-level<br>
  details of stack-switching. Unixes use <code>mmap</code> to allocate a stack and<br>
  Windows uses the native fibers implementation. We'll surely want to<br>
  refactor this to move stack allocation elsewhere in the future. Fibers<br>
  are intended to be relatively general with a lot of type paremters to<br>
  fling values back and forth across suspension points. The whole crate<br>
  is a giant wad of <code>unsafe</code> unfortunately and involves handwritten<br>
  assembly with custom dwarf CFI directives to boot. Definitely deserves<br>
  a close eye in review!</p>
</li>
<li>
<p>The <code>Store</code> type has two new methods -- <code>block_on</code> and <code>on_fiber</code><br>
  which bridge between the async and non-async worlds. Lots of unsafe<br>
  fiddly bits here as we're trying to communicate context pointers<br>
  between disparate portions of the code. Extra eyes and care in review<br>
  is greatly appreciated.</p>
</li>
<li>
<p>The APIs for binding <code>async</code> functions are unfortunately pretty ugly<br>
  in <code>Func</code>. This is mostly due to language limitations and compiler<br>
  bugs (I believe) in Rust. Instead of <code>Func::wrap</code> we have a<br>
<code>Func::wrapN_async</code> family of methods, and we've also got a whole<br>
  bunch of <code>Func::getN_async</code> methods now too. It may be worth<br>
  rethinking the API of <code>Func</code> to try to make the documentation page<br>
  actually grok'able.</p>
</li>
</ul>
<p>This isn't super heavily tested but the various test should suffice for<br>
engaging hopefully nearly all the infrastructure in one form or another.<br>
This is just the start though!</p>
<p>[RFC 2]: <a href="https://github.com/bytecodealliance/rfcs/pull/2">https://github.com/bytecodealliance/rfcs/pull/2</a></p>
<p>&lt;!--</p>
<p>Please ensure that the following steps are all taken care of before submitting<br>
the PR.</p>
<ul>
<li>
<p>[ ] This has been discussed in issue #..., or if not, please tell us why<br>
  here.</p>
</li>
<li>
<p>[ ] A short description of what this does, why it is needed; if the<br>
  description becomes long, the matter should probably be discussed in an issue<br>
  first.</p>
</li>
<li>
<p>[ ] This PR contains test cases, if meaningful.</p>
</li>
<li>[ ] A reviewer from the core maintainer team has been assigned for this PR.<br>
  If you don't know who could review this, please indicate so. The list of<br>
  suggested reviewers on the right can help you.</li>
</ul>
<p>Please ensure all communication adheres to the <a href="https://github.com/bytecodealliance/wasmtime/blob/master/CODE_OF_CONDUCT.md">code of
conduct</a>.<br>
--&gt;</p>
</blockquote>



<a name="217345108"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232434%20Implement%20support%20for%20%60async%60%20functio.../near/217345108" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232434.20Implement.20support.20for.20.60async.60.20functio.2E.2E.2E.html#217345108">(Nov 19 2020 at 23:32)</a>:</h4>
<p>cfallin submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/2434#pullrequestreview-534942287">PR Review</a>.</p>



<a name="217345109"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232434%20Implement%20support%20for%20%60async%60%20functio.../near/217345109" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232434.20Implement.20support.20for.20.60async.60.20functio.2E.2E.2E.html#217345109">(Nov 19 2020 at 23:32)</a>:</h4>
<p>cfallin created <a href="https://github.com/bytecodealliance/wasmtime/pull/2434#discussion_r527273742">PR Review Comment</a>:</p>
<blockquote>
<p>The bottom 64 bits of <code>v8</code> -- <code>v15</code> (aka <code>q8</code> -- <code>q15</code>) are callee-saved as well (yeah, it's kinda weird!). <code>stp q8, q9, ...</code>, etc. should work.</p>
</blockquote>



<a name="217365848"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232434%20Implement%20support%20for%20%60async%60%20functio.../near/217365848" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232434.20Implement.20support.20for.20.60async.60.20functio.2E.2E.2E.html#217365848">(Nov 20 2020 at 06:10)</a>:</h4>
<p>alexcrichton submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/2434#pullrequestreview-535138238">PR Review</a>.</p>



<a name="217365850"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232434%20Implement%20support%20for%20%60async%60%20functio.../near/217365850" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232434.20Implement.20support.20for.20.60async.60.20functio.2E.2E.2E.html#217365850">(Nov 20 2020 at 06:10)</a>:</h4>
<p>alexcrichton created <a href="https://github.com/bytecodealliance/wasmtime/pull/2434#discussion_r527448623">PR Review Comment</a>:</p>
<blockquote>
<p>I think this is the first time I've done aarch64 assembly, so want to confirm something to make sure. According <a href="https://developer.arm.com/architectures/learn-the-architecture/aarch64-instruction-set-architecture/registers-in-aarch64-general-purpose-registers">to this</a> the low 64-bits of the vector registers are <code>dN</code>, does that sound right? From what <a href="https://developer.arm.com/architectures/learn-the-architecture/aarch64-instruction-set-architecture/procedure-call-standard">this is saying though</a> is it true that <code>d8</code> to <code>d31</code> all need to be saved? (wow that's a lot of registers)</p>
</blockquote>



<a name="217367072"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232434%20Implement%20support%20for%20%60async%60%20functio.../near/217367072" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232434.20Implement.20support.20for.20.60async.60.20functio.2E.2E.2E.html#217367072">(Nov 20 2020 at 06:41)</a>:</h4>
<p>cfallin submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/2434#pullrequestreview-535149369">PR Review</a>.</p>



<a name="217367073"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232434%20Implement%20support%20for%20%60async%60%20functio.../near/217367073" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232434.20Implement.20support.20for.20.60async.60.20functio.2E.2E.2E.html#217367073">(Nov 20 2020 at 06:41)</a>:</h4>
<p>cfallin created <a href="https://github.com/bytecodealliance/wasmtime/pull/2434#discussion_r527471451">PR Review Comment</a>:</p>
<blockquote>
<p>Err, sorry, <code>d8</code> -- <code>d15</code>, yes. That document is a bit perplexing to me, though; the AArch64 "AAPCS" (standard ABI) (<a href="https://c9x.me/compile/bib/abi-arm64.pdf">direct pdf link</a> to ABI doc, or <a href="https://developer.arm.com/documentation/ihi0055/b/">ARM's download page</a>) says in 5.1.2 that <code>v0</code> -- <code>v7</code> and <code>v16</code> -- <code>v31</code> are caller-saved, and that's what we've implemented elsewhere (and what our friendly local ARM engineers have pointed us to -- see e.g. #2254).</p>
<p>I'm actually wondering if the ARM page you've linked has a typo; they segment the registers into 8-15 and 16-31, but write "callee-save" for both; there'd be no reason to write the two ranges separately otherwise. In any case, hopefully the above helps somewhat!</p>
</blockquote>



<a name="217414803"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232434%20Implement%20support%20for%20%60async%60%20functio.../near/217414803" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232434.20Implement.20support.20for.20.60async.60.20functio.2E.2E.2E.html#217414803">(Nov 20 2020 at 15:27)</a>:</h4>
<p>alexcrichton updated <a href="https://github.com/bytecodealliance/wasmtime/pull/2434">PR #2434</a> from <code>async</code> to <code>main</code>:</p>
<blockquote>
<p>This is an implementation of [RFC 2] in Wasmtime which is to support<br>
<code>async</code>-defined host functions. At a high level support is added by<br>
executing WebAssembly code that might invoke an asynchronous host<br>
function on a separate native stack. When the host function's future is<br>
not ready we switch back to the main native stack to continue execution.</p>
<p>There's a whole bunch of details in this commit, and it's a bit much to<br>
go over them all here in this commit message. The most important changes<br>
here are:</p>
<ul>
<li>
<p>A new <code>wasmtime-fiber</code> crate has been written to manage the low-level<br>
  details of stack-switching. Unixes use <code>mmap</code> to allocate a stack and<br>
  Windows uses the native fibers implementation. We'll surely want to<br>
  refactor this to move stack allocation elsewhere in the future. Fibers<br>
  are intended to be relatively general with a lot of type paremters to<br>
  fling values back and forth across suspension points. The whole crate<br>
  is a giant wad of <code>unsafe</code> unfortunately and involves handwritten<br>
  assembly with custom dwarf CFI directives to boot. Definitely deserves<br>
  a close eye in review!</p>
</li>
<li>
<p>The <code>Store</code> type has two new methods -- <code>block_on</code> and <code>on_fiber</code><br>
  which bridge between the async and non-async worlds. Lots of unsafe<br>
  fiddly bits here as we're trying to communicate context pointers<br>
  between disparate portions of the code. Extra eyes and care in review<br>
  is greatly appreciated.</p>
</li>
<li>
<p>The APIs for binding <code>async</code> functions are unfortunately pretty ugly<br>
  in <code>Func</code>. This is mostly due to language limitations and compiler<br>
  bugs (I believe) in Rust. Instead of <code>Func::wrap</code> we have a<br>
<code>Func::wrapN_async</code> family of methods, and we've also got a whole<br>
  bunch of <code>Func::getN_async</code> methods now too. It may be worth<br>
  rethinking the API of <code>Func</code> to try to make the documentation page<br>
  actually grok'able.</p>
</li>
</ul>
<p>This isn't super heavily tested but the various test should suffice for<br>
engaging hopefully nearly all the infrastructure in one form or another.<br>
This is just the start though!</p>
<p>[RFC 2]: <a href="https://github.com/bytecodealliance/rfcs/pull/2">https://github.com/bytecodealliance/rfcs/pull/2</a></p>
<p>&lt;!--</p>
<p>Please ensure that the following steps are all taken care of before submitting<br>
the PR.</p>
<ul>
<li>
<p>[ ] This has been discussed in issue #..., or if not, please tell us why<br>
  here.</p>
</li>
<li>
<p>[ ] A short description of what this does, why it is needed; if the<br>
  description becomes long, the matter should probably be discussed in an issue<br>
  first.</p>
</li>
<li>
<p>[ ] This PR contains test cases, if meaningful.</p>
</li>
<li>[ ] A reviewer from the core maintainer team has been assigned for this PR.<br>
  If you don't know who could review this, please indicate so. The list of<br>
  suggested reviewers on the right can help you.</li>
</ul>
<p>Please ensure all communication adheres to the <a href="https://github.com/bytecodealliance/wasmtime/blob/master/CODE_OF_CONDUCT.md">code of
conduct</a>.<br>
--&gt;</p>
</blockquote>



<a name="217415428"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232434%20Implement%20support%20for%20%60async%60%20functio.../near/217415428" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232434.20Implement.20support.20for.20.60async.60.20functio.2E.2E.2E.html#217415428">(Nov 20 2020 at 15:32)</a>:</h4>
<p>alexcrichton updated <a href="https://github.com/bytecodealliance/wasmtime/pull/2434">PR #2434</a> from <code>async</code> to <code>main</code>:</p>
<blockquote>
<p>This is an implementation of [RFC 2] in Wasmtime which is to support<br>
<code>async</code>-defined host functions. At a high level support is added by<br>
executing WebAssembly code that might invoke an asynchronous host<br>
function on a separate native stack. When the host function's future is<br>
not ready we switch back to the main native stack to continue execution.</p>
<p>There's a whole bunch of details in this commit, and it's a bit much to<br>
go over them all here in this commit message. The most important changes<br>
here are:</p>
<ul>
<li>
<p>A new <code>wasmtime-fiber</code> crate has been written to manage the low-level<br>
  details of stack-switching. Unixes use <code>mmap</code> to allocate a stack and<br>
  Windows uses the native fibers implementation. We'll surely want to<br>
  refactor this to move stack allocation elsewhere in the future. Fibers<br>
  are intended to be relatively general with a lot of type paremters to<br>
  fling values back and forth across suspension points. The whole crate<br>
  is a giant wad of <code>unsafe</code> unfortunately and involves handwritten<br>
  assembly with custom dwarf CFI directives to boot. Definitely deserves<br>
  a close eye in review!</p>
</li>
<li>
<p>The <code>Store</code> type has two new methods -- <code>block_on</code> and <code>on_fiber</code><br>
  which bridge between the async and non-async worlds. Lots of unsafe<br>
  fiddly bits here as we're trying to communicate context pointers<br>
  between disparate portions of the code. Extra eyes and care in review<br>
  is greatly appreciated.</p>
</li>
<li>
<p>The APIs for binding <code>async</code> functions are unfortunately pretty ugly<br>
  in <code>Func</code>. This is mostly due to language limitations and compiler<br>
  bugs (I believe) in Rust. Instead of <code>Func::wrap</code> we have a<br>
<code>Func::wrapN_async</code> family of methods, and we've also got a whole<br>
  bunch of <code>Func::getN_async</code> methods now too. It may be worth<br>
  rethinking the API of <code>Func</code> to try to make the documentation page<br>
  actually grok'able.</p>
</li>
</ul>
<p>This isn't super heavily tested but the various test should suffice for<br>
engaging hopefully nearly all the infrastructure in one form or another.<br>
This is just the start though!</p>
<p>[RFC 2]: <a href="https://github.com/bytecodealliance/rfcs/pull/2">https://github.com/bytecodealliance/rfcs/pull/2</a></p>
<p>&lt;!--</p>
<p>Please ensure that the following steps are all taken care of before submitting<br>
the PR.</p>
<ul>
<li>
<p>[ ] This has been discussed in issue #..., or if not, please tell us why<br>
  here.</p>
</li>
<li>
<p>[ ] A short description of what this does, why it is needed; if the<br>
  description becomes long, the matter should probably be discussed in an issue<br>
  first.</p>
</li>
<li>
<p>[ ] This PR contains test cases, if meaningful.</p>
</li>
<li>[ ] A reviewer from the core maintainer team has been assigned for this PR.<br>
  If you don't know who could review this, please indicate so. The list of<br>
  suggested reviewers on the right can help you.</li>
</ul>
<p>Please ensure all communication adheres to the <a href="https://github.com/bytecodealliance/wasmtime/blob/master/CODE_OF_CONDUCT.md">code of
conduct</a>.<br>
--&gt;</p>
</blockquote>



<a name="217415778"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232434%20Implement%20support%20for%20%60async%60%20functio.../near/217415778" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232434.20Implement.20support.20for.20.60async.60.20functio.2E.2E.2E.html#217415778">(Nov 20 2020 at 15:34)</a>:</h4>
<p>alexcrichton submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/2434#pullrequestreview-535532270">PR Review</a>.</p>



<a name="217415780"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232434%20Implement%20support%20for%20%60async%60%20functio.../near/217415780" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232434.20Implement.20support.20for.20.60async.60.20functio.2E.2E.2E.html#217415780">(Nov 20 2020 at 15:34)</a>:</h4>
<p>alexcrichton created <a href="https://github.com/bytecodealliance/wasmtime/pull/2434#discussion_r527771734">PR Review Comment</a>:</p>
<blockquote>
<p>Oh interesting! That does indeed look like a typo. Ok cool, then I think this should be handled in e40bd97</p>
</blockquote>



<a name="223571441"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232434%20Implement%20support%20for%20%60async%60%20functio.../near/223571441" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232434.20Implement.20support.20for.20.60async.60.20functio.2E.2E.2E.html#223571441">(Jan 21 2021 at 21:15)</a>:</h4>
<p>alexcrichton updated <a href="https://github.com/bytecodealliance/wasmtime/pull/2434">PR #2434</a> from <code>async</code> to <code>main</code>:</p>
<blockquote>
<p>This is an implementation of [RFC 2] in Wasmtime which is to support<br>
<code>async</code>-defined host functions. At a high level support is added by<br>
executing WebAssembly code that might invoke an asynchronous host<br>
function on a separate native stack. When the host function's future is<br>
not ready we switch back to the main native stack to continue execution.</p>
<p>There's a whole bunch of details in this commit, and it's a bit much to<br>
go over them all here in this commit message. The most important changes<br>
here are:</p>
<ul>
<li>
<p>A new <code>wasmtime-fiber</code> crate has been written to manage the low-level<br>
  details of stack-switching. Unixes use <code>mmap</code> to allocate a stack and<br>
  Windows uses the native fibers implementation. We'll surely want to<br>
  refactor this to move stack allocation elsewhere in the future. Fibers<br>
  are intended to be relatively general with a lot of type paremters to<br>
  fling values back and forth across suspension points. The whole crate<br>
  is a giant wad of <code>unsafe</code> unfortunately and involves handwritten<br>
  assembly with custom dwarf CFI directives to boot. Definitely deserves<br>
  a close eye in review!</p>
</li>
<li>
<p>The <code>Store</code> type has two new methods -- <code>block_on</code> and <code>on_fiber</code><br>
  which bridge between the async and non-async worlds. Lots of unsafe<br>
  fiddly bits here as we're trying to communicate context pointers<br>
  between disparate portions of the code. Extra eyes and care in review<br>
  is greatly appreciated.</p>
</li>
<li>
<p>The APIs for binding <code>async</code> functions are unfortunately pretty ugly<br>
  in <code>Func</code>. This is mostly due to language limitations and compiler<br>
  bugs (I believe) in Rust. Instead of <code>Func::wrap</code> we have a<br>
<code>Func::wrapN_async</code> family of methods, and we've also got a whole<br>
  bunch of <code>Func::getN_async</code> methods now too. It may be worth<br>
  rethinking the API of <code>Func</code> to try to make the documentation page<br>
  actually grok'able.</p>
</li>
</ul>
<p>This isn't super heavily tested but the various test should suffice for<br>
engaging hopefully nearly all the infrastructure in one form or another.<br>
This is just the start though!</p>
<p>[RFC 2]: <a href="https://github.com/bytecodealliance/rfcs/pull/2">https://github.com/bytecodealliance/rfcs/pull/2</a></p>
<p>&lt;!--</p>
<p>Please ensure that the following steps are all taken care of before submitting<br>
the PR.</p>
<ul>
<li>
<p>[ ] This has been discussed in issue #..., or if not, please tell us why<br>
  here.</p>
</li>
<li>
<p>[ ] A short description of what this does, why it is needed; if the<br>
  description becomes long, the matter should probably be discussed in an issue<br>
  first.</p>
</li>
<li>
<p>[ ] This PR contains test cases, if meaningful.</p>
</li>
<li>[ ] A reviewer from the core maintainer team has been assigned for this PR.<br>
  If you don't know who could review this, please indicate so. The list of<br>
  suggested reviewers on the right can help you.</li>
</ul>
<p>Please ensure all communication adheres to the <a href="https://github.com/bytecodealliance/wasmtime/blob/master/CODE_OF_CONDUCT.md">code of
conduct</a>.<br>
--&gt;<br>
</p>
</blockquote>



<a name="224093172"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232434%20Implement%20support%20for%20%60async%60%20functio.../near/224093172" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232434.20Implement.20support.20for.20.60async.60.20functio.2E.2E.2E.html#224093172">(Jan 26 2021 at 19:53)</a>:</h4>
<p>smacleod submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/2434#pullrequestreview-576692084">PR Review</a>.</p>



<a name="224093173"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232434%20Implement%20support%20for%20%60async%60%20functio.../near/224093173" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232434.20Implement.20support.20for.20.60async.60.20functio.2E.2E.2E.html#224093173">(Jan 26 2021 at 19:53)</a>:</h4>
<p>smacleod submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/2434#pullrequestreview-576692084">PR Review</a>.</p>



<a name="224093174"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232434%20Implement%20support%20for%20%60async%60%20functio.../near/224093174" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232434.20Implement.20support.20for.20.60async.60.20functio.2E.2E.2E.html#224093174">(Jan 26 2021 at 19:53)</a>:</h4>
<p>smacleod created <a href="https://github.com/bytecodealliance/wasmtime/pull/2434#discussion_r564777811">PR Review Comment</a>:</p>
<blockquote>
<p><div class="codehilite" data-code-language="suggestion"><pre><span></span><code>    // instruction which just aborts, but I don't know such an instruction in
    // aarch64 land.
</code></pre></div><br>
</p>
</blockquote>



<a name="224094185"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232434%20Implement%20support%20for%20%60async%60%20functio.../near/224094185" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232434.20Implement.20support.20for.20.60async.60.20functio.2E.2E.2E.html#224094185">(Jan 26 2021 at 20:00)</a>:</h4>
<p>alexcrichton updated <a href="https://github.com/bytecodealliance/wasmtime/pull/2434">PR #2434</a> from <code>async</code> to <code>main</code>:</p>
<blockquote>
<p>This is an implementation of [RFC 2] in Wasmtime which is to support<br>
<code>async</code>-defined host functions. At a high level support is added by<br>
executing WebAssembly code that might invoke an asynchronous host<br>
function on a separate native stack. When the host function's future is<br>
not ready we switch back to the main native stack to continue execution.</p>
<p>There's a whole bunch of details in this commit, and it's a bit much to<br>
go over them all here in this commit message. The most important changes<br>
here are:</p>
<ul>
<li>
<p>A new <code>wasmtime-fiber</code> crate has been written to manage the low-level<br>
  details of stack-switching. Unixes use <code>mmap</code> to allocate a stack and<br>
  Windows uses the native fibers implementation. We'll surely want to<br>
  refactor this to move stack allocation elsewhere in the future. Fibers<br>
  are intended to be relatively general with a lot of type paremters to<br>
  fling values back and forth across suspension points. The whole crate<br>
  is a giant wad of <code>unsafe</code> unfortunately and involves handwritten<br>
  assembly with custom dwarf CFI directives to boot. Definitely deserves<br>
  a close eye in review!</p>
</li>
<li>
<p>The <code>Store</code> type has two new methods -- <code>block_on</code> and <code>on_fiber</code><br>
  which bridge between the async and non-async worlds. Lots of unsafe<br>
  fiddly bits here as we're trying to communicate context pointers<br>
  between disparate portions of the code. Extra eyes and care in review<br>
  is greatly appreciated.</p>
</li>
<li>
<p>The APIs for binding <code>async</code> functions are unfortunately pretty ugly<br>
  in <code>Func</code>. This is mostly due to language limitations and compiler<br>
  bugs (I believe) in Rust. Instead of <code>Func::wrap</code> we have a<br>
<code>Func::wrapN_async</code> family of methods, and we've also got a whole<br>
  bunch of <code>Func::getN_async</code> methods now too. It may be worth<br>
  rethinking the API of <code>Func</code> to try to make the documentation page<br>
  actually grok'able.</p>
</li>
</ul>
<p>This isn't super heavily tested but the various test should suffice for<br>
engaging hopefully nearly all the infrastructure in one form or another.<br>
This is just the start though!</p>
<p>[RFC 2]: <a href="https://github.com/bytecodealliance/rfcs/pull/2">https://github.com/bytecodealliance/rfcs/pull/2</a></p>
<p>&lt;!--</p>
<p>Please ensure that the following steps are all taken care of before submitting<br>
the PR.</p>
<ul>
<li>
<p>[ ] This has been discussed in issue #..., or if not, please tell us why<br>
  here.</p>
</li>
<li>
<p>[ ] A short description of what this does, why it is needed; if the<br>
  description becomes long, the matter should probably be discussed in an issue<br>
  first.</p>
</li>
<li>
<p>[ ] This PR contains test cases, if meaningful.</p>
</li>
<li>[ ] A reviewer from the core maintainer team has been assigned for this PR.<br>
  If you don't know who could review this, please indicate so. The list of<br>
  suggested reviewers on the right can help you.</li>
</ul>
<p>Please ensure all communication adheres to the <a href="https://github.com/bytecodealliance/wasmtime/blob/master/CODE_OF_CONDUCT.md">code of
conduct</a>.<br>
--&gt;<br>
</p>
</blockquote>



<a name="224493468"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232434%20Implement%20support%20for%20%60async%60%20functio.../near/224493468" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232434.20Implement.20support.20for.20.60async.60.20functio.2E.2E.2E.html#224493468">(Jan 29 2021 at 16:07)</a>:</h4>
<p>alexcrichton updated <a href="https://github.com/bytecodealliance/wasmtime/pull/2434">PR #2434</a> from <code>async</code> to <code>main</code>:</p>
<blockquote>
<p>This is an implementation of [RFC 2] in Wasmtime which is to support<br>
<code>async</code>-defined host functions. At a high level support is added by<br>
executing WebAssembly code that might invoke an asynchronous host<br>
function on a separate native stack. When the host function's future is<br>
not ready we switch back to the main native stack to continue execution.</p>
<p>There's a whole bunch of details in this commit, and it's a bit much to<br>
go over them all here in this commit message. The most important changes<br>
here are:</p>
<ul>
<li>
<p>A new <code>wasmtime-fiber</code> crate has been written to manage the low-level<br>
  details of stack-switching. Unixes use <code>mmap</code> to allocate a stack and<br>
  Windows uses the native fibers implementation. We'll surely want to<br>
  refactor this to move stack allocation elsewhere in the future. Fibers<br>
  are intended to be relatively general with a lot of type paremters to<br>
  fling values back and forth across suspension points. The whole crate<br>
  is a giant wad of <code>unsafe</code> unfortunately and involves handwritten<br>
  assembly with custom dwarf CFI directives to boot. Definitely deserves<br>
  a close eye in review!</p>
</li>
<li>
<p>The <code>Store</code> type has two new methods -- <code>block_on</code> and <code>on_fiber</code><br>
  which bridge between the async and non-async worlds. Lots of unsafe<br>
  fiddly bits here as we're trying to communicate context pointers<br>
  between disparate portions of the code. Extra eyes and care in review<br>
  is greatly appreciated.</p>
</li>
<li>
<p>The APIs for binding <code>async</code> functions are unfortunately pretty ugly<br>
  in <code>Func</code>. This is mostly due to language limitations and compiler<br>
  bugs (I believe) in Rust. Instead of <code>Func::wrap</code> we have a<br>
<code>Func::wrapN_async</code> family of methods, and we've also got a whole<br>
  bunch of <code>Func::getN_async</code> methods now too. It may be worth<br>
  rethinking the API of <code>Func</code> to try to make the documentation page<br>
  actually grok'able.</p>
</li>
</ul>
<p>This isn't super heavily tested but the various test should suffice for<br>
engaging hopefully nearly all the infrastructure in one form or another.<br>
This is just the start though!</p>
<p>[RFC 2]: <a href="https://github.com/bytecodealliance/rfcs/pull/2">https://github.com/bytecodealliance/rfcs/pull/2</a></p>
<p>&lt;!--</p>
<p>Please ensure that the following steps are all taken care of before submitting<br>
the PR.</p>
<ul>
<li>
<p>[ ] This has been discussed in issue #..., or if not, please tell us why<br>
  here.</p>
</li>
<li>
<p>[ ] A short description of what this does, why it is needed; if the<br>
  description becomes long, the matter should probably be discussed in an issue<br>
  first.</p>
</li>
<li>
<p>[ ] This PR contains test cases, if meaningful.</p>
</li>
<li>[ ] A reviewer from the core maintainer team has been assigned for this PR.<br>
  If you don't know who could review this, please indicate so. The list of<br>
  suggested reviewers on the right can help you.</li>
</ul>
<p>Please ensure all communication adheres to the <a href="https://github.com/bytecodealliance/wasmtime/blob/master/CODE_OF_CONDUCT.md">code of
conduct</a>.<br>
--&gt;<br>
</p>
</blockquote>



<a name="224499990"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232434%20Implement%20support%20for%20%60async%60%20functio.../near/224499990" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232434.20Implement.20support.20for.20.60async.60.20functio.2E.2E.2E.html#224499990">(Jan 29 2021 at 16:46)</a>:</h4>
<p>alexcrichton updated <a href="https://github.com/bytecodealliance/wasmtime/pull/2434">PR #2434</a> from <code>async</code> to <code>main</code>:</p>
<blockquote>
<p>This is an implementation of [RFC 2] in Wasmtime which is to support<br>
<code>async</code>-defined host functions. At a high level support is added by<br>
executing WebAssembly code that might invoke an asynchronous host<br>
function on a separate native stack. When the host function's future is<br>
not ready we switch back to the main native stack to continue execution.</p>
<p>There's a whole bunch of details in this commit, and it's a bit much to<br>
go over them all here in this commit message. The most important changes<br>
here are:</p>
<ul>
<li>
<p>A new <code>wasmtime-fiber</code> crate has been written to manage the low-level<br>
  details of stack-switching. Unixes use <code>mmap</code> to allocate a stack and<br>
  Windows uses the native fibers implementation. We'll surely want to<br>
  refactor this to move stack allocation elsewhere in the future. Fibers<br>
  are intended to be relatively general with a lot of type paremters to<br>
  fling values back and forth across suspension points. The whole crate<br>
  is a giant wad of <code>unsafe</code> unfortunately and involves handwritten<br>
  assembly with custom dwarf CFI directives to boot. Definitely deserves<br>
  a close eye in review!</p>
</li>
<li>
<p>The <code>Store</code> type has two new methods -- <code>block_on</code> and <code>on_fiber</code><br>
  which bridge between the async and non-async worlds. Lots of unsafe<br>
  fiddly bits here as we're trying to communicate context pointers<br>
  between disparate portions of the code. Extra eyes and care in review<br>
  is greatly appreciated.</p>
</li>
<li>
<p>The APIs for binding <code>async</code> functions are unfortunately pretty ugly<br>
  in <code>Func</code>. This is mostly due to language limitations and compiler<br>
  bugs (I believe) in Rust. Instead of <code>Func::wrap</code> we have a<br>
<code>Func::wrapN_async</code> family of methods, and we've also got a whole<br>
  bunch of <code>Func::getN_async</code> methods now too. It may be worth<br>
  rethinking the API of <code>Func</code> to try to make the documentation page<br>
  actually grok'able.</p>
</li>
</ul>
<p>This isn't super heavily tested but the various test should suffice for<br>
engaging hopefully nearly all the infrastructure in one form or another.<br>
This is just the start though!</p>
<p>[RFC 2]: <a href="https://github.com/bytecodealliance/rfcs/pull/2">https://github.com/bytecodealliance/rfcs/pull/2</a></p>
<p>&lt;!--</p>
<p>Please ensure that the following steps are all taken care of before submitting<br>
the PR.</p>
<ul>
<li>
<p>[ ] This has been discussed in issue #..., or if not, please tell us why<br>
  here.</p>
</li>
<li>
<p>[ ] A short description of what this does, why it is needed; if the<br>
  description becomes long, the matter should probably be discussed in an issue<br>
  first.</p>
</li>
<li>
<p>[ ] This PR contains test cases, if meaningful.</p>
</li>
<li>[ ] A reviewer from the core maintainer team has been assigned for this PR.<br>
  If you don't know who could review this, please indicate so. The list of<br>
  suggested reviewers on the right can help you.</li>
</ul>
<p>Please ensure all communication adheres to the <a href="https://github.com/bytecodealliance/wasmtime/blob/master/CODE_OF_CONDUCT.md">code of
conduct</a>.<br>
--&gt;<br>
</p>
</blockquote>



<a name="224510870"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232434%20Implement%20support%20for%20%60async%60%20functio.../near/224510870" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232434.20Implement.20support.20for.20.60async.60.20functio.2E.2E.2E.html#224510870">(Jan 29 2021 at 18:02)</a>:</h4>
<p>alexcrichton updated <a href="https://github.com/bytecodealliance/wasmtime/pull/2434">PR #2434</a> from <code>async</code> to <code>main</code>:</p>
<blockquote>
<p>This is an implementation of [RFC 2] in Wasmtime which is to support<br>
<code>async</code>-defined host functions. At a high level support is added by<br>
executing WebAssembly code that might invoke an asynchronous host<br>
function on a separate native stack. When the host function's future is<br>
not ready we switch back to the main native stack to continue execution.</p>
<p>There's a whole bunch of details in this commit, and it's a bit much to<br>
go over them all here in this commit message. The most important changes<br>
here are:</p>
<ul>
<li>
<p>A new <code>wasmtime-fiber</code> crate has been written to manage the low-level<br>
  details of stack-switching. Unixes use <code>mmap</code> to allocate a stack and<br>
  Windows uses the native fibers implementation. We'll surely want to<br>
  refactor this to move stack allocation elsewhere in the future. Fibers<br>
  are intended to be relatively general with a lot of type paremters to<br>
  fling values back and forth across suspension points. The whole crate<br>
  is a giant wad of <code>unsafe</code> unfortunately and involves handwritten<br>
  assembly with custom dwarf CFI directives to boot. Definitely deserves<br>
  a close eye in review!</p>
</li>
<li>
<p>The <code>Store</code> type has two new methods -- <code>block_on</code> and <code>on_fiber</code><br>
  which bridge between the async and non-async worlds. Lots of unsafe<br>
  fiddly bits here as we're trying to communicate context pointers<br>
  between disparate portions of the code. Extra eyes and care in review<br>
  is greatly appreciated.</p>
</li>
<li>
<p>The APIs for binding <code>async</code> functions are unfortunately pretty ugly<br>
  in <code>Func</code>. This is mostly due to language limitations and compiler<br>
  bugs (I believe) in Rust. Instead of <code>Func::wrap</code> we have a<br>
<code>Func::wrapN_async</code> family of methods, and we've also got a whole<br>
  bunch of <code>Func::getN_async</code> methods now too. It may be worth<br>
  rethinking the API of <code>Func</code> to try to make the documentation page<br>
  actually grok'able.</p>
</li>
</ul>
<p>This isn't super heavily tested but the various test should suffice for<br>
engaging hopefully nearly all the infrastructure in one form or another.<br>
This is just the start though!</p>
<p>[RFC 2]: <a href="https://github.com/bytecodealliance/rfcs/pull/2">https://github.com/bytecodealliance/rfcs/pull/2</a></p>
<p>&lt;!--</p>
<p>Please ensure that the following steps are all taken care of before submitting<br>
the PR.</p>
<ul>
<li>
<p>[ ] This has been discussed in issue #..., or if not, please tell us why<br>
  here.</p>
</li>
<li>
<p>[ ] A short description of what this does, why it is needed; if the<br>
  description becomes long, the matter should probably be discussed in an issue<br>
  first.</p>
</li>
<li>
<p>[ ] This PR contains test cases, if meaningful.</p>
</li>
<li>[ ] A reviewer from the core maintainer team has been assigned for this PR.<br>
  If you don't know who could review this, please indicate so. The list of<br>
  suggested reviewers on the right can help you.</li>
</ul>
<p>Please ensure all communication adheres to the <a href="https://github.com/bytecodealliance/wasmtime/blob/master/CODE_OF_CONDUCT.md">code of
conduct</a>.<br>
--&gt;<br>
</p>
</blockquote>



<a name="224510910"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232434%20Implement%20support%20for%20%60async%60%20functio.../near/224510910" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232434.20Implement.20support.20for.20.60async.60.20functio.2E.2E.2E.html#224510910">(Jan 29 2021 at 18:02)</a>:</h4>
<p>alexcrichton updated <a href="https://github.com/bytecodealliance/wasmtime/pull/2434">PR #2434</a> from <code>async</code> to <code>main</code>:</p>
<blockquote>
<p>This is an implementation of [RFC 2] in Wasmtime which is to support<br>
<code>async</code>-defined host functions. At a high level support is added by<br>
executing WebAssembly code that might invoke an asynchronous host<br>
function on a separate native stack. When the host function's future is<br>
not ready we switch back to the main native stack to continue execution.</p>
<p>There's a whole bunch of details in this commit, and it's a bit much to<br>
go over them all here in this commit message. The most important changes<br>
here are:</p>
<ul>
<li>
<p>A new <code>wasmtime-fiber</code> crate has been written to manage the low-level<br>
  details of stack-switching. Unixes use <code>mmap</code> to allocate a stack and<br>
  Windows uses the native fibers implementation. We'll surely want to<br>
  refactor this to move stack allocation elsewhere in the future. Fibers<br>
  are intended to be relatively general with a lot of type paremters to<br>
  fling values back and forth across suspension points. The whole crate<br>
  is a giant wad of <code>unsafe</code> unfortunately and involves handwritten<br>
  assembly with custom dwarf CFI directives to boot. Definitely deserves<br>
  a close eye in review!</p>
</li>
<li>
<p>The <code>Store</code> type has two new methods -- <code>block_on</code> and <code>on_fiber</code><br>
  which bridge between the async and non-async worlds. Lots of unsafe<br>
  fiddly bits here as we're trying to communicate context pointers<br>
  between disparate portions of the code. Extra eyes and care in review<br>
  is greatly appreciated.</p>
</li>
<li>
<p>The APIs for binding <code>async</code> functions are unfortunately pretty ugly<br>
  in <code>Func</code>. This is mostly due to language limitations and compiler<br>
  bugs (I believe) in Rust. Instead of <code>Func::wrap</code> we have a<br>
<code>Func::wrapN_async</code> family of methods, and we've also got a whole<br>
  bunch of <code>Func::getN_async</code> methods now too. It may be worth<br>
  rethinking the API of <code>Func</code> to try to make the documentation page<br>
  actually grok'able.</p>
</li>
</ul>
<p>This isn't super heavily tested but the various test should suffice for<br>
engaging hopefully nearly all the infrastructure in one form or another.<br>
This is just the start though!</p>
<p>[RFC 2]: <a href="https://github.com/bytecodealliance/rfcs/pull/2">https://github.com/bytecodealliance/rfcs/pull/2</a></p>
<p>&lt;!--</p>
<p>Please ensure that the following steps are all taken care of before submitting<br>
the PR.</p>
<ul>
<li>
<p>[ ] This has been discussed in issue #..., or if not, please tell us why<br>
  here.</p>
</li>
<li>
<p>[ ] A short description of what this does, why it is needed; if the<br>
  description becomes long, the matter should probably be discussed in an issue<br>
  first.</p>
</li>
<li>
<p>[ ] This PR contains test cases, if meaningful.</p>
</li>
<li>[ ] A reviewer from the core maintainer team has been assigned for this PR.<br>
  If you don't know who could review this, please indicate so. The list of<br>
  suggested reviewers on the right can help you.</li>
</ul>
<p>Please ensure all communication adheres to the <a href="https://github.com/bytecodealliance/wasmtime/blob/master/CODE_OF_CONDUCT.md">code of
conduct</a>.<br>
--&gt;<br>
</p>
</blockquote>



<a name="224783456"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232434%20Implement%20support%20for%20%60async%60%20functio.../near/224783456" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232434.20Implement.20support.20for.20.60async.60.20functio.2E.2E.2E.html#224783456">(Feb 01 2021 at 20:08)</a>:</h4>
<p>alexcrichton updated <a href="https://github.com/bytecodealliance/wasmtime/pull/2434">PR #2434</a> from <code>async</code> to <code>main</code>:</p>
<blockquote>
<p>This is an implementation of [RFC 2] in Wasmtime which is to support<br>
<code>async</code>-defined host functions. At a high level support is added by<br>
executing WebAssembly code that might invoke an asynchronous host<br>
function on a separate native stack. When the host function's future is<br>
not ready we switch back to the main native stack to continue execution.</p>
<p>There's a whole bunch of details in this commit, and it's a bit much to<br>
go over them all here in this commit message. The most important changes<br>
here are:</p>
<ul>
<li>
<p>A new <code>wasmtime-fiber</code> crate has been written to manage the low-level<br>
  details of stack-switching. Unixes use <code>mmap</code> to allocate a stack and<br>
  Windows uses the native fibers implementation. We'll surely want to<br>
  refactor this to move stack allocation elsewhere in the future. Fibers<br>
  are intended to be relatively general with a lot of type paremters to<br>
  fling values back and forth across suspension points. The whole crate<br>
  is a giant wad of <code>unsafe</code> unfortunately and involves handwritten<br>
  assembly with custom dwarf CFI directives to boot. Definitely deserves<br>
  a close eye in review!</p>
</li>
<li>
<p>The <code>Store</code> type has two new methods -- <code>block_on</code> and <code>on_fiber</code><br>
  which bridge between the async and non-async worlds. Lots of unsafe<br>
  fiddly bits here as we're trying to communicate context pointers<br>
  between disparate portions of the code. Extra eyes and care in review<br>
  is greatly appreciated.</p>
</li>
<li>
<p>The APIs for binding <code>async</code> functions are unfortunately pretty ugly<br>
  in <code>Func</code>. This is mostly due to language limitations and compiler<br>
  bugs (I believe) in Rust. Instead of <code>Func::wrap</code> we have a<br>
<code>Func::wrapN_async</code> family of methods, and we've also got a whole<br>
  bunch of <code>Func::getN_async</code> methods now too. It may be worth<br>
  rethinking the API of <code>Func</code> to try to make the documentation page<br>
  actually grok'able.</p>
</li>
</ul>
<p>This isn't super heavily tested but the various test should suffice for<br>
engaging hopefully nearly all the infrastructure in one form or another.<br>
This is just the start though!</p>
<p>[RFC 2]: <a href="https://github.com/bytecodealliance/rfcs/pull/2">https://github.com/bytecodealliance/rfcs/pull/2</a></p>
<p>&lt;!--</p>
<p>Please ensure that the following steps are all taken care of before submitting<br>
the PR.</p>
<ul>
<li>
<p>[ ] This has been discussed in issue #..., or if not, please tell us why<br>
  here.</p>
</li>
<li>
<p>[ ] A short description of what this does, why it is needed; if the<br>
  description becomes long, the matter should probably be discussed in an issue<br>
  first.</p>
</li>
<li>
<p>[ ] This PR contains test cases, if meaningful.</p>
</li>
<li>[ ] A reviewer from the core maintainer team has been assigned for this PR.<br>
  If you don't know who could review this, please indicate so. The list of<br>
  suggested reviewers on the right can help you.</li>
</ul>
<p>Please ensure all communication adheres to the <a href="https://github.com/bytecodealliance/wasmtime/blob/master/CODE_OF_CONDUCT.md">code of
conduct</a>.<br>
--&gt;<br>
</p>
</blockquote>



<a name="224791500"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232434%20Implement%20support%20for%20%60async%60%20functio.../near/224791500" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232434.20Implement.20support.20for.20.60async.60.20functio.2E.2E.2E.html#224791500">(Feb 01 2021 at 21:10)</a>:</h4>
<p>alexcrichton updated <a href="https://github.com/bytecodealliance/wasmtime/pull/2434">PR #2434</a> from <code>async</code> to <code>main</code>:</p>
<blockquote>
<p>This is an implementation of [RFC 2] in Wasmtime which is to support<br>
<code>async</code>-defined host functions. At a high level support is added by<br>
executing WebAssembly code that might invoke an asynchronous host<br>
function on a separate native stack. When the host function's future is<br>
not ready we switch back to the main native stack to continue execution.</p>
<p>There's a whole bunch of details in this commit, and it's a bit much to<br>
go over them all here in this commit message. The most important changes<br>
here are:</p>
<ul>
<li>
<p>A new <code>wasmtime-fiber</code> crate has been written to manage the low-level<br>
  details of stack-switching. Unixes use <code>mmap</code> to allocate a stack and<br>
  Windows uses the native fibers implementation. We'll surely want to<br>
  refactor this to move stack allocation elsewhere in the future. Fibers<br>
  are intended to be relatively general with a lot of type paremters to<br>
  fling values back and forth across suspension points. The whole crate<br>
  is a giant wad of <code>unsafe</code> unfortunately and involves handwritten<br>
  assembly with custom dwarf CFI directives to boot. Definitely deserves<br>
  a close eye in review!</p>
</li>
<li>
<p>The <code>Store</code> type has two new methods -- <code>block_on</code> and <code>on_fiber</code><br>
  which bridge between the async and non-async worlds. Lots of unsafe<br>
  fiddly bits here as we're trying to communicate context pointers<br>
  between disparate portions of the code. Extra eyes and care in review<br>
  is greatly appreciated.</p>
</li>
<li>
<p>The APIs for binding <code>async</code> functions are unfortunately pretty ugly<br>
  in <code>Func</code>. This is mostly due to language limitations and compiler<br>
  bugs (I believe) in Rust. Instead of <code>Func::wrap</code> we have a<br>
<code>Func::wrapN_async</code> family of methods, and we've also got a whole<br>
  bunch of <code>Func::getN_async</code> methods now too. It may be worth<br>
  rethinking the API of <code>Func</code> to try to make the documentation page<br>
  actually grok'able.</p>
</li>
</ul>
<p>This isn't super heavily tested but the various test should suffice for<br>
engaging hopefully nearly all the infrastructure in one form or another.<br>
This is just the start though!</p>
<p>[RFC 2]: <a href="https://github.com/bytecodealliance/rfcs/pull/2">https://github.com/bytecodealliance/rfcs/pull/2</a></p>
<p>&lt;!--</p>
<p>Please ensure that the following steps are all taken care of before submitting<br>
the PR.</p>
<ul>
<li>
<p>[ ] This has been discussed in issue #..., or if not, please tell us why<br>
  here.</p>
</li>
<li>
<p>[ ] A short description of what this does, why it is needed; if the<br>
  description becomes long, the matter should probably be discussed in an issue<br>
  first.</p>
</li>
<li>
<p>[ ] This PR contains test cases, if meaningful.</p>
</li>
<li>[ ] A reviewer from the core maintainer team has been assigned for this PR.<br>
  If you don't know who could review this, please indicate so. The list of<br>
  suggested reviewers on the right can help you.</li>
</ul>
<p>Please ensure all communication adheres to the <a href="https://github.com/bytecodealliance/wasmtime/blob/master/CODE_OF_CONDUCT.md">code of
conduct</a>.<br>
--&gt;<br>
</p>
</blockquote>



<a name="224809433"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232434%20Implement%20support%20for%20%60async%60%20functio.../near/224809433" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232434.20Implement.20support.20for.20.60async.60.20functio.2E.2E.2E.html#224809433">(Feb 01 2021 at 23:36)</a>:</h4>
<p>alexcrichton updated <a href="https://github.com/bytecodealliance/wasmtime/pull/2434">PR #2434</a> from <code>async</code> to <code>main</code>:</p>
<blockquote>
<p>This is an implementation of [RFC 2] in Wasmtime which is to support<br>
<code>async</code>-defined host functions. At a high level support is added by<br>
executing WebAssembly code that might invoke an asynchronous host<br>
function on a separate native stack. When the host function's future is<br>
not ready we switch back to the main native stack to continue execution.</p>
<p>There's a whole bunch of details in this commit, and it's a bit much to<br>
go over them all here in this commit message. The most important changes<br>
here are:</p>
<ul>
<li>
<p>A new <code>wasmtime-fiber</code> crate has been written to manage the low-level<br>
  details of stack-switching. Unixes use <code>mmap</code> to allocate a stack and<br>
  Windows uses the native fibers implementation. We'll surely want to<br>
  refactor this to move stack allocation elsewhere in the future. Fibers<br>
  are intended to be relatively general with a lot of type paremters to<br>
  fling values back and forth across suspension points. The whole crate<br>
  is a giant wad of <code>unsafe</code> unfortunately and involves handwritten<br>
  assembly with custom dwarf CFI directives to boot. Definitely deserves<br>
  a close eye in review!</p>
</li>
<li>
<p>The <code>Store</code> type has two new methods -- <code>block_on</code> and <code>on_fiber</code><br>
  which bridge between the async and non-async worlds. Lots of unsafe<br>
  fiddly bits here as we're trying to communicate context pointers<br>
  between disparate portions of the code. Extra eyes and care in review<br>
  is greatly appreciated.</p>
</li>
<li>
<p>The APIs for binding <code>async</code> functions are unfortunately pretty ugly<br>
  in <code>Func</code>. This is mostly due to language limitations and compiler<br>
  bugs (I believe) in Rust. Instead of <code>Func::wrap</code> we have a<br>
<code>Func::wrapN_async</code> family of methods, and we've also got a whole<br>
  bunch of <code>Func::getN_async</code> methods now too. It may be worth<br>
  rethinking the API of <code>Func</code> to try to make the documentation page<br>
  actually grok'able.</p>
</li>
</ul>
<p>This isn't super heavily tested but the various test should suffice for<br>
engaging hopefully nearly all the infrastructure in one form or another.<br>
This is just the start though!</p>
<p>[RFC 2]: <a href="https://github.com/bytecodealliance/rfcs/pull/2">https://github.com/bytecodealliance/rfcs/pull/2</a></p>
<p>&lt;!--</p>
<p>Please ensure that the following steps are all taken care of before submitting<br>
the PR.</p>
<ul>
<li>
<p>[ ] This has been discussed in issue #..., or if not, please tell us why<br>
  here.</p>
</li>
<li>
<p>[ ] A short description of what this does, why it is needed; if the<br>
  description becomes long, the matter should probably be discussed in an issue<br>
  first.</p>
</li>
<li>
<p>[ ] This PR contains test cases, if meaningful.</p>
</li>
<li>[ ] A reviewer from the core maintainer team has been assigned for this PR.<br>
  If you don't know who could review this, please indicate so. The list of<br>
  suggested reviewers on the right can help you.</li>
</ul>
<p>Please ensure all communication adheres to the <a href="https://github.com/bytecodealliance/wasmtime/blob/master/CODE_OF_CONDUCT.md">code of
conduct</a>.<br>
--&gt;<br>
</p>
</blockquote>



<a name="224922223"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232434%20Implement%20support%20for%20%60async%60%20functio.../near/224922223" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232434.20Implement.20support.20for.20.60async.60.20functio.2E.2E.2E.html#224922223">(Feb 02 2021 at 19:21)</a>:</h4>
<p>alexcrichton updated <a href="https://github.com/bytecodealliance/wasmtime/pull/2434">PR #2434</a> from <code>async</code> to <code>main</code>:</p>
<blockquote>
<p>This is an implementation of [RFC 2] in Wasmtime which is to support<br>
<code>async</code>-defined host functions. At a high level support is added by<br>
executing WebAssembly code that might invoke an asynchronous host<br>
function on a separate native stack. When the host function's future is<br>
not ready we switch back to the main native stack to continue execution.</p>
<p>There's a whole bunch of details in this commit, and it's a bit much to<br>
go over them all here in this commit message. The most important changes<br>
here are:</p>
<ul>
<li>
<p>A new <code>wasmtime-fiber</code> crate has been written to manage the low-level<br>
  details of stack-switching. Unixes use <code>mmap</code> to allocate a stack and<br>
  Windows uses the native fibers implementation. We'll surely want to<br>
  refactor this to move stack allocation elsewhere in the future. Fibers<br>
  are intended to be relatively general with a lot of type paremters to<br>
  fling values back and forth across suspension points. The whole crate<br>
  is a giant wad of <code>unsafe</code> unfortunately and involves handwritten<br>
  assembly with custom dwarf CFI directives to boot. Definitely deserves<br>
  a close eye in review!</p>
</li>
<li>
<p>The <code>Store</code> type has two new methods -- <code>block_on</code> and <code>on_fiber</code><br>
  which bridge between the async and non-async worlds. Lots of unsafe<br>
  fiddly bits here as we're trying to communicate context pointers<br>
  between disparate portions of the code. Extra eyes and care in review<br>
  is greatly appreciated.</p>
</li>
<li>
<p>The APIs for binding <code>async</code> functions are unfortunately pretty ugly<br>
  in <code>Func</code>. This is mostly due to language limitations and compiler<br>
  bugs (I believe) in Rust. Instead of <code>Func::wrap</code> we have a<br>
<code>Func::wrapN_async</code> family of methods, and we've also got a whole<br>
  bunch of <code>Func::getN_async</code> methods now too. It may be worth<br>
  rethinking the API of <code>Func</code> to try to make the documentation page<br>
  actually grok'able.</p>
</li>
</ul>
<p>This isn't super heavily tested but the various test should suffice for<br>
engaging hopefully nearly all the infrastructure in one form or another.<br>
This is just the start though!</p>
<p>[RFC 2]: <a href="https://github.com/bytecodealliance/rfcs/pull/2">https://github.com/bytecodealliance/rfcs/pull/2</a></p>
<p>&lt;!--</p>
<p>Please ensure that the following steps are all taken care of before submitting<br>
the PR.</p>
<ul>
<li>
<p>[ ] This has been discussed in issue #..., or if not, please tell us why<br>
  here.</p>
</li>
<li>
<p>[ ] A short description of what this does, why it is needed; if the<br>
  description becomes long, the matter should probably be discussed in an issue<br>
  first.</p>
</li>
<li>
<p>[ ] This PR contains test cases, if meaningful.</p>
</li>
<li>[ ] A reviewer from the core maintainer team has been assigned for this PR.<br>
  If you don't know who could review this, please indicate so. The list of<br>
  suggested reviewers on the right can help you.</li>
</ul>
<p>Please ensure all communication adheres to the <a href="https://github.com/bytecodealliance/wasmtime/blob/master/CODE_OF_CONDUCT.md">code of
conduct</a>.<br>
--&gt;<br>
</p>
</blockquote>



<a name="225111822"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232434%20Implement%20support%20for%20%60async%60%20functio.../near/225111822" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232434.20Implement.20support.20for.20.60async.60.20functio.2E.2E.2E.html#225111822">(Feb 04 2021 at 02:24)</a>:</h4>
<p>peterhuene submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/2434#pullrequestreview-582982523">PR Review</a>.</p>



<a name="225111823"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232434%20Implement%20support%20for%20%60async%60%20functio.../near/225111823" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232434.20Implement.20support.20for.20.60async.60.20functio.2E.2E.2E.html#225111823">(Feb 04 2021 at 02:24)</a>:</h4>
<p>peterhuene created <a href="https://github.com/bytecodealliance/wasmtime/pull/2434#discussion_r569896886">PR Review Comment</a>:</p>
<blockquote>
<p>So I think <code>CreateFiberEx</code> should probably be used here as we probably want <code>stack_size</code> to be the reserve size and not the commit size on Windows.</p>
<p><code>CreateFiber</code>'s <code>dwStackSize</code> parameter is the commit size and 1 MiB is typically used for the reserve size (it's from the PE header, but 1 MiB is what Microsoft's linker uses).</p>
<p>If <code>dwStackSize</code> is larger than the default reserve size, then it reserves <code>dwStackSize</code> rounded up 1 MiB as the reserve size.</p>
<p>With <code>CreateFiberEx</code>, there are two parameters: <code>dwStackCommitSize</code> and <code>dwStackReserveSize</code>. The former we'll want to pass 0 to get the default commit size (which will be 1 page in size, I believe).</p>
<p>So suggested change:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="w"> </span><span class="kd">let</span><span class="w"> </span><span class="n">fiber</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">CreateFiberEx</span><span class="p">(</span><span class="w"></span>
<span class="w">    </span><span class="mi">0</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="n">stack_size</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="c1">// FIBER_FLAG_FLOAT_SWITCH (might not be in the winapi crate)</span>
<span class="w">    </span><span class="nb">Some</span><span class="p">(</span><span class="n">fiber_start</span>::<span class="o">&lt;</span><span class="n">F</span><span class="p">,</span><span class="w"> </span><span class="n">A</span><span class="p">,</span><span class="w"> </span><span class="n">B</span><span class="p">,</span><span class="w"> </span><span class="n">C</span><span class="o">&gt;</span><span class="p">),</span><span class="w"></span>
<span class="w">    </span><span class="o">&amp;*</span><span class="n">state</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="o">*</span><span class="k">const</span><span class="w"> </span><span class="n">StartState</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="o">*</span><span class="k">mut</span><span class="w"> </span><span class="n">_</span><span class="p">,</span><span class="w"></span>
<span class="p">);</span><span class="w"></span>
</code></pre></div>
<p>This should help prevent the fiber stacks from counting towards the commit limit upfront.</p>
</blockquote>



<a name="225111835"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232434%20Implement%20support%20for%20%60async%60%20functio.../near/225111835" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232434.20Implement.20support.20for.20.60async.60.20functio.2E.2E.2E.html#225111835">(Feb 04 2021 at 02:25)</a>:</h4>
<p>peterhuene edited <a href="https://github.com/bytecodealliance/wasmtime/pull/2434#discussion_r569896886">PR Review Comment</a>.</p>



<a name="225172725"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232434%20Implement%20support%20for%20%60async%60%20functio.../near/225172725" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232434.20Implement.20support.20for.20.60async.60.20functio.2E.2E.2E.html#225172725">(Feb 04 2021 at 15:16)</a>:</h4>
<p>alexcrichton updated <a href="https://github.com/bytecodealliance/wasmtime/pull/2434">PR #2434</a> from <code>async</code> to <code>main</code>:</p>
<blockquote>
<p>This is an implementation of [RFC 2] in Wasmtime which is to support<br>
<code>async</code>-defined host functions. At a high level support is added by<br>
executing WebAssembly code that might invoke an asynchronous host<br>
function on a separate native stack. When the host function's future is<br>
not ready we switch back to the main native stack to continue execution.</p>
<p>There's a whole bunch of details in this commit, and it's a bit much to<br>
go over them all here in this commit message. The most important changes<br>
here are:</p>
<ul>
<li>
<p>A new <code>wasmtime-fiber</code> crate has been written to manage the low-level<br>
  details of stack-switching. Unixes use <code>mmap</code> to allocate a stack and<br>
  Windows uses the native fibers implementation. We'll surely want to<br>
  refactor this to move stack allocation elsewhere in the future. Fibers<br>
  are intended to be relatively general with a lot of type paremters to<br>
  fling values back and forth across suspension points. The whole crate<br>
  is a giant wad of <code>unsafe</code> unfortunately and involves handwritten<br>
  assembly with custom dwarf CFI directives to boot. Definitely deserves<br>
  a close eye in review!</p>
</li>
<li>
<p>The <code>Store</code> type has two new methods -- <code>block_on</code> and <code>on_fiber</code><br>
  which bridge between the async and non-async worlds. Lots of unsafe<br>
  fiddly bits here as we're trying to communicate context pointers<br>
  between disparate portions of the code. Extra eyes and care in review<br>
  is greatly appreciated.</p>
</li>
<li>
<p>The APIs for binding <code>async</code> functions are unfortunately pretty ugly<br>
  in <code>Func</code>. This is mostly due to language limitations and compiler<br>
  bugs (I believe) in Rust. Instead of <code>Func::wrap</code> we have a<br>
<code>Func::wrapN_async</code> family of methods, and we've also got a whole<br>
  bunch of <code>Func::getN_async</code> methods now too. It may be worth<br>
  rethinking the API of <code>Func</code> to try to make the documentation page<br>
  actually grok'able.</p>
</li>
</ul>
<p>This isn't super heavily tested but the various test should suffice for<br>
engaging hopefully nearly all the infrastructure in one form or another.<br>
This is just the start though!</p>
<p>[RFC 2]: <a href="https://github.com/bytecodealliance/rfcs/pull/2">https://github.com/bytecodealliance/rfcs/pull/2</a></p>
<p>&lt;!--</p>
<p>Please ensure that the following steps are all taken care of before submitting<br>
the PR.</p>
<ul>
<li>
<p>[ ] This has been discussed in issue #..., or if not, please tell us why<br>
  here.</p>
</li>
<li>
<p>[ ] A short description of what this does, why it is needed; if the<br>
  description becomes long, the matter should probably be discussed in an issue<br>
  first.</p>
</li>
<li>
<p>[ ] This PR contains test cases, if meaningful.</p>
</li>
<li>[ ] A reviewer from the core maintainer team has been assigned for this PR.<br>
  If you don't know who could review this, please indicate so. The list of<br>
  suggested reviewers on the right can help you.</li>
</ul>
<p>Please ensure all communication adheres to the <a href="https://github.com/bytecodealliance/wasmtime/blob/master/CODE_OF_CONDUCT.md">code of
conduct</a>.<br>
--&gt;<br>
</p>
</blockquote>



<a name="225178941"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232434%20Implement%20support%20for%20%60async%60%20functio.../near/225178941" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232434.20Implement.20support.20for.20.60async.60.20functio.2E.2E.2E.html#225178941">(Feb 04 2021 at 15:58)</a>:</h4>
<p>alexcrichton updated <a href="https://github.com/bytecodealliance/wasmtime/pull/2434">PR #2434</a> from <code>async</code> to <code>main</code>:</p>
<blockquote>
<p>This is an implementation of [RFC 2] in Wasmtime which is to support<br>
<code>async</code>-defined host functions. At a high level support is added by<br>
executing WebAssembly code that might invoke an asynchronous host<br>
function on a separate native stack. When the host function's future is<br>
not ready we switch back to the main native stack to continue execution.</p>
<p>There's a whole bunch of details in this commit, and it's a bit much to<br>
go over them all here in this commit message. The most important changes<br>
here are:</p>
<ul>
<li>
<p>A new <code>wasmtime-fiber</code> crate has been written to manage the low-level<br>
  details of stack-switching. Unixes use <code>mmap</code> to allocate a stack and<br>
  Windows uses the native fibers implementation. We'll surely want to<br>
  refactor this to move stack allocation elsewhere in the future. Fibers<br>
  are intended to be relatively general with a lot of type paremters to<br>
  fling values back and forth across suspension points. The whole crate<br>
  is a giant wad of <code>unsafe</code> unfortunately and involves handwritten<br>
  assembly with custom dwarf CFI directives to boot. Definitely deserves<br>
  a close eye in review!</p>
</li>
<li>
<p>The <code>Store</code> type has two new methods -- <code>block_on</code> and <code>on_fiber</code><br>
  which bridge between the async and non-async worlds. Lots of unsafe<br>
  fiddly bits here as we're trying to communicate context pointers<br>
  between disparate portions of the code. Extra eyes and care in review<br>
  is greatly appreciated.</p>
</li>
<li>
<p>The APIs for binding <code>async</code> functions are unfortunately pretty ugly<br>
  in <code>Func</code>. This is mostly due to language limitations and compiler<br>
  bugs (I believe) in Rust. Instead of <code>Func::wrap</code> we have a<br>
<code>Func::wrapN_async</code> family of methods, and we've also got a whole<br>
  bunch of <code>Func::getN_async</code> methods now too. It may be worth<br>
  rethinking the API of <code>Func</code> to try to make the documentation page<br>
  actually grok'able.</p>
</li>
</ul>
<p>This isn't super heavily tested but the various test should suffice for<br>
engaging hopefully nearly all the infrastructure in one form or another.<br>
This is just the start though!</p>
<p>[RFC 2]: <a href="https://github.com/bytecodealliance/rfcs/pull/2">https://github.com/bytecodealliance/rfcs/pull/2</a></p>
<p>&lt;!--</p>
<p>Please ensure that the following steps are all taken care of before submitting<br>
the PR.</p>
<ul>
<li>
<p>[ ] This has been discussed in issue #..., or if not, please tell us why<br>
  here.</p>
</li>
<li>
<p>[ ] A short description of what this does, why it is needed; if the<br>
  description becomes long, the matter should probably be discussed in an issue<br>
  first.</p>
</li>
<li>
<p>[ ] This PR contains test cases, if meaningful.</p>
</li>
<li>[ ] A reviewer from the core maintainer team has been assigned for this PR.<br>
  If you don't know who could review this, please indicate so. The list of<br>
  suggested reviewers on the right can help you.</li>
</ul>
<p>Please ensure all communication adheres to the <a href="https://github.com/bytecodealliance/wasmtime/blob/master/CODE_OF_CONDUCT.md">code of
conduct</a>.<br>
--&gt;<br>
</p>
</blockquote>



<a name="225179234"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232434%20Implement%20support%20for%20%60async%60%20functio.../near/225179234" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232434.20Implement.20support.20for.20.60async.60.20functio.2E.2E.2E.html#225179234">(Feb 04 2021 at 16:00)</a>:</h4>
<p>alexcrichton updated <a href="https://github.com/bytecodealliance/wasmtime/pull/2434">PR #2434</a> from <code>async</code> to <code>main</code>:</p>
<blockquote>
<p>This is an implementation of [RFC 2] in Wasmtime which is to support<br>
<code>async</code>-defined host functions. At a high level support is added by<br>
executing WebAssembly code that might invoke an asynchronous host<br>
function on a separate native stack. When the host function's future is<br>
not ready we switch back to the main native stack to continue execution.</p>
<p>There's a whole bunch of details in this commit, and it's a bit much to<br>
go over them all here in this commit message. The most important changes<br>
here are:</p>
<ul>
<li>
<p>A new <code>wasmtime-fiber</code> crate has been written to manage the low-level<br>
  details of stack-switching. Unixes use <code>mmap</code> to allocate a stack and<br>
  Windows uses the native fibers implementation. We'll surely want to<br>
  refactor this to move stack allocation elsewhere in the future. Fibers<br>
  are intended to be relatively general with a lot of type paremters to<br>
  fling values back and forth across suspension points. The whole crate<br>
  is a giant wad of <code>unsafe</code> unfortunately and involves handwritten<br>
  assembly with custom dwarf CFI directives to boot. Definitely deserves<br>
  a close eye in review!</p>
</li>
<li>
<p>The <code>Store</code> type has two new methods -- <code>block_on</code> and <code>on_fiber</code><br>
  which bridge between the async and non-async worlds. Lots of unsafe<br>
  fiddly bits here as we're trying to communicate context pointers<br>
  between disparate portions of the code. Extra eyes and care in review<br>
  is greatly appreciated.</p>
</li>
<li>
<p>The APIs for binding <code>async</code> functions are unfortunately pretty ugly<br>
  in <code>Func</code>. This is mostly due to language limitations and compiler<br>
  bugs (I believe) in Rust. Instead of <code>Func::wrap</code> we have a<br>
<code>Func::wrapN_async</code> family of methods, and we've also got a whole<br>
  bunch of <code>Func::getN_async</code> methods now too. It may be worth<br>
  rethinking the API of <code>Func</code> to try to make the documentation page<br>
  actually grok'able.</p>
</li>
</ul>
<p>This isn't super heavily tested but the various test should suffice for<br>
engaging hopefully nearly all the infrastructure in one form or another.<br>
This is just the start though!</p>
<p>[RFC 2]: <a href="https://github.com/bytecodealliance/rfcs/pull/2">https://github.com/bytecodealliance/rfcs/pull/2</a></p>
<p>&lt;!--</p>
<p>Please ensure that the following steps are all taken care of before submitting<br>
the PR.</p>
<ul>
<li>
<p>[ ] This has been discussed in issue #..., or if not, please tell us why<br>
  here.</p>
</li>
<li>
<p>[ ] A short description of what this does, why it is needed; if the<br>
  description becomes long, the matter should probably be discussed in an issue<br>
  first.</p>
</li>
<li>
<p>[ ] This PR contains test cases, if meaningful.</p>
</li>
<li>[ ] A reviewer from the core maintainer team has been assigned for this PR.<br>
  If you don't know who could review this, please indicate so. The list of<br>
  suggested reviewers on the right can help you.</li>
</ul>
<p>Please ensure all communication adheres to the <a href="https://github.com/bytecodealliance/wasmtime/blob/master/CODE_OF_CONDUCT.md">code of
conduct</a>.<br>
--&gt;<br>
</p>
</blockquote>



<a name="225206988"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232434%20Implement%20support%20for%20%60async%60%20functio.../near/225206988" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232434.20Implement.20support.20for.20.60async.60.20functio.2E.2E.2E.html#225206988">(Feb 04 2021 at 19:08)</a>:</h4>
<p>alexcrichton updated <a href="https://github.com/bytecodealliance/wasmtime/pull/2434">PR #2434</a> from <code>async</code> to <code>main</code>:</p>
<blockquote>
<p>This is an implementation of [RFC 2] in Wasmtime which is to support<br>
<code>async</code>-defined host functions. At a high level support is added by<br>
executing WebAssembly code that might invoke an asynchronous host<br>
function on a separate native stack. When the host function's future is<br>
not ready we switch back to the main native stack to continue execution.</p>
<p>There's a whole bunch of details in this commit, and it's a bit much to<br>
go over them all here in this commit message. The most important changes<br>
here are:</p>
<ul>
<li>
<p>A new <code>wasmtime-fiber</code> crate has been written to manage the low-level<br>
  details of stack-switching. Unixes use <code>mmap</code> to allocate a stack and<br>
  Windows uses the native fibers implementation. We'll surely want to<br>
  refactor this to move stack allocation elsewhere in the future. Fibers<br>
  are intended to be relatively general with a lot of type paremters to<br>
  fling values back and forth across suspension points. The whole crate<br>
  is a giant wad of <code>unsafe</code> unfortunately and involves handwritten<br>
  assembly with custom dwarf CFI directives to boot. Definitely deserves<br>
  a close eye in review!</p>
</li>
<li>
<p>The <code>Store</code> type has two new methods -- <code>block_on</code> and <code>on_fiber</code><br>
  which bridge between the async and non-async worlds. Lots of unsafe<br>
  fiddly bits here as we're trying to communicate context pointers<br>
  between disparate portions of the code. Extra eyes and care in review<br>
  is greatly appreciated.</p>
</li>
<li>
<p>The APIs for binding <code>async</code> functions are unfortunately pretty ugly<br>
  in <code>Func</code>. This is mostly due to language limitations and compiler<br>
  bugs (I believe) in Rust. Instead of <code>Func::wrap</code> we have a<br>
<code>Func::wrapN_async</code> family of methods, and we've also got a whole<br>
  bunch of <code>Func::getN_async</code> methods now too. It may be worth<br>
  rethinking the API of <code>Func</code> to try to make the documentation page<br>
  actually grok'able.</p>
</li>
</ul>
<p>This isn't super heavily tested but the various test should suffice for<br>
engaging hopefully nearly all the infrastructure in one form or another.<br>
This is just the start though!</p>
<p>[RFC 2]: <a href="https://github.com/bytecodealliance/rfcs/pull/2">https://github.com/bytecodealliance/rfcs/pull/2</a></p>
<p>&lt;!--</p>
<p>Please ensure that the following steps are all taken care of before submitting<br>
the PR.</p>
<ul>
<li>
<p>[ ] This has been discussed in issue #..., or if not, please tell us why<br>
  here.</p>
</li>
<li>
<p>[ ] A short description of what this does, why it is needed; if the<br>
  description becomes long, the matter should probably be discussed in an issue<br>
  first.</p>
</li>
<li>
<p>[ ] This PR contains test cases, if meaningful.</p>
</li>
<li>[ ] A reviewer from the core maintainer team has been assigned for this PR.<br>
  If you don't know who could review this, please indicate so. The list of<br>
  suggested reviewers on the right can help you.</li>
</ul>
<p>Please ensure all communication adheres to the <a href="https://github.com/bytecodealliance/wasmtime/blob/master/CODE_OF_CONDUCT.md">code of
conduct</a>.<br>
--&gt;<br>
</p>
</blockquote>



<a name="225209540"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232434%20Implement%20support%20for%20%60async%60%20functio.../near/225209540" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232434.20Implement.20support.20for.20.60async.60.20functio.2E.2E.2E.html#225209540">(Feb 04 2021 at 19:27)</a>:</h4>
<p>alexcrichton updated <a href="https://github.com/bytecodealliance/wasmtime/pull/2434">PR #2434</a> from <code>async</code> to <code>main</code>:</p>
<blockquote>
<p>This is an implementation of [RFC 2] in Wasmtime which is to support<br>
<code>async</code>-defined host functions. At a high level support is added by<br>
executing WebAssembly code that might invoke an asynchronous host<br>
function on a separate native stack. When the host function's future is<br>
not ready we switch back to the main native stack to continue execution.</p>
<p>There's a whole bunch of details in this commit, and it's a bit much to<br>
go over them all here in this commit message. The most important changes<br>
here are:</p>
<ul>
<li>
<p>A new <code>wasmtime-fiber</code> crate has been written to manage the low-level<br>
  details of stack-switching. Unixes use <code>mmap</code> to allocate a stack and<br>
  Windows uses the native fibers implementation. We'll surely want to<br>
  refactor this to move stack allocation elsewhere in the future. Fibers<br>
  are intended to be relatively general with a lot of type paremters to<br>
  fling values back and forth across suspension points. The whole crate<br>
  is a giant wad of <code>unsafe</code> unfortunately and involves handwritten<br>
  assembly with custom dwarf CFI directives to boot. Definitely deserves<br>
  a close eye in review!</p>
</li>
<li>
<p>The <code>Store</code> type has two new methods -- <code>block_on</code> and <code>on_fiber</code><br>
  which bridge between the async and non-async worlds. Lots of unsafe<br>
  fiddly bits here as we're trying to communicate context pointers<br>
  between disparate portions of the code. Extra eyes and care in review<br>
  is greatly appreciated.</p>
</li>
<li>
<p>The APIs for binding <code>async</code> functions are unfortunately pretty ugly<br>
  in <code>Func</code>. This is mostly due to language limitations and compiler<br>
  bugs (I believe) in Rust. Instead of <code>Func::wrap</code> we have a<br>
<code>Func::wrapN_async</code> family of methods, and we've also got a whole<br>
  bunch of <code>Func::getN_async</code> methods now too. It may be worth<br>
  rethinking the API of <code>Func</code> to try to make the documentation page<br>
  actually grok'able.</p>
</li>
</ul>
<p>This isn't super heavily tested but the various test should suffice for<br>
engaging hopefully nearly all the infrastructure in one form or another.<br>
This is just the start though!</p>
<p>[RFC 2]: <a href="https://github.com/bytecodealliance/rfcs/pull/2">https://github.com/bytecodealliance/rfcs/pull/2</a></p>
<p>&lt;!--</p>
<p>Please ensure that the following steps are all taken care of before submitting<br>
the PR.</p>
<ul>
<li>
<p>[ ] This has been discussed in issue #..., or if not, please tell us why<br>
  here.</p>
</li>
<li>
<p>[ ] A short description of what this does, why it is needed; if the<br>
  description becomes long, the matter should probably be discussed in an issue<br>
  first.</p>
</li>
<li>
<p>[ ] This PR contains test cases, if meaningful.</p>
</li>
<li>[ ] A reviewer from the core maintainer team has been assigned for this PR.<br>
  If you don't know who could review this, please indicate so. The list of<br>
  suggested reviewers on the right can help you.</li>
</ul>
<p>Please ensure all communication adheres to the <a href="https://github.com/bytecodealliance/wasmtime/blob/master/CODE_OF_CONDUCT.md">code of
conduct</a>.<br>
--&gt;<br>
</p>
</blockquote>



<a name="225213933"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232434%20Implement%20support%20for%20%60async%60%20functio.../near/225213933" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232434.20Implement.20support.20for.20.60async.60.20functio.2E.2E.2E.html#225213933">(Feb 04 2021 at 19:58)</a>:</h4>
<p>alexcrichton updated <a href="https://github.com/bytecodealliance/wasmtime/pull/2434">PR #2434</a> from <code>async</code> to <code>main</code>:</p>
<blockquote>
<p>This is an implementation of [RFC 2] in Wasmtime which is to support<br>
<code>async</code>-defined host functions. At a high level support is added by<br>
executing WebAssembly code that might invoke an asynchronous host<br>
function on a separate native stack. When the host function's future is<br>
not ready we switch back to the main native stack to continue execution.</p>
<p>There's a whole bunch of details in this commit, and it's a bit much to<br>
go over them all here in this commit message. The most important changes<br>
here are:</p>
<ul>
<li>
<p>A new <code>wasmtime-fiber</code> crate has been written to manage the low-level<br>
  details of stack-switching. Unixes use <code>mmap</code> to allocate a stack and<br>
  Windows uses the native fibers implementation. We'll surely want to<br>
  refactor this to move stack allocation elsewhere in the future. Fibers<br>
  are intended to be relatively general with a lot of type paremters to<br>
  fling values back and forth across suspension points. The whole crate<br>
  is a giant wad of <code>unsafe</code> unfortunately and involves handwritten<br>
  assembly with custom dwarf CFI directives to boot. Definitely deserves<br>
  a close eye in review!</p>
</li>
<li>
<p>The <code>Store</code> type has two new methods -- <code>block_on</code> and <code>on_fiber</code><br>
  which bridge between the async and non-async worlds. Lots of unsafe<br>
  fiddly bits here as we're trying to communicate context pointers<br>
  between disparate portions of the code. Extra eyes and care in review<br>
  is greatly appreciated.</p>
</li>
<li>
<p>The APIs for binding <code>async</code> functions are unfortunately pretty ugly<br>
  in <code>Func</code>. This is mostly due to language limitations and compiler<br>
  bugs (I believe) in Rust. Instead of <code>Func::wrap</code> we have a<br>
<code>Func::wrapN_async</code> family of methods, and we've also got a whole<br>
  bunch of <code>Func::getN_async</code> methods now too. It may be worth<br>
  rethinking the API of <code>Func</code> to try to make the documentation page<br>
  actually grok'able.</p>
</li>
</ul>
<p>This isn't super heavily tested but the various test should suffice for<br>
engaging hopefully nearly all the infrastructure in one form or another.<br>
This is just the start though!</p>
<p>[RFC 2]: <a href="https://github.com/bytecodealliance/rfcs/pull/2">https://github.com/bytecodealliance/rfcs/pull/2</a></p>
<p>&lt;!--</p>
<p>Please ensure that the following steps are all taken care of before submitting<br>
the PR.</p>
<ul>
<li>
<p>[ ] This has been discussed in issue #..., or if not, please tell us why<br>
  here.</p>
</li>
<li>
<p>[ ] A short description of what this does, why it is needed; if the<br>
  description becomes long, the matter should probably be discussed in an issue<br>
  first.</p>
</li>
<li>
<p>[ ] This PR contains test cases, if meaningful.</p>
</li>
<li>[ ] A reviewer from the core maintainer team has been assigned for this PR.<br>
  If you don't know who could review this, please indicate so. The list of<br>
  suggested reviewers on the right can help you.</li>
</ul>
<p>Please ensure all communication adheres to the <a href="https://github.com/bytecodealliance/wasmtime/blob/master/CODE_OF_CONDUCT.md">code of
conduct</a>.<br>
--&gt;<br>
</p>
</blockquote>



<a name="225266553"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232434%20Implement%20support%20for%20%60async%60%20functio.../near/225266553" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232434.20Implement.20support.20for.20.60async.60.20functio.2E.2E.2E.html#225266553">(Feb 05 2021 at 06:48)</a>:</h4>
<p>peterhuene submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/2434#pullrequestreview-584061645">PR Review</a>.</p>



<a name="225266554"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232434%20Implement%20support%20for%20%60async%60%20functio.../near/225266554" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232434.20Implement.20support.20for.20.60async.60.20functio.2E.2E.2E.html#225266554">(Feb 05 2021 at 06:48)</a>:</h4>
<p>peterhuene created <a href="https://github.com/bytecodealliance/wasmtime/pull/2434#discussion_r570753878">PR Review Comment</a>:</p>
<blockquote>
<p><div class="codehilite" data-code-language="suggestion"><pre><span></span><code>    // The first 16 bytes of stack are reserved for metadata, so we start
    // storing values beneath that.
</code></pre></div><br>
</p>
</blockquote>



<a name="225348731"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232434%20Implement%20support%20for%20%60async%60%20functio.../near/225348731" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232434.20Implement.20support.20for.20.60async.60.20functio.2E.2E.2E.html#225348731">(Feb 05 2021 at 19:59)</a>:</h4>
<p>alexcrichton updated <a href="https://github.com/bytecodealliance/wasmtime/pull/2434">PR #2434</a> from <code>async</code> to <code>main</code>:</p>
<blockquote>
<p>This is an implementation of [RFC 2] in Wasmtime which is to support<br>
<code>async</code>-defined host functions. At a high level support is added by<br>
executing WebAssembly code that might invoke an asynchronous host<br>
function on a separate native stack. When the host function's future is<br>
not ready we switch back to the main native stack to continue execution.</p>
<p>There's a whole bunch of details in this commit, and it's a bit much to<br>
go over them all here in this commit message. The most important changes<br>
here are:</p>
<ul>
<li>
<p>A new <code>wasmtime-fiber</code> crate has been written to manage the low-level<br>
  details of stack-switching. Unixes use <code>mmap</code> to allocate a stack and<br>
  Windows uses the native fibers implementation. We'll surely want to<br>
  refactor this to move stack allocation elsewhere in the future. Fibers<br>
  are intended to be relatively general with a lot of type paremters to<br>
  fling values back and forth across suspension points. The whole crate<br>
  is a giant wad of <code>unsafe</code> unfortunately and involves handwritten<br>
  assembly with custom dwarf CFI directives to boot. Definitely deserves<br>
  a close eye in review!</p>
</li>
<li>
<p>The <code>Store</code> type has two new methods -- <code>block_on</code> and <code>on_fiber</code><br>
  which bridge between the async and non-async worlds. Lots of unsafe<br>
  fiddly bits here as we're trying to communicate context pointers<br>
  between disparate portions of the code. Extra eyes and care in review<br>
  is greatly appreciated.</p>
</li>
<li>
<p>The APIs for binding <code>async</code> functions are unfortunately pretty ugly<br>
  in <code>Func</code>. This is mostly due to language limitations and compiler<br>
  bugs (I believe) in Rust. Instead of <code>Func::wrap</code> we have a<br>
<code>Func::wrapN_async</code> family of methods, and we've also got a whole<br>
  bunch of <code>Func::getN_async</code> methods now too. It may be worth<br>
  rethinking the API of <code>Func</code> to try to make the documentation page<br>
  actually grok'able.</p>
</li>
</ul>
<p>This isn't super heavily tested but the various test should suffice for<br>
engaging hopefully nearly all the infrastructure in one form or another.<br>
This is just the start though!</p>
<p>[RFC 2]: <a href="https://github.com/bytecodealliance/rfcs/pull/2">https://github.com/bytecodealliance/rfcs/pull/2</a></p>
<p>&lt;!--</p>
<p>Please ensure that the following steps are all taken care of before submitting<br>
the PR.</p>
<ul>
<li>
<p>[ ] This has been discussed in issue #..., or if not, please tell us why<br>
  here.</p>
</li>
<li>
<p>[ ] A short description of what this does, why it is needed; if the<br>
  description becomes long, the matter should probably be discussed in an issue<br>
  first.</p>
</li>
<li>
<p>[ ] This PR contains test cases, if meaningful.</p>
</li>
<li>[ ] A reviewer from the core maintainer team has been assigned for this PR.<br>
  If you don't know who could review this, please indicate so. The list of<br>
  suggested reviewers on the right can help you.</li>
</ul>
<p>Please ensure all communication adheres to the <a href="https://github.com/bytecodealliance/wasmtime/blob/master/CODE_OF_CONDUCT.md">code of
conduct</a>.<br>
--&gt;<br>
</p>
</blockquote>



<a name="226830435"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232434%20Implement%20support%20for%20%60async%60%20functio.../near/226830435" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232434.20Implement.20support.20for.20.60async.60.20functio.2E.2E.2E.html#226830435">(Feb 18 2021 at 15:49)</a>:</h4>
<p>alexcrichton updated <a href="https://github.com/bytecodealliance/wasmtime/pull/2434">PR #2434</a> from <code>async</code> to <code>main</code>.</p>



<a name="226830657"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232434%20Implement%20support%20for%20%60async%60%20functio.../near/226830657" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232434.20Implement.20support.20for.20.60async.60.20functio.2E.2E.2E.html#226830657">(Feb 18 2021 at 15:50)</a>:</h4>
<p>alexcrichton updated <a href="https://github.com/bytecodealliance/wasmtime/pull/2434">PR #2434</a> from <code>async</code> to <code>main</code>.</p>



<a name="227941164"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232434%20Implement%20support%20for%20%60async%60%20functio.../near/227941164" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232434.20Implement.20support.20for.20.60async.60.20functio.2E.2E.2E.html#227941164">(Feb 26 2021 at 15:12)</a>:</h4>
<p><strong>alexcrichton</strong> requested <a href="https://github.com/peterhuene">peterhuene</a> for a review on <a href="https://github.com/bytecodealliance/wasmtime/pull/2434">PR #2434</a>.</p>



<a name="227976946"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232434%20Implement%20support%20for%20%60async%60%20functio.../near/227976946" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232434.20Implement.20support.20for.20.60async.60.20functio.2E.2E.2E.html#227976946">(Feb 26 2021 at 19:12)</a>:</h4>
<p>peterhuene submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/2434#pullrequestreview-599866949">PR Review</a>.</p>



<a name="227976947"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232434%20Implement%20support%20for%20%60async%60%20functio.../near/227976947" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232434.20Implement.20support.20for.20.60async.60.20functio.2E.2E.2E.html#227976947">(Feb 26 2021 at 19:12)</a>:</h4>
<p>peterhuene created <a href="https://github.com/bytecodealliance/wasmtime/pull/2434#discussion_r583859960">PR Review Comment</a>:</p>
<blockquote>
<p>I'll ping some Microsoft debugger folks to see if it's a known limitation of <code>StackWalkEx</code> when the given thread is a fiber.  I suspect <code>RtlVirtualUnwind</code> might not have this problem.</p>
</blockquote>



<a name="227986177"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232434%20Implement%20support%20for%20%60async%60%20functio.../near/227986177" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232434.20Implement.20support.20for.20.60async.60.20functio.2E.2E.2E.html#227986177">(Feb 26 2021 at 20:14)</a>:</h4>
<p>peterhuene submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/2434#pullrequestreview-599909229">PR Review</a>.</p>



<a name="227986178"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232434%20Implement%20support%20for%20%60async%60%20functio.../near/227986178" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232434.20Implement.20support.20for.20.60async.60.20functio.2E.2E.2E.html#227986178">(Feb 26 2021 at 20:14)</a>:</h4>
<p>peterhuene created <a href="https://github.com/bytecodealliance/wasmtime/pull/2434#discussion_r583892410">PR Review Comment</a>:</p>
<blockquote>
<blockquote>
<p>These methods are the most heavily optimized...</p>
</blockquote>
<p>Perhaps I'm reading this sentence wrong, but "most heavily optimized" sounds like the opposite intention.</p>
</blockquote>



<a name="227991522"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232434%20Implement%20support%20for%20%60async%60%20functio.../near/227991522" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232434.20Implement.20support.20for.20.60async.60.20functio.2E.2E.2E.html#227991522">(Feb 26 2021 at 20:49)</a>:</h4>
<p>peterhuene submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/2434#pullrequestreview-599931345">PR Review</a>.</p>



<a name="227991523"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232434%20Implement%20support%20for%20%60async%60%20functio.../near/227991523" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232434.20Implement.20support.20for.20.60async.60.20functio.2E.2E.2E.html#227991523">(Feb 26 2021 at 20:49)</a>:</h4>
<p>peterhuene created <a href="https://github.com/bytecodealliance/wasmtime/pull/2434#discussion_r583910007">PR Review Comment</a>:</p>
<blockquote>
<p><div class="codehilite" data-code-language="suggestion"><pre><span></span><code>        // We don't actually care about the fiber's return value here (no one's
</code></pre></div><br>
</p>
</blockquote>



<a name="227992058"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232434%20Implement%20support%20for%20%60async%60%20functio.../near/227992058" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232434.20Implement.20support.20for.20.60async.60.20functio.2E.2E.2E.html#227992058">(Feb 26 2021 at 20:52)</a>:</h4>
<p>peterhuene submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/2434#pullrequestreview-599933077">PR Review</a>.</p>



<a name="227997349"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232434%20Implement%20support%20for%20%60async%60%20functio.../near/227997349" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232434.20Implement.20support.20for.20.60async.60.20functio.2E.2E.2E.html#227997349">(Feb 26 2021 at 21:31)</a>:</h4>
<p>alexcrichton updated <a href="https://github.com/bytecodealliance/wasmtime/pull/2434">PR #2434</a> from <code>async</code> to <code>main</code>.</p>



<a name="228004470"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232434%20Implement%20support%20for%20%60async%60%20functio.../near/228004470" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232434.20Implement.20support.20for.20.60async.60.20functio.2E.2E.2E.html#228004470">(Feb 26 2021 at 22:19)</a>:</h4>
<p>alexcrichton merged <a href="https://github.com/bytecodealliance/wasmtime/pull/2434">PR #2434</a>.</p>



<hr><p>Last updated: Jan 20 2025 at 06:04 UTC</p>
</html>