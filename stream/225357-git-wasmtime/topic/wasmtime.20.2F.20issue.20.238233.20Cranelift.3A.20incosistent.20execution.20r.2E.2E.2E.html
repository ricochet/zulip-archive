<html>
<head><meta charset="utf-8"><title>wasmtime / issue #8233 Cranelift: incosistent execution r... · git-wasmtime · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/index.html">git-wasmtime</a></h2>
<h3>Topic: <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.238233.20Cranelift.3A.20incosistent.20execution.20r.2E.2E.2E.html">wasmtime / issue #8233 Cranelift: incosistent execution r...</a></h3>

<hr>

<base href="https://bytecodealliance.zulipchat.com">

<head><link href="https://bytecodealliance.github.io/zulip-archive/style.css" rel="stylesheet"></head>

<a name="429323901"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%238233%20Cranelift%3A%20incosistent%20execution%20r.../near/429323901" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.238233.20Cranelift.3A.20incosistent.20execution.20r.2E.2E.2E.html#429323901">(Mar 25 2024 at 09:12)</a>:</h4>
<p><a href="https://github.com/candymate">candymate</a> added the bug label to <a href="https://github.com/bytecodealliance/wasmtime/issues/8233">Issue #8233</a>.</p>



<a name="429323902"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%238233%20Cranelift%3A%20incosistent%20execution%20r.../near/429323902" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.238233.20Cranelift.3A.20incosistent.20execution.20r.2E.2E.2E.html#429323902">(Mar 25 2024 at 09:12)</a>:</h4>
<p><a href="https://github.com/candymate">candymate</a> added the fuzz-bug label to <a href="https://github.com/bytecodealliance/wasmtime/issues/8233">Issue #8233</a>.</p>



<a name="429323904"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%238233%20Cranelift%3A%20incosistent%20execution%20r.../near/429323904" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.238233.20Cranelift.3A.20incosistent.20execution.20r.2E.2E.2E.html#429323904">(Mar 25 2024 at 09:12)</a>:</h4>
<p>candymate opened <a href="https://github.com/bytecodealliance/wasmtime/issues/8233">issue #8233</a>:</p>
<blockquote>
<h3>Test Case</h3>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="c1">// main.rs</span>
<span class="k">use</span><span class="w"> </span><span class="n">wasmtime</span>::<span class="o">*</span><span class="p">;</span>

<span class="k">fn</span> <span class="nf">main</span><span class="p">()</span><span class="w"> </span>-&gt; <span class="nb">Result</span><span class="o">&lt;</span><span class="p">()</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">config</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Config</span>::<span class="n">default</span><span class="p">();</span>
<span class="w">    </span><span class="n">config</span><span class="p">.</span><span class="n">strategy</span><span class="p">(</span><span class="n">Strategy</span>::<span class="n">Cranelift</span><span class="p">);</span>
<span class="w">    </span><span class="n">config</span><span class="p">.</span><span class="n">cranelift_opt_level</span><span class="p">(</span><span class="n">OptLevel</span>::<span class="nb">None</span><span class="p">);</span>

<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">engine1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Engine</span>::<span class="n">new</span><span class="p">(</span><span class="o">&amp;</span><span class="n">config</span><span class="p">)</span><span class="o">?</span><span class="p">;</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">new_config</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">config</span><span class="p">.</span><span class="n">clone</span><span class="p">();</span>
<span class="w">    </span><span class="n">new_config</span><span class="p">.</span><span class="n">cranelift_opt_level</span><span class="p">(</span><span class="n">OptLevel</span>::<span class="n">Speed</span><span class="p">);</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">engine2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Engine</span>::<span class="n">new</span><span class="p">(</span><span class="o">&amp;</span><span class="n">new_config</span><span class="p">)</span><span class="o">?</span><span class="p">;</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">wat</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">r#"</span>
<span class="s">    (module</span>
<span class="s">        (type (;0;) (func (param i64 i64 i64) (result i64)))</span>
<span class="s">        (import "mem" "mem" (memory (;0;) 1))</span>
<span class="s">        (func (;0;) (type 0) (param i64 i64 i64) (result i64)</span>
<span class="s">          i64.const -1</span>
<span class="s">          i64.const 0</span>
<span class="s">          local.get 0</span>
<span class="s">          local.get 1</span>
<span class="s">          i64.lt_s</span>
<span class="s">          select</span>
<span class="s">          local.get 2</span>
<span class="s">          i64.shr_u</span>
<span class="s">          i64.extend8_s)</span>
<span class="s">        (export "main" (func 0)))</span>
<span class="s">    "#</span><span class="p">;</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">module1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Module</span>::<span class="n">new</span><span class="p">(</span><span class="o">&amp;</span><span class="n">engine1</span><span class="p">,</span><span class="w"> </span><span class="n">wat</span><span class="p">)</span><span class="o">?</span><span class="p">;</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">module2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Module</span>::<span class="n">new</span><span class="p">(</span><span class="o">&amp;</span><span class="n">engine2</span><span class="p">,</span><span class="w"> </span><span class="n">wat</span><span class="p">)</span><span class="o">?</span><span class="p">;</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">store1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Store</span>::<span class="n">new</span><span class="p">(</span><span class="o">&amp;</span><span class="n">engine1</span><span class="p">,</span><span class="w"> </span><span class="p">());</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">store2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Store</span>::<span class="n">new</span><span class="p">(</span><span class="o">&amp;</span><span class="n">engine2</span><span class="p">,</span><span class="w"> </span><span class="p">());</span>

<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">memory_ty</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">MemoryType</span>::<span class="n">new</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="nb">None</span><span class="p">);</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">memory1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Memory</span>::<span class="n">new</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="n">store1</span><span class="p">,</span><span class="w"> </span><span class="n">memory_ty</span><span class="p">.</span><span class="n">clone</span><span class="p">())</span><span class="o">?</span><span class="p">;</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">memory2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Memory</span>::<span class="n">new</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="n">store2</span><span class="p">,</span><span class="w"> </span><span class="n">memory_ty</span><span class="p">)</span><span class="o">?</span><span class="p">;</span>

<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">instance1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Instance</span>::<span class="n">new</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="n">store1</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">module1</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="p">[</span><span class="n">memory1</span><span class="p">.</span><span class="n">into</span><span class="p">()])</span><span class="o">?</span><span class="p">;</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">instance2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Instance</span>::<span class="n">new</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="n">store2</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">module2</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="p">[</span><span class="n">memory2</span><span class="p">.</span><span class="n">into</span><span class="p">()])</span><span class="o">?</span><span class="p">;</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">main1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">instance1</span><span class="p">.</span><span class="n">get_func</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="n">store1</span><span class="p">,</span><span class="w"> </span><span class="s">"main"</span><span class="p">)</span>
<span class="w">        </span><span class="p">.</span><span class="n">expect</span><span class="p">(</span><span class="s">"`main` was not an exported function"</span><span class="p">);</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">main2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">instance2</span><span class="p">.</span><span class="n">get_func</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="n">store2</span><span class="p">,</span><span class="w"> </span><span class="s">"main"</span><span class="p">)</span>
<span class="w">        </span><span class="p">.</span><span class="n">expect</span><span class="p">(</span><span class="s">"`main` was not an exported function"</span><span class="p">);</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">params</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="fm">vec!</span><span class="p">[</span>
<span class="w">        </span><span class="n">Val</span>::<span class="n">I64</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span>
<span class="w">        </span><span class="n">Val</span>::<span class="n">I64</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span>
<span class="w">        </span><span class="n">Val</span>::<span class="n">I64</span><span class="p">(</span><span class="mi">2</span><span class="p">),</span>
<span class="w">    </span><span class="p">];</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">results1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="fm">vec!</span><span class="p">[</span><span class="n">Val</span>::<span class="n">I64</span><span class="p">(</span><span class="mi">0</span><span class="p">)];</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">results2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="fm">vec!</span><span class="p">[</span><span class="n">Val</span>::<span class="n">I64</span><span class="p">(</span><span class="mi">0</span><span class="p">)];</span>
<span class="w">    </span><span class="fm">println!</span><span class="p">(</span><span class="s">"Opt level None: {:?}"</span><span class="p">,</span><span class="w"> </span><span class="n">main1</span><span class="p">.</span><span class="n">call</span><span class="p">(</span>
<span class="w">        </span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="n">store1</span><span class="p">,</span>
<span class="w">        </span><span class="o">&amp;</span><span class="n">params</span><span class="p">,</span>
<span class="w">        </span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="n">results1</span>
<span class="w">    </span><span class="p">));</span>
<span class="w">    </span><span class="fm">println!</span><span class="p">(</span><span class="s">"{:?}"</span><span class="p">,</span><span class="w"> </span><span class="n">results1</span><span class="p">);</span>
<span class="w">    </span><span class="fm">println!</span><span class="p">(</span><span class="s">"--------------"</span><span class="p">);</span>
<span class="w">    </span><span class="fm">println!</span><span class="p">(</span><span class="s">"Opt level Speed: {:?}"</span><span class="p">,</span><span class="w"> </span><span class="n">main2</span><span class="p">.</span><span class="n">call</span><span class="p">(</span>
<span class="w">        </span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="n">store2</span><span class="p">,</span>
<span class="w">        </span><span class="o">&amp;</span><span class="n">params</span><span class="p">,</span>
<span class="w">        </span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="n">results2</span>
<span class="w">    </span><span class="p">));</span>
<span class="w">    </span><span class="fm">println!</span><span class="p">(</span><span class="s">"{:?}"</span><span class="p">,</span><span class="w"> </span><span class="n">results2</span><span class="p">);</span>

<span class="w">    </span><span class="nb">Ok</span><span class="p">(())</span>
<span class="p">}</span>
</code></pre></div>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="p">[</span><span class="n">package</span><span class="p">]</span>
<span class="n">name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">"wasmtime-wrapper"</span>
<span class="n">version</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">"0.1.0"</span>
<span class="n">edition</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">"2021"</span>

#<span class="w"> </span><span class="n">See</span><span class="w"> </span><span class="n">more</span><span class="w"> </span><span class="n">keys</span><span class="w"> </span><span class="n">and</span><span class="w"> </span><span class="n">their</span><span class="w"> </span><span class="n">definitions</span><span class="w"> </span><span class="n">at</span><span class="w"> </span><span class="n">https</span>:<span class="c1">//doc.rust-lang.org/cargo/reference/manifest.html</span>

<span class="p">[</span><span class="n">dependencies</span><span class="p">]</span>
<span class="n">wasmtime</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">path</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">"../wasmtime/crates/wasmtime"</span><span class="w"> </span><span class="p">}</span>
#<span class="n">wasmtime</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">"19.0.0"</span>
</code></pre></div>
<h3>Steps to reproduce</h3>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="n">cargo</span><span class="w"> </span><span class="n">run</span><span class="w"> </span><span class="o">--</span><span class="n">release</span><span class="w"> </span><span class="o">--</span><span class="n">target</span><span class="o">=</span><span class="n">aarch64</span><span class="o">-</span><span class="n">unknown</span><span class="o">-</span><span class="n">linux</span><span class="o">-</span><span class="n">gnu</span>
</code></pre></div>
<p>QEMU run options I'm currently using is the following:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="n">qemu</span><span class="o">-</span><span class="n">aarch64</span><span class="w"> </span><span class="o">-</span><span class="n">L</span><span class="w"> </span><span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">aarch64</span><span class="o">-</span><span class="n">linux</span><span class="o">-</span><span class="n">gnu</span><span class="w"> </span><span class="o">-</span><span class="n">E</span><span class="w"> </span><span class="n">LD_LIBRARY_PATH</span><span class="o">=/</span><span class="n">usr</span><span class="o">/</span><span class="n">aarch64</span><span class="o">-</span><span class="n">linux</span><span class="o">-</span><span class="n">gnu</span><span class="o">/</span><span class="n">lib</span><span class="w"> </span><span class="o">-</span><span class="n">E</span><span class="w"> </span><span class="n">WASMTIME_TEST_NO_HOG_MEMORY</span><span class="o">=</span><span class="mi">1</span><span class="w"> </span><span class="n">target</span><span class="o">/</span><span class="n">aarch64</span><span class="o">-</span><span class="n">unknown</span><span class="o">-</span><span class="n">linux</span><span class="o">-</span><span class="n">gnu</span><span class="o">/</span><span class="n">release</span><span class="o">/</span><span class="n">wasmtime</span><span class="o">-</span><span class="n">wrapper</span>
</code></pre></div>
<h3>Expected Results</h3>
<p>Both results from none and speed optimizations should show the same result -1</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="n">Opt</span><span class="w"> </span><span class="n">level</span><span class="w"> </span><span class="nb">None</span>: <span class="nb">Ok</span><span class="p">(())</span>
<span class="p">[</span><span class="n">I64</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)]</span>
<span class="o">--------------</span>
<span class="n">Opt</span><span class="w"> </span><span class="n">level</span><span class="w"> </span><span class="n">Speed</span>: <span class="nb">Ok</span><span class="p">(())</span>
<span class="p">[</span><span class="n">I64</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)]</span>
</code></pre></div>
<h3>Actual Results</h3>
<p>The result from speed optimization is <code>0x3fffffffffffffff</code>, which is the wrong value.</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="n">Opt</span><span class="w"> </span><span class="n">level</span><span class="w"> </span><span class="nb">None</span>: <span class="nb">Ok</span><span class="p">(())</span>
<span class="p">[</span><span class="n">I64</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)]</span>
<span class="o">--------------</span>
<span class="n">Opt</span><span class="w"> </span><span class="n">level</span><span class="w"> </span><span class="n">Speed</span>: <span class="nb">Ok</span><span class="p">(())</span>
<span class="p">[</span><span class="n">I64</span><span class="p">(</span><span class="mi">4611686018427387903</span><span class="p">)]</span>
</code></pre></div>
<h3>Versions and Environment</h3>
<ul>
<li>wasmtime version<ul>
<li>Commit af6b8ca9474a8a36a137416152f1972f991f34a6 (latest version: Sun Mar 24 21:32:31 2024 -0700)</li>
<li>However, also checked on v19.0.0</li>
</ul>
</li>
<li>Operating system &amp; architecture: Ubuntu 22.04.3 LTS, Arch: x86_64</li>
<li>QEMU version: <code>qemu-aarch64 version 8.2.1 (v8.2.1)</code></li>
</ul>
<h3>Extra Info</h3>
<ul>
<li>Sorry for this, but the case is not fully minimized</li>
<li>Does not work on other architectures (x86_64, s390x, riscv64)</li>
<li>Not a security issue: not a tier 1 platform</li>
</ul>
</blockquote>



<a name="429424937"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%238233%20Cranelift%3A%20incosistent%20execution%20r.../near/429424937" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.238233.20Cranelift.3A.20incosistent.20execution.20r.2E.2E.2E.html#429424937">(Mar 25 2024 at 14:42)</a>:</h4>
<p>alexcrichton <a href="https://github.com/bytecodealliance/wasmtime/issues/8233#issuecomment-2018162989">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/8233">issue #8233</a>:</p>
<blockquote>
<p>Thanks for the report! I'm had a surprising amount of trouble reproducing this though, so I'm wondering if this isn't perhaps a different bug lurking somewhere. Locally I can't reproduce on a macOS arm64 machine, a native arm64 Linux machine, or on an x86_64 Linux machine with QEMU emulation. I noticed though that my QEMU was 8.1.5 (what we use in CI) rather than your local 8.2.1.</p>
<p>That appears to be the cause of the issue though, that QEMU 8.2.1 is required. I wonder if this is perhaps QEMU bug in that case?</p>
</blockquote>



<a name="429489803"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%238233%20Cranelift%3A%20incosistent%20execution%20r.../near/429489803" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.238233.20Cranelift.3A.20incosistent.20execution.20r.2E.2E.2E.html#429489803">(Mar 25 2024 at 19:05)</a>:</h4>
<p>alexcrichton <a href="https://github.com/bytecodealliance/wasmtime/issues/8233#issuecomment-2018709500">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/8233">issue #8233</a>:</p>
<blockquote>
<p>Bisection on qemu itself shows qemu/qemu@95bf306e3a058a38f5adb27be2ac598134b159d9 is the first "bad" commit. Not that I understand anything about QEMU source itself...</p>
</blockquote>



<a name="429490269"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%238233%20Cranelift%3A%20incosistent%20execution%20r.../near/429490269" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.238233.20Cranelift.3A.20incosistent.20execution.20r.2E.2E.2E.html#429490269">(Mar 25 2024 at 19:08)</a>:</h4>
<p>candymate <a href="https://github.com/bytecodealliance/wasmtime/issues/8233#issuecomment-2018717666">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/8233">issue #8233</a>:</p>
<blockquote>
<p>@alexcrichton I tried to downgrade QEMU to 8.1.5 and found that I'm getting the correct results (which is -1). Maybe this is a QEMU bug rather than a bug in Cranelift?</p>
<p>FYI, CLIF I'm getting now is:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="n">function</span><span class="w"> </span><span class="n">u0</span>:<span class="mi">0</span><span class="p">(</span><span class="kt">i64</span><span class="w"> </span><span class="n">vmctx</span><span class="p">,</span><span class="w"> </span><span class="kt">i64</span><span class="p">,</span><span class="w"> </span><span class="kt">i64</span><span class="p">,</span><span class="w"> </span><span class="kt">i64</span><span class="p">,</span><span class="w"> </span><span class="kt">i64</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="kt">i64</span> <span class="nc">fast</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">gv0</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">vmctx</span>
<span class="w">    </span><span class="n">gv1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">load</span><span class="p">.</span><span class="kt">i64</span><span class="w"> </span><span class="n">notrap</span><span class="w"> </span><span class="n">aligned</span><span class="w"> </span><span class="n">readonly</span><span class="w"> </span><span class="n">gv0</span><span class="o">+</span><span class="mi">8</span>
<span class="w">    </span><span class="n">gv2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">load</span><span class="p">.</span><span class="kt">i64</span><span class="w"> </span><span class="n">notrap</span><span class="w"> </span><span class="n">aligned</span><span class="w"> </span><span class="n">gv1</span>
<span class="w">    </span><span class="n">sig0</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="kt">i64</span><span class="w"> </span><span class="n">vmctx</span><span class="p">,</span><span class="w"> </span><span class="kt">i32</span><span class="w"> </span><span class="n">uext</span><span class="p">,</span><span class="w"> </span><span class="kt">i32</span><span class="w"> </span><span class="n">uext</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="kt">i32</span> <span class="nc">uext</span><span class="w"> </span><span class="n">system_v</span>
<span class="w">    </span><span class="n">sig1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="kt">i64</span><span class="w"> </span><span class="n">vmctx</span><span class="p">,</span><span class="w"> </span><span class="kt">i32</span><span class="w"> </span><span class="n">uext</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="kt">i32</span> <span class="nc">uext</span><span class="w"> </span><span class="n">system_v</span>
<span class="w">    </span><span class="n">stack_limit</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">gv2</span>

<span class="w">                                </span><span class="n">block0</span><span class="p">(</span><span class="n">v0</span>: <span class="kt">i64</span><span class="p">,</span><span class="w"> </span><span class="n">v1</span>: <span class="kt">i64</span><span class="p">,</span><span class="w"> </span><span class="n">v2</span>: <span class="kt">i64</span><span class="p">,</span><span class="w"> </span><span class="n">v3</span>: <span class="kt">i64</span><span class="p">,</span><span class="w"> </span><span class="n">v4</span>: <span class="kt">i64</span><span class="p">)</span>:
<span class="o">@</span><span class="mi">0033</span><span class="w">                               </span><span class="n">v6</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">iconst</span><span class="p">.</span><span class="kt">i64</span><span class="w"> </span><span class="o">-</span><span class="mi">1</span>
<span class="o">@</span><span class="mi">0035</span><span class="w">                               </span><span class="n">v7</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">iconst</span><span class="p">.</span><span class="kt">i64</span><span class="w"> </span><span class="mi">0</span>
<span class="o">@</span><span class="mi">003</span><span class="n">b</span><span class="w">                               </span><span class="n">v8</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">icmp</span><span class="w"> </span><span class="n">slt</span><span class="w"> </span><span class="n">v2</span><span class="p">,</span><span class="w"> </span><span class="n">v3</span>
<span class="o">@</span><span class="mi">003</span><span class="n">b</span><span class="w">                               </span><span class="n">v9</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">uextend</span><span class="p">.</span><span class="kt">i32</span><span class="w"> </span><span class="n">v8</span>
<span class="o">@</span><span class="mi">003</span><span class="n">c</span><span class="w">                               </span><span class="n">v10</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">select</span><span class="w"> </span><span class="n">v9</span><span class="p">,</span><span class="w"> </span><span class="n">v6</span><span class="p">,</span><span class="w"> </span><span class="n">v7</span><span class="w">  </span><span class="p">;</span><span class="w"> </span><span class="n">v6</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">v7</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span>
<span class="o">@</span><span class="mi">003</span><span class="n">f</span><span class="w">                               </span><span class="n">v11</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ushr</span><span class="w"> </span><span class="n">v10</span><span class="p">,</span><span class="w"> </span><span class="n">v4</span>
<span class="o">@</span><span class="mi">0040</span><span class="w">                               </span><span class="n">v12</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ireduce</span><span class="p">.</span><span class="kt">i8</span><span class="w"> </span><span class="n">v11</span>
<span class="o">@</span><span class="mi">0040</span><span class="w">                               </span><span class="n">v13</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">sextend</span><span class="p">.</span><span class="kt">i64</span><span class="w"> </span><span class="n">v12</span>
<span class="o">@</span><span class="mi">0041</span><span class="w">                               </span><span class="n">jump</span><span class="w"> </span><span class="n">block1</span><span class="p">(</span><span class="n">v13</span><span class="p">)</span>

<span class="w">                                </span><span class="n">block1</span><span class="p">(</span><span class="n">v5</span>: <span class="kt">i64</span><span class="p">)</span>:
<span class="o">@</span><span class="mi">0041</span><span class="w">                               </span><span class="k">return</span><span class="w"> </span><span class="n">v5</span>
<span class="p">}</span>
</code></pre></div>
<p>Now I'm trying to upgrade QEMU to try again...</p>
</blockquote>



<a name="429490607"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%238233%20Cranelift%3A%20incosistent%20execution%20r.../near/429490607" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.238233.20Cranelift.3A.20incosistent.20execution.20r.2E.2E.2E.html#429490607">(Mar 25 2024 at 19:11)</a>:</h4>
<p>alexcrichton <a href="https://github.com/bytecodealliance/wasmtime/issues/8233#issuecomment-2018721817">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/8233">issue #8233</a>:</p>
<blockquote>
<p>Yeah that's what I'm thinking. I'll note that on the master branch of QEMU I still see a non-minus-one return value, so I think for this you may need to downgrade to 8.1.5 rather than upgrade perhaps? That such a bug has gone unnoticed for so long though is also suspicious...</p>
</blockquote>



<a name="429492254"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%238233%20Cranelift%3A%20incosistent%20execution%20r.../near/429492254" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.238233.20Cranelift.3A.20incosistent.20execution.20r.2E.2E.2E.html#429492254">(Mar 25 2024 at 19:21)</a>:</h4>
<p>candymate <a href="https://github.com/bytecodealliance/wasmtime/issues/8233#issuecomment-2018739412">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/8233">issue #8233</a>:</p>
<blockquote>
<p>I also tested on QEMU v8.2.2 and v9.0.0-rc0, and now I'm pretty sure that this is a newly introduced QEMU bug. I think I'll need to downgrade QEMU to v8.1.5 for now...</p>
<p>Anyway, thanks for your work! I think you can close this issue whenever you want.</p>
</blockquote>



<a name="429493242"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%238233%20Cranelift%3A%20incosistent%20execution%20r.../near/429493242" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.238233.20Cranelift.3A.20incosistent.20execution.20r.2E.2E.2E.html#429493242">(Mar 25 2024 at 19:28)</a>:</h4>
<p>alexcrichton closed <a href="https://github.com/bytecodealliance/wasmtime/issues/8233">issue #8233</a>:</p>
<blockquote>
<h3>Test Case</h3>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="c1">// main.rs</span>
<span class="k">use</span><span class="w"> </span><span class="n">wasmtime</span>::<span class="o">*</span><span class="p">;</span>

<span class="k">fn</span> <span class="nf">main</span><span class="p">()</span><span class="w"> </span>-&gt; <span class="nb">Result</span><span class="o">&lt;</span><span class="p">()</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">config</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Config</span>::<span class="n">default</span><span class="p">();</span>
<span class="w">    </span><span class="n">config</span><span class="p">.</span><span class="n">strategy</span><span class="p">(</span><span class="n">Strategy</span>::<span class="n">Cranelift</span><span class="p">);</span>
<span class="w">    </span><span class="n">config</span><span class="p">.</span><span class="n">cranelift_opt_level</span><span class="p">(</span><span class="n">OptLevel</span>::<span class="nb">None</span><span class="p">);</span>

<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">engine1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Engine</span>::<span class="n">new</span><span class="p">(</span><span class="o">&amp;</span><span class="n">config</span><span class="p">)</span><span class="o">?</span><span class="p">;</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">new_config</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">config</span><span class="p">.</span><span class="n">clone</span><span class="p">();</span>
<span class="w">    </span><span class="n">new_config</span><span class="p">.</span><span class="n">cranelift_opt_level</span><span class="p">(</span><span class="n">OptLevel</span>::<span class="n">Speed</span><span class="p">);</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">engine2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Engine</span>::<span class="n">new</span><span class="p">(</span><span class="o">&amp;</span><span class="n">new_config</span><span class="p">)</span><span class="o">?</span><span class="p">;</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">wat</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">r#"</span>
<span class="s">    (module</span>
<span class="s">        (type (;0;) (func (param i64 i64 i64) (result i64)))</span>
<span class="s">        (import "mem" "mem" (memory (;0;) 1))</span>
<span class="s">        (func (;0;) (type 0) (param i64 i64 i64) (result i64)</span>
<span class="s">          i64.const -1</span>
<span class="s">          i64.const 0</span>
<span class="s">          local.get 0</span>
<span class="s">          local.get 1</span>
<span class="s">          i64.lt_s</span>
<span class="s">          select</span>
<span class="s">          local.get 2</span>
<span class="s">          i64.shr_u</span>
<span class="s">          i64.extend8_s)</span>
<span class="s">        (export "main" (func 0)))</span>
<span class="s">    "#</span><span class="p">;</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">module1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Module</span>::<span class="n">new</span><span class="p">(</span><span class="o">&amp;</span><span class="n">engine1</span><span class="p">,</span><span class="w"> </span><span class="n">wat</span><span class="p">)</span><span class="o">?</span><span class="p">;</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">module2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Module</span>::<span class="n">new</span><span class="p">(</span><span class="o">&amp;</span><span class="n">engine2</span><span class="p">,</span><span class="w"> </span><span class="n">wat</span><span class="p">)</span><span class="o">?</span><span class="p">;</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">store1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Store</span>::<span class="n">new</span><span class="p">(</span><span class="o">&amp;</span><span class="n">engine1</span><span class="p">,</span><span class="w"> </span><span class="p">());</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">store2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Store</span>::<span class="n">new</span><span class="p">(</span><span class="o">&amp;</span><span class="n">engine2</span><span class="p">,</span><span class="w"> </span><span class="p">());</span>

<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">memory_ty</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">MemoryType</span>::<span class="n">new</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="nb">None</span><span class="p">);</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">memory1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Memory</span>::<span class="n">new</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="n">store1</span><span class="p">,</span><span class="w"> </span><span class="n">memory_ty</span><span class="p">.</span><span class="n">clone</span><span class="p">())</span><span class="o">?</span><span class="p">;</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">memory2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Memory</span>::<span class="n">new</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="n">store2</span><span class="p">,</span><span class="w"> </span><span class="n">memory_ty</span><span class="p">)</span><span class="o">?</span><span class="p">;</span>

<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">instance1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Instance</span>::<span class="n">new</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="n">store1</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">module1</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="p">[</span><span class="n">memory1</span><span class="p">.</span><span class="n">into</span><span class="p">()])</span><span class="o">?</span><span class="p">;</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">instance2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Instance</span>::<span class="n">new</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="n">store2</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">module2</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="p">[</span><span class="n">memory2</span><span class="p">.</span><span class="n">into</span><span class="p">()])</span><span class="o">?</span><span class="p">;</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">main1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">instance1</span><span class="p">.</span><span class="n">get_func</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="n">store1</span><span class="p">,</span><span class="w"> </span><span class="s">"main"</span><span class="p">)</span>
<span class="w">        </span><span class="p">.</span><span class="n">expect</span><span class="p">(</span><span class="s">"`main` was not an exported function"</span><span class="p">);</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">main2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">instance2</span><span class="p">.</span><span class="n">get_func</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="n">store2</span><span class="p">,</span><span class="w"> </span><span class="s">"main"</span><span class="p">)</span>
<span class="w">        </span><span class="p">.</span><span class="n">expect</span><span class="p">(</span><span class="s">"`main` was not an exported function"</span><span class="p">);</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">params</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="fm">vec!</span><span class="p">[</span>
<span class="w">        </span><span class="n">Val</span>::<span class="n">I64</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span>
<span class="w">        </span><span class="n">Val</span>::<span class="n">I64</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span>
<span class="w">        </span><span class="n">Val</span>::<span class="n">I64</span><span class="p">(</span><span class="mi">2</span><span class="p">),</span>
<span class="w">    </span><span class="p">];</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">results1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="fm">vec!</span><span class="p">[</span><span class="n">Val</span>::<span class="n">I64</span><span class="p">(</span><span class="mi">0</span><span class="p">)];</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">results2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="fm">vec!</span><span class="p">[</span><span class="n">Val</span>::<span class="n">I64</span><span class="p">(</span><span class="mi">0</span><span class="p">)];</span>
<span class="w">    </span><span class="fm">println!</span><span class="p">(</span><span class="s">"Opt level None: {:?}"</span><span class="p">,</span><span class="w"> </span><span class="n">main1</span><span class="p">.</span><span class="n">call</span><span class="p">(</span>
<span class="w">        </span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="n">store1</span><span class="p">,</span>
<span class="w">        </span><span class="o">&amp;</span><span class="n">params</span><span class="p">,</span>
<span class="w">        </span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="n">results1</span>
<span class="w">    </span><span class="p">));</span>
<span class="w">    </span><span class="fm">println!</span><span class="p">(</span><span class="s">"{:?}"</span><span class="p">,</span><span class="w"> </span><span class="n">results1</span><span class="p">);</span>
<span class="w">    </span><span class="fm">println!</span><span class="p">(</span><span class="s">"--------------"</span><span class="p">);</span>
<span class="w">    </span><span class="fm">println!</span><span class="p">(</span><span class="s">"Opt level Speed: {:?}"</span><span class="p">,</span><span class="w"> </span><span class="n">main2</span><span class="p">.</span><span class="n">call</span><span class="p">(</span>
<span class="w">        </span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="n">store2</span><span class="p">,</span>
<span class="w">        </span><span class="o">&amp;</span><span class="n">params</span><span class="p">,</span>
<span class="w">        </span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="n">results2</span>
<span class="w">    </span><span class="p">));</span>
<span class="w">    </span><span class="fm">println!</span><span class="p">(</span><span class="s">"{:?}"</span><span class="p">,</span><span class="w"> </span><span class="n">results2</span><span class="p">);</span>

<span class="w">    </span><span class="nb">Ok</span><span class="p">(())</span>
<span class="p">}</span>
</code></pre></div>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="p">[</span><span class="n">package</span><span class="p">]</span>
<span class="n">name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">"wasmtime-wrapper"</span>
<span class="n">version</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">"0.1.0"</span>
<span class="n">edition</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">"2021"</span>

#<span class="w"> </span><span class="n">See</span><span class="w"> </span><span class="n">more</span><span class="w"> </span><span class="n">keys</span><span class="w"> </span><span class="n">and</span><span class="w"> </span><span class="n">their</span><span class="w"> </span><span class="n">definitions</span><span class="w"> </span><span class="n">at</span><span class="w"> </span><span class="n">https</span>:<span class="c1">//doc.rust-lang.org/cargo/reference/manifest.html</span>

<span class="p">[</span><span class="n">dependencies</span><span class="p">]</span>
<span class="n">wasmtime</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">path</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">"../wasmtime/crates/wasmtime"</span><span class="w"> </span><span class="p">}</span>
#<span class="n">wasmtime</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">"19.0.0"</span>
</code></pre></div>
<h3>Steps to reproduce</h3>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="n">cargo</span><span class="w"> </span><span class="n">run</span><span class="w"> </span><span class="o">--</span><span class="n">release</span><span class="w"> </span><span class="o">--</span><span class="n">target</span><span class="o">=</span><span class="n">aarch64</span><span class="o">-</span><span class="n">unknown</span><span class="o">-</span><span class="n">linux</span><span class="o">-</span><span class="n">gnu</span>
</code></pre></div>
<p>QEMU run options I'm currently using is the following:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="n">qemu</span><span class="o">-</span><span class="n">aarch64</span><span class="w"> </span><span class="o">-</span><span class="n">L</span><span class="w"> </span><span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">aarch64</span><span class="o">-</span><span class="n">linux</span><span class="o">-</span><span class="n">gnu</span><span class="w"> </span><span class="o">-</span><span class="n">E</span><span class="w"> </span><span class="n">LD_LIBRARY_PATH</span><span class="o">=/</span><span class="n">usr</span><span class="o">/</span><span class="n">aarch64</span><span class="o">-</span><span class="n">linux</span><span class="o">-</span><span class="n">gnu</span><span class="o">/</span><span class="n">lib</span><span class="w"> </span><span class="o">-</span><span class="n">E</span><span class="w"> </span><span class="n">WASMTIME_TEST_NO_HOG_MEMORY</span><span class="o">=</span><span class="mi">1</span><span class="w"> </span><span class="n">target</span><span class="o">/</span><span class="n">aarch64</span><span class="o">-</span><span class="n">unknown</span><span class="o">-</span><span class="n">linux</span><span class="o">-</span><span class="n">gnu</span><span class="o">/</span><span class="n">release</span><span class="o">/</span><span class="n">wasmtime</span><span class="o">-</span><span class="n">wrapper</span>
</code></pre></div>
<h3>Expected Results</h3>
<p>Both results from none and speed optimizations should show the same result -1</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="n">Opt</span><span class="w"> </span><span class="n">level</span><span class="w"> </span><span class="nb">None</span>: <span class="nb">Ok</span><span class="p">(())</span>
<span class="p">[</span><span class="n">I64</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)]</span>
<span class="o">--------------</span>
<span class="n">Opt</span><span class="w"> </span><span class="n">level</span><span class="w"> </span><span class="n">Speed</span>: <span class="nb">Ok</span><span class="p">(())</span>
<span class="p">[</span><span class="n">I64</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)]</span>
</code></pre></div>
<h3>Actual Results</h3>
<p>The result from speed optimization is <code>0x3fffffffffffffff</code>, which is the wrong value.</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="n">Opt</span><span class="w"> </span><span class="n">level</span><span class="w"> </span><span class="nb">None</span>: <span class="nb">Ok</span><span class="p">(())</span>
<span class="p">[</span><span class="n">I64</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)]</span>
<span class="o">--------------</span>
<span class="n">Opt</span><span class="w"> </span><span class="n">level</span><span class="w"> </span><span class="n">Speed</span>: <span class="nb">Ok</span><span class="p">(())</span>
<span class="p">[</span><span class="n">I64</span><span class="p">(</span><span class="mi">4611686018427387903</span><span class="p">)]</span>
</code></pre></div>
<h3>Versions and Environment</h3>
<ul>
<li>wasmtime version<ul>
<li>Commit af6b8ca9474a8a36a137416152f1972f991f34a6 (latest version: Sun Mar 24 21:32:31 2024 -0700)</li>
<li>However, also checked on v19.0.0</li>
</ul>
</li>
<li>Operating system &amp; architecture: Ubuntu 22.04.3 LTS, Arch: x86_64</li>
<li>QEMU version: <code>qemu-aarch64 version 8.2.1 (v8.2.1)</code></li>
</ul>
<h3>Extra Info</h3>
<ul>
<li>Sorry for this, but the case is not fully minimized</li>
<li>Does not work on other architectures (x86_64, s390x, riscv64)</li>
<li>Not a security issue: not a tier 1 platform</li>
</ul>
</blockquote>



<a name="429493246"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%238233%20Cranelift%3A%20incosistent%20execution%20r.../near/429493246" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.238233.20Cranelift.3A.20incosistent.20execution.20r.2E.2E.2E.html#429493246">(Mar 25 2024 at 19:28)</a>:</h4>
<p>alexcrichton <a href="https://github.com/bytecodealliance/wasmtime/issues/8233#issuecomment-2018752699">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/8233">issue #8233</a>:</p>
<blockquote>
<p>To confirm this is a QEMU issue I ended up mimizing to:</p>
<div class="codehilite" data-code-language="C"><pre><span></span><code><span class="c1">// foo.c</span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;stdio.h&gt;</span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;stdint.h&gt;</span>

<span class="kt">int64_t</span><span class="w"> </span><span class="nf">callme</span><span class="p">(</span><span class="kt">size_t</span><span class="w"> </span><span class="n">_1</span><span class="p">,</span><span class="w"> </span><span class="kt">size_t</span><span class="w"> </span><span class="n">_2</span><span class="p">,</span><span class="w"> </span><span class="kt">int64_t</span><span class="w"> </span><span class="n">a</span><span class="p">,</span><span class="w"> </span><span class="kt">int64_t</span><span class="w"> </span><span class="n">b</span><span class="p">,</span><span class="w"> </span><span class="kt">int64_t</span><span class="w"> </span><span class="n">c</span><span class="p">);</span>

<span class="kt">int</span><span class="w"> </span><span class="nf">main</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kt">int64_t</span><span class="w"> </span><span class="n">ret</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">callme</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="p">);</span>
<span class="w">    </span><span class="n">printf</span><span class="p">(</span><span class="s">"%ld</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span><span class="w"> </span><span class="n">ret</span><span class="p">);</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div>
<div class="codehilite" data-code-language="GAS"><pre><span></span><code><span class="c1">// foo.S</span>
<span class="na">.global</span><span class="w"> </span><span class="no">callme</span>
<span class="nl">callme:</span>
<span class="w">  </span><span class="nf">cmp</span><span class="w">   </span><span class="no">x2</span><span class="p">,</span><span class="w"> </span><span class="no">x3</span>
<span class="w">  </span><span class="nf">cset</span><span class="w">  </span><span class="no">x12</span><span class="p">,</span><span class="w"> </span><span class="no">lt</span>
<span class="w">  </span><span class="nf">and</span><span class="w">   </span><span class="no">w11</span><span class="p">,</span><span class="w"> </span><span class="no">w12</span><span class="p">,</span><span class="w"> </span><span class="mi">#0</span><span class="no">xff</span>
<span class="w">  </span><span class="nf">cmp</span><span class="w">   </span><span class="no">w11</span><span class="p">,</span><span class="w"> </span><span class="mi">#0</span><span class="no">x0</span>
<span class="w">  </span><span class="nf">csetm</span><span class="w"> </span><span class="no">x14</span><span class="p">,</span><span class="w"> </span><span class="no">ne</span>
<span class="w">  </span><span class="nf">lsr</span><span class="w">   </span><span class="no">x13</span><span class="p">,</span><span class="w"> </span><span class="no">x14</span><span class="p">,</span><span class="w"> </span><span class="no">x4</span>
<span class="w">  </span><span class="nf">sxtb</span><span class="w">  </span><span class="no">x0</span><span class="p">,</span><span class="w"> </span><span class="no">w13</span>
<span class="w">  </span><span class="nf">ret</span>
</code></pre></div>
<p>compiled as:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="cp">$</span><span class="w"> </span><span class="n">aarch64</span><span class="o">-</span><span class="n">linux</span><span class="o">-</span><span class="n">gnu</span><span class="o">-</span><span class="n">gcc</span><span class="w"> </span><span class="n">foo</span><span class="p">.</span><span class="n">c</span><span class="w"> </span><span class="n">foo</span><span class="p">.</span><span class="n">S</span><span class="w"> </span><span class="o">-</span><span class="n">o</span><span class="w"> </span><span class="n">foo</span>
</code></pre></div>
<p>On native that prints -1 and on qemu 8.2.1 it prints 4611686018427387903.</p>
<p>Interestingly if I enable <code>-g</code> with QEMU and single-step in qemu it also prints -1.</p>
<p>In any case I agree it's QEMU so I'm going to close this.</p>
</blockquote>



<a name="429497404"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%238233%20Cranelift%3A%20incosistent%20execution%20r.../near/429497404" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.238233.20Cranelift.3A.20incosistent.20execution.20r.2E.2E.2E.html#429497404">(Mar 25 2024 at 19:55)</a>:</h4>
<p>bjorn3 <a href="https://github.com/bytecodealliance/wasmtime/issues/8233#issuecomment-2018797691">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/8233">issue #8233</a>:</p>
<blockquote>
<p>Are you going to open a qemu issue to get this fixed?</p>
</blockquote>



<a name="429512195"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%238233%20Cranelift%3A%20incosistent%20execution%20r.../near/429512195" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.238233.20Cranelift.3A.20incosistent.20execution.20r.2E.2E.2E.html#429512195">(Mar 25 2024 at 21:17)</a>:</h4>
<p>alexcrichton <a href="https://github.com/bytecodealliance/wasmtime/issues/8233#issuecomment-2018933508">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/8233">issue #8233</a>:</p>
<blockquote>
<p>Ah no I wasn't planning on personally doing that, no</p>
</blockquote>



<a name="429530168"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%238233%20Cranelift%3A%20incosistent%20execution%20r.../near/429530168" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.238233.20Cranelift.3A.20incosistent.20execution.20r.2E.2E.2E.html#429530168">(Mar 25 2024 at 23:49)</a>:</h4>
<p>candymate <a href="https://github.com/bytecodealliance/wasmtime/issues/8233#issuecomment-2019118029">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/8233">issue #8233</a>:</p>
<blockquote>
<p>I'll report this to QEMU by today and let you know about it. Thank you.</p>
</blockquote>



<a name="429530269"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%238233%20Cranelift%3A%20incosistent%20execution%20r.../near/429530269" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.238233.20Cranelift.3A.20incosistent.20execution.20r.2E.2E.2E.html#429530269">(Mar 25 2024 at 23:50)</a>:</h4>
<p>candymate edited a <a href="https://github.com/bytecodealliance/wasmtime/issues/8233#issuecomment-2019118029">comment</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/8233">issue #8233</a>:</p>
<blockquote>
<p>I'll report this to QEMU on today and let you know about it. Thank you.</p>
</blockquote>



<a name="429584156"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%238233%20Cranelift%3A%20incosistent%20execution%20r.../near/429584156" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.238233.20Cranelift.3A.20incosistent.20execution.20r.2E.2E.2E.html#429584156">(Mar 26 2024 at 04:58)</a>:</h4>
<p>candymate edited a <a href="https://github.com/bytecodealliance/wasmtime/issues/8233#issuecomment-2019118029">comment</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/8233">issue #8233</a>:</p>
<blockquote>
<p>I'll report this to QEMU on today and let you know about it. Thank you.</p>
<p>Update: I reported this to QEMU: <a href="https://gitlab.com/qemu-project/qemu/-/issues/2248">https://gitlab.com/qemu-project/qemu/-/issues/2248</a> </p>
</blockquote>



<a name="432231119"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%238233%20Cranelift%3A%20incosistent%20execution%20r.../near/432231119" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.238233.20Cranelift.3A.20incosistent.20execution.20r.2E.2E.2E.html#432231119">(Apr 09 2024 at 12:46)</a>:</h4>
<p>pm215 <a href="https://github.com/bytecodealliance/wasmtime/issues/8233#issuecomment-2045101861">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/8233">issue #8233</a>:</p>
<blockquote>
<p>just FYI, this QEMU bug will be fixed in the upcoming 9.0 release and backported to the relevant stable branches.</p>
</blockquote>



<hr><p>Last updated: Jan 20 2025 at 06:04 UTC</p>
</html>