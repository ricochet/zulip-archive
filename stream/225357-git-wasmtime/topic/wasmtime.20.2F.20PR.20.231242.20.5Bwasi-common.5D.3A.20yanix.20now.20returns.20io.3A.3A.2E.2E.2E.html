<html>
<head><meta charset="utf-8"><title>wasmtime / PR #1242 [wasi-common]: yanix now returns io::... · git-wasmtime · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/index.html">git-wasmtime</a></h2>
<h3>Topic: <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231242.20.5Bwasi-common.5D.3A.20yanix.20now.20returns.20io.3A.3A.2E.2E.2E.html">wasmtime / PR #1242 [wasi-common]: yanix now returns io::...</a></h3>

<hr>

<base href="https://bytecodealliance.zulipchat.com">

<head><link href="https://bytecodealliance.github.io/zulip-archive/style.css" rel="stylesheet"></head>

<a name="189890464"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231242%20%5Bwasi-common%5D%3A%20yanix%20now%20returns%20io%3A%3A.../near/189890464" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231242.20.5Bwasi-common.5D.3A.20yanix.20now.20returns.20io.3A.3A.2E.2E.2E.html#189890464">(Mar 06 2020 at 13:06)</a>:</h4>
<p>kubkon edited <a href="https://github.com/bytecodealliance/wasmtime/pull/1242" target="_blank" title="https://github.com/bytecodealliance/wasmtime/pull/1242">PR #1242</a> from <code>yanix-io-error</code> to <code>master</code>:</p>
<blockquote>
<p>This PR may seem somewhat controversial at first, but hear me<br>
out first. Currently, Yanix would return a custom error that's a<br>
wrapper around three other error types returned by various entities<br>
inside Rust's <code>libstd</code>. In particular, Yanix's error type would wrap<br>
<code>io::Error</code>, <code>num::TryFromIntError</code> and <code>ffi::NulError</code>. It turns<br>
out that there is a natural conversion between the first and the last<br>
and provided by the standard library, i.e., <code>From&lt;ffi::NulError&gt; for io::Error</code><br>
is provided. So at the surface it may seem that only the first two<br>
wrapped error types are worth keeping.</p>
<p>Digging a little bit deeper into <code>libstd</code>, <code>num::TryFromIntError</code><br>
is essentially speaking only a marker that the integral conversion<br>
went wrong. The struct implementing this error stores a unit type,<br>
and nothing more. It therefore seems like a waste to wrap this<br>
particular error when we could unify everything under <code>io::Error</code>.<br>
And so, whenever we perform an int conversion, I suggest we simply<br>
remap the error to <code>io::Error::from_raw_os_error(libc::EOVERFLOW)</code><br>
since this carries a comparable amount of information.</p>
<p>As a result of completely discarding <code>yanix::Error</code> custom error type,<br>
we are invariably simplifying <code>yanix</code> itself, but also allowing<br>
<code>wasi-common</code> to simplify in several places as well.</p>
<p>I'm curious to see what you guys reckon!</p>
</blockquote>



<a name="189890691"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231242%20%5Bwasi-common%5D%3A%20yanix%20now%20returns%20io%3A%3A.../near/189890691" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231242.20.5Bwasi-common.5D.3A.20yanix.20now.20returns.20io.3A.3A.2E.2E.2E.html#189890691">(Mar 06 2020 at 13:09)</a>:</h4>
<p>kubkon updated <a href="https://github.com/bytecodealliance/wasmtime/pull/1242" target="_blank" title="https://github.com/bytecodealliance/wasmtime/pull/1242">PR #1242</a> from <code>yanix-io-error</code> to <code>master</code>:</p>
<blockquote>
<p>This PR may seem somewhat controversial at first, but hear me<br>
out first. Currently, Yanix would return a custom error that's a<br>
wrapper around three other error types returned by various entities<br>
inside Rust's <code>libstd</code>. In particular, Yanix's error type would wrap<br>
<code>io::Error</code>, <code>num::TryFromIntError</code> and <code>ffi::NulError</code>. It turns<br>
out that there is a natural conversion between the first and the last<br>
and provided by the standard library, i.e., <code>From&lt;ffi::NulError&gt; for io::Error</code><br>
is provided. So at the surface it may seem that only the first two<br>
wrapped error types are worth keeping.</p>
<p>Digging a little bit deeper into <code>libstd</code>, <code>num::TryFromIntError</code><br>
is essentially speaking only a marker that the integral conversion<br>
went wrong. The struct implementing this error stores a unit type,<br>
and nothing more. It therefore seems like a waste to wrap this<br>
particular error when we could unify everything under <code>io::Error</code>.<br>
And so, whenever we perform an int conversion, I suggest we simply<br>
remap the error to <code>io::Error::from_raw_os_error(libc::EOVERFLOW)</code><br>
since this carries a comparable amount of information.</p>
<p>As a result of completely discarding <code>yanix::Error</code> custom error type,<br>
we are invariably simplifying <code>yanix</code> itself, but also allowing<br>
<code>wasi-common</code> to simplify in several places as well.</p>
<p>I'm curious to see what you guys reckon!</p>
</blockquote>



<a name="189894822"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231242%20%5Bwasi-common%5D%3A%20yanix%20now%20returns%20io%3A%3A.../near/189894822" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231242.20.5Bwasi-common.5D.3A.20yanix.20now.20returns.20io.3A.3A.2E.2E.2E.html#189894822">(Mar 06 2020 at 14:02)</a>:</h4>
<p>kubkon edited <a href="https://github.com/bytecodealliance/wasmtime/pull/1242" target="_blank" title="https://github.com/bytecodealliance/wasmtime/pull/1242">PR #1242</a> from <code>yanix-io-error</code> to <code>master</code>:</p>
<blockquote>
<p>This PR may seem somewhat controversial at first, but hear me out first. Currently, Yanix would return a custom error that's a wrapper around three other error types returned by various entities inside Rust's <code>libstd</code>. In particular, Yanix's error type would wrap <code>io::Error</code>, <code>num::TryFromIntError</code> and <code>ffi::NulError</code>. It turns out that there is a natural conversion between the first and the last and provided by the standard library, i.e., <code>From&lt;ffi::NulError&gt; for io::Error</code> is provided. So at the surface it may seem that only the first two wrapped error types are worth keeping.</p>
<p>Digging a little bit deeper into <code>libstd</code>, <code>num::TryFromIntError</code> is essentially speaking only a marker that the integral conversion went wrong. The struct implementing this error stores a unit type, and nothing more. It therefore seems like a waste to wrap this particular error when we could unify everything under <code>io::Error</code>. And so, whenever we perform an int conversion, I suggest we simply remap the error to <code>io::Error::from_raw_os_error(libc::EOVERFLOW)</code> since this carries a comparable amount of information.</p>
<p>As a result of completely discarding <code>yanix::Error</code> custom error type, we are invariably simplifying <code>yanix</code> itself, but also allowing <code>wasi-common</code> to simplify in several places as well.</p>
<p>I'm curious to see what you guys reckon!</p>
</blockquote>



<a name="189898204"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231242%20%5Bwasi-common%5D%3A%20yanix%20now%20returns%20io%3A%3A.../near/189898204" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231242.20.5Bwasi-common.5D.3A.20yanix.20now.20returns.20io.3A.3A.2E.2E.2E.html#189898204">(Mar 06 2020 at 14:34)</a>:</h4>
<p>sunfishcode created <a href="https://github.com/bytecodealliance/wasmtime/pull/1242#discussion_r388908554" target="_blank" title="https://github.com/bytecodealliance/wasmtime/pull/1242#discussion_r388908554">PR Review Comment</a>:</p>
<blockquote>
<p>We can just <code>unwrap()</code> this, because <code>readlinkat</code> returns an <code>ssize_t</code> which is either -1 (handled above) or non-negative and will fit in a <code>size_t</code>/<code>usize</code>, which is what we're converting it to here.</p>
</blockquote>



<a name="189898205"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231242%20%5Bwasi-common%5D%3A%20yanix%20now%20returns%20io%3A%3A.../near/189898205" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231242.20.5Bwasi-common.5D.3A.20yanix.20now.20returns.20io.3A.3A.2E.2E.2E.html#189898205">(Mar 06 2020 at 14:34)</a>:</h4>
<p>sunfishcode submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/1242#pullrequestreview-370328750" target="_blank" title="https://github.com/bytecodealliance/wasmtime/pull/1242#pullrequestreview-370328750">PR Review</a>.</p>



<a name="189898206"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231242%20%5Bwasi-common%5D%3A%20yanix%20now%20returns%20io%3A%3A.../near/189898206" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231242.20.5Bwasi-common.5D.3A.20yanix.20now.20returns.20io.3A.3A.2E.2E.2E.html#189898206">(Mar 06 2020 at 14:34)</a>:</h4>
<p>sunfishcode created <a href="https://github.com/bytecodealliance/wasmtime/pull/1242#discussion_r388911013" target="_blank" title="https://github.com/bytecodealliance/wasmtime/pull/1242#discussion_r388911013">PR Review Comment</a>:</p>
<blockquote>
<p><code>FIONREAD</code> returns a non-negative <code>int</code> if it doesn't fail, or it'll fit in a <code>u32</code> if it does. Or, if we want to be super cautious and avoid assuming <code>int</code> is 32-bit, we could widen <code>fionread</code>'s return type here, since the one place that calls it wants a <code>u64</code> anyway. But either way, we can <code>unwrap()</code> the conversion from <code>int</code> here.</p>
</blockquote>



<a name="189898207"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231242%20%5Bwasi-common%5D%3A%20yanix%20now%20returns%20io%3A%3A.../near/189898207" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231242.20.5Bwasi-common.5D.3A.20yanix.20now.20returns.20io.3A.3A.2E.2E.2E.html#189898207">(Mar 06 2020 at 14:34)</a>:</h4>
<p>sunfishcode created <a href="https://github.com/bytecodealliance/wasmtime/pull/1242#discussion_r388930128" target="_blank" title="https://github.com/bytecodealliance/wasmtime/pull/1242#discussion_r388930128">PR Review Comment</a>:</p>
<blockquote>
<p>This can overflow, and it's an error if it does, but: the cookie is an opaque value, and applications aren't supposed to do arithmetic on them or pick their own values or have any awareness of the numeric range of the values. They're just supposed to pass back in the values that we give them. And any value we give them will be convertable back to <code>long</code>, because that's the type the OS gives them to us in. So, this isn't an <code>EOVERFLOW</code>, it's an <code>EINVAL</code>.</p>
</blockquote>



<a name="189898209"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231242%20%5Bwasi-common%5D%3A%20yanix%20now%20returns%20io%3A%3A.../near/189898209" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231242.20.5Bwasi-common.5D.3A.20yanix.20now.20returns.20io.3A.3A.2E.2E.2E.html#189898209">(Mar 06 2020 at 14:34)</a>:</h4>
<p>sunfishcode created <a href="https://github.com/bytecodealliance/wasmtime/pull/1242#discussion_r388911677" target="_blank" title="https://github.com/bytecodealliance/wasmtime/pull/1242#discussion_r388911677">PR Review Comment</a>:</p>
<blockquote>
<p><code>lseek</code> returns an <code>off_t</code>, which we can assume is a non-negative <code>i64</code> if it doesn't fail. So we can <code>unwrap()</code> this conversion.</p>
</blockquote>



<a name="189898210"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231242%20%5Bwasi-common%5D%3A%20yanix%20now%20returns%20io%3A%3A.../near/189898210" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231242.20.5Bwasi-common.5D.3A.20yanix.20now.20returns.20io.3A.3A.2E.2E.2E.html#189898210">(Mar 06 2020 at 14:34)</a>:</h4>
<p>sunfishcode submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/1242#pullrequestreview-370328750" target="_blank" title="https://github.com/bytecodealliance/wasmtime/pull/1242#pullrequestreview-370328750">PR Review</a>.</p>



<a name="189898211"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231242%20%5Bwasi-common%5D%3A%20yanix%20now%20returns%20io%3A%3A.../near/189898211" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231242.20.5Bwasi-common.5D.3A.20yanix.20now.20returns.20io.3A.3A.2E.2E.2E.html#189898211">(Mar 06 2020 at 14:34)</a>:</h4>
<p>sunfishcode created <a href="https://github.com/bytecodealliance/wasmtime/pull/1242#discussion_r388916784" target="_blank" title="https://github.com/bytecodealliance/wasmtime/pull/1242#discussion_r388916784">PR Review Comment</a>:</p>
<blockquote>
<p>This conversion can fail, because it's converting into <code>int</code>. But in that case, the user is providing a dubiously large hint. I don't know specifically how <code>F_RDADVISE</code> works, but offhand, a 2+ GiB advisory read async seems unlikely to help with any kind of performance, so my suggestion here would be to just have this function do nothing if the size overflows here.</p>
</blockquote>



<a name="189898215"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231242%20%5Bwasi-common%5D%3A%20yanix%20now%20returns%20io%3A%3A.../near/189898215" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231242.20.5Bwasi-common.5D.3A.20yanix.20now.20returns.20io.3A.3A.2E.2E.2E.html#189898215">(Mar 06 2020 at 14:34)</a>:</h4>
<p>sunfishcode created <a href="https://github.com/bytecodealliance/wasmtime/pull/1242#discussion_r388912489" target="_blank" title="https://github.com/bytecodealliance/wasmtime/pull/1242#discussion_r388912489">PR Review Comment</a>:</p>
<blockquote>
<p>When <code>poll</code> doesn't fail, its return value is a non-negative <code>int</code>, which will always be convertable to <code>usize</code>, so we can <code>unwrap()</code> here.</p>
</blockquote>



<a name="189904426"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231242%20%5Bwasi-common%5D%3A%20yanix%20now%20returns%20io%3A%3A.../near/189904426" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231242.20.5Bwasi-common.5D.3A.20yanix.20now.20returns.20io.3A.3A.2E.2E.2E.html#189904426">(Mar 06 2020 at 15:37)</a>:</h4>
<p>kubkon created <a href="https://github.com/bytecodealliance/wasmtime/pull/1242#discussion_r388974376" target="_blank" title="https://github.com/bytecodealliance/wasmtime/pull/1242#discussion_r388974376">PR Review Comment</a>:</p>
<blockquote>
<p>Right. I won't widen the return type to <code>u64</code> at this stage, but I'll leave a note (essentially a copy-paste of your excellent explanation) for future consideration should we want to re-visit this. Does it makes sense?</p>
</blockquote>



<a name="189904427"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231242%20%5Bwasi-common%5D%3A%20yanix%20now%20returns%20io%3A%3A.../near/189904427" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231242.20.5Bwasi-common.5D.3A.20yanix.20now.20returns.20io.3A.3A.2E.2E.2E.html#189904427">(Mar 06 2020 at 15:37)</a>:</h4>
<p>kubkon submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/1242#pullrequestreview-370415464" target="_blank" title="https://github.com/bytecodealliance/wasmtime/pull/1242#pullrequestreview-370415464">PR Review</a>.</p>



<a name="189905483"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231242%20%5Bwasi-common%5D%3A%20yanix%20now%20returns%20io%3A%3A.../near/189905483" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231242.20.5Bwasi-common.5D.3A.20yanix.20now.20returns.20io.3A.3A.2E.2E.2E.html#189905483">(Mar 06 2020 at 15:48)</a>:</h4>
<p>kubkon submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/1242#pullrequestreview-370423242" target="_blank" title="https://github.com/bytecodealliance/wasmtime/pull/1242#pullrequestreview-370423242">PR Review</a>.</p>



<a name="189905485"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231242%20%5Bwasi-common%5D%3A%20yanix%20now%20returns%20io%3A%3A.../near/189905485" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231242.20.5Bwasi-common.5D.3A.20yanix.20now.20returns.20io.3A.3A.2E.2E.2E.html#189905485">(Mar 06 2020 at 15:48)</a>:</h4>
<p>kubkon created <a href="https://github.com/bytecodealliance/wasmtime/pull/1242#discussion_r388980307" target="_blank" title="https://github.com/bytecodealliance/wasmtime/pull/1242#discussion_r388980307">PR Review Comment</a>:</p>
<blockquote>
<p>SGTM! If I may expand on this a little bit, how about we <code>log::warn</code> if that's the case before returning early? This should provide some feedback to the user that they may have something wrongly configured, etc.</p>
</blockquote>



<a name="189905967"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231242%20%5Bwasi-common%5D%3A%20yanix%20now%20returns%20io%3A%3A.../near/189905967" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231242.20.5Bwasi-common.5D.3A.20yanix.20now.20returns.20io.3A.3A.2E.2E.2E.html#189905967">(Mar 06 2020 at 15:52)</a>:</h4>
<p>kubkon updated <a href="https://github.com/bytecodealliance/wasmtime/pull/1242" target="_blank" title="https://github.com/bytecodealliance/wasmtime/pull/1242">PR #1242</a> from <code>yanix-io-error</code> to <code>master</code>:</p>
<blockquote>
<p>This PR may seem somewhat controversial at first, but hear me out first. Currently, Yanix would return a custom error that's a wrapper around three other error types returned by various entities inside Rust's <code>libstd</code>. In particular, Yanix's error type would wrap <code>io::Error</code>, <code>num::TryFromIntError</code> and <code>ffi::NulError</code>. It turns out that there is a natural conversion between the first and the last and provided by the standard library, i.e., <code>From&lt;ffi::NulError&gt; for io::Error</code> is provided. So at the surface it may seem that only the first two wrapped error types are worth keeping.</p>
<p>Digging a little bit deeper into <code>libstd</code>, <code>num::TryFromIntError</code> is essentially speaking only a marker that the integral conversion went wrong. The struct implementing this error stores a unit type, and nothing more. It therefore seems like a waste to wrap this particular error when we could unify everything under <code>io::Error</code>. And so, whenever we perform an int conversion, I suggest we simply remap the error to <code>io::Error::from_raw_os_error(libc::EOVERFLOW)</code> since this carries a comparable amount of information.</p>
<p>As a result of completely discarding <code>yanix::Error</code> custom error type, we are invariably simplifying <code>yanix</code> itself, but also allowing <code>wasi-common</code> to simplify in several places as well.</p>
<p>I'm curious to see what you guys reckon!</p>
</blockquote>



<a name="189906761"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231242%20%5Bwasi-common%5D%3A%20yanix%20now%20returns%20io%3A%3A.../near/189906761" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231242.20.5Bwasi-common.5D.3A.20yanix.20now.20returns.20io.3A.3A.2E.2E.2E.html#189906761">(Mar 06 2020 at 16:00)</a>:</h4>
<p>sunfishcode submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/1242#pullrequestreview-370434422" target="_blank" title="https://github.com/bytecodealliance/wasmtime/pull/1242#pullrequestreview-370434422">PR Review</a>.</p>



<a name="189906762"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231242%20%5Bwasi-common%5D%3A%20yanix%20now%20returns%20io%3A%3A.../near/189906762" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231242.20.5Bwasi-common.5D.3A.20yanix.20now.20returns.20io.3A.3A.2E.2E.2E.html#189906762">(Mar 06 2020 at 16:00)</a>:</h4>
<p>sunfishcode created <a href="https://github.com/bytecodealliance/wasmtime/pull/1242#discussion_r388987787" target="_blank" title="https://github.com/bytecodealliance/wasmtime/pull/1242#discussion_r388987787">PR Review Comment</a>:</p>
<blockquote>
<p>Good idea!</p>
</blockquote>



<a name="189907873"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231242%20%5Bwasi-common%5D%3A%20yanix%20now%20returns%20io%3A%3A.../near/189907873" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231242.20.5Bwasi-common.5D.3A.20yanix.20now.20returns.20io.3A.3A.2E.2E.2E.html#189907873">(Mar 06 2020 at 16:11)</a>:</h4>
<p>sunfishcode submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/1242#pullrequestreview-370442770" target="_blank" title="https://github.com/bytecodealliance/wasmtime/pull/1242#pullrequestreview-370442770">PR Review</a>.</p>



<a name="189907874"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231242%20%5Bwasi-common%5D%3A%20yanix%20now%20returns%20io%3A%3A.../near/189907874" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231242.20.5Bwasi-common.5D.3A.20yanix.20now.20returns.20io.3A.3A.2E.2E.2E.html#189907874">(Mar 06 2020 at 16:11)</a>:</h4>
<p>sunfishcode created <a href="https://github.com/bytecodealliance/wasmtime/pull/1242#discussion_r388994891" target="_blank" title="https://github.com/bytecodealliance/wasmtime/pull/1242#discussion_r388994891">PR Review Comment</a>:</p>
<blockquote>
<p>Yes. And actually, there's a subtlety I didn't mention. If you call <code>FIONREAD</code> on a file, it can overflow the <code>int</code>, and at least Linux doesn't check the overflow, but we have code to handle that case in the code that calls this function, and that's what lets us assume that it won't overflow. Fortunately, an <code>unwrap()</code> means that if any OS ever does give us a negative number that we don't expect, it won't pass by silently.</p>
</blockquote>



<a name="189925710"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231242%20%5Bwasi-common%5D%3A%20yanix%20now%20returns%20io%3A%3A.../near/189925710" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231242.20.5Bwasi-common.5D.3A.20yanix.20now.20returns.20io.3A.3A.2E.2E.2E.html#189925710">(Mar 06 2020 at 19:24)</a>:</h4>
<p>alexcrichton submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/1242#pullrequestreview-370569354" target="_blank" title="https://github.com/bytecodealliance/wasmtime/pull/1242#pullrequestreview-370569354">PR Review</a>.</p>



<a name="189925711"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231242%20%5Bwasi-common%5D%3A%20yanix%20now%20returns%20io%3A%3A.../near/189925711" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231242.20.5Bwasi-common.5D.3A.20yanix.20now.20returns.20io.3A.3A.2E.2E.2E.html#189925711">(Mar 06 2020 at 19:24)</a>:</h4>
<p>alexcrichton created <a href="https://github.com/bytecodealliance/wasmtime/pull/1242#discussion_r389096023" target="_blank" title="https://github.com/bytecodealliance/wasmtime/pull/1242#discussion_r389096023">PR Review Comment</a>:</p>
<blockquote>
<p>FWIW I think ideally we would use <code>nread.try_into()?</code> here. I agree with the comment here but "unwrap" is pretty scary when reading this sort of code and feels like something that would best be entirely blanket avoided. If the <code>?</code>-conversion works it's also even more ergonomic than <code>nread.try_into().unwrap()</code>!</p>
<p>Basically I like that there's a comment here to explain why the unwrap is ok, and I don't disagree with it, but I think it would be better idiomatically to use <code>?</code> if we can to propagate errors to consistently "never use unwrap" anywhere in wasi-common. (in theory at least). If the error handling is more verbose than the literal 1-character <code>?</code> symbol though then this is fine.</p>
</blockquote>



<a name="189925730"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231242%20%5Bwasi-common%5D%3A%20yanix%20now%20returns%20io%3A%3A.../near/189925730" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231242.20.5Bwasi-common.5D.3A.20yanix.20now.20returns.20io.3A.3A.2E.2E.2E.html#189925730">(Mar 06 2020 at 19:25)</a>:</h4>
<p>alexcrichton submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/1242#pullrequestreview-370569534" target="_blank" title="https://github.com/bytecodealliance/wasmtime/pull/1242#pullrequestreview-370569534">PR Review</a>.</p>



<a name="189925731"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231242%20%5Bwasi-common%5D%3A%20yanix%20now%20returns%20io%3A%3A.../near/189925731" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231242.20.5Bwasi-common.5D.3A.20yanix.20now.20returns.20io.3A.3A.2E.2E.2E.html#189925731">(Mar 06 2020 at 19:25)</a>:</h4>
<p>alexcrichton created <a href="https://github.com/bytecodealliance/wasmtime/pull/1242#discussion_r389096159" target="_blank" title="https://github.com/bytecodealliance/wasmtime/pull/1242#discussion_r389096159">PR Review Comment</a>:</p>
<blockquote>
<p>Wanna go ahead and fix this for other platforms and remove the <code>: i64</code> here?</p>
</blockquote>



<a name="189925891"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231242%20%5Bwasi-common%5D%3A%20yanix%20now%20returns%20io%3A%3A.../near/189925891" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231242.20.5Bwasi-common.5D.3A.20yanix.20now.20returns.20io.3A.3A.2E.2E.2E.html#189925891">(Mar 06 2020 at 19:27)</a>:</h4>
<p>alexcrichton submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/1242#pullrequestreview-370570895" target="_blank" title="https://github.com/bytecodealliance/wasmtime/pull/1242#pullrequestreview-370570895">PR Review</a>.</p>



<a name="189925892"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231242%20%5Bwasi-common%5D%3A%20yanix%20now%20returns%20io%3A%3A.../near/189925892" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231242.20.5Bwasi-common.5D.3A.20yanix.20now.20returns.20io.3A.3A.2E.2E.2E.html#189925892">(Mar 06 2020 at 19:27)</a>:</h4>
<p>alexcrichton created <a href="https://github.com/bytecodealliance/wasmtime/pull/1242#discussion_r389097205" target="_blank" title="https://github.com/bytecodealliance/wasmtime/pull/1242#discussion_r389097205">PR Review Comment</a>:</p>
<blockquote>
<p>I've seen this pattern in a few places at this point, and the <code>.unwrap()</code> here makes me a little uncomfortable. Could this perhaps be replaced with either a function that returns the last raw os error, or a function that extracts the raw os error and returns some other error if it can't be extracted? For example something like:</p>
<div class="codehilite"><pre><span></span><span class="k">fn</span> <span class="nf">last_raw_os_error</span><span class="p">()</span><span class="w"> </span>-&gt; <span class="kt">i32</span> <span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">Error</span>::<span class="n">last_os_error</span><span class="p">().</span><span class="n">raw_os_error</span><span class="p">().</span><span class="n">unwrap_or</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>


<p>or something like:</p>
<div class="codehilite"><pre><span></span><span class="k">fn</span> <span class="nf">raw_os_error</span><span class="p">(</span><span class="n">err</span>: <span class="kp">&amp;</span><span class="nc">io</span>::<span class="n">Error</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nb">Result</span><span class="o">&lt;</span><span class="kt">i32</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">err</span><span class="p">.</span><span class="n">raw_os_error</span><span class="p">().</span><span class="n">ok_or_else</span><span class="p">(</span><span class="n">Errno</span>::<span class="n">EIO</span><span class="p">)</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>


</blockquote>



<a name="189926732"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231242%20%5Bwasi-common%5D%3A%20yanix%20now%20returns%20io%3A%3A.../near/189926732" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231242.20.5Bwasi-common.5D.3A.20yanix.20now.20returns.20io.3A.3A.2E.2E.2E.html#189926732">(Mar 06 2020 at 19:37)</a>:</h4>
<p>alexcrichton submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/1242#pullrequestreview-370577560" target="_blank" title="https://github.com/bytecodealliance/wasmtime/pull/1242#pullrequestreview-370577560">PR Review</a>.</p>



<a name="189926734"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231242%20%5Bwasi-common%5D%3A%20yanix%20now%20returns%20io%3A%3A.../near/189926734" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231242.20.5Bwasi-common.5D.3A.20yanix.20now.20returns.20io.3A.3A.2E.2E.2E.html#189926734">(Mar 06 2020 at 19:37)</a>:</h4>
<p>alexcrichton created <a href="https://github.com/bytecodealliance/wasmtime/pull/1242#discussion_r389101619" target="_blank" title="https://github.com/bytecodealliance/wasmtime/pull/1242#discussion_r389101619">PR Review Comment</a>:</p>
<blockquote>
<p>@sunfishcode has some counterpoints to this thinking <a href="#narrow/stream/217126-wasmtime/topic/never.20use.20unwrap.3F" title="#narrow/stream/217126-wasmtime/topic/never.20use.20unwrap.3F">on Zulip</a>, so I don't think that we should remove the <code>.unwrap()</code> for now. Let's leave it here and handle the bug report if it ever comes in!</p>
</blockquote>



<a name="189929257"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231242%20%5Bwasi-common%5D%3A%20yanix%20now%20returns%20io%3A%3A.../near/189929257" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231242.20.5Bwasi-common.5D.3A.20yanix.20now.20returns.20io.3A.3A.2E.2E.2E.html#189929257">(Mar 06 2020 at 20:05)</a>:</h4>
<p>sunfishcode submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/1242#pullrequestreview-370593864" target="_blank" title="https://github.com/bytecodealliance/wasmtime/pull/1242#pullrequestreview-370593864">PR Review</a>.</p>



<a name="189929258"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231242%20%5Bwasi-common%5D%3A%20yanix%20now%20returns%20io%3A%3A.../near/189929258" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231242.20.5Bwasi-common.5D.3A.20yanix.20now.20returns.20io.3A.3A.2E.2E.2E.html#189929258">(Mar 06 2020 at 20:05)</a>:</h4>
<p>sunfishcode created <a href="https://github.com/bytecodealliance/wasmtime/pull/1242#discussion_r389118087" target="_blank" title="https://github.com/bytecodealliance/wasmtime/pull/1242#discussion_r389118087">PR Review Comment</a>:</p>
<blockquote>
<p>The <a href="https://doc.rust-lang.org/std/io/struct.Error.html#method.raw_os_error" target="_blank" title="https://doc.rust-lang.org/std/io/struct.Error.html#method.raw_os_error">docs for <code>raw_os_error</code></a> guarantee that it'll return <code>Some</code> on an error returned from <code>last_os_error</code>, so the <code>unwrap</code> is guaranteed to succeed.</p>
<p>It doesn't matter so much in <code>isatty</code> here, but across wasi-common we often have subtle reasoning about specific error codes, so introducing new conditions under which errors like <code>EIO</code> or even <code>-1</code> could materialize makes that tricky.</p>
</blockquote>



<a name="189930450"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231242%20%5Bwasi-common%5D%3A%20yanix%20now%20returns%20io%3A%3A.../near/189930450" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231242.20.5Bwasi-common.5D.3A.20yanix.20now.20returns.20io.3A.3A.2E.2E.2E.html#189930450">(Mar 06 2020 at 20:22)</a>:</h4>
<p>kubkon submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/1242#pullrequestreview-370603083" target="_blank" title="https://github.com/bytecodealliance/wasmtime/pull/1242#pullrequestreview-370603083">PR Review</a>.</p>



<a name="189930451"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231242%20%5Bwasi-common%5D%3A%20yanix%20now%20returns%20io%3A%3A.../near/189930451" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231242.20.5Bwasi-common.5D.3A.20yanix.20now.20returns.20io.3A.3A.2E.2E.2E.html#189930451">(Mar 06 2020 at 20:22)</a>:</h4>
<p>kubkon created <a href="https://github.com/bytecodealliance/wasmtime/pull/1242#discussion_r389125379" target="_blank" title="https://github.com/bytecodealliance/wasmtime/pull/1242#discussion_r389125379">PR Review Comment</a>:</p>
<blockquote>
<p>FWIW, both of you guys make really good points. So in order to strike a middle ground, I've made sure to leave comments at every occurrence of <code>unwrap</code>.</p>
<p>OK, so ultimately let's stick with <code>unwrap</code>s for now, until we get some bug reports. <span aria-label="+1" class="emoji emoji-1f44d" role="img" title="+1">:+1:</span></p>
</blockquote>



<a name="189930505"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231242%20%5Bwasi-common%5D%3A%20yanix%20now%20returns%20io%3A%3A.../near/189930505" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231242.20.5Bwasi-common.5D.3A.20yanix.20now.20returns.20io.3A.3A.2E.2E.2E.html#189930505">(Mar 06 2020 at 20:23)</a>:</h4>
<p>kubkon submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/1242#pullrequestreview-370603726" target="_blank" title="https://github.com/bytecodealliance/wasmtime/pull/1242#pullrequestreview-370603726">PR Review</a>.</p>



<a name="189930506"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231242%20%5Bwasi-common%5D%3A%20yanix%20now%20returns%20io%3A%3A.../near/189930506" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231242.20.5Bwasi-common.5D.3A.20yanix.20now.20returns.20io.3A.3A.2E.2E.2E.html#189930506">(Mar 06 2020 at 20:23)</a>:</h4>
<p>kubkon created <a href="https://github.com/bytecodealliance/wasmtime/pull/1242#discussion_r389125892" target="_blank" title="https://github.com/bytecodealliance/wasmtime/pull/1242#discussion_r389125892">PR Review Comment</a>:</p>
<blockquote>
<p>Ah, you're probably referring to #1231. Good call, lemme do just that!</p>
</blockquote>



<a name="189930889"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231242%20%5Bwasi-common%5D%3A%20yanix%20now%20returns%20io%3A%3A.../near/189930889" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231242.20.5Bwasi-common.5D.3A.20yanix.20now.20returns.20io.3A.3A.2E.2E.2E.html#189930889">(Mar 06 2020 at 20:28)</a>:</h4>
<p>kubkon submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/1242#pullrequestreview-370606082" target="_blank" title="https://github.com/bytecodealliance/wasmtime/pull/1242#pullrequestreview-370606082">PR Review</a>.</p>



<a name="189930890"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231242%20%5Bwasi-common%5D%3A%20yanix%20now%20returns%20io%3A%3A.../near/189930890" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231242.20.5Bwasi-common.5D.3A.20yanix.20now.20returns.20io.3A.3A.2E.2E.2E.html#189930890">(Mar 06 2020 at 20:28)</a>:</h4>
<p>kubkon created <a href="https://github.com/bytecodealliance/wasmtime/pull/1242#discussion_r389127850" target="_blank" title="https://github.com/bytecodealliance/wasmtime/pull/1242#discussion_r389127850">PR Review Comment</a>:</p>
<blockquote>
<p>As @sunfishcode pointed out, according to the docs, this cannot ever fail as we only ever call <code>unwrap</code> after <code>io::Error</code> was populated with a raw OS error, either with <code>io::Error::last_os_error()</code> or <code>io::Error::from_raw_os_error()</code>. I do agree with you @alexcrichton that this is pretty subtle in the sense that we're relying on this prior knowledge that we've actually done just that. If it wasn't the case, we'd in a lot of trouble. Then again, since <code>yanix</code>, and in general, the syscall impl code in <code>wasi-common</code> _only_ (at least for now!) deals with raw OS errno values, this is safe. And since we're constantly evolving WASI, having panics around those calls might be a good thing to catch bugs that otherwise would be silently swallowed as @sunfishcode pointed out.</p>
</blockquote>



<a name="189930905"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231242%20%5Bwasi-common%5D%3A%20yanix%20now%20returns%20io%3A%3A.../near/189930905" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231242.20.5Bwasi-common.5D.3A.20yanix.20now.20returns.20io.3A.3A.2E.2E.2E.html#189930905">(Mar 06 2020 at 20:28)</a>:</h4>
<p>kubkon edited <a href="https://github.com/bytecodealliance/wasmtime/pull/1242#discussion_r389127850" target="_blank" title="https://github.com/bytecodealliance/wasmtime/pull/1242#discussion_r389127850">PR Review Comment</a>.</p>



<a name="189932502"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231242%20%5Bwasi-common%5D%3A%20yanix%20now%20returns%20io%3A%3A.../near/189932502" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231242.20.5Bwasi-common.5D.3A.20yanix.20now.20returns.20io.3A.3A.2E.2E.2E.html#189932502">(Mar 06 2020 at 20:48)</a>:</h4>
<p>kubkon updated <a href="https://github.com/bytecodealliance/wasmtime/pull/1242" target="_blank" title="https://github.com/bytecodealliance/wasmtime/pull/1242">PR #1242</a> from <code>yanix-io-error</code> to <code>master</code>:</p>
<blockquote>
<p>This PR may seem somewhat controversial at first, but hear me out first. Currently, Yanix would return a custom error that's a wrapper around three other error types returned by various entities inside Rust's <code>libstd</code>. In particular, Yanix's error type would wrap <code>io::Error</code>, <code>num::TryFromIntError</code> and <code>ffi::NulError</code>. It turns out that there is a natural conversion between the first and the last and provided by the standard library, i.e., <code>From&lt;ffi::NulError&gt; for io::Error</code> is provided. So at the surface it may seem that only the first two wrapped error types are worth keeping.</p>
<p>Digging a little bit deeper into <code>libstd</code>, <code>num::TryFromIntError</code> is essentially speaking only a marker that the integral conversion went wrong. The struct implementing this error stores a unit type, and nothing more. It therefore seems like a waste to wrap this particular error when we could unify everything under <code>io::Error</code>. And so, whenever we perform an int conversion, I suggest we simply remap the error to <code>io::Error::from_raw_os_error(libc::EOVERFLOW)</code> since this carries a comparable amount of information.</p>
<p>As a result of completely discarding <code>yanix::Error</code> custom error type, we are invariably simplifying <code>yanix</code> itself, but also allowing <code>wasi-common</code> to simplify in several places as well.</p>
<p>I'm curious to see what you guys reckon!</p>
</blockquote>



<a name="189932540"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231242%20%5Bwasi-common%5D%3A%20yanix%20now%20returns%20io%3A%3A.../near/189932540" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231242.20.5Bwasi-common.5D.3A.20yanix.20now.20returns.20io.3A.3A.2E.2E.2E.html#189932540">(Mar 06 2020 at 20:49)</a>:</h4>
<p>kubkon submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/1242#pullrequestreview-370617155" target="_blank" title="https://github.com/bytecodealliance/wasmtime/pull/1242#pullrequestreview-370617155">PR Review</a>.</p>



<a name="189932541"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231242%20%5Bwasi-common%5D%3A%20yanix%20now%20returns%20io%3A%3A.../near/189932541" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231242.20.5Bwasi-common.5D.3A.20yanix.20now.20returns.20io.3A.3A.2E.2E.2E.html#189932541">(Mar 06 2020 at 20:49)</a>:</h4>
<p>kubkon created <a href="https://github.com/bytecodealliance/wasmtime/pull/1242#discussion_r389136635" target="_blank" title="https://github.com/bytecodealliance/wasmtime/pull/1242#discussion_r389136635">PR Review Comment</a>:</p>
<blockquote>
<p>Done in ed98a80.</p>
</blockquote>



<a name="189936045"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231242%20%5Bwasi-common%5D%3A%20yanix%20now%20returns%20io%3A%3A.../near/189936045" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231242.20.5Bwasi-common.5D.3A.20yanix.20now.20returns.20io.3A.3A.2E.2E.2E.html#189936045">(Mar 06 2020 at 21:24)</a>:</h4>
<p>alexcrichton submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/1242#pullrequestreview-370635824" target="_blank" title="https://github.com/bytecodealliance/wasmtime/pull/1242#pullrequestreview-370635824">PR Review</a>.</p>



<a name="189938802"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231242%20%5Bwasi-common%5D%3A%20yanix%20now%20returns%20io%3A%3A.../near/189938802" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231242.20.5Bwasi-common.5D.3A.20yanix.20now.20returns.20io.3A.3A.2E.2E.2E.html#189938802">(Mar 06 2020 at 21:59)</a>:</h4>
<p>sunfishcode submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/1242#pullrequestreview-370652855" target="_blank" title="https://github.com/bytecodealliance/wasmtime/pull/1242#pullrequestreview-370652855">PR Review</a>.</p>



<a name="189940500"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231242%20%5Bwasi-common%5D%3A%20yanix%20now%20returns%20io%3A%3A.../near/189940500" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231242.20.5Bwasi-common.5D.3A.20yanix.20now.20returns.20io.3A.3A.2E.2E.2E.html#189940500">(Mar 06 2020 at 22:20)</a>:</h4>
<p>sunfishcode merged <a href="https://github.com/bytecodealliance/wasmtime/pull/1242" target="_blank" title="https://github.com/bytecodealliance/wasmtime/pull/1242">PR #1242</a>.</p>



<hr><p>Last updated: Jan 20 2025 at 06:04 UTC</p>
</html>