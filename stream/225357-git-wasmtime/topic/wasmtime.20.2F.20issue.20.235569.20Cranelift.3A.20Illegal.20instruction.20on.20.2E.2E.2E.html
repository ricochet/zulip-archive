<html>
<head><meta charset="utf-8"><title>wasmtime / issue #5569 Cranelift: Illegal instruction on ... · git-wasmtime · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/index.html">git-wasmtime</a></h2>
<h3>Topic: <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.235569.20Cranelift.3A.20Illegal.20instruction.20on.20.2E.2E.2E.html">wasmtime / issue #5569 Cranelift: Illegal instruction on ...</a></h3>

<hr>

<base href="https://bytecodealliance.zulipchat.com">

<head><link href="https://bytecodealliance.github.io/zulip-archive/style.css" rel="stylesheet"></head>

<a name="321121238"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%235569%20Cranelift%3A%20Illegal%20instruction%20on%20.../near/321121238" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.235569.20Cranelift.3A.20Illegal.20instruction.20on.20.2E.2E.2E.html#321121238">(Jan 13 2023 at 10:07)</a>:</h4>
<p>afonso360 opened <a href="https://github.com/bytecodealliance/wasmtime/issues/5569">issue #5569</a>:</p>
<blockquote>
<p><span aria-label="wave" class="emoji emoji-1f44b" role="img" title="wave">:wave:</span> Hey,</p>
<p>Fuzzgen found this a week or so ago, but I haven't been able to minimize this. Whenever I try to remove seemingly any instruction the test case passes.</p>
<p>I'm going to keep running fuzzgen with a smaller <code>max_len</code> to try to find a smaller example.</p>
<h3><code>.clif</code> Test Case</h3>
<p><a href="https://github.com/bytecodealliance/wasmtime/files/10410424/testcase.clif.txt">testcase.clif.txt</a></p>
<h3>Steps to Reproduce</h3>
<ul>
<li><code>clif-util test ./the-above.clif</code></li>
</ul>
<h3>Expected Results</h3>
<p>The test to pass</p>
<h3>Actual Results</h3>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="n">afonso</span><span class="o">@</span><span class="n">DESKTOP</span><span class="o">-</span><span class="n">VSTS4BC</span>:<span class="o">~/</span><span class="n">git</span><span class="o">/</span><span class="n">wasmtime</span><span class="o">/</span><span class="n">cranelift</span><span class="cp">$</span><span class="w"> </span><span class="n">cargo</span><span class="w"> </span><span class="n">run</span><span class="w"> </span><span class="o">--</span><span class="n">target</span><span class="w"> </span><span class="n">riscv64gc</span><span class="o">-</span><span class="n">unknown</span><span class="o">-</span><span class="n">linux</span><span class="o">-</span><span class="n">gnu</span><span class="w"> </span><span class="o">--</span><span class="w"> </span><span class="n">test</span><span class="w"> </span><span class="p">.</span><span class="o">/</span><span class="n">lmao</span><span class="p">.</span><span class="n">clif</span><span class="w"></span>
<span class="w">    </span><span class="n">Finished</span><span class="w"> </span><span class="n">dev</span><span class="w"> </span><span class="p">[</span><span class="n">unoptimized</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">debuginfo</span><span class="p">]</span><span class="w"> </span><span class="n">target</span><span class="p">(</span><span class="n">s</span><span class="p">)</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="mf">0.16</span><span class="n">s</span><span class="w"></span>
<span class="w">     </span><span class="n">Running</span><span class="w"> </span><span class="err">`</span><span class="n">qemu</span><span class="o">-</span><span class="n">riscv64</span><span class="w"> </span><span class="o">-</span><span class="n">L</span><span class="w"> </span><span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">riscv64</span><span class="o">-</span><span class="n">linux</span><span class="o">-</span><span class="n">gnu</span><span class="w"> </span><span class="o">-</span><span class="n">E</span><span class="w"> </span><span class="n">LD_LIBRARY_PATH</span><span class="o">=/</span><span class="n">usr</span><span class="o">/</span><span class="n">riscv64</span><span class="o">-</span><span class="n">linux</span><span class="o">-</span><span class="n">gnu</span><span class="o">/</span><span class="n">lib</span><span class="w"> </span><span class="o">/</span><span class="n">home</span><span class="o">/</span><span class="n">afonso</span><span class="o">/</span><span class="n">git</span><span class="o">/</span><span class="n">wasmtime</span><span class="o">/</span><span class="n">target</span><span class="o">/</span><span class="n">riscv64gc</span><span class="o">-</span><span class="n">unknown</span><span class="o">-</span><span class="n">linux</span><span class="o">-</span><span class="n">gnu</span><span class="o">/</span><span class="n">debug</span><span class="o">/</span><span class="n">clif</span><span class="o">-</span><span class="n">util</span><span class="w"> </span><span class="n">test</span><span class="w"> </span><span class="p">.</span><span class="o">/</span><span class="n">lmao</span><span class="p">.</span><span class="n">clif</span><span class="err">`</span><span class="w"></span>
<span class="n">Illegal</span><span class="w"> </span><span class="n">instruction</span><span class="w"></span>
</code></pre></div>
<h3>Versions and Environment</h3>
<p>Cranelift version or commit: main<br>
Operating system: linux<br>
Architecture: riscv64</p>
<h3>Extra Info</h3>
<h4><a href="https://github.com/bytecodealliance/wasmtime/files/10410437/disassmbly.txt">Disassembly</a></h4>
<p>Running this under GDB it crashes in:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="w">   </span><span class="mh">0x3ff7fd5b70</span>:        <span class="nc">bne</span><span class="w">     </span><span class="n">zero</span><span class="p">,</span><span class="n">a7</span><span class="p">,</span><span class="mh">0x3ff7fd5b78</span><span class="w"></span>
<span class="w">   </span><span class="mh">0x3ff7fd5b74</span>:        <span class="nc">unimp</span><span class="w"></span>
<span class="w">   </span><span class="mh">0x3ff7fd5b76</span>:        <span class="nc">unimp</span><span class="w"></span>
<span class="w">   </span><span class="mh">0x3ff7fd5b78</span>:        <span class="nc">divw</span><span class="w">    </span><span class="n">t2</span><span class="p">,</span><span class="n">a6</span><span class="p">,</span><span class="n">a7</span><span class="w"></span>
<span class="w">   </span><span class="mh">0x3ff7fd5b7c</span>:        <span class="nc">feq</span><span class="p">.</span><span class="n">d</span><span class="w">   </span><span class="n">a2</span><span class="p">,</span><span class="n">fa0</span><span class="p">,</span><span class="n">fa0</span><span class="w"></span>
<span class="w">   </span><span class="mh">0x3ff7fd5b80</span>:        <span class="nc">beqz</span><span class="w">    </span><span class="n">a2</span><span class="p">,</span><span class="mh">0x3ff7fd5b90</span><span class="w"></span>
<span class="w">   </span><span class="mh">0x3ff7fd5b84</span>:        <span class="nc">auipc</span><span class="w">   </span><span class="n">t6</span><span class="p">,</span><span class="mh">0x0</span><span class="w"></span>
<span class="w">   </span><span class="mh">0x3ff7fd5b88</span>:        <span class="nc">ld</span><span class="w">      </span><span class="n">t6</span><span class="p">,</span><span class="mi">12</span><span class="p">(</span><span class="n">t6</span><span class="p">)</span><span class="w"></span>
<span class="w">   </span><span class="mh">0x3ff7fd5b8c</span>:        <span class="nc">j</span><span class="w">       </span><span class="mh">0x3ff7fd5b98</span><span class="w"></span>
<span class="w">   </span><span class="mh">0x3ff7fd5b90</span>:        <span class="nc">auipc</span><span class="w">   </span><span class="n">t6</span><span class="p">,</span><span class="mh">0x0</span><span class="w"></span>
<span class="w">   </span><span class="mh">0x3ff7fd5b94</span>:        <span class="nc">jr</span><span class="w">      </span><span class="mi">48</span><span class="p">(</span><span class="n">t6</span><span class="p">)</span><span class="w"></span>
<span class="o">=&gt;</span><span class="w"> </span><span class="mh">0x3ff7fd5b98</span>:        <span class="nc">unimp</span><span class="w"></span>
<span class="w">   </span><span class="mh">0x3ff7fd5b9a</span>:        <span class="nc">unimp</span><span class="w"></span>
<span class="w">   </span><span class="mh">0x3ff7fd5b9c</span>:        <span class="nc">unimp</span><span class="w"></span>
<span class="w">   </span><span class="mh">0x3ff7fd5b9e</span>:        <span class="nc">lw</span><span class="w">      </span><span class="n">s0</span><span class="p">,</span><span class="mi">4</span><span class="p">(</span><span class="n">a4</span><span class="p">)</span><span class="w"></span>
<span class="w">   </span><span class="mh">0x3ff7fd5ba0</span>:        <span class="nc">fmv</span><span class="p">.</span><span class="n">d</span><span class="p">.</span><span class="n">x</span><span class="w"> </span><span class="n">fa3</span><span class="p">,</span><span class="n">t6</span><span class="w"></span>
<span class="w">   </span><span class="mh">0x3ff7fd5ba4</span>:        <span class="nc">fabs</span><span class="p">.</span><span class="n">d</span><span class="w">  </span><span class="n">fa1</span><span class="p">,</span><span class="n">fa0</span><span class="w"></span>
<span class="w">   </span><span class="mh">0x3ff7fd5ba8</span>:        <span class="nc">flt</span><span class="p">.</span><span class="n">d</span><span class="w">   </span><span class="n">a2</span><span class="p">,</span><span class="n">fa3</span><span class="p">,</span><span class="n">fa1</span><span class="w"></span>
<span class="w">   </span><span class="mh">0x3ff7fd5bac</span>:        <span class="nc">bnez</span><span class="w">    </span><span class="n">a2</span><span class="p">,</span><span class="mh">0x3ff7fd5bc8</span><span class="w"></span>
<span class="w">   </span><span class="mh">0x3ff7fd5bb0</span>:        <span class="nc">fcvt</span><span class="p">.</span><span class="n">l</span><span class="p">.</span><span class="n">d</span><span class="w">        </span><span class="n">a2</span><span class="p">,</span><span class="n">fa0</span><span class="p">,</span><span class="n">rne</span><span class="w"></span>
</code></pre></div>
<p>The start of the function is at <code>0x3ff7fd4000</code>, so this is at offset <code>0x1B98</code> in the disassembly. Which appears to be a embedded constant?</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="mi">1</span><span class="n">b88</span>:   <span class="mi">83</span><span class="w"> </span><span class="n">bf</span><span class="w"> </span><span class="n">cf</span><span class="w"> </span><span class="mi">00</span><span class="w">             </span><span class="n">ld</span><span class="w">      </span><span class="n">t6</span><span class="p">,</span><span class="w"> </span><span class="mh">0xc</span><span class="p">(</span><span class="n">t6</span><span class="p">)</span><span class="w"></span>
<span class="mi">1</span><span class="n">b8c</span>:   <span class="mi">6</span><span class="n">f</span><span class="w"> </span><span class="mi">00</span><span class="w"> </span><span class="n">c0</span><span class="w"> </span><span class="mi">00</span><span class="w">             </span><span class="n">j</span><span class="w">       </span><span class="mh">0xc</span><span class="w"></span>
<span class="mi">1</span><span class="n">b90</span>:   <span class="mi">97</span><span class="w"> </span><span class="mi">0</span><span class="n">f</span><span class="w"> </span><span class="mi">00</span><span class="w"> </span><span class="mi">00</span><span class="w">             </span><span class="n">auipc</span><span class="w">   </span><span class="n">t6</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="w"></span>
<span class="mi">1</span><span class="n">b94</span>:   <span class="mi">67</span><span class="w"> </span><span class="mi">80</span><span class="w"> </span><span class="mi">0</span><span class="n">f</span><span class="w"> </span><span class="mi">03</span><span class="w">             </span><span class="n">jalr</span><span class="w">    </span><span class="n">zero</span><span class="p">,</span><span class="w"> </span><span class="n">t6</span><span class="p">,</span><span class="w"> </span><span class="mh">0x30</span><span class="w"></span>
<span class="mi">1</span><span class="n">b98</span>:   <span class="mi">00</span><span class="w"> </span><span class="mi">00</span><span class="w"> </span><span class="mi">00</span><span class="w"> </span><span class="mi">00</span><span class="w">             </span><span class="p">.</span><span class="n">byte</span><span class="w">   </span><span class="mh">0x00</span><span class="p">,</span><span class="w"> </span><span class="mh">0x00</span><span class="p">,</span><span class="w"> </span><span class="mh">0x00</span><span class="p">,</span><span class="w"> </span><span class="mh">0x00</span><span class="w"></span>
<span class="mi">1</span><span class="n">b9c</span>:   <span class="mi">00</span><span class="w"> </span><span class="mi">00</span><span class="w"> </span><span class="mi">40</span><span class="w"> </span><span class="mi">43</span><span class="w">             </span><span class="p">.</span><span class="n">byte</span><span class="w">   </span><span class="mh">0x00</span><span class="p">,</span><span class="w"> </span><span class="mh">0x00</span><span class="p">,</span><span class="w"> </span><span class="mh">0x40</span><span class="p">,</span><span class="w"> </span><span class="mh">0x43</span><span class="w"></span>
<span class="mi">1</span><span class="n">ba0</span>:   <span class="nc">d3</span><span class="w"> </span><span class="mi">86</span><span class="w"> </span><span class="mi">0</span><span class="n">f</span><span class="w"> </span><span class="n">f2</span><span class="w">             </span><span class="n">fmv</span><span class="p">.</span><span class="n">d</span><span class="p">.</span><span class="n">x</span><span class="w"> </span><span class="n">fa3</span><span class="p">,</span><span class="w"> </span><span class="n">t6</span><span class="w"></span>
</code></pre></div>
<p>I suspect the issue here is that the instruction at <code>1b8c</code> is a jump directly into the embedded constant at <code>1b98</code>.</p>
<p>Looking at the trace logs for this range, it looks like we are emitting a veneer right at that offset? And maybe we have a constant offset in some branch that is causing this.</p>
<p><code>1b8c = 7052</code><br>
<code>1b98 = 7064</code></p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="w"> </span><span class="n">TRACE</span><span class="w"> </span><span class="n">cranelift_codegen</span>::<span class="n">machinst</span>::<span class="n">buffer</span><span class="w">     </span><span class="o">&gt;</span><span class="w"> </span><span class="n">emit_island</span>: <span class="nc">fixup</span><span class="w"> </span><span class="n">MachLabelFixup</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">label</span>: <span class="nc">MachLabel</span><span class="p">(</span><span class="mi">529</span><span class="p">),</span><span class="w"> </span><span class="n">offset</span>: <span class="mi">7040</span><span class="p">,</span><span class="w"> </span><span class="n">kind</span>: <span class="nc">B12</span><span class="w"> </span><span class="p">}</span><span class="w"></span>
<span class="w"> </span><span class="n">TRACE</span><span class="w"> </span><span class="n">cranelift_codegen</span>::<span class="n">machinst</span>::<span class="n">buffer</span><span class="w">     </span><span class="o">&gt;</span><span class="w"> </span><span class="n">MachBuffer</span>: <span class="nc">align</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="mi">4</span><span class="w"></span>
<span class="w"> </span><span class="n">TRACE</span><span class="w"> </span><span class="n">cranelift_codegen</span>::<span class="n">machinst</span>::<span class="n">buffer</span><span class="w">     </span><span class="o">&gt;</span><span class="w"> </span><span class="n">making</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="n">veneer</span><span class="w"> </span><span class="n">at</span><span class="w"> </span><span class="mi">7056</span><span class="w"></span>
<span class="w"> </span><span class="n">TRACE</span><span class="w"> </span><span class="n">cranelift_codegen</span>::<span class="n">machinst</span>::<span class="n">buffer</span><span class="w">     </span><span class="o">&gt;</span><span class="w"> </span><span class="n">patching</span><span class="w"> </span><span class="n">original</span><span class="w"> </span><span class="n">at</span><span class="w"> </span><span class="n">offset</span><span class="w"> </span><span class="mi">7040</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">veneer</span><span class="w"> </span><span class="n">offset</span><span class="w"> </span><span class="mi">7056</span><span class="w"></span>
<span class="w"> </span><span class="n">TRACE</span><span class="w"> </span><span class="n">cranelift_codegen</span>::<span class="n">machinst</span>::<span class="n">buffer</span><span class="w">     </span><span class="o">&gt;</span><span class="w"> </span><span class="n">MachBuffer</span>: <span class="nc">put</span><span class="w"> </span><span class="n">data</span><span class="w"> </span><span class="o">@</span><span class="w"> </span><span class="mi">7056</span>: <span class="nc">len</span><span class="w"> </span><span class="mi">8</span><span class="w"></span>
<span class="w"> </span><span class="n">TRACE</span><span class="w"> </span><span class="n">cranelift_codegen</span>::<span class="n">machinst</span>::<span class="n">buffer</span><span class="w">     </span><span class="o">&gt;</span><span class="w"> </span><span class="n">generated</span><span class="w"> </span><span class="n">veneer</span><span class="p">;</span><span class="w"> </span><span class="n">fixup</span><span class="w"> </span><span class="n">offset</span><span class="w"> </span><span class="mi">7056</span><span class="p">,</span><span class="w"> </span><span class="n">label_use</span><span class="w"> </span><span class="n">PCRel32</span><span class="w"></span>
<span class="w"> </span><span class="n">TRACE</span><span class="w"> </span><span class="n">cranelift_codegen</span>::<span class="n">machinst</span>::<span class="n">buffer</span><span class="w">     </span><span class="o">&gt;</span><span class="w"> </span><span class="n">MachBuffer</span>: <span class="nc">use_label_at_offset</span>: <span class="nc">offset</span><span class="w"> </span><span class="mi">7056</span><span class="w"> </span><span class="n">label</span><span class="w"> </span><span class="n">MachLabel</span><span class="p">(</span><span class="mi">529</span><span class="p">)</span><span class="w"> </span><span class="n">kind</span><span class="w"> </span><span class="n">PCRel32</span><span class="w"></span>
<span class="w"> </span><span class="n">TRACE</span><span class="w"> </span><span class="n">cranelift_codegen</span>::<span class="n">machinst</span>::<span class="n">buffer</span><span class="w">     </span><span class="o">&gt;</span><span class="w"> </span><span class="n">MachBuffer</span>: <span class="nc">put</span><span class="w"> </span><span class="n">data</span><span class="w"> </span><span class="o">@</span><span class="w"> </span><span class="mi">7064</span>: <span class="nc">len</span><span class="w"> </span><span class="mi">8</span><span class="w"></span>
<span class="w"> </span><span class="n">TRACE</span><span class="w"> </span><span class="n">cranelift_codegen</span>::<span class="n">machinst</span>::<span class="n">buffer</span><span class="w">     </span><span class="o">&gt;</span><span class="w"> </span><span class="n">MachBuffer</span>: <span class="nc">put</span><span class="w"> </span><span class="mi">32</span><span class="o">-</span><span class="n">bit</span><span class="w"> </span><span class="n">word</span><span class="w"> </span><span class="o">@</span><span class="w"> </span><span class="mi">7072</span>: <span class="nc">f20f86d3</span><span class="w"></span>
<span class="w"> </span><span class="n">TRACE</span><span class="w"> </span><span class="n">cranelift_codegen</span>::<span class="n">machinst</span>::<span class="n">buffer</span><span class="w">     </span><span class="o">&gt;</span><span class="w"> </span><span class="n">MachBuffer</span>: <span class="nc">put</span><span class="w"> </span><span class="mi">32</span><span class="o">-</span><span class="n">bit</span><span class="w"> </span><span class="n">word</span><span class="w"> </span><span class="o">@</span><span class="w"> </span><span class="mi">7076</span>: <span class="mi">22</span><span class="n">a525d3</span><span class="w"></span>
<span class="w"> </span><span class="n">TRACE</span><span class="w"> </span><span class="n">cranelift_codegen</span>::<span class="n">machinst</span>::<span class="n">buffer</span><span class="w">     </span><span class="o">&gt;</span><span class="w"> </span><span class="n">MachBuffer</span>: <span class="nc">put</span><span class="w"> </span><span class="mi">32</span><span class="o">-</span><span class="n">bit</span><span class="w"> </span><span class="n">word</span><span class="w"> </span><span class="o">@</span><span class="w"> </span><span class="mi">7080</span>: <span class="nc">a2b69653</span><span class="w"></span>
<span class="w"> </span><span class="n">TRACE</span><span class="w"> </span><span class="n">cranelift_codegen</span>::<span class="n">machinst</span>::<span class="n">buffer</span><span class="w">     </span><span class="o">&gt;</span><span class="w"> </span><span class="n">MachBuffer</span>: <span class="nc">use_label_at_offset</span>: <span class="nc">offset</span><span class="w"> </span><span class="mi">7084</span><span class="w"> </span><span class="n">label</span><span class="w"> </span><span class="n">MachLabel</span><span class="p">(</span><span class="mi">530</span><span class="p">)</span><span class="w"> </span><span class="n">kind</span><span class="w"> </span><span class="n">B12</span><span class="w"></span>
</code></pre></div>
<p>I'm not too sure how to translate these offsets into an actual clif instruction that is causing this issue.</p>
</blockquote>



<a name="321121240"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%235569%20Cranelift%3A%20Illegal%20instruction%20on%20.../near/321121240" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.235569.20Cranelift.3A.20Illegal.20instruction.20on.20.2E.2E.2E.html#321121240">(Jan 13 2023 at 10:07)</a>:</h4>
<p>afonso360 labeled <a href="https://github.com/bytecodealliance/wasmtime/issues/5569">issue #5569</a>:</p>
<blockquote>
<p><span aria-label="wave" class="emoji emoji-1f44b" role="img" title="wave">:wave:</span> Hey,</p>
<p>Fuzzgen found this a week or so ago, but I haven't been able to minimize this. Whenever I try to remove seemingly any instruction the test case passes.</p>
<p>I'm going to keep running fuzzgen with a smaller <code>max_len</code> to try to find a smaller example.</p>
<h3><code>.clif</code> Test Case</h3>
<p><a href="https://github.com/bytecodealliance/wasmtime/files/10410424/testcase.clif.txt">testcase.clif.txt</a></p>
<h3>Steps to Reproduce</h3>
<ul>
<li><code>clif-util test ./the-above.clif</code></li>
</ul>
<h3>Expected Results</h3>
<p>The test to pass</p>
<h3>Actual Results</h3>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="n">afonso</span><span class="o">@</span><span class="n">DESKTOP</span><span class="o">-</span><span class="n">VSTS4BC</span>:<span class="o">~/</span><span class="n">git</span><span class="o">/</span><span class="n">wasmtime</span><span class="o">/</span><span class="n">cranelift</span><span class="cp">$</span><span class="w"> </span><span class="n">cargo</span><span class="w"> </span><span class="n">run</span><span class="w"> </span><span class="o">--</span><span class="n">target</span><span class="w"> </span><span class="n">riscv64gc</span><span class="o">-</span><span class="n">unknown</span><span class="o">-</span><span class="n">linux</span><span class="o">-</span><span class="n">gnu</span><span class="w"> </span><span class="o">--</span><span class="w"> </span><span class="n">test</span><span class="w"> </span><span class="p">.</span><span class="o">/</span><span class="n">lmao</span><span class="p">.</span><span class="n">clif</span><span class="w"></span>
<span class="w">    </span><span class="n">Finished</span><span class="w"> </span><span class="n">dev</span><span class="w"> </span><span class="p">[</span><span class="n">unoptimized</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">debuginfo</span><span class="p">]</span><span class="w"> </span><span class="n">target</span><span class="p">(</span><span class="n">s</span><span class="p">)</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="mf">0.16</span><span class="n">s</span><span class="w"></span>
<span class="w">     </span><span class="n">Running</span><span class="w"> </span><span class="err">`</span><span class="n">qemu</span><span class="o">-</span><span class="n">riscv64</span><span class="w"> </span><span class="o">-</span><span class="n">L</span><span class="w"> </span><span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">riscv64</span><span class="o">-</span><span class="n">linux</span><span class="o">-</span><span class="n">gnu</span><span class="w"> </span><span class="o">-</span><span class="n">E</span><span class="w"> </span><span class="n">LD_LIBRARY_PATH</span><span class="o">=/</span><span class="n">usr</span><span class="o">/</span><span class="n">riscv64</span><span class="o">-</span><span class="n">linux</span><span class="o">-</span><span class="n">gnu</span><span class="o">/</span><span class="n">lib</span><span class="w"> </span><span class="o">/</span><span class="n">home</span><span class="o">/</span><span class="n">afonso</span><span class="o">/</span><span class="n">git</span><span class="o">/</span><span class="n">wasmtime</span><span class="o">/</span><span class="n">target</span><span class="o">/</span><span class="n">riscv64gc</span><span class="o">-</span><span class="n">unknown</span><span class="o">-</span><span class="n">linux</span><span class="o">-</span><span class="n">gnu</span><span class="o">/</span><span class="n">debug</span><span class="o">/</span><span class="n">clif</span><span class="o">-</span><span class="n">util</span><span class="w"> </span><span class="n">test</span><span class="w"> </span><span class="p">.</span><span class="o">/</span><span class="n">lmao</span><span class="p">.</span><span class="n">clif</span><span class="err">`</span><span class="w"></span>
<span class="n">Illegal</span><span class="w"> </span><span class="n">instruction</span><span class="w"></span>
</code></pre></div>
<h3>Versions and Environment</h3>
<p>Cranelift version or commit: main<br>
Operating system: linux<br>
Architecture: riscv64</p>
<h3>Extra Info</h3>
<h4><a href="https://github.com/bytecodealliance/wasmtime/files/10410437/disassmbly.txt">Disassembly</a></h4>
<p>Running this under GDB it crashes in:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="w">   </span><span class="mh">0x3ff7fd5b70</span>:        <span class="nc">bne</span><span class="w">     </span><span class="n">zero</span><span class="p">,</span><span class="n">a7</span><span class="p">,</span><span class="mh">0x3ff7fd5b78</span><span class="w"></span>
<span class="w">   </span><span class="mh">0x3ff7fd5b74</span>:        <span class="nc">unimp</span><span class="w"></span>
<span class="w">   </span><span class="mh">0x3ff7fd5b76</span>:        <span class="nc">unimp</span><span class="w"></span>
<span class="w">   </span><span class="mh">0x3ff7fd5b78</span>:        <span class="nc">divw</span><span class="w">    </span><span class="n">t2</span><span class="p">,</span><span class="n">a6</span><span class="p">,</span><span class="n">a7</span><span class="w"></span>
<span class="w">   </span><span class="mh">0x3ff7fd5b7c</span>:        <span class="nc">feq</span><span class="p">.</span><span class="n">d</span><span class="w">   </span><span class="n">a2</span><span class="p">,</span><span class="n">fa0</span><span class="p">,</span><span class="n">fa0</span><span class="w"></span>
<span class="w">   </span><span class="mh">0x3ff7fd5b80</span>:        <span class="nc">beqz</span><span class="w">    </span><span class="n">a2</span><span class="p">,</span><span class="mh">0x3ff7fd5b90</span><span class="w"></span>
<span class="w">   </span><span class="mh">0x3ff7fd5b84</span>:        <span class="nc">auipc</span><span class="w">   </span><span class="n">t6</span><span class="p">,</span><span class="mh">0x0</span><span class="w"></span>
<span class="w">   </span><span class="mh">0x3ff7fd5b88</span>:        <span class="nc">ld</span><span class="w">      </span><span class="n">t6</span><span class="p">,</span><span class="mi">12</span><span class="p">(</span><span class="n">t6</span><span class="p">)</span><span class="w"></span>
<span class="w">   </span><span class="mh">0x3ff7fd5b8c</span>:        <span class="nc">j</span><span class="w">       </span><span class="mh">0x3ff7fd5b98</span><span class="w"></span>
<span class="w">   </span><span class="mh">0x3ff7fd5b90</span>:        <span class="nc">auipc</span><span class="w">   </span><span class="n">t6</span><span class="p">,</span><span class="mh">0x0</span><span class="w"></span>
<span class="w">   </span><span class="mh">0x3ff7fd5b94</span>:        <span class="nc">jr</span><span class="w">      </span><span class="mi">48</span><span class="p">(</span><span class="n">t6</span><span class="p">)</span><span class="w"></span>
<span class="o">=&gt;</span><span class="w"> </span><span class="mh">0x3ff7fd5b98</span>:        <span class="nc">unimp</span><span class="w"></span>
<span class="w">   </span><span class="mh">0x3ff7fd5b9a</span>:        <span class="nc">unimp</span><span class="w"></span>
<span class="w">   </span><span class="mh">0x3ff7fd5b9c</span>:        <span class="nc">unimp</span><span class="w"></span>
<span class="w">   </span><span class="mh">0x3ff7fd5b9e</span>:        <span class="nc">lw</span><span class="w">      </span><span class="n">s0</span><span class="p">,</span><span class="mi">4</span><span class="p">(</span><span class="n">a4</span><span class="p">)</span><span class="w"></span>
<span class="w">   </span><span class="mh">0x3ff7fd5ba0</span>:        <span class="nc">fmv</span><span class="p">.</span><span class="n">d</span><span class="p">.</span><span class="n">x</span><span class="w"> </span><span class="n">fa3</span><span class="p">,</span><span class="n">t6</span><span class="w"></span>
<span class="w">   </span><span class="mh">0x3ff7fd5ba4</span>:        <span class="nc">fabs</span><span class="p">.</span><span class="n">d</span><span class="w">  </span><span class="n">fa1</span><span class="p">,</span><span class="n">fa0</span><span class="w"></span>
<span class="w">   </span><span class="mh">0x3ff7fd5ba8</span>:        <span class="nc">flt</span><span class="p">.</span><span class="n">d</span><span class="w">   </span><span class="n">a2</span><span class="p">,</span><span class="n">fa3</span><span class="p">,</span><span class="n">fa1</span><span class="w"></span>
<span class="w">   </span><span class="mh">0x3ff7fd5bac</span>:        <span class="nc">bnez</span><span class="w">    </span><span class="n">a2</span><span class="p">,</span><span class="mh">0x3ff7fd5bc8</span><span class="w"></span>
<span class="w">   </span><span class="mh">0x3ff7fd5bb0</span>:        <span class="nc">fcvt</span><span class="p">.</span><span class="n">l</span><span class="p">.</span><span class="n">d</span><span class="w">        </span><span class="n">a2</span><span class="p">,</span><span class="n">fa0</span><span class="p">,</span><span class="n">rne</span><span class="w"></span>
</code></pre></div>
<p>The start of the function is at <code>0x3ff7fd4000</code>, so this is at offset <code>0x1B98</code> in the disassembly. Which appears to be a embedded constant?</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="mi">1</span><span class="n">b88</span>:   <span class="mi">83</span><span class="w"> </span><span class="n">bf</span><span class="w"> </span><span class="n">cf</span><span class="w"> </span><span class="mi">00</span><span class="w">             </span><span class="n">ld</span><span class="w">      </span><span class="n">t6</span><span class="p">,</span><span class="w"> </span><span class="mh">0xc</span><span class="p">(</span><span class="n">t6</span><span class="p">)</span><span class="w"></span>
<span class="mi">1</span><span class="n">b8c</span>:   <span class="mi">6</span><span class="n">f</span><span class="w"> </span><span class="mi">00</span><span class="w"> </span><span class="n">c0</span><span class="w"> </span><span class="mi">00</span><span class="w">             </span><span class="n">j</span><span class="w">       </span><span class="mh">0xc</span><span class="w"></span>
<span class="mi">1</span><span class="n">b90</span>:   <span class="mi">97</span><span class="w"> </span><span class="mi">0</span><span class="n">f</span><span class="w"> </span><span class="mi">00</span><span class="w"> </span><span class="mi">00</span><span class="w">             </span><span class="n">auipc</span><span class="w">   </span><span class="n">t6</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="w"></span>
<span class="mi">1</span><span class="n">b94</span>:   <span class="mi">67</span><span class="w"> </span><span class="mi">80</span><span class="w"> </span><span class="mi">0</span><span class="n">f</span><span class="w"> </span><span class="mi">03</span><span class="w">             </span><span class="n">jalr</span><span class="w">    </span><span class="n">zero</span><span class="p">,</span><span class="w"> </span><span class="n">t6</span><span class="p">,</span><span class="w"> </span><span class="mh">0x30</span><span class="w"></span>
<span class="mi">1</span><span class="n">b98</span>:   <span class="mi">00</span><span class="w"> </span><span class="mi">00</span><span class="w"> </span><span class="mi">00</span><span class="w"> </span><span class="mi">00</span><span class="w">             </span><span class="p">.</span><span class="n">byte</span><span class="w">   </span><span class="mh">0x00</span><span class="p">,</span><span class="w"> </span><span class="mh">0x00</span><span class="p">,</span><span class="w"> </span><span class="mh">0x00</span><span class="p">,</span><span class="w"> </span><span class="mh">0x00</span><span class="w"></span>
<span class="mi">1</span><span class="n">b9c</span>:   <span class="mi">00</span><span class="w"> </span><span class="mi">00</span><span class="w"> </span><span class="mi">40</span><span class="w"> </span><span class="mi">43</span><span class="w">             </span><span class="p">.</span><span class="n">byte</span><span class="w">   </span><span class="mh">0x00</span><span class="p">,</span><span class="w"> </span><span class="mh">0x00</span><span class="p">,</span><span class="w"> </span><span class="mh">0x40</span><span class="p">,</span><span class="w"> </span><span class="mh">0x43</span><span class="w"></span>
<span class="mi">1</span><span class="n">ba0</span>:   <span class="nc">d3</span><span class="w"> </span><span class="mi">86</span><span class="w"> </span><span class="mi">0</span><span class="n">f</span><span class="w"> </span><span class="n">f2</span><span class="w">             </span><span class="n">fmv</span><span class="p">.</span><span class="n">d</span><span class="p">.</span><span class="n">x</span><span class="w"> </span><span class="n">fa3</span><span class="p">,</span><span class="w"> </span><span class="n">t6</span><span class="w"></span>
</code></pre></div>
<p>I suspect the issue here is that the instruction at <code>1b8c</code> is a jump directly into the embedded constant at <code>1b98</code>.</p>
<p>Looking at the trace logs for this range, it looks like we are emitting a veneer right at that offset? And maybe we have a constant offset in some branch that is causing this.</p>
<p><code>1b8c = 7052</code><br>
<code>1b98 = 7064</code></p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="w"> </span><span class="n">TRACE</span><span class="w"> </span><span class="n">cranelift_codegen</span>::<span class="n">machinst</span>::<span class="n">buffer</span><span class="w">     </span><span class="o">&gt;</span><span class="w"> </span><span class="n">emit_island</span>: <span class="nc">fixup</span><span class="w"> </span><span class="n">MachLabelFixup</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">label</span>: <span class="nc">MachLabel</span><span class="p">(</span><span class="mi">529</span><span class="p">),</span><span class="w"> </span><span class="n">offset</span>: <span class="mi">7040</span><span class="p">,</span><span class="w"> </span><span class="n">kind</span>: <span class="nc">B12</span><span class="w"> </span><span class="p">}</span><span class="w"></span>
<span class="w"> </span><span class="n">TRACE</span><span class="w"> </span><span class="n">cranelift_codegen</span>::<span class="n">machinst</span>::<span class="n">buffer</span><span class="w">     </span><span class="o">&gt;</span><span class="w"> </span><span class="n">MachBuffer</span>: <span class="nc">align</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="mi">4</span><span class="w"></span>
<span class="w"> </span><span class="n">TRACE</span><span class="w"> </span><span class="n">cranelift_codegen</span>::<span class="n">machinst</span>::<span class="n">buffer</span><span class="w">     </span><span class="o">&gt;</span><span class="w"> </span><span class="n">making</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="n">veneer</span><span class="w"> </span><span class="n">at</span><span class="w"> </span><span class="mi">7056</span><span class="w"></span>
<span class="w"> </span><span class="n">TRACE</span><span class="w"> </span><span class="n">cranelift_codegen</span>::<span class="n">machinst</span>::<span class="n">buffer</span><span class="w">     </span><span class="o">&gt;</span><span class="w"> </span><span class="n">patching</span><span class="w"> </span><span class="n">original</span><span class="w"> </span><span class="n">at</span><span class="w"> </span><span class="n">offset</span><span class="w"> </span><span class="mi">7040</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">veneer</span><span class="w"> </span><span class="n">offset</span><span class="w"> </span><span class="mi">7056</span><span class="w"></span>
<span class="w"> </span><span class="n">TRACE</span><span class="w"> </span><span class="n">cranelift_codegen</span>::<span class="n">machinst</span>::<span class="n">buffer</span><span class="w">     </span><span class="o">&gt;</span><span class="w"> </span><span class="n">MachBuffer</span>: <span class="nc">put</span><span class="w"> </span><span class="n">data</span><span class="w"> </span><span class="o">@</span><span class="w"> </span><span class="mi">7056</span>: <span class="nc">len</span><span class="w"> </span><span class="mi">8</span><span class="w"></span>
<span class="w"> </span><span class="n">TRACE</span><span class="w"> </span><span class="n">cranelift_codegen</span>::<span class="n">machinst</span>::<span class="n">buffer</span><span class="w">     </span><span class="o">&gt;</span><span class="w"> </span><span class="n">generated</span><span class="w"> </span><span class="n">veneer</span><span class="p">;</span><span class="w"> </span><span class="n">fixup</span><span class="w"> </span><span class="n">offset</span><span class="w"> </span><span class="mi">7056</span><span class="p">,</span><span class="w"> </span><span class="n">label_use</span><span class="w"> </span><span class="n">PCRel32</span><span class="w"></span>
<span class="w"> </span><span class="n">TRACE</span><span class="w"> </span><span class="n">cranelift_codegen</span>::<span class="n">machinst</span>::<span class="n">buffer</span><span class="w">     </span><span class="o">&gt;</span><span class="w"> </span><span class="n">MachBuffer</span>: <span class="nc">use_label_at_offset</span>: <span class="nc">offset</span><span class="w"> </span><span class="mi">7056</span><span class="w"> </span><span class="n">label</span><span class="w"> </span><span class="n">MachLabel</span><span class="p">(</span><span class="mi">529</span><span class="p">)</span><span class="w"> </span><span class="n">kind</span><span class="w"> </span><span class="n">PCRel32</span><span class="w"></span>
<span class="w"> </span><span class="n">TRACE</span><span class="w"> </span><span class="n">cranelift_codegen</span>::<span class="n">machinst</span>::<span class="n">buffer</span><span class="w">     </span><span class="o">&gt;</span><span class="w"> </span><span class="n">MachBuffer</span>: <span class="nc">put</span><span class="w"> </span><span class="n">data</span><span class="w"> </span><span class="o">@</span><span class="w"> </span><span class="mi">7064</span>: <span class="nc">len</span><span class="w"> </span><span class="mi">8</span><span class="w"></span>
<span class="w"> </span><span class="n">TRACE</span><span class="w"> </span><span class="n">cranelift_codegen</span>::<span class="n">machinst</span>::<span class="n">buffer</span><span class="w">     </span><span class="o">&gt;</span><span class="w"> </span><span class="n">MachBuffer</span>: <span class="nc">put</span><span class="w"> </span><span class="mi">32</span><span class="o">-</span><span class="n">bit</span><span class="w"> </span><span class="n">word</span><span class="w"> </span><span class="o">@</span><span class="w"> </span><span class="mi">7072</span>: <span class="nc">f20f86d3</span><span class="w"></span>
<span class="w"> </span><span class="n">TRACE</span><span class="w"> </span><span class="n">cranelift_codegen</span>::<span class="n">machinst</span>::<span class="n">buffer</span><span class="w">     </span><span class="o">&gt;</span><span class="w"> </span><span class="n">MachBuffer</span>: <span class="nc">put</span><span class="w"> </span><span class="mi">32</span><span class="o">-</span><span class="n">bit</span><span class="w"> </span><span class="n">word</span><span class="w"> </span><span class="o">@</span><span class="w"> </span><span class="mi">7076</span>: <span class="mi">22</span><span class="n">a525d3</span><span class="w"></span>
<span class="w"> </span><span class="n">TRACE</span><span class="w"> </span><span class="n">cranelift_codegen</span>::<span class="n">machinst</span>::<span class="n">buffer</span><span class="w">     </span><span class="o">&gt;</span><span class="w"> </span><span class="n">MachBuffer</span>: <span class="nc">put</span><span class="w"> </span><span class="mi">32</span><span class="o">-</span><span class="n">bit</span><span class="w"> </span><span class="n">word</span><span class="w"> </span><span class="o">@</span><span class="w"> </span><span class="mi">7080</span>: <span class="nc">a2b69653</span><span class="w"></span>
<span class="w"> </span><span class="n">TRACE</span><span class="w"> </span><span class="n">cranelift_codegen</span>::<span class="n">machinst</span>::<span class="n">buffer</span><span class="w">     </span><span class="o">&gt;</span><span class="w"> </span><span class="n">MachBuffer</span>: <span class="nc">use_label_at_offset</span>: <span class="nc">offset</span><span class="w"> </span><span class="mi">7084</span><span class="w"> </span><span class="n">label</span><span class="w"> </span><span class="n">MachLabel</span><span class="p">(</span><span class="mi">530</span><span class="p">)</span><span class="w"> </span><span class="n">kind</span><span class="w"> </span><span class="n">B12</span><span class="w"></span>
</code></pre></div>
<p>I'm not too sure how to translate these offsets into an actual clif instruction that is causing this issue.</p>
</blockquote>



<a name="321121243"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%235569%20Cranelift%3A%20Illegal%20instruction%20on%20.../near/321121243" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.235569.20Cranelift.3A.20Illegal.20instruction.20on.20.2E.2E.2E.html#321121243">(Jan 13 2023 at 10:07)</a>:</h4>
<p>afonso360 labeled <a href="https://github.com/bytecodealliance/wasmtime/issues/5569">issue #5569</a>:</p>
<blockquote>
<p><span aria-label="wave" class="emoji emoji-1f44b" role="img" title="wave">:wave:</span> Hey,</p>
<p>Fuzzgen found this a week or so ago, but I haven't been able to minimize this. Whenever I try to remove seemingly any instruction the test case passes.</p>
<p>I'm going to keep running fuzzgen with a smaller <code>max_len</code> to try to find a smaller example.</p>
<h3><code>.clif</code> Test Case</h3>
<p><a href="https://github.com/bytecodealliance/wasmtime/files/10410424/testcase.clif.txt">testcase.clif.txt</a></p>
<h3>Steps to Reproduce</h3>
<ul>
<li><code>clif-util test ./the-above.clif</code></li>
</ul>
<h3>Expected Results</h3>
<p>The test to pass</p>
<h3>Actual Results</h3>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="n">afonso</span><span class="o">@</span><span class="n">DESKTOP</span><span class="o">-</span><span class="n">VSTS4BC</span>:<span class="o">~/</span><span class="n">git</span><span class="o">/</span><span class="n">wasmtime</span><span class="o">/</span><span class="n">cranelift</span><span class="cp">$</span><span class="w"> </span><span class="n">cargo</span><span class="w"> </span><span class="n">run</span><span class="w"> </span><span class="o">--</span><span class="n">target</span><span class="w"> </span><span class="n">riscv64gc</span><span class="o">-</span><span class="n">unknown</span><span class="o">-</span><span class="n">linux</span><span class="o">-</span><span class="n">gnu</span><span class="w"> </span><span class="o">--</span><span class="w"> </span><span class="n">test</span><span class="w"> </span><span class="p">.</span><span class="o">/</span><span class="n">lmao</span><span class="p">.</span><span class="n">clif</span><span class="w"></span>
<span class="w">    </span><span class="n">Finished</span><span class="w"> </span><span class="n">dev</span><span class="w"> </span><span class="p">[</span><span class="n">unoptimized</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">debuginfo</span><span class="p">]</span><span class="w"> </span><span class="n">target</span><span class="p">(</span><span class="n">s</span><span class="p">)</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="mf">0.16</span><span class="n">s</span><span class="w"></span>
<span class="w">     </span><span class="n">Running</span><span class="w"> </span><span class="err">`</span><span class="n">qemu</span><span class="o">-</span><span class="n">riscv64</span><span class="w"> </span><span class="o">-</span><span class="n">L</span><span class="w"> </span><span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">riscv64</span><span class="o">-</span><span class="n">linux</span><span class="o">-</span><span class="n">gnu</span><span class="w"> </span><span class="o">-</span><span class="n">E</span><span class="w"> </span><span class="n">LD_LIBRARY_PATH</span><span class="o">=/</span><span class="n">usr</span><span class="o">/</span><span class="n">riscv64</span><span class="o">-</span><span class="n">linux</span><span class="o">-</span><span class="n">gnu</span><span class="o">/</span><span class="n">lib</span><span class="w"> </span><span class="o">/</span><span class="n">home</span><span class="o">/</span><span class="n">afonso</span><span class="o">/</span><span class="n">git</span><span class="o">/</span><span class="n">wasmtime</span><span class="o">/</span><span class="n">target</span><span class="o">/</span><span class="n">riscv64gc</span><span class="o">-</span><span class="n">unknown</span><span class="o">-</span><span class="n">linux</span><span class="o">-</span><span class="n">gnu</span><span class="o">/</span><span class="n">debug</span><span class="o">/</span><span class="n">clif</span><span class="o">-</span><span class="n">util</span><span class="w"> </span><span class="n">test</span><span class="w"> </span><span class="p">.</span><span class="o">/</span><span class="n">lmao</span><span class="p">.</span><span class="n">clif</span><span class="err">`</span><span class="w"></span>
<span class="n">Illegal</span><span class="w"> </span><span class="n">instruction</span><span class="w"></span>
</code></pre></div>
<h3>Versions and Environment</h3>
<p>Cranelift version or commit: main<br>
Operating system: linux<br>
Architecture: riscv64</p>
<h3>Extra Info</h3>
<h4><a href="https://github.com/bytecodealliance/wasmtime/files/10410437/disassmbly.txt">Disassembly</a></h4>
<p>Running this under GDB it crashes in:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="w">   </span><span class="mh">0x3ff7fd5b70</span>:        <span class="nc">bne</span><span class="w">     </span><span class="n">zero</span><span class="p">,</span><span class="n">a7</span><span class="p">,</span><span class="mh">0x3ff7fd5b78</span><span class="w"></span>
<span class="w">   </span><span class="mh">0x3ff7fd5b74</span>:        <span class="nc">unimp</span><span class="w"></span>
<span class="w">   </span><span class="mh">0x3ff7fd5b76</span>:        <span class="nc">unimp</span><span class="w"></span>
<span class="w">   </span><span class="mh">0x3ff7fd5b78</span>:        <span class="nc">divw</span><span class="w">    </span><span class="n">t2</span><span class="p">,</span><span class="n">a6</span><span class="p">,</span><span class="n">a7</span><span class="w"></span>
<span class="w">   </span><span class="mh">0x3ff7fd5b7c</span>:        <span class="nc">feq</span><span class="p">.</span><span class="n">d</span><span class="w">   </span><span class="n">a2</span><span class="p">,</span><span class="n">fa0</span><span class="p">,</span><span class="n">fa0</span><span class="w"></span>
<span class="w">   </span><span class="mh">0x3ff7fd5b80</span>:        <span class="nc">beqz</span><span class="w">    </span><span class="n">a2</span><span class="p">,</span><span class="mh">0x3ff7fd5b90</span><span class="w"></span>
<span class="w">   </span><span class="mh">0x3ff7fd5b84</span>:        <span class="nc">auipc</span><span class="w">   </span><span class="n">t6</span><span class="p">,</span><span class="mh">0x0</span><span class="w"></span>
<span class="w">   </span><span class="mh">0x3ff7fd5b88</span>:        <span class="nc">ld</span><span class="w">      </span><span class="n">t6</span><span class="p">,</span><span class="mi">12</span><span class="p">(</span><span class="n">t6</span><span class="p">)</span><span class="w"></span>
<span class="w">   </span><span class="mh">0x3ff7fd5b8c</span>:        <span class="nc">j</span><span class="w">       </span><span class="mh">0x3ff7fd5b98</span><span class="w"></span>
<span class="w">   </span><span class="mh">0x3ff7fd5b90</span>:        <span class="nc">auipc</span><span class="w">   </span><span class="n">t6</span><span class="p">,</span><span class="mh">0x0</span><span class="w"></span>
<span class="w">   </span><span class="mh">0x3ff7fd5b94</span>:        <span class="nc">jr</span><span class="w">      </span><span class="mi">48</span><span class="p">(</span><span class="n">t6</span><span class="p">)</span><span class="w"></span>
<span class="o">=&gt;</span><span class="w"> </span><span class="mh">0x3ff7fd5b98</span>:        <span class="nc">unimp</span><span class="w"></span>
<span class="w">   </span><span class="mh">0x3ff7fd5b9a</span>:        <span class="nc">unimp</span><span class="w"></span>
<span class="w">   </span><span class="mh">0x3ff7fd5b9c</span>:        <span class="nc">unimp</span><span class="w"></span>
<span class="w">   </span><span class="mh">0x3ff7fd5b9e</span>:        <span class="nc">lw</span><span class="w">      </span><span class="n">s0</span><span class="p">,</span><span class="mi">4</span><span class="p">(</span><span class="n">a4</span><span class="p">)</span><span class="w"></span>
<span class="w">   </span><span class="mh">0x3ff7fd5ba0</span>:        <span class="nc">fmv</span><span class="p">.</span><span class="n">d</span><span class="p">.</span><span class="n">x</span><span class="w"> </span><span class="n">fa3</span><span class="p">,</span><span class="n">t6</span><span class="w"></span>
<span class="w">   </span><span class="mh">0x3ff7fd5ba4</span>:        <span class="nc">fabs</span><span class="p">.</span><span class="n">d</span><span class="w">  </span><span class="n">fa1</span><span class="p">,</span><span class="n">fa0</span><span class="w"></span>
<span class="w">   </span><span class="mh">0x3ff7fd5ba8</span>:        <span class="nc">flt</span><span class="p">.</span><span class="n">d</span><span class="w">   </span><span class="n">a2</span><span class="p">,</span><span class="n">fa3</span><span class="p">,</span><span class="n">fa1</span><span class="w"></span>
<span class="w">   </span><span class="mh">0x3ff7fd5bac</span>:        <span class="nc">bnez</span><span class="w">    </span><span class="n">a2</span><span class="p">,</span><span class="mh">0x3ff7fd5bc8</span><span class="w"></span>
<span class="w">   </span><span class="mh">0x3ff7fd5bb0</span>:        <span class="nc">fcvt</span><span class="p">.</span><span class="n">l</span><span class="p">.</span><span class="n">d</span><span class="w">        </span><span class="n">a2</span><span class="p">,</span><span class="n">fa0</span><span class="p">,</span><span class="n">rne</span><span class="w"></span>
</code></pre></div>
<p>The start of the function is at <code>0x3ff7fd4000</code>, so this is at offset <code>0x1B98</code> in the disassembly. Which appears to be a embedded constant?</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="mi">1</span><span class="n">b88</span>:   <span class="mi">83</span><span class="w"> </span><span class="n">bf</span><span class="w"> </span><span class="n">cf</span><span class="w"> </span><span class="mi">00</span><span class="w">             </span><span class="n">ld</span><span class="w">      </span><span class="n">t6</span><span class="p">,</span><span class="w"> </span><span class="mh">0xc</span><span class="p">(</span><span class="n">t6</span><span class="p">)</span><span class="w"></span>
<span class="mi">1</span><span class="n">b8c</span>:   <span class="mi">6</span><span class="n">f</span><span class="w"> </span><span class="mi">00</span><span class="w"> </span><span class="n">c0</span><span class="w"> </span><span class="mi">00</span><span class="w">             </span><span class="n">j</span><span class="w">       </span><span class="mh">0xc</span><span class="w"></span>
<span class="mi">1</span><span class="n">b90</span>:   <span class="mi">97</span><span class="w"> </span><span class="mi">0</span><span class="n">f</span><span class="w"> </span><span class="mi">00</span><span class="w"> </span><span class="mi">00</span><span class="w">             </span><span class="n">auipc</span><span class="w">   </span><span class="n">t6</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="w"></span>
<span class="mi">1</span><span class="n">b94</span>:   <span class="mi">67</span><span class="w"> </span><span class="mi">80</span><span class="w"> </span><span class="mi">0</span><span class="n">f</span><span class="w"> </span><span class="mi">03</span><span class="w">             </span><span class="n">jalr</span><span class="w">    </span><span class="n">zero</span><span class="p">,</span><span class="w"> </span><span class="n">t6</span><span class="p">,</span><span class="w"> </span><span class="mh">0x30</span><span class="w"></span>
<span class="mi">1</span><span class="n">b98</span>:   <span class="mi">00</span><span class="w"> </span><span class="mi">00</span><span class="w"> </span><span class="mi">00</span><span class="w"> </span><span class="mi">00</span><span class="w">             </span><span class="p">.</span><span class="n">byte</span><span class="w">   </span><span class="mh">0x00</span><span class="p">,</span><span class="w"> </span><span class="mh">0x00</span><span class="p">,</span><span class="w"> </span><span class="mh">0x00</span><span class="p">,</span><span class="w"> </span><span class="mh">0x00</span><span class="w"></span>
<span class="mi">1</span><span class="n">b9c</span>:   <span class="mi">00</span><span class="w"> </span><span class="mi">00</span><span class="w"> </span><span class="mi">40</span><span class="w"> </span><span class="mi">43</span><span class="w">             </span><span class="p">.</span><span class="n">byte</span><span class="w">   </span><span class="mh">0x00</span><span class="p">,</span><span class="w"> </span><span class="mh">0x00</span><span class="p">,</span><span class="w"> </span><span class="mh">0x40</span><span class="p">,</span><span class="w"> </span><span class="mh">0x43</span><span class="w"></span>
<span class="mi">1</span><span class="n">ba0</span>:   <span class="nc">d3</span><span class="w"> </span><span class="mi">86</span><span class="w"> </span><span class="mi">0</span><span class="n">f</span><span class="w"> </span><span class="n">f2</span><span class="w">             </span><span class="n">fmv</span><span class="p">.</span><span class="n">d</span><span class="p">.</span><span class="n">x</span><span class="w"> </span><span class="n">fa3</span><span class="p">,</span><span class="w"> </span><span class="n">t6</span><span class="w"></span>
</code></pre></div>
<p>I suspect the issue here is that the instruction at <code>1b8c</code> is a jump directly into the embedded constant at <code>1b98</code>.</p>
<p>Looking at the trace logs for this range, it looks like we are emitting a veneer right at that offset? And maybe we have a constant offset in some branch that is causing this.</p>
<p><code>1b8c = 7052</code><br>
<code>1b98 = 7064</code></p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="w"> </span><span class="n">TRACE</span><span class="w"> </span><span class="n">cranelift_codegen</span>::<span class="n">machinst</span>::<span class="n">buffer</span><span class="w">     </span><span class="o">&gt;</span><span class="w"> </span><span class="n">emit_island</span>: <span class="nc">fixup</span><span class="w"> </span><span class="n">MachLabelFixup</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">label</span>: <span class="nc">MachLabel</span><span class="p">(</span><span class="mi">529</span><span class="p">),</span><span class="w"> </span><span class="n">offset</span>: <span class="mi">7040</span><span class="p">,</span><span class="w"> </span><span class="n">kind</span>: <span class="nc">B12</span><span class="w"> </span><span class="p">}</span><span class="w"></span>
<span class="w"> </span><span class="n">TRACE</span><span class="w"> </span><span class="n">cranelift_codegen</span>::<span class="n">machinst</span>::<span class="n">buffer</span><span class="w">     </span><span class="o">&gt;</span><span class="w"> </span><span class="n">MachBuffer</span>: <span class="nc">align</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="mi">4</span><span class="w"></span>
<span class="w"> </span><span class="n">TRACE</span><span class="w"> </span><span class="n">cranelift_codegen</span>::<span class="n">machinst</span>::<span class="n">buffer</span><span class="w">     </span><span class="o">&gt;</span><span class="w"> </span><span class="n">making</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="n">veneer</span><span class="w"> </span><span class="n">at</span><span class="w"> </span><span class="mi">7056</span><span class="w"></span>
<span class="w"> </span><span class="n">TRACE</span><span class="w"> </span><span class="n">cranelift_codegen</span>::<span class="n">machinst</span>::<span class="n">buffer</span><span class="w">     </span><span class="o">&gt;</span><span class="w"> </span><span class="n">patching</span><span class="w"> </span><span class="n">original</span><span class="w"> </span><span class="n">at</span><span class="w"> </span><span class="n">offset</span><span class="w"> </span><span class="mi">7040</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">veneer</span><span class="w"> </span><span class="n">offset</span><span class="w"> </span><span class="mi">7056</span><span class="w"></span>
<span class="w"> </span><span class="n">TRACE</span><span class="w"> </span><span class="n">cranelift_codegen</span>::<span class="n">machinst</span>::<span class="n">buffer</span><span class="w">     </span><span class="o">&gt;</span><span class="w"> </span><span class="n">MachBuffer</span>: <span class="nc">put</span><span class="w"> </span><span class="n">data</span><span class="w"> </span><span class="o">@</span><span class="w"> </span><span class="mi">7056</span>: <span class="nc">len</span><span class="w"> </span><span class="mi">8</span><span class="w"></span>
<span class="w"> </span><span class="n">TRACE</span><span class="w"> </span><span class="n">cranelift_codegen</span>::<span class="n">machinst</span>::<span class="n">buffer</span><span class="w">     </span><span class="o">&gt;</span><span class="w"> </span><span class="n">generated</span><span class="w"> </span><span class="n">veneer</span><span class="p">;</span><span class="w"> </span><span class="n">fixup</span><span class="w"> </span><span class="n">offset</span><span class="w"> </span><span class="mi">7056</span><span class="p">,</span><span class="w"> </span><span class="n">label_use</span><span class="w"> </span><span class="n">PCRel32</span><span class="w"></span>
<span class="w"> </span><span class="n">TRACE</span><span class="w"> </span><span class="n">cranelift_codegen</span>::<span class="n">machinst</span>::<span class="n">buffer</span><span class="w">     </span><span class="o">&gt;</span><span class="w"> </span><span class="n">MachBuffer</span>: <span class="nc">use_label_at_offset</span>: <span class="nc">offset</span><span class="w"> </span><span class="mi">7056</span><span class="w"> </span><span class="n">label</span><span class="w"> </span><span class="n">MachLabel</span><span class="p">(</span><span class="mi">529</span><span class="p">)</span><span class="w"> </span><span class="n">kind</span><span class="w"> </span><span class="n">PCRel32</span><span class="w"></span>
<span class="w"> </span><span class="n">TRACE</span><span class="w"> </span><span class="n">cranelift_codegen</span>::<span class="n">machinst</span>::<span class="n">buffer</span><span class="w">     </span><span class="o">&gt;</span><span class="w"> </span><span class="n">MachBuffer</span>: <span class="nc">put</span><span class="w"> </span><span class="n">data</span><span class="w"> </span><span class="o">@</span><span class="w"> </span><span class="mi">7064</span>: <span class="nc">len</span><span class="w"> </span><span class="mi">8</span><span class="w"></span>
<span class="w"> </span><span class="n">TRACE</span><span class="w"> </span><span class="n">cranelift_codegen</span>::<span class="n">machinst</span>::<span class="n">buffer</span><span class="w">     </span><span class="o">&gt;</span><span class="w"> </span><span class="n">MachBuffer</span>: <span class="nc">put</span><span class="w"> </span><span class="mi">32</span><span class="o">-</span><span class="n">bit</span><span class="w"> </span><span class="n">word</span><span class="w"> </span><span class="o">@</span><span class="w"> </span><span class="mi">7072</span>: <span class="nc">f20f86d3</span><span class="w"></span>
<span class="w"> </span><span class="n">TRACE</span><span class="w"> </span><span class="n">cranelift_codegen</span>::<span class="n">machinst</span>::<span class="n">buffer</span><span class="w">     </span><span class="o">&gt;</span><span class="w"> </span><span class="n">MachBuffer</span>: <span class="nc">put</span><span class="w"> </span><span class="mi">32</span><span class="o">-</span><span class="n">bit</span><span class="w"> </span><span class="n">word</span><span class="w"> </span><span class="o">@</span><span class="w"> </span><span class="mi">7076</span>: <span class="mi">22</span><span class="n">a525d3</span><span class="w"></span>
<span class="w"> </span><span class="n">TRACE</span><span class="w"> </span><span class="n">cranelift_codegen</span>::<span class="n">machinst</span>::<span class="n">buffer</span><span class="w">     </span><span class="o">&gt;</span><span class="w"> </span><span class="n">MachBuffer</span>: <span class="nc">put</span><span class="w"> </span><span class="mi">32</span><span class="o">-</span><span class="n">bit</span><span class="w"> </span><span class="n">word</span><span class="w"> </span><span class="o">@</span><span class="w"> </span><span class="mi">7080</span>: <span class="nc">a2b69653</span><span class="w"></span>
<span class="w"> </span><span class="n">TRACE</span><span class="w"> </span><span class="n">cranelift_codegen</span>::<span class="n">machinst</span>::<span class="n">buffer</span><span class="w">     </span><span class="o">&gt;</span><span class="w"> </span><span class="n">MachBuffer</span>: <span class="nc">use_label_at_offset</span>: <span class="nc">offset</span><span class="w"> </span><span class="mi">7084</span><span class="w"> </span><span class="n">label</span><span class="w"> </span><span class="n">MachLabel</span><span class="p">(</span><span class="mi">530</span><span class="p">)</span><span class="w"> </span><span class="n">kind</span><span class="w"> </span><span class="n">B12</span><span class="w"></span>
</code></pre></div>
<p>I'm not too sure how to translate these offsets into an actual clif instruction that is causing this issue.</p>
</blockquote>



<a name="321176711"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%235569%20Cranelift%3A%20Illegal%20instruction%20on%20.../near/321176711" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.235569.20Cranelift.3A.20Illegal.20instruction.20on.20.2E.2E.2E.html#321176711">(Jan 13 2023 at 14:36)</a>:</h4>
<p>afonso360 edited <a href="https://github.com/bytecodealliance/wasmtime/issues/5569">issue #5569</a>:</p>
<blockquote>
<p><span aria-label="wave" class="emoji emoji-1f44b" role="img" title="wave">:wave:</span> Hey,</p>
<p>Fuzzgen found this a week or so ago, but I haven't been able to minimize this. Whenever I try to remove seemingly any instruction the test case passes.</p>
<p>I'm going to keep running fuzzgen with a smaller <code>max_len</code> to try to find a smaller example.</p>
<h3><code>.clif</code> Test Case</h3>
<p><a href="https://github.com/bytecodealliance/wasmtime/files/10410424/testcase.clif.txt">testcase.clif.txt</a></p>
<h3>Steps to Reproduce</h3>
<ul>
<li><code>clif-util test ./the-above.clif</code></li>
</ul>
<h3>Expected Results</h3>
<p>The test to pass</p>
<h3>Actual Results</h3>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="n">afonso</span><span class="o">@</span><span class="n">DESKTOP</span><span class="o">-</span><span class="n">VSTS4BC</span>:<span class="o">~/</span><span class="n">git</span><span class="o">/</span><span class="n">wasmtime</span><span class="o">/</span><span class="n">cranelift</span><span class="cp">$</span><span class="w"> </span><span class="n">cargo</span><span class="w"> </span><span class="n">run</span><span class="w"> </span><span class="o">--</span><span class="n">target</span><span class="w"> </span><span class="n">riscv64gc</span><span class="o">-</span><span class="n">unknown</span><span class="o">-</span><span class="n">linux</span><span class="o">-</span><span class="n">gnu</span><span class="w"> </span><span class="o">--</span><span class="w"> </span><span class="n">test</span><span class="w"> </span><span class="p">.</span><span class="o">/</span><span class="n">lmao</span><span class="p">.</span><span class="n">clif</span><span class="w"></span>
<span class="w">    </span><span class="n">Finished</span><span class="w"> </span><span class="n">dev</span><span class="w"> </span><span class="p">[</span><span class="n">unoptimized</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">debuginfo</span><span class="p">]</span><span class="w"> </span><span class="n">target</span><span class="p">(</span><span class="n">s</span><span class="p">)</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="mf">0.16</span><span class="n">s</span><span class="w"></span>
<span class="w">     </span><span class="n">Running</span><span class="w"> </span><span class="err">`</span><span class="n">qemu</span><span class="o">-</span><span class="n">riscv64</span><span class="w"> </span><span class="o">-</span><span class="n">L</span><span class="w"> </span><span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">riscv64</span><span class="o">-</span><span class="n">linux</span><span class="o">-</span><span class="n">gnu</span><span class="w"> </span><span class="o">-</span><span class="n">E</span><span class="w"> </span><span class="n">LD_LIBRARY_PATH</span><span class="o">=/</span><span class="n">usr</span><span class="o">/</span><span class="n">riscv64</span><span class="o">-</span><span class="n">linux</span><span class="o">-</span><span class="n">gnu</span><span class="o">/</span><span class="n">lib</span><span class="w"> </span><span class="o">/</span><span class="n">home</span><span class="o">/</span><span class="n">afonso</span><span class="o">/</span><span class="n">git</span><span class="o">/</span><span class="n">wasmtime</span><span class="o">/</span><span class="n">target</span><span class="o">/</span><span class="n">riscv64gc</span><span class="o">-</span><span class="n">unknown</span><span class="o">-</span><span class="n">linux</span><span class="o">-</span><span class="n">gnu</span><span class="o">/</span><span class="n">debug</span><span class="o">/</span><span class="n">clif</span><span class="o">-</span><span class="n">util</span><span class="w"> </span><span class="n">test</span><span class="w"> </span><span class="p">.</span><span class="o">/</span><span class="n">lmao</span><span class="p">.</span><span class="n">clif</span><span class="err">`</span><span class="w"></span>
<span class="n">Illegal</span><span class="w"> </span><span class="n">instruction</span><span class="w"></span>
</code></pre></div>
<h3>Versions and Environment</h3>
<p>Cranelift version or commit: main<br>
Operating system: linux<br>
Architecture: riscv64</p>
<h3>Extra Info</h3>
<h4><a href="https://github.com/bytecodealliance/wasmtime/files/10410437/disassmbly.txt">Disassembly</a></h4>
<p>Running this under GDB it crashes in:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="w">   </span><span class="mh">0x3ff7fd5b70</span>:        <span class="nc">bne</span><span class="w">     </span><span class="n">zero</span><span class="p">,</span><span class="n">a7</span><span class="p">,</span><span class="mh">0x3ff7fd5b78</span><span class="w"></span>
<span class="w">   </span><span class="mh">0x3ff7fd5b74</span>:        <span class="nc">unimp</span><span class="w"></span>
<span class="w">   </span><span class="mh">0x3ff7fd5b76</span>:        <span class="nc">unimp</span><span class="w"></span>
<span class="w">   </span><span class="mh">0x3ff7fd5b78</span>:        <span class="nc">divw</span><span class="w">    </span><span class="n">t2</span><span class="p">,</span><span class="n">a6</span><span class="p">,</span><span class="n">a7</span><span class="w"></span>
<span class="w">   </span><span class="mh">0x3ff7fd5b7c</span>:        <span class="nc">feq</span><span class="p">.</span><span class="n">d</span><span class="w">   </span><span class="n">a2</span><span class="p">,</span><span class="n">fa0</span><span class="p">,</span><span class="n">fa0</span><span class="w"></span>
<span class="w">   </span><span class="mh">0x3ff7fd5b80</span>:        <span class="nc">beqz</span><span class="w">    </span><span class="n">a2</span><span class="p">,</span><span class="mh">0x3ff7fd5b90</span><span class="w"></span>
<span class="w">   </span><span class="mh">0x3ff7fd5b84</span>:        <span class="nc">auipc</span><span class="w">   </span><span class="n">t6</span><span class="p">,</span><span class="mh">0x0</span><span class="w"></span>
<span class="w">   </span><span class="mh">0x3ff7fd5b88</span>:        <span class="nc">ld</span><span class="w">      </span><span class="n">t6</span><span class="p">,</span><span class="mi">12</span><span class="p">(</span><span class="n">t6</span><span class="p">)</span><span class="w"></span>
<span class="w">   </span><span class="mh">0x3ff7fd5b8c</span>:        <span class="nc">j</span><span class="w">       </span><span class="mh">0x3ff7fd5b98</span><span class="w"></span>
<span class="w">   </span><span class="mh">0x3ff7fd5b90</span>:        <span class="nc">auipc</span><span class="w">   </span><span class="n">t6</span><span class="p">,</span><span class="mh">0x0</span><span class="w"></span>
<span class="w">   </span><span class="mh">0x3ff7fd5b94</span>:        <span class="nc">jr</span><span class="w">      </span><span class="mi">48</span><span class="p">(</span><span class="n">t6</span><span class="p">)</span><span class="w"></span>
<span class="o">=&gt;</span><span class="w"> </span><span class="mh">0x3ff7fd5b98</span>:        <span class="nc">unimp</span><span class="w"></span>
<span class="w">   </span><span class="mh">0x3ff7fd5b9a</span>:        <span class="nc">unimp</span><span class="w"></span>
<span class="w">   </span><span class="mh">0x3ff7fd5b9c</span>:        <span class="nc">unimp</span><span class="w"></span>
<span class="w">   </span><span class="mh">0x3ff7fd5b9e</span>:        <span class="nc">lw</span><span class="w">      </span><span class="n">s0</span><span class="p">,</span><span class="mi">4</span><span class="p">(</span><span class="n">a4</span><span class="p">)</span><span class="w"></span>
<span class="w">   </span><span class="mh">0x3ff7fd5ba0</span>:        <span class="nc">fmv</span><span class="p">.</span><span class="n">d</span><span class="p">.</span><span class="n">x</span><span class="w"> </span><span class="n">fa3</span><span class="p">,</span><span class="n">t6</span><span class="w"></span>
<span class="w">   </span><span class="mh">0x3ff7fd5ba4</span>:        <span class="nc">fabs</span><span class="p">.</span><span class="n">d</span><span class="w">  </span><span class="n">fa1</span><span class="p">,</span><span class="n">fa0</span><span class="w"></span>
<span class="w">   </span><span class="mh">0x3ff7fd5ba8</span>:        <span class="nc">flt</span><span class="p">.</span><span class="n">d</span><span class="w">   </span><span class="n">a2</span><span class="p">,</span><span class="n">fa3</span><span class="p">,</span><span class="n">fa1</span><span class="w"></span>
<span class="w">   </span><span class="mh">0x3ff7fd5bac</span>:        <span class="nc">bnez</span><span class="w">    </span><span class="n">a2</span><span class="p">,</span><span class="mh">0x3ff7fd5bc8</span><span class="w"></span>
<span class="w">   </span><span class="mh">0x3ff7fd5bb0</span>:        <span class="nc">fcvt</span><span class="p">.</span><span class="n">l</span><span class="p">.</span><span class="n">d</span><span class="w">        </span><span class="n">a2</span><span class="p">,</span><span class="n">fa0</span><span class="p">,</span><span class="n">rne</span><span class="w"></span>
</code></pre></div>
<p>The start of the function is at <code>0x3ff7fd4000</code>, so this is at offset <code>0x1B98</code> in the disassembly. Which appears to be a embedded constant?</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="mi">1</span><span class="n">b88</span>:   <span class="mi">83</span><span class="w"> </span><span class="n">bf</span><span class="w"> </span><span class="n">cf</span><span class="w"> </span><span class="mi">00</span><span class="w">             </span><span class="n">ld</span><span class="w">      </span><span class="n">t6</span><span class="p">,</span><span class="w"> </span><span class="mh">0xc</span><span class="p">(</span><span class="n">t6</span><span class="p">)</span><span class="w"></span>
<span class="mi">1</span><span class="n">b8c</span>:   <span class="mi">6</span><span class="n">f</span><span class="w"> </span><span class="mi">00</span><span class="w"> </span><span class="n">c0</span><span class="w"> </span><span class="mi">00</span><span class="w">             </span><span class="n">j</span><span class="w">       </span><span class="mh">0xc</span><span class="w"></span>
<span class="mi">1</span><span class="n">b90</span>:   <span class="mi">97</span><span class="w"> </span><span class="mi">0</span><span class="n">f</span><span class="w"> </span><span class="mi">00</span><span class="w"> </span><span class="mi">00</span><span class="w">             </span><span class="n">auipc</span><span class="w">   </span><span class="n">t6</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="w"></span>
<span class="mi">1</span><span class="n">b94</span>:   <span class="mi">67</span><span class="w"> </span><span class="mi">80</span><span class="w"> </span><span class="mi">0</span><span class="n">f</span><span class="w"> </span><span class="mi">03</span><span class="w">             </span><span class="n">jalr</span><span class="w">    </span><span class="n">zero</span><span class="p">,</span><span class="w"> </span><span class="n">t6</span><span class="p">,</span><span class="w"> </span><span class="mh">0x30</span><span class="w"></span>
<span class="mi">1</span><span class="n">b98</span>:   <span class="mi">00</span><span class="w"> </span><span class="mi">00</span><span class="w"> </span><span class="mi">00</span><span class="w"> </span><span class="mi">00</span><span class="w">             </span><span class="p">.</span><span class="n">byte</span><span class="w">   </span><span class="mh">0x00</span><span class="p">,</span><span class="w"> </span><span class="mh">0x00</span><span class="p">,</span><span class="w"> </span><span class="mh">0x00</span><span class="p">,</span><span class="w"> </span><span class="mh">0x00</span><span class="w"></span>
<span class="mi">1</span><span class="n">b9c</span>:   <span class="mi">00</span><span class="w"> </span><span class="mi">00</span><span class="w"> </span><span class="mi">40</span><span class="w"> </span><span class="mi">43</span><span class="w">             </span><span class="p">.</span><span class="n">byte</span><span class="w">   </span><span class="mh">0x00</span><span class="p">,</span><span class="w"> </span><span class="mh">0x00</span><span class="p">,</span><span class="w"> </span><span class="mh">0x40</span><span class="p">,</span><span class="w"> </span><span class="mh">0x43</span><span class="w"></span>
<span class="mi">1</span><span class="n">ba0</span>:   <span class="nc">d3</span><span class="w"> </span><span class="mi">86</span><span class="w"> </span><span class="mi">0</span><span class="n">f</span><span class="w"> </span><span class="n">f2</span><span class="w">             </span><span class="n">fmv</span><span class="p">.</span><span class="n">d</span><span class="p">.</span><span class="n">x</span><span class="w"> </span><span class="n">fa3</span><span class="p">,</span><span class="w"> </span><span class="n">t6</span><span class="w"></span>
</code></pre></div>
<p>I suspect the issue here is that the instruction at <code>1b8c</code> is a jump directly into the embedded constant at <code>1b98</code>.</p>
<p>Looking at the trace logs for this range, it looks like we are emitting a veneer right at that offset? And maybe we have a constant offset in some branch that is causing this.</p>
<p><code>1b8c = 7052</code><br>
<code>1b98 = 7064</code></p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="w"> </span><span class="n">TRACE</span><span class="w"> </span><span class="n">cranelift_codegen</span>::<span class="n">machinst</span>::<span class="n">buffer</span><span class="w">     </span><span class="o">&gt;</span><span class="w"> </span><span class="n">emit_island</span>: <span class="nc">fixup</span><span class="w"> </span><span class="n">MachLabelFixup</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">label</span>: <span class="nc">MachLabel</span><span class="p">(</span><span class="mi">529</span><span class="p">),</span><span class="w"> </span><span class="n">offset</span>: <span class="mi">7040</span><span class="p">,</span><span class="w"> </span><span class="n">kind</span>: <span class="nc">B12</span><span class="w"> </span><span class="p">}</span><span class="w"></span>
<span class="w"> </span><span class="n">TRACE</span><span class="w"> </span><span class="n">cranelift_codegen</span>::<span class="n">machinst</span>::<span class="n">buffer</span><span class="w">     </span><span class="o">&gt;</span><span class="w"> </span><span class="n">MachBuffer</span>: <span class="nc">align</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="mi">4</span><span class="w"></span>
<span class="w"> </span><span class="n">TRACE</span><span class="w"> </span><span class="n">cranelift_codegen</span>::<span class="n">machinst</span>::<span class="n">buffer</span><span class="w">     </span><span class="o">&gt;</span><span class="w"> </span><span class="n">making</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="n">veneer</span><span class="w"> </span><span class="n">at</span><span class="w"> </span><span class="mi">7056</span><span class="w"></span>
<span class="w"> </span><span class="n">TRACE</span><span class="w"> </span><span class="n">cranelift_codegen</span>::<span class="n">machinst</span>::<span class="n">buffer</span><span class="w">     </span><span class="o">&gt;</span><span class="w"> </span><span class="n">patching</span><span class="w"> </span><span class="n">original</span><span class="w"> </span><span class="n">at</span><span class="w"> </span><span class="n">offset</span><span class="w"> </span><span class="mi">7040</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">veneer</span><span class="w"> </span><span class="n">offset</span><span class="w"> </span><span class="mi">7056</span><span class="w"></span>
<span class="w"> </span><span class="n">TRACE</span><span class="w"> </span><span class="n">cranelift_codegen</span>::<span class="n">machinst</span>::<span class="n">buffer</span><span class="w">     </span><span class="o">&gt;</span><span class="w"> </span><span class="n">MachBuffer</span>: <span class="nc">put</span><span class="w"> </span><span class="n">data</span><span class="w"> </span><span class="o">@</span><span class="w"> </span><span class="mi">7056</span>: <span class="nc">len</span><span class="w"> </span><span class="mi">8</span><span class="w"></span>
<span class="w"> </span><span class="n">TRACE</span><span class="w"> </span><span class="n">cranelift_codegen</span>::<span class="n">machinst</span>::<span class="n">buffer</span><span class="w">     </span><span class="o">&gt;</span><span class="w"> </span><span class="n">generated</span><span class="w"> </span><span class="n">veneer</span><span class="p">;</span><span class="w"> </span><span class="n">fixup</span><span class="w"> </span><span class="n">offset</span><span class="w"> </span><span class="mi">7056</span><span class="p">,</span><span class="w"> </span><span class="n">label_use</span><span class="w"> </span><span class="n">PCRel32</span><span class="w"></span>
<span class="w"> </span><span class="n">TRACE</span><span class="w"> </span><span class="n">cranelift_codegen</span>::<span class="n">machinst</span>::<span class="n">buffer</span><span class="w">     </span><span class="o">&gt;</span><span class="w"> </span><span class="n">MachBuffer</span>: <span class="nc">use_label_at_offset</span>: <span class="nc">offset</span><span class="w"> </span><span class="mi">7056</span><span class="w"> </span><span class="n">label</span><span class="w"> </span><span class="n">MachLabel</span><span class="p">(</span><span class="mi">529</span><span class="p">)</span><span class="w"> </span><span class="n">kind</span><span class="w"> </span><span class="n">PCRel32</span><span class="w"></span>
<span class="w"> </span><span class="n">TRACE</span><span class="w"> </span><span class="n">cranelift_codegen</span>::<span class="n">machinst</span>::<span class="n">buffer</span><span class="w">     </span><span class="o">&gt;</span><span class="w"> </span><span class="n">MachBuffer</span>: <span class="nc">put</span><span class="w"> </span><span class="n">data</span><span class="w"> </span><span class="o">@</span><span class="w"> </span><span class="mi">7064</span>: <span class="nc">len</span><span class="w"> </span><span class="mi">8</span><span class="w"></span>
<span class="w"> </span><span class="n">TRACE</span><span class="w"> </span><span class="n">cranelift_codegen</span>::<span class="n">machinst</span>::<span class="n">buffer</span><span class="w">     </span><span class="o">&gt;</span><span class="w"> </span><span class="n">MachBuffer</span>: <span class="nc">put</span><span class="w"> </span><span class="mi">32</span><span class="o">-</span><span class="n">bit</span><span class="w"> </span><span class="n">word</span><span class="w"> </span><span class="o">@</span><span class="w"> </span><span class="mi">7072</span>: <span class="nc">f20f86d3</span><span class="w"></span>
<span class="w"> </span><span class="n">TRACE</span><span class="w"> </span><span class="n">cranelift_codegen</span>::<span class="n">machinst</span>::<span class="n">buffer</span><span class="w">     </span><span class="o">&gt;</span><span class="w"> </span><span class="n">MachBuffer</span>: <span class="nc">put</span><span class="w"> </span><span class="mi">32</span><span class="o">-</span><span class="n">bit</span><span class="w"> </span><span class="n">word</span><span class="w"> </span><span class="o">@</span><span class="w"> </span><span class="mi">7076</span>: <span class="mi">22</span><span class="n">a525d3</span><span class="w"></span>
<span class="w"> </span><span class="n">TRACE</span><span class="w"> </span><span class="n">cranelift_codegen</span>::<span class="n">machinst</span>::<span class="n">buffer</span><span class="w">     </span><span class="o">&gt;</span><span class="w"> </span><span class="n">MachBuffer</span>: <span class="nc">put</span><span class="w"> </span><span class="mi">32</span><span class="o">-</span><span class="n">bit</span><span class="w"> </span><span class="n">word</span><span class="w"> </span><span class="o">@</span><span class="w"> </span><span class="mi">7080</span>: <span class="nc">a2b69653</span><span class="w"></span>
<span class="w"> </span><span class="n">TRACE</span><span class="w"> </span><span class="n">cranelift_codegen</span>::<span class="n">machinst</span>::<span class="n">buffer</span><span class="w">     </span><span class="o">&gt;</span><span class="w"> </span><span class="n">MachBuffer</span>: <span class="nc">use_label_at_offset</span>: <span class="nc">offset</span><span class="w"> </span><span class="mi">7084</span><span class="w"> </span><span class="n">label</span><span class="w"> </span><span class="n">MachLabel</span><span class="p">(</span><span class="mi">530</span><span class="p">)</span><span class="w"> </span><span class="n">kind</span><span class="w"> </span><span class="n">B12</span><span class="w"></span>
</code></pre></div>
<p>I'm not too sure how to translate these offsets into an actual clif instruction that is causing this issue.</p>
<p>Edit: This seems to be caused by us not using labels in <a href="https://github.com/bytecodealliance/wasmtime/blob/cbeec5ddb929e1c6e77f19731e4e3cf1bc9817d0/cranelift/codegen/src/isa/riscv64/inst/emit.rs#L78"><code>load_constant</code></a>.</p>
</blockquote>



<a name="321931962"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%235569%20Cranelift%3A%20Illegal%20instruction%20on%20.../near/321931962" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.235569.20Cranelift.3A.20Illegal.20instruction.20on.20.2E.2E.2E.html#321931962">(Jan 17 2023 at 21:46)</a>:</h4>
<p>alexcrichton labeled <a href="https://github.com/bytecodealliance/wasmtime/issues/5569">issue #5569</a>:</p>
<blockquote>
<p><span aria-label="wave" class="emoji emoji-1f44b" role="img" title="wave">:wave:</span> Hey,</p>
<p>Fuzzgen found this a week or so ago, but I haven't been able to minimize this. Whenever I try to remove seemingly any instruction the test case passes.</p>
<p>I'm going to keep running fuzzgen with a smaller <code>max_len</code> to try to find a smaller example.</p>
<h3><code>.clif</code> Test Case</h3>
<p><a href="https://github.com/bytecodealliance/wasmtime/files/10410424/testcase.clif.txt">testcase.clif.txt</a></p>
<h3>Steps to Reproduce</h3>
<ul>
<li><code>clif-util test ./the-above.clif</code></li>
</ul>
<h3>Expected Results</h3>
<p>The test to pass</p>
<h3>Actual Results</h3>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="n">afonso</span><span class="o">@</span><span class="n">DESKTOP</span><span class="o">-</span><span class="n">VSTS4BC</span>:<span class="o">~/</span><span class="n">git</span><span class="o">/</span><span class="n">wasmtime</span><span class="o">/</span><span class="n">cranelift</span><span class="cp">$</span><span class="w"> </span><span class="n">cargo</span><span class="w"> </span><span class="n">run</span><span class="w"> </span><span class="o">--</span><span class="n">target</span><span class="w"> </span><span class="n">riscv64gc</span><span class="o">-</span><span class="n">unknown</span><span class="o">-</span><span class="n">linux</span><span class="o">-</span><span class="n">gnu</span><span class="w"> </span><span class="o">--</span><span class="w"> </span><span class="n">test</span><span class="w"> </span><span class="p">.</span><span class="o">/</span><span class="n">lmao</span><span class="p">.</span><span class="n">clif</span><span class="w"></span>
<span class="w">    </span><span class="n">Finished</span><span class="w"> </span><span class="n">dev</span><span class="w"> </span><span class="p">[</span><span class="n">unoptimized</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">debuginfo</span><span class="p">]</span><span class="w"> </span><span class="n">target</span><span class="p">(</span><span class="n">s</span><span class="p">)</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="mf">0.16</span><span class="n">s</span><span class="w"></span>
<span class="w">     </span><span class="n">Running</span><span class="w"> </span><span class="err">`</span><span class="n">qemu</span><span class="o">-</span><span class="n">riscv64</span><span class="w"> </span><span class="o">-</span><span class="n">L</span><span class="w"> </span><span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">riscv64</span><span class="o">-</span><span class="n">linux</span><span class="o">-</span><span class="n">gnu</span><span class="w"> </span><span class="o">-</span><span class="n">E</span><span class="w"> </span><span class="n">LD_LIBRARY_PATH</span><span class="o">=/</span><span class="n">usr</span><span class="o">/</span><span class="n">riscv64</span><span class="o">-</span><span class="n">linux</span><span class="o">-</span><span class="n">gnu</span><span class="o">/</span><span class="n">lib</span><span class="w"> </span><span class="o">/</span><span class="n">home</span><span class="o">/</span><span class="n">afonso</span><span class="o">/</span><span class="n">git</span><span class="o">/</span><span class="n">wasmtime</span><span class="o">/</span><span class="n">target</span><span class="o">/</span><span class="n">riscv64gc</span><span class="o">-</span><span class="n">unknown</span><span class="o">-</span><span class="n">linux</span><span class="o">-</span><span class="n">gnu</span><span class="o">/</span><span class="n">debug</span><span class="o">/</span><span class="n">clif</span><span class="o">-</span><span class="n">util</span><span class="w"> </span><span class="n">test</span><span class="w"> </span><span class="p">.</span><span class="o">/</span><span class="n">lmao</span><span class="p">.</span><span class="n">clif</span><span class="err">`</span><span class="w"></span>
<span class="n">Illegal</span><span class="w"> </span><span class="n">instruction</span><span class="w"></span>
</code></pre></div>
<h3>Versions and Environment</h3>
<p>Cranelift version or commit: main<br>
Operating system: linux<br>
Architecture: riscv64</p>
<h3>Extra Info</h3>
<h4><a href="https://github.com/bytecodealliance/wasmtime/files/10410437/disassmbly.txt">Disassembly</a></h4>
<p>Running this under GDB it crashes in:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="w">   </span><span class="mh">0x3ff7fd5b70</span>:        <span class="nc">bne</span><span class="w">     </span><span class="n">zero</span><span class="p">,</span><span class="n">a7</span><span class="p">,</span><span class="mh">0x3ff7fd5b78</span><span class="w"></span>
<span class="w">   </span><span class="mh">0x3ff7fd5b74</span>:        <span class="nc">unimp</span><span class="w"></span>
<span class="w">   </span><span class="mh">0x3ff7fd5b76</span>:        <span class="nc">unimp</span><span class="w"></span>
<span class="w">   </span><span class="mh">0x3ff7fd5b78</span>:        <span class="nc">divw</span><span class="w">    </span><span class="n">t2</span><span class="p">,</span><span class="n">a6</span><span class="p">,</span><span class="n">a7</span><span class="w"></span>
<span class="w">   </span><span class="mh">0x3ff7fd5b7c</span>:        <span class="nc">feq</span><span class="p">.</span><span class="n">d</span><span class="w">   </span><span class="n">a2</span><span class="p">,</span><span class="n">fa0</span><span class="p">,</span><span class="n">fa0</span><span class="w"></span>
<span class="w">   </span><span class="mh">0x3ff7fd5b80</span>:        <span class="nc">beqz</span><span class="w">    </span><span class="n">a2</span><span class="p">,</span><span class="mh">0x3ff7fd5b90</span><span class="w"></span>
<span class="w">   </span><span class="mh">0x3ff7fd5b84</span>:        <span class="nc">auipc</span><span class="w">   </span><span class="n">t6</span><span class="p">,</span><span class="mh">0x0</span><span class="w"></span>
<span class="w">   </span><span class="mh">0x3ff7fd5b88</span>:        <span class="nc">ld</span><span class="w">      </span><span class="n">t6</span><span class="p">,</span><span class="mi">12</span><span class="p">(</span><span class="n">t6</span><span class="p">)</span><span class="w"></span>
<span class="w">   </span><span class="mh">0x3ff7fd5b8c</span>:        <span class="nc">j</span><span class="w">       </span><span class="mh">0x3ff7fd5b98</span><span class="w"></span>
<span class="w">   </span><span class="mh">0x3ff7fd5b90</span>:        <span class="nc">auipc</span><span class="w">   </span><span class="n">t6</span><span class="p">,</span><span class="mh">0x0</span><span class="w"></span>
<span class="w">   </span><span class="mh">0x3ff7fd5b94</span>:        <span class="nc">jr</span><span class="w">      </span><span class="mi">48</span><span class="p">(</span><span class="n">t6</span><span class="p">)</span><span class="w"></span>
<span class="o">=&gt;</span><span class="w"> </span><span class="mh">0x3ff7fd5b98</span>:        <span class="nc">unimp</span><span class="w"></span>
<span class="w">   </span><span class="mh">0x3ff7fd5b9a</span>:        <span class="nc">unimp</span><span class="w"></span>
<span class="w">   </span><span class="mh">0x3ff7fd5b9c</span>:        <span class="nc">unimp</span><span class="w"></span>
<span class="w">   </span><span class="mh">0x3ff7fd5b9e</span>:        <span class="nc">lw</span><span class="w">      </span><span class="n">s0</span><span class="p">,</span><span class="mi">4</span><span class="p">(</span><span class="n">a4</span><span class="p">)</span><span class="w"></span>
<span class="w">   </span><span class="mh">0x3ff7fd5ba0</span>:        <span class="nc">fmv</span><span class="p">.</span><span class="n">d</span><span class="p">.</span><span class="n">x</span><span class="w"> </span><span class="n">fa3</span><span class="p">,</span><span class="n">t6</span><span class="w"></span>
<span class="w">   </span><span class="mh">0x3ff7fd5ba4</span>:        <span class="nc">fabs</span><span class="p">.</span><span class="n">d</span><span class="w">  </span><span class="n">fa1</span><span class="p">,</span><span class="n">fa0</span><span class="w"></span>
<span class="w">   </span><span class="mh">0x3ff7fd5ba8</span>:        <span class="nc">flt</span><span class="p">.</span><span class="n">d</span><span class="w">   </span><span class="n">a2</span><span class="p">,</span><span class="n">fa3</span><span class="p">,</span><span class="n">fa1</span><span class="w"></span>
<span class="w">   </span><span class="mh">0x3ff7fd5bac</span>:        <span class="nc">bnez</span><span class="w">    </span><span class="n">a2</span><span class="p">,</span><span class="mh">0x3ff7fd5bc8</span><span class="w"></span>
<span class="w">   </span><span class="mh">0x3ff7fd5bb0</span>:        <span class="nc">fcvt</span><span class="p">.</span><span class="n">l</span><span class="p">.</span><span class="n">d</span><span class="w">        </span><span class="n">a2</span><span class="p">,</span><span class="n">fa0</span><span class="p">,</span><span class="n">rne</span><span class="w"></span>
</code></pre></div>
<p>The start of the function is at <code>0x3ff7fd4000</code>, so this is at offset <code>0x1B98</code> in the disassembly. Which appears to be a embedded constant?</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="mi">1</span><span class="n">b88</span>:   <span class="mi">83</span><span class="w"> </span><span class="n">bf</span><span class="w"> </span><span class="n">cf</span><span class="w"> </span><span class="mi">00</span><span class="w">             </span><span class="n">ld</span><span class="w">      </span><span class="n">t6</span><span class="p">,</span><span class="w"> </span><span class="mh">0xc</span><span class="p">(</span><span class="n">t6</span><span class="p">)</span><span class="w"></span>
<span class="mi">1</span><span class="n">b8c</span>:   <span class="mi">6</span><span class="n">f</span><span class="w"> </span><span class="mi">00</span><span class="w"> </span><span class="n">c0</span><span class="w"> </span><span class="mi">00</span><span class="w">             </span><span class="n">j</span><span class="w">       </span><span class="mh">0xc</span><span class="w"></span>
<span class="mi">1</span><span class="n">b90</span>:   <span class="mi">97</span><span class="w"> </span><span class="mi">0</span><span class="n">f</span><span class="w"> </span><span class="mi">00</span><span class="w"> </span><span class="mi">00</span><span class="w">             </span><span class="n">auipc</span><span class="w">   </span><span class="n">t6</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="w"></span>
<span class="mi">1</span><span class="n">b94</span>:   <span class="mi">67</span><span class="w"> </span><span class="mi">80</span><span class="w"> </span><span class="mi">0</span><span class="n">f</span><span class="w"> </span><span class="mi">03</span><span class="w">             </span><span class="n">jalr</span><span class="w">    </span><span class="n">zero</span><span class="p">,</span><span class="w"> </span><span class="n">t6</span><span class="p">,</span><span class="w"> </span><span class="mh">0x30</span><span class="w"></span>
<span class="mi">1</span><span class="n">b98</span>:   <span class="mi">00</span><span class="w"> </span><span class="mi">00</span><span class="w"> </span><span class="mi">00</span><span class="w"> </span><span class="mi">00</span><span class="w">             </span><span class="p">.</span><span class="n">byte</span><span class="w">   </span><span class="mh">0x00</span><span class="p">,</span><span class="w"> </span><span class="mh">0x00</span><span class="p">,</span><span class="w"> </span><span class="mh">0x00</span><span class="p">,</span><span class="w"> </span><span class="mh">0x00</span><span class="w"></span>
<span class="mi">1</span><span class="n">b9c</span>:   <span class="mi">00</span><span class="w"> </span><span class="mi">00</span><span class="w"> </span><span class="mi">40</span><span class="w"> </span><span class="mi">43</span><span class="w">             </span><span class="p">.</span><span class="n">byte</span><span class="w">   </span><span class="mh">0x00</span><span class="p">,</span><span class="w"> </span><span class="mh">0x00</span><span class="p">,</span><span class="w"> </span><span class="mh">0x40</span><span class="p">,</span><span class="w"> </span><span class="mh">0x43</span><span class="w"></span>
<span class="mi">1</span><span class="n">ba0</span>:   <span class="nc">d3</span><span class="w"> </span><span class="mi">86</span><span class="w"> </span><span class="mi">0</span><span class="n">f</span><span class="w"> </span><span class="n">f2</span><span class="w">             </span><span class="n">fmv</span><span class="p">.</span><span class="n">d</span><span class="p">.</span><span class="n">x</span><span class="w"> </span><span class="n">fa3</span><span class="p">,</span><span class="w"> </span><span class="n">t6</span><span class="w"></span>
</code></pre></div>
<p>I suspect the issue here is that the instruction at <code>1b8c</code> is a jump directly into the embedded constant at <code>1b98</code>.</p>
<p>Looking at the trace logs for this range, it looks like we are emitting a veneer right at that offset? And maybe we have a constant offset in some branch that is causing this.</p>
<p><code>1b8c = 7052</code><br>
<code>1b98 = 7064</code></p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="w"> </span><span class="n">TRACE</span><span class="w"> </span><span class="n">cranelift_codegen</span>::<span class="n">machinst</span>::<span class="n">buffer</span><span class="w">     </span><span class="o">&gt;</span><span class="w"> </span><span class="n">emit_island</span>: <span class="nc">fixup</span><span class="w"> </span><span class="n">MachLabelFixup</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">label</span>: <span class="nc">MachLabel</span><span class="p">(</span><span class="mi">529</span><span class="p">),</span><span class="w"> </span><span class="n">offset</span>: <span class="mi">7040</span><span class="p">,</span><span class="w"> </span><span class="n">kind</span>: <span class="nc">B12</span><span class="w"> </span><span class="p">}</span><span class="w"></span>
<span class="w"> </span><span class="n">TRACE</span><span class="w"> </span><span class="n">cranelift_codegen</span>::<span class="n">machinst</span>::<span class="n">buffer</span><span class="w">     </span><span class="o">&gt;</span><span class="w"> </span><span class="n">MachBuffer</span>: <span class="nc">align</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="mi">4</span><span class="w"></span>
<span class="w"> </span><span class="n">TRACE</span><span class="w"> </span><span class="n">cranelift_codegen</span>::<span class="n">machinst</span>::<span class="n">buffer</span><span class="w">     </span><span class="o">&gt;</span><span class="w"> </span><span class="n">making</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="n">veneer</span><span class="w"> </span><span class="n">at</span><span class="w"> </span><span class="mi">7056</span><span class="w"></span>
<span class="w"> </span><span class="n">TRACE</span><span class="w"> </span><span class="n">cranelift_codegen</span>::<span class="n">machinst</span>::<span class="n">buffer</span><span class="w">     </span><span class="o">&gt;</span><span class="w"> </span><span class="n">patching</span><span class="w"> </span><span class="n">original</span><span class="w"> </span><span class="n">at</span><span class="w"> </span><span class="n">offset</span><span class="w"> </span><span class="mi">7040</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">veneer</span><span class="w"> </span><span class="n">offset</span><span class="w"> </span><span class="mi">7056</span><span class="w"></span>
<span class="w"> </span><span class="n">TRACE</span><span class="w"> </span><span class="n">cranelift_codegen</span>::<span class="n">machinst</span>::<span class="n">buffer</span><span class="w">     </span><span class="o">&gt;</span><span class="w"> </span><span class="n">MachBuffer</span>: <span class="nc">put</span><span class="w"> </span><span class="n">data</span><span class="w"> </span><span class="o">@</span><span class="w"> </span><span class="mi">7056</span>: <span class="nc">len</span><span class="w"> </span><span class="mi">8</span><span class="w"></span>
<span class="w"> </span><span class="n">TRACE</span><span class="w"> </span><span class="n">cranelift_codegen</span>::<span class="n">machinst</span>::<span class="n">buffer</span><span class="w">     </span><span class="o">&gt;</span><span class="w"> </span><span class="n">generated</span><span class="w"> </span><span class="n">veneer</span><span class="p">;</span><span class="w"> </span><span class="n">fixup</span><span class="w"> </span><span class="n">offset</span><span class="w"> </span><span class="mi">7056</span><span class="p">,</span><span class="w"> </span><span class="n">label_use</span><span class="w"> </span><span class="n">PCRel32</span><span class="w"></span>
<span class="w"> </span><span class="n">TRACE</span><span class="w"> </span><span class="n">cranelift_codegen</span>::<span class="n">machinst</span>::<span class="n">buffer</span><span class="w">     </span><span class="o">&gt;</span><span class="w"> </span><span class="n">MachBuffer</span>: <span class="nc">use_label_at_offset</span>: <span class="nc">offset</span><span class="w"> </span><span class="mi">7056</span><span class="w"> </span><span class="n">label</span><span class="w"> </span><span class="n">MachLabel</span><span class="p">(</span><span class="mi">529</span><span class="p">)</span><span class="w"> </span><span class="n">kind</span><span class="w"> </span><span class="n">PCRel32</span><span class="w"></span>
<span class="w"> </span><span class="n">TRACE</span><span class="w"> </span><span class="n">cranelift_codegen</span>::<span class="n">machinst</span>::<span class="n">buffer</span><span class="w">     </span><span class="o">&gt;</span><span class="w"> </span><span class="n">MachBuffer</span>: <span class="nc">put</span><span class="w"> </span><span class="n">data</span><span class="w"> </span><span class="o">@</span><span class="w"> </span><span class="mi">7064</span>: <span class="nc">len</span><span class="w"> </span><span class="mi">8</span><span class="w"></span>
<span class="w"> </span><span class="n">TRACE</span><span class="w"> </span><span class="n">cranelift_codegen</span>::<span class="n">machinst</span>::<span class="n">buffer</span><span class="w">     </span><span class="o">&gt;</span><span class="w"> </span><span class="n">MachBuffer</span>: <span class="nc">put</span><span class="w"> </span><span class="mi">32</span><span class="o">-</span><span class="n">bit</span><span class="w"> </span><span class="n">word</span><span class="w"> </span><span class="o">@</span><span class="w"> </span><span class="mi">7072</span>: <span class="nc">f20f86d3</span><span class="w"></span>
<span class="w"> </span><span class="n">TRACE</span><span class="w"> </span><span class="n">cranelift_codegen</span>::<span class="n">machinst</span>::<span class="n">buffer</span><span class="w">     </span><span class="o">&gt;</span><span class="w"> </span><span class="n">MachBuffer</span>: <span class="nc">put</span><span class="w"> </span><span class="mi">32</span><span class="o">-</span><span class="n">bit</span><span class="w"> </span><span class="n">word</span><span class="w"> </span><span class="o">@</span><span class="w"> </span><span class="mi">7076</span>: <span class="mi">22</span><span class="n">a525d3</span><span class="w"></span>
<span class="w"> </span><span class="n">TRACE</span><span class="w"> </span><span class="n">cranelift_codegen</span>::<span class="n">machinst</span>::<span class="n">buffer</span><span class="w">     </span><span class="o">&gt;</span><span class="w"> </span><span class="n">MachBuffer</span>: <span class="nc">put</span><span class="w"> </span><span class="mi">32</span><span class="o">-</span><span class="n">bit</span><span class="w"> </span><span class="n">word</span><span class="w"> </span><span class="o">@</span><span class="w"> </span><span class="mi">7080</span>: <span class="nc">a2b69653</span><span class="w"></span>
<span class="w"> </span><span class="n">TRACE</span><span class="w"> </span><span class="n">cranelift_codegen</span>::<span class="n">machinst</span>::<span class="n">buffer</span><span class="w">     </span><span class="o">&gt;</span><span class="w"> </span><span class="n">MachBuffer</span>: <span class="nc">use_label_at_offset</span>: <span class="nc">offset</span><span class="w"> </span><span class="mi">7084</span><span class="w"> </span><span class="n">label</span><span class="w"> </span><span class="n">MachLabel</span><span class="p">(</span><span class="mi">530</span><span class="p">)</span><span class="w"> </span><span class="n">kind</span><span class="w"> </span><span class="n">B12</span><span class="w"></span>
</code></pre></div>
<p>I'm not too sure how to translate these offsets into an actual clif instruction that is causing this issue.</p>
<p>Edit: This seems to be caused by us not using labels in <a href="https://github.com/bytecodealliance/wasmtime/blob/cbeec5ddb929e1c6e77f19731e4e3cf1bc9817d0/cranelift/codegen/src/isa/riscv64/inst/emit.rs#L78"><code>load_constant</code></a>.</p>
</blockquote>



<a name="322802201"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%235569%20Cranelift%3A%20Illegal%20instruction%20on%20.../near/322802201" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.235569.20Cranelift.3A.20Illegal.20instruction.20on.20.2E.2E.2E.html#322802201">(Jan 22 2023 at 02:33)</a>:</h4>
<p>yuyang-ok <a href="https://github.com/bytecodealliance/wasmtime/issues/5569#issuecomment-1399388813">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/5569">issue #5569</a>:</p>
<blockquote>
<p>@alexcrichton @afonso360 I think I fixed this. :-)</p>
</blockquote>



<a name="325996664"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%235569%20Cranelift%3A%20Illegal%20instruction%20on%20.../near/325996664" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.235569.20Cranelift.3A.20Illegal.20instruction.20on.20.2E.2E.2E.html#325996664">(Feb 05 2023 at 18:16)</a>:</h4>
<p>afonso360 closed <a href="https://github.com/bytecodealliance/wasmtime/issues/5569">issue #5569</a>:</p>
<blockquote>
<p><span aria-label="wave" class="emoji emoji-1f44b" role="img" title="wave">:wave:</span> Hey,</p>
<p>Fuzzgen found this a week or so ago, but I haven't been able to minimize this. Whenever I try to remove seemingly any instruction the test case passes.</p>
<p>I'm going to keep running fuzzgen with a smaller <code>max_len</code> to try to find a smaller example.</p>
<h3><code>.clif</code> Test Case</h3>
<p><a href="https://github.com/bytecodealliance/wasmtime/files/10410424/testcase.clif.txt">testcase.clif.txt</a></p>
<h3>Steps to Reproduce</h3>
<ul>
<li><code>clif-util test ./the-above.clif</code></li>
</ul>
<h3>Expected Results</h3>
<p>The test to pass</p>
<h3>Actual Results</h3>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="n">afonso</span><span class="o">@</span><span class="n">DESKTOP</span><span class="o">-</span><span class="n">VSTS4BC</span>:<span class="o">~/</span><span class="n">git</span><span class="o">/</span><span class="n">wasmtime</span><span class="o">/</span><span class="n">cranelift</span><span class="cp">$</span><span class="w"> </span><span class="n">cargo</span><span class="w"> </span><span class="n">run</span><span class="w"> </span><span class="o">--</span><span class="n">target</span><span class="w"> </span><span class="n">riscv64gc</span><span class="o">-</span><span class="n">unknown</span><span class="o">-</span><span class="n">linux</span><span class="o">-</span><span class="n">gnu</span><span class="w"> </span><span class="o">--</span><span class="w"> </span><span class="n">test</span><span class="w"> </span><span class="p">.</span><span class="o">/</span><span class="n">lmao</span><span class="p">.</span><span class="n">clif</span><span class="w"></span>
<span class="w">    </span><span class="n">Finished</span><span class="w"> </span><span class="n">dev</span><span class="w"> </span><span class="p">[</span><span class="n">unoptimized</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">debuginfo</span><span class="p">]</span><span class="w"> </span><span class="n">target</span><span class="p">(</span><span class="n">s</span><span class="p">)</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="mf">0.16</span><span class="n">s</span><span class="w"></span>
<span class="w">     </span><span class="n">Running</span><span class="w"> </span><span class="err">`</span><span class="n">qemu</span><span class="o">-</span><span class="n">riscv64</span><span class="w"> </span><span class="o">-</span><span class="n">L</span><span class="w"> </span><span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">riscv64</span><span class="o">-</span><span class="n">linux</span><span class="o">-</span><span class="n">gnu</span><span class="w"> </span><span class="o">-</span><span class="n">E</span><span class="w"> </span><span class="n">LD_LIBRARY_PATH</span><span class="o">=/</span><span class="n">usr</span><span class="o">/</span><span class="n">riscv64</span><span class="o">-</span><span class="n">linux</span><span class="o">-</span><span class="n">gnu</span><span class="o">/</span><span class="n">lib</span><span class="w"> </span><span class="o">/</span><span class="n">home</span><span class="o">/</span><span class="n">afonso</span><span class="o">/</span><span class="n">git</span><span class="o">/</span><span class="n">wasmtime</span><span class="o">/</span><span class="n">target</span><span class="o">/</span><span class="n">riscv64gc</span><span class="o">-</span><span class="n">unknown</span><span class="o">-</span><span class="n">linux</span><span class="o">-</span><span class="n">gnu</span><span class="o">/</span><span class="n">debug</span><span class="o">/</span><span class="n">clif</span><span class="o">-</span><span class="n">util</span><span class="w"> </span><span class="n">test</span><span class="w"> </span><span class="p">.</span><span class="o">/</span><span class="n">lmao</span><span class="p">.</span><span class="n">clif</span><span class="err">`</span><span class="w"></span>
<span class="n">Illegal</span><span class="w"> </span><span class="n">instruction</span><span class="w"></span>
</code></pre></div>
<h3>Versions and Environment</h3>
<p>Cranelift version or commit: main<br>
Operating system: linux<br>
Architecture: riscv64</p>
<h3>Extra Info</h3>
<h4><a href="https://github.com/bytecodealliance/wasmtime/files/10410437/disassmbly.txt">Disassembly</a></h4>
<p>Running this under GDB it crashes in:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="w">   </span><span class="mh">0x3ff7fd5b70</span>:        <span class="nc">bne</span><span class="w">     </span><span class="n">zero</span><span class="p">,</span><span class="n">a7</span><span class="p">,</span><span class="mh">0x3ff7fd5b78</span><span class="w"></span>
<span class="w">   </span><span class="mh">0x3ff7fd5b74</span>:        <span class="nc">unimp</span><span class="w"></span>
<span class="w">   </span><span class="mh">0x3ff7fd5b76</span>:        <span class="nc">unimp</span><span class="w"></span>
<span class="w">   </span><span class="mh">0x3ff7fd5b78</span>:        <span class="nc">divw</span><span class="w">    </span><span class="n">t2</span><span class="p">,</span><span class="n">a6</span><span class="p">,</span><span class="n">a7</span><span class="w"></span>
<span class="w">   </span><span class="mh">0x3ff7fd5b7c</span>:        <span class="nc">feq</span><span class="p">.</span><span class="n">d</span><span class="w">   </span><span class="n">a2</span><span class="p">,</span><span class="n">fa0</span><span class="p">,</span><span class="n">fa0</span><span class="w"></span>
<span class="w">   </span><span class="mh">0x3ff7fd5b80</span>:        <span class="nc">beqz</span><span class="w">    </span><span class="n">a2</span><span class="p">,</span><span class="mh">0x3ff7fd5b90</span><span class="w"></span>
<span class="w">   </span><span class="mh">0x3ff7fd5b84</span>:        <span class="nc">auipc</span><span class="w">   </span><span class="n">t6</span><span class="p">,</span><span class="mh">0x0</span><span class="w"></span>
<span class="w">   </span><span class="mh">0x3ff7fd5b88</span>:        <span class="nc">ld</span><span class="w">      </span><span class="n">t6</span><span class="p">,</span><span class="mi">12</span><span class="p">(</span><span class="n">t6</span><span class="p">)</span><span class="w"></span>
<span class="w">   </span><span class="mh">0x3ff7fd5b8c</span>:        <span class="nc">j</span><span class="w">       </span><span class="mh">0x3ff7fd5b98</span><span class="w"></span>
<span class="w">   </span><span class="mh">0x3ff7fd5b90</span>:        <span class="nc">auipc</span><span class="w">   </span><span class="n">t6</span><span class="p">,</span><span class="mh">0x0</span><span class="w"></span>
<span class="w">   </span><span class="mh">0x3ff7fd5b94</span>:        <span class="nc">jr</span><span class="w">      </span><span class="mi">48</span><span class="p">(</span><span class="n">t6</span><span class="p">)</span><span class="w"></span>
<span class="o">=&gt;</span><span class="w"> </span><span class="mh">0x3ff7fd5b98</span>:        <span class="nc">unimp</span><span class="w"></span>
<span class="w">   </span><span class="mh">0x3ff7fd5b9a</span>:        <span class="nc">unimp</span><span class="w"></span>
<span class="w">   </span><span class="mh">0x3ff7fd5b9c</span>:        <span class="nc">unimp</span><span class="w"></span>
<span class="w">   </span><span class="mh">0x3ff7fd5b9e</span>:        <span class="nc">lw</span><span class="w">      </span><span class="n">s0</span><span class="p">,</span><span class="mi">4</span><span class="p">(</span><span class="n">a4</span><span class="p">)</span><span class="w"></span>
<span class="w">   </span><span class="mh">0x3ff7fd5ba0</span>:        <span class="nc">fmv</span><span class="p">.</span><span class="n">d</span><span class="p">.</span><span class="n">x</span><span class="w"> </span><span class="n">fa3</span><span class="p">,</span><span class="n">t6</span><span class="w"></span>
<span class="w">   </span><span class="mh">0x3ff7fd5ba4</span>:        <span class="nc">fabs</span><span class="p">.</span><span class="n">d</span><span class="w">  </span><span class="n">fa1</span><span class="p">,</span><span class="n">fa0</span><span class="w"></span>
<span class="w">   </span><span class="mh">0x3ff7fd5ba8</span>:        <span class="nc">flt</span><span class="p">.</span><span class="n">d</span><span class="w">   </span><span class="n">a2</span><span class="p">,</span><span class="n">fa3</span><span class="p">,</span><span class="n">fa1</span><span class="w"></span>
<span class="w">   </span><span class="mh">0x3ff7fd5bac</span>:        <span class="nc">bnez</span><span class="w">    </span><span class="n">a2</span><span class="p">,</span><span class="mh">0x3ff7fd5bc8</span><span class="w"></span>
<span class="w">   </span><span class="mh">0x3ff7fd5bb0</span>:        <span class="nc">fcvt</span><span class="p">.</span><span class="n">l</span><span class="p">.</span><span class="n">d</span><span class="w">        </span><span class="n">a2</span><span class="p">,</span><span class="n">fa0</span><span class="p">,</span><span class="n">rne</span><span class="w"></span>
</code></pre></div>
<p>The start of the function is at <code>0x3ff7fd4000</code>, so this is at offset <code>0x1B98</code> in the disassembly. Which appears to be a embedded constant?</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="mi">1</span><span class="n">b88</span>:   <span class="mi">83</span><span class="w"> </span><span class="n">bf</span><span class="w"> </span><span class="n">cf</span><span class="w"> </span><span class="mi">00</span><span class="w">             </span><span class="n">ld</span><span class="w">      </span><span class="n">t6</span><span class="p">,</span><span class="w"> </span><span class="mh">0xc</span><span class="p">(</span><span class="n">t6</span><span class="p">)</span><span class="w"></span>
<span class="mi">1</span><span class="n">b8c</span>:   <span class="mi">6</span><span class="n">f</span><span class="w"> </span><span class="mi">00</span><span class="w"> </span><span class="n">c0</span><span class="w"> </span><span class="mi">00</span><span class="w">             </span><span class="n">j</span><span class="w">       </span><span class="mh">0xc</span><span class="w"></span>
<span class="mi">1</span><span class="n">b90</span>:   <span class="mi">97</span><span class="w"> </span><span class="mi">0</span><span class="n">f</span><span class="w"> </span><span class="mi">00</span><span class="w"> </span><span class="mi">00</span><span class="w">             </span><span class="n">auipc</span><span class="w">   </span><span class="n">t6</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="w"></span>
<span class="mi">1</span><span class="n">b94</span>:   <span class="mi">67</span><span class="w"> </span><span class="mi">80</span><span class="w"> </span><span class="mi">0</span><span class="n">f</span><span class="w"> </span><span class="mi">03</span><span class="w">             </span><span class="n">jalr</span><span class="w">    </span><span class="n">zero</span><span class="p">,</span><span class="w"> </span><span class="n">t6</span><span class="p">,</span><span class="w"> </span><span class="mh">0x30</span><span class="w"></span>
<span class="mi">1</span><span class="n">b98</span>:   <span class="mi">00</span><span class="w"> </span><span class="mi">00</span><span class="w"> </span><span class="mi">00</span><span class="w"> </span><span class="mi">00</span><span class="w">             </span><span class="p">.</span><span class="n">byte</span><span class="w">   </span><span class="mh">0x00</span><span class="p">,</span><span class="w"> </span><span class="mh">0x00</span><span class="p">,</span><span class="w"> </span><span class="mh">0x00</span><span class="p">,</span><span class="w"> </span><span class="mh">0x00</span><span class="w"></span>
<span class="mi">1</span><span class="n">b9c</span>:   <span class="mi">00</span><span class="w"> </span><span class="mi">00</span><span class="w"> </span><span class="mi">40</span><span class="w"> </span><span class="mi">43</span><span class="w">             </span><span class="p">.</span><span class="n">byte</span><span class="w">   </span><span class="mh">0x00</span><span class="p">,</span><span class="w"> </span><span class="mh">0x00</span><span class="p">,</span><span class="w"> </span><span class="mh">0x40</span><span class="p">,</span><span class="w"> </span><span class="mh">0x43</span><span class="w"></span>
<span class="mi">1</span><span class="n">ba0</span>:   <span class="nc">d3</span><span class="w"> </span><span class="mi">86</span><span class="w"> </span><span class="mi">0</span><span class="n">f</span><span class="w"> </span><span class="n">f2</span><span class="w">             </span><span class="n">fmv</span><span class="p">.</span><span class="n">d</span><span class="p">.</span><span class="n">x</span><span class="w"> </span><span class="n">fa3</span><span class="p">,</span><span class="w"> </span><span class="n">t6</span><span class="w"></span>
</code></pre></div>
<p>I suspect the issue here is that the instruction at <code>1b8c</code> is a jump directly into the embedded constant at <code>1b98</code>.</p>
<p>Looking at the trace logs for this range, it looks like we are emitting a veneer right at that offset? And maybe we have a constant offset in some branch that is causing this.</p>
<p><code>1b8c = 7052</code><br>
<code>1b98 = 7064</code></p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="w"> </span><span class="n">TRACE</span><span class="w"> </span><span class="n">cranelift_codegen</span>::<span class="n">machinst</span>::<span class="n">buffer</span><span class="w">     </span><span class="o">&gt;</span><span class="w"> </span><span class="n">emit_island</span>: <span class="nc">fixup</span><span class="w"> </span><span class="n">MachLabelFixup</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">label</span>: <span class="nc">MachLabel</span><span class="p">(</span><span class="mi">529</span><span class="p">),</span><span class="w"> </span><span class="n">offset</span>: <span class="mi">7040</span><span class="p">,</span><span class="w"> </span><span class="n">kind</span>: <span class="nc">B12</span><span class="w"> </span><span class="p">}</span><span class="w"></span>
<span class="w"> </span><span class="n">TRACE</span><span class="w"> </span><span class="n">cranelift_codegen</span>::<span class="n">machinst</span>::<span class="n">buffer</span><span class="w">     </span><span class="o">&gt;</span><span class="w"> </span><span class="n">MachBuffer</span>: <span class="nc">align</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="mi">4</span><span class="w"></span>
<span class="w"> </span><span class="n">TRACE</span><span class="w"> </span><span class="n">cranelift_codegen</span>::<span class="n">machinst</span>::<span class="n">buffer</span><span class="w">     </span><span class="o">&gt;</span><span class="w"> </span><span class="n">making</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="n">veneer</span><span class="w"> </span><span class="n">at</span><span class="w"> </span><span class="mi">7056</span><span class="w"></span>
<span class="w"> </span><span class="n">TRACE</span><span class="w"> </span><span class="n">cranelift_codegen</span>::<span class="n">machinst</span>::<span class="n">buffer</span><span class="w">     </span><span class="o">&gt;</span><span class="w"> </span><span class="n">patching</span><span class="w"> </span><span class="n">original</span><span class="w"> </span><span class="n">at</span><span class="w"> </span><span class="n">offset</span><span class="w"> </span><span class="mi">7040</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">veneer</span><span class="w"> </span><span class="n">offset</span><span class="w"> </span><span class="mi">7056</span><span class="w"></span>
<span class="w"> </span><span class="n">TRACE</span><span class="w"> </span><span class="n">cranelift_codegen</span>::<span class="n">machinst</span>::<span class="n">buffer</span><span class="w">     </span><span class="o">&gt;</span><span class="w"> </span><span class="n">MachBuffer</span>: <span class="nc">put</span><span class="w"> </span><span class="n">data</span><span class="w"> </span><span class="o">@</span><span class="w"> </span><span class="mi">7056</span>: <span class="nc">len</span><span class="w"> </span><span class="mi">8</span><span class="w"></span>
<span class="w"> </span><span class="n">TRACE</span><span class="w"> </span><span class="n">cranelift_codegen</span>::<span class="n">machinst</span>::<span class="n">buffer</span><span class="w">     </span><span class="o">&gt;</span><span class="w"> </span><span class="n">generated</span><span class="w"> </span><span class="n">veneer</span><span class="p">;</span><span class="w"> </span><span class="n">fixup</span><span class="w"> </span><span class="n">offset</span><span class="w"> </span><span class="mi">7056</span><span class="p">,</span><span class="w"> </span><span class="n">label_use</span><span class="w"> </span><span class="n">PCRel32</span><span class="w"></span>
<span class="w"> </span><span class="n">TRACE</span><span class="w"> </span><span class="n">cranelift_codegen</span>::<span class="n">machinst</span>::<span class="n">buffer</span><span class="w">     </span><span class="o">&gt;</span><span class="w"> </span><span class="n">MachBuffer</span>: <span class="nc">use_label_at_offset</span>: <span class="nc">offset</span><span class="w"> </span><span class="mi">7056</span><span class="w"> </span><span class="n">label</span><span class="w"> </span><span class="n">MachLabel</span><span class="p">(</span><span class="mi">529</span><span class="p">)</span><span class="w"> </span><span class="n">kind</span><span class="w"> </span><span class="n">PCRel32</span><span class="w"></span>
<span class="w"> </span><span class="n">TRACE</span><span class="w"> </span><span class="n">cranelift_codegen</span>::<span class="n">machinst</span>::<span class="n">buffer</span><span class="w">     </span><span class="o">&gt;</span><span class="w"> </span><span class="n">MachBuffer</span>: <span class="nc">put</span><span class="w"> </span><span class="n">data</span><span class="w"> </span><span class="o">@</span><span class="w"> </span><span class="mi">7064</span>: <span class="nc">len</span><span class="w"> </span><span class="mi">8</span><span class="w"></span>
<span class="w"> </span><span class="n">TRACE</span><span class="w"> </span><span class="n">cranelift_codegen</span>::<span class="n">machinst</span>::<span class="n">buffer</span><span class="w">     </span><span class="o">&gt;</span><span class="w"> </span><span class="n">MachBuffer</span>: <span class="nc">put</span><span class="w"> </span><span class="mi">32</span><span class="o">-</span><span class="n">bit</span><span class="w"> </span><span class="n">word</span><span class="w"> </span><span class="o">@</span><span class="w"> </span><span class="mi">7072</span>: <span class="nc">f20f86d3</span><span class="w"></span>
<span class="w"> </span><span class="n">TRACE</span><span class="w"> </span><span class="n">cranelift_codegen</span>::<span class="n">machinst</span>::<span class="n">buffer</span><span class="w">     </span><span class="o">&gt;</span><span class="w"> </span><span class="n">MachBuffer</span>: <span class="nc">put</span><span class="w"> </span><span class="mi">32</span><span class="o">-</span><span class="n">bit</span><span class="w"> </span><span class="n">word</span><span class="w"> </span><span class="o">@</span><span class="w"> </span><span class="mi">7076</span>: <span class="mi">22</span><span class="n">a525d3</span><span class="w"></span>
<span class="w"> </span><span class="n">TRACE</span><span class="w"> </span><span class="n">cranelift_codegen</span>::<span class="n">machinst</span>::<span class="n">buffer</span><span class="w">     </span><span class="o">&gt;</span><span class="w"> </span><span class="n">MachBuffer</span>: <span class="nc">put</span><span class="w"> </span><span class="mi">32</span><span class="o">-</span><span class="n">bit</span><span class="w"> </span><span class="n">word</span><span class="w"> </span><span class="o">@</span><span class="w"> </span><span class="mi">7080</span>: <span class="nc">a2b69653</span><span class="w"></span>
<span class="w"> </span><span class="n">TRACE</span><span class="w"> </span><span class="n">cranelift_codegen</span>::<span class="n">machinst</span>::<span class="n">buffer</span><span class="w">     </span><span class="o">&gt;</span><span class="w"> </span><span class="n">MachBuffer</span>: <span class="nc">use_label_at_offset</span>: <span class="nc">offset</span><span class="w"> </span><span class="mi">7084</span><span class="w"> </span><span class="n">label</span><span class="w"> </span><span class="n">MachLabel</span><span class="p">(</span><span class="mi">530</span><span class="p">)</span><span class="w"> </span><span class="n">kind</span><span class="w"> </span><span class="n">B12</span><span class="w"></span>
</code></pre></div>
<p>I'm not too sure how to translate these offsets into an actual clif instruction that is causing this issue.</p>
<p>Edit: This seems to be caused by us not using labels in <a href="https://github.com/bytecodealliance/wasmtime/blob/cbeec5ddb929e1c6e77f19731e4e3cf1bc9817d0/cranelift/codegen/src/isa/riscv64/inst/emit.rs#L78"><code>load_constant</code></a>.</p>
</blockquote>



<hr><p>Last updated: Jan 20 2025 at 06:04 UTC</p>
</html>