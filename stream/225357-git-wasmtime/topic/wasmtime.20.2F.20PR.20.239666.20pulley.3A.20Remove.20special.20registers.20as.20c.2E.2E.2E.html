<html>
<head><meta charset="utf-8"><title>wasmtime / PR #9666 pulley: Remove special registers as c... · git-wasmtime · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/index.html">git-wasmtime</a></h2>
<h3>Topic: <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.239666.20pulley.3A.20Remove.20special.20registers.20as.20c.2E.2E.2E.html">wasmtime / PR #9666 pulley: Remove special registers as c...</a></h3>

<hr>

<base href="https://bytecodealliance.zulipchat.com">

<head><link href="https://bytecodealliance.github.io/zulip-archive/style.css" rel="stylesheet"></head>

<a name="484004166"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%239666%20pulley%3A%20Remove%20special%20registers%20as%20c.../near/484004166" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.239666.20pulley.3A.20Remove.20special.20registers.20as.20c.2E.2E.2E.html#484004166">(Nov 22 2024 at 22:54)</a>:</h4>
<p>alexcrichton opened <a href="https://github.com/bytecodealliance/wasmtime/pull/9666">PR #9666</a> from <code>alexcrichton:remove-some-registers</code> to <code>bytecodealliance:main</code>:</p>
<blockquote>
<p>This commit fixes a minor mistake where regalloc was allowed to allocate "special registers" such as the stack pointer, the frame pointer, etc. These register shouldn't participate in general-purpose register allocation, so they're removed from the list of non-preferred registers when metadata is provided to regalloc2.</p>
<p>&lt;!--<br>
Please make sure you include the following information:</p>
<ul>
<li>
<p>If this work has been discussed elsewhere, please include a link to that<br>
  conversation. If it was discussed in an issue, just mention "issue #...".</p>
</li>
<li>
<p>Explain why this change is needed. If the details are in an issue already,<br>
  this can be brief.</p>
</li>
</ul>
<p>Our development process is documented in the Wasmtime book:<br>
<a href="https://docs.wasmtime.dev/contributing-development-process.html">https://docs.wasmtime.dev/contributing-development-process.html</a></p>
<p>Please ensure all communication follows the code of conduct:<br>
<a href="https://github.com/bytecodealliance/wasmtime/blob/main/CODE_OF_CONDUCT.md">https://github.com/bytecodealliance/wasmtime/blob/main/CODE_OF_CONDUCT.md</a><br>
--&gt;</p>
</blockquote>



<a name="484004168"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%239666%20pulley%3A%20Remove%20special%20registers%20as%20c.../near/484004168" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.239666.20pulley.3A.20Remove.20special.20registers.20as.20c.2E.2E.2E.html#484004168">(Nov 22 2024 at 22:54)</a>:</h4>
<p><strong>alexcrichton</strong> requested <a href="https://github.com/cfallin">cfallin</a> for a review on <a href="https://github.com/bytecodealliance/wasmtime/pull/9666">PR #9666</a>.</p>



<a name="484004169"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%239666%20pulley%3A%20Remove%20special%20registers%20as%20c.../near/484004169" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.239666.20pulley.3A.20Remove.20special.20registers.20as.20c.2E.2E.2E.html#484004169">(Nov 22 2024 at 22:54)</a>:</h4>
<p><strong>alexcrichton</strong> requested <a href="https://github.com/orgs/bytecodealliance/teams/wasmtime-compiler-reviewers">wasmtime-compiler-reviewers</a> for a review on <a href="https://github.com/bytecodealliance/wasmtime/pull/9666">PR #9666</a>.</p>



<a name="484004170"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%239666%20pulley%3A%20Remove%20special%20registers%20as%20c.../near/484004170" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.239666.20pulley.3A.20Remove.20special.20registers.20as.20c.2E.2E.2E.html#484004170">(Nov 22 2024 at 22:54)</a>:</h4>
<p><strong>alexcrichton</strong> requested <a href="https://github.com/orgs/bytecodealliance/teams/wasmtime-default-reviewers">wasmtime-default-reviewers</a> for a review on <a href="https://github.com/bytecodealliance/wasmtime/pull/9666">PR #9666</a>.</p>



<a name="484004714"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%239666%20pulley%3A%20Remove%20special%20registers%20as%20c.../near/484004714" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.239666.20pulley.3A.20Remove.20special.20registers.20as.20c.2E.2E.2E.html#484004714">(Nov 22 2024 at 22:59)</a>:</h4>
<p>cfallin submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/9666#pullrequestreview-2455930606">PR review</a>:</p>
<blockquote>
<p>Good catch!</p>
</blockquote>



<a name="484004715"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%239666%20pulley%3A%20Remove%20special%20registers%20as%20c.../near/484004715" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.239666.20pulley.3A.20Remove.20special.20registers.20as.20c.2E.2E.2E.html#484004715">(Nov 22 2024 at 22:59)</a>:</h4>
<p>cfallin created <a href="https://github.com/bytecodealliance/wasmtime/pull/9666#discussion_r1854849100">PR review comment</a>:</p>
<blockquote>
<p>Do we have constants for sp and fp? Can we define them like <code>SPECIAL_START + 0</code> and <code>SPECIAL_START + 1</code> to ensure this stays in sync?</p>
</blockquote>



<a name="484005166"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%239666%20pulley%3A%20Remove%20special%20registers%20as%20c.../near/484005166" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.239666.20pulley.3A.20Remove.20special.20registers.20as.20c.2E.2E.2E.html#484005166">(Nov 22 2024 at 23:02)</a>:</h4>
<p>alexcrichton submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/9666#pullrequestreview-2455947792">PR review</a>.</p>



<a name="484005167"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%239666%20pulley%3A%20Remove%20special%20registers%20as%20c.../near/484005167" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.239666.20pulley.3A.20Remove.20special.20registers.20as.20c.2E.2E.2E.html#484005167">(Nov 22 2024 at 23:02)</a>:</h4>
<p>alexcrichton created <a href="https://github.com/bytecodealliance/wasmtime/pull/9666#discussion_r1854859717">PR review comment</a>:</p>
<blockquote>
<p>Does <a href="https://github.com/bytecodealliance/wasmtime/pull/9666/files#diff-577507af7de53d99c50170886b2c15e77f63375efaeb450058275f4eae3fc1d9R103">this test</a> do what you're thinking?</p>
</blockquote>



<a name="484006205"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%239666%20pulley%3A%20Remove%20special%20registers%20as%20c.../near/484006205" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.239666.20pulley.3A.20Remove.20special.20registers.20as.20c.2E.2E.2E.html#484006205">(Nov 22 2024 at 23:12)</a>:</h4>
<p>cfallin submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/9666#pullrequestreview-2455966004">PR review</a>.</p>



<a name="484006206"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%239666%20pulley%3A%20Remove%20special%20registers%20as%20c.../near/484006206" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.239666.20pulley.3A.20Remove.20special.20registers.20as.20c.2E.2E.2E.html#484006206">(Nov 22 2024 at 23:12)</a>:</h4>
<p>cfallin created <a href="https://github.com/bytecodealliance/wasmtime/pull/9666#discussion_r1854868414">PR review comment</a>:</p>
<blockquote>
<p>That tests the other direction: it asserts that every register from <code>SPECIAL_START</code> onward is special, but it doesn't test that every special register is beyond <code>SPECIAL_START</code>. I guess I'm suggesting a different way to define fp and sp, where we use the constant (plus a nonnegative offset) directly to have this by construction.</p>
</blockquote>



<a name="484006692"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%239666%20pulley%3A%20Remove%20special%20registers%20as%20c.../near/484006692" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.239666.20pulley.3A.20Remove.20special.20registers.20as.20c.2E.2E.2E.html#484006692">(Nov 22 2024 at 23:17)</a>:</h4>
<p>alexcrichton submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/9666#pullrequestreview-2455971704">PR review</a>.</p>



<a name="484006694"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%239666%20pulley%3A%20Remove%20special%20registers%20as%20c.../near/484006694" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.239666.20pulley.3A.20Remove.20special.20registers.20as.20c.2E.2E.2E.html#484006694">(Nov 22 2024 at 23:17)</a>:</h4>
<p>alexcrichton created <a href="https://github.com/bytecodealliance/wasmtime/pull/9666#discussion_r1854872233">PR review comment</a>:</p>
<blockquote>
<p>Ah good point! The way these are defined in pulley is a bit special right now where each register is an <code>enum XReg { x0, ... sp, ... }</code> for example. That's uniform across x/f/v registers so I'm wary to change that much. That being said I'll enhance the test to assert that everything before <code>SPECIAL_START</code> is non-special.</p>
</blockquote>



<a name="484006794"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%239666%20pulley%3A%20Remove%20special%20registers%20as%20c.../near/484006794" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.239666.20pulley.3A.20Remove.20special.20registers.20as.20c.2E.2E.2E.html#484006794">(Nov 22 2024 at 23:18)</a>:</h4>
<p>alexcrichton updated <a href="https://github.com/bytecodealliance/wasmtime/pull/9666">PR #9666</a>.</p>



<a name="484007571"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%239666%20pulley%3A%20Remove%20special%20registers%20as%20c.../near/484007571" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.239666.20pulley.3A.20Remove.20special.20registers.20as.20c.2E.2E.2E.html#484007571">(Nov 22 2024 at 23:26)</a>:</h4>
<p>cfallin submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/9666#pullrequestreview-2455985155">PR review</a>.</p>



<a name="484007606"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%239666%20pulley%3A%20Remove%20special%20registers%20as%20c.../near/484007606" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.239666.20pulley.3A.20Remove.20special.20registers.20as.20c.2E.2E.2E.html#484007606">(Nov 22 2024 at 23:26)</a>:</h4>
<p>cfallin submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/9666#pullrequestreview-2455986624">PR review</a>.</p>



<a name="484007607"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%239666%20pulley%3A%20Remove%20special%20registers%20as%20c.../near/484007607" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.239666.20pulley.3A.20Remove.20special.20registers.20as.20c.2E.2E.2E.html#484007607">(Nov 22 2024 at 23:26)</a>:</h4>
<p>cfallin created <a href="https://github.com/bytecodealliance/wasmtime/pull/9666#discussion_r1854882126">PR review comment</a>:</p>
<blockquote>
<p>Looks good!</p>
</blockquote>



<a name="484007639"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%239666%20pulley%3A%20Remove%20special%20registers%20as%20c.../near/484007639" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.239666.20pulley.3A.20Remove.20special.20registers.20as.20c.2E.2E.2E.html#484007639">(Nov 22 2024 at 23:27)</a>:</h4>
<p>cfallin has enabled auto merge for <a href="https://github.com/bytecodealliance/wasmtime/pull/9666">PR #9666</a>.</p>



<a name="484007801"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%239666%20pulley%3A%20Remove%20special%20registers%20as%20c.../near/484007801" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.239666.20pulley.3A.20Remove.20special.20registers.20as.20c.2E.2E.2E.html#484007801">(Nov 22 2024 at 23:28)</a>:</h4>
<p>alexcrichton has disabled auto merge for <a href="https://github.com/bytecodealliance/wasmtime/pull/9666">PR #9666</a>.</p>



<a name="484007805"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%239666%20pulley%3A%20Remove%20special%20registers%20as%20c.../near/484007805" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.239666.20pulley.3A.20Remove.20special.20registers.20as.20c.2E.2E.2E.html#484007805">(Nov 22 2024 at 23:28)</a>:</h4>
<p>alexcrichton has enabled auto merge for <a href="https://github.com/bytecodealliance/wasmtime/pull/9666">PR #9666</a>.</p>



<a name="484009751"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%239666%20pulley%3A%20Remove%20special%20registers%20as%20c.../near/484009751" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.239666.20pulley.3A.20Remove.20special.20registers.20as.20c.2E.2E.2E.html#484009751">(Nov 22 2024 at 23:50)</a>:</h4>
<p>alexcrichton merged <a href="https://github.com/bytecodealliance/wasmtime/pull/9666">PR #9666</a>.</p>



<hr><p>Last updated: Jan 20 2025 at 06:04 UTC</p>
</html>