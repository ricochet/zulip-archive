<html>
<head><meta charset="utf-8"><title>wasmtime / issue #572 wasm64 support · git-wasmtime · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/index.html">git-wasmtime</a></h2>
<h3>Topic: <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.23572.20wasm64.20support.html">wasmtime / issue #572 wasm64 support</a></h3>

<hr>

<base href="https://bytecodealliance.zulipchat.com">

<head><link href="https://bytecodealliance.github.io/zulip-archive/style.css" rel="stylesheet"></head>

<a name="241658456"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%23572%20wasm64%20support/near/241658456" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.23572.20wasm64.20support.html#241658456">(Jun 05 2021 at 22:09)</a>:</h4>
<p>lastmjs <a href="https://github.com/bytecodealliance/wasmtime/issues/572#issuecomment-855302429">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/572">issue #572</a>:</p>
<blockquote>
<p>Any update on the progress here? I'm working on building applications for the DFINITY Internet Computer, and having wasm64 working could do wonders for applications scaling on the Internet Computer. Right now applications (canisters) are limited to 4gb in size without doing some relatively complicated cross-canister scaling.</p>
</blockquote>



<a name="241665415"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%23572%20wasm64%20support/near/241665415" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.23572.20wasm64.20support.html#241665415">(Jun 06 2021 at 01:32)</a>:</h4>
<p>aardappel <a href="https://github.com/bytecodealliance/wasmtime/issues/572#issuecomment-855321308">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/572">issue #572</a>:</p>
<blockquote>
<p>@lastmjs Memory64 has progressed to a stage 3 proposal, LLVM/WABT/Binaryen support has further matured, spec implementation is available. The biggest things still not finished are Emscripten support (which is in progress) and of course VM support (V8 is in progress, not aware of others that have started).</p>
<p>Wasmtime support would be great! Who's going to take it on? :)</p>
</blockquote>



<a name="246661571"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%23572%20wasm64%20support/near/246661571" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.23572.20wasm64.20support.html#246661571">(Jul 20 2021 at 23:06)</a>:</h4>
<p>zeroexcuses <a href="https://github.com/bytecodealliance/wasmtime/issues/572#issuecomment-883762122">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/572">issue #572</a>:</p>
<blockquote>
<p>Are there any toy repos where someone has forked wasmtime to add wasm64 support? In my very limited understanding, the start of it is:</p>
<ol>
<li>change u32 to u64 here: <a href="https://github.com/bytecodealliance/wasm-tools/blob/main/crates/wasmparser/src/primitives.rs#L260-L261">https://github.com/bytecodealliance/wasm-tools/blob/main/crates/wasmparser/src/primitives.rs#L260-L261</a></li>
<li>modify all the functions regarding memarg at <a href="https://github.com/bytecodealliance/wasmtime/blob/main/cranelift/wasm/src/code_translator.rs#L118">https://github.com/bytecodealliance/wasmtime/blob/main/cranelift/wasm/src/code_translator.rs#L118</a></li>
<li>remove the 32-bit bound check (bad for security), possibly add bounds check (bad for performance) [here, I'm running 'trusted' wasm64 code]</li>
</ol>
<p>This is a bit above my current cranelift knowledge. Is there any repo/toolchain where someone forked all this and patched it?</p>
</blockquote>



<a name="246733836"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%23572%20wasm64%20support/near/246733836" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.23572.20wasm64.20support.html#246733836">(Jul 21 2021 at 15:12)</a>:</h4>
<p>alexcrichton <a href="https://github.com/bytecodealliance/wasmtime/issues/572#issuecomment-884269233">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/572">issue #572</a>:</p>
<blockquote>
<p>FWIW the wasmparser crate, part of <a href="https://github.com/bytecodealliance/wasm-tools">wasm-tools</a>, should already support wasm64 in that it implments validation and decoding support. What's not supported is Wasmtime's <code>code_translator.rs</code> or the supporting runtime support, since that's all geared towards 32-bit. AFAIK though there's no fork of Wasmtime with this implemented at this time (but I could be wrong!)</p>
</blockquote>



<a name="246737832"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%23572%20wasm64%20support/near/246737832" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.23572.20wasm64.20support.html#246737832">(Jul 21 2021 at 15:44)</a>:</h4>
<p>zeroexcuses <a href="https://github.com/bytecodealliance/wasmtime/issues/572#issuecomment-884292557">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/572">issue #572</a>:</p>
<blockquote>
<p>The following two beliefs contradict:</p>
<ol>
<li>
<p>@alexcrichton : Because you are one of the top wasmtime committers, I want to believe "FWIW the wasmparser crate, part of wasm-tools, should already support wasm64 in that it implments validation and decoding support." is true</p>
</li>
<li>
<p><a href="https://github.com/bytecodealliance/wasm-tools/blob/main/crates/wasmparser/src/primitives.rs#L260-L261">https://github.com/bytecodealliance/wasm-tools/blob/main/crates/wasmparser/src/primitives.rs#L260-L261</a> literally states:</p>
</li>
</ol>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="cp">#[derive(Debug, Copy, Clone)]</span><span class="w"></span>
<span class="k">pub</span><span class="w"> </span><span class="k">struct</span> <span class="nc">MemoryImmediate</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="sd">/// Alignment, stored as `n` where the actual alignment is `2^n`</span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="n">align</span>: <span class="kt">u8</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="n">offset</span>: <span class="kt">u32</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="n">memory</span>: <span class="kt">u32</span><span class="p">,</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>
<p>Unless this is some type of weird encoding where <code>actual_address = memory * 2^32 + offset</code>, I don't see how wasm-parser could possibly support wasm64. </p>
<p>Am I mis understanding something fundamental? Does wasm64 not store address as a single u64? If I am misunderstanding this, can you point me to the documentation on how wasm64 does store addresses ?</p>
</blockquote>



<a name="246741747"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%23572%20wasm64%20support/near/246741747" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.23572.20wasm64.20support.html#246741747">(Jul 21 2021 at 16:14)</a>:</h4>
<p>alexcrichton <a href="https://github.com/bytecodealliance/wasmtime/issues/572#issuecomment-884314689">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/572">issue #572</a>:</p>
<blockquote>
<p>In that structure the <code>align</code> field doesn't need to change since it can already represent all reasonable alignments. The <code>offset</code> field is just a fixed offset encoded in the <code>memarg</code> structure. The memory64 proposal <a href="https://github.com/WebAssembly/memory64/blob/master/proposals/memory64/Overview.md">now indicates that this can be up to 64-bits</a>, but I think at the time I implemented memory64 validation that wasn't clarified in the upstream proposal. The <code>memory</code> field is the index of the memory being used, and that does not change in the memory64 proposal.</p>
<p>That <code>MemoryImmediate</code> structure is an AST-level construct, not something used at runtime. It does not represent actual raw addresses, but rather it's the <code>memarg</code> from the spec on each memory-related instruction, describing which memory is being operated on, the alignment of the operation, and the fixed offset from the runtime-calculated address, if any.</p>
</blockquote>



<a name="246743050"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%23572%20wasm64%20support/near/246743050" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.23572.20wasm64.20support.html#246743050">(Jul 21 2021 at 16:24)</a>:</h4>
<p>zeroexcuses <a href="https://github.com/bytecodealliance/wasmtime/issues/572#issuecomment-884321653">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/572">issue #572</a>:</p>
<blockquote>
<p>Is <a href="https://github.com/bytecodealliance/wasm-tools/blob/main/crates/wast/src/ast/expr.rs#L1235-L1246">https://github.com/bytecodealliance/wasm-tools/blob/main/crates/wast/src/ast/expr.rs#L1235-L1246</a></p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="c1">// from wast crate</span>
<span class="cp">#[derive(Debug)]</span><span class="w"></span>
<span class="k">pub</span><span class="w"> </span><span class="k">struct</span> <span class="nc">MemArg</span><span class="o">&lt;'</span><span class="na">a</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="sd">/// The alignment of this access.</span>
<span class="w">    </span><span class="sd">///</span>
<span class="w">    </span><span class="sd">/// This is not stored as a log, this is the actual alignment (e.g. 1, 2, 4,</span>
<span class="w">    </span><span class="sd">/// 8, etc).</span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="n">align</span>: <span class="kt">u32</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="sd">/// The offset, in bytes of this access.</span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="n">offset</span>: <span class="kt">u32</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="sd">/// The memory index we're accessing</span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="n">memory</span>: <span class="nc">ast</span>::<span class="n">ItemRef</span><span class="o">&lt;'</span><span class="na">a</span><span class="p">,</span><span class="w"> </span><span class="n">kw</span>::<span class="n">memory</span><span class="o">&gt;</span><span class="p">,</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>
<p>the right MemoryArg ?</p>
<p>// =============================</p>
<p>It seems like, either way, I need to "fork the instruction set". Two options are:</p>
<ol>
<li>fork wast::Instruction <a href="https://github.com/bytecodealliance/wasm-tools/blob/main/crates/wast/src/ast/expr.rs#L499">https://github.com/bytecodealliance/wasm-tools/blob/main/crates/wast/src/ast/expr.rs#L499</a></li>
<li>fork wasmparser::Operator <a href="https://github.com/bytecodealliance/wasm-tools/blob/main/crates/wasmparser/src/primitives.rs#L350">https://github.com/bytecodealliance/wasm-tools/blob/main/crates/wasmparser/src/primitives.rs#L350</a></li>
</ol>
<p>I was wondering if you had advice on which route might be nicer (the two enums look very similar).</p>
</blockquote>



<a name="246743156"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%23572%20wasm64%20support/near/246743156" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.23572.20wasm64.20support.html#246743156">(Jul 21 2021 at 16:25)</a>:</h4>
<p>zeroexcuses edited a <a href="https://github.com/bytecodealliance/wasmtime/issues/572#issuecomment-884321653">comment</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/572">issue #572</a>:</p>
<blockquote>
<p>Is <a href="https://github.com/bytecodealliance/wasm-tools/blob/main/crates/wast/src/ast/expr.rs#L1235-L1246">https://github.com/bytecodealliance/wasm-tools/blob/main/crates/wast/src/ast/expr.rs#L1235-L1246</a></p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="c1">// from wast crate</span>
<span class="cp">#[derive(Debug)]</span><span class="w"></span>
<span class="k">pub</span><span class="w"> </span><span class="k">struct</span> <span class="nc">MemArg</span><span class="o">&lt;'</span><span class="na">a</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="sd">/// The alignment of this access.</span>
<span class="w">    </span><span class="sd">///</span>
<span class="w">    </span><span class="sd">/// This is not stored as a log, this is the actual alignment (e.g. 1, 2, 4,</span>
<span class="w">    </span><span class="sd">/// 8, etc).</span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="n">align</span>: <span class="kt">u32</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="sd">/// The offset, in bytes of this access.</span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="n">offset</span>: <span class="kt">u32</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="sd">/// The memory index we're accessing</span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="n">memory</span>: <span class="nc">ast</span>::<span class="n">ItemRef</span><span class="o">&lt;'</span><span class="na">a</span><span class="p">,</span><span class="w"> </span><span class="n">kw</span>::<span class="n">memory</span><span class="o">&gt;</span><span class="p">,</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>
<p>the right MemArg ?</p>
<p>// =============================</p>
<p>It seems like, either way, I need to "fork the instruction set". Two options are:</p>
<ol>
<li>fork wast::Instruction <a href="https://github.com/bytecodealliance/wasm-tools/blob/main/crates/wast/src/ast/expr.rs#L499">https://github.com/bytecodealliance/wasm-tools/blob/main/crates/wast/src/ast/expr.rs#L499</a></li>
<li>fork wasmparser::Operator <a href="https://github.com/bytecodealliance/wasm-tools/blob/main/crates/wasmparser/src/primitives.rs#L350">https://github.com/bytecodealliance/wasm-tools/blob/main/crates/wasmparser/src/primitives.rs#L350</a></li>
</ol>
<p>I was wondering if you had advice on which route might be nicer (the two enums look very similar).</p>
</blockquote>



<a name="246748830"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%23572%20wasm64%20support/near/246748830" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.23572.20wasm64.20support.html#246748830">(Jul 21 2021 at 17:04)</a>:</h4>
<p>alexcrichton <a href="https://github.com/bytecodealliance/wasmtime/issues/572#issuecomment-884346824">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/572">issue #572</a>:</p>
<blockquote>
<p>Are you looking to implement wasm64? (sorry I'm not sure if you're looking to learn information about the state of things or whether you're looking to help push forward the state of things)</p>
</blockquote>



<a name="246756883"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%23572%20wasm64%20support/near/246756883" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.23572.20wasm64.20support.html#246756883">(Jul 21 2021 at 18:04)</a>:</h4>
<p>zeroexcuses <a href="https://github.com/bytecodealliance/wasmtime/issues/572#issuecomment-884384353">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/572">issue #572</a>:</p>
<blockquote>
<blockquote>
<p>Are you looking to implement wasm64? (sorry I'm not sure if you're looking to learn information about the state of things or whether you're looking to help push forward the state of things)</p>
</blockquote>
<p>I am looking to throw together a toy prototype with the following properties:</p>
<p>* language looks like wasm, but uses 64-bit instead of 32-bit addresses<br>
  * on x86_64, JITs via cranelift into native code<br>
  * executes 'trusted' code (i.e. no bound checks)</p>
<p>The XY problem is that I am generating wasm32 not via LLVM/Cranelift, but by my own toy code generator. I want to be able to swap in something that allows for &gt; 4GB memory.</p>
</blockquote>



<a name="246757048"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%23572%20wasm64%20support/near/246757048" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.23572.20wasm64.20support.html#246757048">(Jul 21 2021 at 18:05)</a>:</h4>
<p>zeroexcuses edited a <a href="https://github.com/bytecodealliance/wasmtime/issues/572#issuecomment-884384353">comment</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/572">issue #572</a>:</p>
<blockquote>
<blockquote>
<p>Are you looking to implement wasm64? (sorry I'm not sure if you're looking to learn information about the state of things or whether you're looking to help push forward the state of things)</p>
</blockquote>
<p>I am looking to throw together a toy prototype with the following properties:</p>
<p>* language looks like wasm, but uses 64-bit instead of 32-bit addresses<br>
  * on x86_64, JITs via cranelift into native code<br>
  * executes 'trusted' code (i.e. no bound checks)</p>
<p>The XY problem is that I am generating wasm32 not via LLVM/Cranelift, but by my own toy code generator. I want to be able to swap in something that allows for &gt; 4GB memory.</p>
<p>EDIT: I acknowledge this is quite different from 'write a wasm64 backend that passes wasmtime's coding standards and plays nicely with the rest of the wasmtime toolchain'</p>
</blockquote>



<a name="246774530"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%23572%20wasm64%20support/near/246774530" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.23572.20wasm64.20support.html#246774530">(Jul 21 2021 at 20:32)</a>:</h4>
<p>alexcrichton <a href="https://github.com/bytecodealliance/wasmtime/issues/572#issuecomment-884480143">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/572">issue #572</a>:</p>
<blockquote>
<p>If you're goal is to just use Cranelift I don't think there's any changes necessary, the rustc backend using Cranelift is already for x86_64 and works reasonably well. Otherwise if you want to work with wasm you can probably get away with a few small edits to <code>code_translator.rs</code>. Other than that though you're likely in territory I'm at least personally not able to help too much with.</p>
</blockquote>



<a name="246775052"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%23572%20wasm64%20support/near/246775052" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.23572.20wasm64.20support.html#246775052">(Jul 21 2021 at 20:36)</a>:</h4>
<p>zeroexcuses <a href="https://github.com/bytecodealliance/wasmtime/issues/572#issuecomment-884482686">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/572">issue #572</a>:</p>
<blockquote>
<p>I don't think I explained this well. I have</p>
<ol>
<li>a toy language FooLang</li>
<li>a toy compiler FooLang -&gt; wast::{Module, Func, Instruction} -&gt; wasmtime -&gt; x86_64</li>
<li>(2) however, is limited to 4GB memory; I want to eliminate this limitation</li>
<li>I'm going for something like FooLang -&gt; (something that looks like wasm64) -&gt; cranelift_wasm -&gt; x86_64</li>
</ol>
<p>I am trying to figure out the minimal patch to { wast or wasmparser } + cranelift_wasm to (1) have the "wasm-like ast" be able to have 64 bit address and (2) generate corresponding instrs</p>
</blockquote>



<a name="246853455"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%23572%20wasm64%20support/near/246853455" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.23572.20wasm64.20support.html#246853455">(Jul 22 2021 at 14:21)</a>:</h4>
<p>alexcrichton <a href="https://github.com/bytecodealliance/wasmtime/issues/572#issuecomment-884952776">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/572">issue #572</a>:</p>
<blockquote>
<p>Ah ok, unfortunately though I don't think there's a too-minimal-path. I think that wasm64 just needs to be implemented in cranelift-wasm.</p>
</blockquote>



<a name="246901918"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%23572%20wasm64%20support/near/246901918" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.23572.20wasm64.20support.html#246901918">(Jul 22 2021 at 20:38)</a>:</h4>
<p>zeroexcuses <a href="https://github.com/bytecodealliance/wasmtime/issues/572#issuecomment-885217238">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/572">issue #572</a>:</p>
<blockquote>
<p>The current 'minimal' changes I see are:</p>
<ol>
<li>copy <a href="https://github.com/bytecodealliance/wasm-tools/tree/main/crates/wast">https://github.com/bytecodealliance/wasm-tools/tree/main/crates/wast</a> -&gt; wast64, change some u32 to u64 // this gives us an instruction set that supports 64bit addr</li>
<li>copy <a href="https://github.com/bytecodealliance/wasm-tools/tree/main/crates/wasmparser">https://github.com/bytecodealliance/wasm-tools/tree/main/crates/wasmparser</a> -&gt; wasmparser64, changes some u32 to u64 // this gets us 64bit addr while parsing</li>
<li>copy <a href="https://github.com/bytecodealliance/wasmtime/tree/main/cranelift/wasm">https://github.com/bytecodealliance/wasmtime/tree/main/cranelift/wasm</a> -&gt; cranelift-wasm64, add support to generating instrs for 64-bit addr</li>
<li>then, look at dependents of these 3 libs in the wasmtime tree, copy them, adding -64 prefix</li>
</ol>
<p>Is this approximately the 'minimal' path ?</p>
</blockquote>



<a name="246902694"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%23572%20wasm64%20support/near/246902694" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.23572.20wasm64.20support.html#246902694">(Jul 22 2021 at 20:45)</a>:</h4>
<p>bjorn3 <a href="https://github.com/bytecodealliance/wasmtime/issues/572#issuecomment-885220946">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/572">issue #572</a>:</p>
<blockquote>
<p>I think all of them should support both 32bit and 64bit memories especially because the multi-memory proposal allows mixing loads and stores to 32bit and 64bit memories within a single function.</p>
</blockquote>



<a name="246908114"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%23572%20wasm64%20support/near/246908114" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.23572.20wasm64.20support.html#246908114">(Jul 22 2021 at 21:25)</a>:</h4>
<p>zeroexcuses <a href="https://github.com/bytecodealliance/wasmtime/issues/572#issuecomment-885245809">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/572">issue #572</a>:</p>
<blockquote>
<blockquote>
<p>I think all of them should support both 32bit and 64bit memories especially because the multi-memory proposal allows mixing loads and stores to 32bit and 64bit memories within a single function.</p>
</blockquote>
<p>In the general case, I agree that you are right. For my particular case, given:</p>
<blockquote>
<p>I'm going for something like FooLang -&gt; (something that looks like wasm64) -&gt; cranelift_wasm -&gt; x86_64</p>
</blockquote>
<p>only having 64 bit addr would be an acceptable first step</p>
</blockquote>



<a name="246908427"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%23572%20wasm64%20support/near/246908427" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.23572.20wasm64.20support.html#246908427">(Jul 22 2021 at 21:29)</a>:</h4>
<p>abrown <a href="https://github.com/bytecodealliance/wasmtime/issues/572#issuecomment-885247979">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/572">issue #572</a>:</p>
<blockquote>
<p>Why not just implement the proposal as specified--for both memory sizes? It doesn't seem like that much more work and you would probably get some more help from maintainers of all these libraries since it helps them implement the proposal?</p>
</blockquote>



<a name="246910063"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%23572%20wasm64%20support/near/246910063" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.23572.20wasm64.20support.html#246910063">(Jul 22 2021 at 21:50)</a>:</h4>
<p>zeroexcuses <a href="https://github.com/bytecodealliance/wasmtime/issues/572#issuecomment-885258034">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/572">issue #572</a>:</p>
<blockquote>
<blockquote>
<p>Why not just implement the proposal as specified--for both memory sizes? It doesn't seem like that much more work and you would probably get some more help from maintainers of all these libraries since it helps them implement the proposal?</p>
</blockquote>
<ol>
<li>
<p>I have previously been playing around with wast &amp; cranelift-jit, so I believe the hack I have outlined above is a matter of days, whereas I have no idea how much work full wasm64 is (given no one has done it, sounds like months?)</p>
</li>
<li>
<p>I don't think it's honest to pretend to care about something I don't care about just to get help from maintainers.</p>
</li>
</ol>
</blockquote>



<a name="247249920"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%23572%20wasm64%20support/near/247249920" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.23572.20wasm64.20support.html#247249920">(Jul 26 2021 at 19:29)</a>:</h4>
<p>zeroexcuses <a href="https://github.com/bytecodealliance/wasmtime/issues/572#issuecomment-886968162">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/572">issue #572</a>:</p>
<blockquote>
<p>Does <a href="https://github.com/bytecodealliance/wasmtime/tree/main/crates/lightbeam">https://github.com/bytecodealliance/wasmtime/tree/main/crates/lightbeam</a> work ? I am trying to run the examples at:</p>
<p>* <a href="https://github.com/bytecodealliance/wasmtime/blob/main/crates/lightbeam/examples/test.rs">https://github.com/bytecodealliance/wasmtime/blob/main/crates/lightbeam/examples/test.rs</a><br>
  * <a href="https://github.com/bytecodealliance/wasmtime/blob/main/crates/lightbeam/src/benches.rs">https://github.com/bytecodealliance/wasmtime/blob/main/crates/lightbeam/src/benches.rs</a><br>
but getting error: <code> enches::bench_fibonacci_run' panicked at 'not implemented: can't translate CodeSectionEntry("...")', </code></p>
<p>Now, I can modify <a href="https://github.com/bytecodealliance/wasmtime/blob/main/crates/lightbeam/src/module.rs#L572">https://github.com/bytecodealliance/wasmtime/blob/main/crates/lightbeam/src/module.rs#L572</a> to map the enum to <code>{}</code>, but then it runs into the problem that nothing sets TranslateModule::translated_code_section.</p>
<p>Thus, the question: is lightbeam currently in working state, or is it broken ?</p>
</blockquote>



<a name="247250212"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%23572%20wasm64%20support/near/247250212" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.23572.20wasm64.20support.html#247250212">(Jul 26 2021 at 19:31)</a>:</h4>
<p>bjorn3 <a href="https://github.com/bytecodealliance/wasmtime/issues/572#issuecomment-886969670">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/572">issue #572</a>:</p>
<blockquote>
<p>Lightbeam is unmaintained, so it is probably broken.</p>
</blockquote>



<a name="247427675"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%23572%20wasm64%20support/near/247427675" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.23572.20wasm64.20support.html#247427675">(Jul 28 2021 at 06:59)</a>:</h4>
<p>zeroexcuses <a href="https://github.com/bytecodealliance/wasmtime/issues/572#issuecomment-888063545">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/572">issue #572</a>:</p>
<blockquote>
<p>No warranty. Not liable for damages. Do not use this code. Only for educational purposes. Probably dangerous side effects.</p>
<p>I believe I got a basic "ret 42" to execute on lightbeam by copying/pasting <a href="http://module.rs">module.rs</a> and fixing the generated runtime errors:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="k">const</span><span class="w"> </span><span class="n">WAT</span>: <span class="kp">&amp;</span><span class="kt">str</span> <span class="o">=</span><span class="w"> </span><span class="s">r#"</span>
<span class="s">(module</span>
<span class="s">(func $foo (result i32)</span>
<span class="s">  (i32.const 42)))</span>

<span class="s">"#</span><span class="p">;</span><span class="w"></span>

<span class="k">fn</span> <span class="nf">main</span><span class="p">()</span><span class="w"> </span>-&gt; <span class="nc">anyhow</span>::<span class="nb">Result</span><span class="o">&lt;</span><span class="p">()</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">data</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">wat</span>::<span class="n">parse_str</span><span class="p">(</span><span class="n">WAT</span><span class="p">)</span><span class="o">?</span><span class="p">;</span><span class="w"></span>

<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">output</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">TranslatedModule</span>::<span class="n">default</span><span class="p">();</span><span class="w"></span>

<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="n">payload</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="n">Parser</span>::<span class="n">new</span><span class="p">(</span><span class="mi">0</span><span class="p">).</span><span class="n">parse_all</span><span class="p">(</span><span class="o">&amp;</span><span class="n">data</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="fm">println!</span><span class="p">(</span><span class="s">"payload received: {:?}"</span><span class="p">,</span><span class="w"> </span><span class="n">payload</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="k">match</span><span class="w"> </span><span class="n">payload</span><span class="o">?</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">            </span><span class="n">Payload</span>::<span class="n">TypeSection</span><span class="p">(</span><span class="n">s</span><span class="p">)</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="n">output</span><span class="p">.</span><span class="n">ctx</span><span class="p">.</span><span class="n">types</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">translate_sections</span>::<span class="n">type_</span><span class="p">(</span><span class="n">s</span><span class="p">)</span><span class="o">?</span><span class="p">,</span><span class="w"></span>
<span class="w">            </span><span class="n">Payload</span>::<span class="n">ImportSection</span><span class="p">(</span><span class="n">s</span><span class="p">)</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="n">translate_sections</span>::<span class="n">import</span><span class="p">(</span><span class="n">s</span><span class="p">)</span><span class="o">?</span><span class="p">,</span><span class="w"></span>
<span class="w">            </span><span class="n">Payload</span>::<span class="n">FunctionSection</span><span class="p">(</span><span class="n">s</span><span class="p">)</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">                </span><span class="n">output</span><span class="p">.</span><span class="n">ctx</span><span class="p">.</span><span class="n">func_ty_indices</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">translate_sections</span>::<span class="n">function</span><span class="p">(</span><span class="n">s</span><span class="p">)</span><span class="o">?</span><span class="p">;}</span><span class="w"></span>
<span class="w">            </span><span class="n">Payload</span>::<span class="n">TableSection</span><span class="p">(</span><span class="n">s</span><span class="p">)</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">                </span><span class="n">translate_sections</span>::<span class="n">table</span><span class="p">(</span><span class="n">s</span><span class="p">)</span><span class="o">?</span><span class="p">;}</span><span class="w"></span>
<span class="w">            </span><span class="n">Payload</span>::<span class="n">MemorySection</span><span class="p">(</span><span class="n">s</span><span class="p">)</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">                </span><span class="kd">let</span><span class="w"> </span><span class="n">mem</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">translate_sections</span>::<span class="n">memory</span><span class="p">(</span><span class="n">s</span><span class="p">)</span><span class="o">?</span><span class="p">;</span><span class="w"></span>

<span class="w">                </span><span class="k">if</span><span class="w"> </span><span class="n">mem</span><span class="p">.</span><span class="n">len</span><span class="p">()</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">                    </span><span class="nb">Err</span><span class="p">(</span><span class="n">Error</span>::<span class="n">Input</span><span class="p">(</span><span class="s">"Multiple memory sections not yet implemented"</span><span class="p">.</span><span class="n">to_string</span><span class="p">()))</span><span class="o">?</span><span class="p">;}</span><span class="w"></span>

<span class="w">                </span><span class="k">if</span><span class="w"> </span><span class="o">!</span><span class="n">mem</span><span class="p">.</span><span class="n">is_empty</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">                    </span><span class="kd">let</span><span class="w"> </span><span class="n">mem</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">mem</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span><span class="w"></span>
<span class="w">                    </span><span class="kd">let</span><span class="w"> </span><span class="n">limits</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">match</span><span class="w"> </span><span class="n">mem</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">                        </span><span class="n">MemoryType</span>::<span class="n">M32</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">                            </span><span class="n">limits</span><span class="p">,</span><span class="w"></span>
<span class="w">                            </span><span class="n">shared</span>: <span class="nc">false</span><span class="p">,</span><span class="w"></span>
<span class="w">                        </span><span class="p">}</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="n">limits</span><span class="p">,</span><span class="w"></span>
<span class="w">                        </span><span class="n">_</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="nb">Err</span><span class="p">(</span><span class="n">Error</span>::<span class="n">Input</span><span class="p">(</span><span class="s">"unsupported memory"</span><span class="p">.</span><span class="n">to_string</span><span class="p">()))</span><span class="o">?</span><span class="p">,};</span><span class="w"></span>
<span class="w">                    </span><span class="k">if</span><span class="w"> </span><span class="nb">Some</span><span class="p">(</span><span class="n">limits</span><span class="p">.</span><span class="n">initial</span><span class="p">)</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">limits</span><span class="p">.</span><span class="n">maximum</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">                        </span><span class="nb">Err</span><span class="p">(</span><span class="n">Error</span>::<span class="n">Input</span><span class="p">(</span><span class="w"></span>
<span class="w">                            </span><span class="s">"Custom memory limits not supported in lightbeam"</span><span class="p">.</span><span class="n">to_string</span><span class="p">(),))</span><span class="o">?</span><span class="p">;}</span><span class="w"></span>
<span class="w">                    </span><span class="n">output</span><span class="p">.</span><span class="n">memory</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">Some</span><span class="p">(</span><span class="n">limits</span><span class="p">);}}</span><span class="w"></span>
<span class="w">            </span><span class="n">Payload</span>::<span class="n">GlobalSection</span><span class="p">(</span><span class="n">s</span><span class="p">)</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">                </span><span class="n">translate_sections</span>::<span class="n">global</span><span class="p">(</span><span class="n">s</span><span class="p">)</span><span class="o">?</span><span class="p">;}</span><span class="w"></span>
<span class="w">            </span><span class="n">Payload</span>::<span class="n">ExportSection</span><span class="p">(</span><span class="n">s</span><span class="p">)</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">                </span><span class="n">translate_sections</span>::<span class="n">export</span><span class="p">(</span><span class="n">s</span><span class="p">)</span><span class="o">?</span><span class="p">;}</span><span class="w"></span>
<span class="w">            </span><span class="n">Payload</span>::<span class="n">StartSection</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">func</span><span class="p">,</span><span class="w"> </span><span class="o">..</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">                </span><span class="n">translate_sections</span>::<span class="n">start</span><span class="p">(</span><span class="n">func</span><span class="p">)</span><span class="o">?</span><span class="p">;}</span><span class="w"></span>
<span class="w">            </span><span class="n">Payload</span>::<span class="n">ElementSection</span><span class="p">(</span><span class="n">s</span><span class="p">)</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">                </span><span class="n">translate_sections</span>::<span class="n">element</span><span class="p">(</span><span class="n">s</span><span class="p">)</span><span class="o">?</span><span class="p">;}</span><span class="w"></span>
<span class="w">            </span><span class="n">Payload</span>::<span class="n">DataSection</span><span class="p">(</span><span class="n">s</span><span class="p">)</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">                </span><span class="n">translate_sections</span>::<span class="n">data</span><span class="p">(</span><span class="n">s</span><span class="p">)</span><span class="o">?</span><span class="p">;}</span><span class="w"></span>
<span class="w">            </span><span class="n">Payload</span>::<span class="n">CodeSectionStart</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="o">..</span><span class="w"> </span><span class="p">}</span><span class="w"></span>
<span class="w">            </span><span class="o">|</span><span class="w"> </span><span class="n">Payload</span>::<span class="n">CustomSection</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="o">..</span><span class="w"> </span><span class="p">}</span><span class="w"></span>
<span class="w">            </span><span class="o">|</span><span class="w"> </span><span class="n">Payload</span>::<span class="n">Version</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="o">..</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="p">{}</span><span class="w"></span>

<span class="w">            </span><span class="n">Payload</span>::<span class="n">CodeSectionEntry</span><span class="p">(</span><span class="n">function_body</span><span class="p">)</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">                </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">code_gen_session</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">CodeGenSession</span>::<span class="n">new</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">output</span><span class="p">.</span><span class="n">ctx</span><span class="p">,</span><span class="w"> </span><span class="n">microwasm</span>::<span class="n">I64</span><span class="p">);</span><span class="w"></span>
<span class="w">                </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">func_idx</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"></span>

<span class="w">                </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">null_offset_sink</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">NullOffsetSink</span><span class="p">;</span><span class="w"></span>
<span class="w">                </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">unimplemented_reloc_sink</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">translate_sections</span>::<span class="n">UnimplementedRelocSink</span><span class="p">;</span><span class="w"></span>
<span class="w">                </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">null_trap_sink</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">NullTrapSink</span><span class="w"> </span><span class="p">{};</span><span class="w"></span>

<span class="w">                </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">sinks</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Sinks</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">                    </span><span class="n">relocs</span>: <span class="kp">&amp;</span><span class="nc">mut</span><span class="w"> </span><span class="n">unimplemented_reloc_sink</span><span class="p">,</span><span class="w"></span>
<span class="w">                    </span><span class="n">traps</span>: <span class="kp">&amp;</span><span class="nc">mut</span><span class="w"> </span><span class="n">null_trap_sink</span><span class="p">,</span><span class="w"></span>
<span class="w">                    </span><span class="n">offsets</span>: <span class="kp">&amp;</span><span class="nc">mut</span><span class="w"> </span><span class="n">null_offset_sink</span><span class="p">,};</span><span class="w"></span>

<span class="w">                </span><span class="n">translate_wasm</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="n">code_gen_session</span><span class="p">,</span><span class="w"> </span><span class="n">sinks</span><span class="p">,</span><span class="w"> </span><span class="n">func_idx</span><span class="p">,</span><span class="w"> </span><span class="n">function_body</span><span class="p">);</span><span class="w"></span>
<span class="w">                </span><span class="n">func_idx</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">func_idx</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span><span class="w"></span>

<span class="w">                </span><span class="n">output</span><span class="p">.</span><span class="n">translated_code_section</span><span class="w"> </span><span class="o">=</span><span class="w"></span>
<span class="w">                    </span><span class="nb">Some</span><span class="p">(</span><span class="n">code_gen_session</span><span class="p">.</span><span class="n">into_translated_code_section</span><span class="p">()</span><span class="o">?</span><span class="p">);}</span><span class="w"></span>
<span class="w">            </span><span class="n">Payload</span>::<span class="n">End</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="p">{}</span><span class="w"></span>

<span class="w">            </span><span class="n">other</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="fm">unimplemented!</span><span class="p">(</span><span class="s">"can't translate {:?}"</span><span class="p">,</span><span class="w"> </span><span class="n">other</span><span class="p">),}}</span><span class="w"></span>

<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">translated</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">output</span><span class="p">.</span><span class="n">instantiate</span><span class="p">();</span><span class="w"> </span><span class="c1">//  m| m.instantiate())?;</span>

<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">module</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&amp;</span><span class="n">translated</span><span class="p">.</span><span class="n">module</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">func_idx</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="n">func_idx</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="kt">usize</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="n">module</span><span class="p">.</span><span class="n">ctx</span><span class="p">.</span><span class="n">func_ty_indices</span><span class="p">.</span><span class="n">len</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="nb">Err</span><span class="p">(</span><span class="n">ExecutionError</span>::<span class="n">FuncIndexOutOfBounds</span><span class="p">)</span><span class="o">?</span><span class="p">;}</span><span class="w"></span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">type_</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">module</span><span class="p">.</span><span class="n">ctx</span><span class="p">.</span><span class="n">func_type</span><span class="p">(</span><span class="n">func_idx</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">args</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">();</span><span class="w"></span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">&amp;</span><span class="n">type_</span><span class="p">.</span><span class="n">params</span><span class="p">[</span><span class="o">..</span><span class="p">],</span><span class="w"> </span><span class="o">&amp;</span><span class="n">type_</span><span class="p">.</span><span class="n">returns</span><span class="p">[</span><span class="o">..</span><span class="p">])</span><span class="w"></span>
<span class="w">        </span><span class="o">!=</span><span class="w"> </span><span class="p">(</span><span class="o">&lt;</span><span class="p">()</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">TypeList</span><span class="o">&gt;</span>::<span class="n">TYPE_LIST</span><span class="p">,</span><span class="w"> </span><span class="o">&lt;</span><span class="kt">u32</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">TypeList</span><span class="o">&gt;</span>::<span class="n">TYPE_LIST</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="nb">Err</span><span class="p">(</span><span class="n">ExecutionError</span>::<span class="n">TypeMismatch</span><span class="p">)</span><span class="o">?</span><span class="p">;}</span><span class="w"></span>

<span class="w">    </span><span class="fm">println!</span><span class="p">(</span><span class="s">"func_idx: {:?}"</span><span class="p">,</span><span class="w"> </span><span class="n">func_idx</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">code_section</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">translated</span><span class="w"></span>
<span class="w">        </span><span class="p">.</span><span class="n">module</span><span class="w"></span>
<span class="w">        </span><span class="p">.</span><span class="n">translated_code_section</span><span class="w"></span>
<span class="w">        </span><span class="p">.</span><span class="n">as_ref</span><span class="p">()</span><span class="w"></span>
<span class="w">        </span><span class="p">.</span><span class="n">expect</span><span class="p">(</span><span class="s">"no code section"</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">start_buf</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">code_section</span><span class="p">.</span><span class="n">func_start</span><span class="p">(</span><span class="n">func_idx</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="kt">usize</span><span class="p">);</span><span class="w"></span>

<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">result</span>: <span class="kt">u32</span> <span class="o">=</span><span class="w"> </span><span class="k">unsafe</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="n">args</span><span class="p">.</span><span class="n">call</span><span class="p">(</span><span class="w"></span>
<span class="w">            </span><span class="o">&lt;</span><span class="p">()</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">FunctionArgs</span><span class="o">&lt;</span><span class="kt">u32</span><span class="o">&gt;&gt;</span>::<span class="n">into_func</span><span class="p">(</span><span class="n">start_buf</span><span class="p">),</span><span class="w"></span>
<span class="w">            </span><span class="n">translated</span><span class="w"></span>
<span class="w">                </span><span class="p">.</span><span class="n">context</span><span class="w"></span>
<span class="w">                </span><span class="p">.</span><span class="n">as_ref</span><span class="p">()</span><span class="w"></span>
<span class="w">                </span><span class="p">.</span><span class="n">map</span><span class="p">(</span><span class="o">|</span><span class="n">ctx</span><span class="o">|</span><span class="w"> </span><span class="p">(</span><span class="o">&amp;**</span><span class="n">ctx</span><span class="p">)</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="o">*</span><span class="k">const</span><span class="w"> </span><span class="n">VmCtx</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="o">*</span><span class="k">const</span><span class="w"> </span><span class="kt">u8</span><span class="p">)</span><span class="w"></span>
<span class="w">                </span><span class="p">.</span><span class="n">unwrap_or</span><span class="p">(</span><span class="n">std</span>::<span class="n">ptr</span>::<span class="n">null</span><span class="p">()),)};</span><span class="w"></span>

<span class="w">    </span><span class="c1">// let result: u32 = translated.execute_func(0, (5u32, 3u32))?;</span>

<span class="w">    </span><span class="fm">println!</span><span class="p">(</span><span class="s">"f(5, 3) = {}"</span><span class="p">,</span><span class="w"> </span><span class="n">result</span><span class="p">);</span><span class="w"></span>

<span class="w">    </span><span class="fm">assert_eq!</span><span class="p">(</span><span class="n">result</span><span class="p">,</span><span class="w"> </span><span class="mi">42</span><span class="p">);</span><span class="w"></span>

<span class="w">    </span><span class="nb">Ok</span><span class="p">(())}</span><span class="w"></span>

<span class="cp">#[test]</span><span class="w"></span>
<span class="k">fn</span> <span class="nf">test_00</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">main</span><span class="p">().</span><span class="n">unwrap</span><span class="p">();}</span><span class="w"></span>
</code></pre></div>
<p>(adding 5 + 3, even with right calling convention, unfortunately does not return 8 yet).</p>
</blockquote>



<a name="247774115"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%23572%20wasm64%20support/near/247774115" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.23572.20wasm64.20support.html#247774115">(Jul 30 2021 at 23:52)</a>:</h4>
<p>zeroexcuses <a href="https://github.com/bytecodealliance/wasmtime/issues/572#issuecomment-890257062">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/572">issue #572</a>:</p>
<blockquote>
<p>I think I just got passing arguments + adding working. This issue appears to be an out of sync comment + off-by-1 with passing arguments on sysv. In particular, <a href="https://github.com/bytecodealliance/wasmtime/blob/main/crates/lightbeam/src/backend.rs#L587">https://github.com/bytecodealliance/wasmtime/blob/main/crates/lightbeam/src/backend.rs#L587</a> needs to have the <code>rdi</code> register appended to the front of it.</p>
<p>I am now interested in throwing the entire wasm test suite at refactored-lightbeam, and seeing what breaks. Is there a standard way of 'throwing entire wasm test suite" ?</p>
</blockquote>



<a name="248544318"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%23572%20wasm64%20support/near/248544318" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.23572.20wasm64.20support.html#248544318">(Aug 05 2021 at 22:14)</a>:</h4>
<p>alexcrichton <a href="https://github.com/bytecodealliance/wasmtime/issues/572#issuecomment-893849823">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/572">issue #572</a>:</p>
<blockquote>
<p>I have an initial PR for implementing this in cranelift and wasmtime at <a href="https://github.com/bytecodealliance/wasmtime/pull/3153">https://github.com/bytecodealliance/wasmtime/pull/3153</a></p>
</blockquote>



<a name="249243438"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%23572%20wasm64%20support/near/249243438" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.23572.20wasm64.20support.html#249243438">(Aug 12 2021 at 14:40)</a>:</h4>
<p>alexcrichton <a href="https://github.com/bytecodealliance/wasmtime/issues/572#issuecomment-897697262">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/572">issue #572</a>:</p>
<blockquote>
<p>Added in <a href="https://github.com/bytecodealliance/wasmtime/pull/3153">https://github.com/bytecodealliance/wasmtime/pull/3153</a></p>
</blockquote>



<a name="249243440"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%23572%20wasm64%20support/near/249243440" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.23572.20wasm64.20support.html#249243440">(Aug 12 2021 at 14:40)</a>:</h4>
<p>alexcrichton closed <a href="https://github.com/bytecodealliance/wasmtime/issues/572">issue #572</a>:</p>
<blockquote>
<p>We should consider supporting wasm64 modules, not just wasm32; people will want to run with large linear address spaces, both to process large amounts of data and to provide address space for shared mappings or file mappings.</p>
<p>Opening this issue to start discussing what that support should look like, and how we can do that with minimal complexity or duplication.</p>
</blockquote>



<hr><p>Last updated: Jan 20 2025 at 06:04 UTC</p>
</html>