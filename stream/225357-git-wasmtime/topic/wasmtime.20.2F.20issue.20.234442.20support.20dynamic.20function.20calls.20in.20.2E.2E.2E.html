<html>
<head><meta charset="utf-8"><title>wasmtime / issue #4442 support dynamic function calls in ... · git-wasmtime · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/index.html">git-wasmtime</a></h2>
<h3>Topic: <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.234442.20support.20dynamic.20function.20calls.20in.20.2E.2E.2E.html">wasmtime / issue #4442 support dynamic function calls in ...</a></h3>

<hr>

<base href="https://bytecodealliance.zulipchat.com">

<head><link href="https://bytecodealliance.github.io/zulip-archive/style.css" rel="stylesheet"></head>

<a name="289492239"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%234442%20support%20dynamic%20function%20calls%20in%20.../near/289492239" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.234442.20support.20dynamic.20function.20calls.20in.20.2E.2E.2E.html#289492239">(Jul 13 2022 at 17:19)</a>:</h4>
<p>dicej <a href="https://github.com/bytecodealliance/wasmtime/pull/4442#issuecomment-1183483685">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/4442">issue #4442</a>:</p>
<blockquote>
<p>@alexcrichton @jameysharp This addresses #4310.  I plan to push one more commit to add "sad path" tests, but this should be complete otherwise.</p>
<p>Please pay particular attention to the <code>unsafe</code> block in <code>Func::call</code> -- I copied it from <code>TypedFunc::call_raw</code> and modified it, but I want to make sure I did that correctly.</p>
</blockquote>



<a name="289494438"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%234442%20support%20dynamic%20function%20calls%20in%20.../near/289494438" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.234442.20support.20dynamic.20function.20calls.20in.20.2E.2E.2E.html#289494438">(Jul 13 2022 at 17:36)</a>:</h4>
<p>github-actions[bot] <a href="https://github.com/bytecodealliance/wasmtime/pull/4442#issuecomment-1183498922">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/4442">issue #4442</a>:</p>
<blockquote>
<h4>Subscribe to Label Action</h4>
<p>cc @peterhuene</p>
<p>&lt;details&gt;<br>
This issue or pull request has been labeled: "wasmtime:api"</p>
<p>Thus the following users have been cc'd because of the following labels:</p>
<ul>
<li>peterhuene: wasmtime:api</li>
</ul>
<p>To subscribe or unsubscribe from this label, edit the &lt;code&gt;.github/subscribe-to-label.json&lt;/code&gt; configuration file.</p>
<p><a href="https://github.com/bytecodealliance/subscribe-to-label-action">Learn more.</a><br>
&lt;/details&gt;</p>
</blockquote>



<a name="289511408"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%234442%20support%20dynamic%20function%20calls%20in%20.../near/289511408" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.234442.20support.20dynamic.20function.20calls.20in.20.2E.2E.2E.html#289511408">(Jul 13 2022 at 19:50)</a>:</h4>
<p>dicej <a href="https://github.com/bytecodealliance/wasmtime/pull/4442#issuecomment-1183615139">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/4442">issue #4442</a>:</p>
<blockquote>
<p>I could use some advice about how to address the CI issue.  I've added a new <code>wasmtime-component-util</code> crate with code that I wanted to share between <code>wasmtime</code> and <code>wasmtime-component-macro</code>.  The <code>publish</code> script doesn't like that, though:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="n">Caused</span><span class="w"> </span><span class="n">by</span>:
  <span class="nc">no</span><span class="w"> </span><span class="n">matching</span><span class="w"> </span><span class="n">package</span><span class="w"> </span><span class="n">named</span><span class="w"> </span><span class="err">`</span><span class="n">wasmtime</span><span class="o">-</span><span class="n">component</span><span class="o">-</span><span class="n">util</span><span class="err">`</span><span class="w"> </span><span class="n">found</span><span class="w"></span>
<span class="w">  </span><span class="n">location</span><span class="w"> </span><span class="n">searched</span>: <span class="nc">registry</span><span class="w"> </span><span class="err">`</span><span class="n">crates</span><span class="o">-</span><span class="n">io</span><span class="err">`</span><span class="w"></span>
<span class="w">  </span><span class="n">required</span><span class="w"> </span><span class="n">by</span><span class="w"> </span><span class="n">package</span><span class="w"> </span><span class="err">`</span><span class="n">wasmtime</span><span class="o">-</span><span class="n">component</span><span class="o">-</span><span class="kr">macro</span><span class="w"> </span><span class="n">v0</span><span class="p">.</span><span class="mf">40.0</span><span class="w"> </span><span class="p">(</span><span class="o">/</span><span class="n">home</span><span class="o">/</span><span class="n">runner</span><span class="o">/</span><span class="n">work</span><span class="o">/</span><span class="n">wasmtime</span><span class="o">/</span><span class="n">wasmtime</span><span class="o">/</span><span class="n">target</span><span class="o">/</span><span class="n">package</span><span class="o">/</span><span class="n">wasmtime</span><span class="o">-</span><span class="n">component</span><span class="o">-</span><span class="kr">macro</span><span class="o">-</span><span class="mf">0.40.0</span><span class="p">)</span><span class="err">`</span><span class="w"></span>
<span class="n">thread</span><span class="w"> </span><span class="o">'</span><span class="na">main</span><span class="o">'</span><span class="w"> </span><span class="n">panicked</span><span class="w"> </span><span class="n">at</span><span class="w"> </span><span class="o">'</span><span class="na">failed</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">verify</span><span class="w"> </span><span class="s">"crates/component-macro/Cargo.toml"</span><span class="o">'</span><span class="p">,</span><span class="w"> </span><span class="n">scripts</span><span class="o">/</span><span class="n">publish</span><span class="p">.</span><span class="n">rs</span>:<span class="mi">462</span>:<span class="mi">9</span><span class="w"></span>
</code></pre></div>
<p>Is there a better way to reuse that code, or else some way to bootstrap the dependency and make <code>publish</code> happy?</p>
</blockquote>



<a name="289513009"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%234442%20support%20dynamic%20function%20calls%20in%20.../near/289513009" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.234442.20support.20dynamic.20function.20calls.20in.20.2E.2E.2E.html#289513009">(Jul 13 2022 at 20:02)</a>:</h4>
<p>jameysharp <a href="https://github.com/bytecodealliance/wasmtime/pull/4442#issuecomment-1183625134">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/4442">issue #4442</a>:</p>
<blockquote>
<p>I didn't know this, but there's a comment in <code>publish.rs</code> that says "note that this list must be topologically sorted by dependencies". Does it work if you swap the order of <code>wasmtime-component-util</code> and <code>wasmtime-component-macro</code>?</p>
</blockquote>



<a name="289516015"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%234442%20support%20dynamic%20function%20calls%20in%20.../near/289516015" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.234442.20support.20dynamic.20function.20calls.20in.20.2E.2E.2E.html#289516015">(Jul 13 2022 at 20:28)</a>:</h4>
<p>dicej <a href="https://github.com/bytecodealliance/wasmtime/pull/4442#issuecomment-1183646150">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/4442">issue #4442</a>:</p>
<blockquote>
<blockquote>
<p>I didn't know this, but there's a comment in <code>publish.rs</code> that says "note that this list must be topologically sorted by dependencies". Does it work if you swap the order of <code>wasmtime-component-util</code> and <code>wasmtime-component-macro</code>?</p>
</blockquote>
<p>Oh good call.  I _did_ know that, but forgot about it.  Will try that now.</p>
</blockquote>



<a name="289604705"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%234442%20support%20dynamic%20function%20calls%20in%20.../near/289604705" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.234442.20support.20dynamic.20function.20calls.20in.20.2E.2E.2E.html#289604705">(Jul 14 2022 at 15:08)</a>:</h4>
<p>dicej <a href="https://github.com/bytecodealliance/wasmtime/pull/4442#issuecomment-1184563228">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/4442">issue #4442</a>:</p>
<blockquote>
<p>Thanks @alexcrichton and @jameysharp for your thoughtful and detailed feedback.</p>
<p>Alex: I agree with what you said about representing types and wanting to be able to get a type from a <code>Val</code>.  For my first pass at this, I didn't have a <code>Type</code> enum -- I just used <code>InterfaceType</code> everywhere.  That worked pretty well until the borrow checker made its verdict.  I couldn't figure out how to pass a <code>&amp;ComponentTypes</code> to <code>Val::lower</code> since it also takes a <code>&amp;mut StoreContextMut&lt;T&gt;</code> since the former was borrowed from the latter.  Now that I reflect on it, though -- I see I don't need to pass both of those things since I can always get the former from the latter "just in time" by reborrowing when needed.  I'll give that another shot and see what happens.  I'll also see what I can do about deduplicating  <code>Func::call</code> and <code>TypedFunc::call</code>.</p>
</blockquote>



<a name="289606526"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%234442%20support%20dynamic%20function%20calls%20in%20.../near/289606526" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.234442.20support.20dynamic.20function.20calls.20in.20.2E.2E.2E.html#289606526">(Jul 14 2022 at 15:21)</a>:</h4>
<p>alexcrichton <a href="https://github.com/bytecodealliance/wasmtime/pull/4442#issuecomment-1184577591">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/4442">issue #4442</a>:</p>
<blockquote>
<p>Hm actually I do think you'll want to pass around <code>&amp;ComponentTypes</code> if you can. One trick I used with instances is that I took it out of the store temporarily, placing it back into the store when I was done with it during the function call.</p>
<p>I think this will want to be an argument because if an end user creates a <code>Val</code> they'll need to create it with a type for cases like a <code>Record</code>, so the end-user may create a foreign <code>ComponentTypes</code>. Hm maybe at least, I'm not sure. They'll always want to use types already registered within the component so perhaps not... Well in any case as long as it works!</p>
</blockquote>



<a name="289608983"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%234442%20support%20dynamic%20function%20calls%20in%20.../near/289608983" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.234442.20support.20dynamic.20function.20calls.20in.20.2E.2E.2E.html#289608983">(Jul 14 2022 at 15:41)</a>:</h4>
<p>dicej <a href="https://github.com/bytecodealliance/wasmtime/pull/4442#issuecomment-1184598504">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/4442">issue #4442</a>:</p>
<blockquote>
<p>@alexcrichton Would you please point me to the code where you do that trick of pulling the ComponentTypes out of the store temporarily?</p>
<p>Also, here's a quick sketch of what I'm thinking.  Please let me know what you think.</p>
<p><div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="k">pub</span><span class="w"> </span><span class="k">enum</span> <span class="nc">RecordIndex</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">Unit</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="n">Record</span><span class="p">(</span><span class="n">TypeRecordIndex</span><span class="p">),</span><span class="w"></span>
<span class="w">    </span><span class="n">Tuple</span><span class="p">(</span><span class="n">TypeTupleIndex</span><span class="p">)</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="k">pub</span><span class="w"> </span><span class="k">enum</span> <span class="nc">VariantIndex</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">Variant</span><span class="p">(</span><span class="n">TypeVariantIndex</span><span class="p">),</span><span class="w"></span>
<span class="w">    </span><span class="n">Enum</span><span class="p">(</span><span class="n">TypeEnumIndex</span><span class="p">),</span><span class="w"></span>
<span class="w">    </span><span class="n">Union</span><span class="p">(</span><span class="n">TypeUnionIndex</span><span class="p">),</span><span class="w"></span>
<span class="w">    </span><span class="nb">Option</span><span class="p">(</span><span class="n">TypeInterfaceIndex</span><span class="p">),</span><span class="w"></span>
<span class="w">    </span><span class="n">Expected</span><span class="p">(</span><span class="n">TypeExpectedIndex</span><span class="p">)</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="k">pub</span><span class="w"> </span><span class="k">enum</span> <span class="nc">Val</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">Bool</span><span class="p">(</span><span class="kt">bool</span><span class="p">),</span><span class="w"></span>
<span class="w">    </span><span class="n">S8</span><span class="p">(</span><span class="kt">i8</span><span class="p">),</span><span class="w"></span>
<span class="w">    </span><span class="n">U8</span><span class="p">(</span><span class="kt">u8</span><span class="p">),</span><span class="w"></span>
<span class="w">    </span><span class="n">S16</span><span class="p">(</span><span class="kt">i16</span><span class="p">),</span><span class="w"></span>
<span class="w">    </span><span class="n">U16</span><span class="p">(</span><span class="kt">u16</span><span class="p">),</span><span class="w"></span>
<span class="w">    </span><span class="n">S32</span><span class="p">(</span><span class="kt">i32</span><span class="p">),</span><span class="w"></span>
<span class="w">    </span><span class="n">U32</span><span class="p">(</span><span class="kt">u32</span><span class="p">),</span><span class="w"></span>
<span class="w">    </span><span class="n">S64</span><span class="p">(</span><span class="kt">i64</span><span class="p">),</span><span class="w"></span>
<span class="w">    </span><span class="n">U64</span><span class="p">(</span><span class="kt">u64</span><span class="p">),</span><span class="w"></span>
<span class="w">    </span><span class="n">Float32</span><span class="p">(</span><span class="kt">u32</span><span class="p">),</span><span class="w"></span>
<span class="w">    </span><span class="n">Float64</span><span class="p">(</span><span class="kt">u64</span><span class="p">),</span><span class="w"></span>
<span class="w">    </span><span class="n">Char</span><span class="p">(</span><span class="kt">char</span><span class="p">),</span><span class="w"></span>
<span class="w">    </span><span class="nb">String</span><span class="p">(</span><span class="n">Rc</span><span class="o">&lt;</span><span class="kt">str</span><span class="o">&gt;</span><span class="p">),</span><span class="w"></span>
<span class="w">    </span><span class="n">List</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="n">element_type_index</span>: <span class="nc">TypeInterfaceIndex</span><span class="p">,</span><span class="w"></span>
<span class="w">        </span><span class="n">values</span>: <span class="nc">Rc</span><span class="o">&lt;</span><span class="p">[</span><span class="n">Val</span><span class="p">]</span><span class="o">&gt;</span><span class="w"></span>
<span class="w">    </span><span class="p">},</span><span class="w"></span>
<span class="w">    </span><span class="n">Record</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="n">type_index</span>: <span class="nc">RecordIndex</span><span class="p">,</span><span class="w"></span>
<span class="w">        </span><span class="n">fields</span>: <span class="nc">Rc</span><span class="o">&lt;</span><span class="p">[</span><span class="n">Val</span><span class="p">]</span><span class="o">&gt;</span><span class="w"></span>
<span class="w">    </span><span class="p">},</span><span class="w"></span>
<span class="w">    </span><span class="n">Variant</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="n">type_index</span>: <span class="nc">VariantIndex</span><span class="p">,</span><span class="w"></span>
<span class="w">        </span><span class="n">discriminant</span>: <span class="kt">u32</span><span class="p">,</span><span class="w"></span>
<span class="w">        </span><span class="n">value</span>: <span class="nc">Rc</span><span class="o">&lt;</span><span class="n">Val</span><span class="o">&gt;</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="p">},</span><span class="w"></span>
<span class="w">    </span><span class="n">Flags</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="n">type_index</span>: <span class="nc">TypeFlagsIndex</span><span class="p">,</span><span class="w"></span>
<span class="w">        </span><span class="n">count</span>: <span class="kt">u32</span><span class="p">,</span><span class="w"></span>
<span class="w">        </span><span class="n">value</span>: <span class="nc">Rc</span><span class="o">&lt;</span><span class="p">[</span><span class="kt">u32</span><span class="p">]</span><span class="o">&gt;</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="p">},</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="k">impl</span><span class="w"> </span><span class="n">Val</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="k">fn</span> <span class="nf">ty</span><span class="p">()</span><span class="w"> </span>-&gt; <span class="nc">InterfaceType</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="o">..</span><span class="p">.</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>

<span class="w">    </span><span class="o">..</span><span class="p">.</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div><br>
</p>
</blockquote>



<a name="289609390"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%234442%20support%20dynamic%20function%20calls%20in%20.../near/289609390" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.234442.20support.20dynamic.20function.20calls.20in.20.2E.2E.2E.html#289609390">(Jul 14 2022 at 15:44)</a>:</h4>
<p>dicej <a href="https://github.com/bytecodealliance/wasmtime/pull/4442#issuecomment-1184601551">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/4442">issue #4442</a>:</p>
<blockquote>
<p>Regarding the code sketch above: we'd need to add methods to <code>ComponentTypes</code> to create composite <code>Val</code>s, I guess.</p>
</blockquote>



<a name="289613084"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%234442%20support%20dynamic%20function%20calls%20in%20.../near/289613084" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.234442.20support.20dynamic.20function.20calls.20in.20.2E.2E.2E.html#289613084">(Jul 14 2022 at 16:12)</a>:</h4>
<p>alexcrichton <a href="https://github.com/bytecodealliance/wasmtime/pull/4442#issuecomment-1184632155">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/4442">issue #4442</a>:</p>
<blockquote>
<p>That seems like a good start to me. I'd probably go ahead and use <code>Box&lt;T&gt;</code> everywhere instead of <code>Rc&lt;T&gt;</code> for <code>Send</code>/<code>Sync</code> reasons. We're already nowhere near "this is almost optimal perf" so I don't think there's much benefit to making it cheaply clone-able. </p>
<p>Otherwise though the type information will be a bit tricky since I would prefer to not simply reexport everything within <code>wasmtime_environ::component::types</code>. I think the <code>wasmtime</code> crate will need to have its own parallel type hierarchy with methods for us to audit, document, and maintain as part of an embedder API.</p>
</blockquote>



<a name="289629900"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%234442%20support%20dynamic%20function%20calls%20in%20.../near/289629900" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.234442.20support.20dynamic.20function.20calls.20in.20.2E.2E.2E.html#289629900">(Jul 14 2022 at 18:22)</a>:</h4>
<p>dicej <a href="https://github.com/bytecodealliance/wasmtime/pull/4442#issuecomment-1184762332">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/4442">issue #4442</a>:</p>
<blockquote>
<p>@alexcrichton Can you elaborate on what you think the parallel type hierarchy in the <code>wasmtime</code> crate would look like?  I'm having trouble imagining how to build that in such a way that it reuses <code>ComponentTypes</code> behind the scenes.  I also wonder whether it would represent just despecialized types or the full range including specializations like unions, options, etc.</p>
<p>Here's my latest sketch:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="k">pub</span><span class="w"> </span><span class="k">struct</span> <span class="nc">TypeIndex</span><span class="p">(</span><span class="n">TypeInterfaceIndex</span><span class="p">);</span><span class="w"></span>
<span class="k">pub</span><span class="w"> </span><span class="k">struct</span> <span class="nc">RecordTypeIndex</span><span class="p">(</span><span class="n">TypeRecordIndex</span><span class="p">);</span><span class="w"></span>
<span class="k">pub</span><span class="w"> </span><span class="k">struct</span> <span class="nc">TupleTypeIndex</span><span class="p">(</span><span class="n">TypeTupleIndex</span><span class="p">);</span><span class="w"></span>
<span class="k">pub</span><span class="w"> </span><span class="k">struct</span> <span class="nc">VariantTypeIndex</span><span class="p">(</span><span class="n">TypeVariantIndex</span><span class="p">);</span><span class="w"></span>
<span class="k">pub</span><span class="w"> </span><span class="k">struct</span> <span class="nc">EnumTypeIndex</span><span class="p">(</span><span class="n">TypeEnumIndex</span><span class="p">);</span><span class="w"></span>
<span class="o">..</span><span class="p">.</span><span class="w"></span>

<span class="k">pub</span><span class="w"> </span><span class="k">enum</span> <span class="nc">AnyRecordTypeIndex</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">Unit</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="n">Record</span><span class="p">(</span><span class="n">RecordTypeIndex</span><span class="p">),</span><span class="w"></span>
<span class="w">    </span><span class="n">Tuple</span><span class="p">(</span><span class="n">TupleTypeIndex</span><span class="p">)</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="k">pub</span><span class="w"> </span><span class="k">enum</span> <span class="nc">AnyVariantTypeIndex</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">Variant</span><span class="p">(</span><span class="n">VariantTypeIndex</span><span class="p">),</span><span class="w"></span>
<span class="w">    </span><span class="n">Enum</span><span class="p">(</span><span class="n">EnumTypeIndex</span><span class="p">),</span><span class="w"></span>
<span class="w">    </span><span class="n">Union</span><span class="p">(</span><span class="n">UnionTypeIndex</span><span class="p">),</span><span class="w"></span>
<span class="w">    </span><span class="nb">Option</span><span class="p">(</span><span class="n">TypeIndex</span><span class="p">),</span><span class="w"></span>
<span class="w">    </span><span class="n">Expected</span><span class="p">(</span><span class="n">ExpectedTypeIndex</span><span class="p">)</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="k">pub</span><span class="w"> </span><span class="k">enum</span> <span class="nc">Type</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">Bool</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="n">S8</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="n">U8</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="n">S16</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="n">U16</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="n">S32</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="n">U32</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="n">S64</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="n">U64</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="n">Float32</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="n">Float64</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="n">Char</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="nb">String</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="n">List</span><span class="p">(</span><span class="n">TypeIndex</span><span class="p">),</span><span class="w"></span>
<span class="w">    </span><span class="n">Record</span><span class="p">(</span><span class="n">AnyRecordTypeIndex</span><span class="p">),</span><span class="w"></span>
<span class="w">    </span><span class="n">Variant</span><span class="p">(</span><span class="n">AnyVariantTypeIndex</span><span class="p">),</span><span class="w"></span>
<span class="w">    </span><span class="n">Flags</span><span class="p">(</span><span class="n">FlagTypeIndex</span><span class="p">),</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="k">impl</span><span class="w"> </span><span class="n">Type</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">fn</span> <span class="nf">from</span><span class="p">(</span><span class="n">ty</span>: <span class="kp">&amp;</span><span class="nc">InterfaceType</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nc">Self</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="o">..</span><span class="p">.</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="k">pub</span><span class="w"> </span><span class="k">struct</span> <span class="nc">Field</span><span class="o">&lt;'</span><span class="na">a</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">name</span>: <span class="kp">&amp;</span><span class="kt">str</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="n">ty</span>: <span class="nc">Type</span><span class="p">,</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="k">pub</span><span class="w"> </span><span class="k">struct</span> <span class="nc">Types</span><span class="p">(</span><span class="n">ComponentTypes</span><span class="p">);</span><span class="w"></span>

<span class="k">impl</span><span class="w"> </span><span class="n">Types</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="k">fn</span> <span class="nf">record_name</span><span class="p">(</span><span class="o">&amp;</span><span class="bp">self</span><span class="p">,</span><span class="w"> </span><span class="n">index</span>: <span class="nc">RecordTypeIndex</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="kp">&amp;</span><span class="kt">str</span> <span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="o">&amp;</span><span class="bp">self</span><span class="p">.</span><span class="mi">0</span><span class="p">[</span><span class="n">index</span><span class="p">.</span><span class="mi">0</span><span class="p">].</span><span class="n">name</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>

<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="k">fn</span> <span class="nf">record_fields</span><span class="p">(</span><span class="o">&amp;</span><span class="bp">self</span><span class="p">,</span><span class="w"> </span><span class="n">index</span>: <span class="nc">RecordTypeIndex</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nc">impl</span><span class="w"> </span><span class="nb">Iterator</span><span class="o">&lt;</span><span class="n">Field</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="o">&amp;</span><span class="bp">self</span><span class="p">.</span><span class="mi">0</span><span class="p">[</span><span class="n">index</span><span class="p">.</span><span class="mi">0</span><span class="p">].</span><span class="n">fields</span><span class="p">.</span><span class="n">iter</span><span class="p">().</span><span class="n">map</span><span class="p">(</span><span class="o">|</span><span class="n">field</span><span class="o">|</span><span class="w"> </span><span class="n">Field</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">name</span>: <span class="kp">&amp;</span><span class="nc">field</span><span class="p">.</span><span class="n">name</span><span class="p">,</span><span class="w"> </span><span class="n">ty</span>: <span class="nc">Type</span>::<span class="n">from</span><span class="p">(</span><span class="o">&amp;</span><span class="n">field</span><span class="p">.</span><span class="n">ty</span><span class="p">)</span><span class="w"> </span><span class="p">})</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>

<span class="w">    </span><span class="o">..</span><span class="p">.</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="k">pub</span><span class="w"> </span><span class="k">enum</span> <span class="nc">Val</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">Bool</span><span class="p">(</span><span class="kt">bool</span><span class="p">),</span><span class="w"></span>
<span class="w">    </span><span class="n">S8</span><span class="p">(</span><span class="kt">i8</span><span class="p">),</span><span class="w"></span>
<span class="w">    </span><span class="n">U8</span><span class="p">(</span><span class="kt">u8</span><span class="p">),</span><span class="w"></span>
<span class="w">    </span><span class="n">S16</span><span class="p">(</span><span class="kt">i16</span><span class="p">),</span><span class="w"></span>
<span class="w">    </span><span class="n">U16</span><span class="p">(</span><span class="kt">u16</span><span class="p">),</span><span class="w"></span>
<span class="w">    </span><span class="n">S32</span><span class="p">(</span><span class="kt">i32</span><span class="p">),</span><span class="w"></span>
<span class="w">    </span><span class="n">U32</span><span class="p">(</span><span class="kt">u32</span><span class="p">),</span><span class="w"></span>
<span class="w">    </span><span class="n">S64</span><span class="p">(</span><span class="kt">i64</span><span class="p">),</span><span class="w"></span>
<span class="w">    </span><span class="n">U64</span><span class="p">(</span><span class="kt">u64</span><span class="p">),</span><span class="w"></span>
<span class="w">    </span><span class="n">Float32</span><span class="p">(</span><span class="kt">u32</span><span class="p">),</span><span class="w"></span>
<span class="w">    </span><span class="n">Float64</span><span class="p">(</span><span class="kt">u64</span><span class="p">),</span><span class="w"></span>
<span class="w">    </span><span class="n">Char</span><span class="p">(</span><span class="kt">char</span><span class="p">),</span><span class="w"></span>
<span class="w">    </span><span class="nb">String</span><span class="p">(</span><span class="nb">Box</span><span class="o">&lt;</span><span class="kt">str</span><span class="o">&gt;</span><span class="p">),</span><span class="w"></span>
<span class="w">    </span><span class="n">List</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="n">element_type</span>: <span class="nc">Type</span><span class="p">,</span><span class="w"></span>
<span class="w">        </span><span class="n">values</span>: <span class="nb">Box</span><span class="o">&lt;</span><span class="p">[</span><span class="n">Val</span><span class="p">]</span><span class="o">&gt;</span><span class="w"></span>
<span class="w">    </span><span class="p">},</span><span class="w"></span>
<span class="w">    </span><span class="n">Record</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="n">ty</span>: <span class="nc">RecordType</span><span class="p">,</span><span class="w"></span>
<span class="w">        </span><span class="n">fields</span>: <span class="nb">Box</span><span class="o">&lt;</span><span class="p">[</span><span class="n">Val</span><span class="p">]</span><span class="o">&gt;</span><span class="w"></span>
<span class="w">    </span><span class="p">},</span><span class="w"></span>
<span class="w">    </span><span class="n">Variant</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="n">ty</span>: <span class="nc">VariantType</span><span class="p">,</span><span class="w"></span>
<span class="w">        </span><span class="n">discriminant</span>: <span class="kt">u32</span><span class="p">,</span><span class="w"></span>
<span class="w">        </span><span class="n">value</span>: <span class="nb">Box</span><span class="o">&lt;</span><span class="n">Val</span><span class="o">&gt;</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="p">},</span><span class="w"></span>
<span class="w">    </span><span class="n">Flags</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="n">ty</span>: <span class="nc">FlagsType</span><span class="p">,</span><span class="w"></span>
<span class="w">        </span><span class="n">count</span>: <span class="kt">u32</span><span class="p">,</span><span class="w"></span>
<span class="w">        </span><span class="n">value</span>: <span class="nb">Box</span><span class="o">&lt;</span><span class="p">[</span><span class="kt">u32</span><span class="p">]</span><span class="o">&gt;</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="p">},</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="k">impl</span><span class="w"> </span><span class="n">Val</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="k">fn</span> <span class="nf">ty</span><span class="p">(</span><span class="n">types</span>: <span class="kp">&amp;</span><span class="nc">Types</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nc">Type</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="o">..</span><span class="p">.</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>

<span class="w">    </span><span class="o">..</span><span class="p">.</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>
<p>The idea is to wrap the relevant <code>wasmtime_environ</code> index types with <code>wasmtime</code> equivalents, plus a <code>Types</code> type which wrap's <code>wasmtime_environ</code>'s <code>ComponentTypes</code> and provide methods for getting names, fields, cases, etc. for various composite types.  Lots of boilerplate, of course, but happy to do it if that's the right approach.</p>
</blockquote>



<a name="289631451"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%234442%20support%20dynamic%20function%20calls%20in%20.../near/289631451" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.234442.20support.20dynamic.20function.20calls.20in.20.2E.2E.2E.html#289631451">(Jul 14 2022 at 18:35)</a>:</h4>
<p>alexcrichton <a href="https://github.com/bytecodealliance/wasmtime/pull/4442#issuecomment-1184773615">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/4442">issue #4442</a>:</p>
<blockquote>
<p>That looks along the lines of what I was thinking, but to be clear I haven't fully thought this through. I've got what I think should be the constraints in my head but said constraints don't always translate well to code... In any case what you've described captures all the main constraints I was thinking of. The actual <code>ComponentTypes</code> under the hood will be wrapped up in an <code>Arc</code> so we can "cheaply" clone that and move it around. One possible design tradeoff is to bundle the <code>Arc</code> into the <code>Type</code> itself. For example we could hide all the indices and instead have something liek:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="k">enum</span> <span class="nc">Type</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="c1">// ...</span>
<span class="w">    </span><span class="n">Record</span><span class="p">(</span><span class="n">RecordType</span><span class="p">),</span><span class="w"></span>
<span class="w">    </span><span class="c1">// ...</span>
<span class="p">}</span><span class="w"></span>

<span class="k">struct</span> <span class="nc">RecordType</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">index</span>: <span class="nc">TypeRecordIndex</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="n">types</span>: <span class="nc">Arc</span><span class="o">&lt;</span><span class="n">ComponentTypes</span><span class="o">&gt;</span><span class="p">,</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>
<p>That's a whole lot of <code>Arc</code> cloning though and will lose perf very quickly. Another possible alternative is:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="k">enum</span> <span class="nc">Type</span><span class="o">&lt;'</span><span class="na">a</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="c1">// ...</span>
<span class="w">    </span><span class="n">Record</span><span class="p">(</span><span class="n">RecordType</span><span class="o">&lt;'</span><span class="na">a</span><span class="o">&gt;</span><span class="p">),</span><span class="w"></span>
<span class="w">    </span><span class="c1">// ...</span>
<span class="p">}</span><span class="w"></span>

<span class="k">struct</span> <span class="nc">RecordType</span><span class="o">&lt;'</span><span class="na">a</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">index</span>: <span class="nc">TypeRecordIndex</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="n">types</span>: <span class="kp">&amp;</span><span class="o">'</span><span class="na">a</span> <span class="nc">ComponentTypes</span><span class="p">,</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>
<p>but then getting that from a <code>Val</code> gets tricky. One possibility though could be:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="k">enum</span> <span class="nc">Val</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="c1">// ...</span>
<span class="w">    </span><span class="n">Record</span><span class="p">(</span><span class="n">Record</span><span class="p">),</span><span class="w"></span>
<span class="w">    </span><span class="c1">// ...</span>
<span class="p">}</span><span class="w"></span>

<span class="k">struct</span> <span class="nc">Record</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="c1">// ...</span>
<span class="w">    </span><span class="n">ty</span>: <span class="nc">TypeRecordIndex</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="n">instance</span>: <span class="nc">Instance</span><span class="p">,</span><span class="w"> </span><span class="c1">// just an index</span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>
<p>or something like that maybe?</p>
<p>I may be too naive also trying to prematurely optimize this. It might make the most sense to go with <code>Type</code> containing <code>Arc&lt;ComponentTypes&gt;</code> for now. I do think ideally we would hide all the indexes used under the hood if we can, but that's not necessarily required.</p>
</blockquote>



<a name="289649851"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%234442%20support%20dynamic%20function%20calls%20in%20.../near/289649851" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.234442.20support.20dynamic.20function.20calls.20in.20.2E.2E.2E.html#289649851">(Jul 14 2022 at 21:07)</a>:</h4>
<p>dicej <a href="https://github.com/bytecodealliance/wasmtime/pull/4442#issuecomment-1184897224">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/4442">issue #4442</a>:</p>
<blockquote>
<p>I've tried a few variations.  Here's the latest:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="k">pub</span><span class="w"> </span><span class="k">struct</span> <span class="nc">Types</span><span class="o">&lt;'</span><span class="na">a</span><span class="o">&gt;</span><span class="p">(</span><span class="o">&amp;'</span><span class="na">a</span><span class="w"> </span><span class="n">ComponentTypes</span><span class="p">);</span><span class="w"></span>

<span class="k">pub</span><span class="w"> </span><span class="k">struct</span> <span class="nc">Case</span><span class="o">&lt;'</span><span class="na">a</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">name</span>: <span class="kp">&amp;</span><span class="o">'</span><span class="na">a</span> <span class="kt">str</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="n">ty</span>: <span class="nc">Type</span><span class="p">,</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="cp">#[derive(Copy, Clone)]</span><span class="w"></span>
<span class="k">pub</span><span class="w"> </span><span class="k">struct</span> <span class="nc">VariantIndex</span><span class="p">(</span><span class="n">TypeVariantIndex</span><span class="p">);</span><span class="w"></span>

<span class="k">impl</span><span class="w"> </span><span class="n">VariantIndex</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="k">fn</span> <span class="nf">name</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="w"> </span><span class="n">types</span>: <span class="nc">Types</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="kp">&amp;</span><span class="kt">str</span> <span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="o">&amp;</span><span class="n">types</span><span class="p">.</span><span class="mi">0</span><span class="p">[</span><span class="bp">self</span><span class="p">.</span><span class="mi">0</span><span class="p">].</span><span class="n">name</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>

<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="k">fn</span> <span class="nf">cases</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="w"> </span><span class="n">types</span>: <span class="nc">Types</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nc">impl</span><span class="w"> </span><span class="nb">ExactSizeIterator</span><span class="o">&lt;</span><span class="n">Case</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="n">types</span><span class="p">.</span><span class="mi">0</span><span class="p">[</span><span class="bp">self</span><span class="p">.</span><span class="mi">0</span><span class="p">].</span><span class="n">cases</span><span class="p">.</span><span class="n">iter</span><span class="p">().</span><span class="n">map</span><span class="p">(</span><span class="o">|</span><span class="n">case</span><span class="o">|</span><span class="w"> </span><span class="n">Case</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">            </span><span class="n">name</span>: <span class="kp">&amp;</span><span class="nc">case</span><span class="p">.</span><span class="n">name</span><span class="p">,</span><span class="w"></span>
<span class="w">            </span><span class="n">ty</span>: <span class="nc">Type</span>::<span class="n">from</span><span class="p">(</span><span class="o">&amp;</span><span class="n">case</span><span class="p">.</span><span class="n">ty</span><span class="p">),</span><span class="w"></span>
<span class="w">        </span><span class="p">})</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="k">pub</span><span class="w"> </span><span class="k">enum</span> <span class="nc">Type</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="c1">// ...</span>
<span class="w">    </span><span class="n">Variant</span><span class="p">(</span><span class="n">VariantIndex</span><span class="p">),</span><span class="w"></span>
<span class="w">    </span><span class="c1">// ...</span>
<span class="p">}</span><span class="w"></span>

<span class="k">impl</span><span class="w"> </span><span class="n">Type</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">fn</span> <span class="nf">from</span><span class="p">(</span><span class="n">ty</span>: <span class="kp">&amp;</span><span class="nc">InterfaceType</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nc">Self</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="k">match</span><span class="w"> </span><span class="n">ty</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">            </span><span class="c1">// ...</span>
<span class="w">            </span><span class="n">InterfaceType</span>::<span class="n">Variant</span><span class="p">(</span><span class="n">index</span><span class="p">)</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="n">Type</span>::<span class="n">Variant</span><span class="p">(</span><span class="n">VariantIndex</span><span class="p">(</span><span class="o">*</span><span class="n">index</span><span class="p">)),</span><span class="w"></span>
<span class="w">            </span><span class="c1">// ...</span>
<span class="w">        </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="k">pub</span><span class="w"> </span><span class="k">enum</span> <span class="nc">Val</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="c1">// ...</span>
<span class="w">    </span><span class="n">Variant</span><span class="p">(</span><span class="n">Variant</span><span class="p">),</span><span class="w"></span>
<span class="w">    </span><span class="c1">// ...</span>
<span class="p">}</span><span class="w"></span>

<span class="k">impl</span><span class="w"> </span><span class="n">Val</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="k">fn</span> <span class="nf">ty</span><span class="p">(</span><span class="o">&amp;</span><span class="bp">self</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nc">Type</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="k">match</span><span class="w"> </span><span class="bp">self</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">            </span><span class="c1">// ...</span>
<span class="w">            </span><span class="bp">Self</span>::<span class="n">Variant</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">ty</span><span class="p">,</span><span class="w"> </span><span class="o">..</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="n">Type</span>::<span class="n">Variant</span><span class="p">(</span><span class="n">ty</span><span class="p">),</span><span class="w"></span>
<span class="w">            </span><span class="c1">// ...</span>
<span class="w">        </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>

<span class="w">    </span><span class="c1">// ...</span>
<span class="p">}</span><span class="w"></span>

<span class="k">pub</span><span class="w"> </span><span class="k">struct</span> <span class="nc">Variant</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">ty</span>: <span class="nc">VariantIndex</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="n">discriminant</span>: <span class="kt">u32</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="n">value</span>: <span class="nb">Box</span><span class="o">&lt;</span><span class="n">Val</span><span class="o">&gt;</span><span class="p">,</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="k">impl</span><span class="w"> </span><span class="n">Variant</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="k">fn</span> <span class="nf">try_new</span><span class="p">(</span><span class="w"></span>
<span class="w">        </span><span class="n">ty</span>: <span class="nc">VariantIndex</span><span class="p">,</span><span class="w"></span>
<span class="w">        </span><span class="n">types</span>: <span class="nc">Types</span><span class="p">,</span><span class="w"></span>
<span class="w">        </span><span class="n">discriminant</span>: <span class="kt">u32</span><span class="p">,</span><span class="w"></span>
<span class="w">        </span><span class="n">value</span>: <span class="nb">Box</span><span class="o">&lt;</span><span class="n">Val</span><span class="o">&gt;</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nb">Result</span><span class="o">&lt;</span><span class="bp">Self</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="c1">// ... (here we would verify that `discriminant` and `value` match `ty` and throw an error otherwise)</span>

<span class="w">        </span><span class="nb">Ok</span><span class="p">(</span><span class="bp">Self</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">            </span><span class="n">ty</span><span class="p">,</span><span class="w"></span>
<span class="w">            </span><span class="n">discriminant</span><span class="p">,</span><span class="w"></span>
<span class="w">            </span><span class="n">value</span><span class="p">,</span><span class="w"></span>
<span class="w">        </span><span class="p">})</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="k">impl</span><span class="w"> </span><span class="n">Func</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="k">fn</span> <span class="nf">types</span><span class="p">(</span><span class="o">&amp;</span><span class="bp">self</span><span class="p">,</span><span class="w"> </span><span class="n">store</span>: <span class="nc">impl</span><span class="w"> </span><span class="n">AsContext</span><span class="o">&lt;'</span><span class="na">a</span><span class="o">&gt;</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nc">Types</span><span class="o">&lt;'</span><span class="na">a</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="n">Types</span><span class="p">(</span><span class="o">&amp;</span><span class="n">store</span><span class="p">.</span><span class="n">as_context</span><span class="p">()[</span><span class="bp">self</span><span class="p">.</span><span class="mi">0</span><span class="p">].</span><span class="n">types</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>

<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="k">fn</span> <span class="nf">get_param_type</span><span class="p">(</span><span class="o">&amp;</span><span class="bp">self</span><span class="p">,</span><span class="w"> </span><span class="n">store</span>: <span class="nc">impl</span><span class="w"> </span><span class="n">AsContext</span><span class="p">,</span><span class="w"> </span><span class="n">index</span>: <span class="kt">u32</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nc">Type</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="n">data</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&amp;</span><span class="n">store</span><span class="p">.</span><span class="n">as_context</span><span class="p">()[</span><span class="bp">self</span><span class="p">.</span><span class="mi">0</span><span class="p">];</span><span class="w"></span>
<span class="w">        </span><span class="n">Type</span>::<span class="n">from</span><span class="p">(</span><span class="n">data</span><span class="p">.</span><span class="n">types</span><span class="p">[</span><span class="n">data</span><span class="p">.</span><span class="n">ty</span><span class="p">].</span><span class="n">params</span><span class="p">[</span><span class="n">index</span><span class="p">])</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>

<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="k">fn</span> <span class="nf">get_result_type</span><span class="p">(</span><span class="o">&amp;</span><span class="bp">self</span><span class="p">,</span><span class="w"> </span><span class="n">store</span>: <span class="nc">impl</span><span class="w"> </span><span class="n">AsContext</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nc">Type</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="n">data</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&amp;</span><span class="n">store</span><span class="p">.</span><span class="n">as_context</span><span class="p">()[</span><span class="bp">self</span><span class="p">.</span><span class="mi">0</span><span class="p">];</span><span class="w"></span>
<span class="w">        </span><span class="n">Type</span>::<span class="n">from</span><span class="p">(</span><span class="n">data</span><span class="p">.</span><span class="n">types</span><span class="p">[</span><span class="n">data</span><span class="p">.</span><span class="n">ty</span><span class="p">].</span><span class="n">result</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>

<span class="w">    </span><span class="c1">// ...</span>
<span class="p">}</span><span class="w"></span>

<span class="cp">#[test]</span><span class="w"></span>
<span class="k">fn</span> <span class="nf">foo</span><span class="p">()</span><span class="w"> </span>-&gt; <span class="nb">Result</span><span class="o">&lt;</span><span class="p">()</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">engine</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">super</span>::<span class="n">engine</span><span class="p">();</span><span class="w"></span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">store</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Store</span>::<span class="n">new</span><span class="p">(</span><span class="o">&amp;</span><span class="n">engine</span><span class="p">,</span><span class="w"> </span><span class="p">());</span><span class="w"></span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">component</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Component</span>::<span class="n">new</span><span class="p">(</span><span class="w"></span>
<span class="w">        </span><span class="o">&amp;</span><span class="n">engine</span><span class="p">,</span><span class="w"></span>
<span class="w">        </span><span class="n">make_echo_component_with_params</span><span class="p">(</span><span class="w"></span>
<span class="w">            </span><span class="s">r#"(variant (case "A" u32) (case "B" s32))"#</span><span class="p">,</span><span class="w"></span>
<span class="w">            </span><span class="o">&amp;</span><span class="p">[</span><span class="k">super</span>::<span class="n">Type</span>::<span class="n">I32</span><span class="p">,</span><span class="w"> </span><span class="k">super</span>::<span class="n">Type</span>::<span class="n">I32</span><span class="p">],</span><span class="w"></span>
<span class="w">        </span><span class="p">),</span><span class="w"></span>
<span class="w">    </span><span class="p">)</span><span class="o">?</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">instance</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Linker</span>::<span class="n">new</span><span class="p">(</span><span class="o">&amp;</span><span class="n">engine</span><span class="p">).</span><span class="n">instantiate</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="n">store</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">component</span><span class="p">)</span><span class="o">?</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">func</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">instance</span><span class="p">.</span><span class="n">get_func</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="n">store</span><span class="p">,</span><span class="w"> </span><span class="s">"echo"</span><span class="p">).</span><span class="n">unwrap</span><span class="p">();</span><span class="w"></span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">ty</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">func</span><span class="p">.</span><span class="n">get_param_type</span><span class="p">(</span><span class="o">&amp;</span><span class="n">store</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">);</span><span class="w"></span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="kd">let</span><span class="w"> </span><span class="n">Type</span>::<span class="n">Variant</span><span class="p">(</span><span class="n">index</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ty</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="n">input</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span><span class="n">Val</span>::<span class="n">Variant</span><span class="p">(</span><span class="n">Variant</span>::<span class="n">try_new</span><span class="p">(</span><span class="n">ty</span><span class="p">,</span><span class="w"> </span><span class="n">func</span><span class="p">.</span><span class="n">types</span><span class="p">(</span><span class="o">&amp;</span><span class="n">store</span><span class="p">))</span><span class="o">?</span><span class="p">)];</span><span class="w"></span>
<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="n">output</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">func</span><span class="p">.</span><span class="n">call</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="n">store</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">input</span><span class="p">)</span><span class="o">?</span><span class="p">;</span><span class="w"></span>

<span class="w">        </span><span class="fm">assert_eq!</span><span class="p">(</span><span class="n">input</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="w"> </span><span class="n">output</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="fm">unreachable!</span><span class="p">()</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>

<span class="w">    </span><span class="nb">Ok</span><span class="p">(())</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>
<p>The ergonomics aren't outstanding, but the efficiency is pretty good.  My rationale for still exposing indexes is that Wasm itself uses indexes everywhere, so the paradigm will at least be familiar to users.</p>
<p>Happy to just use an <code>Arc&lt;ComponentTypes&gt;</code> everywhere if we want to prioritize ergonomics, though.</p>
</blockquote>



<a name="289735293"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%234442%20support%20dynamic%20function%20calls%20in%20.../near/289735293" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.234442.20support.20dynamic.20function.20calls.20in.20.2E.2E.2E.html#289735293">(Jul 15 2022 at 14:35)</a>:</h4>
<p>dicej <a href="https://github.com/bytecodealliance/wasmtime/pull/4442#issuecomment-1185608664">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/4442">issue #4442</a>:</p>
<blockquote>
<p>@alexcrichton Any thoughts on what I posted above?  I want to make sure we agree on the design of <code>Val</code> and <code>Type</code> before I start rewriting things.</p>
<p>Meanwhile, I'll start working on #4307 and come back to this once we have consensus.</p>
</blockquote>



<a name="289766523"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%234442%20support%20dynamic%20function%20calls%20in%20.../near/289766523" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.234442.20support.20dynamic.20function.20calls.20in.20.2E.2E.2E.html#289766523">(Jul 15 2022 at 18:39)</a>:</h4>
<p>alexcrichton <a href="https://github.com/bytecodealliance/wasmtime/pull/4442#issuecomment-1185809180">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/4442">issue #4442</a>:</p>
<blockquote>
<p>Apologies for the delay, busy day yesterday and this morning! That looks good to me though. Some things may be tweaked over time but I think that's good to land.</p>
</blockquote>



<a name="289989188"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%234442%20support%20dynamic%20function%20calls%20in%20.../near/289989188" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.234442.20support.20dynamic.20function.20calls.20in.20.2E.2E.2E.html#289989188">(Jul 18 2022 at 16:23)</a>:</h4>
<p>dicej <a href="https://github.com/bytecodealliance/wasmtime/pull/4442#issuecomment-1187705536">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/4442">issue #4442</a>:</p>
<blockquote>
<p>I started implementing this according to what I proposed above, but now I'm having second thoughts.  At first, I thought the natural place to do type checking was when creating the <code>Val</code>.  For example:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="k">impl</span><span class="w"> </span><span class="n">Variant</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="k">fn</span> <span class="nf">try_new</span><span class="p">(</span><span class="w"></span>
<span class="w">        </span><span class="n">ty</span>: <span class="nc">VariantIndex</span><span class="p">,</span><span class="w"> </span><span class="c1">// just a wrapper around a TypeVariantIndex</span>
<span class="w">        </span><span class="n">types</span>: <span class="nc">Types</span><span class="p">,</span><span class="w">  </span><span class="c1">// just a wrapper around a &amp;ComponentTypes</span>
<span class="w">        </span><span class="n">discriminant</span>: <span class="kt">u32</span><span class="p">,</span><span class="w"></span>
<span class="w">        </span><span class="n">value</span>: <span class="nb">Box</span><span class="o">&lt;</span><span class="n">Val</span><span class="o">&gt;</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nb">Result</span><span class="o">&lt;</span><span class="bp">Self</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="c1">// ... (here we would verify that `discriminant` and `value` match `ty` and throw an error otherwise)</span>

<span class="w">        </span><span class="nb">Ok</span><span class="p">(</span><span class="bp">Self</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">            </span><span class="n">ty</span><span class="p">,</span><span class="w"></span>
<span class="w">            </span><span class="n">discriminant</span><span class="p">,</span><span class="w"></span>
<span class="w">            </span><span class="n">value</span><span class="p">,</span><span class="w"></span>
<span class="w">        </span><span class="p">})</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>
<p>However, that has a big hole: an embedding programmer could accidentally create a <code>Val</code> using a <code>Types</code> from one component instance and then use it with a different one.  Since <code>Val</code> only has indexes, there's nothing to tie it to a specific component instance.  They might even get confused and try to build new <code>Val</code>s which contain other <code>Val</code>s from other component instances.</p>
<p>Also, my plan was to provide accessor methods for e.g. getting the cases for a <code>Type</code>, such that each accessor would take a <code>Types</code> parameter.  That would put the onus on the embedding programmer to make sure to always pass the correct <code>Types</code> instance, which I could imagine might get confusing when wrangling many component instances at once.</p>
<p>So now I think we're better off with @alexcrichton's suggestion of either embedding an <code>Arc&lt;ComponentTypes&gt;</code> or <code>&amp;ComponentTypes</code> inside each relevant <code>Type</code>' variant alongside the index.  Each corresponding <code>Val</code> variant would do the same.  We'd still need to be careful to prevent the programmer from building <code>Val</code>s which contain <code>Val</code>s from other component instances, and also check once more in <code>Func::call</code> that the parameters all reference the correct <code>ComponentTypes</code>, but at least that's quick and easy to do.</p>
<p>Another crazy idea would be to borrow a trick from <a href="https://plv.mpi-sws.org/rustbelt/ghostcell/">GhostCell</a> and tag <code>Val</code>s and <code>Type</code>s with a synthetic lifetime which uniquely identifies the component instance they may be used with.  That would probably be optimal from a performance standpoint, as well as catch issues at compile time instead of runtime, but perhaps it's a bit too exotic for the problem at hand?</p>
<p>One final thought: @alexcrichton how strongly do you feel that one should be able to get a <code>Type</code> from a <code>Val</code>?  I ask because I think there are ergonomic advantages to _not_ tying a <code>Val</code> to a specific type.  It certainly makes using <code>Func::call</code> easier -- just pass a &amp;[Val] in without needing to first ask the <code>Func</code> for its parameter <code>Type</code>s and match against each of them.  It could also be nice to use the output of a <code>Func::call</code> from one component instance as the input to a <code>Func::call</code> in another instance without any explicit conversion.</p>
</blockquote>



<a name="290025542"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%234442%20support%20dynamic%20function%20calls%20in%20.../near/290025542" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.234442.20support.20dynamic.20function.20calls.20in.20.2E.2E.2E.html#290025542">(Jul 18 2022 at 21:28)</a>:</h4>
<p>alexcrichton <a href="https://github.com/bytecodealliance/wasmtime/pull/4442#issuecomment-1188330843">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/4442">issue #4442</a>:</p>
<blockquote>
<p>Hm yes that is indeed a problem! FWIW this is solved at the store level with the <code>store_id</code> field in <code>Stored&lt;T&gt;</code>, basically a solution for ABA problem (ish). We could do something similar here where each component is assigned a unique index at runtime to prevent mixing types (although we would still want to sort of support equality of types across components which could perhaps get quite nasty quite quickly, unsure).</p>
<p>Otherwise though storing <code>Arc&lt;T&gt;</code> would also be a good solution. I don't know a ton about <code>GhostCell</code> myself but when I skimmed it in the past it looked like it wouldn't ever really lend itself well to an ergonomic API. I haven't tried using it historically though.</p>
<p>I dunno how to feel about getting a <code>Type</code> from a <code>Val</code>. I feel like it should be possible as a primitive operation, but I'm not exactly certain in this opinion. The current iteration where a record is just a list of <code>Val</code> also feels a bit odd to me in that there's no correlation with field names at construction to when the value is used, which seems like it may accidentally be easy to shoot yourself in the foot by mixing up field orders or things like that.</p>
<p>Personally I'm trying to stay analgous to the core wasm API, but I realize how it's a lot easier there than it is here. I don't really know the best answer to any of these questions. Our main use case for this is fuzzing at this point where getting a <code>Type</code> from <code>Val</code> may not matter too much. </p>
</blockquote>



<a name="290331519"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%234442%20support%20dynamic%20function%20calls%20in%20.../near/290331519" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.234442.20support.20dynamic.20function.20calls.20in.20.2E.2E.2E.html#290331519">(Jul 21 2022 at 04:14)</a>:</h4>
<p>dicej <a href="https://github.com/bytecodealliance/wasmtime/pull/4442#issuecomment-1191017882">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/4442">issue #4442</a>:</p>
<blockquote>
<p>I've overhauled the code according to the above feedback, and I decided to squash and rebase since so much was changing anyway.  Please let me know what you think.</p>
<p>Highlights to note:</p>
<ul>
<li><code>component::types::Type</code> is public, and <code>Val</code> now has a <code>ty</code> method to get the type of that value as a <code>Type</code>.  This should also be suitable for use with <code>Component::exports</code> and <code>Component::imports</code> when the time comes to implement those.</li>
<li>I manged to reuse <code>call_raw</code> so there's minimal duplication in <code>Func::call</code> and no new <code>unsafe</code> code (but note that <code>call_raw</code> has moved to <code>Func</code> along with <code>post_return</code>).</li>
<li>Type checking now mostly happens during <code>Val</code> creation, with one final, quick, linear-time check happening in <code>Func::call</code>.</li>
<li>The sad path tests are now checking for specific errors.</li>
</ul>
</blockquote>



<a name="290445985"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%234442%20support%20dynamic%20function%20calls%20in%20.../near/290445985" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.234442.20support.20dynamic.20function.20calls.20in.20.2E.2E.2E.html#290445985">(Jul 21 2022 at 23:13)</a>:</h4>
<p>dicej <a href="https://github.com/bytecodealliance/wasmtime/pull/4442#issuecomment-1192018806">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/4442">issue #4442</a>:</p>
<blockquote>
<p>Thanks so much for the thorough review, @alexcrichton.  I've addressed some of the issues you raised (and marked the corresponding conversations "resolved") and will look at the others tomorrow.</p>
</blockquote>



<a name="290550966"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%234442%20support%20dynamic%20function%20calls%20in%20.../near/290550966" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.234442.20support.20dynamic.20function.20calls.20in.20.2E.2E.2E.html#290550966">(Jul 22 2022 at 18:37)</a>:</h4>
<p>dicej <a href="https://github.com/bytecodealliance/wasmtime/pull/4442#issuecomment-1192840410">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/4442">issue #4442</a>:</p>
<blockquote>
<p>@alexcrichton I believe I've addressed everything you mentioned.  I'm still unsure about how <code>Type</code> equality should work, but I'm hoping the current implementation is good enough to start with and can be refined later.</p>
</blockquote>



<a name="290794887"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%234442%20support%20dynamic%20function%20calls%20in%20.../near/290794887" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.234442.20support.20dynamic.20function.20calls.20in.20.2E.2E.2E.html#290794887">(Jul 25 2022 at 17:51)</a>:</h4>
<p>dicej <a href="https://github.com/bytecodealliance/wasmtime/pull/4442#issuecomment-1194412601">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/4442">issue #4442</a>:</p>
<blockquote>
<p>@alexcrichton I've addressed your latest feedback and opened <a href="https://github.com/bytecodealliance/wasmtime/issues/4522">https://github.com/bytecodealliance/wasmtime/issues/4522</a>.</p>
</blockquote>



<a name="290800993"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%234442%20support%20dynamic%20function%20calls%20in%20.../near/290800993" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.234442.20support.20dynamic.20function.20calls.20in.20.2E.2E.2E.html#290800993">(Jul 25 2022 at 18:38)</a>:</h4>
<p>alexcrichton <a href="https://github.com/bytecodealliance/wasmtime/pull/4442#issuecomment-1194464656">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/4442">issue #4442</a>:</p>
<blockquote>
<p>Thanks again for this @dicej!</p>
</blockquote>



<hr><p>Last updated: Jan 20 2025 at 06:04 UTC</p>
</html>