<html>
<head><meta charset="utf-8"><title>wasmtime / PR #5268 wiggle: Refactor with fewer raw pointers · git-wasmtime · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/index.html">git-wasmtime</a></h2>
<h3>Topic: <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.235268.20wiggle.3A.20Refactor.20with.20fewer.20raw.20pointers.html">wasmtime / PR #5268 wiggle: Refactor with fewer raw pointers</a></h3>

<hr>

<base href="https://bytecodealliance.zulipchat.com">

<head><link href="https://bytecodealliance.github.io/zulip-archive/style.css" rel="stylesheet"></head>

<a name="310118064"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%235268%20wiggle%3A%20Refactor%20with%20fewer%20raw%20pointers/near/310118064" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.235268.20wiggle.3A.20Refactor.20with.20fewer.20raw.20pointers.html#310118064">(Nov 15 2022 at 02:26)</a>:</h4>
<p><strong>alexcrichton</strong> requested <a href="https://github.com/abrown">abrown</a> for a review on <a href="https://github.com/bytecodealliance/wasmtime/pull/5268">PR #5268</a>.</p>



<a name="310118065"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%235268%20wiggle%3A%20Refactor%20with%20fewer%20raw%20pointers/near/310118065" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.235268.20wiggle.3A.20Refactor.20with.20fewer.20raw.20pointers.html#310118065">(Nov 15 2022 at 02:26)</a>:</h4>
<p>alexcrichton opened <a href="https://github.com/bytecodealliance/wasmtime/pull/5268">PR #5268</a> from <code>unsafe-wiggle-internals</code> to <code>main</code>:</p>
<blockquote>
<p>This commit refactors the internals of <code>wiggle</code> to have fewer raw pointers and more liberally use <code>&amp;[UnsafeCell&lt;_&gt;]</code>. The purpose of this refactoring is to more strictly thread through lifetime information throughout the crate to avoid getting it wrong. Additionally storing <code>UnsafeCell&lt;T&gt;</code> at rest pushes the unsafety of access to the leaves of modifications where Rust safety guarantees are upheld. Finally this provides what I believe is a safer internal representation of <code>WasmtimeGuestMemory</code> since it technically holds onto <code>&amp;mut [u8]</code> un-soundly as other <code>&amp;mut T</code> pointers are handed out.</p>
<p>&lt;!--</p>
<p>Please ensure that the following steps are all taken care of before submitting<br>
the PR.</p>
<ul>
<li>
<p>[ ] This has been discussed in issue #..., or if not, please tell us why<br>
  here.</p>
</li>
<li>
<p>[ ] A short description of what this does, why it is needed; if the<br>
  description becomes long, the matter should probably be discussed in an issue<br>
  first.</p>
</li>
<li>
<p>[ ] This PR contains test cases, if meaningful.</p>
</li>
<li>[ ] A reviewer from the core maintainer team has been assigned for this PR.<br>
  If you don't know who could review this, please indicate so. The list of<br>
  suggested reviewers on the right can help you.</li>
</ul>
<p>Please ensure all communication adheres to the <a href="https://github.com/bytecodealliance/wasmtime/blob/master/CODE_OF_CONDUCT.md">code of
conduct</a>.<br>
--&gt;<br>
</p>
</blockquote>



<a name="310220461"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%235268%20wiggle%3A%20Refactor%20with%20fewer%20raw%20pointers/near/310220461" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.235268.20wiggle.3A.20Refactor.20with.20fewer.20raw.20pointers.html#310220461">(Nov 15 2022 at 15:05)</a>:</h4>
<p>alexcrichton updated <a href="https://github.com/bytecodealliance/wasmtime/pull/5268">PR #5268</a> from <code>unsafe-wiggle-internals</code> to <code>main</code>.</p>



<a name="310244474"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%235268%20wiggle%3A%20Refactor%20with%20fewer%20raw%20pointers/near/310244474" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.235268.20wiggle.3A.20Refactor.20with.20fewer.20raw.20pointers.html#310244474">(Nov 15 2022 at 16:55)</a>:</h4>
<p>abrown submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/5268#pullrequestreview-1181235780">PR review</a>.</p>



<a name="310247848"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%235268%20wiggle%3A%20Refactor%20with%20fewer%20raw%20pointers/near/310247848" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.235268.20wiggle.3A.20Refactor.20with.20fewer.20raw.20pointers.html#310247848">(Nov 15 2022 at 17:11)</a>:</h4>
<p>alexcrichton edited <a href="https://github.com/bytecodealliance/wasmtime/pull/5268">PR #5268</a> from <code>unsafe-wiggle-internals</code> to <code>main</code>:</p>
<blockquote>
<p>This commit refactors the internals of <code>wiggle</code> to have fewer raw pointers and more liberally use <code>&amp;[UnsafeCell&lt;_&gt;]</code>. The purpose of this refactoring is to more strictly thread through lifetime information throughout the crate to avoid getting it wrong. Additionally storing <code>UnsafeCell&lt;T&gt;</code> at rest pushes the unsafety of access to the leaves of modifications where Rust safety guarantees are upheld. Finally this provides what I believe is a safer internal representation of <code>WasmtimeGuestMemory</code> since it technically holds onto <code>&amp;mut [u8]</code> un-soundly as other <code>&amp;mut T</code> pointers are handed out.</p>
<p>Additionally generated <code>GuestTypeTransparent</code> impls in the <code>wiggle</code> macro were removed because they are not safe for shared memories as-is and otherwise aren't needed for WASI today. The trait has been updated to indicate that all bit patterns must be valid in addition to having the same representation on the host as in the guest to accomodate this.</p>
</blockquote>



<a name="310247887"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%235268%20wiggle%3A%20Refactor%20with%20fewer%20raw%20pointers/near/310247887" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.235268.20wiggle.3A.20Refactor.20with.20fewer.20raw.20pointers.html#310247887">(Nov 15 2022 at 17:11)</a>:</h4>
<p>alexcrichton merged <a href="https://github.com/bytecodealliance/wasmtime/pull/5268">PR #5268</a>.</p>



<hr><p>Last updated: Jan 20 2025 at 06:04 UTC</p>
</html>