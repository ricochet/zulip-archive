<html>
<head><meta charset="utf-8"><title>wasmtime / PR #3706 s390x: Add ISLE support · git-wasmtime · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/index.html">git-wasmtime</a></h2>
<h3>Topic: <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.233706.20s390x.3A.20Add.20ISLE.20support.html">wasmtime / PR #3706 s390x: Add ISLE support</a></h3>

<hr>

<base href="https://bytecodealliance.zulipchat.com">

<head><link href="https://bytecodealliance.github.io/zulip-archive/style.css" rel="stylesheet"></head>

<a name="268756090"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%233706%20s390x%3A%20Add%20ISLE%20support/near/268756090" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.233706.20s390x.3A.20Add.20ISLE.20support.html#268756090">(Jan 20 2022 at 20:55)</a>:</h4>
<p>uweigand opened <a href="https://github.com/bytecodealliance/wasmtime/pull/3706">PR #3706</a> from <code>isle-s390x</code> to <code>main</code>:</p>
<blockquote>
<p>This adds ISLE support for the s390x back-end and moves lowering<br>
of most instructions to ISLE.  The only instructions still remaining<br>
are calls, returns, traps, and branches, most of which will need<br>
additional support in common code.</p>
<p>Generated code is not intended to be (significantly) differnet<br>
than before; any additional optimizations due to the ISLE layer<br>
can be added in follow-on patches.  There were a few differences<br>
in some filetests, but those are all just simple register allocation<br>
changes (and all to the better!).</p>
<p>CC @cfallin @fitzgen </p>
<p>&lt;!--</p>
<p>Please ensure that the following steps are all taken care of before submitting<br>
the PR.</p>
<ul>
<li>
<p>[ ] This has been discussed in issue #..., or if not, please tell us why<br>
  here.</p>
</li>
<li>
<p>[ ] A short description of what this does, why it is needed; if the<br>
  description becomes long, the matter should probably be discussed in an issue<br>
  first.</p>
</li>
<li>
<p>[ ] This PR contains test cases, if meaningful.</p>
</li>
<li>[ ] A reviewer from the core maintainer team has been assigned for this PR.<br>
  If you don't know who could review this, please indicate so. The list of<br>
  suggested reviewers on the right can help you.</li>
</ul>
<p>Please ensure all communication adheres to the <a href="https://github.com/bytecodealliance/wasmtime/blob/master/CODE_OF_CONDUCT.md">code of
conduct</a>.<br>
--&gt;<br>
</p>
</blockquote>



<a name="268762812"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%233706%20s390x%3A%20Add%20ISLE%20support/near/268762812" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.233706.20s390x.3A.20Add.20ISLE.20support.html#268762812">(Jan 20 2022 at 21:45)</a>:</h4>
<p>uweigand updated <a href="https://github.com/bytecodealliance/wasmtime/pull/3706">PR #3706</a> from <code>isle-s390x</code> to <code>main</code>.</p>



<a name="268768986"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%233706%20s390x%3A%20Add%20ISLE%20support/near/268768986" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.233706.20s390x.3A.20Add.20ISLE.20support.html#268768986">(Jan 20 2022 at 22:45)</a>:</h4>
<p>cfallin submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/3706#pullrequestreview-858875849">PR review</a>.</p>



<a name="268768987"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%233706%20s390x%3A%20Add%20ISLE%20support/near/268768987" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.233706.20s390x.3A.20Add.20ISLE.20support.html#268768987">(Jan 20 2022 at 22:45)</a>:</h4>
<p>cfallin submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/3706#pullrequestreview-858875849">PR review</a>.</p>



<a name="268768988"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%233706%20s390x%3A%20Add%20ISLE%20support/near/268768988" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.233706.20s390x.3A.20Add.20ISLE.20support.html#268768988">(Jan 20 2022 at 22:45)</a>:</h4>
<p>cfallin created <a href="https://github.com/bytecodealliance/wasmtime/pull/3706#discussion_r789203233">PR review comment</a>:</p>
<blockquote>
<p>A future-looking note here: when we get to verifying rules, in theory we want every rule to be independently correct, i.e., not only correct in cases not shadowed by other rules. Here and in some other spots nearby I notice the pattern of specific cases followed by wildcards, which is fine for this as long as the more general fallback is correct without the special case, but here appears not to be.</p>
<p>Earlier we had tried to follow the principle that rule ordering is <em>completely</em> flexible, and any applicable rule could fire, so the LHSes need to be disjoint or priorities need to be used if one must fire over the other. But I think that's pretty surprising and un-ergonomic in cases like this, so the DSL compiler now goes for "more specific rule first" which will indeed to the right thing here.</p>
<p>We'll undoubtedly uncover other cases like this if/when we do try to verify in this way but I just thought I'd note it as a principle we're trying to stick to elsewhere; here a <code>(not_neg1)</code> extractor or somesuch might cause fewer issues later...</p>
<p>(Part of me still likes the simplicity of "first written rule takes priority"; it's simple, explicit, no hidden magic... but others voiced good reasons not to do that, so, too late now probably...)</p>
</blockquote>



<a name="268779922"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%233706%20s390x%3A%20Add%20ISLE%20support/near/268779922" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.233706.20s390x.3A.20Add.20ISLE.20support.html#268779922">(Jan 21 2022 at 00:45)</a>:</h4>
<p>fitzgen submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/3706#pullrequestreview-858932595">PR review</a>.</p>



<a name="268779923"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%233706%20s390x%3A%20Add%20ISLE%20support/near/268779923" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.233706.20s390x.3A.20Add.20ISLE.20support.html#268779923">(Jan 21 2022 at 00:45)</a>:</h4>
<p>fitzgen submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/3706#pullrequestreview-858932595">PR review</a>.</p>



<a name="268779924"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%233706%20s390x%3A%20Add%20ISLE%20support/near/268779924" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.233706.20s390x.3A.20Add.20ISLE.20support.html#268779924">(Jan 21 2022 at 00:45)</a>:</h4>
<p>fitzgen created <a href="https://github.com/bytecodealliance/wasmtime/pull/3706#discussion_r789246285">PR review comment</a>:</p>
<blockquote>
<p>Nitpick: it would be nice if the docs for this term and the other similar ones below it mentioned that this is a side-effectful operation.</p>
</blockquote>



<a name="268779925"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%233706%20s390x%3A%20Add%20ISLE%20support/near/268779925" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.233706.20s390x.3A.20Add.20ISLE.20support.html#268779925">(Jan 21 2022 at 00:45)</a>:</h4>
<p>fitzgen created <a href="https://github.com/bytecodealliance/wasmtime/pull/3706#discussion_r789253236">PR review comment</a>:</p>
<blockquote>
<p>Along similar lines, I think this should be</p>
<p><div class="codehilite" data-code-language="suggestion"><pre><span></span><code>(rule (maybe_trap_if_sdiv_overflow $false _ _ _) (invalid_reg))
</code></pre></div><br>
</p>
</blockquote>



<a name="268779926"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%233706%20s390x%3A%20Add%20ISLE%20support/near/268779926" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.233706.20s390x.3A.20Add.20ISLE.20support.html#268779926">(Jan 21 2022 at 00:45)</a>:</h4>
<p>fitzgen created <a href="https://github.com/bytecodealliance/wasmtime/pull/3706#discussion_r789253685">PR review comment</a>:</p>
<blockquote>
<p><div class="codehilite" data-code-language="suggestion"><pre><span></span><code>(rule (maybe_avoid_srem_overflow $false _ x _) x)
</code></pre></div><br>
</p>
</blockquote>



<a name="268779928"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%233706%20s390x%3A%20Add%20ISLE%20support/near/268779928" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.233706.20s390x.3A.20Add.20ISLE.20support.html#268779928">(Jan 21 2022 at 00:45)</a>:</h4>
<p>fitzgen created <a href="https://github.com/bytecodealliance/wasmtime/pull/3706#discussion_r789252874">PR review comment</a>:</p>
<blockquote>
<blockquote>
<p>We'll undoubtedly uncover other cases like this if/when we do try to verify in this way but I just thought I'd note it as a principle we're trying to stick to elsewhere; here a (not_neg1) extractor or somesuch might cause fewer issues later...</p>
</blockquote>
<p>+1</p>
</blockquote>



<a name="268848810"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%233706%20s390x%3A%20Add%20ISLE%20support/near/268848810" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.233706.20s390x.3A.20Add.20ISLE.20support.html#268848810">(Jan 21 2022 at 14:21)</a>:</h4>
<p>uweigand submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/3706#pullrequestreview-859601380">PR review</a>.</p>



<a name="268848811"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%233706%20s390x%3A%20Add%20ISLE%20support/near/268848811" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.233706.20s390x.3A.20Add.20ISLE.20support.html#268848811">(Jan 21 2022 at 14:21)</a>:</h4>
<p>uweigand created <a href="https://github.com/bytecodealliance/wasmtime/pull/3706#discussion_r789697301">PR review comment</a>:</p>
<blockquote>
<p>OK, I wasn't aware of that requirement.  For the divide checks, this should be straightforward using some extra extractors as you say.   We still need a default case, but as long as the default is <code>true</code> instead of <code>false</code> it will still be always correct.  However, I guess I then cannot use the <code>(avoid_div_traps)</code> extractor as-is, since I need the negated sense now.  I don't think there's way to do that negation on ISLE, so I'd need another extractor e.g. like so:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="p">(</span><span class="n">decl</span><span class="w"> </span><span class="n">zero_divisor_check_needed</span><span class="w"> </span><span class="p">(</span><span class="n">Value</span><span class="p">)</span><span class="w"> </span><span class="kt">bool</span><span class="p">)</span><span class="w"></span>
<span class="p">(</span><span class="n">rule</span><span class="w"> </span><span class="p">(</span><span class="n">zero_divisor_check_needed</span><span class="w"> </span><span class="p">(</span><span class="n">u64_from_value</span><span class="w"> </span><span class="p">(</span><span class="n">u64_nonzero</span><span class="w"> </span><span class="n">_</span><span class="p">))</span><span class="w"> </span><span class="cp">$false</span><span class="p">))</span><span class="w"></span>
<span class="p">(</span><span class="n">rule</span><span class="w"> </span><span class="p">(</span><span class="n">zero_divisor_check_needed</span><span class="w"> </span><span class="p">(</span><span class="n">value_type</span><span class="w"> </span><span class="p">(</span><span class="n">allow_div_traps</span><span class="p">))</span><span class="w"> </span><span class="cp">$false</span><span class="p">))</span><span class="w"></span>
<span class="p">(</span><span class="n">rule</span><span class="w"> </span><span class="p">(</span><span class="n">zero_divisor_check_needed</span><span class="w"> </span><span class="n">_</span><span class="w"> </span><span class="cp">$true</span><span class="p">))</span><span class="w"></span>
</code></pre></div>
<p>That new <code>(allow_div_traps)</code> should probably go into the common prelude as well.</p>
<p>However, I have made that same assumption extensively elsewhere, in particular when dispatching between different input types.  For example, there's frequently the pattern of a pair of  <code>(fits_in_32 ty)</code> and <code>(fits_in_64 ty)</code> rules, where 32-bit types <em>must</em> use the <code>fits_in_32</code> rule, since the input isn't sufficiently sign- or zero-extended so the instruction behind the <code>fits_in_64</code> rule would yield an incorrect result.   Similarly, for e.g. moves I have both a <code>(fits_in_32 ty)</code> rule and a <code>$F32</code> rule, where the <code>fits_in_32</code> rule is incorrect for <code>$F32</code> as it uses a GPR instruction.</p>
<p>To ensure each rule is independently correct (if not optimal), I need to rework all this type handling.  This probably means making supported types for each rule much more explicit, which is probably a good thing in the long run anyway.</p>
<p>I'll be working on this and provide an updated patch.<br>
</p>
</blockquote>



<a name="268849000"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%233706%20s390x%3A%20Add%20ISLE%20support/near/268849000" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.233706.20s390x.3A.20Add.20ISLE.20support.html#268849000">(Jan 21 2022 at 14:23)</a>:</h4>
<p>uweigand submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/3706#pullrequestreview-859603357">PR review</a>.</p>



<a name="268849002"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%233706%20s390x%3A%20Add%20ISLE%20support/near/268849002" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.233706.20s390x.3A.20Add.20ISLE.20support.html#268849002">(Jan 21 2022 at 14:23)</a>:</h4>
<p>uweigand created <a href="https://github.com/bytecodealliance/wasmtime/pull/3706#discussion_r789698580">PR review comment</a>:</p>
<blockquote>
<p>Of course, done.</p>
</blockquote>



<a name="268883998"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%233706%20s390x%3A%20Add%20ISLE%20support/near/268883998" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.233706.20s390x.3A.20Add.20ISLE.20support.html#268883998">(Jan 21 2022 at 18:32)</a>:</h4>
<p>uweigand updated <a href="https://github.com/bytecodealliance/wasmtime/pull/3706">PR #3706</a> from <code>isle-s390x</code> to <code>main</code>.</p>



<a name="268890815"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%233706%20s390x%3A%20Add%20ISLE%20support/near/268890815" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.233706.20s390x.3A.20Add.20ISLE.20support.html#268890815">(Jan 21 2022 at 19:22)</a>:</h4>
<p>fitzgen submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/3706#pullrequestreview-859943523">PR review</a>.</p>



<a name="268891142"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%233706%20s390x%3A%20Add%20ISLE%20support/near/268891142" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.233706.20s390x.3A.20Add.20ISLE.20support.html#268891142">(Jan 21 2022 at 19:25)</a>:</h4>
<p>cfallin merged <a href="https://github.com/bytecodealliance/wasmtime/pull/3706">PR #3706</a>.</p>



<hr><p>Last updated: Jan 20 2025 at 06:04 UTC</p>
</html>