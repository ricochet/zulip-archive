<html>
<head><meta charset="utf-8"><title>wasmtime / Issue #2537 Make cranelift-codegen-shared no_std · git-wasmtime · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/index.html">git-wasmtime</a></h2>
<h3>Topic: <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20Issue.20.232537.20Make.20cranelift-codegen-shared.20no_std.html">wasmtime / Issue #2537 Make cranelift-codegen-shared no_std</a></h3>

<hr>

<base href="https://bytecodealliance.zulipchat.com">

<head><link href="https://bytecodealliance.github.io/zulip-archive/style.css" rel="stylesheet"></head>

<a name="221455359"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20Issue%20%232537%20Make%20cranelift-codegen-shared%20no_std/near/221455359" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20Issue.20.232537.20Make.20cranelift-codegen-shared.20no_std.html#221455359">(Jan 03 2021 at 15:16)</a>:</h4>
<p>tomaka <a href="https://github.com/bytecodealliance/wasmtime/pull/2537#issuecomment-753632372">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/2537">Issue #2537</a>:</p>
<blockquote>
<p>The CI failure looks unrelated to the PR:</p>
<blockquote>
<p>rust-lld: error while loading shared libraries: <a href="http://libLLVM-11-rust-1.49.0-stable.so">libLLVM-11-rust-1.49.0-stable.so</a>: cannot open shared object file: No such file or director</p>
</blockquote>
</blockquote>



<a name="221455596"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20Issue%20%232537%20Make%20cranelift-codegen-shared%20no_std/near/221455596" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20Issue.20.232537.20Make.20cranelift-codegen-shared.20no_std.html#221455596">(Jan 03 2021 at 15:23)</a>:</h4>
<p>bjorn3 <a href="https://github.com/bytecodealliance/wasmtime/pull/2537#issuecomment-753633207">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/2537">Issue #2537</a>:</p>
<blockquote>
<p>This is for <a href="https://github.com/tomaka/redshirt">https://github.com/tomaka/redshirt</a>, right?</p>
</blockquote>



<a name="221455796"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20Issue%20%232537%20Make%20cranelift-codegen-shared%20no_std/near/221455796" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20Issue.20.232537.20Make.20cranelift-codegen-shared.20no_std.html#221455796">(Jan 03 2021 at 15:28)</a>:</h4>
<p>tomaka <a href="https://github.com/bytecodealliance/wasmtime/pull/2537#issuecomment-753633981">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/2537">Issue #2537</a>:</p>
<blockquote>
<blockquote>
<p>This is for <a href="https://github.com/tomaka/redshirt">https://github.com/tomaka/redshirt</a>, right?</p>
</blockquote>
<p>Indeed! My current plan to fork everything and add (back) <code>no-std</code> compatibility. I'm upstreaming a few changes which I think are uncontroversial.</p>
<p>Since redshirt isn't my actual job and the holiday season coming to an end, the chances of actually implementing <code>no-std</code> compatibility any time soon are pretty low, but I wanted to get something going.<br>
</p>
</blockquote>



<a name="221455797"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20Issue%20%232537%20Make%20cranelift-codegen-shared%20no_std/near/221455797" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20Issue.20.232537.20Make.20cranelift-codegen-shared.20no_std.html#221455797">(Jan 03 2021 at 15:28)</a>:</h4>
<p>tomaka edited a <a href="https://github.com/bytecodealliance/wasmtime/pull/2537#issuecomment-753633981">comment</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/2537">Issue #2537</a>:</p>
<blockquote>
<blockquote>
<p>This is for <a href="https://github.com/tomaka/redshirt">https://github.com/tomaka/redshirt</a>, right?</p>
</blockquote>
<p>Indeed! My current plan to fork everything and add (back) <code>no-std</code> compatibility in hacky ways. I'm upstreaming a few changes which I think are uncontroversial.</p>
<p>Since redshirt isn't my actual job and the holiday season coming to an end, the chances of actually implementing <code>no-std</code> compatibility any time soon are pretty low, but I wanted to get something going.<br>
</p>
</blockquote>



<a name="221455804"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20Issue%20%232537%20Make%20cranelift-codegen-shared%20no_std/near/221455804" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20Issue.20.232537.20Make.20cranelift-codegen-shared.20no_std.html#221455804">(Jan 03 2021 at 15:29)</a>:</h4>
<p>tomaka edited a <a href="https://github.com/bytecodealliance/wasmtime/pull/2537#issuecomment-753633981">comment</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/2537">Issue #2537</a>:</p>
<blockquote>
<blockquote>
<p>This is for <a href="https://github.com/tomaka/redshirt">https://github.com/tomaka/redshirt</a>, right?</p>
</blockquote>
<p>Indeed! My current plan to fork everything and add (back) <code>no-std</code> compatibility potentially in hacky ways (e.g. the <code>thiserror</code> dependency is fundamentally incompatible with no-std, so I'm changing it). I'm upstreaming a few changes which I think are uncontroversial.</p>
<p>Since redshirt isn't my actual job and the holiday season coming to an end, the chances of actually implementing <code>no-std</code> compatibility any time soon are pretty low, but I wanted to get something going.<br>
</p>
</blockquote>



<a name="221455807"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20Issue%20%232537%20Make%20cranelift-codegen-shared%20no_std/near/221455807" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20Issue.20.232537.20Make.20cranelift-codegen-shared.20no_std.html#221455807">(Jan 03 2021 at 15:29)</a>:</h4>
<p>tomaka edited a <a href="https://github.com/bytecodealliance/wasmtime/pull/2537#issuecomment-753633981">comment</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/2537">Issue #2537</a>:</p>
<blockquote>
<blockquote>
<p>This is for <a href="https://github.com/tomaka/redshirt">https://github.com/tomaka/redshirt</a>, right?</p>
</blockquote>
<p>Indeed! My current plan to fork everything and add (back) <code>no-std</code> compatibility potentially in hacky ways (e.g. the <code>thiserror</code> dependency is fundamentally incompatible with no-std, so I'm changing it). I'm upstreaming a few changes which I think are uncontroversial.</p>
<p>Since redshirt isn't my actual job and the holiday season is coming to an end, the chances of actually implementing <code>no-std</code> compatibility any time soon are pretty low, but I wanted to get something going.<br>
</p>
</blockquote>



<a name="221540663"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20Issue%20%232537%20Make%20cranelift-codegen-shared%20no_std/near/221540663" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20Issue.20.232537.20Make.20cranelift-codegen-shared.20no_std.html#221540663">(Jan 04 2021 at 15:56)</a>:</h4>
<p>alexcrichton <a href="https://github.com/bytecodealliance/wasmtime/pull/2537#issuecomment-754057070">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/2537">Issue #2537</a>:</p>
<blockquote>
<p>We have a <a href="https://docs.wasmtime.dev/stability-platform-support.html#what-about-no_std">somewhat lengthy documentation section</a> about why <code>#![no_std]</code> isn't currently used, would you be able to comment as to how your use case fits into that?</p>
</blockquote>



<a name="221545199"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20Issue%20%232537%20Make%20cranelift-codegen-shared%20no_std/near/221545199" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20Issue.20.232537.20Make.20cranelift-codegen-shared.20no_std.html#221545199">(Jan 04 2021 at 16:26)</a>:</h4>
<p>tomaka <a href="https://github.com/bytecodealliance/wasmtime/pull/2537#issuecomment-754074450">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/2537">Issue #2537</a>:</p>
<blockquote>
<blockquote>
<p>The patch to switch to #![no_std] is small, why not accept it?</p>
</blockquote>
<p>Ah sorry, I've seen this but a long time ago, and forgot the existence of this section.</p>
<p>I'm building (on my free time) an operating system that executes Wasm programs on bare metal, directly in ring 0.</p>
<blockquote>
<p>For platforms without support for the Rust standard library the JIT compiler of Wasmtime often won't run on the platform as well. The JIT compiler requires mmap (or an equivalent), and presence of mmap often implies presence of a libc which means Rust's std library works.</p>
</blockquote>
<p>I can somewhat easily implement mmap (assuming <code>MAP_ANONYMOUS</code>) and threads on bare metal, but implementing a shim of libc or standard library full of <code>unimplemented!()</code> expressions just for <code>wasmtime</code> to work seems kind of "wrong", and way more efforts than forking wasmtime and replacing the platform-specific code with my own.<br>
</p>
</blockquote>



<a name="221545355"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20Issue%20%232537%20Make%20cranelift-codegen-shared%20no_std/near/221545355" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20Issue.20.232537.20Make.20cranelift-codegen-shared.20no_std.html#221545355">(Jan 04 2021 at 16:27)</a>:</h4>
<p>tomaka edited a <a href="https://github.com/bytecodealliance/wasmtime/pull/2537#issuecomment-754074450">comment</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/2537">Issue #2537</a>:</p>
<blockquote>
<blockquote>
<p>The patch to switch to #![no_std] is small, why not accept it?</p>
</blockquote>
<p>Ah sorry, I've seen this but a long time ago, and forgot the existence of this section.</p>
<p>I'm building (on my free time) an operating system that executes Wasm programs on bare metal, directly in ring 0.<br>
It's already functional, but terribly slow as it's using <code>wasmi</code> the interpreter.</p>
<blockquote>
<p>For platforms without support for the Rust standard library the JIT compiler of Wasmtime often won't run on the platform as well. The JIT compiler requires mmap (or an equivalent), and presence of mmap often implies presence of a libc which means Rust's std library works.</p>
</blockquote>
<p>I can somewhat easily implement mmap (assuming <code>MAP_ANONYMOUS</code>) and threads on bare metal, but implementing a shim of libc or standard library full of <code>unimplemented!()</code> expressions just for <code>wasmtime</code> to work seems kind of "wrong", and way more efforts than forking wasmtime and replacing the platform-specific code with my own.<br>
</p>
</blockquote>



<a name="221546871"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20Issue%20%232537%20Make%20cranelift-codegen-shared%20no_std/near/221546871" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20Issue.20.232537.20Make.20cranelift-codegen-shared.20no_std.html#221546871">(Jan 04 2021 at 16:38)</a>:</h4>
<p>alexcrichton <a href="https://github.com/bytecodealliance/wasmtime/pull/2537#issuecomment-754081130">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/2537">Issue #2537</a>:</p>
<blockquote>
<p>I would personally recommend for your use case that using <code>std</code> is the way to go. The standard library already has targets like wasm itself which return errors for any unsupported operations (like <code>std::thread</code>), and if you're using <code>std</code> then this and other crates (like <code>wasmparser</code>) would just work.</p>
</blockquote>



<a name="221548096"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20Issue%20%232537%20Make%20cranelift-codegen-shared%20no_std/near/221548096" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20Issue.20.232537.20Make.20cranelift-codegen-shared.20no_std.html#221548096">(Jan 04 2021 at 16:47)</a>:</h4>
<p>bjorn3 <a href="https://github.com/bytecodealliance/wasmtime/pull/2537#issuecomment-754086160">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/2537">Issue #2537</a>:</p>
<blockquote>
<blockquote>
<p>I would personally recommend for your use case that using std is the way to go.</p>
</blockquote>
<p>That would require forking the standard library.</p>
<blockquote>
<p>The standard library already has targets like wasm itself which return errors for any unsupported operations (like std::thread), and if you're using std then this and other crates (like wasmparser) would just work.</p>
</blockquote>
<p>Honestly that just feels like a hack. It shouldn't be possible to call functions when the kind of action (threads, filesystem, processes) doesn't exist at all on the target. The benefit of the current core, alloc, std split is that you can somewhat guarantee that code only depends on things that they should depend on. If the target doesn't support env vars and cranelift depends on libstd it is very easy to introduce a use of an env var to for example enable debug output. This would then break running cranelift on that target. By having cranelift depend only on core and alloc, this isn't possible.</p>
</blockquote>



<a name="221548174"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20Issue%20%232537%20Make%20cranelift-codegen-shared%20no_std/near/221548174" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20Issue.20.232537.20Make.20cranelift-codegen-shared.20no_std.html#221548174">(Jan 04 2021 at 16:48)</a>:</h4>
<p>tomaka <a href="https://github.com/bytecodealliance/wasmtime/pull/2537#issuecomment-754086352">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/2537">Issue #2537</a>:</p>
<blockquote>
<p>If the objective is for the <code>std</code> to compile for every single platform, how would <code>wasmtime</code> know that a certain feature is <code>unimplemented!</code> or not?</p>
<p>If I'm using <code>wasmtime 0.68</code>, how can I know that <code>wasmtime 0.69</code> or one of its dependencies doesn't sometimes call <code>std::fs::File::open</code>, which is <code>unimplemented!</code> and unimplementable?</p>
<p>When it comes to <code>wasm32-unknown-unknown</code>, which is the one platform right now whose <code>std</code> has <code>unimplemented!()</code> portions, the outcome is that half of the Rust ecosystem uses <code>#[cfg(not(target_os = "unknown")]]</code> and uses Cargo features like <code>wasm-bindgen</code> or <code>stdweb</code> to know what to replace the <code>std</code> with.</p>
</blockquote>



<a name="221548309"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20Issue%20%232537%20Make%20cranelift-codegen-shared%20no_std/near/221548309" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20Issue.20.232537.20Make.20cranelift-codegen-shared.20no_std.html#221548309">(Jan 04 2021 at 16:49)</a>:</h4>
<p>tomaka edited a <a href="https://github.com/bytecodealliance/wasmtime/pull/2537#issuecomment-754086352">comment</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/2537">Issue #2537</a>:</p>
<blockquote>
<p>If the objective is for the <code>std</code> to compile for every single platform, how would <code>wasmtime</code> know that a certain feature is <code>unimplemented!</code> or not?</p>
<p>If I'm using <code>wasmtime 0.68</code>, how can I know that <code>wasmtime 0.69</code> or one of its dependencies doesn't sometimes call <code>std::fs::File::open</code>, which is <code>unimplemented!</code> and unimplementable?</p>
<p>When it comes to <code>wasm32-unknown-unknown</code>, which is the one platform right now whose <code>std</code> has <code>unimplemented!()</code> portions, the outcome is that half of the Rust ecosystem uses <code>#[cfg(not(target_os = "unknown")]]</code> and uses Cargo features like <code>wasm-bindgen</code> or <code>stdweb</code> to know what to replace the <code>std</code> with. Instead of standardizing a list of features available to all crates, putting <code>unimplemented!()</code> causes an "un-standardization", as people replace the <code>std</code> with an alternative.</p>
</blockquote>



<a name="221548319"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20Issue%20%232537%20Make%20cranelift-codegen-shared%20no_std/near/221548319" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20Issue.20.232537.20Make.20cranelift-codegen-shared.20no_std.html#221548319">(Jan 04 2021 at 16:49)</a>:</h4>
<p>tomaka edited a <a href="https://github.com/bytecodealliance/wasmtime/pull/2537#issuecomment-754086352">comment</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/2537">Issue #2537</a>:</p>
<blockquote>
<p>If the objective is for the <code>std</code> to compile for every single platform, how would <code>wasmtime</code> know that a certain feature is <code>unimplemented!</code> or not?</p>
<p>If I'm using <code>wasmtime 0.68</code>, how can I know that <code>wasmtime 0.69</code> or one of its dependencies doesn't sometimes call <code>std::fs::File::open</code>, which is <code>unimplemented!</code> and unimplementable?</p>
<p>When it comes to <code>wasm32-unknown-unknown</code>, which is the one platform right now whose <code>std</code> has <code>unimplemented!()</code> portions, the outcome is that half of the Rust ecosystem uses <code>#[cfg(not(target_os = "unknown")]]</code> and uses Cargo features like <code>wasm-bindgen</code> or <code>stdweb</code> to know what to replace the <code>std</code> with. Instead of standardizing a list of features available to all crates, putting <code>unimplemented!()</code> caused an "un-standardization", as people replace the <code>std</code> with an alternative.</p>
</blockquote>



<a name="221548365"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20Issue%20%232537%20Make%20cranelift-codegen-shared%20no_std/near/221548365" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20Issue.20.232537.20Make.20cranelift-codegen-shared.20no_std.html#221548365">(Jan 04 2021 at 16:49)</a>:</h4>
<p>tomaka edited a <a href="https://github.com/bytecodealliance/wasmtime/pull/2537#issuecomment-754086352">comment</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/2537">Issue #2537</a>:</p>
<blockquote>
<p>If the objective is for the <code>std</code> to compile for every single platform, how would <code>wasmtime</code> know that a certain feature is <code>unimplemented!</code> or not?</p>
<p>If I'm using <code>wasmtime 0.68</code>, how can I know that <code>wasmtime 0.69</code> or one of its dependencies doesn't sometimes call <code>std::fs::File::open</code>, which is <code>unimplemented!</code> and unimplementable?</p>
<p>When it comes to <code>wasm32-unknown-unknown</code>, which is the one widely-used platform right now whose <code>std</code> has <code>unimplemented!()</code> portions, the outcome is that half of the Rust ecosystem uses <code>#[cfg(not(target_os = "unknown")]]</code> and uses Cargo features like <code>wasm-bindgen</code> or <code>stdweb</code> to know what to replace the <code>std</code> with. Instead of standardizing a list of features available to all crates, putting <code>unimplemented!()</code> caused an "un-standardization", as people replace the <code>std</code> with an alternative.</p>
</blockquote>



<a name="221551226"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20Issue%20%232537%20Make%20cranelift-codegen-shared%20no_std/near/221551226" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20Issue.20.232537.20Make.20cranelift-codegen-shared.20no_std.html#221551226">(Jan 04 2021 at 17:09)</a>:</h4>
<p>alexcrichton <a href="https://github.com/bytecodealliance/wasmtime/pull/2537#issuecomment-754098389">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/2537">Issue #2537</a>:</p>
<blockquote>
<p>Call it a hack, call it a fork, the reality is that either libstd compiles for your platform or you force literally all users of your platform to not use <code>std</code>. Not using <code>std</code> has quite a large cost because there's lots of crates that would otherwise work (like this and <code>wasmparser</code>). Additionally not using <code>std</code> is not very idiomatic, weird workarounds, imports, etc, are required to get things compiling. Nothing is guaranteed to work anyway unless you're running on the platforms itself. I do not believe there is an objectively correct answer as to whether you should be able to call a function that always returns an error. @bjorn3 you think you shouldn't be able to do that, I disagree.</p>
<p>I don't know why <code>std</code> <em>wouldn't</em> have the objective of compiling for all platforms. How does <code>wasmtime</code> today know if a feature is unimplemented or not? Someone runs the code and sends a PR to handle their platform if it dooesn't work. You have no guarantee future versions will continue to work, but you never have a guarantee about that unless your target is added to Wasmtime's CI. In no way does using <code>no_std</code> here provide you with any degree of guarantee that things will always work into the future.</p>
<p>Overall I feel there's an imbalance here when a hobbyist's personal project impacts the idioms in a project like Wasmtime. Are all Rust ecosystem crates expected to cater to all hobbyist's whims?</p>
</blockquote>



<a name="221552269"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20Issue%20%232537%20Make%20cranelift-codegen-shared%20no_std/near/221552269" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20Issue.20.232537.20Make.20cranelift-codegen-shared.20no_std.html#221552269">(Jan 04 2021 at 17:17)</a>:</h4>
<p>bjorn3 <a href="https://github.com/bytecodealliance/wasmtime/pull/2537#issuecomment-754102652">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/2537">Issue #2537</a>:</p>
<blockquote>
<blockquote>
<p>Overall I feel there's an imbalance here when a hobbyist's personal project impacts the idioms in a project like Wasmtime.</p>
</blockquote>
<p>Wasmtime interacts a lot with the outside world due to memory mapping, filesystem accesses and terminal accesses. Cranelift on the other hand doesn't interact with the outside world. It only requires a memory allocator because using a large fixed size chunk of memory is inefficient and would complicate code. The Cranelift embedded may or may not interact with the outside world, but Cranelift itself is a observably equivalent to a function from clif ir to bytes. (ignoring OOM's)</p>
</blockquote>



<a name="221552476"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20Issue%20%232537%20Make%20cranelift-codegen-shared%20no_std/near/221552476" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20Issue.20.232537.20Make.20cranelift-codegen-shared.20no_std.html#221552476">(Jan 04 2021 at 17:19)</a>:</h4>
<p>tomaka <a href="https://github.com/bytecodealliance/wasmtime/pull/2537#issuecomment-754103448">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/2537">Issue #2537</a>:</p>
<blockquote>
<blockquote>
<p>Overall I feel there's an imbalance here when a hobbyist's personal project impacts the idioms in a project like Wasmtime. Are all Rust ecosystem crates expected to cater to all hobbyist's whims?</p>
</blockquote>
<p>I mentioned "so feel free to close this PR if it is inappropriate.". I legitimately didn't remember that there was a guideline against small no-std-compatibility PRs.</p>
<blockquote>
<p>all it a hack, call it a fork, the reality is that either libstd compiles for your platform or you force literally all users of your platform to not use std. Not using std has quite a large cost because there's lots of crates that would otherwise work (like this and wasmparser). Additionally not using std is not very idiomatic, weird workarounds, imports, etc, are required to get things compiling.</p>
</blockquote>
<p>I'm of the complete opposite view.</p>
<p>I have personally been some traumatised trying to make <a href="https://github.com/paritytech/polkadot/">a big project</a> work for <code>wasm32-unknown-unknown</code> that I've restarted the codebase from scratch with a strict <code>no_std</code> requirement, because in practice it's what works. Going through the hundreds of direct and indirect dependencies figuring out how they use their <code>wasm-bindgen</code> features and fixing issues because they use features that aren't implemented drove me insane. I have absolutely no intention of doing the same thing for <code>wasmtime</code>.<br>
</p>
</blockquote>



<a name="221552529"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20Issue%20%232537%20Make%20cranelift-codegen-shared%20no_std/near/221552529" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20Issue.20.232537.20Make.20cranelift-codegen-shared.20no_std.html#221552529">(Jan 04 2021 at 17:19)</a>:</h4>
<p>tomaka edited a <a href="https://github.com/bytecodealliance/wasmtime/pull/2537#issuecomment-754103448">comment</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/2537">Issue #2537</a>:</p>
<blockquote>
<blockquote>
<p>Overall I feel there's an imbalance here when a hobbyist's personal project impacts the idioms in a project like Wasmtime. Are all Rust ecosystem crates expected to cater to all hobbyist's whims?</p>
</blockquote>
<p>I mentioned "so feel free to close this PR if it is inappropriate.". I legitimately didn't remember that there was a guideline against small no-std-compatibility PRs.</p>
<blockquote>
<p>all it a hack, call it a fork, the reality is that either libstd compiles for your platform or you force literally all users of your platform to not use std. Not using std has quite a large cost because there's lots of crates that would otherwise work (like this and wasmparser). Additionally not using std is not very idiomatic, weird workarounds, imports, etc, are required to get things compiling.</p>
</blockquote>
<p>I'm of the complete opposite view.</p>
<p>I have personally been somewhat traumatised trying to make <a href="https://github.com/paritytech/polkadot/">a big project</a> work for <code>wasm32-unknown-unknown</code> that I've restarted the codebase from scratch with a strict <code>no_std</code> requirement, because in practice it's what works. Going through the hundreds of direct and indirect dependencies figuring out how they use their <code>wasm-bindgen</code> features and fixing issues because they use features that aren't implemented drove me insane. I have absolutely no intention of doing the same thing for <code>wasmtime</code>.<br>
</p>
</blockquote>



<a name="221552611"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20Issue%20%232537%20Make%20cranelift-codegen-shared%20no_std/near/221552611" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20Issue.20.232537.20Make.20cranelift-codegen-shared.20no_std.html#221552611">(Jan 04 2021 at 17:20)</a>:</h4>
<p>tomaka edited a <a href="https://github.com/bytecodealliance/wasmtime/pull/2537#issuecomment-754103448">comment</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/2537">Issue #2537</a>:</p>
<blockquote>
<blockquote>
<p>Overall I feel there's an imbalance here when a hobbyist's personal project impacts the idioms in a project like Wasmtime. Are all Rust ecosystem crates expected to cater to all hobbyist's whims?</p>
</blockquote>
<p>I mentioned "so feel free to close this PR if it is inappropriate.". I legitimately didn't remember that there was a guideline against small no-std-compatibility PRs.</p>
<blockquote>
<p>all it a hack, call it a fork, the reality is that either libstd compiles for your platform or you force literally all users of your platform to not use std. Not using std has quite a large cost because there's lots of crates that would otherwise work (like this and wasmparser). Additionally not using std is not very idiomatic, weird workarounds, imports, etc, are required to get things compiling.</p>
</blockquote>
<p>I'm of the complete opposite view.</p>
<p>I have personally been somewhat traumatised trying to make <a href="https://github.com/paritytech/polkadot/">a big project</a> work for <code>wasm32-unknown-unknown</code> that I've restarted the codebase from scratch with a strict <code>no_std</code> requirement, because in practice, I cannot stress it enough, it's what works. Going through the hundreds of direct and indirect dependencies figuring out how they use their <code>wasm-bindgen</code> features and fixing issues because they use features that aren't implemented drove me insane. I have absolutely no intention of doing the same thing for <code>wasmtime</code>.<br>
</p>
</blockquote>



<a name="221552662"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20Issue%20%232537%20Make%20cranelift-codegen-shared%20no_std/near/221552662" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20Issue.20.232537.20Make.20cranelift-codegen-shared.20no_std.html#221552662">(Jan 04 2021 at 17:20)</a>:</h4>
<p>tomaka edited a <a href="https://github.com/bytecodealliance/wasmtime/pull/2537#issuecomment-754103448">comment</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/2537">Issue #2537</a>:</p>
<blockquote>
<blockquote>
<p>Overall I feel there's an imbalance here when a hobbyist's personal project impacts the idioms in a project like Wasmtime. Are all Rust ecosystem crates expected to cater to all hobbyist's whims?</p>
</blockquote>
<p>I mentioned "so feel free to close this PR if it is inappropriate.". I legitimately didn't remember that there was a guideline against small no-std-compatibility PRs.</p>
<blockquote>
<p>all it a hack, call it a fork, the reality is that either libstd compiles for your platform or you force literally all users of your platform to not use std. Not using std has quite a large cost because there's lots of crates that would otherwise work (like this and wasmparser). Additionally not using std is not very idiomatic, weird workarounds, imports, etc, are required to get things compiling.</p>
</blockquote>
<p>I'm of the complete opposite view.</p>
<p>I have personally been somewhat traumatised trying to make <a href="https://github.com/paritytech/polkadot/">a big project</a> work for <code>wasm32-unknown-unknown</code> that I've restarted the codebase from scratch with a strict <code>no_std</code> requirement, because in practice, I cannot stress this enough, it's what works. Going through the hundreds of direct and indirect dependencies figuring out how they use their <code>wasm-bindgen</code> features and fixing issues because they use features that aren't implemented drove me insane. I have absolutely no intention of doing the same thing for <code>wasmtime</code>.<br>
</p>
</blockquote>



<a name="221553046"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20Issue%20%232537%20Make%20cranelift-codegen-shared%20no_std/near/221553046" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20Issue.20.232537.20Make.20cranelift-codegen-shared.20no_std.html#221553046">(Jan 04 2021 at 17:23)</a>:</h4>
<p>tomaka <a href="https://github.com/bytecodealliance/wasmtime/pull/2537#issuecomment-754105634">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/2537">Issue #2537</a>:</p>
<blockquote>
<p>To repeat my opinion, as someone who now has a lot of experience in <code>no_std</code> compatibility, forking <code>wasmtime</code> to make it no-std-compatible seems tremendously easier and more sane than writing a custom <code>std</code> implementation full of shim functions.</p>
</blockquote>



<a name="221553137"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20Issue%20%232537%20Make%20cranelift-codegen-shared%20no_std/near/221553137" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20Issue.20.232537.20Make.20cranelift-codegen-shared.20no_std.html#221553137">(Jan 04 2021 at 17:24)</a>:</h4>
<p>tomaka edited a <a href="https://github.com/bytecodealliance/wasmtime/pull/2537#issuecomment-754105634">comment</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/2537">Issue #2537</a>:</p>
<blockquote>
<p>To repeat my opinion, as someone who now has a lot of experience in <code>no_std</code> compatibility, forking <code>wasmtime</code> to make it no-std-compatible (and, I guess, without upstreaming patches) seems tremendously easier and more sane than writing a custom <code>std</code> implementation full of shim functions.</p>
</blockquote>



<a name="221556155"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20Issue%20%232537%20Make%20cranelift-codegen-shared%20no_std/near/221556155" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20Issue.20.232537.20Make.20cranelift-codegen-shared.20no_std.html#221556155">(Jan 04 2021 at 17:46)</a>:</h4>
<p>alexcrichton <a href="https://github.com/bytecodealliance/wasmtime/pull/2537#issuecomment-754117484">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/2537">Issue #2537</a>:</p>
<blockquote>
<p>To be clear, I'm speaking my personal opinions here, I don't represent all contributors to this project. I would recommend you prototype the <code>std</code>-based solution to get an idea for how hard it might be, there's been upstream work to make new targets very easy to add to <code>std</code>. There's also nothing set in stone for how hobbyist targets are handled in libstd, I'm happy to have a conversation about how to best support that if you'd like, but if you'd rather not have such a conversation that's ok too.</p>
</blockquote>



<a name="221557063"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20Issue%20%232537%20Make%20cranelift-codegen-shared%20no_std/near/221557063" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20Issue.20.232537.20Make.20cranelift-codegen-shared.20no_std.html#221557063">(Jan 04 2021 at 17:54)</a>:</h4>
<p>cfallin <a href="https://github.com/bytecodealliance/wasmtime/pull/2537#issuecomment-754121326">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/2537">Issue #2537</a>:</p>
<blockquote>
<p>Speaking only about Cranelift, the effort to make the core compiler crates no_std (and keep them that way) does not seem <em>too</em> bad -- swap/add some <code>use</code> statements and maybe add a CI job to grep for <code>std::</code> in certain directories -- and I'd be happy to review such a thing if others in the project were onboard. (This would need changes in the <code>regalloc</code> crate as well.) I can certainly see the value in having a nice, portable, minimal-dependencies JIT compiler library (as @bjorn3 says, in theory a compiler should need nothing other than memory allocation). I'd defer to others on the rest of Wasmtime; the runtime portability issue seems like a much more difficult question.</p>
</blockquote>



<hr><p>Last updated: Jan 20 2025 at 06:04 UTC</p>
</html>