<html>
<head><meta charset="utf-8"><title>wasmtime / Issue #2493 Directories with more than ~150 fi... · git-wasmtime · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/index.html">git-wasmtime</a></h2>
<h3>Topic: <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20Issue.20.232493.20Directories.20with.20more.20than.20~150.20fi.2E.2E.2E.html">wasmtime / Issue #2493 Directories with more than ~150 fi...</a></h3>

<hr>

<base href="https://bytecodealliance.zulipchat.com">

<head><link href="https://bytecodealliance.github.io/zulip-archive/style.css" rel="stylesheet"></head>

<a name="219361552"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20Issue%20%232493%20Directories%20with%20more%20than%20~150%20fi.../near/219361552" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20Issue.20.232493.20Directories.20with.20more.20than.20~150.20fi.2E.2E.2E.html#219361552">(Dec 09 2020 at 16:32)</a>:</h4>
<p>abbec opened <a href="https://github.com/bytecodealliance/wasmtime/issues/2493">Issue #2493</a>:</p>
<blockquote>
<p>I am using this simple C program to test:</p>
<div class="codehilite" data-code-language="C"><pre><span></span><code><span class="cp">#include</span> <span class="cpf">&lt;dirent.h&gt;</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&lt;stdio.h&gt;</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&lt;errno.h&gt;</span><span class="cp"></span>

<span class="kt">int</span> <span class="nf">main</span><span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="kt">char</span> <span class="o">**</span><span class="n">argv</span><span class="p">)</span> <span class="p">{</span>
  <span class="kt">DIR</span> <span class="o">*</span><span class="n">d</span><span class="p">;</span>

  <span class="kt">char</span> <span class="o">*</span> <span class="n">target</span> <span class="o">=</span> <span class="s">"."</span><span class="p">;</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">argc</span> <span class="o">==</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">target</span> <span class="o">=</span> <span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
  <span class="p">}</span>
  <span class="k">struct</span> <span class="nc">dirent</span> <span class="o">*</span><span class="n">dir</span><span class="p">;</span>
  <span class="n">d</span> <span class="o">=</span> <span class="n">opendir</span><span class="p">(</span><span class="n">target</span><span class="p">);</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">d</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">while</span> <span class="p">((</span><span class="n">dir</span> <span class="o">=</span> <span class="n">readdir</span><span class="p">(</span><span class="n">d</span><span class="p">))</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">printf</span><span class="p">(</span><span class="s">"%s</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">dir</span><span class="o">-&gt;</span><span class="n">d_name</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="n">printf</span><span class="p">(</span><span class="s">"errno: %d</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">errno</span><span class="p">);</span>
    <span class="n">closedir</span><span class="p">(</span><span class="n">d</span><span class="p">);</span>
  <span class="p">}</span>

  <span class="k">return</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div>
<p>I then use this bash script to generate a directory with <code>N</code> files in</p>
<div class="codehilite" data-code-language="Bash"><pre><span></span><code>rm -rf testfolder
mkdir -p testfolder
<span class="k">for</span> n in <span class="k">$(</span>seq <span class="m">1</span> <span class="si">${</span><span class="nv">1</span><span class="k">:-</span><span class="nv">100</span><span class="si">}</span><span class="k">)</span><span class="p">;</span> <span class="k">do</span>
        touch testfolder/<span class="k">$(</span><span class="nb">printf</span> %04d <span class="s2">"</span><span class="nv">$n</span><span class="s2">"</span><span class="k">)</span>
<span class="k">done</span>
</code></pre></div>
<p>This is what happens when I run it</p>
<div class="codehilite" data-code-language="Bash"><pre><span></span><code>$ bash generate-files.sh <span class="m">100</span>

$ ls testfolder/
<span class="m">0001</span>  <span class="m">0005</span>  <span class="m">0009</span>  <span class="m">0013</span>  <span class="m">0017</span>  <span class="m">0021</span>  <span class="m">0025</span>  <span class="m">0029</span>  <span class="m">0033</span>  <span class="m">0037</span>  <span class="m">0041</span>  <span class="m">0045</span>  <span class="m">0049</span>  <span class="m">0053</span>  <span class="m">0057</span>  <span class="m">0061</span>  <span class="m">0065</span>  <span class="m">0069</span>  <span class="m">0073</span>  <span class="m">0077</span>  <span class="m">0081</span>  <span class="m">0085</span>  <span class="m">0089</span>  <span class="m">0093</span>  <span class="m">0097</span>
<span class="m">0002</span>  <span class="m">0006</span>  <span class="m">0010</span>  <span class="m">0014</span>  <span class="m">0018</span>  <span class="m">0022</span>  <span class="m">0026</span>  <span class="m">0030</span>  <span class="m">0034</span>  <span class="m">0038</span>  <span class="m">0042</span>  <span class="m">0046</span>  <span class="m">0050</span>  <span class="m">0054</span>  <span class="m">0058</span>  <span class="m">0062</span>  <span class="m">0066</span>  <span class="m">0070</span>  <span class="m">0074</span>  <span class="m">0078</span>  <span class="m">0082</span>  <span class="m">0086</span>  <span class="m">0090</span>  <span class="m">0094</span>  <span class="m">0098</span>
<span class="m">0003</span>  <span class="m">0007</span>  <span class="m">0011</span>  <span class="m">0015</span>  <span class="m">0019</span>  <span class="m">0023</span>  <span class="m">0027</span>  <span class="m">0031</span>  <span class="m">0035</span>  <span class="m">0039</span>  <span class="m">0043</span>  <span class="m">0047</span>  <span class="m">0051</span>  <span class="m">0055</span>  <span class="m">0059</span>  <span class="m">0063</span>  <span class="m">0067</span>  <span class="m">0071</span>  <span class="m">0075</span>  <span class="m">0079</span>  <span class="m">0083</span>  <span class="m">0087</span>  <span class="m">0091</span>  <span class="m">0095</span>  <span class="m">0099</span>
<span class="m">0004</span>  <span class="m">0008</span>  <span class="m">0012</span>  <span class="m">0016</span>  <span class="m">0020</span>  <span class="m">0024</span>  <span class="m">0028</span>  <span class="m">0032</span>  <span class="m">0036</span>  <span class="m">0040</span>  <span class="m">0044</span>  <span class="m">0048</span>  <span class="m">0052</span>  <span class="m">0056</span>  <span class="m">0060</span>  <span class="m">0064</span>  <span class="m">0068</span>  <span class="m">0072</span>  <span class="m">0076</span>  <span class="m">0080</span>  <span class="m">0084</span>  <span class="m">0088</span>  <span class="m">0092</span>  <span class="m">0096</span>  <span class="m">0100</span>

$ wasmtime run ls.wasm --dir<span class="o">=</span>./testfolder -- testfolder <span class="p">|</span> wc -l
<span class="m">103</span> <span class="c1"># 100 files + "." ".." and the "errno" print</span>

$ bash generate-files.sh <span class="m">200</span>

$ wasmtime run ls.wasm --dir<span class="o">=</span>./testfolder -- testfolder <span class="p">|</span> wc -l
<span class="m">147</span> <span class="c1"># lots of files missing</span>

<span class="c1"># for example 0012</span>
$ wasmtime run ls.wasm --dir<span class="o">=</span>./testfolder -- testfolder <span class="p">|</span> grep <span class="m">0012</span>

$ wasmtime run ls.wasm --dir<span class="o">=</span>./testfolder -- testfolder <span class="p">|</span> grep <span class="m">0011</span>
<span class="m">0011</span>
</code></pre></div>
<p>Running wasmer on the same input works as expected:</p>
<div class="codehilite" data-code-language="Bash"><pre><span></span><code>$ ~/.wasmer/bin/wasmer run ls.wasm --dir<span class="o">=</span>./testfolder -- testfolder <span class="p">|</span> wc -l
<span class="m">201</span> <span class="c1"># wasmer does not return "." and ".."</span>

$ ~/.wasmer/bin/wasmer run ls.wasm --dir<span class="o">=</span>./testfolder -- testfolder <span class="p">|</span> grep <span class="m">0012</span>
<span class="m">0012</span>
</code></pre></div>
<h1>Expected Behavior</h1>
<p>Calls to <code>readdir</code> returns all directory entries, even for folders with more than 150 files.<br>
</p>
</blockquote>



<a name="219361553"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20Issue%20%232493%20Directories%20with%20more%20than%20~150%20fi.../near/219361553" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20Issue.20.232493.20Directories.20with.20more.20than.20~150.20fi.2E.2E.2E.html#219361553">(Dec 09 2020 at 16:32)</a>:</h4>
<p>abbec labeled <a href="https://github.com/bytecodealliance/wasmtime/issues/2493">Issue #2493</a>:</p>
<blockquote>
<p>I am using this simple C program to test:</p>
<div class="codehilite" data-code-language="C"><pre><span></span><code><span class="cp">#include</span> <span class="cpf">&lt;dirent.h&gt;</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&lt;stdio.h&gt;</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&lt;errno.h&gt;</span><span class="cp"></span>

<span class="kt">int</span> <span class="nf">main</span><span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="kt">char</span> <span class="o">**</span><span class="n">argv</span><span class="p">)</span> <span class="p">{</span>
  <span class="kt">DIR</span> <span class="o">*</span><span class="n">d</span><span class="p">;</span>

  <span class="kt">char</span> <span class="o">*</span> <span class="n">target</span> <span class="o">=</span> <span class="s">"."</span><span class="p">;</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">argc</span> <span class="o">==</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">target</span> <span class="o">=</span> <span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
  <span class="p">}</span>
  <span class="k">struct</span> <span class="nc">dirent</span> <span class="o">*</span><span class="n">dir</span><span class="p">;</span>
  <span class="n">d</span> <span class="o">=</span> <span class="n">opendir</span><span class="p">(</span><span class="n">target</span><span class="p">);</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">d</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">while</span> <span class="p">((</span><span class="n">dir</span> <span class="o">=</span> <span class="n">readdir</span><span class="p">(</span><span class="n">d</span><span class="p">))</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">printf</span><span class="p">(</span><span class="s">"%s</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">dir</span><span class="o">-&gt;</span><span class="n">d_name</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="n">printf</span><span class="p">(</span><span class="s">"errno: %d</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">errno</span><span class="p">);</span>
    <span class="n">closedir</span><span class="p">(</span><span class="n">d</span><span class="p">);</span>
  <span class="p">}</span>

  <span class="k">return</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div>
<p>I then use this bash script to generate a directory with <code>N</code> files in</p>
<div class="codehilite" data-code-language="Bash"><pre><span></span><code>rm -rf testfolder
mkdir -p testfolder
<span class="k">for</span> n in <span class="k">$(</span>seq <span class="m">1</span> <span class="si">${</span><span class="nv">1</span><span class="k">:-</span><span class="nv">100</span><span class="si">}</span><span class="k">)</span><span class="p">;</span> <span class="k">do</span>
        touch testfolder/<span class="k">$(</span><span class="nb">printf</span> %04d <span class="s2">"</span><span class="nv">$n</span><span class="s2">"</span><span class="k">)</span>
<span class="k">done</span>
</code></pre></div>
<p>This is what happens when I run it</p>
<div class="codehilite" data-code-language="Bash"><pre><span></span><code>$ bash generate-files.sh <span class="m">100</span>

$ ls testfolder/
<span class="m">0001</span>  <span class="m">0005</span>  <span class="m">0009</span>  <span class="m">0013</span>  <span class="m">0017</span>  <span class="m">0021</span>  <span class="m">0025</span>  <span class="m">0029</span>  <span class="m">0033</span>  <span class="m">0037</span>  <span class="m">0041</span>  <span class="m">0045</span>  <span class="m">0049</span>  <span class="m">0053</span>  <span class="m">0057</span>  <span class="m">0061</span>  <span class="m">0065</span>  <span class="m">0069</span>  <span class="m">0073</span>  <span class="m">0077</span>  <span class="m">0081</span>  <span class="m">0085</span>  <span class="m">0089</span>  <span class="m">0093</span>  <span class="m">0097</span>
<span class="m">0002</span>  <span class="m">0006</span>  <span class="m">0010</span>  <span class="m">0014</span>  <span class="m">0018</span>  <span class="m">0022</span>  <span class="m">0026</span>  <span class="m">0030</span>  <span class="m">0034</span>  <span class="m">0038</span>  <span class="m">0042</span>  <span class="m">0046</span>  <span class="m">0050</span>  <span class="m">0054</span>  <span class="m">0058</span>  <span class="m">0062</span>  <span class="m">0066</span>  <span class="m">0070</span>  <span class="m">0074</span>  <span class="m">0078</span>  <span class="m">0082</span>  <span class="m">0086</span>  <span class="m">0090</span>  <span class="m">0094</span>  <span class="m">0098</span>
<span class="m">0003</span>  <span class="m">0007</span>  <span class="m">0011</span>  <span class="m">0015</span>  <span class="m">0019</span>  <span class="m">0023</span>  <span class="m">0027</span>  <span class="m">0031</span>  <span class="m">0035</span>  <span class="m">0039</span>  <span class="m">0043</span>  <span class="m">0047</span>  <span class="m">0051</span>  <span class="m">0055</span>  <span class="m">0059</span>  <span class="m">0063</span>  <span class="m">0067</span>  <span class="m">0071</span>  <span class="m">0075</span>  <span class="m">0079</span>  <span class="m">0083</span>  <span class="m">0087</span>  <span class="m">0091</span>  <span class="m">0095</span>  <span class="m">0099</span>
<span class="m">0004</span>  <span class="m">0008</span>  <span class="m">0012</span>  <span class="m">0016</span>  <span class="m">0020</span>  <span class="m">0024</span>  <span class="m">0028</span>  <span class="m">0032</span>  <span class="m">0036</span>  <span class="m">0040</span>  <span class="m">0044</span>  <span class="m">0048</span>  <span class="m">0052</span>  <span class="m">0056</span>  <span class="m">0060</span>  <span class="m">0064</span>  <span class="m">0068</span>  <span class="m">0072</span>  <span class="m">0076</span>  <span class="m">0080</span>  <span class="m">0084</span>  <span class="m">0088</span>  <span class="m">0092</span>  <span class="m">0096</span>  <span class="m">0100</span>

$ wasmtime run ls.wasm --dir<span class="o">=</span>./testfolder -- testfolder <span class="p">|</span> wc -l
<span class="m">103</span> <span class="c1"># 100 files + "." ".." and the "errno" print</span>

$ bash generate-files.sh <span class="m">200</span>

$ wasmtime run ls.wasm --dir<span class="o">=</span>./testfolder -- testfolder <span class="p">|</span> wc -l
<span class="m">147</span> <span class="c1"># lots of files missing</span>

<span class="c1"># for example 0012</span>
$ wasmtime run ls.wasm --dir<span class="o">=</span>./testfolder -- testfolder <span class="p">|</span> grep <span class="m">0012</span>

$ wasmtime run ls.wasm --dir<span class="o">=</span>./testfolder -- testfolder <span class="p">|</span> grep <span class="m">0011</span>
<span class="m">0011</span>
</code></pre></div>
<p>Running wasmer on the same input works as expected:</p>
<div class="codehilite" data-code-language="Bash"><pre><span></span><code>$ ~/.wasmer/bin/wasmer run ls.wasm --dir<span class="o">=</span>./testfolder -- testfolder <span class="p">|</span> wc -l
<span class="m">201</span> <span class="c1"># wasmer does not return "." and ".."</span>

$ ~/.wasmer/bin/wasmer run ls.wasm --dir<span class="o">=</span>./testfolder -- testfolder <span class="p">|</span> grep <span class="m">0012</span>
<span class="m">0012</span>
</code></pre></div>
<h1>Expected Behavior</h1>
<p>Calls to <code>readdir</code> returns all directory entries, even for folders with more than 150 files.<br>
</p>
</blockquote>



<a name="219361777"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20Issue%20%232493%20Directories%20with%20more%20than%20~150%20fi.../near/219361777" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20Issue.20.232493.20Directories.20with.20more.20than.20~150.20fi.2E.2E.2E.html#219361777">(Dec 09 2020 at 16:34)</a>:</h4>
<p>abbec edited <a href="https://github.com/bytecodealliance/wasmtime/issues/2493">Issue #2493</a>:</p>
<blockquote>
<p>I am using this simple C program to test:</p>
<div class="codehilite" data-code-language="C"><pre><span></span><code><span class="cp">#include</span> <span class="cpf">&lt;dirent.h&gt;</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&lt;stdio.h&gt;</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&lt;errno.h&gt;</span><span class="cp"></span>

<span class="kt">int</span> <span class="nf">main</span><span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="kt">char</span> <span class="o">**</span><span class="n">argv</span><span class="p">)</span> <span class="p">{</span>
  <span class="kt">DIR</span> <span class="o">*</span><span class="n">d</span><span class="p">;</span>

  <span class="kt">char</span> <span class="o">*</span> <span class="n">target</span> <span class="o">=</span> <span class="s">"."</span><span class="p">;</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">argc</span> <span class="o">==</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">target</span> <span class="o">=</span> <span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
  <span class="p">}</span>
  <span class="k">struct</span> <span class="nc">dirent</span> <span class="o">*</span><span class="n">dir</span><span class="p">;</span>
  <span class="n">d</span> <span class="o">=</span> <span class="n">opendir</span><span class="p">(</span><span class="n">target</span><span class="p">);</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">d</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">while</span> <span class="p">((</span><span class="n">dir</span> <span class="o">=</span> <span class="n">readdir</span><span class="p">(</span><span class="n">d</span><span class="p">))</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">printf</span><span class="p">(</span><span class="s">"%s</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">dir</span><span class="o">-&gt;</span><span class="n">d_name</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="n">printf</span><span class="p">(</span><span class="s">"errno: %d</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">errno</span><span class="p">);</span>
    <span class="n">closedir</span><span class="p">(</span><span class="n">d</span><span class="p">);</span>
  <span class="p">}</span>

  <span class="k">return</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div>
<p>I then use this bash script to generate a directory with <code>N</code> files in</p>
<div class="codehilite" data-code-language="Bash"><pre><span></span><code>rm -rf testfolder
mkdir -p testfolder
<span class="k">for</span> n in <span class="k">$(</span>seq <span class="m">1</span> <span class="si">${</span><span class="nv">1</span><span class="k">:-</span><span class="nv">100</span><span class="si">}</span><span class="k">)</span><span class="p">;</span> <span class="k">do</span>
        touch testfolder/<span class="k">$(</span><span class="nb">printf</span> %04d <span class="s2">"</span><span class="nv">$n</span><span class="s2">"</span><span class="k">)</span>
<span class="k">done</span>
</code></pre></div>
<p>This is what happens when I run it</p>
<div class="codehilite" data-code-language="Bash"><pre><span></span><code>$ bash generate-files.sh <span class="m">100</span>

$ ls testfolder/
<span class="m">0001</span>  <span class="m">0005</span>  <span class="m">0009</span>  <span class="m">0013</span>  <span class="m">0017</span>  <span class="m">0021</span>  <span class="m">0025</span>  <span class="m">0029</span>  <span class="m">0033</span>  <span class="m">0037</span>  <span class="m">0041</span>  <span class="m">0045</span>  <span class="m">0049</span>  <span class="m">0053</span>  <span class="m">0057</span>  <span class="m">0061</span>  <span class="m">0065</span>  <span class="m">0069</span>  <span class="m">0073</span>  <span class="m">0077</span>  <span class="m">0081</span>  <span class="m">0085</span>  <span class="m">0089</span>  <span class="m">0093</span>  <span class="m">0097</span>
<span class="m">0002</span>  <span class="m">0006</span>  <span class="m">0010</span>  <span class="m">0014</span>  <span class="m">0018</span>  <span class="m">0022</span>  <span class="m">0026</span>  <span class="m">0030</span>  <span class="m">0034</span>  <span class="m">0038</span>  <span class="m">0042</span>  <span class="m">0046</span>  <span class="m">0050</span>  <span class="m">0054</span>  <span class="m">0058</span>  <span class="m">0062</span>  <span class="m">0066</span>  <span class="m">0070</span>  <span class="m">0074</span>  <span class="m">0078</span>  <span class="m">0082</span>  <span class="m">0086</span>  <span class="m">0090</span>  <span class="m">0094</span>  <span class="m">0098</span>
<span class="m">0003</span>  <span class="m">0007</span>  <span class="m">0011</span>  <span class="m">0015</span>  <span class="m">0019</span>  <span class="m">0023</span>  <span class="m">0027</span>  <span class="m">0031</span>  <span class="m">0035</span>  <span class="m">0039</span>  <span class="m">0043</span>  <span class="m">0047</span>  <span class="m">0051</span>  <span class="m">0055</span>  <span class="m">0059</span>  <span class="m">0063</span>  <span class="m">0067</span>  <span class="m">0071</span>  <span class="m">0075</span>  <span class="m">0079</span>  <span class="m">0083</span>  <span class="m">0087</span>  <span class="m">0091</span>  <span class="m">0095</span>  <span class="m">0099</span>
<span class="m">0004</span>  <span class="m">0008</span>  <span class="m">0012</span>  <span class="m">0016</span>  <span class="m">0020</span>  <span class="m">0024</span>  <span class="m">0028</span>  <span class="m">0032</span>  <span class="m">0036</span>  <span class="m">0040</span>  <span class="m">0044</span>  <span class="m">0048</span>  <span class="m">0052</span>  <span class="m">0056</span>  <span class="m">0060</span>  <span class="m">0064</span>  <span class="m">0068</span>  <span class="m">0072</span>  <span class="m">0076</span>  <span class="m">0080</span>  <span class="m">0084</span>  <span class="m">0088</span>  <span class="m">0092</span>  <span class="m">0096</span>  <span class="m">0100</span>

$ wasmtime run ls.wasm --dir<span class="o">=</span>./testfolder -- testfolder <span class="p">|</span> wc -l
<span class="m">103</span> <span class="c1"># 100 files + "." ".." and the "errno" print</span>

$ bash generate-files.sh <span class="m">200</span>

$ wasmtime run ls.wasm --dir<span class="o">=</span>./testfolder -- testfolder <span class="p">|</span> wc -l
<span class="m">147</span> <span class="c1"># lots of files missing</span>

<span class="c1"># for example 0012</span>
$ wasmtime run ls.wasm --dir<span class="o">=</span>./testfolder -- testfolder <span class="p">|</span> grep <span class="m">0012</span>

$ wasmtime run ls.wasm --dir<span class="o">=</span>./testfolder -- testfolder <span class="p">|</span> grep <span class="m">0011</span>
<span class="m">0011</span>
</code></pre></div>
<p>Running wasmer on the same input works as expected:</p>
<div class="codehilite" data-code-language="Bash"><pre><span></span><code>$ ~/.wasmer/bin/wasmer run ls.wasm --dir<span class="o">=</span>./testfolder -- testfolder <span class="p">|</span> wc -l
<span class="m">201</span> <span class="c1"># wasmer does not return "." and ".."</span>

$ ~/.wasmer/bin/wasmer run ls.wasm --dir<span class="o">=</span>./testfolder -- testfolder <span class="p">|</span> grep <span class="m">0012</span>
<span class="m">0012</span>
</code></pre></div>
<h1>Expected Behavior</h1>
<p>Calls to <code>readdir</code> returns all directory entries, even for folders with more than ~150 files.<br>
</p>
</blockquote>



<a name="219363515"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20Issue%20%232493%20Directories%20with%20more%20than%20~150%20fi.../near/219363515" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20Issue.20.232493.20Directories.20with.20more.20than.20~150.20fi.2E.2E.2E.html#219363515">(Dec 09 2020 at 16:46)</a>:</h4>
<p>abbec <a href="https://github.com/bytecodealliance/wasmtime/issues/2493#issuecomment-741898192">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/2493">Issue #2493</a>:</p>
<blockquote>
<p>Tested wasmtime versions are 0.19 and 0.21 (both with the same result)</p>
</blockquote>



<a name="219383730"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20Issue%20%232493%20Directories%20with%20more%20than%20~150%20fi.../near/219383730" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20Issue.20.232493.20Directories.20with.20more.20than.20~150.20fi.2E.2E.2E.html#219383730">(Dec 09 2020 at 19:13)</a>:</h4>
<p>pchickey assigned <a href="https://github.com/bytecodealliance/wasmtime/issues/2493">Issue #2493</a>:</p>
<blockquote>
<p>I am using this simple C program to test:</p>
<div class="codehilite" data-code-language="C"><pre><span></span><code><span class="cp">#include</span> <span class="cpf">&lt;dirent.h&gt;</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&lt;stdio.h&gt;</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&lt;errno.h&gt;</span><span class="cp"></span>

<span class="kt">int</span> <span class="nf">main</span><span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="kt">char</span> <span class="o">**</span><span class="n">argv</span><span class="p">)</span> <span class="p">{</span>
  <span class="kt">DIR</span> <span class="o">*</span><span class="n">d</span><span class="p">;</span>

  <span class="kt">char</span> <span class="o">*</span> <span class="n">target</span> <span class="o">=</span> <span class="s">"."</span><span class="p">;</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">argc</span> <span class="o">==</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">target</span> <span class="o">=</span> <span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
  <span class="p">}</span>
  <span class="k">struct</span> <span class="nc">dirent</span> <span class="o">*</span><span class="n">dir</span><span class="p">;</span>
  <span class="n">d</span> <span class="o">=</span> <span class="n">opendir</span><span class="p">(</span><span class="n">target</span><span class="p">);</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">d</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">while</span> <span class="p">((</span><span class="n">dir</span> <span class="o">=</span> <span class="n">readdir</span><span class="p">(</span><span class="n">d</span><span class="p">))</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">printf</span><span class="p">(</span><span class="s">"%s</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">dir</span><span class="o">-&gt;</span><span class="n">d_name</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="n">printf</span><span class="p">(</span><span class="s">"errno: %d</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">errno</span><span class="p">);</span>
    <span class="n">closedir</span><span class="p">(</span><span class="n">d</span><span class="p">);</span>
  <span class="p">}</span>

  <span class="k">return</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div>
<p>I then use this bash script to generate a directory with <code>N</code> files in</p>
<div class="codehilite" data-code-language="Bash"><pre><span></span><code>rm -rf testfolder
mkdir -p testfolder
<span class="k">for</span> n in <span class="k">$(</span>seq <span class="m">1</span> <span class="si">${</span><span class="nv">1</span><span class="k">:-</span><span class="nv">100</span><span class="si">}</span><span class="k">)</span><span class="p">;</span> <span class="k">do</span>
        touch testfolder/<span class="k">$(</span><span class="nb">printf</span> %04d <span class="s2">"</span><span class="nv">$n</span><span class="s2">"</span><span class="k">)</span>
<span class="k">done</span>
</code></pre></div>
<p>This is what happens when I run it</p>
<div class="codehilite" data-code-language="Bash"><pre><span></span><code>$ bash generate-files.sh <span class="m">100</span>

$ ls testfolder/
<span class="m">0001</span>  <span class="m">0005</span>  <span class="m">0009</span>  <span class="m">0013</span>  <span class="m">0017</span>  <span class="m">0021</span>  <span class="m">0025</span>  <span class="m">0029</span>  <span class="m">0033</span>  <span class="m">0037</span>  <span class="m">0041</span>  <span class="m">0045</span>  <span class="m">0049</span>  <span class="m">0053</span>  <span class="m">0057</span>  <span class="m">0061</span>  <span class="m">0065</span>  <span class="m">0069</span>  <span class="m">0073</span>  <span class="m">0077</span>  <span class="m">0081</span>  <span class="m">0085</span>  <span class="m">0089</span>  <span class="m">0093</span>  <span class="m">0097</span>
<span class="m">0002</span>  <span class="m">0006</span>  <span class="m">0010</span>  <span class="m">0014</span>  <span class="m">0018</span>  <span class="m">0022</span>  <span class="m">0026</span>  <span class="m">0030</span>  <span class="m">0034</span>  <span class="m">0038</span>  <span class="m">0042</span>  <span class="m">0046</span>  <span class="m">0050</span>  <span class="m">0054</span>  <span class="m">0058</span>  <span class="m">0062</span>  <span class="m">0066</span>  <span class="m">0070</span>  <span class="m">0074</span>  <span class="m">0078</span>  <span class="m">0082</span>  <span class="m">0086</span>  <span class="m">0090</span>  <span class="m">0094</span>  <span class="m">0098</span>
<span class="m">0003</span>  <span class="m">0007</span>  <span class="m">0011</span>  <span class="m">0015</span>  <span class="m">0019</span>  <span class="m">0023</span>  <span class="m">0027</span>  <span class="m">0031</span>  <span class="m">0035</span>  <span class="m">0039</span>  <span class="m">0043</span>  <span class="m">0047</span>  <span class="m">0051</span>  <span class="m">0055</span>  <span class="m">0059</span>  <span class="m">0063</span>  <span class="m">0067</span>  <span class="m">0071</span>  <span class="m">0075</span>  <span class="m">0079</span>  <span class="m">0083</span>  <span class="m">0087</span>  <span class="m">0091</span>  <span class="m">0095</span>  <span class="m">0099</span>
<span class="m">0004</span>  <span class="m">0008</span>  <span class="m">0012</span>  <span class="m">0016</span>  <span class="m">0020</span>  <span class="m">0024</span>  <span class="m">0028</span>  <span class="m">0032</span>  <span class="m">0036</span>  <span class="m">0040</span>  <span class="m">0044</span>  <span class="m">0048</span>  <span class="m">0052</span>  <span class="m">0056</span>  <span class="m">0060</span>  <span class="m">0064</span>  <span class="m">0068</span>  <span class="m">0072</span>  <span class="m">0076</span>  <span class="m">0080</span>  <span class="m">0084</span>  <span class="m">0088</span>  <span class="m">0092</span>  <span class="m">0096</span>  <span class="m">0100</span>

$ wasmtime run ls.wasm --dir<span class="o">=</span>./testfolder -- testfolder <span class="p">|</span> wc -l
<span class="m">103</span> <span class="c1"># 100 files + "." ".." and the "errno" print</span>

$ bash generate-files.sh <span class="m">200</span>

$ wasmtime run ls.wasm --dir<span class="o">=</span>./testfolder -- testfolder <span class="p">|</span> wc -l
<span class="m">147</span> <span class="c1"># lots of files missing</span>

<span class="c1"># for example 0012</span>
$ wasmtime run ls.wasm --dir<span class="o">=</span>./testfolder -- testfolder <span class="p">|</span> grep <span class="m">0012</span>

$ wasmtime run ls.wasm --dir<span class="o">=</span>./testfolder -- testfolder <span class="p">|</span> grep <span class="m">0011</span>
<span class="m">0011</span>
</code></pre></div>
<p>Running wasmer on the same input works as expected:</p>
<div class="codehilite" data-code-language="Bash"><pre><span></span><code>$ ~/.wasmer/bin/wasmer run ls.wasm --dir<span class="o">=</span>./testfolder -- testfolder <span class="p">|</span> wc -l
<span class="m">201</span> <span class="c1"># wasmer does not return "." and ".."</span>

$ ~/.wasmer/bin/wasmer run ls.wasm --dir<span class="o">=</span>./testfolder -- testfolder <span class="p">|</span> grep <span class="m">0012</span>
<span class="m">0012</span>
</code></pre></div>
<h1>Expected Behavior</h1>
<p>Calls to <code>readdir</code> returns all directory entries, even for folders with more than ~150 files.<br>
</p>
</blockquote>



<a name="219386238"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20Issue%20%232493%20Directories%20with%20more%20than%20~150%20fi.../near/219386238" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20Issue.20.232493.20Directories.20with.20more.20than.20~150.20fi.2E.2E.2E.html#219386238">(Dec 09 2020 at 19:32)</a>:</h4>
<p>pchickey <a href="https://github.com/bytecodealliance/wasmtime/issues/2493#issuecomment-741998937">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/2493">Issue #2493</a>:</p>
<blockquote>
<p>What toolchain and libc did you compile the example with?</p>
<p>When I compiled with wasi-sdk 12, I was unable to reproduce.<br>
<a href="https://github.com/bytecodealliance/wasmtime/files/5668210/issue2493.zip">issue2493.zip</a></p>
</blockquote>



<a name="219386470"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20Issue%20%232493%20Directories%20with%20more%20than%20~150%20fi.../near/219386470" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20Issue.20.232493.20Directories.20with.20more.20than.20~150.20fi.2E.2E.2E.html#219386470">(Dec 09 2020 at 19:33)</a>:</h4>
<p>pchickey deleted a <a href="https://github.com/bytecodealliance/wasmtime/issues/2493#issuecomment-741998937">comment</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/2493">Issue #2493</a>:</p>
<blockquote>
<p>What toolchain and libc did you compile the example with?</p>
<p>When I compiled with wasi-sdk 12, I was unable to reproduce.<br>
<a href="https://github.com/bytecodealliance/wasmtime/files/5668210/issue2493.zip">issue2493.zip</a></p>
</blockquote>



<a name="219386691"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20Issue%20%232493%20Directories%20with%20more%20than%20~150%20fi.../near/219386691" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20Issue.20.232493.20Directories.20with.20more.20than.20~150.20fi.2E.2E.2E.html#219386691">(Dec 09 2020 at 19:34)</a>:</h4>
<p>pchickey <a href="https://github.com/bytecodealliance/wasmtime/issues/2493#issuecomment-742000470">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/2493">Issue #2493</a>:</p>
<blockquote>
<p>I was able to reproduce, this is a wasi-common bug</p>
</blockquote>



<a name="219388993"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20Issue%20%232493%20Directories%20with%20more%20than%20~150%20fi.../near/219388993" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20Issue.20.232493.20Directories.20with.20more.20than.20~150.20fi.2E.2E.2E.html#219388993">(Dec 09 2020 at 19:52)</a>:</h4>
<p>pchickey labeled <a href="https://github.com/bytecodealliance/wasmtime/issues/2493">Issue #2493</a> (assigned to pchickey):</p>
<blockquote>
<p>I am using this simple C program to test:</p>
<div class="codehilite" data-code-language="C"><pre><span></span><code><span class="cp">#include</span> <span class="cpf">&lt;dirent.h&gt;</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&lt;stdio.h&gt;</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&lt;errno.h&gt;</span><span class="cp"></span>

<span class="kt">int</span> <span class="nf">main</span><span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="kt">char</span> <span class="o">**</span><span class="n">argv</span><span class="p">)</span> <span class="p">{</span>
  <span class="kt">DIR</span> <span class="o">*</span><span class="n">d</span><span class="p">;</span>

  <span class="kt">char</span> <span class="o">*</span> <span class="n">target</span> <span class="o">=</span> <span class="s">"."</span><span class="p">;</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">argc</span> <span class="o">==</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">target</span> <span class="o">=</span> <span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
  <span class="p">}</span>
  <span class="k">struct</span> <span class="nc">dirent</span> <span class="o">*</span><span class="n">dir</span><span class="p">;</span>
  <span class="n">d</span> <span class="o">=</span> <span class="n">opendir</span><span class="p">(</span><span class="n">target</span><span class="p">);</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">d</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">while</span> <span class="p">((</span><span class="n">dir</span> <span class="o">=</span> <span class="n">readdir</span><span class="p">(</span><span class="n">d</span><span class="p">))</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">printf</span><span class="p">(</span><span class="s">"%s</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">dir</span><span class="o">-&gt;</span><span class="n">d_name</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="n">printf</span><span class="p">(</span><span class="s">"errno: %d</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">errno</span><span class="p">);</span>
    <span class="n">closedir</span><span class="p">(</span><span class="n">d</span><span class="p">);</span>
  <span class="p">}</span>

  <span class="k">return</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div>
<p>I then use this bash script to generate a directory with <code>N</code> files in</p>
<div class="codehilite" data-code-language="Bash"><pre><span></span><code>rm -rf testfolder
mkdir -p testfolder
<span class="k">for</span> n in <span class="k">$(</span>seq <span class="m">1</span> <span class="si">${</span><span class="nv">1</span><span class="k">:-</span><span class="nv">100</span><span class="si">}</span><span class="k">)</span><span class="p">;</span> <span class="k">do</span>
        touch testfolder/<span class="k">$(</span><span class="nb">printf</span> %04d <span class="s2">"</span><span class="nv">$n</span><span class="s2">"</span><span class="k">)</span>
<span class="k">done</span>
</code></pre></div>
<p>This is what happens when I run it</p>
<div class="codehilite" data-code-language="Bash"><pre><span></span><code>$ bash generate-files.sh <span class="m">100</span>

$ ls testfolder/
<span class="m">0001</span>  <span class="m">0005</span>  <span class="m">0009</span>  <span class="m">0013</span>  <span class="m">0017</span>  <span class="m">0021</span>  <span class="m">0025</span>  <span class="m">0029</span>  <span class="m">0033</span>  <span class="m">0037</span>  <span class="m">0041</span>  <span class="m">0045</span>  <span class="m">0049</span>  <span class="m">0053</span>  <span class="m">0057</span>  <span class="m">0061</span>  <span class="m">0065</span>  <span class="m">0069</span>  <span class="m">0073</span>  <span class="m">0077</span>  <span class="m">0081</span>  <span class="m">0085</span>  <span class="m">0089</span>  <span class="m">0093</span>  <span class="m">0097</span>
<span class="m">0002</span>  <span class="m">0006</span>  <span class="m">0010</span>  <span class="m">0014</span>  <span class="m">0018</span>  <span class="m">0022</span>  <span class="m">0026</span>  <span class="m">0030</span>  <span class="m">0034</span>  <span class="m">0038</span>  <span class="m">0042</span>  <span class="m">0046</span>  <span class="m">0050</span>  <span class="m">0054</span>  <span class="m">0058</span>  <span class="m">0062</span>  <span class="m">0066</span>  <span class="m">0070</span>  <span class="m">0074</span>  <span class="m">0078</span>  <span class="m">0082</span>  <span class="m">0086</span>  <span class="m">0090</span>  <span class="m">0094</span>  <span class="m">0098</span>
<span class="m">0003</span>  <span class="m">0007</span>  <span class="m">0011</span>  <span class="m">0015</span>  <span class="m">0019</span>  <span class="m">0023</span>  <span class="m">0027</span>  <span class="m">0031</span>  <span class="m">0035</span>  <span class="m">0039</span>  <span class="m">0043</span>  <span class="m">0047</span>  <span class="m">0051</span>  <span class="m">0055</span>  <span class="m">0059</span>  <span class="m">0063</span>  <span class="m">0067</span>  <span class="m">0071</span>  <span class="m">0075</span>  <span class="m">0079</span>  <span class="m">0083</span>  <span class="m">0087</span>  <span class="m">0091</span>  <span class="m">0095</span>  <span class="m">0099</span>
<span class="m">0004</span>  <span class="m">0008</span>  <span class="m">0012</span>  <span class="m">0016</span>  <span class="m">0020</span>  <span class="m">0024</span>  <span class="m">0028</span>  <span class="m">0032</span>  <span class="m">0036</span>  <span class="m">0040</span>  <span class="m">0044</span>  <span class="m">0048</span>  <span class="m">0052</span>  <span class="m">0056</span>  <span class="m">0060</span>  <span class="m">0064</span>  <span class="m">0068</span>  <span class="m">0072</span>  <span class="m">0076</span>  <span class="m">0080</span>  <span class="m">0084</span>  <span class="m">0088</span>  <span class="m">0092</span>  <span class="m">0096</span>  <span class="m">0100</span>

$ wasmtime run ls.wasm --dir<span class="o">=</span>./testfolder -- testfolder <span class="p">|</span> wc -l
<span class="m">103</span> <span class="c1"># 100 files + "." ".." and the "errno" print</span>

$ bash generate-files.sh <span class="m">200</span>

$ wasmtime run ls.wasm --dir<span class="o">=</span>./testfolder -- testfolder <span class="p">|</span> wc -l
<span class="m">147</span> <span class="c1"># lots of files missing</span>

<span class="c1"># for example 0012</span>
$ wasmtime run ls.wasm --dir<span class="o">=</span>./testfolder -- testfolder <span class="p">|</span> grep <span class="m">0012</span>

$ wasmtime run ls.wasm --dir<span class="o">=</span>./testfolder -- testfolder <span class="p">|</span> grep <span class="m">0011</span>
<span class="m">0011</span>
</code></pre></div>
<p>Running wasmer on the same input works as expected:</p>
<div class="codehilite" data-code-language="Bash"><pre><span></span><code>$ ~/.wasmer/bin/wasmer run ls.wasm --dir<span class="o">=</span>./testfolder -- testfolder <span class="p">|</span> wc -l
<span class="m">201</span> <span class="c1"># wasmer does not return "." and ".."</span>

$ ~/.wasmer/bin/wasmer run ls.wasm --dir<span class="o">=</span>./testfolder -- testfolder <span class="p">|</span> grep <span class="m">0012</span>
<span class="m">0012</span>
</code></pre></div>
<h1>Expected Behavior</h1>
<p>Calls to <code>readdir</code> returns all directory entries, even for folders with more than ~150 files.<br>
</p>
</blockquote>



<a name="219434498"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20Issue%20%232493%20Directories%20with%20more%20than%20~150%20fi.../near/219434498" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20Issue.20.232493.20Directories.20with.20more.20than.20~150.20fi.2E.2E.2E.html#219434498">(Dec 10 2020 at 05:48)</a>:</h4>
<p>sunfishcode <a href="https://github.com/bytecodealliance/wasmtime/issues/2493#issuecomment-742256706">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/2493">Issue #2493</a>:</p>
<blockquote>
<p>Me too. #2494 is a fix for this.</p>
</blockquote>



<a name="219435797"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20Issue%20%232493%20Directories%20with%20more%20than%20~150%20fi.../near/219435797" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20Issue.20.232493.20Directories.20with.20more.20than.20~150.20fi.2E.2E.2E.html#219435797">(Dec 10 2020 at 06:18)</a>:</h4>
<p>abbec <a href="https://github.com/bytecodealliance/wasmtime/issues/2493#issuecomment-742268347">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/2493">Issue #2493</a>:</p>
<blockquote>
<p>Nice, that was fast! <span aria-label="smile" class="emoji emoji-1f642" role="img" title="smile">:smile:</span></p>
</blockquote>



<a name="219646167"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20Issue%20%232493%20Directories%20with%20more%20than%20~150%20fi.../near/219646167" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20Issue.20.232493.20Directories.20with.20more.20than.20~150.20fi.2E.2E.2E.html#219646167">(Dec 11 2020 at 18:52)</a>:</h4>
<p>sunfishcode closed <a href="https://github.com/bytecodealliance/wasmtime/issues/2493">Issue #2493</a> (assigned to pchickey):</p>
<blockquote>
<p>I am using this simple C program to test:</p>
<div class="codehilite" data-code-language="C"><pre><span></span><code><span class="cp">#include</span> <span class="cpf">&lt;dirent.h&gt;</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&lt;stdio.h&gt;</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&lt;errno.h&gt;</span><span class="cp"></span>

<span class="kt">int</span> <span class="nf">main</span><span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="kt">char</span> <span class="o">**</span><span class="n">argv</span><span class="p">)</span> <span class="p">{</span>
  <span class="kt">DIR</span> <span class="o">*</span><span class="n">d</span><span class="p">;</span>

  <span class="kt">char</span> <span class="o">*</span> <span class="n">target</span> <span class="o">=</span> <span class="s">"."</span><span class="p">;</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">argc</span> <span class="o">==</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">target</span> <span class="o">=</span> <span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
  <span class="p">}</span>
  <span class="k">struct</span> <span class="nc">dirent</span> <span class="o">*</span><span class="n">dir</span><span class="p">;</span>
  <span class="n">d</span> <span class="o">=</span> <span class="n">opendir</span><span class="p">(</span><span class="n">target</span><span class="p">);</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">d</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">while</span> <span class="p">((</span><span class="n">dir</span> <span class="o">=</span> <span class="n">readdir</span><span class="p">(</span><span class="n">d</span><span class="p">))</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">printf</span><span class="p">(</span><span class="s">"%s</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">dir</span><span class="o">-&gt;</span><span class="n">d_name</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="n">printf</span><span class="p">(</span><span class="s">"errno: %d</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">errno</span><span class="p">);</span>
    <span class="n">closedir</span><span class="p">(</span><span class="n">d</span><span class="p">);</span>
  <span class="p">}</span>

  <span class="k">return</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div>
<p>I then use this bash script to generate a directory with <code>N</code> files in</p>
<div class="codehilite" data-code-language="Bash"><pre><span></span><code>rm -rf testfolder
mkdir -p testfolder
<span class="k">for</span> n in <span class="k">$(</span>seq <span class="m">1</span> <span class="si">${</span><span class="nv">1</span><span class="k">:-</span><span class="nv">100</span><span class="si">}</span><span class="k">)</span><span class="p">;</span> <span class="k">do</span>
        touch testfolder/<span class="k">$(</span><span class="nb">printf</span> %04d <span class="s2">"</span><span class="nv">$n</span><span class="s2">"</span><span class="k">)</span>
<span class="k">done</span>
</code></pre></div>
<p>This is what happens when I run it</p>
<div class="codehilite" data-code-language="Bash"><pre><span></span><code>$ bash generate-files.sh <span class="m">100</span>

$ ls testfolder/
<span class="m">0001</span>  <span class="m">0005</span>  <span class="m">0009</span>  <span class="m">0013</span>  <span class="m">0017</span>  <span class="m">0021</span>  <span class="m">0025</span>  <span class="m">0029</span>  <span class="m">0033</span>  <span class="m">0037</span>  <span class="m">0041</span>  <span class="m">0045</span>  <span class="m">0049</span>  <span class="m">0053</span>  <span class="m">0057</span>  <span class="m">0061</span>  <span class="m">0065</span>  <span class="m">0069</span>  <span class="m">0073</span>  <span class="m">0077</span>  <span class="m">0081</span>  <span class="m">0085</span>  <span class="m">0089</span>  <span class="m">0093</span>  <span class="m">0097</span>
<span class="m">0002</span>  <span class="m">0006</span>  <span class="m">0010</span>  <span class="m">0014</span>  <span class="m">0018</span>  <span class="m">0022</span>  <span class="m">0026</span>  <span class="m">0030</span>  <span class="m">0034</span>  <span class="m">0038</span>  <span class="m">0042</span>  <span class="m">0046</span>  <span class="m">0050</span>  <span class="m">0054</span>  <span class="m">0058</span>  <span class="m">0062</span>  <span class="m">0066</span>  <span class="m">0070</span>  <span class="m">0074</span>  <span class="m">0078</span>  <span class="m">0082</span>  <span class="m">0086</span>  <span class="m">0090</span>  <span class="m">0094</span>  <span class="m">0098</span>
<span class="m">0003</span>  <span class="m">0007</span>  <span class="m">0011</span>  <span class="m">0015</span>  <span class="m">0019</span>  <span class="m">0023</span>  <span class="m">0027</span>  <span class="m">0031</span>  <span class="m">0035</span>  <span class="m">0039</span>  <span class="m">0043</span>  <span class="m">0047</span>  <span class="m">0051</span>  <span class="m">0055</span>  <span class="m">0059</span>  <span class="m">0063</span>  <span class="m">0067</span>  <span class="m">0071</span>  <span class="m">0075</span>  <span class="m">0079</span>  <span class="m">0083</span>  <span class="m">0087</span>  <span class="m">0091</span>  <span class="m">0095</span>  <span class="m">0099</span>
<span class="m">0004</span>  <span class="m">0008</span>  <span class="m">0012</span>  <span class="m">0016</span>  <span class="m">0020</span>  <span class="m">0024</span>  <span class="m">0028</span>  <span class="m">0032</span>  <span class="m">0036</span>  <span class="m">0040</span>  <span class="m">0044</span>  <span class="m">0048</span>  <span class="m">0052</span>  <span class="m">0056</span>  <span class="m">0060</span>  <span class="m">0064</span>  <span class="m">0068</span>  <span class="m">0072</span>  <span class="m">0076</span>  <span class="m">0080</span>  <span class="m">0084</span>  <span class="m">0088</span>  <span class="m">0092</span>  <span class="m">0096</span>  <span class="m">0100</span>

$ wasmtime run ls.wasm --dir<span class="o">=</span>./testfolder -- testfolder <span class="p">|</span> wc -l
<span class="m">103</span> <span class="c1"># 100 files + "." ".." and the "errno" print</span>

$ bash generate-files.sh <span class="m">200</span>

$ wasmtime run ls.wasm --dir<span class="o">=</span>./testfolder -- testfolder <span class="p">|</span> wc -l
<span class="m">147</span> <span class="c1"># lots of files missing</span>

<span class="c1"># for example 0012</span>
$ wasmtime run ls.wasm --dir<span class="o">=</span>./testfolder -- testfolder <span class="p">|</span> grep <span class="m">0012</span>

$ wasmtime run ls.wasm --dir<span class="o">=</span>./testfolder -- testfolder <span class="p">|</span> grep <span class="m">0011</span>
<span class="m">0011</span>
</code></pre></div>
<p>Running wasmer on the same input works as expected:</p>
<div class="codehilite" data-code-language="Bash"><pre><span></span><code>$ ~/.wasmer/bin/wasmer run ls.wasm --dir<span class="o">=</span>./testfolder -- testfolder <span class="p">|</span> wc -l
<span class="m">201</span> <span class="c1"># wasmer does not return "." and ".."</span>

$ ~/.wasmer/bin/wasmer run ls.wasm --dir<span class="o">=</span>./testfolder -- testfolder <span class="p">|</span> grep <span class="m">0012</span>
<span class="m">0012</span>
</code></pre></div>
<h1>Expected Behavior</h1>
<p>Calls to <code>readdir</code> returns all directory entries, even for folders with more than ~150 files.<br>
</p>
</blockquote>



<hr><p>Last updated: Jan 20 2025 at 06:04 UTC</p>
</html>