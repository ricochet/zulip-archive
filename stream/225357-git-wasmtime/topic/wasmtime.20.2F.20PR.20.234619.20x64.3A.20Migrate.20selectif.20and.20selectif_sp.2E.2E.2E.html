<html>
<head><meta charset="utf-8"><title>wasmtime / PR #4619 x64: Migrate selectif and selectif_sp... · git-wasmtime · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/index.html">git-wasmtime</a></h2>
<h3>Topic: <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.234619.20x64.3A.20Migrate.20selectif.20and.20selectif_sp.2E.2E.2E.html">wasmtime / PR #4619 x64: Migrate selectif and selectif_sp...</a></h3>

<hr>

<base href="https://bytecodealliance.zulipchat.com">

<head><link href="https://bytecodealliance.github.io/zulip-archive/style.css" rel="stylesheet"></head>

<a name="292077443"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%234619%20x64%3A%20Migrate%20selectif%20and%20selectif_sp.../near/292077443" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.234619.20x64.3A.20Migrate.20selectif.20and.20selectif_sp.2E.2E.2E.html#292077443">(Aug 04 2022 at 22:21)</a>:</h4>
<p>elliottt edited <a href="https://github.com/bytecodealliance/wasmtime/pull/4619">PR #4619</a> from <code>trevor/x64-isle-select</code> to <code>main</code>:</p>
<blockquote>
<ul>
<li>Lower selectif and selectif_spectre_guard</li>
<li>Remove unused code</li>
</ul>
<p>&lt;!--</p>
<p>Please ensure that the following steps are all taken care of before submitting<br>
the PR.</p>
<ul>
<li>
<p>[ ] This has been discussed in issue #..., or if not, please tell us why<br>
  here.</p>
</li>
<li>
<p>[ ] A short description of what this does, why it is needed; if the<br>
  description becomes long, the matter should probably be discussed in an issue<br>
  first.</p>
</li>
<li>
<p>[ ] This PR contains test cases, if meaningful.</p>
</li>
<li>[ ] A reviewer from the core maintainer team has been assigned for this PR.<br>
  If you don't know who could review this, please indicate so. The list of<br>
  suggested reviewers on the right can help you.</li>
</ul>
<p>Please ensure all communication adheres to the <a href="https://github.com/bytecodealliance/wasmtime/blob/master/CODE_OF_CONDUCT.md">code of
conduct</a>.<br>
--&gt;<br>
</p>
</blockquote>



<a name="292077716"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%234619%20x64%3A%20Migrate%20selectif%20and%20selectif_sp.../near/292077716" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.234619.20x64.3A.20Migrate.20selectif.20and.20selectif_sp.2E.2E.2E.html#292077716">(Aug 04 2022 at 22:24)</a>:</h4>
<p>elliottt edited <a href="https://github.com/bytecodealliance/wasmtime/pull/4619">PR #4619</a> from <code>trevor/x64-isle-select</code> to <code>main</code>:</p>
<blockquote>
<p>Lower <code>selectif</code> and <code>selectif_spectre_guard</code> in ISLE, which allows a lot of code related to <code>emit_cmp</code> to be removed from the x64 <a href="http://lower.rs">lower.rs</a> module.</p>
<p>&lt;!--</p>
<p>Please ensure that the following steps are all taken care of before submitting<br>
the PR.</p>
<ul>
<li>
<p>[ ] This has been discussed in issue #..., or if not, please tell us why<br>
  here.</p>
</li>
<li>
<p>[ ] A short description of what this does, why it is needed; if the<br>
  description becomes long, the matter should probably be discussed in an issue<br>
  first.</p>
</li>
<li>
<p>[ ] This PR contains test cases, if meaningful.</p>
</li>
<li>[ ] A reviewer from the core maintainer team has been assigned for this PR.<br>
  If you don't know who could review this, please indicate so. The list of<br>
  suggested reviewers on the right can help you.</li>
</ul>
<p>Please ensure all communication adheres to the <a href="https://github.com/bytecodealliance/wasmtime/blob/master/CODE_OF_CONDUCT.md">code of
conduct</a>.<br>
--&gt;<br>
</p>
</blockquote>



<a name="292078883"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%234619%20x64%3A%20Migrate%20selectif%20and%20selectif_sp.../near/292078883" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.234619.20x64.3A.20Migrate.20selectif.20and.20selectif_sp.2E.2E.2E.html#292078883">(Aug 04 2022 at 22:36)</a>:</h4>
<p><strong>elliottt</strong> has marked <a href="https://github.com/bytecodealliance/wasmtime/pull/4619">PR #4619</a> as ready for review.</p>



<a name="292080246"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%234619%20x64%3A%20Migrate%20selectif%20and%20selectif_sp.../near/292080246" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.234619.20x64.3A.20Migrate.20selectif.20and.20selectif_sp.2E.2E.2E.html#292080246">(Aug 04 2022 at 22:52)</a>:</h4>
<p>elliottt submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/4619#pullrequestreview-1062665111">PR review</a>.</p>



<a name="292080247"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%234619%20x64%3A%20Migrate%20selectif%20and%20selectif_sp.../near/292080247" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.234619.20x64.3A.20Migrate.20selectif.20and.20selectif_sp.2E.2E.2E.html#292080247">(Aug 04 2022 at 22:52)</a>:</h4>
<p>elliottt created <a href="https://github.com/bytecodealliance/wasmtime/pull/4619#discussion_r938305070">PR review comment</a>:</p>
<blockquote>
<p>This might not be the most reusable signature, should I rework this to take the type as an argument and <code>ValueRegs</code> arguments instead of <code>Value</code>?</p>
</blockquote>



<a name="292082317"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%234619%20x64%3A%20Migrate%20selectif%20and%20selectif_sp.../near/292082317" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.234619.20x64.3A.20Migrate.20selectif.20and.20selectif_sp.2E.2E.2E.html#292082317">(Aug 04 2022 at 23:17)</a>:</h4>
<p>cfallin submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/4619#pullrequestreview-1062687403">PR review</a>.</p>



<a name="292082318"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%234619%20x64%3A%20Migrate%20selectif%20and%20selectif_sp.../near/292082318" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.234619.20x64.3A.20Migrate.20selectif.20and.20selectif_sp.2E.2E.2E.html#292082318">(Aug 04 2022 at 23:17)</a>:</h4>
<p>cfallin created <a href="https://github.com/bytecodealliance/wasmtime/pull/4619#discussion_r938322322">PR review comment</a>:</p>
<blockquote>
<p>That might be slightly more idiomatic for the "inst helpers" layer, though I don't think it's too important either way; strong types mean we can always refactor easily and relatively safely...</p>
</blockquote>



<a name="292082319"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%234619%20x64%3A%20Migrate%20selectif%20and%20selectif_sp.../near/292082319" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.234619.20x64.3A.20Migrate.20selectif.20and.20selectif_sp.2E.2E.2E.html#292082319">(Aug 04 2022 at 23:17)</a>:</h4>
<p>cfallin submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/4619#pullrequestreview-1062687403">PR review</a>.</p>



<a name="292082320"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%234619%20x64%3A%20Migrate%20selectif%20and%20selectif_sp.../near/292082320" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.234619.20x64.3A.20Migrate.20selectif.20and.20selectif_sp.2E.2E.2E.html#292082320">(Aug 04 2022 at 23:17)</a>:</h4>
<p>cfallin created <a href="https://github.com/bytecodealliance/wasmtime/pull/4619#discussion_r938323497">PR review comment</a>:</p>
<blockquote>
<p>Here is I think a good reason to force the inputs into registers: otherwise the heap legalization is going to have a load in the hotpath.</p>
<p>Although, after saying that, I am a bit curious whether the reduced register pressure (no <code>rdx</code> needed here anymore) has an effect in the opposite direction... if it's not too much trouble, would you be willing to run a quick set of Sightglass benchmarks (on at least say <code>bz2</code>, <code>spidermonkey</code>, <code>pulldown-cmark</code>)?</p>
</blockquote>



<a name="292085339"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%234619%20x64%3A%20Migrate%20selectif%20and%20selectif_sp.../near/292085339" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.234619.20x64.3A.20Migrate.20selectif.20and.20selectif_sp.2E.2E.2E.html#292085339">(Aug 04 2022 at 23:51)</a>:</h4>
<p>elliottt updated <a href="https://github.com/bytecodealliance/wasmtime/pull/4619">PR #4619</a> from <code>trevor/x64-isle-select</code> to <code>main</code>.</p>



<a name="292085630"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%234619%20x64%3A%20Migrate%20selectif%20and%20selectif_sp.../near/292085630" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.234619.20x64.3A.20Migrate.20selectif.20and.20selectif_sp.2E.2E.2E.html#292085630">(Aug 04 2022 at 23:54)</a>:</h4>
<p>elliottt created <a href="https://github.com/bytecodealliance/wasmtime/pull/4619#discussion_r938338622">PR review comment</a>:</p>
<blockquote>
<p>Sure! I have a fix that forces the value to registers now so this PR shouldn't change performance, but I'll run the sightglass benchmarks without that fix just to see what the difference is.</p>
</blockquote>



<a name="292085631"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%234619%20x64%3A%20Migrate%20selectif%20and%20selectif_sp.../near/292085631" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.234619.20x64.3A.20Migrate.20selectif.20and.20selectif_sp.2E.2E.2E.html#292085631">(Aug 04 2022 at 23:54)</a>:</h4>
<p>elliottt submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/4619#pullrequestreview-1062707355">PR review</a>.</p>



<a name="292093846"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%234619%20x64%3A%20Migrate%20selectif%20and%20selectif_sp.../near/292093846" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.234619.20x64.3A.20Migrate.20selectif.20and.20selectif_sp.2E.2E.2E.html#292093846">(Aug 05 2022 at 02:09)</a>:</h4>
<p>elliottt submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/4619#pullrequestreview-1062766202">PR review</a>.</p>



<a name="292093847"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%234619%20x64%3A%20Migrate%20selectif%20and%20selectif_sp.../near/292093847" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.234619.20x64.3A.20Migrate.20selectif.20and.20selectif_sp.2E.2E.2E.html#292093847">(Aug 05 2022 at 02:09)</a>:</h4>
<p>elliottt created <a href="https://github.com/bytecodealliance/wasmtime/pull/4619#discussion_r938385015">PR review comment</a>:</p>
<blockquote>
<p>Here are the results, <code>branch.so</code> is loading a <code>0</code> from memory, <code>main.so</code> is with <code>xor r, r, r</code>: <a href="https://gist.github.com/elliottt/67be59da8bbdc3a9f946837efc81dedf">https://gist.github.com/elliottt/67be59da8bbdc3a9f946837efc81dedf</a></p>
<p>Overall, it looks like using <code>xor r, r, r</code> is still a win, so I'll merge the version of this PR that preserves that behavior <span aria-label="+1" class="emoji emoji-1f44d" role="img" title="+1">:+1:</span> </p>
</blockquote>



<a name="292094105"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%234619%20x64%3A%20Migrate%20selectif%20and%20selectif_sp.../near/292094105" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.234619.20x64.3A.20Migrate.20selectif.20and.20selectif_sp.2E.2E.2E.html#292094105">(Aug 05 2022 at 02:14)</a>:</h4>
<p>elliottt edited <a href="https://github.com/bytecodealliance/wasmtime/pull/4619#discussion_r938385015">PR review comment</a>.</p>



<a name="292111841"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%234619%20x64%3A%20Migrate%20selectif%20and%20selectif_sp.../near/292111841" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.234619.20x64.3A.20Migrate.20selectif.20and.20selectif_sp.2E.2E.2E.html#292111841">(Aug 05 2022 at 06:09)</a>:</h4>
<p>elliottt created <a href="https://github.com/bytecodealliance/wasmtime/pull/4619#discussion_r938473817">PR review comment</a>:</p>
<blockquote>
<p>My naming of the two outputs was bothering me, so I ran another set of benchmarks with the sha of the commit as the name for the shared object. Here are the results: <a href="https://gist.github.com/elliottt/cd2ad5c97d53c57a315b76b4b674af46">https://gist.github.com/elliottt/cd2ad5c97d53c57a315b76b4b674af46</a>.</p>
<p>25c436f4480b5e20f832eab4d165734692c298a0 is the head of this branch, loading 0 via <code>xor</code><br>
643f53789890f2a776839fe4f5a662d0ec7f891b is the previous commit that would load 0 via memory</p>
</blockquote>



<a name="292111842"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%234619%20x64%3A%20Migrate%20selectif%20and%20selectif_sp.../near/292111842" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.234619.20x64.3A.20Migrate.20selectif.20and.20selectif_sp.2E.2E.2E.html#292111842">(Aug 05 2022 at 06:09)</a>:</h4>
<p>elliottt submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/4619#pullrequestreview-1062884320">PR review</a>.</p>



<a name="292112077"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%234619%20x64%3A%20Migrate%20selectif%20and%20selectif_sp.../near/292112077" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.234619.20x64.3A.20Migrate.20selectif.20and.20selectif_sp.2E.2E.2E.html#292112077">(Aug 05 2022 at 06:13)</a>:</h4>
<p>elliottt edited <a href="https://github.com/bytecodealliance/wasmtime/pull/4619#discussion_r938473817">PR review comment</a>.</p>



<a name="292178466"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%234619%20x64%3A%20Migrate%20selectif%20and%20selectif_sp.../near/292178466" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.234619.20x64.3A.20Migrate.20selectif.20and.20selectif_sp.2E.2E.2E.html#292178466">(Aug 05 2022 at 16:36)</a>:</h4>
<p>elliottt merged <a href="https://github.com/bytecodealliance/wasmtime/pull/4619">PR #4619</a>.</p>



<a name="292179273"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%234619%20x64%3A%20Migrate%20selectif%20and%20selectif_sp.../near/292179273" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.234619.20x64.3A.20Migrate.20selectif.20and.20selectif_sp.2E.2E.2E.html#292179273">(Aug 05 2022 at 16:43)</a>:</h4>
<p>cfallin created <a href="https://github.com/bytecodealliance/wasmtime/pull/4619#discussion_r938988869">PR review comment</a>:</p>
<blockquote>
<p>A bit late but I realized this morning that we probably aren't actually benchmarking the thing with the default Sightglass config: it should be using static memories with a large enough guard region (4+2GiB by default I think?) that bounds checks don't actually happen. We would need to configure it to use dynamic bounds to see a delta; we may just be reading into noise here.</p>
<p>If you're up for it, <code>--static-memory-maximum-size 0 --static-memory-guard-size 0</code> will I think give a completely dynamic (bounds-checked) configuration; running the two different wasmtimes and timing them (with e.g. <code>hyperfine</code>, running a cwasm with <code>--allow-precompiled</code>) is probably easier than hacking the default config to make Sightglass use it.</p>
<p>I still remain a little skeptical that loads of 0 from memory are faster, but I'd love to be proven wrong...</p>
</blockquote>



<a name="292179274"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%234619%20x64%3A%20Migrate%20selectif%20and%20selectif_sp.../near/292179274" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.234619.20x64.3A.20Migrate.20selectif.20and.20selectif_sp.2E.2E.2E.html#292179274">(Aug 05 2022 at 16:43)</a>:</h4>
<p>cfallin submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/4619#pullrequestreview-1063613641">PR review</a>.</p>



<a name="292181242"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%234619%20x64%3A%20Migrate%20selectif%20and%20selectif_sp.../near/292181242" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.234619.20x64.3A.20Migrate.20selectif.20and.20selectif_sp.2E.2E.2E.html#292181242">(Aug 05 2022 at 16:59)</a>:</h4>
<p>elliottt submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/4619#pullrequestreview-1063629816">PR review</a>.</p>



<a name="292181244"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%234619%20x64%3A%20Migrate%20selectif%20and%20selectif_sp.../near/292181244" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.234619.20x64.3A.20Migrate.20selectif.20and.20selectif_sp.2E.2E.2E.html#292181244">(Aug 05 2022 at 16:59)</a>:</h4>
<p>elliottt created <a href="https://github.com/bytecodealliance/wasmtime/pull/4619#discussion_r939000311">PR review comment</a>:</p>
<blockquote>
<p>Happy to run some more tests in the background -- I've still got the shared objects hanging around. I figured it was better to merge the version that didn't introduce the loads, as it would be pretty easy to revert the last commit on this PR if we decided that it was worthwhile <span aria-label="+1" class="emoji emoji-1f44d" role="img" title="+1">:+1:</span> </p>
</blockquote>



<a name="292185549"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%234619%20x64%3A%20Migrate%20selectif%20and%20selectif_sp.../near/292185549" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.234619.20x64.3A.20Migrate.20selectif.20and.20selectif_sp.2E.2E.2E.html#292185549">(Aug 05 2022 at 17:37)</a>:</h4>
<p>elliottt submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/4619#pullrequestreview-1063673045">PR review</a>.</p>



<a name="292185550"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%234619%20x64%3A%20Migrate%20selectif%20and%20selectif_sp.../near/292185550" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.234619.20x64.3A.20Migrate.20selectif.20and.20selectif_sp.2E.2E.2E.html#292185550">(Aug 05 2022 at 17:37)</a>:</h4>
<p>elliottt created <a href="https://github.com/bytecodealliance/wasmtime/pull/4619#discussion_r939029250">PR review comment</a>:</p>
<blockquote>
<p>The results for bz2 are pretty interesting: initialization really takes a hit from the load.</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="n">instantiation</span><span class="w"> </span>:: <span class="nc">nanoseconds</span><span class="w"> </span>:: <span class="nc">benchmarks</span><span class="o">/</span><span class="n">bz2</span><span class="o">/</span><span class="n">benchmark</span><span class="p">.</span><span class="n">wasm</span><span class="w"></span>

<span class="w">  </span><span class="err">Δ</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">26233.52</span><span class="w"> </span><span class="err">±</span><span class="w"> </span><span class="mf">5394.98</span><span class="w"> </span><span class="p">(</span><span class="n">confidence</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">99</span><span class="o">%</span><span class="p">)</span><span class="w"></span>

<span class="w">  </span><span class="mi">25</span><span class="n">c436f4480b5e20f832eab4d165734692c298a0</span><span class="p">.</span><span class="n">so</span><span class="w"> </span><span class="n">is</span><span class="w"> </span><span class="mf">1.43</span><span class="n">x</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="mf">1.65</span><span class="n">x</span><span class="w"> </span><span class="n">faster</span><span class="w"> </span><span class="n">than</span><span class="w"> </span><span class="mi">643</span><span class="n">f53789890f2a776839fe4f5a662d0ec7f891b</span><span class="p">.</span><span class="n">so</span><span class="o">!</span><span class="w"></span>
<span class="w">  </span><span class="mi">643</span><span class="n">f53789890f2a776839fe4f5a662d0ec7f891b</span><span class="p">.</span><span class="n">so</span><span class="w"> </span><span class="n">is</span><span class="w"> </span><span class="mf">0.58</span><span class="n">x</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="mf">0.72</span><span class="n">x</span><span class="w"> </span><span class="n">faster</span><span class="w"> </span><span class="n">than</span><span class="w"> </span><span class="mi">25</span><span class="n">c436f4480b5e20f832eab4d165734692c298a0</span><span class="p">.</span><span class="n">so</span><span class="o">!</span><span class="w"></span>

<span class="w">  </span><span class="p">[</span><span class="mi">43591</span><span class="w"> </span><span class="mf">48321.01</span><span class="w"> </span><span class="mi">90806</span><span class="p">]</span><span class="w"> </span><span class="mi">25</span><span class="n">c436f4480b5e20f832eab4d165734692c298a0</span><span class="p">.</span><span class="n">so</span><span class="w"></span>
<span class="w">  </span><span class="p">[</span><span class="mi">43783</span><span class="w"> </span><span class="mf">74554.53</span><span class="w"> </span><span class="mi">122088</span><span class="p">]</span><span class="w"> </span><span class="mi">643</span><span class="n">f53789890f2a776839fe4f5a662d0ec7f891b</span><span class="p">.</span><span class="n">so</span><span class="w"></span>

<span class="n">instantiation</span><span class="w"> </span>:: <span class="nc">cycles</span><span class="w"> </span>:: <span class="nc">benchmarks</span><span class="o">/</span><span class="n">bz2</span><span class="o">/</span><span class="n">benchmark</span><span class="p">.</span><span class="n">wasm</span><span class="w"></span>

<span class="w">  </span><span class="err">Δ</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">94444.02</span><span class="w"> </span><span class="err">±</span><span class="w"> </span><span class="mf">19422.58</span><span class="w"> </span><span class="p">(</span><span class="n">confidence</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">99</span><span class="o">%</span><span class="p">)</span><span class="w"></span>

<span class="w">  </span><span class="mi">25</span><span class="n">c436f4480b5e20f832eab4d165734692c298a0</span><span class="p">.</span><span class="n">so</span><span class="w"> </span><span class="n">is</span><span class="w"> </span><span class="mf">1.43</span><span class="n">x</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="mf">1.65</span><span class="n">x</span><span class="w"> </span><span class="n">faster</span><span class="w"> </span><span class="n">than</span><span class="w"> </span><span class="mi">643</span><span class="n">f53789890f2a776839fe4f5a662d0ec7f891b</span><span class="p">.</span><span class="n">so</span><span class="o">!</span><span class="w"></span>
<span class="w">  </span><span class="mi">643</span><span class="n">f53789890f2a776839fe4f5a662d0ec7f891b</span><span class="p">.</span><span class="n">so</span><span class="w"> </span><span class="n">is</span><span class="w"> </span><span class="mf">0.58</span><span class="n">x</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="mf">0.72</span><span class="n">x</span><span class="w"> </span><span class="n">faster</span><span class="w"> </span><span class="n">than</span><span class="w"> </span><span class="mi">25</span><span class="n">c436f4480b5e20f832eab4d165734692c298a0</span><span class="p">.</span><span class="n">so</span><span class="o">!</span><span class="w"></span>

<span class="w">  </span><span class="p">[</span><span class="mi">156936</span><span class="w"> </span><span class="mf">173963.32</span><span class="w"> </span><span class="mi">326914</span><span class="p">]</span><span class="w"> </span><span class="mi">25</span><span class="n">c436f4480b5e20f832eab4d165734692c298a0</span><span class="p">.</span><span class="n">so</span><span class="w"></span>
<span class="w">  </span><span class="p">[</span><span class="mi">157626</span><span class="w"> </span><span class="mf">268407.34</span><span class="w"> </span><span class="mi">439534</span><span class="p">]</span><span class="w"> </span><span class="mi">643</span><span class="n">f53789890f2a776839fe4f5a662d0ec7f891b</span><span class="p">.</span><span class="n">so</span><span class="w"></span>

<span class="n">execution</span><span class="w"> </span>:: <span class="nc">nanoseconds</span><span class="w"> </span>:: <span class="nc">benchmarks</span><span class="o">/</span><span class="n">bz2</span><span class="o">/</span><span class="n">benchmark</span><span class="p">.</span><span class="n">wasm</span><span class="w"></span>

<span class="w">  </span><span class="err">Δ</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">269493.01</span><span class="w"> </span><span class="err">±</span><span class="w"> </span><span class="mf">178023.21</span><span class="w"> </span><span class="p">(</span><span class="n">confidence</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">99</span><span class="o">%</span><span class="p">)</span><span class="w"></span>

<span class="w">  </span><span class="mi">25</span><span class="n">c436f4480b5e20f832eab4d165734692c298a0</span><span class="p">.</span><span class="n">so</span><span class="w"> </span><span class="n">is</span><span class="w"> </span><span class="mf">0.99</span><span class="n">x</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="mf">1.00</span><span class="n">x</span><span class="w"> </span><span class="n">faster</span><span class="w"> </span><span class="n">than</span><span class="w"> </span><span class="mi">643</span><span class="n">f53789890f2a776839fe4f5a662d0ec7f891b</span><span class="p">.</span><span class="n">so</span><span class="o">!</span><span class="w"></span>
<span class="w">  </span><span class="mi">643</span><span class="n">f53789890f2a776839fe4f5a662d0ec7f891b</span><span class="p">.</span><span class="n">so</span><span class="w"> </span><span class="n">is</span><span class="w"> </span><span class="mf">1.00</span><span class="n">x</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="mf">1.01</span><span class="n">x</span><span class="w"> </span><span class="n">faster</span><span class="w"> </span><span class="n">than</span><span class="w"> </span><span class="mi">25</span><span class="n">c436f4480b5e20f832eab4d165734692c298a0</span><span class="p">.</span><span class="n">so</span><span class="o">!</span><span class="w"></span>

<span class="w">  </span><span class="p">[</span><span class="mi">30236428</span><span class="w"> </span><span class="mf">30873377.89</span><span class="w"> </span><span class="mi">31490866</span><span class="p">]</span><span class="w"> </span><span class="mi">25</span><span class="n">c436f4480b5e20f832eab4d165734692c298a0</span><span class="p">.</span><span class="n">so</span><span class="w"></span>
<span class="w">  </span><span class="p">[</span><span class="mi">30184192</span><span class="w"> </span><span class="mf">30603884.88</span><span class="w"> </span><span class="mi">31578144</span><span class="p">]</span><span class="w"> </span><span class="mi">643</span><span class="n">f53789890f2a776839fe4f5a662d0ec7f891b</span><span class="p">.</span><span class="n">so</span><span class="w"></span>

<span class="n">execution</span><span class="w"> </span>:: <span class="nc">cycles</span><span class="w"> </span>:: <span class="nc">benchmarks</span><span class="o">/</span><span class="n">bz2</span><span class="o">/</span><span class="n">benchmark</span><span class="p">.</span><span class="n">wasm</span><span class="w"></span>

<span class="w">  </span><span class="err">Δ</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">970207.46</span><span class="w"> </span><span class="err">±</span><span class="w"> </span><span class="mf">640905.23</span><span class="w"> </span><span class="p">(</span><span class="n">confidence</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">99</span><span class="o">%</span><span class="p">)</span><span class="w"></span>

<span class="w">  </span><span class="mi">25</span><span class="n">c436f4480b5e20f832eab4d165734692c298a0</span><span class="p">.</span><span class="n">so</span><span class="w"> </span><span class="n">is</span><span class="w"> </span><span class="mf">0.99</span><span class="n">x</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="mf">1.00</span><span class="n">x</span><span class="w"> </span><span class="n">faster</span><span class="w"> </span><span class="n">than</span><span class="w"> </span><span class="mi">643</span><span class="n">f53789890f2a776839fe4f5a662d0ec7f891b</span><span class="p">.</span><span class="n">so</span><span class="o">!</span><span class="w"></span>
<span class="w">  </span><span class="mi">643</span><span class="n">f53789890f2a776839fe4f5a662d0ec7f891b</span><span class="p">.</span><span class="n">so</span><span class="w"> </span><span class="n">is</span><span class="w"> </span><span class="mf">1.00</span><span class="n">x</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="mf">1.01</span><span class="n">x</span><span class="w"> </span><span class="n">faster</span><span class="w"> </span><span class="n">than</span><span class="w"> </span><span class="mi">25</span><span class="n">c436f4480b5e20f832eab4d165734692c298a0</span><span class="p">.</span><span class="n">so</span><span class="o">!</span><span class="w"></span>

<span class="w">  </span><span class="p">[</span><span class="mi">108854820</span><span class="w"> </span><span class="mf">111147916.48</span><span class="w"> </span><span class="mi">113370948</span><span class="p">]</span><span class="w"> </span><span class="mi">25</span><span class="n">c436f4480b5e20f832eab4d165734692c298a0</span><span class="p">.</span><span class="n">so</span><span class="w"></span>
<span class="w">  </span><span class="p">[</span><span class="mi">108666764</span><span class="w"> </span><span class="mf">110177709.02</span><span class="w"> </span><span class="mi">113685162</span><span class="p">]</span><span class="w"> </span><span class="mi">643</span><span class="n">f53789890f2a776839fe4f5a662d0ec7f891b</span><span class="p">.</span><span class="n">so</span><span class="w"></span>

<span class="n">compilation</span><span class="w"> </span>:: <span class="nc">cycles</span><span class="w"> </span>:: <span class="nc">benchmarks</span><span class="o">/</span><span class="n">bz2</span><span class="o">/</span><span class="n">benchmark</span><span class="p">.</span><span class="n">wasm</span><span class="w"></span>

<span class="w">  </span><span class="n">No</span><span class="w"> </span><span class="n">difference</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="n">performance</span><span class="p">.</span><span class="w"></span>

<span class="w">  </span><span class="p">[</span><span class="mi">235950166</span><span class="w"> </span><span class="mf">248161159.74</span><span class="w"> </span><span class="mi">266311074</span><span class="p">]</span><span class="w"> </span><span class="mi">25</span><span class="n">c436f4480b5e20f832eab4d165734692c298a0</span><span class="p">.</span><span class="n">so</span><span class="w"></span>
<span class="w">  </span><span class="p">[</span><span class="mi">237357286</span><span class="w"> </span><span class="mf">247903675.98</span><span class="w"> </span><span class="mi">301295484</span><span class="p">]</span><span class="w"> </span><span class="mi">643</span><span class="n">f53789890f2a776839fe4f5a662d0ec7f891b</span><span class="p">.</span><span class="n">so</span><span class="w"></span>

<span class="n">compilation</span><span class="w"> </span>:: <span class="nc">nanoseconds</span><span class="w"> </span>:: <span class="nc">benchmarks</span><span class="o">/</span><span class="n">bz2</span><span class="o">/</span><span class="n">benchmark</span><span class="p">.</span><span class="n">wasm</span><span class="w"></span>

<span class="w">  </span><span class="n">No</span><span class="w"> </span><span class="n">difference</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="n">performance</span><span class="p">.</span><span class="w"></span>

<span class="w">  </span><span class="p">[</span><span class="mi">65539498</span><span class="w"> </span><span class="mf">68931326.53</span><span class="w"> </span><span class="mi">73972799</span><span class="p">]</span><span class="w"> </span><span class="mi">25</span><span class="n">c436f4480b5e20f832eab4d165734692c298a0</span><span class="p">.</span><span class="n">so</span><span class="w"></span>
<span class="w">  </span><span class="p">[</span><span class="mi">65930352</span><span class="w"> </span><span class="mf">68859805.71</span><span class="w"> </span><span class="mi">83690362</span><span class="p">]</span><span class="w"> </span><span class="mi">643</span><span class="n">f53789890f2a776839fe4f5a662d0ec7f891b</span><span class="p">.</span><span class="n">so</span><span class="w"></span>
</code></pre></div>
<p>As a note about how I set these flags: I modified <code>crates/bench-api/src/lib.rs</code> to initialize both of the fields @cfallin mentioned to <code>0</code> so that I could continue using <code>sightglass</code> for generating the benchmarks.</p>
</blockquote>



<a name="292185938"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%234619%20x64%3A%20Migrate%20selectif%20and%20selectif_sp.../near/292185938" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.234619.20x64.3A.20Migrate.20selectif.20and.20selectif_sp.2E.2E.2E.html#292185938">(Aug 05 2022 at 17:40)</a>:</h4>
<p>cfallin created <a href="https://github.com/bytecodealliance/wasmtime/pull/4619#discussion_r939032541">PR review comment</a>:</p>
<blockquote>
<p>Interesting, so load-from-zero is still 0-1% faster, if I'm reading this right? Great if so; perhaps the register pressure is the deciding factor!</p>
</blockquote>



<a name="292185939"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%234619%20x64%3A%20Migrate%20selectif%20and%20selectif_sp.../near/292185939" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.234619.20x64.3A.20Migrate.20selectif.20and.20selectif_sp.2E.2E.2E.html#292185939">(Aug 05 2022 at 17:40)</a>:</h4>
<p>cfallin submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/4619#pullrequestreview-1063676231">PR review</a>.</p>



<a name="292186424"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%234619%20x64%3A%20Migrate%20selectif%20and%20selectif_sp.../near/292186424" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.234619.20x64.3A.20Migrate.20selectif.20and.20selectif_sp.2E.2E.2E.html#292186424">(Aug 05 2022 at 17:44)</a>:</h4>
<p>cfallin submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/4619#pullrequestreview-1063680044">PR review</a>.</p>



<a name="292186425"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%234619%20x64%3A%20Migrate%20selectif%20and%20selectif_sp.../near/292186425" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.234619.20x64.3A.20Migrate.20selectif.20and.20selectif_sp.2E.2E.2E.html#292186425">(Aug 05 2022 at 17:44)</a>:</h4>
<p>cfallin created <a href="https://github.com/bytecodealliance/wasmtime/pull/4619#discussion_r939037105">PR review comment</a>:</p>
<blockquote>
<p>Actually after discussing offline with @elliottt it seems that what's on <code>main</code> now is the xor-based approach; the gap is small enough and xor is otherwise the idiomatic way to zero a register (optimized as such by microarchitectures etc) that I think I'd prefer to keep that approach. Thanks for running the benchmarks here!</p>
</blockquote>



<hr><p>Last updated: Jan 20 2025 at 06:04 UTC</p>
</html>