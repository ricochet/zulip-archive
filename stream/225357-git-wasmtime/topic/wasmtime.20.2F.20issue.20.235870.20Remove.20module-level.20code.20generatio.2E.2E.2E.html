<html>
<head><meta charset="utf-8"><title>wasmtime / issue #5870 Remove module-level code generatio... · git-wasmtime · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/index.html">git-wasmtime</a></h2>
<h3>Topic: <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.235870.20Remove.20module-level.20code.20generatio.2E.2E.2E.html">wasmtime / issue #5870 Remove module-level code generatio...</a></h3>

<hr>

<base href="https://bytecodealliance.zulipchat.com">

<head><link href="https://bytecodealliance.github.io/zulip-archive/style.css" rel="stylesheet"></head>

<a name="336359017"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%235870%20Remove%20module-level%20code%20generatio.../near/336359017" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.235870.20Remove.20module-level.20code.20generatio.2E.2E.2E.html#336359017">(Feb 23 2023 at 22:58)</a>:</h4>
<p>elliottt <a href="https://github.com/bytecodealliance/wasmtime/pull/5870#issuecomment-1442540248">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/5870">issue #5870</a>:</p>
<blockquote>
<blockquote>
<p>Thank you, I was just trying to decide what to do about this for #5850.</p>
<p>Have you double-checked the precise-output tests for these backends to make sure that each of these cases is covered? I suspect they are all covered but it'd be nice to make sure while we're thinking about it.</p>
</blockquote>
<p>I had a quick look through the tests I was removing, and @cfallin is right about adding generic cold-block tests. I'll add one to each backend before merging this <span aria-label="+1" class="emoji emoji-1f44d" role="img" title="+1">:+1:</span> </p>
</blockquote>



<a name="336364164"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%235870%20Remove%20module-level%20code%20generatio.../near/336364164" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.235870.20Remove.20module-level.20code.20generatio.2E.2E.2E.html#336364164">(Feb 23 2023 at 23:38)</a>:</h4>
<p>jameysharp <a href="https://github.com/bytecodealliance/wasmtime/pull/5870#issuecomment-1442575700">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/5870">issue #5870</a>:</p>
<blockquote>
<p>Huh. On all backends, this new test produces the same lowered block order, with or without the <code>cold</code> annotation.</p>
<p>In fact as best I can tell, the only difference in generated code between the two cases is that if the <code>cold</code> annotation is used, all backends insert an unreachable "jump" instruction after the "return" and before the cold block. That seems like a bug?</p>
<p>But I think it would also help to have a test which actually produces a different lowering order with the annotation than without.</p>
</blockquote>



<a name="336367739"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%235870%20Remove%20module-level%20code%20generatio.../near/336367739" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.235870.20Remove.20module-level.20code.20generatio.2E.2E.2E.html#336367739">(Feb 24 2023 at 00:09)</a>:</h4>
<p>elliottt <a href="https://github.com/bytecodealliance/wasmtime/pull/5870#issuecomment-1442602063">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/5870">issue #5870</a>:</p>
<blockquote>
<blockquote>
<p>Huh. On all backends, this new test produces the same lowered block order, with or without the <code>cold</code> annotation.</p>
<p>In fact as best I can tell, the only difference in generated code between the two cases is that if the <code>cold</code> annotation is used, all backends insert an unreachable "jump" instruction after the "return" and before the cold block. That seems like a bug?</p>
<p>But I think it would also help to have a test which actually produces a different lowering order with the annotation than without.</p>
</blockquote>
<p>Good call. I've replaced the one I ported from the x64 test with one that is simpler, and easier to show the block order changing with.</p>
</blockquote>



<a name="336374721"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%235870%20Remove%20module-level%20code%20generatio.../near/336374721" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.235870.20Remove.20module-level.20code.20generatio.2E.2E.2E.html#336374721">(Feb 24 2023 at 01:12)</a>:</h4>
<p>elliottt <a href="https://github.com/bytecodealliance/wasmtime/pull/5870#issuecomment-1442653973">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/5870">issue #5870</a>:</p>
<blockquote>
<blockquote>
<p>In fact as best I can tell, the only difference in generated code between the two cases is that if the <code>cold</code> annotation is used, all backends insert an unreachable "jump" instruction after the "return" and before the cold block. That seems like a bug?</p>
</blockquote>
<p>It's unreachable code, that you can see really well when comparing the VCode and disassembly:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="p">;</span><span class="w"> </span><span class="n">VCode</span>:                            <span class="p">;</span><span class="w"> </span><span class="n">Disassembled</span>:
<span class="p">;</span><span class="w">   </span><span class="n">pushq</span><span class="w">   </span><span class="o">%</span><span class="n">rbp</span><span class="w">                    </span><span class="p">;</span><span class="w"> </span><span class="n">block0</span>: <span class="p">;</span><span class="w"> </span><span class="n">offset</span><span class="w"> </span><span class="mh">0x0</span>
<span class="p">;</span><span class="w">   </span><span class="n">movq</span><span class="w">    </span><span class="o">%</span><span class="n">rsp</span><span class="p">,</span><span class="w"> </span><span class="o">%</span><span class="n">rbp</span><span class="w">              </span><span class="p">;</span><span class="w">   </span><span class="n">pushq</span><span class="w"> </span><span class="o">%</span><span class="n">rbp</span>
<span class="p">;</span><span class="w"> </span><span class="n">block0</span>:                           <span class="p">;</span><span class="w">   </span><span class="n">movq</span><span class="w"> </span><span class="o">%</span><span class="n">rsp</span><span class="p">,</span><span class="w"> </span><span class="o">%</span><span class="n">rbp</span>
<span class="p">;</span><span class="w">   </span><span class="n">movq</span><span class="w">    </span><span class="o">%</span><span class="n">rdi</span><span class="p">,</span><span class="w"> </span><span class="o">%</span><span class="n">r11</span><span class="w">              </span><span class="p">;</span><span class="w"> </span><span class="n">block1</span>: <span class="p">;</span><span class="w"> </span><span class="n">offset</span><span class="w"> </span><span class="mh">0x4</span>
<span class="p">;</span><span class="w">   </span><span class="n">addl</span><span class="w">    </span><span class="o">%</span><span class="n">r11d</span><span class="p">,</span><span class="w"> </span><span class="cp">$</span><span class="mi">4660</span><span class="p">,</span><span class="w"> </span><span class="o">%</span><span class="n">r11d</span><span class="w">     </span><span class="p">;</span><span class="w">   </span><span class="n">movq</span><span class="w"> </span><span class="o">%</span><span class="n">rdi</span><span class="p">,</span><span class="w"> </span><span class="o">%</span><span class="n">r11</span>
<span class="p">;</span><span class="w">   </span><span class="n">testl</span><span class="w">   </span><span class="o">%</span><span class="n">r11d</span><span class="p">,</span><span class="w"> </span><span class="o">%</span><span class="n">r11d</span><span class="w">            </span><span class="p">;</span><span class="w">   </span><span class="n">addl</span><span class="w"> </span><span class="cp">$</span><span class="mh">0x1234</span><span class="p">,</span><span class="w"> </span><span class="o">%</span><span class="n">r11d</span>
<span class="p">;</span><span class="w">   </span><span class="n">jnz</span><span class="w">     </span><span class="n">label1</span><span class="p">;</span><span class="w"> </span><span class="n">j</span><span class="w"> </span><span class="n">label2</span><span class="w">        </span><span class="p">;</span><span class="w">   </span><span class="n">testl</span><span class="w"> </span><span class="o">%</span><span class="n">r11d</span><span class="p">,</span><span class="w"> </span><span class="o">%</span><span class="n">r11d</span>
<span class="p">;</span><span class="w"> </span><span class="n">block1</span>:                           <span class="p">;</span><span class="w">   </span><span class="n">je</span><span class="w"> </span><span class="mh">0x39</span>
<span class="p">;</span><span class="w">   </span><span class="n">movq</span><span class="w">    </span><span class="o">%</span><span class="n">r11</span><span class="p">,</span><span class="w"> </span><span class="o">%</span><span class="n">r8</span><span class="w">               </span><span class="p">;</span><span class="w"> </span><span class="n">block2</span>: <span class="p">;</span><span class="w"> </span><span class="n">offset</span><span class="w"> </span><span class="mh">0x17</span>
<span class="p">;</span><span class="w">   </span><span class="n">jmp</span><span class="w">     </span><span class="n">label3</span><span class="w">                  </span><span class="p">;</span><span class="w">   </span><span class="n">movq</span><span class="w"> </span><span class="o">%</span><span class="n">r11</span><span class="p">,</span><span class="w"> </span><span class="o">%</span><span class="n">r8</span>
<span class="p">;</span><span class="w"> </span><span class="n">block3</span>:                           <span class="p">;</span><span class="w"> </span><span class="n">block3</span>: <span class="p">;</span><span class="w"> </span><span class="n">offset</span><span class="w"> </span><span class="mh">0x1a</span>
<span class="p">;</span><span class="w">   </span><span class="n">movq</span><span class="w">    </span><span class="o">%</span><span class="n">r11</span><span class="p">,</span><span class="w"> </span><span class="o">%</span><span class="n">rax</span><span class="w">              </span><span class="p">;</span><span class="w">   </span><span class="n">movq</span><span class="w"> </span><span class="o">%</span><span class="n">r11</span><span class="p">,</span><span class="w"> </span><span class="o">%</span><span class="n">rax</span>
<span class="p">;</span><span class="w">   </span><span class="n">subl</span><span class="w">    </span><span class="o">%</span><span class="n">eax</span><span class="p">,</span><span class="w"> </span><span class="cp">$</span><span class="mi">4660</span><span class="p">,</span><span class="w"> </span><span class="o">%</span><span class="n">eax</span><span class="w">       </span><span class="p">;</span><span class="w">   </span><span class="n">subl</span><span class="w"> </span><span class="cp">$</span><span class="mh">0x1234</span><span class="p">,</span><span class="w"> </span><span class="o">%</span><span class="n">eax</span>
<span class="p">;</span><span class="w">   </span><span class="n">addl</span><span class="w">    </span><span class="o">%</span><span class="n">eax</span><span class="p">,</span><span class="w"> </span><span class="o">%</span><span class="n">r8d</span><span class="p">,</span><span class="w"> </span><span class="o">%</span><span class="n">eax</span><span class="w">        </span><span class="p">;</span><span class="w">   </span><span class="n">addl</span><span class="w"> </span><span class="o">%</span><span class="n">r8d</span><span class="p">,</span><span class="w"> </span><span class="o">%</span><span class="n">eax</span>
<span class="p">;</span><span class="w">   </span><span class="n">testl</span><span class="w">   </span><span class="o">%</span><span class="n">r11d</span><span class="p">,</span><span class="w"> </span><span class="o">%</span><span class="n">r11d</span><span class="w">            </span><span class="p">;</span><span class="w">   </span><span class="n">testl</span><span class="w"> </span><span class="o">%</span><span class="n">r11d</span><span class="p">,</span><span class="w"> </span><span class="o">%</span><span class="n">r11d</span>
<span class="p">;</span><span class="w">   </span><span class="n">jnz</span><span class="w">     </span><span class="n">label4</span><span class="p">;</span><span class="w"> </span><span class="n">j</span><span class="w"> </span><span class="n">label5</span><span class="w">        </span><span class="p">;</span><span class="w">   </span><span class="n">jne</span><span class="w"> </span><span class="mh">0x39</span>
<span class="p">;</span><span class="w"> </span><span class="n">block5</span>:                           <span class="p">;</span><span class="w"> </span><span class="n">block4</span>: <span class="p">;</span><span class="w"> </span><span class="n">offset</span><span class="w"> </span><span class="mh">0x2f</span>
<span class="p">;</span><span class="w">   </span><span class="n">movq</span><span class="w">    </span><span class="o">%</span><span class="n">rbp</span><span class="p">,</span><span class="w"> </span><span class="o">%</span><span class="n">rsp</span><span class="w">              </span><span class="p">;</span><span class="w">   </span><span class="n">movq</span><span class="w"> </span><span class="o">%</span><span class="n">rbp</span><span class="p">,</span><span class="w"> </span><span class="o">%</span><span class="n">rsp</span>
<span class="p">;</span><span class="w">   </span><span class="n">popq</span><span class="w">    </span><span class="o">%</span><span class="n">rbp</span><span class="w">                    </span><span class="p">;</span><span class="w">   </span><span class="n">popq</span><span class="w"> </span><span class="o">%</span><span class="n">rbp</span>
<span class="p">;</span><span class="w">   </span><span class="n">ret</span><span class="w">                             </span><span class="p">;</span><span class="w">   </span><span class="n">retq</span>
<span class="p">;</span><span class="w"> </span><span class="n">block8</span>:                           <span class="p">;</span><span class="w"> </span><span class="n">block5</span>: <span class="p">;</span><span class="w"> </span><span class="n">offset</span><span class="w"> </span><span class="mh">0x34</span>
<span class="p">;</span><span class="w">   </span><span class="n">jmp</span><span class="w">     </span><span class="n">label3</span><span class="w">                  </span><span class="p">;</span><span class="w">   </span><span class="n">jmp</span><span class="w"> </span><span class="mh">0x1a</span>
<span class="p">;</span><span class="w"> </span><span class="n">block2</span>:                           <span class="p">;</span><span class="w"> </span><span class="n">block6</span>: <span class="p">;</span><span class="w"> </span><span class="n">offset</span><span class="w"> </span><span class="mh">0x39</span>
<span class="p">;</span><span class="w">   </span><span class="n">jmp</span><span class="w">     </span><span class="n">label6</span><span class="w">                  </span><span class="p">;</span><span class="w">   </span><span class="n">movq</span><span class="w"> </span><span class="o">%</span><span class="n">r11</span><span class="p">,</span><span class="w"> </span><span class="o">%</span><span class="n">r8</span>
<span class="p">;</span><span class="w"> </span><span class="n">block4</span>:                           <span class="p">;</span><span class="w">   </span><span class="n">addl</span><span class="w"> </span><span class="cp">$</span><span class="mh">0x1234</span><span class="p">,</span><span class="w"> </span><span class="o">%</span><span class="n">r8d</span>
<span class="p">;</span><span class="w">   </span><span class="n">jmp</span><span class="w">     </span><span class="n">label6</span><span class="w">                  </span><span class="p">;</span><span class="w">   </span><span class="n">testl</span><span class="w"> </span><span class="o">%</span><span class="n">r8d</span><span class="p">,</span><span class="w"> </span><span class="o">%</span><span class="n">r8d</span>
<span class="p">;</span><span class="w"> </span><span class="n">block6</span>:                           <span class="p">;</span><span class="w">   </span><span class="n">je</span><span class="w"> </span><span class="mh">0x1a</span>
<span class="p">;</span><span class="w">   </span><span class="n">movq</span><span class="w">    </span><span class="o">%</span><span class="n">r11</span><span class="p">,</span><span class="w"> </span><span class="o">%</span><span class="n">r8</span><span class="w">               </span><span class="p">;</span><span class="w"> </span><span class="n">block7</span>: <span class="p">;</span><span class="w"> </span><span class="n">offset</span><span class="w"> </span><span class="mh">0x4c</span>
<span class="p">;</span><span class="w">   </span><span class="n">addl</span><span class="w">    </span><span class="o">%</span><span class="n">r8d</span><span class="p">,</span><span class="w"> </span><span class="cp">$</span><span class="mi">4660</span><span class="p">,</span><span class="w"> </span><span class="o">%</span><span class="n">r8d</span><span class="w">       </span><span class="p">;</span><span class="w">   </span><span class="n">jmp</span><span class="w"> </span><span class="mh">0x39</span>
<span class="p">;</span><span class="w">   </span><span class="n">testl</span><span class="w">   </span><span class="o">%</span><span class="n">r8d</span><span class="p">,</span><span class="w"> </span><span class="o">%</span><span class="n">r8d</span>
<span class="p">;</span><span class="w">   </span><span class="n">jnz</span><span class="w">     </span><span class="n">label7</span><span class="p">;</span><span class="w"> </span><span class="n">j</span><span class="w"> </span><span class="n">label8</span>
<span class="p">;</span><span class="w"> </span><span class="n">block7</span>:
<span class="p">;</span><span class="w">   </span><span class="n">jmp</span><span class="w">     </span><span class="n">label6</span>
</code></pre></div>
<p>I think we could fix this pretty easily in the machinst buffer, but we might need to track a little bit of additional state to know when blocks are unreachable.</p>
</blockquote>



<a name="336374933"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%235870%20Remove%20module-level%20code%20generatio.../near/336374933" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.235870.20Remove.20module-level.20code.20generatio.2E.2E.2E.html#336374933">(Feb 24 2023 at 01:15)</a>:</h4>
<p>elliottt edited a <a href="https://github.com/bytecodealliance/wasmtime/pull/5870#issuecomment-1442653973">comment</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/5870">issue #5870</a>:</p>
<blockquote>
<blockquote>
<p>In fact as best I can tell, the only difference in generated code between the two cases is that if the <code>cold</code> annotation is used, all backends insert an unreachable "jump" instruction after the "return" and before the cold block. That seems like a bug?</p>
</blockquote>
<p>It's unreachable code, that you can see really well when comparing the VCode and disassembly. VCode block8 is disassembled block5, and the unconditional jump in block6 in the VCode to block8 got inlined, the original condition got inverted, and the final jump went back to <code>block6</code> again.</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="p">;</span><span class="w"> </span><span class="n">VCode</span>:                            <span class="p">;</span><span class="w"> </span><span class="n">Disassembled</span>:
<span class="p">;</span><span class="w">   </span><span class="n">pushq</span><span class="w">   </span><span class="o">%</span><span class="n">rbp</span><span class="w">                    </span><span class="p">;</span><span class="w"> </span><span class="n">block0</span>: <span class="p">;</span><span class="w"> </span><span class="n">offset</span><span class="w"> </span><span class="mh">0x0</span>
<span class="p">;</span><span class="w">   </span><span class="n">movq</span><span class="w">    </span><span class="o">%</span><span class="n">rsp</span><span class="p">,</span><span class="w"> </span><span class="o">%</span><span class="n">rbp</span><span class="w">              </span><span class="p">;</span><span class="w">   </span><span class="n">pushq</span><span class="w"> </span><span class="o">%</span><span class="n">rbp</span>
<span class="p">;</span><span class="w"> </span><span class="n">block0</span>:                           <span class="p">;</span><span class="w">   </span><span class="n">movq</span><span class="w"> </span><span class="o">%</span><span class="n">rsp</span><span class="p">,</span><span class="w"> </span><span class="o">%</span><span class="n">rbp</span>
<span class="p">;</span><span class="w">   </span><span class="n">movq</span><span class="w">    </span><span class="o">%</span><span class="n">rdi</span><span class="p">,</span><span class="w"> </span><span class="o">%</span><span class="n">r11</span><span class="w">              </span><span class="p">;</span><span class="w"> </span><span class="n">block1</span>: <span class="p">;</span><span class="w"> </span><span class="n">offset</span><span class="w"> </span><span class="mh">0x4</span>
<span class="p">;</span><span class="w">   </span><span class="n">addl</span><span class="w">    </span><span class="o">%</span><span class="n">r11d</span><span class="p">,</span><span class="w"> </span><span class="cp">$</span><span class="mi">4660</span><span class="p">,</span><span class="w"> </span><span class="o">%</span><span class="n">r11d</span><span class="w">     </span><span class="p">;</span><span class="w">   </span><span class="n">movq</span><span class="w"> </span><span class="o">%</span><span class="n">rdi</span><span class="p">,</span><span class="w"> </span><span class="o">%</span><span class="n">r11</span>
<span class="p">;</span><span class="w">   </span><span class="n">testl</span><span class="w">   </span><span class="o">%</span><span class="n">r11d</span><span class="p">,</span><span class="w"> </span><span class="o">%</span><span class="n">r11d</span><span class="w">            </span><span class="p">;</span><span class="w">   </span><span class="n">addl</span><span class="w"> </span><span class="cp">$</span><span class="mh">0x1234</span><span class="p">,</span><span class="w"> </span><span class="o">%</span><span class="n">r11d</span>
<span class="p">;</span><span class="w">   </span><span class="n">jnz</span><span class="w">     </span><span class="n">label1</span><span class="p">;</span><span class="w"> </span><span class="n">j</span><span class="w"> </span><span class="n">label2</span><span class="w">        </span><span class="p">;</span><span class="w">   </span><span class="n">testl</span><span class="w"> </span><span class="o">%</span><span class="n">r11d</span><span class="p">,</span><span class="w"> </span><span class="o">%</span><span class="n">r11d</span>
<span class="p">;</span><span class="w"> </span><span class="n">block1</span>:                           <span class="p">;</span><span class="w">   </span><span class="n">je</span><span class="w"> </span><span class="mh">0x39</span>
<span class="p">;</span><span class="w">   </span><span class="n">movq</span><span class="w">    </span><span class="o">%</span><span class="n">r11</span><span class="p">,</span><span class="w"> </span><span class="o">%</span><span class="n">r8</span><span class="w">               </span><span class="p">;</span><span class="w"> </span><span class="n">block2</span>: <span class="p">;</span><span class="w"> </span><span class="n">offset</span><span class="w"> </span><span class="mh">0x17</span>
<span class="p">;</span><span class="w">   </span><span class="n">jmp</span><span class="w">     </span><span class="n">label3</span><span class="w">                  </span><span class="p">;</span><span class="w">   </span><span class="n">movq</span><span class="w"> </span><span class="o">%</span><span class="n">r11</span><span class="p">,</span><span class="w"> </span><span class="o">%</span><span class="n">r8</span>
<span class="p">;</span><span class="w"> </span><span class="n">block3</span>:                           <span class="p">;</span><span class="w"> </span><span class="n">block3</span>: <span class="p">;</span><span class="w"> </span><span class="n">offset</span><span class="w"> </span><span class="mh">0x1a</span>
<span class="p">;</span><span class="w">   </span><span class="n">movq</span><span class="w">    </span><span class="o">%</span><span class="n">r11</span><span class="p">,</span><span class="w"> </span><span class="o">%</span><span class="n">rax</span><span class="w">              </span><span class="p">;</span><span class="w">   </span><span class="n">movq</span><span class="w"> </span><span class="o">%</span><span class="n">r11</span><span class="p">,</span><span class="w"> </span><span class="o">%</span><span class="n">rax</span>
<span class="p">;</span><span class="w">   </span><span class="n">subl</span><span class="w">    </span><span class="o">%</span><span class="n">eax</span><span class="p">,</span><span class="w"> </span><span class="cp">$</span><span class="mi">4660</span><span class="p">,</span><span class="w"> </span><span class="o">%</span><span class="n">eax</span><span class="w">       </span><span class="p">;</span><span class="w">   </span><span class="n">subl</span><span class="w"> </span><span class="cp">$</span><span class="mh">0x1234</span><span class="p">,</span><span class="w"> </span><span class="o">%</span><span class="n">eax</span>
<span class="p">;</span><span class="w">   </span><span class="n">addl</span><span class="w">    </span><span class="o">%</span><span class="n">eax</span><span class="p">,</span><span class="w"> </span><span class="o">%</span><span class="n">r8d</span><span class="p">,</span><span class="w"> </span><span class="o">%</span><span class="n">eax</span><span class="w">        </span><span class="p">;</span><span class="w">   </span><span class="n">addl</span><span class="w"> </span><span class="o">%</span><span class="n">r8d</span><span class="p">,</span><span class="w"> </span><span class="o">%</span><span class="n">eax</span>
<span class="p">;</span><span class="w">   </span><span class="n">testl</span><span class="w">   </span><span class="o">%</span><span class="n">r11d</span><span class="p">,</span><span class="w"> </span><span class="o">%</span><span class="n">r11d</span><span class="w">            </span><span class="p">;</span><span class="w">   </span><span class="n">testl</span><span class="w"> </span><span class="o">%</span><span class="n">r11d</span><span class="p">,</span><span class="w"> </span><span class="o">%</span><span class="n">r11d</span>
<span class="p">;</span><span class="w">   </span><span class="n">jnz</span><span class="w">     </span><span class="n">label4</span><span class="p">;</span><span class="w"> </span><span class="n">j</span><span class="w"> </span><span class="n">label5</span><span class="w">        </span><span class="p">;</span><span class="w">   </span><span class="n">jne</span><span class="w"> </span><span class="mh">0x39</span>
<span class="p">;</span><span class="w"> </span><span class="n">block5</span>:                           <span class="p">;</span><span class="w"> </span><span class="n">block4</span>: <span class="p">;</span><span class="w"> </span><span class="n">offset</span><span class="w"> </span><span class="mh">0x2f</span>
<span class="p">;</span><span class="w">   </span><span class="n">movq</span><span class="w">    </span><span class="o">%</span><span class="n">rbp</span><span class="p">,</span><span class="w"> </span><span class="o">%</span><span class="n">rsp</span><span class="w">              </span><span class="p">;</span><span class="w">   </span><span class="n">movq</span><span class="w"> </span><span class="o">%</span><span class="n">rbp</span><span class="p">,</span><span class="w"> </span><span class="o">%</span><span class="n">rsp</span>
<span class="p">;</span><span class="w">   </span><span class="n">popq</span><span class="w">    </span><span class="o">%</span><span class="n">rbp</span><span class="w">                    </span><span class="p">;</span><span class="w">   </span><span class="n">popq</span><span class="w"> </span><span class="o">%</span><span class="n">rbp</span>
<span class="p">;</span><span class="w">   </span><span class="n">ret</span><span class="w">                             </span><span class="p">;</span><span class="w">   </span><span class="n">retq</span>
<span class="p">;</span><span class="w"> </span><span class="n">block8</span>:                           <span class="p">;</span><span class="w"> </span><span class="n">block5</span>: <span class="p">;</span><span class="w"> </span><span class="n">offset</span><span class="w"> </span><span class="mh">0x34</span>
<span class="p">;</span><span class="w">   </span><span class="n">jmp</span><span class="w">     </span><span class="n">label3</span><span class="w">                  </span><span class="p">;</span><span class="w">   </span><span class="n">jmp</span><span class="w"> </span><span class="mh">0x1a</span>
<span class="p">;</span><span class="w"> </span><span class="n">block2</span>:                           <span class="p">;</span><span class="w"> </span><span class="n">block6</span>: <span class="p">;</span><span class="w"> </span><span class="n">offset</span><span class="w"> </span><span class="mh">0x39</span>
<span class="p">;</span><span class="w">   </span><span class="n">jmp</span><span class="w">     </span><span class="n">label6</span><span class="w">                  </span><span class="p">;</span><span class="w">   </span><span class="n">movq</span><span class="w"> </span><span class="o">%</span><span class="n">r11</span><span class="p">,</span><span class="w"> </span><span class="o">%</span><span class="n">r8</span>
<span class="p">;</span><span class="w"> </span><span class="n">block4</span>:                           <span class="p">;</span><span class="w">   </span><span class="n">addl</span><span class="w"> </span><span class="cp">$</span><span class="mh">0x1234</span><span class="p">,</span><span class="w"> </span><span class="o">%</span><span class="n">r8d</span>
<span class="p">;</span><span class="w">   </span><span class="n">jmp</span><span class="w">     </span><span class="n">label6</span><span class="w">                  </span><span class="p">;</span><span class="w">   </span><span class="n">testl</span><span class="w"> </span><span class="o">%</span><span class="n">r8d</span><span class="p">,</span><span class="w"> </span><span class="o">%</span><span class="n">r8d</span>
<span class="p">;</span><span class="w"> </span><span class="n">block6</span>:                           <span class="p">;</span><span class="w">   </span><span class="n">je</span><span class="w"> </span><span class="mh">0x1a</span>
<span class="p">;</span><span class="w">   </span><span class="n">movq</span><span class="w">    </span><span class="o">%</span><span class="n">r11</span><span class="p">,</span><span class="w"> </span><span class="o">%</span><span class="n">r8</span><span class="w">               </span><span class="p">;</span><span class="w"> </span><span class="n">block7</span>: <span class="p">;</span><span class="w"> </span><span class="n">offset</span><span class="w"> </span><span class="mh">0x4c</span>
<span class="p">;</span><span class="w">   </span><span class="n">addl</span><span class="w">    </span><span class="o">%</span><span class="n">r8d</span><span class="p">,</span><span class="w"> </span><span class="cp">$</span><span class="mi">4660</span><span class="p">,</span><span class="w"> </span><span class="o">%</span><span class="n">r8d</span><span class="w">       </span><span class="p">;</span><span class="w">   </span><span class="n">jmp</span><span class="w"> </span><span class="mh">0x39</span>
<span class="p">;</span><span class="w">   </span><span class="n">testl</span><span class="w">   </span><span class="o">%</span><span class="n">r8d</span><span class="p">,</span><span class="w"> </span><span class="o">%</span><span class="n">r8d</span>
<span class="p">;</span><span class="w">   </span><span class="n">jnz</span><span class="w">     </span><span class="n">label7</span><span class="p">;</span><span class="w"> </span><span class="n">j</span><span class="w"> </span><span class="n">label8</span>
<span class="p">;</span><span class="w"> </span><span class="n">block7</span>:
<span class="p">;</span><span class="w">   </span><span class="n">jmp</span><span class="w">     </span><span class="n">label6</span>
</code></pre></div>
<p>I think we could fix this pretty easily in the machinst buffer, but we might need to track a little bit of additional state to know when blocks are unreachable.</p>
</blockquote>



<a name="336374962"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%235870%20Remove%20module-level%20code%20generatio.../near/336374962" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.235870.20Remove.20module-level.20code.20generatio.2E.2E.2E.html#336374962">(Feb 24 2023 at 01:15)</a>:</h4>
<p>jameysharp <a href="https://github.com/bytecodealliance/wasmtime/pull/5870#issuecomment-1442656074">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/5870">issue #5870</a>:</p>
<blockquote>
<p>Yes, this version of the cold-block tests looks great! I think "if-then triangle" CFG is perfect for this.</p>
</blockquote>



<a name="336375564"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%235870%20Remove%20module-level%20code%20generatio.../near/336375564" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.235870.20Remove.20module-level.20code.20generatio.2E.2E.2E.html#336375564">(Feb 24 2023 at 01:22)</a>:</h4>
<p>cfallin <a href="https://github.com/bytecodealliance/wasmtime/pull/5870#issuecomment-1442661253">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/5870">issue #5870</a>:</p>
<blockquote>
<blockquote>
<p>I think we could fix this pretty easily in the machinst buffer, but we might need to track a little bit of additional state to know when blocks are unreachable.</p>
</blockquote>
<p>To add a little more detail to that: removing the dead block at the MachBuffer level would require the MachBuffer to know about instructions other than branches (here, a return instruction that makes the following block unreachable); in the original MachBuffer design that was an explicit anti-goal, for simplicity.</p>
<p>Now that we're at more of a "polish the mature code" stage of development, I think it'd be totally reasonable to give the MachBuffer a notion of explicit "informed unreachability": the emitter could invoke a method like <code>.mark_unreachable()</code> after a return, similar in spirit to how it informs the MachBuffer about branches.</p>
<p>The tricky part is weaving that into the existing mechanism, and updating the correctness proof accordingly. It probably implies a new kind of record in the "latest branch" list. Unreachability is currently implicitly recognized as a property that follows an unconditional branch instead.</p>
<p>All that said, I don't think this is the highest-priority change: these blocks could impact icache pressure by increasing code size a little, but are dead, i.e. not actually executed. Still, the above is the place to start if someone wants to tackle it!</p>
</blockquote>



<hr><p>Last updated: Jan 20 2025 at 06:04 UTC</p>
</html>