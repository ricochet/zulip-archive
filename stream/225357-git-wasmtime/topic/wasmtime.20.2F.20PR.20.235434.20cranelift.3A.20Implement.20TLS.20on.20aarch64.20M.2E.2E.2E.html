<html>
<head><meta charset="utf-8"><title>wasmtime / PR #5434 cranelift: Implement TLS on aarch64 M... · git-wasmtime · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/index.html">git-wasmtime</a></h2>
<h3>Topic: <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.235434.20cranelift.3A.20Implement.20TLS.20on.20aarch64.20M.2E.2E.2E.html">wasmtime / PR #5434 cranelift: Implement TLS on aarch64 M...</a></h3>

<hr>

<base href="https://bytecodealliance.zulipchat.com">

<head><link href="https://bytecodealliance.github.io/zulip-archive/style.css" rel="stylesheet"></head>

<a name="315726366"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%235434%20cranelift%3A%20Implement%20TLS%20on%20aarch64%20M.../near/315726366" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.235434.20cranelift.3A.20Implement.20TLS.20on.20aarch64.20M.2E.2E.2E.html#315726366">(Dec 14 2022 at 02:44)</a>:</h4>
<p>nathanwhit opened <a href="https://github.com/bytecodealliance/wasmtime/pull/5434">PR #5434</a> from <code>aarch64-macho-support-tls</code> to <code>main</code>:</p>
<blockquote>
<p>&lt;!--</p>
<p>Please ensure that the following steps are all taken care of before submitting<br>
the PR.</p>
<ul>
<li>
<p>[ ] This has been discussed in issue #..., or if not, please tell us why<br>
  here.</p>
</li>
<li>
<p>[ ] A short description of what this does, why it is needed; if the<br>
  description becomes long, the matter should probably be discussed in an issue<br>
  first.</p>
</li>
<li>
<p>[ ] This PR contains test cases, if meaningful.</p>
</li>
<li>[ ] A reviewer from the core maintainer team has been assigned for this PR.<br>
  If you don't know who could review this, please indicate so. The list of<br>
  suggested reviewers on the right can help you.</li>
</ul>
<p>Please ensure all communication adheres to the <a href="https://github.com/bytecodealliance/wasmtime/blob/master/CODE_OF_CONDUCT.md">code of
conduct</a>.<br>
--&gt;<br>
Fixes #5433.</p>
<p>This PR implements support for TLS on aarch64 Mach-O (i.e. Apple silicon). This also includes an update to <code>object</code> as this PR depends on a fix released in <code>object 0.30</code>.</p>
<p>For testing, I've added a filetest similar to the existing test for aarch64 ELF. I wasn't sure if I should add an emit test as well, since there doesn't seem to be one for TLS on aarch64 ELF. I've also tested these changes on a local branch of cg_clif, and it passes the TLS tests there.</p>
</blockquote>



<a name="315727599"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%235434%20cranelift%3A%20Implement%20TLS%20on%20aarch64%20M.../near/315727599" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.235434.20cranelift.3A.20Implement.20TLS.20on.20aarch64.20M.2E.2E.2E.html#315727599">(Dec 14 2022 at 03:01)</a>:</h4>
<p>cfallin submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/5434#pullrequestreview-1216705645">PR review</a>.</p>



<a name="315727600"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%235434%20cranelift%3A%20Implement%20TLS%20on%20aarch64%20M.../near/315727600" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.235434.20cranelift.3A.20Implement.20TLS.20on.20aarch64.20M.2E.2E.2E.html#315727600">(Dec 14 2022 at 03:01)</a>:</h4>
<p>cfallin submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/5434#pullrequestreview-1216705645">PR review</a>.</p>



<a name="315727601"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%235434%20cranelift%3A%20Implement%20TLS%20on%20aarch64%20M.../near/315727601" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.235434.20cranelift.3A.20Implement.20TLS.20on.20aarch64.20M.2E.2E.2E.html#315727601">(Dec 14 2022 at 03:01)</a>:</h4>
<p>cfallin created <a href="https://github.com/bytecodealliance/wasmtime/pull/5434#discussion_r1047962436">PR review comment</a>:</p>
<blockquote>
<p>The <code>has_type</code> clause shouldn't be necessary here if <code>(if (tls_model_is_elf_gd))</code> below is present, or vice-versa. I'm guessing you were running into rule-overlap issues (the checker doesn't know that <code>tls_model_is_elf_gd</code> and <code>tls_model_is_macho</code> are mutually exclusive, but it can distinguish the <code>TlsModel</code> enum arms)? Either adding rule priorities (<code>(rule 1 ...)</code> and <code>(rule 0 ...)</code>) with the <code>if</code> clauses, or keeping the <code>(has_type (tls_model ...))</code> only, would work. It looks like in x64 we did the latter so let's do that here too for consistency :-)</p>
</blockquote>



<a name="315727602"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%235434%20cranelift%3A%20Implement%20TLS%20on%20aarch64%20M.../near/315727602" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.235434.20cranelift.3A.20Implement.20TLS.20on.20aarch64.20M.2E.2E.2E.html#315727602">(Dec 14 2022 at 03:01)</a>:</h4>
<p>cfallin created <a href="https://github.com/bytecodealliance/wasmtime/pull/5434#discussion_r1047960205">PR review comment</a>:</p>
<blockquote>
<p><code>uses</code> and <code>defs</code> and <code>clobbers</code> can all be empty here, as this emission happens after regalloc runs so we don't need any of this metadata.</p>
</blockquote>



<a name="315727603"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%235434%20cranelift%3A%20Implement%20TLS%20on%20aarch64%20M.../near/315727603" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.235434.20cranelift.3A.20Implement.20TLS.20on.20aarch64.20M.2E.2E.2E.html#315727603">(Dec 14 2022 at 03:01)</a>:</h4>
<p>cfallin created <a href="https://github.com/bytecodealliance/wasmtime/pull/5434#discussion_r1047958142">PR review comment</a>:</p>
<blockquote>
<p>s/AAarch64/Aarch64/ (and in comment below too)</p>
</blockquote>



<a name="315729241"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%235434%20cranelift%3A%20Implement%20TLS%20on%20aarch64%20M.../near/315729241" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.235434.20cranelift.3A.20Implement.20TLS.20on.20aarch64.20M.2E.2E.2E.html#315729241">(Dec 14 2022 at 03:23)</a>:</h4>
<p>cfallin updated <a href="https://github.com/bytecodealliance/wasmtime/pull/5434">PR #5434</a> from <code>aarch64-macho-support-tls</code> to <code>main</code>.</p>



<a name="315943382"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%235434%20cranelift%3A%20Implement%20TLS%20on%20aarch64%20M.../near/315943382" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.235434.20cranelift.3A.20Implement.20TLS.20on.20aarch64.20M.2E.2E.2E.html#315943382">(Dec 15 2022 at 01:00)</a>:</h4>
<p>nathanwhit updated <a href="https://github.com/bytecodealliance/wasmtime/pull/5434">PR #5434</a> from <code>aarch64-macho-support-tls</code> to <code>main</code>.</p>



<a name="315944739"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%235434%20cranelift%3A%20Implement%20TLS%20on%20aarch64%20M.../near/315944739" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.235434.20cranelift.3A.20Implement.20TLS.20on.20aarch64.20M.2E.2E.2E.html#315944739">(Dec 15 2022 at 01:19)</a>:</h4>
<p>cfallin submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/5434#pullrequestreview-1218462652">PR review</a>.</p>



<a name="315944740"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%235434%20cranelift%3A%20Implement%20TLS%20on%20aarch64%20M.../near/315944740" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.235434.20cranelift.3A.20Implement.20TLS.20on.20aarch64.20M.2E.2E.2E.html#315944740">(Dec 15 2022 at 01:19)</a>:</h4>
<p>cfallin submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/5434#pullrequestreview-1218462652">PR review</a>.</p>



<a name="315944741"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%235434%20cranelift%3A%20Implement%20TLS%20on%20aarch64%20M.../near/315944741" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.235434.20cranelift.3A.20Implement.20TLS.20on.20aarch64.20M.2E.2E.2E.html#315944741">(Dec 15 2022 at 01:19)</a>:</h4>
<p>cfallin created <a href="https://github.com/bytecodealliance/wasmtime/pull/5434#discussion_r1049122033">PR review comment</a>:</p>
<blockquote>
<p>We probably don't want to increase the size of <code>Inst</code> if we can help it at all -- the point of this test is to guard against perf regressions. Can we find a way to remove a field or, failing that, box the contents of the inst? Two options come to mind:</p>
<ul>
<li>(Maybe preferred) eliminate <code>rtmp</code>, and use <code>x1</code> explicitly instead. This is part of the clobber-set of the call already, so it should be legal to use it to hold the address of the called function.</li>
<li>(Alternately) create a struct and hold a <code>Box</code> in the inst, taking only 8 bytes</li>
</ul>
</blockquote>



<a name="315948632"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%235434%20cranelift%3A%20Implement%20TLS%20on%20aarch64%20M.../near/315948632" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.235434.20cranelift.3A.20Implement.20TLS.20on.20aarch64.20M.2E.2E.2E.html#315948632">(Dec 15 2022 at 02:20)</a>:</h4>
<p>nathanwhit updated <a href="https://github.com/bytecodealliance/wasmtime/pull/5434">PR #5434</a> from <code>aarch64-macho-support-tls</code> to <code>main</code>.</p>



<a name="315948633"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%235434%20cranelift%3A%20Implement%20TLS%20on%20aarch64%20M.../near/315948633" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.235434.20cranelift.3A.20Implement.20TLS.20on.20aarch64.20M.2E.2E.2E.html#315948633">(Dec 15 2022 at 02:20)</a>:</h4>
<p>nathanwhit submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/5434#pullrequestreview-1218498011">PR review</a>.</p>



<a name="315948634"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%235434%20cranelift%3A%20Implement%20TLS%20on%20aarch64%20M.../near/315948634" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.235434.20cranelift.3A.20Implement.20TLS.20on.20aarch64.20M.2E.2E.2E.html#315948634">(Dec 15 2022 at 02:20)</a>:</h4>
<p>nathanwhit created <a href="https://github.com/bytecodealliance/wasmtime/pull/5434#discussion_r1049150083">PR review comment</a>:</p>
<blockquote>
<p>Ah, I wasn't sure that it was okay to use <code>x1</code>, but your explanation makes sense (and helped clear up my confusion) - thanks!</p>
<p>Just pushed a commit to make that change (and reverted the change to the size test as well)</p>
</blockquote>



<a name="326717162"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%235434%20cranelift%3A%20Implement%20TLS%20on%20aarch64%20M.../near/326717162" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.235434.20cranelift.3A.20Implement.20TLS.20on.20aarch64.20M.2E.2E.2E.html#326717162">(Feb 09 2023 at 01:42)</a>:</h4>
<p>nathanwhit updated <a href="https://github.com/bytecodealliance/wasmtime/pull/5434">PR #5434</a> from <code>aarch64-macho-support-tls</code> to <code>main</code>.</p>



<a name="344327324"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%235434%20cranelift%3A%20Implement%20TLS%20on%20aarch64%20M.../near/344327324" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.235434.20cranelift.3A.20Implement.20TLS.20on.20aarch64.20M.2E.2E.2E.html#344327324">(Mar 24 2023 at 17:19)</a>:</h4>
<p>nathanwhit updated <a href="https://github.com/bytecodealliance/wasmtime/pull/5434">PR #5434</a> from <code>aarch64-macho-support-tls</code> to <code>main</code>.</p>



<a name="344341555"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%235434%20cranelift%3A%20Implement%20TLS%20on%20aarch64%20M.../near/344341555" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.235434.20cranelift.3A.20Implement.20TLS.20on.20aarch64.20M.2E.2E.2E.html#344341555">(Mar 24 2023 at 18:27)</a>:</h4>
<p>cfallin merged <a href="https://github.com/bytecodealliance/wasmtime/pull/5434">PR #5434</a>.</p>



<hr><p>Last updated: Jan 20 2025 at 06:04 UTC</p>
</html>