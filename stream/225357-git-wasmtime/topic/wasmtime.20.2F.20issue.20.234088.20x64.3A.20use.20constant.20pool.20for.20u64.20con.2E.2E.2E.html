<html>
<head><meta charset="utf-8"><title>wasmtime / issue #4088 x64: use constant pool for u64 con... · git-wasmtime · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/index.html">git-wasmtime</a></h2>
<h3>Topic: <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.234088.20x64.3A.20use.20constant.20pool.20for.20u64.20con.2E.2E.2E.html">wasmtime / issue #4088 x64: use constant pool for u64 con...</a></h3>

<hr>

<base href="https://bytecodealliance.zulipchat.com">

<head><link href="https://bytecodealliance.github.io/zulip-archive/style.css" rel="stylesheet"></head>

<a name="280589514"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%234088%20x64%3A%20use%20constant%20pool%20for%20u64%20con.../near/280589514" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.234088.20x64.3A.20use.20constant.20pool.20for.20u64.20con.2E.2E.2E.html#280589514">(Apr 29 2022 at 05:56)</a>:</h4>
<p>cfallin <a href="https://github.com/bytecodealliance/wasmtime/pull/4088#issuecomment-1112901593">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/4088">issue #4088</a>:</p>
<blockquote>
<p>(For context for those not already deeply lost in the depths of the x64 backend, the <code>movabs</code> lowering for immediates happens when the value doesn't fit in a signed 32-bit immediate field that most reg/mem/immediate operands support. So this sort of code would not appear when doing arithmetic on small integers, but appears all the time when 64-bit bitmasks are involved, e.g. in SpiderMonkey's NaN-(un)boxing sequences.)</p>
</blockquote>



<a name="280590261"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%234088%20x64%3A%20use%20constant%20pool%20for%20u64%20con.../near/280590261" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.234088.20x64.3A.20use.20constant.20pool.20for.20u64.20con.2E.2E.2E.html#280590261">(Apr 29 2022 at 06:09)</a>:</h4>
<p>github-actions[bot] <a href="https://github.com/bytecodealliance/wasmtime/pull/4088#issuecomment-1112907821">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/4088">issue #4088</a>:</p>
<blockquote>
<h4>Subscribe to Label Action</h4>
<p>cc @cfallin, @fitzgen</p>
<p>&lt;details&gt;<br>
This issue or pull request has been labeled: "cranelift", "cranelift:area:aarch64", "cranelift:area:machinst", "cranelift:area:x64", "isle"</p>
<p>Thus the following users have been cc'd because of the following labels:</p>
<ul>
<li>cfallin: isle</li>
<li>fitzgen: isle</li>
</ul>
<p>To subscribe or unsubscribe from this label, edit the &lt;code&gt;.github/subscribe-to-label.json&lt;/code&gt; configuration file.</p>
<p><a href="https://github.com/bytecodealliance/subscribe-to-label-action">Learn more.</a><br>
&lt;/details&gt;</p>
</blockquote>



<a name="280613046"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%234088%20x64%3A%20use%20constant%20pool%20for%20u64%20con.../near/280613046" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.234088.20x64.3A.20use.20constant.20pool.20for.20u64.20con.2E.2E.2E.html#280613046">(Apr 29 2022 at 10:22)</a>:</h4>
<p>bjorn3 <a href="https://github.com/bytecodealliance/wasmtime/pull/4088#issuecomment-1113148135">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/4088">issue #4088</a>:</p>
<blockquote>
<p>How will this affect disassemblers? I presume they would try to interpret the constant pool as instructions and due to the varying size of x86 instructions completely mess up disassembly of instructions following the constant pool, right? Would it be an option to allow disabling the constant pool usage?</p>
</blockquote>



<a name="280661474"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%234088%20x64%3A%20use%20constant%20pool%20for%20u64%20con.../near/280661474" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.234088.20x64.3A.20use.20constant.20pool.20for.20u64.20con.2E.2E.2E.html#280661474">(Apr 29 2022 at 17:09)</a>:</h4>
<p>cfallin <a href="https://github.com/bytecodealliance/wasmtime/pull/4088#issuecomment-1113537911">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/4088">issue #4088</a>:</p>
<blockquote>
<blockquote>
<p>How will this affect disassemblers? I presume they would try to interpret the constant pool as instructions and due to the varying size of x86 instructions completely mess up disassembly of instructions following the constant pool, right? Would it be an option to allow disabling the constant pool usage?</p>
</blockquote>
<p>@bjorn3 most disassemblers will sync to function boundaries at least (if they have that metadata, e.g. with an ELF image), so the constant pool at the end will at worst become garbage instructions after the final <code>ret</code>.</p>
<p>I do agree it'd be better to put the constants somewhere else if possible (in <code>.rodata</code> or at least between functions, outside of the ranges/function body sizes specified by metadata) -- but two factors work against this:</p>
<ul>
<li>Our per-function compilation strategy means that we would need a separate pass at the end to collect all constant pools, and do fixups for rip-relative references at that point. Right now with per-function constant pools each function body is completely independent and has no relocs for constant references.</li>
<li>On some platforms (e.g. aarch64) the available range for constant references is limited (+/- 128MiB, IIRC), so we need at least the possibility of constant pools among/between functions as well as in a separate <code>.rodata</code>. And as long as we're doing that, it's simpler to adopt a strategy that always works (constants per function, with <code>MachBuffer</code>'s constant-island handling) rather than choose between strategies and have a rarely-used path (i.e., less well-tested).</li>
</ul>
<p>And finally I'll note that we have constant pools already, for SIMD constants; this PR is expanding their use, not introducing them at all.</p>
</blockquote>



<a name="280662377"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%234088%20x64%3A%20use%20constant%20pool%20for%20u64%20con.../near/280662377" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.234088.20x64.3A.20use.20constant.20pool.20for.20u64.20con.2E.2E.2E.html#280662377">(Apr 29 2022 at 17:17)</a>:</h4>
<p>bjorn3 <a href="https://github.com/bytecodealliance/wasmtime/pull/4088#issuecomment-1113544837">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/4088">issue #4088</a>:</p>
<blockquote>
<blockquote>
<p>@bjorn3 most disassemblers will sync to function boundaries at least (if they have that metadata, e.g. with an ELF image), so the constant pool at the end will at worst become garbage instructions after the final ret.</p>
</blockquote>
<p>This PR doesn't put the constant pool in the middle in case of large functions like it does for AArch64?</p>
<blockquote>
<p>On some platforms (e.g. aarch64) the available range for constant references is limited (+/- 128MiB, IIRC)</p>
</blockquote>
<p>For AArch64 it is less of an issue due to the instructions having a fixed size and thus there being no risk of the disassembler desyncing for as long as the constant pool size is a multiple of the instruction length.</p>
</blockquote>



<a name="280662760"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%234088%20x64%3A%20use%20constant%20pool%20for%20u64%20con.../near/280662760" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.234088.20x64.3A.20use.20constant.20pool.20for.20u64.20con.2E.2E.2E.html#280662760">(Apr 29 2022 at 17:20)</a>:</h4>
<p>cfallin <a href="https://github.com/bytecodealliance/wasmtime/pull/4088#issuecomment-1113547457">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/4088">issue #4088</a>:</p>
<blockquote>
<blockquote>
<blockquote>
<p>@bjorn3 most disassemblers will sync to function boundaries at least (if they have that metadata, e.g. with an ELF image), so the constant pool at the end will at worst become garbage instructions after the final ret.</p>
</blockquote>
<p>This PR doesn't put the constant pool in the middle in case of large functions like it does for AArch64?</p>
</blockquote>
<p>It doesn't change the behavior at all; the <code>MachBuffer</code> will do whatever it did before for SIMD constants. On x86-64 the available PC-relative range is +/- 2GiB, so realistically the constant pool will always be at the end of the function.</p>
</blockquote>



<a name="280697077"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%234088%20x64%3A%20use%20constant%20pool%20for%20u64%20con.../near/280697077" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.234088.20x64.3A.20use.20constant.20pool.20for.20u64.20con.2E.2E.2E.html#280697077">(Apr 29 2022 at 22:29)</a>:</h4>
<p>cfallin <a href="https://github.com/bytecodealliance/wasmtime/pull/4088#issuecomment-1113827924">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/4088">issue #4088</a>:</p>
<blockquote>
<p>@abrown or @fitzgen: rebased and ready for review (stacks on #4080, which stacks on #4091).</p>
</blockquote>



<a name="280911025"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%234088%20x64%3A%20use%20constant%20pool%20for%20u64%20con.../near/280911025" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.234088.20x64.3A.20use.20constant.20pool.20for.20u64.20con.2E.2E.2E.html#280911025">(May 02 2022 at 18:06)</a>:</h4>
<p>abrown <a href="https://github.com/bytecodealliance/wasmtime/pull/4088#issuecomment-1115199650">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/4088">issue #4088</a>:</p>
<blockquote>
<p>How about we review this after we figure out #4080?</p>
</blockquote>



<a name="280947867"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%234088%20x64%3A%20use%20constant%20pool%20for%20u64%20con.../near/280947867" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.234088.20x64.3A.20use.20constant.20pool.20for.20u64.20con.2E.2E.2E.html#280947867">(May 02 2022 at 23:22)</a>:</h4>
<p>cfallin <a href="https://github.com/bytecodealliance/wasmtime/pull/4088#issuecomment-1115461583">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/4088">issue #4088</a>:</p>
<blockquote>
<p>Rebased now that #4080 merged.</p>
</blockquote>



<a name="281773664"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%234088%20x64%3A%20use%20constant%20pool%20for%20u64%20con.../near/281773664" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.234088.20x64.3A.20use.20constant.20pool.20for.20u64.20con.2E.2E.2E.html#281773664">(May 10 2022 at 03:46)</a>:</h4>
<p>cfallin <a href="https://github.com/bytecodealliance/wasmtime/pull/4088#issuecomment-1121856852">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/4088">issue #4088</a>:</p>
<blockquote>
<p>@abrown or @fitzgen, I think this should be OK to review now (thanks!).</p>
</blockquote>



<a name="281856480"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%234088%20x64%3A%20use%20constant%20pool%20for%20u64%20con.../near/281856480" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.234088.20x64.3A.20use.20constant.20pool.20for.20u64.20con.2E.2E.2E.html#281856480">(May 10 2022 at 17:12)</a>:</h4>
<p>alexcrichton <a href="https://github.com/bytecodealliance/wasmtime/pull/4088#issuecomment-1122659792">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/4088">issue #4088</a>:</p>
<blockquote>
<p>I was poking around and it looks like this PR fails tests on <code>main</code> due to what looks like a "merge conflict" in test added after this PR was created, but I suspect the test probably just needs an updated output</p>
</blockquote>



<a name="281857030"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%234088%20x64%3A%20use%20constant%20pool%20for%20u64%20con.../near/281857030" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.234088.20x64.3A.20use.20constant.20pool.20for.20u64.20con.2E.2E.2E.html#281857030">(May 10 2022 at 17:16)</a>:</h4>
<p>cfallin <a href="https://github.com/bytecodealliance/wasmtime/pull/4088#issuecomment-1122663816">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/4088">issue #4088</a>:</p>
<blockquote>
<p>Urgh, we really need a bors-like thing... I'll take a look, sorry!</p>
</blockquote>



<hr><p>Last updated: Jan 20 2025 at 06:04 UTC</p>
</html>