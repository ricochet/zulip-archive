<html>
<head><meta charset="utf-8"><title>wasmtime / PR #7749 Make `shutdown` close the input/outpu... · git-wasmtime · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/index.html">git-wasmtime</a></h2>
<h3>Topic: <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.237749.20Make.20.60shutdown.60.20close.20the.20input.2Foutpu.2E.2E.2E.html">wasmtime / PR #7749 Make `shutdown` close the input/outpu...</a></h3>

<hr>

<base href="https://bytecodealliance.zulipchat.com">

<head><link href="https://bytecodealliance.github.io/zulip-archive/style.css" rel="stylesheet"></head>

<a name="411238819"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%237749%20Make%20%60shutdown%60%20close%20the%20input/outpu.../near/411238819" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.237749.20Make.20.60shutdown.60.20close.20the.20input.2Foutpu.2E.2E.2E.html#411238819">(Jan 04 2024 at 18:22)</a>:</h4>
<p>badeend opened <a href="https://github.com/bytecodealliance/wasmtime/pull/7749">PR #7749</a> from <code>badeend:shutdown-close-streams</code> to <code>bytecodealliance:main</code>:</p>
<blockquote>
<p>Make <code>tcp-socket::shutdown</code> close the input/output-streams.<br>
This was already specified in the WITs, but not implemented nor enforced by any tests.<br>
</p>
</blockquote>



<a name="411238820"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%237749%20Make%20%60shutdown%60%20close%20the%20input/outpu.../near/411238820" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.237749.20Make.20.60shutdown.60.20close.20the.20input.2Foutpu.2E.2E.2E.html#411238820">(Jan 04 2024 at 18:22)</a>:</h4>
<p><strong>badeend</strong> requested <a href="https://github.com/fitzgen">fitzgen</a> for a review on <a href="https://github.com/bytecodealliance/wasmtime/pull/7749">PR #7749</a>.</p>



<a name="411238822"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%237749%20Make%20%60shutdown%60%20close%20the%20input/outpu.../near/411238822" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.237749.20Make.20.60shutdown.60.20close.20the.20input.2Foutpu.2E.2E.2E.html#411238822">(Jan 04 2024 at 18:22)</a>:</h4>
<p><strong>badeend</strong> requested <a href="https://github.com/orgs/bytecodealliance/teams/wasmtime-core-reviewers">wasmtime-core-reviewers</a> for a review on <a href="https://github.com/bytecodealliance/wasmtime/pull/7749">PR #7749</a>.</p>



<a name="411258129"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%237749%20Make%20%60shutdown%60%20close%20the%20input/outpu.../near/411258129" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.237749.20Make.20.60shutdown.60.20close.20the.20input.2Foutpu.2E.2E.2E.html#411258129">(Jan 04 2024 at 20:41)</a>:</h4>
<p>alexcrichton submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/7749#pullrequestreview-1804939364">PR review</a>:</p>
<blockquote>
<p>Thanks! One question but otherwise looks good <span aria-label="+1" class="emoji emoji-1f44d" role="img" title="+1">:+1:</span> </p>
</blockquote>



<a name="411258130"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%237749%20Make%20%60shutdown%60%20close%20the%20input/outpu.../near/411258130" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.237749.20Make.20.60shutdown.60.20close.20the.20input.2Foutpu.2E.2E.2E.html#411258130">(Jan 04 2024 at 20:41)</a>:</h4>
<p>alexcrichton submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/7749#pullrequestreview-1804939364">PR review</a>:</p>
<blockquote>
<p>Thanks! One question but otherwise looks good <span aria-label="+1" class="emoji emoji-1f44d" role="img" title="+1">:+1:</span> </p>
</blockquote>



<a name="411258131"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%237749%20Make%20%60shutdown%60%20close%20the%20input/outpu.../near/411258131" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.237749.20Make.20.60shutdown.60.20close.20the.20input.2Foutpu.2E.2E.2E.html#411258131">(Jan 04 2024 at 20:41)</a>:</h4>
<p>alexcrichton created <a href="https://github.com/bytecodealliance/wasmtime/pull/7749#discussion_r1442231778">PR review comment</a>:</p>
<blockquote>
<p>Should this be checked after checking for <code>Waiting</code> below? It's a bit weird to have a pending write and then call shutdown, but I think the <code>shutdown</code> syscall will cause the background write to wake up and report its failure?</p>
</blockquote>



<a name="411508263"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%237749%20Make%20%60shutdown%60%20close%20the%20input/outpu.../near/411508263" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.237749.20Make.20.60shutdown.60.20close.20the.20input.2Foutpu.2E.2E.2E.html#411508263">(Jan 06 2024 at 13:36)</a>:</h4>
<p>badeend submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/7749#pullrequestreview-1807463911">PR review</a>.</p>



<a name="411508265"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%237749%20Make%20%60shutdown%60%20close%20the%20input/outpu.../near/411508265" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.237749.20Make.20.60shutdown.60.20close.20the.20input.2Foutpu.2E.2E.2E.html#411508265">(Jan 06 2024 at 13:36)</a>:</h4>
<p>badeend created <a href="https://github.com/bytecodealliance/wasmtime/pull/7749#discussion_r1443765768">PR review comment</a>:</p>
<blockquote>
<p>The user-facing behavior implemented in this PR seems correct to me. I.e. to return <code>StreamError::Closed</code> even if an background write was still in progress.</p>
<p>With the current solution it's the responsibility of the caller to properly wait for all data to be fully acknowledged/flushed _before_ calling <code>shutdown</code>.</p>
<p>This issue is not limited to just <code>shutdown</code>, but also <code>drop</code>.</p>
<p>I think the true question is: whether or not to abandon the background write (as currently current implemented) or detach the running background tasks and let the background write finish up even after the WASI input stream has been closed (on <code>drop</code> or <code>shutdown</code>).<br>
</p>
</blockquote>



<a name="411508300"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%237749%20Make%20%60shutdown%60%20close%20the%20input/outpu.../near/411508300" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.237749.20Make.20.60shutdown.60.20close.20the.20input.2Foutpu.2E.2E.2E.html#411508300">(Jan 06 2024 at 13:37)</a>:</h4>
<p>badeend edited <a href="https://github.com/bytecodealliance/wasmtime/pull/7749#discussion_r1443765768">PR review comment</a>.</p>



<a name="411508347"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%237749%20Make%20%60shutdown%60%20close%20the%20input/outpu.../near/411508347" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.237749.20Make.20.60shutdown.60.20close.20the.20input.2Foutpu.2E.2E.2E.html#411508347">(Jan 06 2024 at 13:38)</a>:</h4>
<p>badeend edited <a href="https://github.com/bytecodealliance/wasmtime/pull/7749#discussion_r1443765768">PR review comment</a>.</p>



<a name="411508494"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%237749%20Make%20%60shutdown%60%20close%20the%20input/outpu.../near/411508494" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.237749.20Make.20.60shutdown.60.20close.20the.20input.2Foutpu.2E.2E.2E.html#411508494">(Jan 06 2024 at 13:41)</a>:</h4>
<p>badeend edited <a href="https://github.com/bytecodealliance/wasmtime/pull/7749#discussion_r1443765768">PR review comment</a>.</p>



<a name="411758101"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%237749%20Make%20%60shutdown%60%20close%20the%20input/outpu.../near/411758101" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.237749.20Make.20.60shutdown.60.20close.20the.20input.2Foutpu.2E.2E.2E.html#411758101">(Jan 08 2024 at 15:14)</a>:</h4>
<p>alexcrichton submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/7749#pullrequestreview-1809329894">PR review</a>.</p>



<a name="411758102"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%237749%20Make%20%60shutdown%60%20close%20the%20input/outpu.../near/411758102" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.237749.20Make.20.60shutdown.60.20close.20the.20input.2Foutpu.2E.2E.2E.html#411758102">(Jan 08 2024 at 15:14)</a>:</h4>
<p>alexcrichton created <a href="https://github.com/bytecodealliance/wasmtime/pull/7749#discussion_r1444809390">PR review comment</a>:</p>
<blockquote>
<p>Oh I'm not advocating for letting this proceed in the background, I'm more thinking that it might be best to shuffle this to get the response from the background task before checking the shutdown status. I'm under the impression that a <code>shutdown</code> will cancel pending writes by marking the socket as writable and returning <code>Ok(0)</code> or <code>EPIPE</code> or something like that. That would mean that after the <code>shutdown</code> it's not an indefinite block for the background task to finish up and for us to get the result.</p>
</blockquote>



<a name="411804327"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%237749%20Make%20%60shutdown%60%20close%20the%20input/outpu.../near/411804327" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.237749.20Make.20.60shutdown.60.20close.20the.20input.2Foutpu.2E.2E.2E.html#411804327">(Jan 08 2024 at 19:39)</a>:</h4>
<p>badeend submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/7749#pullrequestreview-1809899224">PR review</a>.</p>



<a name="411804328"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%237749%20Make%20%60shutdown%60%20close%20the%20input/outpu.../near/411804328" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.237749.20Make.20.60shutdown.60.20close.20the.20input.2Foutpu.2E.2E.2E.html#411804328">(Jan 08 2024 at 19:39)</a>:</h4>
<p>badeend created <a href="https://github.com/bytecodealliance/wasmtime/pull/7749#discussion_r1445243694">PR review comment</a>:</p>
<blockquote>
<blockquote>
<p>it might be best to shuffle this to get the response from the background task before checking the shutdown status.</p>
</blockquote>
<p>What would be the benefit? On line 296 I reset the last_write status which drops the <code>AbortOnDropJoinHandle</code>. So the background task will always be aborted, right?</p>
</blockquote>



<a name="411956105"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%237749%20Make%20%60shutdown%60%20close%20the%20input/outpu.../near/411956105" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.237749.20Make.20.60shutdown.60.20close.20the.20input.2Foutpu.2E.2E.2E.html#411956105">(Jan 09 2024 at 15:20)</a>:</h4>
<p>alexcrichton submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/7749#pullrequestreview-1811384786">PR review</a>.</p>



<a name="411956107"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%237749%20Make%20%60shutdown%60%20close%20the%20input/outpu.../near/411956107" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.237749.20Make.20.60shutdown.60.20close.20the.20input.2Foutpu.2E.2E.2E.html#411956107">(Jan 09 2024 at 15:20)</a>:</h4>
<p>alexcrichton created <a href="https://github.com/bytecodealliance/wasmtime/pull/7749#discussion_r1446229644">PR review comment</a>:</p>
<blockquote>
<p>It's true yeah that largely the same thing will happen, but I'd at least personally prefer to explicitly clean up the task rather than let it get cleaned up in the background if possible. It's sort of six-to-one-half-dozen-or-the-other though.</p>
<p>I'm not certain of the portability of the behavior of marking the socket as writable and cancelling all writes once <code>shutdown</code> is issued though. If that's not the actual OS behavior then switching the order here wouldn't work.</p>
<p>Given the discussion <a href="#narrow/stream/219900-wasi/topic/What.20happens.20to.20in-progress.20background.20writes.20on.20drop.3F/near/411819385">here</a> though I'm also a bit wary of cancelling active writes since that could show up as surprising for users, so maybe I should be advocating for letting this proceed in the background...</p>
</blockquote>



<a name="469743367"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%237749%20Make%20%60shutdown%60%20close%20the%20input/outpu.../near/469743367" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.237749.20Make.20.60shutdown.60.20close.20the.20input.2Foutpu.2E.2E.2E.html#469743367">(Sep 12 2024 at 17:54)</a>:</h4>
<p>badeend closed without merge <a href="https://github.com/bytecodealliance/wasmtime/pull/7749">PR #7749</a>.</p>



<a name="469743740"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%237749%20Make%20%60shutdown%60%20close%20the%20input/outpu.../near/469743740" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.237749.20Make.20.60shutdown.60.20close.20the.20input.2Foutpu.2E.2E.2E.html#469743740">(Sep 12 2024 at 17:55)</a>:</h4>
<p>badeend <a href="https://github.com/bytecodealliance/wasmtime/pull/7749#issuecomment-2346910167">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/7749">PR #7749</a>:</p>
<blockquote>
<p>Fixed in <a href="https://github.com/bytecodealliance/wasmtime/pull/9055">https://github.com/bytecodealliance/wasmtime/pull/9055</a> &amp; <a href="https://github.com/bytecodealliance/wasmtime/pull/9225">https://github.com/bytecodealliance/wasmtime/pull/9225</a></p>
</blockquote>



<hr><p>Last updated: Jan 20 2025 at 06:04 UTC</p>
</html>