<html>
<head><meta charset="utf-8"><title>wasmtime / PR #1329 [wasi-common] add custom FdPool conta... · git-wasmtime · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/index.html">git-wasmtime</a></h2>
<h3>Topic: <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231329.20.5Bwasi-common.5D.20add.20custom.20FdPool.20conta.2E.2E.2E.html">wasmtime / PR #1329 [wasi-common] add custom FdPool conta...</a></h3>

<hr>

<base href="https://bytecodealliance.zulipchat.com">

<head><link href="https://bytecodealliance.github.io/zulip-archive/style.css" rel="stylesheet"></head>

<a name="190822048"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231329%20%5Bwasi-common%5D%20add%20custom%20FdPool%20conta.../near/190822048" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231329.20.5Bwasi-common.5D.20add.20custom.20FdPool.20conta.2E.2E.2E.html#190822048">(Mar 17 2020 at 09:10)</a>:</h4>
<p>kubkon edited <a href="https://github.com/bytecodealliance/wasmtime/pull/1329" target="_blank" title="https://github.com/bytecodealliance/wasmtime/pull/1329">PR #1329</a> from <code>fd_handles</code> to <code>master</code>:</p>
<blockquote>
<p>This PR adds a custom <code>FdSet</code> container which is intended<br>
for use in <code>wasi-common</code> to track WASI fd allocs/deallocs. The<br>
main aim for this container is to abstract away the current<br>
approach of spawning new handles</p>
<div class="codehilite"><pre><span></span><span class="n">fd</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">fd</span><span class="p">.</span><span class="n">checked_add</span><span class="p">(</span><span class="mi">1</span><span class="p">).</span><span class="n">ok_or</span><span class="p">(...)</span><span class="o">?</span><span class="p">;</span><span class="w"></span>
</pre></div>


<p>and to make it possible to reuse unused/reclaimed handles<br>
which currently is not done.</p>
<p>The struct offers 3 methods to manage its functionality:</p>
<ul>
<li>
<p><code>FdSet::new</code> initialises the internal data structures,<br>
  and most notably, it preallocates an <code>FdSet::BATCH_SIZE</code><br>
  worth of handles in such a way that we always start popping<br>
  from the "smallest" handle (think of it as of reversed stack,<br>
  I guess; it's not a binary heap since we don't really care<br>
  whether internally the handles are sorted in some way, just that<br>
  the "largets" handle is at the bottom. Why will become clear<br>
  when describing <code>allocate</code> method.)</p>
</li>
<li>
<p><code>FdSet::allocate</code> pops the next available handle if one is available.<br>
  The tricky bit here is that, if we run out of handles, we preallocate<br>
  the next <code>FdSet::BATCH_SIZE</code> worth of handles starting from the<br>
  latest popped handle (i.e., the "largest" handle). This<br>
  works only because we make sure to only ever pop and push already<br>
  existing handles from the back, and push _new_ handles (from the<br>
  preallocation step) from the front. When we ultimately run out<br>
  of _all_ available handles, we then return <code>None</code> for the client<br>
  to handle in some way (e.g., throwing an error such as <code>WasiError::EMFILE</code><br>
  or whatnot).</p>
</li>
<li>
<p><code>FdSet::deallocate</code> returns the already allocated handle back to<br>
  the pool for further reuse.</p>
</li>
</ul>
<p>When figuring out the internals, I've tried to optimise for both<br>
alloc and dealloc performance, and I believe we've got an amortised<br>
<code>O(1)~*</code> performance for both (if my maths is right, and it may very<br>
well not be, so please verify!).</p>
<p>In order to keep <code>FdSet</code> fairly generic, I've made sure not to hard-code<br>
it for the current type system generated by <code>wig</code> (i.e., <code>wasi::__wasi_fd_t</code><br>
representing WASI handle), but rather, any type which wants to be managed<br>
by <code>FdSet</code> needs to conform to <code>Fd</code> trait. This trait is quite simple as<br>
it only requires a couple of rudimentary traits (although <code>std:#️⃣:Hash</code><br>
is quite a powerful assumption here!), and a custom method</p>
<div class="codehilite"><pre><span></span><span class="n">Fd</span>::<span class="n">next</span><span class="p">(</span><span class="o">&amp;</span><span class="bp">self</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nb">Option</span><span class="o">&lt;</span><span class="n">Self</span><span class="o">&gt;</span><span class="p">;</span><span class="w"></span>
</pre></div>


<p>which is there to encapsulate creating another handle from the given one.<br>
In the current state of the code, that'd be simply <code>u32::checked_add(1)</code>.<br>
When <code>wiggle</code> makes it way into the <code>wasi-common</code>, I'd imagine it being<br>
similar to</p>
<div class="codehilite"><pre><span></span><span class="k">fn</span> <span class="nf">next</span><span class="p">(</span><span class="o">&amp;</span><span class="bp">self</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nb">Option</span><span class="o">&lt;</span><span class="n">Self</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="bp">self</span><span class="p">.</span><span class="mf">0.</span><span class="n">checked_add</span><span class="p">(</span><span class="mi">1</span><span class="p">).</span><span class="n">map</span><span class="p">(</span><span class="n">Self</span>::<span class="n">from</span><span class="p">)</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>


<p>Anyhow, I'd be happy to learn your thoughts about this design!</p>
</blockquote>



<a name="190822121"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231329%20%5Bwasi-common%5D%20add%20custom%20FdPool%20conta.../near/190822121" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231329.20.5Bwasi-common.5D.20add.20custom.20FdPool.20conta.2E.2E.2E.html#190822121">(Mar 17 2020 at 09:11)</a>:</h4>
<p>kubkon edited <a href="https://github.com/bytecodealliance/wasmtime/pull/1329" target="_blank" title="https://github.com/bytecodealliance/wasmtime/pull/1329">PR #1329</a> from <code>fd_handles</code> to <code>master</code>:</p>
<blockquote>
<p>This PR adds a custom <code>FdPool</code> container which is intended<br>
for use in <code>wasi-common</code> to track WASI fd allocs/deallocs. The<br>
main aim for this container is to abstract away the current<br>
approach of spawning new handles</p>
<div class="codehilite"><pre><span></span><span class="n">fd</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">fd</span><span class="p">.</span><span class="n">checked_add</span><span class="p">(</span><span class="mi">1</span><span class="p">).</span><span class="n">ok_or</span><span class="p">(...)</span><span class="o">?</span><span class="p">;</span><span class="w"></span>
</pre></div>


<p>and to make it possible to reuse unused/reclaimed handles<br>
which currently is not done.</p>
<p>The struct offers 3 methods to manage its functionality:</p>
<ul>
<li>
<p><code>FdPool::new</code> initialises the internal data structures,<br>
  and most notably, it preallocates an <code>FdPool::BATCH_SIZE</code><br>
  worth of handles in such a way that we always start popping<br>
  from the "smallest" handle (think of it as of reversed stack,<br>
  I guess; it's not a binary heap since we don't really care<br>
  whether internally the handles are sorted in some way, just that<br>
  the "largets" handle is at the bottom. Why will become clear<br>
  when describing <code>allocate</code> method.)</p>
</li>
<li>
<p><code>FdPool::allocate</code> pops the next available handle if one is available.<br>
  The tricky bit here is that, if we run out of handles, we preallocate<br>
  the next <code>FdPool::BATCH_SIZE</code> worth of handles starting from the<br>
  latest popped handle (i.e., the "largest" handle). This<br>
  works only because we make sure to only ever pop and push already<br>
  existing handles from the back, and push _new_ handles (from the<br>
  preallocation step) from the front. When we ultimately run out<br>
  of _all_ available handles, we then return <code>None</code> for the client<br>
  to handle in some way (e.g., throwing an error such as <code>WasiError::EMFILE</code><br>
  or whatnot).</p>
</li>
<li>
<p><code>FdPool::deallocate</code> returns the already allocated handle back to<br>
  the pool for further reuse.</p>
</li>
</ul>
<p>When figuring out the internals, I've tried to optimise for both<br>
alloc and dealloc performance, and I believe we've got an amortised<br>
<code>O(1)~*</code> performance for both (if my maths is right, and it may very<br>
well not be, so please verify!).</p>
<p>In order to keep <code>FdPool</code> fairly generic, I've made sure not to hard-code<br>
it for the current type system generated by <code>wig</code> (i.e., <code>wasi::__wasi_fd_t</code><br>
representing WASI handle), but rather, any type which wants to be managed<br>
by <code>FdPool</code> needs to conform to <code>Fd</code> trait. This trait is quite simple as<br>
it only requires a couple of rudimentary traits (although <code>std:#️⃣:Hash</code><br>
is quite a powerful assumption here!), and a custom method</p>
<div class="codehilite"><pre><span></span><span class="n">Fd</span>::<span class="n">next</span><span class="p">(</span><span class="o">&amp;</span><span class="bp">self</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nb">Option</span><span class="o">&lt;</span><span class="n">Self</span><span class="o">&gt;</span><span class="p">;</span><span class="w"></span>
</pre></div>


<p>which is there to encapsulate creating another handle from the given one.<br>
In the current state of the code, that'd be simply <code>u32::checked_add(1)</code>.<br>
When <code>wiggle</code> makes it way into the <code>wasi-common</code>, I'd imagine it being<br>
similar to</p>
<div class="codehilite"><pre><span></span><span class="k">fn</span> <span class="nf">next</span><span class="p">(</span><span class="o">&amp;</span><span class="bp">self</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nb">Option</span><span class="o">&lt;</span><span class="n">Self</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="bp">self</span><span class="p">.</span><span class="mf">0.</span><span class="n">checked_add</span><span class="p">(</span><span class="mi">1</span><span class="p">).</span><span class="n">map</span><span class="p">(</span><span class="n">Self</span>::<span class="n">from</span><span class="p">)</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>


<p>Anyhow, I'd be happy to learn your thoughts about this design!</p>
</blockquote>



<a name="190858004"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231329%20%5Bwasi-common%5D%20add%20custom%20FdPool%20conta.../near/190858004" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231329.20.5Bwasi-common.5D.20add.20custom.20FdPool.20conta.2E.2E.2E.html#190858004">(Mar 17 2020 at 14:49)</a>:</h4>
<p>alexcrichton submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/1329#pullrequestreview-376100515" target="_blank" title="https://github.com/bytecodealliance/wasmtime/pull/1329#pullrequestreview-376100515">PR Review</a>.</p>



<a name="190858005"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231329%20%5Bwasi-common%5D%20add%20custom%20FdPool%20conta.../near/190858005" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231329.20.5Bwasi-common.5D.20add.20custom.20FdPool.20conta.2E.2E.2E.html#190858005">(Mar 17 2020 at 14:49)</a>:</h4>
<p>alexcrichton created <a href="https://github.com/bytecodealliance/wasmtime/pull/1329#discussion_r393735228" target="_blank" title="https://github.com/bytecodealliance/wasmtime/pull/1329#discussion_r393735228">PR Review Comment</a>:</p>
<blockquote>
<p>I think we can probably avoid a literal list-of-indices here perhaps? We could have a <code>Vec</code> of available indices, as well as a "next index to hand out" stored as <code>Option&lt;Fd&gt;</code>. Allocation would pop from the <code>Vec</code> or otherwise <code>.take()</code> the next index. If the next index was taken we store the result of <code>.next()</code> back in there. </p>
<p>Later during <code>deallocate</code> we'd just push the entry onto the <code>Vec</code>.</p>
<p>I think that may simplify a bit here and make it a bit more lightweight in terms of overhead?</p>
</blockquote>



<a name="190858007"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231329%20%5Bwasi-common%5D%20add%20custom%20FdPool%20conta.../near/190858007" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231329.20.5Bwasi-common.5D.20add.20custom.20FdPool.20conta.2E.2E.2E.html#190858007">(Mar 17 2020 at 14:49)</a>:</h4>
<p>alexcrichton created <a href="https://github.com/bytecodealliance/wasmtime/pull/1329#discussion_r393730700" target="_blank" title="https://github.com/bytecodealliance/wasmtime/pull/1329#discussion_r393730700">PR Review Comment</a>:</p>
<blockquote>
<p>Instead of <code>.replace</code> I think this could be <code>self.stdin = Some(...)</code>, right?</p>
</blockquote>



<a name="190858008"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231329%20%5Bwasi-common%5D%20add%20custom%20FdPool%20conta.../near/190858008" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231329.20.5Bwasi-common.5D.20add.20custom.20FdPool.20conta.2E.2E.2E.html#190858008">(Mar 17 2020 at 14:49)</a>:</h4>
<p>alexcrichton submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/1329#pullrequestreview-376100515" target="_blank" title="https://github.com/bytecodealliance/wasmtime/pull/1329#pullrequestreview-376100515">PR Review</a>.</p>



<a name="190858009"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231329%20%5Bwasi-common%5D%20add%20custom%20FdPool%20conta.../near/190858009" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231329.20.5Bwasi-common.5D.20add.20custom.20FdPool.20conta.2E.2E.2E.html#190858009">(Mar 17 2020 at 14:49)</a>:</h4>
<p>alexcrichton created <a href="https://github.com/bytecodealliance/wasmtime/pull/1329#discussion_r393735546" target="_blank" title="https://github.com/bytecodealliance/wasmtime/pull/1329#discussion_r393735546">PR Review Comment</a>:</p>
<blockquote>
<p>Could this file reexport from the current snapshot to avoid duplication?</p>
</blockquote>



<a name="190861618"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231329%20%5Bwasi-common%5D%20add%20custom%20FdPool%20conta.../near/190861618" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231329.20.5Bwasi-common.5D.20add.20custom.20FdPool.20conta.2E.2E.2E.html#190861618">(Mar 17 2020 at 15:11)</a>:</h4>
<p>kubkon submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/1329#pullrequestreview-376128516" target="_blank" title="https://github.com/bytecodealliance/wasmtime/pull/1329#pullrequestreview-376128516">PR Review</a>.</p>



<a name="190861621"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231329%20%5Bwasi-common%5D%20add%20custom%20FdPool%20conta.../near/190861621" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231329.20.5Bwasi-common.5D.20add.20custom.20FdPool.20conta.2E.2E.2E.html#190861621">(Mar 17 2020 at 15:11)</a>:</h4>
<p>kubkon created <a href="https://github.com/bytecodealliance/wasmtime/pull/1329#discussion_r393752074" target="_blank" title="https://github.com/bytecodealliance/wasmtime/pull/1329#discussion_r393752074">PR Review Comment</a>:</p>
<blockquote>
<p>So basically, you suggest to skip the preallocation step, did I get it right? If so, this is what I originally had, just thought we could preallocate a couple upfront as means of optimisation but I guess that might have been somewhat premature ;-)</p>
</blockquote>



<a name="190861864"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231329%20%5Bwasi-common%5D%20add%20custom%20FdPool%20conta.../near/190861864" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231329.20.5Bwasi-common.5D.20add.20custom.20FdPool.20conta.2E.2E.2E.html#190861864">(Mar 17 2020 at 15:13)</a>:</h4>
<p>alexcrichton submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/1329#pullrequestreview-376130116" target="_blank" title="https://github.com/bytecodealliance/wasmtime/pull/1329#pullrequestreview-376130116">PR Review</a>.</p>



<a name="190861865"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231329%20%5Bwasi-common%5D%20add%20custom%20FdPool%20conta.../near/190861865" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231329.20.5Bwasi-common.5D.20add.20custom.20FdPool.20conta.2E.2E.2E.html#190861865">(Mar 17 2020 at 15:13)</a>:</h4>
<p>alexcrichton created <a href="https://github.com/bytecodealliance/wasmtime/pull/1329#discussion_r393753269" target="_blank" title="https://github.com/bytecodealliance/wasmtime/pull/1329#discussion_r393753269">PR Review Comment</a>:</p>
<blockquote>
<p>Right yeah I think the preallocation can largely be skipped. We can always continue to optimize it more though if necessary!</p>
</blockquote>



<a name="190861997"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231329%20%5Bwasi-common%5D%20add%20custom%20FdPool%20conta.../near/190861997" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231329.20.5Bwasi-common.5D.20add.20custom.20FdPool.20conta.2E.2E.2E.html#190861997">(Mar 17 2020 at 15:14)</a>:</h4>
<p>kubkon submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/1329#pullrequestreview-376130607" target="_blank" title="https://github.com/bytecodealliance/wasmtime/pull/1329#pullrequestreview-376130607">PR Review</a>.</p>



<a name="190861998"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231329%20%5Bwasi-common%5D%20add%20custom%20FdPool%20conta.../near/190861998" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231329.20.5Bwasi-common.5D.20add.20custom.20FdPool.20conta.2E.2E.2E.html#190861998">(Mar 17 2020 at 15:14)</a>:</h4>
<p>kubkon created <a href="https://github.com/bytecodealliance/wasmtime/pull/1329#discussion_r393753689" target="_blank" title="https://github.com/bytecodealliance/wasmtime/pull/1329#discussion_r393753689">PR Review Comment</a>:</p>
<blockquote>
<p>Excellent question! I thought about this myself, and in principle, I'd love if we could. The problem is with type aliasing between the two snapshots. The compiler gets confused which <code>wasi::__wasi_fd_t as Fd</code> to use. Do you think there's a way to overcome this? Would perhaps type aliasing work here?</p>
</blockquote>



<a name="190862070"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231329%20%5Bwasi-common%5D%20add%20custom%20FdPool%20conta.../near/190862070" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231329.20.5Bwasi-common.5D.20add.20custom.20FdPool.20conta.2E.2E.2E.html#190862070">(Mar 17 2020 at 15:14)</a>:</h4>
<p>kubkon submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/1329#pullrequestreview-376131067" target="_blank" title="https://github.com/bytecodealliance/wasmtime/pull/1329#pullrequestreview-376131067">PR Review</a>.</p>



<a name="190862072"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231329%20%5Bwasi-common%5D%20add%20custom%20FdPool%20conta.../near/190862072" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231329.20.5Bwasi-common.5D.20add.20custom.20FdPool.20conta.2E.2E.2E.html#190862072">(Mar 17 2020 at 15:14)</a>:</h4>
<p>kubkon created <a href="https://github.com/bytecodealliance/wasmtime/pull/1329#discussion_r393754055" target="_blank" title="https://github.com/bytecodealliance/wasmtime/pull/1329#discussion_r393754055">PR Review Comment</a>:</p>
<blockquote>
<p>Agreed! Let me roll it back then!</p>
</blockquote>



<a name="190862604"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231329%20%5Bwasi-common%5D%20add%20custom%20FdPool%20conta.../near/190862604" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231329.20.5Bwasi-common.5D.20add.20custom.20FdPool.20conta.2E.2E.2E.html#190862604">(Mar 17 2020 at 15:17)</a>:</h4>
<p>alexcrichton submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/1329#pullrequestreview-376134018" target="_blank" title="https://github.com/bytecodealliance/wasmtime/pull/1329#pullrequestreview-376134018">PR Review</a>.</p>



<a name="190862606"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231329%20%5Bwasi-common%5D%20add%20custom%20FdPool%20conta.../near/190862606" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231329.20.5Bwasi-common.5D.20add.20custom.20FdPool.20conta.2E.2E.2E.html#190862606">(Mar 17 2020 at 15:17)</a>:</h4>
<p>alexcrichton created <a href="https://github.com/bytecodealliance/wasmtime/pull/1329#discussion_r393756345" target="_blank" title="https://github.com/bytecodealliance/wasmtime/pull/1329#discussion_r393756345">PR Review Comment</a>:</p>
<blockquote>
<p>Hm I'm not sure I understand the compiler error, wanna push up a branch I can poke at?</p>
</blockquote>



<a name="190866897"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231329%20%5Bwasi-common%5D%20add%20custom%20FdPool%20conta.../near/190866897" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231329.20.5Bwasi-common.5D.20add.20custom.20FdPool.20conta.2E.2E.2E.html#190866897">(Mar 17 2020 at 15:42)</a>:</h4>
<p>kubkon updated <a href="https://github.com/bytecodealliance/wasmtime/pull/1329" target="_blank" title="https://github.com/bytecodealliance/wasmtime/pull/1329">PR #1329</a> from <code>fd_handles</code> to <code>master</code>:</p>
<blockquote>
<p>This PR adds a custom <code>FdPool</code> container which is intended<br>
for use in <code>wasi-common</code> to track WASI fd allocs/deallocs. The<br>
main aim for this container is to abstract away the current<br>
approach of spawning new handles</p>
<div class="codehilite"><pre><span></span><span class="n">fd</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">fd</span><span class="p">.</span><span class="n">checked_add</span><span class="p">(</span><span class="mi">1</span><span class="p">).</span><span class="n">ok_or</span><span class="p">(...)</span><span class="o">?</span><span class="p">;</span><span class="w"></span>
</pre></div>


<p>and to make it possible to reuse unused/reclaimed handles<br>
which currently is not done.</p>
<p>The struct offers 3 methods to manage its functionality:</p>
<ul>
<li>
<p><code>FdPool::new</code> initialises the internal data structures,<br>
  and most notably, it preallocates an <code>FdPool::BATCH_SIZE</code><br>
  worth of handles in such a way that we always start popping<br>
  from the "smallest" handle (think of it as of reversed stack,<br>
  I guess; it's not a binary heap since we don't really care<br>
  whether internally the handles are sorted in some way, just that<br>
  the "largets" handle is at the bottom. Why will become clear<br>
  when describing <code>allocate</code> method.)</p>
</li>
<li>
<p><code>FdPool::allocate</code> pops the next available handle if one is available.<br>
  The tricky bit here is that, if we run out of handles, we preallocate<br>
  the next <code>FdPool::BATCH_SIZE</code> worth of handles starting from the<br>
  latest popped handle (i.e., the "largest" handle). This<br>
  works only because we make sure to only ever pop and push already<br>
  existing handles from the back, and push _new_ handles (from the<br>
  preallocation step) from the front. When we ultimately run out<br>
  of _all_ available handles, we then return <code>None</code> for the client<br>
  to handle in some way (e.g., throwing an error such as <code>WasiError::EMFILE</code><br>
  or whatnot).</p>
</li>
<li>
<p><code>FdPool::deallocate</code> returns the already allocated handle back to<br>
  the pool for further reuse.</p>
</li>
</ul>
<p>When figuring out the internals, I've tried to optimise for both<br>
alloc and dealloc performance, and I believe we've got an amortised<br>
<code>O(1)~*</code> performance for both (if my maths is right, and it may very<br>
well not be, so please verify!).</p>
<p>In order to keep <code>FdPool</code> fairly generic, I've made sure not to hard-code<br>
it for the current type system generated by <code>wig</code> (i.e., <code>wasi::__wasi_fd_t</code><br>
representing WASI handle), but rather, any type which wants to be managed<br>
by <code>FdPool</code> needs to conform to <code>Fd</code> trait. This trait is quite simple as<br>
it only requires a couple of rudimentary traits (although <code>std:#️⃣:Hash</code><br>
is quite a powerful assumption here!), and a custom method</p>
<div class="codehilite"><pre><span></span><span class="n">Fd</span>::<span class="n">next</span><span class="p">(</span><span class="o">&amp;</span><span class="bp">self</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nb">Option</span><span class="o">&lt;</span><span class="n">Self</span><span class="o">&gt;</span><span class="p">;</span><span class="w"></span>
</pre></div>


<p>which is there to encapsulate creating another handle from the given one.<br>
In the current state of the code, that'd be simply <code>u32::checked_add(1)</code>.<br>
When <code>wiggle</code> makes it way into the <code>wasi-common</code>, I'd imagine it being<br>
similar to</p>
<div class="codehilite"><pre><span></span><span class="k">fn</span> <span class="nf">next</span><span class="p">(</span><span class="o">&amp;</span><span class="bp">self</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nb">Option</span><span class="o">&lt;</span><span class="n">Self</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="bp">self</span><span class="p">.</span><span class="mf">0.</span><span class="n">checked_add</span><span class="p">(</span><span class="mi">1</span><span class="p">).</span><span class="n">map</span><span class="p">(</span><span class="n">Self</span>::<span class="n">from</span><span class="p">)</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>


<p>Anyhow, I'd be happy to learn your thoughts about this design!</p>
</blockquote>



<a name="190868668"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231329%20%5Bwasi-common%5D%20add%20custom%20FdPool%20conta.../near/190868668" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231329.20.5Bwasi-common.5D.20add.20custom.20FdPool.20conta.2E.2E.2E.html#190868668">(Mar 17 2020 at 15:53)</a>:</h4>
<p>kubkon submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/1329#pullrequestreview-376168555" target="_blank" title="https://github.com/bytecodealliance/wasmtime/pull/1329#pullrequestreview-376168555">PR Review</a>.</p>



<a name="190868669"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231329%20%5Bwasi-common%5D%20add%20custom%20FdPool%20conta.../near/190868669" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231329.20.5Bwasi-common.5D.20add.20custom.20FdPool.20conta.2E.2E.2E.html#190868669">(Mar 17 2020 at 15:53)</a>:</h4>
<p>kubkon created <a href="https://github.com/bytecodealliance/wasmtime/pull/1329#discussion_r393783727" target="_blank" title="https://github.com/bytecodealliance/wasmtime/pull/1329#discussion_r393783727">PR Review Comment</a>:</p>
<blockquote>
<p>Right, I now remembered what the issue was. Since <code>__wasi_fd_t</code> is a type alias to <code>u32</code> in both snapshots, we obviously cannot define two implementations of the form</p>
<div class="codehilite"><pre><span></span><span class="c1">// this one is in snapshot1, in wasi.rs</span>
<span class="k">impl</span><span class="w"> </span><span class="k">crate</span>::<span class="n">fdpool</span>::<span class="n">Fd</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">__wasi_fd_t</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">   </span><span class="c1">// ...</span>
<span class="p">}</span><span class="w"></span>
</pre></div>


<p>and</p>
<div class="codehilite"><pre><span></span><span class="c1">// this one is in snapshot0, in old/snapshot0/wasi.rs</span>
<span class="k">impl</span><span class="w"> </span><span class="k">crate</span>::<span class="n">fdpool</span>::<span class="n">Fd</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">__wasi_fd_t</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="c1">// ...</span>
<span class="p">}</span><span class="w"></span>
</pre></div>


<p>I guess given that there is virtually no ABI difference between the two types across both snapshots, we could simply ignore implementing it in snapshot0. Would that be acceptable? I mean given that soon-ish we'd want to use <code>wiggle</code> to completely rethink how we handle multiple snapshots with as little code duplication as possible, this seems fair to me.</p>
</blockquote>



<a name="190871902"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231329%20%5Bwasi-common%5D%20add%20custom%20FdPool%20conta.../near/190871902" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231329.20.5Bwasi-common.5D.20add.20custom.20FdPool.20conta.2E.2E.2E.html#190871902">(Mar 17 2020 at 16:13)</a>:</h4>
<p>alexcrichton submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/1329#pullrequestreview-376187388" target="_blank" title="https://github.com/bytecodealliance/wasmtime/pull/1329#pullrequestreview-376187388">PR Review</a>.</p>



<a name="190871903"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231329%20%5Bwasi-common%5D%20add%20custom%20FdPool%20conta.../near/190871903" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231329.20.5Bwasi-common.5D.20add.20custom.20FdPool.20conta.2E.2E.2E.html#190871903">(Mar 17 2020 at 16:13)</a>:</h4>
<p>alexcrichton created <a href="https://github.com/bytecodealliance/wasmtime/pull/1329#discussion_r393798393" target="_blank" title="https://github.com/bytecodealliance/wasmtime/pull/1329#discussion_r393798393">PR Review Comment</a>:</p>
<blockquote>
<p>Yeah I think that'll be alright!</p>
</blockquote>



<a name="190872028"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231329%20%5Bwasi-common%5D%20add%20custom%20FdPool%20conta.../near/190872028" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231329.20.5Bwasi-common.5D.20add.20custom.20FdPool.20conta.2E.2E.2E.html#190872028">(Mar 17 2020 at 16:14)</a>:</h4>
<p>alexcrichton submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/1329#pullrequestreview-376187901" target="_blank" title="https://github.com/bytecodealliance/wasmtime/pull/1329#pullrequestreview-376187901">PR Review</a>.</p>



<a name="190872029"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231329%20%5Bwasi-common%5D%20add%20custom%20FdPool%20conta.../near/190872029" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231329.20.5Bwasi-common.5D.20add.20custom.20FdPool.20conta.2E.2E.2E.html#190872029">(Mar 17 2020 at 16:14)</a>:</h4>
<p>alexcrichton created <a href="https://github.com/bytecodealliance/wasmtime/pull/1329#discussion_r393798820" target="_blank" title="https://github.com/bytecodealliance/wasmtime/pull/1329#discussion_r393798820">PR Review Comment</a>:</p>
<blockquote>
<p>This could use <code>?</code> I think if you wanted to be super nifty</p>
</blockquote>



<a name="190872347"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231329%20%5Bwasi-common%5D%20add%20custom%20FdPool%20conta.../near/190872347" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231329.20.5Bwasi-common.5D.20add.20custom.20FdPool.20conta.2E.2E.2E.html#190872347">(Mar 17 2020 at 16:16)</a>:</h4>
<p>kubkon updated <a href="https://github.com/bytecodealliance/wasmtime/pull/1329" target="_blank" title="https://github.com/bytecodealliance/wasmtime/pull/1329">PR #1329</a> from <code>fd_handles</code> to <code>master</code>:</p>
<blockquote>
<p>This PR adds a custom <code>FdPool</code> container which is intended<br>
for use in <code>wasi-common</code> to track WASI fd allocs/deallocs. The<br>
main aim for this container is to abstract away the current<br>
approach of spawning new handles</p>
<div class="codehilite"><pre><span></span><span class="n">fd</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">fd</span><span class="p">.</span><span class="n">checked_add</span><span class="p">(</span><span class="mi">1</span><span class="p">).</span><span class="n">ok_or</span><span class="p">(...)</span><span class="o">?</span><span class="p">;</span><span class="w"></span>
</pre></div>


<p>and to make it possible to reuse unused/reclaimed handles<br>
which currently is not done.</p>
<p>The struct offers 3 methods to manage its functionality:</p>
<ul>
<li>
<p><code>FdPool::new</code> initialises the internal data structures,<br>
  and most notably, it preallocates an <code>FdPool::BATCH_SIZE</code><br>
  worth of handles in such a way that we always start popping<br>
  from the "smallest" handle (think of it as of reversed stack,<br>
  I guess; it's not a binary heap since we don't really care<br>
  whether internally the handles are sorted in some way, just that<br>
  the "largets" handle is at the bottom. Why will become clear<br>
  when describing <code>allocate</code> method.)</p>
</li>
<li>
<p><code>FdPool::allocate</code> pops the next available handle if one is available.<br>
  The tricky bit here is that, if we run out of handles, we preallocate<br>
  the next <code>FdPool::BATCH_SIZE</code> worth of handles starting from the<br>
  latest popped handle (i.e., the "largest" handle). This<br>
  works only because we make sure to only ever pop and push already<br>
  existing handles from the back, and push _new_ handles (from the<br>
  preallocation step) from the front. When we ultimately run out<br>
  of _all_ available handles, we then return <code>None</code> for the client<br>
  to handle in some way (e.g., throwing an error such as <code>WasiError::EMFILE</code><br>
  or whatnot).</p>
</li>
<li>
<p><code>FdPool::deallocate</code> returns the already allocated handle back to<br>
  the pool for further reuse.</p>
</li>
</ul>
<p>When figuring out the internals, I've tried to optimise for both<br>
alloc and dealloc performance, and I believe we've got an amortised<br>
<code>O(1)~*</code> performance for both (if my maths is right, and it may very<br>
well not be, so please verify!).</p>
<p>In order to keep <code>FdPool</code> fairly generic, I've made sure not to hard-code<br>
it for the current type system generated by <code>wig</code> (i.e., <code>wasi::__wasi_fd_t</code><br>
representing WASI handle), but rather, any type which wants to be managed<br>
by <code>FdPool</code> needs to conform to <code>Fd</code> trait. This trait is quite simple as<br>
it only requires a couple of rudimentary traits (although <code>std:#️⃣:Hash</code><br>
is quite a powerful assumption here!), and a custom method</p>
<div class="codehilite"><pre><span></span><span class="n">Fd</span>::<span class="n">next</span><span class="p">(</span><span class="o">&amp;</span><span class="bp">self</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nb">Option</span><span class="o">&lt;</span><span class="n">Self</span><span class="o">&gt;</span><span class="p">;</span><span class="w"></span>
</pre></div>


<p>which is there to encapsulate creating another handle from the given one.<br>
In the current state of the code, that'd be simply <code>u32::checked_add(1)</code>.<br>
When <code>wiggle</code> makes it way into the <code>wasi-common</code>, I'd imagine it being<br>
similar to</p>
<div class="codehilite"><pre><span></span><span class="k">fn</span> <span class="nf">next</span><span class="p">(</span><span class="o">&amp;</span><span class="bp">self</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nb">Option</span><span class="o">&lt;</span><span class="n">Self</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="bp">self</span><span class="p">.</span><span class="mf">0.</span><span class="n">checked_add</span><span class="p">(</span><span class="mi">1</span><span class="p">).</span><span class="n">map</span><span class="p">(</span><span class="n">Self</span>::<span class="n">from</span><span class="p">)</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>


<p>Anyhow, I'd be happy to learn your thoughts about this design!</p>
</blockquote>



<a name="190872444"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231329%20%5Bwasi-common%5D%20add%20custom%20FdPool%20conta.../near/190872444" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231329.20.5Bwasi-common.5D.20add.20custom.20FdPool.20conta.2E.2E.2E.html#190872444">(Mar 17 2020 at 16:17)</a>:</h4>
<p>kubkon submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/1329#pullrequestreview-376190633" target="_blank" title="https://github.com/bytecodealliance/wasmtime/pull/1329#pullrequestreview-376190633">PR Review</a>.</p>



<a name="190872445"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231329%20%5Bwasi-common%5D%20add%20custom%20FdPool%20conta.../near/190872445" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231329.20.5Bwasi-common.5D.20add.20custom.20FdPool.20conta.2E.2E.2E.html#190872445">(Mar 17 2020 at 16:17)</a>:</h4>
<p>kubkon created <a href="https://github.com/bytecodealliance/wasmtime/pull/1329#discussion_r393800952" target="_blank" title="https://github.com/bytecodealliance/wasmtime/pull/1329#discussion_r393800952">PR Review Comment</a>:</p>
<blockquote>
<p>Of course, well spotted, thanks!</p>
</blockquote>



<a name="190872682"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231329%20%5Bwasi-common%5D%20add%20custom%20FdPool%20conta.../near/190872682" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231329.20.5Bwasi-common.5D.20add.20custom.20FdPool.20conta.2E.2E.2E.html#190872682">(Mar 17 2020 at 16:18)</a>:</h4>
<p>kubkon updated <a href="https://github.com/bytecodealliance/wasmtime/pull/1329" target="_blank" title="https://github.com/bytecodealliance/wasmtime/pull/1329">PR #1329</a> from <code>fd_handles</code> to <code>master</code>:</p>
<blockquote>
<p>This PR adds a custom <code>FdPool</code> container which is intended<br>
for use in <code>wasi-common</code> to track WASI fd allocs/deallocs. The<br>
main aim for this container is to abstract away the current<br>
approach of spawning new handles</p>
<div class="codehilite"><pre><span></span><span class="n">fd</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">fd</span><span class="p">.</span><span class="n">checked_add</span><span class="p">(</span><span class="mi">1</span><span class="p">).</span><span class="n">ok_or</span><span class="p">(...)</span><span class="o">?</span><span class="p">;</span><span class="w"></span>
</pre></div>


<p>and to make it possible to reuse unused/reclaimed handles<br>
which currently is not done.</p>
<p>The struct offers 3 methods to manage its functionality:</p>
<ul>
<li>
<p><code>FdPool::new</code> initialises the internal data structures,<br>
  and most notably, it preallocates an <code>FdPool::BATCH_SIZE</code><br>
  worth of handles in such a way that we always start popping<br>
  from the "smallest" handle (think of it as of reversed stack,<br>
  I guess; it's not a binary heap since we don't really care<br>
  whether internally the handles are sorted in some way, just that<br>
  the "largets" handle is at the bottom. Why will become clear<br>
  when describing <code>allocate</code> method.)</p>
</li>
<li>
<p><code>FdPool::allocate</code> pops the next available handle if one is available.<br>
  The tricky bit here is that, if we run out of handles, we preallocate<br>
  the next <code>FdPool::BATCH_SIZE</code> worth of handles starting from the<br>
  latest popped handle (i.e., the "largest" handle). This<br>
  works only because we make sure to only ever pop and push already<br>
  existing handles from the back, and push _new_ handles (from the<br>
  preallocation step) from the front. When we ultimately run out<br>
  of _all_ available handles, we then return <code>None</code> for the client<br>
  to handle in some way (e.g., throwing an error such as <code>WasiError::EMFILE</code><br>
  or whatnot).</p>
</li>
<li>
<p><code>FdPool::deallocate</code> returns the already allocated handle back to<br>
  the pool for further reuse.</p>
</li>
</ul>
<p>When figuring out the internals, I've tried to optimise for both<br>
alloc and dealloc performance, and I believe we've got an amortised<br>
<code>O(1)~*</code> performance for both (if my maths is right, and it may very<br>
well not be, so please verify!).</p>
<p>In order to keep <code>FdPool</code> fairly generic, I've made sure not to hard-code<br>
it for the current type system generated by <code>wig</code> (i.e., <code>wasi::__wasi_fd_t</code><br>
representing WASI handle), but rather, any type which wants to be managed<br>
by <code>FdPool</code> needs to conform to <code>Fd</code> trait. This trait is quite simple as<br>
it only requires a couple of rudimentary traits (although <code>std:#️⃣:Hash</code><br>
is quite a powerful assumption here!), and a custom method</p>
<div class="codehilite"><pre><span></span><span class="n">Fd</span>::<span class="n">next</span><span class="p">(</span><span class="o">&amp;</span><span class="bp">self</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nb">Option</span><span class="o">&lt;</span><span class="n">Self</span><span class="o">&gt;</span><span class="p">;</span><span class="w"></span>
</pre></div>


<p>which is there to encapsulate creating another handle from the given one.<br>
In the current state of the code, that'd be simply <code>u32::checked_add(1)</code>.<br>
When <code>wiggle</code> makes it way into the <code>wasi-common</code>, I'd imagine it being<br>
similar to</p>
<div class="codehilite"><pre><span></span><span class="k">fn</span> <span class="nf">next</span><span class="p">(</span><span class="o">&amp;</span><span class="bp">self</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nb">Option</span><span class="o">&lt;</span><span class="n">Self</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="bp">self</span><span class="p">.</span><span class="mf">0.</span><span class="n">checked_add</span><span class="p">(</span><span class="mi">1</span><span class="p">).</span><span class="n">map</span><span class="p">(</span><span class="n">Self</span>::<span class="n">from</span><span class="p">)</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>


<p>Anyhow, I'd be happy to learn your thoughts about this design!</p>
</blockquote>



<a name="190873117"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231329%20%5Bwasi-common%5D%20add%20custom%20FdPool%20conta.../near/190873117" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231329.20.5Bwasi-common.5D.20add.20custom.20FdPool.20conta.2E.2E.2E.html#190873117">(Mar 17 2020 at 16:21)</a>:</h4>
<p><strong>kubkon</strong> requested <a href="https://github.com/alexcrichton" target="_blank" title="https://github.com/alexcrichton">alexcrichton</a>, <a href="https://github.com/pchickey" target="_blank" title="https://github.com/pchickey">pchickey</a>, and <a href="https://github.com/sunfishcode" target="_blank" title="https://github.com/sunfishcode">sunfishcode</a> for a review on <a href="https://github.com/bytecodealliance/wasmtime/pull/1329" target="_blank" title="https://github.com/bytecodealliance/wasmtime/pull/1329">PR #1329</a>.</p>



<a name="190876123"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231329%20%5Bwasi-common%5D%20add%20custom%20FdPool%20conta.../near/190876123" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231329.20.5Bwasi-common.5D.20add.20custom.20FdPool.20conta.2E.2E.2E.html#190876123">(Mar 17 2020 at 16:40)</a>:</h4>
<p>alexcrichton submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/1329#pullrequestreview-376210956" target="_blank" title="https://github.com/bytecodealliance/wasmtime/pull/1329#pullrequestreview-376210956">PR Review</a>.</p>



<a name="190880375"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231329%20%5Bwasi-common%5D%20add%20custom%20FdPool%20conta.../near/190880375" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231329.20.5Bwasi-common.5D.20add.20custom.20FdPool.20conta.2E.2E.2E.html#190880375">(Mar 17 2020 at 17:06)</a>:</h4>
<p>sunfishcode submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/1329#pullrequestreview-376212900" target="_blank" title="https://github.com/bytecodealliance/wasmtime/pull/1329#pullrequestreview-376212900">PR Review</a>.</p>



<a name="190880376"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231329%20%5Bwasi-common%5D%20add%20custom%20FdPool%20conta.../near/190880376" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231329.20.5Bwasi-common.5D.20add.20custom.20FdPool.20conta.2E.2E.2E.html#190880376">(Mar 17 2020 at 17:06)</a>:</h4>
<p>sunfishcode submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/1329#pullrequestreview-376212900" target="_blank" title="https://github.com/bytecodealliance/wasmtime/pull/1329#pullrequestreview-376212900">PR Review</a>.</p>



<a name="190880378"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231329%20%5Bwasi-common%5D%20add%20custom%20FdPool%20conta.../near/190880378" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231329.20.5Bwasi-common.5D.20add.20custom.20FdPool.20conta.2E.2E.2E.html#190880378">(Mar 17 2020 at 17:06)</a>:</h4>
<p>sunfishcode created <a href="https://github.com/bytecodealliance/wasmtime/pull/1329#discussion_r393818209" target="_blank" title="https://github.com/bytecodealliance/wasmtime/pull/1329#discussion_r393818209">PR Review Comment</a>:</p>
<blockquote>
<p>This can use a slice literal, <code>&amp;[ ... ]</code>, instead of a temporary <code>vec!</code>.</p>
</blockquote>



<a name="190880379"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231329%20%5Bwasi-common%5D%20add%20custom%20FdPool%20conta.../near/190880379" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231329.20.5Bwasi-common.5D.20add.20custom.20FdPool.20conta.2E.2E.2E.html#190880379">(Mar 17 2020 at 17:06)</a>:</h4>
<p>sunfishcode created <a href="https://github.com/bytecodealliance/wasmtime/pull/1329#discussion_r393829284" target="_blank" title="https://github.com/bytecodealliance/wasmtime/pull/1329#discussion_r393829284">PR Review Comment</a>:</p>
<blockquote>
<p>In place of the <code>claimed</code> check (which I propose removing above), this can instead <code>assert</code> that <code>fd</code> is not greater than <code>next_alloc</code>, and <code>debug_assert</code> that it's not in <code>available</code> (<code>debug_assert</code> because it could be slow in some cases).</p>
</blockquote>



<a name="190880380"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231329%20%5Bwasi-common%5D%20add%20custom%20FdPool%20conta.../near/190880380" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231329.20.5Bwasi-common.5D.20add.20custom.20FdPool.20conta.2E.2E.2E.html#190880380">(Mar 17 2020 at 17:06)</a>:</h4>
<p>sunfishcode created <a href="https://github.com/bytecodealliance/wasmtime/pull/1329#discussion_r393818571" target="_blank" title="https://github.com/bytecodealliance/wasmtime/pull/1329#discussion_r393818571">PR Review Comment</a>:</p>
<blockquote>
<p>As above, this can use a slice literal instead of a temporary <code>vec!</code>.</p>
</blockquote>



<a name="190880381"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231329%20%5Bwasi-common%5D%20add%20custom%20FdPool%20conta.../near/190880381" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231329.20.5Bwasi-common.5D.20add.20custom.20FdPool.20conta.2E.2E.2E.html#190880381">(Mar 17 2020 at 17:06)</a>:</h4>
<p>sunfishcode created <a href="https://github.com/bytecodealliance/wasmtime/pull/1329#discussion_r393824177" target="_blank" title="https://github.com/bytecodealliance/wasmtime/pull/1329#discussion_r393824177">PR Review Comment</a>:</p>
<blockquote>
<p>For tidiness, we should do the <code>entries.remove</code> before doing the <code>fds.deallocate</code>, so that we remove things in reverse order from how we add them, so that we maintain an invariant that at any time a <code>fd</code> is in <code>entries</code>, it's allocated in <code>fds</code> too.</p>
<p>With that, we can remove the <code>claimed</code> field of <code>FdPool</code>, and assume that removal always succeeds.</p>
</blockquote>



<a name="190884994"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231329%20%5Bwasi-common%5D%20add%20custom%20FdPool%20conta.../near/190884994" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231329.20.5Bwasi-common.5D.20add.20custom.20FdPool.20conta.2E.2E.2E.html#190884994">(Mar 17 2020 at 17:37)</a>:</h4>
<p>kubkon submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/1329#pullrequestreview-376260158" target="_blank" title="https://github.com/bytecodealliance/wasmtime/pull/1329#pullrequestreview-376260158">PR Review</a>.</p>



<a name="190884995"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231329%20%5Bwasi-common%5D%20add%20custom%20FdPool%20conta.../near/190884995" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231329.20.5Bwasi-common.5D.20add.20custom.20FdPool.20conta.2E.2E.2E.html#190884995">(Mar 17 2020 at 17:37)</a>:</h4>
<p>kubkon created <a href="https://github.com/bytecodealliance/wasmtime/pull/1329#discussion_r393854900" target="_blank" title="https://github.com/bytecodealliance/wasmtime/pull/1329#discussion_r393854900">PR Review Comment</a>:</p>
<blockquote>
<p>The reason I didn't use slice literal here is due to the dereferencing rules. In <code>PendingEntry::File</code> arm we use <code>OsHandle::from</code> which requires <code>std::fs::File</code>, and with slice literal we provide a ref instead.</p>
</blockquote>



<a name="190885015"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231329%20%5Bwasi-common%5D%20add%20custom%20FdPool%20conta.../near/190885015" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231329.20.5Bwasi-common.5D.20add.20custom.20FdPool.20conta.2E.2E.2E.html#190885015">(Mar 17 2020 at 17:38)</a>:</h4>
<p>kubkon submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/1329#pullrequestreview-376260290" target="_blank" title="https://github.com/bytecodealliance/wasmtime/pull/1329#pullrequestreview-376260290">PR Review</a>.</p>



<a name="190885016"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231329%20%5Bwasi-common%5D%20add%20custom%20FdPool%20conta.../near/190885016" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231329.20.5Bwasi-common.5D.20add.20custom.20FdPool.20conta.2E.2E.2E.html#190885016">(Mar 17 2020 at 17:38)</a>:</h4>
<p>kubkon created <a href="https://github.com/bytecodealliance/wasmtime/pull/1329#discussion_r393855000" target="_blank" title="https://github.com/bytecodealliance/wasmtime/pull/1329#discussion_r393855000">PR Review Comment</a>:</p>
<blockquote>
<p>See above.</p>
</blockquote>



<a name="190885497"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231329%20%5Bwasi-common%5D%20add%20custom%20FdPool%20conta.../near/190885497" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231329.20.5Bwasi-common.5D.20add.20custom.20FdPool.20conta.2E.2E.2E.html#190885497">(Mar 17 2020 at 17:40)</a>:</h4>
<p>kubkon submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/1329#pullrequestreview-376262528" target="_blank" title="https://github.com/bytecodealliance/wasmtime/pull/1329#pullrequestreview-376262528">PR Review</a>.</p>



<a name="190885498"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231329%20%5Bwasi-common%5D%20add%20custom%20FdPool%20conta.../near/190885498" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231329.20.5Bwasi-common.5D.20add.20custom.20FdPool.20conta.2E.2E.2E.html#190885498">(Mar 17 2020 at 17:40)</a>:</h4>
<p>kubkon created <a href="https://github.com/bytecodealliance/wasmtime/pull/1329#discussion_r393856760" target="_blank" title="https://github.com/bytecodealliance/wasmtime/pull/1329#discussion_r393856760">PR Review Comment</a>:</p>
<blockquote>
<p>Hmm, I'm fine with asserts. However, the reason I've designed <code>deallocate</code> return <code>bool</code> was to mimic the behaviour of <code>HashSet::remove</code> which returns a <code>bool</code> to signal if removal worked or not (i.e., if any element was actually removed in the end). In this case, I guess you're right that if we try removing from the <code>claimed</code> <code>HashSet</code> and it actually fails, then something went horribly wrong as it shouldn't ever happen.</p>
</blockquote>



<a name="190885524"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231329%20%5Bwasi-common%5D%20add%20custom%20FdPool%20conta.../near/190885524" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231329.20.5Bwasi-common.5D.20add.20custom.20FdPool.20conta.2E.2E.2E.html#190885524">(Mar 17 2020 at 17:40)</a>:</h4>
<p>kubkon submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/1329#pullrequestreview-376262672" target="_blank" title="https://github.com/bytecodealliance/wasmtime/pull/1329#pullrequestreview-376262672">PR Review</a>.</p>



<a name="190885525"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231329%20%5Bwasi-common%5D%20add%20custom%20FdPool%20conta.../near/190885525" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231329.20.5Bwasi-common.5D.20add.20custom.20FdPool.20conta.2E.2E.2E.html#190885525">(Mar 17 2020 at 17:40)</a>:</h4>
<p>kubkon created <a href="https://github.com/bytecodealliance/wasmtime/pull/1329#discussion_r393856888" target="_blank" title="https://github.com/bytecodealliance/wasmtime/pull/1329#discussion_r393856888">PR Review Comment</a>:</p>
<blockquote>
<p>Ah, good call, thanks!</p>
</blockquote>



<a name="190885878"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231329%20%5Bwasi-common%5D%20add%20custom%20FdPool%20conta.../near/190885878" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231329.20.5Bwasi-common.5D.20add.20custom.20FdPool.20conta.2E.2E.2E.html#190885878">(Mar 17 2020 at 17:43)</a>:</h4>
<p>sunfishcode submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/1329#pullrequestreview-376264556" target="_blank" title="https://github.com/bytecodealliance/wasmtime/pull/1329#pullrequestreview-376264556">PR Review</a>.</p>



<a name="190885879"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231329%20%5Bwasi-common%5D%20add%20custom%20FdPool%20conta.../near/190885879" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231329.20.5Bwasi-common.5D.20add.20custom.20FdPool.20conta.2E.2E.2E.html#190885879">(Mar 17 2020 at 17:43)</a>:</h4>
<p>sunfishcode created <a href="https://github.com/bytecodealliance/wasmtime/pull/1329#discussion_r393858348" target="_blank" title="https://github.com/bytecodealliance/wasmtime/pull/1329#discussion_r393858348">PR Review Comment</a>:</p>
<blockquote>
<p>Ah, makes sense!</p>
</blockquote>



<a name="190885971"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231329%20%5Bwasi-common%5D%20add%20custom%20FdPool%20conta.../near/190885971" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231329.20.5Bwasi-common.5D.20add.20custom.20FdPool.20conta.2E.2E.2E.html#190885971">(Mar 17 2020 at 17:44)</a>:</h4>
<p>kubkon created <a href="https://github.com/bytecodealliance/wasmtime/pull/1329#discussion_r393858815" target="_blank" title="https://github.com/bytecodealliance/wasmtime/pull/1329#discussion_r393858815">PR Review Comment</a>:</p>
<blockquote>
<p>Oh, after re-reading your comment again, checking whether <code>fd</code> is not greater than <code>next_alloc</code> will require an <code>if</code> anyway since <code>next_alloc</code> is wrapped in an <code>Option</code> and it will not always be guaranteed to be <code>Some</code> (in particular, when we exceed all possible allocs for instance, e.g., <code>std::u32::MAX</code>).</p>
</blockquote>



<a name="190885972"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231329%20%5Bwasi-common%5D%20add%20custom%20FdPool%20conta.../near/190885972" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231329.20.5Bwasi-common.5D.20add.20custom.20FdPool.20conta.2E.2E.2E.html#190885972">(Mar 17 2020 at 17:44)</a>:</h4>
<p>kubkon submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/1329#pullrequestreview-376265128" target="_blank" title="https://github.com/bytecodealliance/wasmtime/pull/1329#pullrequestreview-376265128">PR Review</a>.</p>



<a name="190886161"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231329%20%5Bwasi-common%5D%20add%20custom%20FdPool%20conta.../near/190886161" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231329.20.5Bwasi-common.5D.20add.20custom.20FdPool.20conta.2E.2E.2E.html#190886161">(Mar 17 2020 at 17:45)</a>:</h4>
<p>kubkon submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/1329#pullrequestreview-376266161" target="_blank" title="https://github.com/bytecodealliance/wasmtime/pull/1329#pullrequestreview-376266161">PR Review</a>.</p>



<a name="190886162"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231329%20%5Bwasi-common%5D%20add%20custom%20FdPool%20conta.../near/190886162" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231329.20.5Bwasi-common.5D.20add.20custom.20FdPool.20conta.2E.2E.2E.html#190886162">(Mar 17 2020 at 17:45)</a>:</h4>
<p>kubkon created <a href="https://github.com/bytecodealliance/wasmtime/pull/1329#discussion_r393859582" target="_blank" title="https://github.com/bytecodealliance/wasmtime/pull/1329#discussion_r393859582">PR Review Comment</a>:</p>
<blockquote>
<p>Given the above, unless you can think of a cleaner way of doing it, I guess I'd be in favour of the original approach. What do you think?</p>
</blockquote>



<a name="190886896"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231329%20%5Bwasi-common%5D%20add%20custom%20FdPool%20conta.../near/190886896" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231329.20.5Bwasi-common.5D.20add.20custom.20FdPool.20conta.2E.2E.2E.html#190886896">(Mar 17 2020 at 17:50)</a>:</h4>
<p>kubkon updated <a href="https://github.com/bytecodealliance/wasmtime/pull/1329" target="_blank" title="https://github.com/bytecodealliance/wasmtime/pull/1329">PR #1329</a> from <code>fd_handles</code> to <code>master</code>:</p>
<blockquote>
<p>This PR adds a custom <code>FdPool</code> container which is intended<br>
for use in <code>wasi-common</code> to track WASI fd allocs/deallocs. The<br>
main aim for this container is to abstract away the current<br>
approach of spawning new handles</p>
<div class="codehilite"><pre><span></span><span class="n">fd</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">fd</span><span class="p">.</span><span class="n">checked_add</span><span class="p">(</span><span class="mi">1</span><span class="p">).</span><span class="n">ok_or</span><span class="p">(...)</span><span class="o">?</span><span class="p">;</span><span class="w"></span>
</pre></div>


<p>and to make it possible to reuse unused/reclaimed handles<br>
which currently is not done.</p>
<p>The struct offers 3 methods to manage its functionality:</p>
<ul>
<li>
<p><code>FdPool::new</code> initialises the internal data structures,<br>
  and most notably, it preallocates an <code>FdPool::BATCH_SIZE</code><br>
  worth of handles in such a way that we always start popping<br>
  from the "smallest" handle (think of it as of reversed stack,<br>
  I guess; it's not a binary heap since we don't really care<br>
  whether internally the handles are sorted in some way, just that<br>
  the "largets" handle is at the bottom. Why will become clear<br>
  when describing <code>allocate</code> method.)</p>
</li>
<li>
<p><code>FdPool::allocate</code> pops the next available handle if one is available.<br>
  The tricky bit here is that, if we run out of handles, we preallocate<br>
  the next <code>FdPool::BATCH_SIZE</code> worth of handles starting from the<br>
  latest popped handle (i.e., the "largest" handle). This<br>
  works only because we make sure to only ever pop and push already<br>
  existing handles from the back, and push _new_ handles (from the<br>
  preallocation step) from the front. When we ultimately run out<br>
  of _all_ available handles, we then return <code>None</code> for the client<br>
  to handle in some way (e.g., throwing an error such as <code>WasiError::EMFILE</code><br>
  or whatnot).</p>
</li>
<li>
<p><code>FdPool::deallocate</code> returns the already allocated handle back to<br>
  the pool for further reuse.</p>
</li>
</ul>
<p>When figuring out the internals, I've tried to optimise for both<br>
alloc and dealloc performance, and I believe we've got an amortised<br>
<code>O(1)~*</code> performance for both (if my maths is right, and it may very<br>
well not be, so please verify!).</p>
<p>In order to keep <code>FdPool</code> fairly generic, I've made sure not to hard-code<br>
it for the current type system generated by <code>wig</code> (i.e., <code>wasi::__wasi_fd_t</code><br>
representing WASI handle), but rather, any type which wants to be managed<br>
by <code>FdPool</code> needs to conform to <code>Fd</code> trait. This trait is quite simple as<br>
it only requires a couple of rudimentary traits (although <code>std:#️⃣:Hash</code><br>
is quite a powerful assumption here!), and a custom method</p>
<div class="codehilite"><pre><span></span><span class="n">Fd</span>::<span class="n">next</span><span class="p">(</span><span class="o">&amp;</span><span class="bp">self</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nb">Option</span><span class="o">&lt;</span><span class="n">Self</span><span class="o">&gt;</span><span class="p">;</span><span class="w"></span>
</pre></div>


<p>which is there to encapsulate creating another handle from the given one.<br>
In the current state of the code, that'd be simply <code>u32::checked_add(1)</code>.<br>
When <code>wiggle</code> makes it way into the <code>wasi-common</code>, I'd imagine it being<br>
similar to</p>
<div class="codehilite"><pre><span></span><span class="k">fn</span> <span class="nf">next</span><span class="p">(</span><span class="o">&amp;</span><span class="bp">self</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nb">Option</span><span class="o">&lt;</span><span class="n">Self</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="bp">self</span><span class="p">.</span><span class="mf">0.</span><span class="n">checked_add</span><span class="p">(</span><span class="mi">1</span><span class="p">).</span><span class="n">map</span><span class="p">(</span><span class="n">Self</span>::<span class="n">from</span><span class="p">)</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>


<p>Anyhow, I'd be happy to learn your thoughts about this design!</p>
</blockquote>



<a name="190886984"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231329%20%5Bwasi-common%5D%20add%20custom%20FdPool%20conta.../near/190886984" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231329.20.5Bwasi-common.5D.20add.20custom.20FdPool.20conta.2E.2E.2E.html#190886984">(Mar 17 2020 at 17:51)</a>:</h4>
<p>kubkon created <a href="https://github.com/bytecodealliance/wasmtime/pull/1329#discussion_r393863454" target="_blank" title="https://github.com/bytecodealliance/wasmtime/pull/1329#discussion_r393863454">PR Review Comment</a>:</p>
<blockquote>
<p>Done in 647cc1f. I'm still a little bit unclear how to address <code>FdPool::deallocate</code> though. Would you mind giving it another look after re-reading my comments please?</p>
</blockquote>



<a name="190886985"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231329%20%5Bwasi-common%5D%20add%20custom%20FdPool%20conta.../near/190886985" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231329.20.5Bwasi-common.5D.20add.20custom.20FdPool.20conta.2E.2E.2E.html#190886985">(Mar 17 2020 at 17:51)</a>:</h4>
<p>kubkon submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/1329#pullrequestreview-376271005" target="_blank" title="https://github.com/bytecodealliance/wasmtime/pull/1329#pullrequestreview-376271005">PR Review</a>.</p>



<a name="190887391"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231329%20%5Bwasi-common%5D%20add%20custom%20FdPool%20conta.../near/190887391" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231329.20.5Bwasi-common.5D.20add.20custom.20FdPool.20conta.2E.2E.2E.html#190887391">(Mar 17 2020 at 17:54)</a>:</h4>
<p>kubkon created <a href="https://github.com/bytecodealliance/wasmtime/pull/1329#discussion_r393865518" target="_blank" title="https://github.com/bytecodealliance/wasmtime/pull/1329#discussion_r393865518">PR Review Comment</a>:</p>
<blockquote>
<p>Perhaps we could <code>assert!</code> on <code>self.claimed.remove</code> instead? This would ensure we <code>panic!</code> if the client code ever provides an illegal <code>fd</code> value?</p>
</blockquote>



<a name="190887392"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231329%20%5Bwasi-common%5D%20add%20custom%20FdPool%20conta.../near/190887392" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231329.20.5Bwasi-common.5D.20add.20custom.20FdPool.20conta.2E.2E.2E.html#190887392">(Mar 17 2020 at 17:54)</a>:</h4>
<p>kubkon submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/1329#pullrequestreview-376273604" target="_blank" title="https://github.com/bytecodealliance/wasmtime/pull/1329#pullrequestreview-376273604">PR Review</a>.</p>



<a name="190904317"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231329%20%5Bwasi-common%5D%20add%20custom%20FdPool%20conta.../near/190904317" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231329.20.5Bwasi-common.5D.20add.20custom.20FdPool.20conta.2E.2E.2E.html#190904317">(Mar 17 2020 at 20:08)</a>:</h4>
<p>kubkon updated <a href="https://github.com/bytecodealliance/wasmtime/pull/1329" target="_blank" title="https://github.com/bytecodealliance/wasmtime/pull/1329">PR #1329</a> from <code>fd_handles</code> to <code>master</code>:</p>
<blockquote>
<p>This PR adds a custom <code>FdPool</code> container which is intended<br>
for use in <code>wasi-common</code> to track WASI fd allocs/deallocs. The<br>
main aim for this container is to abstract away the current<br>
approach of spawning new handles</p>
<div class="codehilite"><pre><span></span><span class="n">fd</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">fd</span><span class="p">.</span><span class="n">checked_add</span><span class="p">(</span><span class="mi">1</span><span class="p">).</span><span class="n">ok_or</span><span class="p">(...)</span><span class="o">?</span><span class="p">;</span><span class="w"></span>
</pre></div>


<p>and to make it possible to reuse unused/reclaimed handles<br>
which currently is not done.</p>
<p>The struct offers 3 methods to manage its functionality:</p>
<ul>
<li>
<p><code>FdPool::new</code> initialises the internal data structures,<br>
  and most notably, it preallocates an <code>FdPool::BATCH_SIZE</code><br>
  worth of handles in such a way that we always start popping<br>
  from the "smallest" handle (think of it as of reversed stack,<br>
  I guess; it's not a binary heap since we don't really care<br>
  whether internally the handles are sorted in some way, just that<br>
  the "largets" handle is at the bottom. Why will become clear<br>
  when describing <code>allocate</code> method.)</p>
</li>
<li>
<p><code>FdPool::allocate</code> pops the next available handle if one is available.<br>
  The tricky bit here is that, if we run out of handles, we preallocate<br>
  the next <code>FdPool::BATCH_SIZE</code> worth of handles starting from the<br>
  latest popped handle (i.e., the "largest" handle). This<br>
  works only because we make sure to only ever pop and push already<br>
  existing handles from the back, and push _new_ handles (from the<br>
  preallocation step) from the front. When we ultimately run out<br>
  of _all_ available handles, we then return <code>None</code> for the client<br>
  to handle in some way (e.g., throwing an error such as <code>WasiError::EMFILE</code><br>
  or whatnot).</p>
</li>
<li>
<p><code>FdPool::deallocate</code> returns the already allocated handle back to<br>
  the pool for further reuse.</p>
</li>
</ul>
<p>When figuring out the internals, I've tried to optimise for both<br>
alloc and dealloc performance, and I believe we've got an amortised<br>
<code>O(1)~*</code> performance for both (if my maths is right, and it may very<br>
well not be, so please verify!).</p>
<p>In order to keep <code>FdPool</code> fairly generic, I've made sure not to hard-code<br>
it for the current type system generated by <code>wig</code> (i.e., <code>wasi::__wasi_fd_t</code><br>
representing WASI handle), but rather, any type which wants to be managed<br>
by <code>FdPool</code> needs to conform to <code>Fd</code> trait. This trait is quite simple as<br>
it only requires a couple of rudimentary traits (although <code>std:#️⃣:Hash</code><br>
is quite a powerful assumption here!), and a custom method</p>
<div class="codehilite"><pre><span></span><span class="n">Fd</span>::<span class="n">next</span><span class="p">(</span><span class="o">&amp;</span><span class="bp">self</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nb">Option</span><span class="o">&lt;</span><span class="n">Self</span><span class="o">&gt;</span><span class="p">;</span><span class="w"></span>
</pre></div>


<p>which is there to encapsulate creating another handle from the given one.<br>
In the current state of the code, that'd be simply <code>u32::checked_add(1)</code>.<br>
When <code>wiggle</code> makes it way into the <code>wasi-common</code>, I'd imagine it being<br>
similar to</p>
<div class="codehilite"><pre><span></span><span class="k">fn</span> <span class="nf">next</span><span class="p">(</span><span class="o">&amp;</span><span class="bp">self</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nb">Option</span><span class="o">&lt;</span><span class="n">Self</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="bp">self</span><span class="p">.</span><span class="mf">0.</span><span class="n">checked_add</span><span class="p">(</span><span class="mi">1</span><span class="p">).</span><span class="n">map</span><span class="p">(</span><span class="n">Self</span>::<span class="n">from</span><span class="p">)</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>


<p>Anyhow, I'd be happy to learn your thoughts about this design!</p>
</blockquote>



<a name="190904953"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231329%20%5Bwasi-common%5D%20add%20custom%20FdPool%20conta.../near/190904953" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231329.20.5Bwasi-common.5D.20add.20custom.20FdPool.20conta.2E.2E.2E.html#190904953">(Mar 17 2020 at 20:13)</a>:</h4>
<p><strong>kubkon</strong> requested <a href="https://github.com/alexcrichton" target="_blank" title="https://github.com/alexcrichton">alexcrichton</a>, and <a href="https://github.com/pchickey" target="_blank" title="https://github.com/pchickey">pchickey</a> for a review on <a href="https://github.com/bytecodealliance/wasmtime/pull/1329" target="_blank" title="https://github.com/bytecodealliance/wasmtime/pull/1329">PR #1329</a>.</p>



<a name="190904957"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231329%20%5Bwasi-common%5D%20add%20custom%20FdPool%20conta.../near/190904957" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231329.20.5Bwasi-common.5D.20add.20custom.20FdPool.20conta.2E.2E.2E.html#190904957">(Mar 17 2020 at 20:13)</a>:</h4>
<p><strong>kubkon</strong> requested <a href="https://github.com/alexcrichton" target="_blank" title="https://github.com/alexcrichton">alexcrichton</a>, <a href="https://github.com/pchickey" target="_blank" title="https://github.com/pchickey">pchickey</a>, and <a href="https://github.com/sunfishcode" target="_blank" title="https://github.com/sunfishcode">sunfishcode</a> for a review on <a href="https://github.com/bytecodealliance/wasmtime/pull/1329" target="_blank" title="https://github.com/bytecodealliance/wasmtime/pull/1329">PR #1329</a>.</p>



<a name="190905689"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231329%20%5Bwasi-common%5D%20add%20custom%20FdPool%20conta.../near/190905689" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231329.20.5Bwasi-common.5D.20add.20custom.20FdPool.20conta.2E.2E.2E.html#190905689">(Mar 17 2020 at 20:20)</a>:</h4>
<p>alexcrichton submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/1329#pullrequestreview-376375203" target="_blank" title="https://github.com/bytecodealliance/wasmtime/pull/1329#pullrequestreview-376375203">PR Review</a>.</p>



<a name="190906211"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231329%20%5Bwasi-common%5D%20add%20custom%20FdPool%20conta.../near/190906211" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231329.20.5Bwasi-common.5D.20add.20custom.20FdPool.20conta.2E.2E.2E.html#190906211">(Mar 17 2020 at 20:25)</a>:</h4>
<p>sunfishcode submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/1329#pullrequestreview-376378417" target="_blank" title="https://github.com/bytecodealliance/wasmtime/pull/1329#pullrequestreview-376378417">PR Review</a>.</p>



<a name="190916317"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231329%20%5Bwasi-common%5D%20add%20custom%20FdPool%20conta.../near/190916317" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231329.20.5Bwasi-common.5D.20add.20custom.20FdPool.20conta.2E.2E.2E.html#190916317">(Mar 17 2020 at 21:58)</a>:</h4>
<p>kubkon merged <a href="https://github.com/bytecodealliance/wasmtime/pull/1329" target="_blank" title="https://github.com/bytecodealliance/wasmtime/pull/1329">PR #1329</a>.</p>



<hr><p>Last updated: Jan 20 2025 at 06:04 UTC</p>
</html>