<html>
<head><meta charset="utf-8"><title>wasmtime / PR #7450 Cranelift: Reassociate constants out ... · git-wasmtime · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/index.html">git-wasmtime</a></h2>
<h3>Topic: <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.237450.20Cranelift.3A.20Reassociate.20constants.20out.20.2E.2E.2E.html">wasmtime / PR #7450 Cranelift: Reassociate constants out ...</a></h3>

<hr>

<base href="https://bytecodealliance.zulipchat.com">

<head><link href="https://bytecodealliance.github.io/zulip-archive/style.css" rel="stylesheet"></head>

<a name="399808819"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%237450%20Cranelift%3A%20Reassociate%20constants%20out%20.../near/399808819" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.237450.20Cranelift.3A.20Reassociate.20constants.20out.20.2E.2E.2E.html#399808819">(Nov 01 2023 at 21:52)</a>:</h4>
<p>fitzgen opened <a href="https://github.com/bytecodealliance/wasmtime/pull/7450">PR #7450</a> from <code>fitzgen:reassociate-constants-in-nested-shifts</code> to <code>bytecodealliance:main</code>:</p>
<blockquote>
<p>This allows for more constant propagation.</p>
<p>&lt;!--<br>
Please make sure you include the following information:</p>
<ul>
<li>
<p>If this work has been discussed elsewhere, please include a link to that<br>
  conversation. If it was discussed in an issue, just mention "issue #...".</p>
</li>
<li>
<p>Explain why this change is needed. If the details are in an issue already,<br>
  this can be brief.</p>
</li>
</ul>
<p>Our development process is documented in the Wasmtime book:<br>
<a href="https://docs.wasmtime.dev/contributing-development-process.html">https://docs.wasmtime.dev/contributing-development-process.html</a></p>
<p>Please ensure all communication follows the code of conduct:<br>
<a href="https://github.com/bytecodealliance/wasmtime/blob/main/CODE_OF_CONDUCT.md">https://github.com/bytecodealliance/wasmtime/blob/main/CODE_OF_CONDUCT.md</a><br>
--&gt;</p>
</blockquote>



<a name="399808820"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%237450%20Cranelift%3A%20Reassociate%20constants%20out%20.../near/399808820" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.237450.20Cranelift.3A.20Reassociate.20constants.20out.20.2E.2E.2E.html#399808820">(Nov 01 2023 at 21:52)</a>:</h4>
<p><strong>fitzgen</strong> requested <a href="https://github.com/elliottt">elliottt</a> for a review on <a href="https://github.com/bytecodealliance/wasmtime/pull/7450">PR #7450</a>.</p>



<a name="399808821"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%237450%20Cranelift%3A%20Reassociate%20constants%20out%20.../near/399808821" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.237450.20Cranelift.3A.20Reassociate.20constants.20out.20.2E.2E.2E.html#399808821">(Nov 01 2023 at 21:52)</a>:</h4>
<p><strong>fitzgen</strong> requested <a href="https://github.com/orgs/bytecodealliance/teams/wasmtime-compiler-reviewers">wasmtime-compiler-reviewers</a> for a review on <a href="https://github.com/bytecodealliance/wasmtime/pull/7450">PR #7450</a>.</p>



<a name="399810282"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%237450%20Cranelift%3A%20Reassociate%20constants%20out%20.../near/399810282" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.237450.20Cranelift.3A.20Reassociate.20constants.20out.20.2E.2E.2E.html#399810282">(Nov 01 2023 at 22:03)</a>:</h4>
<p>afonso360 submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/7450#pullrequestreview-1709152263">PR review</a>.</p>



<a name="399810283"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%237450%20Cranelift%3A%20Reassociate%20constants%20out%20.../near/399810283" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.237450.20Cranelift.3A.20Reassociate.20constants.20out.20.2E.2E.2E.html#399810283">(Nov 01 2023 at 22:03)</a>:</h4>
<p>afonso360 created <a href="https://github.com/bytecodealliance/wasmtime/pull/7450#discussion_r1379377330">PR review comment</a>:</p>
<blockquote>
<p>I think this doesn't hold if <code>(c + b) &gt;= ty_bits</code> right? Either way I'm going to run fuzzgen on this for a while to doublecheck.</p>
</blockquote>



<a name="399812810"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%237450%20Cranelift%3A%20Reassociate%20constants%20out%20.../near/399812810" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.237450.20Cranelift.3A.20Reassociate.20constants.20out.20.2E.2E.2E.html#399812810">(Nov 01 2023 at 22:31)</a>:</h4>
<p>fitzgen submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/7450#pullrequestreview-1709178176">PR review</a>.</p>



<a name="399812812"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%237450%20Cranelift%3A%20Reassociate%20constants%20out%20.../near/399812812" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.237450.20Cranelift.3A.20Reassociate.20constants.20out.20.2E.2E.2E.html#399812812">(Nov 01 2023 at 22:31)</a>:</h4>
<p>fitzgen created <a href="https://github.com/bytecodealliance/wasmtime/pull/7450#discussion_r1379396186">PR review comment</a>:</p>
<blockquote>
<p>Ah yeah unfortunately I think you are right:</p>
<div class="codehilite" data-code-language="smt"><pre><span></span><code>(declare-const a (_ BitVec 32))
(declare-const b (_ BitVec 32))
(declare-const c (_ BitVec 32))

(define-fun shl ((x (_ BitVec 32)) (y (_ BitVec 32))) (_ BitVec 32)
  (let ((z (bvurem y #x00000020)))
    (bvshl x z)))


(assert (not (= (shl (shl a b) c)
                (shl a (bvadd b c)))))

(check-sat)
(get-model)
</code></pre></div>
<p>Produces</p>
<div class="codehilite" data-code-language="smt"><pre><span></span><code>sat
(
  (define-fun b () (_ BitVec 32)
    #x00000010)
  (define-fun a () (_ BitVec 32)
    #xf879c486)
  (define-fun c () (_ BitVec 32)
    #x00000010)
)
</code></pre></div>
<p>and then</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="k">fn</span> <span class="nf">shl</span><span class="p">(</span><span class="n">a</span>: <span class="kt">u32</span><span class="p">,</span><span class="w"> </span><span class="n">b</span>: <span class="kt">u32</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="kt">u32</span> <span class="p">{</span>
<span class="w">    </span><span class="n">a</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="p">(</span><span class="n">b</span><span class="w"> </span><span class="o">%</span><span class="w"> </span><span class="mi">32</span><span class="p">)</span>
<span class="p">}</span>

<span class="k">fn</span> <span class="nf">foo</span><span class="p">(</span><span class="n">a</span>: <span class="kt">u32</span><span class="p">,</span><span class="w"> </span><span class="n">b</span>: <span class="kt">u32</span><span class="p">,</span><span class="w"> </span><span class="n">c</span>: <span class="kt">u32</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="kt">u32</span> <span class="p">{</span>
<span class="w">    </span><span class="n">shl</span><span class="p">(</span><span class="n">shl</span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="w"> </span><span class="n">b</span><span class="p">),</span><span class="w"> </span><span class="n">c</span><span class="p">)</span>
<span class="p">}</span>

<span class="k">fn</span> <span class="nf">bar</span><span class="p">(</span><span class="n">a</span>: <span class="kt">u32</span><span class="p">,</span><span class="w"> </span><span class="n">b</span>: <span class="kt">u32</span><span class="p">,</span><span class="w"> </span><span class="n">c</span>: <span class="kt">u32</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="kt">u32</span> <span class="p">{</span>
<span class="w">    </span><span class="n">shl</span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="w"> </span><span class="n">b</span><span class="p">.</span><span class="n">wrapping_add</span><span class="p">(</span><span class="n">c</span><span class="p">))</span>
<span class="p">}</span>

<span class="k">fn</span> <span class="nf">main</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">0xf879c486</span><span class="p">;</span>
<span class="w">    </span><span class="fm">dbg!</span><span class="p">(</span><span class="n">a</span><span class="p">);</span>

<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">b</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">0x00000010</span><span class="p">;</span>
<span class="w">    </span><span class="fm">dbg!</span><span class="p">(</span><span class="n">b</span><span class="p">);</span>

<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">c</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">0x00000010</span><span class="p">;</span>
<span class="w">    </span><span class="fm">dbg!</span><span class="p">(</span><span class="n">c</span><span class="p">);</span>

<span class="w">    </span><span class="fm">dbg!</span><span class="p">(</span><span class="n">foo</span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="w"> </span><span class="n">b</span><span class="p">,</span><span class="w"> </span><span class="n">c</span><span class="p">));</span>
<span class="w">    </span><span class="fm">dbg!</span><span class="p">(</span><span class="n">bar</span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="w"> </span><span class="n">b</span><span class="p">,</span><span class="w"> </span><span class="n">c</span><span class="p">));</span>
<span class="p">}</span>
</code></pre></div>
<p>produces</p>
<p><div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="p">[</span><span class="n">src</span><span class="o">/</span><span class="n">main</span><span class="p">.</span><span class="n">rs</span>:<span class="mi">15</span><span class="p">]</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">4168729734</span>
<span class="p">[</span><span class="n">src</span><span class="o">/</span><span class="n">main</span><span class="p">.</span><span class="n">rs</span>:<span class="mi">18</span><span class="p">]</span><span class="w"> </span><span class="n">b</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">16</span>
<span class="p">[</span><span class="n">src</span><span class="o">/</span><span class="n">main</span><span class="p">.</span><span class="n">rs</span>:<span class="mi">21</span><span class="p">]</span><span class="w"> </span><span class="n">c</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">16</span>
<span class="p">[</span><span class="n">src</span><span class="o">/</span><span class="n">main</span><span class="p">.</span><span class="n">rs</span>:<span class="mi">23</span><span class="p">]</span><span class="w"> </span><span class="n">foo</span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="w"> </span><span class="n">b</span><span class="p">,</span><span class="w"> </span><span class="n">c</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span>
<span class="p">[</span><span class="n">src</span><span class="o">/</span><span class="n">main</span><span class="p">.</span><span class="n">rs</span>:<span class="mi">24</span><span class="p">]</span><span class="w"> </span><span class="n">bar</span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="w"> </span><span class="n">b</span><span class="p">,</span><span class="w"> </span><span class="n">c</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">4168729734</span>
</code></pre></div><br>
</p>
</blockquote>



<a name="399813719"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%237450%20Cranelift%3A%20Reassociate%20constants%20out%20.../near/399813719" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.237450.20Cranelift.3A.20Reassociate.20constants.20out.20.2E.2E.2E.html#399813719">(Nov 01 2023 at 22:40)</a>:</h4>
<p>fitzgen updated <a href="https://github.com/bytecodealliance/wasmtime/pull/7450">PR #7450</a>.</p>



<a name="399813814"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%237450%20Cranelift%3A%20Reassociate%20constants%20out%20.../near/399813814" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.237450.20Cranelift.3A.20Reassociate.20constants.20out.20.2E.2E.2E.html#399813814">(Nov 01 2023 at 22:40)</a>:</h4>
<p>fitzgen submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/7450#pullrequestreview-1709185429">PR review</a>.</p>



<a name="399813815"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%237450%20Cranelift%3A%20Reassociate%20constants%20out%20.../near/399813815" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.237450.20Cranelift.3A.20Reassociate.20constants.20out.20.2E.2E.2E.html#399813815">(Nov 01 2023 at 22:40)</a>:</h4>
<p>fitzgen created <a href="https://github.com/bytecodealliance/wasmtime/pull/7450#discussion_r1379401522">PR review comment</a>:</p>
<blockquote>
<p>Removed the rules that depended on this buggy identity.</p>
</blockquote>



<a name="399815940"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%237450%20Cranelift%3A%20Reassociate%20constants%20out%20.../near/399815940" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.237450.20Cranelift.3A.20Reassociate.20constants.20out.20.2E.2E.2E.html#399815940">(Nov 01 2023 at 23:00)</a>:</h4>
<p>afonso360 submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/7450#pullrequestreview-1709201535">PR review</a>:</p>
<blockquote>
<p><span aria-label="+1" class="emoji emoji-1f44d" role="img" title="+1">:+1:</span> LGTM!</p>
<p>Coincidentally I've been working on a similar set of rules at <a href="https://github.com/afonso360/wasmtime/tree/egraphs-shifts-2">egraphs-shifts-2</a>. I'll submit those as a PR tomorrow!</p>
</blockquote>



<a name="399816038"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%237450%20Cranelift%3A%20Reassociate%20constants%20out%20.../near/399816038" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.237450.20Cranelift.3A.20Reassociate.20constants.20out.20.2E.2E.2E.html#399816038">(Nov 01 2023 at 23:01)</a>:</h4>
<p>afonso360 submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/7450#pullrequestreview-1709201535">PR review</a>:</p>
<blockquote>
<p><span aria-label="+1" class="emoji emoji-1f44d" role="img" title="+1">:+1:</span> LGTM!</p>
<p>Coincidentally I've been working on a similar <a href="https://github.com/bytecodealliance/wasmtime/compare/main...afonso360:wasmtime:egraphs-shifts-2">set of rules</a>. I'll submit those as a PR tomorrow!</p>
</blockquote>



<a name="399820360"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%237450%20Cranelift%3A%20Reassociate%20constants%20out%20.../near/399820360" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.237450.20Cranelift.3A.20Reassociate.20constants.20out.20.2E.2E.2E.html#399820360">(Nov 01 2023 at 23:49)</a>:</h4>
<p>fitzgen merged <a href="https://github.com/bytecodealliance/wasmtime/pull/7450">PR #7450</a>.</p>



<hr><p>Last updated: Jan 20 2025 at 06:04 UTC</p>
</html>