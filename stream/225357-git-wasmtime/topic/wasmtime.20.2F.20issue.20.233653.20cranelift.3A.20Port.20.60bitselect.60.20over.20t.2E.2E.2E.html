<html>
<head><meta charset="utf-8"><title>wasmtime / issue #3653 cranelift: Port `bitselect` over t... · git-wasmtime · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/index.html">git-wasmtime</a></h2>
<h3>Topic: <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.233653.20cranelift.3A.20Port.20.60bitselect.60.20over.20t.2E.2E.2E.html">wasmtime / issue #3653 cranelift: Port `bitselect` over t...</a></h3>

<hr>

<base href="https://bytecodealliance.zulipchat.com">

<head><link href="https://bytecodealliance.github.io/zulip-archive/style.css" rel="stylesheet"></head>

<a name="267018779"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%233653%20cranelift%3A%20Port%20%60bitselect%60%20over%20t.../near/267018779" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.233653.20cranelift.3A.20Port.20.60bitselect.60.20over.20t.2E.2E.2E.html#267018779">(Jan 06 2022 at 02:25)</a>:</h4>
<p>github-actions[bot] <a href="https://github.com/bytecodealliance/wasmtime/pull/3653#issuecomment-1006233740">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/3653">issue #3653</a>:</p>
<blockquote>
<h4>Subscribe to Label Action</h4>
<p>cc @cfallin, @fitzgen</p>
<p>&lt;details&gt;<br>
This issue or pull request has been labeled: "cranelift", "cranelift:area:x64", "isle"</p>
<p>Thus the following users have been cc'd because of the following labels:</p>
<ul>
<li>cfallin: isle</li>
<li>fitzgen: isle</li>
</ul>
<p>To subscribe or unsubscribe from this label, edit the &lt;code&gt;.github/subscribe-to-label.json&lt;/code&gt; configuration file.</p>
<p><a href="https://github.com/bytecodealliance/subscribe-to-label-action">Learn more.</a><br>
&lt;/details&gt;</p>
</blockquote>



<a name="267090888"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%233653%20cranelift%3A%20Port%20%60bitselect%60%20over%20t.../near/267090888" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.233653.20cranelift.3A.20Port.20.60bitselect.60.20over.20t.2E.2E.2E.html#267090888">(Jan 06 2022 at 17:45)</a>:</h4>
<p>fitzgen <a href="https://github.com/bytecodealliance/wasmtime/pull/3653#issuecomment-1006786206">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/3653">issue #3653</a>:</p>
<blockquote>
<blockquote>
<p>we are generating some unnecessary <code>movdqa</code>s now</p>
</blockquote>
<p>It looks like the initial <code>movdqa</code> is being inserted by move mitosis, but that the regalloc isn't coalescing and eliding the move:</p>
<p><div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="w"> </span><span class="n">TRACE</span><span class="w"> </span><span class="n">cranelift_codegen</span>::<span class="n">isa</span>::<span class="n">x64</span>::<span class="n">inst</span><span class="w">       </span><span class="o">&gt;</span><span class="w"> </span><span class="n">mov_mitosis</span><span class="p">(</span><span class="n">pand</span><span class="w">    </span><span class="o">%</span><span class="n">v1V</span><span class="p">,</span><span class="w"> </span><span class="o">%</span><span class="n">v5V</span><span class="p">)</span><span class="w"></span>
<span class="w"> </span><span class="n">TRACE</span><span class="w"> </span><span class="n">cranelift_codegen</span>::<span class="n">isa</span>::<span class="n">x64</span>::<span class="n">inst</span><span class="w">       </span><span class="o">&gt;</span><span class="w">   </span>-&gt; <span class="nc">movdqa</span><span class="w">  </span><span class="o">%</span><span class="n">v0V</span><span class="p">,</span><span class="w"> </span><span class="o">%</span><span class="n">v5V</span><span class="w"></span>
<span class="w"> </span><span class="n">TRACE</span><span class="w"> </span><span class="n">cranelift_codegen</span>::<span class="n">isa</span>::<span class="n">x64</span>::<span class="n">inst</span><span class="w">       </span><span class="o">&gt;</span><span class="w">   </span>-&gt; <span class="nc">pand</span><span class="w">    </span><span class="o">%</span><span class="n">v1V</span><span class="p">,</span><span class="w"> </span><span class="o">%</span><span class="n">v5V</span><span class="w"></span>
<span class="w"> </span><span class="err">```</span><span class="w"></span>

<span class="o">@</span><span class="n">cfallin</span><span class="w"> </span><span class="n">any</span><span class="w"> </span><span class="n">idea</span><span class="w"> </span><span class="n">why</span><span class="w"> </span><span class="n">regalloc</span><span class="w"> </span><span class="n">might</span><span class="w"> </span><span class="n">not</span><span class="w"> </span><span class="n">be</span><span class="w"> </span><span class="n">able</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">coalesce</span><span class="o">/</span><span class="n">elide</span><span class="w"> </span><span class="n">this</span><span class="w"> </span><span class="k">move</span><span class="o">?</span><span class="w"> </span><span class="p">(</span><span class="n">See</span><span class="w"> </span><span class="n">OP</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">full</span><span class="w"> </span><span class="n">code</span><span class="p">)</span><span class="w"></span>
<span class="o">~~~</span><span class="w"></span>
</code></pre></div><br>
</p>
</blockquote>



<a name="267091578"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%233653%20cranelift%3A%20Port%20%60bitselect%60%20over%20t.../near/267091578" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.233653.20cranelift.3A.20Port.20.60bitselect.60.20over.20t.2E.2E.2E.html#267091578">(Jan 06 2022 at 17:51)</a>:</h4>
<p>fitzgen <a href="https://github.com/bytecodealliance/wasmtime/pull/3653#issuecomment-1006792254">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/3653">issue #3653</a>:</p>
<blockquote>
<p>It looks like regalloc correctly determines that these virtual registers (<code>v0V</code> and <code>v5V</code>) are in the same e-class / are connected by moves (and therefore could be coalesced?) but isn't actually coalescing them:</p>
<p><div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="w"> </span><span class="n">TRACE</span><span class="w"> </span><span class="n">cranelift_codegen</span>::<span class="n">machinst</span>::<span class="n">compile</span><span class="w">    </span><span class="o">&gt;</span><span class="w"> </span><span class="n">vcode</span><span class="w"> </span><span class="n">from</span><span class="w"> </span><span class="n">lowering</span>:
<span class="nc">VCode_ShowWithRRU</span><span class="w"> </span><span class="p">{{</span><span class="w"></span>
<span class="w">  </span><span class="n">Entry</span><span class="w"> </span><span class="n">block</span>: <span class="mi">0</span><span class="w"></span>
<span class="n">Block</span><span class="w"> </span><span class="mi">0</span>:
  <span class="p">(</span><span class="n">original</span><span class="w"> </span><span class="n">IR</span><span class="w"> </span><span class="n">block</span>: <span class="nc">block0</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="p">(</span><span class="n">instruction</span><span class="w"> </span><span class="n">range</span>: <span class="mi">0</span><span class="w"> </span><span class="o">..</span><span class="w"> </span><span class="mi">12</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="n">Inst</span><span class="w"> </span><span class="mi">0</span>:   <span class="nc">movdqa</span><span class="w">  </span><span class="o">%</span><span class="n">xmm0</span><span class="p">,</span><span class="w"> </span><span class="o">%</span><span class="n">v0V</span><span class="w"></span>
<span class="w">  </span><span class="n">Inst</span><span class="w"> </span><span class="mi">1</span>:   <span class="nc">movdqa</span><span class="w">  </span><span class="o">%</span><span class="n">xmm1</span><span class="p">,</span><span class="w"> </span><span class="o">%</span><span class="n">v1V</span><span class="w"></span>
<span class="w">  </span><span class="n">Inst</span><span class="w"> </span><span class="mi">2</span>:   <span class="nc">movdqa</span><span class="w">  </span><span class="o">%</span><span class="n">xmm2</span><span class="p">,</span><span class="w"> </span><span class="o">%</span><span class="n">v2V</span><span class="w"></span>
<span class="w">  </span><span class="n">Inst</span><span class="w"> </span><span class="mi">3</span>:   <span class="nc">movdqa</span><span class="w">  </span><span class="o">%</span><span class="n">v0V</span><span class="p">,</span><span class="w"> </span><span class="o">%</span><span class="n">v5V</span><span class="w"></span>
<span class="w">  </span><span class="n">Inst</span><span class="w"> </span><span class="mi">4</span>:   <span class="nc">pand</span><span class="w">    </span><span class="o">%</span><span class="n">v1V</span><span class="p">,</span><span class="w"> </span><span class="o">%</span><span class="n">v5V</span><span class="w"></span>
<span class="w">  </span><span class="n">Inst</span><span class="w"> </span><span class="mi">5</span>:   <span class="nc">movdqa</span><span class="w">  </span><span class="o">%</span><span class="n">v0V</span><span class="p">,</span><span class="w"> </span><span class="o">%</span><span class="n">v6V</span><span class="w"></span>
<span class="w">  </span><span class="n">Inst</span><span class="w"> </span><span class="mi">6</span>:   <span class="nc">pandn</span><span class="w">   </span><span class="o">%</span><span class="n">v2V</span><span class="p">,</span><span class="w"> </span><span class="o">%</span><span class="n">v6V</span><span class="w"></span>
<span class="w">  </span><span class="n">Inst</span><span class="w"> </span><span class="mi">7</span>:   <span class="nc">movdqa</span><span class="w">  </span><span class="o">%</span><span class="n">v5V</span><span class="p">,</span><span class="w"> </span><span class="o">%</span><span class="n">v3V</span><span class="w"></span>
<span class="w">  </span><span class="n">Inst</span><span class="w"> </span><span class="mi">8</span>:   <span class="nc">por</span><span class="w">     </span><span class="o">%</span><span class="n">v6V</span><span class="p">,</span><span class="w"> </span><span class="o">%</span><span class="n">v3V</span><span class="w"></span>
<span class="w">  </span><span class="n">Inst</span><span class="w"> </span><span class="mi">9</span>:   <span class="nc">movdqa</span><span class="w">  </span><span class="o">%</span><span class="n">v3V</span><span class="p">,</span><span class="w"> </span><span class="o">%</span><span class="n">v4V</span><span class="w"></span>
<span class="w">  </span><span class="n">Inst</span><span class="w"> </span><span class="mi">10</span>:   <span class="nc">movdqa</span><span class="w">  </span><span class="o">%</span><span class="n">v4V</span><span class="p">,</span><span class="w"> </span><span class="o">%</span><span class="n">xmm0</span><span class="w"></span>
<span class="w">  </span><span class="n">Inst</span><span class="w"> </span><span class="mi">11</span>:   <span class="nc">ret</span><span class="w"></span>
<span class="p">}}</span><span class="w"></span>

<span class="o">..</span><span class="p">.</span><span class="w"></span>

<span class="w"> </span><span class="n">TRACE</span><span class="w"> </span><span class="n">regalloc</span>::<span class="n">bt_coalescing_analysis</span><span class="w">        </span><span class="o">&gt;</span><span class="w"></span>
<span class="w"> </span><span class="n">TRACE</span><span class="w"> </span><span class="n">regalloc</span>::<span class="n">bt_coalescing_analysis</span><span class="w">        </span><span class="o">&gt;</span><span class="w"> </span><span class="n">do_coalescing_analysis</span>: <span class="nc">begin</span><span class="w"></span>
<span class="w"> </span><span class="n">TRACE</span><span class="w"> </span><span class="n">regalloc</span>::<span class="n">bt_coalescing_analysis</span><span class="w">        </span><span class="o">&gt;</span><span class="w"> </span><span class="n">connected</span><span class="w"> </span><span class="n">by</span><span class="w"> </span><span class="n">moves</span>: <span class="nc">i0</span><span class="w"> </span><span class="n">v0V</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">r0V</span><span class="w"> </span><span class="p">(</span><span class="n">est_freq</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"></span>
<span class="w"> </span><span class="n">TRACE</span><span class="w"> </span><span class="n">regalloc</span>::<span class="n">bt_coalescing_analysis</span><span class="w">        </span><span class="o">&gt;</span><span class="w"> </span><span class="n">connected</span><span class="w"> </span><span class="n">by</span><span class="w"> </span><span class="n">moves</span>: <span class="nc">i1</span><span class="w"> </span><span class="n">v1V</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">r1V</span><span class="w"> </span><span class="p">(</span><span class="n">est_freq</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"></span>
<span class="w"> </span><span class="n">TRACE</span><span class="w"> </span><span class="n">regalloc</span>::<span class="n">bt_coalescing_analysis</span><span class="w">        </span><span class="o">&gt;</span><span class="w"> </span><span class="n">connected</span><span class="w"> </span><span class="n">by</span><span class="w"> </span><span class="n">moves</span>: <span class="nc">i2</span><span class="w"> </span><span class="n">v2V</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">r2V</span><span class="w"> </span><span class="p">(</span><span class="n">est_freq</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"></span>
<span class="w"> </span><span class="n">TRACE</span><span class="w"> </span><span class="n">regalloc</span>::<span class="n">bt_coalescing_analysis</span><span class="w">        </span><span class="o">&gt;</span><span class="w"> </span><span class="n">connected</span><span class="w"> </span><span class="n">by</span><span class="w"> </span><span class="n">moves</span>: <span class="nc">i3</span><span class="w"> </span><span class="n">v5V</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">v0V</span><span class="w"> </span><span class="p">(</span><span class="n">est_freq</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"></span>
<span class="w"> </span><span class="n">TRACE</span><span class="w"> </span><span class="n">regalloc</span>::<span class="n">bt_coalescing_analysis</span><span class="w">        </span><span class="o">&gt;</span><span class="w"> </span><span class="n">connected</span><span class="w"> </span><span class="n">by</span><span class="w"> </span><span class="n">moves</span>: <span class="nc">i5</span><span class="w"> </span><span class="n">v6V</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">v0V</span><span class="w"> </span><span class="p">(</span><span class="n">est_freq</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"></span>
<span class="w"> </span><span class="n">TRACE</span><span class="w"> </span><span class="n">regalloc</span>::<span class="n">bt_coalescing_analysis</span><span class="w">        </span><span class="o">&gt;</span><span class="w"> </span><span class="n">reduce</span><span class="w"> </span><span class="n">cost</span><span class="w"> </span><span class="n">of</span><span class="w"> </span><span class="n">vr0</span><span class="w"> </span><span class="n">and</span><span class="w"> </span><span class="n">vr6</span><span class="w"></span>
<span class="w"> </span><span class="n">TRACE</span><span class="w"> </span><span class="n">regalloc</span>::<span class="n">bt_coalescing_analysis</span><span class="w">        </span><span class="o">&gt;</span><span class="w"> </span><span class="n">connected</span><span class="w"> </span><span class="n">by</span><span class="w"> </span><span class="n">moves</span>: <span class="nc">i7</span><span class="w"> </span><span class="n">v3V</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">v5V</span><span class="w"> </span><span class="p">(</span><span class="n">est_freq</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"></span>
<span class="w"> </span><span class="n">TRACE</span><span class="w"> </span><span class="n">regalloc</span>::<span class="n">bt_coalescing_analysis</span><span class="w">        </span><span class="o">&gt;</span><span class="w"> </span><span class="n">reduce</span><span class="w"> </span><span class="n">cost</span><span class="w"> </span><span class="n">of</span><span class="w"> </span><span class="n">vr5</span><span class="w"> </span><span class="n">and</span><span class="w"> </span><span class="n">vr3</span><span class="w"></span>
<span class="w"> </span><span class="n">TRACE</span><span class="w"> </span><span class="n">regalloc</span>::<span class="n">bt_coalescing_analysis</span><span class="w">        </span><span class="o">&gt;</span><span class="w"> </span><span class="n">connected</span><span class="w"> </span><span class="n">by</span><span class="w"> </span><span class="n">moves</span>: <span class="nc">i9</span><span class="w"> </span><span class="n">v4V</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">v3V</span><span class="w"> </span><span class="p">(</span><span class="n">est_freq</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"></span>
<span class="w"> </span><span class="n">TRACE</span><span class="w"> </span><span class="n">regalloc</span>::<span class="n">bt_coalescing_analysis</span><span class="w">        </span><span class="o">&gt;</span><span class="w"> </span><span class="n">reduce</span><span class="w"> </span><span class="n">cost</span><span class="w"> </span><span class="n">of</span><span class="w"> </span><span class="n">vr3</span><span class="w"> </span><span class="n">and</span><span class="w"> </span><span class="n">vr4</span><span class="w"></span>
<span class="w"> </span><span class="n">TRACE</span><span class="w"> </span><span class="n">regalloc</span>::<span class="n">bt_coalescing_analysis</span><span class="w">        </span><span class="o">&gt;</span><span class="w"> </span><span class="n">connected</span><span class="w"> </span><span class="n">by</span><span class="w"> </span><span class="n">moves</span>: <span class="nc">i10</span><span class="w"> </span><span class="n">r0V</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">v4V</span><span class="w"> </span><span class="p">(</span><span class="n">est_freq</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"></span>
<span class="w"> </span><span class="n">TRACE</span><span class="w"> </span><span class="n">regalloc</span>::<span class="n">bt_coalescing_analysis</span><span class="w">        </span><span class="o">&gt;</span><span class="w"> </span><span class="n">Revised</span><span class="w"> </span><span class="n">VLRs</span>:
 <span class="nc">TRACE</span><span class="w"> </span><span class="n">regalloc</span>::<span class="n">bt_coalescing_analysis</span><span class="w">        </span><span class="o">&gt;</span><span class="w"> </span><span class="n">vr0</span><span class="w">   </span><span class="p">(</span><span class="n">VR</span>: <span class="nc">v0V</span><span class="p">,</span><span class="w"> </span><span class="n">sz</span><span class="o">=</span><span class="mi">6</span><span class="p">,</span><span class="w"> </span><span class="n">tc</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="n">sc</span><span class="o">=</span><span class="mf">0.333</span><span class="p">,</span><span class="w"> </span><span class="p">[(</span><span class="n">RF</span>: <span class="nc">i0</span><span class="p">.</span><span class="n">d</span><span class="o">-</span><span class="n">i5</span><span class="p">.</span><span class="n">u</span><span class="p">)])</span><span class="w"></span>
<span class="w"> </span><span class="n">TRACE</span><span class="w"> </span><span class="n">regalloc</span>::<span class="n">bt_coalescing_analysis</span><span class="w">        </span><span class="o">&gt;</span><span class="w"> </span><span class="n">vr1</span><span class="w">   </span><span class="p">(</span><span class="n">VR</span>: <span class="nc">v1V</span><span class="p">,</span><span class="w"> </span><span class="n">sz</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span><span class="w"> </span><span class="n">tc</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="n">sc</span><span class="o">=</span><span class="mf">0.500</span><span class="p">,</span><span class="w"> </span><span class="p">[(</span><span class="n">RF</span>: <span class="nc">i1</span><span class="p">.</span><span class="n">d</span><span class="o">-</span><span class="n">i4</span><span class="p">.</span><span class="n">u</span><span class="p">)])</span><span class="w"></span>
<span class="w"> </span><span class="n">TRACE</span><span class="w"> </span><span class="n">regalloc</span>::<span class="n">bt_coalescing_analysis</span><span class="w">        </span><span class="o">&gt;</span><span class="w"> </span><span class="n">vr2</span><span class="w">   </span><span class="p">(</span><span class="n">VR</span>: <span class="nc">v2V</span><span class="p">,</span><span class="w"> </span><span class="n">sz</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span><span class="w"> </span><span class="n">tc</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="n">sc</span><span class="o">=</span><span class="mf">0.400</span><span class="p">,</span><span class="w"> </span><span class="p">[(</span><span class="n">RF</span>: <span class="nc">i2</span><span class="p">.</span><span class="n">d</span><span class="o">-</span><span class="n">i6</span><span class="p">.</span><span class="n">u</span><span class="p">)])</span><span class="w"></span>
<span class="w"> </span><span class="n">TRACE</span><span class="w"> </span><span class="n">regalloc</span>::<span class="n">bt_coalescing_analysis</span><span class="w">        </span><span class="o">&gt;</span><span class="w"> </span><span class="n">vr3</span><span class="w">   </span><span class="p">(</span><span class="n">VR</span>: <span class="nc">v3V</span><span class="p">,</span><span class="w"> </span><span class="n">sz</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span><span class="w"> </span><span class="n">tc</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="n">sc</span><span class="o">=</span><span class="mf">0.667</span><span class="p">,</span><span class="w"> </span><span class="p">[(</span><span class="n">RF</span>: <span class="nc">i7</span><span class="p">.</span><span class="n">d</span><span class="o">-</span><span class="n">i9</span><span class="p">.</span><span class="n">u</span><span class="p">)])</span><span class="w"></span>
<span class="w"> </span><span class="n">TRACE</span><span class="w"> </span><span class="n">regalloc</span>::<span class="n">bt_coalescing_analysis</span><span class="w">        </span><span class="o">&gt;</span><span class="w"> </span><span class="n">vr4</span><span class="w">   </span><span class="p">(</span><span class="n">VR</span>: <span class="nc">v4V</span><span class="p">,</span><span class="w"> </span><span class="n">sz</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="n">tc</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">sc</span><span class="o">=</span><span class="mf">0.500</span><span class="p">,</span><span class="w"> </span><span class="p">[(</span><span class="n">RF</span>: <span class="nc">i9</span><span class="p">.</span><span class="n">d</span><span class="o">-</span><span class="n">i10</span><span class="p">.</span><span class="n">u</span><span class="p">)])</span><span class="w"></span>
<span class="w"> </span><span class="n">TRACE</span><span class="w"> </span><span class="n">regalloc</span>::<span class="n">bt_coalescing_analysis</span><span class="w">        </span><span class="o">&gt;</span><span class="w"> </span><span class="n">vr5</span><span class="w">   </span><span class="p">(</span><span class="n">VR</span>: <span class="nc">v5V</span><span class="p">,</span><span class="w"> </span><span class="n">sz</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span><span class="w"> </span><span class="n">tc</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span><span class="w"> </span><span class="n">sc</span><span class="o">=</span><span class="mf">0.600</span><span class="p">,</span><span class="w"> </span><span class="p">[(</span><span class="n">RF</span>: <span class="nc">i3</span><span class="p">.</span><span class="n">d</span><span class="o">-</span><span class="n">i7</span><span class="p">.</span><span class="n">u</span><span class="p">)])</span><span class="w"></span>
<span class="w"> </span><span class="n">TRACE</span><span class="w"> </span><span class="n">regalloc</span>::<span class="n">bt_coalescing_analysis</span><span class="w">        </span><span class="o">&gt;</span><span class="w"> </span><span class="n">vr6</span><span class="w">   </span><span class="p">(</span><span class="n">VR</span>: <span class="nc">v6V</span><span class="p">,</span><span class="w"> </span><span class="n">sz</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span><span class="w"> </span><span class="n">tc</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span><span class="w"> </span><span class="n">sc</span><span class="o">=</span><span class="mf">0.750</span><span class="p">,</span><span class="w"> </span><span class="p">[(</span><span class="n">RF</span>: <span class="nc">i5</span><span class="p">.</span><span class="n">d</span><span class="o">-</span><span class="kt">i8</span><span class="p">.</span><span class="n">u</span><span class="p">)])</span><span class="w"></span>
<span class="w"> </span><span class="n">TRACE</span><span class="w"> </span><span class="n">regalloc</span>::<span class="n">bt_coalescing_analysis</span><span class="w">        </span><span class="o">&gt;</span><span class="w"> </span><span class="n">Coalescing</span><span class="w"> </span><span class="n">hints</span>:
 <span class="nc">TRACE</span><span class="w"> </span><span class="n">regalloc</span>::<span class="n">bt_coalescing_analysis</span><span class="w">        </span><span class="o">&gt;</span><span class="w">   </span><span class="n">hintsfor</span><span class="w"> </span><span class="n">vr0</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">Exactly</span><span class="w"> </span><span class="o">%</span><span class="n">xmm0</span><span class="p">,</span><span class="w"> </span><span class="n">weight</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="n">SameAs</span><span class="w"> </span><span class="n">vr6</span><span class="p">,</span><span class="w"> </span><span class="n">weight</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="w"></span>
<span class="w"> </span><span class="n">TRACE</span><span class="w"> </span><span class="n">regalloc</span>::<span class="n">bt_coalescing_analysis</span><span class="w">        </span><span class="o">&gt;</span><span class="w">   </span><span class="n">hintsfor</span><span class="w"> </span><span class="n">vr1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">Exactly</span><span class="w"> </span><span class="o">%</span><span class="n">xmm1</span><span class="p">,</span><span class="w"> </span><span class="n">weight</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="w"></span>
<span class="w"> </span><span class="n">TRACE</span><span class="w"> </span><span class="n">regalloc</span>::<span class="n">bt_coalescing_analysis</span><span class="w">        </span><span class="o">&gt;</span><span class="w">   </span><span class="n">hintsfor</span><span class="w"> </span><span class="n">vr2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">Exactly</span><span class="w"> </span><span class="o">%</span><span class="n">xmm2</span><span class="p">,</span><span class="w"> </span><span class="n">weight</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="w"></span>
<span class="w"> </span><span class="n">TRACE</span><span class="w"> </span><span class="n">regalloc</span>::<span class="n">bt_coalescing_analysis</span><span class="w">        </span><span class="o">&gt;</span><span class="w">   </span><span class="n">hintsfor</span><span class="w"> </span><span class="n">vr3</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">SameAs</span><span class="w"> </span><span class="n">vr5</span><span class="p">,</span><span class="w"> </span><span class="n">weight</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="n">SameAs</span><span class="w"> </span><span class="n">vr4</span><span class="p">,</span><span class="w"> </span><span class="n">weight</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="w"></span>
<span class="w"> </span><span class="n">TRACE</span><span class="w"> </span><span class="n">regalloc</span>::<span class="n">bt_coalescing_analysis</span><span class="w">        </span><span class="o">&gt;</span><span class="w">   </span><span class="n">hintsfor</span><span class="w"> </span><span class="n">vr4</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">SameAs</span><span class="w"> </span><span class="n">vr3</span><span class="p">,</span><span class="w"> </span><span class="n">weight</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="n">Exactly</span><span class="w"> </span><span class="o">%</span><span class="n">xmm0</span><span class="p">,</span><span class="w"> </span><span class="n">weight</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="w"></span>
<span class="w"> </span><span class="n">TRACE</span><span class="w"> </span><span class="n">regalloc</span>::<span class="n">bt_coalescing_analysis</span><span class="w">        </span><span class="o">&gt;</span><span class="w">   </span><span class="n">hintsfor</span><span class="w"> </span><span class="n">vr5</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">SameAs</span><span class="w"> </span><span class="n">vr3</span><span class="p">,</span><span class="w"> </span><span class="n">weight</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="w"></span>
<span class="w"> </span><span class="n">TRACE</span><span class="w"> </span><span class="n">regalloc</span>::<span class="n">bt_coalescing_analysis</span><span class="w">        </span><span class="o">&gt;</span><span class="w">   </span><span class="n">hintsfor</span><span class="w"> </span><span class="n">vr6</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">SameAs</span><span class="w"> </span><span class="n">vr0</span><span class="p">,</span><span class="w"> </span><span class="n">weight</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="w"></span>
<span class="w"> </span><span class="n">TRACE</span><span class="w"> </span><span class="n">regalloc</span>::<span class="n">bt_coalescing_analysis</span><span class="w">        </span><span class="o">&gt;</span><span class="w">   </span><span class="n">eclassof</span><span class="w"> </span><span class="n">vr0</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span><span class="n">vr6</span><span class="p">,</span><span class="w"> </span><span class="n">vr0</span><span class="p">]</span><span class="w"></span>
<span class="w"> </span><span class="n">TRACE</span><span class="w"> </span><span class="n">regalloc</span>::<span class="n">bt_coalescing_analysis</span><span class="w">        </span><span class="o">&gt;</span><span class="w">   </span><span class="n">eclassof</span><span class="w"> </span><span class="n">vr1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span><span class="n">vr1</span><span class="p">]</span><span class="w"></span>
<span class="w"> </span><span class="n">TRACE</span><span class="w"> </span><span class="n">regalloc</span>::<span class="n">bt_coalescing_analysis</span><span class="w">        </span><span class="o">&gt;</span><span class="w">   </span><span class="n">eclassof</span><span class="w"> </span><span class="n">vr2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span><span class="n">vr2</span><span class="p">]</span><span class="w"></span>
<span class="w"> </span><span class="n">TRACE</span><span class="w"> </span><span class="n">regalloc</span>::<span class="n">bt_coalescing_analysis</span><span class="w">        </span><span class="o">&gt;</span><span class="w">   </span><span class="n">eclassof</span><span class="w"> </span><span class="n">vr3</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span><span class="n">vr4</span><span class="p">,</span><span class="w"> </span><span class="n">vr5</span><span class="p">,</span><span class="w"> </span><span class="n">vr3</span><span class="p">]</span><span class="w"></span>
<span class="w"> </span><span class="n">TRACE</span><span class="w"> </span><span class="n">regalloc</span>::<span class="n">bt_coalescing_analysis</span><span class="w">        </span><span class="o">&gt;</span><span class="w">   </span><span class="n">eclassof</span><span class="w"> </span><span class="n">vr4</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span><span class="n">vr4</span><span class="p">,</span><span class="w"> </span><span class="n">vr5</span><span class="p">,</span><span class="w"> </span><span class="n">vr3</span><span class="p">]</span><span class="w"></span>
<span class="w"> </span><span class="n">TRACE</span><span class="w"> </span><span class="n">regalloc</span>::<span class="n">bt_coalescing_analysis</span><span class="w">        </span><span class="o">&gt;</span><span class="w">   </span><span class="n">eclassof</span><span class="w"> </span><span class="n">vr5</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span><span class="n">vr4</span><span class="p">,</span><span class="w"> </span><span class="n">vr5</span><span class="p">,</span><span class="w"> </span><span class="n">vr3</span><span class="p">]</span><span class="w"></span>
<span class="w"> </span><span class="n">TRACE</span><span class="w"> </span><span class="n">regalloc</span>::<span class="n">bt_coalescing_analysis</span><span class="w">        </span><span class="o">&gt;</span><span class="w">   </span><span class="n">eclassof</span><span class="w"> </span><span class="n">vr6</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span><span class="n">vr6</span><span class="p">,</span><span class="w"> </span><span class="n">vr0</span><span class="p">]</span><span class="w"></span>
<span class="w"> </span><span class="n">TRACE</span><span class="w"> </span><span class="n">regalloc</span>::<span class="n">bt_coalescing_analysis</span><span class="w">        </span><span class="o">&gt;</span><span class="w">   </span><span class="n">vv_boundary_move</span><span class="w"> </span><span class="n">at</span><span class="w"> </span><span class="n">i5</span><span class="w"></span>
<span class="w"> </span><span class="n">TRACE</span><span class="w"> </span><span class="n">regalloc</span>::<span class="n">bt_coalescing_analysis</span><span class="w">        </span><span class="o">&gt;</span><span class="w">   </span><span class="n">vv_boundary_move</span><span class="w"> </span><span class="n">at</span><span class="w"> </span><span class="n">i7</span><span class="w"></span>
<span class="w"> </span><span class="n">TRACE</span><span class="w"> </span><span class="n">regalloc</span>::<span class="n">bt_coalescing_analysis</span><span class="w">        </span><span class="o">&gt;</span><span class="w">   </span><span class="n">vv_boundary_move</span><span class="w"> </span><span class="n">at</span><span class="w"> </span><span class="n">i9</span><span class="w"></span>
<span class="w"> </span><span class="n">TRACE</span><span class="w"> </span><span class="n">regalloc</span>::<span class="n">bt_coalescing_analysis</span><span class="w">        </span><span class="o">&gt;</span><span class="w"> </span><span class="n">do_coalescing_analysis</span>: <span class="nc">end</span><span class="w"></span>
<span class="w"> </span><span class="n">TRACE</span><span class="w"> </span><span class="n">regalloc</span>::<span class="n">bt_coalescing_analysis</span><span class="w">        </span><span class="o">&gt;</span><span class="w"></span>
</code></pre></div><br>
</p>
</blockquote>



<a name="267092990"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%233653%20cranelift%3A%20Port%20%60bitselect%60%20over%20t.../near/267092990" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.233653.20cranelift.3A.20Port.20.60bitselect.60.20over.20t.2E.2E.2E.html#267092990">(Jan 06 2022 at 18:01)</a>:</h4>
<p>fitzgen edited a <a href="https://github.com/bytecodealliance/wasmtime/pull/3653#issuecomment-1006792254">comment</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/3653">issue #3653</a>:</p>
<blockquote>
<p>It looks like regalloc correctly determines that these virtual registers (<code>v0V</code> and <code>v5V</code>) are in the same e-class / are connected by moves (and therefore could be coalesced?) but isn't actually coalescing them:</p>
<p><div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="w"> </span><span class="n">TRACE</span><span class="w"> </span><span class="n">cranelift_codegen</span>::<span class="n">machinst</span>::<span class="n">compile</span><span class="w">    </span><span class="o">&gt;</span><span class="w"> </span><span class="n">vcode</span><span class="w"> </span><span class="n">from</span><span class="w"> </span><span class="n">lowering</span>:
<span class="nc">VCode_ShowWithRRU</span><span class="w"> </span><span class="p">{{</span><span class="w"></span>
<span class="w">  </span><span class="n">Entry</span><span class="w"> </span><span class="n">block</span>: <span class="mi">0</span><span class="w"></span>
<span class="n">Block</span><span class="w"> </span><span class="mi">0</span>:
  <span class="p">(</span><span class="n">original</span><span class="w"> </span><span class="n">IR</span><span class="w"> </span><span class="n">block</span>: <span class="nc">block0</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="p">(</span><span class="n">instruction</span><span class="w"> </span><span class="n">range</span>: <span class="mi">0</span><span class="w"> </span><span class="o">..</span><span class="w"> </span><span class="mi">12</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="n">Inst</span><span class="w"> </span><span class="mi">0</span>:   <span class="nc">load_const</span><span class="w"> </span><span class="n">VCodeConstant</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span><span class="w"> </span><span class="o">%</span><span class="n">v0V</span><span class="w"></span>
<span class="w">  </span><span class="n">Inst</span><span class="w"> </span><span class="mi">1</span>:   <span class="nc">load_const</span><span class="w"> </span><span class="n">VCodeConstant</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span><span class="w"> </span><span class="o">%</span><span class="n">v1V</span><span class="w"></span>
<span class="w">  </span><span class="n">Inst</span><span class="w"> </span><span class="mi">2</span>:   <span class="nc">load_const</span><span class="w"> </span><span class="n">VCodeConstant</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span><span class="w"> </span><span class="o">%</span><span class="n">v2V</span><span class="w"></span>
<span class="w">  </span><span class="n">Inst</span><span class="w"> </span><span class="mi">3</span>:   <span class="nc">movdqa</span><span class="w">  </span><span class="o">%</span><span class="n">v0V</span><span class="p">,</span><span class="w"> </span><span class="o">%</span><span class="n">v5V</span><span class="w"></span>
<span class="w">  </span><span class="n">Inst</span><span class="w"> </span><span class="mi">4</span>:   <span class="nc">pand</span><span class="w">    </span><span class="o">%</span><span class="n">v1V</span><span class="p">,</span><span class="w"> </span><span class="o">%</span><span class="n">v5V</span><span class="w"></span>
<span class="w">  </span><span class="n">Inst</span><span class="w"> </span><span class="mi">5</span>:   <span class="nc">movdqa</span><span class="w">  </span><span class="o">%</span><span class="n">v0V</span><span class="p">,</span><span class="w"> </span><span class="o">%</span><span class="n">v6V</span><span class="w"></span>
<span class="w">  </span><span class="n">Inst</span><span class="w"> </span><span class="mi">6</span>:   <span class="nc">pandn</span><span class="w">   </span><span class="o">%</span><span class="n">v2V</span><span class="p">,</span><span class="w"> </span><span class="o">%</span><span class="n">v6V</span><span class="w"></span>
<span class="w">  </span><span class="n">Inst</span><span class="w"> </span><span class="mi">7</span>:   <span class="nc">movdqa</span><span class="w">  </span><span class="o">%</span><span class="n">v5V</span><span class="p">,</span><span class="w"> </span><span class="o">%</span><span class="n">v3V</span><span class="w"></span>
<span class="w">  </span><span class="n">Inst</span><span class="w"> </span><span class="mi">8</span>:   <span class="nc">por</span><span class="w">     </span><span class="o">%</span><span class="n">v6V</span><span class="p">,</span><span class="w"> </span><span class="o">%</span><span class="n">v3V</span><span class="w"></span>
<span class="w">  </span><span class="n">Inst</span><span class="w"> </span><span class="mi">9</span>:   <span class="nc">movdqa</span><span class="w">  </span><span class="o">%</span><span class="n">v3V</span><span class="p">,</span><span class="w"> </span><span class="o">%</span><span class="n">v4V</span><span class="w"></span>
<span class="w">  </span><span class="n">Inst</span><span class="w"> </span><span class="mi">10</span>:   <span class="nc">movdqa</span><span class="w">  </span><span class="o">%</span><span class="n">v4V</span><span class="p">,</span><span class="w"> </span><span class="o">%</span><span class="n">xmm0</span><span class="w"></span>
<span class="w">  </span><span class="n">Inst</span><span class="w"> </span><span class="mi">11</span>:   <span class="nc">ret</span><span class="w"></span>
<span class="p">}}</span><span class="w"></span>

<span class="o">..</span><span class="p">.</span><span class="w"></span>

<span class="w"> </span><span class="n">TRACE</span><span class="w"> </span><span class="n">regalloc</span>::<span class="n">bt_coalescing_analysis</span><span class="w">        </span><span class="o">&gt;</span><span class="w"></span>
<span class="w"> </span><span class="n">TRACE</span><span class="w"> </span><span class="n">regalloc</span>::<span class="n">bt_coalescing_analysis</span><span class="w">        </span><span class="o">&gt;</span><span class="w"> </span><span class="n">do_coalescing_analysis</span>: <span class="nc">begin</span><span class="w"></span>
<span class="w"> </span><span class="n">TRACE</span><span class="w"> </span><span class="n">regalloc</span>::<span class="n">bt_coalescing_analysis</span><span class="w">        </span><span class="o">&gt;</span><span class="w"> </span><span class="n">connected</span><span class="w"> </span><span class="n">by</span><span class="w"> </span><span class="n">moves</span>: <span class="nc">i3</span><span class="w"> </span><span class="n">v5V</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">v0V</span><span class="w"> </span><span class="p">(</span><span class="n">est_freq</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"></span>
<span class="w"> </span><span class="n">TRACE</span><span class="w"> </span><span class="n">regalloc</span>::<span class="n">bt_coalescing_analysis</span><span class="w">        </span><span class="o">&gt;</span><span class="w"> </span><span class="n">connected</span><span class="w"> </span><span class="n">by</span><span class="w"> </span><span class="n">moves</span>: <span class="nc">i5</span><span class="w"> </span><span class="n">v6V</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">v0V</span><span class="w"> </span><span class="p">(</span><span class="n">est_freq</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"></span>
<span class="w"> </span><span class="n">TRACE</span><span class="w"> </span><span class="n">regalloc</span>::<span class="n">bt_coalescing_analysis</span><span class="w">        </span><span class="o">&gt;</span><span class="w"> </span><span class="n">reduce</span><span class="w"> </span><span class="n">cost</span><span class="w"> </span><span class="n">of</span><span class="w"> </span><span class="n">vr0</span><span class="w"> </span><span class="n">and</span><span class="w"> </span><span class="n">vr6</span><span class="w"></span>
<span class="w"> </span><span class="n">TRACE</span><span class="w"> </span><span class="n">regalloc</span>::<span class="n">bt_coalescing_analysis</span><span class="w">        </span><span class="o">&gt;</span><span class="w"> </span><span class="n">connected</span><span class="w"> </span><span class="n">by</span><span class="w"> </span><span class="n">moves</span>: <span class="nc">i7</span><span class="w"> </span><span class="n">v3V</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">v5V</span><span class="w"> </span><span class="p">(</span><span class="n">est_freq</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"></span>
<span class="w"> </span><span class="n">TRACE</span><span class="w"> </span><span class="n">regalloc</span>::<span class="n">bt_coalescing_analysis</span><span class="w">        </span><span class="o">&gt;</span><span class="w"> </span><span class="n">reduce</span><span class="w"> </span><span class="n">cost</span><span class="w"> </span><span class="n">of</span><span class="w"> </span><span class="n">vr5</span><span class="w"> </span><span class="n">and</span><span class="w"> </span><span class="n">vr3</span><span class="w"></span>
<span class="w"> </span><span class="n">TRACE</span><span class="w"> </span><span class="n">regalloc</span>::<span class="n">bt_coalescing_analysis</span><span class="w">        </span><span class="o">&gt;</span><span class="w"> </span><span class="n">connected</span><span class="w"> </span><span class="n">by</span><span class="w"> </span><span class="n">moves</span>: <span class="nc">i9</span><span class="w"> </span><span class="n">v4V</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">v3V</span><span class="w"> </span><span class="p">(</span><span class="n">est_freq</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"></span>
<span class="w"> </span><span class="n">TRACE</span><span class="w"> </span><span class="n">regalloc</span>::<span class="n">bt_coalescing_analysis</span><span class="w">        </span><span class="o">&gt;</span><span class="w"> </span><span class="n">reduce</span><span class="w"> </span><span class="n">cost</span><span class="w"> </span><span class="n">of</span><span class="w"> </span><span class="n">vr3</span><span class="w"> </span><span class="n">and</span><span class="w"> </span><span class="n">vr4</span><span class="w"></span>
<span class="w"> </span><span class="n">TRACE</span><span class="w"> </span><span class="n">regalloc</span>::<span class="n">bt_coalescing_analysis</span><span class="w">        </span><span class="o">&gt;</span><span class="w"> </span><span class="n">connected</span><span class="w"> </span><span class="n">by</span><span class="w"> </span><span class="n">moves</span>: <span class="nc">i10</span><span class="w"> </span><span class="n">r0V</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">v4V</span><span class="w"> </span><span class="p">(</span><span class="n">est_freq</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"></span>
<span class="w"> </span><span class="n">TRACE</span><span class="w"> </span><span class="n">regalloc</span>::<span class="n">bt_coalescing_analysis</span><span class="w">        </span><span class="o">&gt;</span><span class="w"> </span><span class="n">Revised</span><span class="w"> </span><span class="n">VLRs</span>:
 <span class="nc">TRACE</span><span class="w"> </span><span class="n">regalloc</span>::<span class="n">bt_coalescing_analysis</span><span class="w">        </span><span class="o">&gt;</span><span class="w"> </span><span class="n">vr0</span><span class="w">   </span><span class="p">(</span><span class="n">VR</span>: <span class="nc">v0V</span><span class="p">,</span><span class="w"> </span><span class="n">sz</span><span class="o">=</span><span class="mi">6</span><span class="p">,</span><span class="w"> </span><span class="n">tc</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="n">sc</span><span class="o">=</span><span class="mf">0.333</span><span class="p">,</span><span class="w"> </span><span class="p">[(</span><span class="n">RF</span>: <span class="nc">i0</span><span class="p">.</span><span class="n">d</span><span class="o">-</span><span class="n">i5</span><span class="p">.</span><span class="n">u</span><span class="p">)])</span><span class="w"></span>
<span class="w"> </span><span class="n">TRACE</span><span class="w"> </span><span class="n">regalloc</span>::<span class="n">bt_coalescing_analysis</span><span class="w">        </span><span class="o">&gt;</span><span class="w"> </span><span class="n">vr1</span><span class="w">   </span><span class="p">(</span><span class="n">VR</span>: <span class="nc">v1V</span><span class="p">,</span><span class="w"> </span><span class="n">sz</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span><span class="w"> </span><span class="n">tc</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="n">sc</span><span class="o">=</span><span class="mf">0.500</span><span class="p">,</span><span class="w"> </span><span class="p">[(</span><span class="n">RF</span>: <span class="nc">i1</span><span class="p">.</span><span class="n">d</span><span class="o">-</span><span class="n">i4</span><span class="p">.</span><span class="n">u</span><span class="p">)])</span><span class="w"></span>
<span class="w"> </span><span class="n">TRACE</span><span class="w"> </span><span class="n">regalloc</span>::<span class="n">bt_coalescing_analysis</span><span class="w">        </span><span class="o">&gt;</span><span class="w"> </span><span class="n">vr2</span><span class="w">   </span><span class="p">(</span><span class="n">VR</span>: <span class="nc">v2V</span><span class="p">,</span><span class="w"> </span><span class="n">sz</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span><span class="w"> </span><span class="n">tc</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="n">sc</span><span class="o">=</span><span class="mf">0.400</span><span class="p">,</span><span class="w"> </span><span class="p">[(</span><span class="n">RF</span>: <span class="nc">i2</span><span class="p">.</span><span class="n">d</span><span class="o">-</span><span class="n">i6</span><span class="p">.</span><span class="n">u</span><span class="p">)])</span><span class="w"></span>
<span class="w"> </span><span class="n">TRACE</span><span class="w"> </span><span class="n">regalloc</span>::<span class="n">bt_coalescing_analysis</span><span class="w">        </span><span class="o">&gt;</span><span class="w"> </span><span class="n">vr3</span><span class="w">   </span><span class="p">(</span><span class="n">VR</span>: <span class="nc">v3V</span><span class="p">,</span><span class="w"> </span><span class="n">sz</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span><span class="w"> </span><span class="n">tc</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="n">sc</span><span class="o">=</span><span class="mf">0.667</span><span class="p">,</span><span class="w"> </span><span class="p">[(</span><span class="n">RF</span>: <span class="nc">i7</span><span class="p">.</span><span class="n">d</span><span class="o">-</span><span class="n">i9</span><span class="p">.</span><span class="n">u</span><span class="p">)])</span><span class="w"></span>
<span class="w"> </span><span class="n">TRACE</span><span class="w"> </span><span class="n">regalloc</span>::<span class="n">bt_coalescing_analysis</span><span class="w">        </span><span class="o">&gt;</span><span class="w"> </span><span class="n">vr4</span><span class="w">   </span><span class="p">(</span><span class="n">VR</span>: <span class="nc">v4V</span><span class="p">,</span><span class="w"> </span><span class="n">sz</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="n">tc</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">sc</span><span class="o">=</span><span class="mf">0.500</span><span class="p">,</span><span class="w"> </span><span class="p">[(</span><span class="n">RF</span>: <span class="nc">i9</span><span class="p">.</span><span class="n">d</span><span class="o">-</span><span class="n">i10</span><span class="p">.</span><span class="n">u</span><span class="p">)])</span><span class="w"></span>
<span class="w"> </span><span class="n">TRACE</span><span class="w"> </span><span class="n">regalloc</span>::<span class="n">bt_coalescing_analysis</span><span class="w">        </span><span class="o">&gt;</span><span class="w"> </span><span class="n">vr5</span><span class="w">   </span><span class="p">(</span><span class="n">VR</span>: <span class="nc">v5V</span><span class="p">,</span><span class="w"> </span><span class="n">sz</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span><span class="w"> </span><span class="n">tc</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span><span class="w"> </span><span class="n">sc</span><span class="o">=</span><span class="mf">0.600</span><span class="p">,</span><span class="w"> </span><span class="p">[(</span><span class="n">RF</span>: <span class="nc">i3</span><span class="p">.</span><span class="n">d</span><span class="o">-</span><span class="n">i7</span><span class="p">.</span><span class="n">u</span><span class="p">)])</span><span class="w"></span>
<span class="w"> </span><span class="n">TRACE</span><span class="w"> </span><span class="n">regalloc</span>::<span class="n">bt_coalescing_analysis</span><span class="w">        </span><span class="o">&gt;</span><span class="w"> </span><span class="n">vr6</span><span class="w">   </span><span class="p">(</span><span class="n">VR</span>: <span class="nc">v6V</span><span class="p">,</span><span class="w"> </span><span class="n">sz</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span><span class="w"> </span><span class="n">tc</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span><span class="w"> </span><span class="n">sc</span><span class="o">=</span><span class="mf">0.750</span><span class="p">,</span><span class="w"> </span><span class="p">[(</span><span class="n">RF</span>: <span class="nc">i5</span><span class="p">.</span><span class="n">d</span><span class="o">-</span><span class="kt">i8</span><span class="p">.</span><span class="n">u</span><span class="p">)])</span><span class="w"></span>
<span class="w"> </span><span class="n">TRACE</span><span class="w"> </span><span class="n">regalloc</span>::<span class="n">bt_coalescing_analysis</span><span class="w">        </span><span class="o">&gt;</span><span class="w"> </span><span class="n">Coalescing</span><span class="w"> </span><span class="n">hints</span>:
 <span class="nc">TRACE</span><span class="w"> </span><span class="n">regalloc</span>::<span class="n">bt_coalescing_analysis</span><span class="w">        </span><span class="o">&gt;</span><span class="w">   </span><span class="n">hintsfor</span><span class="w"> </span><span class="n">vr0</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">SameAs</span><span class="w"> </span><span class="n">vr6</span><span class="p">,</span><span class="w"> </span><span class="n">weight</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="w"></span>
<span class="w"> </span><span class="n">TRACE</span><span class="w"> </span><span class="n">regalloc</span>::<span class="n">bt_coalescing_analysis</span><span class="w">        </span><span class="o">&gt;</span><span class="w">   </span><span class="n">hintsfor</span><span class="w"> </span><span class="n">vr1</span><span class="w"> </span><span class="o">=</span><span class="w"></span>
<span class="w"> </span><span class="n">TRACE</span><span class="w"> </span><span class="n">regalloc</span>::<span class="n">bt_coalescing_analysis</span><span class="w">        </span><span class="o">&gt;</span><span class="w">   </span><span class="n">hintsfor</span><span class="w"> </span><span class="n">vr2</span><span class="w"> </span><span class="o">=</span><span class="w"></span>
<span class="w"> </span><span class="n">TRACE</span><span class="w"> </span><span class="n">regalloc</span>::<span class="n">bt_coalescing_analysis</span><span class="w">        </span><span class="o">&gt;</span><span class="w">   </span><span class="n">hintsfor</span><span class="w"> </span><span class="n">vr3</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">SameAs</span><span class="w"> </span><span class="n">vr5</span><span class="p">,</span><span class="w"> </span><span class="n">weight</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="n">SameAs</span><span class="w"> </span><span class="n">vr4</span><span class="p">,</span><span class="w"> </span><span class="n">weight</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="w"></span>
<span class="w"> </span><span class="n">TRACE</span><span class="w"> </span><span class="n">regalloc</span>::<span class="n">bt_coalescing_analysis</span><span class="w">        </span><span class="o">&gt;</span><span class="w">   </span><span class="n">hintsfor</span><span class="w"> </span><span class="n">vr4</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">SameAs</span><span class="w"> </span><span class="n">vr3</span><span class="p">,</span><span class="w"> </span><span class="n">weight</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="n">Exactly</span><span class="w"> </span><span class="o">%</span><span class="n">xmm0</span><span class="p">,</span><span class="w"> </span><span class="n">weight</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="w"></span>
<span class="w"> </span><span class="n">TRACE</span><span class="w"> </span><span class="n">regalloc</span>::<span class="n">bt_coalescing_analysis</span><span class="w">        </span><span class="o">&gt;</span><span class="w">   </span><span class="n">hintsfor</span><span class="w"> </span><span class="n">vr5</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">SameAs</span><span class="w"> </span><span class="n">vr3</span><span class="p">,</span><span class="w"> </span><span class="n">weight</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="w"></span>
<span class="w"> </span><span class="n">TRACE</span><span class="w"> </span><span class="n">regalloc</span>::<span class="n">bt_coalescing_analysis</span><span class="w">        </span><span class="o">&gt;</span><span class="w">   </span><span class="n">hintsfor</span><span class="w"> </span><span class="n">vr6</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">SameAs</span><span class="w"> </span><span class="n">vr0</span><span class="p">,</span><span class="w"> </span><span class="n">weight</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="w"></span>
<span class="w"> </span><span class="n">TRACE</span><span class="w"> </span><span class="n">regalloc</span>::<span class="n">bt_coalescing_analysis</span><span class="w">        </span><span class="o">&gt;</span><span class="w">   </span><span class="n">eclassof</span><span class="w"> </span><span class="n">vr0</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span><span class="n">vr6</span><span class="p">,</span><span class="w"> </span><span class="n">vr0</span><span class="p">]</span><span class="w"></span>
<span class="w"> </span><span class="n">TRACE</span><span class="w"> </span><span class="n">regalloc</span>::<span class="n">bt_coalescing_analysis</span><span class="w">        </span><span class="o">&gt;</span><span class="w">   </span><span class="n">eclassof</span><span class="w"> </span><span class="n">vr1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span><span class="n">vr1</span><span class="p">]</span><span class="w"></span>
<span class="w"> </span><span class="n">TRACE</span><span class="w"> </span><span class="n">regalloc</span>::<span class="n">bt_coalescing_analysis</span><span class="w">        </span><span class="o">&gt;</span><span class="w">   </span><span class="n">eclassof</span><span class="w"> </span><span class="n">vr2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span><span class="n">vr2</span><span class="p">]</span><span class="w"></span>
<span class="w"> </span><span class="n">TRACE</span><span class="w"> </span><span class="n">regalloc</span>::<span class="n">bt_coalescing_analysis</span><span class="w">        </span><span class="o">&gt;</span><span class="w">   </span><span class="n">eclassof</span><span class="w"> </span><span class="n">vr3</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span><span class="n">vr4</span><span class="p">,</span><span class="w"> </span><span class="n">vr5</span><span class="p">,</span><span class="w"> </span><span class="n">vr3</span><span class="p">]</span><span class="w"></span>
<span class="w"> </span><span class="n">TRACE</span><span class="w"> </span><span class="n">regalloc</span>::<span class="n">bt_coalescing_analysis</span><span class="w">        </span><span class="o">&gt;</span><span class="w">   </span><span class="n">eclassof</span><span class="w"> </span><span class="n">vr4</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span><span class="n">vr4</span><span class="p">,</span><span class="w"> </span><span class="n">vr5</span><span class="p">,</span><span class="w"> </span><span class="n">vr3</span><span class="p">]</span><span class="w"></span>
<span class="w"> </span><span class="n">TRACE</span><span class="w"> </span><span class="n">regalloc</span>::<span class="n">bt_coalescing_analysis</span><span class="w">        </span><span class="o">&gt;</span><span class="w">   </span><span class="n">eclassof</span><span class="w"> </span><span class="n">vr5</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span><span class="n">vr4</span><span class="p">,</span><span class="w"> </span><span class="n">vr5</span><span class="p">,</span><span class="w"> </span><span class="n">vr3</span><span class="p">]</span><span class="w"></span>
<span class="w"> </span><span class="n">TRACE</span><span class="w"> </span><span class="n">regalloc</span>::<span class="n">bt_coalescing_analysis</span><span class="w">        </span><span class="o">&gt;</span><span class="w">   </span><span class="n">eclassof</span><span class="w"> </span><span class="n">vr6</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span><span class="n">vr6</span><span class="p">,</span><span class="w"> </span><span class="n">vr0</span><span class="p">]</span><span class="w"></span>
<span class="w"> </span><span class="n">TRACE</span><span class="w"> </span><span class="n">regalloc</span>::<span class="n">bt_coalescing_analysis</span><span class="w">        </span><span class="o">&gt;</span><span class="w">   </span><span class="n">vv_boundary_move</span><span class="w"> </span><span class="n">at</span><span class="w"> </span><span class="n">i5</span><span class="w"></span>
<span class="w"> </span><span class="n">TRACE</span><span class="w"> </span><span class="n">regalloc</span>::<span class="n">bt_coalescing_analysis</span><span class="w">        </span><span class="o">&gt;</span><span class="w">   </span><span class="n">vv_boundary_move</span><span class="w"> </span><span class="n">at</span><span class="w"> </span><span class="n">i7</span><span class="w"></span>
<span class="w"> </span><span class="n">TRACE</span><span class="w"> </span><span class="n">regalloc</span>::<span class="n">bt_coalescing_analysis</span><span class="w">        </span><span class="o">&gt;</span><span class="w">   </span><span class="n">vv_boundary_move</span><span class="w"> </span><span class="n">at</span><span class="w"> </span><span class="n">i9</span><span class="w"></span>
<span class="w"> </span><span class="n">TRACE</span><span class="w"> </span><span class="n">regalloc</span>::<span class="n">bt_coalescing_analysis</span><span class="w">        </span><span class="o">&gt;</span><span class="w"> </span><span class="n">do_coalescing_analysis</span>: <span class="nc">end</span><span class="w"></span>
<span class="w"> </span><span class="n">TRACE</span><span class="w"> </span><span class="n">regalloc</span>::<span class="n">bt_coalescing_analysis</span><span class="w">        </span><span class="o">&gt;</span><span class="w"></span>
</code></pre></div><br>
</p>
</blockquote>



<a name="267095628"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%233653%20cranelift%3A%20Port%20%60bitselect%60%20over%20t.../near/267095628" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.233653.20cranelift.3A.20Port.20.60bitselect.60.20over.20t.2E.2E.2E.html#267095628">(Jan 06 2022 at 18:23)</a>:</h4>
<p>cfallin <a href="https://github.com/bytecodealliance/wasmtime/pull/3653#issuecomment-1006814612">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/3653">issue #3653</a>:</p>
<blockquote>
<p>Hmm, interesting. My understanding is that <a href="http://regalloc.rs">regalloc.rs</a> computes equivalence classes to use in a strictly heuristic way during allocation (of virtual-reg ranges to registers, and then separately to spillslots). former (mainly in <a href="https://github.com/bytecodealliance/regalloc.rs/blob/main/lib/src/bt_main.rs">this file</a>) traverses equivalence classes looking for register hints (move to/from fixed reg), and to avoid some evictions. But two vregs existing in the same eclass does not guarantee that the move between them will be elided; in fact, one can construct inputs where there is not possible, as liveranges in an eclass can overlap. Elements in an eclass are joined by an "equivalence" that's kind of misnamed, I guess: it just means that at one point, one of the vregs was assigned to the other. Consider e.g. a loop where two vregs are swapped every iteration (<code>loop(x, y): br loop(y, x)</code>). So in this case, for whatever reason, the spill weights and processing order mean that the two sides of the move get allocated to different registers, and then that's it; the heuristics weren't quite good enough.</p>
<p>Zooming out a bit, I would expect that once in a while, we get perturbations like this as ISLE's SSA lowering works just a bit differently. As long as we don't see regressions overall, I think this is fine to accept.</p>
</blockquote>



<a name="267095662"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%233653%20cranelift%3A%20Port%20%60bitselect%60%20over%20t.../near/267095662" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.233653.20cranelift.3A.20Port.20.60bitselect.60.20over.20t.2E.2E.2E.html#267095662">(Jan 06 2022 at 18:23)</a>:</h4>
<p>cfallin edited a <a href="https://github.com/bytecodealliance/wasmtime/pull/3653#issuecomment-1006814612">comment</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/3653">issue #3653</a>:</p>
<blockquote>
<p>Hmm, interesting. My understanding is that <a href="http://regalloc.rs">regalloc.rs</a> computes equivalence classes to use in a strictly heuristic way during allocation (of virtual-reg ranges to registers, and then separately to spillslots). The former (mainly in <a href="https://github.com/bytecodealliance/regalloc.rs/blob/main/lib/src/bt_main.rs">this file</a>) traverses equivalence classes looking for register hints (move to/from fixed reg), and to avoid some evictions. But two vregs existing in the same eclass does not guarantee that the move between them will be elided; in fact, one can construct inputs where there is not possible, as liveranges in an eclass can overlap. Elements in an eclass are joined by an "equivalence" that's kind of misnamed, I guess: it just means that at one point, one of the vregs was assigned to the other. Consider e.g. a loop where two vregs are swapped every iteration (<code>loop(x, y): br loop(y, x)</code>). So in this case, for whatever reason, the spill weights and processing order mean that the two sides of the move get allocated to different registers, and then that's it; the heuristics weren't quite good enough.</p>
<p>Zooming out a bit, I would expect that once in a while, we get perturbations like this as ISLE's SSA lowering works just a bit differently. As long as we don't see regressions overall, I think this is fine to accept.</p>
</blockquote>



<a name="267095723"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%233653%20cranelift%3A%20Port%20%60bitselect%60%20over%20t.../near/267095723" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.233653.20cranelift.3A.20Port.20.60bitselect.60.20over.20t.2E.2E.2E.html#267095723">(Jan 06 2022 at 18:24)</a>:</h4>
<p>cfallin edited a <a href="https://github.com/bytecodealliance/wasmtime/pull/3653#issuecomment-1006814612">comment</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/3653">issue #3653</a>:</p>
<blockquote>
<p>Hmm, interesting. My understanding is that <a href="http://regalloc.rs">regalloc.rs</a> computes equivalence classes to use in a strictly heuristic way during allocation (of virtual-reg ranges to registers, and then separately to spillslots). The former (mainly in <a href="https://github.com/bytecodealliance/regalloc.rs/blob/main/lib/src/bt_main.rs">this file</a>) traverses equivalence classes looking for register hints (move to/from fixed reg), and to avoid some evictions. But two vregs existing in the same eclass does not guarantee that the move between them will be elided; in fact, one can construct inputs where this is not possible, as liveranges in an eclass can overlap. Elements in an eclass are joined by an "equivalence" that's kind of misnamed, I guess: it just means that at one point, one of the vregs was assigned to the other. Consider e.g. a loop where two vregs are swapped every iteration (<code>loop(x, y): br loop(y, x)</code>). So in this case, for whatever reason, the spill weights and processing order mean that the two sides of the move get allocated to different registers, and then that's it; the heuristics weren't quite good enough.</p>
<p>Zooming out a bit, I would expect that once in a while, we get perturbations like this as ISLE's SSA lowering works just a bit differently. As long as we don't see regressions overall, I think this is fine to accept.</p>
</blockquote>



<a name="267096850"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%233653%20cranelift%3A%20Port%20%60bitselect%60%20over%20t.../near/267096850" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.233653.20cranelift.3A.20Port.20.60bitselect.60.20over.20t.2E.2E.2E.html#267096850">(Jan 06 2022 at 18:33)</a>:</h4>
<p>fitzgen <a href="https://github.com/bytecodealliance/wasmtime/pull/3653#issuecomment-1006821112">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/3653">issue #3653</a>:</p>
<blockquote>
<p>Swapped the operands to the two commutative instructions (which I noticed was the only difference between the pre-regalloc vcode on <code>main</code> vs this branch) and the moves went away.</p>
<p>Yay <span aria-label="grimacing" class="emoji emoji-1f62c" role="img" title="grimacing">:grimacing:</span> </p>
</blockquote>



<a name="267096924"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%233653%20cranelift%3A%20Port%20%60bitselect%60%20over%20t.../near/267096924" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.233653.20cranelift.3A.20Port.20.60bitselect.60.20over.20t.2E.2E.2E.html#267096924">(Jan 06 2022 at 18:34)</a>:</h4>
<p>fitzgen <a href="https://github.com/bytecodealliance/wasmtime/pull/3653#issuecomment-1006821287">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/3653">issue #3653</a>:</p>
<blockquote>
<blockquote>
<p>Zooming out a bit, I would expect that once in a while, we get perturbations like this as ISLE's SSA lowering works just a bit differently. As long as we don't see regressions overall, I think this is fine to accept.</p>
</blockquote>
<p>But yeah, agreed on this point <span aria-label="+1" class="emoji emoji-1f44d" role="img" title="+1">:+1:</span> </p>
</blockquote>



<a name="267102056"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%233653%20cranelift%3A%20Port%20%60bitselect%60%20over%20t.../near/267102056" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.233653.20cranelift.3A.20Port.20.60bitselect.60.20over.20t.2E.2E.2E.html#267102056">(Jan 06 2022 at 19:18)</a>:</h4>
<p>github-actions[bot] <a href="https://github.com/bytecodealliance/wasmtime/pull/3653#issuecomment-1006855683">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/3653">issue #3653</a>:</p>
<blockquote>
<h4>Subscribe to Label Action</h4>
<p>cc @peterhuene</p>
<p>&lt;details&gt;<br>
This issue or pull request has been labeled: "wasmtime:api"</p>
<p>Thus the following users have been cc'd because of the following labels:</p>
<ul>
<li>peterhuene: wasmtime:api</li>
</ul>
<p>To subscribe or unsubscribe from this label, edit the &lt;code&gt;.github/subscribe-to-label.json&lt;/code&gt; configuration file.</p>
<p><a href="https://github.com/bytecodealliance/subscribe-to-label-action">Learn more.</a><br>
&lt;/details&gt;</p>
</blockquote>



<hr><p>Last updated: Jan 20 2025 at 06:04 UTC</p>
</html>