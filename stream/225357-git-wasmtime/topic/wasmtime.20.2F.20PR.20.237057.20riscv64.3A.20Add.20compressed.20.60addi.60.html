<html>
<head><meta charset="utf-8"><title>wasmtime / PR #7057 riscv64: Add compressed `addi` · git-wasmtime · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/index.html">git-wasmtime</a></h2>
<h3>Topic: <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.237057.20riscv64.3A.20Add.20compressed.20.60addi.60.html">wasmtime / PR #7057 riscv64: Add compressed `addi`</a></h3>

<hr>

<base href="https://bytecodealliance.zulipchat.com">

<head><link href="https://bytecodealliance.github.io/zulip-archive/style.css" rel="stylesheet"></head>

<a name="391765584"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%237057%20riscv64%3A%20Add%20compressed%20%60addi%60/near/391765584" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.237057.20riscv64.3A.20Add.20compressed.20.60addi.60.html#391765584">(Sep 18 2023 at 19:54)</a>:</h4>
<p>afonso360 opened <a href="https://github.com/bytecodealliance/wasmtime/pull/7057">PR #7057</a> from <code>afonso360:riscv-c-inst-part-2</code> to <code>bytecodealliance:main</code>:</p>
<blockquote>
<p><span aria-label="wave" class="emoji emoji-1f44b" role="img" title="wave">:wave:</span> Hey,</p>
<p>This PR introduces all of the compressed variations of the <code>addi</code> instruction (4 different adds!) as well as compressed trap, compressed <code>debugtrap</code>, and compressed shift left.</p>
<p>We have the following add variants:</p>
<ul>
<li><code>c.addi</code> this is the normal <code>addi</code>, with a signed 6 bit immediate field.</li>
<li><code>c.addiw</code> also fairly normal, a 32 bit add with a 6 bit immediate, that sign extends the result to 64bits.</li>
<li><code>c.addi16sp</code> modifies the stack pointer with a signed 6 bit immediate scaled by 16.</li>
<li><code>c.addi4spn</code> adds a zero extended 6 bit immediate scaled by 4 to the stack pointer. Unlike <code>c.addi16sp</code> it allows saving the result in any compressible register.<br>
</li>
</ul>
</blockquote>



<a name="391765585"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%237057%20riscv64%3A%20Add%20compressed%20%60addi%60/near/391765585" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.237057.20riscv64.3A.20Add.20compressed.20.60addi.60.html#391765585">(Sep 18 2023 at 19:54)</a>:</h4>
<p><strong>afonso360</strong> requested <a href="https://github.com/abrown">abrown</a> for a review on <a href="https://github.com/bytecodealliance/wasmtime/pull/7057">PR #7057</a>.</p>



<a name="391765586"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%237057%20riscv64%3A%20Add%20compressed%20%60addi%60/near/391765586" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.237057.20riscv64.3A.20Add.20compressed.20.60addi.60.html#391765586">(Sep 18 2023 at 19:54)</a>:</h4>
<p><strong>afonso360</strong> requested <a href="https://github.com/orgs/bytecodealliance/teams/wasmtime-compiler-reviewers">wasmtime-compiler-reviewers</a> for a review on <a href="https://github.com/bytecodealliance/wasmtime/pull/7057">PR #7057</a>.</p>



<a name="391770348"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%237057%20riscv64%3A%20Add%20compressed%20%60addi%60/near/391770348" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.237057.20riscv64.3A.20Add.20compressed.20.60addi.60.html#391770348">(Sep 18 2023 at 20:31)</a>:</h4>
<p>alexcrichton submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/7057#pullrequestreview-1631913113">PR review</a>.</p>



<a name="391770349"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%237057%20riscv64%3A%20Add%20compressed%20%60addi%60/near/391770349" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.237057.20riscv64.3A.20Add.20compressed.20.60addi.60.html#391770349">(Sep 18 2023 at 20:31)</a>:</h4>
<p>alexcrichton submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/7057#pullrequestreview-1631913113">PR review</a>.</p>



<a name="391770350"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%237057%20riscv64%3A%20Add%20compressed%20%60addi%60/near/391770350" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.237057.20riscv64.3A.20Add.20compressed.20.60addi.60.html#391770350">(Sep 18 2023 at 20:31)</a>:</h4>
<p>alexcrichton created <a href="https://github.com/bytecodealliance/wasmtime/pull/7057#discussion_r1329245289">PR review comment</a>:</p>
<blockquote>
<p>To avoid the double-construction logic for <code>Imm6::maybe_from_imm12</code> could this do:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="kd">let</span><span class="w"> </span><span class="n">imm6</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">match</span><span class="w"> </span><span class="n">Imm6</span>::<span class="n">maybe_from_imm12</span><span class="p">(</span><span class="n">imm12</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nb">Some</span><span class="p">(</span><span class="n">imm6</span><span class="p">)</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="n">imm6</span><span class="p">,</span>
<span class="w">    </span><span class="nb">None</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="kc">false</span><span class="p">,</span>
<span class="p">};</span>
</code></pre></div>
<p>or alternatively if this function returned <code>Option&lt;()&gt;</code> instead of <code>bool</code> it could use <code>?</code>. Or alternatively I think this could use <code>let Some(imm6) = ... else { return false; };</code>, but I haven't use <code>let</code>/<code>else</code> much myself.</p>
</blockquote>



<a name="391770352"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%237057%20riscv64%3A%20Add%20compressed%20%60addi%60/near/391770352" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.237057.20riscv64.3A.20Add.20compressed.20.60addi.60.html#391770352">(Sep 18 2023 at 20:31)</a>:</h4>
<p>alexcrichton created <a href="https://github.com/bytecodealliance/wasmtime/pull/7057#discussion_r1329246402">PR review comment</a>:</p>
<blockquote>
<p>Instead of gating all these rules with <code>has_zca</code>, could that be at the top of the function to early-return <code>false</code> if it's not enabled?</p>
</blockquote>



<a name="391770353"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%237057%20riscv64%3A%20Add%20compressed%20%60addi%60/near/391770353" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.237057.20riscv64.3A.20Add.20compressed.20.60addi.60.html#391770353">(Sep 18 2023 at 20:31)</a>:</h4>
<p>alexcrichton created <a href="https://github.com/bytecodealliance/wasmtime/pull/7057#discussion_r1329247294">PR review comment</a>:</p>
<blockquote>
<p>Should this be <code>c.addiw</code> instead of <code>c.sext.w</code>?</p>
</blockquote>



<a name="391772076"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%237057%20riscv64%3A%20Add%20compressed%20%60addi%60/near/391772076" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.237057.20riscv64.3A.20Add.20compressed.20.60addi.60.html#391772076">(Sep 18 2023 at 20:44)</a>:</h4>
<p>afonso360 submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/7057#pullrequestreview-1631935165">PR review</a>.</p>



<a name="391772077"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%237057%20riscv64%3A%20Add%20compressed%20%60addi%60/near/391772077" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.237057.20riscv64.3A.20Add.20compressed.20.60addi.60.html#391772077">(Sep 18 2023 at 20:44)</a>:</h4>
<p>afonso360 created <a href="https://github.com/bytecodealliance/wasmtime/pull/7057#discussion_r1329259099">PR review comment</a>:</p>
<blockquote>
<p>Yes, I think we can. I was worried that it was possible for a target to implement <code>Zcd</code> or <code>Zcb</code> (which I'm planing on implementing soon) without <code>Zca</code>, but I looked at the spec and both of them require <code>Zca</code> to be present.</p>
</blockquote>



<a name="391772127"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%237057%20riscv64%3A%20Add%20compressed%20%60addi%60/near/391772127" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.237057.20riscv64.3A.20Add.20compressed.20.60addi.60.html#391772127">(Sep 18 2023 at 20:44)</a>:</h4>
<p>afonso360 submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/7057#pullrequestreview-1631935529">PR review</a>.</p>



<a name="391772128"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%237057%20riscv64%3A%20Add%20compressed%20%60addi%60/near/391772128" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.237057.20riscv64.3A.20Add.20compressed.20.60addi.60.html#391772128">(Sep 18 2023 at 20:44)</a>:</h4>
<p>afonso360 created <a href="https://github.com/bytecodealliance/wasmtime/pull/7057#discussion_r1329259317">PR review comment</a>:</p>
<blockquote>
<p>Oops, yes it should.</p>
</blockquote>



<a name="391772434"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%237057%20riscv64%3A%20Add%20compressed%20%60addi%60/near/391772434" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.237057.20riscv64.3A.20Add.20compressed.20.60addi.60.html#391772434">(Sep 18 2023 at 20:46)</a>:</h4>
<p>alexcrichton submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/7057#pullrequestreview-1631938564">PR review</a>:</p>
<blockquote>
<p>Oh I meant to do this too</p>
</blockquote>



<a name="391772581"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%237057%20riscv64%3A%20Add%20compressed%20%60addi%60/near/391772581" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.237057.20riscv64.3A.20Add.20compressed.20.60addi.60.html#391772581">(Sep 18 2023 at 20:47)</a>:</h4>
<p>afonso360 submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/7057#pullrequestreview-1631940131">PR review</a>.</p>



<a name="391772584"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%237057%20riscv64%3A%20Add%20compressed%20%60addi%60/near/391772584" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.237057.20riscv64.3A.20Add.20compressed.20.60addi.60.html#391772584">(Sep 18 2023 at 20:47)</a>:</h4>
<p>afonso360 created <a href="https://github.com/bytecodealliance/wasmtime/pull/7057#discussion_r1329262429">PR review comment</a>:</p>
<blockquote>
<p>Here I think it's ok  to do that, but I'd like to keep the separate check for <code>c.addi16sp</code> and <code>c.addi4spn</code> so that we can try to match all 3 instructions. Otherwise we could enter into one branch and never emit the instruction.</p>
</blockquote>



<a name="391772669"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%237057%20riscv64%3A%20Add%20compressed%20%60addi%60/near/391772669" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.237057.20riscv64.3A.20Add.20compressed.20.60addi.60.html#391772669">(Sep 18 2023 at 20:48)</a>:</h4>
<p>afonso360 edited <a href="https://github.com/bytecodealliance/wasmtime/pull/7057#discussion_r1329262429">PR review comment</a>.</p>



<a name="391773275"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%237057%20riscv64%3A%20Add%20compressed%20%60addi%60/near/391773275" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.237057.20riscv64.3A.20Add.20compressed.20.60addi.60.html#391773275">(Sep 18 2023 at 20:53)</a>:</h4>
<p>afonso360 edited <a href="https://github.com/bytecodealliance/wasmtime/pull/7057#discussion_r1329262429">PR review comment</a>.</p>



<a name="391773587"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%237057%20riscv64%3A%20Add%20compressed%20%60addi%60/near/391773587" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.237057.20riscv64.3A.20Add.20compressed.20.60addi.60.html#391773587">(Sep 18 2023 at 20:54)</a>:</h4>
<p>afonso360 updated <a href="https://github.com/bytecodealliance/wasmtime/pull/7057">PR #7057</a>.</p>



<a name="391776086"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%237057%20riscv64%3A%20Add%20compressed%20%60addi%60/near/391776086" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.237057.20riscv64.3A.20Add.20compressed.20.60addi.60.html#391776086">(Sep 18 2023 at 21:12)</a>:</h4>
<p>afonso360 has enabled auto merge for <a href="https://github.com/bytecodealliance/wasmtime/pull/7057">PR #7057</a>.</p>



<a name="391796138"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%237057%20riscv64%3A%20Add%20compressed%20%60addi%60/near/391796138" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.237057.20riscv64.3A.20Add.20compressed.20.60addi.60.html#391796138">(Sep 19 2023 at 00:16)</a>:</h4>
<p>afonso360 merged <a href="https://github.com/bytecodealliance/wasmtime/pull/7057">PR #7057</a>.</p>



<hr><p>Last updated: Jan 20 2025 at 06:04 UTC</p>
</html>