<html>
<head><meta charset="utf-8"><title>wasmtime / issue #5181 Cranelift: use egraphs by default · git-wasmtime · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/index.html">git-wasmtime</a></h2>
<h3>Topic: <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.235181.20Cranelift.3A.20use.20egraphs.20by.20default.html">wasmtime / issue #5181 Cranelift: use egraphs by default</a></h3>

<hr>

<base href="https://bytecodealliance.zulipchat.com">

<head><link href="https://bytecodealliance.github.io/zulip-archive/style.css" rel="stylesheet"></head>

<a name="307564305"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%235181%20Cranelift%3A%20use%20egraphs%20by%20default/near/307564305" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.235181.20Cranelift.3A.20use.20egraphs.20by.20default.html#307564305">(Nov 02 2022 at 16:21)</a>:</h4>
<p>fitzgen opened <a href="https://github.com/bytecodealliance/wasmtime/issues/5181">issue #5181</a>:</p>
<blockquote>
<p>It should be enabled by default. We should also define what the requirements we need to meet to enable it by default are.</p>
<p>cc @cfallin @jameysharp </p>
</blockquote>



<a name="307564306"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%235181%20Cranelift%3A%20use%20egraphs%20by%20default/near/307564306" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.235181.20Cranelift.3A.20use.20egraphs.20by.20default.html#307564306">(Nov 02 2022 at 16:21)</a>:</h4>
<p>fitzgen labeled <a href="https://github.com/bytecodealliance/wasmtime/issues/5181">issue #5181</a>:</p>
<blockquote>
<p>It should be enabled by default. We should also define what the requirements we need to meet to enable it by default are.</p>
<p>cc @cfallin @jameysharp </p>
</blockquote>



<a name="307564307"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%235181%20Cranelift%3A%20use%20egraphs%20by%20default/near/307564307" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.235181.20Cranelift.3A.20use.20egraphs.20by.20default.html#307564307">(Nov 02 2022 at 16:21)</a>:</h4>
<p>fitzgen labeled <a href="https://github.com/bytecodealliance/wasmtime/issues/5181">issue #5181</a>:</p>
<blockquote>
<p>It should be enabled by default. We should also define what the requirements we need to meet to enable it by default are.</p>
<p>cc @cfallin @jameysharp </p>
</blockquote>



<a name="307576247"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%235181%20Cranelift%3A%20use%20egraphs%20by%20default/near/307576247" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.235181.20Cranelift.3A.20use.20egraphs.20by.20default.html#307576247">(Nov 02 2022 at 17:15)</a>:</h4>
<p>jameysharp <a href="https://github.com/bytecodealliance/wasmtime/issues/5181#issuecomment-1300949678">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/5181">issue #5181</a>:</p>
<blockquote>
<p>As far as I know there are two specific reasons we haven't done this yet:</p>
<ol>
<li>Compile speed regresses a little bit with egraphs turned on.</li>
<li>We were encountering some fuzzing failures.</li>
</ol>
<p>We have some ideas that might get the egraphs optimizer to parity with the current implementation and we want to play with those.</p>
</blockquote>



<a name="307578475"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%235181%20Cranelift%3A%20use%20egraphs%20by%20default/near/307578475" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.235181.20Cranelift.3A.20use.20egraphs.20by.20default.html#307578475">(Nov 02 2022 at 17:25)</a>:</h4>
<p>cfallin <a href="https://github.com/bytecodealliance/wasmtime/issues/5181#issuecomment-1300974449">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/5181">issue #5181</a>:</p>
<blockquote>
<p>Indeed; to add a little more, the overall approach I want to take is to integrate the egraph data structure more completely into the <code>DataFlowGraph</code>. Basically, the <code>PrimaryMap</code> of <code>ValueDef</code>s can take the place of the "eclass nodes" in <code>cranelift-egraph</code> currently: alongside the other kinds of defs (instruction output, blockparam, alias), we can have a "union" kind. Then the multi-definition aspect of the aegraph can be represented directly in the CLIF.</p>
<p>Then the only other difference is that we can take "pure" insts and <em>not</em> place them in blocks before elaboration. So the egraph-mode becomes:</p>
<ul>
<li>Allow multiple definitions of a value in the CLIF, by introducing a "union" kind of value (write this in the CLIF text format as e.g. <code>v3 &lt;- v1, v2</code> analogously to aliases currently);</li>
<li>Apply rewrite rules as soon as values are introduced, as we do in egraph-mode today (optimizations-during-build);</li>
<li>Do not place "pure" instructions in the <code>Layout</code> until elaboration. Elaboration consists of (i) choosing a canonical value for each value (a value-&gt;value map), and (ii) putting <code>Inst</code>s in the <code>Layout</code>, possibly duplicating where needed;</li>
<li>Modifying the hashing in GVN a bit so that we hash insts based on canonical values (via a union-find forest) rather than latest-value-in-eclass values.</li>
</ul>
<p>There are a bunch of nice outcomes from that (and once I saw it, I realized we basically <em>must</em> go this way, and a separate egraph doesn't make sense anymore):</p>
<ul>
<li>Any CLIF is also almost an aegraph, trivially / by construction. (The lack of placement for pure nodes is the only difference).</li>
<li>There is no copying/translation of information between egraph nodes and CLIF instructions.</li>
<li>We get all the debugging benefits of the text format and other utilities surrounding CLIF.</li>
</ul>
<p>I want to build all of this first, and suspect that when I do, the perf regressions we're seeing should go away. The reason for holding back before then is both because of the regression but also because if the design is going to change, we should do that before we rely on it as the default path.</p>
<p>I'm currently 100%-coding-time on another project but will hopefully be able to come back to this sometime soon-ish; @jameysharp and I have talked about collaborating on its implementation as well.</p>
</blockquote>



<a name="307582263"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%235181%20Cranelift%3A%20use%20egraphs%20by%20default/near/307582263" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.235181.20Cranelift.3A.20use.20egraphs.20by.20default.html#307582263">(Nov 02 2022 at 17:44)</a>:</h4>
<p>bjorn3 <a href="https://github.com/bytecodealliance/wasmtime/issues/5181#issuecomment-1301005362">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/5181">issue #5181</a>:</p>
<blockquote>
<p>Would it be possible to replace <code>Layout</code> with a different type while the function is in aegraph form, but keep <code>DataFlowGraph</code> in both cases? This would extend to more alternative representations like VSDG/sea of nodes or something with structured control flow (for eg wasm or spirv generation) with minimal (or no) changes to the core ir while at the same time minimizing code duplication.</p>
</blockquote>



<a name="307582933"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%235181%20Cranelift%3A%20use%20egraphs%20by%20default/near/307582933" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.235181.20Cranelift.3A.20use.20egraphs.20by.20default.html#307582933">(Nov 02 2022 at 17:47)</a>:</h4>
<p>cfallin <a href="https://github.com/bytecodealliance/wasmtime/issues/5181#issuecomment-1301009243">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/5181">issue #5181</a>:</p>
<blockquote>
<p>Yep, we could go further in that direction as well; that's an interesting direction to explore.</p>
</blockquote>



<a name="322402262"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%235181%20Cranelift%3A%20use%20egraphs%20by%20default/near/322402262" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.235181.20Cranelift.3A.20use.20egraphs.20by.20default.html#322402262">(Jan 19 2023 at 23:46)</a>:</h4>
<p>cfallin closed <a href="https://github.com/bytecodealliance/wasmtime/issues/5181">issue #5181</a>:</p>
<blockquote>
<p>It should be enabled by default. We should also define what the requirements we need to meet to enable it by default are.</p>
<p>cc @cfallin @jameysharp </p>
</blockquote>



<hr><p>Last updated: Jan 20 2025 at 06:04 UTC</p>
</html>