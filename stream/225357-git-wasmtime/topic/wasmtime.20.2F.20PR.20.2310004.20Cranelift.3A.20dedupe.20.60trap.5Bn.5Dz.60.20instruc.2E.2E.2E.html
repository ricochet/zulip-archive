<html>
<head><meta charset="utf-8"><title>wasmtime / PR #10004 Cranelift: dedupe `trap[n]z` instruc... · git-wasmtime · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/index.html">git-wasmtime</a></h2>
<h3>Topic: <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2310004.20Cranelift.3A.20dedupe.20.60trap.5Bn.5Dz.60.20instruc.2E.2E.2E.html">wasmtime / PR #10004 Cranelift: dedupe `trap[n]z` instruc...</a></h3>

<hr>

<base href="https://bytecodealliance.zulipchat.com">

<head><link href="https://bytecodealliance.github.io/zulip-archive/style.css" rel="stylesheet"></head>

<a name="493487939"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2310004%20Cranelift%3A%20dedupe%20%60trap%5Bn%5Dz%60%20instruc.../near/493487939" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2310004.20Cranelift.3A.20dedupe.20.60trap.5Bn.5Dz.60.20instruc.2E.2E.2E.html#493487939">(Jan 14 2025 at 01:23)</a>:</h4>
<p>fitzgen opened <a href="https://github.com/bytecodealliance/wasmtime/pull/10004">PR #10004</a> from <code>fitzgen:idempotent-trapz-trapnz</code> to <code>bytecodealliance:main</code>:</p>
<blockquote>
<p>This commit extends our existing support for merging idempotently side-effectful instructions that produce exactly one value to those that produce zero or one value, and marks the <code>trap[n]z</code> instructions as having idempotent side effects. This cleans up a lot test cases in our <code>disas</code> test suite, particularly those related to explicit bounds checks and GC.</p>
<p>As an aside, it seems like it should be easy to extend this to idempotently side-effectful instructions that produce multiple values as well, but I don't believe we have any such instructions, so I didn't bother.</p>
<p>&lt;!--<br>
Please make sure you include the following information:</p>
<ul>
<li>
<p>If this work has been discussed elsewhere, please include a link to that<br>
  conversation. If it was discussed in an issue, just mention "issue #...".</p>
</li>
<li>
<p>Explain why this change is needed. If the details are in an issue already,<br>
  this can be brief.</p>
</li>
</ul>
<p>Our development process is documented in the Wasmtime book:<br>
<a href="https://docs.wasmtime.dev/contributing-development-process.html">https://docs.wasmtime.dev/contributing-development-process.html</a></p>
<p>Please ensure all communication follows the code of conduct:<br>
<a href="https://github.com/bytecodealliance/wasmtime/blob/main/CODE_OF_CONDUCT.md">https://github.com/bytecodealliance/wasmtime/blob/main/CODE_OF_CONDUCT.md</a><br>
--&gt;</p>
</blockquote>



<a name="493487940"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2310004%20Cranelift%3A%20dedupe%20%60trap%5Bn%5Dz%60%20instruc.../near/493487940" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2310004.20Cranelift.3A.20dedupe.20.60trap.5Bn.5Dz.60.20instruc.2E.2E.2E.html#493487940">(Jan 14 2025 at 01:23)</a>:</h4>
<p><strong>fitzgen</strong> requested <a href="https://github.com/cfallin">cfallin</a> for a review on <a href="https://github.com/bytecodealliance/wasmtime/pull/10004">PR #10004</a>.</p>



<a name="493487941"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2310004%20Cranelift%3A%20dedupe%20%60trap%5Bn%5Dz%60%20instruc.../near/493487941" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2310004.20Cranelift.3A.20dedupe.20.60trap.5Bn.5Dz.60.20instruc.2E.2E.2E.html#493487941">(Jan 14 2025 at 01:23)</a>:</h4>
<p><strong>fitzgen</strong> requested <a href="https://github.com/orgs/bytecodealliance/teams/wasmtime-compiler-reviewers">wasmtime-compiler-reviewers</a> for a review on <a href="https://github.com/bytecodealliance/wasmtime/pull/10004">PR #10004</a>.</p>



<a name="493487943"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2310004%20Cranelift%3A%20dedupe%20%60trap%5Bn%5Dz%60%20instruc.../near/493487943" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2310004.20Cranelift.3A.20dedupe.20.60trap.5Bn.5Dz.60.20instruc.2E.2E.2E.html#493487943">(Jan 14 2025 at 01:23)</a>:</h4>
<p><strong>fitzgen</strong> requested <a href="https://github.com/dicej">dicej</a> for a review on <a href="https://github.com/bytecodealliance/wasmtime/pull/10004">PR #10004</a>.</p>



<a name="493487944"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2310004%20Cranelift%3A%20dedupe%20%60trap%5Bn%5Dz%60%20instruc.../near/493487944" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2310004.20Cranelift.3A.20dedupe.20.60trap.5Bn.5Dz.60.20instruc.2E.2E.2E.html#493487944">(Jan 14 2025 at 01:23)</a>:</h4>
<p><strong>fitzgen</strong> requested <a href="https://github.com/orgs/bytecodealliance/teams/wasmtime-core-reviewers">wasmtime-core-reviewers</a> for a review on <a href="https://github.com/bytecodealliance/wasmtime/pull/10004">PR #10004</a>.</p>



<a name="493489420"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2310004%20Cranelift%3A%20dedupe%20%60trap%5Bn%5Dz%60%20instruc.../near/493489420" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2310004.20Cranelift.3A.20dedupe.20.60trap.5Bn.5Dz.60.20instruc.2E.2E.2E.html#493489420">(Jan 14 2025 at 01:34)</a>:</h4>
<p>fitzgen updated <a href="https://github.com/bytecodealliance/wasmtime/pull/10004">PR #10004</a>.</p>



<a name="493512863"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2310004%20Cranelift%3A%20dedupe%20%60trap%5Bn%5Dz%60%20instruc.../near/493512863" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2310004.20Cranelift.3A.20dedupe.20.60trap.5Bn.5Dz.60.20instruc.2E.2E.2E.html#493512863">(Jan 14 2025 at 05:24)</a>:</h4>
<p>cfallin submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/10004#pullrequestreview-2548836810">PR review</a>:</p>
<blockquote>
<p>This is great -- thanks a bunch for working this out!</p>
<p>My only thoughts are for a few more comments and one more test, otherwise LGTM.</p>
</blockquote>



<a name="493512864"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2310004%20Cranelift%3A%20dedupe%20%60trap%5Bn%5Dz%60%20instruc.../near/493512864" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2310004.20Cranelift.3A.20dedupe.20.60trap.5Bn.5Dz.60.20instruc.2E.2E.2E.html#493512864">(Jan 14 2025 at 05:24)</a>:</h4>
<p>cfallin created <a href="https://github.com/bytecodealliance/wasmtime/pull/10004#discussion_r1914263128">PR review comment</a>:</p>
<blockquote>
<p>Can we add a comment here describing the rationale a bit more (for our future selves as much as others)?</p>
<p>Something like: "<code>side_effects_idempotent</code> indicates that when we have more than one copy of this instruction, it is safe to merge (GVN) them. Traps have this characteristic: as long as we don't remove them, if we have already passed through (computed) one trap instruction on a given condition, it is safe to consider other traps on the same condition as redundant. In other words, a trap on value X is idempotent: once we observe its side effect (which will either terminate execution or do nothing), we don't need to observe it again."</p>
</blockquote>



<a name="493512865"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2310004%20Cranelift%3A%20dedupe%20%60trap%5Bn%5Dz%60%20instruc.../near/493512865" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2310004.20Cranelift.3A.20dedupe.20.60trap.5Bn.5Dz.60.20instruc.2E.2E.2E.html#493512865">(Jan 14 2025 at 05:24)</a>:</h4>
<p>cfallin created <a href="https://github.com/bytecodealliance/wasmtime/pull/10004#discussion_r1914265113">PR review comment</a>:</p>
<blockquote>
<p>Can we also add a test with a <code>trapz</code> and <code>trapnz</code> on the same condition, to verify that (if we ever change the instruction encoding) we're disambiguating on the condition as well and not merging them? (i.e., arrange such that they would merge if they were both the same opcode)</p>
</blockquote>



<a name="493512866"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2310004%20Cranelift%3A%20dedupe%20%60trap%5Bn%5Dz%60%20instruc.../near/493512866" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2310004.20Cranelift.3A.20dedupe.20.60trap.5Bn.5Dz.60.20instruc.2E.2E.2E.html#493512866">(Jan 14 2025 at 05:24)</a>:</h4>
<p>cfallin created <a href="https://github.com/bytecodealliance/wasmtime/pull/10004#discussion_r1914263699">PR review comment</a>:</p>
<blockquote>
<p>"Hit in GVN map but for instruction with zero results: may be a side-effect-only idempotent instruction like <code>trapnz</code>/<code>trapz</code>. Nothing else to do here." perhaps?</p>
</blockquote>



<a name="493642147"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2310004%20Cranelift%3A%20dedupe%20%60trap%5Bn%5Dz%60%20instruc.../near/493642147" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2310004.20Cranelift.3A.20dedupe.20.60trap.5Bn.5Dz.60.20instruc.2E.2E.2E.html#493642147">(Jan 14 2025 at 18:15)</a>:</h4>
<p>fitzgen updated <a href="https://github.com/bytecodealliance/wasmtime/pull/10004">PR #10004</a>.</p>



<a name="493642209"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2310004%20Cranelift%3A%20dedupe%20%60trap%5Bn%5Dz%60%20instruc.../near/493642209" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2310004.20Cranelift.3A.20dedupe.20.60trap.5Bn.5Dz.60.20instruc.2E.2E.2E.html#493642209">(Jan 14 2025 at 18:15)</a>:</h4>
<p>fitzgen has enabled auto merge for <a href="https://github.com/bytecodealliance/wasmtime/pull/10004">PR #10004</a>.</p>



<a name="493642670"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2310004%20Cranelift%3A%20dedupe%20%60trap%5Bn%5Dz%60%20instruc.../near/493642670" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2310004.20Cranelift.3A.20dedupe.20.60trap.5Bn.5Dz.60.20instruc.2E.2E.2E.html#493642670">(Jan 14 2025 at 18:18)</a>:</h4>
<p>fitzgen updated <a href="https://github.com/bytecodealliance/wasmtime/pull/10004">PR #10004</a>.</p>



<a name="493647461"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2310004%20Cranelift%3A%20dedupe%20%60trap%5Bn%5Dz%60%20instruc.../near/493647461" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2310004.20Cranelift.3A.20dedupe.20.60trap.5Bn.5Dz.60.20instruc.2E.2E.2E.html#493647461">(Jan 14 2025 at 18:48)</a>:</h4>
<p>fitzgen merged <a href="https://github.com/bytecodealliance/wasmtime/pull/10004">PR #10004</a>.</p>



<hr><p>Last updated: Jan 20 2025 at 06:04 UTC</p>
</html>