<html>
<head><meta charset="utf-8"><title>wasmtime / issue #4767 cranelift: Add VEX and EVEX memory... · git-wasmtime · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/index.html">git-wasmtime</a></h2>
<h3>Topic: <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.234767.20cranelift.3A.20Add.20VEX.20and.20EVEX.20memory.2E.2E.2E.html">wasmtime / issue #4767 cranelift: Add VEX and EVEX memory...</a></h3>

<hr>

<base href="https://bytecodealliance.zulipchat.com">

<head><link href="https://bytecodealliance.github.io/zulip-archive/style.css" rel="stylesheet"></head>

<a name="295024658"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%234767%20cranelift%3A%20Add%20VEX%20and%20EVEX%20memory.../near/295024658" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.234767.20cranelift.3A.20Add.20VEX.20and.20EVEX.20memory.2E.2E.2E.html#295024658">(Aug 24 2022 at 11:21)</a>:</h4>
<p>afonso360 opened <a href="https://github.com/bytecodealliance/wasmtime/issues/4767">issue #4767</a>:</p>
<blockquote>
<p><span aria-label="wave" class="emoji emoji-1f44b" role="img" title="wave">:wave:</span> Hey,</p>
<h4>Feature</h4>
<p>We should add the memory encodings for VEX and EVEX instructions.</p>
<h4>Benefit</h4>
<p>Better codegen.</p>
<h4>Implementation</h4>
<ul>
<li>Add the encodings in the VEX and EVEX encoders</li>
<li>Fix lower.isle as needed to produce the new instructions</li>
</ul>
<h4>Alternatives</h4>
<p>We could keep doing what we do now and have worse codegen.</p>
<p>cc: @abrown </p>
</blockquote>



<a name="296847562"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%234767%20cranelift%3A%20Add%20VEX%20and%20EVEX%20memory.../near/296847562" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.234767.20cranelift.3A.20Add.20VEX.20and.20EVEX.20memory.2E.2E.2E.html#296847562">(Sep 02 2022 at 15:50)</a>:</h4>
<p>akirilov-arm labeled <a href="https://github.com/bytecodealliance/wasmtime/issues/4767">issue #4767</a>:</p>
<blockquote>
<p><span aria-label="wave" class="emoji emoji-1f44b" role="img" title="wave">:wave:</span> Hey,</p>
<h4>Feature</h4>
<p>We should add the memory encodings for VEX and EVEX instructions.</p>
<h4>Benefit</h4>
<p>Better codegen.</p>
<h4>Implementation</h4>
<ul>
<li>Add the encodings in the VEX and EVEX encoders</li>
<li>Fix lower.isle as needed to produce the new instructions</li>
</ul>
<h4>Alternatives</h4>
<p>We could keep doing what we do now and have worse codegen.</p>
<p>cc: @abrown </p>
</blockquote>



<a name="296847563"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%234767%20cranelift%3A%20Add%20VEX%20and%20EVEX%20memory.../near/296847563" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.234767.20cranelift.3A.20Add.20VEX.20and.20EVEX.20memory.2E.2E.2E.html#296847563">(Sep 02 2022 at 15:50)</a>:</h4>
<p>akirilov-arm labeled <a href="https://github.com/bytecodealliance/wasmtime/issues/4767">issue #4767</a>:</p>
<blockquote>
<p><span aria-label="wave" class="emoji emoji-1f44b" role="img" title="wave">:wave:</span> Hey,</p>
<h4>Feature</h4>
<p>We should add the memory encodings for VEX and EVEX instructions.</p>
<h4>Benefit</h4>
<p>Better codegen.</p>
<h4>Implementation</h4>
<ul>
<li>Add the encodings in the VEX and EVEX encoders</li>
<li>Fix lower.isle as needed to produce the new instructions</li>
</ul>
<h4>Alternatives</h4>
<p>We could keep doing what we do now and have worse codegen.</p>
<p>cc: @abrown </p>
</blockquote>



<a name="296847565"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%234767%20cranelift%3A%20Add%20VEX%20and%20EVEX%20memory.../near/296847565" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.234767.20cranelift.3A.20Add.20VEX.20and.20EVEX.20memory.2E.2E.2E.html#296847565">(Sep 02 2022 at 15:50)</a>:</h4>
<p>akirilov-arm labeled <a href="https://github.com/bytecodealliance/wasmtime/issues/4767">issue #4767</a>:</p>
<blockquote>
<p><span aria-label="wave" class="emoji emoji-1f44b" role="img" title="wave">:wave:</span> Hey,</p>
<h4>Feature</h4>
<p>We should add the memory encodings for VEX and EVEX instructions.</p>
<h4>Benefit</h4>
<p>Better codegen.</p>
<h4>Implementation</h4>
<ul>
<li>Add the encodings in the VEX and EVEX encoders</li>
<li>Fix lower.isle as needed to produce the new instructions</li>
</ul>
<h4>Alternatives</h4>
<p>We could keep doing what we do now and have worse codegen.</p>
<p>cc: @abrown </p>
</blockquote>



<a name="328069660"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%234767%20cranelift%3A%20Add%20VEX%20and%20EVEX%20memory.../near/328069660" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.234767.20cranelift.3A.20Add.20VEX.20and.20EVEX.20memory.2E.2E.2E.html#328069660">(Feb 15 2023 at 17:41)</a>:</h4>
<p>afonso360 <a href="https://github.com/bytecodealliance/wasmtime/issues/4767#issuecomment-1431758415">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/4767">issue #4767</a>:</p>
<blockquote>
<p>We discussed this a little bit in today's cranelift meeting. While it would be nice for cranelift, @cfallin pointed out that it would be slightly less relevant for wasmtime since the instructions that use these memory encodings have alignment restrictions, and WebAssembly has alignment <em>hints</em> but no guarantees, so we can't use it there.</p>
</blockquote>



<a name="328120315"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%234767%20cranelift%3A%20Add%20VEX%20and%20EVEX%20memory.../near/328120315" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.234767.20cranelift.3A.20Add.20VEX.20and.20EVEX.20memory.2E.2E.2E.html#328120315">(Feb 15 2023 at 22:29)</a>:</h4>
<p>abrown <a href="https://github.com/bytecodealliance/wasmtime/issues/4767#issuecomment-1432149408">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/4767">issue #4767</a>:</p>
<blockquote>
<p>I discussed this with @cfallin a bit and wanted to correct some misconceptions. As I did some digging in the x86 manual, the SSE documentation (section 10.3) does indicate that memory operands must be aligned:</p>
<blockquote>
<p>The address of a 128-bit packed memory operand must be aligned on a 16-byte boundary, except in the following<br>
cases:<br>
• The MOVUPS instruction supports unaligned accesses.<br>
• Scalar instructions that use a 4-byte memory operand that is not subject to alignment requirements.</p>
</blockquote>
<p>But the same restriction does not apply for VEX (read AVX) and EVEX (AVX-512) instructions:</p>
<blockquote>
<p>Memory alignment requirements on EVEX-encoded SIMD instructions are similar to VEX-encoded SIMD instructions. Memory alignment applies to EVEX-encoded SIMD instructions in three categories:<br>
• Explicitly-aligned SIMD load and store instructions accessing 64 bytes of memory with EVEX prefix encoded<br>
vector length of 512 bits (e.g., VMOVAPD, VMOVAPS, VMOVDQA, etc.). These instructions always require the<br>
memory address to be aligned on a 64-byte boundary.15-14 Vol. 1<br>
PROGRAMMING WITH INTEL® AVX-512<br>
• Explicitly-unaligned SIMD load and store instructions accessing 64 bytes or less of data from memory (e.g.,<br>
VMOVUPD, VMOVUPS, VMOVDQU, VMOVQ, VMOVD, etc.). These instructions do not require the memory<br>
address to be aligned on a natural vector-length byte boundary.<br>
• Most arithmetic and data processing instructions encoded using EVEX support memory access semantics.<br>
When these instructions access from memory, there are no alignment restrictions.</p>
</blockquote>
<p>There are additional benefits to using VEX and EVEX encodings (e.g., using 3 registers) that @cfallin pointed out so I think this issue should still be considered. In fact, this is something I would be interested in helping out with (cc: @alexcrichton, who may have something already in progress).</p>
</blockquote>



<a name="328132754"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%234767%20cranelift%3A%20Add%20VEX%20and%20EVEX%20memory.../near/328132754" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.234767.20cranelift.3A.20Add.20VEX.20and.20EVEX.20memory.2E.2E.2E.html#328132754">(Feb 16 2023 at 00:13)</a>:</h4>
<p>alexcrichton <a href="https://github.com/bytecodealliance/wasmtime/issues/4767#issuecomment-1432270031">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/4767">issue #4767</a>:</p>
<blockquote>
<p>I ended up giving this a stab in <a href="https://github.com/bytecodealliance/wasmtime/pull/5795">https://github.com/bytecodealliance/wasmtime/pull/5795</a>, but it could very well be wrong! (I also didn't handle EVEX yet)</p>
</blockquote>



<a name="368595164"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%234767%20cranelift%3A%20Add%20VEX%20and%20EVEX%20memory.../near/368595164" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.234767.20cranelift.3A.20Add.20VEX.20and.20EVEX.20memory.2E.2E.2E.html#368595164">(Jun 22 2023 at 15:03)</a>:</h4>
<p>alexcrichton <a href="https://github.com/bytecodealliance/wasmtime/issues/4767#issuecomment-1602803193">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/4767">issue #4767</a>:</p>
<blockquote>
<p>The final bit of EVEX was done in <a href="https://github.com/bytecodealliance/wasmtime/pull/6416">https://github.com/bytecodealliance/wasmtime/pull/6416</a>, so I think this is done now.</p>
</blockquote>



<a name="368595174"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%234767%20cranelift%3A%20Add%20VEX%20and%20EVEX%20memory.../near/368595174" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.234767.20cranelift.3A.20Add.20VEX.20and.20EVEX.20memory.2E.2E.2E.html#368595174">(Jun 22 2023 at 15:04)</a>:</h4>
<p>alexcrichton closed <a href="https://github.com/bytecodealliance/wasmtime/issues/4767">issue #4767</a>:</p>
<blockquote>
<p><span aria-label="wave" class="emoji emoji-1f44b" role="img" title="wave">:wave:</span> Hey,</p>
<h4>Feature</h4>
<p>We should add the memory encodings for VEX and EVEX instructions.</p>
<h4>Benefit</h4>
<p>Better codegen.</p>
<h4>Implementation</h4>
<ul>
<li>Add the encodings in the VEX and EVEX encoders</li>
<li>Fix lower.isle as needed to produce the new instructions</li>
</ul>
<h4>Alternatives</h4>
<p>We could keep doing what we do now and have worse codegen.</p>
<p>cc: @abrown </p>
</blockquote>



<hr><p>Last updated: Jan 20 2025 at 06:04 UTC</p>
</html>