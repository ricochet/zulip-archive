<html>
<head><meta charset="utf-8"><title>wasmtime / Issue #1616 Legalize ireduce.iN.i2N to isplit · git-wasmtime · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/index.html">git-wasmtime</a></h2>
<h3>Topic: <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20Issue.20.231616.20Legalize.20ireduce.2EiN.2Ei2N.20to.20isplit.html">wasmtime / Issue #1616 Legalize ireduce.iN.i2N to isplit</a></h3>

<hr>

<base href="https://bytecodealliance.zulipchat.com">

<head><link href="https://bytecodealliance.github.io/zulip-archive/style.css" rel="stylesheet"></head>

<a name="195548094"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20Issue%20%231616%20Legalize%20ireduce.iN.i2N%20to%20isplit/near/195548094" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20Issue.20.231616.20Legalize.20ireduce.2EiN.2Ei2N.20to.20isplit.html#195548094">(Apr 28 2020 at 11:10)</a>:</h4>
<p>github-actions[bot] <a href="https://github.com/bytecodealliance/wasmtime/pull/1616#issuecomment-620539796" title="https://github.com/bytecodealliance/wasmtime/pull/1616#issuecomment-620539796">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/1616" title="https://github.com/bytecodealliance/wasmtime/pull/1616">Issue #1616</a>:</p>
<blockquote>
<h4>Subscribe to Label Action</h4>
<p>cc @bnjbvr</p>
<p>&lt;details&gt;<br>
This issue or pull request has been labeled: "cranelift", "cranelift:meta"</p>
<p>Thus the following users have been cc'd because of the following labels:</p>
<ul>
<li>bnjbvr: cranelift</li>
</ul>
<p>To subscribe or unsubscribe from this label, edit the &lt;code&gt;.github/subscribe-to-label.json&lt;/code&gt; configuration file.</p>
<p><a href="https://github.com/bytecodealliance/subscribe-to-label-action" title="https://github.com/bytecodealliance/subscribe-to-label-action">Learn more.</a><br>
&lt;/details&gt;</p>
</blockquote>



<a name="196031191"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20Issue%20%231616%20Legalize%20ireduce.iN.i2N%20to%20isplit/near/196031191" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20Issue.20.231616.20Legalize.20ireduce.2EiN.2Ei2N.20to.20isplit.html#196031191">(May 02 2020 at 03:51)</a>:</h4>
<p>whitequark <a href="https://github.com/bytecodealliance/wasmtime/pull/1616#issuecomment-622663821" title="https://github.com/bytecodealliance/wasmtime/pull/1616#issuecomment-622663821">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/1616" title="https://github.com/bytecodealliance/wasmtime/pull/1616">Issue #1616</a>:</p>
<blockquote>
<p>Is there anything I need to do to get this PR merged? It doesn't depend on anything else.</p>
</blockquote>



<a name="196369323"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20Issue%20%231616%20Legalize%20ireduce.iN.i2N%20to%20isplit/near/196369323" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20Issue.20.231616.20Legalize.20ireduce.2EiN.2Ei2N.20to.20isplit.html#196369323">(May 05 2020 at 21:16)</a>:</h4>
<p>whitequark <a href="https://github.com/bytecodealliance/wasmtime/pull/1616#issuecomment-624311062" title="https://github.com/bytecodealliance/wasmtime/pull/1616#issuecomment-624311062">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/1616" title="https://github.com/bytecodealliance/wasmtime/pull/1616">Issue #1616</a>:</p>
<blockquote>
<blockquote>
<p>or I should have reason to be suspicious of this legalization (which otherwise seems entirely fine)</p>
</blockquote>
<p>When I wrote that, it was because to me it looked like a legalization splitting <code>iconcat</code>s should be in the <code>narrow</code> group, but I tried putting it there and determined that it only works in the <code>expand</code> group. If it looks good to you, it's probably just me being very new to Cranelift.</p>
</blockquote>



<a name="196369497"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20Issue%20%231616%20Legalize%20ireduce.iN.i2N%20to%20isplit/near/196369497" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20Issue.20.231616.20Legalize.20ireduce.2EiN.2Ei2N.20to.20isplit.html#196369497">(May 05 2020 at 21:18)</a>:</h4>
<p>whitequark <a href="https://github.com/bytecodealliance/wasmtime/pull/1616#issuecomment-624311769" title="https://github.com/bytecodealliance/wasmtime/pull/1616#issuecomment-624311769">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/1616" title="https://github.com/bytecodealliance/wasmtime/pull/1616">Issue #1616</a>:</p>
<blockquote>
<p>Oh, and I also found it odd that it didn't work without the <code>copy</code>, like in #1152, but after that I reviewed the Cranelift legalizer and figured that it's just written that way for some reason.</p>
</blockquote>



<a name="196389063"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20Issue%20%231616%20Legalize%20ireduce.iN.i2N%20to%20isplit/near/196389063" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20Issue.20.231616.20Legalize.20ireduce.2EiN.2Ei2N.20to.20isplit.html#196389063">(May 06 2020 at 01:32)</a>:</h4>
<p>iximeow <a href="https://github.com/bytecodealliance/wasmtime/pull/1616#issuecomment-624398246" title="https://github.com/bytecodealliance/wasmtime/pull/1616#issuecomment-624398246">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/1616" title="https://github.com/bytecodealliance/wasmtime/pull/1616">Issue #1616</a>:</p>
<blockquote>
<blockquote>
<p>should be in the <code>narrow</code> group,</p>
</blockquote>
<p>I'd only thought about the <code>narrow</code> group for narrowing SIMD operations, though I see it's used for quite a bit more. And, that the legalization in fact does not seem to apply when in that group.</p>
<p>I found that in <code>narrow</code> or <code>widen</code> that only one of the legalizations actually made it to the generated legalizer (the i128 reduction) but from the failing test that doesn't seem to apply either. I _think_ what's happening is the <code>ireduce</code> legalization has bounded types, so by <a href="https://github.com/whitequark/wasmtime/blob/15e43610e191b30b29424f6d3cd7b320050e41a5/cranelift/codegen/meta/src/isa/x86/mod.rs#L40" title="https://github.com/whitequark/wasmtime/blob/15e43610e191b30b29424f6d3cd7b320050e41a5/cranelift/codegen/meta/src/isa/x86/mod.rs#L40"><code>legalize_monomorphic</code></a> in the x86_32 cpu definition legalization is run through <code>expand_flags</code>, which eventually is chained to the base <code>expand</code> legalizer. I don't know why codegen would vary across groups though.</p>
<p>I see other legalizations through <code>narrow</code> appear to have an unbounded parameter, or use a type otherwise undeclared (like <code>I128</code>) , so I think this about where to look. And I believe <code>ireduce</code> falls over with an unbounded type because of the constraint that the result must be half the size of the input.</p>
<p>This all definitely is not straightforward, and I suspect the missing cases when these legalizations are in <code>narrow</code> or <code>widen</code> might be a bug in the code generator for the legalizer, but finding a somewhat compelling reason why this ought to be in <code>expand</code> is all I was really after. Since this is all slated for <span aria-label="boom" class="emoji emoji-1f4a5" role="img" title="boom">:boom:</span> I'll stop here :)</p>
</blockquote>



<hr><p>Last updated: Jan 20 2025 at 06:04 UTC</p>
</html>