<html>
<head><meta charset="utf-8"><title>wasmtime / issue #7786 How to access the instance&#x27;s memor... · git-wasmtime · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/index.html">git-wasmtime</a></h2>
<h3>Topic: <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.237786.20How.20to.20access.20the.20instance.27s.20memor.2E.2E.2E.html">wasmtime / issue #7786 How to access the instance&#x27;s memor...</a></h3>

<hr>

<base href="https://bytecodealliance.zulipchat.com">

<head><link href="https://bytecodealliance.github.io/zulip-archive/style.css" rel="stylesheet"></head>

<a name="416463410"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%237786%20How%20to%20access%20the%20instance%27s%20memor.../near/416463410" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.237786.20How.20to.20access.20the.20instance.27s.20memor.2E.2E.2E.html#416463410">(Jan 17 2024 at 23:34)</a>:</h4>
<p>eigenein opened <a href="https://github.com/bytecodealliance/wasmtime/issues/7786">issue #7786</a>:</p>
<blockquote>
<p><span aria-label="wave" class="emoji emoji-1f44b" role="img" title="wave">:wave:</span> Hi team,</p>
<p>I'm instantiating a long-lived <code>Engine</code> and <code>Linker</code>, and then I'm adding some host functions to the linker (Rust API). Some of these functions should receive a string as a parameter, so an offset and a length in a guest's memory, for example:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">linker</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">wasmtime</span>::<span class="n">Linker</span>::<span class="n">new</span><span class="p">(</span><span class="o">&amp;</span><span class="n">engine</span><span class="p">);</span>
<span class="n">linker</span><span class="p">.</span><span class="n">func_wrap</span><span class="p">(</span><span class="s">"logging"</span><span class="p">,</span><span class="w"> </span><span class="s">"info"</span><span class="p">,</span>
<span class="w">    </span><span class="o">|</span><span class="k">mut</span><span class="w"> </span><span class="n">caller</span>: <span class="nc">Caller</span><span class="o">&lt;'</span><span class="nb">_</span><span class="p">,</span><span class="w"> </span><span class="nb">String</span><span class="o">&gt;</span><span class="p">,</span><span class="w"> </span><span class="n">offset</span>: <span class="kt">u32</span><span class="p">,</span><span class="w"> </span><span class="n">size</span>: <span class="kt">u32</span><span class="o">|</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="c1">// How do I access instance's memory here and read from there?</span>
<span class="w">    </span><span class="p">},</span>
<span class="p">)</span><span class="o">?</span><span class="p">;</span>
</code></pre></div>
<p>I could use a closure, but I'm going to support a plugin system, and a shared host function may be called from any of them. Also, <code>Store</code> is short-lived, and I wouldn't like to re-instantiate a <code>Linker</code> together with the closures for every host→guest call</p>
<p>Should I put a reference to instance's <code>Memory</code> to the instance's <code>Store</code>? That smells a little, since <code>Caller</code> already contains <code>Store</code> and all the memories are already owned by <code>Store</code>. Am I missing something?</p>
</blockquote>



<a name="416463472"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%237786%20How%20to%20access%20the%20instance%27s%20memor.../near/416463472" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.237786.20How.20to.20access.20the.20instance.27s.20memor.2E.2E.2E.html#416463472">(Jan 17 2024 at 23:34)</a>:</h4>
<p>eigenein edited <a href="https://github.com/bytecodealliance/wasmtime/issues/7786">issue #7786</a>:</p>
<blockquote>
<p><span aria-label="wave" class="emoji emoji-1f44b" role="img" title="wave">:wave:</span> Hi team,</p>
<p>I'm instantiating a long-lived <code>Engine</code> and <code>Linker</code>, and then I'm adding some host functions to the linker (Rust API). Some of these functions should receive a string as a parameter, so an offset and a length in a guest's memory, for example:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">linker</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">wasmtime</span>::<span class="n">Linker</span>::<span class="n">new</span><span class="p">(</span><span class="o">&amp;</span><span class="n">engine</span><span class="p">);</span>
<span class="n">linker</span><span class="p">.</span><span class="n">func_wrap</span><span class="p">(</span><span class="s">"logging"</span><span class="p">,</span><span class="w"> </span><span class="s">"info"</span><span class="p">,</span>
<span class="w">    </span><span class="o">|</span><span class="k">mut</span><span class="w"> </span><span class="n">caller</span>: <span class="nc">Caller</span><span class="o">&lt;'</span><span class="nb">_</span><span class="p">,</span><span class="w"> </span><span class="p">()</span><span class="o">&gt;</span><span class="p">,</span><span class="w"> </span><span class="n">offset</span>: <span class="kt">u32</span><span class="p">,</span><span class="w"> </span><span class="n">size</span>: <span class="kt">u32</span><span class="o">|</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="c1">// How do I access instance's memory here and read from there?</span>
<span class="w">    </span><span class="p">},</span>
<span class="p">)</span><span class="o">?</span><span class="p">;</span>
</code></pre></div>
<p>I could use a closure, but I'm going to support a plugin system, and a shared host function may be called from any of them. Also, <code>Store</code> is short-lived, and I wouldn't like to re-instantiate a <code>Linker</code> together with the closures for every host→guest call</p>
<p>Should I put a reference to instance's <code>Memory</code> to the instance's <code>Store</code>? That smells a little, since <code>Caller</code> already contains <code>Store</code> and all the memories are already owned by <code>Store</code>. Am I missing something?</p>
</blockquote>



<a name="416463499"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%237786%20How%20to%20access%20the%20instance%27s%20memor.../near/416463499" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.237786.20How.20to.20access.20the.20instance.27s.20memor.2E.2E.2E.html#416463499">(Jan 17 2024 at 23:34)</a>:</h4>
<p>eigenein edited <a href="https://github.com/bytecodealliance/wasmtime/issues/7786">issue #7786</a>:</p>
<blockquote>
<p><span aria-label="wave" class="emoji emoji-1f44b" role="img" title="wave">:wave:</span> Hi team,</p>
<p>I'm instantiating a long-lived <code>Engine</code> and <code>Linker</code>, and then I'm adding some host functions to the linker (Rust API). Some of these functions should receive a string as a parameter, so an offset and a length in a guest's memory, for example:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">linker</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">wasmtime</span>::<span class="n">Linker</span>::<span class="n">new</span><span class="p">(</span><span class="o">&amp;</span><span class="n">engine</span><span class="p">);</span>
<span class="n">linker</span><span class="p">.</span><span class="n">func_wrap</span><span class="p">(</span><span class="s">"logging"</span><span class="p">,</span><span class="w"> </span><span class="s">"info"</span><span class="p">,</span>
<span class="w">    </span><span class="o">|</span><span class="k">mut</span><span class="w"> </span><span class="n">caller</span>: <span class="nc">Caller</span><span class="o">&lt;'</span><span class="nb">_</span><span class="p">,</span><span class="w"> </span><span class="p">()</span><span class="o">&gt;</span><span class="p">,</span><span class="w"> </span><span class="n">offset</span>: <span class="kt">u32</span><span class="p">,</span><span class="w"> </span><span class="n">size</span>: <span class="kt">u32</span><span class="o">|</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="c1">// How do I access instance's memory here and read from there?</span>
<span class="w">    </span><span class="p">},</span>
<span class="p">)</span><span class="o">?</span><span class="p">;</span>
</code></pre></div>
<p>I could use a closure, but I'm going to support a plugin system, and a shared host function may be called from any plugin. Also, <code>Store</code> is short-lived, and I wouldn't like to re-instantiate a <code>Linker</code> together with the closures for every host→guest call</p>
<p>Should I put a reference to instance's <code>Memory</code> to the instance's <code>Store</code>? That smells a little, since <code>Caller</code> already contains <code>Store</code> and all the memories are already owned by <code>Store</code>. Am I missing something?</p>
</blockquote>



<a name="416463523"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%237786%20How%20to%20access%20the%20instance%27s%20memor.../near/416463523" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.237786.20How.20to.20access.20the.20instance.27s.20memor.2E.2E.2E.html#416463523">(Jan 17 2024 at 23:35)</a>:</h4>
<p>eigenein edited <a href="https://github.com/bytecodealliance/wasmtime/issues/7786">issue #7786</a>:</p>
<blockquote>
<p><span aria-label="wave" class="emoji emoji-1f44b" role="img" title="wave">:wave:</span> Hi team,</p>
<p>I'm instantiating a long-lived <code>Engine</code> and <code>Linker</code>, and then I'm adding some host functions to the linker (Rust API). Some of these functions should receive a string as a parameter, so an offset and a length in a guest's memory, for example:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">linker</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">wasmtime</span>::<span class="n">Linker</span>::<span class="n">new</span><span class="p">(</span><span class="o">&amp;</span><span class="n">engine</span><span class="p">);</span>
<span class="n">linker</span><span class="p">.</span><span class="n">func_wrap</span><span class="p">(</span><span class="s">"logging"</span><span class="p">,</span><span class="w"> </span><span class="s">"info"</span><span class="p">,</span>
<span class="w">    </span><span class="o">|</span><span class="k">mut</span><span class="w"> </span><span class="n">caller</span>: <span class="nc">Caller</span><span class="o">&lt;'</span><span class="nb">_</span><span class="p">,</span><span class="w"> </span><span class="p">()</span><span class="o">&gt;</span><span class="p">,</span><span class="w"> </span><span class="n">offset</span>: <span class="kt">u32</span><span class="p">,</span><span class="w"> </span><span class="n">size</span>: <span class="kt">u32</span><span class="o">|</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="c1">// How do I access instance's memory here and read from there?</span>
<span class="w">    </span><span class="p">},</span>
<span class="p">)</span><span class="o">?</span><span class="p">;</span>
</code></pre></div>
<p>I could use a closure, but I'm going to support a plugin system, and a shared host function may be called from any plugin. Also, <code>Store</code> is short-lived, and I wouldn't like to re-instantiate a <code>Linker</code> together with the closures for every host-to-guest call</p>
<p>Should I put a reference to instance's <code>Memory</code> to the instance's <code>Store</code>? That smells a little, since <code>Caller</code> already contains <code>Store</code> and all the memories are already owned by <code>Store</code>. Am I missing something?</p>
</blockquote>



<a name="416464658"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%237786%20How%20to%20access%20the%20instance%27s%20memor.../near/416464658" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.237786.20How.20to.20access.20the.20instance.27s.20memor.2E.2E.2E.html#416464658">(Jan 17 2024 at 23:46)</a>:</h4>
<p>eigenein edited <a href="https://github.com/bytecodealliance/wasmtime/issues/7786">issue #7786</a>:</p>
<blockquote>
<p><span aria-label="wave" class="emoji emoji-1f44b" role="img" title="wave">:wave:</span> Hi team,</p>
<p>I'm instantiating a long-lived <code>Engine</code> and <code>Linker</code>, and then I'm adding some host functions to the linker (Rust API). Some of these functions should receive a string as a parameter, so an offset and a length in a guest's memory, for example:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">linker</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">wasmtime</span>::<span class="n">Linker</span>::<span class="n">new</span><span class="p">(</span><span class="o">&amp;</span><span class="n">engine</span><span class="p">);</span>
<span class="n">linker</span><span class="p">.</span><span class="n">func_wrap</span><span class="p">(</span><span class="s">"logging"</span><span class="p">,</span><span class="w"> </span><span class="s">"info"</span><span class="p">,</span>
<span class="w">    </span><span class="o">|</span><span class="k">mut</span><span class="w"> </span><span class="n">caller</span>: <span class="nc">Caller</span><span class="o">&lt;'</span><span class="nb">_</span><span class="p">,</span><span class="w"> </span><span class="p">()</span><span class="o">&gt;</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="n">offset</span><span class="p">,</span><span class="w"> </span><span class="n">size</span><span class="p">)</span>: <span class="p">(</span><span class="kt">u32</span><span class="p">,</span><span class="w"> </span><span class="kt">u32</span><span class="p">)</span><span class="o">|</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="c1">// How do I access instance's memory here and read from there?</span>
<span class="w">    </span><span class="p">},</span>
<span class="p">)</span><span class="o">?</span><span class="p">;</span>
</code></pre></div>
<p>I could use a closure, but I'm going to support a plugin system, and a shared host function may be called from any plugin. Also, <code>Store</code> is short-lived, and I wouldn't like to re-instantiate a <code>Linker</code> together with the closures for every host-to-guest call</p>
<p>Should I put a reference to instance's <code>Memory</code> to the instance's <code>Store</code>? That smells a little, since <code>Caller</code> already contains <code>Store</code> and all the memories are already owned by <code>Store</code>. Am I missing something?</p>
</blockquote>



<a name="416464904"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%237786%20How%20to%20access%20the%20instance%27s%20memor.../near/416464904" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.237786.20How.20to.20access.20the.20instance.27s.20memor.2E.2E.2E.html#416464904">(Jan 17 2024 at 23:48)</a>:</h4>
<p>eigenein edited <a href="https://github.com/bytecodealliance/wasmtime/issues/7786">issue #7786</a>:</p>
<blockquote>
<p><span aria-label="wave" class="emoji emoji-1f44b" role="img" title="wave">:wave:</span> Hi team,</p>
<p>I'm instantiating a long-lived <code>Engine</code> and <code>Linker</code>, and then I'm adding some host functions to the linker (Rust API). Some of these functions should receive a string as a parameter, so an offset and a length in a guest's memory, for example:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">linker</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">wasmtime</span>::<span class="n">Linker</span>::<span class="n">new</span><span class="p">(</span><span class="o">&amp;</span><span class="n">engine</span><span class="p">);</span>
<span class="n">linker</span><span class="p">.</span><span class="n">func_wrap</span><span class="p">(</span><span class="s">"logging"</span><span class="p">,</span><span class="w"> </span><span class="s">"info"</span><span class="p">,</span>
<span class="w">    </span><span class="o">|</span><span class="k">mut</span><span class="w"> </span><span class="n">caller</span>: <span class="nc">Caller</span><span class="o">&lt;'</span><span class="nb">_</span><span class="p">,</span><span class="w"> </span><span class="p">()</span><span class="o">&gt;</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="n">offset</span><span class="p">,</span><span class="w"> </span><span class="n">size</span><span class="p">)</span>: <span class="p">(</span><span class="kt">u32</span><span class="p">,</span><span class="w"> </span><span class="kt">u32</span><span class="p">)</span><span class="o">|</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="c1">// How do I access instance's memory here and read from there?</span>
<span class="w">    </span><span class="p">},</span>
<span class="p">)</span><span class="o">?</span><span class="p">;</span>
</code></pre></div>
<p>I could use a closure, but I'm going to support a plugin system, and a shared host function may be called from any plugin. Also, <code>Store</code> is short-lived, and I wouldn't like to re-instantiate a <code>Linker</code> together with the closures for every host-to-guest call</p>
<p>Should I put a reference to <code>Instance</code> or to the instance's <code>Memory</code> to the instance's <code>Store</code>? That smells a little, since <code>Caller</code> already contains <code>Store</code> and all the memories are already owned by <code>Store</code>. Am I missing something?</p>
</blockquote>



<a name="416464977"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%237786%20How%20to%20access%20the%20instance%27s%20memor.../near/416464977" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.237786.20How.20to.20access.20the.20instance.27s.20memor.2E.2E.2E.html#416464977">(Jan 17 2024 at 23:49)</a>:</h4>
<p>eigenein edited <a href="https://github.com/bytecodealliance/wasmtime/issues/7786">issue #7786</a>:</p>
<blockquote>
<p><span aria-label="wave" class="emoji emoji-1f44b" role="img" title="wave">:wave:</span> Hi team,</p>
<p>I'm instantiating a long-lived <code>Engine</code> and <code>Linker</code>, and then I'm adding some host functions to the linker (Rust API). Some of these functions should receive a string as a parameter, so an offset and a length in a guest's memory, for example:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">linker</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">wasmtime</span>::<span class="n">Linker</span>::<span class="n">new</span><span class="p">(</span><span class="o">&amp;</span><span class="n">engine</span><span class="p">);</span>
<span class="n">linker</span><span class="p">.</span><span class="n">func_wrap</span><span class="p">(</span><span class="s">"logging"</span><span class="p">,</span><span class="w"> </span><span class="s">"info"</span><span class="p">,</span>
<span class="w">    </span><span class="o">|</span><span class="k">mut</span><span class="w"> </span><span class="n">caller</span>: <span class="nc">Caller</span><span class="o">&lt;'</span><span class="nb">_</span><span class="p">,</span><span class="w"> </span><span class="p">()</span><span class="o">&gt;</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="n">offset</span><span class="p">,</span><span class="w"> </span><span class="n">size</span><span class="p">)</span>: <span class="p">(</span><span class="kt">u32</span><span class="p">,</span><span class="w"> </span><span class="kt">u32</span><span class="p">)</span><span class="o">|</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="c1">// How do I access instance's memory here and read from there?</span>
<span class="w">    </span><span class="p">},</span>
<span class="p">)</span><span class="o">?</span><span class="p">;</span>
</code></pre></div>
<p>I could use a closure, but I'm going to support a plugin system, and a shared host function may be called from any plugin. Also, <code>Store</code> is short-lived, and I wouldn't like to re-instantiate a <code>Linker</code> together with the closures for every host-to-guest call</p>
<p>Should I put a reference to <code>Instance</code> or to the instance's <code>Memory</code> to the instance's <code>Store</code>? That smells a little, since <code>Caller</code> already contains <code>Store</code> and all the memories are already owned by <code>Store</code>, that is effeectively making a loop of references. Am I missing something?</p>
</blockquote>



<a name="416464991"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%237786%20How%20to%20access%20the%20instance%27s%20memor.../near/416464991" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.237786.20How.20to.20access.20the.20instance.27s.20memor.2E.2E.2E.html#416464991">(Jan 17 2024 at 23:49)</a>:</h4>
<p>eigenein edited <a href="https://github.com/bytecodealliance/wasmtime/issues/7786">issue #7786</a>:</p>
<blockquote>
<p><span aria-label="wave" class="emoji emoji-1f44b" role="img" title="wave">:wave:</span> Hi team,</p>
<p>I'm instantiating a long-lived <code>Engine</code> and <code>Linker</code>, and then I'm adding some host functions to the linker (Rust API). Some of these functions should receive a string as a parameter, so an offset and a length in a guest's memory, for example:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">linker</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">wasmtime</span>::<span class="n">Linker</span>::<span class="n">new</span><span class="p">(</span><span class="o">&amp;</span><span class="n">engine</span><span class="p">);</span>
<span class="n">linker</span><span class="p">.</span><span class="n">func_wrap</span><span class="p">(</span><span class="s">"logging"</span><span class="p">,</span><span class="w"> </span><span class="s">"info"</span><span class="p">,</span>
<span class="w">    </span><span class="o">|</span><span class="k">mut</span><span class="w"> </span><span class="n">caller</span>: <span class="nc">Caller</span><span class="o">&lt;'</span><span class="nb">_</span><span class="p">,</span><span class="w"> </span><span class="p">()</span><span class="o">&gt;</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="n">offset</span><span class="p">,</span><span class="w"> </span><span class="n">size</span><span class="p">)</span>: <span class="p">(</span><span class="kt">u32</span><span class="p">,</span><span class="w"> </span><span class="kt">u32</span><span class="p">)</span><span class="o">|</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="c1">// How do I access instance's memory here and read from there?</span>
<span class="w">    </span><span class="p">},</span>
<span class="p">)</span><span class="o">?</span><span class="p">;</span>
</code></pre></div>
<p>I could use a closure, but I'm going to support a plugin system, and a shared host function may be called from any plugin. Also, <code>Store</code> is short-lived, and I wouldn't like to re-instantiate a <code>Linker</code> together with the closures for every host-to-guest call</p>
<p>Should I put a reference to <code>Instance</code> or to the instance's <code>Memory</code> to the instance's <code>Store</code>? That smells a little, since <code>Caller</code> already contains <code>Store</code> and all the memories are already owned by <code>Store</code>, that is effectively making a loop of references. Am I missing something?</p>
</blockquote>



<a name="416465034"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%237786%20How%20to%20access%20the%20instance%27s%20memor.../near/416465034" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.237786.20How.20to.20access.20the.20instance.27s.20memor.2E.2E.2E.html#416465034">(Jan 17 2024 at 23:49)</a>:</h4>
<p>eigenein edited <a href="https://github.com/bytecodealliance/wasmtime/issues/7786">issue #7786</a>:</p>
<blockquote>
<p><span aria-label="wave" class="emoji emoji-1f44b" role="img" title="wave">:wave:</span> Hi team,</p>
<p>I'm instantiating a long-lived <code>Engine</code> and <code>Linker</code>, and then I'm adding some host functions to the linker (Rust API). Some of these functions should receive a string as a parameter, so an offset and a length in a guest's memory, for example:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">linker</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">wasmtime</span>::<span class="n">Linker</span>::<span class="n">new</span><span class="p">(</span><span class="o">&amp;</span><span class="n">engine</span><span class="p">);</span>
<span class="n">linker</span><span class="p">.</span><span class="n">func_wrap</span><span class="p">(</span><span class="s">"logging"</span><span class="p">,</span><span class="w"> </span><span class="s">"info"</span><span class="p">,</span>
<span class="w">    </span><span class="o">|</span><span class="k">mut</span><span class="w"> </span><span class="n">caller</span>: <span class="nc">Caller</span><span class="o">&lt;'</span><span class="nb">_</span><span class="p">,</span><span class="w"> </span><span class="p">()</span><span class="o">&gt;</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="n">offset</span><span class="p">,</span><span class="w"> </span><span class="n">size</span><span class="p">)</span>: <span class="p">(</span><span class="kt">u32</span><span class="p">,</span><span class="w"> </span><span class="kt">u32</span><span class="p">)</span><span class="o">|</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="c1">// How do I access instance's memory here and read from there?</span>
<span class="w">    </span><span class="p">},</span>
<span class="p">)</span><span class="o">?</span><span class="p">;</span>
</code></pre></div>
<p>I could use a closure, but I'm going to support a plugin system, and a shared host function may be called from any plugin. Also, <code>Store</code> is short-lived, and I wouldn't like to re-instantiate a <code>Linker</code> together with the closures for every host-to-guest call</p>
<p>Should I put a reference to <code>Instance</code> or to the instance's <code>Memory</code> to the instance's <code>Store</code>? That smells a little, since <code>Caller</code> already contains <code>Store</code> and all the memories are already owned by <code>Store</code> – so that would effectively be making a loop of references. Am I missing something?</p>
</blockquote>



<a name="416465976"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%237786%20How%20to%20access%20the%20instance%27s%20memor.../near/416465976" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.237786.20How.20to.20access.20the.20instance.27s.20memor.2E.2E.2E.html#416465976">(Jan 17 2024 at 23:57)</a>:</h4>
<p>eigenein edited <a href="https://github.com/bytecodealliance/wasmtime/issues/7786">issue #7786</a>:</p>
<blockquote>
<p><span aria-label="wave" class="emoji emoji-1f44b" role="img" title="wave">:wave:</span> Hi team,</p>
<p>I'm instantiating a long-lived <code>Engine</code> and <code>Linker</code>, and then I'm adding some host functions to the linker (Rust API). Some of these functions should receive a string as a parameter, so an offset and a length in a guest's memory, for example:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">linker</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">wasmtime</span>::<span class="n">Linker</span>::<span class="n">new</span><span class="p">(</span><span class="o">&amp;</span><span class="n">engine</span><span class="p">);</span>
<span class="n">linker</span><span class="p">.</span><span class="n">func_wrap</span><span class="p">(</span><span class="s">"logging"</span><span class="p">,</span><span class="w"> </span><span class="s">"info"</span><span class="p">,</span>
<span class="w">    </span><span class="o">|</span><span class="k">mut</span><span class="w"> </span><span class="n">caller</span>: <span class="nc">Caller</span><span class="o">&lt;'</span><span class="nb">_</span><span class="p">,</span><span class="w"> </span><span class="p">()</span><span class="o">&gt;</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="n">offset</span><span class="p">,</span><span class="w"> </span><span class="n">size</span><span class="p">)</span>: <span class="p">(</span><span class="kt">u32</span><span class="p">,</span><span class="w"> </span><span class="kt">u32</span><span class="p">)</span><span class="o">|</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="c1">// How do I access instance's memory here and read from it?</span>
<span class="w">    </span><span class="p">},</span>
<span class="p">)</span><span class="o">?</span><span class="p">;</span>
</code></pre></div>
<p>I could use a closure, but I'm going to support a plugin system, and a shared host function may be called from any plugin. Also, <code>Store</code> is short-lived, and I wouldn't like to re-instantiate a <code>Linker</code> together with the closures for every host-to-guest call</p>
<p>Should I put a reference to <code>Instance</code> or to the instance's <code>Memory</code> to the instance's <code>Store</code>? That smells a little, since <code>Caller</code> already contains <code>Store</code> and all the memories are already owned by <code>Store</code> – so that would effectively be making a loop of references. Am I missing something?</p>
</blockquote>



<a name="416466233"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%237786%20How%20to%20access%20the%20instance%27s%20memor.../near/416466233" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.237786.20How.20to.20access.20the.20instance.27s.20memor.2E.2E.2E.html#416466233">(Jan 17 2024 at 23:59)</a>:</h4>
<p>eigenein edited <a href="https://github.com/bytecodealliance/wasmtime/issues/7786">issue #7786</a>:</p>
<blockquote>
<p><span aria-label="wave" class="emoji emoji-1f44b" role="img" title="wave">:wave:</span> Hi team,</p>
<p>I'm instantiating a long-lived <code>Engine</code> and <code>Linker</code>, and then I'm adding some host functions to the linker (Rust API). Some of these functions should receive a string as a parameter, so an offset and a length in a guest's memory, for example:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">linker</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">wasmtime</span>::<span class="n">Linker</span>::<span class="n">new</span><span class="p">(</span><span class="o">&amp;</span><span class="n">engine</span><span class="p">);</span>
<span class="n">linker</span><span class="p">.</span><span class="n">func_wrap</span><span class="p">(</span><span class="s">"logging"</span><span class="p">,</span><span class="w"> </span><span class="s">"info"</span><span class="p">,</span>
<span class="w">    </span><span class="o">|</span><span class="k">mut</span><span class="w"> </span><span class="n">caller</span>: <span class="nc">Caller</span><span class="o">&lt;'</span><span class="nb">_</span><span class="p">,</span><span class="w"> </span><span class="p">()</span><span class="o">&gt;</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="n">offset</span><span class="p">,</span><span class="w"> </span><span class="n">size</span><span class="p">)</span>: <span class="p">(</span><span class="kt">u32</span><span class="p">,</span><span class="w"> </span><span class="kt">u32</span><span class="p">)</span><span class="o">|</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="c1">// How do I access instance's memory here and read from it?</span>
<span class="w">    </span><span class="p">},</span>
<span class="p">)</span><span class="o">?</span><span class="p">;</span>
</code></pre></div>
<p>I could use a closure as suggested in <a href="https://github.com/bytecodealliance/wasmtime/issues/2491#issuecomment-742352722">https://github.com/bytecodealliance/wasmtime/issues/2491#issuecomment-742352722</a>, but I'm going to support a plugin system, and a shared host function may be called from any plugin. Also, <code>Store</code> is short-lived, and I wouldn't like to re-instantiate a <code>Linker</code> together with the closures for every host-to-guest call</p>
<p>Should I put a reference to <code>Instance</code> or to the instance's <code>Memory</code> to the instance's <code>Store</code>? That smells a little, since <code>Caller</code> already contains <code>Store</code> and all the memories are already owned by <code>Store</code> – so that would effectively be making a loop of references. Am I missing something?</p>
</blockquote>



<a name="416466331"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%237786%20How%20to%20access%20the%20instance%27s%20memor.../near/416466331" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.237786.20How.20to.20access.20the.20instance.27s.20memor.2E.2E.2E.html#416466331">(Jan 18 2024 at 00:00)</a>:</h4>
<p>eigenein edited <a href="https://github.com/bytecodealliance/wasmtime/issues/7786">issue #7786</a>:</p>
<blockquote>
<p><span aria-label="wave" class="emoji emoji-1f44b" role="img" title="wave">:wave:</span> Hi team,</p>
<p>I'm instantiating a long-lived <code>Engine</code> and <code>Linker</code>, and then I'm adding some host functions to the linker (Rust API). Some of these functions should receive a string as a parameter, so an offset and a length in a guest's memory, for example:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">linker</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">wasmtime</span>::<span class="n">Linker</span>::<span class="n">new</span><span class="p">(</span><span class="o">&amp;</span><span class="n">engine</span><span class="p">);</span>
<span class="n">linker</span><span class="p">.</span><span class="n">func_wrap</span><span class="p">(</span><span class="s">"logging"</span><span class="p">,</span><span class="w"> </span><span class="s">"info"</span><span class="p">,</span>
<span class="w">    </span><span class="o">|</span><span class="k">mut</span><span class="w"> </span><span class="n">caller</span>: <span class="nc">Caller</span><span class="o">&lt;'</span><span class="nb">_</span><span class="p">,</span><span class="w"> </span><span class="p">()</span><span class="o">&gt;</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="n">offset</span><span class="p">,</span><span class="w"> </span><span class="n">size</span><span class="p">)</span>: <span class="p">(</span><span class="kt">u32</span><span class="p">,</span><span class="w"> </span><span class="kt">u32</span><span class="p">)</span><span class="o">|</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="c1">// How do I access instance's memory here and read from it?</span>
<span class="w">    </span><span class="p">},</span>
<span class="p">)</span><span class="o">?</span><span class="p">;</span>
</code></pre></div>
<p>I could use a closure as suggested in <a href="https://github.com/bytecodealliance/wasmtime/issues/2491#issuecomment-742352722">https://github.com/bytecodealliance/wasmtime/issues/2491#issuecomment-742352722</a>, but I'm going to support a plugin system, and a shared host function may be called from any plugin. Also, <code>Store</code> is short-lived, and I wouldn't like to re-instantiate a <code>Linker</code> together with the closures for every host-to-guest call</p>
<p>Should I put a reference to <code>Instance</code> or to the instance's <code>Memory</code> into the instance's <code>Store</code>? That smells a little, since <code>Caller</code> already contains <code>Store</code> and all the memories are already owned by <code>Store</code> – so that would effectively be making a loop of references. Am I missing something?</p>
</blockquote>



<a name="416470995"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%237786%20How%20to%20access%20the%20instance%27s%20memor.../near/416470995" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.237786.20How.20to.20access.20the.20instance.27s.20memor.2E.2E.2E.html#416470995">(Jan 18 2024 at 00:36)</a>:</h4>
<p>alexcrichton <a href="https://github.com/bytecodealliance/wasmtime/issues/7786#issuecomment-1897557763">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/7786">issue #7786</a>:</p>
<blockquote>
<p>There's an example for this <a href="https://docs.rs/wasmtime/latest/wasmtime/struct.Func.html#method.wrap">on the documentation of <code>Func::wrap</code></a> where the gist of it is:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">mem</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">match</span><span class="w"> </span><span class="n">caller</span><span class="p">.</span><span class="n">get_export</span><span class="p">(</span><span class="s">"memory"</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nb">Some</span><span class="p">(</span><span class="n">Extern</span>::<span class="n">Memory</span><span class="p">(</span><span class="n">mem</span><span class="p">))</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="n">mem</span><span class="p">,</span>
<span class="w">        </span><span class="n">_</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="n">anyhow</span>::<span class="n">bail</span><span class="o">!</span><span class="p">(</span><span class="s">"failed to find host memory"</span><span class="p">),</span>
<span class="w">    </span><span class="p">};</span>
</code></pre></div>
<p>One option is to store a <code>Memory</code> in the <code>T</code> of <code>Store&lt;T&gt;</code> (i.e. replace the <code>()</code> you're using currently), but the easiest option is probably to call <code>caller.get_export(...)</code></p>
</blockquote>



<a name="416472025"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%237786%20How%20to%20access%20the%20instance%27s%20memor.../near/416472025" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.237786.20How.20to.20access.20the.20instance.27s.20memor.2E.2E.2E.html#416472025">(Jan 18 2024 at 00:43)</a>:</h4>
<p>eigenein <a href="https://github.com/bytecodealliance/wasmtime/issues/7786#issuecomment-1897563849">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/7786">issue #7786</a>:</p>
<blockquote>
<p>@alexcrichton Thank you, just exactly what I needed and completely overlooked!</p>
</blockquote>



<a name="416472026"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%237786%20How%20to%20access%20the%20instance%27s%20memor.../near/416472026" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.237786.20How.20to.20access.20the.20instance.27s.20memor.2E.2E.2E.html#416472026">(Jan 18 2024 at 00:43)</a>:</h4>
<p>eigenein closed <a href="https://github.com/bytecodealliance/wasmtime/issues/7786">issue #7786</a>:</p>
<blockquote>
<p><span aria-label="wave" class="emoji emoji-1f44b" role="img" title="wave">:wave:</span> Hi team,</p>
<p>I'm instantiating a long-lived <code>Engine</code> and <code>Linker</code>, and then I'm adding some host functions to the linker (Rust API). Some of these functions should receive a string as a parameter, so an offset and a length in a guest's memory, for example:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">linker</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">wasmtime</span>::<span class="n">Linker</span>::<span class="n">new</span><span class="p">(</span><span class="o">&amp;</span><span class="n">engine</span><span class="p">);</span>
<span class="n">linker</span><span class="p">.</span><span class="n">func_wrap</span><span class="p">(</span><span class="s">"logging"</span><span class="p">,</span><span class="w"> </span><span class="s">"info"</span><span class="p">,</span>
<span class="w">    </span><span class="o">|</span><span class="k">mut</span><span class="w"> </span><span class="n">caller</span>: <span class="nc">Caller</span><span class="o">&lt;'</span><span class="nb">_</span><span class="p">,</span><span class="w"> </span><span class="p">()</span><span class="o">&gt;</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="n">offset</span><span class="p">,</span><span class="w"> </span><span class="n">size</span><span class="p">)</span>: <span class="p">(</span><span class="kt">u32</span><span class="p">,</span><span class="w"> </span><span class="kt">u32</span><span class="p">)</span><span class="o">|</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="c1">// How do I access instance's memory here and read from it?</span>
<span class="w">    </span><span class="p">},</span>
<span class="p">)</span><span class="o">?</span><span class="p">;</span>
</code></pre></div>
<p>I could use a closure as suggested in <a href="https://github.com/bytecodealliance/wasmtime/issues/2491#issuecomment-742352722">https://github.com/bytecodealliance/wasmtime/issues/2491#issuecomment-742352722</a>, but I'm going to support a plugin system, and a shared host function may be called from any plugin. Also, <code>Store</code> is short-lived, and I wouldn't like to re-instantiate a <code>Linker</code> together with the closures for every host-to-guest call</p>
<p>Should I put a reference to <code>Instance</code> or to the instance's <code>Memory</code> into the instance's <code>Store</code>? That smells a little, since <code>Caller</code> already contains <code>Store</code> and all the memories are already owned by <code>Store</code> – so that would effectively be making a loop of references. Am I missing something?</p>
</blockquote>



<hr><p>Last updated: Jan 20 2025 at 06:04 UTC</p>
</html>