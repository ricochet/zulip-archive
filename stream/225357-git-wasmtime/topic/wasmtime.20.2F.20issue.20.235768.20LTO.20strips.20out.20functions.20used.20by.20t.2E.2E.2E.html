<html>
<head><meta charset="utf-8"><title>wasmtime / issue #5768 LTO strips out functions used by t... · git-wasmtime · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/index.html">git-wasmtime</a></h2>
<h3>Topic: <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.235768.20LTO.20strips.20out.20functions.20used.20by.20t.2E.2E.2E.html">wasmtime / issue #5768 LTO strips out functions used by t...</a></h3>

<hr>

<base href="https://bytecodealliance.zulipchat.com">

<head><link href="https://bytecodealliance.github.io/zulip-archive/style.css" rel="stylesheet"></head>

<a name="327584553"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%235768%20LTO%20strips%20out%20functions%20used%20by%20t.../near/327584553" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.235768.20LTO.20strips.20out.20functions.20used.20by.20t.2E.2E.2E.html#327584553">(Feb 13 2023 at 15:58)</a>:</h4>
<p>koute labeled <a href="https://github.com/bytecodealliance/wasmtime/issues/5768">issue #5768</a>:</p>
<blockquote>
<p>(This looks like a <code>rustc</code> bug to me, but I'm reporting it here since it can be trivially worked around in <code>wasmtime</code>.)</p>
<p>When <code>wasmtime</code> is linked with LTO some of the symbols which are passed into the <code>global_asm!</code> trampolines are not properly preserved and are stripped by LTO, resulting in a link-time compile failure.</p>
<p>We hit this after we upgraded from <code>wasmtime</code> 1.0.2 to <code>wasmtime</code> 5.0.0.</p>
<h3>Steps to Reproduce</h3>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="n">git</span><span class="w"> </span><span class="n">clone</span><span class="w"> </span><span class="n">https</span>:<span class="c1">//github.com/paritytech/substrate.git</span>
<span class="n">cd</span><span class="w"> </span><span class="n">substrate</span>
<span class="n">git</span><span class="w"> </span><span class="n">fetch</span><span class="w"> </span><span class="n">origin</span><span class="w"> </span><span class="mi">10</span><span class="n">bf4bd0d9ed75c62bf9e094759fa9315e1c2017</span>
<span class="n">git</span><span class="w"> </span><span class="n">checkout</span><span class="w"> </span><span class="mi">10</span><span class="n">bf4bd0d9ed75c62bf9e094759fa9315e1c2017</span>
<span class="n">cd</span><span class="w"> </span><span class="n">bin</span><span class="o">/</span><span class="n">node</span><span class="o">/</span><span class="n">cli</span>
<span class="n">cargo</span><span class="w"> </span><span class="n">build</span><span class="w"> </span><span class="o">--</span><span class="n">profile</span><span class="o">=</span><span class="n">production</span>
</code></pre></div>
<p>This will take quite a while; sorry, I don't have a more minimal reproduction on hand since the issue doesn't reproduce on a toy example and reducing the actual reproduction into a minimal example is tricky when it takes forever to reproduce.</p>
<h3>Expected Results</h3>
<p>The compilation succeeds.</p>
<h3>Actual Results</h3>
<p>Linking fails.</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="n">error</span>: <span class="nc">linking</span><span class="w"> </span><span class="n">with</span><span class="w"> </span><span class="err">`</span><span class="n">cc</span><span class="err">`</span><span class="w"> </span><span class="n">failed</span>: <span class="nc">exit</span><span class="w"> </span><span class="n">status</span>: <span class="mi">1</span>
<span class="w">  </span><span class="o">|</span>
<span class="w">  </span><span class="o">=</span><span class="w"> </span><span class="n">note</span>: <span class="s">"cc"</span><span class="w"> </span><span class="s">"-m64"</span><span class="w"> </span><span class="s">"/tmp/rustcVp2xZW/symbols.o"</span><span class="w"> </span><span class="s">"/home/benchbot/cargo_target_dir/production/deps/substrate-5e6858252d8e1fde.substrate.8fb52a54-cgu.0.rcgu.o"</span><span class="w"> </span><span class="s">"-Wl,--as-needed"</span><span class="w"> </span><span class="s">"-L"</span><span class="w"> </span><span class="s">"/home/benchbot/cargo_target_dir/production/deps"</span><span class="w"> </span><span class="s">"-L"</span><span class="w"> </span><span class="s">"/home/benchbot/cargo_target_dir/production/build/secp256k1-sys-325112220bd38f82/out"</span><span class="w"> </span><span class="s">"-L"</span><span class="w"> </span><span class="s">"/home/benchbot/cargo_target_dir/production/build/psm-9a0468c1d0238995/out"</span><span class="w"> </span><span class="s">"-L"</span><span class="w"> </span><span class="s">"/home/benchbot/cargo_target_dir/production/build/zstd-sys-89ca5ccaf9b199da/out"</span><span class="w"> </span><span class="s">"-L"</span><span class="w"> </span><span class="s">"/home/benchbot/cargo_target_dir/production/build/wasmtime-runtime-abbae99d5a8a5288/out"</span><span class="w"> </span><span class="s">"-L"</span><span class="w"> </span><span class="s">"/home/benchbot/cargo_target_dir/production/build/blake3-3c4da28db5e4fd3e/out"</span><span class="w"> </span><span class="s">"-L"</span><span class="w"> </span><span class="s">"/home/benchbot/cargo_target_dir/production/build/blake3-3c4da28db5e4fd3e/out"</span><span class="w"> </span><span class="s">"-L"</span><span class="w"> </span><span class="s">"/home/benchbot/cargo_target_dir/production/build/ring-2ca6aaf61769762f/out"</span><span class="w"> </span><span class="s">"-L"</span><span class="w"> </span><span class="s">"/home/benchbot/cargo_target_dir/production/build/librocksdb-sys-9f56c52ab5fb72b3/out"</span><span class="w"> </span><span class="s">"-L"</span><span class="w"> </span><span class="s">"/home/benchbot/cargo_target_dir/production/build/librocksdb-sys-9f56c52ab5fb72b3/out"</span><span class="w"> </span><span class="s">"-L"</span><span class="w"> </span><span class="s">"/home/benchbot/cargo_target_dir/production/build/tikv-jemalloc-sys-1c1b04141739d384/out/build/lib"</span><span class="w"> </span><span class="s">"-L"</span><span class="w"> </span><span class="s">"/home/benchbot/cargo_target_dir/production/build/lz4-sys-8668a2a3112e8575/out"</span><span class="w"> </span><span class="s">"-L"</span><span class="w"> </span><span class="s">"/usr/local/rustup/toolchains/1.66.1-x86_64-unknown-linux-gnu/lib/rustlib/x86_64-unknown-linux-gnu/lib"</span><span class="w"> </span><span class="s">"-Wl,-Bstatic"</span><span class="w"> </span><span class="s">"/tmp/rustcVp2xZW/liblz4_sys-d7fc638637648eea.rlib"</span><span class="w"> </span><span class="s">"/tmp/rustcVp2xZW/liblibrocksdb_sys-8e2bd3fbce00bae8.rlib"</span><span class="w"> </span><span class="s">"/tmp/rustcVp2xZW/libring-eaff6bf0aa221db4.rlib"</span><span class="w"> </span><span class="s">"/tmp/rustcVp2xZW/libblake3-71adb6285cf48b0f.rlib"</span><span class="w"> </span><span class="s">"/tmp/rustcVp2xZW/libsecp256k1_sys-3053efd9f5b6aa76.rlib"</span><span class="w"> </span><span class="s">"/tmp/rustcVp2xZW/libpsm-9a050d5bd674c210.rlib"</span><span class="w"> </span><span class="s">"/tmp/rustcVp2xZW/libzstd_sys-21f01571affc3d59.rlib"</span><span class="w"> </span><span class="s">"/tmp/rustcVp2xZW/libwasmtime_runtime-0c33dd4e6df14e3b.rlib"</span><span class="w"> </span><span class="s">"/usr/local/rustup/toolchains/1.66.1-x86_64-unknown-linux-gnu/lib/rustlib/x86_64-unknown-linux-gnu/lib/libcompiler_builtins-91d9d5141f4e57a1.rlib"</span><span class="w"> </span><span class="s">"-Wl,-Bdynamic"</span><span class="w"> </span><span class="s">"-lstdc++"</span><span class="w"> </span><span class="s">"-lz"</span><span class="w"> </span><span class="s">"-lgcc_s"</span><span class="w"> </span><span class="s">"-lutil"</span><span class="w"> </span><span class="s">"-lrt"</span><span class="w"> </span><span class="s">"-lpthread"</span><span class="w"> </span><span class="s">"-lm"</span><span class="w"> </span><span class="s">"-ldl"</span><span class="w"> </span><span class="s">"-lc"</span><span class="w"> </span><span class="s">"-Wl,--eh-frame-hdr"</span><span class="w"> </span><span class="s">"-Wl,-znoexecstack"</span><span class="w"> </span><span class="s">"-L"</span><span class="w"> </span><span class="s">"/usr/local/rustup/toolchains/1.66.1-x86_64-unknown-linux-gnu/lib/rustlib/x86_64-unknown-linux-gnu/lib"</span><span class="w"> </span><span class="s">"-o"</span><span class="w"> </span><span class="s">"/home/benchbot/cargo_target_dir/production/deps/substrate-5e6858252d8e1fde"</span><span class="w"> </span><span class="s">"-Wl,--gc-sections"</span><span class="w"> </span><span class="s">"-pie"</span><span class="w"> </span><span class="s">"-Wl,-zrelro,-znow"</span><span class="w"> </span><span class="s">"-Wl,-O1"</span><span class="w"> </span><span class="s">"-nodefaultlibs"</span>
<span class="w">  </span><span class="o">=</span><span class="w"> </span><span class="n">note</span>: <span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">bin</span><span class="o">/</span><span class="n">ld</span>: <span class="o">/</span><span class="n">home</span><span class="o">/</span><span class="n">benchbot</span><span class="o">/</span><span class="n">cargo_target_dir</span><span class="o">/</span><span class="n">production</span><span class="o">/</span><span class="n">deps</span><span class="o">/</span><span class="n">substrate</span><span class="o">-</span><span class="mf">5e6858252</span><span class="n">d8e1fde</span><span class="p">.</span><span class="n">substrate</span><span class="p">.</span><span class="mi">8</span><span class="n">fb52a54</span><span class="o">-</span><span class="n">cgu</span><span class="p">.</span><span class="mf">0.</span><span class="n">rcgu</span><span class="p">.</span><span class="n">o</span>: <span class="nc">in</span><span class="w"> </span><span class="n">function</span><span class="w"> </span><span class="err">`</span><span class="n">table_grow_funcref</span><span class="o">'</span>:
          <span class="nc">substrate</span><span class="p">.</span><span class="mi">8</span><span class="n">fb52a54</span><span class="o">-</span><span class="n">cgu</span><span class="p">.</span><span class="mi">0</span>:<span class="p">(.</span><span class="n">text</span><span class="o">+</span><span class="mh">0x151</span><span class="p">)</span>: <span class="nc">undefined</span><span class="w"> </span><span class="n">reference</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="err">`</span><span class="n">wasmtime_runtime</span>::<span class="n">libcalls</span>::<span class="n">trampolines</span>::<span class="n">impl_table_grow_funcref</span><span class="o">'</span>
<span class="w">          </span><span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">bin</span><span class="o">/</span><span class="n">ld</span>: <span class="o">/</span><span class="n">home</span><span class="o">/</span><span class="n">benchbot</span><span class="o">/</span><span class="n">cargo_target_dir</span><span class="o">/</span><span class="n">production</span><span class="o">/</span><span class="n">deps</span><span class="o">/</span><span class="n">substrate</span><span class="o">-</span><span class="mf">5e6858252</span><span class="n">d8e1fde</span><span class="p">.</span><span class="n">substrate</span><span class="p">.</span><span class="mi">8</span><span class="n">fb52a54</span><span class="o">-</span><span class="n">cgu</span><span class="p">.</span><span class="mf">0.</span><span class="n">rcgu</span><span class="p">.</span><span class="n">o</span>: <span class="nc">in</span><span class="w"> </span><span class="n">function</span><span class="w"> </span><span class="err">`</span><span class="n">table_fill_funcref</span><span class="o">'</span>:
          <span class="nc">substrate</span><span class="p">.</span><span class="mi">8</span><span class="n">fb52a54</span><span class="o">-</span><span class="n">cgu</span><span class="p">.</span><span class="mi">0</span>:<span class="p">(.</span><span class="n">text</span><span class="o">+</span><span class="mh">0x1b1</span><span class="p">)</span>: <span class="nc">undefined</span><span class="w"> </span><span class="n">reference</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="err">`</span><span class="n">wasmtime_runtime</span>::<span class="n">libcalls</span>::<span class="n">trampolines</span>::<span class="n">impl_table_fill_funcref</span><span class="o">'</span>
<span class="w">          </span><span class="n">collect2</span>: <span class="nc">error</span>: <span class="nc">ld</span><span class="w"> </span><span class="n">returned</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="n">exit</span><span class="w"> </span><span class="n">status</span>
</code></pre></div>
<h3>Versions and Environment</h3>
<ul>
<li>rustc 1.69.0-nightly (c8e6a9e8b 2023-01-23)</li>
<li><code>wasmtime</code> 5.0.0</li>
<li>Linux+amd64</li>
</ul>
<p>The issue also reproduces on macOS+aarch64.</p>
<h3>Extra Info</h3>
<p>There's a trivial workaround which fixes the issue:</p>
<div class="codehilite" data-code-language="Diff"><pre><span></span><code><span class="gh">diff --git a/crates/runtime/src/libcalls.rs b/crates/runtime/src/libcalls.rs</span>
<span class="gh">index 5bed4d8ef..626fb861f 100644</span>
<span class="gd">--- a/crates/runtime/src/libcalls.rs</span>
<span class="gi">+++ b/crates/runtime/src/libcalls.rs</span>
<span class="gu">@@ -109,7 +109,7 @@ pub mod trampolines {</span>
<span class="w"> </span>                // the `sym` operator to get the symbol here, but other targets
<span class="w"> </span>                // like s390x need to use outlined assembly files which requires
<span class="w"> </span>                // `no_mangle`.
<span class="gd">-                #[cfg_attr(target_arch = "s390x", no_mangle)]</span>
<span class="gi">+                #[no_mangle]</span>
<span class="w"> </span>                unsafe extern "C" fn [&lt;impl_ $name&gt;](
<span class="w"> </span>                    vmctx : *mut VMContext,
<span class="w"> </span>                    $( $pname : libcall!(@ty $param), )*
</code></pre></div>
<p>I have verified that this "fixes" the issue. (Although of course ideally it'd be best to fix the underlying <code>rustc</code> bug.)</p>
</blockquote>



<a name="327584558"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%235768%20LTO%20strips%20out%20functions%20used%20by%20t.../near/327584558" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.235768.20LTO.20strips.20out.20functions.20used.20by.20t.2E.2E.2E.html#327584558">(Feb 13 2023 at 15:58)</a>:</h4>
<p>koute opened <a href="https://github.com/bytecodealliance/wasmtime/issues/5768">issue #5768</a>:</p>
<blockquote>
<p>(This looks like a <code>rustc</code> bug to me, but I'm reporting it here since it can be trivially worked around in <code>wasmtime</code>.)</p>
<p>When <code>wasmtime</code> is linked with LTO some of the symbols which are passed into the <code>global_asm!</code> trampolines are not properly preserved and are stripped by LTO, resulting in a link-time compile failure.</p>
<p>We hit this after we upgraded from <code>wasmtime</code> 1.0.2 to <code>wasmtime</code> 5.0.0.</p>
<h3>Steps to Reproduce</h3>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="n">git</span><span class="w"> </span><span class="n">clone</span><span class="w"> </span><span class="n">https</span>:<span class="c1">//github.com/paritytech/substrate.git</span>
<span class="n">cd</span><span class="w"> </span><span class="n">substrate</span>
<span class="n">git</span><span class="w"> </span><span class="n">fetch</span><span class="w"> </span><span class="n">origin</span><span class="w"> </span><span class="mi">10</span><span class="n">bf4bd0d9ed75c62bf9e094759fa9315e1c2017</span>
<span class="n">git</span><span class="w"> </span><span class="n">checkout</span><span class="w"> </span><span class="mi">10</span><span class="n">bf4bd0d9ed75c62bf9e094759fa9315e1c2017</span>
<span class="n">cd</span><span class="w"> </span><span class="n">bin</span><span class="o">/</span><span class="n">node</span><span class="o">/</span><span class="n">cli</span>
<span class="n">cargo</span><span class="w"> </span><span class="n">build</span><span class="w"> </span><span class="o">--</span><span class="n">profile</span><span class="o">=</span><span class="n">production</span>
</code></pre></div>
<p>This will take quite a while; sorry, I don't have a more minimal reproduction on hand since the issue doesn't reproduce on a toy example and reducing the actual reproduction into a minimal example is tricky when it takes forever to reproduce.</p>
<h3>Expected Results</h3>
<p>The compilation succeeds.</p>
<h3>Actual Results</h3>
<p>Linking fails.</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="n">error</span>: <span class="nc">linking</span><span class="w"> </span><span class="n">with</span><span class="w"> </span><span class="err">`</span><span class="n">cc</span><span class="err">`</span><span class="w"> </span><span class="n">failed</span>: <span class="nc">exit</span><span class="w"> </span><span class="n">status</span>: <span class="mi">1</span>
<span class="w">  </span><span class="o">|</span>
<span class="w">  </span><span class="o">=</span><span class="w"> </span><span class="n">note</span>: <span class="s">"cc"</span><span class="w"> </span><span class="s">"-m64"</span><span class="w"> </span><span class="s">"/tmp/rustcVp2xZW/symbols.o"</span><span class="w"> </span><span class="s">"/home/benchbot/cargo_target_dir/production/deps/substrate-5e6858252d8e1fde.substrate.8fb52a54-cgu.0.rcgu.o"</span><span class="w"> </span><span class="s">"-Wl,--as-needed"</span><span class="w"> </span><span class="s">"-L"</span><span class="w"> </span><span class="s">"/home/benchbot/cargo_target_dir/production/deps"</span><span class="w"> </span><span class="s">"-L"</span><span class="w"> </span><span class="s">"/home/benchbot/cargo_target_dir/production/build/secp256k1-sys-325112220bd38f82/out"</span><span class="w"> </span><span class="s">"-L"</span><span class="w"> </span><span class="s">"/home/benchbot/cargo_target_dir/production/build/psm-9a0468c1d0238995/out"</span><span class="w"> </span><span class="s">"-L"</span><span class="w"> </span><span class="s">"/home/benchbot/cargo_target_dir/production/build/zstd-sys-89ca5ccaf9b199da/out"</span><span class="w"> </span><span class="s">"-L"</span><span class="w"> </span><span class="s">"/home/benchbot/cargo_target_dir/production/build/wasmtime-runtime-abbae99d5a8a5288/out"</span><span class="w"> </span><span class="s">"-L"</span><span class="w"> </span><span class="s">"/home/benchbot/cargo_target_dir/production/build/blake3-3c4da28db5e4fd3e/out"</span><span class="w"> </span><span class="s">"-L"</span><span class="w"> </span><span class="s">"/home/benchbot/cargo_target_dir/production/build/blake3-3c4da28db5e4fd3e/out"</span><span class="w"> </span><span class="s">"-L"</span><span class="w"> </span><span class="s">"/home/benchbot/cargo_target_dir/production/build/ring-2ca6aaf61769762f/out"</span><span class="w"> </span><span class="s">"-L"</span><span class="w"> </span><span class="s">"/home/benchbot/cargo_target_dir/production/build/librocksdb-sys-9f56c52ab5fb72b3/out"</span><span class="w"> </span><span class="s">"-L"</span><span class="w"> </span><span class="s">"/home/benchbot/cargo_target_dir/production/build/librocksdb-sys-9f56c52ab5fb72b3/out"</span><span class="w"> </span><span class="s">"-L"</span><span class="w"> </span><span class="s">"/home/benchbot/cargo_target_dir/production/build/tikv-jemalloc-sys-1c1b04141739d384/out/build/lib"</span><span class="w"> </span><span class="s">"-L"</span><span class="w"> </span><span class="s">"/home/benchbot/cargo_target_dir/production/build/lz4-sys-8668a2a3112e8575/out"</span><span class="w"> </span><span class="s">"-L"</span><span class="w"> </span><span class="s">"/usr/local/rustup/toolchains/1.66.1-x86_64-unknown-linux-gnu/lib/rustlib/x86_64-unknown-linux-gnu/lib"</span><span class="w"> </span><span class="s">"-Wl,-Bstatic"</span><span class="w"> </span><span class="s">"/tmp/rustcVp2xZW/liblz4_sys-d7fc638637648eea.rlib"</span><span class="w"> </span><span class="s">"/tmp/rustcVp2xZW/liblibrocksdb_sys-8e2bd3fbce00bae8.rlib"</span><span class="w"> </span><span class="s">"/tmp/rustcVp2xZW/libring-eaff6bf0aa221db4.rlib"</span><span class="w"> </span><span class="s">"/tmp/rustcVp2xZW/libblake3-71adb6285cf48b0f.rlib"</span><span class="w"> </span><span class="s">"/tmp/rustcVp2xZW/libsecp256k1_sys-3053efd9f5b6aa76.rlib"</span><span class="w"> </span><span class="s">"/tmp/rustcVp2xZW/libpsm-9a050d5bd674c210.rlib"</span><span class="w"> </span><span class="s">"/tmp/rustcVp2xZW/libzstd_sys-21f01571affc3d59.rlib"</span><span class="w"> </span><span class="s">"/tmp/rustcVp2xZW/libwasmtime_runtime-0c33dd4e6df14e3b.rlib"</span><span class="w"> </span><span class="s">"/usr/local/rustup/toolchains/1.66.1-x86_64-unknown-linux-gnu/lib/rustlib/x86_64-unknown-linux-gnu/lib/libcompiler_builtins-91d9d5141f4e57a1.rlib"</span><span class="w"> </span><span class="s">"-Wl,-Bdynamic"</span><span class="w"> </span><span class="s">"-lstdc++"</span><span class="w"> </span><span class="s">"-lz"</span><span class="w"> </span><span class="s">"-lgcc_s"</span><span class="w"> </span><span class="s">"-lutil"</span><span class="w"> </span><span class="s">"-lrt"</span><span class="w"> </span><span class="s">"-lpthread"</span><span class="w"> </span><span class="s">"-lm"</span><span class="w"> </span><span class="s">"-ldl"</span><span class="w"> </span><span class="s">"-lc"</span><span class="w"> </span><span class="s">"-Wl,--eh-frame-hdr"</span><span class="w"> </span><span class="s">"-Wl,-znoexecstack"</span><span class="w"> </span><span class="s">"-L"</span><span class="w"> </span><span class="s">"/usr/local/rustup/toolchains/1.66.1-x86_64-unknown-linux-gnu/lib/rustlib/x86_64-unknown-linux-gnu/lib"</span><span class="w"> </span><span class="s">"-o"</span><span class="w"> </span><span class="s">"/home/benchbot/cargo_target_dir/production/deps/substrate-5e6858252d8e1fde"</span><span class="w"> </span><span class="s">"-Wl,--gc-sections"</span><span class="w"> </span><span class="s">"-pie"</span><span class="w"> </span><span class="s">"-Wl,-zrelro,-znow"</span><span class="w"> </span><span class="s">"-Wl,-O1"</span><span class="w"> </span><span class="s">"-nodefaultlibs"</span>
<span class="w">  </span><span class="o">=</span><span class="w"> </span><span class="n">note</span>: <span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">bin</span><span class="o">/</span><span class="n">ld</span>: <span class="o">/</span><span class="n">home</span><span class="o">/</span><span class="n">benchbot</span><span class="o">/</span><span class="n">cargo_target_dir</span><span class="o">/</span><span class="n">production</span><span class="o">/</span><span class="n">deps</span><span class="o">/</span><span class="n">substrate</span><span class="o">-</span><span class="mf">5e6858252</span><span class="n">d8e1fde</span><span class="p">.</span><span class="n">substrate</span><span class="p">.</span><span class="mi">8</span><span class="n">fb52a54</span><span class="o">-</span><span class="n">cgu</span><span class="p">.</span><span class="mf">0.</span><span class="n">rcgu</span><span class="p">.</span><span class="n">o</span>: <span class="nc">in</span><span class="w"> </span><span class="n">function</span><span class="w"> </span><span class="err">`</span><span class="n">table_grow_funcref</span><span class="o">'</span>:
          <span class="nc">substrate</span><span class="p">.</span><span class="mi">8</span><span class="n">fb52a54</span><span class="o">-</span><span class="n">cgu</span><span class="p">.</span><span class="mi">0</span>:<span class="p">(.</span><span class="n">text</span><span class="o">+</span><span class="mh">0x151</span><span class="p">)</span>: <span class="nc">undefined</span><span class="w"> </span><span class="n">reference</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="err">`</span><span class="n">wasmtime_runtime</span>::<span class="n">libcalls</span>::<span class="n">trampolines</span>::<span class="n">impl_table_grow_funcref</span><span class="o">'</span>
<span class="w">          </span><span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">bin</span><span class="o">/</span><span class="n">ld</span>: <span class="o">/</span><span class="n">home</span><span class="o">/</span><span class="n">benchbot</span><span class="o">/</span><span class="n">cargo_target_dir</span><span class="o">/</span><span class="n">production</span><span class="o">/</span><span class="n">deps</span><span class="o">/</span><span class="n">substrate</span><span class="o">-</span><span class="mf">5e6858252</span><span class="n">d8e1fde</span><span class="p">.</span><span class="n">substrate</span><span class="p">.</span><span class="mi">8</span><span class="n">fb52a54</span><span class="o">-</span><span class="n">cgu</span><span class="p">.</span><span class="mf">0.</span><span class="n">rcgu</span><span class="p">.</span><span class="n">o</span>: <span class="nc">in</span><span class="w"> </span><span class="n">function</span><span class="w"> </span><span class="err">`</span><span class="n">table_fill_funcref</span><span class="o">'</span>:
          <span class="nc">substrate</span><span class="p">.</span><span class="mi">8</span><span class="n">fb52a54</span><span class="o">-</span><span class="n">cgu</span><span class="p">.</span><span class="mi">0</span>:<span class="p">(.</span><span class="n">text</span><span class="o">+</span><span class="mh">0x1b1</span><span class="p">)</span>: <span class="nc">undefined</span><span class="w"> </span><span class="n">reference</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="err">`</span><span class="n">wasmtime_runtime</span>::<span class="n">libcalls</span>::<span class="n">trampolines</span>::<span class="n">impl_table_fill_funcref</span><span class="o">'</span>
<span class="w">          </span><span class="n">collect2</span>: <span class="nc">error</span>: <span class="nc">ld</span><span class="w"> </span><span class="n">returned</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="n">exit</span><span class="w"> </span><span class="n">status</span>
</code></pre></div>
<h3>Versions and Environment</h3>
<ul>
<li>rustc 1.69.0-nightly (c8e6a9e8b 2023-01-23)</li>
<li><code>wasmtime</code> 5.0.0</li>
<li>Linux+amd64</li>
</ul>
<p>The issue also reproduces on macOS+aarch64.</p>
<h3>Extra Info</h3>
<p>There's a trivial workaround which fixes the issue:</p>
<div class="codehilite" data-code-language="Diff"><pre><span></span><code><span class="gh">diff --git a/crates/runtime/src/libcalls.rs b/crates/runtime/src/libcalls.rs</span>
<span class="gh">index 5bed4d8ef..626fb861f 100644</span>
<span class="gd">--- a/crates/runtime/src/libcalls.rs</span>
<span class="gi">+++ b/crates/runtime/src/libcalls.rs</span>
<span class="gu">@@ -109,7 +109,7 @@ pub mod trampolines {</span>
<span class="w"> </span>                // the `sym` operator to get the symbol here, but other targets
<span class="w"> </span>                // like s390x need to use outlined assembly files which requires
<span class="w"> </span>                // `no_mangle`.
<span class="gd">-                #[cfg_attr(target_arch = "s390x", no_mangle)]</span>
<span class="gi">+                #[no_mangle]</span>
<span class="w"> </span>                unsafe extern "C" fn [&lt;impl_ $name&gt;](
<span class="w"> </span>                    vmctx : *mut VMContext,
<span class="w"> </span>                    $( $pname : libcall!(@ty $param), )*
</code></pre></div>
<p>I have verified that this "fixes" the issue. (Although of course ideally it'd be best to fix the underlying <code>rustc</code> bug.)</p>
</blockquote>



<a name="327716221"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%235768%20LTO%20strips%20out%20functions%20used%20by%20t.../near/327716221" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.235768.20LTO.20strips.20out.20functions.20used.20by.20t.2E.2E.2E.html#327716221">(Feb 14 2023 at 08:30)</a>:</h4>
<p>koute <a href="https://github.com/bytecodealliance/wasmtime/issues/5768#issuecomment-1429324072">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/5768">issue #5768</a>:</p>
<blockquote>
<p>Alternative workaround which also seems to work from what I can see:</p>
<div class="codehilite" data-code-language="Diff"><pre><span></span><code><span class="gh">diff --git a/crates/runtime/src/libcalls.rs b/crates/runtime/src/libcalls.rs</span>
<span class="gh">index 5bed4d8ef..294a65034 100644</span>
<span class="gd">--- a/crates/runtime/src/libcalls.rs</span>
<span class="gi">+++ b/crates/runtime/src/libcalls.rs</span>
<span class="gu">@@ -122,6 +122,11 @@ pub mod trampolines {</span>
<span class="w"> </span>                        Err(panic) =&gt; crate::traphandlers::resume_panic(panic),
<span class="w"> </span>                    }
<span class="w"> </span>                }
<span class="gi">+</span>
<span class="gi">+                #[allow(non_upper_case_globals)]</span>
<span class="gi">+                #[used]</span>
<span class="gi">+                static [&lt;impl_ $name _ref&gt;]: unsafe extern "C" fn(*mut VMContext, $( $pname : libcall!(@ty $param), )*) $( -&gt; libcall!(@ty $result))? = [&lt;impl_ $name&gt;];</span>
<span class="w"> </span>            )*
<span class="w"> </span>        }};
</code></pre></div>
</blockquote>



<a name="327723549"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%235768%20LTO%20strips%20out%20functions%20used%20by%20t.../near/327723549" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.235768.20LTO.20strips.20out.20functions.20used.20by.20t.2E.2E.2E.html#327723549">(Feb 14 2023 at 09:10)</a>:</h4>
<p>koute edited a <a href="https://github.com/bytecodealliance/wasmtime/issues/5768#issuecomment-1429324072">comment</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/5768">issue #5768</a>:</p>
<blockquote>
<p>Alternative workaround which also seems to work from what I can see:</p>
<div class="codehilite" data-code-language="Diff"><pre><span></span><code><span class="gh">diff --git a/crates/runtime/src/libcalls.rs b/crates/runtime/src/libcalls.rs</span>
<span class="gh">index 626cae408..2ce3bfc7d 100644</span>
<span class="gd">--- a/crates/runtime/src/libcalls.rs</span>
<span class="gi">+++ b/crates/runtime/src/libcalls.rs</span>
<span class="gu">@@ -122,6 +122,17 @@ pub mod trampolines {</span>
<span class="w"> </span>                        Err(panic) =&gt; crate::traphandlers::resume_panic(panic),
<span class="w"> </span>                    }
<span class="w"> </span>                }
<span class="gi">+</span>
<span class="gi">+                #[allow(non_upper_case_globals)]</span>
<span class="gi">+                #[used]</span>
<span class="gi">+                static [&lt;impl_ $name _ref&gt;]: unsafe extern "C" fn(</span>
<span class="gi">+                    *mut VMContext,</span>
<span class="gi">+                    $( $pname : libcall!(@ty $param), )*</span>
<span class="gi">+                ) $( -&gt; libcall!(@ty $result))? = [&lt;impl_ $name&gt;];</span>
<span class="w"> </span>            )*
<span class="w"> </span>        }};
</code></pre></div>
</blockquote>



<a name="327725236"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%235768%20LTO%20strips%20out%20functions%20used%20by%20t.../near/327725236" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.235768.20LTO.20strips.20out.20functions.20used.20by.20t.2E.2E.2E.html#327725236">(Feb 14 2023 at 09:19)</a>:</h4>
<p>koute <a href="https://github.com/bytecodealliance/wasmtime/issues/5768#issuecomment-1429387647">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/5768">issue #5768</a>:</p>
<blockquote>
<p>I've also created a <code>rustc</code> issue here: <a href="https://github.com/rust-lang/rust/issues/108030">https://github.com/rust-lang/rust/issues/108030</a></p>
</blockquote>



<a name="327801485"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%235768%20LTO%20strips%20out%20functions%20used%20by%20t.../near/327801485" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.235768.20LTO.20strips.20out.20functions.20used.20by.20t.2E.2E.2E.html#327801485">(Feb 14 2023 at 15:16)</a>:</h4>
<p>alexcrichton closed <a href="https://github.com/bytecodealliance/wasmtime/issues/5768">issue #5768</a>:</p>
<blockquote>
<p>(This looks like a <code>rustc</code> bug to me, but I'm reporting it here since it can be trivially worked around in <code>wasmtime</code>.)</p>
<p>When <code>wasmtime</code> is linked with LTO some of the symbols which are passed into the <code>global_asm!</code> trampolines are not properly preserved and are stripped by LTO, resulting in a link-time compile failure.</p>
<p>We hit this after we upgraded from <code>wasmtime</code> 1.0.2 to <code>wasmtime</code> 5.0.0.</p>
<h3>Steps to Reproduce</h3>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="n">git</span><span class="w"> </span><span class="n">clone</span><span class="w"> </span><span class="n">https</span>:<span class="c1">//github.com/paritytech/substrate.git</span>
<span class="n">cd</span><span class="w"> </span><span class="n">substrate</span>
<span class="n">git</span><span class="w"> </span><span class="n">fetch</span><span class="w"> </span><span class="n">origin</span><span class="w"> </span><span class="mi">10</span><span class="n">bf4bd0d9ed75c62bf9e094759fa9315e1c2017</span>
<span class="n">git</span><span class="w"> </span><span class="n">checkout</span><span class="w"> </span><span class="mi">10</span><span class="n">bf4bd0d9ed75c62bf9e094759fa9315e1c2017</span>
<span class="n">cd</span><span class="w"> </span><span class="n">bin</span><span class="o">/</span><span class="n">node</span><span class="o">/</span><span class="n">cli</span>
<span class="n">cargo</span><span class="w"> </span><span class="n">build</span><span class="w"> </span><span class="o">--</span><span class="n">profile</span><span class="o">=</span><span class="n">production</span>
</code></pre></div>
<p>This will take quite a while; sorry, I don't have a more minimal reproduction on hand since the issue doesn't reproduce on a toy example and reducing the actual reproduction into a minimal example is tricky when it takes forever to reproduce.</p>
<h3>Expected Results</h3>
<p>The compilation succeeds.</p>
<h3>Actual Results</h3>
<p>Linking fails.</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="n">error</span>: <span class="nc">linking</span><span class="w"> </span><span class="n">with</span><span class="w"> </span><span class="err">`</span><span class="n">cc</span><span class="err">`</span><span class="w"> </span><span class="n">failed</span>: <span class="nc">exit</span><span class="w"> </span><span class="n">status</span>: <span class="mi">1</span>
<span class="w">  </span><span class="o">|</span>
<span class="w">  </span><span class="o">=</span><span class="w"> </span><span class="n">note</span>: <span class="s">"cc"</span><span class="w"> </span><span class="s">"-m64"</span><span class="w"> </span><span class="s">"/tmp/rustcVp2xZW/symbols.o"</span><span class="w"> </span><span class="s">"/home/benchbot/cargo_target_dir/production/deps/substrate-5e6858252d8e1fde.substrate.8fb52a54-cgu.0.rcgu.o"</span><span class="w"> </span><span class="s">"-Wl,--as-needed"</span><span class="w"> </span><span class="s">"-L"</span><span class="w"> </span><span class="s">"/home/benchbot/cargo_target_dir/production/deps"</span><span class="w"> </span><span class="s">"-L"</span><span class="w"> </span><span class="s">"/home/benchbot/cargo_target_dir/production/build/secp256k1-sys-325112220bd38f82/out"</span><span class="w"> </span><span class="s">"-L"</span><span class="w"> </span><span class="s">"/home/benchbot/cargo_target_dir/production/build/psm-9a0468c1d0238995/out"</span><span class="w"> </span><span class="s">"-L"</span><span class="w"> </span><span class="s">"/home/benchbot/cargo_target_dir/production/build/zstd-sys-89ca5ccaf9b199da/out"</span><span class="w"> </span><span class="s">"-L"</span><span class="w"> </span><span class="s">"/home/benchbot/cargo_target_dir/production/build/wasmtime-runtime-abbae99d5a8a5288/out"</span><span class="w"> </span><span class="s">"-L"</span><span class="w"> </span><span class="s">"/home/benchbot/cargo_target_dir/production/build/blake3-3c4da28db5e4fd3e/out"</span><span class="w"> </span><span class="s">"-L"</span><span class="w"> </span><span class="s">"/home/benchbot/cargo_target_dir/production/build/blake3-3c4da28db5e4fd3e/out"</span><span class="w"> </span><span class="s">"-L"</span><span class="w"> </span><span class="s">"/home/benchbot/cargo_target_dir/production/build/ring-2ca6aaf61769762f/out"</span><span class="w"> </span><span class="s">"-L"</span><span class="w"> </span><span class="s">"/home/benchbot/cargo_target_dir/production/build/librocksdb-sys-9f56c52ab5fb72b3/out"</span><span class="w"> </span><span class="s">"-L"</span><span class="w"> </span><span class="s">"/home/benchbot/cargo_target_dir/production/build/librocksdb-sys-9f56c52ab5fb72b3/out"</span><span class="w"> </span><span class="s">"-L"</span><span class="w"> </span><span class="s">"/home/benchbot/cargo_target_dir/production/build/tikv-jemalloc-sys-1c1b04141739d384/out/build/lib"</span><span class="w"> </span><span class="s">"-L"</span><span class="w"> </span><span class="s">"/home/benchbot/cargo_target_dir/production/build/lz4-sys-8668a2a3112e8575/out"</span><span class="w"> </span><span class="s">"-L"</span><span class="w"> </span><span class="s">"/usr/local/rustup/toolchains/1.66.1-x86_64-unknown-linux-gnu/lib/rustlib/x86_64-unknown-linux-gnu/lib"</span><span class="w"> </span><span class="s">"-Wl,-Bstatic"</span><span class="w"> </span><span class="s">"/tmp/rustcVp2xZW/liblz4_sys-d7fc638637648eea.rlib"</span><span class="w"> </span><span class="s">"/tmp/rustcVp2xZW/liblibrocksdb_sys-8e2bd3fbce00bae8.rlib"</span><span class="w"> </span><span class="s">"/tmp/rustcVp2xZW/libring-eaff6bf0aa221db4.rlib"</span><span class="w"> </span><span class="s">"/tmp/rustcVp2xZW/libblake3-71adb6285cf48b0f.rlib"</span><span class="w"> </span><span class="s">"/tmp/rustcVp2xZW/libsecp256k1_sys-3053efd9f5b6aa76.rlib"</span><span class="w"> </span><span class="s">"/tmp/rustcVp2xZW/libpsm-9a050d5bd674c210.rlib"</span><span class="w"> </span><span class="s">"/tmp/rustcVp2xZW/libzstd_sys-21f01571affc3d59.rlib"</span><span class="w"> </span><span class="s">"/tmp/rustcVp2xZW/libwasmtime_runtime-0c33dd4e6df14e3b.rlib"</span><span class="w"> </span><span class="s">"/usr/local/rustup/toolchains/1.66.1-x86_64-unknown-linux-gnu/lib/rustlib/x86_64-unknown-linux-gnu/lib/libcompiler_builtins-91d9d5141f4e57a1.rlib"</span><span class="w"> </span><span class="s">"-Wl,-Bdynamic"</span><span class="w"> </span><span class="s">"-lstdc++"</span><span class="w"> </span><span class="s">"-lz"</span><span class="w"> </span><span class="s">"-lgcc_s"</span><span class="w"> </span><span class="s">"-lutil"</span><span class="w"> </span><span class="s">"-lrt"</span><span class="w"> </span><span class="s">"-lpthread"</span><span class="w"> </span><span class="s">"-lm"</span><span class="w"> </span><span class="s">"-ldl"</span><span class="w"> </span><span class="s">"-lc"</span><span class="w"> </span><span class="s">"-Wl,--eh-frame-hdr"</span><span class="w"> </span><span class="s">"-Wl,-znoexecstack"</span><span class="w"> </span><span class="s">"-L"</span><span class="w"> </span><span class="s">"/usr/local/rustup/toolchains/1.66.1-x86_64-unknown-linux-gnu/lib/rustlib/x86_64-unknown-linux-gnu/lib"</span><span class="w"> </span><span class="s">"-o"</span><span class="w"> </span><span class="s">"/home/benchbot/cargo_target_dir/production/deps/substrate-5e6858252d8e1fde"</span><span class="w"> </span><span class="s">"-Wl,--gc-sections"</span><span class="w"> </span><span class="s">"-pie"</span><span class="w"> </span><span class="s">"-Wl,-zrelro,-znow"</span><span class="w"> </span><span class="s">"-Wl,-O1"</span><span class="w"> </span><span class="s">"-nodefaultlibs"</span>
<span class="w">  </span><span class="o">=</span><span class="w"> </span><span class="n">note</span>: <span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">bin</span><span class="o">/</span><span class="n">ld</span>: <span class="o">/</span><span class="n">home</span><span class="o">/</span><span class="n">benchbot</span><span class="o">/</span><span class="n">cargo_target_dir</span><span class="o">/</span><span class="n">production</span><span class="o">/</span><span class="n">deps</span><span class="o">/</span><span class="n">substrate</span><span class="o">-</span><span class="mf">5e6858252</span><span class="n">d8e1fde</span><span class="p">.</span><span class="n">substrate</span><span class="p">.</span><span class="mi">8</span><span class="n">fb52a54</span><span class="o">-</span><span class="n">cgu</span><span class="p">.</span><span class="mf">0.</span><span class="n">rcgu</span><span class="p">.</span><span class="n">o</span>: <span class="nc">in</span><span class="w"> </span><span class="n">function</span><span class="w"> </span><span class="err">`</span><span class="n">table_grow_funcref</span><span class="o">'</span>:
          <span class="nc">substrate</span><span class="p">.</span><span class="mi">8</span><span class="n">fb52a54</span><span class="o">-</span><span class="n">cgu</span><span class="p">.</span><span class="mi">0</span>:<span class="p">(.</span><span class="n">text</span><span class="o">+</span><span class="mh">0x151</span><span class="p">)</span>: <span class="nc">undefined</span><span class="w"> </span><span class="n">reference</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="err">`</span><span class="n">wasmtime_runtime</span>::<span class="n">libcalls</span>::<span class="n">trampolines</span>::<span class="n">impl_table_grow_funcref</span><span class="o">'</span>
<span class="w">          </span><span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">bin</span><span class="o">/</span><span class="n">ld</span>: <span class="o">/</span><span class="n">home</span><span class="o">/</span><span class="n">benchbot</span><span class="o">/</span><span class="n">cargo_target_dir</span><span class="o">/</span><span class="n">production</span><span class="o">/</span><span class="n">deps</span><span class="o">/</span><span class="n">substrate</span><span class="o">-</span><span class="mf">5e6858252</span><span class="n">d8e1fde</span><span class="p">.</span><span class="n">substrate</span><span class="p">.</span><span class="mi">8</span><span class="n">fb52a54</span><span class="o">-</span><span class="n">cgu</span><span class="p">.</span><span class="mf">0.</span><span class="n">rcgu</span><span class="p">.</span><span class="n">o</span>: <span class="nc">in</span><span class="w"> </span><span class="n">function</span><span class="w"> </span><span class="err">`</span><span class="n">table_fill_funcref</span><span class="o">'</span>:
          <span class="nc">substrate</span><span class="p">.</span><span class="mi">8</span><span class="n">fb52a54</span><span class="o">-</span><span class="n">cgu</span><span class="p">.</span><span class="mi">0</span>:<span class="p">(.</span><span class="n">text</span><span class="o">+</span><span class="mh">0x1b1</span><span class="p">)</span>: <span class="nc">undefined</span><span class="w"> </span><span class="n">reference</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="err">`</span><span class="n">wasmtime_runtime</span>::<span class="n">libcalls</span>::<span class="n">trampolines</span>::<span class="n">impl_table_fill_funcref</span><span class="o">'</span>
<span class="w">          </span><span class="n">collect2</span>: <span class="nc">error</span>: <span class="nc">ld</span><span class="w"> </span><span class="n">returned</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="n">exit</span><span class="w"> </span><span class="n">status</span>
</code></pre></div>
<h3>Versions and Environment</h3>
<ul>
<li>rustc 1.69.0-nightly (c8e6a9e8b 2023-01-23)</li>
<li><code>wasmtime</code> 5.0.0</li>
<li>Linux+amd64</li>
</ul>
<p>The issue also reproduces on macOS+aarch64.</p>
<h3>Extra Info</h3>
<p>There's a trivial workaround which fixes the issue:</p>
<div class="codehilite" data-code-language="Diff"><pre><span></span><code><span class="gh">diff --git a/crates/runtime/src/libcalls.rs b/crates/runtime/src/libcalls.rs</span>
<span class="gh">index 5bed4d8ef..626fb861f 100644</span>
<span class="gd">--- a/crates/runtime/src/libcalls.rs</span>
<span class="gi">+++ b/crates/runtime/src/libcalls.rs</span>
<span class="gu">@@ -109,7 +109,7 @@ pub mod trampolines {</span>
<span class="w"> </span>                // the `sym` operator to get the symbol here, but other targets
<span class="w"> </span>                // like s390x need to use outlined assembly files which requires
<span class="w"> </span>                // `no_mangle`.
<span class="gd">-                #[cfg_attr(target_arch = "s390x", no_mangle)]</span>
<span class="gi">+                #[no_mangle]</span>
<span class="w"> </span>                unsafe extern "C" fn [&lt;impl_ $name&gt;](
<span class="w"> </span>                    vmctx : *mut VMContext,
<span class="w"> </span>                    $( $pname : libcall!(@ty $param), )*
</code></pre></div>
<p>I have verified that this "fixes" the issue. (Although of course ideally it'd be best to fix the underlying <code>rustc</code> bug.)</p>
</blockquote>



<hr><p>Last updated: Jan 20 2025 at 06:04 UTC</p>
</html>