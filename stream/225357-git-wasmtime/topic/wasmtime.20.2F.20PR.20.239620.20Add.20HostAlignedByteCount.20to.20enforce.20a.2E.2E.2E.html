<html>
<head><meta charset="utf-8"><title>wasmtime / PR #9620 Add HostAlignedByteCount to enforce a... · git-wasmtime · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/index.html">git-wasmtime</a></h2>
<h3>Topic: <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.239620.20Add.20HostAlignedByteCount.20to.20enforce.20a.2E.2E.2E.html">wasmtime / PR #9620 Add HostAlignedByteCount to enforce a...</a></h3>

<hr>

<base href="https://bytecodealliance.zulipchat.com">

<head><link href="https://bytecodealliance.github.io/zulip-archive/style.css" rel="stylesheet"></head>

<a name="483167103"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%239620%20Add%20HostAlignedByteCount%20to%20enforce%20a.../near/483167103" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.239620.20Add.20HostAlignedByteCount.20to.20enforce.20a.2E.2E.2E.html#483167103">(Nov 19 2024 at 02:29)</a>:</h4>
<p><strong>sunshowers</strong> requested <a href="https://github.com/orgs/bytecodealliance/teams/wasmtime-core-reviewers">wasmtime-core-reviewers</a> for a review on <a href="https://github.com/bytecodealliance/wasmtime/pull/9620">PR #9620</a>.</p>



<a name="483167105"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%239620%20Add%20HostAlignedByteCount%20to%20enforce%20a.../near/483167105" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.239620.20Add.20HostAlignedByteCount.20to.20enforce.20a.2E.2E.2E.html#483167105">(Nov 19 2024 at 02:29)</a>:</h4>
<p><strong>sunshowers</strong> requested <a href="https://github.com/alexcrichton">alexcrichton</a> for a review on <a href="https://github.com/bytecodealliance/wasmtime/pull/9620">PR #9620</a>.</p>



<a name="483167106"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%239620%20Add%20HostAlignedByteCount%20to%20enforce%20a.../near/483167106" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.239620.20Add.20HostAlignedByteCount.20to.20enforce.20a.2E.2E.2E.html#483167106">(Nov 19 2024 at 02:29)</a>:</h4>
<p>sunshowers opened <a href="https://github.com/bytecodealliance/wasmtime/pull/9620">PR #9620</a> from <code>sunshowers:host-aligned</code> to <code>bytecodealliance:main</code>:</p>
<blockquote>
<p>As part of the work to allow mmaps to be backed by other implementations (#9544), I realized that we didn't have any way to track whether a particular usize is host-page-aligned at compile time.</p>
<p>Add a <code>HostAlignedByteCount</code> which tracks that a particular usize is aligned to the host page size. This also does not expose safe unchecked arithmetic operations, to ensure that overflows always error out.</p>
<p>With <code>HostAlignedByteCount</code>, a lot of runtime checks can go away thanks to the type-level assertion.</p>
<p>In the interest of keeping the diff relatively small, I haven't converted everything over yet. More code can be converted over as we go along.</p>
</blockquote>



<a name="483167258"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%239620%20Add%20HostAlignedByteCount%20to%20enforce%20a.../near/483167258" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.239620.20Add.20HostAlignedByteCount.20to.20enforce.20a.2E.2E.2E.html#483167258">(Nov 19 2024 at 02:30)</a>:</h4>
<p>sunshowers submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/9620#pullrequestreview-2444159991">PR review</a>.</p>



<a name="483167259"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%239620%20Add%20HostAlignedByteCount%20to%20enforce%20a.../near/483167259" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.239620.20Add.20HostAlignedByteCount.20to.20enforce.20a.2E.2E.2E.html#483167259">(Nov 19 2024 at 02:30)</a>:</h4>
<p>sunshowers created <a href="https://github.com/bytecodealliance/wasmtime/pull/9620#discussion_r1847553683">PR review comment</a>:</p>
<blockquote>
<p>This code and the similar section below would be good to convert over, but I decided to do this in a followup.</p>
</blockquote>



<a name="483167518"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%239620%20Add%20HostAlignedByteCount%20to%20enforce%20a.../near/483167518" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.239620.20Add.20HostAlignedByteCount.20to.20enforce.20a.2E.2E.2E.html#483167518">(Nov 19 2024 at 02:32)</a>:</h4>
<p>sunshowers submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/9620#pullrequestreview-2444161667">PR review</a>.</p>



<a name="483167520"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%239620%20Add%20HostAlignedByteCount%20to%20enforce%20a.../near/483167520" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.239620.20Add.20HostAlignedByteCount.20to.20enforce.20a.2E.2E.2E.html#483167520">(Nov 19 2024 at 02:32)</a>:</h4>
<p>sunshowers created <a href="https://github.com/bytecodealliance/wasmtime/pull/9620#discussion_r1847554997">PR review comment</a>:</p>
<blockquote>
<p>I first named this <code>AlignedByteCount</code>, but then realized that the VM page size might not be the same as the host page size, so named it <code>HostAlignedByteCount</code> instead. Happy to rename this to something else if it makes sense.</p>
</blockquote>



<a name="483168234"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%239620%20Add%20HostAlignedByteCount%20to%20enforce%20a.../near/483168234" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.239620.20Add.20HostAlignedByteCount.20to.20enforce.20a.2E.2E.2E.html#483168234">(Nov 19 2024 at 02:38)</a>:</h4>
<p>sunshowers updated <a href="https://github.com/bytecodealliance/wasmtime/pull/9620">PR #9620</a>.</p>



<a name="483168472"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%239620%20Add%20HostAlignedByteCount%20to%20enforce%20a.../near/483168472" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.239620.20Add.20HostAlignedByteCount.20to.20enforce.20a.2E.2E.2E.html#483168472">(Nov 19 2024 at 02:41)</a>:</h4>
<p>sunshowers updated <a href="https://github.com/bytecodealliance/wasmtime/pull/9620">PR #9620</a>.</p>



<a name="483169155"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%239620%20Add%20HostAlignedByteCount%20to%20enforce%20a.../near/483169155" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.239620.20Add.20HostAlignedByteCount.20to.20enforce.20a.2E.2E.2E.html#483169155">(Nov 19 2024 at 02:47)</a>:</h4>
<p>sunshowers submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/9620#pullrequestreview-2444174817">PR review</a>.</p>



<a name="483169156"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%239620%20Add%20HostAlignedByteCount%20to%20enforce%20a.../near/483169156" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.239620.20Add.20HostAlignedByteCount.20to.20enforce.20a.2E.2E.2E.html#483169156">(Nov 19 2024 at 02:47)</a>:</h4>
<p>sunshowers created <a href="https://github.com/bytecodealliance/wasmtime/pull/9620#discussion_r1847564546">PR review comment</a>:</p>
<blockquote>
<p>Should this print the size in hex or as a decimal?</p>
</blockquote>



<a name="483169320"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%239620%20Add%20HostAlignedByteCount%20to%20enforce%20a.../near/483169320" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.239620.20Add.20HostAlignedByteCount.20to.20enforce.20a.2E.2E.2E.html#483169320">(Nov 19 2024 at 02:49)</a>:</h4>
<p>sunshowers edited <a href="https://github.com/bytecodealliance/wasmtime/pull/9620">PR #9620</a>:</p>
<blockquote>
<p>As part of the work to allow mmaps to be backed by other implementations (#9544), I realized that we didn't have any way to track whether a particular usize is host-page-aligned at compile time.</p>
<p>Add a <code>HostAlignedByteCount</code> which tracks that a particular usize is aligned to the host page size. This also does not expose safe unchecked arithmetic operations, to ensure that overflows are always handled.</p>
<p>With <code>HostAlignedByteCount</code>, a lot of runtime checks can go away thanks to the type-level assertion.</p>
<p>In the interest of keeping the diff relatively small, I haven't converted everything over yet. More code can be converted over as we go along.</p>
</blockquote>



<a name="483193618"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%239620%20Add%20HostAlignedByteCount%20to%20enforce%20a.../near/483193618" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.239620.20Add.20HostAlignedByteCount.20to.20enforce.20a.2E.2E.2E.html#483193618">(Nov 19 2024 at 06:57)</a>:</h4>
<p>sunshowers <a href="https://github.com/bytecodealliance/wasmtime/pull/9620#issuecomment-2484843263">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/9620">PR #9620</a>:</p>
<blockquote>
<p>I started working on a followup as well: <a href="https://github.com/bytecodealliance/wasmtime/commit/03efe42fb4d8fdd760d945ce6ceb95b8ca338974">https://github.com/bytecodealliance/wasmtime/commit/03efe42fb4d8fdd760d945ce6ceb95b8ca338974</a></p>
<p>Unfortunately GitHub's review flow does not let you manage stacked PRs unless you have push access to the destination repo, so I'll have to put these up one at a time. Sigh :(</p>
</blockquote>



<a name="483299848"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%239620%20Add%20HostAlignedByteCount%20to%20enforce%20a.../near/483299848" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.239620.20Add.20HostAlignedByteCount.20to.20enforce.20a.2E.2E.2E.html#483299848">(Nov 19 2024 at 16:09)</a>:</h4>
<p>alexcrichton submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/9620#pullrequestreview-2445939968">PR review</a>:</p>
<blockquote>
<p>Thanks for this!</p>
</blockquote>



<a name="483299851"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%239620%20Add%20HostAlignedByteCount%20to%20enforce%20a.../near/483299851" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.239620.20Add.20HostAlignedByteCount.20to.20enforce.20a.2E.2E.2E.html#483299851">(Nov 19 2024 at 16:09)</a>:</h4>
<p>alexcrichton created <a href="https://github.com/bytecodealliance/wasmtime/pull/9620#discussion_r1848647729">PR review comment</a>:</p>
<blockquote>
<p>For here I think it's probably ok to discard the precise values that were being operated on as otherwise that makes the errors here pretty large for a low-level type such as this.</p>
</blockquote>



<a name="483299852"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%239620%20Add%20HostAlignedByteCount%20to%20enforce%20a.../near/483299852" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.239620.20Add.20HostAlignedByteCount.20to.20enforce.20a.2E.2E.2E.html#483299852">(Nov 19 2024 at 16:09)</a>:</h4>
<p>alexcrichton created <a href="https://github.com/bytecodealliance/wasmtime/pull/9620#discussion_r1848646746">PR review comment</a>:</p>
<blockquote>
<p>Mind putting this type/impls/errors/etc in a dedicated submodule of the <code>vm</code> module?</p>
</blockquote>



<a name="483299853"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%239620%20Add%20HostAlignedByteCount%20to%20enforce%20a.../near/483299853" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.239620.20Add.20HostAlignedByteCount.20to.20enforce.20a.2E.2E.2E.html#483299853">(Nov 19 2024 at 16:09)</a>:</h4>
<p>alexcrichton created <a href="https://github.com/bytecodealliance/wasmtime/pull/9620#discussion_r1848646023">PR review comment</a>:</p>
<blockquote>
<p>Same seems reasonable to me <span aria-label="+1" class="emoji emoji-1f44d" role="img" title="+1">:+1:</span> </p>
</blockquote>



<a name="483299854"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%239620%20Add%20HostAlignedByteCount%20to%20enforce%20a.../near/483299854" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.239620.20Add.20HostAlignedByteCount.20to.20enforce.20a.2E.2E.2E.html#483299854">(Nov 19 2024 at 16:09)</a>:</h4>
<p>alexcrichton created <a href="https://github.com/bytecodealliance/wasmtime/pull/9620#discussion_r1848648534">PR review comment</a>:</p>
<blockquote>
<p>Let's go with hex perhaps to clearly show that the low bits are all zero</p>
</blockquote>



<a name="483329405"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%239620%20Add%20HostAlignedByteCount%20to%20enforce%20a.../near/483329405" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.239620.20Add.20HostAlignedByteCount.20to.20enforce.20a.2E.2E.2E.html#483329405">(Nov 19 2024 at 18:35)</a>:</h4>
<p>alexcrichton submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/9620#pullrequestreview-2446294239">PR review</a>.</p>



<a name="483329407"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%239620%20Add%20HostAlignedByteCount%20to%20enforce%20a.../near/483329407" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.239620.20Add.20HostAlignedByteCount.20to.20enforce.20a.2E.2E.2E.html#483329407">(Nov 19 2024 at 18:35)</a>:</h4>
<p>alexcrichton created <a href="https://github.com/bytecodealliance/wasmtime/pull/9620#discussion_r1848860769">PR review comment</a>:</p>
<blockquote>
<p>Reviewing some other code elsewhere, I think that the <code>from_file</code> constructor may cause problems here because file lengths aren't always page-aligned. </p>
<p>To help catch this mind adding a <code>debug_assert!</code> to <code>new_unchecked</code>? That I think should make the test suite panic</p>
</blockquote>



<a name="483334073"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%239620%20Add%20HostAlignedByteCount%20to%20enforce%20a.../near/483334073" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.239620.20Add.20HostAlignedByteCount.20to.20enforce.20a.2E.2E.2E.html#483334073">(Nov 19 2024 at 19:03)</a>:</h4>
<p>alexcrichton <a href="https://github.com/bytecodealliance/wasmtime/pull/9620#issuecomment-2486515866">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/9620">PR #9620</a>:</p>
<blockquote>
<p>As a heads up I'm adding <a href="https://github.com/bytecodealliance/wasmtime/pull/9614">https://github.com/bytecodealliance/wasmtime/pull/9614</a> to the merge queue which is going to have a number of conflicts with this. It should (hopefully) be just a few <code>#[cfg(feature = "signals-based-traps")]</code> in a few places but if anything is overly difficult or onerous lemme know and I can help out</p>
</blockquote>



<a name="483577346"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%239620%20Add%20HostAlignedByteCount%20to%20enforce%20a.../near/483577346" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.239620.20Add.20HostAlignedByteCount.20to.20enforce.20a.2E.2E.2E.html#483577346">(Nov 20 2024 at 21:49)</a>:</h4>
<p>sunshowers updated <a href="https://github.com/bytecodealliance/wasmtime/pull/9620">PR #9620</a>.</p>



<a name="483577454"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%239620%20Add%20HostAlignedByteCount%20to%20enforce%20a.../near/483577454" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.239620.20Add.20HostAlignedByteCount.20to.20enforce.20a.2E.2E.2E.html#483577454">(Nov 20 2024 at 21:50)</a>:</h4>
<p>sunshowers submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/9620#pullrequestreview-2449770038">PR review</a>.</p>



<a name="483577455"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%239620%20Add%20HostAlignedByteCount%20to%20enforce%20a.../near/483577455" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.239620.20Add.20HostAlignedByteCount.20to.20enforce.20a.2E.2E.2E.html#483577455">(Nov 20 2024 at 21:50)</a>:</h4>
<p>sunshowers created <a href="https://github.com/bytecodealliance/wasmtime/pull/9620#discussion_r1851026661">PR review comment</a>:</p>
<blockquote>
<p>Done.</p>
</blockquote>



<a name="483577589"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%239620%20Add%20HostAlignedByteCount%20to%20enforce%20a.../near/483577589" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.239620.20Add.20HostAlignedByteCount.20to.20enforce.20a.2E.2E.2E.html#483577589">(Nov 20 2024 at 21:51)</a>:</h4>
<p>sunshowers submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/9620#pullrequestreview-2449771660">PR review</a>.</p>



<a name="483577590"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%239620%20Add%20HostAlignedByteCount%20to%20enforce%20a.../near/483577590" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.239620.20Add.20HostAlignedByteCount.20to.20enforce.20a.2E.2E.2E.html#483577590">(Nov 20 2024 at 21:51)</a>:</h4>
<p>sunshowers created <a href="https://github.com/bytecodealliance/wasmtime/pull/9620#discussion_r1851027656">PR review comment</a>:</p>
<blockquote>
<p>This ended up becoming #9639.</p>
</blockquote>



<a name="483578419"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%239620%20Add%20HostAlignedByteCount%20to%20enforce%20a.../near/483578419" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.239620.20Add.20HostAlignedByteCount.20to.20enforce.20a.2E.2E.2E.html#483578419">(Nov 20 2024 at 21:58)</a>:</h4>
<p>sunshowers created <a href="https://github.com/bytecodealliance/wasmtime/pull/9620#discussion_r1851034096">PR review comment</a>:</p>
<blockquote>
<p>Hmm good point, done.</p>
</blockquote>



<a name="483578420"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%239620%20Add%20HostAlignedByteCount%20to%20enforce%20a.../near/483578420" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.239620.20Add.20HostAlignedByteCount.20to.20enforce.20a.2E.2E.2E.html#483578420">(Nov 20 2024 at 21:58)</a>:</h4>
<p>sunshowers submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/9620#pullrequestreview-2449781489">PR review</a>.</p>



<a name="483584543"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%239620%20Add%20HostAlignedByteCount%20to%20enforce%20a.../near/483584543" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.239620.20Add.20HostAlignedByteCount.20to.20enforce.20a.2E.2E.2E.html#483584543">(Nov 20 2024 at 22:47)</a>:</h4>
<p>sunshowers updated <a href="https://github.com/bytecodealliance/wasmtime/pull/9620">PR #9620</a>.</p>



<a name="483584818"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%239620%20Add%20HostAlignedByteCount%20to%20enforce%20a.../near/483584818" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.239620.20Add.20HostAlignedByteCount.20to.20enforce.20a.2E.2E.2E.html#483584818">(Nov 20 2024 at 22:49)</a>:</h4>
<p>sunshowers <a href="https://github.com/bytecodealliance/wasmtime/pull/9620#issuecomment-2489692243">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/9620">PR #9620</a>:</p>
<blockquote>
<p>(Apologies for the force push -- had to do it as part of the rebase. GH makes me cry)</p>
</blockquote>



<a name="483596640"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%239620%20Add%20HostAlignedByteCount%20to%20enforce%20a.../near/483596640" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.239620.20Add.20HostAlignedByteCount.20to.20enforce.20a.2E.2E.2E.html#483596640">(Nov 21 2024 at 00:42)</a>:</h4>
<p>alexcrichton submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/9620#pullrequestreview-2449995532">PR review</a>:</p>
<blockquote>
<p>Thanks again for this!</p>
</blockquote>



<a name="483614828"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%239620%20Add%20HostAlignedByteCount%20to%20enforce%20a.../near/483614828" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.239620.20Add.20HostAlignedByteCount.20to.20enforce.20a.2E.2E.2E.html#483614828">(Nov 21 2024 at 04:19)</a>:</h4>
<p>sunshowers updated <a href="https://github.com/bytecodealliance/wasmtime/pull/9620">PR #9620</a>.</p>



<a name="483614858"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%239620%20Add%20HostAlignedByteCount%20to%20enforce%20a.../near/483614858" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.239620.20Add.20HostAlignedByteCount.20to.20enforce.20a.2E.2E.2E.html#483614858">(Nov 21 2024 at 04:19)</a>:</h4>
<p>sunshowers <a href="https://github.com/bytecodealliance/wasmtime/pull/9620#issuecomment-2490036652">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/9620">PR #9620</a>:</p>
<blockquote>
<p>All right, think I fixed the Miri issue.</p>
</blockquote>



<a name="483733680"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%239620%20Add%20HostAlignedByteCount%20to%20enforce%20a.../near/483733680" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.239620.20Add.20HostAlignedByteCount.20to.20enforce.20a.2E.2E.2E.html#483733680">(Nov 21 2024 at 16:05)</a>:</h4>
<p>alexcrichton submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/9620#pullrequestreview-2451949909">PR review</a>.</p>



<a name="483733681"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%239620%20Add%20HostAlignedByteCount%20to%20enforce%20a.../near/483733681" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.239620.20Add.20HostAlignedByteCount.20to.20enforce.20a.2E.2E.2E.html#483733681">(Nov 21 2024 at 16:05)</a>:</h4>
<p>alexcrichton created <a href="https://github.com/bytecodealliance/wasmtime/pull/9620#discussion_r1852422279">PR review comment</a>:</p>
<blockquote>
<p>I think this may be the source of the bug, albeit it's a bit indirect. Previously the <code>&gt;</code> condition is now morally becoming <code>&gt;=</code> since <code>new_accessible == self.accessible()</code> didn't run this block before but it's now running this block with <code>difference == 0</code>. I think then it may be the case that mprotect for 0 bytes is succeeding on unix but failing on Windows.</p>
<p>On Linux I see <code>mprotect(0x740d36001000, 0, PROT_READ|PROT_WRITE) = 0</code> in strace with this patch when running the failing spec test and while I haven't executed this on Windows this is what I would suspect is going on.</p>
<p>Another option is to update the <code>Mmap</code> type to skip <code>make_accessible</code> when the byte size is zero which I think would also be reasonable.</p>
</blockquote>



<a name="483805033"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%239620%20Add%20HostAlignedByteCount%20to%20enforce%20a.../near/483805033" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.239620.20Add.20HostAlignedByteCount.20to.20enforce.20a.2E.2E.2E.html#483805033">(Nov 21 2024 at 23:03)</a>:</h4>
<p>sunshowers submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/9620#pullrequestreview-2452976969">PR review</a>.</p>



<a name="483805034"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%239620%20Add%20HostAlignedByteCount%20to%20enforce%20a.../near/483805034" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.239620.20Add.20HostAlignedByteCount.20to.20enforce.20a.2E.2E.2E.html#483805034">(Nov 21 2024 at 23:03)</a>:</h4>
<p>sunshowers created <a href="https://github.com/bytecodealliance/wasmtime/pull/9620#discussion_r1853062478">PR review comment</a>:</p>
<blockquote>
<p>Oh that's terrifying -- I'm going to fix this (probably by making <code>make_accessible</code> ignore zero-sized regions) and go through this code again to make sure I didn't miss any other sign changes. Thanks for diagnosing this!</p>
</blockquote>



<a name="483811176"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%239620%20Add%20HostAlignedByteCount%20to%20enforce%20a.../near/483811176" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.239620.20Add.20HostAlignedByteCount.20to.20enforce.20a.2E.2E.2E.html#483811176">(Nov 22 2024 at 00:00)</a>:</h4>
<p>sunshowers updated <a href="https://github.com/bytecodealliance/wasmtime/pull/9620">PR #9620</a>.</p>



<a name="483811809"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%239620%20Add%20HostAlignedByteCount%20to%20enforce%20a.../near/483811809" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.239620.20Add.20HostAlignedByteCount.20to.20enforce.20a.2E.2E.2E.html#483811809">(Nov 22 2024 at 00:04)</a>:</h4>
<p>sunshowers created <a href="https://github.com/bytecodealliance/wasmtime/pull/9620#discussion_r1853103224">PR review comment</a>:</p>
<blockquote>
<p>Made <code>make_accessible</code> a no-op on zero-length allocations, as well as the other mprotect calls (<code>make_executable</code> and <code>make_readonly</code>). They also had this as a lurking bug because they had assertions that <code>range.start &lt;= range.end</code>, not <code>range.start &lt; range.end</code>.</p>
<p>I've also added tests for zero-length calls, and re-reviewed everything -- didn't see any other changes.</p>
</blockquote>



<a name="483811810"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%239620%20Add%20HostAlignedByteCount%20to%20enforce%20a.../near/483811810" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.239620.20Add.20HostAlignedByteCount.20to.20enforce.20a.2E.2E.2E.html#483811810">(Nov 22 2024 at 00:04)</a>:</h4>
<p>sunshowers submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/9620#pullrequestreview-2453035773">PR review</a>.</p>



<a name="483811846"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%239620%20Add%20HostAlignedByteCount%20to%20enforce%20a.../near/483811846" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.239620.20Add.20HostAlignedByteCount.20to.20enforce.20a.2E.2E.2E.html#483811846">(Nov 22 2024 at 00:05)</a>:</h4>
<p>sunshowers edited <a href="https://github.com/bytecodealliance/wasmtime/pull/9620#discussion_r1853103224">PR review comment</a>.</p>



<a name="483815292"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%239620%20Add%20HostAlignedByteCount%20to%20enforce%20a.../near/483815292" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.239620.20Add.20HostAlignedByteCount.20to.20enforce.20a.2E.2E.2E.html#483815292">(Nov 22 2024 at 00:39)</a>:</h4>
<p>alexcrichton merged <a href="https://github.com/bytecodealliance/wasmtime/pull/9620">PR #9620</a>.</p>



<hr><p>Last updated: Jan 20 2025 at 06:04 UTC</p>
</html>