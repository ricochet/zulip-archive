<html>
<head><meta charset="utf-8"><title>wasmtime / Issue #2806 Fully support multiple returns in ... · git-wasmtime · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/index.html">git-wasmtime</a></h2>
<h3>Topic: <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20Issue.20.232806.20Fully.20support.20multiple.20returns.20in.20.2E.2E.2E.html">wasmtime / Issue #2806 Fully support multiple returns in ...</a></h3>

<hr>

<base href="https://bytecodealliance.zulipchat.com">

<head><link href="https://bytecodealliance.github.io/zulip-archive/style.css" rel="stylesheet"></head>

<a name="233214681"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20Issue%20%232806%20Fully%20support%20multiple%20returns%20in%20.../near/233214681" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20Issue.20.232806.20Fully.20support.20multiple.20returns.20in.20.2E.2E.2E.html#233214681">(Apr 05 2021 at 19:03)</a>:</h4>
<p>sunfishcode <a href="https://github.com/bytecodealliance/wasmtime/pull/2806#issuecomment-813579754">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/2806">Issue #2806</a>:</p>
<blockquote>
<p>If the wasm C ABI adopts multiple return values as a way to return small-ish structs, and if a hypothetical future Rust supports this when returning <code>repr(C)</code> structs to <code>extern "C"</code> functions, then we could optimize this feature without user-visible API changes, right?</p>
<p>Ah, and as a minor bikeshed, rather than "WasmtimeSystemV" and "WasmtimeFastcall", what would you think of a more explicit name, like "SingleRetSystemV" and "SingleRetFastcall" or so, to help keep it clear what its purpose is?</p>
</blockquote>



<a name="233216855"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20Issue%20%232806%20Fully%20support%20multiple%20returns%20in%20.../near/233216855" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20Issue.20.232806.20Fully.20support.20multiple.20returns.20in.20.2E.2E.2E.html#233216855">(Apr 05 2021 at 19:21)</a>:</h4>
<p>alexcrichton <a href="https://github.com/bytecodealliance/wasmtime/pull/2806#issuecomment-813591165">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/2806">Issue #2806</a>:</p>
<blockquote>
<p>Can you clarify what you mean about the wasm C ABI? The current proposed wasm-c-api <code>wasm.h</code> header file provides no way to get a natively-callable function pointer which exposes ABI details, that's all internal to the engine. Currently we have no support to do so in the wasmtime extensions either afaik.</p>
<p>For the naming bits, I would personally think that we should probably keep "wasmtime" in the name to give ourselves the liberty to easily change it in the future. For example baldrdash has a whole bunch of custom conventions and such throughout cranelift, and I could imagine us wanting to add something like that for wasmtime in the future to optimize various bits and pieces here and there.</p>
</blockquote>



<a name="233217975"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20Issue%20%232806%20Fully%20support%20multiple%20returns%20in%20.../near/233217975" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20Issue.20.232806.20Fully.20support.20multiple.20returns.20in.20.2E.2E.2E.html#233217975">(Apr 05 2021 at 19:30)</a>:</h4>
<p>sunfishcode <a href="https://github.com/bytecodealliance/wasmtime/pull/2806#issuecomment-813599070">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/2806">Issue #2806</a>:</p>
<blockquote>
<p>Ah, I meant <a href="https://github.com/WebAssembly/tool-conventions/blob/master/BasicCABI.md">the toolchain C ABI</a> used by clang, where we've talked about adding multi-value for small structs once it's sufficiently supported in engines.</p>
<p>If WasmtimeSystemV etc. are meant to adapt to other Wasmtime needs in the future, should we document that they aren't ABI-stable, similar to Fast and Cold?</p>
</blockquote>



<a name="233219203"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20Issue%20%232806%20Fully%20support%20multiple%20returns%20in%20.../near/233219203" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20Issue.20.232806.20Fully.20support.20multiple.20returns.20in.20.2E.2E.2E.html#233219203">(Apr 05 2021 at 19:40)</a>:</h4>
<p>alexcrichton <a href="https://github.com/bytecodealliance/wasmtime/pull/2806#issuecomment-813606194">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/2806">Issue #2806</a>:</p>
<blockquote>
<p>Ah I see! I think, yes, we're able to optimize this in the future without any user-visible changes. We don't expose anything about the ABI details from the <code>wasmtime</code> crate today (intentionally). We're limited in that we have to be able to define all wasm signatures as mapping to a particular Rust signature (which we previously weren't able to do so), but beyond that we can do whatever we want to the internals of the ABI.</p>
<p>And sure, I can document that these are unstable ABIs.</p>
</blockquote>



<a name="233221816"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20Issue%20%232806%20Fully%20support%20multiple%20returns%20in%20.../near/233221816" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20Issue.20.232806.20Fully.20support.20multiple.20returns.20in.20.2E.2E.2E.html#233221816">(Apr 05 2021 at 20:02)</a>:</h4>
<p>github-actions[bot] <a href="https://github.com/bytecodealliance/wasmtime/pull/2806#issuecomment-813617407">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/2806">Issue #2806</a>:</p>
<blockquote>
<h4>Subscribe to Label Action</h4>
<p>cc @peterhuene</p>
<p>&lt;details&gt;<br>
This issue or pull request has been labeled: "cranelift", "cranelift:area:aarch64", "cranelift:area:machinst", "cranelift:area:x64", "cranelift:wasm", "lightbeam", "wasmtime:api"</p>
<p>Thus the following users have been cc'd because of the following labels:</p>
<ul>
<li>peterhuene: wasmtime:api</li>
</ul>
<p>To subscribe or unsubscribe from this label, edit the &lt;code&gt;.github/subscribe-to-label.json&lt;/code&gt; configuration file.</p>
<p><a href="https://github.com/bytecodealliance/subscribe-to-label-action">Learn more.</a><br>
&lt;/details&gt;</p>
</blockquote>



<a name="233382710"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20Issue%20%232806%20Fully%20support%20multiple%20returns%20in%20.../near/233382710" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20Issue.20.232806.20Fully.20support.20multiple.20returns.20in.20.2E.2E.2E.html#233382710">(Apr 06 2021 at 20:25)</a>:</h4>
<p>alexcrichton <a href="https://github.com/bytecodealliance/wasmtime/pull/2806#issuecomment-814415982">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/2806">Issue #2806</a>:</p>
<blockquote>
<p>Ok I think I got everything working now! Since it was a very recent change, @cfallin can you confirm you saw <a href="https://github.com/bytecodealliance/wasmtime/pull/2806/commits/95f86be431557253e41baaef0da68ccf0b3bc0fd">https://github.com/bytecodealliance/wasmtime/pull/2806/commits/95f86be431557253e41baaef0da68ccf0b3bc0fd</a>? That was necessary to fix some segfaults that were cropping up on windows since the 4-byte return values were getting stored as 8-byte results. The comment there makes me suspicious though...</p>
<p>I made a stab at getting this implemented in the old backend but I ended up giving up. The old backend implements multi-value returns very differently than the new backend. The old backend spills everything to the stack if it doesn't all fit in registers, which isn't the behavior that we want here (one in registers everything else on the stack). I couldn't figure out how to update the old backend to do this but I figured it wasn't really that necessary. I just removed some trait impls for the old backend in the <code>wasmtime</code> crate so <code>wasmtime</code> is still usable but won't have some abilities. (technically not a valid use of Cargo features but who's enabling the feature anyway?)</p>
<p>I'll tag @peterhuene for the review of the wasmtime bits, thanks for looking at the Cranelift bits @cfallin!</p>
</blockquote>



<a name="233388098"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20Issue%20%232806%20Fully%20support%20multiple%20returns%20in%20.../near/233388098" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20Issue.20.232806.20Fully.20support.20multiple.20returns.20in.20.2E.2E.2E.html#233388098">(Apr 06 2021 at 21:01)</a>:</h4>
<p>cfallin <a href="https://github.com/bytecodealliance/wasmtime/pull/2806#issuecomment-814437743">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/2806">Issue #2806</a>:</p>
<blockquote>
<blockquote>
<p>Ok I think I got everything working now! Since it was a very recent change, @cfallin can you confirm you saw <a href="https://github.com/bytecodealliance/wasmtime/commit/95f86be431557253e41baaef0da68ccf0b3bc0fd">95f86be</a>? That was necessary to fix some segfaults that were cropping up on windows since the 4-byte return values were getting stored as 8-byte results. The comment there makes me suspicious though...</p>
</blockquote>
<p>That was indeed a suspicious comment. I am not sure exactly what the original intent was but I double-checked just now that this <code>store</code> helper is not being used to codegen stores; those directly produce correctly-sized instructions. I suspect this originally came from spill/reload helpers in which case "always spill/reload the full reg" is a reasonable conservative approach but even then we have the invariant that upper bits (beyond a type's width) in a register are undefined and extended when needed by an op so this should be fine I think. Thanks for calling it out!</p>
</blockquote>



<a name="233514178"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20Issue%20%232806%20Fully%20support%20multiple%20returns%20in%20.../near/233514178" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20Issue.20.232806.20Fully.20support.20multiple.20returns.20in.20.2E.2E.2E.html#233514178">(Apr 07 2021 at 15:48)</a>:</h4>
<p>alexcrichton <a href="https://github.com/bytecodealliance/wasmtime/pull/2806#issuecomment-815022441">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/2806">Issue #2806</a>:</p>
<blockquote>
<p>I was a little worried about the unwind info myself (and kept switching it back and forth from <code>Fast</code> to the default to see if it ever fixed failing tests, it never did). In the <a href="https://github.com/bytecodealliance/wasmtime/blob/main/tests/all/traps.rs">traps tests though</a> we do have a number of tests already with "internal" wasm function frames on the stack (such as <a href="https://github.com/bytecodealliance/wasmtime/blob/main/tests/all/traps.rs#L365-L398">this one</a>) so I think we're at least covering the basics of representing unwind information for varying abis. I'm not sure if this is guaranteed to work in the limit, though.</p>
<p>@cfallin also were you thinking of more than the tests I added in <a href="https://github.com/bytecodealliance/wasmtime/pull/2806/commits/5962d4c9118a8816afdfaa0a8a70f854d2ba60ab">https://github.com/bytecodealliance/wasmtime/pull/2806/commits/5962d4c9118a8816afdfaa0a8a70f854d2ba60ab</a>? I tried to break things in various ways but I think it all seems to be working pretty well so far at least.</p>
</blockquote>



<a name="233515006"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20Issue%20%232806%20Fully%20support%20multiple%20returns%20in%20.../near/233515006" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20Issue.20.232806.20Fully.20support.20multiple.20returns.20in.20.2E.2E.2E.html#233515006">(Apr 07 2021 at 15:53)</a>:</h4>
<p>cfallin <a href="https://github.com/bytecodealliance/wasmtime/pull/2806#issuecomment-815026295">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/2806">Issue #2806</a>:</p>
<blockquote>
<blockquote>
<p>@cfallin also were you thinking of more than the tests I added in <a href="https://github.com/bytecodealliance/wasmtime/commit/5962d4c9118a8816afdfaa0a8a70f854d2ba60ab">5962d4c</a>? I tried to break things in various ways but I think it all seems to be working pretty well so far at least.</p>
</blockquote>
<p>@alexcrichton That's very thorough, thanks!</p>
<p>I may be missing something but I don't see any <code>wasmtime_system_v</code> or <code>wasmtime_fastcall</code> signatures -- my main concern was the interleaving of those with externally-usable ABIs. I think it may be enough to just do a <code>wasmtime_system_v</code> + <code>system_v</code> set of tests instead of the SysV/Fastcall combos you have in that file now. Thanks!</p>
</blockquote>



<a name="233530689"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20Issue%20%232806%20Fully%20support%20multiple%20returns%20in%20.../near/233530689" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20Issue.20.232806.20Fully.20support.20multiple.20returns.20in.20.2E.2E.2E.html#233530689">(Apr 07 2021 at 17:34)</a>:</h4>
<p>alexcrichton <a href="https://github.com/bytecodealliance/wasmtime/pull/2806#issuecomment-815095802">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/2806">Issue #2806</a>:</p>
<blockquote>
<p>Ok I've managed to get all tests green and I think I've got all the various tests here in place. It's of course always easy though to use the same abi everywhere if any issues arise, but I'm gonna go ahead and merge this. If there are more tests desired though I'm happy to add some!</p>
</blockquote>



<a name="234728789"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20Issue%20%232806%20Fully%20support%20multiple%20returns%20in%20.../near/234728789" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20Issue.20.232806.20Fully.20support.20multiple.20returns.20in.20.2E.2E.2E.html#234728789">(Apr 15 2021 at 18:30)</a>:</h4>
<p>bnjbvr <a href="https://github.com/bytecodealliance/wasmtime/pull/2806#issuecomment-820643560">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/2806">Issue #2806</a>:</p>
<blockquote>
<p>Just a note for future reference that this commit has also caused another regression on our side, causing stack overflows on Windows in async tests. I unfortunately don't have more to share, because debugging doesn't work reliably: the called wasm function panics (which is the subject of the test, so it's supposed to do so). When running in the VSCode debugger I hit SIGILL and then the program aborts, while running outside of a debugger there's a stack overflow somewhere. I haven't managed to make an isolated test case either, since I don't have any clues about what's causing the failure.</p>
</blockquote>



<hr><p>Last updated: Jan 20 2025 at 06:04 UTC</p>
</html>