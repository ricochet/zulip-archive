<html>
<head><meta charset="utf-8"><title>wasmtime / PR #1443 Make Handle a trait required for any ... · git-wasmtime · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/index.html">git-wasmtime</a></h2>
<h3>Topic: <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231443.20Make.20Handle.20a.20trait.20required.20for.20any.20.2E.2E.2E.html">wasmtime / PR #1443 Make Handle a trait required for any ...</a></h3>

<hr>

<base href="https://bytecodealliance.zulipchat.com">

<head><link href="https://bytecodealliance.github.io/zulip-archive/style.css" rel="stylesheet"></head>

<a name="192406528"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231443%20Make%20Handle%20a%20trait%20required%20for%20any%20.../near/192406528" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231443.20Make.20Handle.20a.20trait.20required.20for.20any.20.2E.2E.2E.html#192406528">(Mar 31 2020 at 15:36)</a>:</h4>
<p>kubkon opened <a href="https://github.com/bytecodealliance/wasmtime/pull/1443" title="https://github.com/bytecodealliance/wasmtime/pull/1443">PR #1443</a> from <code>yacc</code> to <code>master</code>:</p>
<blockquote>
<p>OK, so this PR is a bit of an experiment that came about somewhat itself<br>
when I was looking at refactoring use of <code>Rc&lt;RefCell&lt;Descriptor&gt;&gt;</code> inside<br>
<code>Entry</code> struct. I've noticed that since we've placed <code>VirtualFile</code> on the<br>
same level as <code>OsHandle</code> and <code>Stdin</code> etc., we've ended up necessiitating<br>
checks for different combinations such as "is a real OS resource being mixed<br>
up with a virtual resource?", and if that was the case, we'd panic since<br>
this was clearly not allowed (e.g., symlinking, or worse renaming).<br>
Therefore, it seemed natural for virtual file to be on the same level<br>
as _any_ OS handle (regardless of whether it's an actual file, socket,<br>
or stdio handle). In other words, we should ideally envision the following<br>
hierarchy:</p>
<div class="codehilite"><pre><span></span>\-- OsHandle \-- OsFile
              -- Stdio
\-- Virtual
</pre></div>


<p>This way, we can deal with the mix up at a level above which cleans up<br>
our logic significantly.</p>
<p>On the other hand, when looking through the <code>virtfs</code>, the trait approach<br>
to some type that's a valid <code>Handle</code> grew on me, and I think this<br>
is the way to go. And this is what this PR is proposing, a trait<br>
<code>Handle</code> which features enough functionality to make both virtual and<br>
OS ops to work. Now, inside <code>Entry</code> we can safely store something like<br>
<code>Rc&lt;dyn Handle&gt;</code> where <code>Handle</code> can downcast to either <code>VirtualFile</code> or<br>
<code>VirtualDir</code>, or <code>OsHandle</code> if its an actual OS resource. Note that<br>
I've left <code>Handle</code> as one massive trait, but I reckon we could split<br>
it up into several smaller traits, each dealing with some bit of WASI<br>
functionality. I'm hoping this would perhaps make it easier to figure<br>
out polyfilling between snapshots and the new upcoming ephemeral<br>
snapshot since a lot of boilerplate functionality is now done as part<br>
of the <code>Handle</code> trait implementation.</p>
<p>Next, I've redone the original <code>OsHandle</code> to be an <code>OsFile</code> which<br>
now stores a raw descriptor/handle (<code>RawFd</code>/<code>RawHandle</code>) inside a<br>
<code>Cell</code> so that we can handle interior mutability in an easy (read,<br>
non-panicky) way. In order not to lose the perks of derefercing to<br>
<code>std::fs::File</code>, I've added a convenience trait <code>AsFile</code> which<br>
will take <code>OsFile</code> by reference (or the stdio handles) and create<br>
a non-owned <code>ManuallyDrop&lt;File&gt;</code> resource which can be passed around<br>
and acted upon the way we'd normally do on <code>&amp;File</code>. This change of<br>
course implies that we now have to worry about properly closing all<br>
OS resources stored as part of <code>OsFile</code>, thus this type now implements<br>
<code>Drop</code> trait which essentially speaking moves the raw descriptor/handle<br>
into a <code>File</code> and drops it.</p>
<p>Finally, I've redone setting time info on relative paths on *nix using<br>
the same approach as advocated in the virtual fs. Namely, we do an<br>
<code>openat</code> followed by <code>filestat_set_times</code> on the obtained descriptor.<br>
This effectively removes the need for custom <code>filetime</code> module in<br>
<code>yanix</code>. However, this does probably incur additional cost of at least<br>
one additional syscall, and I haven't checked whether this approach<br>
performs as expected on platforms such as NixOS which as far as I remember<br>
had some weirdness todo with linking <code>utimensat</code> symbols, etc. Still,<br>
this change is worth considering given that the implementation of<br>
<code>path_filestat_set_times</code> cleans up a lot, albeit with some additional<br>
cost.</p>
<p>Anyhow, lemme y'all know what you think!</p>
<p>PS, if anybody is wondering why the incoming branch is called <code>yacc</code>,<br>
it stands for "yet another cleanup cleanup" simply because I was out<br>
of ideas...</p>
</blockquote>



<a name="192406586"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231443%20Make%20Handle%20a%20trait%20required%20for%20any%20.../near/192406586" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231443.20Make.20Handle.20a.20trait.20required.20for.20any.20.2E.2E.2E.html#192406586">(Mar 31 2020 at 15:36)</a>:</h4>
<p><strong>kubkon</strong> requested <a href="https://github.com/iximeow" title="https://github.com/iximeow">iximeow</a> for a review on <a href="https://github.com/bytecodealliance/wasmtime/pull/1443" title="https://github.com/bytecodealliance/wasmtime/pull/1443">PR #1443</a>.</p>



<a name="192406592"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231443%20Make%20Handle%20a%20trait%20required%20for%20any%20.../near/192406592" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231443.20Make.20Handle.20a.20trait.20required.20for.20any.20.2E.2E.2E.html#192406592">(Mar 31 2020 at 15:37)</a>:</h4>
<p><strong>kubkon</strong> requested <a href="https://github.com/sunfishcode" title="https://github.com/sunfishcode">sunfishcode</a> and <a href="https://github.com/iximeow" title="https://github.com/iximeow">iximeow</a> for a review on <a href="https://github.com/bytecodealliance/wasmtime/pull/1443" title="https://github.com/bytecodealliance/wasmtime/pull/1443">PR #1443</a>.</p>



<a name="192406604"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231443%20Make%20Handle%20a%20trait%20required%20for%20any%20.../near/192406604" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231443.20Make.20Handle.20a.20trait.20required.20for.20any.20.2E.2E.2E.html#192406604">(Mar 31 2020 at 15:37)</a>:</h4>
<p>kubkon assigned <a href="https://github.com/bytecodealliance/wasmtime/pull/1443" title="https://github.com/bytecodealliance/wasmtime/pull/1443">PR #1443</a> to alexcrichton.</p>



<a name="192406636"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231443%20Make%20Handle%20a%20trait%20required%20for%20any%20.../near/192406636" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231443.20Make.20Handle.20a.20trait.20required.20for.20any.20.2E.2E.2E.html#192406636">(Mar 31 2020 at 15:37)</a>:</h4>
<p>kubkon unassigned <a href="https://github.com/bytecodealliance/wasmtime/pull/1443" title="https://github.com/bytecodealliance/wasmtime/pull/1443">PR #1443</a> to alexcrichton.</p>



<a name="192406651"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231443%20Make%20Handle%20a%20trait%20required%20for%20any%20.../near/192406651" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231443.20Make.20Handle.20a.20trait.20required.20for.20any.20.2E.2E.2E.html#192406651">(Mar 31 2020 at 15:37)</a>:</h4>
<p><strong>kubkon</strong> requested <a href="https://github.com/alexcrichton" title="https://github.com/alexcrichton">alexcrichton</a>, <a href="https://github.com/sunfishcode" title="https://github.com/sunfishcode">sunfishcode</a> and <a href="https://github.com/iximeow" title="https://github.com/iximeow">iximeow</a> for a review on <a href="https://github.com/bytecodealliance/wasmtime/pull/1443" title="https://github.com/bytecodealliance/wasmtime/pull/1443">PR #1443</a>.</p>



<a name="192418665"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231443%20Make%20Handle%20a%20trait%20required%20for%20any%20.../near/192418665" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231443.20Make.20Handle.20a.20trait.20required.20for.20any.20.2E.2E.2E.html#192418665">(Mar 31 2020 at 17:01)</a>:</h4>
<p>kubkon updated <a href="https://github.com/bytecodealliance/wasmtime/pull/1443" title="https://github.com/bytecodealliance/wasmtime/pull/1443">PR #1443</a> from <code>yacc</code> to <code>master</code>:</p>
<blockquote>
<p>OK, so this PR is a bit of an experiment that came about somewhat itself<br>
when I was looking at refactoring use of <code>Rc&lt;RefCell&lt;Descriptor&gt;&gt;</code> inside<br>
<code>Entry</code> struct. I've noticed that since we've placed <code>VirtualFile</code> on the<br>
same level as <code>OsHandle</code> and <code>Stdin</code> etc., we've ended up necessiitating<br>
checks for different combinations such as "is a real OS resource being mixed<br>
up with a virtual resource?", and if that was the case, we'd panic since<br>
this was clearly not allowed (e.g., symlinking, or worse renaming).<br>
Therefore, it seemed natural for virtual file to be on the same level<br>
as _any_ OS handle (regardless of whether it's an actual file, socket,<br>
or stdio handle). In other words, we should ideally envision the following<br>
hierarchy:</p>
<div class="codehilite"><pre><span></span>\-- OsHandle \-- OsFile
              -- Stdio
\-- Virtual
</pre></div>


<p>This way, we can deal with the mix up at a level above which cleans up<br>
our logic significantly.</p>
<p>On the other hand, when looking through the <code>virtfs</code>, the trait approach<br>
to some type that's a valid <code>Handle</code> grew on me, and I think this<br>
is the way to go. And this is what this PR is proposing, a trait<br>
<code>Handle</code> which features enough functionality to make both virtual and<br>
OS ops to work. Now, inside <code>Entry</code> we can safely store something like<br>
<code>Rc&lt;dyn Handle&gt;</code> where <code>Handle</code> can downcast to either <code>VirtualFile</code> or<br>
<code>VirtualDir</code>, or <code>OsHandle</code> if its an actual OS resource. Note that<br>
I've left <code>Handle</code> as one massive trait, but I reckon we could split<br>
it up into several smaller traits, each dealing with some bit of WASI<br>
functionality. I'm hoping this would perhaps make it easier to figure<br>
out polyfilling between snapshots and the new upcoming ephemeral<br>
snapshot since a lot of boilerplate functionality is now done as part<br>
of the <code>Handle</code> trait implementation.</p>
<p>Next, I've redone the original <code>OsHandle</code> to be an <code>OsFile</code> which<br>
now stores a raw descriptor/handle (<code>RawFd</code>/<code>RawHandle</code>) inside a<br>
<code>Cell</code> so that we can handle interior mutability in an easy (read,<br>
non-panicky) way. In order not to lose the perks of derefercing to<br>
<code>std::fs::File</code>, I've added a convenience trait <code>AsFile</code> which<br>
will take <code>OsFile</code> by reference (or the stdio handles) and create<br>
a non-owned <code>ManuallyDrop&lt;File&gt;</code> resource which can be passed around<br>
and acted upon the way we'd normally do on <code>&amp;File</code>. This change of<br>
course implies that we now have to worry about properly closing all<br>
OS resources stored as part of <code>OsFile</code>, thus this type now implements<br>
<code>Drop</code> trait which essentially speaking moves the raw descriptor/handle<br>
into a <code>File</code> and drops it.</p>
<p>Finally, I've redone setting time info on relative paths on *nix using<br>
the same approach as advocated in the virtual fs. Namely, we do an<br>
<code>openat</code> followed by <code>filestat_set_times</code> on the obtained descriptor.<br>
This effectively removes the need for custom <code>filetime</code> module in<br>
<code>yanix</code>. However, this does probably incur additional cost of at least<br>
one additional syscall, and I haven't checked whether this approach<br>
performs as expected on platforms such as NixOS which as far as I remember<br>
had some weirdness todo with linking <code>utimensat</code> symbols, etc. Still,<br>
this change is worth considering given that the implementation of<br>
<code>path_filestat_set_times</code> cleans up a lot, albeit with some additional<br>
cost.</p>
<p>Anyhow, lemme y'all know what you think!</p>
<p>PS, if anybody is wondering why the incoming branch is called <code>yacc</code>,<br>
it stands for "yet another cleanup cleanup" simply because I was out<br>
of ideas...</p>
</blockquote>



<a name="192489941"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231443%20Make%20Handle%20a%20trait%20required%20for%20any%20.../near/192489941" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231443.20Make.20Handle.20a.20trait.20required.20for.20any.20.2E.2E.2E.html#192489941">(Apr 01 2020 at 07:06)</a>:</h4>
<p>kubkon updated <a href="https://github.com/bytecodealliance/wasmtime/pull/1443" title="https://github.com/bytecodealliance/wasmtime/pull/1443">PR #1443</a> from <code>yacc</code> to <code>master</code>:</p>
<blockquote>
<p>OK, so this PR is a bit of an experiment that came about somewhat itself<br>
when I was looking at refactoring use of <code>Rc&lt;RefCell&lt;Descriptor&gt;&gt;</code> inside<br>
<code>Entry</code> struct. I've noticed that since we've placed <code>VirtualFile</code> on the<br>
same level as <code>OsHandle</code> and <code>Stdin</code> etc., we've ended up necessiitating<br>
checks for different combinations such as "is a real OS resource being mixed<br>
up with a virtual resource?", and if that was the case, we'd panic since<br>
this was clearly not allowed (e.g., symlinking, or worse renaming).<br>
Therefore, it seemed natural for virtual file to be on the same level<br>
as _any_ OS handle (regardless of whether it's an actual file, socket,<br>
or stdio handle). In other words, we should ideally envision the following<br>
hierarchy:</p>
<div class="codehilite"><pre><span></span>\-- OsHandle \-- OsFile
              -- Stdio
\-- Virtual
</pre></div>


<p>This way, we can deal with the mix up at a level above which cleans up<br>
our logic significantly.</p>
<p>On the other hand, when looking through the <code>virtfs</code>, the trait approach<br>
to some type that's a valid <code>Handle</code> grew on me, and I think this<br>
is the way to go. And this is what this PR is proposing, a trait<br>
<code>Handle</code> which features enough functionality to make both virtual and<br>
OS ops to work. Now, inside <code>Entry</code> we can safely store something like<br>
<code>Rc&lt;dyn Handle&gt;</code> where <code>Handle</code> can downcast to either <code>VirtualFile</code> or<br>
<code>VirtualDir</code>, or <code>OsHandle</code> if its an actual OS resource. Note that<br>
I've left <code>Handle</code> as one massive trait, but I reckon we could split<br>
it up into several smaller traits, each dealing with some bit of WASI<br>
functionality. I'm hoping this would perhaps make it easier to figure<br>
out polyfilling between snapshots and the new upcoming ephemeral<br>
snapshot since a lot of boilerplate functionality is now done as part<br>
of the <code>Handle</code> trait implementation.</p>
<p>Next, I've redone the original <code>OsHandle</code> to be an <code>OsFile</code> which<br>
now stores a raw descriptor/handle (<code>RawFd</code>/<code>RawHandle</code>) inside a<br>
<code>Cell</code> so that we can handle interior mutability in an easy (read,<br>
non-panicky) way. In order not to lose the perks of derefercing to<br>
<code>std::fs::File</code>, I've added a convenience trait <code>AsFile</code> which<br>
will take <code>OsFile</code> by reference (or the stdio handles) and create<br>
a non-owned <code>ManuallyDrop&lt;File&gt;</code> resource which can be passed around<br>
and acted upon the way we'd normally do on <code>&amp;File</code>. This change of<br>
course implies that we now have to worry about properly closing all<br>
OS resources stored as part of <code>OsFile</code>, thus this type now implements<br>
<code>Drop</code> trait which essentially speaking moves the raw descriptor/handle<br>
into a <code>File</code> and drops it.</p>
<p>Finally, I've redone setting time info on relative paths on *nix using<br>
the same approach as advocated in the virtual fs. Namely, we do an<br>
<code>openat</code> followed by <code>filestat_set_times</code> on the obtained descriptor.<br>
This effectively removes the need for custom <code>filetime</code> module in<br>
<code>yanix</code>. However, this does probably incur additional cost of at least<br>
one additional syscall, and I haven't checked whether this approach<br>
performs as expected on platforms such as NixOS which as far as I remember<br>
had some weirdness todo with linking <code>utimensat</code> symbols, etc. Still,<br>
this change is worth considering given that the implementation of<br>
<code>path_filestat_set_times</code> cleans up a lot, albeit with some additional<br>
cost.</p>
<p>Anyhow, lemme y'all know what you think!</p>
<p>PS, if anybody is wondering why the incoming branch is called <code>yacc</code>,<br>
it stands for "yet another cleanup cleanup" simply because I was out<br>
of ideas...</p>
</blockquote>



<a name="192568717"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231443%20Make%20Handle%20a%20trait%20required%20for%20any%20.../near/192568717" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231443.20Make.20Handle.20a.20trait.20required.20for.20any.20.2E.2E.2E.html#192568717">(Apr 01 2020 at 18:02)</a>:</h4>
<p>pchickey submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/1443#pullrequestreview-385823249" title="https://github.com/bytecodealliance/wasmtime/pull/1443#pullrequestreview-385823249">PR Review</a>.</p>



<a name="192568719"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231443%20Make%20Handle%20a%20trait%20required%20for%20any%20.../near/192568719" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231443.20Make.20Handle.20a.20trait.20required.20for.20any.20.2E.2E.2E.html#192568719">(Apr 01 2020 at 18:02)</a>:</h4>
<p>pchickey submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/1443#pullrequestreview-385823249" title="https://github.com/bytecodealliance/wasmtime/pull/1443#pullrequestreview-385823249">PR Review</a>.</p>



<a name="192568720"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231443%20Make%20Handle%20a%20trait%20required%20for%20any%20.../near/192568720" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231443.20Make.20Handle.20a.20trait.20required.20for.20any.20.2E.2E.2E.html#192568720">(Apr 01 2020 at 18:02)</a>:</h4>
<p>pchickey created <a href="https://github.com/bytecodealliance/wasmtime/pull/1443#discussion_r401806326" title="https://github.com/bytecodealliance/wasmtime/pull/1443#discussion_r401806326">PR Review Comment</a>:</p>
<blockquote>
<p>left in some commented out debugs here and just below</p>
</blockquote>



<a name="192596125"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231443%20Make%20Handle%20a%20trait%20required%20for%20any%20.../near/192596125" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231443.20Make.20Handle.20a.20trait.20required.20for.20any.20.2E.2E.2E.html#192596125">(Apr 01 2020 at 21:37)</a>:</h4>
<p>alexcrichton submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/1443#pullrequestreview-385967484" title="https://github.com/bytecodealliance/wasmtime/pull/1443#pullrequestreview-385967484">PR Review</a>.</p>



<a name="193068624"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231443%20Make%20Handle%20a%20trait%20required%20for%20any%20.../near/193068624" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231443.20Make.20Handle.20a.20trait.20required.20for.20any.20.2E.2E.2E.html#193068624">(Apr 06 2020 at 16:43)</a>:</h4>
<p>kubkon updated <a href="https://github.com/bytecodealliance/wasmtime/pull/1443" title="https://github.com/bytecodealliance/wasmtime/pull/1443">PR #1443</a> from <code>yacc</code> to <code>master</code>:</p>
<blockquote>
<p>OK, so this PR is a bit of an experiment that came about somewhat itself<br>
when I was looking at refactoring use of <code>Rc&lt;RefCell&lt;Descriptor&gt;&gt;</code> inside<br>
<code>Entry</code> struct. I've noticed that since we've placed <code>VirtualFile</code> on the<br>
same level as <code>OsHandle</code> and <code>Stdin</code> etc., we've ended up necessiitating<br>
checks for different combinations such as "is a real OS resource being mixed<br>
up with a virtual resource?", and if that was the case, we'd panic since<br>
this was clearly not allowed (e.g., symlinking, or worse renaming).<br>
Therefore, it seemed natural for virtual file to be on the same level<br>
as _any_ OS handle (regardless of whether it's an actual file, socket,<br>
or stdio handle). In other words, we should ideally envision the following<br>
hierarchy:</p>
<div class="codehilite"><pre><span></span>\-- OsHandle \-- OsFile
              -- Stdio
\-- Virtual
</pre></div>


<p>This way, we can deal with the mix up at a level above which cleans up<br>
our logic significantly.</p>
<p>On the other hand, when looking through the <code>virtfs</code>, the trait approach<br>
to some type that's a valid <code>Handle</code> grew on me, and I think this<br>
is the way to go. And this is what this PR is proposing, a trait<br>
<code>Handle</code> which features enough functionality to make both virtual and<br>
OS ops to work. Now, inside <code>Entry</code> we can safely store something like<br>
<code>Rc&lt;dyn Handle&gt;</code> where <code>Handle</code> can downcast to either <code>VirtualFile</code> or<br>
<code>VirtualDir</code>, or <code>OsHandle</code> if its an actual OS resource. Note that<br>
I've left <code>Handle</code> as one massive trait, but I reckon we could split<br>
it up into several smaller traits, each dealing with some bit of WASI<br>
functionality. I'm hoping this would perhaps make it easier to figure<br>
out polyfilling between snapshots and the new upcoming ephemeral<br>
snapshot since a lot of boilerplate functionality is now done as part<br>
of the <code>Handle</code> trait implementation.</p>
<p>Next, I've redone the original <code>OsHandle</code> to be an <code>OsFile</code> which<br>
now stores a raw descriptor/handle (<code>RawFd</code>/<code>RawHandle</code>) inside a<br>
<code>Cell</code> so that we can handle interior mutability in an easy (read,<br>
non-panicky) way. In order not to lose the perks of derefercing to<br>
<code>std::fs::File</code>, I've added a convenience trait <code>AsFile</code> which<br>
will take <code>OsFile</code> by reference (or the stdio handles) and create<br>
a non-owned <code>ManuallyDrop&lt;File&gt;</code> resource which can be passed around<br>
and acted upon the way we'd normally do on <code>&amp;File</code>. This change of<br>
course implies that we now have to worry about properly closing all<br>
OS resources stored as part of <code>OsFile</code>, thus this type now implements<br>
<code>Drop</code> trait which essentially speaking moves the raw descriptor/handle<br>
into a <code>File</code> and drops it.</p>
<p>Finally, I've redone setting time info on relative paths on *nix using<br>
the same approach as advocated in the virtual fs. Namely, we do an<br>
<code>openat</code> followed by <code>filestat_set_times</code> on the obtained descriptor.<br>
This effectively removes the need for custom <code>filetime</code> module in<br>
<code>yanix</code>. However, this does probably incur additional cost of at least<br>
one additional syscall, and I haven't checked whether this approach<br>
performs as expected on platforms such as NixOS which as far as I remember<br>
had some weirdness todo with linking <code>utimensat</code> symbols, etc. Still,<br>
this change is worth considering given that the implementation of<br>
<code>path_filestat_set_times</code> cleans up a lot, albeit with some additional<br>
cost.</p>
<p>Anyhow, lemme y'all know what you think!</p>
<p>PS, if anybody is wondering why the incoming branch is called <code>yacc</code>,<br>
it stands for "yet another cleanup cleanup" simply because I was out<br>
of ideas...</p>
</blockquote>



<a name="193105754"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231443%20Make%20Handle%20a%20trait%20required%20for%20any%20.../near/193105754" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231443.20Make.20Handle.20a.20trait.20required.20for.20any.20.2E.2E.2E.html#193105754">(Apr 06 2020 at 21:42)</a>:</h4>
<p>iximeow submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/1443#pullrequestreview-388557371" title="https://github.com/bytecodealliance/wasmtime/pull/1443#pullrequestreview-388557371">PR Review</a>.</p>



<a name="193105762"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231443%20Make%20Handle%20a%20trait%20required%20for%20any%20.../near/193105762" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231443.20Make.20Handle.20a.20trait.20required.20for.20any.20.2E.2E.2E.html#193105762">(Apr 06 2020 at 21:42)</a>:</h4>
<p>iximeow submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/1443#pullrequestreview-388557371" title="https://github.com/bytecodealliance/wasmtime/pull/1443#pullrequestreview-388557371">PR Review</a>.</p>



<a name="193105764"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231443%20Make%20Handle%20a%20trait%20required%20for%20any%20.../near/193105764" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231443.20Make.20Handle.20a.20trait.20required.20for.20any.20.2E.2E.2E.html#193105764">(Apr 06 2020 at 21:42)</a>:</h4>
<p>iximeow created <a href="https://github.com/bytecodealliance/wasmtime/pull/1443#discussion_r404339339" title="https://github.com/bytecodealliance/wasmtime/pull/1443#discussion_r404339339">PR Review Comment</a>:</p>
<blockquote>
<p>Why the <code>+ 'static</code> here? My understanding of the interaction between lifetimes/trait objects is kind of fuzzy, but isn't <code>'static</code> the implied default? (I'm not sure why we'd want to forbid non-<code>'static</code>, either)</p>
</blockquote>



<a name="193105766"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231443%20Make%20Handle%20a%20trait%20required%20for%20any%20.../near/193105766" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231443.20Make.20Handle.20a.20trait.20required.20for.20any.20.2E.2E.2E.html#193105766">(Apr 06 2020 at 21:42)</a>:</h4>
<p>iximeow created <a href="https://github.com/bytecodealliance/wasmtime/pull/1443#discussion_r404341365" title="https://github.com/bytecodealliance/wasmtime/pull/1443#discussion_r404341365">PR Review Comment</a>:</p>
<blockquote>
<p>What _is_ the <code>TODO</code> here? The <code>get_file_type() == Err</code> case?</p>
</blockquote>



<a name="193105767"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231443%20Make%20Handle%20a%20trait%20required%20for%20any%20.../near/193105767" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231443.20Make.20Handle.20a.20trait.20required.20for.20any.20.2E.2E.2E.html#193105767">(Apr 06 2020 at 21:42)</a>:</h4>
<p>iximeow created <a href="https://github.com/bytecodealliance/wasmtime/pull/1443#discussion_r404352910" title="https://github.com/bytecodealliance/wasmtime/pull/1443#discussion_r404352910">PR Review Comment</a>:</p>
<blockquote>
<p><code>update_from</code> on an <code>OsFile</code> that has a <code>dir</code> with <code>Some</code> would then have a stale <code>dir</code>. I'm not sure how much an issue this actually is, since we only <code>update_from</code> in <code>fdstat_set_flags</code>. Flags are on the referenced filesystem entry, not on the <code>fd</code>, right? So inconsistent flags aren't actually possible? Otherwise we might end up in a state where <code>dir</code> was populated can iterate when it shouldn't, or can't iterate when it should.</p>
<p>At the very least, if this is sound (and I suspect it is), I think it'd be good to have a comment describing why alongside this impl.</p>
</blockquote>



<a name="193105769"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231443%20Make%20Handle%20a%20trait%20required%20for%20any%20.../near/193105769" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231443.20Make.20Handle.20a.20trait.20required.20for.20any.20.2E.2E.2E.html#193105769">(Apr 06 2020 at 21:42)</a>:</h4>
<p>iximeow created <a href="https://github.com/bytecodealliance/wasmtime/pull/1443#discussion_r404368063" title="https://github.com/bytecodealliance/wasmtime/pull/1443#discussion_r404368063">PR Review Comment</a>:</p>
<blockquote>
<p><code>ReOpenFile</code> requires the file handle came from <code>CreateFile</code>, but the standard library will use <code>GetStdHandle</code> rather than <code>CreateFile("CONIN$",...</code> or <code>CONOUT$</code>. If it works I'd be a little suspect of it mysteriously breaking one day. Judging by <a href="https://github.com/rust-lang/rust/issues/40490" title="https://github.com/rust-lang/rust/issues/40490">https://github.com/rust-lang/rust/issues/40490</a> (found when looking to confirm how stdlib deals with Windows stdio) it seems pretty suspect to retain a stdio handle in the first place?</p>
<p>Nothing specific to add, just topical thought meandering, sorry <span aria-label="sweat smile" class="emoji emoji-1f605" role="img" title="sweat smile">:sweat_smile:</span> </p>
</blockquote>



<a name="193107191"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231443%20Make%20Handle%20a%20trait%20required%20for%20any%20.../near/193107191" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231443.20Make.20Handle.20a.20trait.20required.20for.20any.20.2E.2E.2E.html#193107191">(Apr 06 2020 at 21:54)</a>:</h4>
<p>pchickey submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/1443#pullrequestreview-388645847" title="https://github.com/bytecodealliance/wasmtime/pull/1443#pullrequestreview-388645847">PR Review</a>.</p>



<a name="193107192"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231443%20Make%20Handle%20a%20trait%20required%20for%20any%20.../near/193107192" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231443.20Make.20Handle.20a.20trait.20required.20for.20any.20.2E.2E.2E.html#193107192">(Apr 06 2020 at 21:54)</a>:</h4>
<p>pchickey created <a href="https://github.com/bytecodealliance/wasmtime/pull/1443#discussion_r404412061" title="https://github.com/bytecodealliance/wasmtime/pull/1443#discussion_r404412061">PR Review Comment</a>:</p>
<blockquote>
<p>That syntax threw me off when I learned it a week or two ago, it just means that the <code>Handle</code> concrete type cant have a lifetime.</p>
</blockquote>



<a name="193357987"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231443%20Make%20Handle%20a%20trait%20required%20for%20any%20.../near/193357987" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231443.20Make.20Handle.20a.20trait.20required.20for.20any.20.2E.2E.2E.html#193357987">(Apr 08 2020 at 18:13)</a>:</h4>
<p>kubkon submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/1443#pullrequestreview-390215414" title="https://github.com/bytecodealliance/wasmtime/pull/1443#pullrequestreview-390215414">PR Review</a>.</p>



<a name="193357988"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231443%20Make%20Handle%20a%20trait%20required%20for%20any%20.../near/193357988" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231443.20Make.20Handle.20a.20trait.20required.20for.20any.20.2E.2E.2E.html#193357988">(Apr 08 2020 at 18:13)</a>:</h4>
<p>kubkon created <a href="https://github.com/bytecodealliance/wasmtime/pull/1443#discussion_r405719155" title="https://github.com/bytecodealliance/wasmtime/pull/1443#discussion_r405719155">PR Review Comment</a>:</p>
<blockquote>
<p>Yep, exactly as @pchickey said. I can't foresee a situation where type that implements <code>Handle</code> wouldn't last for the entire duration of the program.</p>
</blockquote>



<a name="193358225"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231443%20Make%20Handle%20a%20trait%20required%20for%20any%20.../near/193358225" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231443.20Make.20Handle.20a.20trait.20required.20for.20any.20.2E.2E.2E.html#193358225">(Apr 08 2020 at 18:15)</a>:</h4>
<p>kubkon submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/1443#pullrequestreview-390216885" title="https://github.com/bytecodealliance/wasmtime/pull/1443#pullrequestreview-390216885">PR Review</a>.</p>



<a name="193358226"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231443%20Make%20Handle%20a%20trait%20required%20for%20any%20.../near/193358226" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231443.20Make.20Handle.20a.20trait.20required.20for.20any.20.2E.2E.2E.html#193358226">(Apr 08 2020 at 18:15)</a>:</h4>
<p>kubkon created <a href="https://github.com/bytecodealliance/wasmtime/pull/1443#discussion_r405720439" title="https://github.com/bytecodealliance/wasmtime/pull/1443#discussion_r405720439">PR Review Comment</a>:</p>
<blockquote>
<p>Oh right, I forgot to remove it. Thanks for spotting this one!</p>
</blockquote>



<a name="193359981"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231443%20Make%20Handle%20a%20trait%20required%20for%20any%20.../near/193359981" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231443.20Make.20Handle.20a.20trait.20required.20for.20any.20.2E.2E.2E.html#193359981">(Apr 08 2020 at 18:29)</a>:</h4>
<p>kubkon created <a href="https://github.com/bytecodealliance/wasmtime/pull/1443#discussion_r405728863" title="https://github.com/bytecodealliance/wasmtime/pull/1443#discussion_r405728863">PR Review Comment</a>:</p>
<blockquote>
<p>That's an excellent observation, thanks! I think adding a comment to remember about this potential issue is the best thing to do here.</p>
<p>On a related albeit somewhat different note, I'd still like to refactor how we store the <code>DIR</code> stream pointer on BSDes in <code>OsFile</code>. Having an embedded <code>Option</code> seems like a less than ideal solution to use here. I was actually thinking of splitting the type into two or possibly an enum, so that if we are dealing with a dir on BSD, we'd immediately store a valid <code>DIR</code> stream pointer. But this will be a subsequent PR :-)</p>
</blockquote>



<a name="193359982"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231443%20Make%20Handle%20a%20trait%20required%20for%20any%20.../near/193359982" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231443.20Make.20Handle.20a.20trait.20required.20for.20any.20.2E.2E.2E.html#193359982">(Apr 08 2020 at 18:29)</a>:</h4>
<p>kubkon submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/1443#pullrequestreview-390227110" title="https://github.com/bytecodealliance/wasmtime/pull/1443#pullrequestreview-390227110">PR Review</a>.</p>



<a name="193361110"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231443%20Make%20Handle%20a%20trait%20required%20for%20any%20.../near/193361110" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231443.20Make.20Handle.20a.20trait.20required.20for.20any.20.2E.2E.2E.html#193361110">(Apr 08 2020 at 18:37)</a>:</h4>
<p>kubkon submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/1443#pullrequestreview-390232944" title="https://github.com/bytecodealliance/wasmtime/pull/1443#pullrequestreview-390232944">PR Review</a>.</p>



<a name="193361112"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231443%20Make%20Handle%20a%20trait%20required%20for%20any%20.../near/193361112" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231443.20Make.20Handle.20a.20trait.20required.20for.20any.20.2E.2E.2E.html#193361112">(Apr 08 2020 at 18:37)</a>:</h4>
<p>kubkon created <a href="https://github.com/bytecodealliance/wasmtime/pull/1443#discussion_r405733556" title="https://github.com/bytecodealliance/wasmtime/pull/1443#discussion_r405733556">PR Review Comment</a>:</p>
<blockquote>
<p>Oh good find, thanks! So if I understood it right, modifying stdio should error out on Windows since the handle was obtained from <code>GetStdHandle</code> and not <code>CreateFile</code>. I'm keen to leave some sort of TODO here anyway to investigate this further on Windows.</p>
</blockquote>



<a name="193361711"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231443%20Make%20Handle%20a%20trait%20required%20for%20any%20.../near/193361711" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231443.20Make.20Handle.20a.20trait.20required.20for.20any.20.2E.2E.2E.html#193361711">(Apr 08 2020 at 18:42)</a>:</h4>
<p>kubkon updated <a href="https://github.com/bytecodealliance/wasmtime/pull/1443" title="https://github.com/bytecodealliance/wasmtime/pull/1443">PR #1443</a> from <code>yacc</code> to <code>master</code>:</p>
<blockquote>
<p>OK, so this PR is a bit of an experiment that came about somewhat itself<br>
when I was looking at refactoring use of <code>Rc&lt;RefCell&lt;Descriptor&gt;&gt;</code> inside<br>
<code>Entry</code> struct. I've noticed that since we've placed <code>VirtualFile</code> on the<br>
same level as <code>OsHandle</code> and <code>Stdin</code> etc., we've ended up necessiitating<br>
checks for different combinations such as "is a real OS resource being mixed<br>
up with a virtual resource?", and if that was the case, we'd panic since<br>
this was clearly not allowed (e.g., symlinking, or worse renaming).<br>
Therefore, it seemed natural for virtual file to be on the same level<br>
as _any_ OS handle (regardless of whether it's an actual file, socket,<br>
or stdio handle). In other words, we should ideally envision the following<br>
hierarchy:</p>
<div class="codehilite"><pre><span></span>\-- OsHandle \-- OsFile
              -- Stdio
\-- Virtual
</pre></div>


<p>This way, we can deal with the mix up at a level above which cleans up<br>
our logic significantly.</p>
<p>On the other hand, when looking through the <code>virtfs</code>, the trait approach<br>
to some type that's a valid <code>Handle</code> grew on me, and I think this<br>
is the way to go. And this is what this PR is proposing, a trait<br>
<code>Handle</code> which features enough functionality to make both virtual and<br>
OS ops to work. Now, inside <code>Entry</code> we can safely store something like<br>
<code>Rc&lt;dyn Handle&gt;</code> where <code>Handle</code> can downcast to either <code>VirtualFile</code> or<br>
<code>VirtualDir</code>, or <code>OsHandle</code> if its an actual OS resource. Note that<br>
I've left <code>Handle</code> as one massive trait, but I reckon we could split<br>
it up into several smaller traits, each dealing with some bit of WASI<br>
functionality. I'm hoping this would perhaps make it easier to figure<br>
out polyfilling between snapshots and the new upcoming ephemeral<br>
snapshot since a lot of boilerplate functionality is now done as part<br>
of the <code>Handle</code> trait implementation.</p>
<p>Next, I've redone the original <code>OsHandle</code> to be an <code>OsFile</code> which<br>
now stores a raw descriptor/handle (<code>RawFd</code>/<code>RawHandle</code>) inside a<br>
<code>Cell</code> so that we can handle interior mutability in an easy (read,<br>
non-panicky) way. In order not to lose the perks of derefercing to<br>
<code>std::fs::File</code>, I've added a convenience trait <code>AsFile</code> which<br>
will take <code>OsFile</code> by reference (or the stdio handles) and create<br>
a non-owned <code>ManuallyDrop&lt;File&gt;</code> resource which can be passed around<br>
and acted upon the way we'd normally do on <code>&amp;File</code>. This change of<br>
course implies that we now have to worry about properly closing all<br>
OS resources stored as part of <code>OsFile</code>, thus this type now implements<br>
<code>Drop</code> trait which essentially speaking moves the raw descriptor/handle<br>
into a <code>File</code> and drops it.</p>
<p>Finally, I've redone setting time info on relative paths on *nix using<br>
the same approach as advocated in the virtual fs. Namely, we do an<br>
<code>openat</code> followed by <code>filestat_set_times</code> on the obtained descriptor.<br>
This effectively removes the need for custom <code>filetime</code> module in<br>
<code>yanix</code>. However, this does probably incur additional cost of at least<br>
one additional syscall, and I haven't checked whether this approach<br>
performs as expected on platforms such as NixOS which as far as I remember<br>
had some weirdness todo with linking <code>utimensat</code> symbols, etc. Still,<br>
this change is worth considering given that the implementation of<br>
<code>path_filestat_set_times</code> cleans up a lot, albeit with some additional<br>
cost.</p>
<p>Anyhow, lemme y'all know what you think!</p>
<p>PS, if anybody is wondering why the incoming branch is called <code>yacc</code>,<br>
it stands for "yet another cleanup cleanup" simply because I was out<br>
of ideas...</p>
</blockquote>



<a name="193362813"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231443%20Make%20Handle%20a%20trait%20required%20for%20any%20.../near/193362813" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231443.20Make.20Handle.20a.20trait.20required.20for.20any.20.2E.2E.2E.html#193362813">(Apr 08 2020 at 18:50)</a>:</h4>
<p>kubkon updated <a href="https://github.com/bytecodealliance/wasmtime/pull/1443" title="https://github.com/bytecodealliance/wasmtime/pull/1443">PR #1443</a> from <code>yacc</code> to <code>master</code>:</p>
<blockquote>
<p>OK, so this PR is a bit of an experiment that came about somewhat itself<br>
when I was looking at refactoring use of <code>Rc&lt;RefCell&lt;Descriptor&gt;&gt;</code> inside<br>
<code>Entry</code> struct. I've noticed that since we've placed <code>VirtualFile</code> on the<br>
same level as <code>OsHandle</code> and <code>Stdin</code> etc., we've ended up necessiitating<br>
checks for different combinations such as "is a real OS resource being mixed<br>
up with a virtual resource?", and if that was the case, we'd panic since<br>
this was clearly not allowed (e.g., symlinking, or worse renaming).<br>
Therefore, it seemed natural for virtual file to be on the same level<br>
as _any_ OS handle (regardless of whether it's an actual file, socket,<br>
or stdio handle). In other words, we should ideally envision the following<br>
hierarchy:</p>
<div class="codehilite"><pre><span></span>\-- OsHandle \-- OsFile
              -- Stdio
\-- Virtual
</pre></div>


<p>This way, we can deal with the mix up at a level above which cleans up<br>
our logic significantly.</p>
<p>On the other hand, when looking through the <code>virtfs</code>, the trait approach<br>
to some type that's a valid <code>Handle</code> grew on me, and I think this<br>
is the way to go. And this is what this PR is proposing, a trait<br>
<code>Handle</code> which features enough functionality to make both virtual and<br>
OS ops to work. Now, inside <code>Entry</code> we can safely store something like<br>
<code>Rc&lt;dyn Handle&gt;</code> where <code>Handle</code> can downcast to either <code>VirtualFile</code> or<br>
<code>VirtualDir</code>, or <code>OsHandle</code> if its an actual OS resource. Note that<br>
I've left <code>Handle</code> as one massive trait, but I reckon we could split<br>
it up into several smaller traits, each dealing with some bit of WASI<br>
functionality. I'm hoping this would perhaps make it easier to figure<br>
out polyfilling between snapshots and the new upcoming ephemeral<br>
snapshot since a lot of boilerplate functionality is now done as part<br>
of the <code>Handle</code> trait implementation.</p>
<p>Next, I've redone the original <code>OsHandle</code> to be an <code>OsFile</code> which<br>
now stores a raw descriptor/handle (<code>RawFd</code>/<code>RawHandle</code>) inside a<br>
<code>Cell</code> so that we can handle interior mutability in an easy (read,<br>
non-panicky) way. In order not to lose the perks of derefercing to<br>
<code>std::fs::File</code>, I've added a convenience trait <code>AsFile</code> which<br>
will take <code>OsFile</code> by reference (or the stdio handles) and create<br>
a non-owned <code>ManuallyDrop&lt;File&gt;</code> resource which can be passed around<br>
and acted upon the way we'd normally do on <code>&amp;File</code>. This change of<br>
course implies that we now have to worry about properly closing all<br>
OS resources stored as part of <code>OsFile</code>, thus this type now implements<br>
<code>Drop</code> trait which essentially speaking moves the raw descriptor/handle<br>
into a <code>File</code> and drops it.</p>
<p>Finally, I've redone setting time info on relative paths on *nix using<br>
the same approach as advocated in the virtual fs. Namely, we do an<br>
<code>openat</code> followed by <code>filestat_set_times</code> on the obtained descriptor.<br>
This effectively removes the need for custom <code>filetime</code> module in<br>
<code>yanix</code>. However, this does probably incur additional cost of at least<br>
one additional syscall, and I haven't checked whether this approach<br>
performs as expected on platforms such as NixOS which as far as I remember<br>
had some weirdness todo with linking <code>utimensat</code> symbols, etc. Still,<br>
this change is worth considering given that the implementation of<br>
<code>path_filestat_set_times</code> cleans up a lot, albeit with some additional<br>
cost.</p>
<p>Anyhow, lemme y'all know what you think!</p>
<p>PS, if anybody is wondering why the incoming branch is called <code>yacc</code>,<br>
it stands for "yet another cleanup cleanup" simply because I was out<br>
of ideas...</p>
</blockquote>



<a name="193503964"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231443%20Make%20Handle%20a%20trait%20required%20for%20any%20.../near/193503964" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231443.20Make.20Handle.20a.20trait.20required.20for.20any.20.2E.2E.2E.html#193503964">(Apr 09 2020 at 20:18)</a>:</h4>
<p>kubkon merged <a href="https://github.com/bytecodealliance/wasmtime/pull/1443" title="https://github.com/bytecodealliance/wasmtime/pull/1443">PR #1443</a>.</p>



<hr><p>Last updated: Jan 20 2025 at 06:04 UTC</p>
</html>