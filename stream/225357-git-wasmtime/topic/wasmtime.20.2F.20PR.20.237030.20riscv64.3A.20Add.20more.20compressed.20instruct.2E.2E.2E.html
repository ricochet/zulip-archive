<html>
<head><meta charset="utf-8"><title>wasmtime / PR #7030 riscv64: Add more compressed instruct... · git-wasmtime · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/index.html">git-wasmtime</a></h2>
<h3>Topic: <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.237030.20riscv64.3A.20Add.20more.20compressed.20instruct.2E.2E.2E.html">wasmtime / PR #7030 riscv64: Add more compressed instruct...</a></h3>

<hr>

<base href="https://bytecodealliance.zulipchat.com">

<head><link href="https://bytecodealliance.github.io/zulip-archive/style.css" rel="stylesheet"></head>

<a name="390783303"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%237030%20riscv64%3A%20Add%20more%20compressed%20instruct.../near/390783303" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.237030.20riscv64.3A.20Add.20more.20compressed.20instruct.2E.2E.2E.html#390783303">(Sep 13 2023 at 18:53)</a>:</h4>
<p>afonso360 opened <a href="https://github.com/bytecodealliance/wasmtime/pull/7030">PR #7030</a> from <code>afonso360:riscv-ca</code> to <code>bytecodealliance:main</code>:</p>
<blockquote>
<p><span aria-label="wave" class="emoji emoji-1f44b" role="img" title="wave">:wave:</span> Hey,</p>
<p>This PR adds two new compressed instruction formats. CA and CJ. These are used for some register-register arithmetic ops (CA) and jump instructions (CJ).</p>
<p>It also changes all instructions that use a Label, StackMap or Relocation to use <code>emit_uncompressed</code> to ensure that we don't wrongly compress a instruction when it is expecting a different type of label or relocation.</p>
<p>Capstone seems to not recognize <code>c.jr ra</code> as <code>c.ret</code>, but it is technically an alias as far as I understand it.<br>
</p>
</blockquote>



<a name="390783307"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%237030%20riscv64%3A%20Add%20more%20compressed%20instruct.../near/390783307" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.237030.20riscv64.3A.20Add.20more.20compressed.20instruct.2E.2E.2E.html#390783307">(Sep 13 2023 at 18:53)</a>:</h4>
<p><strong>afonso360</strong> requested <a href="https://github.com/fitzgen">fitzgen</a> for a review on <a href="https://github.com/bytecodealliance/wasmtime/pull/7030">PR #7030</a>.</p>



<a name="390783309"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%237030%20riscv64%3A%20Add%20more%20compressed%20instruct.../near/390783309" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.237030.20riscv64.3A.20Add.20more.20compressed.20instruct.2E.2E.2E.html#390783309">(Sep 13 2023 at 18:53)</a>:</h4>
<p><strong>afonso360</strong> requested <a href="https://github.com/orgs/bytecodealliance/teams/wasmtime-compiler-reviewers">wasmtime-compiler-reviewers</a> for a review on <a href="https://github.com/bytecodealliance/wasmtime/pull/7030">PR #7030</a>.</p>



<a name="390787074"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%237030%20riscv64%3A%20Add%20more%20compressed%20instruct.../near/390787074" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.237030.20riscv64.3A.20Add.20more.20compressed.20instruct.2E.2E.2E.html#390787074">(Sep 13 2023 at 19:19)</a>:</h4>
<p>afonso360 updated <a href="https://github.com/bytecodealliance/wasmtime/pull/7030">PR #7030</a>.</p>



<a name="390788198"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%237030%20riscv64%3A%20Add%20more%20compressed%20instruct.../near/390788198" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.237030.20riscv64.3A.20Add.20more.20compressed.20instruct.2E.2E.2E.html#390788198">(Sep 13 2023 at 19:27)</a>:</h4>
<p>afonso360 updated <a href="https://github.com/bytecodealliance/wasmtime/pull/7030">PR #7030</a>.</p>



<a name="390808273"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%237030%20riscv64%3A%20Add%20more%20compressed%20instruct.../near/390808273" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.237030.20riscv64.3A.20Add.20more.20compressed.20instruct.2E.2E.2E.html#390808273">(Sep 13 2023 at 21:53)</a>:</h4>
<p>alexcrichton submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/7030#pullrequestreview-1625506794">PR review</a>:</p>
<blockquote>
<p>Looks good <span aria-label="+1" class="emoji emoji-1f44d" role="img" title="+1">:+1:</span> </p>
<p>Question though: is it possible to remove the usage of <code>emit_uncompressed</code>? It seems like the usage here is primarily related to relocations and how <code>PCRelHi20</code> for example expects a 4-byte instruction. Are there alternative relocations for the 16-bit compressed instructions we could use instead with some refactoring? Or is this matching what other compilers do where for these constructs uncompressed instructions are always emitted?</p>
</blockquote>



<a name="390808274"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%237030%20riscv64%3A%20Add%20more%20compressed%20instruct.../near/390808274" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.237030.20riscv64.3A.20Add.20more.20compressed.20instruct.2E.2E.2E.html#390808274">(Sep 13 2023 at 21:53)</a>:</h4>
<p>alexcrichton submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/7030#pullrequestreview-1625506794">PR review</a>:</p>
<blockquote>
<p>Looks good <span aria-label="+1" class="emoji emoji-1f44d" role="img" title="+1">:+1:</span> </p>
<p>Question though: is it possible to remove the usage of <code>emit_uncompressed</code>? It seems like the usage here is primarily related to relocations and how <code>PCRelHi20</code> for example expects a 4-byte instruction. Are there alternative relocations for the 16-bit compressed instructions we could use instead with some refactoring? Or is this matching what other compilers do where for these constructs uncompressed instructions are always emitted?</p>
</blockquote>



<a name="390808275"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%237030%20riscv64%3A%20Add%20more%20compressed%20instruct.../near/390808275" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.237030.20riscv64.3A.20Add.20more.20compressed.20instruct.2E.2E.2E.html#390808275">(Sep 13 2023 at 21:53)</a>:</h4>
<p>alexcrichton created <a href="https://github.com/bytecodealliance/wasmtime/pull/7030#discussion_r1325113283">PR review comment</a>:</p>
<blockquote>
<p>Oh wow this is something else... I'm curious but do you know if there's a link explaining why the bits are this way? Mostly I'm just curious!</p>
</blockquote>



<a name="390812570"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%237030%20riscv64%3A%20Add%20more%20compressed%20instruct.../near/390812570" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.237030.20riscv64.3A.20Add.20more.20compressed.20instruct.2E.2E.2E.html#390812570">(Sep 13 2023 at 22:25)</a>:</h4>
<p>cfallin submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/7030#pullrequestreview-1625538888">PR review</a>.</p>



<a name="390812571"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%237030%20riscv64%3A%20Add%20more%20compressed%20instruct.../near/390812571" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.237030.20riscv64.3A.20Add.20more.20compressed.20instruct.2E.2E.2E.html#390812571">(Sep 13 2023 at 22:25)</a>:</h4>
<p>cfallin created <a href="https://github.com/bytecodealliance/wasmtime/pull/7030#discussion_r1325134652">PR review comment</a>:</p>
<blockquote>
<p>There's some discussion of this in <a href="https://www2.eecs.berkeley.edu/Pubs/TechRpts/2016/EECS-2016-1.html">Andrew Waterman's PhD thesis</a> (his thesis work was the ISA design) -- e.g. on page 31 of that PDF he discusses how certain immediate bits always come from the same position in instruction formats and this reduces MUX logic overhead. Kind of a fascinating design point actually (how few gates can you use for an RV32I implementation).</p>
</blockquote>



<a name="390815639"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%237030%20riscv64%3A%20Add%20more%20compressed%20instruct.../near/390815639" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.237030.20riscv64.3A.20Add.20more.20compressed.20instruct.2E.2E.2E.html#390815639">(Sep 13 2023 at 22:57)</a>:</h4>
<p>alexcrichton submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/7030#pullrequestreview-1625563595">PR review</a>.</p>



<a name="390815640"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%237030%20riscv64%3A%20Add%20more%20compressed%20instruct.../near/390815640" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.237030.20riscv64.3A.20Add.20more.20compressed.20instruct.2E.2E.2E.html#390815640">(Sep 13 2023 at 22:57)</a>:</h4>
<p>alexcrichton created <a href="https://github.com/bytecodealliance/wasmtime/pull/7030#discussion_r1325151710">PR review comment</a>:</p>
<blockquote>
<p>Whoa wild! I've got some reading ahead of me :)</p>
</blockquote>



<a name="390914897"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%237030%20riscv64%3A%20Add%20more%20compressed%20instruct.../near/390914897" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.237030.20riscv64.3A.20Add.20more.20compressed.20instruct.2E.2E.2E.html#390914897">(Sep 14 2023 at 12:04)</a>:</h4>
<p>afonso360 updated <a href="https://github.com/bytecodealliance/wasmtime/pull/7030">PR #7030</a>.</p>



<a name="391126733"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%237030%20riscv64%3A%20Add%20more%20compressed%20instruct.../near/391126733" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.237030.20riscv64.3A.20Add.20more.20compressed.20instruct.2E.2E.2E.html#391126733">(Sep 15 2023 at 09:49)</a>:</h4>
<p>afonso360 merged <a href="https://github.com/bytecodealliance/wasmtime/pull/7030">PR #7030</a>.</p>



<hr><p>Last updated: Jan 20 2025 at 06:04 UTC</p>
</html>