<html>
<head><meta charset="utf-8"><title>wasmtime / Issue #1753 impl From&lt;anyhow::Error&gt; for Trap · git-wasmtime · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/index.html">git-wasmtime</a></h2>
<h3>Topic: <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20Issue.20.231753.20impl.20From.3Canyhow.3A.3AError.3E.20for.20Trap.html">wasmtime / Issue #1753 impl From&lt;anyhow::Error&gt; for Trap</a></h3>

<hr>

<base href="https://bytecodealliance.zulipchat.com">

<head><link href="https://bytecodealliance.github.io/zulip-archive/style.css" rel="stylesheet"></head>

<a name="198695773"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20Issue%20%231753%20impl%20From%3Canyhow%3A%3AError%3E%20for%20Trap/near/198695773" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20Issue.20.231753.20impl.20From.3Canyhow.3A.3AError.3E.20for.20Trap.html#198695773">(May 25 2020 at 19:18)</a>:</h4>
<p>github-actions[bot] <a href="https://github.com/bytecodealliance/wasmtime/pull/1753#issuecomment-633690440">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/1753">Issue #1753</a>:</p>
<blockquote>
<h4>Subscribe to Label Action</h4>
<p>cc @peterhuene</p>
<p>&lt;details&gt;<br>
This issue or pull request has been labeled: "wasmtime:api"</p>
<p>Thus the following users have been cc'd because of the following labels:</p>
<ul>
<li>peterhuene: wasmtime:api</li>
</ul>
<p>To subscribe or unsubscribe from this label, edit the &lt;code&gt;.github/subscribe-to-label.json&lt;/code&gt; configuration file.</p>
<p><a href="https://github.com/bytecodealliance/subscribe-to-label-action">Learn more.</a><br>
&lt;/details&gt;</p>
</blockquote>



<a name="198770340"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20Issue%20%231753%20impl%20From%3Canyhow%3A%3AError%3E%20for%20Trap/near/198770340" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20Issue.20.231753.20impl.20From.3Canyhow.3A.3AError.3E.20for.20Trap.html#198770340">(May 26 2020 at 14:32)</a>:</h4>
<p>alexcrichton <a href="https://github.com/bytecodealliance/wasmtime/pull/1753#issuecomment-634063463">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/1753">Issue #1753</a>:</p>
<blockquote>
<p>Thanks for this! I'm a little wary to do it, however, because it's a lossy conversion. The original error object contains important contextual information (like the backtrace, list of error contexts, etc), and that all gets lost on conversion into a <code>Trap</code>. One thing we could consider, however, is to refactor the internals of <code>Trap</code> to have a variant of its representation where it stores an <code>anyhow::Error</code> perhaps?</p>
<p>One thing that'd also be great is if we could support anything that's <code>E: Error</code> or otherwise support other error types via generics rather than just <code>anyhow::Error</code></p>
</blockquote>



<a name="198777296"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20Issue%20%231753%20impl%20From%3Canyhow%3A%3AError%3E%20for%20Trap/near/198777296" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20Issue.20.231753.20impl.20From.3Canyhow.3A.3AError.3E.20for.20Trap.html#198777296">(May 26 2020 at 15:16)</a>:</h4>
<p>leoyvens <a href="https://github.com/bytecodealliance/wasmtime/pull/1753#issuecomment-634090047">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/1753">Issue #1753</a>:</p>
<blockquote>
<p>Doing a better conversion is out of my depth, but I'd expect that those improvements can be made backwards compatibly. Right now this is the best that can be done with the public API, so this is just making the public API more ergonomic.</p>
<p>I didn't make this generic over <code>E: Error</code> because I didn't want to create any backwards compatibility hazard wrt to coherence, but I can do so if that's preferred.</p>
</blockquote>



<a name="198911833"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20Issue%20%231753%20impl%20From%3Canyhow%3A%3AError%3E%20for%20Trap/near/198911833" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20Issue.20.231753.20impl.20From.3Canyhow.3A.3AError.3E.20for.20Trap.html#198911833">(May 27 2020 at 15:50)</a>:</h4>
<p>alexcrichton <a href="https://github.com/bytecodealliance/wasmtime/pull/1753#issuecomment-634755174">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/1753">Issue #1753</a>:</p>
<blockquote>
<p>We've already got an <code>enum TrapReason</code>, so how about doing something like this:</p>
<div class="codehilite"><pre><span></span><code><span class="k">impl</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span><span class="w"> </span><span class="nb">From</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">Trap</span><span class="w"> </span><span class="k">where</span><span class="w"> </span><span class="n">T</span>: <span class="nb">Into</span><span class="o">&lt;</span><span class="n">anyhow</span>::<span class="n">Error</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="c1">// ...</span>
<span class="p">}</span><span class="w"></span>

<span class="k">enum</span> <span class="nc">TrapReason</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="c1">// ...</span>
<span class="w">    </span><span class="n">Error</span><span class="p">(</span><span class="n">anyhow</span>::<span class="n">Error</span><span class="p">),</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="k">impl</span><span class="w"> </span><span class="n">Error</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">Trap</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">fn</span> <span class="nf">source</span><span class="p">(</span><span class="o">&amp;</span><span class="bp">self</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="cm">/* ... */</span><span class="w"> </span><span class="p">}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>


<p>We can figure out later if it's necessary to expose the underlying error's original type, but otherwise for now that will at least sidestep issues with <code>Display</code> vs <code>Debug</code> and we'll be able to get a structure stack of causal errors.</p>
</blockquote>



<a name="198930513"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20Issue%20%231753%20impl%20From%3Canyhow%3A%3AError%3E%20for%20Trap/near/198930513" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20Issue.20.231753.20impl.20From.3Canyhow.3A.3AError.3E.20for.20Trap.html#198930513">(May 27 2020 at 18:13)</a>:</h4>
<p>sunfishcode <a href="https://github.com/bytecodealliance/wasmtime/pull/1753#issuecomment-634848421">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/1753">Issue #1753</a>:</p>
<blockquote>
<p>FWIW, there are a few existing places that could use that too:</p>
<div class="codehilite"><pre><span></span><code>$ rg &#39;Trap::new\(format!\(&quot;\{:\?\}&quot;&#39;
crates/wasmtime/src/linker.rs
410:                        Err(error) =&gt; Trap::new(format!(&quot;{:?}&quot;, error)),

crates/c-api/src/error.rs
14:        Box::new(wasm_trap_t::new(Trap::new(format!(&quot;{:?}&quot;, self.error))))
</code></pre></div>


</blockquote>



<a name="198960864"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20Issue%20%231753%20impl%20From%3Canyhow%3A%3AError%3E%20for%20Trap/near/198960864" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20Issue.20.231753.20impl.20From.3Canyhow.3A.3AError.3E.20for.20Trap.html#198960864">(May 27 2020 at 22:20)</a>:</h4>
<p>leoyvens <a href="https://github.com/bytecodealliance/wasmtime/pull/1753#issuecomment-634973985">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/1753">Issue #1753</a>:</p>
<blockquote>
<p>The suggested <code>impl&lt;T&gt; From&lt;T&gt; for Trap where T: Into&lt;anyhow::Error&gt;</code> conflicts with the reflexive impl <code>impl&lt;T&gt; std::convert::From&lt;T&gt; for T</code> since <code>Trap</code> itself implements <code>Error</code>. I did add a conversion <code>Box&lt;dyn std::error::Error + Send + Sync&gt;</code>.</p>
<p>Based on the suggestions given and the uses in the project, I added a <code>Error(Box&lt;dyn std::error::Error + Send + Sync&gt;)</code> variant to <code>TrapReason</code> which allowed for some nice refactorings.</p>
<p><code>Trap::message</code> is confusing to me, imo along with <code>Display</code> and <code>Debug</code> there are too many ways of converting a Trap to a string. But I kept it, though the return type had to be changed to an owned <code>String</code>.</p>
</blockquote>



<a name="198962495"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20Issue%20%231753%20impl%20From%3Canyhow%3A%3AError%3E%20for%20Trap/near/198962495" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20Issue.20.231753.20impl.20From.3Canyhow.3A.3AError.3E.20for.20Trap.html#198962495">(May 27 2020 at 22:38)</a>:</h4>
<p>github-actions[bot] <a href="https://github.com/bytecodealliance/wasmtime/pull/1753#issuecomment-634980553">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/1753">Issue #1753</a>:</p>
<blockquote>
<h4>Subscribe to Label Action</h4>
<p>cc @peterhuene</p>
<p>&lt;details&gt;<br>
This issue or pull request has been labeled: "wasmtime:c-api"</p>
<p>Thus the following users have been cc'd because of the following labels:</p>
<ul>
<li>peterhuene: wasmtime:c-api</li>
</ul>
<p>To subscribe or unsubscribe from this label, edit the &lt;code&gt;.github/subscribe-to-label.json&lt;/code&gt; configuration file.</p>
<p><a href="https://github.com/bytecodealliance/subscribe-to-label-action">Learn more.</a><br>
&lt;/details&gt;</p>
</blockquote>



<a name="199207533"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20Issue%20%231753%20impl%20From%3Canyhow%3A%3AError%3E%20for%20Trap/near/199207533" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20Issue.20.231753.20impl.20From.3Canyhow.3A.3AError.3E.20for.20Trap.html#199207533">(May 29 2020 at 20:24)</a>:</h4>
<p>alexcrichton <a href="https://github.com/bytecodealliance/wasmtime/pull/1753#issuecomment-636175894">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/1753">Issue #1753</a>:</p>
<blockquote>
<p>This all looks great to me, thanks again for this!</p>
</blockquote>



<hr><p>Last updated: Jan 20 2025 at 06:04 UTC</p>
</html>