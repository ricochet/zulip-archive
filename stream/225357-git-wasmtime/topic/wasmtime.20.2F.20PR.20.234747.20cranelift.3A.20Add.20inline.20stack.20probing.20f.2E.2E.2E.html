<html>
<head><meta charset="utf-8"><title>wasmtime / PR #4747 cranelift: Add inline stack probing f... · git-wasmtime · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/index.html">git-wasmtime</a></h2>
<h3>Topic: <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.234747.20cranelift.3A.20Add.20inline.20stack.20probing.20f.2E.2E.2E.html">wasmtime / PR #4747 cranelift: Add inline stack probing f...</a></h3>

<hr>

<base href="https://bytecodealliance.zulipchat.com">

<head><link href="https://bytecodealliance.github.io/zulip-archive/style.css" rel="stylesheet"></head>

<a name="294530447"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%234747%20cranelift%3A%20Add%20inline%20stack%20probing%20f.../near/294530447" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.234747.20cranelift.3A.20Add.20inline.20stack.20probing.20f.2E.2E.2E.html#294530447">(Aug 21 2022 at 10:52)</a>:</h4>
<p>afonso360 opened <a href="https://github.com/bytecodealliance/wasmtime/pull/4747">PR #4747</a> from <code>inline-stackprobing</code> to <code>main</code>:</p>
<blockquote>
<p><span aria-label="wave" class="emoji emoji-1f44b" role="img" title="wave">:wave:</span> Hey,</p>
<p>This PR adds inline stack probing for the x64 backend. Opening as a draft since there are still some pending questions.</p>
<p>This is feature gated behind a <code>enable_inline_probestack</code> and also requires the user to enable <code>enable_probestack</code>.</p>
<p>Currently we have two implementations, If we only need to probe a few stack pages, we unroll the probes. If we need more we fall back to using a loop.</p>
<p>Closes: #2299<br>
cc: @bjorn3 @cfallin </p>
</blockquote>



<a name="294530486"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%234747%20cranelift%3A%20Add%20inline%20stack%20probing%20f.../near/294530486" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.234747.20cranelift.3A.20Add.20inline.20stack.20probing.20f.2E.2E.2E.html#294530486">(Aug 21 2022 at 10:52)</a>:</h4>
<p>afonso360 submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/4747#pullrequestreview-1079654855">PR review</a>.</p>



<a name="294530487"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%234747%20cranelift%3A%20Add%20inline%20stack%20probing%20f.../near/294530487" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.234747.20cranelift.3A.20Add.20inline.20stack.20probing.20f.2E.2E.2E.html#294530487">(Aug 21 2022 at 10:52)</a>:</h4>
<p>afonso360 created <a href="https://github.com/bytecodealliance/wasmtime/pull/4747#discussion_r950825466">PR review comment</a>:</p>
<blockquote>
<p>I'm not too happy about this, and did this mostly as a proof of concept to see if it fixes the issues we were having in <a href="https://github.com/bjorn3/rustc_codegen_cranelift/issues/1261#issuecomment-1219307630">https://github.com/bjorn3/rustc_codegen_cranelift/issues/1261#issuecomment-1219307630</a> .</p>
<p>I think the real solution here is allowing us to emit labels and use those with the regular jump instruction.</p>
<p><code>gen_prologue</code> curently does two things:</p>
<ul>
<li>Initializes part of the <code>Callee</code> struct (calculates stack sizes)</li>
<li>Generates the prologue instructions</li>
</ul>
<p>These instructions aren't emitted immediatley, instead we call this early on in vcode emission to initialize the <code>Callee</code> struct, and the only later on emit the previously generated instructions.</p>
<p><a href="https://github.com/bytecodealliance/wasmtime/blob/d620705a323e3da59bd90473b4e627c8502b1255/cranelift/codegen/src/machinst/vcode.rs#L790-L793">https://github.com/bytecodealliance/wasmtime/blob/d620705a323e3da59bd90473b4e627c8502b1255/cranelift/codegen/src/machinst/vcode.rs#L790-L793</a></p>
<p>I think we can change this slightly to allow label emission in <code>gen_prologue</code> by splitting it into two functions.</p>
<p>One that precomputes the stack sizes and initializes the <code>Callee</code> struct, that is called early on (where the current <code>gen_prologue</code> currently is).</p>
<p>And a second one that directly emits the prologue instructions. This way we can emit them and at the same time pass a function to generate a label at the current emit point.</p>
<p>Are there issues with emitting labels so late in the pipeline? And does this sound like a reasonable refactor?<br>
</p>
</blockquote>



<a name="294530535"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%234747%20cranelift%3A%20Add%20inline%20stack%20probing%20f.../near/294530535" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.234747.20cranelift.3A.20Add.20inline.20stack.20probing.20f.2E.2E.2E.html#294530535">(Aug 21 2022 at 10:53)</a>:</h4>
<p>afonso360 submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/4747#pullrequestreview-1079654958">PR review</a>.</p>



<a name="294530536"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%234747%20cranelift%3A%20Add%20inline%20stack%20probing%20f.../near/294530536" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.234747.20cranelift.3A.20Add.20inline.20stack.20probing.20f.2E.2E.2E.html#294530536">(Aug 21 2022 at 10:53)</a>:</h4>
<p>afonso360 created <a href="https://github.com/bytecodealliance/wasmtime/pull/4747#discussion_r950825544">PR review comment</a>:</p>
<blockquote>
<p>I'm not too happy about this, and did this mostly as a proof of concept to see if it fixes the issues we were having in <a href="https://github.com/bjorn3/rustc_codegen_cranelift/issues/1261#issuecomment-1219307630">https://github.com/bjorn3/rustc_codegen_cranelift/issues/1261#issuecomment-1219307630</a> .</p>
<p>I think the real solution here is allowing us to emit labels and use those with the regular jump instruction.</p>
<p><code>gen_prologue</code> curently does two things:</p>
<ul>
<li>Initializes part of the <code>Callee</code> struct (calculates stack sizes)</li>
<li>Generates the prologue instructions</li>
</ul>
<p>These instructions aren't emitted immediatley, instead we call this early on in vcode emission to initialize the <code>Callee</code> struct, and the only later on emit the previously generated instructions.</p>
<p><a href="https://github.com/bytecodealliance/wasmtime/blob/d620705a323e3da59bd90473b4e627c8502b1255/cranelift/codegen/src/machinst/vcode.rs#L790-L793">https://github.com/bytecodealliance/wasmtime/blob/d620705a323e3da59bd90473b4e627c8502b1255/cranelift/codegen/src/machinst/vcode.rs#L790-L793</a></p>
<p>I think we can change this slightly to allow label emission in <code>gen_prologue</code> by splitting it into two functions.</p>
<p>One that precomputes the stack sizes and initializes the <code>Callee</code> struct, that is called early on (where the current <code>gen_prologue</code> currently is).</p>
<p>And a second one that directly emits the prologue instructions. This way we can emit them and at the same time pass a function to generate a label at the current emit point.</p>
<p>Are there issues with emitting labels so late in the pipeline? And does this sound like a reasonable refactor?<br>
</p>
</blockquote>



<a name="294530545"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%234747%20cranelift%3A%20Add%20inline%20stack%20probing%20f.../near/294530545" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.234747.20cranelift.3A.20Add.20inline.20stack.20probing.20f.2E.2E.2E.html#294530545">(Aug 21 2022 at 10:53)</a>:</h4>
<p>afonso360 deleted <a href="https://github.com/bytecodealliance/wasmtime/pull/4747#discussion_r950825544">PR review comment</a>.</p>



<a name="294531326"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%234747%20cranelift%3A%20Add%20inline%20stack%20probing%20f.../near/294531326" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.234747.20cranelift.3A.20Add.20inline.20stack.20probing.20f.2E.2E.2E.html#294531326">(Aug 21 2022 at 11:02)</a>:</h4>
<p>bjorn3 submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/4747#pullrequestreview-1079655273">PR review</a>.</p>



<a name="294531327"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%234747%20cranelift%3A%20Add%20inline%20stack%20probing%20f.../near/294531327" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.234747.20cranelift.3A.20Add.20inline.20stack.20probing.20f.2E.2E.2E.html#294531327">(Aug 21 2022 at 11:02)</a>:</h4>
<p>bjorn3 submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/4747#pullrequestreview-1079655273">PR review</a>.</p>



<a name="294531328"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%234747%20cranelift%3A%20Add%20inline%20stack%20probing%20f.../near/294531328" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.234747.20cranelift.3A.20Add.20inline.20stack.20probing.20f.2E.2E.2E.html#294531328">(Aug 21 2022 at 11:02)</a>:</h4>
<p>bjorn3 created <a href="https://github.com/bytecodealliance/wasmtime/pull/4747#discussion_r950825890">PR review comment</a>:</p>
<blockquote>
<p>You can only have either outlined or inlined stack probes, not both at the same time. Maybe make it an enum?</p>
</blockquote>



<a name="294543275"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%234747%20cranelift%3A%20Add%20inline%20stack%20probing%20f.../near/294543275" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.234747.20cranelift.3A.20Add.20inline.20stack.20probing.20f.2E.2E.2E.html#294543275">(Aug 21 2022 at 13:17)</a>:</h4>
<p>afonso360 submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/4747#pullrequestreview-1079672306">PR review</a>.</p>



<a name="294543277"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%234747%20cranelift%3A%20Add%20inline%20stack%20probing%20f.../near/294543277" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.234747.20cranelift.3A.20Add.20inline.20stack.20probing.20f.2E.2E.2E.html#294543277">(Aug 21 2022 at 13:17)</a>:</h4>
<p>afonso360 created <a href="https://github.com/bytecodealliance/wasmtime/pull/4747#discussion_r950844867">PR review comment</a>:</p>
<blockquote>
<p>Yeah, that sounds like a good idea.</p>
</blockquote>



<a name="294543288"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%234747%20cranelift%3A%20Add%20inline%20stack%20probing%20f.../near/294543288" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.234747.20cranelift.3A.20Add.20inline.20stack.20probing.20f.2E.2E.2E.html#294543288">(Aug 21 2022 at 13:17)</a>:</h4>
<p>afonso360 edited <a href="https://github.com/bytecodealliance/wasmtime/pull/4747#discussion_r950844867">PR review comment</a>.</p>



<a name="294764961"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%234747%20cranelift%3A%20Add%20inline%20stack%20probing%20f.../near/294764961" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.234747.20cranelift.3A.20Add.20inline.20stack.20probing.20f.2E.2E.2E.html#294764961">(Aug 22 2022 at 20:51)</a>:</h4>
<p>cfallin submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/4747#pullrequestreview-1081131776">PR review</a>.</p>



<a name="294764962"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%234747%20cranelift%3A%20Add%20inline%20stack%20probing%20f.../near/294764962" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.234747.20cranelift.3A.20Add.20inline.20stack.20probing.20f.2E.2E.2E.html#294764962">(Aug 22 2022 at 20:51)</a>:</h4>
<p>cfallin created <a href="https://github.com/bytecodealliance/wasmtime/pull/4747#discussion_r951901282">PR review comment</a>:</p>
<blockquote>
<p>@afonso360 in principle we <em>could</em> allow for control flow to be inserted this late in the pipeline, but in practice it's a fairly intrusive refactor as we have to somehow communicate out-of-band the label and reference to it (or hack it with an explicit offset as here, but this definitely is not the right answer IMHO as it bakes in a dependence on encoded instruction sizes determined elsewhere in the code, in a way that could lead to a CVE if it later breaks).</p>
<p>I think the better answer here is to actually have a psuedo-<code>MachInst</code> that represents "stack-probe loop" and emits whatever is appropriate. We already have control-flow-inside-an-instruction for cases like <code>TrapIf</code>; this works well enough and maintains the abstraction that an instruction is a single-in, single-out thing (ignoring CLIF-level branches for now), which the rest of the backend assumes. Does that make sense?</p>
</blockquote>



<a name="294767272"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%234747%20cranelift%3A%20Add%20inline%20stack%20probing%20f.../near/294767272" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.234747.20cranelift.3A.20Add.20inline.20stack.20probing.20f.2E.2E.2E.html#294767272">(Aug 22 2022 at 21:08)</a>:</h4>
<p>afonso360 created <a href="https://github.com/bytecodealliance/wasmtime/pull/4747#discussion_r951915090">PR review comment</a>:</p>
<blockquote>
<p>Yeah that does sound reasonable, and a lot easier that performing that refactor. Thanks!</p>
</blockquote>



<a name="294767273"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%234747%20cranelift%3A%20Add%20inline%20stack%20probing%20f.../near/294767273" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.234747.20cranelift.3A.20Add.20inline.20stack.20probing.20f.2E.2E.2E.html#294767273">(Aug 22 2022 at 21:08)</a>:</h4>
<p>afonso360 submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/4747#pullrequestreview-1081151695">PR review</a>.</p>



<a name="294838341"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%234747%20cranelift%3A%20Add%20inline%20stack%20probing%20f.../near/294838341" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.234747.20cranelift.3A.20Add.20inline.20stack.20probing.20f.2E.2E.2E.html#294838341">(Aug 23 2022 at 10:19)</a>:</h4>
<p>afonso360 updated <a href="https://github.com/bytecodealliance/wasmtime/pull/4747">PR #4747</a> from <code>inline-stackprobing</code> to <code>main</code>.</p>



<a name="294840415"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%234747%20cranelift%3A%20Add%20inline%20stack%20probing%20f.../near/294840415" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.234747.20cranelift.3A.20Add.20inline.20stack.20probing.20f.2E.2E.2E.html#294840415">(Aug 23 2022 at 10:37)</a>:</h4>
<p>afonso360 submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/4747#pullrequestreview-1081887685">PR review</a>.</p>



<a name="294840416"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%234747%20cranelift%3A%20Add%20inline%20stack%20probing%20f.../near/294840416" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.234747.20cranelift.3A.20Add.20inline.20stack.20probing.20f.2E.2E.2E.html#294840416">(Aug 23 2022 at 10:37)</a>:</h4>
<p>afonso360 created <a href="https://github.com/bytecodealliance/wasmtime/pull/4747#discussion_r952444030">PR review comment</a>:</p>
<blockquote>
<p>I've added a <code>stackprobe_strategy</code> flag, and while right now its just <code>inline</code> and <code>outline</code> I think in the future we can experiment with adding different strategies to mix the two, such as allowing both and in <code>OptLevel::Size</code> emitting the unroll inline or the call, whichever is smallest.</p>
</blockquote>



<a name="294840601"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%234747%20cranelift%3A%20Add%20inline%20stack%20probing%20f.../near/294840601" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.234747.20cranelift.3A.20Add.20inline.20stack.20probing.20f.2E.2E.2E.html#294840601">(Aug 23 2022 at 10:38)</a>:</h4>
<p>bjorn3 created <a href="https://github.com/bytecodealliance/wasmtime/pull/4747#discussion_r952445557">PR review comment</a>:</p>
<blockquote>
<p>Looks like you haven't pushed it yet.</p>
</blockquote>



<a name="294840603"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%234747%20cranelift%3A%20Add%20inline%20stack%20probing%20f.../near/294840603" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.234747.20cranelift.3A.20Add.20inline.20stack.20probing.20f.2E.2E.2E.html#294840603">(Aug 23 2022 at 10:38)</a>:</h4>
<p>bjorn3 submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/4747#pullrequestreview-1081889693">PR review</a>.</p>



<a name="294840827"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%234747%20cranelift%3A%20Add%20inline%20stack%20probing%20f.../near/294840827" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.234747.20cranelift.3A.20Add.20inline.20stack.20probing.20f.2E.2E.2E.html#294840827">(Aug 23 2022 at 10:40)</a>:</h4>
<p>afonso360 edited <a href="https://github.com/bytecodealliance/wasmtime/pull/4747#discussion_r952444030">PR review comment</a>.</p>



<a name="294840931"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%234747%20cranelift%3A%20Add%20inline%20stack%20probing%20f.../near/294840931" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.234747.20cranelift.3A.20Add.20inline.20stack.20probing.20f.2E.2E.2E.html#294840931">(Aug 23 2022 at 10:41)</a>:</h4>
<p>afonso360 updated <a href="https://github.com/bytecodealliance/wasmtime/pull/4747">PR #4747</a> from <code>inline-stackprobing</code> to <code>main</code>.</p>



<a name="294840937"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%234747%20cranelift%3A%20Add%20inline%20stack%20probing%20f.../near/294840937" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.234747.20cranelift.3A.20Add.20inline.20stack.20probing.20f.2E.2E.2E.html#294840937">(Aug 23 2022 at 10:42)</a>:</h4>
<p>afonso360 submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/4747#pullrequestreview-1081893768">PR review</a>.</p>



<a name="294840952"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%234747%20cranelift%3A%20Add%20inline%20stack%20probing%20f.../near/294840952" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.234747.20cranelift.3A.20Add.20inline.20stack.20probing.20f.2E.2E.2E.html#294840952">(Aug 23 2022 at 10:42)</a>:</h4>
<p>afonso360 created <a href="https://github.com/bytecodealliance/wasmtime/pull/4747#discussion_r952448649">PR review comment</a>:</p>
<blockquote>
<p>Oops, fixed</p>
</blockquote>



<a name="294840984"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%234747%20cranelift%3A%20Add%20inline%20stack%20probing%20f.../near/294840984" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.234747.20cranelift.3A.20Add.20inline.20stack.20probing.20f.2E.2E.2E.html#294840984">(Aug 23 2022 at 10:42)</a>:</h4>
<p>afonso360 edited <a href="https://github.com/bytecodealliance/wasmtime/pull/4747#discussion_r952448649">PR review comment</a>.</p>



<a name="294841038"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%234747%20cranelift%3A%20Add%20inline%20stack%20probing%20f.../near/294841038" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.234747.20cranelift.3A.20Add.20inline.20stack.20probing.20f.2E.2E.2E.html#294841038">(Aug 23 2022 at 10:42)</a>:</h4>
<p>afonso360 updated <a href="https://github.com/bytecodealliance/wasmtime/pull/4747">PR #4747</a> from <code>inline-stackprobing</code> to <code>main</code>.</p>



<a name="294841049"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%234747%20cranelift%3A%20Add%20inline%20stack%20probing%20f.../near/294841049" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.234747.20cranelift.3A.20Add.20inline.20stack.20probing.20f.2E.2E.2E.html#294841049">(Aug 23 2022 at 10:42)</a>:</h4>
<p>afonso360 updated <a href="https://github.com/bytecodealliance/wasmtime/pull/4747">PR #4747</a> from <code>inline-stackprobing</code> to <code>main</code>.</p>



<a name="294878355"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%234747%20cranelift%3A%20Add%20inline%20stack%20probing%20f.../near/294878355" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.234747.20cranelift.3A.20Add.20inline.20stack.20probing.20f.2E.2E.2E.html#294878355">(Aug 23 2022 at 14:36)</a>:</h4>
<p><strong>afonso360</strong> has marked <a href="https://github.com/bytecodealliance/wasmtime/pull/4747">PR #4747</a> as ready for review.</p>



<a name="296543747"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%234747%20cranelift%3A%20Add%20inline%20stack%20probing%20f.../near/296543747" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.234747.20cranelift.3A.20Add.20inline.20stack.20probing.20f.2E.2E.2E.html#296543747">(Sep 01 2022 at 08:58)</a>:</h4>
<p>afonso360 updated <a href="https://github.com/bytecodealliance/wasmtime/pull/4747">PR #4747</a> from <code>inline-stackprobing</code> to <code>main</code>.</p>



<a name="296698323"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%234747%20cranelift%3A%20Add%20inline%20stack%20probing%20f.../near/296698323" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.234747.20cranelift.3A.20Add.20inline.20stack.20probing.20f.2E.2E.2E.html#296698323">(Sep 01 2022 at 20:56)</a>:</h4>
<p>jameysharp submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/4747#pullrequestreview-1093608412">PR review</a>.</p>



<a name="296698324"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%234747%20cranelift%3A%20Add%20inline%20stack%20probing%20f.../near/296698324" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.234747.20cranelift.3A.20Add.20inline.20stack.20probing.20f.2E.2E.2E.html#296698324">(Sep 01 2022 at 20:56)</a>:</h4>
<p>jameysharp submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/4747#pullrequestreview-1093608412">PR review</a>.</p>



<a name="296698325"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%234747%20cranelift%3A%20Add%20inline%20stack%20probing%20f.../near/296698325" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.234747.20cranelift.3A.20Add.20inline.20stack.20probing.20f.2E.2E.2E.html#296698325">(Sep 01 2022 at 20:56)</a>:</h4>
<p>jameysharp created <a href="https://github.com/bytecodealliance/wasmtime/pull/4747#discussion_r960796881">PR review comment</a>:</p>
<blockquote>
<p>This comment is no longer true, is it? I think you can delete it.</p>
</blockquote>



<a name="296698327"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%234747%20cranelift%3A%20Add%20inline%20stack%20probing%20f.../near/296698327" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.234747.20cranelift.3A.20Add.20inline.20stack.20probing.20f.2E.2E.2E.html#296698327">(Sep 01 2022 at 20:56)</a>:</h4>
<p>jameysharp created <a href="https://github.com/bytecodealliance/wasmtime/pull/4747#discussion_r960801508">PR review comment</a>:</p>
<blockquote>
<p>Minor edits I just noticed:</p>
<p><div class="codehilite" data-code-language="suggestion"><pre><span></span><code>            // The inline stack probe loop has 3 phases:
            //
            // We generate the "guard area" register which is essentially the frame_size aligned to
            // guard_size. We copy the stack pointer and subtract the guard area from it. This
            // gets us a register that we can use to compare when looping.
            //
            // After that we emit the loop. Essentially we just adjust the stack pointer one guard_size'd
            // distance at a time and then touch the stack by writing anything to it. We use the previously
            // created "guard area" register to know when to stop looping.
</code></pre></div><br>
</p>
</blockquote>



<a name="296698328"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%234747%20cranelift%3A%20Add%20inline%20stack%20probing%20f.../near/296698328" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.234747.20cranelift.3A.20Add.20inline.20stack.20probing.20f.2E.2E.2E.html#296698328">(Sep 01 2022 at 20:56)</a>:</h4>
<p>jameysharp created <a href="https://github.com/bytecodealliance/wasmtime/pull/4747#discussion_r961090751">PR review comment</a>:</p>
<blockquote>
<p>Why do just a few runtests need stack-probing disabled?</p>
</blockquote>



<a name="296701039"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%234747%20cranelift%3A%20Add%20inline%20stack%20probing%20f.../near/296701039" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.234747.20cranelift.3A.20Add.20inline.20stack.20probing.20f.2E.2E.2E.html#296701039">(Sep 01 2022 at 21:14)</a>:</h4>
<p>afonso360 updated <a href="https://github.com/bytecodealliance/wasmtime/pull/4747">PR #4747</a> from <code>inline-stackprobing</code> to <code>main</code>.</p>



<a name="296701516"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%234747%20cranelift%3A%20Add%20inline%20stack%20probing%20f.../near/296701516" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.234747.20cranelift.3A.20Add.20inline.20stack.20probing.20f.2E.2E.2E.html#296701516">(Sep 01 2022 at 21:18)</a>:</h4>
<p>afonso360 submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/4747#pullrequestreview-1094070960">PR review</a>.</p>



<a name="296701517"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%234747%20cranelift%3A%20Add%20inline%20stack%20probing%20f.../near/296701517" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.234747.20cranelift.3A.20Add.20inline.20stack.20probing.20f.2E.2E.2E.html#296701517">(Sep 01 2022 at 21:18)</a>:</h4>
<p>afonso360 created <a href="https://github.com/bytecodealliance/wasmtime/pull/4747#discussion_r961109910">PR review comment</a>:</p>
<blockquote>
<p>These tests have stack slots above the threshold where we emit a stack probe. The default strategy is to outline the stack probing to a external function call, but since we never provide an implementation for that anywhere the JIT can't link these tests, so they fail.</p>
<p>I manually disabled stack probing for these which reflects the old behaviour of force disabling it everywhere.</p>
</blockquote>



<a name="296701783"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%234747%20cranelift%3A%20Add%20inline%20stack%20probing%20f.../near/296701783" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.234747.20cranelift.3A.20Add.20inline.20stack.20probing.20f.2E.2E.2E.html#296701783">(Sep 01 2022 at 21:20)</a>:</h4>
<p>afonso360 edited <a href="https://github.com/bytecodealliance/wasmtime/pull/4747#discussion_r961109910">PR review comment</a>.</p>



<a name="296702803"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%234747%20cranelift%3A%20Add%20inline%20stack%20probing%20f.../near/296702803" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.234747.20cranelift.3A.20Add.20inline.20stack.20probing.20f.2E.2E.2E.html#296702803">(Sep 01 2022 at 21:27)</a>:</h4>
<p>jameysharp has enabled auto merge for <a href="https://github.com/bytecodealliance/wasmtime/pull/4747">PR #4747</a>.</p>



<a name="296710144"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%234747%20cranelift%3A%20Add%20inline%20stack%20probing%20f.../near/296710144" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.234747.20cranelift.3A.20Add.20inline.20stack.20probing.20f.2E.2E.2E.html#296710144">(Sep 01 2022 at 22:32)</a>:</h4>
<p>jameysharp merged <a href="https://github.com/bytecodealliance/wasmtime/pull/4747">PR #4747</a>.</p>



<hr><p>Last updated: Jan 20 2025 at 06:04 UTC</p>
</html>