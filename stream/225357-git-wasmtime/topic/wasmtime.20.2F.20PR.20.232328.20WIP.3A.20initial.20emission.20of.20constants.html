<html>
<head><meta charset="utf-8"><title>wasmtime / PR #2328 WIP: initial emission of constants · git-wasmtime · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/index.html">git-wasmtime</a></h2>
<h3>Topic: <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232328.20WIP.3A.20initial.20emission.20of.20constants.html">wasmtime / PR #2328 WIP: initial emission of constants</a></h3>

<hr>

<base href="https://bytecodealliance.zulipchat.com">

<head><link href="https://bytecodealliance.github.io/zulip-archive/style.css" rel="stylesheet"></head>

<a name="214747404"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232328%20WIP%3A%20initial%20emission%20of%20constants/near/214747404" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232328.20WIP.3A.20initial.20emission.20of.20constants.html#214747404">(Oct 27 2020 at 18:57)</a>:</h4>
<p>abrown opened <a href="https://github.com/bytecodealliance/wasmtime/pull/2328">PR #2328</a> from <code>constants</code> to <code>main</code>:</p>
<blockquote>
<p>@cfallin, based on what we discussed in Zulip and #1385, here's a first pass on a way to emit constants using <code>MachBuffer::defer_constant</code>. Note that I had to do two mappings--one from <code>Constant</code> to <code>UsedConstant</code> and another from <code>UsedConstant</code> to <code>MachLabel</code>--in order to make this work ("work" is too strong--"compile"). I'm interested in your feedback before I fix this up and improve <code>gen_constant</code>.</p>
</blockquote>



<a name="214747405"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232328%20WIP%3A%20initial%20emission%20of%20constants/near/214747405" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232328.20WIP.3A.20initial.20emission.20of.20constants.html#214747405">(Oct 27 2020 at 18:57)</a>:</h4>
<p><strong>abrown</strong> requested <a href="https://github.com/cfallin">cfallin</a> for a review on <a href="https://github.com/bytecodealliance/wasmtime/pull/2328">PR #2328</a>.</p>



<a name="214774150"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232328%20WIP%3A%20initial%20emission%20of%20constants/near/214774150" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232328.20WIP.3A.20initial.20emission.20of.20constants.html#214774150">(Oct 27 2020 at 22:44)</a>:</h4>
<p>cfallin submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/2328#pullrequestreview-518205996">PR Review</a>.</p>



<a name="215039241"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232328%20WIP%3A%20initial%20emission%20of%20constants/near/215039241" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232328.20WIP.3A.20initial.20emission.20of.20constants.html#215039241">(Oct 29 2020 at 22:59)</a>:</h4>
<p>cfallin submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/2328#pullrequestreview-520145103">PR Review</a>.</p>



<a name="215039243"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232328%20WIP%3A%20initial%20emission%20of%20constants/near/215039243" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232328.20WIP.3A.20initial.20emission.20of.20constants.html#215039243">(Oct 29 2020 at 22:59)</a>:</h4>
<p>cfallin submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/2328#pullrequestreview-520145103">PR Review</a>.</p>



<a name="215039244"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232328%20WIP%3A%20initial%20emission%20of%20constants/near/215039244" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232328.20WIP.3A.20initial.20emission.20of.20constants.html#215039244">(Oct 29 2020 at 22:59)</a>:</h4>
<p>cfallin created <a href="https://github.com/bytecodealliance/wasmtime/pull/2328#discussion_r514613405">PR Review Comment</a>:</p>
<blockquote>
<p>This is actually inside the per-block loop body, so this would emit one copy of each (function-wide) constant per basic block. I don't think this is what was intended :-)</p>
</blockquote>



<a name="215039245"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232328%20WIP%3A%20initial%20emission%20of%20constants/near/215039245" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232328.20WIP.3A.20initial.20emission.20of.20constants.html#215039245">(Oct 29 2020 at 22:59)</a>:</h4>
<p>cfallin created <a href="https://github.com/bytecodealliance/wasmtime/pull/2328#discussion_r514613727">PR Review Comment</a>:</p>
<blockquote>
<p>Would it be sufficient in all cases to align to the size (so e.g. 8-byte constants are 8-byte-aligned, ...)? Or are there cases where we need more than that?</p>
</blockquote>



<a name="215039246"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232328%20WIP%3A%20initial%20emission%20of%20constants/near/215039246" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232328.20WIP.3A.20initial.20emission.20of.20constants.html#215039246">(Oct 29 2020 at 22:59)</a>:</h4>
<p>cfallin created <a href="https://github.com/bytecodealliance/wasmtime/pull/2328#discussion_r514614184">PR Review Comment</a>:</p>
<blockquote>
<p>I'm trying to think of a better name for this -- would just <code>VCodeConstant</code> be more fitting, do you think, since they live in the <code>VCode</code>?</p>
</blockquote>



<a name="215138400"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232328%20WIP%3A%20initial%20emission%20of%20constants/near/215138400" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232328.20WIP.3A.20initial.20emission.20of.20constants.html#215138400">(Oct 30 2020 at 19:11)</a>:</h4>
<p>abrown updated <a href="https://github.com/bytecodealliance/wasmtime/pull/2328">PR #2328</a> from <code>constants</code> to <code>main</code>:</p>
<blockquote>
<p>@cfallin, based on what we discussed in Zulip and #1385, here's a first pass on a way to emit constants using <code>MachBuffer::defer_constant</code>. Note that I had to do two mappings--one from <code>Constant</code> to <code>UsedConstant</code> and another from <code>UsedConstant</code> to <code>MachLabel</code>--in order to make this work ("work" is too strong--"compile"). I'm interested in your feedback before I fix this up and improve <code>gen_constant</code>.</p>
</blockquote>



<a name="215498658"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232328%20WIP%3A%20initial%20emission%20of%20constants/near/215498658" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232328.20WIP.3A.20initial.20emission.20of.20constants.html#215498658">(Nov 03 2020 at 19:17)</a>:</h4>
<p>abrown updated <a href="https://github.com/bytecodealliance/wasmtime/pull/2328">PR #2328</a> from <code>constants</code> to <code>main</code>:</p>
<blockquote>
<p>@cfallin, based on what we discussed in Zulip and #1385, here's a first pass on a way to emit constants using <code>MachBuffer::defer_constant</code>. Note that I had to do two mappings--one from <code>Constant</code> to <code>UsedConstant</code> and another from <code>UsedConstant</code> to <code>MachLabel</code>--in order to make this work ("work" is too strong--"compile"). I'm interested in your feedback before I fix this up and improve <code>gen_constant</code>.</p>
</blockquote>



<a name="215499139"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232328%20WIP%3A%20initial%20emission%20of%20constants/near/215499139" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232328.20WIP.3A.20initial.20emission.20of.20constants.html#215499139">(Nov 03 2020 at 19:21)</a>:</h4>
<p>abrown submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/2328#pullrequestreview-522807491">PR Review</a>.</p>



<a name="215499140"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232328%20WIP%3A%20initial%20emission%20of%20constants/near/215499140" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232328.20WIP.3A.20initial.20emission.20of.20constants.html#215499140">(Nov 03 2020 at 19:21)</a>:</h4>
<p>abrown created <a href="https://github.com/bytecodealliance/wasmtime/pull/2328#discussion_r516901907">PR Review Comment</a>:</p>
<blockquote>
<p>Check out the new <code>VCodeConstantData::alignment</code> and let me know what you think.</p>
</blockquote>



<a name="215500741"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232328%20WIP%3A%20initial%20emission%20of%20constants/near/215500741" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232328.20WIP.3A.20initial.20emission.20of.20constants.html#215500741">(Nov 03 2020 at 19:37)</a>:</h4>
<p>abrown updated <a href="https://github.com/bytecodealliance/wasmtime/pull/2328">PR #2328</a> from <code>constants</code> to <code>main</code>:</p>
<blockquote>
<p>@cfallin, based on what we discussed in Zulip and #1385, here's a first pass on a way to emit constants using <code>MachBuffer::defer_constant</code>. Note that I had to do two mappings--one from <code>Constant</code> to <code>UsedConstant</code> and another from <code>UsedConstant</code> to <code>MachLabel</code>--in order to make this work ("work" is too strong--"compile"). I'm interested in your feedback before I fix this up and improve <code>gen_constant</code>.</p>
</blockquote>



<a name="215500852"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232328%20WIP%3A%20initial%20emission%20of%20constants/near/215500852" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232328.20WIP.3A.20initial.20emission.20of.20constants.html#215500852">(Nov 03 2020 at 19:38)</a>:</h4>
<p>abrown updated <a href="https://github.com/bytecodealliance/wasmtime/pull/2328">PR #2328</a> from <code>constants</code> to <code>main</code>:</p>
<blockquote>
<p>@cfallin, based on what we discussed in Zulip and #1385, here's a first pass on a way to emit constants using <code>MachBuffer::defer_constant</code>. Note that I had to do two mappings--one from <code>Constant</code> to <code>UsedConstant</code> and another from <code>UsedConstant</code> to <code>MachLabel</code>--in order to make this work ("work" is too strong--"compile"). I'm interested in your feedback before I fix this up and improve <code>gen_constant</code>.</p>
</blockquote>



<a name="215501487"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232328%20WIP%3A%20initial%20emission%20of%20constants/near/215501487" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232328.20WIP.3A.20initial.20emission.20of.20constants.html#215501487">(Nov 03 2020 at 19:45)</a>:</h4>
<p>abrown submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/2328#pullrequestreview-522823329">PR Review</a>.</p>



<a name="215501488"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232328%20WIP%3A%20initial%20emission%20of%20constants/near/215501488" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232328.20WIP.3A.20initial.20emission.20of.20constants.html#215501488">(Nov 03 2020 at 19:45)</a>:</h4>
<p>abrown created <a href="https://github.com/bytecodealliance/wasmtime/pull/2328#discussion_r516914712">PR Review Comment</a>:</p>
<blockquote>
<p>We could make this more granular but I am guessing this is good enough for now?</p>
</blockquote>



<a name="215501521"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232328%20WIP%3A%20initial%20emission%20of%20constants/near/215501521" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232328.20WIP.3A.20initial.20emission.20of.20constants.html#215501521">(Nov 03 2020 at 19:45)</a>:</h4>
<p>abrown submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/2328#pullrequestreview-522823564">PR Review</a>.</p>



<a name="215501522"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232328%20WIP%3A%20initial%20emission%20of%20constants/near/215501522" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232328.20WIP.3A.20initial.20emission.20of.20constants.html#215501522">(Nov 03 2020 at 19:45)</a>:</h4>
<p>abrown created <a href="https://github.com/bytecodealliance/wasmtime/pull/2328#discussion_r516914886">PR Review Comment</a>:</p>
<blockquote>
<p>@cfallin, take a look at this. The compile-time memory usage will definitely be higher if we de-duplicate constants. As you know, there's quite the trade-off here:</p>
<ul>
<li>either we pay for these structures in compile-time memory</li>
<li>we pay for de-duplication with compile-time CPU usage (compare new constant values byte-by-byte with every other previously-inserted constant value)</li>
<li>or we pay with additional code-size in the emitted binary</li>
</ul>
<p>The way it is written now we can safely rip out the two <code>HashMap</code>s and all of this will still work.</p>
</blockquote>



<a name="215501842"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232328%20WIP%3A%20initial%20emission%20of%20constants/near/215501842" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232328.20WIP.3A.20initial.20emission.20of.20constants.html#215501842">(Nov 03 2020 at 19:48)</a>:</h4>
<p>abrown submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/2328#pullrequestreview-522825258">PR Review</a>.</p>



<a name="215501843"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232328%20WIP%3A%20initial%20emission%20of%20constants/near/215501843" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232328.20WIP.3A.20initial.20emission.20of.20constants.html#215501843">(Nov 03 2020 at 19:48)</a>:</h4>
<p>abrown created <a href="https://github.com/bytecodealliance/wasmtime/pull/2328#discussion_r516916248">PR Review Comment</a>:</p>
<blockquote>
<p>@cfallin, I tried adding a <code>WellKnown</code> enum to <code>Amode</code> but I realized that this way is better: 1) if we want to de-duplicate we can, and 2) all of this constant code is co-located, which makes it a little more comprehensible for other developers (a little of it ends up affecting <code>MachBuffer</code> but that is just the easiest way to do things)</p>
</blockquote>



<hr><p>Last updated: Jan 20 2025 at 06:04 UTC</p>
</html>