<html>
<head><meta charset="utf-8"><title>wasmtime / PR #7208 riscv64: Fix encoding for `c.addi4spn` · git-wasmtime · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/index.html">git-wasmtime</a></h2>
<h3>Topic: <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.237208.20riscv64.3A.20Fix.20encoding.20for.20.60c.2Eaddi4spn.60.html">wasmtime / PR #7208 riscv64: Fix encoding for `c.addi4spn`</a></h3>

<hr>

<base href="https://bytecodealliance.zulipchat.com">

<head><link href="https://bytecodealliance.github.io/zulip-archive/style.css" rel="stylesheet"></head>

<a name="395902308"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%237208%20riscv64%3A%20Fix%20encoding%20for%20%60c.addi4spn%60/near/395902308" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.237208.20riscv64.3A.20Fix.20encoding.20for.20.60c.2Eaddi4spn.60.html#395902308">(Oct 10 2023 at 14:57)</a>:</h4>
<p>afonso360 opened <a href="https://github.com/bytecodealliance/wasmtime/pull/7208">PR #7208</a> from <code>afonso360:riscv-fix-addi4spn-encoding</code> to <code>bytecodealliance:main</code>:</p>
<blockquote>
<p><span aria-label="wave" class="emoji emoji-1f44b" role="img" title="wave">:wave:</span> Hey,</p>
<p>I was running fuzzgen on riscv when it crashed with an illegal instruction. When generating large stack offsets, we can use the compressed instruction <code>c.addi4spn</code>, It has a range of <code>{4,1020}</code> bytes. However we were accidentally not encoding the MSB on the immediate field.</p>
<p>This meant that the instruction would be encoded with an offset of 0, which is illegal for this instruction.  The fix here is to ensure that the MSB bit is encoded correctly.</p>
</blockquote>



<a name="395902312"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%237208%20riscv64%3A%20Fix%20encoding%20for%20%60c.addi4spn%60/near/395902312" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.237208.20riscv64.3A.20Fix.20encoding.20for.20.60c.2Eaddi4spn.60.html#395902312">(Oct 10 2023 at 14:57)</a>:</h4>
<p><strong>afonso360</strong> requested <a href="https://github.com/fitzgen">fitzgen</a> for a review on <a href="https://github.com/bytecodealliance/wasmtime/pull/7208">PR #7208</a>.</p>



<a name="395902313"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%237208%20riscv64%3A%20Fix%20encoding%20for%20%60c.addi4spn%60/near/395902313" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.237208.20riscv64.3A.20Fix.20encoding.20for.20.60c.2Eaddi4spn.60.html#395902313">(Oct 10 2023 at 14:57)</a>:</h4>
<p><strong>afonso360</strong> requested <a href="https://github.com/orgs/bytecodealliance/teams/wasmtime-compiler-reviewers">wasmtime-compiler-reviewers</a> for a review on <a href="https://github.com/bytecodealliance/wasmtime/pull/7208">PR #7208</a>.</p>



<a name="395925130"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%237208%20riscv64%3A%20Fix%20encoding%20for%20%60c.addi4spn%60/near/395925130" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.237208.20riscv64.3A.20Fix.20encoding.20for.20.60c.2Eaddi4spn.60.html#395925130">(Oct 10 2023 at 17:05)</a>:</h4>
<p>fitzgen submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/7208#pullrequestreview-1668412982">PR review</a>.</p>



<a name="395925131"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%237208%20riscv64%3A%20Fix%20encoding%20for%20%60c.addi4spn%60/near/395925131" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.237208.20riscv64.3A.20Fix.20encoding.20for.20.60c.2Eaddi4spn.60.html#395925131">(Oct 10 2023 at 17:05)</a>:</h4>
<p>fitzgen submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/7208#pullrequestreview-1668412982">PR review</a>.</p>



<a name="395925133"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%237208%20riscv64%3A%20Fix%20encoding%20for%20%60c.addi4spn%60/near/395925133" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.237208.20riscv64.3A.20Fix.20encoding.20for.20.60c.2Eaddi4spn.60.html#395925133">(Oct 10 2023 at 17:05)</a>:</h4>
<p>fitzgen created <a href="https://github.com/bytecodealliance/wasmtime/pull/7208#discussion_r1353009110">PR review comment</a>:</p>
<blockquote>
<p>Do we have <code>emit_tests.rs</code> for riscv64? I would kind of expect some updated tests in there that exercise this, rather than just the checked in fuzz test.</p>
</blockquote>



<a name="395929515"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%237208%20riscv64%3A%20Fix%20encoding%20for%20%60c.addi4spn%60/near/395929515" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.237208.20riscv64.3A.20Fix.20encoding.20for.20.60c.2Eaddi4spn.60.html#395929515">(Oct 10 2023 at 17:37)</a>:</h4>
<p>afonso360 submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/7208#pullrequestreview-1668474493">PR review</a>.</p>



<a name="395929517"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%237208%20riscv64%3A%20Fix%20encoding%20for%20%60c.addi4spn%60/near/395929517" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.237208.20riscv64.3A.20Fix.20encoding.20for.20.60c.2Eaddi4spn.60.html#395929517">(Oct 10 2023 at 17:37)</a>:</h4>
<p>afonso360 created <a href="https://github.com/bytecodealliance/wasmtime/pull/7208#discussion_r1353049147">PR review comment</a>:</p>
<blockquote>
<p>I've been using the disassembled section in the compile tests as a check that the encodings are correct. However, we don't have many compile tests specifically for C instructions. Most of them test only with the Base ISA and don't enable the other extensions so they won't be emitting this instruction.</p>
</blockquote>



<a name="395929706"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%237208%20riscv64%3A%20Fix%20encoding%20for%20%60c.addi4spn%60/near/395929706" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.237208.20riscv64.3A.20Fix.20encoding.20for.20.60c.2Eaddi4spn.60.html#395929706">(Oct 10 2023 at 17:38)</a>:</h4>
<p>afonso360 edited <a href="https://github.com/bytecodealliance/wasmtime/pull/7208#discussion_r1353049147">PR review comment</a>.</p>



<a name="395931055"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%237208%20riscv64%3A%20Fix%20encoding%20for%20%60c.addi4spn%60/near/395931055" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.237208.20riscv64.3A.20Fix.20encoding.20for.20.60c.2Eaddi4spn.60.html#395931055">(Oct 10 2023 at 17:48)</a>:</h4>
<p>afonso360 edited <a href="https://github.com/bytecodealliance/wasmtime/pull/7208#discussion_r1353049147">PR review comment</a>.</p>



<a name="395948672"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%237208%20riscv64%3A%20Fix%20encoding%20for%20%60c.addi4spn%60/near/395948672" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.237208.20riscv64.3A.20Fix.20encoding.20for.20.60c.2Eaddi4spn.60.html#395948672">(Oct 10 2023 at 19:30)</a>:</h4>
<p>fitzgen submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/7208#pullrequestreview-1668734640">PR review</a>.</p>



<a name="395948674"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%237208%20riscv64%3A%20Fix%20encoding%20for%20%60c.addi4spn%60/near/395948674" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.237208.20riscv64.3A.20Fix.20encoding.20for.20.60c.2Eaddi4spn.60.html#395948674">(Oct 10 2023 at 19:30)</a>:</h4>
<p>fitzgen created <a href="https://github.com/bytecodealliance/wasmtime/pull/7208#discussion_r1353228038">PR review comment</a>:</p>
<blockquote>
<p>Right, I guess before merging this I would like to have either a test in <code>emit_tests.rs</code> that does some loop over min/max/etc values for this type of immediate and encodes each of them or something else like that in spirit (e.g. a series of <code>c.addi4spn</code> instructions with various min/max/etc values in a filetest).</p>
</blockquote>



<a name="396142529"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%237208%20riscv64%3A%20Fix%20encoding%20for%20%60c.addi4spn%60/near/396142529" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.237208.20riscv64.3A.20Fix.20encoding.20for.20.60c.2Eaddi4spn.60.html#396142529">(Oct 11 2023 at 18:13)</a>:</h4>
<p>afonso360 updated <a href="https://github.com/bytecodealliance/wasmtime/pull/7208">PR #7208</a>.</p>



<a name="396142977"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%237208%20riscv64%3A%20Fix%20encoding%20for%20%60c.addi4spn%60/near/396142977" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.237208.20riscv64.3A.20Fix.20encoding.20for.20.60c.2Eaddi4spn.60.html#396142977">(Oct 11 2023 at 18:16)</a>:</h4>
<p>afonso360 submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/7208#pullrequestreview-1672186909">PR review</a>.</p>



<a name="396142978"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%237208%20riscv64%3A%20Fix%20encoding%20for%20%60c.addi4spn%60/near/396142978" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.237208.20riscv64.3A.20Fix.20encoding.20for.20.60c.2Eaddi4spn.60.html#396142978">(Oct 11 2023 at 18:16)</a>:</h4>
<p>afonso360 created <a href="https://github.com/bytecodealliance/wasmtime/pull/7208#discussion_r1355548559">PR review comment</a>:</p>
<blockquote>
<p>I've added a test for both min and max values as well as one that sets a bit in each subfield in the immediate of the instruction. I've also added tests for out of bound values.</p>
<p>I added them into <code>zca.clif</code> instead of <code>emit_tests.rs</code>, since its slightly awkward to add these there because they are encoding only changes we don't actually know the name of the instruction in cranelift. So the test would look something like <code>addi a1, sp, 4</code> but the result is a 2 byte <code>c.addisp4n</code>.</p>
</blockquote>



<a name="396155807"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%237208%20riscv64%3A%20Fix%20encoding%20for%20%60c.addi4spn%60/near/396155807" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.237208.20riscv64.3A.20Fix.20encoding.20for.20.60c.2Eaddi4spn.60.html#396155807">(Oct 11 2023 at 19:51)</a>:</h4>
<p>fitzgen submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/7208#pullrequestreview-1672431699">PR review</a>:</p>
<blockquote>
<p>Thanks!</p>
</blockquote>



<a name="396161351"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%237208%20riscv64%3A%20Fix%20encoding%20for%20%60c.addi4spn%60/near/396161351" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.237208.20riscv64.3A.20Fix.20encoding.20for.20.60c.2Eaddi4spn.60.html#396161351">(Oct 11 2023 at 20:36)</a>:</h4>
<p>fitzgen merged <a href="https://github.com/bytecodealliance/wasmtime/pull/7208">PR #7208</a>.</p>



<hr><p>Last updated: Jan 20 2025 at 06:04 UTC</p>
</html>