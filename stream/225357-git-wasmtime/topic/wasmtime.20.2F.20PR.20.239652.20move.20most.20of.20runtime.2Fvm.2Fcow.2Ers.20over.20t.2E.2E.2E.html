<html>
<head><meta charset="utf-8"><title>wasmtime / PR #9652 move most of runtime/vm/cow.rs over t... · git-wasmtime · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/index.html">git-wasmtime</a></h2>
<h3>Topic: <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.239652.20move.20most.20of.20runtime.2Fvm.2Fcow.2Ers.20over.20t.2E.2E.2E.html">wasmtime / PR #9652 move most of runtime/vm/cow.rs over t...</a></h3>

<hr>

<base href="https://bytecodealliance.zulipchat.com">

<head><link href="https://bytecodealliance.github.io/zulip-archive/style.css" rel="stylesheet"></head>

<a name="483843138"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%239652%20move%20most%20of%20runtime/vm/cow.rs%20over%20t.../near/483843138" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.239652.20move.20most.20of.20runtime.2Fvm.2Fcow.2Ers.20over.20t.2E.2E.2E.html#483843138">(Nov 22 2024 at 06:09)</a>:</h4>
<p>sunshowers opened <a href="https://github.com/bytecodealliance/wasmtime/pull/9652">PR #9652</a> from <code>sunshowers:cow-aligned</code> to <code>bytecodealliance:main</code>:</p>
<blockquote>
<p>As part of attempting to move some of these operations over to <code>Mmap</code> instances, it is nice to have type-level checking for aligned sizes. In upcoming PRs, APIs like <code>map_at</code> will be switched to using <code>Mmap</code> instances with aligned counts.</p>
<p>There are a couple of spots where I have questions -- will flag them in review comments.</p>
</blockquote>



<a name="483843139"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%239652%20move%20most%20of%20runtime/vm/cow.rs%20over%20t.../near/483843139" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.239652.20move.20most.20of.20runtime.2Fvm.2Fcow.2Ers.20over.20t.2E.2E.2E.html#483843139">(Nov 22 2024 at 06:09)</a>:</h4>
<p><strong>sunshowers</strong> requested <a href="https://github.com/alexcrichton">alexcrichton</a> for a review on <a href="https://github.com/bytecodealliance/wasmtime/pull/9652">PR #9652</a>.</p>



<a name="483843140"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%239652%20move%20most%20of%20runtime/vm/cow.rs%20over%20t.../near/483843140" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.239652.20move.20most.20of.20runtime.2Fvm.2Fcow.2Ers.20over.20t.2E.2E.2E.html#483843140">(Nov 22 2024 at 06:09)</a>:</h4>
<p><strong>sunshowers</strong> requested <a href="https://github.com/orgs/bytecodealliance/teams/wasmtime-core-reviewers">wasmtime-core-reviewers</a> for a review on <a href="https://github.com/bytecodealliance/wasmtime/pull/9652">PR #9652</a>.</p>



<a name="483843329"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%239652%20move%20most%20of%20runtime/vm/cow.rs%20over%20t.../near/483843329" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.239652.20move.20most.20of.20runtime.2Fvm.2Fcow.2Ers.20over.20t.2E.2E.2E.html#483843329">(Nov 22 2024 at 06:10)</a>:</h4>
<p>sunshowers submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/9652#pullrequestreview-2453399680">PR review</a>.</p>



<a name="483843330"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%239652%20move%20most%20of%20runtime/vm/cow.rs%20over%20t.../near/483843330" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.239652.20move.20most.20of.20runtime.2Fvm.2Fcow.2Ers.20over.20t.2E.2E.2E.html#483843330">(Nov 22 2024 at 06:10)</a>:</h4>
<p>sunshowers created <a href="https://github.com/bytecodealliance/wasmtime/pull/9652#discussion_r1853334858">PR review comment</a>:</p>
<blockquote>
<p>Thoughts about this? I tried to be super cautious about signs this time.</p>
</blockquote>



<a name="483843332"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%239652%20move%20most%20of%20runtime/vm/cow.rs%20over%20t.../near/483843332" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.239652.20move.20most.20of.20runtime.2Fvm.2Fcow.2Ers.20over.20t.2E.2E.2E.html#483843332">(Nov 22 2024 at 06:10)</a>:</h4>
<p>sunshowers created <a href="https://github.com/bytecodealliance/wasmtime/pull/9652#discussion_r1853335684">PR review comment</a>:</p>
<blockquote>
<p>Wasn't clear to me whether this was possible -- there are several offsets here that all interact with each other.</p>
</blockquote>



<a name="483843497"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%239652%20move%20most%20of%20runtime/vm/cow.rs%20over%20t.../near/483843497" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.239652.20move.20most.20of.20runtime.2Fvm.2Fcow.2Ers.20over.20t.2E.2E.2E.html#483843497">(Nov 22 2024 at 06:12)</a>:</h4>
<p>sunshowers updated <a href="https://github.com/bytecodealliance/wasmtime/pull/9652">PR #9652</a>.</p>



<a name="483844008"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%239652%20move%20most%20of%20runtime/vm/cow.rs%20over%20t.../near/483844008" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.239652.20move.20most.20of.20runtime.2Fvm.2Fcow.2Ers.20over.20t.2E.2E.2E.html#483844008">(Nov 22 2024 at 06:18)</a>:</h4>
<p>sunshowers edited <a href="https://github.com/bytecodealliance/wasmtime/pull/9652#discussion_r1853334858">PR review comment</a>.</p>



<a name="483964222"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%239652%20move%20most%20of%20runtime/vm/cow.rs%20over%20t.../near/483964222" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.239652.20move.20most.20of.20runtime.2Fvm.2Fcow.2Ers.20over.20t.2E.2E.2E.html#483964222">(Nov 22 2024 at 18:04)</a>:</h4>
<p>alexcrichton submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/9652#pullrequestreview-2455258597">PR review</a>:</p>
<blockquote>
<p>Thanks for this!</p>
</blockquote>



<a name="483964223"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%239652%20move%20most%20of%20runtime/vm/cow.rs%20over%20t.../near/483964223" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.239652.20move.20most.20of.20runtime.2Fvm.2Fcow.2Ers.20over.20t.2E.2E.2E.html#483964223">(Nov 22 2024 at 18:04)</a>:</h4>
<p>alexcrichton created <a href="https://github.com/bytecodealliance/wasmtime/pull/9652#discussion_r1854405860">PR review comment</a>:</p>
<blockquote>
<p>I think this is safe to be <code>.unwrap()</code> since the bounds checks above I think rule out the underflow in this case</p>
</blockquote>



<a name="483964224"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%239652%20move%20most%20of%20runtime/vm/cow.rs%20over%20t.../near/483964224" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.239652.20move.20most.20of.20runtime.2Fvm.2Fcow.2Ers.20over.20t.2E.2E.2E.html#483964224">(Nov 22 2024 at 18:04)</a>:</h4>
<p>alexcrichton created <a href="https://github.com/bytecodealliance/wasmtime/pull/9652#discussion_r1854425220">PR review comment</a>:</p>
<blockquote>
<p>Would it be possible to keep the same <code>&lt;</code> condition as before? I find that one a bit easier to understand in terms of the diagrams below personally.</p>
</blockquote>



<a name="483964225"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%239652%20move%20most%20of%20runtime/vm/cow.rs%20over%20t.../near/483964225" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.239652.20move.20most.20of.20runtime.2Fvm.2Fcow.2Ers.20over.20t.2E.2E.2E.html#483964225">(Nov 22 2024 at 18:04)</a>:</h4>
<p>alexcrichton created <a href="https://github.com/bytecodealliance/wasmtime/pull/9652#discussion_r1854409231">PR review comment</a>:</p>
<blockquote>
<p>Could these stay defined where they were below to keep their definition close to the diagram explaining what they are?</p>
</blockquote>



<a name="484005629"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%239652%20move%20most%20of%20runtime/vm/cow.rs%20over%20t.../near/484005629" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.239652.20move.20most.20of.20runtime.2Fvm.2Fcow.2Ers.20over.20t.2E.2E.2E.html#484005629">(Nov 22 2024 at 23:06)</a>:</h4>
<p>sunshowers updated <a href="https://github.com/bytecodealliance/wasmtime/pull/9652">PR #9652</a>.</p>



<a name="484005673"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%239652%20move%20most%20of%20runtime/vm/cow.rs%20over%20t.../near/484005673" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.239652.20move.20most.20of.20runtime.2Fvm.2Fcow.2Ers.20over.20t.2E.2E.2E.html#484005673">(Nov 22 2024 at 23:07)</a>:</h4>
<p>sunshowers submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/9652#pullrequestreview-2455946221">PR review</a>.</p>



<a name="484005674"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%239652%20move%20most%20of%20runtime/vm/cow.rs%20over%20t.../near/484005674" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.239652.20move.20most.20of.20runtime.2Fvm.2Fcow.2Ers.20over.20t.2E.2E.2E.html#484005674">(Nov 22 2024 at 23:07)</a>:</h4>
<p>sunshowers created <a href="https://github.com/bytecodealliance/wasmtime/pull/9652#discussion_r1854859420">PR review comment</a>:</p>
<blockquote>
<p>Yeah good idea, much more understandable with this and the below change.</p>
</blockquote>



<a name="484005675"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%239652%20move%20most%20of%20runtime/vm/cow.rs%20over%20t.../near/484005675" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.239652.20move.20most.20of.20runtime.2Fvm.2Fcow.2Ers.20over.20t.2E.2E.2E.html#484005675">(Nov 22 2024 at 23:07)</a>:</h4>
<p>sunshowers created <a href="https://github.com/bytecodealliance/wasmtime/pull/9652#discussion_r1854858845">PR review comment</a>:</p>
<blockquote>
<p>Okay -- to be honest I'm not entirely sure that this is the case in reality, it seems like in configuration you could define keep_resident to be more then the byte size. But in any case this should panic (and if there is such a condition it should be handled at a higher level)</p>
</blockquote>



<a name="484006005"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%239652%20move%20most%20of%20runtime/vm/cow.rs%20over%20t.../near/484006005" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.239652.20move.20most.20of.20runtime.2Fvm.2Fcow.2Ers.20over.20t.2E.2E.2E.html#484006005">(Nov 22 2024 at 23:10)</a>:</h4>
<p>sunshowers <a href="https://github.com/bytecodealliance/wasmtime/pull/9652#issuecomment-2495071764">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/9652">PR #9652</a>:</p>
<blockquote>
<p>ugh, attempting to fix the no-std build</p>
</blockquote>



<a name="484006652"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%239652%20move%20most%20of%20runtime/vm/cow.rs%20over%20t.../near/484006652" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.239652.20move.20most.20of.20runtime.2Fvm.2Fcow.2Ers.20over.20t.2E.2E.2E.html#484006652">(Nov 22 2024 at 23:16)</a>:</h4>
<p>sunshowers updated <a href="https://github.com/bytecodealliance/wasmtime/pull/9652">PR #9652</a>.</p>



<a name="484007002"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%239652%20move%20most%20of%20runtime/vm/cow.rs%20over%20t.../near/484007002" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.239652.20move.20most.20of.20runtime.2Fvm.2Fcow.2Ers.20over.20t.2E.2E.2E.html#484007002">(Nov 22 2024 at 23:20)</a>:</h4>
<p>sunshowers submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/9652#pullrequestreview-2455974834">PR review</a>.</p>



<a name="484007003"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%239652%20move%20most%20of%20runtime/vm/cow.rs%20over%20t.../near/484007003" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.239652.20move.20most.20of.20runtime.2Fvm.2Fcow.2Ers.20over.20t.2E.2E.2E.html#484007003">(Nov 22 2024 at 23:20)</a>:</h4>
<p>sunshowers created <a href="https://github.com/bytecodealliance/wasmtime/pull/9652#discussion_r1854874813">PR review comment</a>:</p>
<blockquote>
<p>Done.</p>
</blockquote>



<a name="484007936"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%239652%20move%20most%20of%20runtime/vm/cow.rs%20over%20t.../near/484007936" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.239652.20move.20most.20of.20runtime.2Fvm.2Fcow.2Ers.20over.20t.2E.2E.2E.html#484007936">(Nov 22 2024 at 23:30)</a>:</h4>
<p>alexcrichton submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/9652#pullrequestreview-2455996333">PR review</a>.</p>



<a name="484009355"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%239652%20move%20most%20of%20runtime/vm/cow.rs%20over%20t.../near/484009355" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.239652.20move.20most.20of.20runtime.2Fvm.2Fcow.2Ers.20over.20t.2E.2E.2E.html#484009355">(Nov 22 2024 at 23:46)</a>:</h4>
<p>alexcrichton merged <a href="https://github.com/bytecodealliance/wasmtime/pull/9652">PR #9652</a>.</p>



<hr><p>Last updated: Jan 20 2025 at 06:04 UTC</p>
</html>