<html>
<head><meta charset="utf-8"><title>wasmtime / PR #5252 Cranelift(Aarch64): Optimize lowering... · git-wasmtime · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/index.html">git-wasmtime</a></h2>
<h3>Topic: <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.235252.20Cranelift.28Aarch64.29.3A.20Optimize.20lowering.2E.2E.2E.html">wasmtime / PR #5252 Cranelift(Aarch64): Optimize lowering...</a></h3>

<hr>

<base href="https://bytecodealliance.zulipchat.com">

<head><link href="https://bytecodealliance.github.io/zulip-archive/style.css" rel="stylesheet"></head>

<a name="309105317"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%235252%20Cranelift%28Aarch64%29%3A%20Optimize%20lowering.../near/309105317" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.235252.20Cranelift.28Aarch64.29.3A.20Optimize.20lowering.2E.2E.2E.html#309105317">(Nov 10 2022 at 23:58)</a>:</h4>
<p>fitzgen opened <a href="https://github.com/bytecodealliance/wasmtime/pull/5252">PR #5252</a> from <code>optimize-comparisons-with-immediates-on-aarch64</code> to <code>main</code>:</p>
<blockquote>
<p>We can encode more constants into 12-bit immediates if we do the following rewrite for comparisons with odd constants:</p>
<div class="codehilite"><pre><span></span><code>    A &gt;= B + 1
==&gt; A - 1 &gt;= B
==&gt; A &gt; B
</code></pre></div>

<p>(And similar for less-than-or-equals.)</p>
<p>&lt;!--</p>
<p>Please ensure that the following steps are all taken care of before submitting<br>
the PR.</p>
<ul>
<li>
<p>[ ] This has been discussed in issue #..., or if not, please tell us why<br>
  here.</p>
</li>
<li>
<p>[ ] A short description of what this does, why it is needed; if the<br>
  description becomes long, the matter should probably be discussed in an issue<br>
  first.</p>
</li>
<li>
<p>[ ] This PR contains test cases, if meaningful.</p>
</li>
<li>[ ] A reviewer from the core maintainer team has been assigned for this PR.<br>
  If you don't know who could review this, please indicate so. The list of<br>
  suggested reviewers on the right can help you.</li>
</ul>
<p>Please ensure all communication adheres to the <a href="https://github.com/bytecodealliance/wasmtime/blob/master/CODE_OF_CONDUCT.md">code of
conduct</a>.<br>
--&gt;<br>
</p>
</blockquote>



<a name="309105319"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%235252%20Cranelift%28Aarch64%29%3A%20Optimize%20lowering.../near/309105319" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.235252.20Cranelift.28Aarch64.29.3A.20Optimize.20lowering.2E.2E.2E.html#309105319">(Nov 10 2022 at 23:58)</a>:</h4>
<p><strong>fitzgen</strong> requested <a href="https://github.com/elliottt">elliottt</a> for a review on <a href="https://github.com/bytecodealliance/wasmtime/pull/5252">PR #5252</a>.</p>



<a name="309105433"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%235252%20Cranelift%28Aarch64%29%3A%20Optimize%20lowering.../near/309105433" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.235252.20Cranelift.28Aarch64.29.3A.20Optimize.20lowering.2E.2E.2E.html#309105433">(Nov 10 2022 at 23:59)</a>:</h4>
<p>fitzgen created <a href="https://github.com/bytecodealliance/wasmtime/pull/5252#discussion_r1019715483">PR review comment</a>:</p>
<blockquote>
<p>I'm not sure why these changed here, but also I think it is benign since <code>movz</code> is zero-extending the value?</p>
</blockquote>



<a name="309105434"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%235252%20Cranelift%28Aarch64%29%3A%20Optimize%20lowering.../near/309105434" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.235252.20Cranelift.28Aarch64.29.3A.20Optimize.20lowering.2E.2E.2E.html#309105434">(Nov 10 2022 at 23:59)</a>:</h4>
<p>fitzgen submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/5252#pullrequestreview-1176639034">PR review</a>.</p>



<a name="309110455"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%235252%20Cranelift%28Aarch64%29%3A%20Optimize%20lowering.../near/309110455" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.235252.20Cranelift.28Aarch64.29.3A.20Optimize.20lowering.2E.2E.2E.html#309110455">(Nov 11 2022 at 00:46)</a>:</h4>
<p>elliottt submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/5252#pullrequestreview-1176666119">PR review</a>.</p>



<a name="310240441"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%235252%20Cranelift%28Aarch64%29%3A%20Optimize%20lowering.../near/310240441" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.235252.20Cranelift.28Aarch64.29.3A.20Optimize.20lowering.2E.2E.2E.html#310240441">(Nov 15 2022 at 16:36)</a>:</h4>
<p>fitzgen updated <a href="https://github.com/bytecodealliance/wasmtime/pull/5252">PR #5252</a> from <code>optimize-comparisons-with-immediates-on-aarch64</code> to <code>main</code>.</p>



<a name="310249009"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%235252%20Cranelift%28Aarch64%29%3A%20Optimize%20lowering.../near/310249009" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.235252.20Cranelift.28Aarch64.29.3A.20Optimize.20lowering.2E.2E.2E.html#310249009">(Nov 15 2022 at 17:17)</a>:</h4>
<p>jameysharp submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/5252#pullrequestreview-1181270600">PR review</a>.</p>



<a name="310249010"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%235252%20Cranelift%28Aarch64%29%3A%20Optimize%20lowering.../near/310249010" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.235252.20Cranelift.28Aarch64.29.3A.20Optimize.20lowering.2E.2E.2E.html#310249010">(Nov 15 2022 at 17:17)</a>:</h4>
<p>jameysharp created <a href="https://github.com/bytecodealliance/wasmtime/pull/5252#discussion_r1023064942">PR review comment</a>:</p>
<blockquote>
<p>Why is <code>make_imm12_from_u64</code> separate from <code>imm12_from_u64</code>? They look identical to me.</p>
</blockquote>



<a name="310249221"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%235252%20Cranelift%28Aarch64%29%3A%20Optimize%20lowering.../near/310249221" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.235252.20Cranelift.28Aarch64.29.3A.20Optimize.20lowering.2E.2E.2E.html#310249221">(Nov 15 2022 at 17:18)</a>:</h4>
<p>fitzgen created <a href="https://github.com/bytecodealliance/wasmtime/pull/5252#discussion_r1023065830">PR review comment</a>:</p>
<blockquote>
<p>One is a pure constructor and the other is a fallible extractor. They are identical but can't replace one another in ISLE's type system.</p>
</blockquote>



<a name="310249223"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%235252%20Cranelift%28Aarch64%29%3A%20Optimize%20lowering.../near/310249223" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.235252.20Cranelift.28Aarch64.29.3A.20Optimize.20lowering.2E.2E.2E.html#310249223">(Nov 15 2022 at 17:18)</a>:</h4>
<p>fitzgen submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/5252#pullrequestreview-1181272723">PR review</a>.</p>



<a name="310249372"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%235252%20Cranelift%28Aarch64%29%3A%20Optimize%20lowering.../near/310249372" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.235252.20Cranelift.28Aarch64.29.3A.20Optimize.20lowering.2E.2E.2E.html#310249372">(Nov 15 2022 at 17:18)</a>:</h4>
<p>fitzgen merged <a href="https://github.com/bytecodealliance/wasmtime/pull/5252">PR #5252</a>.</p>



<a name="310249504"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%235252%20Cranelift%28Aarch64%29%3A%20Optimize%20lowering.../near/310249504" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.235252.20Cranelift.28Aarch64.29.3A.20Optimize.20lowering.2E.2E.2E.html#310249504">(Nov 15 2022 at 17:19)</a>:</h4>
<p>elliottt created <a href="https://github.com/bytecodealliance/wasmtime/pull/5252#discussion_r1023067818">PR review comment</a>:</p>
<blockquote>
<p>Couldn't it be an infallible extractor? Then there'd be no <code>Option</code> in the return type, and the same rust function could be reused for the extractor and constructor in isle.</p>
</blockquote>



<a name="310249505"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%235252%20Cranelift%28Aarch64%29%3A%20Optimize%20lowering.../near/310249505" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.235252.20Cranelift.28Aarch64.29.3A.20Optimize.20lowering.2E.2E.2E.html#310249505">(Nov 15 2022 at 17:19)</a>:</h4>
<p>elliottt submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/5252#pullrequestreview-1181274922">PR review</a>.</p>



<a name="310249658"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%235252%20Cranelift%28Aarch64%29%3A%20Optimize%20lowering.../near/310249658" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.235252.20Cranelift.28Aarch64.29.3A.20Optimize.20lowering.2E.2E.2E.html#310249658">(Nov 15 2022 at 17:20)</a>:</h4>
<p>elliottt created <a href="https://github.com/bytecodealliance/wasmtime/pull/5252#discussion_r1023068465">PR review comment</a>:</p>
<blockquote>
<p>Scratch that -- I just realized that we're relying on the failure behavior in the extractor case :)</p>
</blockquote>



<a name="310249659"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%235252%20Cranelift%28Aarch64%29%3A%20Optimize%20lowering.../near/310249659" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.235252.20Cranelift.28Aarch64.29.3A.20Optimize.20lowering.2E.2E.2E.html#310249659">(Nov 15 2022 at 17:20)</a>:</h4>
<p>elliottt submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/5252#pullrequestreview-1181275805">PR review</a>.</p>



<a name="310249825"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%235252%20Cranelift%28Aarch64%29%3A%20Optimize%20lowering.../near/310249825" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.235252.20Cranelift.28Aarch64.29.3A.20Optimize.20lowering.2E.2E.2E.html#310249825">(Nov 15 2022 at 17:21)</a>:</h4>
<p>fitzgen submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/5252#pullrequestreview-1181277069">PR review</a>.</p>



<a name="310249826"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%235252%20Cranelift%28Aarch64%29%3A%20Optimize%20lowering.../near/310249826" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.235252.20Cranelift.28Aarch64.29.3A.20Optimize.20lowering.2E.2E.2E.html#310249826">(Nov 15 2022 at 17:21)</a>:</h4>
<p>fitzgen created <a href="https://github.com/bytecodealliance/wasmtime/pull/5252#discussion_r1023069341">PR review comment</a>:</p>
<blockquote>
<p>It can't be infallible because not all <code>u64</code>s can be represented with <code>Imm12</code>s</p>
</blockquote>



<a name="310249975"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%235252%20Cranelift%28Aarch64%29%3A%20Optimize%20lowering.../near/310249975" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.235252.20Cranelift.28Aarch64.29.3A.20Optimize.20lowering.2E.2E.2E.html#310249975">(Nov 15 2022 at 17:21)</a>:</h4>
<p>fitzgen edited <a href="https://github.com/bytecodealliance/wasmtime/pull/5252#discussion_r1023069341">PR review comment</a>.</p>



<a name="310251529"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%235252%20Cranelift%28Aarch64%29%3A%20Optimize%20lowering.../near/310251529" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.235252.20Cranelift.28Aarch64.29.3A.20Optimize.20lowering.2E.2E.2E.html#310251529">(Nov 15 2022 at 17:29)</a>:</h4>
<p>jameysharp submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/5252#pullrequestreview-1181289004">PR review</a>.</p>



<a name="310251530"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%235252%20Cranelift%28Aarch64%29%3A%20Optimize%20lowering.../near/310251530" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.235252.20Cranelift.28Aarch64.29.3A.20Optimize.20lowering.2E.2E.2E.html#310251530">(Nov 15 2022 at 17:29)</a>:</h4>
<p>jameysharp created <a href="https://github.com/bytecodealliance/wasmtime/pull/5252#discussion_r1023077685">PR review comment</a>:</p>
<blockquote>
<p>Ah, I see. But then you could have used the extractor instead of a constructor, right?</p>
<p><div class="codehilite" data-code-language="Common Lisp"><pre><span></span><code><span class="p">(</span><span class="nv">if-let</span><span class="w"> </span><span class="p">(</span><span class="nv">imm12_from_u64</span><span class="w"> </span><span class="nv">imm</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nv">u64_sub</span><span class="w"> </span><span class="nv">b</span><span class="w"> </span><span class="mi">1</span><span class="p">))</span><span class="w"></span>
</code></pre></div><br>
</p>
</blockquote>



<hr><p>Last updated: Jan 20 2025 at 06:04 UTC</p>
</html>