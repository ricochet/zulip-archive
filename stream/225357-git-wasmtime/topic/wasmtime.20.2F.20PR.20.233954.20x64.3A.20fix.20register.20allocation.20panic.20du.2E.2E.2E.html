<html>
<head><meta charset="utf-8"><title>wasmtime / PR #3954 x64: fix register allocation panic du... · git-wasmtime · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/index.html">git-wasmtime</a></h2>
<h3>Topic: <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.233954.20x64.3A.20fix.20register.20allocation.20panic.20du.2E.2E.2E.html">wasmtime / PR #3954 x64: fix register allocation panic du...</a></h3>

<hr>

<base href="https://bytecodealliance.zulipchat.com">

<head><link href="https://bytecodealliance.github.io/zulip-archive/style.css" rel="stylesheet"></head>

<a name="276115228"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%233954%20x64%3A%20fix%20register%20allocation%20panic%20du.../near/276115228" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.233954.20x64.3A.20fix.20register.20allocation.20panic.20du.2E.2E.2E.html#276115228">(Mar 21 2022 at 21:17)</a>:</h4>
<p>abrown opened <a href="https://github.com/bytecodealliance/wasmtime/pull/3954">PR #3954</a> from <code>isle-issue-3951</code> to <code>main</code>:</p>
<blockquote>
<p>Fuzz testing identified a lowering case for CLIF's <code>icmp</code> in which the<br>
double use of a loaded operand resulted in a register allocation error.<br>
This change manually adds <code>put_in_xmm</code> to avoid load-coalescing these<br>
values and includes a CLIF filetest to trigger this issue. Closes #3951.</p>
<p>I opened #3953 to discuss a way in which this kind of mistake (i.e.,<br>
forgetting to add <code>put_in_*</code> in certain situations) could be avoided.</p>
<p>&lt;!--</p>
<p>Please ensure that the following steps are all taken care of before submitting<br>
the PR.</p>
<ul>
<li>
<p>[ ] This has been discussed in issue #..., or if not, please tell us why<br>
  here.</p>
</li>
<li>
<p>[ ] A short description of what this does, why it is needed; if the<br>
  description becomes long, the matter should probably be discussed in an issue<br>
  first.</p>
</li>
<li>
<p>[ ] This PR contains test cases, if meaningful.</p>
</li>
<li>[ ] A reviewer from the core maintainer team has been assigned for this PR.<br>
  If you don't know who could review this, please indicate so. The list of<br>
  suggested reviewers on the right can help you.</li>
</ul>
<p>Please ensure all communication adheres to the <a href="https://github.com/bytecodealliance/wasmtime/blob/master/CODE_OF_CONDUCT.md">code of
conduct</a>.<br>
--&gt;<br>
</p>
</blockquote>



<a name="276115280"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%233954%20x64%3A%20fix%20register%20allocation%20panic%20du.../near/276115280" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.233954.20x64.3A.20fix.20register.20allocation.20panic.20du.2E.2E.2E.html#276115280">(Mar 21 2022 at 21:18)</a>:</h4>
<p><strong>abrown</strong> requested <a href="https://github.com/alexcrichton">alexcrichton</a> for a review on <a href="https://github.com/bytecodealliance/wasmtime/pull/3954">PR #3954</a>.</p>



<a name="276119956"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%233954%20x64%3A%20fix%20register%20allocation%20panic%20du.../near/276119956" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.233954.20x64.3A.20fix.20register.20allocation.20panic.20du.2E.2E.2E.html#276119956">(Mar 21 2022 at 22:03)</a>:</h4>
<p>alexcrichton submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/3954#pullrequestreview-916406109">PR review</a>.</p>



<a name="276119957"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%233954%20x64%3A%20fix%20register%20allocation%20panic%20du.../near/276119957" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.233954.20x64.3A.20fix.20register.20allocation.20panic.20du.2E.2E.2E.html#276119957">(Mar 21 2022 at 22:03)</a>:</h4>
<p>alexcrichton submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/3954#pullrequestreview-916406109">PR review</a>.</p>



<a name="276119958"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%233954%20x64%3A%20fix%20register%20allocation%20panic%20du.../near/276119958" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.233954.20x64.3A.20fix.20register.20allocation.20panic.20du.2E.2E.2E.html#276119958">(Mar 21 2022 at 22:03)</a>:</h4>
<p>alexcrichton created <a href="https://github.com/bytecodealliance/wasmtime/pull/3954#discussion_r831579288">PR review comment</a>:</p>
<blockquote>
<p>I haven't been following the implicit conversions recently but this feels sort of weird to me where previously when I was working on ISLE I tried to make sure that <code>put_in_xmm</code> was only called once-per-value, but here you're explicitly calling <code>put_in_xmm b</code> above but here it's implicitly being converted with what I presume is also <code>put_in_xmm</code>. I don't personally know the effect of calling <code>put_in_xmm</code> twice and whether it has some sort of cache to repeatedly return the same thing.</p>
</blockquote>



<a name="276122431"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%233954%20x64%3A%20fix%20register%20allocation%20panic%20du.../near/276122431" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.233954.20x64.3A.20fix.20register.20allocation.20panic.20du.2E.2E.2E.html#276122431">(Mar 21 2022 at 22:33)</a>:</h4>
<p>cfallin submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/3954#pullrequestreview-916425727">PR review</a>.</p>



<a name="276122432"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%233954%20x64%3A%20fix%20register%20allocation%20panic%20du.../near/276122432" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.233954.20x64.3A.20fix.20register.20allocation.20panic.20du.2E.2E.2E.html#276122432">(Mar 21 2022 at 22:33)</a>:</h4>
<p>cfallin submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/3954#pullrequestreview-916425727">PR review</a>.</p>



<a name="276122433"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%233954%20x64%3A%20fix%20register%20allocation%20panic%20du.../near/276122433" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.233954.20x64.3A.20fix.20register.20allocation.20panic.20du.2E.2E.2E.html#276122433">(Mar 21 2022 at 22:33)</a>:</h4>
<p>cfallin created <a href="https://github.com/bytecodealliance/wasmtime/pull/3954#discussion_r831594920">PR review comment</a>:</p>
<blockquote>
<p>I would probably write this as <code>(a_reg Xmm (put_in_xmm a))</code> and then use <code>a_reg</code> afterward. The use of <code>b</code> below feels a bit asymmetrical and confusing otherwise.</p>
</blockquote>



<a name="276122434"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%233954%20x64%3A%20fix%20register%20allocation%20panic%20du.../near/276122434" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.233954.20x64.3A.20fix.20register.20allocation.20panic.20du.2E.2E.2E.html#276122434">(Mar 21 2022 at 22:33)</a>:</h4>
<p>cfallin created <a href="https://github.com/bytecodealliance/wasmtime/pull/3954#discussion_r831595142">PR review comment</a>:</p>
<blockquote>
<p>Likewise here, I'd bind the registers as separate locals then use them here and in the pcmpeq below.</p>
</blockquote>



<a name="276122435"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%233954%20x64%3A%20fix%20register%20allocation%20panic%20du.../near/276122435" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.233954.20x64.3A.20fix.20register.20allocation.20panic.20du.2E.2E.2E.html#276122435">(Mar 21 2022 at 22:33)</a>:</h4>
<p>cfallin created <a href="https://github.com/bytecodealliance/wasmtime/pull/3954#discussion_r831594475">PR review comment</a>:</p>
<blockquote>
<p>There's actually a whole section of our documentation answering this question! <a href="https://github.com/bytecodealliance/wasmtime/blob/main/cranelift/docs/isle-integration.md#implicit-type-conversions-and-side-effects">Here</a> we added some justification for this decision and a criterion for when it is acceptable: implicit conversions can have side-effects if they are <em>idempotent</em>.</p>
<p>Specifically, <code>put_in_{reg,xmm,gpr}</code> will make a note that the value is required (so when the upward pass reaches the producer, it's actually lowered), and return the vreg already assigned for this SSA value. Calling it multiple times will return the same vreg.</p>
<p>On balance, making <code>put_in_reg</code> implicit makes lowering patterns easier to write, I think; the real issue here is the odd condition that we can't use memory operands in compares. This is (as @abrown notes in sibling issue) something we should fix, for sure.</p>
</blockquote>



<a name="276131637"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%233954%20x64%3A%20fix%20register%20allocation%20panic%20du.../near/276131637" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.233954.20x64.3A.20fix.20register.20allocation.20panic.20du.2E.2E.2E.html#276131637">(Mar 22 2022 at 00:40)</a>:</h4>
<p>abrown updated <a href="https://github.com/bytecodealliance/wasmtime/pull/3954">PR #3954</a> from <code>isle-issue-3951</code> to <code>main</code>.</p>



<a name="276132282"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%233954%20x64%3A%20fix%20register%20allocation%20panic%20du.../near/276132282" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.233954.20x64.3A.20fix.20register.20allocation.20panic.20du.2E.2E.2E.html#276132282">(Mar 22 2022 at 00:53)</a>:</h4>
<p>abrown submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/3954#pullrequestreview-916542908">PR review</a>.</p>



<a name="276132283"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%233954%20x64%3A%20fix%20register%20allocation%20panic%20du.../near/276132283" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.233954.20x64.3A.20fix.20register.20allocation.20panic.20du.2E.2E.2E.html#276132283">(Mar 22 2022 at 00:53)</a>:</h4>
<p>abrown created <a href="https://github.com/bytecodealliance/wasmtime/pull/3954#discussion_r831677061">PR review comment</a>:</p>
<blockquote>
<p>Yeah, good catch; I was doing this half-implicit/half-explicit earlier (and thanks to @alexcrichton also for pointing that out). Fixed in c8d8556.</p>
</blockquote>



<a name="276132442"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%233954%20x64%3A%20fix%20register%20allocation%20panic%20du.../near/276132442" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.233954.20x64.3A.20fix.20register.20allocation.20panic.20du.2E.2E.2E.html#276132442">(Mar 22 2022 at 00:56)</a>:</h4>
<p>abrown submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/3954#pullrequestreview-916544157">PR review</a>.</p>



<a name="276132443"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%233954%20x64%3A%20fix%20register%20allocation%20panic%20du.../near/276132443" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.233954.20x64.3A.20fix.20register.20allocation.20panic.20du.2E.2E.2E.html#276132443">(Mar 22 2022 at 00:56)</a>:</h4>
<p>abrown created <a href="https://github.com/bytecodealliance/wasmtime/pull/3954#discussion_r831679151">PR review comment</a>:</p>
<blockquote>
<p>This thread is resolved by the new <code>let</code> statements for <code>xmm_a</code> and <code>xmm_b</code> in c8d8556. I'll leave it unresolved, though, for future readers who may want to understand what @cfallin just explained.</p>
</blockquote>



<a name="276134770"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%233954%20x64%3A%20fix%20register%20allocation%20panic%20du.../near/276134770" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.233954.20x64.3A.20fix.20register.20allocation.20panic.20du.2E.2E.2E.html#276134770">(Mar 22 2022 at 01:46)</a>:</h4>
<p>abrown merged <a href="https://github.com/bytecodealliance/wasmtime/pull/3954">PR #3954</a>.</p>



<hr><p>Last updated: Jan 20 2025 at 06:04 UTC</p>
</html>