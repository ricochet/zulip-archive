<html>
<head><meta charset="utf-8"><title>wasmtime / issue #6359 add C API for epoch_deadline_callb... · git-wasmtime · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/index.html">git-wasmtime</a></h2>
<h3>Topic: <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.236359.20add.20C.20API.20for.20epoch_deadline_callb.2E.2E.2E.html">wasmtime / issue #6359 add C API for epoch_deadline_callb...</a></h3>

<hr>

<base href="https://bytecodealliance.zulipchat.com">

<head><link href="https://bytecodealliance.github.io/zulip-archive/style.css" rel="stylesheet"></head>

<a name="357008050"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%236359%20add%20C%20API%20for%20epoch_deadline_callb.../near/357008050" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.236359.20add.20C.20API.20for.20epoch_deadline_callb.2E.2E.2E.html#357008050">(May 09 2023 at 14:44)</a>:</h4>
<p>github-actions[bot] <a href="https://github.com/bytecodealliance/wasmtime/pull/6359#issuecomment-1540267384">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/6359">issue #6359</a>:</p>
<blockquote>
<h4>Subscribe to Label Action</h4>
<p>cc @peterhuene</p>
<p>&lt;details&gt;<br>
This issue or pull request has been labeled: "wasmtime:c-api"</p>
<p>Thus the following users have been cc'd because of the following labels:</p>
<ul>
<li>peterhuene: wasmtime:c-api</li>
</ul>
<p>To subscribe or unsubscribe from this label, edit the &lt;code&gt;.github/subscribe-to-label.json&lt;/code&gt; configuration file.</p>
<p><a href="https://github.com/bytecodealliance/subscribe-to-label-action">Learn more.</a><br>
&lt;/details&gt;</p>
</blockquote>



<a name="357379713"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%236359%20add%20C%20API%20for%20epoch_deadline_callb.../near/357379713" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.236359.20add.20C.20API.20for.20epoch_deadline_callb.2E.2E.2E.html#357379713">(May 10 2023 at 18:52)</a>:</h4>
<p>kpreisser <a href="https://github.com/bytecodealliance/wasmtime/pull/6359#issuecomment-1542656012">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/6359">issue #6359</a>:</p>
<blockquote>
<p>Hi! From my testing, it seems the new <code>wasmtime_error_new</code> function in the C API doesn't copy the string passed by the <code>const char*</code> argument when being called; instead the supplied char pointer is dereferenced later after <code>wasmtime_error_new</code> has already returned, e.g. when returning the <code>wasmtime_error_t*</code> in the epoch callback. Is this intended?</p>
<p>I would have expected a similar behavior as <code>wasmtime_trap_new</code>, which copies the string when being called, so that the memory holding the string can be freed by the caller after the function returns. Otherwise, it's not quite clear to me when the memory can be freed.</p>
<p>Thanks!</p>
</blockquote>



<a name="357380611"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%236359%20add%20C%20API%20for%20epoch_deadline_callb.../near/357380611" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.236359.20add.20C.20API.20for.20epoch_deadline_callb.2E.2E.2E.html#357380611">(May 10 2023 at 18:57)</a>:</h4>
<p>kpreisser edited a <a href="https://github.com/bytecodealliance/wasmtime/pull/6359#issuecomment-1542656012">comment</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/6359">issue #6359</a>:</p>
<blockquote>
<p>Hi! From my testing, it seems the new <code>wasmtime_error_new</code> function in the C API doesn't copy the string passed by the <code>const char*</code> argument when being called; instead the supplied char pointer is dereferenced later after <code>wasmtime_error_new</code> has already returned, e.g. when returning the <code>wasmtime_error_t*</code> in the epoch deadline callback. Is this intended?</p>
<p>I would have expected a similar behavior as <code>wasmtime_trap_new</code>, which copies the string when being called, so that the memory holding the string can be freed by the caller after the function returns. Otherwise, it's not quite clear to me when the memory can be freed.</p>
<p>Thanks!</p>
</blockquote>



<a name="357380674"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%236359%20add%20C%20API%20for%20epoch_deadline_callb.../near/357380674" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.236359.20add.20C.20API.20for.20epoch_deadline_callb.2E.2E.2E.html#357380674">(May 10 2023 at 18:57)</a>:</h4>
<p>alexcrichton <a href="https://github.com/bytecodealliance/wasmtime/pull/6359#issuecomment-1542660694">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/6359">issue #6359</a>:</p>
<blockquote>
<p>Ah thanks for testing! That's a mistake in the API and a subtle detail with the implementation. It's definitely not intended that the pointer should remain live, the contents should be copied into the error. </p>
<p>The line that needs to change is <a href="https://github.com/bytecodealliance/wasmtime/blob/6bb0ec7a11944e820e646c97f95e7fde517b486d/crates/c-api/src/error.rs#L28">this one</a>, namely the <code>anyhow!(msg_string)</code> should become <code>anyhow!("{msg_string}")</code>. @theothergraham or @kpreisser would one of y'all be up for a PR along those lines?</p>
</blockquote>



<a name="357389077"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%236359%20add%20C%20API%20for%20epoch_deadline_callb.../near/357389077" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.236359.20add.20C.20API.20for.20epoch_deadline_callb.2E.2E.2E.html#357389077">(May 10 2023 at 19:38)</a>:</h4>
<p>theothergraham <a href="https://github.com/bytecodealliance/wasmtime/pull/6359#issuecomment-1542707021">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/6359">issue #6359</a>:</p>
<blockquote>
<p><span aria-label="face palm" class="emoji emoji-1f926" role="img" title="face palm">:face_palm:</span> Sorry, that's my Rust newbieness showing. I missed that <code>String:: from_utf8_lossy()</code> only makes a copy if it finds invalid uft-8. I'll make a PR. Thank you for catching that, @kpreisser!</p>
</blockquote>



<hr><p>Last updated: Jan 20 2025 at 06:04 UTC</p>
</html>