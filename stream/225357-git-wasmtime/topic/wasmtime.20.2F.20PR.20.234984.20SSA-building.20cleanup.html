<html>
<head><meta charset="utf-8"><title>wasmtime / PR #4984 SSA-building cleanup · git-wasmtime · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/index.html">git-wasmtime</a></h2>
<h3>Topic: <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.234984.20SSA-building.20cleanup.html">wasmtime / PR #4984 SSA-building cleanup</a></h3>

<hr>

<base href="https://bytecodealliance.zulipchat.com">

<head><link href="https://bytecodealliance.github.io/zulip-archive/style.css" rel="stylesheet"></head>

<a name="301540025"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%234984%20SSA-building%20cleanup/near/301540025" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.234984.20SSA-building.20cleanup.html#301540025">(Sep 29 2022 at 22:06)</a>:</h4>
<p>jameysharp opened <a href="https://github.com/bytecodealliance/wasmtime/pull/4984">PR #4984</a> from <code>ssa-cleanup</code> to <code>main</code>:</p>
<blockquote>
<p>This is a collection of all the cleanups I set aside while working on #4955 and #4966. According to DHAT and hyperfine, these patches together have almost no effect on performance. DHAT says this reduces total memory allocated, max heap size, and bytes written, while increasing instructions retired and bytes read, but all by tiny fractions of a percent.</p>
</blockquote>



<a name="301540026"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%234984%20SSA-building%20cleanup/near/301540026" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.234984.20SSA-building.20cleanup.html#301540026">(Sep 29 2022 at 22:06)</a>:</h4>
<p><strong>jameysharp</strong> requested <a href="https://github.com/cfallin">cfallin</a> for a review on <a href="https://github.com/bytecodealliance/wasmtime/pull/4984">PR #4984</a>.</p>



<a name="301541233"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%234984%20SSA-building%20cleanup/near/301541233" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.234984.20SSA-building.20cleanup.html#301541233">(Sep 29 2022 at 22:17)</a>:</h4>
<p>cfallin submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/4984#pullrequestreview-1126053909">PR review</a>.</p>



<a name="301541236"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%234984%20SSA-building%20cleanup/near/301541236" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.234984.20SSA-building.20cleanup.html#301541236">(Sep 29 2022 at 22:17)</a>:</h4>
<p>cfallin submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/4984#pullrequestreview-1126053909">PR review</a>.</p>



<a name="301541237"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%234984%20SSA-building%20cleanup/near/301541237" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.234984.20SSA-building.20cleanup.html#301541237">(Sep 29 2022 at 22:17)</a>:</h4>
<p>cfallin created <a href="https://github.com/bytecodealliance/wasmtime/pull/4984#discussion_r984062338">PR review comment</a>:</p>
<blockquote>
<p>I think this results in a change in behavior with respect to before: earlier we had an assert that ensured a block could only be sealed once (line 437 in the original); now we silently accept <code>Yes</code> here. That is probably OK -- the effect is nothing if already sealed -- but I just want to make sure we've thought about this and that it doesn't contradict docs elsewhere?</p>
</blockquote>



<a name="301541238"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%234984%20SSA-building%20cleanup/near/301541238" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.234984.20SSA-building.20cleanup.html#301541238">(Sep 29 2022 at 22:17)</a>:</h4>
<p>cfallin created <a href="https://github.com/bytecodealliance/wasmtime/pull/4984#discussion_r984061070">PR review comment</a>:</p>
<blockquote>
<p>I wonder: is this actually necessary? <code>SecondaryMap</code> (or at least, one created with <code>::with_default()</code>) will return a readonly borrow of some shared "default" value for an <code>Index</code> of a non-existing index, or will dynamically expand as needed for an <code>IndexMut</code> access; the lack of prior expansion is unobservable (as opposed to just-in-time expansion), I think. Or is that not the case?</p>
</blockquote>



<a name="301542265"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%234984%20SSA-building%20cleanup/near/301542265" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.234984.20SSA-building.20cleanup.html#301542265">(Sep 29 2022 at 22:27)</a>:</h4>
<p>jameysharp created <a href="https://github.com/bytecodealliance/wasmtime/pull/4984#discussion_r984068667">PR review comment</a>:</p>
<blockquote>
<p>In terms of public API, the behavior is unchanged. I moved the assert to <code>seal_block</code>; and <code>seal_all_blocks</code> was only calling <code>seal_one_block</code> if the block was not already sealed.</p>
<p>Making the internal helpers just no-op for sealed blocks meant that I could remove a conditional from <code>seal_all_blocks</code> and check only once in <code>mark_block_sealed</code> instead.</p>
<p>As far as private callers go, <code>append_jump_argument</code> calls <code>mark_block_sealed</code> but only on a block it just created, so it definitely isn't sealed.</p>
</blockquote>



<a name="301542266"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%234984%20SSA-building%20cleanup/near/301542266" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.234984.20SSA-building.20cleanup.html#301542266">(Sep 29 2022 at 22:27)</a>:</h4>
<p>jameysharp submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/4984#pullrequestreview-1126064080">PR review</a>.</p>



<a name="301543186"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%234984%20SSA-building%20cleanup/near/301543186" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.234984.20SSA-building.20cleanup.html#301543186">(Sep 29 2022 at 22:36)</a>:</h4>
<p>jameysharp submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/4984#pullrequestreview-1126069520">PR review</a>.</p>



<a name="301543187"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%234984%20SSA-building%20cleanup/near/301543187" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.234984.20SSA-building.20cleanup.html#301543187">(Sep 29 2022 at 22:36)</a>:</h4>
<p>jameysharp created <a href="https://github.com/bytecodealliance/wasmtime/pull/4984#discussion_r984072562">PR review comment</a>:</p>
<blockquote>
<p>I almost had myself convinced that I could delete <code>declare_block</code> entirely, because as you say, the allocated size of a <code>SecondaryMap</code> is unobservable... almost.</p>
<p>The exception is <code>SecondaryMap::keys</code>, which iterates only over indexes that are currently initialized. And <code>seal_all_blocks</code> uses <code>self.ssa_blocks.keys()</code> to determine which blocks need to be sealed.</p>
<p>So if I don't ensure that the map has grown at least to the declared block's index, then I think there's a sequence of public API calls against a <code>FunctionBuilder</code> that would hit a debug assertion. It's something like <code>create_block</code>, <code>switch_to_block</code>, <code>ensure_inserted_block</code>, and <code>finalize</code>, without declaring any predecessors or calling <code>use_var</code>.</p>
<p>I didn't specifically test that because it was starting to make my head hurt. So maybe it's actually okay, but I didn't want to think about it further.</p>
</blockquote>



<a name="301543507"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%234984%20SSA-building%20cleanup/near/301543507" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.234984.20SSA-building.20cleanup.html#301543507">(Sep 29 2022 at 22:39)</a>:</h4>
<p>jameysharp updated <a href="https://github.com/bytecodealliance/wasmtime/pull/4984">PR #4984</a> from <code>ssa-cleanup</code> to <code>main</code>.</p>



<a name="301551345"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%234984%20SSA-building%20cleanup/near/301551345" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.234984.20SSA-building.20cleanup.html#301551345">(Sep 29 2022 at 23:59)</a>:</h4>
<p>jameysharp merged <a href="https://github.com/bytecodealliance/wasmtime/pull/4984">PR #4984</a>.</p>



<hr><p>Last updated: Jan 20 2025 at 06:04 UTC</p>
</html>