<html>
<head><meta charset="utf-8"><title>wasmtime / Issue #1738 Why does wasmtime runtime import s... · git-wasmtime · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/index.html">git-wasmtime</a></h2>
<h3>Topic: <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20Issue.20.231738.20Why.20does.20wasmtime.20runtime.20import.20s.2E.2E.2E.html">wasmtime / Issue #1738 Why does wasmtime runtime import s...</a></h3>

<hr>

<base href="https://bytecodealliance.zulipchat.com">

<head><link href="https://bytecodealliance.github.io/zulip-archive/style.css" rel="stylesheet"></head>

<a name="198334680"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20Issue%20%231738%20Why%20does%20wasmtime%20runtime%20import%20s.../near/198334680" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20Issue.20.231738.20Why.20does.20wasmtime.20runtime.20import.20s.2E.2E.2E.html#198334680">(May 21 2020 at 15:27)</a>:</h4>
<p>whitequark opened <a href="https://github.com/bytecodealliance/wasmtime/issues/1738">Issue #1738</a>:</p>
<blockquote>
<p>I was looking into developing the Windows backend of Cranelift/wasmtime on Linux using cross-compilation and wine, and it actually works quite well, with one exception: I have to comment out the setjmp helper, because if I don't, this happens:</p>
<div class="codehilite"><pre><span></span><code>$ cargo run --target x86_64-pc-windows-gnu hello.wasm
    Finished dev [unoptimized + debuginfo] target(s) in 0.12s
     Running `target/x86_64-pc-windows-gnu/debug/wasmtime.exe hello.wasm`
wine: Call from 0x7bc5d60c to unimplemented function ntdll.dll._setjmp, aborting
wine: Unimplemented function ntdll.dll._setjmp called at address 0x7bc5d60c (thread 003e), starting debugger...
</code></pre></div>


<p>This clearly looks like a bug in wine of some sort, but given that setjmp is a pervasive function and it's neither implemented in wine nor can I find any similar bug reports, what wasmtime does here is at least <em>unusual</em>. What gives?</p>
</blockquote>



<a name="198334681"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20Issue%20%231738%20Why%20does%20wasmtime%20runtime%20import%20s.../near/198334681" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20Issue.20.231738.20Why.20does.20wasmtime.20runtime.20import.20s.2E.2E.2E.html#198334681">(May 21 2020 at 15:27)</a>:</h4>
<p>whitequark labeled <a href="https://github.com/bytecodealliance/wasmtime/issues/1738">Issue #1738</a>:</p>
<blockquote>
<p>I was looking into developing the Windows backend of Cranelift/wasmtime on Linux using cross-compilation and wine, and it actually works quite well, with one exception: I have to comment out the setjmp helper, because if I don't, this happens:</p>
<div class="codehilite"><pre><span></span><code>$ cargo run --target x86_64-pc-windows-gnu hello.wasm
    Finished dev [unoptimized + debuginfo] target(s) in 0.12s
     Running `target/x86_64-pc-windows-gnu/debug/wasmtime.exe hello.wasm`
wine: Call from 0x7bc5d60c to unimplemented function ntdll.dll._setjmp, aborting
wine: Unimplemented function ntdll.dll._setjmp called at address 0x7bc5d60c (thread 003e), starting debugger...
</code></pre></div>


<p>This clearly looks like a bug in wine of some sort, but given that setjmp is a pervasive function and it's neither implemented in wine nor can I find any similar bug reports, what wasmtime does here is at least <em>unusual</em>. What gives?</p>
</blockquote>



<a name="198334723"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20Issue%20%231738%20Why%20does%20wasmtime%20runtime%20import%20s.../near/198334723" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20Issue.20.231738.20Why.20does.20wasmtime.20runtime.20import.20s.2E.2E.2E.html#198334723">(May 21 2020 at 15:27)</a>:</h4>
<p>whitequark <a href="https://github.com/bytecodealliance/wasmtime/issues/1738#issuecomment-632149862">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/1738">Issue #1738</a>:</p>
<blockquote>
<p>Er, I think I chose the wrong issue template--I'm not really sure if this is a bug in wasmtime.</p>
</blockquote>



<a name="198334878"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20Issue%20%231738%20Why%20does%20wasmtime%20runtime%20import%20s.../near/198334878" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20Issue.20.231738.20Why.20does.20wasmtime.20runtime.20import.20s.2E.2E.2E.html#198334878">(May 21 2020 at 15:29)</a>:</h4>
<p>whitequark <a href="https://github.com/bytecodealliance/wasmtime/issues/1738#issuecomment-632151329">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/1738">Issue #1738</a>:</p>
<blockquote>
<p>According to <a href="https://www.geoffchappell.com/studies/windows/win32/ntdll/api/index.htm">this page</a> ntdll.dll indeed exports <code>_setjmp</code> and it is undocumented, so maybe wasmtime shouldn't really be using it?</p>
</blockquote>



<a name="198335655"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20Issue%20%231738%20Why%20does%20wasmtime%20runtime%20import%20s.../near/198335655" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20Issue.20.231738.20Why.20does.20wasmtime.20runtime.20import.20s.2E.2E.2E.html#198335655">(May 21 2020 at 15:35)</a>:</h4>
<p>bjorn3 <a href="https://github.com/bytecodealliance/wasmtime/issues/1738#issuecomment-632159576">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/1738">Issue #1738</a>:</p>
<blockquote>
<p>The only reference to <code>setjmp</code> I could find is <a href="https://github.com/bytecodealliance/wasmtime/blob/962f057c8a0e42bcba33850d412d77e5de5830fb/crates/runtime/src/helpers.c#L8">https://github.com/bytecodealliance/wasmtime/blob/962f057c8a0e42bcba33850d412d77e5de5830fb/crates/runtime/src/helpers.c#L8</a> which imports it from <code>setjmp.h</code>. This is a header defined by the C specification.</p>
</blockquote>



<a name="198336206"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20Issue%20%231738%20Why%20does%20wasmtime%20runtime%20import%20s.../near/198336206" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20Issue.20.231738.20Why.20does.20wasmtime.20runtime.20import.20s.2E.2E.2E.html#198336206">(May 21 2020 at 15:40)</a>:</h4>
<p>whitequark <a href="https://github.com/bytecodealliance/wasmtime/issues/1738#issuecomment-632164687">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/1738">Issue #1738</a>:</p>
<blockquote>
<p>I believe the problem is that wasmtime <em>uses</em> a C runtime function but does not <em>link</em> to C runtime. Things happen to work pretty much by accident because ntdll happens to expose that function too. If I comment out the <code>#[link = "ntdll"]</code> and add <code>#[link = "ucrt"] extern "C" {}</code> then things work as I expect.</p>
</blockquote>



<a name="198336911"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20Issue%20%231738%20Why%20does%20wasmtime%20runtime%20import%20s.../near/198336911" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20Issue.20.231738.20Why.20does.20wasmtime.20runtime.20import.20s.2E.2E.2E.html#198336911">(May 21 2020 at 15:45)</a>:</h4>
<p>whitequark <a href="https://github.com/bytecodealliance/wasmtime/issues/1738#issuecomment-632167595">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/1738">Issue #1738</a>:</p>
<blockquote>
<p>It is actually not necessary to link to <code>ucrt</code> explicitly. What is necessary is to <em>not</em> link to <code>ntdll</code>, since for some reason the <code>_setjmp</code> symbol from ntdll is preferred compared to the symbol from <code>msvcrt</code>.</p>
</blockquote>



<a name="198337079"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20Issue%20%231738%20Why%20does%20wasmtime%20runtime%20import%20s.../near/198337079" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20Issue.20.231738.20Why.20does.20wasmtime.20runtime.20import.20s.2E.2E.2E.html#198337079">(May 21 2020 at 15:47)</a>:</h4>
<p>alexcrichton <a href="https://github.com/bytecodealliance/wasmtime/issues/1738#issuecomment-632168343">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/1738">Issue #1738</a>:</p>
<blockquote>
<p>The <code>setjmp</code>/<code>longjmp</code> functions are used to implement traps right now in wasmtime. They're used to jump over all the JIT code back to the original caller. IIRC there's actually a few setjmp-like functions on Windows, and we had to historically be quite careful about which precise one that we used.</p>
<p>I suspect that what's happening here is that the header we're using ends up mapping our call to <code>_setjmp</code> and the <code>setjmp</code> symbol (no leading underscore) is actually different and defined elsewhere. I'm not sure if one is particularly more canonical than the other, but if the bare <code>setjmp</code> symbol is the way to go then it seems reasonable to add!</p>
<p>I'm not personally too too familiar with how this works on Windows and how you'd select between them (or how they're different, really)</p>
</blockquote>



<a name="198338684"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20Issue%20%231738%20Why%20does%20wasmtime%20runtime%20import%20s.../near/198338684" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20Issue.20.231738.20Why.20does.20wasmtime.20runtime.20import.20s.2E.2E.2E.html#198338684">(May 21 2020 at 15:59)</a>:</h4>
<p>whitequark <a href="https://github.com/bytecodealliance/wasmtime/issues/1738#issuecomment-632175989">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/1738">Issue #1738</a>:</p>
<blockquote>
<p>@alexcrichton It appears to me that the problem is that the linker command line includes the following: <code>"-ladvapi32" "-lntdll" "-lwinapi_advapi32" "-lwinapi_cfgmgr32" "-lwinapi_gdi32" "-lwinapi_kernel32" "-lwinapi_msimg32" "-lwinapi_ole32" "-lwinapi_opengl32" "-lwinapi_shell32" "-lwinapi_user32" "-lwinapi_winspool" "-ladvapi32" "-lws2_32" "-luserenv" "-lmingwex" "-lmingw32" "-lmsvcrt" "-lmsvcrt" "-luser32" "-lkernel32" "-lgcc_eh" "-l:libpthread.a" "-lgcc" "-lmsvcrt" "-lkernel32"</code> where as you can see <code>ntdll</code> appears earlier than <code>msvcrt</code> and so it is searched earlier. Is there a way to control the order here?</p>
</blockquote>



<a name="198344222"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20Issue%20%231738%20Why%20does%20wasmtime%20runtime%20import%20s.../near/198344222" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20Issue.20.231738.20Why.20does.20wasmtime.20runtime.20import.20s.2E.2E.2E.html#198344222">(May 21 2020 at 16:38)</a>:</h4>
<p>whitequark <a href="https://github.com/bytecodealliance/wasmtime/issues/1738#issuecomment-632203862">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/1738">Issue #1738</a>:</p>
<blockquote>
<p>@alexcrichton Scratch that, I removed the <code>#[link = "ntdll"]</code> and added it back via <code>RUSTFLAGS="-C link-arg=-Wl,--allow-multiple-definition -C link-arg=-lmsvcrt -C link-arg=-lntdll -Z print-link-args"</code> but this just segfaults ld. Can we grab <code>NtQueryInformationFile</code> via <code>GetProcAddress</code> instead?</p>
</blockquote>



<a name="198349403"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20Issue%20%231738%20Why%20does%20wasmtime%20runtime%20import%20s.../near/198349403" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20Issue.20.231738.20Why.20does.20wasmtime.20runtime.20import.20s.2E.2E.2E.html#198349403">(May 21 2020 at 17:17)</a>:</h4>
<p>whitequark <a href="https://github.com/bytecodealliance/wasmtime/issues/1738#issuecomment-632234221">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/1738">Issue #1738</a>:</p>
<blockquote>
<p>See #1739.</p>
</blockquote>



<a name="198361254"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20Issue%20%231738%20Why%20does%20wasmtime%20runtime%20import%20s.../near/198361254" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20Issue.20.231738.20Why.20does.20wasmtime.20runtime.20import.20s.2E.2E.2E.html#198361254">(May 21 2020 at 18:56)</a>:</h4>
<p>alexcrichton closed <a href="https://github.com/bytecodealliance/wasmtime/issues/1738">Issue #1738</a>:</p>
<blockquote>
<p>I was looking into developing the Windows backend of Cranelift/wasmtime on Linux using cross-compilation and wine, and it actually works quite well, with one exception: I have to comment out the setjmp helper, because if I don't, this happens:</p>
<div class="codehilite"><pre><span></span><code>$ cargo run --target x86_64-pc-windows-gnu hello.wasm
    Finished dev [unoptimized + debuginfo] target(s) in 0.12s
     Running `target/x86_64-pc-windows-gnu/debug/wasmtime.exe hello.wasm`
wine: Call from 0x7bc5d60c to unimplemented function ntdll.dll._setjmp, aborting
wine: Unimplemented function ntdll.dll._setjmp called at address 0x7bc5d60c (thread 003e), starting debugger...
</code></pre></div>


<p>This clearly looks like a bug in wine of some sort, but given that setjmp is a pervasive function and it's neither implemented in wine nor can I find any similar bug reports, what wasmtime does here is at least <em>unusual</em>. What gives?</p>
</blockquote>



<hr><p>Last updated: Jan 20 2025 at 06:04 UTC</p>
</html>