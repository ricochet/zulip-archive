<html>
<head><meta charset="utf-8"><title>wasmtime / PR #1647 Introduce peepmatic: a peephole optim... · git-wasmtime · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/index.html">git-wasmtime</a></h2>
<h3>Topic: <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231647.20Introduce.20peepmatic.3A.20a.20peephole.20optim.2E.2E.2E.html">wasmtime / PR #1647 Introduce peepmatic: a peephole optim...</a></h3>

<hr>

<base href="https://bytecodealliance.zulipchat.com">

<head><link href="https://bytecodealliance.github.io/zulip-archive/style.css" rel="stylesheet"></head>

<a name="196023819"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231647%20Introduce%20peepmatic%3A%20a%20peephole%20optim.../near/196023819" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231647.20Introduce.20peepmatic.3A.20a.20peephole.20optim.2E.2E.2E.html#196023819">(May 02 2020 at 00:23)</a>:</h4>
<p>fitzgen opened <a href="https://github.com/bytecodealliance/wasmtime/pull/1647" title="https://github.com/bytecodealliance/wasmtime/pull/1647">PR #1647</a> from <code>integrate-peepmatic</code> to <code>master</code>:</p>
<blockquote>
<p>This PR introduces <code>peepmatic</code>, a peephole optimizations DSL and peephole optimizer compiler.</p>
<p>Developers write a set of optimizations in the DSL, and then <code>peepmatic</code> compiles the set of optimizations into an efficient peephole optimizer:</p>
<div class="codehilite"><pre><span></span><code>DSL ----peepmatic----&gt; Peephole Optimizer
</code></pre></div>


<p>The generated peephole optimizer has all of its optimizations' left-hand sides collapsed into a compact transducer automaton that makes matching candidate instruction sequences fast.</p>
<p>The DSL's optimizations may be written by hand or discovered mechanically with a superoptimizer like [Souper][]. Eventually, <code>peepmatic</code> should have a verifier that ensures that the DSL's optimizations are sound, similar to what [Alive][] does for LLVM optimizations.</p>
<p>[Souper]: <a href="https://github.com/google/souper" title="https://github.com/google/souper">https://github.com/google/souper</a><br>
[Alive]: <a href="https://github.com/AliveToolkit/alive2" title="https://github.com/AliveToolkit/alive2">https://github.com/AliveToolkit/alive2</a></p>
<h3>Learn More</h3>
<ul>
<li>
<p><a href="https://github.com/fitzgen/wasmtime/blob/integrate-peepmatic/cranelift/peepmatic/README.md" title="https://github.com/fitzgen/wasmtime/blob/integrate-peepmatic/cranelift/peepmatic/README.md"><code>cranelift/peepmatic/README.md</code> has an overview of the DSL and implementation</a></p>
</li>
<li>
<p><a href="https://docs.google.com/presentation/d/1RW_UHWX1t9-_XkXVsPZauliW1LIJgGz02hUFZE7APT0/edit" title="https://docs.google.com/presentation/d/1RW_UHWX1t9-_XkXVsPZauliW1LIJgGz02hUFZE7APT0/edit">Here is a slide deck I am presenting at the 2020-05-04 Cranelift meeting</a></p>
</li>
</ul>
<h3>Current Status</h3>
<ul>
<li>
<p>I've ported most of <code>simple_preopt.rs</code> to <code>peepmatic</code>'s DSL</p>
</li>
<li>
<p>All tests are passing</p>
</li>
<li>
<p>I've been doing lots and lots of fuzzing</p>
</li>
</ul>
<h3>Next Steps</h3>
<p>This work is not complete, but I think it is at a good point to merge into Cranelift and then evolve in-tree.</p>
<p>The next steps after landing this PR are:</p>
<ul>
<li>
<p>Port the rest of <code>simple_preopt.rs</code> over to <code>peepmatic</code></p>
</li>
<li>
<p>Port <code>postopt.rs</code> over to <code>peepmatic</code></p>
</li>
<li>
<p>Optimize the runtime that interprets the generated peephole optimizations transducers and applies them</p>
</li>
<li>
<p>Extend <code>peepmatic</code> to work with the new backend's <code>MachInst</code> and vcode</p>
</li>
</ul>
<p>For even further future directions, see the discussion in the slides, linked above.</p>
</blockquote>



<a name="196023820"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231647%20Introduce%20peepmatic%3A%20a%20peephole%20optim.../near/196023820" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231647.20Introduce.20peepmatic.3A.20a.20peephole.20optim.2E.2E.2E.html#196023820">(May 02 2020 at 00:23)</a>:</h4>
<p><strong>fitzgen</strong> requested <a href="https://github.com/sunfishcode" title="https://github.com/sunfishcode">sunfishcode</a> for a review on <a href="https://github.com/bytecodealliance/wasmtime/pull/1647" title="https://github.com/bytecodealliance/wasmtime/pull/1647">PR #1647</a>.</p>



<a name="196049135"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231647%20Introduce%20peepmatic%3A%20a%20peephole%20optim.../near/196049135" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231647.20Introduce.20peepmatic.3A.20a.20peephole.20optim.2E.2E.2E.html#196049135">(May 02 2020 at 12:19)</a>:</h4>
<p>bjorn3 submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/1647#pullrequestreview-404522746" title="https://github.com/bytecodealliance/wasmtime/pull/1647#pullrequestreview-404522746">PR Review</a>.</p>



<a name="196049136"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231647%20Introduce%20peepmatic%3A%20a%20peephole%20optim.../near/196049136" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231647.20Introduce.20peepmatic.3A.20a.20peephole.20optim.2E.2E.2E.html#196049136">(May 02 2020 at 12:19)</a>:</h4>
<p>bjorn3 submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/1647#pullrequestreview-404522746" title="https://github.com/bytecodealliance/wasmtime/pull/1647#pullrequestreview-404522746">PR Review</a>.</p>



<a name="196049137"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231647%20Introduce%20peepmatic%3A%20a%20peephole%20optim.../near/196049137" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231647.20Introduce.20peepmatic.3A.20a.20peephole.20optim.2E.2E.2E.html#196049137">(May 02 2020 at 12:19)</a>:</h4>
<p>bjorn3 created <a href="https://github.com/bytecodealliance/wasmtime/pull/1647#discussion_r418950397" title="https://github.com/bytecodealliance/wasmtime/pull/1647#discussion_r418950397">PR Review Comment</a>:</p>
<blockquote>
<p>Maybe construct this map on the fly from <code>values</code> when deserializing?</p>
</blockquote>



<a name="196049138"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231647%20Introduce%20peepmatic%3A%20a%20peephole%20optim.../near/196049138" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231647.20Introduce.20peepmatic.3A.20a.20peephole.20optim.2E.2E.2E.html#196049138">(May 02 2020 at 12:19)</a>:</h4>
<p>bjorn3 created <a href="https://github.com/bytecodealliance/wasmtime/pull/1647#discussion_r418950966" title="https://github.com/bytecodealliance/wasmtime/pull/1647#discussion_r418950966">PR Review Comment</a>:</p>
<blockquote>
<div class="codehilite"><pre><span></span><code>    False,
</code></pre></div>


</blockquote>



<a name="196049139"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231647%20Introduce%20peepmatic%3A%20a%20peephole%20optim.../near/196049139" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231647.20Introduce.20peepmatic.3A.20a.20peephole.20optim.2E.2E.2E.html#196049139">(May 02 2020 at 12:19)</a>:</h4>
<p>bjorn3 created <a href="https://github.com/bytecodealliance/wasmtime/pull/1647#discussion_r418950478" title="https://github.com/bytecodealliance/wasmtime/pull/1647#discussion_r418950478">PR Review Comment</a>:</p>
<blockquote>
<p>Is there any use for this function as opposed to using <code>intern</code>?</p>
</blockquote>



<a name="196049140"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231647%20Introduce%20peepmatic%3A%20a%20peephole%20optim.../near/196049140" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231647.20Introduce.20peepmatic.3A.20a.20peephole.20optim.2E.2E.2E.html#196049140">(May 02 2020 at 12:19)</a>:</h4>
<p>bjorn3 created <a href="https://github.com/bytecodealliance/wasmtime/pull/1647#discussion_r418950897" title="https://github.com/bytecodealliance/wasmtime/pull/1647#discussion_r418950897">PR Review Comment</a>:</p>
<blockquote>
<p>It would be nice to start this doc comment with a single sentence describing this type in short, followed by a blank line. Rustdoc will then show that sentence and only that sentence when visiting the documentation of the parent module.</p>
</blockquote>



<a name="196049141"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231647%20Introduce%20peepmatic%3A%20a%20peephole%20optim.../near/196049141" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231647.20Introduce.20peepmatic.3A.20a.20peephole.20optim.2E.2E.2E.html#196049141">(May 02 2020 at 12:19)</a>:</h4>
<p>bjorn3 created <a href="https://github.com/bytecodealliance/wasmtime/pull/1647#discussion_r418951064" title="https://github.com/bytecodealliance/wasmtime/pull/1647#discussion_r418951064">PR Review Comment</a>:</p>
<blockquote>
<div class="codehilite"><pre><span></span><code>    /// Implicitly define the n^th RHS as a condition code.
</code></pre></div>


</blockquote>



<a name="196049142"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231647%20Introduce%20peepmatic%3A%20a%20peephole%20optim.../near/196049142" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231647.20Introduce.20peepmatic.3A.20a.20peephole.20optim.2E.2E.2E.html#196049142">(May 02 2020 at 12:19)</a>:</h4>
<p>bjorn3 created <a href="https://github.com/bytecodealliance/wasmtime/pull/1647#discussion_r418951253" title="https://github.com/bytecodealliance/wasmtime/pull/1647#discussion_r418951253">PR Review Comment</a>:</p>
<blockquote>
<p>Is there any use for peephole optimization of <code>adjust_sp_down{,_imm}</code>?</p>
</blockquote>



<a name="196049143"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231647%20Introduce%20peepmatic%3A%20a%20peephole%20optim.../near/196049143" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231647.20Introduce.20peepmatic.3A.20a.20peephole.20optim.2E.2E.2E.html#196049143">(May 02 2020 at 12:19)</a>:</h4>
<p>bjorn3 created <a href="https://github.com/bytecodealliance/wasmtime/pull/1647#discussion_r418951149" title="https://github.com/bytecodealliance/wasmtime/pull/1647#discussion_r418951149">PR Review Comment</a>:</p>
<blockquote>
<p>"implicitly" is repeated for all variants.</p>
</blockquote>



<a name="196049144"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231647%20Introduce%20peepmatic%3A%20a%20peephole%20optim.../near/196049144" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231647.20Introduce.20peepmatic.3A.20a.20peephole.20optim.2E.2E.2E.html#196049144">(May 02 2020 at 12:19)</a>:</h4>
<p>bjorn3 created <a href="https://github.com/bytecodealliance/wasmtime/pull/1647#discussion_r418951653" title="https://github.com/bytecodealliance/wasmtime/pull/1647#discussion_r418951653">PR Review Comment</a>:</p>
<blockquote>
<div class="codehilite"><pre><span></span><code>    /// A map from a path (whose owned data is inside `arena`) to the canonical
    /// `PathId` we assigned it when interning it.
    map: HashMap&lt;UnsafePath, PathId&gt;,

    /// A map from a `PathId` index to an unsafe, self-borrowed path pointing
    /// into `arena`. It is safe to given these out as safe `Path`s, as long as
    /// the lifetime is not longer than this `PathInterner`&#39;s lifetime.
    paths: Vec&lt;UnsafePath&gt;,

    /// Bump allocation arena for path data. The bump arena ensures that these
    /// allocations never move, and are therefore safe for self-references.
</code></pre></div>


<p>These show up when using <code>--document-private-items</code>.</p>
</blockquote>



<a name="196050433"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231647%20Introduce%20peepmatic%3A%20a%20peephole%20optim.../near/196050433" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231647.20Introduce.20peepmatic.3A.20a.20peephole.20optim.2E.2E.2E.html#196050433">(May 02 2020 at 12:54)</a>:</h4>
<p>bjorn3 submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/1647#pullrequestreview-404523965" title="https://github.com/bytecodealliance/wasmtime/pull/1647#pullrequestreview-404523965">PR Review</a>.</p>



<a name="196050434"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231647%20Introduce%20peepmatic%3A%20a%20peephole%20optim.../near/196050434" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231647.20Introduce.20peepmatic.3A.20a.20peephole.20optim.2E.2E.2E.html#196050434">(May 02 2020 at 12:54)</a>:</h4>
<p>bjorn3 submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/1647#pullrequestreview-404523965" title="https://github.com/bytecodealliance/wasmtime/pull/1647#pullrequestreview-404523965">PR Review</a>.</p>



<a name="196050435"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231647%20Introduce%20peepmatic%3A%20a%20peephole%20optim.../near/196050435" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231647.20Introduce.20peepmatic.3A.20a.20peephole.20optim.2E.2E.2E.html#196050435">(May 02 2020 at 12:54)</a>:</h4>
<p>bjorn3 created <a href="https://github.com/bytecodealliance/wasmtime/pull/1647#discussion_r418952294" title="https://github.com/bytecodealliance/wasmtime/pull/1647#discussion_r418952294">PR Review Comment</a>:</p>
<blockquote>
<p>You can already match on <code>ValueDef</code> yourself.</p>
</blockquote>



<a name="196050436"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231647%20Introduce%20peepmatic%3A%20a%20peephole%20optim.../near/196050436" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231647.20Introduce.20peepmatic.3A.20a.20peephole.20optim.2E.2E.2E.html#196050436">(May 02 2020 at 12:54)</a>:</h4>
<p>bjorn3 created <a href="https://github.com/bytecodealliance/wasmtime/pull/1647#discussion_r418952540" title="https://github.com/bytecodealliance/wasmtime/pull/1647#discussion_r418952540">PR Review Comment</a>:</p>
<blockquote>
<p>Maybe require that <code>src</code> is already not in the layout?</p>
</blockquote>



<a name="196050437"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231647%20Introduce%20peepmatic%3A%20a%20peephole%20optim.../near/196050437" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231647.20Introduce.20peepmatic.3A.20a.20peephole.20optim.2E.2E.2E.html#196050437">(May 02 2020 at 12:54)</a>:</h4>
<p>bjorn3 created <a href="https://github.com/bytecodealliance/wasmtime/pull/1647#discussion_r418952674" title="https://github.com/bytecodealliance/wasmtime/pull/1647#discussion_r418952674">PR Review Comment</a>:</p>
<blockquote>
<p>Please add a CI check that <code>preopt.serialized</code> is up to date.</p>
</blockquote>



<a name="196050438"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231647%20Introduce%20peepmatic%3A%20a%20peephole%20optim.../near/196050438" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231647.20Introduce.20peepmatic.3A.20a.20peephole.20optim.2E.2E.2E.html#196050438">(May 02 2020 at 12:54)</a>:</h4>
<p>bjorn3 created <a href="https://github.com/bytecodealliance/wasmtime/pull/1647#discussion_r418952972" title="https://github.com/bytecodealliance/wasmtime/pull/1647#discussion_r418952972">PR Review Comment</a>:</p>
<blockquote>
<p>Is 1 unreachable?</p>
</blockquote>



<a name="196050439"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231647%20Introduce%20peepmatic%3A%20a%20peephole%20optim.../near/196050439" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231647.20Introduce.20peepmatic.3A.20a.20peephole.20optim.2E.2E.2E.html#196050439">(May 02 2020 at 12:54)</a>:</h4>
<p>bjorn3 created <a href="https://github.com/bytecodealliance/wasmtime/pull/1647#discussion_r418953202" title="https://github.com/bytecodealliance/wasmtime/pull/1647#discussion_r418953202">PR Review Comment</a>:</p>
<blockquote>
<p>Same here re size of 1.</p>
</blockquote>



<a name="196050440"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231647%20Introduce%20peepmatic%3A%20a%20peephole%20optim.../near/196050440" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231647.20Introduce.20peepmatic.3A.20a.20peephole.20optim.2E.2E.2E.html#196050440">(May 02 2020 at 12:54)</a>:</h4>
<p>bjorn3 created <a href="https://github.com/bytecodealliance/wasmtime/pull/1647#discussion_r418953398" title="https://github.com/bytecodealliance/wasmtime/pull/1647#discussion_r418953398">PR Review Comment</a>:</p>
<blockquote>
<p>If this is for a signed operation, the immediate needs to be sign extended.</p>
</blockquote>



<a name="196050441"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231647%20Introduce%20peepmatic%3A%20a%20peephole%20optim.../near/196050441" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231647.20Introduce.20peepmatic.3A.20a.20peephole.20optim.2E.2E.2E.html#196050441">(May 02 2020 at 12:54)</a>:</h4>
<p>bjorn3 created <a href="https://github.com/bytecodealliance/wasmtime/pull/1647#discussion_r418954240" title="https://github.com/bytecodealliance/wasmtime/pull/1647#discussion_r418954240">PR Review Comment</a>:</p>
<blockquote>
<p>Why are the constants here at the beginning, instead of at the end like in the real clif ir?</p>
</blockquote>



<a name="196050442"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231647%20Introduce%20peepmatic%3A%20a%20peephole%20optim.../near/196050442" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231647.20Introduce.20peepmatic.3A.20a.20peephole.20optim.2E.2E.2E.html#196050442">(May 02 2020 at 12:54)</a>:</h4>
<p>bjorn3 created <a href="https://github.com/bytecodealliance/wasmtime/pull/1647#discussion_r418954484" title="https://github.com/bytecodealliance/wasmtime/pull/1647#discussion_r418954484">PR Review Comment</a>:</p>
<blockquote>
<p>To be honest reading through this file was tiresome. Maybe a more rust like syntax would help with this?</p>
</blockquote>



<a name="196050443"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231647%20Introduce%20peepmatic%3A%20a%20peephole%20optim.../near/196050443" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231647.20Introduce.20peepmatic.3A.20a.20peephole.20optim.2E.2E.2E.html#196050443">(May 02 2020 at 12:54)</a>:</h4>
<p>bjorn3 created <a href="https://github.com/bytecodealliance/wasmtime/pull/1647#discussion_r418955601" title="https://github.com/bytecodealliance/wasmtime/pull/1647#discussion_r418955601">PR Review Comment</a>:</p>
<blockquote>
<p>Maybe avoid duplication by moving the <code>linear::Optimization</code> construction into the macro, leaving this closure to just return a Vec. Also you can try to cast the closure to <code>fn(&amp;mut dyn FnMut(&amp;[u8]) -&gt; PathId, &amp;mut dyn FnMut(u64) -&gt; IntegerId) -&gt; Vec&lt;linear::Increment&gt;</code> before calling it. This may help type inference enough to not need explicit type annotations here.</p>
</blockquote>



<a name="196050553"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231647%20Introduce%20peepmatic%3A%20a%20peephole%20optim.../near/196050553" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231647.20Introduce.20peepmatic.3A.20a.20peephole.20optim.2E.2E.2E.html#196050553">(May 02 2020 at 12:58)</a>:</h4>
<p>bjorn3 submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/1647#pullrequestreview-404526413" title="https://github.com/bytecodealliance/wasmtime/pull/1647#pullrequestreview-404526413">PR Review</a>.</p>



<a name="196050554"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231647%20Introduce%20peepmatic%3A%20a%20peephole%20optim.../near/196050554" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231647.20Introduce.20peepmatic.3A.20a.20peephole.20optim.2E.2E.2E.html#196050554">(May 02 2020 at 12:58)</a>:</h4>
<p>bjorn3 created <a href="https://github.com/bytecodealliance/wasmtime/pull/1647#discussion_r418956092" title="https://github.com/bytecodealliance/wasmtime/pull/1647#discussion_r418956092">PR Review Comment</a>:</p>
<blockquote>
<p>This doesn't check if the peephole optimizers were up to date. Only that they can be rebuild.</p>
</blockquote>



<a name="196050557"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231647%20Introduce%20peepmatic%3A%20a%20peephole%20optim.../near/196050557" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231647.20Introduce.20peepmatic.3A.20a.20peephole.20optim.2E.2E.2E.html#196050557">(May 02 2020 at 12:58)</a>:</h4>
<p>bjorn3 deleted <a href="https://github.com/bytecodealliance/wasmtime/pull/1647#discussion_r418952674" title="https://github.com/bytecodealliance/wasmtime/pull/1647#discussion_r418952674">PR Review Comment</a>.</p>



<a name="196939982"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231647%20Introduce%20peepmatic%3A%20a%20peephole%20optim.../near/196939982" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231647.20Introduce.20peepmatic.3A.20a.20peephole.20optim.2E.2E.2E.html#196939982">(May 08 2020 at 19:29)</a>:</h4>
<p>fitzgen submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/1647#pullrequestreview-408472437" title="https://github.com/bytecodealliance/wasmtime/pull/1647#pullrequestreview-408472437">PR Review</a>.</p>



<a name="196939984"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231647%20Introduce%20peepmatic%3A%20a%20peephole%20optim.../near/196939984" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231647.20Introduce.20peepmatic.3A.20a.20peephole.20optim.2E.2E.2E.html#196939984">(May 08 2020 at 19:29)</a>:</h4>
<p>fitzgen created <a href="https://github.com/bytecodealliance/wasmtime/pull/1647#discussion_r422330708" title="https://github.com/bytecodealliance/wasmtime/pull/1647#discussion_r422330708">PR Review Comment</a>:</p>
<blockquote>
<p>Yes, it is used when evaluating <code>MatchOp::IntegerValue</code> -- see <code>peepmatic/crates/runtime/src/optimizer.rs</code>.</p>
</blockquote>



<a name="196941709"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231647%20Introduce%20peepmatic%3A%20a%20peephole%20optim.../near/196941709" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231647.20Introduce.20peepmatic.3A.20a.20peephole.20optim.2E.2E.2E.html#196941709">(May 08 2020 at 19:44)</a>:</h4>
<p>fitzgen submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/1647#pullrequestreview-408481008" title="https://github.com/bytecodealliance/wasmtime/pull/1647#pullrequestreview-408481008">PR Review</a>.</p>



<a name="196941711"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231647%20Introduce%20peepmatic%3A%20a%20peephole%20optim.../near/196941711" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231647.20Introduce.20peepmatic.3A.20a.20peephole.20optim.2E.2E.2E.html#196941711">(May 08 2020 at 19:44)</a>:</h4>
<p>fitzgen created <a href="https://github.com/bytecodealliance/wasmtime/pull/1647#discussion_r422337540" title="https://github.com/bytecodealliance/wasmtime/pull/1647#discussion_r422337540">PR Review Comment</a>:</p>
<blockquote>
<p><code>Nop</code> is closer to <code>True</code> than <code>False</code>, but I think renaming it really clarifies anything here.</p>
</blockquote>



<a name="196942246"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231647%20Introduce%20peepmatic%3A%20a%20peephole%20optim.../near/196942246" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231647.20Introduce.20peepmatic.3A.20a.20peephole.20optim.2E.2E.2E.html#196942246">(May 08 2020 at 19:49)</a>:</h4>
<p>fitzgen submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/1647#pullrequestreview-408483672" title="https://github.com/bytecodealliance/wasmtime/pull/1647#pullrequestreview-408483672">PR Review</a>.</p>



<a name="196942247"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231647%20Introduce%20peepmatic%3A%20a%20peephole%20optim.../near/196942247" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231647.20Introduce.20peepmatic.3A.20a.20peephole.20optim.2E.2E.2E.html#196942247">(May 08 2020 at 19:49)</a>:</h4>
<p>fitzgen created <a href="https://github.com/bytecodealliance/wasmtime/pull/1647#discussion_r422339639" title="https://github.com/bytecodealliance/wasmtime/pull/1647#discussion_r422339639">PR Review Comment</a>:</p>
<blockquote>
<p>Yes, to convert <code>adjust_sp_down</code> with a constant argument into an <code>adjust_sp_down_imm</code>.</p>
</blockquote>



<a name="196945619"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231647%20Introduce%20peepmatic%3A%20a%20peephole%20optim.../near/196945619" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231647.20Introduce.20peepmatic.3A.20a.20peephole.20optim.2E.2E.2E.html#196945619">(May 08 2020 at 20:19)</a>:</h4>
<p>fitzgen created <a href="https://github.com/bytecodealliance/wasmtime/pull/1647#discussion_r422353161" title="https://github.com/bytecodealliance/wasmtime/pull/1647#discussion_r422353161">PR Review Comment</a>:</p>
<blockquote>
<p>In clif, some immediates are at the beginning (e.g. condition codes) and some are at the end (e.g. constant values). For simplicity, I implemented peepmatic such that all immediates come first, followed by all operands. There is no inherent reason it needs to be this way.</p>
</blockquote>



<a name="196945620"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231647%20Introduce%20peepmatic%3A%20a%20peephole%20optim.../near/196945620" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231647.20Introduce.20peepmatic.3A.20a.20peephole.20optim.2E.2E.2E.html#196945620">(May 08 2020 at 20:19)</a>:</h4>
<p>fitzgen submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/1647#pullrequestreview-408500373" title="https://github.com/bytecodealliance/wasmtime/pull/1647#pullrequestreview-408500373">PR Review</a>.</p>



<a name="196945913"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231647%20Introduce%20peepmatic%3A%20a%20peephole%20optim.../near/196945913" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231647.20Introduce.20peepmatic.3A.20a.20peephole.20optim.2E.2E.2E.html#196945913">(May 08 2020 at 20:21)</a>:</h4>
<p>fitzgen submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/1647#pullrequestreview-408501720" title="https://github.com/bytecodealliance/wasmtime/pull/1647#pullrequestreview-408501720">PR Review</a>.</p>



<a name="196945915"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231647%20Introduce%20peepmatic%3A%20a%20peephole%20optim.../near/196945915" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231647.20Introduce.20peepmatic.3A.20a.20peephole.20optim.2E.2E.2E.html#196945915">(May 08 2020 at 20:21)</a>:</h4>
<p>fitzgen created <a href="https://github.com/bytecodealliance/wasmtime/pull/1647#discussion_r422354211" title="https://github.com/bytecodealliance/wasmtime/pull/1647#discussion_r422354211">PR Review Comment</a>:</p>
<blockquote>
<p>S-expressions are simple and easy to parse. Plus we have nice infrastructure for them in the <code>wast</code> crate. Syntax and parsing is largely busy work, and not the interesting bits of this work. If the cranelift team feels strongly, we can change this, but it isn't worth debating about before landing this PR.</p>
</blockquote>



<a name="196946288"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231647%20Introduce%20peepmatic%3A%20a%20peephole%20optim.../near/196946288" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231647.20Introduce.20peepmatic.3A.20a.20peephole.20optim.2E.2E.2E.html#196946288">(May 08 2020 at 20:24)</a>:</h4>
<p>fitzgen submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/1647#pullrequestreview-408503488" title="https://github.com/bytecodealliance/wasmtime/pull/1647#pullrequestreview-408503488">PR Review</a>.</p>



<a name="196946289"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231647%20Introduce%20peepmatic%3A%20a%20peephole%20optim.../near/196946289" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231647.20Introduce.20peepmatic.3A.20a.20peephole.20optim.2E.2E.2E.html#196946289">(May 08 2020 at 20:24)</a>:</h4>
<p>fitzgen created <a href="https://github.com/bytecodealliance/wasmtime/pull/1647#discussion_r422355753" title="https://github.com/bytecodealliance/wasmtime/pull/1647#discussion_r422355753">PR Review Comment</a>:</p>
<blockquote>
<p>This is true, but it is nice having a convenience method, same as why <code>Result&lt;T, E&gt;</code> has an <code>ok</code> method.</p>
</blockquote>



<a name="196946414"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231647%20Introduce%20peepmatic%3A%20a%20peephole%20optim.../near/196946414" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231647.20Introduce.20peepmatic.3A.20a.20peephole.20optim.2E.2E.2E.html#196946414">(May 08 2020 at 20:26)</a>:</h4>
<p>fitzgen submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/1647#pullrequestreview-408504266" title="https://github.com/bytecodealliance/wasmtime/pull/1647#pullrequestreview-408504266">PR Review</a>.</p>



<a name="196946415"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231647%20Introduce%20peepmatic%3A%20a%20peephole%20optim.../near/196946415" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231647.20Introduce.20peepmatic.3A.20a.20peephole.20optim.2E.2E.2E.html#196946415">(May 08 2020 at 20:26)</a>:</h4>
<p>fitzgen created <a href="https://github.com/bytecodealliance/wasmtime/pull/1647#discussion_r422356347" title="https://github.com/bytecodealliance/wasmtime/pull/1647#discussion_r422356347">PR Review Comment</a>:</p>
<blockquote>
<p>This would require that we remove it ourselves before calling this method, which would be a bunch of duplication.</p>
</blockquote>



<a name="196946840"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231647%20Introduce%20peepmatic%3A%20a%20peephole%20optim.../near/196946840" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231647.20Introduce.20peepmatic.3A.20a.20peephole.20optim.2E.2E.2E.html#196946840">(May 08 2020 at 20:30)</a>:</h4>
<p>fitzgen submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/1647#pullrequestreview-408507224" title="https://github.com/bytecodealliance/wasmtime/pull/1647#pullrequestreview-408507224">PR Review</a>.</p>



<a name="196946841"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231647%20Introduce%20peepmatic%3A%20a%20peephole%20optim.../near/196946841" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231647.20Introduce.20peepmatic.3A.20a.20peephole.20optim.2E.2E.2E.html#196946841">(May 08 2020 at 20:30)</a>:</h4>
<p>fitzgen created <a href="https://github.com/bytecodealliance/wasmtime/pull/1647#discussion_r422358205" title="https://github.com/bytecodealliance/wasmtime/pull/1647#discussion_r422358205">PR Review Comment</a>:</p>
<blockquote>
<p>This is something we could do in the future with a custom serialization and deserialization implementation.</p>
</blockquote>



<a name="196948402"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231647%20Introduce%20peepmatic%3A%20a%20peephole%20optim.../near/196948402" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231647.20Introduce.20peepmatic.3A.20a.20peephole.20optim.2E.2E.2E.html#196948402">(May 08 2020 at 20:44)</a>:</h4>
<p>bjorn3 submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/1647#pullrequestreview-408514880" title="https://github.com/bytecodealliance/wasmtime/pull/1647#pullrequestreview-408514880">PR Review</a>.</p>



<a name="196948403"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231647%20Introduce%20peepmatic%3A%20a%20peephole%20optim.../near/196948403" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231647.20Introduce.20peepmatic.3A.20a.20peephole.20optim.2E.2E.2E.html#196948403">(May 08 2020 at 20:44)</a>:</h4>
<p>bjorn3 created <a href="https://github.com/bytecodealliance/wasmtime/pull/1647#discussion_r422364490" title="https://github.com/bytecodealliance/wasmtime/pull/1647#discussion_r422364490">PR Review Comment</a>:</p>
<blockquote>
<p>This order is confusing for <code>isub_imm</code>.</p>
</blockquote>



<a name="196948429"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231647%20Introduce%20peepmatic%3A%20a%20peephole%20optim.../near/196948429" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231647.20Introduce.20peepmatic.3A.20a.20peephole.20optim.2E.2E.2E.html#196948429">(May 08 2020 at 20:44)</a>:</h4>
<p>fitzgen submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/1647#pullrequestreview-408515063" title="https://github.com/bytecodealliance/wasmtime/pull/1647#pullrequestreview-408515063">PR Review</a>.</p>



<a name="196948431"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231647%20Introduce%20peepmatic%3A%20a%20peephole%20optim.../near/196948431" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231647.20Introduce.20peepmatic.3A.20a.20peephole.20optim.2E.2E.2E.html#196948431">(May 08 2020 at 20:44)</a>:</h4>
<p>fitzgen created <a href="https://github.com/bytecodealliance/wasmtime/pull/1647#discussion_r422364656" title="https://github.com/bytecodealliance/wasmtime/pull/1647#discussion_r422364656">PR Review Comment</a>:</p>
<blockquote>
<p>Nice idea!</p>
</blockquote>



<a name="196948693"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231647%20Introduce%20peepmatic%3A%20a%20peephole%20optim.../near/196948693" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231647.20Introduce.20peepmatic.3A.20a.20peephole.20optim.2E.2E.2E.html#196948693">(May 08 2020 at 20:47)</a>:</h4>
<p>fitzgen submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/1647#pullrequestreview-408516537" title="https://github.com/bytecodealliance/wasmtime/pull/1647#pullrequestreview-408516537">PR Review</a>.</p>



<a name="196948694"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231647%20Introduce%20peepmatic%3A%20a%20peephole%20optim.../near/196948694" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231647.20Introduce.20peepmatic.3A.20a.20peephole.20optim.2E.2E.2E.html#196948694">(May 08 2020 at 20:47)</a>:</h4>
<p>fitzgen created <a href="https://github.com/bytecodealliance/wasmtime/pull/1647#discussion_r422365863" title="https://github.com/bytecodealliance/wasmtime/pull/1647#discussion_r422365863">PR Review Comment</a>:</p>
<blockquote>
<p>I haven't been able to create a test case where I can observe the lack of sign extension, and the fact that the existing code wasn't doing this either makes me think it isn't necessary. Can you provide a test case that shows this?</p>
</blockquote>



<a name="196948878"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231647%20Introduce%20peepmatic%3A%20a%20peephole%20optim.../near/196948878" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231647.20Introduce.20peepmatic.3A.20a.20peephole.20optim.2E.2E.2E.html#196948878">(May 08 2020 at 20:48)</a>:</h4>
<p>fitzgen updated <a href="https://github.com/bytecodealliance/wasmtime/pull/1647" title="https://github.com/bytecodealliance/wasmtime/pull/1647">PR #1647</a> from <code>integrate-peepmatic</code> to <code>master</code>:</p>
<blockquote>
<p>This PR introduces <code>peepmatic</code>, a peephole optimizations DSL and peephole optimizer compiler.</p>
<p>Developers write a set of optimizations in the DSL, and then <code>peepmatic</code> compiles the set of optimizations into an efficient peephole optimizer:</p>
<div class="codehilite"><pre><span></span><code>DSL ----peepmatic----&gt; Peephole Optimizer
</code></pre></div>


<p>The generated peephole optimizer has all of its optimizations' left-hand sides collapsed into a compact transducer automaton that makes matching candidate instruction sequences fast.</p>
<p>The DSL's optimizations may be written by hand or discovered mechanically with a superoptimizer like [Souper][]. Eventually, <code>peepmatic</code> should have a verifier that ensures that the DSL's optimizations are sound, similar to what [Alive][] does for LLVM optimizations.</p>
<p>[Souper]: <a href="https://github.com/google/souper" title="https://github.com/google/souper">https://github.com/google/souper</a><br>
[Alive]: <a href="https://github.com/AliveToolkit/alive2" title="https://github.com/AliveToolkit/alive2">https://github.com/AliveToolkit/alive2</a></p>
<h3>Learn More</h3>
<ul>
<li>
<p><a href="https://github.com/fitzgen/wasmtime/blob/integrate-peepmatic/cranelift/peepmatic/README.md" title="https://github.com/fitzgen/wasmtime/blob/integrate-peepmatic/cranelift/peepmatic/README.md"><code>cranelift/peepmatic/README.md</code> has an overview of the DSL and implementation</a></p>
</li>
<li>
<p><a href="https://docs.google.com/presentation/d/1RW_UHWX1t9-_XkXVsPZauliW1LIJgGz02hUFZE7APT0/edit" title="https://docs.google.com/presentation/d/1RW_UHWX1t9-_XkXVsPZauliW1LIJgGz02hUFZE7APT0/edit">Here is a slide deck I am presenting at the 2020-05-04 Cranelift meeting</a></p>
</li>
</ul>
<h3>Current Status</h3>
<ul>
<li>
<p>I've ported most of <code>simple_preopt.rs</code> to <code>peepmatic</code>'s DSL</p>
</li>
<li>
<p>All tests are passing</p>
</li>
<li>
<p>I've been doing lots and lots of fuzzing</p>
</li>
</ul>
<h3>Next Steps</h3>
<p>This work is not complete, but I think it is at a good point to merge into Cranelift and then evolve in-tree.</p>
<p>The next steps after landing this PR are:</p>
<ul>
<li>
<p>Port the rest of <code>simple_preopt.rs</code> over to <code>peepmatic</code></p>
</li>
<li>
<p>Port <code>postopt.rs</code> over to <code>peepmatic</code></p>
</li>
<li>
<p>Optimize the runtime that interprets the generated peephole optimizations transducers and applies them</p>
</li>
<li>
<p>Extend <code>peepmatic</code> to work with the new backend's <code>MachInst</code> and vcode</p>
</li>
</ul>
<p>For even further future directions, see the discussion in the slides, linked above.</p>
</blockquote>



<a name="196953284"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231647%20Introduce%20peepmatic%3A%20a%20peephole%20optim.../near/196953284" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231647.20Introduce.20peepmatic.3A.20a.20peephole.20optim.2E.2E.2E.html#196953284">(May 08 2020 at 21:35)</a>:</h4>
<p>fitzgen updated <a href="https://github.com/bytecodealliance/wasmtime/pull/1647" title="https://github.com/bytecodealliance/wasmtime/pull/1647">PR #1647</a> from <code>integrate-peepmatic</code> to <code>master</code>:</p>
<blockquote>
<p>This PR introduces <code>peepmatic</code>, a peephole optimizations DSL and peephole optimizer compiler.</p>
<p>Developers write a set of optimizations in the DSL, and then <code>peepmatic</code> compiles the set of optimizations into an efficient peephole optimizer:</p>
<div class="codehilite"><pre><span></span><code>DSL ----peepmatic----&gt; Peephole Optimizer
</code></pre></div>


<p>The generated peephole optimizer has all of its optimizations' left-hand sides collapsed into a compact transducer automaton that makes matching candidate instruction sequences fast.</p>
<p>The DSL's optimizations may be written by hand or discovered mechanically with a superoptimizer like [Souper][]. Eventually, <code>peepmatic</code> should have a verifier that ensures that the DSL's optimizations are sound, similar to what [Alive][] does for LLVM optimizations.</p>
<p>[Souper]: <a href="https://github.com/google/souper" title="https://github.com/google/souper">https://github.com/google/souper</a><br>
[Alive]: <a href="https://github.com/AliveToolkit/alive2" title="https://github.com/AliveToolkit/alive2">https://github.com/AliveToolkit/alive2</a></p>
<h3>Learn More</h3>
<ul>
<li>
<p><a href="https://github.com/fitzgen/wasmtime/blob/integrate-peepmatic/cranelift/peepmatic/README.md" title="https://github.com/fitzgen/wasmtime/blob/integrate-peepmatic/cranelift/peepmatic/README.md"><code>cranelift/peepmatic/README.md</code> has an overview of the DSL and implementation</a></p>
</li>
<li>
<p><a href="https://docs.google.com/presentation/d/1RW_UHWX1t9-_XkXVsPZauliW1LIJgGz02hUFZE7APT0/edit" title="https://docs.google.com/presentation/d/1RW_UHWX1t9-_XkXVsPZauliW1LIJgGz02hUFZE7APT0/edit">Here is a slide deck I am presenting at the 2020-05-04 Cranelift meeting</a></p>
</li>
</ul>
<h3>Current Status</h3>
<ul>
<li>
<p>I've ported most of <code>simple_preopt.rs</code> to <code>peepmatic</code>'s DSL</p>
</li>
<li>
<p>All tests are passing</p>
</li>
<li>
<p>I've been doing lots and lots of fuzzing</p>
</li>
</ul>
<h3>Next Steps</h3>
<p>This work is not complete, but I think it is at a good point to merge into Cranelift and then evolve in-tree.</p>
<p>The next steps after landing this PR are:</p>
<ul>
<li>
<p>Port the rest of <code>simple_preopt.rs</code> over to <code>peepmatic</code></p>
</li>
<li>
<p>Port <code>postopt.rs</code> over to <code>peepmatic</code></p>
</li>
<li>
<p>Optimize the runtime that interprets the generated peephole optimizations transducers and applies them</p>
</li>
<li>
<p>Extend <code>peepmatic</code> to work with the new backend's <code>MachInst</code> and vcode</p>
</li>
</ul>
<p>For even further future directions, see the discussion in the slides, linked above.</p>
</blockquote>



<a name="196956463"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231647%20Introduce%20peepmatic%3A%20a%20peephole%20optim.../near/196956463" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231647.20Introduce.20peepmatic.3A.20a.20peephole.20optim.2E.2E.2E.html#196956463">(May 08 2020 at 22:13)</a>:</h4>
<p>fitzgen updated <a href="https://github.com/bytecodealliance/wasmtime/pull/1647" title="https://github.com/bytecodealliance/wasmtime/pull/1647">PR #1647</a> from <code>integrate-peepmatic</code> to <code>master</code>:</p>
<blockquote>
<p>This PR introduces <code>peepmatic</code>, a peephole optimizations DSL and peephole optimizer compiler.</p>
<p>Developers write a set of optimizations in the DSL, and then <code>peepmatic</code> compiles the set of optimizations into an efficient peephole optimizer:</p>
<div class="codehilite"><pre><span></span><code>DSL ----peepmatic----&gt; Peephole Optimizer
</code></pre></div>


<p>The generated peephole optimizer has all of its optimizations' left-hand sides collapsed into a compact transducer automaton that makes matching candidate instruction sequences fast.</p>
<p>The DSL's optimizations may be written by hand or discovered mechanically with a superoptimizer like [Souper][]. Eventually, <code>peepmatic</code> should have a verifier that ensures that the DSL's optimizations are sound, similar to what [Alive][] does for LLVM optimizations.</p>
<p>[Souper]: <a href="https://github.com/google/souper" title="https://github.com/google/souper">https://github.com/google/souper</a><br>
[Alive]: <a href="https://github.com/AliveToolkit/alive2" title="https://github.com/AliveToolkit/alive2">https://github.com/AliveToolkit/alive2</a></p>
<h3>Learn More</h3>
<ul>
<li>
<p><a href="https://github.com/fitzgen/wasmtime/blob/integrate-peepmatic/cranelift/peepmatic/README.md" title="https://github.com/fitzgen/wasmtime/blob/integrate-peepmatic/cranelift/peepmatic/README.md"><code>cranelift/peepmatic/README.md</code> has an overview of the DSL and implementation</a></p>
</li>
<li>
<p><a href="https://docs.google.com/presentation/d/1RW_UHWX1t9-_XkXVsPZauliW1LIJgGz02hUFZE7APT0/edit" title="https://docs.google.com/presentation/d/1RW_UHWX1t9-_XkXVsPZauliW1LIJgGz02hUFZE7APT0/edit">Here is a slide deck I am presenting at the 2020-05-04 Cranelift meeting</a></p>
</li>
</ul>
<h3>Current Status</h3>
<ul>
<li>
<p>I've ported most of <code>simple_preopt.rs</code> to <code>peepmatic</code>'s DSL</p>
</li>
<li>
<p>All tests are passing</p>
</li>
<li>
<p>I've been doing lots and lots of fuzzing</p>
</li>
</ul>
<h3>Next Steps</h3>
<p>This work is not complete, but I think it is at a good point to merge into Cranelift and then evolve in-tree.</p>
<p>The next steps after landing this PR are:</p>
<ul>
<li>
<p>Port the rest of <code>simple_preopt.rs</code> over to <code>peepmatic</code></p>
</li>
<li>
<p>Port <code>postopt.rs</code> over to <code>peepmatic</code></p>
</li>
<li>
<p>Optimize the runtime that interprets the generated peephole optimizations transducers and applies them</p>
</li>
<li>
<p>Extend <code>peepmatic</code> to work with the new backend's <code>MachInst</code> and vcode</p>
</li>
</ul>
<p>For even further future directions, see the discussion in the slides, linked above.</p>
</blockquote>



<a name="197326425"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231647%20Introduce%20peepmatic%3A%20a%20peephole%20optim.../near/197326425" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231647.20Introduce.20peepmatic.3A.20a.20peephole.20optim.2E.2E.2E.html#197326425">(May 12 2020 at 19:29)</a>:</h4>
<p>fitzgen updated <a href="https://github.com/bytecodealliance/wasmtime/pull/1647">PR #1647</a> from <code>integrate-peepmatic</code> to <code>master</code>:</p>
<blockquote>
<p>This PR introduces <code>peepmatic</code>, a peephole optimizations DSL and peephole optimizer compiler.</p>
<p>Developers write a set of optimizations in the DSL, and then <code>peepmatic</code> compiles the set of optimizations into an efficient peephole optimizer:</p>
<div class="codehilite"><pre><span></span><code>DSL ----peepmatic----&gt; Peephole Optimizer
</code></pre></div>


<p>The generated peephole optimizer has all of its optimizations' left-hand sides collapsed into a compact transducer automaton that makes matching candidate instruction sequences fast.</p>
<p>The DSL's optimizations may be written by hand or discovered mechanically with a superoptimizer like [Souper][]. Eventually, <code>peepmatic</code> should have a verifier that ensures that the DSL's optimizations are sound, similar to what [Alive][] does for LLVM optimizations.</p>
<p>[Souper]: <a href="https://github.com/google/souper">https://github.com/google/souper</a><br>
[Alive]: <a href="https://github.com/AliveToolkit/alive2">https://github.com/AliveToolkit/alive2</a></p>
<h3>Learn More</h3>
<ul>
<li>
<p><a href="https://github.com/fitzgen/wasmtime/blob/integrate-peepmatic/cranelift/peepmatic/README.md"><code>cranelift/peepmatic/README.md</code> has an overview of the DSL and implementation</a></p>
</li>
<li>
<p><a href="https://docs.google.com/presentation/d/1RW_UHWX1t9-_XkXVsPZauliW1LIJgGz02hUFZE7APT0/edit">Here is a slide deck I am presenting at the 2020-05-04 Cranelift meeting</a></p>
</li>
</ul>
<h3>Current Status</h3>
<ul>
<li>
<p>I've ported most of <code>simple_preopt.rs</code> to <code>peepmatic</code>'s DSL</p>
</li>
<li>
<p>All tests are passing</p>
</li>
<li>
<p>I've been doing lots and lots of fuzzing</p>
</li>
</ul>
<h3>Next Steps</h3>
<p>This work is not complete, but I think it is at a good point to merge into Cranelift and then evolve in-tree.</p>
<p>The next steps after landing this PR are:</p>
<ul>
<li>
<p>Port the rest of <code>simple_preopt.rs</code> over to <code>peepmatic</code></p>
</li>
<li>
<p>Port <code>postopt.rs</code> over to <code>peepmatic</code></p>
</li>
<li>
<p>Optimize the runtime that interprets the generated peephole optimizations transducers and applies them</p>
</li>
<li>
<p>Extend <code>peepmatic</code> to work with the new backend's <code>MachInst</code> and vcode</p>
</li>
</ul>
<p>For even further future directions, see the discussion in the slides, linked above.</p>
</blockquote>



<a name="197327129"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231647%20Introduce%20peepmatic%3A%20a%20peephole%20optim.../near/197327129" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231647.20Introduce.20peepmatic.3A.20a.20peephole.20optim.2E.2E.2E.html#197327129">(May 12 2020 at 19:34)</a>:</h4>
<p>bjorn3 submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/1647#pullrequestreview-410360941">PR Review</a>.</p>



<a name="197327130"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231647%20Introduce%20peepmatic%3A%20a%20peephole%20optim.../near/197327130" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231647.20Introduce.20peepmatic.3A.20a.20peephole.20optim.2E.2E.2E.html#197327130">(May 12 2020 at 19:34)</a>:</h4>
<p>bjorn3 created <a href="https://github.com/bytecodealliance/wasmtime/pull/1647#discussion_r423984151">PR Review Comment</a>:</p>
<blockquote>
<p>See <a href="https://github.com/bytecodealliance/wasmtime/issues/1095">https://github.com/bytecodealliance/wasmtime/issues/1095</a></p>
</blockquote>



<a name="197336818"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231647%20Introduce%20peepmatic%3A%20a%20peephole%20optim.../near/197336818" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231647.20Introduce.20peepmatic.3A.20a.20peephole.20optim.2E.2E.2E.html#197336818">(May 12 2020 at 20:46)</a>:</h4>
<p>fitzgen submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/1647#pullrequestreview-410409041">PR Review</a>.</p>



<a name="197336819"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231647%20Introduce%20peepmatic%3A%20a%20peephole%20optim.../near/197336819" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231647.20Introduce.20peepmatic.3A.20a.20peephole.20optim.2E.2E.2E.html#197336819">(May 12 2020 at 20:46)</a>:</h4>
<p>fitzgen created <a href="https://github.com/bytecodealliance/wasmtime/pull/1647#discussion_r424023082">PR Review Comment</a>:</p>
<blockquote>
<p>Thanks. I'll work on fixing #1095 at the <code>InstructionBuilder</code> level, as suggested in that issue, rather than in this PR.</p>
</blockquote>



<a name="197491781"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231647%20Introduce%20peepmatic%3A%20a%20peephole%20optim.../near/197491781" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231647.20Introduce.20peepmatic.3A.20a.20peephole.20optim.2E.2E.2E.html#197491781">(May 13 2020 at 23:48)</a>:</h4>
<p>sunfishcode submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/1647#pullrequestreview-411370902">PR Review</a>.</p>



<a name="197491783"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231647%20Introduce%20peepmatic%3A%20a%20peephole%20optim.../near/197491783" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231647.20Introduce.20peepmatic.3A.20a.20peephole.20optim.2E.2E.2E.html#197491783">(May 13 2020 at 23:48)</a>:</h4>
<p>sunfishcode submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/1647#pullrequestreview-411370902">PR Review</a>.</p>



<a name="197491784"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231647%20Introduce%20peepmatic%3A%20a%20peephole%20optim.../near/197491784" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231647.20Introduce.20peepmatic.3A.20a.20peephole.20optim.2E.2E.2E.html#197491784">(May 13 2020 at 23:48)</a>:</h4>
<p>sunfishcode created <a href="https://github.com/bytecodealliance/wasmtime/pull/1647#discussion_r424790801">PR Review Comment</a>:</p>
<blockquote>
<p>I don't see the <code>func</code> or <code>isa</code> lifetimes being used outside of this declaration, so it's not clear why <code>do_preopt</code>'s signature changed here. Does the <code>optimizer</code> have any state that lives longer than the <code>do_preopt</code> call?</p>
</blockquote>



<a name="197565711"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231647%20Introduce%20peepmatic%3A%20a%20peephole%20optim.../near/197565711" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231647.20Introduce.20peepmatic.3A.20a.20peephole.20optim.2E.2E.2E.html#197565711">(May 14 2020 at 14:47)</a>:</h4>
<p>fitzgen submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/1647#pullrequestreview-411881650">PR Review</a>.</p>



<a name="197565712"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231647%20Introduce%20peepmatic%3A%20a%20peephole%20optim.../near/197565712" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231647.20Introduce.20peepmatic.3A.20a.20peephole.20optim.2E.2E.2E.html#197565712">(May 14 2020 at 14:47)</a>:</h4>
<p>fitzgen created <a href="https://github.com/bytecodealliance/wasmtime/pull/1647#discussion_r425195771">PR Review Comment</a>:</p>
<blockquote>
<p>This might be left over from some bits that ultimately got thrown away; I'll try and remove it and on the off chance that I can't, then I'll have an explanation for why not ;)</p>
</blockquote>



<a name="197566376"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231647%20Introduce%20peepmatic%3A%20a%20peephole%20optim.../near/197566376" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231647.20Introduce.20peepmatic.3A.20a.20peephole.20optim.2E.2E.2E.html#197566376">(May 14 2020 at 14:52)</a>:</h4>
<p>fitzgen submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/1647#pullrequestreview-411886664">PR Review</a>.</p>



<a name="197566377"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231647%20Introduce%20peepmatic%3A%20a%20peephole%20optim.../near/197566377" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231647.20Introduce.20peepmatic.3A.20a.20peephole.20optim.2E.2E.2E.html#197566377">(May 14 2020 at 14:52)</a>:</h4>
<p>fitzgen created <a href="https://github.com/bytecodealliance/wasmtime/pull/1647#discussion_r425199560">PR Review Comment</a>:</p>
<blockquote>
<p>Ok, these are removed.</p>
</blockquote>



<a name="197566393"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231647%20Introduce%20peepmatic%3A%20a%20peephole%20optim.../near/197566393" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231647.20Introduce.20peepmatic.3A.20a.20peephole.20optim.2E.2E.2E.html#197566393">(May 14 2020 at 14:52)</a>:</h4>
<p>fitzgen updated <a href="https://github.com/bytecodealliance/wasmtime/pull/1647">PR #1647</a> from <code>integrate-peepmatic</code> to <code>master</code>:</p>
<blockquote>
<p>This PR introduces <code>peepmatic</code>, a peephole optimizations DSL and peephole optimizer compiler.</p>
<p>Developers write a set of optimizations in the DSL, and then <code>peepmatic</code> compiles the set of optimizations into an efficient peephole optimizer:</p>
<div class="codehilite"><pre><span></span><code>DSL ----peepmatic----&gt; Peephole Optimizer
</code></pre></div>


<p>The generated peephole optimizer has all of its optimizations' left-hand sides collapsed into a compact transducer automaton that makes matching candidate instruction sequences fast.</p>
<p>The DSL's optimizations may be written by hand or discovered mechanically with a superoptimizer like [Souper][]. Eventually, <code>peepmatic</code> should have a verifier that ensures that the DSL's optimizations are sound, similar to what [Alive][] does for LLVM optimizations.</p>
<p>[Souper]: <a href="https://github.com/google/souper">https://github.com/google/souper</a><br>
[Alive]: <a href="https://github.com/AliveToolkit/alive2">https://github.com/AliveToolkit/alive2</a></p>
<h3>Learn More</h3>
<ul>
<li>
<p><a href="https://github.com/fitzgen/wasmtime/blob/integrate-peepmatic/cranelift/peepmatic/README.md"><code>cranelift/peepmatic/README.md</code> has an overview of the DSL and implementation</a></p>
</li>
<li>
<p><a href="https://docs.google.com/presentation/d/1RW_UHWX1t9-_XkXVsPZauliW1LIJgGz02hUFZE7APT0/edit">Here is a slide deck I am presenting at the 2020-05-04 Cranelift meeting</a></p>
</li>
</ul>
<h3>Current Status</h3>
<ul>
<li>
<p>I've ported most of <code>simple_preopt.rs</code> to <code>peepmatic</code>'s DSL</p>
</li>
<li>
<p>All tests are passing</p>
</li>
<li>
<p>I've been doing lots and lots of fuzzing</p>
</li>
</ul>
<h3>Next Steps</h3>
<p>This work is not complete, but I think it is at a good point to merge into Cranelift and then evolve in-tree.</p>
<p>The next steps after landing this PR are:</p>
<ul>
<li>
<p>Port the rest of <code>simple_preopt.rs</code> over to <code>peepmatic</code></p>
</li>
<li>
<p>Port <code>postopt.rs</code> over to <code>peepmatic</code></p>
</li>
<li>
<p>Optimize the runtime that interprets the generated peephole optimizations transducers and applies them</p>
</li>
<li>
<p>Extend <code>peepmatic</code> to work with the new backend's <code>MachInst</code> and vcode</p>
</li>
</ul>
<p>For even further future directions, see the discussion in the slides, linked above.</p>
</blockquote>



<a name="197577269"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231647%20Introduce%20peepmatic%3A%20a%20peephole%20optim.../near/197577269" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231647.20Introduce.20peepmatic.3A.20a.20peephole.20optim.2E.2E.2E.html#197577269">(May 14 2020 at 16:02)</a>:</h4>
<p>fitzgen merged <a href="https://github.com/bytecodealliance/wasmtime/pull/1647">PR #1647</a>.</p>



<hr><p>Last updated: Jan 20 2025 at 06:04 UTC</p>
</html>