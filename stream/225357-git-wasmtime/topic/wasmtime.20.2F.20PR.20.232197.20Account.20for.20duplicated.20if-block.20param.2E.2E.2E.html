<html>
<head><meta charset="utf-8"><title>wasmtime / PR #2197 Account for duplicated if-block param... · git-wasmtime · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/index.html">git-wasmtime</a></h2>
<h3>Topic: <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232197.20Account.20for.20duplicated.20if-block.20param.2E.2E.2E.html">wasmtime / PR #2197 Account for duplicated if-block param...</a></h3>

<hr>

<base href="https://bytecodealliance.zulipchat.com">

<head><link href="https://bytecodealliance.github.io/zulip-archive/style.css" rel="stylesheet"></head>

<a name="209840535"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232197%20Account%20for%20duplicated%20if-block%20param.../near/209840535" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232197.20Account.20for.20duplicated.20if-block.20param.2E.2E.2E.html#209840535">(Sep 11 2020 at 22:01)</a>:</h4>
<p>cfallin opened <a href="https://github.com/bytecodealliance/wasmtime/pull/2197">PR #2197</a> from <code>fix-if-params</code> to <code>main</code>:</p>
<blockquote>
<p>This is a close analogue to @bnjbvr 's fix in commit 518b7a7e. Similar to<br>
that fix, this PR fixes a bug in which the Wasm translator could<br>
misalign its value stack and either mistranslate or cause a panic with a<br>
type-checking error.</p>
<p>Found via fuzzing by :decoder in SpiderMonkey (bug 1664453).</p>
<p>&lt;!--</p>
<p>Please ensure that the following steps are all taken care of before submitting<br>
the PR.</p>
<ul>
<li>
<p>[ ] This has been discussed in issue #..., or if not, please tell us why<br>
  here.</p>
</li>
<li>
<p>[ ] A short description of what this does, why it is needed; if the<br>
  description becomes long, the matter should probably be discussed in an issue<br>
  first.</p>
</li>
<li>
<p>[ ] This PR contains test cases, if meaningful.</p>
</li>
<li>[ ] A reviewer from the core maintainer team has been assigned for this PR.<br>
  If you don't know who could review this, please indicate so. The list of<br>
  suggested reviewers on the right can help you.</li>
</ul>
<p>Please ensure all communication adheres to the <a href="https://github.com/bytecodealliance/wasmtime/blob/master/CODE_OF_CONDUCT.md">code of
conduct</a>.<br>
--&gt;</p>
</blockquote>



<a name="209840537"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232197%20Account%20for%20duplicated%20if-block%20param.../near/209840537" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232197.20Account.20for.20duplicated.20if-block.20param.2E.2E.2E.html#209840537">(Sep 11 2020 at 22:01)</a>:</h4>
<p><strong>cfallin</strong> requested <a href="https://github.com/fitzgen">fitzgen</a> for a review on <a href="https://github.com/bytecodealliance/wasmtime/pull/2197">PR #2197</a>.</p>



<a name="209841226"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232197%20Account%20for%20duplicated%20if-block%20param.../near/209841226" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232197.20Account.20for.20duplicated.20if-block.20param.2E.2E.2E.html#209841226">(Sep 11 2020 at 22:09)</a>:</h4>
<p>bjorn3 submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/2197#pullrequestreview-487150732">PR Review</a>.</p>



<a name="209841227"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232197%20Account%20for%20duplicated%20if-block%20param.../near/209841227" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232197.20Account.20for.20duplicated.20if-block.20param.2E.2E.2E.html#209841227">(Sep 11 2020 at 22:09)</a>:</h4>
<p>bjorn3 submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/2197#pullrequestreview-487150732">PR Review</a>.</p>



<a name="209841228"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232197%20Account%20for%20duplicated%20if-block%20param.../near/209841228" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232197.20Account.20for.20duplicated.20if-block.20param.2E.2E.2E.html#209841228">(Sep 11 2020 at 22:09)</a>:</h4>
<p>bjorn3 created <a href="https://github.com/bytecodealliance/wasmtime/pull/2197#discussion_r487312344">PR Review Comment</a>:</p>
<blockquote>
<p>Are all those duplicate <code>unreachable</code> necessary to reproduce the bug?</p>
</blockquote>



<a name="209844651"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232197%20Account%20for%20duplicated%20if-block%20param.../near/209844651" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232197.20Account.20for.20duplicated.20if-block.20param.2E.2E.2E.html#209844651">(Sep 11 2020 at 22:54)</a>:</h4>
<p>cfallin updated <a href="https://github.com/bytecodealliance/wasmtime/pull/2197">PR #2197</a> from <code>fix-if-params</code> to <code>main</code>:</p>
<blockquote>
<p>This is a close analogue to @bnjbvr 's fix in commit 518b7a7e. Similar to<br>
that fix, this PR fixes a bug in which the Wasm translator could<br>
misalign its value stack and either mistranslate or cause a panic with a<br>
type-checking error.</p>
<p>Found via fuzzing by :decoder in SpiderMonkey (bug 1664453).</p>
<p>&lt;!--</p>
<p>Please ensure that the following steps are all taken care of before submitting<br>
the PR.</p>
<ul>
<li>
<p>[ ] This has been discussed in issue #..., or if not, please tell us why<br>
  here.</p>
</li>
<li>
<p>[ ] A short description of what this does, why it is needed; if the<br>
  description becomes long, the matter should probably be discussed in an issue<br>
  first.</p>
</li>
<li>
<p>[ ] This PR contains test cases, if meaningful.</p>
</li>
<li>[ ] A reviewer from the core maintainer team has been assigned for this PR.<br>
  If you don't know who could review this, please indicate so. The list of<br>
  suggested reviewers on the right can help you.</li>
</ul>
<p>Please ensure all communication adheres to the <a href="https://github.com/bytecodealliance/wasmtime/blob/master/CODE_OF_CONDUCT.md">code of
conduct</a>.<br>
--&gt;</p>
</blockquote>



<a name="209844752"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232197%20Account%20for%20duplicated%20if-block%20param.../near/209844752" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232197.20Account.20for.20duplicated.20if-block.20param.2E.2E.2E.html#209844752">(Sep 11 2020 at 22:56)</a>:</h4>
<p>cfallin submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/2197#pullrequestreview-487165318">PR Review</a>.</p>



<a name="209844753"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232197%20Account%20for%20duplicated%20if-block%20param.../near/209844753" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232197.20Account.20for.20duplicated.20if-block.20param.2E.2E.2E.html#209844753">(Sep 11 2020 at 22:56)</a>:</h4>
<p>cfallin created <a href="https://github.com/bytecodealliance/wasmtime/pull/2197#discussion_r487324629">PR Review Comment</a>:</p>
<blockquote>
<p>Actually, I can't seem to get it to reproduce with <code>clif-util</code> at all, now that I play with this -- the panic only manifests in the SpiderMonkey embedding (likely due to some subtle difference in the FuncEnvironment, perhaps? The error that occurs is an I32/I64 mismatch so it's not guaranteed to occur...). I've removed the test case, but I can work out a better way to test this if needed.</p>
</blockquote>



<a name="210022732"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232197%20Account%20for%20duplicated%20if-block%20param.../near/210022732" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232197.20Account.20for.20duplicated.20if-block.20param.2E.2E.2E.html#210022732">(Sep 14 2020 at 15:35)</a>:</h4>
<p>fitzgen submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/2197#pullrequestreview-487899761">PR Review</a>.</p>



<a name="210036510"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232197%20Account%20for%20duplicated%20if-block%20param.../near/210036510" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232197.20Account.20for.20duplicated.20if-block.20param.2E.2E.2E.html#210036510">(Sep 14 2020 at 17:22)</a>:</h4>
<p>bnjbvr submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/2197#pullrequestreview-487989216">PR Review</a>.</p>



<a name="210036511"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232197%20Account%20for%20duplicated%20if-block%20param.../near/210036511" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232197.20Account.20for.20duplicated.20if-block.20param.2E.2E.2E.html#210036511">(Sep 14 2020 at 17:22)</a>:</h4>
<p>bnjbvr created <a href="https://github.com/bytecodealliance/wasmtime/pull/2197#discussion_r488100380">PR Review Comment</a>:</p>
<blockquote>
<p>Random drive by, since this is the duplication might have a small code smell: would it make sense to add an helper on the ControlStackFrame struct itself, so we could do <code>frame.truncate_to_original_size(&amp;mut stack)</code>, and hide the details of the number of parameters? Then the <code>original_stack_size</code> helper would be redundant, if I remember correctly...</p>
</blockquote>



<a name="210076873"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232197%20Account%20for%20duplicated%20if-block%20param.../near/210076873" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232197.20Account.20for.20duplicated.20if-block.20param.2E.2E.2E.html#210076873">(Sep 14 2020 at 23:54)</a>:</h4>
<p>cfallin updated <a href="https://github.com/bytecodealliance/wasmtime/pull/2197">PR #2197</a> from <code>fix-if-params</code> to <code>main</code>:</p>
<blockquote>
<p>This is a close analogue to @bnjbvr 's fix in commit 518b7a7e. Similar to<br>
that fix, this PR fixes a bug in which the Wasm translator could<br>
misalign its value stack and either mistranslate or cause a panic with a<br>
type-checking error.</p>
<p>Found via fuzzing by :decoder in SpiderMonkey (bug 1664453).</p>
<p>&lt;!--</p>
<p>Please ensure that the following steps are all taken care of before submitting<br>
the PR.</p>
<ul>
<li>
<p>[ ] This has been discussed in issue #..., or if not, please tell us why<br>
  here.</p>
</li>
<li>
<p>[ ] A short description of what this does, why it is needed; if the<br>
  description becomes long, the matter should probably be discussed in an issue<br>
  first.</p>
</li>
<li>
<p>[ ] This PR contains test cases, if meaningful.</p>
</li>
<li>[ ] A reviewer from the core maintainer team has been assigned for this PR.<br>
  If you don't know who could review this, please indicate so. The list of<br>
  suggested reviewers on the right can help you.</li>
</ul>
<p>Please ensure all communication adheres to the <a href="https://github.com/bytecodealliance/wasmtime/blob/master/CODE_OF_CONDUCT.md">code of
conduct</a>.<br>
--&gt;</p>
</blockquote>



<a name="210076901"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232197%20Account%20for%20duplicated%20if-block%20param.../near/210076901" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232197.20Account.20for.20duplicated.20if-block.20param.2E.2E.2E.html#210076901">(Sep 14 2020 at 23:54)</a>:</h4>
<p>cfallin submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/2197#pullrequestreview-488231013">PR Review</a>.</p>



<a name="210076902"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232197%20Account%20for%20duplicated%20if-block%20param.../near/210076902" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232197.20Account.20for.20duplicated.20if-block.20param.2E.2E.2E.html#210076902">(Sep 14 2020 at 23:54)</a>:</h4>
<p>cfallin created <a href="https://github.com/bytecodealliance/wasmtime/pull/2197#discussion_r488300900">PR Review Comment</a>:</p>
<blockquote>
<p>Good call, thanks! Factored out into a helper.</p>
</blockquote>



<a name="210076937"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232197%20Account%20for%20duplicated%20if-block%20param.../near/210076937" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232197.20Account.20for.20duplicated.20if-block.20param.2E.2E.2E.html#210076937">(Sep 14 2020 at 23:55)</a>:</h4>
<p>cfallin submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/2197#pullrequestreview-488231316">PR Review</a>.</p>



<a name="210076938"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232197%20Account%20for%20duplicated%20if-block%20param.../near/210076938" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232197.20Account.20for.20duplicated.20if-block.20param.2E.2E.2E.html#210076938">(Sep 14 2020 at 23:55)</a>:</h4>
<p>cfallin created <a href="https://github.com/bytecodealliance/wasmtime/pull/2197#discussion_r488301193">PR Review Comment</a>:</p>
<blockquote>
<p>I've updated the PR to include a repro case that I constructed starting from another (<code>if-unreachable-else-params.wat</code>), so this is tested now independently of SpiderMonkey.</p>
</blockquote>



<a name="210079733"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232197%20Account%20for%20duplicated%20if-block%20param.../near/210079733" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232197.20Account.20for.20duplicated.20if-block.20param.2E.2E.2E.html#210079733">(Sep 15 2020 at 00:39)</a>:</h4>
<p>cfallin merged <a href="https://github.com/bytecodealliance/wasmtime/pull/2197">PR #2197</a>.</p>



<a name="210081113"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232197%20Account%20for%20duplicated%20if-block%20param.../near/210081113" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232197.20Account.20for.20duplicated.20if-block.20param.2E.2E.2E.html#210081113">(Sep 15 2020 at 01:04)</a>:</h4>
<p>fitzgen submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/2197#pullrequestreview-488253001">PR Review</a>.</p>



<a name="210081114"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232197%20Account%20for%20duplicated%20if-block%20param.../near/210081114" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232197.20Account.20for.20duplicated.20if-block.20param.2E.2E.2E.html#210081114">(Sep 15 2020 at 01:04)</a>:</h4>
<p>fitzgen created <a href="https://github.com/bytecodealliance/wasmtime/pull/2197#discussion_r488320981">PR Review Comment</a>:</p>
<blockquote>
<p>Good call indeed, much cleaner now!</p>
</blockquote>



<hr><p>Last updated: Jan 20 2025 at 06:04 UTC</p>
</html>