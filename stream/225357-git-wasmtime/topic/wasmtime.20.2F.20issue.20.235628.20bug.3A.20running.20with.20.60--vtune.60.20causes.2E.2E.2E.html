<html>
<head><meta charset="utf-8"><title>wasmtime / issue #5628 bug: running with `--vtune` causes... · git-wasmtime · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/index.html">git-wasmtime</a></h2>
<h3>Topic: <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.235628.20bug.3A.20running.20with.20.60--vtune.60.20causes.2E.2E.2E.html">wasmtime / issue #5628 bug: running with `--vtune` causes...</a></h3>

<hr>

<base href="https://bytecodealliance.zulipchat.com">

<head><link href="https://bytecodealliance.github.io/zulip-archive/style.css" rel="stylesheet"></head>

<a name="323375290"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%235628%20bug%3A%20running%20with%20%60--vtune%60%20causes.../near/323375290" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.235628.20bug.3A.20running.20with.20.60--vtune.60.20causes.2E.2E.2E.html#323375290">(Jan 24 2023 at 23:37)</a>:</h4>
<p>abrown opened <a href="https://github.com/bytecodealliance/wasmtime/issues/5628">issue #5628</a>:</p>
<blockquote>
<h3>Test Case</h3>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="p">(</span><span class="n">module</span><span class="p">)</span><span class="w"></span>
</code></pre></div>
<h3>Steps to Reproduce</h3>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="n">wasmtime</span><span class="w"> </span><span class="o">--</span><span class="n">vtune</span><span class="w"> </span><span class="o">/</span><span class="n">tmp</span><span class="o">/</span><span class="n">empty</span><span class="p">.</span><span class="n">wat</span><span class="w"></span>
</code></pre></div>
<h3>Expected Results</h3>
<p>Adding the <code>--vtune</code> flag, which enables VTune profiling, should succeed regardless of the environment.</p>
<h3>Actual Results</h3>
<p>A snippet of the backtrace:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="n">thread</span><span class="w"> </span><span class="o">'</span><span class="na">main</span><span class="o">'</span><span class="w"> </span><span class="n">panicked</span><span class="w"> </span><span class="n">at</span><span class="w"> </span><span class="o">'</span><span class="na">called</span><span class="w"> </span><span class="err">`</span><span class="nb">Result</span>::<span class="n">unwrap</span><span class="p">()</span><span class="err">`</span><span class="w"> </span><span class="n">on</span><span class="w"> </span><span class="n">an</span><span class="w"> </span><span class="err">`</span><span class="nb">Err</span><span class="err">`</span><span class="w"> </span><span class="n">value</span>: <span class="nc">error</span><span class="w"> </span><span class="n">when</span><span class="w"> </span><span class="n">notifying</span><span class="w"> </span><span class="n">event</span><span class="o">'</span><span class="p">,</span><span class="w"> </span><span class="n">crates</span><span class="o">/</span><span class="n">jit</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">profiling</span><span class="o">/</span><span class="n">vtune</span><span class="p">.</span><span class="n">rs</span>:<span class="mi">60</span>:<span class="mi">14</span><span class="w"></span>
<span class="n">note</span>: <span class="nc">run</span><span class="w"> </span><span class="n">with</span><span class="w"> </span><span class="err">`</span><span class="n">RUST_BACKTRACE</span><span class="o">=</span><span class="mi">1</span><span class="err">`</span><span class="w"> </span><span class="n">environment</span><span class="w"> </span><span class="n">variable</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">display</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="n">backtrace</span><span class="w"></span>
<span class="n">thread</span><span class="w"> </span><span class="o">'</span><span class="na">main</span><span class="o">'</span><span class="w"> </span><span class="n">panicked</span><span class="w"> </span><span class="n">at</span><span class="w"> </span><span class="o">'</span><span class="na">called</span><span class="w"> </span><span class="err">`</span><span class="nb">Result</span>::<span class="n">unwrap</span><span class="p">()</span><span class="err">`</span><span class="w"> </span><span class="n">on</span><span class="w"> </span><span class="n">an</span><span class="w"> </span><span class="err">`</span><span class="nb">Err</span><span class="err">`</span><span class="w"> </span><span class="n">value</span>: <span class="nc">PoisonError</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="o">..</span><span class="w"> </span><span class="p">}</span><span class="o">'</span><span class="p">,</span><span class="w"> </span><span class="n">crates</span><span class="o">/</span><span class="n">jit</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">profiling</span><span class="o">/</span><span class="n">vtune</span><span class="p">.</span><span class="n">rs</span>:<span class="mi">47</span>:<span class="mi">27</span><span class="w"></span>
<span class="o">..</span><span class="p">.</span><span class="w"></span>
<span class="w"> </span><span class="mi">17</span>:     <span class="mh">0x564e6a13571c</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="o">&lt;</span><span class="n">wasmtime_jit</span>::<span class="n">profiling</span>::<span class="n">vtune</span>::<span class="n">VTuneAgent</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">core</span>::<span class="n">ops</span>::<span class="nb">drop</span>::<span class="nb">Drop</span><span class="o">&gt;</span>::<span class="nb">drop</span>::<span class="n">ha421249d00e9da25</span><span class="w"></span>
<span class="w">                               </span><span class="n">at</span><span class="w"> </span><span class="o">/..</span><span class="p">.</span><span class="o">/</span><span class="n">wasmtime</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">crates</span><span class="o">/</span><span class="n">jit</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">profiling</span><span class="o">/</span><span class="n">vtune</span><span class="p">.</span><span class="n">rs</span>:<span class="mi">47</span>:<span class="mi">9</span><span class="w"></span>
<span class="w">  </span><span class="mi">18</span>:     <span class="mh">0x564e6935d677</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">core</span>::<span class="n">ptr</span>::<span class="n">drop_in_place</span><span class="o">&lt;</span><span class="n">wasmtime_jit</span>::<span class="n">profiling</span>::<span class="n">vtune</span>::<span class="n">VTuneAgent</span><span class="o">&gt;</span>::<span class="n">h4021027fefeb76a5</span><span class="w"></span>
<span class="w">                               </span><span class="n">at</span><span class="w"> </span><span class="o">/</span><span class="n">rustc</span><span class="o">/</span><span class="mi">69</span><span class="n">f9c33d71c871fc16ac445211281c6e7a340943</span><span class="o">/</span><span class="n">library</span><span class="o">/</span><span class="n">core</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">ptr</span><span class="o">/</span><span class="k">mod</span><span class="p">.</span><span class="n">rs</span>:<span class="mi">490</span>:<span class="mi">1</span><span class="w"></span>
<span class="w">  </span><span class="mi">19</span>:     <span class="mh">0x564e6935f22d</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">core</span>::<span class="n">ptr</span>::<span class="n">drop_in_place</span><span class="o">&lt;</span><span class="n">alloc</span>::<span class="n">boxed</span>::<span class="nb">Box</span><span class="o">&lt;</span><span class="k">dyn</span><span class="w"> </span><span class="n">wasmtime_jit</span>::<span class="n">profiling</span>::<span class="n">ProfilingAgent</span><span class="o">&gt;&gt;</span>::<span class="n">h3e6586f99c95bc40</span><span class="w"></span>
<span class="w">                               </span><span class="n">at</span><span class="w"> </span><span class="o">/</span><span class="n">rustc</span><span class="o">/</span><span class="mi">69</span><span class="n">f9c33d71c871fc16ac445211281c6e7a340943</span><span class="o">/</span><span class="n">library</span><span class="o">/</span><span class="n">core</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">ptr</span><span class="o">/</span><span class="k">mod</span><span class="p">.</span><span class="n">rs</span>:<span class="mi">490</span>:<span class="mi">1</span><span class="w"></span>
<span class="w">  </span><span class="mi">20</span>:     <span class="mh">0x564e6935c24c</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">core</span>::<span class="n">ptr</span>::<span class="n">drop_in_place</span><span class="o">&lt;</span><span class="n">wasmtime</span>::<span class="n">engine</span>::<span class="n">EngineInner</span><span class="o">&gt;</span>::<span class="n">hb7a0d51da9c6653e</span><span class="w"></span>
<span class="w">                               </span><span class="n">at</span><span class="w"> </span><span class="o">/</span><span class="n">rustc</span><span class="o">/</span><span class="mi">69</span><span class="n">f9c33d71c871fc16ac445211281c6e7a340943</span><span class="o">/</span><span class="n">library</span><span class="o">/</span><span class="n">core</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">ptr</span><span class="o">/</span><span class="k">mod</span><span class="p">.</span><span class="n">rs</span>:<span class="mi">490</span>:<span class="mi">1</span><span class="w"></span>
<span class="w">  </span><span class="mi">21</span>:     <span class="mh">0x564e693b2b64</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">alloc</span>::<span class="n">sync</span>::<span class="n">Arc</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span>::<span class="n">drop_slow</span>::<span class="n">h6c0d38bb7bee604c</span><span class="w"></span>
<span class="w">                               </span><span class="n">at</span><span class="w"> </span><span class="o">/</span><span class="n">rustc</span><span class="o">/</span><span class="mi">69</span><span class="n">f9c33d71c871fc16ac445211281c6e7a340943</span><span class="o">/</span><span class="n">library</span><span class="o">/</span><span class="n">alloc</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">sync</span><span class="p">.</span><span class="n">rs</span>:<span class="mi">1114</span>:<span class="mi">18</span><span class="w"></span>
<span class="w">  </span><span class="mi">22</span>:     <span class="mh">0x564e6935f9fb</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="o">&lt;</span><span class="n">alloc</span>::<span class="n">sync</span>::<span class="n">Arc</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">core</span>::<span class="n">ops</span>::<span class="nb">drop</span>::<span class="nb">Drop</span><span class="o">&gt;</span>::<span class="nb">drop</span>::<span class="n">haeb7e9ee9f329b2a</span><span class="w"></span>
<span class="w">                               </span><span class="n">at</span><span class="w"> </span><span class="o">/</span><span class="n">rustc</span><span class="o">/</span><span class="mi">69</span><span class="n">f9c33d71c871fc16ac445211281c6e7a340943</span><span class="o">/</span><span class="n">library</span><span class="o">/</span><span class="n">alloc</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">sync</span><span class="p">.</span><span class="n">rs</span>:<span class="mi">1711</span>:<span class="mi">13</span><span class="w"></span>
<span class="w">  </span><span class="mi">23</span>:     <span class="mh">0x564e6935e00b</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">core</span>::<span class="n">ptr</span>::<span class="n">drop_in_place</span><span class="o">&lt;</span><span class="n">alloc</span>::<span class="n">sync</span>::<span class="n">Arc</span><span class="o">&lt;</span><span class="n">wasmtime</span>::<span class="n">engine</span>::<span class="n">EngineInner</span><span class="o">&gt;&gt;</span>::<span class="n">h4fab3897c40d1cc6</span><span class="w"></span>
<span class="w">                               </span><span class="n">at</span><span class="w"> </span><span class="o">/</span><span class="n">rustc</span><span class="o">/</span><span class="mi">69</span><span class="n">f9c33d71c871fc16ac445211281c6e7a340943</span><span class="o">/</span><span class="n">library</span><span class="o">/</span><span class="n">core</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">ptr</span><span class="o">/</span><span class="k">mod</span><span class="p">.</span><span class="n">rs</span>:<span class="mi">490</span>:<span class="mi">1</span><span class="w"></span>
<span class="w">  </span><span class="mi">24</span>:     <span class="mh">0x564e6935bb9b</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">core</span>::<span class="n">ptr</span>::<span class="n">drop_in_place</span><span class="o">&lt;</span><span class="n">wasmtime</span>::<span class="n">engine</span>::<span class="n">Engine</span><span class="o">&gt;</span>::<span class="n">h804e987e96a87bb3</span><span class="w"></span>
<span class="w">                               </span><span class="n">at</span><span class="w"> </span><span class="o">/</span><span class="n">rustc</span><span class="o">/</span><span class="mi">69</span><span class="n">f9c33d71c871fc16ac445211281c6e7a340943</span><span class="o">/</span><span class="n">library</span><span class="o">/</span><span class="n">core</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">ptr</span><span class="o">/</span><span class="k">mod</span><span class="p">.</span><span class="n">rs</span>:<span class="mi">490</span>:<span class="mi">1</span><span class="w"></span>
<span class="w">  </span><span class="mi">25</span>:     <span class="mh">0x564e68f55ce4</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">wasmtime_cli</span>::<span class="n">commands</span>::<span class="n">run</span>::<span class="n">RunCommand</span>::<span class="n">execute</span>::<span class="n">h6e097e3761430deb</span><span class="w"></span>
<span class="w">                               </span><span class="n">at</span><span class="w"> </span><span class="o">/..</span><span class="p">.</span><span class="o">/</span><span class="n">wasmtime</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">commands</span><span class="o">/</span><span class="n">run</span><span class="p">.</span><span class="n">rs</span>:<span class="mi">230</span>:<span class="mi">5</span><span class="w"></span>
<span class="w">  </span><span class="mi">26</span>:     <span class="mh">0x564e68dcb405</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">wasmtime</span>::<span class="n">Wasmtime</span>::<span class="n">execute</span>::<span class="n">hc576e9eb67754303</span><span class="w"></span>
<span class="w">                               </span><span class="n">at</span><span class="w"> </span><span class="o">/..</span><span class="p">.</span><span class="o">/</span><span class="n">wasmtime</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">bin</span><span class="o">/</span><span class="n">wasmtime</span><span class="p">.</span><span class="n">rs</span>:<span class="mi">52</span>:<span class="mi">29</span><span class="w"></span>
</code></pre></div>
<h3>Versions and Environment</h3>
<p>Wasmtime version or commit: <code>main</code></p>
<p>Operating system: Fedora</p>
<p>Architecture: x86_64</p>
<h3>Extra Info</h3>
<p>I thought that perhaps the issue was that Wasmtime expected to be run by VTune. When I try the following, things seem to almost work:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="n">rm</span><span class="w"> </span><span class="o">-</span><span class="n">rf</span><span class="w"> </span><span class="o">/</span><span class="n">tmp</span><span class="o">/</span><span class="n">vtune</span><span class="o">-</span><span class="n">results</span><span class="w"></span>
<span class="n">vtune</span><span class="w"> </span><span class="o">-</span><span class="n">collect</span><span class="w"> </span><span class="n">hotspots</span><span class="w"> </span><span class="o">-</span><span class="n">result</span><span class="o">-</span><span class="n">dir</span><span class="w"> </span><span class="o">/</span><span class="n">tmp</span><span class="o">/</span><span class="n">vtune</span><span class="o">-</span><span class="n">results</span><span class="w"> </span><span class="n">target</span><span class="o">/</span><span class="n">debug</span><span class="o">/</span><span class="n">wasmtime</span><span class="w"> </span><span class="o">--</span><span class="n">vtune</span><span class="w"> </span><span class="o">/</span><span class="n">tmp</span><span class="o">/</span><span class="n">empty</span><span class="p">.</span><span class="n">wat</span><span class="w"></span>
</code></pre></div>
<p>I do see a worrying line in the output, though: <code>vtune: Error: Cannot load data file </code>/tmp/vtune-results/data.0/40123-40133.0.trace' (Data file is corrupted).` But I can replicate the original bug when I use a more complex WAT file:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="n">rm</span><span class="w"> </span><span class="o">-</span><span class="n">rf</span><span class="w"> </span><span class="o">/</span><span class="n">tmp</span><span class="o">/</span><span class="n">vtune</span><span class="o">-</span><span class="n">results</span><span class="w"></span>
<span class="n">vtune</span><span class="w"> </span><span class="o">-</span><span class="n">collect</span><span class="w"> </span><span class="n">hotspots</span><span class="w"> </span><span class="o">-</span><span class="n">result</span><span class="o">-</span><span class="n">dir</span><span class="w"> </span><span class="o">/</span><span class="n">tmp</span><span class="o">/</span><span class="n">vtune</span><span class="o">-</span><span class="n">results</span><span class="w"> </span><span class="n">target</span><span class="o">/</span><span class="n">debug</span><span class="o">/</span><span class="n">wasmtime</span><span class="w"> </span><span class="o">--</span><span class="n">vtune</span><span class="w"> </span><span class="o">~/</span><span class="n">Code</span><span class="o">/</span><span class="n">wasmtime</span><span class="o">/</span><span class="n">tests</span><span class="o">/</span><span class="n">all</span><span class="o">/</span><span class="n">cli_tests</span><span class="o">/</span><span class="n">simple</span><span class="p">.</span><span class="n">wat</span><span class="w"></span>
</code></pre></div>
</blockquote>



<a name="323375291"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%235628%20bug%3A%20running%20with%20%60--vtune%60%20causes.../near/323375291" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.235628.20bug.3A.20running.20with.20.60--vtune.60.20causes.2E.2E.2E.html#323375291">(Jan 24 2023 at 23:37)</a>:</h4>
<p>abrown labeled <a href="https://github.com/bytecodealliance/wasmtime/issues/5628">issue #5628</a>:</p>
<blockquote>
<h3>Test Case</h3>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="p">(</span><span class="n">module</span><span class="p">)</span><span class="w"></span>
</code></pre></div>
<h3>Steps to Reproduce</h3>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="n">wasmtime</span><span class="w"> </span><span class="o">--</span><span class="n">vtune</span><span class="w"> </span><span class="o">/</span><span class="n">tmp</span><span class="o">/</span><span class="n">empty</span><span class="p">.</span><span class="n">wat</span><span class="w"></span>
</code></pre></div>
<h3>Expected Results</h3>
<p>Adding the <code>--vtune</code> flag, which enables VTune profiling, should succeed regardless of the environment.</p>
<h3>Actual Results</h3>
<p>A snippet of the backtrace:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="n">thread</span><span class="w"> </span><span class="o">'</span><span class="na">main</span><span class="o">'</span><span class="w"> </span><span class="n">panicked</span><span class="w"> </span><span class="n">at</span><span class="w"> </span><span class="o">'</span><span class="na">called</span><span class="w"> </span><span class="err">`</span><span class="nb">Result</span>::<span class="n">unwrap</span><span class="p">()</span><span class="err">`</span><span class="w"> </span><span class="n">on</span><span class="w"> </span><span class="n">an</span><span class="w"> </span><span class="err">`</span><span class="nb">Err</span><span class="err">`</span><span class="w"> </span><span class="n">value</span>: <span class="nc">error</span><span class="w"> </span><span class="n">when</span><span class="w"> </span><span class="n">notifying</span><span class="w"> </span><span class="n">event</span><span class="o">'</span><span class="p">,</span><span class="w"> </span><span class="n">crates</span><span class="o">/</span><span class="n">jit</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">profiling</span><span class="o">/</span><span class="n">vtune</span><span class="p">.</span><span class="n">rs</span>:<span class="mi">60</span>:<span class="mi">14</span><span class="w"></span>
<span class="n">note</span>: <span class="nc">run</span><span class="w"> </span><span class="n">with</span><span class="w"> </span><span class="err">`</span><span class="n">RUST_BACKTRACE</span><span class="o">=</span><span class="mi">1</span><span class="err">`</span><span class="w"> </span><span class="n">environment</span><span class="w"> </span><span class="n">variable</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">display</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="n">backtrace</span><span class="w"></span>
<span class="n">thread</span><span class="w"> </span><span class="o">'</span><span class="na">main</span><span class="o">'</span><span class="w"> </span><span class="n">panicked</span><span class="w"> </span><span class="n">at</span><span class="w"> </span><span class="o">'</span><span class="na">called</span><span class="w"> </span><span class="err">`</span><span class="nb">Result</span>::<span class="n">unwrap</span><span class="p">()</span><span class="err">`</span><span class="w"> </span><span class="n">on</span><span class="w"> </span><span class="n">an</span><span class="w"> </span><span class="err">`</span><span class="nb">Err</span><span class="err">`</span><span class="w"> </span><span class="n">value</span>: <span class="nc">PoisonError</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="o">..</span><span class="w"> </span><span class="p">}</span><span class="o">'</span><span class="p">,</span><span class="w"> </span><span class="n">crates</span><span class="o">/</span><span class="n">jit</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">profiling</span><span class="o">/</span><span class="n">vtune</span><span class="p">.</span><span class="n">rs</span>:<span class="mi">47</span>:<span class="mi">27</span><span class="w"></span>
<span class="o">..</span><span class="p">.</span><span class="w"></span>
<span class="w"> </span><span class="mi">17</span>:     <span class="mh">0x564e6a13571c</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="o">&lt;</span><span class="n">wasmtime_jit</span>::<span class="n">profiling</span>::<span class="n">vtune</span>::<span class="n">VTuneAgent</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">core</span>::<span class="n">ops</span>::<span class="nb">drop</span>::<span class="nb">Drop</span><span class="o">&gt;</span>::<span class="nb">drop</span>::<span class="n">ha421249d00e9da25</span><span class="w"></span>
<span class="w">                               </span><span class="n">at</span><span class="w"> </span><span class="o">/..</span><span class="p">.</span><span class="o">/</span><span class="n">wasmtime</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">crates</span><span class="o">/</span><span class="n">jit</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">profiling</span><span class="o">/</span><span class="n">vtune</span><span class="p">.</span><span class="n">rs</span>:<span class="mi">47</span>:<span class="mi">9</span><span class="w"></span>
<span class="w">  </span><span class="mi">18</span>:     <span class="mh">0x564e6935d677</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">core</span>::<span class="n">ptr</span>::<span class="n">drop_in_place</span><span class="o">&lt;</span><span class="n">wasmtime_jit</span>::<span class="n">profiling</span>::<span class="n">vtune</span>::<span class="n">VTuneAgent</span><span class="o">&gt;</span>::<span class="n">h4021027fefeb76a5</span><span class="w"></span>
<span class="w">                               </span><span class="n">at</span><span class="w"> </span><span class="o">/</span><span class="n">rustc</span><span class="o">/</span><span class="mi">69</span><span class="n">f9c33d71c871fc16ac445211281c6e7a340943</span><span class="o">/</span><span class="n">library</span><span class="o">/</span><span class="n">core</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">ptr</span><span class="o">/</span><span class="k">mod</span><span class="p">.</span><span class="n">rs</span>:<span class="mi">490</span>:<span class="mi">1</span><span class="w"></span>
<span class="w">  </span><span class="mi">19</span>:     <span class="mh">0x564e6935f22d</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">core</span>::<span class="n">ptr</span>::<span class="n">drop_in_place</span><span class="o">&lt;</span><span class="n">alloc</span>::<span class="n">boxed</span>::<span class="nb">Box</span><span class="o">&lt;</span><span class="k">dyn</span><span class="w"> </span><span class="n">wasmtime_jit</span>::<span class="n">profiling</span>::<span class="n">ProfilingAgent</span><span class="o">&gt;&gt;</span>::<span class="n">h3e6586f99c95bc40</span><span class="w"></span>
<span class="w">                               </span><span class="n">at</span><span class="w"> </span><span class="o">/</span><span class="n">rustc</span><span class="o">/</span><span class="mi">69</span><span class="n">f9c33d71c871fc16ac445211281c6e7a340943</span><span class="o">/</span><span class="n">library</span><span class="o">/</span><span class="n">core</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">ptr</span><span class="o">/</span><span class="k">mod</span><span class="p">.</span><span class="n">rs</span>:<span class="mi">490</span>:<span class="mi">1</span><span class="w"></span>
<span class="w">  </span><span class="mi">20</span>:     <span class="mh">0x564e6935c24c</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">core</span>::<span class="n">ptr</span>::<span class="n">drop_in_place</span><span class="o">&lt;</span><span class="n">wasmtime</span>::<span class="n">engine</span>::<span class="n">EngineInner</span><span class="o">&gt;</span>::<span class="n">hb7a0d51da9c6653e</span><span class="w"></span>
<span class="w">                               </span><span class="n">at</span><span class="w"> </span><span class="o">/</span><span class="n">rustc</span><span class="o">/</span><span class="mi">69</span><span class="n">f9c33d71c871fc16ac445211281c6e7a340943</span><span class="o">/</span><span class="n">library</span><span class="o">/</span><span class="n">core</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">ptr</span><span class="o">/</span><span class="k">mod</span><span class="p">.</span><span class="n">rs</span>:<span class="mi">490</span>:<span class="mi">1</span><span class="w"></span>
<span class="w">  </span><span class="mi">21</span>:     <span class="mh">0x564e693b2b64</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">alloc</span>::<span class="n">sync</span>::<span class="n">Arc</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span>::<span class="n">drop_slow</span>::<span class="n">h6c0d38bb7bee604c</span><span class="w"></span>
<span class="w">                               </span><span class="n">at</span><span class="w"> </span><span class="o">/</span><span class="n">rustc</span><span class="o">/</span><span class="mi">69</span><span class="n">f9c33d71c871fc16ac445211281c6e7a340943</span><span class="o">/</span><span class="n">library</span><span class="o">/</span><span class="n">alloc</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">sync</span><span class="p">.</span><span class="n">rs</span>:<span class="mi">1114</span>:<span class="mi">18</span><span class="w"></span>
<span class="w">  </span><span class="mi">22</span>:     <span class="mh">0x564e6935f9fb</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="o">&lt;</span><span class="n">alloc</span>::<span class="n">sync</span>::<span class="n">Arc</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">core</span>::<span class="n">ops</span>::<span class="nb">drop</span>::<span class="nb">Drop</span><span class="o">&gt;</span>::<span class="nb">drop</span>::<span class="n">haeb7e9ee9f329b2a</span><span class="w"></span>
<span class="w">                               </span><span class="n">at</span><span class="w"> </span><span class="o">/</span><span class="n">rustc</span><span class="o">/</span><span class="mi">69</span><span class="n">f9c33d71c871fc16ac445211281c6e7a340943</span><span class="o">/</span><span class="n">library</span><span class="o">/</span><span class="n">alloc</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">sync</span><span class="p">.</span><span class="n">rs</span>:<span class="mi">1711</span>:<span class="mi">13</span><span class="w"></span>
<span class="w">  </span><span class="mi">23</span>:     <span class="mh">0x564e6935e00b</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">core</span>::<span class="n">ptr</span>::<span class="n">drop_in_place</span><span class="o">&lt;</span><span class="n">alloc</span>::<span class="n">sync</span>::<span class="n">Arc</span><span class="o">&lt;</span><span class="n">wasmtime</span>::<span class="n">engine</span>::<span class="n">EngineInner</span><span class="o">&gt;&gt;</span>::<span class="n">h4fab3897c40d1cc6</span><span class="w"></span>
<span class="w">                               </span><span class="n">at</span><span class="w"> </span><span class="o">/</span><span class="n">rustc</span><span class="o">/</span><span class="mi">69</span><span class="n">f9c33d71c871fc16ac445211281c6e7a340943</span><span class="o">/</span><span class="n">library</span><span class="o">/</span><span class="n">core</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">ptr</span><span class="o">/</span><span class="k">mod</span><span class="p">.</span><span class="n">rs</span>:<span class="mi">490</span>:<span class="mi">1</span><span class="w"></span>
<span class="w">  </span><span class="mi">24</span>:     <span class="mh">0x564e6935bb9b</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">core</span>::<span class="n">ptr</span>::<span class="n">drop_in_place</span><span class="o">&lt;</span><span class="n">wasmtime</span>::<span class="n">engine</span>::<span class="n">Engine</span><span class="o">&gt;</span>::<span class="n">h804e987e96a87bb3</span><span class="w"></span>
<span class="w">                               </span><span class="n">at</span><span class="w"> </span><span class="o">/</span><span class="n">rustc</span><span class="o">/</span><span class="mi">69</span><span class="n">f9c33d71c871fc16ac445211281c6e7a340943</span><span class="o">/</span><span class="n">library</span><span class="o">/</span><span class="n">core</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">ptr</span><span class="o">/</span><span class="k">mod</span><span class="p">.</span><span class="n">rs</span>:<span class="mi">490</span>:<span class="mi">1</span><span class="w"></span>
<span class="w">  </span><span class="mi">25</span>:     <span class="mh">0x564e68f55ce4</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">wasmtime_cli</span>::<span class="n">commands</span>::<span class="n">run</span>::<span class="n">RunCommand</span>::<span class="n">execute</span>::<span class="n">h6e097e3761430deb</span><span class="w"></span>
<span class="w">                               </span><span class="n">at</span><span class="w"> </span><span class="o">/..</span><span class="p">.</span><span class="o">/</span><span class="n">wasmtime</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">commands</span><span class="o">/</span><span class="n">run</span><span class="p">.</span><span class="n">rs</span>:<span class="mi">230</span>:<span class="mi">5</span><span class="w"></span>
<span class="w">  </span><span class="mi">26</span>:     <span class="mh">0x564e68dcb405</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">wasmtime</span>::<span class="n">Wasmtime</span>::<span class="n">execute</span>::<span class="n">hc576e9eb67754303</span><span class="w"></span>
<span class="w">                               </span><span class="n">at</span><span class="w"> </span><span class="o">/..</span><span class="p">.</span><span class="o">/</span><span class="n">wasmtime</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">bin</span><span class="o">/</span><span class="n">wasmtime</span><span class="p">.</span><span class="n">rs</span>:<span class="mi">52</span>:<span class="mi">29</span><span class="w"></span>
</code></pre></div>
<h3>Versions and Environment</h3>
<p>Wasmtime version or commit: <code>main</code></p>
<p>Operating system: Fedora</p>
<p>Architecture: x86_64</p>
<h3>Extra Info</h3>
<p>I thought that perhaps the issue was that Wasmtime expected to be run by VTune. When I try the following, things seem to almost work:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="n">rm</span><span class="w"> </span><span class="o">-</span><span class="n">rf</span><span class="w"> </span><span class="o">/</span><span class="n">tmp</span><span class="o">/</span><span class="n">vtune</span><span class="o">-</span><span class="n">results</span><span class="w"></span>
<span class="n">vtune</span><span class="w"> </span><span class="o">-</span><span class="n">collect</span><span class="w"> </span><span class="n">hotspots</span><span class="w"> </span><span class="o">-</span><span class="n">result</span><span class="o">-</span><span class="n">dir</span><span class="w"> </span><span class="o">/</span><span class="n">tmp</span><span class="o">/</span><span class="n">vtune</span><span class="o">-</span><span class="n">results</span><span class="w"> </span><span class="n">target</span><span class="o">/</span><span class="n">debug</span><span class="o">/</span><span class="n">wasmtime</span><span class="w"> </span><span class="o">--</span><span class="n">vtune</span><span class="w"> </span><span class="o">/</span><span class="n">tmp</span><span class="o">/</span><span class="n">empty</span><span class="p">.</span><span class="n">wat</span><span class="w"></span>
</code></pre></div>
<p>I do see a worrying line in the output, though: <code>vtune: Error: Cannot load data file </code>/tmp/vtune-results/data.0/40123-40133.0.trace' (Data file is corrupted).` But I can replicate the original bug when I use a more complex WAT file:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="n">rm</span><span class="w"> </span><span class="o">-</span><span class="n">rf</span><span class="w"> </span><span class="o">/</span><span class="n">tmp</span><span class="o">/</span><span class="n">vtune</span><span class="o">-</span><span class="n">results</span><span class="w"></span>
<span class="n">vtune</span><span class="w"> </span><span class="o">-</span><span class="n">collect</span><span class="w"> </span><span class="n">hotspots</span><span class="w"> </span><span class="o">-</span><span class="n">result</span><span class="o">-</span><span class="n">dir</span><span class="w"> </span><span class="o">/</span><span class="n">tmp</span><span class="o">/</span><span class="n">vtune</span><span class="o">-</span><span class="n">results</span><span class="w"> </span><span class="n">target</span><span class="o">/</span><span class="n">debug</span><span class="o">/</span><span class="n">wasmtime</span><span class="w"> </span><span class="o">--</span><span class="n">vtune</span><span class="w"> </span><span class="o">~/</span><span class="n">Code</span><span class="o">/</span><span class="n">wasmtime</span><span class="o">/</span><span class="n">tests</span><span class="o">/</span><span class="n">all</span><span class="o">/</span><span class="n">cli_tests</span><span class="o">/</span><span class="n">simple</span><span class="p">.</span><span class="n">wat</span><span class="w"></span>
</code></pre></div>
</blockquote>



<a name="323375369"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%235628%20bug%3A%20running%20with%20%60--vtune%60%20causes.../near/323375369" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.235628.20bug.3A.20running.20with.20.60--vtune.60.20causes.2E.2E.2E.html#323375369">(Jan 24 2023 at 23:38)</a>:</h4>
<p>abrown edited <a href="https://github.com/bytecodealliance/wasmtime/issues/5628">issue #5628</a>:</p>
<blockquote>
<h3>Test Case</h3>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="p">(</span><span class="n">module</span><span class="p">)</span><span class="w"></span>
</code></pre></div>
<h3>Steps to Reproduce</h3>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="n">wasmtime</span><span class="w"> </span><span class="o">--</span><span class="n">vtune</span><span class="w"> </span><span class="o">/</span><span class="n">tmp</span><span class="o">/</span><span class="n">empty</span><span class="p">.</span><span class="n">wat</span><span class="w"></span>
</code></pre></div>
<h3>Expected Results</h3>
<p>Adding the <code>--vtune</code> flag, which enables VTune profiling, should succeed regardless of the environment.</p>
<h3>Actual Results</h3>
<p>A snippet of the backtrace:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="n">thread</span><span class="w"> </span><span class="o">'</span><span class="na">main</span><span class="o">'</span><span class="w"> </span><span class="n">panicked</span><span class="w"> </span><span class="n">at</span><span class="w"> </span><span class="o">'</span><span class="na">called</span><span class="w"> </span><span class="err">`</span><span class="nb">Result</span>::<span class="n">unwrap</span><span class="p">()</span><span class="err">`</span><span class="w"> </span><span class="n">on</span><span class="w"> </span><span class="n">an</span><span class="w"> </span><span class="err">`</span><span class="nb">Err</span><span class="err">`</span><span class="w"> </span><span class="n">value</span>: <span class="nc">error</span><span class="w"> </span><span class="n">when</span><span class="w"> </span><span class="n">notifying</span><span class="w"> </span><span class="n">event</span><span class="o">'</span><span class="p">,</span><span class="w"> </span><span class="n">crates</span><span class="o">/</span><span class="n">jit</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">profiling</span><span class="o">/</span><span class="n">vtune</span><span class="p">.</span><span class="n">rs</span>:<span class="mi">60</span>:<span class="mi">14</span><span class="w"></span>
<span class="n">note</span>: <span class="nc">run</span><span class="w"> </span><span class="n">with</span><span class="w"> </span><span class="err">`</span><span class="n">RUST_BACKTRACE</span><span class="o">=</span><span class="mi">1</span><span class="err">`</span><span class="w"> </span><span class="n">environment</span><span class="w"> </span><span class="n">variable</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">display</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="n">backtrace</span><span class="w"></span>
<span class="n">thread</span><span class="w"> </span><span class="o">'</span><span class="na">main</span><span class="o">'</span><span class="w"> </span><span class="n">panicked</span><span class="w"> </span><span class="n">at</span><span class="w"> </span><span class="o">'</span><span class="na">called</span><span class="w"> </span><span class="err">`</span><span class="nb">Result</span>::<span class="n">unwrap</span><span class="p">()</span><span class="err">`</span><span class="w"> </span><span class="n">on</span><span class="w"> </span><span class="n">an</span><span class="w"> </span><span class="err">`</span><span class="nb">Err</span><span class="err">`</span><span class="w"> </span><span class="n">value</span>: <span class="nc">PoisonError</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="o">..</span><span class="w"> </span><span class="p">}</span><span class="o">'</span><span class="p">,</span><span class="w"> </span><span class="n">crates</span><span class="o">/</span><span class="n">jit</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">profiling</span><span class="o">/</span><span class="n">vtune</span><span class="p">.</span><span class="n">rs</span>:<span class="mi">47</span>:<span class="mi">27</span><span class="w"></span>
<span class="o">..</span><span class="p">.</span><span class="w"></span>
<span class="w"> </span><span class="mi">17</span>:     <span class="mh">0x564e6a13571c</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="o">&lt;</span><span class="n">wasmtime_jit</span>::<span class="n">profiling</span>::<span class="n">vtune</span>::<span class="n">VTuneAgent</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">core</span>::<span class="n">ops</span>::<span class="nb">drop</span>::<span class="nb">Drop</span><span class="o">&gt;</span>::<span class="nb">drop</span>::<span class="n">ha421249d00e9da25</span><span class="w"></span>
<span class="w">                               </span><span class="n">at</span><span class="w"> </span><span class="o">/..</span><span class="p">.</span><span class="o">/</span><span class="n">wasmtime</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">crates</span><span class="o">/</span><span class="n">jit</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">profiling</span><span class="o">/</span><span class="n">vtune</span><span class="p">.</span><span class="n">rs</span>:<span class="mi">47</span>:<span class="mi">9</span><span class="w"></span>
<span class="w">  </span><span class="mi">18</span>:     <span class="mh">0x564e6935d677</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">core</span>::<span class="n">ptr</span>::<span class="n">drop_in_place</span><span class="o">&lt;</span><span class="n">wasmtime_jit</span>::<span class="n">profiling</span>::<span class="n">vtune</span>::<span class="n">VTuneAgent</span><span class="o">&gt;</span>::<span class="n">h4021027fefeb76a5</span><span class="w"></span>
<span class="w">                               </span><span class="n">at</span><span class="w"> </span><span class="o">/</span><span class="n">rustc</span><span class="o">/</span><span class="mi">69</span><span class="n">f9c33d71c871fc16ac445211281c6e7a340943</span><span class="o">/</span><span class="n">library</span><span class="o">/</span><span class="n">core</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">ptr</span><span class="o">/</span><span class="k">mod</span><span class="p">.</span><span class="n">rs</span>:<span class="mi">490</span>:<span class="mi">1</span><span class="w"></span>
<span class="w">  </span><span class="mi">19</span>:     <span class="mh">0x564e6935f22d</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">core</span>::<span class="n">ptr</span>::<span class="n">drop_in_place</span><span class="o">&lt;</span><span class="n">alloc</span>::<span class="n">boxed</span>::<span class="nb">Box</span><span class="o">&lt;</span><span class="k">dyn</span><span class="w"> </span><span class="n">wasmtime_jit</span>::<span class="n">profiling</span>::<span class="n">ProfilingAgent</span><span class="o">&gt;&gt;</span>::<span class="n">h3e6586f99c95bc40</span><span class="w"></span>
<span class="w">                               </span><span class="n">at</span><span class="w"> </span><span class="o">/</span><span class="n">rustc</span><span class="o">/</span><span class="mi">69</span><span class="n">f9c33d71c871fc16ac445211281c6e7a340943</span><span class="o">/</span><span class="n">library</span><span class="o">/</span><span class="n">core</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">ptr</span><span class="o">/</span><span class="k">mod</span><span class="p">.</span><span class="n">rs</span>:<span class="mi">490</span>:<span class="mi">1</span><span class="w"></span>
<span class="w">  </span><span class="mi">20</span>:     <span class="mh">0x564e6935c24c</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">core</span>::<span class="n">ptr</span>::<span class="n">drop_in_place</span><span class="o">&lt;</span><span class="n">wasmtime</span>::<span class="n">engine</span>::<span class="n">EngineInner</span><span class="o">&gt;</span>::<span class="n">hb7a0d51da9c6653e</span><span class="w"></span>
<span class="w">                               </span><span class="n">at</span><span class="w"> </span><span class="o">/</span><span class="n">rustc</span><span class="o">/</span><span class="mi">69</span><span class="n">f9c33d71c871fc16ac445211281c6e7a340943</span><span class="o">/</span><span class="n">library</span><span class="o">/</span><span class="n">core</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">ptr</span><span class="o">/</span><span class="k">mod</span><span class="p">.</span><span class="n">rs</span>:<span class="mi">490</span>:<span class="mi">1</span><span class="w"></span>
<span class="w">  </span><span class="mi">21</span>:     <span class="mh">0x564e693b2b64</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">alloc</span>::<span class="n">sync</span>::<span class="n">Arc</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span>::<span class="n">drop_slow</span>::<span class="n">h6c0d38bb7bee604c</span><span class="w"></span>
<span class="w">                               </span><span class="n">at</span><span class="w"> </span><span class="o">/</span><span class="n">rustc</span><span class="o">/</span><span class="mi">69</span><span class="n">f9c33d71c871fc16ac445211281c6e7a340943</span><span class="o">/</span><span class="n">library</span><span class="o">/</span><span class="n">alloc</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">sync</span><span class="p">.</span><span class="n">rs</span>:<span class="mi">1114</span>:<span class="mi">18</span><span class="w"></span>
<span class="w">  </span><span class="mi">22</span>:     <span class="mh">0x564e6935f9fb</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="o">&lt;</span><span class="n">alloc</span>::<span class="n">sync</span>::<span class="n">Arc</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">core</span>::<span class="n">ops</span>::<span class="nb">drop</span>::<span class="nb">Drop</span><span class="o">&gt;</span>::<span class="nb">drop</span>::<span class="n">haeb7e9ee9f329b2a</span><span class="w"></span>
<span class="w">                               </span><span class="n">at</span><span class="w"> </span><span class="o">/</span><span class="n">rustc</span><span class="o">/</span><span class="mi">69</span><span class="n">f9c33d71c871fc16ac445211281c6e7a340943</span><span class="o">/</span><span class="n">library</span><span class="o">/</span><span class="n">alloc</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">sync</span><span class="p">.</span><span class="n">rs</span>:<span class="mi">1711</span>:<span class="mi">13</span><span class="w"></span>
<span class="w">  </span><span class="mi">23</span>:     <span class="mh">0x564e6935e00b</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">core</span>::<span class="n">ptr</span>::<span class="n">drop_in_place</span><span class="o">&lt;</span><span class="n">alloc</span>::<span class="n">sync</span>::<span class="n">Arc</span><span class="o">&lt;</span><span class="n">wasmtime</span>::<span class="n">engine</span>::<span class="n">EngineInner</span><span class="o">&gt;&gt;</span>::<span class="n">h4fab3897c40d1cc6</span><span class="w"></span>
<span class="w">                               </span><span class="n">at</span><span class="w"> </span><span class="o">/</span><span class="n">rustc</span><span class="o">/</span><span class="mi">69</span><span class="n">f9c33d71c871fc16ac445211281c6e7a340943</span><span class="o">/</span><span class="n">library</span><span class="o">/</span><span class="n">core</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">ptr</span><span class="o">/</span><span class="k">mod</span><span class="p">.</span><span class="n">rs</span>:<span class="mi">490</span>:<span class="mi">1</span><span class="w"></span>
<span class="w">  </span><span class="mi">24</span>:     <span class="mh">0x564e6935bb9b</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">core</span>::<span class="n">ptr</span>::<span class="n">drop_in_place</span><span class="o">&lt;</span><span class="n">wasmtime</span>::<span class="n">engine</span>::<span class="n">Engine</span><span class="o">&gt;</span>::<span class="n">h804e987e96a87bb3</span><span class="w"></span>
<span class="w">                               </span><span class="n">at</span><span class="w"> </span><span class="o">/</span><span class="n">rustc</span><span class="o">/</span><span class="mi">69</span><span class="n">f9c33d71c871fc16ac445211281c6e7a340943</span><span class="o">/</span><span class="n">library</span><span class="o">/</span><span class="n">core</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">ptr</span><span class="o">/</span><span class="k">mod</span><span class="p">.</span><span class="n">rs</span>:<span class="mi">490</span>:<span class="mi">1</span><span class="w"></span>
<span class="w">  </span><span class="mi">25</span>:     <span class="mh">0x564e68f55ce4</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">wasmtime_cli</span>::<span class="n">commands</span>::<span class="n">run</span>::<span class="n">RunCommand</span>::<span class="n">execute</span>::<span class="n">h6e097e3761430deb</span><span class="w"></span>
<span class="w">                               </span><span class="n">at</span><span class="w"> </span><span class="o">/..</span><span class="p">.</span><span class="o">/</span><span class="n">wasmtime</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">commands</span><span class="o">/</span><span class="n">run</span><span class="p">.</span><span class="n">rs</span>:<span class="mi">230</span>:<span class="mi">5</span><span class="w"></span>
<span class="w">  </span><span class="mi">26</span>:     <span class="mh">0x564e68dcb405</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">wasmtime</span>::<span class="n">Wasmtime</span>::<span class="n">execute</span>::<span class="n">hc576e9eb67754303</span><span class="w"></span>
<span class="w">                               </span><span class="n">at</span><span class="w"> </span><span class="o">/..</span><span class="p">.</span><span class="o">/</span><span class="n">wasmtime</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">bin</span><span class="o">/</span><span class="n">wasmtime</span><span class="p">.</span><span class="n">rs</span>:<span class="mi">52</span>:<span class="mi">29</span><span class="w"></span>
</code></pre></div>
<h3>Versions and Environment</h3>
<p>Wasmtime version or commit: <code>main</code></p>
<p>Operating system: Fedora</p>
<p>Architecture: x86_64</p>
<h3>Extra Info</h3>
<p>I thought that perhaps the issue was that Wasmtime expected to be run by VTune. When I try the following, things seem to almost work:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="n">rm</span><span class="w"> </span><span class="o">-</span><span class="n">rf</span><span class="w"> </span><span class="o">/</span><span class="n">tmp</span><span class="o">/</span><span class="n">vtune</span><span class="o">-</span><span class="n">results</span><span class="w"></span>
<span class="n">vtune</span><span class="w"> </span><span class="o">-</span><span class="n">collect</span><span class="w"> </span><span class="n">hotspots</span><span class="w"> </span><span class="o">-</span><span class="n">result</span><span class="o">-</span><span class="n">dir</span><span class="w"> </span><span class="o">/</span><span class="n">tmp</span><span class="o">/</span><span class="n">vtune</span><span class="o">-</span><span class="n">results</span><span class="w"> </span><span class="n">target</span><span class="o">/</span><span class="n">debug</span><span class="o">/</span><span class="n">wasmtime</span><span class="w"> </span><span class="o">--</span><span class="n">vtune</span><span class="w"> </span><span class="o">/</span><span class="n">tmp</span><span class="o">/</span><span class="n">empty</span><span class="p">.</span><span class="n">wat</span><span class="w"></span>
</code></pre></div>
<p>I do see a worrying line in the output, though: "vtune: Error: Cannot load data file `/tmp/vtune-results/data.0/40123-40133.0.trace' (Data file is corrupted)." But I can replicate the original bug when I use a more complex WAT file:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="n">rm</span><span class="w"> </span><span class="o">-</span><span class="n">rf</span><span class="w"> </span><span class="o">/</span><span class="n">tmp</span><span class="o">/</span><span class="n">vtune</span><span class="o">-</span><span class="n">results</span><span class="w"></span>
<span class="n">vtune</span><span class="w"> </span><span class="o">-</span><span class="n">collect</span><span class="w"> </span><span class="n">hotspots</span><span class="w"> </span><span class="o">-</span><span class="n">result</span><span class="o">-</span><span class="n">dir</span><span class="w"> </span><span class="o">/</span><span class="n">tmp</span><span class="o">/</span><span class="n">vtune</span><span class="o">-</span><span class="n">results</span><span class="w"> </span><span class="n">target</span><span class="o">/</span><span class="n">debug</span><span class="o">/</span><span class="n">wasmtime</span><span class="w"> </span><span class="o">--</span><span class="n">vtune</span><span class="w"> </span><span class="o">~/</span><span class="n">Code</span><span class="o">/</span><span class="n">wasmtime</span><span class="o">/</span><span class="n">tests</span><span class="o">/</span><span class="n">all</span><span class="o">/</span><span class="n">cli_tests</span><span class="o">/</span><span class="n">simple</span><span class="p">.</span><span class="n">wat</span><span class="w"></span>
</code></pre></div>
</blockquote>



<a name="323375381"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%235628%20bug%3A%20running%20with%20%60--vtune%60%20causes.../near/323375381" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.235628.20bug.3A.20running.20with.20.60--vtune.60.20causes.2E.2E.2E.html#323375381">(Jan 24 2023 at 23:38)</a>:</h4>
<p>abrown <a href="https://github.com/bytecodealliance/wasmtime/issues/5628#issuecomment-1402832222">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/5628">issue #5628</a>:</p>
<blockquote>
<p>cc: @jlb6740, @bnjbvr </p>
</blockquote>



<a name="323470327"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%235628%20bug%3A%20running%20with%20%60--vtune%60%20causes.../near/323470327" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.235628.20bug.3A.20running.20with.20.60--vtune.60.20causes.2E.2E.2E.html#323470327">(Jan 25 2023 at 12:17)</a>:</h4>
<p>bnjbvr <a href="https://github.com/bytecodealliance/wasmtime/issues/5628#issuecomment-1403521276">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/5628">issue #5628</a>:</p>
<blockquote>
<p>Thanks! I've just ran into that in our embedding too; will investigate quickly to find if there's anything obvious there.</p>
</blockquote>



<a name="323508688"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%235628%20bug%3A%20running%20with%20%60--vtune%60%20causes.../near/323508688" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.235628.20bug.3A.20running.20with.20.60--vtune.60.20causes.2E.2E.2E.html#323508688">(Jan 25 2023 at 15:06)</a>:</h4>
<p>bnjbvr <a href="https://github.com/bytecodealliance/wasmtime/issues/5628#issuecomment-1403762927">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/5628">issue #5628</a>:</p>
<blockquote>
<p>@abrown so at the end of this short investigation:</p>
<ul>
<li>I couldn't run under vtune, as running vtune on my OS fails with a cryptic library loading error (probably the package is borked).</li>
<li>From scanning the issue in our embedding, it seems that running outside vtune fails when <code>notify_event</code> is called for new methods. That being said, I've just noticed the documentation of this method for <code>...METHOD_LOAD_FINISHED</code> says that <a href="https://www.intel.com/content/www/us/en/develop/documentation/vtune-help/top/api-support/jit-profiling-api/jit-profiling-api-reference/ijit-notifyevent.html#ijit-notifyevent_IJIT_METHOD_LOAD">the return value is undefined</a> for this particular event type, while the high-level ittapi crate will check it's 1 to decide it's been successful, independently of the event. I've opened <a href="https://github.com/intel/ittapi/pull/82">https://github.com/intel/ittapi/pull/82</a> to fix that.</li>
</ul>
<p>I can see that the shutdown results in a error, when trying with your test case; that being said, it only output to log, in my case, and doesn't crash. So I'm wondering if we're running into different issues, or if some of them are OS-specific ("I'm running ArchLinux, btw").</p>
</blockquote>



<a name="323596678"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%235628%20bug%3A%20running%20with%20%60--vtune%60%20causes.../near/323596678" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.235628.20bug.3A.20running.20with.20.60--vtune.60.20causes.2E.2E.2E.html#323596678">(Jan 25 2023 at 22:26)</a>:</h4>
<p>abrown <a href="https://github.com/bytecodealliance/wasmtime/issues/5628#issuecomment-1404309283">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/5628">issue #5628</a>:</p>
<blockquote>
<p>Made some comments over in <a href="https://github.com/intel/ittapi/pull/82">https://github.com/intel/ittapi/pull/82</a>.</p>
</blockquote>



<hr><p>Last updated: Jan 20 2025 at 06:04 UTC</p>
</html>