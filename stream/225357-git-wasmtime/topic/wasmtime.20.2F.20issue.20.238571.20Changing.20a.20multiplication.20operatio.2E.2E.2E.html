<html>
<head><meta charset="utf-8"><title>wasmtime / issue #8571 Changing a multiplication operatio... · git-wasmtime · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/index.html">git-wasmtime</a></h2>
<h3>Topic: <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.238571.20Changing.20a.20multiplication.20operatio.2E.2E.2E.html">wasmtime / issue #8571 Changing a multiplication operatio...</a></h3>

<hr>

<base href="https://bytecodealliance.zulipchat.com">

<head><link href="https://bytecodealliance.github.io/zulip-archive/style.css" rel="stylesheet"></head>

<a name="437455608"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%238571%20Changing%20a%20multiplication%20operatio.../near/437455608" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.238571.20Changing.20a.20multiplication.20operatio.2E.2E.2E.html#437455608">(May 07 2024 at 13:37)</a>:</h4>
<p><a href="https://github.com/hungryzzz">hungryzzz</a> added the bug label to <a href="https://github.com/bytecodealliance/wasmtime/issues/8571">Issue #8571</a>.</p>



<a name="437455612"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%238571%20Changing%20a%20multiplication%20operatio.../near/437455612" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.238571.20Changing.20a.20multiplication.20operatio.2E.2E.2E.html#437455612">(May 07 2024 at 13:37)</a>:</h4>
<p>hungryzzz opened <a href="https://github.com/bytecodealliance/wasmtime/issues/8571">issue #8571</a>:</p>
<blockquote>
<h3>Test Case</h3>
<p><a href="https://github.com/bytecodealliance/wasmtime/files/15236026/cases.zip">cases.zip</a></p>
<h3>Steps to Reproduce</h3>
<p>I run the attached two cases(<code>good.wasm</code>&amp;<code>bad.wasm</code>) in <code>Wasmtime</code> and <code>WasmEdge</code>, and collect their execution time respectively.</p>
<h3>Expected Results &amp; Actual Results</h3>
<p>Actually the only difference between the attached two cases is as follow, i.e., a multiplication operation to a division one, but the execution time of <code>Wasmtime</code> increases by more than 5 times, while the same for <code>Wasmedge</code> and <code>Wasmer</code>.</p>
<p>![截屏2024-05-07 21 18 58](<a href="https://github.com/bytecodealliance/wasmtime/assets/32137313/a5c51594-b60f-466e-8517-48977fed9da3">https://github.com/bytecodealliance/wasmtime/assets/32137313/a5c51594-b60f-466e-8517-48977fed9da3</a>)</p>
<p>For <code>good.wasm</code>, the execution time in different runtimes are as follows:<br>
&lt;img width="1214" alt="截屏2024-05-07 21 32 15" src="<a href="https://github.com/bytecodealliance/wasmtime/assets/32137313/41a41f7d-72ab-4233-81eb-2600a6cb021f">https://github.com/bytecodealliance/wasmtime/assets/32137313/41a41f7d-72ab-4233-81eb-2600a6cb021f</a>"&gt;</p>
<p>For <code>bad.wasm</code>, the execution time in different runtimes are as follows:<br>
&lt;img width="1191" alt="截屏2024-05-07 21 33 33" src="<a href="https://github.com/bytecodealliance/wasmtime/assets/32137313/2f281b67-4568-40d9-adba-240d069b6fdf">https://github.com/bytecodealliance/wasmtime/assets/32137313/2f281b67-4568-40d9-adba-240d069b6fdf</a>"&gt;</p>
<h3>Versions and Environment</h3>
<p>Wasmtime version or commit: d0cf46a098d97bab9c4cf54a2f3aeaddea7d3831</p>
<p>Operating system: Linux ringzzz-OptiPlex-7070 5.15.0-97-generic</p>
<p>Architecture: Intel(R) Core(TM) i5-9500T CPU @ 2.20GHz</p>
</blockquote>



<a name="437455660"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%238571%20Changing%20a%20multiplication%20operatio.../near/437455660" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.238571.20Changing.20a.20multiplication.20operatio.2E.2E.2E.html#437455660">(May 07 2024 at 13:37)</a>:</h4>
<p>hungryzzz edited <a href="https://github.com/bytecodealliance/wasmtime/issues/8571">issue #8571</a>:</p>
<blockquote>
<h3>Test Case</h3>
<p><a href="https://github.com/bytecodealliance/wasmtime/files/15236026/cases.zip">cases.zip</a></p>
<h3>Steps to Reproduce</h3>
<p>Hi, I run the attached two cases(<code>good.wasm</code>&amp;<code>bad.wasm</code>) in <code>Wasmtime</code> and <code>WasmEdge</code>, and collect their execution time respectively.</p>
<h3>Expected Results &amp; Actual Results</h3>
<p>Actually the only difference between the attached two cases is as follow, i.e., a multiplication operation to a division one, but the execution time of <code>Wasmtime</code> increases by more than 5 times, while the same for <code>Wasmedge</code> and <code>Wasmer</code>.</p>
<p>![截屏2024-05-07 21 18 58](<a href="https://github.com/bytecodealliance/wasmtime/assets/32137313/a5c51594-b60f-466e-8517-48977fed9da3">https://github.com/bytecodealliance/wasmtime/assets/32137313/a5c51594-b60f-466e-8517-48977fed9da3</a>)</p>
<p>For <code>good.wasm</code>, the execution time in different runtimes are as follows:<br>
&lt;img width="1214" alt="截屏2024-05-07 21 32 15" src="<a href="https://github.com/bytecodealliance/wasmtime/assets/32137313/41a41f7d-72ab-4233-81eb-2600a6cb021f">https://github.com/bytecodealliance/wasmtime/assets/32137313/41a41f7d-72ab-4233-81eb-2600a6cb021f</a>"&gt;</p>
<p>For <code>bad.wasm</code>, the execution time in different runtimes are as follows:<br>
&lt;img width="1191" alt="截屏2024-05-07 21 33 33" src="<a href="https://github.com/bytecodealliance/wasmtime/assets/32137313/2f281b67-4568-40d9-adba-240d069b6fdf">https://github.com/bytecodealliance/wasmtime/assets/32137313/2f281b67-4568-40d9-adba-240d069b6fdf</a>"&gt;</p>
<h3>Versions and Environment</h3>
<p>Wasmtime version or commit: d0cf46a098d97bab9c4cf54a2f3aeaddea7d3831</p>
<p>Operating system: Linux ringzzz-OptiPlex-7070 5.15.0-97-generic</p>
<p>Architecture: Intel(R) Core(TM) i5-9500T CPU @ 2.20GHz</p>
</blockquote>



<a name="437456197"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%238571%20Changing%20a%20multiplication%20operatio.../near/437456197" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.238571.20Changing.20a.20multiplication.20operatio.2E.2E.2E.html#437456197">(May 07 2024 at 13:40)</a>:</h4>
<p>hungryzzz edited <a href="https://github.com/bytecodealliance/wasmtime/issues/8571">issue #8571</a>:</p>
<blockquote>
<h3>Test Case</h3>
<p><a href="https://github.com/bytecodealliance/wasmtime/files/15236026/cases.zip">cases.zip</a></p>
<h3>Steps to Reproduce</h3>
<p>Hi, I run the attached two cases(<code>good.wasm</code>&amp;<code>bad.wasm</code>) in <code>Wasmtime</code> and <code>WasmEdge</code>, and collect their execution time respectively.</p>
<h3>Expected Results &amp; Actual Results</h3>
<p>Actually the only difference between the attached two cases is as follow, i.e., a multiplication operation to a division one, but the execution time of <code>Wasmtime</code> increases by more than 5 times, while the execution time before and after the modification is nearly the same for <code>Wasmedge</code> and <code>Wasmer</code>.</p>
<p>![截屏2024-05-07 21 18 58](<a href="https://github.com/bytecodealliance/wasmtime/assets/32137313/a5c51594-b60f-466e-8517-48977fed9da3">https://github.com/bytecodealliance/wasmtime/assets/32137313/a5c51594-b60f-466e-8517-48977fed9da3</a>)</p>
<p>For <code>good.wasm</code>, the execution time in different runtimes are as follows:<br>
&lt;img width="1214" alt="截屏2024-05-07 21 32 15" src="<a href="https://github.com/bytecodealliance/wasmtime/assets/32137313/41a41f7d-72ab-4233-81eb-2600a6cb021f">https://github.com/bytecodealliance/wasmtime/assets/32137313/41a41f7d-72ab-4233-81eb-2600a6cb021f</a>"&gt;</p>
<p>For <code>bad.wasm</code>, the execution time in different runtimes are as follows:<br>
&lt;img width="1191" alt="截屏2024-05-07 21 33 33" src="<a href="https://github.com/bytecodealliance/wasmtime/assets/32137313/2f281b67-4568-40d9-adba-240d069b6fdf">https://github.com/bytecodealliance/wasmtime/assets/32137313/2f281b67-4568-40d9-adba-240d069b6fdf</a>"&gt;</p>
<h3>Versions and Environment</h3>
<p>Wasmtime version or commit: d0cf46a098d97bab9c4cf54a2f3aeaddea7d3831</p>
<p>Operating system: Linux ringzzz-OptiPlex-7070 5.15.0-97-generic</p>
<p>Architecture: Intel(R) Core(TM) i5-9500T CPU @ 2.20GHz</p>
</blockquote>



<a name="437456290"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%238571%20Changing%20a%20multiplication%20operatio.../near/437456290" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.238571.20Changing.20a.20multiplication.20operatio.2E.2E.2E.html#437456290">(May 07 2024 at 13:40)</a>:</h4>
<p>hungryzzz edited <a href="https://github.com/bytecodealliance/wasmtime/issues/8571">issue #8571</a>:</p>
<blockquote>
<h3>Test Case</h3>
<p><a href="https://github.com/bytecodealliance/wasmtime/files/15236026/cases.zip">cases.zip</a></p>
<h3>Steps to Reproduce</h3>
<p>Hi, I run the attached two cases(<code>good.wasm</code>&amp;<code>bad.wasm</code>) in <code>Wasmtime</code> and <code>WasmEdge</code>, and collect their execution time respectively.</p>
<h3>Expected Results &amp; Actual Results</h3>
<p>Actually the only difference between the attached two cases is as follow, i.e., a multiplication operation to a division one, but the execution time of <code>Wasmtime</code> increases by more than 5 times, while the execution time before and after the modification is nearly the same in <code>Wasmedge</code> and <code>Wasmer</code>.</p>
<p>![截屏2024-05-07 21 18 58](<a href="https://github.com/bytecodealliance/wasmtime/assets/32137313/a5c51594-b60f-466e-8517-48977fed9da3">https://github.com/bytecodealliance/wasmtime/assets/32137313/a5c51594-b60f-466e-8517-48977fed9da3</a>)</p>
<p>For <code>good.wasm</code>, the execution time in different runtimes are as follows:<br>
&lt;img width="1214" alt="截屏2024-05-07 21 32 15" src="<a href="https://github.com/bytecodealliance/wasmtime/assets/32137313/41a41f7d-72ab-4233-81eb-2600a6cb021f">https://github.com/bytecodealliance/wasmtime/assets/32137313/41a41f7d-72ab-4233-81eb-2600a6cb021f</a>"&gt;</p>
<p>For <code>bad.wasm</code>, the execution time in different runtimes are as follows:<br>
&lt;img width="1191" alt="截屏2024-05-07 21 33 33" src="<a href="https://github.com/bytecodealliance/wasmtime/assets/32137313/2f281b67-4568-40d9-adba-240d069b6fdf">https://github.com/bytecodealliance/wasmtime/assets/32137313/2f281b67-4568-40d9-adba-240d069b6fdf</a>"&gt;</p>
<h3>Versions and Environment</h3>
<p>Wasmtime version or commit: d0cf46a098d97bab9c4cf54a2f3aeaddea7d3831</p>
<p>Operating system: Linux ringzzz-OptiPlex-7070 5.15.0-97-generic</p>
<p>Architecture: Intel(R) Core(TM) i5-9500T CPU @ 2.20GHz</p>
</blockquote>



<a name="437460312"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%238571%20Changing%20a%20multiplication%20operatio.../near/437460312" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.238571.20Changing.20a.20multiplication.20operatio.2E.2E.2E.html#437460312">(May 07 2024 at 13:58)</a>:</h4>
<p>bjorn3 <a href="https://github.com/bytecodealliance/wasmtime/issues/8571#issuecomment-2098477868">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/8571">issue #8571</a>:</p>
<blockquote>
<p>Division is a lot more expensive than multiplication on pretty much every cpu. It may be that the other wasm engines are optimizing it away, or schedule the instructions slightly differently in a way that masks most of the latency on modern super scalar cpu's.</p>
</blockquote>



<a name="437466994"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%238571%20Changing%20a%20multiplication%20operatio.../near/437466994" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.238571.20Changing.20a.20multiplication.20operatio.2E.2E.2E.html#437466994">(May 07 2024 at 14:31)</a>:</h4>
<p>hungryzzz <a href="https://github.com/bytecodealliance/wasmtime/issues/8571#issuecomment-2098550298">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/8571">issue #8571</a>:</p>
<blockquote>
<p>Yes, you're right, but the default backend of <code>Wasmer</code> is also <code>Cranelift</code>,  the execution time before and after the modification in <code>Wasmer</code> is nearly the same. So I am wondering if it is possible that the subsequent commits introduce some bugs.</p>
<p>&lt;img width="1366" alt="截屏2024-05-07 22 27 01" src="<a href="https://github.com/bytecodealliance/wasmtime/assets/32137313/650171d3-f6db-4e60-9ad1-0a0811c4d026">https://github.com/bytecodealliance/wasmtime/assets/32137313/650171d3-f6db-4e60-9ad1-0a0811c4d026</a>"&gt;</p>
</blockquote>



<a name="437485148"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%238571%20Changing%20a%20multiplication%20operatio.../near/437485148" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.238571.20Changing.20a.20multiplication.20operatio.2E.2E.2E.html#437485148">(May 07 2024 at 16:06)</a>:</h4>
<p>cfallin closed <a href="https://github.com/bytecodealliance/wasmtime/issues/8571">issue #8571</a>:</p>
<blockquote>
<h3>Test Case</h3>
<p><a href="https://github.com/bytecodealliance/wasmtime/files/15236026/cases.zip">cases.zip</a></p>
<h3>Steps to Reproduce</h3>
<p>Hi, I run the attached two cases(<code>good.wasm</code>&amp;<code>bad.wasm</code>) in <code>Wasmtime</code> and <code>WasmEdge</code>, and collect their execution time respectively.</p>
<h3>Expected Results &amp; Actual Results</h3>
<p>Actually the only difference between the attached two cases is as follow, i.e., a multiplication operation to a division one, but the execution time of <code>Wasmtime</code> increases by more than 5 times, while the execution time before and after the modification is nearly the same in <code>Wasmedge</code> and <code>Wasmer</code>.</p>
<p>![截屏2024-05-07 21 18 58](<a href="https://github.com/bytecodealliance/wasmtime/assets/32137313/a5c51594-b60f-466e-8517-48977fed9da3">https://github.com/bytecodealliance/wasmtime/assets/32137313/a5c51594-b60f-466e-8517-48977fed9da3</a>)</p>
<p>For <code>good.wasm</code>, the execution time in different runtimes are as follows:<br>
&lt;img width="1214" alt="截屏2024-05-07 21 32 15" src="<a href="https://github.com/bytecodealliance/wasmtime/assets/32137313/41a41f7d-72ab-4233-81eb-2600a6cb021f">https://github.com/bytecodealliance/wasmtime/assets/32137313/41a41f7d-72ab-4233-81eb-2600a6cb021f</a>"&gt;</p>
<p>For <code>bad.wasm</code>, the execution time in different runtimes are as follows:<br>
&lt;img width="1191" alt="截屏2024-05-07 21 33 33" src="<a href="https://github.com/bytecodealliance/wasmtime/assets/32137313/2f281b67-4568-40d9-adba-240d069b6fdf">https://github.com/bytecodealliance/wasmtime/assets/32137313/2f281b67-4568-40d9-adba-240d069b6fdf</a>"&gt;</p>
<h3>Versions and Environment</h3>
<p>Wasmtime version or commit: d0cf46a098d97bab9c4cf54a2f3aeaddea7d3831</p>
<p>Operating system: Linux ringzzz-OptiPlex-7070 5.15.0-97-generic</p>
<p>Architecture: Intel(R) Core(TM) i5-9500T CPU @ 2.20GHz</p>
</blockquote>



<a name="437485149"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%238571%20Changing%20a%20multiplication%20operatio.../near/437485149" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.238571.20Changing.20a.20multiplication.20operatio.2E.2E.2E.html#437485149">(May 07 2024 at 16:06)</a>:</h4>
<p>cfallin <a href="https://github.com/bytecodealliance/wasmtime/issues/8571#issuecomment-2098813503">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/8571">issue #8571</a>:</p>
<blockquote>
<p>@hungryzzz our current version of the mid-end optimizer can't yet rewrite divs by constants into multiplies by magic constants; we have #6049 for this. I'm going to go ahead and close this issue in favor of that as it's a duplicate report.</p>
</blockquote>



<a name="437590416"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%238571%20Changing%20a%20multiplication%20operatio.../near/437590416" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.238571.20Changing.20a.20multiplication.20operatio.2E.2E.2E.html#437590416">(May 08 2024 at 07:04)</a>:</h4>
<p>hungryzzz edited <a href="https://github.com/bytecodealliance/wasmtime/issues/8571">issue #8571</a>:</p>
<blockquote>
<h3>Test Case</h3>
<p><a href="https://github.com/bytecodealliance/wasmtime/files/15236026/cases.zip">cases.zip</a></p>
<h3>Steps to Reproduce</h3>
<p>Hi, I run the attached two cases(<code>good.wasm</code>&amp;<code>bad.wasm</code>) in <code>Wasmtime</code> and <code>WasmEdge</code>, and collect their execution time respectively.</p>
<h3>Expected Results &amp; Actual Results</h3>
<p>Actually the only difference between the attached two cases is as follow, i.e., a multiplication operation to a division one, but the execution time of <code>Wasmtime</code> increases by more than 5 times, while the execution time before and after the modification is nearly the same in <code>Wasmedge</code> and <code>Wasmer</code>.</p>
<p>![截屏2024-05-07 21 18 58](<a href="https://github.com/bytecodealliance/wasmtime/assets/32137313/a5c51594-b60f-466e-8517-48977fed9da3">https://github.com/bytecodealliance/wasmtime/assets/32137313/a5c51594-b60f-466e-8517-48977fed9da3</a>)</p>
<p>For <code>good.wasm</code>, the execution time in different runtimes are as follows:</p>
<div class="codehilite" data-code-language="Bash"><pre><span></span><code>/home/ringzzz/wasm_runtime/wasmer/target/release/wasmer<span class="w"> </span><span class="nv">$filename</span>.wasm<span class="w">  </span><span class="m">1</span>.76s<span class="w"> </span>user<span class="w"> </span><span class="m">0</span>.01s<span class="w"> </span>system<span class="w"> </span><span class="m">100</span>%<span class="w"> </span>cpu<span class="w"> </span><span class="m">1</span>.766<span class="w"> </span>total
/home/ringzzz/wasm_runtime/WasmEdge/build/tools/wasmedge/wasmedge<span class="w">   </span><span class="m">1</span>.18s<span class="w"> </span>user<span class="w"> </span><span class="m">0</span>.00s<span class="w"> </span>system<span class="w"> </span><span class="m">99</span>%<span class="w"> </span>cpu<span class="w"> </span><span class="m">1</span>.179<span class="w"> </span>total
/home/ringzzz/wasm_runtime/wasmtime/target/release/wasmtime<span class="w"> </span>run<span class="w">    </span><span class="m">0</span>.74s<span class="w"> </span>user<span class="w"> </span><span class="m">0</span>.00s<span class="w"> </span>system<span class="w"> </span><span class="m">100</span>%<span class="w"> </span>cpu<span class="w"> </span><span class="m">0</span>.741<span class="w"> </span>total
</code></pre></div>
<p>For <code>bad.wasm</code>, the execution time in different runtimes are as follows:</p>
<div class="codehilite" data-code-language="Bash"><pre><span></span><code>/home/ringzzz/wasm_runtime/wasmer/target/release/wasmer<span class="w"> </span><span class="nv">$filename</span>.wasm<span class="w">  </span><span class="m">1</span>.77s<span class="w"> </span>user<span class="w"> </span><span class="m">0</span>.00s<span class="w"> </span>system<span class="w"> </span><span class="m">100</span>%<span class="w"> </span>cpu<span class="w"> </span><span class="m">1</span>.765<span class="w"> </span>total
/home/ringzzz/wasm_runtime/WasmEdge/build/tools/wasmedge/wasmedge<span class="w">   </span><span class="m">1</span>.18s<span class="w"> </span>user<span class="w"> </span><span class="m">0</span>.00s<span class="w"> </span>system<span class="w"> </span><span class="m">99</span>%<span class="w"> </span>cpu<span class="w"> </span><span class="m">1</span>.181<span class="w"> </span>total
/home/ringzzz/wasm_runtime/wasmtime/target/release/wasmtime<span class="w"> </span>run<span class="w">    </span><span class="m">4</span>.68s<span class="w"> </span>user<span class="w"> </span><span class="m">0</span>.00s<span class="w"> </span>system<span class="w"> </span><span class="m">100</span>%<span class="w"> </span>cpu<span class="w"> </span><span class="m">4</span>.680<span class="w"> </span>total
</code></pre></div>
<h3>Versions and Environment</h3>
<p>Wasmtime version or commit: d0cf46a098d97bab9c4cf54a2f3aeaddea7d3831</p>
<p>Operating system: Linux ringzzz-OptiPlex-7070 5.15.0-97-generic</p>
<p>Architecture: Intel(R) Core(TM) i5-9500T CPU @ 2.20GHz</p>
</blockquote>



<a name="437590553"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%238571%20Changing%20a%20multiplication%20operatio.../near/437590553" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.238571.20Changing.20a.20multiplication.20operatio.2E.2E.2E.html#437590553">(May 08 2024 at 07:05)</a>:</h4>
<p>hungryzzz edited a <a href="https://github.com/bytecodealliance/wasmtime/issues/8571#issuecomment-2098550298">comment</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/8571">issue #8571</a>:</p>
<blockquote>
<p>Yes, you're right, but the default backend of <code>Wasmer</code> is also <code>Cranelift</code>,  the execution time before and after the modification in <code>Wasmer</code> is nearly the same. So I am wondering if it is possible that the subsequent commits introduce some bugs.</p>
<div class="codehilite" data-code-language="Bash"><pre><span></span><code>➜<span class="w">  </span><span class="k">case</span><span class="w"> </span>✗<span class="w"> </span><span class="nb">time</span><span class="w"> </span>wasmer<span class="w"> </span>run<span class="w"> </span>--cranelift<span class="w"> </span>good.wasm
~/wasmer/target/release/wasmer<span class="w"> </span>run<span class="w"> </span>--cranelift<span class="w">   </span><span class="m">1</span>.76s<span class="w"> </span>user<span class="w"> </span><span class="m">0</span>.00s<span class="w"> </span>system<span class="w"> </span><span class="m">100</span>%<span class="w"> </span>cpu<span class="w"> </span><span class="m">1</span>.758<span class="w"> </span>total
➜<span class="w">  </span><span class="k">case</span>✗<span class="w"> </span><span class="nb">time</span><span class="w"> </span>wasmer<span class="w"> </span>run<span class="w"> </span>--cranelift<span class="w"> </span>bad.wasm
~/wasmer/target/release/wasmer<span class="w"> </span>run<span class="w"> </span>--cranelift<span class="w">   </span><span class="m">1</span>.75s<span class="w"> </span>user<span class="w"> </span><span class="m">0</span>.01s<span class="w"> </span>system<span class="w"> </span><span class="m">100</span>%<span class="w"> </span>cpu<span class="w"> </span><span class="m">1</span>.759<span class="w"> </span>total
</code></pre></div>
</blockquote>



<a name="437590758"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%238571%20Changing%20a%20multiplication%20operatio.../near/437590758" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.238571.20Changing.20a.20multiplication.20operatio.2E.2E.2E.html#437590758">(May 08 2024 at 07:06)</a>:</h4>
<p>hungryzzz edited <a href="https://github.com/bytecodealliance/wasmtime/issues/8571">issue #8571</a>:</p>
<blockquote>
<h3>Test Case</h3>
<p><a href="https://github.com/bytecodealliance/wasmtime/files/15236026/cases.zip">cases.zip</a></p>
<h3>Steps to Reproduce</h3>
<p>Hi, I run the attached two cases(<code>good.wasm</code>&amp;<code>bad.wasm</code>) in <code>Wasmtime</code> and <code>WasmEdge</code>, and collect their execution time respectively.</p>
<h3>Expected Results &amp; Actual Results</h3>
<p>Actually the only difference between the attached two cases is as follow, i.e., a multiplication operation to a division one, but the execution time of <code>Wasmtime</code> increases by more than 5 times, while the execution time before and after the modification is nearly the same in <code>Wasmedge</code> and <code>Wasmer</code>.</p>
<p>![截屏2024-05-07 21 18 58](<a href="https://github.com/bytecodealliance/wasmtime/assets/32137313/a5c51594-b60f-466e-8517-48977fed9da3">https://github.com/bytecodealliance/wasmtime/assets/32137313/a5c51594-b60f-466e-8517-48977fed9da3</a>)</p>
<p>For <code>good.wasm</code>, the execution time in different runtimes are as follows:</p>
<div class="codehilite" data-code-language="Bash"><pre><span></span><code>~/wasmer/target/release/wasmer<span class="w"> </span><span class="nv">$filename</span>.wasm<span class="w">  </span><span class="m">1</span>.76s<span class="w"> </span>user<span class="w"> </span><span class="m">0</span>.01s<span class="w"> </span>system<span class="w"> </span><span class="m">100</span>%<span class="w"> </span>cpu<span class="w"> </span><span class="m">1</span>.766<span class="w"> </span>total
~/WasmEdge/build/tools/wasmedge/wasmedge<span class="w">   </span><span class="m">1</span>.18s<span class="w"> </span>user<span class="w"> </span><span class="m">0</span>.00s<span class="w"> </span>system<span class="w"> </span><span class="m">99</span>%<span class="w"> </span>cpu<span class="w"> </span><span class="m">1</span>.179<span class="w"> </span>total
~/wasmtime/target/release/wasmtime<span class="w"> </span>run<span class="w">    </span><span class="m">0</span>.74s<span class="w"> </span>user<span class="w"> </span><span class="m">0</span>.00s<span class="w"> </span>system<span class="w"> </span><span class="m">100</span>%<span class="w"> </span>cpu<span class="w"> </span><span class="m">0</span>.741<span class="w"> </span>total
</code></pre></div>
<p>For <code>bad.wasm</code>, the execution time in different runtimes are as follows:</p>
<div class="codehilite" data-code-language="Bash"><pre><span></span><code>~/wasmer/target/release/wasmer<span class="w"> </span><span class="nv">$filename</span>.wasm<span class="w">  </span><span class="m">1</span>.77s<span class="w"> </span>user<span class="w"> </span><span class="m">0</span>.00s<span class="w"> </span>system<span class="w"> </span><span class="m">100</span>%<span class="w"> </span>cpu<span class="w"> </span><span class="m">1</span>.765<span class="w"> </span>total
~/WasmEdge/build/tools/wasmedge/wasmedge<span class="w">   </span><span class="m">1</span>.18s<span class="w"> </span>user<span class="w"> </span><span class="m">0</span>.00s<span class="w"> </span>system<span class="w"> </span><span class="m">99</span>%<span class="w"> </span>cpu<span class="w"> </span><span class="m">1</span>.181<span class="w"> </span>total
~/wasmtime/target/release/wasmtime<span class="w"> </span>run<span class="w">    </span><span class="m">4</span>.68s<span class="w"> </span>user<span class="w"> </span><span class="m">0</span>.00s<span class="w"> </span>system<span class="w"> </span><span class="m">100</span>%<span class="w"> </span>cpu<span class="w"> </span><span class="m">4</span>.680<span class="w"> </span>total
</code></pre></div>
<h3>Versions and Environment</h3>
<p>Wasmtime version or commit: d0cf46a098d97bab9c4cf54a2f3aeaddea7d3831</p>
<p>Operating system: Linux ringzzz-OptiPlex-7070 5.15.0-97-generic</p>
<p>Architecture: Intel(R) Core(TM) i5-9500T CPU @ 2.20GHz</p>
</blockquote>



<a name="444954521"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%238571%20Changing%20a%20multiplication%20operatio.../near/444954521" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.238571.20Changing.20a.20multiplication.20operatio.2E.2E.2E.html#444954521">(Jun 16 2024 at 08:16)</a>:</h4>
<p>hungryzzz <a href="https://github.com/bytecodealliance/wasmtime/issues/8571#issuecomment-2171212821">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/8571">issue #8571</a>:</p>
<blockquote>
<p>@cfallin Hi, I check the generated machine code of <code>bad.wasm</code> and <code>good.wasm</code>, and find that, in the wasm code, the result of <code>i32.div_u</code> or <code>i32.mul</code> will be dropped directly, and the machine code of <code>good.wasm</code> will eliminate the multiplication operation, however, the machine code of <code>bad.wasm</code> will still do the division operation.<br>
Does this have anything to do with "rewrite divs by constants into multiplies by magic constants"? (In my view, this optimization aims to speed up the division operation under some magic contants?)<br>
By the way, I also replace <code>i32.mul</code> to other operator, e.g., <code>i32.sub</code> and <code>i32.add</code>, all of this operator will be eliminated directly. But I don't understand why only the division operator will not be eliminated.</p>
<div class="codehilite" data-code-language="WebAssembly"><pre><span></span><code><span class="c1">;; part of bad.wasm</span>
<span class="nb">i32.const</span> <span class="mi">0</span>
<span class="nb">i32.const</span> <span class="mi">1</span>
<span class="nb">i32.div_u</span> <span class="c1">;; diff</span>
<span class="nb">drop</span>

<span class="c1">;; part of good.wasm</span>
<span class="nb">i32.const</span> <span class="mi">0</span>
<span class="nb">i32.const</span> <span class="mi">1</span>
<span class="nb">i32.mul</span> <span class="c1">;; diff</span>
<span class="nb">drop</span>
</code></pre></div>
<p><a href="https://github.com/user-attachments/files/15856642/report.zip">report.zip</a><br>
</p>
</blockquote>



<a name="444954548"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%238571%20Changing%20a%20multiplication%20operatio.../near/444954548" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.238571.20Changing.20a.20multiplication.20operatio.2E.2E.2E.html#444954548">(Jun 16 2024 at 08:16)</a>:</h4>
<p>hungryzzz edited a <a href="https://github.com/bytecodealliance/wasmtime/issues/8571#issuecomment-2171212821">comment</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/8571">issue #8571</a>:</p>
<blockquote>
<p>@cfallin Hi, I check the generated machine code of <code>bad.wasm</code> and <code>good.wasm</code>, and find that, in the wasm code, the result of <code>i32.div_u</code> or <code>i32.mul</code> will be dropped directly, and the machine code of <code>good.wasm</code> will eliminate the multiplication operation, however, the machine code of <code>bad.wasm</code> will still do the division operation.<br>
Does this have anything to do with "rewrite divs by constants into multiplies by magic constants"? (In my view, this optimization aims to speed up the division operation?)<br>
By the way, I also replace <code>i32.mul</code> to other operator, e.g., <code>i32.sub</code> and <code>i32.add</code>, all of this operator will be eliminated directly. But I don't understand why only the division operator will not be eliminated.</p>
<div class="codehilite" data-code-language="WebAssembly"><pre><span></span><code><span class="c1">;; part of bad.wasm</span>
<span class="nb">i32.const</span> <span class="mi">0</span>
<span class="nb">i32.const</span> <span class="mi">1</span>
<span class="nb">i32.div_u</span> <span class="c1">;; diff</span>
<span class="nb">drop</span>

<span class="c1">;; part of good.wasm</span>
<span class="nb">i32.const</span> <span class="mi">0</span>
<span class="nb">i32.const</span> <span class="mi">1</span>
<span class="nb">i32.mul</span> <span class="c1">;; diff</span>
<span class="nb">drop</span>
</code></pre></div>
<p><a href="https://github.com/user-attachments/files/15856642/report.zip">report.zip</a><br>
</p>
</blockquote>



<a name="444955488"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%238571%20Changing%20a%20multiplication%20operatio.../near/444955488" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.238571.20Changing.20a.20multiplication.20operatio.2E.2E.2E.html#444955488">(Jun 16 2024 at 08:31)</a>:</h4>
<p>hungryzzz edited a <a href="https://github.com/bytecodealliance/wasmtime/issues/8571#issuecomment-2171212821">comment</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/8571">issue #8571</a>:</p>
<blockquote>
<p>@cfallin Hi, I check the generated machine code of <code>bad.wasm</code> and <code>good.wasm</code>, and find that, in the wasm code, the result of <code>i32.div_u</code> or <code>i32.mul</code> will be dropped directly, and the machine code of <code>good.wasm</code> will eliminate the multiplication operation, however, the machine code of <code>bad.wasm</code> will still do the division operation.<br>
Does this have anything to do with "rewrite divs by constants into multiplies by magic constants"? (In my view, this optimization aims to speed up the division operation?)<br>
By the way, I also replace <code>i32.mul</code> to other operator, e.g., <code>i32.sub</code> and <code>i32.add</code>, all of this operator will be eliminated directly. But I don't understand why only the division operator will not be eliminated.</p>
<div class="codehilite" data-code-language="WebAssembly"><pre><span></span><code><span class="c1">;; part of bad.wasm</span>
<span class="nb">i32.const</span> <span class="mi">0</span>
<span class="nb">i32.const</span> <span class="mi">1</span>
<span class="nb">i32.div_u</span> <span class="c1">;; diff</span>
<span class="nb">drop</span>

<span class="c1">;; part of good.wasm</span>
<span class="nb">i32.const</span> <span class="mi">0</span>
<span class="nb">i32.const</span> <span class="mi">1</span>
<span class="nb">i32.mul</span> <span class="c1">;; diff</span>
<span class="nb">drop</span>
</code></pre></div>
<div class="codehilite" data-code-language="Bash"><pre><span></span><code><span class="c1"># the division operation in machine code of bad.wasm</span>

xor<span class="w"> </span>%eax,%eax
mov<span class="w"> </span><span class="nv">$0</span>x1,%esi
xor<span class="w"> </span>%rdx,%rdx
div<span class="w"> </span>%esi
</code></pre></div>
<p><a href="https://github.com/user-attachments/files/15856642/report.zip">report.zip</a><br>
</p>
</blockquote>



<a name="445038839"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%238571%20Changing%20a%20multiplication%20operatio.../near/445038839" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.238571.20Changing.20a.20multiplication.20operatio.2E.2E.2E.html#445038839">(Jun 17 2024 at 01:24)</a>:</h4>
<p>cfallin <a href="https://github.com/bytecodealliance/wasmtime/issues/8571#issuecomment-2172000849">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/8571">issue #8571</a>:</p>
<blockquote>
<p>Yes, divides also cannot be removed currently, even if dead: they may have side-effects in general (and Cranelift's predicate for "is this instruction side-effecting" doesn't know about constant input values, so it can't reason that a divide-by-constant-1 will never reach the divide-by-zero trap case). That's why a <code>drop</code>'d <code>i32.div_u</code> still appears in codegen while the <code>i32.mul</code> does not.</p>
</blockquote>



<hr><p>Last updated: Jan 20 2025 at 06:04 UTC</p>
</html>