<html>
<head><meta charset="utf-8"><title>wasmtime / issue #3523 Pathological time spent in registe... · git-wasmtime · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/index.html">git-wasmtime</a></h2>
<h3>Topic: <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.233523.20Pathological.20time.20spent.20in.20registe.2E.2E.2E.html">wasmtime / issue #3523 Pathological time spent in registe...</a></h3>

<hr>

<base href="https://bytecodealliance.zulipchat.com">

<head><link href="https://bytecodealliance.github.io/zulip-archive/style.css" rel="stylesheet"></head>

<a name="261559665"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%233523%20Pathological%20time%20spent%20in%20registe.../near/261559665" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.233523.20Pathological.20time.20spent.20in.20registe.2E.2E.2E.html#261559665">(Nov 15 2021 at 21:11)</a>:</h4>
<p>alexcrichton edited <a href="https://github.com/bytecodealliance/wasmtime/issues/3523">issue #3523</a>:</p>
<blockquote>
<p>We have implemented this repo <a href="https://github.com/girazoki/wasmtime-try">https://github.com/girazoki/wasmtime-try</a> to try something that has been happening us with some latest code change we have done at moonbeam. The code change is <a href="https://github.com/PureStake/moonbeam/pull/989">https://github.com/PureStake/moonbeam/pull/989</a>.</p>
<p>Without the PR, wasmtime takes around 15 seconds to compile the wasm. However, if we include the change (removal of the trait) wasmtime takes less than a second to compile. We wonder how these differences can be so big with such a small code change.</p>
<p>Both runtimes are in <a href="https://github.com/girazoki/wasmtime-try">https://github.com/girazoki/wasmtime-try</a> to try them out<br>
Any help would be appreciated, thanks!</p>
</blockquote>



<a name="261559823"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%233523%20Pathological%20time%20spent%20in%20registe.../near/261559823" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.233523.20Pathological.20time.20spent.20in.20registe.2E.2E.2E.html#261559823">(Nov 15 2021 at 21:12)</a>:</h4>
<p>cfallin <a href="https://github.com/bytecodealliance/wasmtime/issues/3523#issuecomment-969326035">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/3523">issue #3523</a>:</p>
<blockquote>
<p>@alexcrichton That's a good question; ordinarily we'd definitely want to chase something like this, but if the RA2 transition happens soon-ish then the payoff of the time it would take to understand the issue and update the old regalloc, and be confident in the fix, doesn't seem worth it. Especially as many of the details of <a href="http://regalloc.rs">regalloc.rs</a> have fallen out of my mental L2 cache by now...</p>
<p>These sorts of things do put pressure on the transition, though, so hopefully the moving pieces needed for that will come together soon!</p>
</blockquote>



<a name="261560293"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%233523%20Pathological%20time%20spent%20in%20registe.../near/261560293" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.233523.20Pathological.20time.20spent.20in.20registe.2E.2E.2E.html#261560293">(Nov 15 2021 at 21:16)</a>:</h4>
<p>alexcrichton <a href="https://github.com/bytecodealliance/wasmtime/issues/3523#issuecomment-969328744">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/3523">issue #3523</a>:</p>
<blockquote>
<p>@adamrk given your interest on <a href="https://github.com/bytecodealliance/wasmtime/issues/3441#issuecomment-947072360">this issue</a> you might be interested in this one as well (<a href="https://github.com/bytecodealliance/wasmtime/issues/3523#issuecomment-969319849">detailed here</a>) but if not no worries!</p>
</blockquote>



<a name="261645742"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%233523%20Pathological%20time%20spent%20in%20registe.../near/261645742" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.233523.20Pathological.20time.20spent.20in.20registe.2E.2E.2E.html#261645742">(Nov 16 2021 at 14:11)</a>:</h4>
<p>crystalin <a href="https://github.com/bytecodealliance/wasmtime/issues/3523#issuecomment-970312015">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/3523">issue #3523</a>:</p>
<blockquote>
<p>Not sure if that would help, but here are the perf (you can open in <a href="https://www.speedscope.app/">https://www.speedscope.app/</a> ) for when it is loading the wasm: <a href="https://drive.google.com/file/d/1LSid_h9vs8LGtbaQ8z41CD3vn4-y4g2U/view?usp=sharing">https://drive.google.com/file/d/1LSid_h9vs8LGtbaQ8z41CD3vn4-y4g2U/view?usp=sharing</a></p>
<p>(Here is where most of the work goes it seems)<br>
![20211111_164744](<a href="https://user-images.githubusercontent.com/329248/142000660-5bb26ba7-6458-4bda-8813-8075fd3bc00b.jpg">https://user-images.githubusercontent.com/329248/142000660-5bb26ba7-6458-4bda-8813-8075fd3bc00b.jpg</a>)<br>
.</p>
</blockquote>



<a name="261645758"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%233523%20Pathological%20time%20spent%20in%20registe.../near/261645758" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.233523.20Pathological.20time.20spent.20in.20registe.2E.2E.2E.html#261645758">(Nov 16 2021 at 14:11)</a>:</h4>
<p>crystalin edited a <a href="https://github.com/bytecodealliance/wasmtime/issues/3523#issuecomment-970312015">comment</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/3523">issue #3523</a>:</p>
<blockquote>
<p>Not sure if that would help, but here are the perf (you can open in <a href="https://www.speedscope.app/">https://www.speedscope.app/</a> ) for when it is loading the wasm: <a href="https://drive.google.com/file/d/1LSid_h9vs8LGtbaQ8z41CD3vn4-y4g2U/view?usp=sharing">https://drive.google.com/file/d/1LSid_h9vs8LGtbaQ8z41CD3vn4-y4g2U/view?usp=sharing</a></p>
<p>(Here is where most of the work goes it seems)<br>
</p>
</blockquote>



<a name="261645781"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%233523%20Pathological%20time%20spent%20in%20registe.../near/261645781" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.233523.20Pathological.20time.20spent.20in.20registe.2E.2E.2E.html#261645781">(Nov 16 2021 at 14:11)</a>:</h4>
<p>crystalin edited a <a href="https://github.com/bytecodealliance/wasmtime/issues/3523#issuecomment-970312015">comment</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/3523">issue #3523</a>:</p>
<blockquote>
<p>Not sure if that would help, but here are the perf (you can open in <a href="https://www.speedscope.app/">https://www.speedscope.app/</a> ) for when it is loading the wasm: <a href="https://drive.google.com/file/d/1LSid_h9vs8LGtbaQ8z41CD3vn4-y4g2U/view?usp=sharing">https://drive.google.com/file/d/1LSid_h9vs8LGtbaQ8z41CD3vn4-y4g2U/view?usp=sharing</a></p>
<p>(Here is where most of the work goes it seems<br>
![image (1)](<a href="https://user-images.githubusercontent.com/329248/142000825-4c5a5f37-ba7e-41f3-9b19-31989555b883.png">https://user-images.githubusercontent.com/329248/142000825-4c5a5f37-ba7e-41f3-9b19-31989555b883.png</a>)<br>
)</p>
</blockquote>



<a name="261645797"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%233523%20Pathological%20time%20spent%20in%20registe.../near/261645797" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.233523.20Pathological.20time.20spent.20in.20registe.2E.2E.2E.html#261645797">(Nov 16 2021 at 14:11)</a>:</h4>
<p>crystalin edited a <a href="https://github.com/bytecodealliance/wasmtime/issues/3523#issuecomment-970312015">comment</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/3523">issue #3523</a>:</p>
<blockquote>
<p>Not sure if that would help, but here are the perf (you can open in <a href="https://www.speedscope.app/">https://www.speedscope.app/</a> ) for when it is loading the wasm: <a href="https://drive.google.com/file/d/1LSid_h9vs8LGtbaQ8z41CD3vn4-y4g2U/view?usp=sharing">https://drive.google.com/file/d/1LSid_h9vs8LGtbaQ8z41CD3vn4-y4g2U/view?usp=sharing</a></p>
<p>(Here is where most of the work goes it seems)<br>
![image (1)](<a href="https://user-images.githubusercontent.com/329248/142000825-4c5a5f37-ba7e-41f3-9b19-31989555b883.png">https://user-images.githubusercontent.com/329248/142000825-4c5a5f37-ba7e-41f3-9b19-31989555b883.png</a>)</p>
</blockquote>



<a name="262089313"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%233523%20Pathological%20time%20spent%20in%20registe.../near/262089313" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.233523.20Pathological.20time.20spent.20in.20registe.2E.2E.2E.html#262089313">(Nov 19 2021 at 16:22)</a>:</h4>
<p>alexcrichton labeled <a href="https://github.com/bytecodealliance/wasmtime/issues/3523">issue #3523</a>:</p>
<blockquote>
<p>We have implemented this repo <a href="https://github.com/girazoki/wasmtime-try">https://github.com/girazoki/wasmtime-try</a> to try something that has been happening us with some latest code change we have done at moonbeam. The code change is <a href="https://github.com/PureStake/moonbeam/pull/989">https://github.com/PureStake/moonbeam/pull/989</a>.</p>
<p>Without the PR, wasmtime takes around 15 seconds to compile the wasm. However, if we include the change (removal of the trait) wasmtime takes less than a second to compile. We wonder how these differences can be so big with such a small code change.</p>
<p>Both runtimes are in <a href="https://github.com/girazoki/wasmtime-try">https://github.com/girazoki/wasmtime-try</a> to try them out<br>
Any help would be appreciated, thanks!</p>
</blockquote>



<a name="262089535"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%233523%20Pathological%20time%20spent%20in%20registe.../near/262089535" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.233523.20Pathological.20time.20spent.20in.20registe.2E.2E.2E.html#262089535">(Nov 19 2021 at 16:23)</a>:</h4>
<p>alexcrichton labeled <a href="https://github.com/bytecodealliance/wasmtime/issues/3523">issue #3523</a>:</p>
<blockquote>
<p>We have implemented this repo <a href="https://github.com/girazoki/wasmtime-try">https://github.com/girazoki/wasmtime-try</a> to try something that has been happening us with some latest code change we have done at moonbeam. The code change is <a href="https://github.com/PureStake/moonbeam/pull/989">https://github.com/PureStake/moonbeam/pull/989</a>.</p>
<p>Without the PR, wasmtime takes around 15 seconds to compile the wasm. However, if we include the change (removal of the trait) wasmtime takes less than a second to compile. We wonder how these differences can be so big with such a small code change.</p>
<p>Both runtimes are in <a href="https://github.com/girazoki/wasmtime-try">https://github.com/girazoki/wasmtime-try</a> to try them out<br>
Any help would be appreciated, thanks!</p>
</blockquote>



<a name="262840580"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%233523%20Pathological%20time%20spent%20in%20registe.../near/262840580" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.233523.20Pathological.20time.20spent.20in.20registe.2E.2E.2E.html#262840580">(Nov 26 2021 at 22:57)</a>:</h4>
<p>adamrk <a href="https://github.com/bytecodealliance/wasmtime/issues/3523#issuecomment-980461512">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/3523">issue #3523</a>:</p>
<blockquote>
<p>Sorry, just noticed this. Yeah, I'll take a look at it.</p>
</blockquote>



<a name="264996327"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%233523%20Pathological%20time%20spent%20in%20registe.../near/264996327" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.233523.20Pathological.20time.20spent.20in.20registe.2E.2E.2E.html#264996327">(Dec 15 2021 at 11:32)</a>:</h4>
<p>JoshOrndorff <a href="https://github.com/bytecodealliance/wasmtime/issues/3523#issuecomment-994702854">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/3523">issue #3523</a>:</p>
<blockquote>
<p>@alexcrichton We have hit what appears to be the same issue in the Moonbeam project again. This time it is in <a href="https://github.com/JoshOrndorff/wasmtime-try/blob/main/moonbase_runtime.compact.wasm">this wasm file</a>.</p>
<p>Following your example, @girazoki, explored this:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="n">RUST_LOG</span><span class="o">=</span><span class="n">wasmtime_cranelift</span><span class="w"> </span><span class="n">wasmtime</span><span class="w"> </span><span class="n">compile</span><span class="w"> </span><span class="n">moonbase_runtime</span><span class="p">.</span><span class="n">wasm</span><span class="w"></span>

<span class="o">..</span><span class="p">.</span><span class="w"></span>

<span class="w"> </span><span class="n">DEBUG</span><span class="w"> </span><span class="n">wasmtime_cranelift</span>::<span class="n">compiler</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="n">FuncIndex</span><span class="p">(</span><span class="mi">1276</span><span class="p">)</span><span class="w"> </span><span class="n">translated</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="mf">13.571936365</span><span class="n">s</span><span class="w"></span>
<span class="w"> </span><span class="n">TRACE</span><span class="w"> </span><span class="n">wasmtime_cranelift</span>::<span class="n">compiler</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="n">FuncIndex</span><span class="p">(</span><span class="mi">1276</span><span class="p">)</span><span class="w"> </span><span class="n">timing</span><span class="w"> </span><span class="n">info</span><span class="w"></span>
<span class="o">========</span><span class="w"> </span><span class="o">========</span><span class="w">  </span><span class="o">==================================</span><span class="w"></span>
<span class="w">   </span><span class="n">Total</span><span class="w">     </span><span class="bp">Self</span><span class="w">  </span><span class="n">Pass</span><span class="w"></span>
<span class="o">--------</span><span class="w"> </span><span class="o">--------</span><span class="w">  </span><span class="o">----------------------------------</span><span class="w"></span>
<span class="w">   </span><span class="mf">0.510</span><span class="w">    </span><span class="mf">0.510</span><span class="w">  </span><span class="n">Translate</span><span class="w"> </span><span class="n">WASM</span><span class="w"> </span><span class="n">function</span><span class="w"></span>
<span class="w">  </span><span class="mf">13.056</span><span class="w">    </span><span class="mf">0.030</span><span class="w">  </span><span class="n">Compilation</span><span class="w"> </span><span class="n">passes</span><span class="w"></span>
<span class="w">   </span><span class="mf">0.001</span><span class="w">    </span><span class="mf">0.001</span><span class="w">  </span><span class="n">Control</span><span class="w"> </span><span class="n">flow</span><span class="w"> </span><span class="n">graph</span><span class="w"></span>
<span class="w">   </span><span class="mf">0.002</span><span class="w">    </span><span class="mf">0.002</span><span class="w">  </span><span class="n">Dominator</span><span class="w"> </span><span class="n">tree</span><span class="w"></span>
<span class="w">   </span><span class="mf">0.000</span><span class="w">    </span><span class="mf">0.000</span><span class="w">  </span><span class="n">Loop</span><span class="w"> </span><span class="n">analysis</span><span class="w"></span>
<span class="w">   </span><span class="mf">0.001</span><span class="w">    </span><span class="mf">0.001</span><span class="w">  </span><span class="n">Pre</span><span class="o">-</span><span class="n">legalization</span><span class="w"> </span><span class="n">rewriting</span><span class="w"></span>
<span class="w">   </span><span class="mf">0.005</span><span class="w">    </span><span class="mf">0.005</span><span class="w">  </span><span class="n">Dead</span><span class="w"> </span><span class="n">code</span><span class="w"> </span><span class="n">elimination</span><span class="w"></span>
<span class="w">   </span><span class="mf">0.009</span><span class="w">    </span><span class="mf">0.009</span><span class="w">  </span><span class="n">Global</span><span class="w"> </span><span class="n">value</span><span class="w"> </span><span class="n">numbering</span><span class="w"></span>
<span class="w">   </span><span class="mf">0.044</span><span class="w">    </span><span class="mf">0.033</span><span class="w">  </span><span class="n">Loop</span><span class="w"> </span><span class="n">invariant</span><span class="w"> </span><span class="n">code</span><span class="w"> </span><span class="n">motion</span><span class="w"></span>
<span class="w">   </span><span class="mf">0.000</span><span class="w">    </span><span class="mf">0.000</span><span class="w">  </span><span class="n">Remove</span><span class="w"> </span><span class="n">unreachable</span><span class="w"> </span><span class="n">blocks</span><span class="w"></span>
<span class="w">   </span><span class="mf">0.210</span><span class="w">    </span><span class="mf">0.210</span><span class="w">  </span><span class="n">Remove</span><span class="w"> </span><span class="n">constant</span><span class="w"> </span><span class="n">phi</span><span class="o">-</span><span class="n">nodes</span><span class="w"></span>
<span class="w">   </span><span class="mf">0.222</span><span class="w">    </span><span class="mf">0.222</span><span class="w">  </span><span class="n">VCode</span><span class="w"> </span><span class="n">lowering</span><span class="w"></span>
<span class="w">   </span><span class="mf">0.060</span><span class="w">    </span><span class="mf">0.060</span><span class="w">  </span><span class="n">VCode</span><span class="w"> </span><span class="n">post</span><span class="o">-</span><span class="n">register</span><span class="w"> </span><span class="n">allocation</span><span class="w"> </span><span class="n">finalization</span><span class="w"></span>
<span class="w">   </span><span class="mf">0.029</span><span class="w">    </span><span class="mf">0.029</span><span class="w">  </span><span class="n">VCode</span><span class="w"> </span><span class="n">emission</span><span class="w"></span>
<span class="w">   </span><span class="mf">0.000</span><span class="w">    </span><span class="mf">0.000</span><span class="w">  </span><span class="n">VCode</span><span class="w"> </span><span class="n">emission</span><span class="w"> </span><span class="n">finalization</span><span class="w"></span>
<span class="w">  </span><span class="mf">12.443</span><span class="w">   </span><span class="mf">12.443</span><span class="w">  </span><span class="n">Register</span><span class="w"> </span><span class="n">allocation</span><span class="w"></span>
<span class="w">   </span><span class="mf">0.006</span><span class="w">    </span><span class="mf">0.006</span><span class="w">  </span><span class="n">Binary</span><span class="w"> </span><span class="n">machine</span><span class="w"> </span><span class="n">code</span><span class="w"> </span><span class="n">emission</span><span class="w"></span>
<span class="w">   </span><span class="mf">0.009</span><span class="w">    </span><span class="mf">0.009</span><span class="w">  </span><span class="n">Layout</span><span class="w"> </span><span class="n">full</span><span class="w"> </span><span class="n">renumbering</span><span class="w"></span>
<span class="o">========</span><span class="w"> </span><span class="o">========</span><span class="w">  </span><span class="o">==================================</span><span class="w"></span>
</code></pre></div>
<p>How did you figure out the human-readale or even the mangled name of the function to know where to put the <code>#[inline(never)]</code>?</p>
</blockquote>



<a name="265047527"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%233523%20Pathological%20time%20spent%20in%20registe.../near/265047527" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.233523.20Pathological.20time.20spent.20in.20registe.2E.2E.2E.html#265047527">(Dec 15 2021 at 17:49)</a>:</h4>
<p>alexcrichton <a href="https://github.com/bytecodealliance/wasmtime/issues/3523#issuecomment-995023900">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/3523">issue #3523</a>:</p>
<blockquote>
<p>Oh nice, thanks for that! I was able to find the function-in-question with:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="n">RUST_LOG</span><span class="o">=</span><span class="n">wasmtime_cranelift</span><span class="o">=</span><span class="n">debug</span><span class="w"> </span><span class="p">.</span><span class="o">/</span><span class="n">target</span><span class="o">/</span><span class="n">release</span><span class="o">/</span><span class="n">wasmtime</span><span class="w"> </span><span class="n">compile</span><span class="w"> </span><span class="n">moonbase_runtime</span><span class="p">.</span><span class="n">compact</span><span class="p">.</span><span class="n">wasm</span><span class="w"></span>
</code></pre></div>
<p>which prints out:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="o">..</span><span class="p">.</span><span class="w"></span>
<span class="w"> </span><span class="n">DEBUG</span><span class="w"> </span><span class="n">wasmtime_cranelift</span>::<span class="n">compiler</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="n">FuncIndex</span><span class="p">(</span><span class="mi">1776</span><span class="p">)</span><span class="w"> </span><span class="n">translated</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="mf">70.436892</span><span class="n">ms</span><span class="w"></span>
<span class="w"> </span><span class="n">DEBUG</span><span class="w"> </span><span class="n">wasmtime_cranelift</span>::<span class="n">compiler</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="n">FuncIndex</span><span class="p">(</span><span class="mi">679</span><span class="p">)</span><span class="w"> </span><span class="n">translated</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="mf">69.31585</span><span class="n">ms</span><span class="w"></span>
<span class="w"> </span><span class="n">DEBUG</span><span class="w"> </span><span class="n">wasmtime_cranelift</span>::<span class="n">compiler</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="n">FuncIndex</span><span class="p">(</span><span class="mi">2050</span><span class="p">)</span><span class="w"> </span><span class="n">translated</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="mf">61.266995</span><span class="n">ms</span><span class="w"></span>
<span class="w"> </span><span class="n">DEBUG</span><span class="w"> </span><span class="n">wasmtime_cranelift</span>::<span class="n">compiler</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="n">FuncIndex</span><span class="p">(</span><span class="mi">1574</span><span class="p">)</span><span class="w"> </span><span class="n">translated</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="mf">68.276648</span><span class="n">ms</span><span class="w"></span>
<span class="w"> </span><span class="n">DEBUG</span><span class="w"> </span><span class="n">wasmtime_cranelift</span>::<span class="n">compiler</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="n">FuncIndex</span><span class="p">(</span><span class="mi">1622</span><span class="p">)</span><span class="w"> </span><span class="n">translated</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="mf">75.956103</span><span class="n">ms</span><span class="w"></span>
<span class="w"> </span><span class="n">DEBUG</span><span class="w"> </span><span class="n">wasmtime_cranelift</span>::<span class="n">compiler</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="n">FuncIndex</span><span class="p">(</span><span class="mi">1983</span><span class="p">)</span><span class="w"> </span><span class="n">translated</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="mf">85.31272</span><span class="n">ms</span><span class="w"></span>
<span class="w"> </span><span class="n">DEBUG</span><span class="w"> </span><span class="n">wasmtime_cranelift</span>::<span class="n">compiler</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="n">FuncIndex</span><span class="p">(</span><span class="mi">1347</span><span class="p">)</span><span class="w"> </span><span class="n">translated</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="mf">282.235891</span><span class="n">ms</span><span class="w"></span>
<span class="w"> </span><span class="n">DEBUG</span><span class="w"> </span><span class="n">wasmtime_cranelift</span>::<span class="n">compiler</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="n">FuncIndex</span><span class="p">(</span><span class="mi">1276</span><span class="p">)</span><span class="w"> </span><span class="n">translated</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="mf">19.01582367</span><span class="n">s</span><span class="w"></span>
</code></pre></div>
<p>which points to function 1276 as the offender here.</p>
<p>Using <code>wasm-opt</code> I got:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="cp">$</span><span class="w"> </span><span class="n">wasm</span><span class="o">-</span><span class="n">opt</span><span class="w"> </span><span class="o">--</span><span class="n">extract</span><span class="o">-</span><span class="n">function</span><span class="o">-</span><span class="n">index</span><span class="o">=</span><span class="mi">1276</span><span class="w"> </span><span class="p">.</span><span class="o">/</span><span class="n">moonbase_runtime</span><span class="p">.</span><span class="n">compact</span><span class="p">.</span><span class="n">wasm</span><span class="w"> </span><span class="o">-</span><span class="n">o</span><span class="w"> </span><span class="n">extract</span><span class="p">.</span><span class="n">wasm</span><span class="w"></span>
<span class="n">extracting</span><span class="w"> </span><span class="o">&lt;</span><span class="n">xcm_executor</span>::<span class="n">XcmExecutor</span><span class="o">&lt;</span><span class="n">Config</span><span class="o">&gt;</span><span class="err">\</span><span class="mi">20</span><span class="k">as</span><span class="err">\</span><span class="mi">20</span><span class="n">xcm</span>::<span class="n">v2</span>::<span class="n">traits</span>::<span class="n">ExecuteXcm</span><span class="o">&lt;&lt;</span><span class="n">Config</span><span class="err">\</span><span class="mi">20</span><span class="k">as</span><span class="err">\</span><span class="mi">20</span><span class="n">xcm_executor</span>::<span class="n">config</span>::<span class="n">Config</span><span class="o">&gt;</span>::<span class="n">Call</span><span class="o">&gt;&gt;</span>::<span class="n">execute_xcm_in_credit</span>::<span class="n">hf77207caf74f0f13</span><span class="w"></span>
</code></pre></div>
<p>which I can confirm the <a href="https://github.com/bytecodealliance/wasmtime/files/7721648/extract.wasm.gz">extracted wasm file</a> takes ~20s to compile, quite too long!</p>
</blockquote>



<a name="265047651"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%233523%20Pathological%20time%20spent%20in%20registe.../near/265047651" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.233523.20Pathological.20time.20spent.20in.20registe.2E.2E.2E.html#265047651">(Dec 15 2021 at 17:50)</a>:</h4>
<p>alexcrichton edited <a href="https://github.com/bytecodealliance/wasmtime/issues/3523">issue #3523</a>:</p>
<blockquote>
<h2>Original Issue</h2>
<p>We have implemented this repo <a href="https://github.com/girazoki/wasmtime-try">https://github.com/girazoki/wasmtime-try</a> to try something that has been happening us with some latest code change we have done at moonbeam. The code change is <a href="https://github.com/PureStake/moonbeam/pull/989">https://github.com/PureStake/moonbeam/pull/989</a>.</p>
<p>Without the PR, wasmtime takes around 15 seconds to compile the wasm. However, if we include the change (removal of the trait) wasmtime takes less than a second to compile. We wonder how these differences can be so big with such a small code change.</p>
<p>Both runtimes are in <a href="https://github.com/girazoki/wasmtime-try">https://github.com/girazoki/wasmtime-try</a> to try them out<br>
Any help would be appreciated, thanks!</p>
<h2>Current status</h2>
<p>Modules with way-too-long-compile-times:</p>
<ul>
<li><a href="https://github.com/bytecodealliance/wasmtime/issues/3523#issuecomment-969324846">https://github.com/bytecodealliance/wasmtime/issues/3523#issuecomment-969324846</a></li>
<li><a href="https://github.com/bytecodealliance/wasmtime/issues/3523#issuecomment-995023900">https://github.com/bytecodealliance/wasmtime/issues/3523#issuecomment-995023900</a></li>
</ul>
</blockquote>



<a name="280223078"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%233523%20Pathological%20time%20spent%20in%20registe.../near/280223078" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.233523.20Pathological.20time.20spent.20in.20registe.2E.2E.2E.html#280223078">(Apr 26 2022 at 15:01)</a>:</h4>
<p>alexcrichton <a href="https://github.com/bytecodealliance/wasmtime/issues/3523#issuecomment-1109907417">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/3523">issue #3523</a>:</p>
<blockquote>
<p>I'm going to close this given the discussion on <a href="https://github.com/bytecodealliance/wasmtime/issues/4060">https://github.com/bytecodealliance/wasmtime/issues/4060</a>. The new regalloc probably improves things here but these sorts of outliers are inevitable with Cranelift's design goals.</p>
</blockquote>



<a name="280223084"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%233523%20Pathological%20time%20spent%20in%20registe.../near/280223084" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.233523.20Pathological.20time.20spent.20in.20registe.2E.2E.2E.html#280223084">(Apr 26 2022 at 15:01)</a>:</h4>
<p>alexcrichton closed <a href="https://github.com/bytecodealliance/wasmtime/issues/3523">issue #3523</a>:</p>
<blockquote>
<h2>Original Issue</h2>
<p>We have implemented this repo <a href="https://github.com/girazoki/wasmtime-try">https://github.com/girazoki/wasmtime-try</a> to try something that has been happening us with some latest code change we have done at moonbeam. The code change is <a href="https://github.com/PureStake/moonbeam/pull/989">https://github.com/PureStake/moonbeam/pull/989</a>.</p>
<p>Without the PR, wasmtime takes around 15 seconds to compile the wasm. However, if we include the change (removal of the trait) wasmtime takes less than a second to compile. We wonder how these differences can be so big with such a small code change.</p>
<p>Both runtimes are in <a href="https://github.com/girazoki/wasmtime-try">https://github.com/girazoki/wasmtime-try</a> to try them out<br>
Any help would be appreciated, thanks!</p>
<h2>Current status</h2>
<p>Modules with way-too-long-compile-times:</p>
<ul>
<li><a href="https://github.com/bytecodealliance/wasmtime/issues/3523#issuecomment-969324846">https://github.com/bytecodealliance/wasmtime/issues/3523#issuecomment-969324846</a></li>
<li><a href="https://github.com/bytecodealliance/wasmtime/issues/3523#issuecomment-995023900">https://github.com/bytecodealliance/wasmtime/issues/3523#issuecomment-995023900</a></li>
</ul>
</blockquote>



<hr><p>Last updated: Jan 20 2025 at 06:04 UTC</p>
</html>