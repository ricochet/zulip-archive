<html>
<head><meta charset="utf-8"><title>wasmtime / Issue #2715 Pooling instance allocator: use na... · git-wasmtime · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/index.html">git-wasmtime</a></h2>
<h3>Topic: <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20Issue.20.232715.20Pooling.20instance.20allocator.3A.20use.20na.2E.2E.2E.html">wasmtime / Issue #2715 Pooling instance allocator: use na...</a></h3>

<hr>

<base href="https://bytecodealliance.zulipchat.com">

<head><link href="https://bytecodealliance.github.io/zulip-archive/style.css" rel="stylesheet"></head>

<a name="229381498"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20Issue%20%232715%20Pooling%20instance%20allocator%3A%20use%20na.../near/229381498" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20Issue.20.232715.20Pooling.20instance.20allocator.3A.20use.20na.2E.2E.2E.html#229381498">(Mar 08 2021 at 21:59)</a>:</h4>
<p>peterhuene assigned <a href="https://github.com/bytecodealliance/wasmtime/issues/2715">Issue #2715</a> (assigned to peterhuene):</p>
<blockquote>
<p>Currently the pooling instance allocator page-aligns each instance in the pool.</p>
<p>This is unnecessary and can lead to wasting a space to alignment padding.</p>
<p>Instances can be aligned according to their natural alignment instead as the pooling instance allocator does not muck around with the backing pages for an instance like it does with the other resources.</p>
</blockquote>



<a name="229381499"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20Issue%20%232715%20Pooling%20instance%20allocator%3A%20use%20na.../near/229381499" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20Issue.20.232715.20Pooling.20instance.20allocator.3A.20use.20na.2E.2E.2E.html#229381499">(Mar 08 2021 at 21:59)</a>:</h4>
<p>peterhuene labeled <a href="https://github.com/bytecodealliance/wasmtime/issues/2715">Issue #2715</a> (assigned to peterhuene):</p>
<blockquote>
<p>Currently the pooling instance allocator page-aligns each instance in the pool.</p>
<p>This is unnecessary and can lead to wasting a space to alignment padding.</p>
<p>Instances can be aligned according to their natural alignment instead as the pooling instance allocator does not muck around with the backing pages for an instance like it does with the other resources.</p>
</blockquote>



<a name="229381500"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20Issue%20%232715%20Pooling%20instance%20allocator%3A%20use%20na.../near/229381500" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20Issue.20.232715.20Pooling.20instance.20allocator.3A.20use.20na.2E.2E.2E.html#229381500">(Mar 08 2021 at 21:59)</a>:</h4>
<p>peterhuene opened <a href="https://github.com/bytecodealliance/wasmtime/issues/2715">Issue #2715</a> (assigned to peterhuene):</p>
<blockquote>
<p>Currently the pooling instance allocator page-aligns each instance in the pool.</p>
<p>This is unnecessary and can lead to wasting a space to alignment padding.</p>
<p>Instances can be aligned according to their natural alignment instead as the pooling instance allocator does not muck around with the backing pages for an instance like it does with the other resources.</p>
</blockquote>



<a name="229381644"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20Issue%20%232715%20Pooling%20instance%20allocator%3A%20use%20na.../near/229381644" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20Issue.20.232715.20Pooling.20instance.20allocator.3A.20use.20na.2E.2E.2E.html#229381644">(Mar 08 2021 at 22:00)</a>:</h4>
<p>peterhuene edited <a href="https://github.com/bytecodealliance/wasmtime/issues/2715">Issue #2715</a> (assigned to peterhuene):</p>
<blockquote>
<p>Currently the pooling instance allocator page-aligns each instance in the pool.</p>
<p>This is unnecessary and can lead to wasting some space to alignment padding.</p>
<p>Instances can be aligned according to their natural alignment instead as the pooling instance allocator does not muck around with the backing pages for an instance like it does with the other resources.</p>
</blockquote>



<a name="229394580"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20Issue%20%232715%20Pooling%20instance%20allocator%3A%20use%20na.../near/229394580" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20Issue.20.232715.20Pooling.20instance.20allocator.3A.20use.20na.2E.2E.2E.html#229394580">(Mar 08 2021 at 23:21)</a>:</h4>
<p>alexcrichton <a href="https://github.com/bytecodealliance/wasmtime/issues/2715#issuecomment-793162793">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/2715">Issue #2715</a>:</p>
<blockquote>
<p>Replying to <a href="https://github.com/bytecodealliance/wasmtime/pull/2518#issuecomment-792956929">https://github.com/bytecodealliance/wasmtime/pull/2518#issuecomment-792956929</a> over here....</p>
<p>For tables you mention that decommit is needed, but that's just a fancy way to do <code>memset</code> with zeros, right? Is the kernel doing it for us that much faster than us doing it ourselves? (not sure if this was a bottleneck in lucet, for example).</p>
<p>For malloc/free as well I'm imagining that we'd malloc the whole pool and then do custom memory management within the pool itself FWIW, rather than using malloc/free for each individual instance and table.</p>
<p>My main thinking with using malloc/free is that it's just generally a bit more portable and helps us to work with any old chunk of memory rather than something that's specificall mmap'd</p>
</blockquote>



<a name="229414973"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20Issue%20%232715%20Pooling%20instance%20allocator%3A%20use%20na.../near/229414973" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20Issue.20.232715.20Pooling.20instance.20allocator.3A.20use.20na.2E.2E.2E.html#229414973">(Mar 09 2021 at 03:15)</a>:</h4>
<p>peterhuene <a href="https://github.com/bytecodealliance/wasmtime/issues/2715#issuecomment-793315028">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/2715">Issue #2715</a>:</p>
<blockquote>
<p>Correct, it's just a fancy way to <code>memset</code> for tables, so it can be replaced with that.  It would certainly be worth benchmarking to see if managing the table pool is worth the added complexity.  Lucet doesn't implement it this way since tables are read-only and part of the compilation artifact itself iirc (that is to say, tables are not a concern of the runtime).</p>
<p>Re the portability issue, the pooling allocator needs the platform specific implementation anyway for managing the linear memory pool, so switching over the instance and table pools likely won't rid us of much platform-specific code.</p>
<p>Still, it can't hurt to investigate such a design.</p>
</blockquote>



<a name="229415017"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20Issue%20%232715%20Pooling%20instance%20allocator%3A%20use%20na.../near/229415017" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20Issue.20.232715.20Pooling.20instance.20allocator.3A.20use.20na.2E.2E.2E.html#229415017">(Mar 09 2021 at 03:16)</a>:</h4>
<p>peterhuene edited a <a href="https://github.com/bytecodealliance/wasmtime/issues/2715#issuecomment-793315028">comment</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/2715">Issue #2715</a>:</p>
<blockquote>
<p>Correct, it's just a fancy way to <code>memset</code> for tables, so it can be replaced with that.  It would certainly be worth benchmarking to see if managing the table pool is worth the added complexity.  Lucet doesn't implement it this way since tables are read-only and part of the compilation artifact itself iirc (that is to say, tables are not a concern of the runtime).</p>
<p>Re: the portability issue, the pooling allocator needs the platform specific implementation anyway for managing the linear memory pool, so switching over the instance and table pools likely won't rid us of much platform-specific code.</p>
<p>Still, it can't hurt to investigate such a design.</p>
</blockquote>



<a name="229415099"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20Issue%20%232715%20Pooling%20instance%20allocator%3A%20use%20na.../near/229415099" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20Issue.20.232715.20Pooling.20instance.20allocator.3A.20use.20na.2E.2E.2E.html#229415099">(Mar 09 2021 at 03:17)</a>:</h4>
<p>peterhuene edited a <a href="https://github.com/bytecodealliance/wasmtime/issues/2715#issuecomment-793315028">comment</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/2715">Issue #2715</a>:</p>
<blockquote>
<p>Correct, it's just a fancy way to <code>memset</code> for tables, so it can be replaced with that.  It would certainly be worth benchmarking to see if managing the table pool is worth the added complexity.  Lucet doesn't implement it this way since tables are read-only and part of the compilation artifact itself iirc (that is to say, tables are not a concern of the runtime).</p>
<p>Re: the portability issue, the pooling allocator needs the platform specific implementation anyway for managing the linear memory pool, so switching over the instance and table pools to <code>malloc</code>/<code>free</code> likely won't rid us of much platform-specific code.</p>
<p>Still, it can't hurt to investigate such a design.</p>
</blockquote>



<hr><p>Last updated: Jan 20 2025 at 06:04 UTC</p>
</html>