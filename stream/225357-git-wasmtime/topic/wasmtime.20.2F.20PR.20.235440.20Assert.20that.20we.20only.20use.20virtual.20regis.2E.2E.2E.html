<html>
<head><meta charset="utf-8"><title>wasmtime / PR #5440 Assert that we only use virtual regis... · git-wasmtime · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/index.html">git-wasmtime</a></h2>
<h3>Topic: <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.235440.20Assert.20that.20we.20only.20use.20virtual.20regis.2E.2E.2E.html">wasmtime / PR #5440 Assert that we only use virtual regis...</a></h3>

<hr>

<base href="https://bytecodealliance.zulipchat.com">

<head><link href="https://bytecodealliance.github.io/zulip-archive/style.css" rel="stylesheet"></head>

<a name="315915231"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%235440%20Assert%20that%20we%20only%20use%20virtual%20regis.../near/315915231" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.235440.20Assert.20that.20we.20only.20use.20virtual.20regis.2E.2E.2E.html#315915231">(Dec 14 2022 at 21:09)</a>:</h4>
<p>elliottt opened <a href="https://github.com/bytecodealliance/wasmtime/pull/5440">PR #5440</a> from <code>trevor/assert-virtual-regs-move</code> to <code>main</code>:</p>
<blockquote>
<p>&lt;!--</p>
<p>Please ensure that the following steps are all taken care of before submitting<br>
the PR.</p>
<ul>
<li>
<p>[ ] This has been discussed in issue #..., or if not, please tell us why<br>
  here.</p>
</li>
<li>
<p>[ ] A short description of what this does, why it is needed; if the<br>
  description becomes long, the matter should probably be discussed in an issue<br>
  first.</p>
</li>
<li>
<p>[ ] This PR contains test cases, if meaningful.</p>
</li>
<li>[ ] A reviewer from the core maintainer team has been assigned for this PR.<br>
  If you don't know who could review this, please indicate so. The list of<br>
  suggested reviewers on the right can help you.</li>
</ul>
<p>Please ensure all communication adheres to the <a href="https://github.com/bytecodealliance/wasmtime/blob/master/CODE_OF_CONDUCT.md">code of
conduct</a>.<br>
--&gt;<br>
</p>
</blockquote>



<a name="315916752"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%235440%20Assert%20that%20we%20only%20use%20virtual%20regis.../near/315916752" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.235440.20Assert.20that.20we.20only.20use.20virtual.20regis.2E.2E.2E.html#315916752">(Dec 14 2022 at 21:19)</a>:</h4>
<p>cfallin submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/5440#pullrequestreview-1218258871">PR review</a>.</p>



<a name="317022319"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%235440%20Assert%20that%20we%20only%20use%20virtual%20regis.../near/317022319" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.235440.20Assert.20that.20we.20only.20use.20virtual.20regis.2E.2E.2E.html#317022319">(Dec 20 2022 at 19:21)</a>:</h4>
<p>elliottt updated <a href="https://github.com/bytecodealliance/wasmtime/pull/5440">PR #5440</a> from <code>trevor/assert-virtual-regs-move</code> to <code>main</code>.</p>



<a name="317028097"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%235440%20Assert%20that%20we%20only%20use%20virtual%20regis.../near/317028097" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.235440.20Assert.20that.20we.20only.20use.20virtual.20regis.2E.2E.2E.html#317028097">(Dec 20 2022 at 19:50)</a>:</h4>
<p>elliottt updated <a href="https://github.com/bytecodealliance/wasmtime/pull/5440">PR #5440</a> from <code>trevor/assert-virtual-regs-move</code> to <code>main</code>.</p>



<a name="317031868"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%235440%20Assert%20that%20we%20only%20use%20virtual%20regis.../near/317031868" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.235440.20Assert.20that.20we.20only.20use.20virtual.20regis.2E.2E.2E.html#317031868">(Dec 20 2022 at 20:15)</a>:</h4>
<p><strong>elliottt</strong> requested <a href="https://github.com/cfallin">cfallin</a> for a review on <a href="https://github.com/bytecodealliance/wasmtime/pull/5440">PR #5440</a>.</p>



<a name="317032250"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%235440%20Assert%20that%20we%20only%20use%20virtual%20regis.../near/317032250" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.235440.20Assert.20that.20we.20only.20use.20virtual.20regis.2E.2E.2E.html#317032250">(Dec 20 2022 at 20:17)</a>:</h4>
<p>elliottt updated <a href="https://github.com/bytecodealliance/wasmtime/pull/5440">PR #5440</a> from <code>trevor/assert-virtual-regs-move</code> to <code>main</code>.</p>



<a name="317032369"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%235440%20Assert%20that%20we%20only%20use%20virtual%20regis.../near/317032369" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.235440.20Assert.20that.20we.20only.20use.20virtual.20regis.2E.2E.2E.html#317032369">(Dec 20 2022 at 20:18)</a>:</h4>
<p>elliottt updated <a href="https://github.com/bytecodealliance/wasmtime/pull/5440">PR #5440</a> from <code>trevor/assert-virtual-regs-move</code> to <code>main</code>.</p>



<a name="317032451"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%235440%20Assert%20that%20we%20only%20use%20virtual%20regis.../near/317032451" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.235440.20Assert.20that.20we.20only.20use.20virtual.20regis.2E.2E.2E.html#317032451">(Dec 20 2022 at 20:19)</a>:</h4>
<p><strong>elliottt</strong> has marked <a href="https://github.com/bytecodealliance/wasmtime/pull/5440">PR #5440</a> as ready for review.</p>



<a name="317051527"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%235440%20Assert%20that%20we%20only%20use%20virtual%20regis.../near/317051527" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.235440.20Assert.20that.20we.20only.20use.20virtual.20regis.2E.2E.2E.html#317051527">(Dec 20 2022 at 22:29)</a>:</h4>
<p>elliottt edited <a href="https://github.com/bytecodealliance/wasmtime/pull/5440">PR #5440</a> from <code>trevor/assert-virtual-regs-move</code> to <code>main</code>:</p>
<blockquote>
<p>Assert that we never see real registers as arguments to move instructions in <code>VCodeBuilder::collect_operands</code>.</p>
<p>Also fix a bug in the riscv64 backend that was discovered by these assertions: the lowerings of <code>get_stack_pointer</code> and <code>get_frame_pointer</code> were using physical registers 8 and 2 directly. The solution was similar to other backends: add a move instruction specifically for moving out of physical registers, whose source operand is opaque to regalloc2.<br>
&lt;!--</p>
<p>Please ensure that the following steps are all taken care of before submitting<br>
the PR.</p>
<ul>
<li>
<p>[ ] This has been discussed in issue #..., or if not, please tell us why<br>
  here.</p>
</li>
<li>
<p>[ ] A short description of what this does, why it is needed; if the<br>
  description becomes long, the matter should probably be discussed in an issue<br>
  first.</p>
</li>
<li>
<p>[ ] This PR contains test cases, if meaningful.</p>
</li>
<li>[ ] A reviewer from the core maintainer team has been assigned for this PR.<br>
  If you don't know who could review this, please indicate so. The list of<br>
  suggested reviewers on the right can help you.</li>
</ul>
<p>Please ensure all communication adheres to the <a href="https://github.com/bytecodealliance/wasmtime/blob/master/CODE_OF_CONDUCT.md">code of
conduct</a>.<br>
--&gt;<br>
</p>
</blockquote>



<a name="317056200"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%235440%20Assert%20that%20we%20only%20use%20virtual%20regis.../near/317056200" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.235440.20Assert.20that.20we.20only.20use.20virtual.20regis.2E.2E.2E.html#317056200">(Dec 20 2022 at 23:04)</a>:</h4>
<p>cfallin submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/5440#pullrequestreview-1225247762">PR review</a>.</p>



<a name="317056201"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%235440%20Assert%20that%20we%20only%20use%20virtual%20regis.../near/317056201" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.235440.20Assert.20that.20we.20only.20use.20virtual.20regis.2E.2E.2E.html#317056201">(Dec 20 2022 at 23:04)</a>:</h4>
<p>cfallin submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/5440#pullrequestreview-1225247762">PR review</a>.</p>



<a name="317056202"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%235440%20Assert%20that%20we%20only%20use%20virtual%20regis.../near/317056202" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.235440.20Assert.20that.20we.20only.20use.20virtual.20regis.2E.2E.2E.html#317056202">(Dec 20 2022 at 23:04)</a>:</h4>
<p>cfallin created <a href="https://github.com/bytecodealliance/wasmtime/pull/5440#discussion_r1053829158">PR review comment</a>:</p>
<blockquote>
<p>Can we add a note here that the <code>PReg</code> must be a non-allocatable register?</p>
</blockquote>



<a name="317056203"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%235440%20Assert%20that%20we%20only%20use%20virtual%20regis.../near/317056203" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.235440.20Assert.20that.20we.20only.20use.20virtual.20regis.2E.2E.2E.html#317056203">(Dec 20 2022 at 23:04)</a>:</h4>
<p>cfallin created <a href="https://github.com/bytecodealliance/wasmtime/pull/5440#discussion_r1053828363">PR review comment</a>:</p>
<blockquote>
<p>This generic constructor seems a little dangerous because it allows construction of <code>PReg</code> values for allocatable registers, which should not be usable; these will ideally be caught by an assertion (e.g. when handling moves) but it would be better to avoid constructing them in the first place. Could we expose specific constructors for the registers we want (e.g., <code>fp_reg</code>, <code>sp_reg</code>) here instead?</p>
</blockquote>



<a name="317056204"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%235440%20Assert%20that%20we%20only%20use%20virtual%20regis.../near/317056204" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.235440.20Assert.20that.20we.20only.20use.20virtual.20regis.2E.2E.2E.html#317056204">(Dec 20 2022 at 23:04)</a>:</h4>
<p>cfallin created <a href="https://github.com/bytecodealliance/wasmtime/pull/5440#discussion_r1053827177">PR review comment</a>:</p>
<blockquote>
<p>Inadvertent insertion/repetition?</p>
</blockquote>



<a name="317056205"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%235440%20Assert%20that%20we%20only%20use%20virtual%20regis.../near/317056205" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.235440.20Assert.20that.20we.20only.20use.20virtual.20regis.2E.2E.2E.html#317056205">(Dec 20 2022 at 23:04)</a>:</h4>
<p>cfallin created <a href="https://github.com/bytecodealliance/wasmtime/pull/5440#discussion_r1053828742">PR review comment</a>:</p>
<blockquote>
<p>Is <code>fmv.d</code> the right mnemonic here? That's a floating-point move, no?</p>
</blockquote>



<a name="317056854"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%235440%20Assert%20that%20we%20only%20use%20virtual%20regis.../near/317056854" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.235440.20Assert.20that.20we.20only.20use.20virtual.20regis.2E.2E.2E.html#317056854">(Dec 20 2022 at 23:09)</a>:</h4>
<p>elliottt created <a href="https://github.com/bytecodealliance/wasmtime/pull/5440#discussion_r1053832312">PR review comment</a>:</p>
<blockquote>
<p>Yep, thanks!</p>
</blockquote>



<a name="317056855"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%235440%20Assert%20that%20we%20only%20use%20virtual%20regis.../near/317056855" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.235440.20Assert.20that.20we.20only.20use.20virtual.20regis.2E.2E.2E.html#317056855">(Dec 20 2022 at 23:09)</a>:</h4>
<p>elliottt submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/5440#pullrequestreview-1225257589">PR review</a>.</p>



<a name="317057389"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%235440%20Assert%20that%20we%20only%20use%20virtual%20regis.../near/317057389" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.235440.20Assert.20that.20we.20only.20use.20virtual.20regis.2E.2E.2E.html#317057389">(Dec 20 2022 at 23:13)</a>:</h4>
<p>elliottt submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/5440#pullrequestreview-1225260004">PR review</a>.</p>



<a name="317057390"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%235440%20Assert%20that%20we%20only%20use%20virtual%20regis.../near/317057390" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.235440.20Assert.20that.20we.20only.20use.20virtual.20regis.2E.2E.2E.html#317057390">(Dec 20 2022 at 23:13)</a>:</h4>
<p>elliottt created <a href="https://github.com/bytecodealliance/wasmtime/pull/5440#discussion_r1053834097">PR review comment</a>:</p>
<blockquote>
<p>Good catch, I misread the F64 in the above case for Mov.</p>
</blockquote>



<a name="317058127"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%235440%20Assert%20that%20we%20only%20use%20virtual%20regis.../near/317058127" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.235440.20Assert.20that.20we.20only.20use.20virtual.20regis.2E.2E.2E.html#317058127">(Dec 20 2022 at 23:19)</a>:</h4>
<p>elliottt updated <a href="https://github.com/bytecodealliance/wasmtime/pull/5440">PR #5440</a> from <code>trevor/assert-virtual-regs-move</code> to <code>main</code>.</p>



<a name="317073888"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%235440%20Assert%20that%20we%20only%20use%20virtual%20regis.../near/317073888" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.235440.20Assert.20that.20we.20only.20use.20virtual.20regis.2E.2E.2E.html#317073888">(Dec 21 2022 at 02:22)</a>:</h4>
<p>elliottt merged <a href="https://github.com/bytecodealliance/wasmtime/pull/5440">PR #5440</a>.</p>



<hr><p>Last updated: Jan 20 2025 at 06:04 UTC</p>
</html>