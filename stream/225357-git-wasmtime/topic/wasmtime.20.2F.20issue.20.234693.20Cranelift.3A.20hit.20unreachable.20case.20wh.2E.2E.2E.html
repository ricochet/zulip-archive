<html>
<head><meta charset="utf-8"><title>wasmtime / issue #4693 Cranelift: hit unreachable case wh... · git-wasmtime · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/index.html">git-wasmtime</a></h2>
<h3>Topic: <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.234693.20Cranelift.3A.20hit.20unreachable.20case.20wh.2E.2E.2E.html">wasmtime / issue #4693 Cranelift: hit unreachable case wh...</a></h3>

<hr>

<base href="https://bytecodealliance.zulipchat.com">

<head><link href="https://bytecodealliance.github.io/zulip-archive/style.css" rel="stylesheet"></head>

<a name="293001418"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%234693%20Cranelift%3A%20hit%20unreachable%20case%20wh.../near/293001418" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.234693.20Cranelift.3A.20hit.20unreachable.20case.20wh.2E.2E.2E.html#293001418">(Aug 11 2022 at 20:12)</a>:</h4>
<p>elliottt opened <a href="https://github.com/bytecodealliance/wasmtime/issues/4693">issue #4693</a>:</p>
<blockquote>
<h3><code>.clif</code> Test Case</h3>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="n">function</span><span class="w"> </span><span class="o">%</span><span class="n">f13</span><span class="p">(</span><span class="n">f32x4</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nc">i32x4</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="n">block0</span><span class="p">(</span><span class="n">v0</span>: <span class="nc">f32x4</span><span class="p">)</span>:
  <span class="nc">v1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">fcvt_to_uint</span><span class="p">.</span><span class="n">i32x4</span><span class="w"> </span><span class="n">v0</span><span class="w"></span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="n">v1</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>
<h3>Steps to Reproduce</h3>
<p>Compiling this causes an unreachable case to be reached: <a href="https://github.com/bytecodealliance/wasmtime/blob/380db48ce6b7a754025e33bde02a8d14897376f3/cranelift/codegen/src/isa/x64/lower.rs#L800-L804">https://github.com/bytecodealliance/wasmtime/blob/380db48ce6b7a754025e33bde02a8d14897376f3/cranelift/codegen/src/isa/x64/lower.rs#L800-L804</a></p>
<h3>Expected Results</h3>
<p>Either an error or a successful compilation.</p>
<h3>Actual Results</h3>
<p>Panic</p>
<h3>Versions and Environment</h3>
<p>Cranelift version or commit: 0c2e0494bdc63518962ad2773abc13d7d1d1dd8a</p>
<p>Operating system: linux</p>
<p>Architecture: x86_64<br>
</p>
</blockquote>



<a name="293001419"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%234693%20Cranelift%3A%20hit%20unreachable%20case%20wh.../near/293001419" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.234693.20Cranelift.3A.20hit.20unreachable.20case.20wh.2E.2E.2E.html#293001419">(Aug 11 2022 at 20:12)</a>:</h4>
<p>elliottt labeled <a href="https://github.com/bytecodealliance/wasmtime/issues/4693">issue #4693</a>:</p>
<blockquote>
<h3><code>.clif</code> Test Case</h3>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="n">function</span><span class="w"> </span><span class="o">%</span><span class="n">f13</span><span class="p">(</span><span class="n">f32x4</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nc">i32x4</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="n">block0</span><span class="p">(</span><span class="n">v0</span>: <span class="nc">f32x4</span><span class="p">)</span>:
  <span class="nc">v1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">fcvt_to_uint</span><span class="p">.</span><span class="n">i32x4</span><span class="w"> </span><span class="n">v0</span><span class="w"></span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="n">v1</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>
<h3>Steps to Reproduce</h3>
<p>Compiling this causes an unreachable case to be reached: <a href="https://github.com/bytecodealliance/wasmtime/blob/380db48ce6b7a754025e33bde02a8d14897376f3/cranelift/codegen/src/isa/x64/lower.rs#L800-L804">https://github.com/bytecodealliance/wasmtime/blob/380db48ce6b7a754025e33bde02a8d14897376f3/cranelift/codegen/src/isa/x64/lower.rs#L800-L804</a></p>
<h3>Expected Results</h3>
<p>Either an error or a successful compilation.</p>
<h3>Actual Results</h3>
<p>Panic</p>
<h3>Versions and Environment</h3>
<p>Cranelift version or commit: 0c2e0494bdc63518962ad2773abc13d7d1d1dd8a</p>
<p>Operating system: linux</p>
<p>Architecture: x86_64<br>
</p>
</blockquote>



<a name="293001420"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%234693%20Cranelift%3A%20hit%20unreachable%20case%20wh.../near/293001420" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.234693.20Cranelift.3A.20hit.20unreachable.20case.20wh.2E.2E.2E.html#293001420">(Aug 11 2022 at 20:12)</a>:</h4>
<p>elliottt labeled <a href="https://github.com/bytecodealliance/wasmtime/issues/4693">issue #4693</a>:</p>
<blockquote>
<h3><code>.clif</code> Test Case</h3>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="n">function</span><span class="w"> </span><span class="o">%</span><span class="n">f13</span><span class="p">(</span><span class="n">f32x4</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nc">i32x4</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="n">block0</span><span class="p">(</span><span class="n">v0</span>: <span class="nc">f32x4</span><span class="p">)</span>:
  <span class="nc">v1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">fcvt_to_uint</span><span class="p">.</span><span class="n">i32x4</span><span class="w"> </span><span class="n">v0</span><span class="w"></span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="n">v1</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>
<h3>Steps to Reproduce</h3>
<p>Compiling this causes an unreachable case to be reached: <a href="https://github.com/bytecodealliance/wasmtime/blob/380db48ce6b7a754025e33bde02a8d14897376f3/cranelift/codegen/src/isa/x64/lower.rs#L800-L804">https://github.com/bytecodealliance/wasmtime/blob/380db48ce6b7a754025e33bde02a8d14897376f3/cranelift/codegen/src/isa/x64/lower.rs#L800-L804</a></p>
<h3>Expected Results</h3>
<p>Either an error or a successful compilation.</p>
<h3>Actual Results</h3>
<p>Panic</p>
<h3>Versions and Environment</h3>
<p>Cranelift version or commit: 0c2e0494bdc63518962ad2773abc13d7d1d1dd8a</p>
<p>Operating system: linux</p>
<p>Architecture: x86_64<br>
</p>
</blockquote>



<a name="293019044"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%234693%20Cranelift%3A%20hit%20unreachable%20case%20wh.../near/293019044" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.234693.20Cranelift.3A.20hit.20unreachable.20case.20wh.2E.2E.2E.html#293019044">(Aug 11 2022 at 22:26)</a>:</h4>
<p>jlb6740 <a href="https://github.com/bytecodealliance/wasmtime/issues/4693#issuecomment-1212557254">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/4693">issue #4693</a>:</p>
<blockquote>
<p>Hi @elliottt . Does this unreachable case get hit before patch <a href="https://github.com/bytecodealliance/wasmtime/pull/4684">https://github.com/bytecodealliance/wasmtime/pull/4684</a> ? <br>
I have not tried, but the comments here say this unreachable is guarded by both the Opcode::FcvtToUnit and Opcode::FcvtToSint. It looks like 4864 removed one of those branches and if so I wondering if that patch (removing that code) introduced the possibility of this fall through?</p>
</blockquote>



<a name="293021277"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%234693%20Cranelift%3A%20hit%20unreachable%20case%20wh.../near/293021277" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.234693.20Cranelift.3A.20hit.20unreachable.20case.20wh.2E.2E.2E.html#293021277">(Aug 11 2022 at 22:46)</a>:</h4>
<p>elliottt <a href="https://github.com/bytecodealliance/wasmtime/issues/4693#issuecomment-1212567878">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/4693">issue #4693</a>:</p>
<blockquote>
<p>I hit the panic at <code>c4fd6a95da582a4a21802d981062c9202746ef19</code>, which is the direct parent of #4684. This panic is from <code>fcvt_to_uint</code>, vs <code>fcvt_from_uint</code> which was ported to ISLE in #4684.</p>
</blockquote>



<a name="293021870"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%234693%20Cranelift%3A%20hit%20unreachable%20case%20wh.../near/293021870" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.234693.20Cranelift.3A.20hit.20unreachable.20case.20wh.2E.2E.2E.html#293021870">(Aug 11 2022 at 22:46)</a>:</h4>
<p>elliottt edited a <a href="https://github.com/bytecodealliance/wasmtime/issues/4693#issuecomment-1212567878">comment</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/4693">issue #4693</a>:</p>
<blockquote>
<p>I hit the panic at c4fd6a95da582a4a21802d981062c9202746ef19, which is the direct parent of #4684. This panic is from <code>fcvt_to_uint</code>, vs <code>fcvt_from_uint</code> which was ported to ISLE in #4684.</p>
</blockquote>



<a name="294779304"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%234693%20Cranelift%3A%20hit%20unreachable%20case%20wh.../near/294779304" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.234693.20Cranelift.3A.20hit.20unreachable.20case.20wh.2E.2E.2E.html#294779304">(Aug 22 2022 at 22:53)</a>:</h4>
<p>jlb6740 <a href="https://github.com/bytecodealliance/wasmtime/issues/4693#issuecomment-1223288319">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/4693">issue #4693</a>:</p>
<blockquote>
<p>Hi @elliottt. I went to try and reproduce this issue and noticed that I was seeing the unreachable code but not where this original bug filing notes it. Looks like code has changed with <a href="https://github.com/bytecodealliance/wasmtime/pull/4704">https://github.com/bytecodealliance/wasmtime/pull/4704</a>. Was that patch supposed to resolve this issue? I can reproduce still with this file:</p>
<blockquote>
<p>test run<br>
target x86_64</p>
<p>function %f13(f32x4) -&gt; i32x4 {<br>
block0(v0: f32x4):<br>
  v1 = fcvt_to_uint.i32x4 v0<br>
  return v1<br>
}</p>
<p>; run: %f13([0x1.0 0.0 0x1.0 0x75bcd18.0]) == [1 0 1 123456789])</p>
</blockquote>
<p>run with: </p>
<p>RUST_BACKTRACE=1 ./target/debug/clif-util test cranelift/filetests/filetests/runtests/test.clif</p>
</blockquote>



<a name="294781609"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%234693%20Cranelift%3A%20hit%20unreachable%20case%20wh.../near/294781609" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.234693.20Cranelift.3A.20hit.20unreachable.20case.20wh.2E.2E.2E.html#294781609">(Aug 22 2022 at 23:12)</a>:</h4>
<p>jlb6740 deleted a <a href="https://github.com/bytecodealliance/wasmtime/issues/4693#issuecomment-1223288319">comment</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/4693">issue #4693</a>:</p>
<blockquote>
<p>Hi @elliottt. I went to try and reproduce this issue and noticed that I was seeing the unreachable code but not where this original bug filing notes it. Looks like code has changed with <a href="https://github.com/bytecodealliance/wasmtime/pull/4704">https://github.com/bytecodealliance/wasmtime/pull/4704</a>. Was that patch supposed to resolve this issue? I can reproduce still with this file:</p>
<blockquote>
<p>test run<br>
target x86_64</p>
<p>function %f13(f32x4) -&gt; i32x4 {<br>
block0(v0: f32x4):<br>
  v1 = fcvt_to_uint.i32x4 v0<br>
  return v1<br>
}</p>
<p>; run: %f13([0x1.0 0.0 0x1.0 0x75bcd18.0]) == [1 0 1 123456789])</p>
</blockquote>
<p>run with: </p>
<p>RUST_BACKTRACE=1 ./target/debug/clif-util test cranelift/filetests/filetests/runtests/test.clif</p>
</blockquote>



<a name="295936088"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%234693%20Cranelift%3A%20hit%20unreachable%20case%20wh.../near/295936088" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.234693.20Cranelift.3A.20hit.20unreachable.20case.20wh.2E.2E.2E.html#295936088">(Aug 29 2022 at 15:40)</a>:</h4>
<p>abrown closed <a href="https://github.com/bytecodealliance/wasmtime/issues/4693">issue #4693</a>:</p>
<blockquote>
<h3><code>.clif</code> Test Case</h3>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="n">function</span><span class="w"> </span><span class="o">%</span><span class="n">f13</span><span class="p">(</span><span class="n">f32x4</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nc">i32x4</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="n">block0</span><span class="p">(</span><span class="n">v0</span>: <span class="nc">f32x4</span><span class="p">)</span>:
  <span class="nc">v1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">fcvt_to_uint</span><span class="p">.</span><span class="n">i32x4</span><span class="w"> </span><span class="n">v0</span><span class="w"></span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="n">v1</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>
<h3>Steps to Reproduce</h3>
<p>Compiling this causes an unreachable case to be reached: <a href="https://github.com/bytecodealliance/wasmtime/blob/380db48ce6b7a754025e33bde02a8d14897376f3/cranelift/codegen/src/isa/x64/lower.rs#L800-L804">https://github.com/bytecodealliance/wasmtime/blob/380db48ce6b7a754025e33bde02a8d14897376f3/cranelift/codegen/src/isa/x64/lower.rs#L800-L804</a></p>
<h3>Expected Results</h3>
<p>Either an error or a successful compilation.</p>
<h3>Actual Results</h3>
<p>Panic</p>
<h3>Versions and Environment</h3>
<p>Cranelift version or commit: 0c2e0494bdc63518962ad2773abc13d7d1d1dd8a</p>
<p>Operating system: linux</p>
<p>Architecture: x86_64<br>
</p>
</blockquote>



<hr><p>Last updated: Jan 20 2025 at 06:04 UTC</p>
</html>