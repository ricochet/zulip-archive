<html>
<head><meta charset="utf-8"><title>wasmtime / issue #7266 `wasi:http` bleeding into the prev... · git-wasmtime · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/index.html">git-wasmtime</a></h2>
<h3>Topic: <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.237266.20.60wasi.3Ahttp.60.20bleeding.20into.20the.20prev.2E.2E.2E.html">wasmtime / issue #7266 `wasi:http` bleeding into the prev...</a></h3>

<hr>

<base href="https://bytecodealliance.zulipchat.com">

<head><link href="https://bytecodealliance.github.io/zulip-archive/style.css" rel="stylesheet"></head>

<a name="397098578"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%237266%20%60wasi%3Ahttp%60%20bleeding%20into%20the%20prev.../near/397098578" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.237266.20.60wasi.3Ahttp.60.20bleeding.20into.20the.20prev.2E.2E.2E.html#397098578">(Oct 17 2023 at 12:32)</a>:</h4>
<p><a href="https://github.com/rvolosatovs">rvolosatovs</a> added the bug label to <a href="https://github.com/bytecodealliance/wasmtime/issues/7266">Issue #7266</a>.</p>



<a name="397098579"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%237266%20%60wasi%3Ahttp%60%20bleeding%20into%20the%20prev.../near/397098579" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.237266.20.60wasi.3Ahttp.60.20bleeding.20into.20the.20prev.2E.2E.2E.html#397098579">(Oct 17 2023 at 12:32)</a>:</h4>
<p>rvolosatovs opened <a href="https://github.com/bytecodealliance/wasmtime/issues/7266">issue #7266</a>:</p>
<blockquote>
<h3>Test Case</h3>
<p><a href="https://github.com/rvolosatovs/wasmtime-adapter-http-repro">https://github.com/rvolosatovs/wasmtime-adapter-http-repro</a></p>
<h3>Steps to Reproduce</h3>
<ul>
<li>clone <a href="https://github.com/rvolosatovs/wasmtime-adapter-http-repro">https://github.com/rvolosatovs/wasmtime-adapter-http-repro</a></li>
<li><code>curl -sL https://github.com/bytecodealliance/wasmtime/releases/download/dev/wasi_snapshot_preview1.reactor.wasm | cargo run</code></li>
</ul>
<h3>Expected Results</h3>
<p>Success, especially because <code>wasm-tools print</code> suggests no <code>incoming-body</code> type exists in the adapter</p>
<h3>Actual Results</h3>
<p>Failure to encode a component</p>
<h3>Versions and Environment</h3>
<p><code>dev</code> (9e4d44626a008f8a1b1b3b4a48f0d5693185844b)</p>
<p>Operating system: linux</p>
<p>Architecture: x86_64</p>
<h3>Extra Info</h3>
<p>We have seen this issue before @dicej @alexcrichton @pchickey, it appeared that it was fixed, but perhaps that was because the component and adapter definitions happened to be in sync during testing.</p>
</blockquote>



<a name="397102582"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%237266%20%60wasi%3Ahttp%60%20bleeding%20into%20the%20prev.../near/397102582" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.237266.20.60wasi.3Ahttp.60.20bleeding.20into.20the.20prev.2E.2E.2E.html#397102582">(Oct 17 2023 at 12:54)</a>:</h4>
<p>rvolosatovs edited <a href="https://github.com/bytecodealliance/wasmtime/issues/7266">issue #7266</a>:</p>
<blockquote>
<h3>Test Case</h3>
<p><a href="https://github.com/rvolosatovs/wasmtime-adapter-http-repro">https://github.com/rvolosatovs/wasmtime-adapter-http-repro</a></p>
<h3>Steps to Reproduce</h3>
<ul>
<li>clone <a href="https://github.com/rvolosatovs/wasmtime-adapter-http-repro">https://github.com/rvolosatovs/wasmtime-adapter-http-repro</a></li>
<li><code>curl -sL https://github.com/bytecodealliance/wasmtime/releases/download/dev/wasi_snapshot_preview1.reactor.wasm | cargo run</code></li>
</ul>
<h3>Expected Results</h3>
<p>Success, especially because <code>wasm-tools print</code> suggests no <code>incoming-body</code> type exists in the adapter</p>
<h3>Actual Results</h3>
<p>Failure to encode a component</p>
<h3>Versions and Environment</h3>
<p><code>dev</code> (9e4d44626a008f8a1b1b3b4a48f0d5693185844b)</p>
<p>Operating system: linux</p>
<p>Architecture: x86_64</p>
<h3>Extra Info</h3>
<p>We have seen this issue before @dicej @alexcrichton @pchickey, it appeared that it was fixed, but perhaps that was because the component and adapter definitions happened to be in sync during testing.</p>
</blockquote>



<a name="397132551"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%237266%20%60wasi%3Ahttp%60%20bleeding%20into%20the%20prev.../near/397132551" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.237266.20.60wasi.3Ahttp.60.20bleeding.20into.20the.20prev.2E.2E.2E.html#397132551">(Oct 17 2023 at 15:21)</a>:</h4>
<p>alexcrichton <a href="https://github.com/bytecodealliance/wasmtime/issues/7266#issuecomment-1766641380">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/7266">issue #7266</a>:</p>
<blockquote>
<p>Looking into this the issue appears to be:</p>
<ul>
<li>The <code>Resolve</code> for the world used to create the adapter has <code>wasi:http</code> in it. This is because the <code>wasmtime:wasi</code> package that's used to pull everything together has worlds in it that depend on <code>wasi:http</code>.</li>
<li>When the adapter is produced the <code>wasmtime:wasi</code> package is serialized into binary and embedded within the adapter itself.</li>
<li>When the adapter is processed by <code>wit-component</code> it will deserialize this information into an entire <code>Resolve</code> and then merge it with the target resolve.</li>
</ul>
<p>This means that even though the adapter itself doesn't use the <code>wasi:http</code> interfaces the merge step of two <code>Resolve</code> items still attempts to merge them together. The best fix that I can think of is to filter out items during the encoding phase so only the relevant types are encoded, namely just the <code>wasmtime:wasi/preview1-adapter-reactor</code> world for example. Such filtering should remove the encoding of <code>wasi:http</code> types and interfaces, meaning they'll be entirely gone from the adapter.</p>
<p>Such a change must happen in <code>wit-component</code> in the <code>wasm-tools</code> repository. I'll wait for <a href="https://github.com/bytecodealliance/wasm-tools/pull/1252">https://github.com/bytecodealliance/wasm-tools/pull/1252</a> to finish before implementing this.</p>
</blockquote>



<a name="397758952"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%237266%20%60wasi%3Ahttp%60%20bleeding%20into%20the%20prev.../near/397758952" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.237266.20.60wasi.3Ahttp.60.20bleeding.20into.20the.20prev.2E.2E.2E.html#397758952">(Oct 20 2023 at 18:34)</a>:</h4>
<p>alexcrichton <a href="https://github.com/bytecodealliance/wasmtime/issues/7266#issuecomment-1773211960">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/7266">issue #7266</a>:</p>
<blockquote>
<p>Ok I've looked again at this and this should be solved by <a href="https://github.com/bytecodealliance/wasm-tools/pull/1260">https://github.com/bytecodealliance/wasm-tools/pull/1260</a>. The issue doesn't actually reproduce as-is today due to the introduction of versions on <code>main</code> which means merging now succeeds, but I've tested <code>main</code> just before versions came in and was able to reproduce this issue and test that <a href="https://github.com/bytecodealliance/wasm-tools/pull/1260">https://github.com/bytecodealliance/wasm-tools/pull/1260</a> fixes things.</p>
<p>The fix there will be a bit delayed due to the fact that we'll have it off-by-default for a bit. Eventually down the road we'll switch the adapter to using the new metadata format by default, but until that point this bug will still be present. You can compile your own adapter, however, and specify <code>WIT_COMPONENT_NEW_ENCODE=1</code> to build an adapter with the new format to fix this issue. This does depend on all pices of the system using an updated <code>wit-component</code>, however.</p>
</blockquote>



<a name="429547224"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%237266%20%60wasi%3Ahttp%60%20bleeding%20into%20the%20prev.../near/429547224" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.237266.20.60wasi.3Ahttp.60.20bleeding.20into.20the.20prev.2E.2E.2E.html#429547224">(Mar 26 2024 at 03:17)</a>:</h4>
<p>alexcrichton closed <a href="https://github.com/bytecodealliance/wasmtime/issues/7266">issue #7266</a>:</p>
<blockquote>
<h3>Test Case</h3>
<p><a href="https://github.com/rvolosatovs/wasmtime-adapter-http-repro">https://github.com/rvolosatovs/wasmtime-adapter-http-repro</a></p>
<h3>Steps to Reproduce</h3>
<ul>
<li>clone <a href="https://github.com/rvolosatovs/wasmtime-adapter-http-repro">https://github.com/rvolosatovs/wasmtime-adapter-http-repro</a></li>
<li><code>curl -sL https://github.com/bytecodealliance/wasmtime/releases/download/dev/wasi_snapshot_preview1.reactor.wasm | cargo run</code></li>
</ul>
<h3>Expected Results</h3>
<p>Success, especially because <code>wasm-tools print</code> suggests no <code>incoming-body</code> type exists in the adapter</p>
<h3>Actual Results</h3>
<p>Failure to encode a component</p>
<h3>Versions and Environment</h3>
<p><code>dev</code> (9e4d44626a008f8a1b1b3b4a48f0d5693185844b)</p>
<p>Operating system: linux</p>
<p>Architecture: x86_64</p>
<h3>Extra Info</h3>
<p>We have seen this issue before @dicej @alexcrichton @pchickey, it appeared that it was fixed, but perhaps that was because the component and adapter definitions happened to be in sync during testing.</p>
</blockquote>



<a name="429547225"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%237266%20%60wasi%3Ahttp%60%20bleeding%20into%20the%20prev.../near/429547225" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.237266.20.60wasi.3Ahttp.60.20bleeding.20into.20the.20prev.2E.2E.2E.html#429547225">(Mar 26 2024 at 03:17)</a>:</h4>
<p>alexcrichton <a href="https://github.com/bytecodealliance/wasmtime/issues/7266#issuecomment-2019309337">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/7266">issue #7266</a>:</p>
<blockquote>
<p>I believe this has since been fixed, so closing.</p>
</blockquote>



<hr><p>Last updated: Jan 20 2025 at 06:04 UTC</p>
</html>