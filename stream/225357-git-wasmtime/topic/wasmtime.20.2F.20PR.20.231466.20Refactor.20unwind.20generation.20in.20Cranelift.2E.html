<html>
<head><meta charset="utf-8"><title>wasmtime / PR #1466 Refactor unwind generation in Cranelift. · git-wasmtime · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/index.html">git-wasmtime</a></h2>
<h3>Topic: <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231466.20Refactor.20unwind.20generation.20in.20Cranelift.2E.html">wasmtime / PR #1466 Refactor unwind generation in Cranelift.</a></h3>

<hr>

<base href="https://bytecodealliance.zulipchat.com">

<head><link href="https://bytecodealliance.github.io/zulip-archive/style.css" rel="stylesheet"></head>

<a name="192862718"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231466%20Refactor%20unwind%20generation%20in%20Cranelift./near/192862718" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231466.20Refactor.20unwind.20generation.20in.20Cranelift.2E.html#192862718">(Apr 03 2020 at 20:55)</a>:</h4>
<p>peterhuene opened <a href="https://github.com/bytecodealliance/wasmtime/pull/1466" title="https://github.com/bytecodealliance/wasmtime/pull/1466">PR #1466</a> from <code>fix-unwind-emit</code> to <code>master</code>:</p>
<blockquote>
<p>This commit makes the following changes to unwind information generation in<br>
Cranelift:</p>
<ul>
<li>
<p>Remove frame layout change implementation in favor of processing the prologue<br>
  and epilogue instructions when unwind information is requested.  This also<br>
  means this work is no longer performed for Windows, which didn't utilize it.<br>
  It also helps simplify the prologue and epilogue generation code.</p>
</li>
<li>
<p>Remove the unwind sink implementation that required each unwind information<br>
  to be represented in final form. For FDEs, this meant writing a<br>
  complete frame table per function, which wastes 20 bytes or so for each<br>
  function with duplicate CIEs.  This also enables Cranelift users to collect the<br>
  unwind information and write it as a single frame table.</p>
</li>
<li>
<p>For System V calling convention, the unwind information is no longer stored<br>
  in code memory (it's only a requirement for Windows ABI to do so).  This allows<br>
  for more compact code memory for modules with a lot of functions.</p>
</li>
<li>
<p>Deletes some duplicate code relating to frame table generation.  Users can<br>
  now simply use gimli to create a frame table from each function's unwind<br>
  information.</p>
</li>
</ul>
<p>Fixes #1181.</p>
</blockquote>



<a name="192862733"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231466%20Refactor%20unwind%20generation%20in%20Cranelift./near/192862733" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231466.20Refactor.20unwind.20generation.20in.20Cranelift.2E.html#192862733">(Apr 03 2020 at 20:55)</a>:</h4>
<p>peterhuene edited <a href="https://github.com/bytecodealliance/wasmtime/pull/1466" title="https://github.com/bytecodealliance/wasmtime/pull/1466">PR #1466</a> from <code>fix-unwind-emit</code> to <code>master</code>:</p>
<blockquote>
<p>This PR makes the following changes to unwind information generation in<br>
Cranelift:</p>
<ul>
<li>
<p>Remove frame layout change implementation in favor of processing the prologue<br>
  and epilogue instructions when unwind information is requested.  This also<br>
  means this work is no longer performed for Windows, which didn't utilize it.<br>
  It also helps simplify the prologue and epilogue generation code.</p>
</li>
<li>
<p>Remove the unwind sink implementation that required each unwind information<br>
  to be represented in final form. For FDEs, this meant writing a<br>
  complete frame table per function, which wastes 20 bytes or so for each<br>
  function with duplicate CIEs.  This also enables Cranelift users to collect the<br>
  unwind information and write it as a single frame table.</p>
</li>
<li>
<p>For System V calling convention, the unwind information is no longer stored<br>
  in code memory (it's only a requirement for Windows ABI to do so).  This allows<br>
  for more compact code memory for modules with a lot of functions.</p>
</li>
<li>
<p>Deletes some duplicate code relating to frame table generation.  Users can<br>
  now simply use gimli to create a frame table from each function's unwind<br>
  information.</p>
</li>
</ul>
<p>Fixes #1181.</p>
</blockquote>



<a name="192862908"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231466%20Refactor%20unwind%20generation%20in%20Cranelift./near/192862908" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231466.20Refactor.20unwind.20generation.20in.20Cranelift.2E.html#192862908">(Apr 03 2020 at 20:56)</a>:</h4>
<p><strong>peterhuene</strong> requested <a href="https://github.com/yurydelendik" title="https://github.com/yurydelendik">yurydelendik</a> for a review on <a href="https://github.com/bytecodealliance/wasmtime/pull/1466" title="https://github.com/bytecodealliance/wasmtime/pull/1466">PR #1466</a>.</p>



<a name="192864297"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231466%20Refactor%20unwind%20generation%20in%20Cranelift./near/192864297" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231466.20Refactor.20unwind.20generation.20in.20Cranelift.2E.html#192864297">(Apr 03 2020 at 21:09)</a>:</h4>
<p>peterhuene updated <a href="https://github.com/bytecodealliance/wasmtime/pull/1466" title="https://github.com/bytecodealliance/wasmtime/pull/1466">PR #1466</a> from <code>fix-unwind-emit</code> to <code>master</code>:</p>
<blockquote>
<p>This PR makes the following changes to unwind information generation in<br>
Cranelift:</p>
<ul>
<li>
<p>Remove frame layout change implementation in favor of processing the prologue<br>
  and epilogue instructions when unwind information is requested.  This also<br>
  means this work is no longer performed for Windows, which didn't utilize it.<br>
  It also helps simplify the prologue and epilogue generation code.</p>
</li>
<li>
<p>Remove the unwind sink implementation that required each unwind information<br>
  to be represented in final form. For FDEs, this meant writing a<br>
  complete frame table per function, which wastes 20 bytes or so for each<br>
  function with duplicate CIEs.  This also enables Cranelift users to collect the<br>
  unwind information and write it as a single frame table.</p>
</li>
<li>
<p>For System V calling convention, the unwind information is no longer stored<br>
  in code memory (it's only a requirement for Windows ABI to do so).  This allows<br>
  for more compact code memory for modules with a lot of functions.</p>
</li>
<li>
<p>Deletes some duplicate code relating to frame table generation.  Users can<br>
  now simply use gimli to create a frame table from each function's unwind<br>
  information.</p>
</li>
</ul>
<p>Fixes #1181.</p>
</blockquote>



<a name="192867938"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231466%20Refactor%20unwind%20generation%20in%20Cranelift./near/192867938" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231466.20Refactor.20unwind.20generation.20in.20Cranelift.2E.html#192867938">(Apr 03 2020 at 21:48)</a>:</h4>
<p>peterhuene updated <a href="https://github.com/bytecodealliance/wasmtime/pull/1466" title="https://github.com/bytecodealliance/wasmtime/pull/1466">PR #1466</a> from <code>fix-unwind-emit</code> to <code>master</code>:</p>
<blockquote>
<p>This PR makes the following changes to unwind information generation in<br>
Cranelift:</p>
<ul>
<li>
<p>Remove frame layout change implementation in favor of processing the prologue<br>
  and epilogue instructions when unwind information is requested.  This also<br>
  means this work is no longer performed for Windows, which didn't utilize it.<br>
  It also helps simplify the prologue and epilogue generation code.</p>
</li>
<li>
<p>Remove the unwind sink implementation that required each unwind information<br>
  to be represented in final form. For FDEs, this meant writing a<br>
  complete frame table per function, which wastes 20 bytes or so for each<br>
  function with duplicate CIEs.  This also enables Cranelift users to collect the<br>
  unwind information and write it as a single frame table.</p>
</li>
<li>
<p>For System V calling convention, the unwind information is no longer stored<br>
  in code memory (it's only a requirement for Windows ABI to do so).  This allows<br>
  for more compact code memory for modules with a lot of functions.</p>
</li>
<li>
<p>Deletes some duplicate code relating to frame table generation.  Users can<br>
  now simply use gimli to create a frame table from each function's unwind<br>
  information.</p>
</li>
</ul>
<p>Fixes #1181.</p>
</blockquote>



<a name="192871327"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231466%20Refactor%20unwind%20generation%20in%20Cranelift./near/192871327" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231466.20Refactor.20unwind.20generation.20in.20Cranelift.2E.html#192871327">(Apr 03 2020 at 22:26)</a>:</h4>
<p>peterhuene updated <a href="https://github.com/bytecodealliance/wasmtime/pull/1466" title="https://github.com/bytecodealliance/wasmtime/pull/1466">PR #1466</a> from <code>fix-unwind-emit</code> to <code>master</code>:</p>
<blockquote>
<p>This PR makes the following changes to unwind information generation in<br>
Cranelift:</p>
<ul>
<li>
<p>Remove frame layout change implementation in favor of processing the prologue<br>
  and epilogue instructions when unwind information is requested.  This also<br>
  means this work is no longer performed for Windows, which didn't utilize it.<br>
  It also helps simplify the prologue and epilogue generation code.</p>
</li>
<li>
<p>Remove the unwind sink implementation that required each unwind information<br>
  to be represented in final form. For FDEs, this meant writing a<br>
  complete frame table per function, which wastes 20 bytes or so for each<br>
  function with duplicate CIEs.  This also enables Cranelift users to collect the<br>
  unwind information and write it as a single frame table.</p>
</li>
<li>
<p>For System V calling convention, the unwind information is no longer stored<br>
  in code memory (it's only a requirement for Windows ABI to do so).  This allows<br>
  for more compact code memory for modules with a lot of functions.</p>
</li>
<li>
<p>Deletes some duplicate code relating to frame table generation.  Users can<br>
  now simply use gimli to create a frame table from each function's unwind<br>
  information.</p>
</li>
</ul>
<p>Fixes #1181.</p>
</blockquote>



<a name="192872494"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231466%20Refactor%20unwind%20generation%20in%20Cranelift./near/192872494" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231466.20Refactor.20unwind.20generation.20in.20Cranelift.2E.html#192872494">(Apr 03 2020 at 22:41)</a>:</h4>
<p>peterhuene updated <a href="https://github.com/bytecodealliance/wasmtime/pull/1466" title="https://github.com/bytecodealliance/wasmtime/pull/1466">PR #1466</a> from <code>fix-unwind-emit</code> to <code>master</code>:</p>
<blockquote>
<p>This PR makes the following changes to unwind information generation in<br>
Cranelift:</p>
<ul>
<li>
<p>Remove frame layout change implementation in favor of processing the prologue<br>
  and epilogue instructions when unwind information is requested.  This also<br>
  means this work is no longer performed for Windows, which didn't utilize it.<br>
  It also helps simplify the prologue and epilogue generation code.</p>
</li>
<li>
<p>Remove the unwind sink implementation that required each unwind information<br>
  to be represented in final form. For FDEs, this meant writing a<br>
  complete frame table per function, which wastes 20 bytes or so for each<br>
  function with duplicate CIEs.  This also enables Cranelift users to collect the<br>
  unwind information and write it as a single frame table.</p>
</li>
<li>
<p>For System V calling convention, the unwind information is no longer stored<br>
  in code memory (it's only a requirement for Windows ABI to do so).  This allows<br>
  for more compact code memory for modules with a lot of functions.</p>
</li>
<li>
<p>Deletes some duplicate code relating to frame table generation.  Users can<br>
  now simply use gimli to create a frame table from each function's unwind<br>
  information.</p>
</li>
</ul>
<p>Fixes #1181.</p>
</blockquote>



<a name="193361291"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231466%20Refactor%20unwind%20generation%20in%20Cranelift./near/193361291" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231466.20Refactor.20unwind.20generation.20in.20Cranelift.2E.html#193361291">(Apr 08 2020 at 18:39)</a>:</h4>
<p>peterhuene edited <a href="https://github.com/bytecodealliance/wasmtime/pull/1466" title="https://github.com/bytecodealliance/wasmtime/pull/1466">PR #1466</a> from <code>fix-unwind-emit</code> to <code>master</code>:</p>
<blockquote>
<p>This PR makes the following changes to unwind information generation in<br>
Cranelift:</p>
<ul>
<li>
<p>Remove frame layout change implementation in favor of processing the prologue<br>
  and epilogue instructions when unwind information is requested.  This also<br>
  means this work is no longer performed for Windows, which didn't utilize it.<br>
  It also helps simplify the prologue and epilogue generation code.</p>
</li>
<li>
<p>Remove the unwind sink implementation that required each unwind information<br>
  to be represented in final form. For FDEs, this meant writing a<br>
  complete frame table per function, which wastes 20 bytes or so for each<br>
  function with duplicate CIEs.  This also enables Cranelift users to collect the<br>
  unwind information and write it as a single frame table.</p>
</li>
<li>
<p>For System V calling convention in Wasmtime, the unwind information is no longer stored<br>
  in code memory (it's only a requirement for Windows ABI to do so).  This allows<br>
  for more compact code memory for modules with a lot of functions.</p>
</li>
<li>
<p>Deletes some duplicate code relating to frame table generation.  Users can<br>
  now simply use gimli to create a frame table from each function's unwind<br>
  information.</p>
</li>
</ul>
<p>Fixes #1181.</p>
</blockquote>



<a name="193374662"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231466%20Refactor%20unwind%20generation%20in%20Cranelift./near/193374662" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231466.20Refactor.20unwind.20generation.20in.20Cranelift.2E.html#193374662">(Apr 08 2020 at 20:30)</a>:</h4>
<p>abrown created <a href="https://github.com/bytecodealliance/wasmtime/pull/1466#discussion_r405795575" title="https://github.com/bytecodealliance/wasmtime/pull/1466#discussion_r405795575">PR Review Comment</a>:</p>
<blockquote>
<p>I think this might suffer from the same problem of #1471: when compiling for ARM, this block will be ignored and <code>map_reg</code> won't exist over in <code>wasmtime-environ</code> and <code>wasmtime-debug</code>. I guess we have the same options I mentioned in that issue:</p>
<blockquote>
<ol>
<li>to just get the ARM building, I could remove the feature flag on x86; then users encounter a runtime error if they try to use this FDE functionality but at least it compiles</li>
<li>to make map_reg functional on other platforms, we could either move map_reg out of the x86 module or create separate map_reg functions in all of the ISA modules.</li>
</ol>
</blockquote>
</blockquote>



<a name="193374663"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231466%20Refactor%20unwind%20generation%20in%20Cranelift./near/193374663" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231466.20Refactor.20unwind.20generation.20in.20Cranelift.2E.html#193374663">(Apr 08 2020 at 20:30)</a>:</h4>
<p>abrown submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/1466#pullrequestreview-390308539" title="https://github.com/bytecodealliance/wasmtime/pull/1466#pullrequestreview-390308539">PR Review</a>.</p>



<a name="193375687"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231466%20Refactor%20unwind%20generation%20in%20Cranelift./near/193375687" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231466.20Refactor.20unwind.20generation.20in.20Cranelift.2E.html#193375687">(Apr 08 2020 at 20:39)</a>:</h4>
<p>peterhuene created <a href="https://github.com/bytecodealliance/wasmtime/pull/1466#discussion_r405800591" title="https://github.com/bytecodealliance/wasmtime/pull/1466#discussion_r405800591">PR Review Comment</a>:</p>
<blockquote>
<p>Ah, I missed that it was in wasmtime-environ and not in the cranelift build.  I like the second solution, perhaps with a default implementation that errors with a new <code>RegisterMappingError</code> indicating the ISA doesn't support gimli register mapping?</p>
</blockquote>



<a name="193375688"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231466%20Refactor%20unwind%20generation%20in%20Cranelift./near/193375688" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231466.20Refactor.20unwind.20generation.20in.20Cranelift.2E.html#193375688">(Apr 08 2020 at 20:39)</a>:</h4>
<p>peterhuene submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/1466#pullrequestreview-390314630" title="https://github.com/bytecodealliance/wasmtime/pull/1466#pullrequestreview-390314630">PR Review</a>.</p>



<a name="193375749"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231466%20Refactor%20unwind%20generation%20in%20Cranelift./near/193375749" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231466.20Refactor.20unwind.20generation.20in.20Cranelift.2E.html#193375749">(Apr 08 2020 at 20:40)</a>:</h4>
<p>peterhuene edited <a href="https://github.com/bytecodealliance/wasmtime/pull/1466#discussion_r405800591" title="https://github.com/bytecodealliance/wasmtime/pull/1466#discussion_r405800591">PR Review Comment</a>.</p>



<a name="193375820"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231466%20Refactor%20unwind%20generation%20in%20Cranelift./near/193375820" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231466.20Refactor.20unwind.20generation.20in.20Cranelift.2E.html#193375820">(Apr 08 2020 at 20:41)</a>:</h4>
<p>peterhuene submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/1466#pullrequestreview-390315409" title="https://github.com/bytecodealliance/wasmtime/pull/1466#pullrequestreview-390315409">PR Review</a>.</p>



<a name="193375823"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231466%20Refactor%20unwind%20generation%20in%20Cranelift./near/193375823" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231466.20Refactor.20unwind.20generation.20in.20Cranelift.2E.html#193375823">(Apr 08 2020 at 20:41)</a>:</h4>
<p>peterhuene created <a href="https://github.com/bytecodealliance/wasmtime/pull/1466#discussion_r405801228" title="https://github.com/bytecodealliance/wasmtime/pull/1466#discussion_r405801228">PR Review Comment</a>:</p>
<blockquote>
<p>Going to resolve this and take the conversation back to #1471.</p>
</blockquote>



<a name="193831848"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231466%20Refactor%20unwind%20generation%20in%20Cranelift./near/193831848" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231466.20Refactor.20unwind.20generation.20in.20Cranelift.2E.html#193831848">(Apr 13 2020 at 22:56)</a>:</h4>
<p>peterhuene updated <a href="https://github.com/bytecodealliance/wasmtime/pull/1466" title="https://github.com/bytecodealliance/wasmtime/pull/1466">PR #1466</a> from <code>fix-unwind-emit</code> to <code>master</code>:</p>
<blockquote>
<p>This PR makes the following changes to unwind information generation in<br>
Cranelift:</p>
<ul>
<li>
<p>Remove frame layout change implementation in favor of processing the prologue<br>
  and epilogue instructions when unwind information is requested.  This also<br>
  means this work is no longer performed for Windows, which didn't utilize it.<br>
  It also helps simplify the prologue and epilogue generation code.</p>
</li>
<li>
<p>Remove the unwind sink implementation that required each unwind information<br>
  to be represented in final form. For FDEs, this meant writing a<br>
  complete frame table per function, which wastes 20 bytes or so for each<br>
  function with duplicate CIEs.  This also enables Cranelift users to collect the<br>
  unwind information and write it as a single frame table.</p>
</li>
<li>
<p>For System V calling convention in Wasmtime, the unwind information is no longer stored<br>
  in code memory (it's only a requirement for Windows ABI to do so).  This allows<br>
  for more compact code memory for modules with a lot of functions.</p>
</li>
<li>
<p>Deletes some duplicate code relating to frame table generation.  Users can<br>
  now simply use gimli to create a frame table from each function's unwind<br>
  information.</p>
</li>
</ul>
<p>Fixes #1181.</p>
</blockquote>



<a name="193958033"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231466%20Refactor%20unwind%20generation%20in%20Cranelift./near/193958033" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231466.20Refactor.20unwind.20generation.20in.20Cranelift.2E.html#193958033">(Apr 14 2020 at 21:14)</a>:</h4>
<p>peterhuene assigned <a href="https://github.com/bytecodealliance/wasmtime/pull/1466" title="https://github.com/bytecodealliance/wasmtime/pull/1466">PR #1466</a> to yurydelendik.</p>



<a name="193958044"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231466%20Refactor%20unwind%20generation%20in%20Cranelift./near/193958044" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231466.20Refactor.20unwind.20generation.20in.20Cranelift.2E.html#193958044">(Apr 14 2020 at 21:14)</a>:</h4>
<p><strong>peterhuene</strong> requested <a href="https://github.com/bnjbvr" title="https://github.com/bnjbvr">bnjbvr</a> and <a href="https://github.com/yurydelendik" title="https://github.com/yurydelendik">yurydelendik</a> for a review on <a href="https://github.com/bytecodealliance/wasmtime/pull/1466" title="https://github.com/bytecodealliance/wasmtime/pull/1466">PR #1466</a>.</p>



<a name="194053958"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231466%20Refactor%20unwind%20generation%20in%20Cranelift./near/194053958" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231466.20Refactor.20unwind.20generation.20in.20Cranelift.2E.html#194053958">(Apr 15 2020 at 16:06)</a>:</h4>
<p>yurydelendik submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/1466#pullrequestreview-393921926" title="https://github.com/bytecodealliance/wasmtime/pull/1466#pullrequestreview-393921926">PR Review</a>.</p>



<a name="194053959"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231466%20Refactor%20unwind%20generation%20in%20Cranelift./near/194053959" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231466.20Refactor.20unwind.20generation.20in.20Cranelift.2E.html#194053959">(Apr 15 2020 at 16:06)</a>:</h4>
<p>yurydelendik created <a href="https://github.com/bytecodealliance/wasmtime/pull/1466#discussion_r408960504" title="https://github.com/bytecodealliance/wasmtime/pull/1466#discussion_r408960504">PR Review Comment</a>:</p>
<blockquote>
<p>Here and near <code>map_reg</code> in this file, we need to avoid <code>panic</code>. It maybe reasonable to just skip the operation if register is unknown to DWARF (I don't think we can create a fallback <code>CallFrameInstruction</code>).</p>
</blockquote>



<a name="194214055"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231466%20Refactor%20unwind%20generation%20in%20Cranelift./near/194214055" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231466.20Refactor.20unwind.20generation.20in.20Cranelift.2E.html#194214055">(Apr 15 2020 at 19:14)</a>:</h4>
<p>peterhuene submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/1466#pullrequestreview-394061799" title="https://github.com/bytecodealliance/wasmtime/pull/1466#pullrequestreview-394061799">PR Review</a>.</p>



<a name="194214056"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231466%20Refactor%20unwind%20generation%20in%20Cranelift./near/194214056" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231466.20Refactor.20unwind.20generation.20in.20Cranelift.2E.html#194214056">(Apr 15 2020 at 19:14)</a>:</h4>
<p>peterhuene created <a href="https://github.com/bytecodealliance/wasmtime/pull/1466#discussion_r409074598" title="https://github.com/bytecodealliance/wasmtime/pull/1466#discussion_r409074598">PR Review Comment</a>:</p>
<blockquote>
<p>Good point.  We could also return an error instead of panicking since the creation function now returns <code>CodegenResult</code> from #1216.</p>
</blockquote>



<a name="194218763"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231466%20Refactor%20unwind%20generation%20in%20Cranelift./near/194218763" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231466.20Refactor.20unwind.20generation.20in.20Cranelift.2E.html#194218763">(Apr 15 2020 at 19:54)</a>:</h4>
<p>abrown submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/1466#pullrequestreview-394088449" title="https://github.com/bytecodealliance/wasmtime/pull/1466#pullrequestreview-394088449">PR Review</a>.</p>



<a name="194218764"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231466%20Refactor%20unwind%20generation%20in%20Cranelift./near/194218764" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231466.20Refactor.20unwind.20generation.20in.20Cranelift.2E.html#194218764">(Apr 15 2020 at 19:54)</a>:</h4>
<p>abrown created <a href="https://github.com/bytecodealliance/wasmtime/pull/1466#discussion_r409096200" title="https://github.com/bytecodealliance/wasmtime/pull/1466#discussion_r409096200">PR Review Comment</a>:</p>
<blockquote>
<p><code>map_reg</code> should now return a <code>Result</code> since #1451 so it should be a bit easier; prior to that PR <code>map_reg</code> panicked so when I added <code>RegisterMappingError</code> I kept the same behavior with this <code>expect</code> (and one other place I believe). I agree it would be better if we avoided panicking!</p>
</blockquote>



<a name="194221714"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231466%20Refactor%20unwind%20generation%20in%20Cranelift./near/194221714" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231466.20Refactor.20unwind.20generation.20in.20Cranelift.2E.html#194221714">(Apr 15 2020 at 20:17)</a>:</h4>
<p>peterhuene created <a href="https://github.com/bytecodealliance/wasmtime/pull/1466#discussion_r409108305" title="https://github.com/bytecodealliance/wasmtime/pull/1466#discussion_r409108305">PR Review Comment</a>:</p>
<blockquote>
<p>I missed that will all the merging.  I'll get that fixed.</p>
</blockquote>



<a name="194221715"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231466%20Refactor%20unwind%20generation%20in%20Cranelift./near/194221715" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231466.20Refactor.20unwind.20generation.20in.20Cranelift.2E.html#194221715">(Apr 15 2020 at 20:17)</a>:</h4>
<p>peterhuene submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/1466#pullrequestreview-394103580" title="https://github.com/bytecodealliance/wasmtime/pull/1466#pullrequestreview-394103580">PR Review</a>.</p>



<a name="194224668"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231466%20Refactor%20unwind%20generation%20in%20Cranelift./near/194224668" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231466.20Refactor.20unwind.20generation.20in.20Cranelift.2E.html#194224668">(Apr 15 2020 at 20:43)</a>:</h4>
<p>peterhuene deleted <a href="https://github.com/bytecodealliance/wasmtime/pull/1466#discussion_r409108305" title="https://github.com/bytecodealliance/wasmtime/pull/1466#discussion_r409108305">PR Review Comment</a>.</p>



<a name="194227245"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231466%20Refactor%20unwind%20generation%20in%20Cranelift./near/194227245" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231466.20Refactor.20unwind.20generation.20in.20Cranelift.2E.html#194227245">(Apr 15 2020 at 21:03)</a>:</h4>
<p>peterhuene updated <a href="https://github.com/bytecodealliance/wasmtime/pull/1466" title="https://github.com/bytecodealliance/wasmtime/pull/1466">PR #1466</a> (assigned to yurydelendik) from <code>fix-unwind-emit</code> to <code>master</code>:</p>
<blockquote>
<p>This PR makes the following changes to unwind information generation in<br>
Cranelift:</p>
<ul>
<li>
<p>Remove frame layout change implementation in favor of processing the prologue<br>
  and epilogue instructions when unwind information is requested.  This also<br>
  means this work is no longer performed for Windows, which didn't utilize it.<br>
  It also helps simplify the prologue and epilogue generation code.</p>
</li>
<li>
<p>Remove the unwind sink implementation that required each unwind information<br>
  to be represented in final form. For FDEs, this meant writing a<br>
  complete frame table per function, which wastes 20 bytes or so for each<br>
  function with duplicate CIEs.  This also enables Cranelift users to collect the<br>
  unwind information and write it as a single frame table.</p>
</li>
<li>
<p>For System V calling convention in Wasmtime, the unwind information is no longer stored<br>
  in code memory (it's only a requirement for Windows ABI to do so).  This allows<br>
  for more compact code memory for modules with a lot of functions.</p>
</li>
<li>
<p>Deletes some duplicate code relating to frame table generation.  Users can<br>
  now simply use gimli to create a frame table from each function's unwind<br>
  information.</p>
</li>
</ul>
<p>Fixes #1181.</p>
</blockquote>



<a name="194227266"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231466%20Refactor%20unwind%20generation%20in%20Cranelift./near/194227266" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231466.20Refactor.20unwind.20generation.20in.20Cranelift.2E.html#194227266">(Apr 15 2020 at 21:03)</a>:</h4>
<p>peterhuene submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/1466#pullrequestreview-394133440" title="https://github.com/bytecodealliance/wasmtime/pull/1466#pullrequestreview-394133440">PR Review</a>.</p>



<a name="194227267"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231466%20Refactor%20unwind%20generation%20in%20Cranelift./near/194227267" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231466.20Refactor.20unwind.20generation.20in.20Cranelift.2E.html#194227267">(Apr 15 2020 at 21:03)</a>:</h4>
<p>peterhuene created <a href="https://github.com/bytecodealliance/wasmtime/pull/1466#discussion_r409132525" title="https://github.com/bytecodealliance/wasmtime/pull/1466#discussion_r409132525">PR Review Comment</a>:</p>
<blockquote>
<p>I've pushed up a commit to remove the <code>expect</code> from <code>map_reg</code> calls.</p>
</blockquote>



<a name="194232397"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231466%20Refactor%20unwind%20generation%20in%20Cranelift./near/194232397" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231466.20Refactor.20unwind.20generation.20in.20Cranelift.2E.html#194232397">(Apr 15 2020 at 21:50)</a>:</h4>
<p>peterhuene updated <a href="https://github.com/bytecodealliance/wasmtime/pull/1466" title="https://github.com/bytecodealliance/wasmtime/pull/1466">PR #1466</a> (assigned to yurydelendik) from <code>fix-unwind-emit</code> to <code>master</code>:</p>
<blockquote>
<p>This PR makes the following changes to unwind information generation in<br>
Cranelift:</p>
<ul>
<li>
<p>Remove frame layout change implementation in favor of processing the prologue<br>
  and epilogue instructions when unwind information is requested.  This also<br>
  means this work is no longer performed for Windows, which didn't utilize it.<br>
  It also helps simplify the prologue and epilogue generation code.</p>
</li>
<li>
<p>Remove the unwind sink implementation that required each unwind information<br>
  to be represented in final form. For FDEs, this meant writing a<br>
  complete frame table per function, which wastes 20 bytes or so for each<br>
  function with duplicate CIEs.  This also enables Cranelift users to collect the<br>
  unwind information and write it as a single frame table.</p>
</li>
<li>
<p>For System V calling convention in Wasmtime, the unwind information is no longer stored<br>
  in code memory (it's only a requirement for Windows ABI to do so).  This allows<br>
  for more compact code memory for modules with a lot of functions.</p>
</li>
<li>
<p>Deletes some duplicate code relating to frame table generation.  Users can<br>
  now simply use gimli to create a frame table from each function's unwind<br>
  information.</p>
</li>
</ul>
<p>Fixes #1181.</p>
</blockquote>



<a name="194233365"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231466%20Refactor%20unwind%20generation%20in%20Cranelift./near/194233365" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231466.20Refactor.20unwind.20generation.20in.20Cranelift.2E.html#194233365">(Apr 15 2020 at 21:59)</a>:</h4>
<p>yurydelendik submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/1466#pullrequestreview-394164985" title="https://github.com/bytecodealliance/wasmtime/pull/1466#pullrequestreview-394164985">PR Review</a>.</p>



<a name="194233366"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231466%20Refactor%20unwind%20generation%20in%20Cranelift./near/194233366" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231466.20Refactor.20unwind.20generation.20in.20Cranelift.2E.html#194233366">(Apr 15 2020 at 21:59)</a>:</h4>
<p>yurydelendik created <a href="https://github.com/bytecodealliance/wasmtime/pull/1466#discussion_r409159036" title="https://github.com/bytecodealliance/wasmtime/pull/1466#discussion_r409159036">PR Review Comment</a>:</p>
<blockquote>
<p>Thanks. FWIW I think generating even incomplete FDE for backtrace outweighs maintainability/diagnostics of unwind generation code. That said, we may ignore map_reg errors in future.</p>
</blockquote>



<a name="194238525"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231466%20Refactor%20unwind%20generation%20in%20Cranelift./near/194238525" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231466.20Refactor.20unwind.20generation.20in.20Cranelift.2E.html#194238525">(Apr 15 2020 at 22:53)</a>:</h4>
<p>yurydelendik submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/1466#pullrequestreview-394189146" title="https://github.com/bytecodealliance/wasmtime/pull/1466#pullrequestreview-394189146">PR Review</a>.</p>



<a name="194238527"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231466%20Refactor%20unwind%20generation%20in%20Cranelift./near/194238527" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231466.20Refactor.20unwind.20generation.20in.20Cranelift.2E.html#194238527">(Apr 15 2020 at 22:53)</a>:</h4>
<p>yurydelendik created <a href="https://github.com/bytecodealliance/wasmtime/pull/1466#discussion_r409180522" title="https://github.com/bytecodealliance/wasmtime/pull/1466#discussion_r409180522">PR Review Comment</a>:</p>
<blockquote>
<p>IIRC that needs to happen after each FDE: GCC __register_frame walks until the end (if my understanding of source code right), though on MacOS everything goes through _unw_add_dynamic_fde (single FDE only).</p>
</blockquote>



<a name="194238615"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231466%20Refactor%20unwind%20generation%20in%20Cranelift./near/194238615" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231466.20Refactor.20unwind.20generation.20in.20Cranelift.2E.html#194238615">(Apr 15 2020 at 22:54)</a>:</h4>
<p>yurydelendik edited <a href="https://github.com/bytecodealliance/wasmtime/pull/1466#discussion_r409180522" title="https://github.com/bytecodealliance/wasmtime/pull/1466#discussion_r409180522">PR Review Comment</a>.</p>



<a name="194239257"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231466%20Refactor%20unwind%20generation%20in%20Cranelift./near/194239257" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231466.20Refactor.20unwind.20generation.20in.20Cranelift.2E.html#194239257">(Apr 15 2020 at 23:01)</a>:</h4>
<p>yurydelendik submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/1466#pullrequestreview-394192514" title="https://github.com/bytecodealliance/wasmtime/pull/1466#pullrequestreview-394192514">PR Review</a>.</p>



<a name="194241524"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231466%20Refactor%20unwind%20generation%20in%20Cranelift./near/194241524" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231466.20Refactor.20unwind.20generation.20in.20Cranelift.2E.html#194241524">(Apr 15 2020 at 23:33)</a>:</h4>
<p>peterhuene submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/1466#pullrequestreview-394204158" title="https://github.com/bytecodealliance/wasmtime/pull/1466#pullrequestreview-394204158">PR Review</a>.</p>



<a name="194241525"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231466%20Refactor%20unwind%20generation%20in%20Cranelift./near/194241525" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231466.20Refactor.20unwind.20generation.20in.20Cranelift.2E.html#194241525">(Apr 15 2020 at 23:33)</a>:</h4>
<p>peterhuene created <a href="https://github.com/bytecodealliance/wasmtime/pull/1466#discussion_r409193858" title="https://github.com/bytecodealliance/wasmtime/pull/1466#discussion_r409193858">PR Review Comment</a>:</p>
<blockquote>
<p>Ugh, you're right.  I think this is repeatedly going through the remaining part of the table each iteration to register the frame.  I'll fix.</p>
</blockquote>



<a name="194245982"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231466%20Refactor%20unwind%20generation%20in%20Cranelift./near/194245982" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231466.20Refactor.20unwind.20generation.20in.20Cranelift.2E.html#194245982">(Apr 16 2020 at 00:39)</a>:</h4>
<p>peterhuene updated <a href="https://github.com/bytecodealliance/wasmtime/pull/1466" title="https://github.com/bytecodealliance/wasmtime/pull/1466">PR #1466</a> (assigned to yurydelendik) from <code>fix-unwind-emit</code> to <code>master</code>:</p>
<blockquote>
<p>This PR makes the following changes to unwind information generation in<br>
Cranelift:</p>
<ul>
<li>
<p>Remove frame layout change implementation in favor of processing the prologue<br>
  and epilogue instructions when unwind information is requested.  This also<br>
  means this work is no longer performed for Windows, which didn't utilize it.<br>
  It also helps simplify the prologue and epilogue generation code.</p>
</li>
<li>
<p>Remove the unwind sink implementation that required each unwind information<br>
  to be represented in final form. For FDEs, this meant writing a<br>
  complete frame table per function, which wastes 20 bytes or so for each<br>
  function with duplicate CIEs.  This also enables Cranelift users to collect the<br>
  unwind information and write it as a single frame table.</p>
</li>
<li>
<p>For System V calling convention in Wasmtime, the unwind information is no longer stored<br>
  in code memory (it's only a requirement for Windows ABI to do so).  This allows<br>
  for more compact code memory for modules with a lot of functions.</p>
</li>
<li>
<p>Deletes some duplicate code relating to frame table generation.  Users can<br>
  now simply use gimli to create a frame table from each function's unwind<br>
  information.</p>
</li>
</ul>
<p>Fixes #1181.</p>
</blockquote>



<a name="194257306"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231466%20Refactor%20unwind%20generation%20in%20Cranelift./near/194257306" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231466.20Refactor.20unwind.20generation.20in.20Cranelift.2E.html#194257306">(Apr 16 2020 at 04:34)</a>:</h4>
<p>peterhuene submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/1466#pullrequestreview-394291896" title="https://github.com/bytecodealliance/wasmtime/pull/1466#pullrequestreview-394291896">PR Review</a>.</p>



<a name="194257307"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231466%20Refactor%20unwind%20generation%20in%20Cranelift./near/194257307" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231466.20Refactor.20unwind.20generation.20in.20Cranelift.2E.html#194257307">(Apr 16 2020 at 04:34)</a>:</h4>
<p>peterhuene created <a href="https://github.com/bytecodealliance/wasmtime/pull/1466#discussion_r409275968" title="https://github.com/bytecodealliance/wasmtime/pull/1466#discussion_r409275968">PR Review Comment</a>:</p>
<blockquote>
<p>So I put up a commit that calls <code>__register_frame</code> once for non-macOS and for macOS it iterates the table and calls <code>__register_frame</code> per FDE.  Judging from the libgcc source, this should work just fine.  Let me know what you think and I'll make any additional changes.</p>
</blockquote>



<a name="194276121"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231466%20Refactor%20unwind%20generation%20in%20Cranelift./near/194276121" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231466.20Refactor.20unwind.20generation.20in.20Cranelift.2E.html#194276121">(Apr 16 2020 at 09:12)</a>:</h4>
<p><strong>bnjbvr</strong> requested <a href="https://github.com/bnjbvr" title="https://github.com/bnjbvr">bnjbvr</a> and <a href="https://github.com/yurydelendik" title="https://github.com/yurydelendik">yurydelendik</a> for a review on <a href="https://github.com/bytecodealliance/wasmtime/pull/1466" title="https://github.com/bytecodealliance/wasmtime/pull/1466">PR #1466</a>.</p>



<a name="194308488"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231466%20Refactor%20unwind%20generation%20in%20Cranelift./near/194308488" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231466.20Refactor.20unwind.20generation.20in.20Cranelift.2E.html#194308488">(Apr 16 2020 at 14:02)</a>:</h4>
<p>yurydelendik submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/1466#pullrequestreview-394663990" title="https://github.com/bytecodealliance/wasmtime/pull/1466#pullrequestreview-394663990">PR Review</a>.</p>



<a name="194345932"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231466%20Refactor%20unwind%20generation%20in%20Cranelift./near/194345932" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231466.20Refactor.20unwind.20generation.20in.20Cranelift.2E.html#194345932">(Apr 16 2020 at 18:15)</a>:</h4>
<p>peterhuene updated <a href="https://github.com/bytecodealliance/wasmtime/pull/1466" title="https://github.com/bytecodealliance/wasmtime/pull/1466">PR #1466</a> (assigned to yurydelendik) from <code>fix-unwind-emit</code> to <code>master</code>:</p>
<blockquote>
<p>This PR makes the following changes to unwind information generation in<br>
Cranelift:</p>
<ul>
<li>
<p>Remove frame layout change implementation in favor of processing the prologue<br>
  and epilogue instructions when unwind information is requested.  This also<br>
  means this work is no longer performed for Windows, which didn't utilize it.<br>
  It also helps simplify the prologue and epilogue generation code.</p>
</li>
<li>
<p>Remove the unwind sink implementation that required each unwind information<br>
  to be represented in final form. For FDEs, this meant writing a<br>
  complete frame table per function, which wastes 20 bytes or so for each<br>
  function with duplicate CIEs.  This also enables Cranelift users to collect the<br>
  unwind information and write it as a single frame table.</p>
</li>
<li>
<p>For System V calling convention in Wasmtime, the unwind information is no longer stored<br>
  in code memory (it's only a requirement for Windows ABI to do so).  This allows<br>
  for more compact code memory for modules with a lot of functions.</p>
</li>
<li>
<p>Deletes some duplicate code relating to frame table generation.  Users can<br>
  now simply use gimli to create a frame table from each function's unwind<br>
  information.</p>
</li>
</ul>
<p>Fixes #1181.</p>
</blockquote>



<a name="194353766"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231466%20Refactor%20unwind%20generation%20in%20Cranelift./near/194353766" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231466.20Refactor.20unwind.20generation.20in.20Cranelift.2E.html#194353766">(Apr 16 2020 at 19:14)</a>:</h4>
<p>peterhuene updated <a href="https://github.com/bytecodealliance/wasmtime/pull/1466" title="https://github.com/bytecodealliance/wasmtime/pull/1466">PR #1466</a> (assigned to yurydelendik) from <code>fix-unwind-emit</code> to <code>master</code>:</p>
<blockquote>
<p>This PR makes the following changes to unwind information generation in<br>
Cranelift:</p>
<ul>
<li>
<p>Remove frame layout change implementation in favor of processing the prologue<br>
  and epilogue instructions when unwind information is requested.  This also<br>
  means this work is no longer performed for Windows, which didn't utilize it.<br>
  It also helps simplify the prologue and epilogue generation code.</p>
</li>
<li>
<p>Remove the unwind sink implementation that required each unwind information<br>
  to be represented in final form. For FDEs, this meant writing a<br>
  complete frame table per function, which wastes 20 bytes or so for each<br>
  function with duplicate CIEs.  This also enables Cranelift users to collect the<br>
  unwind information and write it as a single frame table.</p>
</li>
<li>
<p>For System V calling convention in Wasmtime, the unwind information is no longer stored<br>
  in code memory (it's only a requirement for Windows ABI to do so).  This allows<br>
  for more compact code memory for modules with a lot of functions.</p>
</li>
<li>
<p>Deletes some duplicate code relating to frame table generation.  Users can<br>
  now simply use gimli to create a frame table from each function's unwind<br>
  information.</p>
</li>
</ul>
<p>Fixes #1181.</p>
</blockquote>



<a name="194363840"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231466%20Refactor%20unwind%20generation%20in%20Cranelift./near/194363840" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231466.20Refactor.20unwind.20generation.20in.20Cranelift.2E.html#194363840">(Apr 16 2020 at 20:34)</a>:</h4>
<p>peterhuene merged <a href="https://github.com/bytecodealliance/wasmtime/pull/1466" title="https://github.com/bytecodealliance/wasmtime/pull/1466">PR #1466</a>.</p>



<a name="195502348"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231466%20Refactor%20unwind%20generation%20in%20Cranelift./near/195502348" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231466.20Refactor.20unwind.20generation.20in.20Cranelift.2E.html#195502348">(Apr 28 2020 at 05:29)</a>:</h4>
<p>philipc submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/1466#pullrequestreview-401507622" title="https://github.com/bytecodealliance/wasmtime/pull/1466#pullrequestreview-401507622">PR Review</a>.</p>



<a name="195502349"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231466%20Refactor%20unwind%20generation%20in%20Cranelift./near/195502349" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231466.20Refactor.20unwind.20generation.20in.20Cranelift.2E.html#195502349">(Apr 28 2020 at 05:29)</a>:</h4>
<p>philipc created <a href="https://github.com/bytecodealliance/wasmtime/pull/1466#discussion_r416337240" title="https://github.com/bytecodealliance/wasmtime/pull/1466#discussion_r416337240">PR Review Comment</a>:</p>
<blockquote>
<p>FYI, <code>gimli::write::Expression</code> is no longer a simple <code>Vec&lt;u8&gt;</code> after <a href="https://github.com/gimli-rs/gimli/pull/479" title="https://github.com/gimli-rs/gimli/pull/479">https://github.com/gimli-rs/gimli/pull/479</a>, so this isn't going to work.</p>
<p>It seems like you don't actually need <code>impl From&lt;gimli::write::CallFrameInstruction&gt; for CallFrameInstruction</code> though, so it would be possible to simply delete all the <code>Expression</code> support. If you do need to support expressions, then you'll need to come up with your own serializable version of them. gimli's expressions are used for other debug sections too, thus they potentially have references to DIEs and can't be individually serialized.</p>
</blockquote>



<a name="195521977"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231466%20Refactor%20unwind%20generation%20in%20Cranelift./near/195521977" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231466.20Refactor.20unwind.20generation.20in.20Cranelift.2E.html#195521977">(Apr 28 2020 at 06:03)</a>:</h4>
<p>philipc submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/1466#pullrequestreview-401520362" title="https://github.com/bytecodealliance/wasmtime/pull/1466#pullrequestreview-401520362">PR Review</a>.</p>



<a name="195521978"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231466%20Refactor%20unwind%20generation%20in%20Cranelift./near/195521978" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231466.20Refactor.20unwind.20generation.20in.20Cranelift.2E.html#195521978">(Apr 28 2020 at 06:03)</a>:</h4>
<p>philipc created <a href="https://github.com/bytecodealliance/wasmtime/pull/1466#discussion_r416349933" title="https://github.com/bytecodealliance/wasmtime/pull/1466#discussion_r416349933">PR Review Comment</a>:</p>
<blockquote>
<p>See <a href="https://github.com/philipc/wasmtime/commit/103d68d6c5e6201f76a17b14b29ddca82ad02350" title="https://github.com/philipc/wasmtime/commit/103d68d6c5e6201f76a17b14b29ddca82ad02350">https://github.com/philipc/wasmtime/commit/103d68d6c5e6201f76a17b14b29ddca82ad02350</a> for the changes I think are needed. I can open a PR once a new gimli version is released.</p>
</blockquote>



<a name="195797336"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231466%20Refactor%20unwind%20generation%20in%20Cranelift./near/195797336" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231466.20Refactor.20unwind.20generation.20in.20Cranelift.2E.html#195797336">(Apr 30 2020 at 04:23)</a>:</h4>
<p>peterhuene submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/1466#pullrequestreview-403191195" title="https://github.com/bytecodealliance/wasmtime/pull/1466#pullrequestreview-403191195">PR Review</a>.</p>



<a name="195797338"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%231466%20Refactor%20unwind%20generation%20in%20Cranelift./near/195797338" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.231466.20Refactor.20unwind.20generation.20in.20Cranelift.2E.html#195797338">(Apr 30 2020 at 04:23)</a>:</h4>
<p>peterhuene created <a href="https://github.com/bytecodealliance/wasmtime/pull/1466#discussion_r417745315" title="https://github.com/bytecodealliance/wasmtime/pull/1466#discussion_r417745315">PR Review Comment</a>:</p>
<blockquote>
<p>@philipc thanks for the heads up!  When we update gimli, I think we can work around this by removing expression support from this representation since we don't need it to describe our frames currently.</p>
</blockquote>



<hr><p>Last updated: Jan 20 2025 at 06:04 UTC</p>
</html>