<html>
<head><meta charset="utf-8"><title>wasmtime / PR #5464 cranelift: Rework block instructions ... · git-wasmtime · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/index.html">git-wasmtime</a></h2>
<h3>Topic: <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.235464.20cranelift.3A.20Rework.20block.20instructions.20.2E.2E.2E.html">wasmtime / PR #5464 cranelift: Rework block instructions ...</a></h3>

<hr>

<base href="https://bytecodealliance.zulipchat.com">

<head><link href="https://bytecodealliance.github.io/zulip-archive/style.css" rel="stylesheet"></head>

<a name="316390705"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%235464%20cranelift%3A%20Rework%20block%20instructions%20.../near/316390705" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.235464.20cranelift.3A.20Rework.20block.20instructions.20.2E.2E.2E.html#316390705">(Dec 17 2022 at 01:49)</a>:</h4>
<p>elliottt opened <a href="https://github.com/bytecodealliance/wasmtime/pull/5464">PR #5464</a> from <code>trevor/block-with-args</code> to <code>main</code>:</p>
<blockquote>
<p>Add a new type <code>BlockWithArgs</code> that represents the pair of a block name with arguments to be passed to it. Rework the implementation of <code>jump</code>, <code>brz</code>, and <code>brnz</code> to use <code>BlockWithArgs</code> instead of storing the block arguments as varargs in the instruction's <code>ValueList</code>.</p>
<p>&lt;!--</p>
<p>Please ensure that the following steps are all taken care of before submitting<br>
the PR.</p>
<ul>
<li>
<p>[ ] This has been discussed in issue #..., or if not, please tell us why<br>
  here.</p>
</li>
<li>
<p>[ ] A short description of what this does, why it is needed; if the<br>
  description becomes long, the matter should probably be discussed in an issue<br>
  first.</p>
</li>
<li>
<p>[ ] This PR contains test cases, if meaningful.</p>
</li>
<li>[ ] A reviewer from the core maintainer team has been assigned for this PR.<br>
  If you don't know who could review this, please indicate so. The list of<br>
  suggested reviewers on the right can help you.</li>
</ul>
<p>Please ensure all communication adheres to the <a href="https://github.com/bytecodealliance/wasmtime/blob/master/CODE_OF_CONDUCT.md">code of
conduct</a>.<br>
--&gt;<br>
</p>
</blockquote>



<a name="316391005"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%235464%20cranelift%3A%20Rework%20block%20instructions%20.../near/316391005" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.235464.20cranelift.3A.20Rework.20block.20instructions.20.2E.2E.2E.html#316391005">(Dec 17 2022 at 01:54)</a>:</h4>
<p>elliottt edited <a href="https://github.com/bytecodealliance/wasmtime/pull/5464">PR #5464</a> from <code>trevor/block-with-args</code> to <code>main</code>:</p>
<blockquote>
<p>Add a new type <code>BlockWithArgs</code> that represents the pair of a block name with arguments to be passed to it. Rework the implementation of <code>jump</code>, <code>brz</code>, and <code>brnz</code> to use <code>BlockWithArgs</code> instead of storing the block arguments as varargs in the instruction's <code>ValueList</code>.</p>
<p>Some open questions:</p>
<ul>
<li>[ ] Does the return value of  <code>num_fixed_actuals</code> function still make sense for <code>brz</code> and <code>brnz</code> even though they no longer store their control argument in the instruction's argument list?</li>
<li>[ ]The reworked builder api for <code>jump</code>, <code>brz</code>, and <code>brnz</code> is not very nice to work with. Can we generate two variations of each function, one that takes a <code>BlockWithArgs</code> and one that takes the pair of <code>Block</code> and <code>Value</code> slice?</li>
<li>[ ] I'm not 100% confident that I've found everywhere that we're using instruction arguments and block arguments interchangeably. Is there a good way to track this down beyond fuzzing?</li>
</ul>
<p>&lt;!--</p>
<p>Please ensure that the following steps are all taken care of before submitting<br>
the PR.</p>
<ul>
<li>
<p>[ ] This has been discussed in issue #..., or if not, please tell us why<br>
  here.</p>
</li>
<li>
<p>[ ] A short description of what this does, why it is needed; if the<br>
  description becomes long, the matter should probably be discussed in an issue<br>
  first.</p>
</li>
<li>
<p>[ ] This PR contains test cases, if meaningful.</p>
</li>
<li>[ ] A reviewer from the core maintainer team has been assigned for this PR.<br>
  If you don't know who could review this, please indicate so. The list of<br>
  suggested reviewers on the right can help you.</li>
</ul>
<p>Please ensure all communication adheres to the <a href="https://github.com/bytecodealliance/wasmtime/blob/master/CODE_OF_CONDUCT.md">code of
conduct</a>.<br>
--&gt;<br>
</p>
</blockquote>



<a name="316391035"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%235464%20cranelift%3A%20Rework%20block%20instructions%20.../near/316391035" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.235464.20cranelift.3A.20Rework.20block.20instructions.20.2E.2E.2E.html#316391035">(Dec 17 2022 at 01:54)</a>:</h4>
<p>elliottt edited <a href="https://github.com/bytecodealliance/wasmtime/pull/5464">PR #5464</a> from <code>trevor/block-with-args</code> to <code>main</code>:</p>
<blockquote>
<p>Add a new type <code>BlockWithArgs</code> that represents the pair of a block name with arguments to be passed to it. Rework the implementation of <code>jump</code>, <code>brz</code>, and <code>brnz</code> to use <code>BlockWithArgs</code> instead of storing the block arguments as varargs in the instruction's <code>ValueList</code>.</p>
<p>Some open questions:</p>
<ul>
<li>[ ] Does the return value of  <code>num_fixed_actuals</code> function still make sense for <code>brz</code> and <code>brnz</code> even though they no longer store their control argument in the instruction's argument list?</li>
<li>[ ] The reworked builder api for <code>jump</code>, <code>brz</code>, and <code>brnz</code> is not very nice to work with. Can we generate two variations of each function, one that takes a <code>BlockWithArgs</code> and one that takes the pair of <code>Block</code> and <code>Value</code> slice?</li>
<li>[ ] I'm not 100% confident that I've found everywhere that we're using instruction arguments and block arguments interchangeably. Is there a good way to track this down beyond fuzzing?</li>
</ul>
<p>&lt;!--</p>
<p>Please ensure that the following steps are all taken care of before submitting<br>
the PR.</p>
<ul>
<li>
<p>[ ] This has been discussed in issue #..., or if not, please tell us why<br>
  here.</p>
</li>
<li>
<p>[ ] A short description of what this does, why it is needed; if the<br>
  description becomes long, the matter should probably be discussed in an issue<br>
  first.</p>
</li>
<li>
<p>[ ] This PR contains test cases, if meaningful.</p>
</li>
<li>[ ] A reviewer from the core maintainer team has been assigned for this PR.<br>
  If you don't know who could review this, please indicate so. The list of<br>
  suggested reviewers on the right can help you.</li>
</ul>
<p>Please ensure all communication adheres to the <a href="https://github.com/bytecodealliance/wasmtime/blob/master/CODE_OF_CONDUCT.md">code of
conduct</a>.<br>
--&gt;<br>
</p>
</blockquote>



<a name="316797184"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%235464%20cranelift%3A%20Rework%20block%20instructions%20.../near/316797184" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.235464.20cranelift.3A.20Rework.20block.20instructions.20.2E.2E.2E.html#316797184">(Dec 19 2022 at 17:46)</a>:</h4>
<p>elliottt updated <a href="https://github.com/bytecodealliance/wasmtime/pull/5464">PR #5464</a> from <code>trevor/block-with-args</code> to <code>main</code>.</p>



<a name="316803929"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%235464%20cranelift%3A%20Rework%20block%20instructions%20.../near/316803929" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.235464.20cranelift.3A.20Rework.20block.20instructions.20.2E.2E.2E.html#316803929">(Dec 19 2022 at 18:24)</a>:</h4>
<p>cfallin submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/5464#pullrequestreview-1223295362">PR review</a>.</p>



<a name="316803930"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%235464%20cranelift%3A%20Rework%20block%20instructions%20.../near/316803930" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.235464.20cranelift.3A.20Rework.20block.20instructions.20.2E.2E.2E.html#316803930">(Dec 19 2022 at 18:24)</a>:</h4>
<p>cfallin submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/5464#pullrequestreview-1223295362">PR review</a>.</p>



<a name="316803931"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%235464%20cranelift%3A%20Rework%20block%20instructions%20.../near/316803931" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.235464.20cranelift.3A.20Rework.20block.20instructions.20.2E.2E.2E.html#316803931">(Dec 19 2022 at 18:24)</a>:</h4>
<p>cfallin created <a href="https://github.com/bytecodealliance/wasmtime/pull/5464#discussion_r1052476712">PR review comment</a>:</p>
<blockquote>
<p>Can we note that args are included here (in contrast to <code>label</code> below), and possibly also call it <code>block_with_args</code> throughout for clarity?</p>
</blockquote>



<a name="316803932"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%235464%20cranelift%3A%20Rework%20block%20instructions%20.../near/316803932" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.235464.20cranelift.3A.20Rework.20block.20instructions.20.2E.2E.2E.html#316803932">(Dec 19 2022 at 18:24)</a>:</h4>
<p>cfallin created <a href="https://github.com/bytecodealliance/wasmtime/pull/5464#discussion_r1052477043">PR review comment</a>:</p>
<blockquote>
<p>Likewise here, note that args are included</p>
</blockquote>



<a name="316803934"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%235464%20cranelift%3A%20Rework%20block%20instructions%20.../near/316803934" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.235464.20cranelift.3A.20Rework.20block.20instructions.20.2E.2E.2E.html#316803934">(Dec 19 2022 at 18:24)</a>:</h4>
<p>cfallin created <a href="https://github.com/bytecodealliance/wasmtime/pull/5464#discussion_r1052484037">PR review comment</a>:</p>
<blockquote>
<p>Is this correct for conditional branches? We need to skip the first arg from the elab stack, no?</p>
</blockquote>



<a name="316803935"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%235464%20cranelift%3A%20Rework%20block%20instructions%20.../near/316803935" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.235464.20cranelift.3A.20Rework.20block.20instructions.20.2E.2E.2E.html#316803935">(Dec 19 2022 at 18:24)</a>:</h4>
<p>cfallin created <a href="https://github.com/bytecodealliance/wasmtime/pull/5464#discussion_r1052485236">PR review comment</a>:</p>
<blockquote>
<p>The code duplication here is pretty unfortunate. Could we wrap it in a closure (<code>handle_use</code> or somesuch)?</p>
<p>(Making it a closure will probably require closure args for borrows so the closure itself doesn't hold the borrows for too long)</p>
</blockquote>



<a name="316803936"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%235464%20cranelift%3A%20Rework%20block%20instructions%20.../near/316803936" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.235464.20cranelift.3A.20Rework.20block.20instructions.20.2E.2E.2E.html#316803936">(Dec 19 2022 at 18:24)</a>:</h4>
<p>cfallin created <a href="https://github.com/bytecodealliance/wasmtime/pull/5464#discussion_r1052489449">PR review comment</a>:</p>
<blockquote>
<p>Somewhat confusing to name this local <code>cell</code> if it's not actually a Cell or some other kind of interior mutability -- can we just call it <code>first_elem</code> or something?</p>
</blockquote>



<a name="316803937"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%235464%20cranelift%3A%20Rework%20block%20instructions%20.../near/316803937" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.235464.20cranelift.3A.20Rework.20block.20instructions.20.2E.2E.2E.html#316803937">(Dec 19 2022 at 18:24)</a>:</h4>
<p>cfallin created <a href="https://github.com/bytecodealliance/wasmtime/pull/5464#discussion_r1052488755">PR review comment</a>:</p>
<blockquote>
<p>We can probably preallocate the list with the appropriate length upfront, since <code>args</code> is a slice and we know its length?</p>
</blockquote>



<a name="316804076"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%235464%20cranelift%3A%20Rework%20block%20instructions%20.../near/316804076" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.235464.20cranelift.3A.20Rework.20block.20instructions.20.2E.2E.2E.html#316804076">(Dec 19 2022 at 18:25)</a>:</h4>
<p>cfallin submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/5464#pullrequestreview-1223295362">PR review</a>.</p>



<a name="316806041"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%235464%20cranelift%3A%20Rework%20block%20instructions%20.../near/316806041" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.235464.20cranelift.3A.20Rework.20block.20instructions.20.2E.2E.2E.html#316806041">(Dec 19 2022 at 18:34)</a>:</h4>
<p>jameysharp submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/5464#pullrequestreview-1223351104">PR review</a>.</p>



<a name="316806042"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%235464%20cranelift%3A%20Rework%20block%20instructions%20.../near/316806042" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.235464.20cranelift.3A.20Rework.20block.20instructions.20.2E.2E.2E.html#316806042">(Dec 19 2022 at 18:34)</a>:</h4>
<p>jameysharp created <a href="https://github.com/bytecodealliance/wasmtime/pull/5464#discussion_r1052513877">PR review comment</a>:</p>
<blockquote>
<p>Huh, apparently <code>EntityList</code> doesn't have a <code>with_capacity</code> constructor. Its <code>extend</code> method does make some use of <code>Iterator::size_hint</code> though, so this reallocs the list at most once, when it has only one element in it. We could use <code>Iterator::chain</code> to preallocate the right size but I'm not convinced it's worth bothering.</p>
</blockquote>



<a name="316809635"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%235464%20cranelift%3A%20Rework%20block%20instructions%20.../near/316809635" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.235464.20cranelift.3A.20Rework.20block.20instructions.20.2E.2E.2E.html#316809635">(Dec 19 2022 at 18:55)</a>:</h4>
<p>elliottt updated <a href="https://github.com/bytecodealliance/wasmtime/pull/5464">PR #5464</a> from <code>trevor/block-with-args</code> to <code>main</code>.</p>



<a name="319658337"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%235464%20cranelift%3A%20Rework%20block%20instructions%20.../near/319658337" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.235464.20cranelift.3A.20Rework.20block.20instructions.20.2E.2E.2E.html#319658337">(Jan 05 2023 at 19:35)</a>:</h4>
<p>elliottt updated <a href="https://github.com/bytecodealliance/wasmtime/pull/5464">PR #5464</a> from <code>trevor/block-with-args</code> to <code>main</code>.</p>



<a name="319705790"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%235464%20cranelift%3A%20Rework%20block%20instructions%20.../near/319705790" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.235464.20cranelift.3A.20Rework.20block.20instructions.20.2E.2E.2E.html#319705790">(Jan 06 2023 at 01:45)</a>:</h4>
<p>elliottt updated <a href="https://github.com/bytecodealliance/wasmtime/pull/5464">PR #5464</a> from <code>trevor/block-with-args</code> to <code>main</code>.</p>



<a name="319705882"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%235464%20cranelift%3A%20Rework%20block%20instructions%20.../near/319705882" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.235464.20cranelift.3A.20Rework.20block.20instructions.20.2E.2E.2E.html#319705882">(Jan 06 2023 at 01:46)</a>:</h4>
<p>elliottt edited <a href="https://github.com/bytecodealliance/wasmtime/pull/5464">PR #5464</a> from <code>trevor/block-with-args</code> to <code>main</code>:</p>
<blockquote>
<p>Add a new type <code>BlockWithArgs</code> that represents the pair of a block name with arguments to be passed to it. Rework the implementation of <code>jump</code>, <code>brz</code>, and <code>brnz</code> to use <code>BlockWithArgs</code> instead of storing the block arguments as varargs in the instruction's <code>ValueList</code>.</p>
<p>Some open questions:</p>
<ul>
<li>[ ] Does the return value of  <code>num_fixed_actuals</code> function still make sense for <code>brz</code> and <code>brnz</code> even though they no longer store their control argument in the instruction's argument list?</li>
<li>[x] The reworked builder api for <code>jump</code>, <code>brz</code>, and <code>brnz</code> is not very nice to work with. Can we generate two variations of each function, one that takes a <code>BlockWithArgs</code> and one that takes the pair of <code>Block</code> and <code>Value</code> slice?</li>
<li>[ ] I'm not 100% confident that I've found everywhere that we're using instruction arguments and block arguments interchangeably. Is there a good way to track this down beyond fuzzing?</li>
</ul>
<p>&lt;!--</p>
<p>Please ensure that the following steps are all taken care of before submitting<br>
the PR.</p>
<ul>
<li>
<p>[ ] This has been discussed in issue #..., or if not, please tell us why<br>
  here.</p>
</li>
<li>
<p>[ ] A short description of what this does, why it is needed; if the<br>
  description becomes long, the matter should probably be discussed in an issue<br>
  first.</p>
</li>
<li>
<p>[ ] This PR contains test cases, if meaningful.</p>
</li>
<li>[ ] A reviewer from the core maintainer team has been assigned for this PR.<br>
  If you don't know who could review this, please indicate so. The list of<br>
  suggested reviewers on the right can help you.</li>
</ul>
<p>Please ensure all communication adheres to the <a href="https://github.com/bytecodealliance/wasmtime/blob/master/CODE_OF_CONDUCT.md">code of
conduct</a>.<br>
--&gt;<br>
</p>
</blockquote>



<a name="319888206"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%235464%20cranelift%3A%20Rework%20block%20instructions%20.../near/319888206" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.235464.20cranelift.3A.20Rework.20block.20instructions.20.2E.2E.2E.html#319888206">(Jan 07 2023 at 00:50)</a>:</h4>
<p>elliottt updated <a href="https://github.com/bytecodealliance/wasmtime/pull/5464">PR #5464</a> from <code>trevor/block-with-args</code> to <code>main</code>.</p>



<a name="319888223"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%235464%20cranelift%3A%20Rework%20block%20instructions%20.../near/319888223" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.235464.20cranelift.3A.20Rework.20block.20instructions.20.2E.2E.2E.html#319888223">(Jan 07 2023 at 00:50)</a>:</h4>
<p>elliottt updated <a href="https://github.com/bytecodealliance/wasmtime/pull/5464">PR #5464</a> from <code>trevor/block-with-args</code> to <code>main</code>.</p>



<a name="319888319"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%235464%20cranelift%3A%20Rework%20block%20instructions%20.../near/319888319" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.235464.20cranelift.3A.20Rework.20block.20instructions.20.2E.2E.2E.html#319888319">(Jan 07 2023 at 00:51)</a>:</h4>
<p>elliottt submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/5464#pullrequestreview-1239571010">PR review</a>.</p>



<a name="319888321"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%235464%20cranelift%3A%20Rework%20block%20instructions%20.../near/319888321" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.235464.20cranelift.3A.20Rework.20block.20instructions.20.2E.2E.2E.html#319888321">(Jan 07 2023 at 00:51)</a>:</h4>
<p>elliottt created <a href="https://github.com/bytecodealliance/wasmtime/pull/5464#discussion_r1063919237">PR review comment</a>:</p>
<blockquote>
<p>Yep, this wasn't correct. Switching to using a map function for values made it much easier to get this right.</p>
</blockquote>



<a name="319888445"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%235464%20cranelift%3A%20Rework%20block%20instructions%20.../near/319888445" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.235464.20cranelift.3A.20Rework.20block.20instructions.20.2E.2E.2E.html#319888445">(Jan 07 2023 at 00:52)</a>:</h4>
<p>elliottt submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/5464#pullrequestreview-1239571269">PR review</a>.</p>



<a name="319888446"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%235464%20cranelift%3A%20Rework%20block%20instructions%20.../near/319888446" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.235464.20cranelift.3A.20Rework.20block.20instructions.20.2E.2E.2E.html#319888446">(Jan 07 2023 at 00:52)</a>:</h4>
<p>elliottt created <a href="https://github.com/bytecodealliance/wasmtime/pull/5464#discussion_r1063919595">PR review comment</a>:</p>
<blockquote>
<p>I've added some functions to abstract over the values of an instruction to avoid this sort of duplication, and am in the process of auditing uses of the existing arg accessors to determine if they need to be changed.</p>
</blockquote>



<a name="319889205"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%235464%20cranelift%3A%20Rework%20block%20instructions%20.../near/319889205" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.235464.20cranelift.3A.20Rework.20block.20instructions.20.2E.2E.2E.html#319889205">(Jan 07 2023 at 01:00)</a>:</h4>
<p>elliottt edited <a href="https://github.com/bytecodealliance/wasmtime/pull/5464">PR #5464</a> from <code>trevor/block-with-args</code> to <code>main</code>:</p>
<blockquote>
<p>Add a new type <code>BlockWithArgs</code> that represents the pair of a block name with arguments to be passed to it. Rework the implementation of <code>jump</code>, <code>brz</code>, and <code>brnz</code> to use <code>BlockWithArgs</code> instead of storing the block arguments as varargs in the instruction's <code>ValueList</code>.</p>
<p>Some open questions:</p>
<ul>
<li>[x] Does the return value of  <code>num_fixed_actuals</code> function still make sense for <code>brz</code> and <code>brnz</code> even though they no longer store their control argument in the instruction's argument list?</li>
<li>[x] The reworked builder api for <code>jump</code>, <code>brz</code>, and <code>brnz</code> is not very nice to work with. Can we generate two variations of each function, one that takes a <code>BlockWithArgs</code> and one that takes the pair of <code>Block</code> and <code>Value</code> slice?</li>
<li>[ ] I'm not 100% confident that I've found everywhere that we're using instruction arguments and block arguments interchangeably. Is there a good way to track this down beyond fuzzing?</li>
</ul>
<p>&lt;!--</p>
<p>Please ensure that the following steps are all taken care of before submitting<br>
the PR.</p>
<ul>
<li>
<p>[ ] This has been discussed in issue #..., or if not, please tell us why<br>
  here.</p>
</li>
<li>
<p>[ ] A short description of what this does, why it is needed; if the<br>
  description becomes long, the matter should probably be discussed in an issue<br>
  first.</p>
</li>
<li>
<p>[ ] This PR contains test cases, if meaningful.</p>
</li>
<li>[ ] A reviewer from the core maintainer team has been assigned for this PR.<br>
  If you don't know who could review this, please indicate so. The list of<br>
  suggested reviewers on the right can help you.</li>
</ul>
<p>Please ensure all communication adheres to the <a href="https://github.com/bytecodealliance/wasmtime/blob/master/CODE_OF_CONDUCT.md">code of
conduct</a>.<br>
--&gt;<br>
</p>
</blockquote>



<a name="319893306"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%235464%20cranelift%3A%20Rework%20block%20instructions%20.../near/319893306" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.235464.20cranelift.3A.20Rework.20block.20instructions.20.2E.2E.2E.html#319893306">(Jan 07 2023 at 02:00)</a>:</h4>
<p>elliottt updated <a href="https://github.com/bytecodealliance/wasmtime/pull/5464">PR #5464</a> from <code>trevor/block-with-args</code> to <code>main</code>.</p>



<a name="319893533"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%235464%20cranelift%3A%20Rework%20block%20instructions%20.../near/319893533" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.235464.20cranelift.3A.20Rework.20block.20instructions.20.2E.2E.2E.html#319893533">(Jan 07 2023 at 02:03)</a>:</h4>
<p>elliottt updated <a href="https://github.com/bytecodealliance/wasmtime/pull/5464">PR #5464</a> from <code>trevor/block-with-args</code> to <code>main</code>.</p>



<a name="320292089"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%235464%20cranelift%3A%20Rework%20block%20instructions%20.../near/320292089" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.235464.20cranelift.3A.20Rework.20block.20instructions.20.2E.2E.2E.html#320292089">(Jan 09 2023 at 18:09)</a>:</h4>
<p>elliottt updated <a href="https://github.com/bytecodealliance/wasmtime/pull/5464">PR #5464</a> from <code>trevor/block-with-args</code> to <code>main</code>.</p>



<a name="320339633"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%235464%20cranelift%3A%20Rework%20block%20instructions%20.../near/320339633" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.235464.20cranelift.3A.20Rework.20block.20instructions.20.2E.2E.2E.html#320339633">(Jan 09 2023 at 22:03)</a>:</h4>
<p>elliottt updated <a href="https://github.com/bytecodealliance/wasmtime/pull/5464">PR #5464</a> from <code>trevor/block-with-args</code> to <code>main</code>.</p>



<a name="320340915"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%235464%20cranelift%3A%20Rework%20block%20instructions%20.../near/320340915" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.235464.20cranelift.3A.20Rework.20block.20instructions.20.2E.2E.2E.html#320340915">(Jan 09 2023 at 22:12)</a>:</h4>
<p>elliottt updated <a href="https://github.com/bytecodealliance/wasmtime/pull/5464">PR #5464</a> from <code>trevor/block-with-args</code> to <code>main</code>.</p>



<a name="320342630"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%235464%20cranelift%3A%20Rework%20block%20instructions%20.../near/320342630" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.235464.20cranelift.3A.20Rework.20block.20instructions.20.2E.2E.2E.html#320342630">(Jan 09 2023 at 22:24)</a>:</h4>
<p>elliottt edited <a href="https://github.com/bytecodealliance/wasmtime/pull/5464">PR #5464</a> from <code>trevor/block-with-args</code> to <code>main</code>:</p>
<blockquote>
<p>Add a new type <code>BlockWithArgs</code> that represents the pair of a block name with arguments to be passed to it. Rework the implementation of <code>jump</code>, <code>brz</code>, and <code>brnz</code> to use <code>BlockWithArgs</code> instead of storing the block arguments as varargs in the instruction's <code>ValueList</code>.</p>
<p>Some open questions:</p>
<ul>
<li>[x] Does the return value of  <code>num_fixed_actuals</code> function still make sense for <code>brz</code> and <code>brnz</code> even though they no longer store their control argument in the instruction's argument list?</li>
<li>[x] The reworked builder api for <code>jump</code>, <code>brz</code>, and <code>brnz</code> is not very nice to work with. Can we generate two variations of each function, one that takes a <code>BlockWithArgs</code> and one that takes the pair of <code>Block</code> and <code>Value</code> slice?</li>
<li>[x] I'm not 100% confident that I've found everywhere that we're using instruction arguments and block arguments interchangeably. Is there a good way to track this down beyond fuzzing?</li>
</ul>
<p>&lt;!--</p>
<p>Please ensure that the following steps are all taken care of before submitting<br>
the PR.</p>
<ul>
<li>
<p>[ ] This has been discussed in issue #..., or if not, please tell us why<br>
  here.</p>
</li>
<li>
<p>[ ] A short description of what this does, why it is needed; if the<br>
  description becomes long, the matter should probably be discussed in an issue<br>
  first.</p>
</li>
<li>
<p>[ ] This PR contains test cases, if meaningful.</p>
</li>
<li>[ ] A reviewer from the core maintainer team has been assigned for this PR.<br>
  If you don't know who could review this, please indicate so. The list of<br>
  suggested reviewers on the right can help you.</li>
</ul>
<p>Please ensure all communication adheres to the <a href="https://github.com/bytecodealliance/wasmtime/blob/master/CODE_OF_CONDUCT.md">code of
conduct</a>.<br>
--&gt;<br>
</p>
</blockquote>



<a name="320354815"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%235464%20cranelift%3A%20Rework%20block%20instructions%20.../near/320354815" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.235464.20cranelift.3A.20Rework.20block.20instructions.20.2E.2E.2E.html#320354815">(Jan 10 2023 at 00:02)</a>:</h4>
<p>jameysharp submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/5464#pullrequestreview-1241318124">PR review</a>.</p>



<a name="320354816"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%235464%20cranelift%3A%20Rework%20block%20instructions%20.../near/320354816" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.235464.20cranelift.3A.20Rework.20block.20instructions.20.2E.2E.2E.html#320354816">(Jan 10 2023 at 00:02)</a>:</h4>
<p>jameysharp created <a href="https://github.com/bytecodealliance/wasmtime/pull/5464#discussion_r1065193641">PR review comment</a>:</p>
<blockquote>
<p>I was concerned about silently deleting the "Can't use <code>.sum()</code> for <code>Cost</code> types" comment and then effectively implementing our own version of <code>Iterator::sum</code>. But I see that <code>Cost</code> does implement <code>std::ops::Add</code> and this statement was already relying on <code>+</code> being overloaded. So I'm pretty sure this change is correct.</p>
</blockquote>



<a name="320354817"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%235464%20cranelift%3A%20Rework%20block%20instructions%20.../near/320354817" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.235464.20cranelift.3A.20Rework.20block.20instructions.20.2E.2E.2E.html#320354817">(Jan 10 2023 at 00:02)</a>:</h4>
<p>jameysharp submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/5464#pullrequestreview-1241318124">PR review</a>.</p>



<a name="320363557"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%235464%20cranelift%3A%20Rework%20block%20instructions%20.../near/320363557" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.235464.20cranelift.3A.20Rework.20block.20instructions.20.2E.2E.2E.html#320363557">(Jan 10 2023 at 01:30)</a>:</h4>
<p>elliottt updated <a href="https://github.com/bytecodealliance/wasmtime/pull/5464">PR #5464</a> from <code>trevor/block-with-args</code> to <code>main</code>.</p>



<a name="320495623"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%235464%20cranelift%3A%20Rework%20block%20instructions%20.../near/320495623" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.235464.20cranelift.3A.20Rework.20block.20instructions.20.2E.2E.2E.html#320495623">(Jan 10 2023 at 16:48)</a>:</h4>
<p>elliottt updated <a href="https://github.com/bytecodealliance/wasmtime/pull/5464">PR #5464</a> from <code>trevor/block-with-args</code> to <code>main</code>.</p>



<a name="320496140"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%235464%20cranelift%3A%20Rework%20block%20instructions%20.../near/320496140" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.235464.20cranelift.3A.20Rework.20block.20instructions.20.2E.2E.2E.html#320496140">(Jan 10 2023 at 16:50)</a>:</h4>
<p>elliottt updated <a href="https://github.com/bytecodealliance/wasmtime/pull/5464">PR #5464</a> from <code>trevor/block-with-args</code> to <code>main</code>.</p>



<a name="320497016"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%235464%20cranelift%3A%20Rework%20block%20instructions%20.../near/320497016" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.235464.20cranelift.3A.20Rework.20block.20instructions.20.2E.2E.2E.html#320497016">(Jan 10 2023 at 16:54)</a>:</h4>
<p>elliottt updated <a href="https://github.com/bytecodealliance/wasmtime/pull/5464">PR #5464</a> from <code>trevor/block-with-args</code> to <code>main</code>.</p>



<a name="320524789"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%235464%20cranelift%3A%20Rework%20block%20instructions%20.../near/320524789" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.235464.20cranelift.3A.20Rework.20block.20instructions.20.2E.2E.2E.html#320524789">(Jan 10 2023 at 19:08)</a>:</h4>
<p>elliottt updated <a href="https://github.com/bytecodealliance/wasmtime/pull/5464">PR #5464</a> from <code>trevor/block-with-args</code> to <code>main</code>.</p>



<a name="320528997"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%235464%20cranelift%3A%20Rework%20block%20instructions%20.../near/320528997" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.235464.20cranelift.3A.20Rework.20block.20instructions.20.2E.2E.2E.html#320528997">(Jan 10 2023 at 19:30)</a>:</h4>
<p>elliottt updated <a href="https://github.com/bytecodealliance/wasmtime/pull/5464">PR #5464</a> from <code>trevor/block-with-args</code> to <code>main</code>.</p>



<a name="320529162"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%235464%20cranelift%3A%20Rework%20block%20instructions%20.../near/320529162" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.235464.20cranelift.3A.20Rework.20block.20instructions.20.2E.2E.2E.html#320529162">(Jan 10 2023 at 19:31)</a>:</h4>
<p>elliottt edited <a href="https://github.com/bytecodealliance/wasmtime/pull/5464">PR #5464</a> from <code>trevor/block-with-args</code> to <code>main</code>:</p>
<blockquote>
<p>Add a new type <code>BlockWithArgs</code> that represents the pair of a block name with arguments to be passed to it. Rework the implementation of <code>jump</code>, <code>brz</code>, and <code>brnz</code> to use <code>BlockWithArgs</code> instead of storing the block arguments as varargs in the instruction's <code>ValueList</code>.</p>
<p>Some open questions:</p>
<ul>
<li>[x] Does the return value of  <code>num_fixed_actuals</code> function still make sense for <code>brz</code> and <code>brnz</code> even though they no longer store their control argument in the instruction's argument list?</li>
<li>[x] The reworked builder api for <code>jump</code>, <code>brz</code>, and <code>brnz</code> is not very nice to work with. Can we generate two variations of each function, one that takes a <code>BlockWithArgs</code> and one that takes the pair of <code>Block</code> and <code>Value</code> slice?</li>
<li>[x] I'm not 100% confident that I've found everywhere that we're using instruction arguments and block arguments interchangeably. Is there a good way to track this down beyond fuzzing?</li>
</ul>
<p>&lt;!--</p>
<p>Please ensure that the following steps are all taken care of before submitting<br>
the PR.</p>
<ul>
<li>
<p>[ ] This has been discussed in issue #..., or if not, please tell us why<br>
  here.</p>
</li>
<li>
<p>[ ] A short description of what this does, why it is needed; if the<br>
  description becomes long, the matter should probably be discussed in an issue<br>
  first.</p>
</li>
<li>
<p>[ ] This PR contains test cases, if meaningful.</p>
</li>
<li>[ ] A reviewer from the core maintainer team has been assigned for this PR.<br>
  If you don't know who could review this, please indicate so. The list of<br>
  suggested reviewers on the right can help you.</li>
</ul>
<p>Please ensure all communication adheres to the <a href="https://github.com/bytecodealliance/wasmtime/blob/master/CODE_OF_CONDUCT.md">code of
conduct</a>.<br>
--&gt;<br>
</p>
</blockquote>



<a name="320529857"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%235464%20cranelift%3A%20Rework%20block%20instructions%20.../near/320529857" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.235464.20cranelift.3A.20Rework.20block.20instructions.20.2E.2E.2E.html#320529857">(Jan 10 2023 at 19:35)</a>:</h4>
<p>elliottt edited <a href="https://github.com/bytecodealliance/wasmtime/pull/5464">PR #5464</a> from <code>trevor/block-with-args</code> to <code>main</code>:</p>
<blockquote>
<p>Add a new type <code>BlockCall</code> that represents the pair of a block name with arguments to be passed to it. (The mnemonic here is that it looks a bit like a function call.) Rework the implementation of <code>jump</code>, <code>brz</code>, and <code>brnz</code> to use <code>BlockCall</code> instead of storing the block arguments as varargs in the instruction's <code>ValueList</code>.</p>
<p>To ensure that we're processing value references from <code>BlockCall</code> values held in instructions, introduce three new functions on <code>DataFlowGraph</code>: <code>inst_values</code>, <code>inst_values_mut</code>, and <code>inst_values_mut_with</code>. The first function returns an iterator that traverses both the instruction and block arguments, while the latter two return a custom type that has a single <code>map</code> function for mutating the values referenced. The <code>inst_values_mut_with</code> variant exists for cases where the <code>DataFlowGraph</code> being mutated is held within another structure that needs to be mutated simultaneously.</p>
<p>&lt;!--</p>
<p>Please ensure that the following steps are all taken care of before submitting<br>
the PR.</p>
<ul>
<li>
<p>[ ] This has been discussed in issue #..., or if not, please tell us why<br>
  here.</p>
</li>
<li>
<p>[ ] A short description of what this does, why it is needed; if the<br>
  description becomes long, the matter should probably be discussed in an issue<br>
  first.</p>
</li>
<li>
<p>[ ] This PR contains test cases, if meaningful.</p>
</li>
<li>[ ] A reviewer from the core maintainer team has been assigned for this PR.<br>
  If you don't know who could review this, please indicate so. The list of<br>
  suggested reviewers on the right can help you.</li>
</ul>
<p>Please ensure all communication adheres to the <a href="https://github.com/bytecodealliance/wasmtime/blob/master/CODE_OF_CONDUCT.md">code of
conduct</a>.<br>
--&gt;<br>
</p>
</blockquote>



<a name="320529938"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%235464%20cranelift%3A%20Rework%20block%20instructions%20.../near/320529938" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.235464.20cranelift.3A.20Rework.20block.20instructions.20.2E.2E.2E.html#320529938">(Jan 10 2023 at 19:36)</a>:</h4>
<p><strong>elliottt</strong> has marked <a href="https://github.com/bytecodealliance/wasmtime/pull/5464">PR #5464</a> as ready for review.</p>



<a name="320530446"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%235464%20cranelift%3A%20Rework%20block%20instructions%20.../near/320530446" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.235464.20cranelift.3A.20Rework.20block.20instructions.20.2E.2E.2E.html#320530446">(Jan 10 2023 at 19:39)</a>:</h4>
<p>elliottt edited <a href="https://github.com/bytecodealliance/wasmtime/pull/5464">PR #5464</a> from <code>trevor/block-with-args</code> to <code>main</code>:</p>
<blockquote>
<p>Add a new type <code>BlockCall</code> that represents the pair of a block name with arguments to be passed to it. (The mnemonic here is that it looks a bit like a function call.) Rework the implementation of <code>jump</code>, <code>brz</code>, and <code>brnz</code> to use <code>BlockCall</code> instead of storing the block arguments as varargs in the instruction's <code>ValueList</code>.</p>
<p>To ensure that we're processing value references from <code>BlockCall</code> values held in instructions, introduce three new functions on <code>DataFlowGraph</code>: <code>inst_values</code>, <code>inst_values_mut</code>, and <code>inst_values_mut_with</code>. The first function returns an iterator that traverses both the instruction and block arguments, while the latter two return a custom type that has a single <code>map</code> function for mutating the values referenced. The <code>inst_values_mut_with</code> variant exists for cases where the <code>DataFlowGraph</code> being mutated is held within another structure that needs to be mutated simultaneously.</p>
<p>I went through the existing uses of <code>inst_args</code>, <code>inst_fixed_args</code>, <code>inst_variable_args</code>, and their mut variants to decide whether or not they should be using the new iterator interface introduced above. Many needed to be migrated over, but there were cases where the original instruction was correct: the fuzzgen passes for fcvt and int_divz are examples of where the block args were never being indexed.</p>
<p>&lt;!--</p>
<p>Please ensure that the following steps are all taken care of before submitting<br>
the PR.</p>
<ul>
<li>
<p>[ ] This has been discussed in issue #..., or if not, please tell us why<br>
  here.</p>
</li>
<li>
<p>[ ] A short description of what this does, why it is needed; if the<br>
  description becomes long, the matter should probably be discussed in an issue<br>
  first.</p>
</li>
<li>
<p>[ ] This PR contains test cases, if meaningful.</p>
</li>
<li>[ ] A reviewer from the core maintainer team has been assigned for this PR.<br>
  If you don't know who could review this, please indicate so. The list of<br>
  suggested reviewers on the right can help you.</li>
</ul>
<p>Please ensure all communication adheres to the <a href="https://github.com/bytecodealliance/wasmtime/blob/master/CODE_OF_CONDUCT.md">code of
conduct</a>.<br>
--&gt;<br>
</p>
</blockquote>



<a name="320530455"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%235464%20cranelift%3A%20Rework%20block%20instructions%20.../near/320530455" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.235464.20cranelift.3A.20Rework.20block.20instructions.20.2E.2E.2E.html#320530455">(Jan 10 2023 at 19:39)</a>:</h4>
<p><strong>elliottt</strong> requested <a href="https://github.com/jameysharp">jameysharp</a> for a review on <a href="https://github.com/bytecodealliance/wasmtime/pull/5464">PR #5464</a>.</p>



<a name="320561678"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%235464%20cranelift%3A%20Rework%20block%20instructions%20.../near/320561678" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.235464.20cranelift.3A.20Rework.20block.20instructions.20.2E.2E.2E.html#320561678">(Jan 10 2023 at 23:01)</a>:</h4>
<p>elliottt updated <a href="https://github.com/bytecodealliance/wasmtime/pull/5464">PR #5464</a> from <code>trevor/block-with-args</code> to <code>main</code>.</p>



<a name="320564812"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%235464%20cranelift%3A%20Rework%20block%20instructions%20.../near/320564812" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.235464.20cranelift.3A.20Rework.20block.20instructions.20.2E.2E.2E.html#320564812">(Jan 10 2023 at 23:29)</a>:</h4>
<p>elliottt edited <a href="https://github.com/bytecodealliance/wasmtime/pull/5464">PR #5464</a> from <code>trevor/block-with-args</code> to <code>main</code>:</p>
<blockquote>
<p>Add a new type <code>BlockCall</code> that represents the pair of a block name with arguments to be passed to it. (The mnemonic here is that it looks a bit like a function call.) Rework the implementation of <code>jump</code>, <code>brz</code>, and <code>brnz</code> to use <code>BlockCall</code> instead of storing the block arguments as varargs in the instruction's <code>ValueList</code>.</p>
<p>To ensure that we're processing block arguments from <code>BlockCall</code> values in instructions, three new functions have been introduced on <code>DataFlowGraph</code> that both sets of arguments: </p>
<ul>
<li><code>inst_values</code> - returns an iterator that traverses values in the instruction and block arguments</li>
<li><code>map_inst_values</code> - applies a function to each value in the instruction and block arguments</li>
<li><code>overwrite_inst_values</code> - overwrite all values in an instruction and block arguments with values from the iterator</li>
</ul>
<p>I went through the existing uses of <code>inst_args</code>, <code>inst_fixed_args</code>, <code>inst_variable_args</code>, and their mut variants to decide whether or not they should be using the new iterator interface introduced above. Many needed to be migrated over, but there were cases where the original instruction was correct: the fuzzgen passes for fcvt and int_divz are examples of where the block args were never being indexed.</p>
<p>&lt;!--</p>
<p>Please ensure that the following steps are all taken care of before submitting<br>
the PR.</p>
<ul>
<li>
<p>[ ] This has been discussed in issue #..., or if not, please tell us why<br>
  here.</p>
</li>
<li>
<p>[ ] A short description of what this does, why it is needed; if the<br>
  description becomes long, the matter should probably be discussed in an issue<br>
  first.</p>
</li>
<li>
<p>[ ] This PR contains test cases, if meaningful.</p>
</li>
<li>[ ] A reviewer from the core maintainer team has been assigned for this PR.<br>
  If you don't know who could review this, please indicate so. The list of<br>
  suggested reviewers on the right can help you.</li>
</ul>
<p>Please ensure all communication adheres to the <a href="https://github.com/bytecodealliance/wasmtime/blob/master/CODE_OF_CONDUCT.md">code of
conduct</a>.<br>
--&gt;<br>
</p>
</blockquote>



<a name="320581238"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%235464%20cranelift%3A%20Rework%20block%20instructions%20.../near/320581238" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.235464.20cranelift.3A.20Rework.20block.20instructions.20.2E.2E.2E.html#320581238">(Jan 11 2023 at 02:27)</a>:</h4>
<p>jameysharp submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/5464#pullrequestreview-1243126646">PR review</a>.</p>



<a name="320581239"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%235464%20cranelift%3A%20Rework%20block%20instructions%20.../near/320581239" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.235464.20cranelift.3A.20Rework.20block.20instructions.20.2E.2E.2E.html#320581239">(Jan 11 2023 at 02:27)</a>:</h4>
<p>jameysharp submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/5464#pullrequestreview-1243126646">PR review</a>.</p>



<a name="320581241"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%235464%20cranelift%3A%20Rework%20block%20instructions%20.../near/320581241" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.235464.20cranelift.3A.20Rework.20block.20instructions.20.2E.2E.2E.html#320581241">(Jan 11 2023 at 02:27)</a>:</h4>
<p>jameysharp created <a href="https://github.com/bytecodealliance/wasmtime/pull/5464#discussion_r1066459265">PR review comment</a>:</p>
<blockquote>
<p>I believe every part of this iterator supports access from both ends. If true, that means you can change the declaration this way, I think, and then callers can use <code>Iterator::rev</code> if they want.</p>
<p><div class="codehilite" data-code-language="suggestion"><pre><span></span><code>    pub fn inst_values&lt;'dfg&gt;(&amp;'dfg self, inst: Inst) -&gt; impl DoubleEndedIterator&lt;Item = Value&gt; + 'dfg {
</code></pre></div><br>
</p>
</blockquote>



<a name="320581242"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%235464%20cranelift%3A%20Rework%20block%20instructions%20.../near/320581242" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.235464.20cranelift.3A.20Rework.20block.20instructions.20.2E.2E.2E.html#320581242">(Jan 11 2023 at 02:27)</a>:</h4>
<p>jameysharp created <a href="https://github.com/bytecodealliance/wasmtime/pull/5464#discussion_r1066454633">PR review comment</a>:</p>
<blockquote>
<p>Continuing the theme, how about renaming <code>block</code> here to <code>block_call</code> and extending the documentation to "Destination basic block, with its arguments provided"?</p>
</blockquote>



<a name="320581243"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%235464%20cranelift%3A%20Rework%20block%20instructions%20.../near/320581243" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.235464.20cranelift.3A.20Rework.20block.20instructions.20.2E.2E.2E.html#320581243">(Jan 11 2023 at 02:27)</a>:</h4>
<p>jameysharp created <a href="https://github.com/bytecodealliance/wasmtime/pull/5464#discussion_r1066455831">PR review comment</a>:</p>
<blockquote>
<p>I guess this blank line doesn't really need to be added here.</p>
</blockquote>



<a name="320581244"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%235464%20cranelift%3A%20Rework%20block%20instructions%20.../near/320581244" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.235464.20cranelift.3A.20Rework.20block.20instructions.20.2E.2E.2E.html#320581244">(Jan 11 2023 at 02:27)</a>:</h4>
<p>jameysharp created <a href="https://github.com/bytecodealliance/wasmtime/pull/5464#discussion_r1066460809">PR review comment</a>:</p>
<blockquote>
<p>Since it turned out that <code>inst_values</code> can return an iterator, you can replace all the uses of <code>for_each</code> with <code>for</code> loops. In cases like this one that's good both because it minimizes the diff here and because <code>for_each</code> is generally discouraged, as a Rust idiom. Switching back to <code>for</code> loops is a bigger win for the uses of <code>try_for_each</code>, which can just use <code>break</code> statements or the <code>?</code> operator instead of <code>ControlFlow</code>.</p>
</blockquote>



<a name="320581245"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%235464%20cranelift%3A%20Rework%20block%20instructions%20.../near/320581245" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.235464.20cranelift.3A.20Rework.20block.20instructions.20.2E.2E.2E.html#320581245">(Jan 11 2023 at 02:27)</a>:</h4>
<p>jameysharp created <a href="https://github.com/bytecodealliance/wasmtime/pull/5464#discussion_r1066465376">PR review comment</a>:</p>
<blockquote>
<p>The comment isn't quite true: This vector can't be moved onto <code>self</code>, since the reason for introducing it is to avoid holding borrows of <code>self</code> across calls to <code>self.elaborate_eclass_use</code>.</p>
<p>But this function, <code>elaborate_block</code>, is only called from <code>elaborate_domtree</code>, so the vector could be allocated there and passed in by reference. That function in turn is called only once for the pass, so allocating the temporary storage there is as good as storing it on <code>self</code> would be.</p>
</blockquote>



<a name="320581246"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%235464%20cranelift%3A%20Rework%20block%20instructions%20.../near/320581246" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.235464.20cranelift.3A.20Rework.20block.20instructions.20.2E.2E.2E.html#320581246">(Jan 11 2023 at 02:27)</a>:</h4>
<p>jameysharp created <a href="https://github.com/bytecodealliance/wasmtime/pull/5464#discussion_r1066463286">PR review comment</a>:</p>
<blockquote>
<p>I think most of the changes around here can be undone, assuming that <code>self.func.dfg.inst_values(inst)</code> can return a <code>DoubleEndedIterator</code>.</p>
</blockquote>



<a name="320581247"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%235464%20cranelift%3A%20Rework%20block%20instructions%20.../near/320581247" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.235464.20cranelift.3A.20Rework.20block.20instructions.20.2E.2E.2E.html#320581247">(Jan 11 2023 at 02:27)</a>:</h4>
<p>jameysharp created <a href="https://github.com/bytecodealliance/wasmtime/pull/5464#discussion_r1066455445">PR review comment</a>:</p>
<blockquote>
<p>I've never had reason to use this Rust format-string syntax before, but this seems like a good place for it:</p>
<p><div class="codehilite" data-code-language="suggestion"><pre><span></span><code>                "let {0} = self.data_flow_graph_mut().block_with_args({0}_label, {0}_args);",
                op.name
</code></pre></div><br>
</p>
</blockquote>



<a name="320581248"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%235464%20cranelift%3A%20Rework%20block%20instructions%20.../near/320581248" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.235464.20cranelift.3A.20Rework.20block.20instructions.20.2E.2E.2E.html#320581248">(Jan 11 2023 at 02:27)</a>:</h4>
<p>jameysharp created <a href="https://github.com/bytecodealliance/wasmtime/pull/5464#discussion_r1066467072">PR review comment</a>:</p>
<blockquote>
<p>I'm amused that leaving the semicolon off here is legal, but let's not...</p>
<p><div class="codehilite" data-code-language="suggestion"><pre><span></span><code>                *arg = new_arg.value;
</code></pre></div><br>
</p>
</blockquote>



<a name="320581249"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%235464%20cranelift%3A%20Rework%20block%20instructions%20.../near/320581249" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.235464.20cranelift.3A.20Rework.20block.20instructions.20.2E.2E.2E.html#320581249">(Jan 11 2023 at 02:27)</a>:</h4>
<p>jameysharp created <a href="https://github.com/bytecodealliance/wasmtime/pull/5464#discussion_r1066466169">PR review comment</a>:</p>
<blockquote>
<p>A minor cleanup here is to call <code>Vec::drain</code> instead of <code>iter</code>, <code>copied</code>, and <code>clear</code>.</p>
<p><div class="codehilite" data-code-language="suggestion"><pre><span></span><code>            self.func
                .dfg
                .overwrite_inst_values(inst, elab_values.drain(..));
</code></pre></div><br>
</p>
</blockquote>



<a name="320581250"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%235464%20cranelift%3A%20Rework%20block%20instructions%20.../near/320581250" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.235464.20cranelift.3A.20Rework.20block.20instructions.20.2E.2E.2E.html#320581250">(Jan 11 2023 at 02:27)</a>:</h4>
<p>jameysharp created <a href="https://github.com/bytecodealliance/wasmtime/pull/5464#discussion_r1066472886">PR review comment</a>:</p>
<blockquote>
<p>Minor style note: a <code>for</code> loop always calls <code>into_iter</code>, so you don't need to do it here.</p>
<p><div class="codehilite" data-code-language="suggestion"><pre><span></span><code>        for mut block in self.insts[inst].branch_destination() {
</code></pre></div><br>
</p>
</blockquote>



<a name="320581251"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%235464%20cranelift%3A%20Rework%20block%20instructions%20.../near/320581251" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.235464.20cranelift.3A.20Rework.20block.20instructions.20.2E.2E.2E.html#320581251">(Jan 11 2023 at 02:27)</a>:</h4>
<p>jameysharp created <a href="https://github.com/bytecodealliance/wasmtime/pull/5464#discussion_r1066488732">PR review comment</a>:</p>
<blockquote>
<p>Like the <code>for_each</code> calls, now that <code>inst_values</code> is an iterator this can turn back into a <code>for</code> loop with an early return.</p>
</blockquote>



<a name="320581252"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%235464%20cranelift%3A%20Rework%20block%20instructions%20.../near/320581252" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.235464.20cranelift.3A.20Rework.20block.20instructions.20.2E.2E.2E.html#320581252">(Jan 11 2023 at 02:27)</a>:</h4>
<p>jameysharp created <a href="https://github.com/bytecodealliance/wasmtime/pull/5464#discussion_r1066470221">PR review comment</a>:</p>
<blockquote>
<p>I don't see that this <code>count_values</code> method is used anywhere. Am I missing something?</p>
</blockquote>



<a name="320581253"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%235464%20cranelift%3A%20Rework%20block%20instructions%20.../near/320581253" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.235464.20cranelift.3A.20Rework.20block.20instructions.20.2E.2E.2E.html#320581253">(Jan 11 2023 at 02:27)</a>:</h4>
<p>jameysharp created <a href="https://github.com/bytecodealliance/wasmtime/pull/5464#discussion_r1066468163">PR review comment</a>:</p>
<blockquote>
<p>Since <code>map_inst_values</code> writes back unconditionally, let's not bother checking for unchanged values here either. (I expect rustfmt will want the outer curly braces removed too, but GitHub won't let me do suggestions on the full range of lines here.)</p>
<p><div class="codehilite" data-code-language="suggestion"><pre><span></span><code>            resolve_aliases(&amp;dfg.values, arg)
</code></pre></div><br>
</p>
</blockquote>



<a name="320581254"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%235464%20cranelift%3A%20Rework%20block%20instructions%20.../near/320581254" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.235464.20cranelift.3A.20Rework.20block.20instructions.20.2E.2E.2E.html#320581254">(Jan 11 2023 at 02:27)</a>:</h4>
<p>jameysharp created <a href="https://github.com/bytecodealliance/wasmtime/pull/5464#discussion_r1066482909">PR review comment</a>:</p>
<blockquote>
<p><code>into_iter</code> isn't necessary here either:</p>
<p><div class="codehilite" data-code-language="suggestion"><pre><span></span><code>        for mut block in self.insts[inst].branch_destination() {
</code></pre></div><br>
</p>
</blockquote>



<a name="320581255"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%235464%20cranelift%3A%20Rework%20block%20instructions%20.../near/320581255" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.235464.20cranelift.3A.20Rework.20block.20instructions.20.2E.2E.2E.html#320581255">(Jan 11 2023 at 02:27)</a>:</h4>
<p>jameysharp created <a href="https://github.com/bytecodealliance/wasmtime/pull/5464#discussion_r1066498273">PR review comment</a>:</p>
<blockquote>
<p>Good call updating this comment. Maybe "a count only of the <code>Value</code> arguments" or something along those lines? It doesn't include various kinds of immediate arguments either.</p>
</blockquote>



<a name="320581256"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%235464%20cranelift%3A%20Rework%20block%20instructions%20.../near/320581256" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.235464.20cranelift.3A.20Rework.20block.20instructions.20.2E.2E.2E.html#320581256">(Jan 11 2023 at 02:27)</a>:</h4>
<p>jameysharp created <a href="https://github.com/bytecodealliance/wasmtime/pull/5464#discussion_r1066504697">PR review comment</a>:</p>
<blockquote>
<p>This closure is called with <code>block</code> set to <code>branch()</code>, which is then shadowed here with the same value. I think this closure shouldn't take any arguments.</p>
<p>With that change, I think this will be the only call to <code>branch()</code>, so I'd inline it into <code>continue_at</code>.</p>
</blockquote>



<a name="320581257"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%235464%20cranelift%3A%20Rework%20block%20instructions%20.../near/320581257" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.235464.20cranelift.3A.20Rework.20block.20instructions.20.2E.2E.2E.html#320581257">(Jan 11 2023 at 02:27)</a>:</h4>
<p>jameysharp created <a href="https://github.com/bytecodealliance/wasmtime/pull/5464#discussion_r1066508411">PR review comment</a>:</p>
<blockquote>
<p>Do you suppose this function should be renamed to <code>block_call</code> now, or perhaps <code>make_block_call</code> or something? I think calling it <code>block_with_args</code> isn't terrible but it's worth taking a moment to think about it.</p>
<p>Also, there are various comments that still refer to <code>BlockWithArgs</code>, like this one and a bunch of places in <code>instructions.rs</code>.</p>
</blockquote>



<a name="320581258"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%235464%20cranelift%3A%20Rework%20block%20instructions%20.../near/320581258" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.235464.20cranelift.3A.20Rework.20block.20instructions.20.2E.2E.2E.html#320581258">(Jan 11 2023 at 02:27)</a>:</h4>
<p>jameysharp created <a href="https://github.com/bytecodealliance/wasmtime/pull/5464#discussion_r1066497679">PR review comment</a>:</p>
<blockquote>
<p>I wonder if this alternative is any better (after applying rustfmt, anyway). What do you think?</p>
<p><div class="codehilite" data-code-language="suggestion"><pre><span></span><code>            let branch_args = self.f.dfg.insts[inst].branch_destination().into_iter().flat_map(|block| block.args_slice(&amp;self.f.dfg.value_lists));
</code></pre></div><br>
</p>
</blockquote>



<a name="320581259"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%235464%20cranelift%3A%20Rework%20block%20instructions%20.../near/320581259" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.235464.20cranelift.3A.20Rework.20block.20instructions.20.2E.2E.2E.html#320581259">(Jan 11 2023 at 02:27)</a>:</h4>
<p>jameysharp created <a href="https://github.com/bytecodealliance/wasmtime/pull/5464#discussion_r1066508783">PR review comment</a>:</p>
<blockquote>
<p>Another place where <code>into_iter</code> isn't necessary:</p>
<p><div class="codehilite" data-code-language="suggestion"><pre><span></span><code>            for branch in dfg.insts[pred.inst].branch_destination_mut() {
</code></pre></div><br>
</p>
</blockquote>



<a name="320596966"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%235464%20cranelift%3A%20Rework%20block%20instructions%20.../near/320596966" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.235464.20cranelift.3A.20Rework.20block.20instructions.20.2E.2E.2E.html#320596966">(Jan 11 2023 at 04:47)</a>:</h4>
<p>elliottt submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/5464#pullrequestreview-1243281497">PR review</a>.</p>



<a name="320596967"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%235464%20cranelift%3A%20Rework%20block%20instructions%20.../near/320596967" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.235464.20cranelift.3A.20Rework.20block.20instructions.20.2E.2E.2E.html#320596967">(Jan 11 2023 at 04:47)</a>:</h4>
<p>elliottt created <a href="https://github.com/bytecodealliance/wasmtime/pull/5464#discussion_r1066569088">PR review comment</a>:</p>
<blockquote>
<p>I'm surprised this wasn't caught by rustfmt!</p>
</blockquote>



<a name="320596997"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%235464%20cranelift%3A%20Rework%20block%20instructions%20.../near/320596997" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.235464.20cranelift.3A.20Rework.20block.20instructions.20.2E.2E.2E.html#320596997">(Jan 11 2023 at 04:47)</a>:</h4>
<p>elliottt deleted <a href="https://github.com/bytecodealliance/wasmtime/pull/5464#discussion_r1066569088">PR review comment</a>.</p>



<a name="320597168"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%235464%20cranelift%3A%20Rework%20block%20instructions%20.../near/320597168" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.235464.20cranelift.3A.20Rework.20block.20instructions.20.2E.2E.2E.html#320597168">(Jan 11 2023 at 04:48)</a>:</h4>
<p>elliottt submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/5464#pullrequestreview-1243282221">PR review</a>.</p>



<a name="320597170"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%235464%20cranelift%3A%20Rework%20block%20instructions%20.../near/320597170" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.235464.20cranelift.3A.20Rework.20block.20instructions.20.2E.2E.2E.html#320597170">(Jan 11 2023 at 04:48)</a>:</h4>
<p>elliottt created <a href="https://github.com/bytecodealliance/wasmtime/pull/5464#discussion_r1066569562">PR review comment</a>:</p>
<blockquote>
<p>It was left-over from an earlier refactoring, thanks for catching it!</p>
</blockquote>



<a name="320597492"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%235464%20cranelift%3A%20Rework%20block%20instructions%20.../near/320597492" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.235464.20cranelift.3A.20Rework.20block.20instructions.20.2E.2E.2E.html#320597492">(Jan 11 2023 at 04:50)</a>:</h4>
<p>elliottt submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/5464#pullrequestreview-1243283125">PR review</a>.</p>



<a name="320597493"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%235464%20cranelift%3A%20Rework%20block%20instructions%20.../near/320597493" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.235464.20cranelift.3A.20Rework.20block.20instructions.20.2E.2E.2E.html#320597493">(Jan 11 2023 at 04:50)</a>:</h4>
<p>elliottt created <a href="https://github.com/bytecodealliance/wasmtime/pull/5464#discussion_r1066570182">PR review comment</a>:</p>
<blockquote>
<p>Ah, this was to avoid a warning. Do you mind if we leave these for now and remove them once <code>branch_destination</code> returns a slice?</p>
</blockquote>



<a name="320598351"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%235464%20cranelift%3A%20Rework%20block%20instructions%20.../near/320598351" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.235464.20cranelift.3A.20Rework.20block.20instructions.20.2E.2E.2E.html#320598351">(Jan 11 2023 at 04:56)</a>:</h4>
<p>elliottt updated <a href="https://github.com/bytecodealliance/wasmtime/pull/5464">PR #5464</a> from <code>trevor/block-with-args</code> to <code>main</code>.</p>



<a name="320739437"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%235464%20cranelift%3A%20Rework%20block%20instructions%20.../near/320739437" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.235464.20cranelift.3A.20Rework.20block.20instructions.20.2E.2E.2E.html#320739437">(Jan 11 2023 at 16:09)</a>:</h4>
<p>jameysharp created <a href="https://github.com/bytecodealliance/wasmtime/pull/5464#discussion_r1067182538">PR review comment</a>:</p>
<blockquote>
<p>Oh, that makes sense! Sure, leave the <code>.into_iter()</code> calls in, that's fine.</p>
</blockquote>



<a name="320739440"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%235464%20cranelift%3A%20Rework%20block%20instructions%20.../near/320739440" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.235464.20cranelift.3A.20Rework.20block.20instructions.20.2E.2E.2E.html#320739440">(Jan 11 2023 at 16:09)</a>:</h4>
<p>jameysharp submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/5464#pullrequestreview-1244198765">PR review</a>.</p>



<a name="320742319"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%235464%20cranelift%3A%20Rework%20block%20instructions%20.../near/320742319" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.235464.20cranelift.3A.20Rework.20block.20instructions.20.2E.2E.2E.html#320742319">(Jan 11 2023 at 16:21)</a>:</h4>
<p>jameysharp submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/5464#pullrequestreview-1244219720">PR review</a>.</p>



<a name="320742321"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%235464%20cranelift%3A%20Rework%20block%20instructions%20.../near/320742321" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.235464.20cranelift.3A.20Rework.20block.20instructions.20.2E.2E.2E.html#320742321">(Jan 11 2023 at 16:21)</a>:</h4>
<p>jameysharp created <a href="https://github.com/bytecodealliance/wasmtime/pull/5464#discussion_r1067196616">PR review comment</a>:</p>
<blockquote>
<p>I guess the current CI failure is that this <code>use</code> item is no longer necessary.</p>
</blockquote>



<a name="320752455"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%235464%20cranelift%3A%20Rework%20block%20instructions%20.../near/320752455" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.235464.20cranelift.3A.20Rework.20block.20instructions.20.2E.2E.2E.html#320752455">(Jan 11 2023 at 17:06)</a>:</h4>
<p>elliottt submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/5464#pullrequestreview-1244295055">PR review</a>.</p>



<a name="320752456"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%235464%20cranelift%3A%20Rework%20block%20instructions%20.../near/320752456" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.235464.20cranelift.3A.20Rework.20block.20instructions.20.2E.2E.2E.html#320752456">(Jan 11 2023 at 17:06)</a>:</h4>
<p>elliottt created <a href="https://github.com/bytecodealliance/wasmtime/pull/5464#discussion_r1067247240">PR review comment</a>:</p>
<blockquote>
<p>I've removed the comment and implemented that change, thanks!</p>
</blockquote>



<a name="320759943"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%235464%20cranelift%3A%20Rework%20block%20instructions%20.../near/320759943" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.235464.20cranelift.3A.20Rework.20block.20instructions.20.2E.2E.2E.html#320759943">(Jan 11 2023 at 17:43)</a>:</h4>
<p>elliottt submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/5464#pullrequestreview-1244350310">PR review</a>.</p>



<a name="320759944"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%235464%20cranelift%3A%20Rework%20block%20instructions%20.../near/320759944" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.235464.20cranelift.3A.20Rework.20block.20instructions.20.2E.2E.2E.html#320759944">(Jan 11 2023 at 17:43)</a>:</h4>
<p>elliottt created <a href="https://github.com/bytecodealliance/wasmtime/pull/5464#discussion_r1067284384">PR review comment</a>:</p>
<blockquote>
<p>I like it!</p>
</blockquote>



<a name="320783161"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%235464%20cranelift%3A%20Rework%20block%20instructions%20.../near/320783161" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.235464.20cranelift.3A.20Rework.20block.20instructions.20.2E.2E.2E.html#320783161">(Jan 11 2023 at 19:42)</a>:</h4>
<p>elliottt updated <a href="https://github.com/bytecodealliance/wasmtime/pull/5464">PR #5464</a> from <code>trevor/block-with-args</code> to <code>main</code>.</p>



<a name="320784748"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%235464%20cranelift%3A%20Rework%20block%20instructions%20.../near/320784748" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.235464.20cranelift.3A.20Rework.20block.20instructions.20.2E.2E.2E.html#320784748">(Jan 11 2023 at 19:50)</a>:</h4>
<p>elliottt updated <a href="https://github.com/bytecodealliance/wasmtime/pull/5464">PR #5464</a> from <code>trevor/block-with-args</code> to <code>main</code>.</p>



<a name="320784911"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%235464%20cranelift%3A%20Rework%20block%20instructions%20.../near/320784911" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.235464.20cranelift.3A.20Rework.20block.20instructions.20.2E.2E.2E.html#320784911">(Jan 11 2023 at 19:51)</a>:</h4>
<p>elliottt updated <a href="https://github.com/bytecodealliance/wasmtime/pull/5464">PR #5464</a> from <code>trevor/block-with-args</code> to <code>main</code>.</p>



<a name="320805779"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%235464%20cranelift%3A%20Rework%20block%20instructions%20.../near/320805779" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.235464.20cranelift.3A.20Rework.20block.20instructions.20.2E.2E.2E.html#320805779">(Jan 11 2023 at 22:01)</a>:</h4>
<p>elliottt edited <a href="https://github.com/bytecodealliance/wasmtime/pull/5464">PR #5464</a> from <code>trevor/block-with-args</code> to <code>main</code>:</p>
<blockquote>
<p>Add a new type <code>BlockCall</code> that represents the pair of a block name with arguments to be passed to it. (The mnemonic here is that it looks a bit like a function call.) Rework the implementation of <code>jump</code>, <code>brz</code>, and <code>brnz</code> to use <code>BlockCall</code> instead of storing the block arguments as varargs in the instruction's <code>ValueList</code>.</p>
<p>To ensure that we're processing block arguments from <code>BlockCall</code> values in instructions, three new functions have been introduced on <code>DataFlowGraph</code> that both sets of arguments: </p>
<ul>
<li><code>inst_values</code> - returns an iterator that traverses values in the instruction and block arguments</li>
<li><code>map_inst_values</code> - applies a function to each value in the instruction and block arguments</li>
<li><code>overwrite_inst_values</code> - overwrite all values in an instruction and block arguments with values from the iterator</li>
</ul>
<p>I went through the existing uses of <code>inst_args</code>, <code>inst_fixed_args</code>, <code>inst_variable_args</code>, and their mut variants to decide whether or not they should be using the new iterator interface introduced above. Many needed to be migrated over, but there were cases where the original instruction was correct: the fuzzgen passes for fcvt and int_divz are examples of where the block args were never being indexed.</p>
<p>Fixes #5451 <br>
&lt;!--</p>
<p>Please ensure that the following steps are all taken care of before submitting<br>
the PR.</p>
<ul>
<li>
<p>[ ] This has been discussed in issue #..., or if not, please tell us why<br>
  here.</p>
</li>
<li>
<p>[ ] A short description of what this does, why it is needed; if the<br>
  description becomes long, the matter should probably be discussed in an issue<br>
  first.</p>
</li>
<li>
<p>[ ] This PR contains test cases, if meaningful.</p>
</li>
<li>[ ] A reviewer from the core maintainer team has been assigned for this PR.<br>
  If you don't know who could review this, please indicate so. The list of<br>
  suggested reviewers on the right can help you.</li>
</ul>
<p>Please ensure all communication adheres to the <a href="https://github.com/bytecodealliance/wasmtime/blob/master/CODE_OF_CONDUCT.md">code of
conduct</a>.<br>
--&gt;<br>
</p>
</blockquote>



<a name="320814513"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%235464%20cranelift%3A%20Rework%20block%20instructions%20.../near/320814513" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.235464.20cranelift.3A.20Rework.20block.20instructions.20.2E.2E.2E.html#320814513">(Jan 11 2023 at 23:06)</a>:</h4>
<p>elliottt updated <a href="https://github.com/bytecodealliance/wasmtime/pull/5464">PR #5464</a> from <code>trevor/block-with-args</code> to <code>main</code>.</p>



<a name="320817120"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%235464%20cranelift%3A%20Rework%20block%20instructions%20.../near/320817120" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.235464.20cranelift.3A.20Rework.20block.20instructions.20.2E.2E.2E.html#320817120">(Jan 11 2023 at 23:32)</a>:</h4>
<p>elliottt updated <a href="https://github.com/bytecodealliance/wasmtime/pull/5464">PR #5464</a> from <code>trevor/block-with-args</code> to <code>main</code>.</p>



<a name="320825299"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%235464%20cranelift%3A%20Rework%20block%20instructions%20.../near/320825299" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.235464.20cranelift.3A.20Rework.20block.20instructions.20.2E.2E.2E.html#320825299">(Jan 12 2023 at 00:49)</a>:</h4>
<p>elliottt edited <a href="https://github.com/bytecodealliance/wasmtime/pull/5464">PR #5464</a> from <code>trevor/block-with-args</code> to <code>main</code>:</p>
<blockquote>
<p>Add a new type <code>BlockCall</code> that represents the pair of a block name with arguments to be passed to it. (The mnemonic here is that it looks a bit like a function call.) Rework the implementation of <code>jump</code>, <code>brz</code>, and <code>brnz</code> to use <code>BlockCall</code> instead of storing the block arguments as varargs in the instruction's <code>ValueList</code>.</p>
<p>To ensure that we're processing block arguments from <code>BlockCall</code> values in instructions, three new functions have been introduced on <code>DataFlowGraph</code> that both sets of arguments: </p>
<ul>
<li><code>inst_values</code> - returns an iterator that traverses values in the instruction and block arguments</li>
<li><code>map_inst_values</code> - applies a function to each value in the instruction and block arguments</li>
<li><code>overwrite_inst_values</code> - overwrite all values in an instruction and block arguments with values from the iterator</li>
</ul>
<p>I went through the existing uses of <code>inst_args</code>, <code>inst_fixed_args</code>, <code>inst_variable_args</code>, and their mut variants to decide whether or not they should be using the new iterator interface introduced above. Many needed to be migrated over, but there were cases where the original instruction was correct: the fuzzgen passes for fcvt and int_divz are examples of where the block args were never being indexed.<br>
&lt;!--</p>
<p>Please ensure that the following steps are all taken care of before submitting<br>
the PR.</p>
<ul>
<li>
<p>[ ] This has been discussed in issue #..., or if not, please tell us why<br>
  here.</p>
</li>
<li>
<p>[ ] A short description of what this does, why it is needed; if the<br>
  description becomes long, the matter should probably be discussed in an issue<br>
  first.</p>
</li>
<li>
<p>[ ] This PR contains test cases, if meaningful.</p>
</li>
<li>[ ] A reviewer from the core maintainer team has been assigned for this PR.<br>
  If you don't know who could review this, please indicate so. The list of<br>
  suggested reviewers on the right can help you.</li>
</ul>
<p>Please ensure all communication adheres to the <a href="https://github.com/bytecodealliance/wasmtime/blob/master/CODE_OF_CONDUCT.md">code of
conduct</a>.<br>
--&gt;<br>
</p>
</blockquote>



<a name="320826933"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%235464%20cranelift%3A%20Rework%20block%20instructions%20.../near/320826933" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.235464.20cranelift.3A.20Rework.20block.20instructions.20.2E.2E.2E.html#320826933">(Jan 12 2023 at 01:08)</a>:</h4>
<p>elliottt updated <a href="https://github.com/bytecodealliance/wasmtime/pull/5464">PR #5464</a> from <code>trevor/block-with-args</code> to <code>main</code>.</p>



<a name="320979629"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%235464%20cranelift%3A%20Rework%20block%20instructions%20.../near/320979629" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.235464.20cranelift.3A.20Rework.20block.20instructions.20.2E.2E.2E.html#320979629">(Jan 12 2023 at 16:27)</a>:</h4>
<p>elliottt updated <a href="https://github.com/bytecodealliance/wasmtime/pull/5464">PR #5464</a> from <code>trevor/block-with-args</code> to <code>main</code>.</p>



<a name="321280047"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%235464%20cranelift%3A%20Rework%20block%20instructions%20.../near/321280047" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.235464.20cranelift.3A.20Rework.20block.20instructions.20.2E.2E.2E.html#321280047">(Jan 13 2023 at 23:50)</a>:</h4>
<p>jameysharp submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/5464#pullrequestreview-1248483159">PR review</a>.</p>



<a name="321280048"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%235464%20cranelift%3A%20Rework%20block%20instructions%20.../near/321280048" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.235464.20cranelift.3A.20Rework.20block.20instructions.20.2E.2E.2E.html#321280048">(Jan 13 2023 at 23:50)</a>:</h4>
<p>jameysharp submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/5464#pullrequestreview-1248483159">PR review</a>.</p>



<a name="321280049"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%235464%20cranelift%3A%20Rework%20block%20instructions%20.../near/321280049" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.235464.20cranelift.3A.20Rework.20block.20instructions.20.2E.2E.2E.html#321280049">(Jan 13 2023 at 23:50)</a>:</h4>
<p>jameysharp created <a href="https://github.com/bytecodealliance/wasmtime/pull/5464#discussion_r1070018741">PR review comment</a>:</p>
<blockquote>
<p>Should this just use <code>inst_values</code>, now that that's an iterator? I'm not sure I quite understand how the stack is being used here, but I don't _think_ it requires these to be in separate iterators, so I think this simplification should be okay.</p>
<p><div class="codehilite" data-code-language="suggestion"><pre><span></span><code>                stack.push(f.dfg.inst_values(src_inst));
</code></pre></div><br>
</p>
</blockquote>



<a name="321280050"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%235464%20cranelift%3A%20Rework%20block%20instructions%20.../near/321280050" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.235464.20cranelift.3A.20Rework.20block.20instructions.20.2E.2E.2E.html#321280050">(Jan 13 2023 at 23:50)</a>:</h4>
<p>jameysharp created <a href="https://github.com/bytecodealliance/wasmtime/pull/5464#discussion_r1070149572">PR review comment</a>:</p>
<blockquote>
<p>Would you mind passing the <code>block</code> from the caller? It's already done the necessary pattern match and can avoid the <code>.unwrap()</code>.</p>
</blockquote>



<a name="321280051"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%235464%20cranelift%3A%20Rework%20block%20instructions%20.../near/321280051" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.235464.20cranelift.3A.20Rework.20block.20instructions.20.2E.2E.2E.html#321280051">(Jan 13 2023 at 23:50)</a>:</h4>
<p>jameysharp created <a href="https://github.com/bytecodealliance/wasmtime/pull/5464#discussion_r1070152718">PR review comment</a>:</p>
<blockquote>
<p>Most (maybe all?) of this complexity should go away when the <code>br_if</code> migration is done, so I don't care whether you make this change before merging, but:</p>
<p>I just noticed we can delete the <code>BranchOrderKind</code> enum and deduplicate the <code>replace</code> calls below by just directly returning which opcode the <code>Branch</code> should use after this rewrite:</p>
<div class="codehilite" data-code-language="suggestion"><pre><span></span><code>                        Opcode::Brz =&gt; Opcode::Brnz,
                        Opcode::Brnz =&gt; Opcode::Brz,
</code></pre></div>
<p>We could also get rid of some noise by moving the <code>replace</code> calls inside the inner match, instead of returning a tuple below and having to let-bind it above.</p>
</blockquote>



<a name="321873821"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%235464%20cranelift%3A%20Rework%20block%20instructions%20.../near/321873821" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.235464.20cranelift.3A.20Rework.20block.20instructions.20.2E.2E.2E.html#321873821">(Jan 17 2023 at 16:39)</a>:</h4>
<p>elliottt created <a href="https://github.com/bytecodealliance/wasmtime/pull/5464#discussion_r1072443710">PR review comment</a>:</p>
<blockquote>
<p>Yep, it definitely should, thanks for catching that one!</p>
</blockquote>



<a name="321873822"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%235464%20cranelift%3A%20Rework%20block%20instructions%20.../near/321873822" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.235464.20cranelift.3A.20Rework.20block.20instructions.20.2E.2E.2E.html#321873822">(Jan 17 2023 at 16:39)</a>:</h4>
<p>elliottt submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/5464#pullrequestreview-1251966353">PR review</a>.</p>



<a name="321878992"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%235464%20cranelift%3A%20Rework%20block%20instructions%20.../near/321878992" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.235464.20cranelift.3A.20Rework.20block.20instructions.20.2E.2E.2E.html#321878992">(Jan 17 2023 at 17:01)</a>:</h4>
<p>elliottt created <a href="https://github.com/bytecodealliance/wasmtime/pull/5464#discussion_r1072478572">PR review comment</a>:</p>
<blockquote>
<p>I remember what happened when I tried this with a previous version of this branch: we need to change the element type of <code>stack</code> to <code>Box&lt;dyn Iterator&lt;Item=Value&gt;&gt;</code> for that change to work because <code>inst_values</code> returns an <code>impl Iterator&lt;Item=Value&gt;</code>. Will the heap indirection be worth the change here?</p>
</blockquote>



<a name="321878994"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%235464%20cranelift%3A%20Rework%20block%20instructions%20.../near/321878994" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.235464.20cranelift.3A.20Rework.20block.20instructions.20.2E.2E.2E.html#321878994">(Jan 17 2023 at 17:01)</a>:</h4>
<p>elliottt submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/5464#pullrequestreview-1252043266">PR review</a>.</p>



<a name="321881433"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%235464%20cranelift%3A%20Rework%20block%20instructions%20.../near/321881433" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.235464.20cranelift.3A.20Rework.20block.20instructions.20.2E.2E.2E.html#321881433">(Jan 17 2023 at 17:11)</a>:</h4>
<p>elliottt updated <a href="https://github.com/bytecodealliance/wasmtime/pull/5464">PR #5464</a> from <code>trevor/block-with-args</code> to <code>main</code>.</p>



<a name="321926302"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%235464%20cranelift%3A%20Rework%20block%20instructions%20.../near/321926302" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.235464.20cranelift.3A.20Rework.20block.20instructions.20.2E.2E.2E.html#321926302">(Jan 17 2023 at 21:07)</a>:</h4>
<p>elliottt submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/5464#pullrequestreview-1252456273">PR review</a>.</p>



<a name="321926303"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%235464%20cranelift%3A%20Rework%20block%20instructions%20.../near/321926303" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.235464.20cranelift.3A.20Rework.20block.20instructions.20.2E.2E.2E.html#321926303">(Jan 17 2023 at 21:07)</a>:</h4>
<p>elliottt created <a href="https://github.com/bytecodealliance/wasmtime/pull/5464#discussion_r1072819463">PR review comment</a>:</p>
<blockquote>
<p>We went back and forth on alternate approaches here in a DM, and @jameysharp found a great one that he's going to push in a separate PR.</p>
</blockquote>



<a name="321934120"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%235464%20cranelift%3A%20Rework%20block%20instructions%20.../near/321934120" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.235464.20cranelift.3A.20Rework.20block.20instructions.20.2E.2E.2E.html#321934120">(Jan 17 2023 at 22:01)</a>:</h4>
<p>elliottt submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/5464#pullrequestreview-1252522339">PR review</a>.</p>



<a name="321934124"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%235464%20cranelift%3A%20Rework%20block%20instructions%20.../near/321934124" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.235464.20cranelift.3A.20Rework.20block.20instructions.20.2E.2E.2E.html#321934124">(Jan 17 2023 at 22:01)</a>:</h4>
<p>elliottt created <a href="https://github.com/bytecodealliance/wasmtime/pull/5464#discussion_r1072874312">PR review comment</a>:</p>
<blockquote>
<p>This refactoring was made in #5586.</p>
</blockquote>



<a name="321940147"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%235464%20cranelift%3A%20Rework%20block%20instructions%20.../near/321940147" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.235464.20cranelift.3A.20Rework.20block.20instructions.20.2E.2E.2E.html#321940147">(Jan 17 2023 at 22:44)</a>:</h4>
<p>elliottt updated <a href="https://github.com/bytecodealliance/wasmtime/pull/5464">PR #5464</a> from <code>trevor/block-with-args</code> to <code>main</code>.</p>



<a name="321941047"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%235464%20cranelift%3A%20Rework%20block%20instructions%20.../near/321941047" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.235464.20cranelift.3A.20Rework.20block.20instructions.20.2E.2E.2E.html#321941047">(Jan 17 2023 at 22:51)</a>:</h4>
<p>elliottt updated <a href="https://github.com/bytecodealliance/wasmtime/pull/5464">PR #5464</a> from <code>trevor/block-with-args</code> to <code>main</code>.</p>



<a name="321941217"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%235464%20cranelift%3A%20Rework%20block%20instructions%20.../near/321941217" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.235464.20cranelift.3A.20Rework.20block.20instructions.20.2E.2E.2E.html#321941217">(Jan 17 2023 at 22:52)</a>:</h4>
<p>elliottt updated <a href="https://github.com/bytecodealliance/wasmtime/pull/5464">PR #5464</a> from <code>trevor/block-with-args</code> to <code>main</code>.</p>



<a name="321953517"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%235464%20cranelift%3A%20Rework%20block%20instructions%20.../near/321953517" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.235464.20cranelift.3A.20Rework.20block.20instructions.20.2E.2E.2E.html#321953517">(Jan 18 2023 at 00:31)</a>:</h4>
<p>elliottt merged <a href="https://github.com/bytecodealliance/wasmtime/pull/5464">PR #5464</a>.</p>



<hr><p>Last updated: Jan 20 2025 at 06:04 UTC</p>
</html>