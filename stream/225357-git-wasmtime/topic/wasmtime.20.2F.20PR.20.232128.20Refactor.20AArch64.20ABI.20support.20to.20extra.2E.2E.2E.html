<html>
<head><meta charset="utf-8"><title>wasmtime / PR #2128 Refactor AArch64 ABI support to extra... · git-wasmtime · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/index.html">git-wasmtime</a></h2>
<h3>Topic: <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232128.20Refactor.20AArch64.20ABI.20support.20to.20extra.2E.2E.2E.html">wasmtime / PR #2128 Refactor AArch64 ABI support to extra...</a></h3>

<hr>

<base href="https://bytecodealliance.zulipchat.com">

<head><link href="https://bytecodealliance.github.io/zulip-archive/style.css" rel="stylesheet"></head>

<a name="206778968"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232128%20Refactor%20AArch64%20ABI%20support%20to%20extra.../near/206778968" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232128.20Refactor.20AArch64.20ABI.20support.20to.20extra.2E.2E.2E.html#206778968">(Aug 13 2020 at 04:06)</a>:</h4>
<p>cfallin opened <a href="https://github.com/bytecodealliance/wasmtime/pull/2128">PR #2128</a> from <code>machinst-abi-refactor-2</code> to <code>main</code>:</p>
<blockquote>
<p>We have observed that the ABI implementations for AArch64 and x64 are<br>
very similar; in fact, x64's implementation started as a modified copy<br>
of AArch64's implementation. This is an artifact of both a similar ABI<br>
(both machines pass args and return values in registers first, then the<br>
stack, and both machines give considerable freedom with stack-frame<br>
layout) and a too-low-level ABI abstraction in the existing design. For<br>
machines that fit the mainstream or most common ABI-design idioms, we<br>
should be able to do much better.</p>
<p>This commit factors AArch64 into machine-specific and<br>
machine-independent parts, but does not yet modify x64; that will come<br>
next.</p>
<p>This should be completely neutral with respect to compile time and<br>
generated code performance.</p>
<p>&lt;!--</p>
<p>Please ensure that the following steps are all taken care of before submitting<br>
the PR.</p>
<ul>
<li>
<p>[ ] This has been discussed in issue #..., or if not, please tell us why<br>
  here.</p>
</li>
<li>
<p>[ ] A short description of what this does, why it is needed; if the<br>
  description becomes long, the matter should probably be discussed in an issue<br>
  first.</p>
</li>
<li>
<p>[ ] This PR contains test cases, if meaningful.</p>
</li>
<li>[ ] A reviewer from the core maintainer team has been assigned for this PR.<br>
  If you don't know who could review this, please indicate so. The list of<br>
  suggested reviewers on the right can help you.</li>
</ul>
<p>Please ensure all communication adheres to the <a href="https://github.com/bytecodealliance/wasmtime/blob/master/CODE_OF_CONDUCT.md">code of
conduct</a>.<br>
--&gt;</p>
</blockquote>



<a name="206778969"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232128%20Refactor%20AArch64%20ABI%20support%20to%20extra.../near/206778969" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232128.20Refactor.20AArch64.20ABI.20support.20to.20extra.2E.2E.2E.html#206778969">(Aug 13 2020 at 04:06)</a>:</h4>
<p><strong>cfallin</strong> requested <a href="https://github.com/julian-seward1">julian-seward1</a> for a review on <a href="https://github.com/bytecodealliance/wasmtime/pull/2128">PR #2128</a>.</p>



<a name="206792579"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232128%20Refactor%20AArch64%20ABI%20support%20to%20extra.../near/206792579" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232128.20Refactor.20AArch64.20ABI.20support.20to.20extra.2E.2E.2E.html#206792579">(Aug 13 2020 at 08:46)</a>:</h4>
<p>bjorn3 submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/2128#pullrequestreview-466559506">PR Review</a>.</p>



<a name="206792580"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232128%20Refactor%20AArch64%20ABI%20support%20to%20extra.../near/206792580" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232128.20Refactor.20AArch64.20ABI.20support.20to.20extra.2E.2E.2E.html#206792580">(Aug 13 2020 at 08:46)</a>:</h4>
<p>bjorn3 submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/2128#pullrequestreview-466559506">PR Review</a>.</p>



<a name="206792581"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232128%20Refactor%20AArch64%20ABI%20support%20to%20extra.../near/206792581" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232128.20Refactor.20AArch64.20ABI.20support.20to.20extra.2E.2E.2E.html#206792581">(Aug 13 2020 at 08:46)</a>:</h4>
<p>bjorn3 created <a href="https://github.com/bytecodealliance/wasmtime/pull/2128#discussion_r469791680">PR Review Comment</a>:</p>
<blockquote>
<div class="codehilite"><pre><span></span><code>    ty.lane_type().is_float()
</code></pre></div>


</blockquote>



<a name="206792582"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232128%20Refactor%20AArch64%20ABI%20support%20to%20extra.../near/206792582" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232128.20Refactor.20AArch64.20ABI.20support.20to.20extra.2E.2E.2E.html#206792582">(Aug 13 2020 at 08:46)</a>:</h4>
<p>bjorn3 created <a href="https://github.com/bytecodealliance/wasmtime/pull/2128#discussion_r469793690">PR Review Comment</a>:</p>
<blockquote>
<div class="codehilite"><pre><span></span><code>    usize::from(ty.bits())
</code></pre></div>


</blockquote>



<a name="206792583"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232128%20Refactor%20AArch64%20ABI%20support%20to%20extra.../near/206792583" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232128.20Refactor.20AArch64.20ABI.20support.20to.20extra.2E.2E.2E.html#206792583">(Aug 13 2020 at 08:46)</a>:</h4>
<p>bjorn3 created <a href="https://github.com/bytecodealliance/wasmtime/pull/2128#discussion_r469794476">PR Review Comment</a>:</p>
<blockquote>
<p>Can you add support for <code>ArgumentPurpose::StructArgument(size)</code>?</p>
</blockquote>



<a name="206792584"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232128%20Refactor%20AArch64%20ABI%20support%20to%20extra.../near/206792584" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232128.20Refactor.20AArch64.20ABI.20support.20to.20extra.2E.2E.2E.html#206792584">(Aug 13 2020 at 08:46)</a>:</h4>
<p>bjorn3 created <a href="https://github.com/bytecodealliance/wasmtime/pull/2128#discussion_r469793354">PR Review Comment</a>:</p>
<blockquote>
<div class="codehilite"><pre><span></span><code>    !ty.is_vector &amp;&amp; (ty.is_bool() || ty.is_int() || ty.is_ref())
</code></pre></div>


</blockquote>



<a name="206901576"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232128%20Refactor%20AArch64%20ABI%20support%20to%20extra.../near/206901576" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232128.20Refactor.20AArch64.20ABI.20support.20to.20extra.2E.2E.2E.html#206901576">(Aug 14 2020 at 06:12)</a>:</h4>
<p>julian-seward1 submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/2128#pullrequestreview-467329294">PR Review</a>.</p>



<a name="206901577"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232128%20Refactor%20AArch64%20ABI%20support%20to%20extra.../near/206901577" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232128.20Refactor.20AArch64.20ABI.20support.20to.20extra.2E.2E.2E.html#206901577">(Aug 14 2020 at 06:12)</a>:</h4>
<p>julian-seward1 created <a href="https://github.com/bytecodealliance/wasmtime/pull/2128#discussion_r470429644">PR Review Comment</a>:</p>
<blockquote>
<p>See my top-level comments regarding <code>MemArg</code>.</p>
</blockquote>



<a name="206901692"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232128%20Refactor%20AArch64%20ABI%20support%20to%20extra.../near/206901692" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232128.20Refactor.20AArch64.20ABI.20support.20to.20extra.2E.2E.2E.html#206901692">(Aug 14 2020 at 06:15)</a>:</h4>
<p>julian-seward1 submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/2128#pullrequestreview-467330270">PR Review</a>.</p>



<a name="206901694"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232128%20Refactor%20AArch64%20ABI%20support%20to%20extra.../near/206901694" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232128.20Refactor.20AArch64.20ABI.20support.20to.20extra.2E.2E.2E.html#206901694">(Aug 14 2020 at 06:15)</a>:</h4>
<p>julian-seward1 created <a href="https://github.com/bytecodealliance/wasmtime/pull/2128#discussion_r470430441">PR Review Comment</a>:</p>
<blockquote>
<p>nit: "The MOV" --&gt; either "MOV" or "The MOV insn"</p>
</blockquote>



<a name="206901887"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232128%20Refactor%20AArch64%20ABI%20support%20to%20extra.../near/206901887" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232128.20Refactor.20AArch64.20ABI.20support.20to.20extra.2E.2E.2E.html#206901887">(Aug 14 2020 at 06:20)</a>:</h4>
<p>julian-seward1 submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/2128#pullrequestreview-467331853">PR Review</a>.</p>



<a name="206901890"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232128%20Refactor%20AArch64%20ABI%20support%20to%20extra.../near/206901890" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232128.20Refactor.20AArch64.20ABI.20support.20to.20extra.2E.2E.2E.html#206901890">(Aug 14 2020 at 06:20)</a>:</h4>
<p>julian-seward1 created <a href="https://github.com/bytecodealliance/wasmtime/pull/2128#discussion_r470431735">PR Review Comment</a>:</p>
<blockquote>
<p>One way to generalise these kinds of target-specific <code>in_meh_reg</code> predicates is to change them into functions from <code>ir::Type</code> to <code>RegClass</code>.  Then <code>in_int_reg(ty)</code> becomes <code>class_for_ty(ty) == RegClass::I64</code>.</p>
</blockquote>



<a name="206901943"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232128%20Refactor%20AArch64%20ABI%20support%20to%20extra.../near/206901943" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232128.20Refactor.20AArch64.20ABI.20support.20to.20extra.2E.2E.2E.html#206901943">(Aug 14 2020 at 06:20)</a>:</h4>
<p>julian-seward1 submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/2128#pullrequestreview-467332167">PR Review</a>.</p>



<a name="206901944"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232128%20Refactor%20AArch64%20ABI%20support%20to%20extra.../near/206901944" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232128.20Refactor.20AArch64.20ABI.20support.20to.20extra.2E.2E.2E.html#206901944">(Aug 14 2020 at 06:20)</a>:</h4>
<p>julian-seward1 created <a href="https://github.com/bytecodealliance/wasmtime/pull/2128#discussion_r470431981">PR Review Comment</a>:</p>
<blockquote>
<p>Maybe name <code>is_callee_save_reg</code> would be clearer, when reading use points?</p>
</blockquote>



<a name="206901968"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232128%20Refactor%20AArch64%20ABI%20support%20to%20extra.../near/206901968" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232128.20Refactor.20AArch64.20ABI.20support.20to.20extra.2E.2E.2E.html#206901968">(Aug 14 2020 at 06:21)</a>:</h4>
<p>julian-seward1 submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/2128#pullrequestreview-467332414">PR Review</a>.</p>



<a name="206901969"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232128%20Refactor%20AArch64%20ABI%20support%20to%20extra.../near/206901969" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232128.20Refactor.20AArch64.20ABI.20support.20to.20extra.2E.2E.2E.html#206901969">(Aug 14 2020 at 06:21)</a>:</h4>
<p>julian-seward1 created <a href="https://github.com/bytecodealliance/wasmtime/pull/2128#discussion_r470432187">PR Review Comment</a>:</p>
<blockquote>
<p>Can these be unstable sorts, in the interest of cranking every last nanosecond out of the machine?</p>
</blockquote>



<a name="206902312"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232128%20Refactor%20AArch64%20ABI%20support%20to%20extra.../near/206902312" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232128.20Refactor.20AArch64.20ABI.20support.20to.20extra.2E.2E.2E.html#206902312">(Aug 14 2020 at 06:29)</a>:</h4>
<p>julian-seward1 submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/2128#pullrequestreview-467335521">PR Review</a>.</p>



<a name="206902313"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232128%20Refactor%20AArch64%20ABI%20support%20to%20extra.../near/206902313" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232128.20Refactor.20AArch64.20ABI.20support.20to.20extra.2E.2E.2E.html#206902313">(Aug 14 2020 at 06:29)</a>:</h4>
<p>julian-seward1 created <a href="https://github.com/bytecodealliance/wasmtime/pull/2128#discussion_r470434779">PR Review Comment</a>:</p>
<blockquote>
<p>The general comment structure of "this is for AArch64 and X64" gives me some concern.  These comments are soon going to be out of date and hence confusing, once ports to other targets exist.  I would prefer that</p>
<ul>
<li>
<p>the implementation is introduced as "a vanilla modern ABI, in which some the first few (possibly zero) args are passed in registers, and the rest on the stack".  I think that will cover most bases in the short/medium term, at least until we have to deal with the POWER64 ABIs, which are pretty weird due to the TOC requirement.</p>
</li>
<li>
<p>references to "AArch64 and X64" are removed</p>
</li>
<li>
<p>in the comment(s), instantiations/descriptions for each architecture are laid out explicitly, so that when adding a new architecture, the relevant pieces of the comments can be updated</p>
</li>
</ul>
</blockquote>



<a name="206902419"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232128%20Refactor%20AArch64%20ABI%20support%20to%20extra.../near/206902419" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232128.20Refactor.20AArch64.20ABI.20support.20to.20extra.2E.2E.2E.html#206902419">(Aug 14 2020 at 06:31)</a>:</h4>
<p>julian-seward1 submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/2128#pullrequestreview-467336447">PR Review</a>.</p>



<a name="206902421"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232128%20Refactor%20AArch64%20ABI%20support%20to%20extra.../near/206902421" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232128.20Refactor.20AArch64.20ABI.20support.20to.20extra.2E.2E.2E.html#206902421">(Aug 14 2020 at 06:31)</a>:</h4>
<p>julian-seward1 created <a href="https://github.com/bytecodealliance/wasmtime/pull/2128#discussion_r470435581">PR Review Comment</a>:</p>
<blockquote>
<p>We're sure that <code>usize::from(ty.bits())</code> actucally produces the same numbers, yes?</p>
</blockquote>



<a name="206902585"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232128%20Refactor%20AArch64%20ABI%20support%20to%20extra.../near/206902585" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232128.20Refactor.20AArch64.20ABI.20support.20to.20extra.2E.2E.2E.html#206902585">(Aug 14 2020 at 06:35)</a>:</h4>
<p>julian-seward1 submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/2128#pullrequestreview-467337878">PR Review</a>.</p>



<a name="206902586"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232128%20Refactor%20AArch64%20ABI%20support%20to%20extra.../near/206902586" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232128.20Refactor.20AArch64.20ABI.20support.20to.20extra.2E.2E.2E.html#206902586">(Aug 14 2020 at 06:35)</a>:</h4>
<p>julian-seward1 created <a href="https://github.com/bytecodealliance/wasmtime/pull/2128#discussion_r470436774">PR Review Comment</a>:</p>
<blockquote>
<p>Could this function be renamed to something that exposes the reason for the query?  I mean, <code>ty_is_int</code> is, well, why do we care?  If it were (eg) <code>param_of_this_ty_goes_in_intreg</code> then that would be clearer.  But that's a decision that's surely per-target?  Why would target-independent code want to know about the apparent int-ness of a type?</p>
</blockquote>



<a name="206902682"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232128%20Refactor%20AArch64%20ABI%20support%20to%20extra.../near/206902682" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232128.20Refactor.20AArch64.20ABI.20support.20to.20extra.2E.2E.2E.html#206902682">(Aug 14 2020 at 06:38)</a>:</h4>
<p>julian-seward1 submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/2128#pullrequestreview-467338815">PR Review</a>.</p>



<a name="206902683"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232128%20Refactor%20AArch64%20ABI%20support%20to%20extra.../near/206902683" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232128.20Refactor.20AArch64.20ABI.20support.20to.20extra.2E.2E.2E.html#206902683">(Aug 14 2020 at 06:38)</a>:</h4>
<p>julian-seward1 created <a href="https://github.com/bytecodealliance/wasmtime/pull/2128#discussion_r470437550">PR Review Comment</a>:</p>
<blockquote>
<p>Personally I prefer the original, since it involves less indirection for the reader and doesn't make any assumptions about <code>is_vector</code>, <code>is_bool</code>, <code>is_int</code> and <code>is_ref</code> covering all possible types exactly once.</p>
</blockquote>



<a name="206902755"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232128%20Refactor%20AArch64%20ABI%20support%20to%20extra.../near/206902755" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232128.20Refactor.20AArch64.20ABI.20support.20to.20extra.2E.2E.2E.html#206902755">(Aug 14 2020 at 06:39)</a>:</h4>
<p>julian-seward1 submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/2128#pullrequestreview-467339698">PR Review</a>.</p>



<a name="206902756"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232128%20Refactor%20AArch64%20ABI%20support%20to%20extra.../near/206902756" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232128.20Refactor.20AArch64.20ABI.20support.20to.20extra.2E.2E.2E.html#206902756">(Aug 14 2020 at 06:39)</a>:</h4>
<p>julian-seward1 created <a href="https://github.com/bytecodealliance/wasmtime/pull/2128#discussion_r470438174">PR Review Comment</a>:</p>
<blockquote>
<p>Could this just be <code>StackArg</code>?  If an arg is on the stack it is definitely in memory.</p>
</blockquote>



<a name="206902822"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232128%20Refactor%20AArch64%20ABI%20support%20to%20extra.../near/206902822" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232128.20Refactor.20AArch64.20ABI.20support.20to.20extra.2E.2E.2E.html#206902822">(Aug 14 2020 at 06:40)</a>:</h4>
<p>julian-seward1 submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/2128#pullrequestreview-467340262">PR Review</a>.</p>



<a name="206902823"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232128%20Refactor%20AArch64%20ABI%20support%20to%20extra.../near/206902823" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232128.20Refactor.20AArch64.20ABI.20support.20to.20extra.2E.2E.2E.html#206902823">(Aug 14 2020 at 06:40)</a>:</h4>
<p>julian-seward1 created <a href="https://github.com/bytecodealliance/wasmtime/pull/2128#discussion_r470438741">PR Review Comment</a>:</p>
<blockquote>
<p>Could you clarify a bit what <code>gen_clobber_save/restore</code> do?  I can kinda guess, but a bit more clarity here would be nice (maybe just an extra sentence).</p>
</blockquote>



<a name="206902986"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232128%20Refactor%20AArch64%20ABI%20support%20to%20extra.../near/206902986" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232128.20Refactor.20AArch64.20ABI.20support.20to.20extra.2E.2E.2E.html#206902986">(Aug 14 2020 at 06:44)</a>:</h4>
<p>julian-seward1 submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/2128#pullrequestreview-467341705">PR Review</a>.</p>



<a name="206902987"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232128%20Refactor%20AArch64%20ABI%20support%20to%20extra.../near/206902987" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232128.20Refactor.20AArch64.20ABI.20support.20to.20extra.2E.2E.2E.html#206902987">(Aug 14 2020 at 06:44)</a>:</h4>
<p>julian-seward1 created <a href="https://github.com/bytecodealliance/wasmtime/pull/2128#discussion_r470439894">PR Review Comment</a>:</p>
<blockquote>
<p>This doesn't say anything about alignment spacers pushed before the outbound args are pushed, so as to give the correct alignment for <code>SP before making a call</code>.  Does it need to?  For SM's wasm baseline compiler this was certainly A Thing that we had to work through (for stackmap generation, at least), and it was most confusingful.</p>
</blockquote>



<a name="206903019"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232128%20Refactor%20AArch64%20ABI%20support%20to%20extra.../near/206903019" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232128.20Refactor.20AArch64.20ABI.20support.20to.20extra.2E.2E.2E.html#206903019">(Aug 14 2020 at 06:45)</a>:</h4>
<p>julian-seward1 submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/2128#pullrequestreview-467342294">PR Review</a>.</p>



<a name="206903020"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232128%20Refactor%20AArch64%20ABI%20support%20to%20extra.../near/206903020" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232128.20Refactor.20AArch64.20ABI.20support.20to.20extra.2E.2E.2E.html#206903020">(Aug 14 2020 at 06:45)</a>:</h4>
<p>julian-seward1 created <a href="https://github.com/bytecodealliance/wasmtime/pull/2128#discussion_r470440440">PR Review Comment</a>:</p>
<blockquote>
<p>nano-nit, but .. when I saw <code>nominal-SP</code> I thought "nominal minus SP, what?!"  Can you remove the <code>-</code> so as to make it consistent with the definition point on the next line?</p>
</blockquote>



<a name="206903185"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232128%20Refactor%20AArch64%20ABI%20support%20to%20extra.../near/206903185" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232128.20Refactor.20AArch64.20ABI.20support.20to.20extra.2E.2E.2E.html#206903185">(Aug 14 2020 at 06:49)</a>:</h4>
<p>julian-seward1 submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/2128#pullrequestreview-467343778">PR Review</a>.</p>



<a name="206903186"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232128%20Refactor%20AArch64%20ABI%20support%20to%20extra.../near/206903186" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232128.20Refactor.20AArch64.20ABI.20support.20to.20extra.2E.2E.2E.html#206903186">(Aug 14 2020 at 06:49)</a>:</h4>
<p>julian-seward1 created <a href="https://github.com/bytecodealliance/wasmtime/pull/2128#discussion_r470441672">PR Review Comment</a>:</p>
<blockquote>
<p>Re the <code>* 8</code>, here and everywhere else .. this makes me nervous regarding 64/32-bit cleanness when we inevitable come to having to support a 32 bit target.  Would you consider finding all places in the diff where there is an assumption that the word size is 64-bit, and adding a warning comment line <code>// WARNING 32-bit unclean</code> or some such?  For the benefit of future porters?</p>
</blockquote>



<a name="206903568"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232128%20Refactor%20AArch64%20ABI%20support%20to%20extra.../near/206903568" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232128.20Refactor.20AArch64.20ABI.20support.20to.20extra.2E.2E.2E.html#206903568">(Aug 14 2020 at 06:56)</a>:</h4>
<p>julian-seward1 submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/2128#pullrequestreview-467346983">PR Review</a>.</p>



<a name="206903674"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232128%20Refactor%20AArch64%20ABI%20support%20to%20extra.../near/206903674" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232128.20Refactor.20AArch64.20ABI.20support.20to.20extra.2E.2E.2E.html#206903674">(Aug 14 2020 at 07:00)</a>:</h4>
<p>julian-seward1 edited <a href="https://github.com/bytecodealliance/wasmtime/pull/2128#discussion_r470441672">PR Review Comment</a>.</p>



<a name="206903753"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232128%20Refactor%20AArch64%20ABI%20support%20to%20extra.../near/206903753" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232128.20Refactor.20AArch64.20ABI.20support.20to.20extra.2E.2E.2E.html#206903753">(Aug 14 2020 at 07:01)</a>:</h4>
<p>julian-seward1 submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/2128#pullrequestreview-467346983">PR Review</a>.</p>



<a name="206955060"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232128%20Refactor%20AArch64%20ABI%20support%20to%20extra.../near/206955060" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232128.20Refactor.20AArch64.20ABI.20support.20to.20extra.2E.2E.2E.html#206955060">(Aug 14 2020 at 17:28)</a>:</h4>
<p>julian-seward1 submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/2128#pullrequestreview-467747595">PR Review</a>.</p>



<a name="206955838"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232128%20Refactor%20AArch64%20ABI%20support%20to%20extra.../near/206955838" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232128.20Refactor.20AArch64.20ABI.20support.20to.20extra.2E.2E.2E.html#206955838">(Aug 14 2020 at 17:35)</a>:</h4>
<p>bjorn3 submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/2128#pullrequestreview-467752294">PR Review</a>.</p>



<a name="206955839"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232128%20Refactor%20AArch64%20ABI%20support%20to%20extra.../near/206955839" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232128.20Refactor.20AArch64.20ABI.20support.20to.20extra.2E.2E.2E.html#206955839">(Aug 14 2020 at 17:35)</a>:</h4>
<p>bjorn3 created <a href="https://github.com/bytecodealliance/wasmtime/pull/2128#discussion_r470761974">PR Review Comment</a>:</p>
<blockquote>
<p><a href="https://github.com/bytecodealliance/wasmtime/blob/a577667f9fcc29528532f11a17e5e747cba7b13e/cranelift/codegen/src/ir/types.rs#L246-L248">https://github.com/bytecodealliance/wasmtime/blob/a577667f9fcc29528532f11a17e5e747cba7b13e/cranelift/codegen/src/ir/types.rs#L246-L248</a></p>
<p><a href="https://github.com/bytecodealliance/wasmtime/blob/a577667f9fcc29528532f11a17e5e747cba7b13e/cranelift/codegen/src/ir/types.rs#L69-L80">https://github.com/bytecodealliance/wasmtime/blob/a577667f9fcc29528532f11a17e5e747cba7b13e/cranelift/codegen/src/ir/types.rs#L69-L80</a></p>
<p>For <code>IFLAGS</code> and <code>FFLAGS</code> it always returns 0. Other than that everything produces the same value.</p>
</blockquote>



<a name="206979115"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232128%20Refactor%20AArch64%20ABI%20support%20to%20extra.../near/206979115" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232128.20Refactor.20AArch64.20ABI.20support.20to.20extra.2E.2E.2E.html#206979115">(Aug 14 2020 at 20:38)</a>:</h4>
<p>cfallin submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/2128#pullrequestreview-467861910">PR Review</a>.</p>



<a name="206979116"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232128%20Refactor%20AArch64%20ABI%20support%20to%20extra.../near/206979116" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232128.20Refactor.20AArch64.20ABI.20support.20to.20extra.2E.2E.2E.html#206979116">(Aug 14 2020 at 20:38)</a>:</h4>
<p>cfallin created <a href="https://github.com/bytecodealliance/wasmtime/pull/2128#discussion_r470854491">PR Review Comment</a>:</p>
<blockquote>
<p>Hmm, I think I'm going to go with @bjorn3's suggestion here, just because we've had several instances of merge conflicts in these match-on-type statements when someone adds support for a new vector type. It seems to me that it's better to have a single source of truth for the type categories, which is what we have with <code>Type::is_*()</code>.</p>
</blockquote>



<a name="206979269"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232128%20Refactor%20AArch64%20ABI%20support%20to%20extra.../near/206979269" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232128.20Refactor.20AArch64.20ABI.20support.20to.20extra.2E.2E.2E.html#206979269">(Aug 14 2020 at 20:40)</a>:</h4>
<p>cfallin submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/2128#pullrequestreview-467862533">PR Review</a>.</p>



<a name="206979270"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232128%20Refactor%20AArch64%20ABI%20support%20to%20extra.../near/206979270" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232128.20Refactor.20AArch64.20ABI.20support.20to.20extra.2E.2E.2E.html#206979270">(Aug 14 2020 at 20:40)</a>:</h4>
<p>cfallin created <a href="https://github.com/bytecodealliance/wasmtime/pull/2128#discussion_r470855025">PR Review Comment</a>:</p>
<blockquote>
<p>This is a separate issue, IMHO, that can be done in another PR. There's a bunch of other stuff I need to get to before supporting struct args, but I'd be happy to review a PR for this :-)</p>
</blockquote>



<a name="206981333"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232128%20Refactor%20AArch64%20ABI%20support%20to%20extra.../near/206981333" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232128.20Refactor.20AArch64.20ABI.20support.20to.20extra.2E.2E.2E.html#206981333">(Aug 14 2020 at 21:00)</a>:</h4>
<p>cfallin submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/2128#pullrequestreview-467872183">PR Review</a>.</p>



<a name="206981334"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232128%20Refactor%20AArch64%20ABI%20support%20to%20extra.../near/206981334" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232128.20Refactor.20AArch64.20ABI.20support.20to.20extra.2E.2E.2E.html#206981334">(Aug 14 2020 at 21:00)</a>:</h4>
<p>cfallin created <a href="https://github.com/bytecodealliance/wasmtime/pull/2128#discussion_r470862752">PR Review Comment</a>:</p>
<blockquote>
<p>I thought about that, but IMHO it's better to have truly deterministic output -- not doing so could create all sorts of weird testing issues, problems with caching at various levels, etc. We expect these lists to be short (at most the number of machine registers) so the difference shouldn't be too large...</p>
</blockquote>



<a name="206981407"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232128%20Refactor%20AArch64%20ABI%20support%20to%20extra.../near/206981407" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232128.20Refactor.20AArch64.20ABI.20support.20to.20extra.2E.2E.2E.html#206981407">(Aug 14 2020 at 21:01)</a>:</h4>
<p>cfallin submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/2128#pullrequestreview-467872627">PR Review</a>.</p>



<a name="206981408"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232128%20Refactor%20AArch64%20ABI%20support%20to%20extra.../near/206981408" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232128.20Refactor.20AArch64.20ABI.20support.20to.20extra.2E.2E.2E.html#206981408">(Aug 14 2020 at 21:01)</a>:</h4>
<p>cfallin created <a href="https://github.com/bytecodealliance/wasmtime/pull/2128#discussion_r470863127">PR Review Comment</a>:</p>
<blockquote>
<p>(And to be clear, the nondeterminism is otherwise new with this patch, because it changes the iteration to be directly over the <code>Set</code> rather than over the set-converted-to-vec, and the iteration order is unspecified.)</p>
</blockquote>



<a name="206981444"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232128%20Refactor%20AArch64%20ABI%20support%20to%20extra.../near/206981444" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232128.20Refactor.20AArch64.20ABI.20support.20to.20extra.2E.2E.2E.html#206981444">(Aug 14 2020 at 21:01)</a>:</h4>
<p>cfallin submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/2128#pullrequestreview-467872838">PR Review</a>.</p>



<a name="206981446"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232128%20Refactor%20AArch64%20ABI%20support%20to%20extra.../near/206981446" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232128.20Refactor.20AArch64.20ABI.20support.20to.20extra.2E.2E.2E.html#206981446">(Aug 14 2020 at 21:01)</a>:</h4>
<p>cfallin created <a href="https://github.com/bytecodealliance/wasmtime/pull/2128#discussion_r470863295">PR Review Comment</a>:</p>
<blockquote>
<p>Removed, actually, as we can use other existing helpers -- thanks!</p>
</blockquote>



<a name="206983172"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232128%20Refactor%20AArch64%20ABI%20support%20to%20extra.../near/206983172" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232128.20Refactor.20AArch64.20ABI.20support.20to.20extra.2E.2E.2E.html#206983172">(Aug 14 2020 at 21:17)</a>:</h4>
<p>cfallin submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/2128#pullrequestreview-467879966">PR Review</a>.</p>



<a name="206983173"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232128%20Refactor%20AArch64%20ABI%20support%20to%20extra.../near/206983173" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232128.20Refactor.20AArch64.20ABI.20support.20to.20extra.2E.2E.2E.html#206983173">(Aug 14 2020 at 21:17)</a>:</h4>
<p>cfallin created <a href="https://github.com/bytecodealliance/wasmtime/pull/2128#discussion_r470869154">PR Review Comment</a>:</p>
<blockquote>
<p>Actually calling it <code>StackAMode</code> as per the below (<code>MemArg</code> -&gt; <code>AMode</code>), thanks!</p>
</blockquote>



<a name="206984962"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232128%20Refactor%20AArch64%20ABI%20support%20to%20extra.../near/206984962" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232128.20Refactor.20AArch64.20ABI.20support.20to.20extra.2E.2E.2E.html#206984962">(Aug 14 2020 at 21:37)</a>:</h4>
<p>cfallin updated <a href="https://github.com/bytecodealliance/wasmtime/pull/2128">PR #2128</a> from <code>machinst-abi-refactor-2</code> to <code>main</code>:</p>
<blockquote>
<p>We have observed that the ABI implementations for AArch64 and x64 are<br>
very similar; in fact, x64's implementation started as a modified copy<br>
of AArch64's implementation. This is an artifact of both a similar ABI<br>
(both machines pass args and return values in registers first, then the<br>
stack, and both machines give considerable freedom with stack-frame<br>
layout) and a too-low-level ABI abstraction in the existing design. For<br>
machines that fit the mainstream or most common ABI-design idioms, we<br>
should be able to do much better.</p>
<p>This commit factors AArch64 into machine-specific and<br>
machine-independent parts, but does not yet modify x64; that will come<br>
next.</p>
<p>This should be completely neutral with respect to compile time and<br>
generated code performance.</p>
<p>&lt;!--</p>
<p>Please ensure that the following steps are all taken care of before submitting<br>
the PR.</p>
<ul>
<li>
<p>[ ] This has been discussed in issue #..., or if not, please tell us why<br>
  here.</p>
</li>
<li>
<p>[ ] A short description of what this does, why it is needed; if the<br>
  description becomes long, the matter should probably be discussed in an issue<br>
  first.</p>
</li>
<li>
<p>[ ] This PR contains test cases, if meaningful.</p>
</li>
<li>[ ] A reviewer from the core maintainer team has been assigned for this PR.<br>
  If you don't know who could review this, please indicate so. The list of<br>
  suggested reviewers on the right can help you.</li>
</ul>
<p>Please ensure all communication adheres to the <a href="https://github.com/bytecodealliance/wasmtime/blob/master/CODE_OF_CONDUCT.md">code of
conduct</a>.<br>
--&gt;</p>
</blockquote>



<a name="206992968"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232128%20Refactor%20AArch64%20ABI%20support%20to%20extra.../near/206992968" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232128.20Refactor.20AArch64.20ABI.20support.20to.20extra.2E.2E.2E.html#206992968">(Aug 14 2020 at 23:27)</a>:</h4>
<p>cfallin updated <a href="https://github.com/bytecodealliance/wasmtime/pull/2128">PR #2128</a> from <code>machinst-abi-refactor-2</code> to <code>main</code>:</p>
<blockquote>
<p>We have observed that the ABI implementations for AArch64 and x64 are<br>
very similar; in fact, x64's implementation started as a modified copy<br>
of AArch64's implementation. This is an artifact of both a similar ABI<br>
(both machines pass args and return values in registers first, then the<br>
stack, and both machines give considerable freedom with stack-frame<br>
layout) and a too-low-level ABI abstraction in the existing design. For<br>
machines that fit the mainstream or most common ABI-design idioms, we<br>
should be able to do much better.</p>
<p>This commit factors AArch64 into machine-specific and<br>
machine-independent parts, but does not yet modify x64; that will come<br>
next.</p>
<p>This should be completely neutral with respect to compile time and<br>
generated code performance.</p>
<p>&lt;!--</p>
<p>Please ensure that the following steps are all taken care of before submitting<br>
the PR.</p>
<ul>
<li>
<p>[ ] This has been discussed in issue #..., or if not, please tell us why<br>
  here.</p>
</li>
<li>
<p>[ ] A short description of what this does, why it is needed; if the<br>
  description becomes long, the matter should probably be discussed in an issue<br>
  first.</p>
</li>
<li>
<p>[ ] This PR contains test cases, if meaningful.</p>
</li>
<li>[ ] A reviewer from the core maintainer team has been assigned for this PR.<br>
  If you don't know who could review this, please indicate so. The list of<br>
  suggested reviewers on the right can help you.</li>
</ul>
<p>Please ensure all communication adheres to the <a href="https://github.com/bytecodealliance/wasmtime/blob/master/CODE_OF_CONDUCT.md">code of
conduct</a>.<br>
--&gt;</p>
</blockquote>



<a name="206995078"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232128%20Refactor%20AArch64%20ABI%20support%20to%20extra.../near/206995078" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232128.20Refactor.20AArch64.20ABI.20support.20to.20extra.2E.2E.2E.html#206995078">(Aug 15 2020 at 00:08)</a>:</h4>
<p>cfallin merged <a href="https://github.com/bytecodealliance/wasmtime/pull/2128">PR #2128</a>.</p>



<a name="207013467"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232128%20Refactor%20AArch64%20ABI%20support%20to%20extra.../near/207013467" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232128.20Refactor.20AArch64.20ABI.20support.20to.20extra.2E.2E.2E.html#207013467">(Aug 15 2020 at 09:24)</a>:</h4>
<p>julian-seward1 submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/2128#pullrequestreview-467960201">PR Review</a>.</p>



<a name="207013468"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232128%20Refactor%20AArch64%20ABI%20support%20to%20extra.../near/207013468" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232128.20Refactor.20AArch64.20ABI.20support.20to.20extra.2E.2E.2E.html#207013468">(Aug 15 2020 at 09:24)</a>:</h4>
<p>julian-seward1 created <a href="https://github.com/bytecodealliance/wasmtime/pull/2128#discussion_r470958488">PR Review Comment</a>:</p>
<blockquote>
<p>Oh, yes, I am all in favour of determinism.  I retract my comment :-)</p>
</blockquote>



<a name="207017928"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232128%20Refactor%20AArch64%20ABI%20support%20to%20extra.../near/207017928" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232128.20Refactor.20AArch64.20ABI.20support.20to.20extra.2E.2E.2E.html#207017928">(Aug 15 2020 at 11:37)</a>:</h4>
<p>bjorn3 submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/2128#pullrequestreview-467965990">PR Review</a>.</p>



<a name="207017929"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232128%20Refactor%20AArch64%20ABI%20support%20to%20extra.../near/207017929" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232128.20Refactor.20AArch64.20ABI.20support.20to.20extra.2E.2E.2E.html#207017929">(Aug 15 2020 at 11:37)</a>:</h4>
<p>bjorn3 created <a href="https://github.com/bytecodealliance/wasmtime/pull/2128#discussion_r470968589">PR Review Comment</a>:</p>
<blockquote>
<p><code>unstable_sort_by_key</code> doesn't affect determinism. It only causes a difference when multiple values have the same sort key. In that case the order would be dependent on the internals of the sorting algorithm, but not any random source. <code>sort_by_key</code> on the other hand guarantees that multiple values with the same sort key are kept in the same order.</p>
</blockquote>



<a name="207018049"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232128%20Refactor%20AArch64%20ABI%20support%20to%20extra.../near/207018049" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232128.20Refactor.20AArch64.20ABI.20support.20to.20extra.2E.2E.2E.html#207018049">(Aug 15 2020 at 11:40)</a>:</h4>
<p>bjorn3 edited <a href="https://github.com/bytecodealliance/wasmtime/pull/2128#discussion_r470968589">PR Review Comment</a>.</p>



<hr><p>Last updated: Jan 20 2025 at 06:04 UTC</p>
</html>