<html>
<head><meta charset="utf-8"><title>wasmtime / Issue #1779 Ability to get and load compilatio... · git-wasmtime · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/index.html">git-wasmtime</a></h2>
<h3>Topic: <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20Issue.20.231779.20Ability.20to.20get.20and.20load.20compilatio.2E.2E.2E.html">wasmtime / Issue #1779 Ability to get and load compilatio...</a></h3>

<hr>

<base href="https://bytecodealliance.zulipchat.com">

<head><link href="https://bytecodealliance.github.io/zulip-archive/style.css" rel="stylesheet"></head>

<a name="199027157"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20Issue%20%231779%20Ability%20to%20get%20and%20load%20compilatio.../near/199027157" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20Issue.20.231779.20Ability.20to.20get.20and.20load.20compilatio.2E.2E.2E.html#199027157">(May 28 2020 at 14:10)</a>:</h4>
<p>dsherret opened <a href="https://github.com/bytecodealliance/wasmtime/issues/1779">Issue #1779</a>:</p>
<blockquote>
<h4>Feature</h4>
<p>It would be useful to be able to get the bytes from a compilation result and additionally take bytes from a previous compilation and load them into a module.</p>
<h4>Benefit</h4>
<p>This would allow me to manage my own caching and reduce startup times.</p>
<h4>Implementation</h4>
<p>Here's how it's done in wasmer.</p>
<p>Compiling:</p>
<div class="codehilite"><pre><span></span><code><span class="kd">let</span><span class="w"> </span><span class="n">compile_result</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">wasmer_runtime</span>::<span class="n">compile</span><span class="p">(</span><span class="o">&amp;</span><span class="n">wasm_bytes</span><span class="p">)</span><span class="o">?</span><span class="p">;</span><span class="w"></span>
<span class="kd">let</span><span class="w"> </span><span class="n">artifact</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">compile_result</span><span class="p">.</span><span class="n">cache</span><span class="p">();</span><span class="w"></span>
<span class="kd">let</span><span class="w"> </span><span class="n">compiled_module_bytes</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">artifact</span><span class="p">.</span><span class="n">unwrap</span><span class="p">().</span><span class="n">serialize</span><span class="p">().</span><span class="n">unwrap</span><span class="p">();</span><span class="w"></span>
</code></pre></div>


<p>Loading:</p>
<div class="codehilite"><pre><span></span><code><span class="kd">let</span><span class="w"> </span><span class="n">artifact</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">match</span><span class="w"> </span><span class="n">wasmer_runtime</span>::<span class="n">cache</span>::<span class="n">Artifact</span>::<span class="n">deserialize</span><span class="p">(</span><span class="o">&amp;</span><span class="n">compiled_module_bytes</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="nb">Ok</span><span class="p">(</span><span class="n">artifact</span><span class="p">)</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="n">artifact</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="nb">Err</span><span class="p">(</span><span class="n">err</span><span class="p">)</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="n">err</span><span class="o">!</span><span class="p">(</span><span class="s">&quot;Error deserializing compiled wasm module: {:?}&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">err</span><span class="p">);</span><span class="w"> </span><span class="p">}</span><span class="w"></span>
<span class="p">};</span><span class="w"></span>
<span class="kd">let</span><span class="w"> </span><span class="n">compiler</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">wasmer_runtime</span>::<span class="n">compiler_for_backend</span><span class="p">(</span><span class="n">wasmer_runtime</span>::<span class="n">Backend</span>::<span class="n">default</span><span class="p">()).</span><span class="n">expect</span><span class="p">(</span><span class="s">&quot;Expect to have a compiler&quot;</span><span class="p">);</span><span class="w"></span>
<span class="kd">let</span><span class="w"> </span><span class="n">module</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">unsafe</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">wasmer_runtime_core</span>::<span class="n">load_cache_with</span><span class="p">(</span><span class="n">artifact</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;*</span><span class="n">compiler</span><span class="p">).</span><span class="n">unwrap</span><span class="p">()</span><span class="w"> </span><span class="p">};</span><span class="w"></span>
<span class="kd">let</span><span class="w"> </span><span class="n">import_object</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">wasmer_runtime</span>::<span class="n">imports</span><span class="o">!</span><span class="w"> </span><span class="p">{};</span><span class="w"></span>
<span class="kd">let</span><span class="w"> </span><span class="n">instance</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">module</span><span class="p">.</span><span class="n">instantiate</span><span class="p">(</span><span class="o">&amp;</span><span class="n">import_object</span><span class="p">)</span><span class="o">?</span><span class="p">;</span><span class="w"></span>
</code></pre></div>


<h4>Alternatives</h4>
<p>Using the <code>Config::cache_config_load_default</code> is not ideal because it's wasmtime managing a cache for me and it seems I need to keep the <code>.wasm</code> file bytes around.</p>
</blockquote>



<a name="199027277"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20Issue%20%231779%20Ability%20to%20get%20and%20load%20compilatio.../near/199027277" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20Issue.20.231779.20Ability.20to.20get.20and.20load.20compilatio.2E.2E.2E.html#199027277">(May 28 2020 at 14:11)</a>:</h4>
<p>dsherret edited <a href="https://github.com/bytecodealliance/wasmtime/issues/1779">Issue #1779</a>:</p>
<blockquote>
<h4>Feature</h4>
<p>It would be useful to be able to get the bytes from a compilation result and additionally take bytes from a previous compilation and load them into a module.</p>
<h4>Benefit</h4>
<p>This would allow me to manage my own caching and reduce startup times.</p>
<h4>Implementation</h4>
<p>Here's how it's done in wasmer.</p>
<p>Compiling:</p>
<div class="codehilite"><pre><span></span><code><span class="kd">let</span><span class="w"> </span><span class="n">compile_result</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">wasmer_runtime</span>::<span class="n">compile</span><span class="p">(</span><span class="o">&amp;</span><span class="n">wasm_bytes</span><span class="p">)</span><span class="o">?</span><span class="p">;</span><span class="w"></span>
<span class="kd">let</span><span class="w"> </span><span class="n">artifact</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">compile_result</span><span class="p">.</span><span class="n">cache</span><span class="p">();</span><span class="w"></span>
<span class="kd">let</span><span class="w"> </span><span class="n">compiled_module_bytes</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">artifact</span><span class="p">.</span><span class="n">unwrap</span><span class="p">().</span><span class="n">serialize</span><span class="p">().</span><span class="n">unwrap</span><span class="p">();</span><span class="w"></span>
</code></pre></div>


<p>Loading:</p>
<div class="codehilite"><pre><span></span><code><span class="kd">let</span><span class="w"> </span><span class="n">artifact</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">match</span><span class="w"> </span><span class="n">wasmer_runtime</span>::<span class="n">cache</span>::<span class="n">Artifact</span>::<span class="n">deserialize</span><span class="p">(</span><span class="o">&amp;</span><span class="n">compiled_module_bytes</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="nb">Ok</span><span class="p">(</span><span class="n">artifact</span><span class="p">)</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="n">artifact</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="nb">Err</span><span class="p">(</span><span class="n">err</span><span class="p">)</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="n">err</span><span class="o">!</span><span class="p">(</span><span class="s">&quot;Error deserializing compiled wasm module: {:?}&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">err</span><span class="p">);</span><span class="w"> </span><span class="p">}</span><span class="w"></span>
<span class="p">};</span><span class="w"></span>
<span class="kd">let</span><span class="w"> </span><span class="n">compiler</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">wasmer_runtime</span>::<span class="n">compiler_for_backend</span><span class="p">(</span><span class="n">wasmer_runtime</span>::<span class="n">Backend</span>::<span class="n">default</span><span class="p">()).</span><span class="n">expect</span><span class="p">(</span><span class="s">&quot;Expected to have a compiler&quot;</span><span class="p">);</span><span class="w"></span>
<span class="kd">let</span><span class="w"> </span><span class="n">module</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">unsafe</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">wasmer_runtime_core</span>::<span class="n">load_cache_with</span><span class="p">(</span><span class="n">artifact</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;*</span><span class="n">compiler</span><span class="p">).</span><span class="n">unwrap</span><span class="p">()</span><span class="w"> </span><span class="p">};</span><span class="w"></span>
<span class="kd">let</span><span class="w"> </span><span class="n">import_object</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">wasmer_runtime</span>::<span class="n">imports</span><span class="o">!</span><span class="w"> </span><span class="p">{};</span><span class="w"></span>
<span class="kd">let</span><span class="w"> </span><span class="n">instance</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">module</span><span class="p">.</span><span class="n">instantiate</span><span class="p">(</span><span class="o">&amp;</span><span class="n">import_object</span><span class="p">)</span><span class="o">?</span><span class="p">;</span><span class="w"></span>
</code></pre></div>


<h4>Alternatives</h4>
<p>Using the <code>Config::cache_config_load_default</code> is not ideal because it's wasmtime managing a cache for me and it seems I need to keep the <code>.wasm</code> file bytes around.</p>
</blockquote>



<a name="199029177"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20Issue%20%231779%20Ability%20to%20get%20and%20load%20compilatio.../near/199029177" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20Issue.20.231779.20Ability.20to.20get.20and.20load.20compilatio.2E.2E.2E.html#199029177">(May 28 2020 at 14:27)</a>:</h4>
<p>alexcrichton labeled <a href="https://github.com/bytecodealliance/wasmtime/issues/1779">Issue #1779</a>:</p>
<blockquote>
<h4>Feature</h4>
<p>It would be useful to be able to get the bytes from a compilation result and additionally take bytes from a previous compilation and load them into a module.</p>
<h4>Benefit</h4>
<p>This would allow me to manage my own caching and reduce startup times.</p>
<h4>Implementation</h4>
<p>Here's how it's done in wasmer.</p>
<p>Compiling:</p>
<div class="codehilite"><pre><span></span><code><span class="kd">let</span><span class="w"> </span><span class="n">compile_result</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">wasmer_runtime</span>::<span class="n">compile</span><span class="p">(</span><span class="o">&amp;</span><span class="n">wasm_bytes</span><span class="p">)</span><span class="o">?</span><span class="p">;</span><span class="w"></span>
<span class="kd">let</span><span class="w"> </span><span class="n">artifact</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">compile_result</span><span class="p">.</span><span class="n">cache</span><span class="p">();</span><span class="w"></span>
<span class="kd">let</span><span class="w"> </span><span class="n">compiled_module_bytes</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">artifact</span><span class="p">.</span><span class="n">unwrap</span><span class="p">().</span><span class="n">serialize</span><span class="p">().</span><span class="n">unwrap</span><span class="p">();</span><span class="w"></span>
</code></pre></div>


<p>Loading:</p>
<div class="codehilite"><pre><span></span><code><span class="kd">let</span><span class="w"> </span><span class="n">artifact</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">match</span><span class="w"> </span><span class="n">wasmer_runtime</span>::<span class="n">cache</span>::<span class="n">Artifact</span>::<span class="n">deserialize</span><span class="p">(</span><span class="o">&amp;</span><span class="n">compiled_module_bytes</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="nb">Ok</span><span class="p">(</span><span class="n">artifact</span><span class="p">)</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="n">artifact</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="nb">Err</span><span class="p">(</span><span class="n">err</span><span class="p">)</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="n">err</span><span class="o">!</span><span class="p">(</span><span class="s">&quot;Error deserializing compiled wasm module: {:?}&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">err</span><span class="p">);</span><span class="w"> </span><span class="p">}</span><span class="w"></span>
<span class="p">};</span><span class="w"></span>
<span class="kd">let</span><span class="w"> </span><span class="n">compiler</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">wasmer_runtime</span>::<span class="n">compiler_for_backend</span><span class="p">(</span><span class="n">wasmer_runtime</span>::<span class="n">Backend</span>::<span class="n">default</span><span class="p">()).</span><span class="n">expect</span><span class="p">(</span><span class="s">&quot;Expected to have a compiler&quot;</span><span class="p">);</span><span class="w"></span>
<span class="kd">let</span><span class="w"> </span><span class="n">module</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">unsafe</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">wasmer_runtime_core</span>::<span class="n">load_cache_with</span><span class="p">(</span><span class="n">artifact</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;*</span><span class="n">compiler</span><span class="p">).</span><span class="n">unwrap</span><span class="p">()</span><span class="w"> </span><span class="p">};</span><span class="w"></span>
<span class="kd">let</span><span class="w"> </span><span class="n">import_object</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">wasmer_runtime</span>::<span class="n">imports</span><span class="o">!</span><span class="w"> </span><span class="p">{};</span><span class="w"></span>
<span class="kd">let</span><span class="w"> </span><span class="n">instance</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">module</span><span class="p">.</span><span class="n">instantiate</span><span class="p">(</span><span class="o">&amp;</span><span class="n">import_object</span><span class="p">)</span><span class="o">?</span><span class="p">;</span><span class="w"></span>
</code></pre></div>


<h4>Alternatives</h4>
<p>Using the <code>Config::cache_config_load_default</code> is not ideal because it's wasmtime managing a cache for me and it seems I need to keep the <code>.wasm</code> file bytes around.</p>
</blockquote>



<a name="199029210"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20Issue%20%231779%20Ability%20to%20get%20and%20load%20compilatio.../near/199029210" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20Issue.20.231779.20Ability.20to.20get.20and.20load.20compilatio.2E.2E.2E.html#199029210">(May 28 2020 at 14:27)</a>:</h4>
<p>github-actions[bot] <a href="https://github.com/bytecodealliance/wasmtime/issues/1779#issuecomment-635383843">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/1779">Issue #1779</a>:</p>
<blockquote>
<h4>Subscribe to Label Action</h4>
<p>cc @peterhuene</p>
<p>&lt;details&gt;<br>
This issue or pull request has been labeled: "wasmtime:api"</p>
<p>Thus the following users have been cc'd because of the following labels:</p>
<ul>
<li>peterhuene: wasmtime:api</li>
</ul>
<p>To subscribe or unsubscribe from this label, edit the &lt;code&gt;.github/subscribe-to-label.json&lt;/code&gt; configuration file.</p>
<p><a href="https://github.com/bytecodealliance/subscribe-to-label-action">Learn more.</a><br>
&lt;/details&gt;</p>
</blockquote>



<a name="199038978"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20Issue%20%231779%20Ability%20to%20get%20and%20load%20compilatio.../near/199038978" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20Issue.20.231779.20Ability.20to.20get.20and.20load.20compilatio.2E.2E.2E.html#199038978">(May 28 2020 at 15:33)</a>:</h4>
<p>alexcrichton <a href="https://github.com/bytecodealliance/wasmtime/issues/1779#issuecomment-635423912">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/1779">Issue #1779</a>:</p>
<blockquote>
<p>Thanks for the report, and seems like a reasonable feature to add to me!</p>
<p>I think for us the APIs this might look like are:</p>
<div class="codehilite"><pre><span></span><code><span class="k">impl</span><span class="w"> </span><span class="n">Module</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="k">fn</span> <span class="nf">deserialize_cache_bytes</span><span class="p">(</span><span class="n">store</span>: <span class="kp">&amp;</span><span class="nc">Store</span><span class="p">,</span><span class="w"> </span><span class="n">bytes</span>: <span class="kp">&amp;</span><span class="p">[</span><span class="kt">u8</span><span class="p">])</span><span class="w"> </span>-&gt; <span class="nb">Result</span><span class="o">&lt;</span><span class="n">Module</span><span class="o">&gt;</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="k">fn</span> <span class="nf">serialize_cache_bytes</span><span class="p">(</span><span class="o">&amp;</span><span class="bp">self</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nb">Vec</span><span class="o">&lt;</span><span class="kt">u8</span><span class="o">&gt;</span><span class="p">;</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>


<p>(or something like that)</p>
<p>Our cache format is not currently where we want it to end up. One aspect we'd like for the caches eventually is that you can "mmap and go" with zero changes to what's mmap'd in, but we can probably implement that with something like <code>deserialize_cache_file</code> in the future.</p>
<p>In any case @dsherret would you be willing to work on adding this feature?</p>
</blockquote>



<a name="199039751"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20Issue%20%231779%20Ability%20to%20get%20and%20load%20compilatio.../near/199039751" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20Issue.20.231779.20Ability.20to.20get.20and.20load.20compilatio.2E.2E.2E.html#199039751">(May 28 2020 at 15:39)</a>:</h4>
<p>dsherret <a href="https://github.com/bytecodealliance/wasmtime/issues/1779#issuecomment-635427348">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/1779">Issue #1779</a>:</p>
<blockquote>
<p>@alexcrichton that API looks perfect to me.</p>
<p>How much work do you think it would be? Is it just hooking up a few things internally to that public api? If so, then sure!</p>
<p>I'm actually not using wasmtime at all, but was just evaluating it and this was a blocker for me.</p>
</blockquote>



<a name="199040191"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20Issue%20%231779%20Ability%20to%20get%20and%20load%20compilatio.../near/199040191" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20Issue.20.231779.20Ability.20to.20get.20and.20load.20compilatio.2E.2E.2E.html#199040191">(May 28 2020 at 15:43)</a>:</h4>
<p>alexcrichton <a href="https://github.com/bytecodealliance/wasmtime/issues/1779#issuecomment-635429409">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/1779">Issue #1779</a>:</p>
<blockquote>
<p>I think this may be somewhat nontrivial to implement because the code isn't well-structured this way today. Our <a href="https://github.com/bytecodealliance/wasmtime/blob/b017844bef604b757fc358b3bff5be429f2471e6/crates/environ/src/cache.rs#L69-L96">core caching function</a> would need to be updated to optionally have bytes passed in, or otherwise refactored elsewhere to have "get the bytes" refactored into a separate step.</p>
<p>Overall I don't think it'll be too too difficult of a change, but it will require some refactoring and isn't a simple "just connect the wires" sort of change.</p>
</blockquote>



<a name="199106101"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20Issue%20%231779%20Ability%20to%20get%20and%20load%20compilatio.../near/199106101" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20Issue.20.231779.20Ability.20to.20get.20and.20load.20compilatio.2E.2E.2E.html#199106101">(May 29 2020 at 01:52)</a>:</h4>
<p>dsherret <a href="https://github.com/bytecodealliance/wasmtime/issues/1779#issuecomment-635710580">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/1779">Issue #1779</a>:</p>
<blockquote>
<p>@alexcrichton thanks for pointing me in the direction of the code. I took a look at it briefly and you're right that it would be a bit non-trivial, but overall doesn't look too bad.</p>
<p>I'm currently dragging my head through the sand with an access violation bug so my brain is kind of fried. I'll maybe come back to this later if I don't make any progress otherwise and want to try using wasmtime... (I'd like to support this project as I really like the idea behind it).</p>
</blockquote>



<a name="200703667"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20Issue%20%231779%20Ability%20to%20get%20and%20load%20compilatio.../near/200703667" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20Issue.20.231779.20Ability.20to.20get.20and.20load.20compilatio.2E.2E.2E.html#200703667">(Jun 12 2020 at 18:03)</a>:</h4>
<p>yurydelendik assigned <a href="https://github.com/bytecodealliance/wasmtime/issues/1779">Issue #1779</a>:</p>
<blockquote>
<h4>Feature</h4>
<p>It would be useful to be able to get the bytes from a compilation result and additionally take bytes from a previous compilation and load them into a module.</p>
<h4>Benefit</h4>
<p>This would allow me to manage my own caching and reduce startup times.</p>
<h4>Implementation</h4>
<p>Here's how it's done in wasmer.</p>
<p>Compiling:</p>
<div class="codehilite"><pre><span></span><code><span class="kd">let</span><span class="w"> </span><span class="n">compile_result</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">wasmer_runtime</span>::<span class="n">compile</span><span class="p">(</span><span class="o">&amp;</span><span class="n">wasm_bytes</span><span class="p">)</span><span class="o">?</span><span class="p">;</span><span class="w"></span>
<span class="kd">let</span><span class="w"> </span><span class="n">artifact</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">compile_result</span><span class="p">.</span><span class="n">cache</span><span class="p">();</span><span class="w"></span>
<span class="kd">let</span><span class="w"> </span><span class="n">compiled_module_bytes</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">artifact</span><span class="p">.</span><span class="n">unwrap</span><span class="p">().</span><span class="n">serialize</span><span class="p">().</span><span class="n">unwrap</span><span class="p">();</span><span class="w"></span>
</code></pre></div>


<p>Loading:</p>
<div class="codehilite"><pre><span></span><code><span class="kd">let</span><span class="w"> </span><span class="n">artifact</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">match</span><span class="w"> </span><span class="n">wasmer_runtime</span>::<span class="n">cache</span>::<span class="n">Artifact</span>::<span class="n">deserialize</span><span class="p">(</span><span class="o">&amp;</span><span class="n">compiled_module_bytes</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="nb">Ok</span><span class="p">(</span><span class="n">artifact</span><span class="p">)</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="n">artifact</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="nb">Err</span><span class="p">(</span><span class="n">err</span><span class="p">)</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="n">err</span><span class="o">!</span><span class="p">(</span><span class="s">&quot;Error deserializing compiled wasm module: {:?}&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">err</span><span class="p">);</span><span class="w"> </span><span class="p">}</span><span class="w"></span>
<span class="p">};</span><span class="w"></span>
<span class="kd">let</span><span class="w"> </span><span class="n">compiler</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">wasmer_runtime</span>::<span class="n">compiler_for_backend</span><span class="p">(</span><span class="n">wasmer_runtime</span>::<span class="n">Backend</span>::<span class="n">default</span><span class="p">()).</span><span class="n">expect</span><span class="p">(</span><span class="s">&quot;Expected to have a compiler&quot;</span><span class="p">);</span><span class="w"></span>
<span class="kd">let</span><span class="w"> </span><span class="n">module</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">unsafe</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">wasmer_runtime_core</span>::<span class="n">load_cache_with</span><span class="p">(</span><span class="n">artifact</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;*</span><span class="n">compiler</span><span class="p">).</span><span class="n">unwrap</span><span class="p">()</span><span class="w"> </span><span class="p">};</span><span class="w"></span>
<span class="kd">let</span><span class="w"> </span><span class="n">import_object</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">wasmer_runtime</span>::<span class="n">imports</span><span class="o">!</span><span class="w"> </span><span class="p">{};</span><span class="w"></span>
<span class="kd">let</span><span class="w"> </span><span class="n">instance</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">module</span><span class="p">.</span><span class="n">instantiate</span><span class="p">(</span><span class="o">&amp;</span><span class="n">import_object</span><span class="p">)</span><span class="o">?</span><span class="p">;</span><span class="w"></span>
</code></pre></div>


<h4>Alternatives</h4>
<p>Using the <code>Config::cache_config_load_default</code> is not ideal because it's wasmtime managing a cache for me and it seems I need to keep the <code>.wasm</code> file bytes around.</p>
</blockquote>



<a name="204235638"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20Issue%20%231779%20Ability%20to%20get%20and%20load%20compilatio.../near/204235638" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20Issue.20.231779.20Ability.20to.20get.20and.20load.20compilatio.2E.2E.2E.html#204235638">(Jul 17 2020 at 17:38)</a>:</h4>
<p>yurydelendik <a href="https://github.com/bytecodealliance/wasmtime/issues/1779#issuecomment-660247348">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/1779">Issue #1779</a>:</p>
<blockquote>
<p>@dsherret there is #2020 about to be landed, can you provide any feedback related to this issue?</p>
</blockquote>



<a name="204596744"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20Issue%20%231779%20Ability%20to%20get%20and%20load%20compilatio.../near/204596744" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20Issue.20.231779.20Ability.20to.20get.20and.20load.20compilatio.2E.2E.2E.html#204596744">(Jul 21 2020 at 20:05)</a>:</h4>
<p>yurydelendik closed <a href="https://github.com/bytecodealliance/wasmtime/issues/1779">Issue #1779</a> (assigned to yurydelendik):</p>
<blockquote>
<h4>Feature</h4>
<p>It would be useful to be able to get the bytes from a compilation result and additionally take bytes from a previous compilation and load them into a module.</p>
<h4>Benefit</h4>
<p>This would allow me to manage my own caching and reduce startup times.</p>
<h4>Implementation</h4>
<p>Here's how it's done in wasmer.</p>
<p>Compiling:</p>
<div class="codehilite"><pre><span></span><code><span class="kd">let</span><span class="w"> </span><span class="n">compile_result</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">wasmer_runtime</span>::<span class="n">compile</span><span class="p">(</span><span class="o">&amp;</span><span class="n">wasm_bytes</span><span class="p">)</span><span class="o">?</span><span class="p">;</span><span class="w"></span>
<span class="kd">let</span><span class="w"> </span><span class="n">artifact</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">compile_result</span><span class="p">.</span><span class="n">cache</span><span class="p">();</span><span class="w"></span>
<span class="kd">let</span><span class="w"> </span><span class="n">compiled_module_bytes</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">artifact</span><span class="p">.</span><span class="n">unwrap</span><span class="p">().</span><span class="n">serialize</span><span class="p">().</span><span class="n">unwrap</span><span class="p">();</span><span class="w"></span>
</code></pre></div>


<p>Loading:</p>
<div class="codehilite"><pre><span></span><code><span class="kd">let</span><span class="w"> </span><span class="n">artifact</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">match</span><span class="w"> </span><span class="n">wasmer_runtime</span>::<span class="n">cache</span>::<span class="n">Artifact</span>::<span class="n">deserialize</span><span class="p">(</span><span class="o">&amp;</span><span class="n">compiled_module_bytes</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="nb">Ok</span><span class="p">(</span><span class="n">artifact</span><span class="p">)</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="n">artifact</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="nb">Err</span><span class="p">(</span><span class="n">err</span><span class="p">)</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="n">err</span><span class="o">!</span><span class="p">(</span><span class="s">&quot;Error deserializing compiled wasm module: {:?}&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">err</span><span class="p">);</span><span class="w"> </span><span class="p">}</span><span class="w"></span>
<span class="p">};</span><span class="w"></span>
<span class="kd">let</span><span class="w"> </span><span class="n">compiler</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">wasmer_runtime</span>::<span class="n">compiler_for_backend</span><span class="p">(</span><span class="n">wasmer_runtime</span>::<span class="n">Backend</span>::<span class="n">default</span><span class="p">()).</span><span class="n">expect</span><span class="p">(</span><span class="s">&quot;Expected to have a compiler&quot;</span><span class="p">);</span><span class="w"></span>
<span class="kd">let</span><span class="w"> </span><span class="n">module</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">unsafe</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">wasmer_runtime_core</span>::<span class="n">load_cache_with</span><span class="p">(</span><span class="n">artifact</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;*</span><span class="n">compiler</span><span class="p">).</span><span class="n">unwrap</span><span class="p">()</span><span class="w"> </span><span class="p">};</span><span class="w"></span>
<span class="kd">let</span><span class="w"> </span><span class="n">import_object</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">wasmer_runtime</span>::<span class="n">imports</span><span class="o">!</span><span class="w"> </span><span class="p">{};</span><span class="w"></span>
<span class="kd">let</span><span class="w"> </span><span class="n">instance</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">module</span><span class="p">.</span><span class="n">instantiate</span><span class="p">(</span><span class="o">&amp;</span><span class="n">import_object</span><span class="p">)</span><span class="o">?</span><span class="p">;</span><span class="w"></span>
</code></pre></div>


<h4>Alternatives</h4>
<p>Using the <code>Config::cache_config_load_default</code> is not ideal because it's wasmtime managing a cache for me and it seems I need to keep the <code>.wasm</code> file bytes around.</p>
</blockquote>



<a name="204598665"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20Issue%20%231779%20Ability%20to%20get%20and%20load%20compilatio.../near/204598665" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20Issue.20.231779.20Ability.20to.20get.20and.20load.20compilatio.2E.2E.2E.html#204598665">(Jul 21 2020 at 20:23)</a>:</h4>
<p>dsherret <a href="https://github.com/bytecodealliance/wasmtime/issues/1779#issuecomment-662087304">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/1779">Issue #1779</a>:</p>
<blockquote>
<p>@yurydelendik sorry, I meant to respond. I looked at the public api earlier and it looked good to me! Thanks! I'm not using wasmtime at the moment though.</p>
</blockquote>



<hr><p>Last updated: Jan 20 2025 at 06:04 UTC</p>
</html>