<html>
<head><meta charset="utf-8"><title>wasmtime / issue #5499 FreeBSD arm64/aarch64 support · git-wasmtime · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/index.html">git-wasmtime</a></h2>
<h3>Topic: <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.235499.20FreeBSD.20arm64.2Faarch64.20support.html">wasmtime / issue #5499 FreeBSD arm64/aarch64 support</a></h3>

<hr>

<base href="https://bytecodealliance.zulipchat.com">

<head><link href="https://bytecodealliance.github.io/zulip-archive/style.css" rel="stylesheet"></head>

<a name="318566789"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%235499%20FreeBSD%20arm64/aarch64%20support/near/318566789" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.235499.20FreeBSD.20arm64.2Faarch64.20support.html#318566789">(Dec 30 2022 at 11:36)</a>:</h4>
<p>nunotexbsd opened <a href="https://github.com/bytecodealliance/wasmtime/issues/5499">issue #5499</a>:</p>
<blockquote>
<h4>Feature</h4>
<p>Add FreeBSD support on arm64/aarch64</p>
<h4>Implementation</h4>
<p>Add to <a href="https://github.com/bytecodealliance/wasmtime/blob/main/crates/runtime/src/traphandlers/unix.rs">https://github.com/bytecodealliance/wasmtime/blob/main/crates/runtime/src/traphandlers/unix.rs</a></p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="cp">#[cfg(all(target_os = </span><span class="s">"freebsd"</span><span class="cp">, target_arch = </span><span class="s">"aarch64"</span><span class="cp">))]</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">                    </span><span class="n">pc</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">context</span><span class="p">.</span><span class="n">uc_mcontext</span><span class="p">.</span><span class="n">mc_gpregs</span><span class="p">.</span><span class="n">gp_elr</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="kt">usize</span><span class="p">;</span><span class="w"></span>
<span class="w">                    </span><span class="n">sp</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">context</span><span class="p">.</span><span class="n">uc_mcontext</span><span class="p">.</span><span class="n">mc_gpregs</span><span class="p">.</span><span class="n">gp_sp</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="kt">usize</span><span class="p">;</span><span class="w"></span>
</code></pre></div>
<p>I take this code from <a href="https://github.com/wasmerio/wasmer/blob/dcfdea76999a/lib/vm/src/trap/traphandlers.rs#L302-L304">https://github.com/wasmerio/wasmer/blob/dcfdea76999a/lib/vm/src/trap/traphandlers.rs#L302-L304</a> but don't know if some change needs to be made.</p>
<p>0.2.5 build log:<br>
<a href="https://pkg-status.freebsd.org/ampere3/data/131arm64-default/b02e58aec16f/logs/lapce-0.2.5_1.log">https://pkg-status.freebsd.org/ampere3/data/131arm64-default/b02e58aec16f/logs/lapce-0.2.5_1.log</a></p>
</blockquote>



<a name="319235636"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%235499%20FreeBSD%20arm64/aarch64%20support/near/319235636" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.235499.20FreeBSD.20arm64.2Faarch64.20support.html#319235636">(Jan 03 2023 at 16:47)</a>:</h4>
<p>alexcrichton labeled <a href="https://github.com/bytecodealliance/wasmtime/issues/5499">issue #5499</a>:</p>
<blockquote>
<h4>Feature</h4>
<p>Add FreeBSD support on arm64/aarch64</p>
<h4>Implementation</h4>
<p>Add to <a href="https://github.com/bytecodealliance/wasmtime/blob/main/crates/runtime/src/traphandlers/unix.rs">https://github.com/bytecodealliance/wasmtime/blob/main/crates/runtime/src/traphandlers/unix.rs</a></p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="cp">#[cfg(all(target_os = </span><span class="s">"freebsd"</span><span class="cp">, target_arch = </span><span class="s">"aarch64"</span><span class="cp">))]</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">                    </span><span class="n">pc</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">context</span><span class="p">.</span><span class="n">uc_mcontext</span><span class="p">.</span><span class="n">mc_gpregs</span><span class="p">.</span><span class="n">gp_elr</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="kt">usize</span><span class="p">;</span><span class="w"></span>
<span class="w">                    </span><span class="n">sp</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">context</span><span class="p">.</span><span class="n">uc_mcontext</span><span class="p">.</span><span class="n">mc_gpregs</span><span class="p">.</span><span class="n">gp_sp</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="kt">usize</span><span class="p">;</span><span class="w"></span>
</code></pre></div>
<p>I take this code from <a href="https://github.com/wasmerio/wasmer/blob/dcfdea76999a/lib/vm/src/trap/traphandlers.rs#L302-L304">https://github.com/wasmerio/wasmer/blob/dcfdea76999a/lib/vm/src/trap/traphandlers.rs#L302-L304</a> but don't know if some change needs to be made.</p>
<p>0.2.5 build log:<br>
<a href="https://pkg-status.freebsd.org/ampere3/data/131arm64-default/b02e58aec16f/logs/lapce-0.2.5_1.log">https://pkg-status.freebsd.org/ampere3/data/131arm64-default/b02e58aec16f/logs/lapce-0.2.5_1.log</a></p>
</blockquote>



<a name="319235685"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%235499%20FreeBSD%20arm64/aarch64%20support/near/319235685" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.235499.20FreeBSD.20arm64.2Faarch64.20support.html#319235685">(Jan 03 2023 at 16:47)</a>:</h4>
<p>alexcrichton <a href="https://github.com/bytecodealliance/wasmtime/issues/5499#issuecomment-1369993239">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/5499">issue #5499</a>:</p>
<blockquote>
<p>This is not currently a supported platform but if you'd like to send a PR to update the code it would be appreciated!</p>
</blockquote>



<a name="319274062"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%235499%20FreeBSD%20arm64/aarch64%20support/near/319274062" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.235499.20FreeBSD.20arm64.2Faarch64.20support.html#319274062">(Jan 03 2023 at 20:25)</a>:</h4>
<p>nunotexbsd <a href="https://github.com/bytecodealliance/wasmtime/issues/5499#issuecomment-1370192446">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/5499">issue #5499</a>:</p>
<blockquote>
<p>@alexcrichton</p>
<p>Nice I will do that. Soon I will have arm64 hardware to further tests instead on relying on freebsd build servers.</p>
<p>Thanks</p>
</blockquote>



<a name="319938393"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%235499%20FreeBSD%20arm64/aarch64%20support/near/319938393" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.235499.20FreeBSD.20arm64.2Faarch64.20support.html#319938393">(Jan 07 2023 at 11:08)</a>:</h4>
<p>afonso360 <a href="https://github.com/bytecodealliance/wasmtime/issues/5499#issuecomment-1374441722">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/5499">issue #5499</a>:</p>
<blockquote>
<p>We probably also need to update the <code>wasmtime-jit-icache-coherence</code> crate.</p>
<p>I looked into this a little bit in <a href="https://github.com/bytecodealliance/wasmtime/pull/5323">https://github.com/bytecodealliance/wasmtime/pull/5323</a> but it looks like <a href="https://reviews.freebsd.org/D32360">FreeBSD doesn't yet support the <code>membarrier</code> interface</a>. But perhaps there is something else that we can use?</p>
<p>I had a look at what other JIT's are doing:</p>
<ul>
<li>V8 <a href="https://github.com/v8/v8/blob/d26949217580819901944b3baa4f073543414681/src/codegen/arm64/cpu-arm64.cc#L49-L121">emits its own icache maintenance instructions</a>. </li>
<li>Spidermonkey uses <a href="https://searchfox.org/mozilla-central/source/js/src/jit/FlushICache.cpp#119">membarriers</a></li>
<li>Mono also <a href="https://github.com/dotnet/runtime/blob/56095347ca1bacbc7a95e468f03f02ea808b9d9b/src/mono/mono/mini/mini-arm64.c#L2060-L2084">emits their own icache maintenance instructions</a></li>
</ul>
<p>Maybe FreeBSD has some other syscall that we can use? I'm not too familiar with it.</p>
<p>CC: #3310</p>
</blockquote>



<a name="321125945"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%235499%20FreeBSD%20arm64/aarch64%20support/near/321125945" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.235499.20FreeBSD.20arm64.2Faarch64.20support.html#321125945">(Jan 13 2023 at 10:30)</a>:</h4>
<p>sec <a href="https://github.com/bytecodealliance/wasmtime/issues/5499#issuecomment-1381626806">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/5499">issue #5499</a>:</p>
<blockquote>
<p>Just to add something, for latest relase (6.0.0), small change is need to make it compile:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="cp">#[cfg(all(target_os = </span><span class="s">"freebsd"</span><span class="cp">, target_arch = </span><span class="s">"aarch64"</span><span class="cp">))]</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">cx</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&amp;*</span><span class="p">(</span><span class="n">cx</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="o">*</span><span class="k">const</span><span class="w"> </span><span class="n">libc</span>::<span class="n">mcontext_t</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="p">(</span><span class="w"></span>
<span class="w">        </span><span class="n">cx</span><span class="p">.</span><span class="n">mc_gpregs</span><span class="p">.</span><span class="n">gp_elr</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="o">*</span><span class="k">const</span><span class="w"> </span><span class="kt">u8</span><span class="p">,</span><span class="w"></span>
<span class="w">        </span><span class="n">cx</span><span class="p">.</span><span class="n">mc_gpregs</span><span class="p">.</span><span class="n">gp_x</span><span class="p">[</span><span class="mi">29</span><span class="p">]</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="kt">usize</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="p">)</span><span class="w"></span>
</code></pre></div>
<p>around <a href="https://github.com/bytecodealliance/wasmtime/blob/main/crates/runtime/src/traphandlers/unix.rs#L220">https://github.com/bytecodealliance/wasmtime/blob/main/crates/runtime/src/traphandlers/unix.rs#L220</a></p>
<p>This make it compile, but running tests is not possible becuase of <a href="https://github.com/denoland/rusty_v8/issues/1094">https://github.com/denoland/rusty_v8/issues/1094</a></p>
</blockquote>



<a name="321153290"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%235499%20FreeBSD%20arm64/aarch64%20support/near/321153290" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.235499.20FreeBSD.20arm64.2Faarch64.20support.html#321153290">(Jan 13 2023 at 12:53)</a>:</h4>
<p>nunotexbsd <a href="https://github.com/bytecodealliance/wasmtime/issues/5499#issuecomment-1381809973">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/5499">issue #5499</a>:</p>
<blockquote>
<p>@sec<br>
Thanks for testing it. I still waiting for arm64 hardware so I can't test it.<br>
I will apply your patch and try to find someone that build and run test for me.</p>
</blockquote>



<a name="321154034"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%235499%20FreeBSD%20arm64/aarch64%20support/near/321154034" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.235499.20FreeBSD.20arm64.2Faarch64.20support.html#321154034">(Jan 13 2023 at 12:56)</a>:</h4>
<p>nunotexbsd edited a <a href="https://github.com/bytecodealliance/wasmtime/issues/5499#issuecomment-1381809973">comment</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/5499">issue #5499</a>:</p>
<blockquote>
<p>@sec<br>
Thanks for testing it. I still waiting for arm64 hardware so I can't test it.<br>
I will apply your patch and try to find someone that build and run test for me.</p>
<p><a href="https://github.com/lapce/lapce">https://github.com/lapce/lapce</a> , FreeBSD <a href="https://www.freshports.org/editors/lapce/">port</a>, will be tested on arm64.aarch64</p>
</blockquote>



<a name="321224676"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%235499%20FreeBSD%20arm64/aarch64%20support/near/321224676" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.235499.20FreeBSD.20arm64.2Faarch64.20support.html#321224676">(Jan 13 2023 at 18:08)</a>:</h4>
<p>afonso360 <a href="https://github.com/bytecodealliance/wasmtime/issues/5499#issuecomment-1382208165">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/5499">issue #5499</a>:</p>
<blockquote>
<p><span aria-label="wave" class="emoji emoji-1f44b" role="img" title="wave">:wave:</span> Hey, I've tested the above patch in FreeBSD 14.0-CURRENT</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="n">freebsd</span><span class="o">@</span><span class="n">generic</span>:<span class="o">~</span><span class="w"> </span><span class="o">%</span><span class="w"> </span><span class="n">uname</span><span class="w"> </span><span class="o">-</span><span class="n">a</span><span class="w"></span>
<span class="n">FreeBSD</span><span class="w"> </span><span class="n">generic</span><span class="w"> </span><span class="mf">14.0</span><span class="o">-</span><span class="n">CURRENT</span><span class="w"> </span><span class="n">FreeBSD</span><span class="w"> </span><span class="mf">14.0</span><span class="o">-</span><span class="n">CURRENT</span><span class="w"> </span>#<span class="mi">0</span><span class="w"> </span><span class="n">main</span><span class="o">-</span><span class="n">n259967</span><span class="o">-</span><span class="mi">11</span><span class="n">b5b9e8a520</span>: <span class="nc">Sat</span><span class="w"> </span><span class="n">Jan</span><span class="w">  </span><span class="mi">7</span><span class="w"> </span><span class="mi">18</span>:<span class="mi">30</span>:<span class="mi">37</span><span class="w"> </span><span class="n">UTC</span><span class="w"> </span><span class="mi">2023</span><span class="w">     </span><span class="n">root</span><span class="o">@</span><span class="n">releng1</span><span class="p">.</span><span class="n">nyi</span><span class="p">.</span><span class="n">freebsd</span><span class="p">.</span><span class="n">org</span>:<span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">obj</span><span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">arm64</span><span class="p">.</span><span class="n">aarch64</span><span class="o">/</span><span class="n">sys</span><span class="o">/</span><span class="n">GENERIC</span><span class="w"> </span><span class="n">arm64</span><span class="w"></span>
</code></pre></div>
<p><code>cargo build</code> and <code>cargo run</code> work.</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="n">freebsd</span><span class="o">@</span><span class="n">generic</span>:<span class="o">~/</span><span class="n">git</span><span class="o">/</span><span class="n">wasmtime</span><span class="w"> </span><span class="o">%</span><span class="w"> </span><span class="n">cargo</span><span class="w"> </span><span class="n">run</span><span class="w"> </span><span class="p">.</span><span class="o">/</span><span class="n">examples</span><span class="o">/</span><span class="n">gcd</span><span class="p">.</span><span class="n">wat</span><span class="w"> </span><span class="o">--</span><span class="n">invoke</span><span class="w"> </span><span class="n">gcd</span><span class="w"> </span><span class="mi">8</span><span class="w"> </span><span class="mi">8</span><span class="w"></span>
<span class="w">    </span><span class="n">Finished</span><span class="w"> </span><span class="n">dev</span><span class="w"> </span><span class="p">[</span><span class="n">unoptimized</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">debuginfo</span><span class="p">]</span><span class="w"> </span><span class="n">target</span><span class="p">(</span><span class="n">s</span><span class="p">)</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="mf">2.21</span><span class="n">s</span><span class="w"></span>
<span class="w">     </span><span class="n">Running</span><span class="w"> </span><span class="err">`</span><span class="n">target</span><span class="o">/</span><span class="n">debug</span><span class="o">/</span><span class="n">wasmtime</span><span class="w"> </span><span class="p">.</span><span class="o">/</span><span class="n">examples</span><span class="o">/</span><span class="n">gcd</span><span class="p">.</span><span class="n">wat</span><span class="w"> </span><span class="o">--</span><span class="n">invoke</span><span class="w"> </span><span class="n">gcd</span><span class="w"> </span><span class="mi">8</span><span class="w"> </span><span class="mi">8</span><span class="err">`</span><span class="w"></span>
<span class="n">warning</span>: <span class="nc">using</span><span class="w"> </span><span class="err">`</span><span class="o">--</span><span class="n">invoke</span><span class="err">`</span><span class="w"> </span><span class="n">with</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="n">function</span><span class="w"> </span><span class="n">that</span><span class="w"> </span><span class="n">takes</span><span class="w"> </span><span class="n">arguments</span><span class="w"> </span><span class="n">is</span><span class="w"> </span><span class="n">experimental</span><span class="w"> </span><span class="n">and</span><span class="w"> </span><span class="n">may</span><span class="w"> </span><span class="k">break</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">future</span><span class="w"></span>
<span class="n">warning</span>: <span class="nc">using</span><span class="w"> </span><span class="err">`</span><span class="o">--</span><span class="n">invoke</span><span class="err">`</span><span class="w"> </span><span class="n">with</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="n">function</span><span class="w"> </span><span class="n">that</span><span class="w"> </span><span class="n">returns</span><span class="w"> </span><span class="n">values</span><span class="w"> </span><span class="n">is</span><span class="w"> </span><span class="n">experimental</span><span class="w"> </span><span class="n">and</span><span class="w"> </span><span class="n">may</span><span class="w"> </span><span class="k">break</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">future</span><span class="w"></span>
<span class="mi">8</span><span class="w"></span>
</code></pre></div>
<p>I was able to run <code>cargo test</code>, but the tests fail with <code>illegal instruction</code></p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="w">     </span><span class="n">Running</span><span class="w"> </span><span class="n">unittests</span><span class="w"> </span><span class="n">src</span><span class="o">/</span><span class="n">lib</span><span class="p">.</span><span class="n">rs</span><span class="w"> </span><span class="p">(</span><span class="n">target</span><span class="o">/</span><span class="n">debug</span><span class="o">/</span><span class="n">deps</span><span class="o">/</span><span class="n">wasmtime_cli</span><span class="o">-</span><span class="n">f9e37a0a7433af84</span><span class="p">)</span><span class="w"></span>

<span class="n">running</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="n">tests</span><span class="w"></span>
<span class="n">test</span><span class="w"> </span><span class="n">commands</span>::<span class="n">compile</span>::<span class="n">test</span>::<span class="n">test_aarch64_flags_compile</span><span class="w"> </span><span class="o">..</span><span class="p">.</span><span class="w"> </span><span class="n">ok</span><span class="w"></span>
<span class="n">test</span><span class="w"> </span><span class="n">commands</span>::<span class="n">compile</span>::<span class="n">test</span>::<span class="n">test_successful_compile</span><span class="w"> </span><span class="o">..</span><span class="p">.</span><span class="w"> </span><span class="n">ok</span><span class="w"></span>

<span class="n">test</span><span class="w"> </span><span class="n">result</span>: <span class="nc">ok</span><span class="p">.</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="n">passed</span><span class="p">;</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="n">failed</span><span class="p">;</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="n">ignored</span><span class="p">;</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="n">measured</span><span class="p">;</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="n">filtered</span><span class="w"> </span><span class="n">out</span><span class="p">;</span><span class="w"> </span><span class="n">finished</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="mf">0.57</span><span class="n">s</span><span class="w"></span>

<span class="w">     </span><span class="n">Running</span><span class="w"> </span><span class="n">unittests</span><span class="w"> </span><span class="n">src</span><span class="o">/</span><span class="n">bin</span><span class="o">/</span><span class="n">wasmtime</span><span class="p">.</span><span class="n">rs</span><span class="w"> </span><span class="p">(</span><span class="n">target</span><span class="o">/</span><span class="n">debug</span><span class="o">/</span><span class="n">deps</span><span class="o">/</span><span class="n">wasmtime</span><span class="o">-</span><span class="mi">27</span><span class="n">a7f646c50db093</span><span class="p">)</span><span class="w"></span>

<span class="n">running</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="n">tests</span><span class="w"></span>

<span class="n">test</span><span class="w"> </span><span class="n">result</span>: <span class="nc">ok</span><span class="p">.</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="n">passed</span><span class="p">;</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="n">failed</span><span class="p">;</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="n">ignored</span><span class="p">;</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="n">measured</span><span class="p">;</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="n">filtered</span><span class="w"> </span><span class="n">out</span><span class="p">;</span><span class="w"> </span><span class="n">finished</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="mf">0.00</span><span class="n">s</span><span class="w"></span>

<span class="w">     </span><span class="n">Running</span><span class="w"> </span><span class="n">tests</span><span class="o">/</span><span class="n">all</span><span class="o">/</span><span class="n">main</span><span class="p">.</span><span class="n">rs</span><span class="w"> </span><span class="p">(</span><span class="n">target</span><span class="o">/</span><span class="n">debug</span><span class="o">/</span><span class="n">deps</span><span class="o">/</span><span class="n">all</span><span class="o">-</span><span class="mi">619</span><span class="n">db9ec6a9e4647</span><span class="p">)</span><span class="w"></span>

<span class="n">running</span><span class="w"> </span><span class="mi">819</span><span class="w"> </span><span class="n">tests</span><span class="w"></span>
<span class="n">test</span><span class="w"> </span><span class="n">async_functions</span>::<span class="n">async_with_pooling_stacks</span><span class="w"> </span><span class="o">..</span><span class="p">.</span><span class="w"> </span><span class="n">ok</span><span class="w"></span>
<span class="n">test</span><span class="w"> </span><span class="n">async_functions</span>::<span class="n">cancel_during_run</span><span class="w"> </span><span class="o">..</span><span class="p">.</span><span class="w"> </span><span class="n">ok</span><span class="w"></span>
<span class="n">test</span><span class="w"> </span><span class="n">async_functions</span>::<span class="n">async_host_func_with_pooling_stacks</span><span class="w"> </span><span class="o">..</span><span class="p">.</span><span class="w"> </span><span class="n">ok</span><span class="w"></span>
<span class="n">test</span><span class="w"> </span><span class="n">async_functions</span>::<span class="n">fuel_eventually_finishes</span><span class="w"> </span><span class="o">..</span><span class="p">.</span><span class="w"> </span><span class="n">ok</span><span class="w"></span>
<span class="n">error</span>: <span class="nc">test</span><span class="w"> </span><span class="n">failed</span><span class="p">,</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">rerun</span><span class="w"> </span><span class="n">pass</span><span class="w"> </span><span class="err">`</span><span class="o">--</span><span class="n">test</span><span class="w"> </span><span class="n">all</span><span class="err">`</span><span class="w"></span>

<span class="n">Caused</span><span class="w"> </span><span class="n">by</span>:
  <span class="nc">process</span><span class="w"> </span><span class="n">didn</span><span class="o">'</span><span class="na">t</span><span class="w"> </span><span class="n">exit</span><span class="w"> </span><span class="n">successfully</span>: <span class="err">`</span><span class="o">/</span><span class="n">home</span><span class="o">/</span><span class="n">freebsd</span><span class="o">/</span><span class="n">git</span><span class="o">/</span><span class="n">wasmtime</span><span class="o">/</span><span class="n">target</span><span class="o">/</span><span class="n">debug</span><span class="o">/</span><span class="n">deps</span><span class="o">/</span><span class="n">all</span><span class="o">-</span><span class="mi">619</span><span class="n">db9ec6a9e4647</span><span class="err">`</span><span class="w"> </span><span class="p">(</span><span class="n">signal</span>: <span class="mi">4</span><span class="p">,</span><span class="w"> </span><span class="n">SIGILL</span>: <span class="nc">illegal</span><span class="w"> </span><span class="n">instruction</span><span class="p">)</span><span class="w"></span>
</code></pre></div>
</blockquote>



<a name="321225080"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%235499%20FreeBSD%20arm64/aarch64%20support/near/321225080" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.235499.20FreeBSD.20arm64.2Faarch64.20support.html#321225080">(Jan 13 2023 at 18:10)</a>:</h4>
<p>afonso360 edited a <a href="https://github.com/bytecodealliance/wasmtime/issues/5499#issuecomment-1382208165">comment</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/5499">issue #5499</a>:</p>
<blockquote>
<p><span aria-label="wave" class="emoji emoji-1f44b" role="img" title="wave">:wave:</span> Hey, I've tested the above patch in FreeBSD 14.0-CURRENT</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="n">freebsd</span><span class="o">@</span><span class="n">generic</span>:<span class="o">~</span><span class="w"> </span><span class="o">%</span><span class="w"> </span><span class="n">uname</span><span class="w"> </span><span class="o">-</span><span class="n">a</span><span class="w"></span>
<span class="n">FreeBSD</span><span class="w"> </span><span class="n">generic</span><span class="w"> </span><span class="mf">14.0</span><span class="o">-</span><span class="n">CURRENT</span><span class="w"> </span><span class="n">FreeBSD</span><span class="w"> </span><span class="mf">14.0</span><span class="o">-</span><span class="n">CURRENT</span><span class="w"> </span>#<span class="mi">0</span><span class="w"> </span><span class="n">main</span><span class="o">-</span><span class="n">n259967</span><span class="o">-</span><span class="mi">11</span><span class="n">b5b9e8a520</span>: <span class="nc">Sat</span><span class="w"> </span><span class="n">Jan</span><span class="w">  </span><span class="mi">7</span><span class="w"> </span><span class="mi">18</span>:<span class="mi">30</span>:<span class="mi">37</span><span class="w"> </span><span class="n">UTC</span><span class="w"> </span><span class="mi">2023</span><span class="w">     </span><span class="n">root</span><span class="o">@</span><span class="n">releng1</span><span class="p">.</span><span class="n">nyi</span><span class="p">.</span><span class="n">freebsd</span><span class="p">.</span><span class="n">org</span>:<span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">obj</span><span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">arm64</span><span class="p">.</span><span class="n">aarch64</span><span class="o">/</span><span class="n">sys</span><span class="o">/</span><span class="n">GENERIC</span><span class="w"> </span><span class="n">arm64</span><span class="w"></span>
</code></pre></div>
<p><code>cargo build</code> and <code>cargo run</code> work.</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="n">freebsd</span><span class="o">@</span><span class="n">generic</span>:<span class="o">~/</span><span class="n">git</span><span class="o">/</span><span class="n">wasmtime</span><span class="w"> </span><span class="o">%</span><span class="w"> </span><span class="n">cargo</span><span class="w"> </span><span class="n">run</span><span class="w"> </span><span class="p">.</span><span class="o">/</span><span class="n">examples</span><span class="o">/</span><span class="n">gcd</span><span class="p">.</span><span class="n">wat</span><span class="w"> </span><span class="o">--</span><span class="n">invoke</span><span class="w"> </span><span class="n">gcd</span><span class="w"> </span><span class="mi">8</span><span class="w"> </span><span class="mi">8</span><span class="w"></span>
<span class="w">    </span><span class="n">Finished</span><span class="w"> </span><span class="n">dev</span><span class="w"> </span><span class="p">[</span><span class="n">unoptimized</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">debuginfo</span><span class="p">]</span><span class="w"> </span><span class="n">target</span><span class="p">(</span><span class="n">s</span><span class="p">)</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="mf">2.21</span><span class="n">s</span><span class="w"></span>
<span class="w">     </span><span class="n">Running</span><span class="w"> </span><span class="err">`</span><span class="n">target</span><span class="o">/</span><span class="n">debug</span><span class="o">/</span><span class="n">wasmtime</span><span class="w"> </span><span class="p">.</span><span class="o">/</span><span class="n">examples</span><span class="o">/</span><span class="n">gcd</span><span class="p">.</span><span class="n">wat</span><span class="w"> </span><span class="o">--</span><span class="n">invoke</span><span class="w"> </span><span class="n">gcd</span><span class="w"> </span><span class="mi">8</span><span class="w"> </span><span class="mi">8</span><span class="err">`</span><span class="w"></span>
<span class="n">warning</span>: <span class="nc">using</span><span class="w"> </span><span class="err">`</span><span class="o">--</span><span class="n">invoke</span><span class="err">`</span><span class="w"> </span><span class="n">with</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="n">function</span><span class="w"> </span><span class="n">that</span><span class="w"> </span><span class="n">takes</span><span class="w"> </span><span class="n">arguments</span><span class="w"> </span><span class="n">is</span><span class="w"> </span><span class="n">experimental</span><span class="w"> </span><span class="n">and</span><span class="w"> </span><span class="n">may</span><span class="w"> </span><span class="k">break</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">future</span><span class="w"></span>
<span class="n">warning</span>: <span class="nc">using</span><span class="w"> </span><span class="err">`</span><span class="o">--</span><span class="n">invoke</span><span class="err">`</span><span class="w"> </span><span class="n">with</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="n">function</span><span class="w"> </span><span class="n">that</span><span class="w"> </span><span class="n">returns</span><span class="w"> </span><span class="n">values</span><span class="w"> </span><span class="n">is</span><span class="w"> </span><span class="n">experimental</span><span class="w"> </span><span class="n">and</span><span class="w"> </span><span class="n">may</span><span class="w"> </span><span class="k">break</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">future</span><span class="w"></span>
<span class="mi">8</span><span class="w"></span>
</code></pre></div>
<p>I was able to run <code>cargo test</code>, but the tests fail with <code>illegal instruction</code></p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="w">     </span><span class="n">Running</span><span class="w"> </span><span class="n">unittests</span><span class="w"> </span><span class="n">src</span><span class="o">/</span><span class="n">lib</span><span class="p">.</span><span class="n">rs</span><span class="w"> </span><span class="p">(</span><span class="n">target</span><span class="o">/</span><span class="n">debug</span><span class="o">/</span><span class="n">deps</span><span class="o">/</span><span class="n">wasmtime_cli</span><span class="o">-</span><span class="n">f9e37a0a7433af84</span><span class="p">)</span><span class="w"></span>

<span class="n">running</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="n">tests</span><span class="w"></span>
<span class="n">test</span><span class="w"> </span><span class="n">commands</span>::<span class="n">compile</span>::<span class="n">test</span>::<span class="n">test_aarch64_flags_compile</span><span class="w"> </span><span class="o">..</span><span class="p">.</span><span class="w"> </span><span class="n">ok</span><span class="w"></span>
<span class="n">test</span><span class="w"> </span><span class="n">commands</span>::<span class="n">compile</span>::<span class="n">test</span>::<span class="n">test_successful_compile</span><span class="w"> </span><span class="o">..</span><span class="p">.</span><span class="w"> </span><span class="n">ok</span><span class="w"></span>

<span class="n">test</span><span class="w"> </span><span class="n">result</span>: <span class="nc">ok</span><span class="p">.</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="n">passed</span><span class="p">;</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="n">failed</span><span class="p">;</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="n">ignored</span><span class="p">;</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="n">measured</span><span class="p">;</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="n">filtered</span><span class="w"> </span><span class="n">out</span><span class="p">;</span><span class="w"> </span><span class="n">finished</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="mf">0.57</span><span class="n">s</span><span class="w"></span>

<span class="w">     </span><span class="n">Running</span><span class="w"> </span><span class="n">unittests</span><span class="w"> </span><span class="n">src</span><span class="o">/</span><span class="n">bin</span><span class="o">/</span><span class="n">wasmtime</span><span class="p">.</span><span class="n">rs</span><span class="w"> </span><span class="p">(</span><span class="n">target</span><span class="o">/</span><span class="n">debug</span><span class="o">/</span><span class="n">deps</span><span class="o">/</span><span class="n">wasmtime</span><span class="o">-</span><span class="mi">27</span><span class="n">a7f646c50db093</span><span class="p">)</span><span class="w"></span>

<span class="n">running</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="n">tests</span><span class="w"></span>

<span class="n">test</span><span class="w"> </span><span class="n">result</span>: <span class="nc">ok</span><span class="p">.</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="n">passed</span><span class="p">;</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="n">failed</span><span class="p">;</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="n">ignored</span><span class="p">;</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="n">measured</span><span class="p">;</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="n">filtered</span><span class="w"> </span><span class="n">out</span><span class="p">;</span><span class="w"> </span><span class="n">finished</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="mf">0.00</span><span class="n">s</span><span class="w"></span>

<span class="w">     </span><span class="n">Running</span><span class="w"> </span><span class="n">tests</span><span class="o">/</span><span class="n">all</span><span class="o">/</span><span class="n">main</span><span class="p">.</span><span class="n">rs</span><span class="w"> </span><span class="p">(</span><span class="n">target</span><span class="o">/</span><span class="n">debug</span><span class="o">/</span><span class="n">deps</span><span class="o">/</span><span class="n">all</span><span class="o">-</span><span class="mi">619</span><span class="n">db9ec6a9e4647</span><span class="p">)</span><span class="w"></span>

<span class="n">running</span><span class="w"> </span><span class="mi">819</span><span class="w"> </span><span class="n">tests</span><span class="w"></span>
<span class="n">test</span><span class="w"> </span><span class="n">async_functions</span>::<span class="n">async_with_pooling_stacks</span><span class="w"> </span><span class="o">..</span><span class="p">.</span><span class="w"> </span><span class="n">ok</span><span class="w"></span>
<span class="n">test</span><span class="w"> </span><span class="n">async_functions</span>::<span class="n">cancel_during_run</span><span class="w"> </span><span class="o">..</span><span class="p">.</span><span class="w"> </span><span class="n">ok</span><span class="w"></span>
<span class="n">test</span><span class="w"> </span><span class="n">async_functions</span>::<span class="n">async_host_func_with_pooling_stacks</span><span class="w"> </span><span class="o">..</span><span class="p">.</span><span class="w"> </span><span class="n">ok</span><span class="w"></span>
<span class="n">test</span><span class="w"> </span><span class="n">async_functions</span>::<span class="n">fuel_eventually_finishes</span><span class="w"> </span><span class="o">..</span><span class="p">.</span><span class="w"> </span><span class="n">ok</span><span class="w"></span>
<span class="n">error</span>: <span class="nc">test</span><span class="w"> </span><span class="n">failed</span><span class="p">,</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">rerun</span><span class="w"> </span><span class="n">pass</span><span class="w"> </span><span class="err">`</span><span class="o">--</span><span class="n">test</span><span class="w"> </span><span class="n">all</span><span class="err">`</span><span class="w"></span>

<span class="n">Caused</span><span class="w"> </span><span class="n">by</span>:
  <span class="nc">process</span><span class="w"> </span><span class="n">didn</span><span class="o">'</span><span class="na">t</span><span class="w"> </span><span class="n">exit</span><span class="w"> </span><span class="n">successfully</span>: <span class="err">`</span><span class="o">/</span><span class="n">home</span><span class="o">/</span><span class="n">freebsd</span><span class="o">/</span><span class="n">git</span><span class="o">/</span><span class="n">wasmtime</span><span class="o">/</span><span class="n">target</span><span class="o">/</span><span class="n">debug</span><span class="o">/</span><span class="n">deps</span><span class="o">/</span><span class="n">all</span><span class="o">-</span><span class="mi">619</span><span class="n">db9ec6a9e4647</span><span class="err">`</span><span class="w"> </span><span class="p">(</span><span class="n">signal</span>: <span class="mi">4</span><span class="p">,</span><span class="w"> </span><span class="n">SIGILL</span>: <span class="nc">illegal</span><span class="w"> </span><span class="n">instruction</span><span class="p">)</span><span class="w"></span>
</code></pre></div>
<p>I would guess this is due to the missing icache code. The symptoms are fairly similar to what was happening in #4997 for Windows AArch64.</p>
</blockquote>



<a name="321228652"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%235499%20FreeBSD%20arm64/aarch64%20support/near/321228652" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.235499.20FreeBSD.20arm64.2Faarch64.20support.html#321228652">(Jan 13 2023 at 18:28)</a>:</h4>
<p>afonso360 edited a <a href="https://github.com/bytecodealliance/wasmtime/issues/5499#issuecomment-1382208165">comment</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/5499">issue #5499</a>:</p>
<blockquote>
<p><span aria-label="wave" class="emoji emoji-1f44b" role="img" title="wave">:wave:</span> Hey, I've tested the above patch in FreeBSD 14.0-CURRENT</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="n">freebsd</span><span class="o">@</span><span class="n">generic</span>:<span class="o">~</span><span class="w"> </span><span class="o">%</span><span class="w"> </span><span class="n">uname</span><span class="w"> </span><span class="o">-</span><span class="n">a</span><span class="w"></span>
<span class="n">FreeBSD</span><span class="w"> </span><span class="n">generic</span><span class="w"> </span><span class="mf">14.0</span><span class="o">-</span><span class="n">CURRENT</span><span class="w"> </span><span class="n">FreeBSD</span><span class="w"> </span><span class="mf">14.0</span><span class="o">-</span><span class="n">CURRENT</span><span class="w"> </span>#<span class="mi">0</span><span class="w"> </span><span class="n">main</span><span class="o">-</span><span class="n">n259967</span><span class="o">-</span><span class="mi">11</span><span class="n">b5b9e8a520</span>: <span class="nc">Sat</span><span class="w"> </span><span class="n">Jan</span><span class="w">  </span><span class="mi">7</span><span class="w"> </span><span class="mi">18</span>:<span class="mi">30</span>:<span class="mi">37</span><span class="w"> </span><span class="n">UTC</span><span class="w"> </span><span class="mi">2023</span><span class="w">     </span><span class="n">root</span><span class="o">@</span><span class="n">releng1</span><span class="p">.</span><span class="n">nyi</span><span class="p">.</span><span class="n">freebsd</span><span class="p">.</span><span class="n">org</span>:<span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">obj</span><span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">arm64</span><span class="p">.</span><span class="n">aarch64</span><span class="o">/</span><span class="n">sys</span><span class="o">/</span><span class="n">GENERIC</span><span class="w"> </span><span class="n">arm64</span><span class="w"></span>
</code></pre></div>
<p><code>cargo build</code> and <code>cargo run</code> work.</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="n">freebsd</span><span class="o">@</span><span class="n">generic</span>:<span class="o">~/</span><span class="n">git</span><span class="o">/</span><span class="n">wasmtime</span><span class="w"> </span><span class="o">%</span><span class="w"> </span><span class="n">cargo</span><span class="w"> </span><span class="n">run</span><span class="w"> </span><span class="p">.</span><span class="o">/</span><span class="n">examples</span><span class="o">/</span><span class="n">gcd</span><span class="p">.</span><span class="n">wat</span><span class="w"> </span><span class="o">--</span><span class="n">invoke</span><span class="w"> </span><span class="n">gcd</span><span class="w"> </span><span class="mi">8</span><span class="w"> </span><span class="mi">8</span><span class="w"></span>
<span class="w">    </span><span class="n">Finished</span><span class="w"> </span><span class="n">dev</span><span class="w"> </span><span class="p">[</span><span class="n">unoptimized</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">debuginfo</span><span class="p">]</span><span class="w"> </span><span class="n">target</span><span class="p">(</span><span class="n">s</span><span class="p">)</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="mf">2.21</span><span class="n">s</span><span class="w"></span>
<span class="w">     </span><span class="n">Running</span><span class="w"> </span><span class="err">`</span><span class="n">target</span><span class="o">/</span><span class="n">debug</span><span class="o">/</span><span class="n">wasmtime</span><span class="w"> </span><span class="p">.</span><span class="o">/</span><span class="n">examples</span><span class="o">/</span><span class="n">gcd</span><span class="p">.</span><span class="n">wat</span><span class="w"> </span><span class="o">--</span><span class="n">invoke</span><span class="w"> </span><span class="n">gcd</span><span class="w"> </span><span class="mi">8</span><span class="w"> </span><span class="mi">8</span><span class="err">`</span><span class="w"></span>
<span class="n">warning</span>: <span class="nc">using</span><span class="w"> </span><span class="err">`</span><span class="o">--</span><span class="n">invoke</span><span class="err">`</span><span class="w"> </span><span class="n">with</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="n">function</span><span class="w"> </span><span class="n">that</span><span class="w"> </span><span class="n">takes</span><span class="w"> </span><span class="n">arguments</span><span class="w"> </span><span class="n">is</span><span class="w"> </span><span class="n">experimental</span><span class="w"> </span><span class="n">and</span><span class="w"> </span><span class="n">may</span><span class="w"> </span><span class="k">break</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">future</span><span class="w"></span>
<span class="n">warning</span>: <span class="nc">using</span><span class="w"> </span><span class="err">`</span><span class="o">--</span><span class="n">invoke</span><span class="err">`</span><span class="w"> </span><span class="n">with</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="n">function</span><span class="w"> </span><span class="n">that</span><span class="w"> </span><span class="n">returns</span><span class="w"> </span><span class="n">values</span><span class="w"> </span><span class="n">is</span><span class="w"> </span><span class="n">experimental</span><span class="w"> </span><span class="n">and</span><span class="w"> </span><span class="n">may</span><span class="w"> </span><span class="k">break</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">future</span><span class="w"></span>
<span class="mi">8</span><span class="w"></span>
</code></pre></div>
<p>I was able to run <code>cargo test</code>, but the tests fail with <code>illegal instruction</code></p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="w">     </span><span class="n">Running</span><span class="w"> </span><span class="n">unittests</span><span class="w"> </span><span class="n">src</span><span class="o">/</span><span class="n">lib</span><span class="p">.</span><span class="n">rs</span><span class="w"> </span><span class="p">(</span><span class="n">target</span><span class="o">/</span><span class="n">debug</span><span class="o">/</span><span class="n">deps</span><span class="o">/</span><span class="n">wasmtime_cli</span><span class="o">-</span><span class="n">f9e37a0a7433af84</span><span class="p">)</span><span class="w"></span>

<span class="n">running</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="n">tests</span><span class="w"></span>
<span class="n">test</span><span class="w"> </span><span class="n">commands</span>::<span class="n">compile</span>::<span class="n">test</span>::<span class="n">test_aarch64_flags_compile</span><span class="w"> </span><span class="o">..</span><span class="p">.</span><span class="w"> </span><span class="n">ok</span><span class="w"></span>
<span class="n">test</span><span class="w"> </span><span class="n">commands</span>::<span class="n">compile</span>::<span class="n">test</span>::<span class="n">test_successful_compile</span><span class="w"> </span><span class="o">..</span><span class="p">.</span><span class="w"> </span><span class="n">ok</span><span class="w"></span>

<span class="n">test</span><span class="w"> </span><span class="n">result</span>: <span class="nc">ok</span><span class="p">.</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="n">passed</span><span class="p">;</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="n">failed</span><span class="p">;</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="n">ignored</span><span class="p">;</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="n">measured</span><span class="p">;</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="n">filtered</span><span class="w"> </span><span class="n">out</span><span class="p">;</span><span class="w"> </span><span class="n">finished</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="mf">0.57</span><span class="n">s</span><span class="w"></span>

<span class="w">     </span><span class="n">Running</span><span class="w"> </span><span class="n">unittests</span><span class="w"> </span><span class="n">src</span><span class="o">/</span><span class="n">bin</span><span class="o">/</span><span class="n">wasmtime</span><span class="p">.</span><span class="n">rs</span><span class="w"> </span><span class="p">(</span><span class="n">target</span><span class="o">/</span><span class="n">debug</span><span class="o">/</span><span class="n">deps</span><span class="o">/</span><span class="n">wasmtime</span><span class="o">-</span><span class="mi">27</span><span class="n">a7f646c50db093</span><span class="p">)</span><span class="w"></span>

<span class="n">running</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="n">tests</span><span class="w"></span>

<span class="n">test</span><span class="w"> </span><span class="n">result</span>: <span class="nc">ok</span><span class="p">.</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="n">passed</span><span class="p">;</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="n">failed</span><span class="p">;</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="n">ignored</span><span class="p">;</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="n">measured</span><span class="p">;</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="n">filtered</span><span class="w"> </span><span class="n">out</span><span class="p">;</span><span class="w"> </span><span class="n">finished</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="mf">0.00</span><span class="n">s</span><span class="w"></span>

<span class="w">     </span><span class="n">Running</span><span class="w"> </span><span class="n">tests</span><span class="o">/</span><span class="n">all</span><span class="o">/</span><span class="n">main</span><span class="p">.</span><span class="n">rs</span><span class="w"> </span><span class="p">(</span><span class="n">target</span><span class="o">/</span><span class="n">debug</span><span class="o">/</span><span class="n">deps</span><span class="o">/</span><span class="n">all</span><span class="o">-</span><span class="mi">619</span><span class="n">db9ec6a9e4647</span><span class="p">)</span><span class="w"></span>

<span class="n">running</span><span class="w"> </span><span class="mi">819</span><span class="w"> </span><span class="n">tests</span><span class="w"></span>
<span class="n">test</span><span class="w"> </span><span class="n">async_functions</span>::<span class="n">async_with_pooling_stacks</span><span class="w"> </span><span class="o">..</span><span class="p">.</span><span class="w"> </span><span class="n">ok</span><span class="w"></span>
<span class="n">test</span><span class="w"> </span><span class="n">async_functions</span>::<span class="n">cancel_during_run</span><span class="w"> </span><span class="o">..</span><span class="p">.</span><span class="w"> </span><span class="n">ok</span><span class="w"></span>
<span class="n">test</span><span class="w"> </span><span class="n">async_functions</span>::<span class="n">async_host_func_with_pooling_stacks</span><span class="w"> </span><span class="o">..</span><span class="p">.</span><span class="w"> </span><span class="n">ok</span><span class="w"></span>
<span class="n">test</span><span class="w"> </span><span class="n">async_functions</span>::<span class="n">fuel_eventually_finishes</span><span class="w"> </span><span class="o">..</span><span class="p">.</span><span class="w"> </span><span class="n">ok</span><span class="w"></span>
<span class="n">error</span>: <span class="nc">test</span><span class="w"> </span><span class="n">failed</span><span class="p">,</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">rerun</span><span class="w"> </span><span class="n">pass</span><span class="w"> </span><span class="err">`</span><span class="o">--</span><span class="n">test</span><span class="w"> </span><span class="n">all</span><span class="err">`</span><span class="w"></span>

<span class="n">Caused</span><span class="w"> </span><span class="n">by</span>:
  <span class="nc">process</span><span class="w"> </span><span class="n">didn</span><span class="o">'</span><span class="na">t</span><span class="w"> </span><span class="n">exit</span><span class="w"> </span><span class="n">successfully</span>: <span class="err">`</span><span class="o">/</span><span class="n">home</span><span class="o">/</span><span class="n">freebsd</span><span class="o">/</span><span class="n">git</span><span class="o">/</span><span class="n">wasmtime</span><span class="o">/</span><span class="n">target</span><span class="o">/</span><span class="n">debug</span><span class="o">/</span><span class="n">deps</span><span class="o">/</span><span class="n">all</span><span class="o">-</span><span class="mi">619</span><span class="n">db9ec6a9e4647</span><span class="err">`</span><span class="w"> </span><span class="p">(</span><span class="n">signal</span>: <span class="mi">4</span><span class="p">,</span><span class="w"> </span><span class="n">SIGILL</span>: <span class="nc">illegal</span><span class="w"> </span><span class="n">instruction</span><span class="p">)</span><span class="w"></span>
</code></pre></div>
<p>I would guess this is due to the missing icache code. The symptoms are fairly similar to what was happening in #4997 for Windows AArch64.</p>
<hr>
<p>Edit: The cranelift test suite passes, which I wouldn't have expected <span aria-label="thinking" class="emoji emoji-1f914" role="img" title="thinking">:thinking:</span> Maybe something else is going on here.</p>
</blockquote>



<a name="321269318"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%235499%20FreeBSD%20arm64/aarch64%20support/near/321269318" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.235499.20FreeBSD.20arm64.2Faarch64.20support.html#321269318">(Jan 13 2023 at 22:24)</a>:</h4>
<p>nunotexbsd <a href="https://github.com/bytecodealliance/wasmtime/issues/5499#issuecomment-1382460649">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/5499">issue #5499</a>:</p>
<blockquote>
<p>@afonso360<br>
Thanks for do further tests.<br>
I'm working on <a href="https://bugs.freebsd.org/bugzilla/show_bug.cgi?id=268929">https://bugs.freebsd.org/bugzilla/show_bug.cgi?id=268929</a> and if it succeeds, then I can start testing other ports that depends on this crate.</p>
</blockquote>



<a name="321489642"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%235499%20FreeBSD%20arm64/aarch64%20support/near/321489642" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.235499.20FreeBSD.20arm64.2Faarch64.20support.html#321489642">(Jan 15 2023 at 13:59)</a>:</h4>
<p>nunotexbsd <a href="https://github.com/bytecodealliance/wasmtime/issues/5499#issuecomment-1383157702">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/5499">issue #5499</a>:</p>
<blockquote>
<blockquote>
<p>Just to add something, for latest relase (6.0.0), small change is need to make it compile:</p>
<p><code>
} else if #[cfg(all(target_os = "freebsd", target_arch = "aarch64"))] {
    let cx = &amp;*(cx as *const libc::mcontext_t);
    (
        cx.mc_gpregs.gp_elr as *const u8,
        cx.mc_gpregs.gp_x[29] as usize,
    )
</code></p>
<p>around <a href="https://github.com/bytecodealliance/wasmtime/blob/main/crates/runtime/src/traphandlers/unix.rs#L220">https://github.com/bytecodealliance/wasmtime/blob/main/crates/runtime/src/traphandlers/unix.rs#L220</a></p>
<p>This make it compile, but running tests is not possible becuase of <a href="https://github.com/denoland/rusty_v8/issues/1094">denoland/rusty_v8#1094</a></p>
</blockquote>
<p>Hello @sec,</p>
<p>I have results that it builds on aarch64 and I committed your patch at <a href="https://cgit.freebsd.org/ports/commit/?id=75a1d429216aa977d1bf6b1f4a9c5eb4eb474ac8">https://cgit.freebsd.org/ports/commit/?id=75a1d429216aa977d1bf6b1f4a9c5eb4eb474ac8</a></p>
<p>Should a upstream change be made with this patch?</p>
<p>( Build fails on armv7 FreeBSD 13.1:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="n">error</span><span class="p">[</span><span class="n">E0308</span><span class="p">]</span>: <span class="nc">mismatched</span><span class="w"> </span><span class="n">types</span><span class="w"></span>
<span class="w">   </span><span class="o">-</span>-&gt; <span class="o">/</span><span class="n">wrkdirs</span><span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">ports</span><span class="o">/</span><span class="n">editors</span><span class="o">/</span><span class="n">lapce</span><span class="o">/</span><span class="n">work</span><span class="o">/</span><span class="n">lapce</span><span class="o">-</span><span class="mf">0.2.5</span><span class="o">/</span><span class="n">cargo</span><span class="o">-</span><span class="n">crates</span><span class="o">/</span><span class="n">rustix</span><span class="o">-</span><span class="mf">0.35.10</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">backend</span><span class="o">/</span><span class="n">libc</span><span class="o">/</span><span class="n">net</span><span class="o">/</span><span class="n">syscalls</span><span class="p">.</span><span class="n">rs</span>:<span class="mi">565</span>:<span class="mi">21</span><span class="w"></span>
<span class="w">    </span><span class="o">|</span><span class="w"></span>
<span class="mi">565</span><span class="w"> </span><span class="o">|</span><span class="w">                     </span><span class="n">tv_sec</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="o">|</span><span class="w">                     </span><span class="o">^^^^^^</span><span class="w"> </span><span class="n">expected</span><span class="w"> </span><span class="err">`</span><span class="kt">i64</span><span class="err">`</span><span class="p">,</span><span class="w"> </span><span class="n">found</span><span class="w"> </span><span class="err">`</span><span class="kt">i32</span><span class="err">`</span><span class="w"></span>
<span class="w">    </span><span class="o">|</span><span class="w">                                                                                                                              </span><span class="n">help</span>: <span class="nc">you</span><span class="w"> </span><span class="n">can</span><span class="w"> </span><span class="n">convert</span><span class="w"> </span><span class="n">an</span><span class="w"> </span><span class="err">`</span><span class="kt">i32</span><span class="err">`</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">an</span><span class="w"> </span><span class="err">`</span><span class="kt">i64</span><span class="err">`</span><span class="w"></span>
<span class="w">    </span><span class="o">|</span><span class="w"></span>
<span class="mi">565</span><span class="w"> </span><span class="o">|</span><span class="w">                     </span><span class="n">tv_sec</span>: <span class="nc">tv_sec</span><span class="p">.</span><span class="n">into</span><span class="p">(),</span><span class="w"></span>
<span class="w">    </span><span class="o">|</span><span class="w">                     </span><span class="o">+++++++</span><span class="w">       </span><span class="o">+++++++</span><span class="w"></span>

<span class="p">[</span><span class="n">num</span><span class="o">-</span><span class="n">traits</span><span class="w"> </span><span class="mf">0.2.15</span><span class="p">]</span><span class="w"> </span><span class="n">cargo</span>:<span class="nc">rustc</span><span class="o">-</span><span class="n">cfg</span><span class="o">=</span><span class="n">has_leading_trailing_ones</span><span class="w"></span>
<span class="p">[</span><span class="n">num</span><span class="o">-</span><span class="n">traits</span><span class="w"> </span><span class="mf">0.2.15</span><span class="p">]</span><span class="w"> </span><span class="n">cargo</span>:<span class="nc">rustc</span><span class="o">-</span><span class="n">cfg</span><span class="o">=</span><span class="n">has_int_assignop_ref</span><span class="w"></span>
<span class="n">For</span><span class="w"> </span><span class="n">more</span><span class="w"> </span><span class="n">information</span><span class="w"> </span><span class="n">about</span><span class="w"> </span><span class="n">this</span><span class="w"> </span><span class="n">error</span><span class="p">,</span><span class="w"> </span><span class="kr">try</span><span class="w"> </span><span class="err">`</span><span class="n">rustc</span><span class="w"> </span><span class="o">--</span><span class="n">explain</span><span class="w"> </span><span class="n">E0308</span><span class="err">`</span><span class="p">.</span><span class="w"></span>
<span class="n">error</span>: <span class="nc">could</span><span class="w"> </span><span class="n">not</span><span class="w"> </span><span class="n">compile</span><span class="w"> </span><span class="err">`</span><span class="n">rustix</span><span class="err">`</span><span class="w"> </span><span class="n">due</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">previous</span><span class="w"> </span><span class="n">error</span><span class="w"></span>
</code></pre></div>
<p>This is due to time_t not being a long on armv7. )</p>
</blockquote>



<a name="321894656"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%235499%20FreeBSD%20arm64/aarch64%20support/near/321894656" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.235499.20FreeBSD.20arm64.2Faarch64.20support.html#321894656">(Jan 17 2023 at 18:13)</a>:</h4>
<p>sunfishcode <a href="https://github.com/bytecodealliance/wasmtime/issues/5499#issuecomment-1385833394">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/5499">issue #5499</a>:</p>
<blockquote>
<p>I have a fix for that armv7 FreeBSD bug <a href="https://github.com/bytecodealliance/rustix/pull/518">here</a>; I'll do a point release of rustix and update Wasmtime.</p>
</blockquote>



<a name="321930680"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%235499%20FreeBSD%20arm64/aarch64%20support/near/321930680" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.235499.20FreeBSD.20arm64.2Faarch64.20support.html#321930680">(Jan 17 2023 at 21:38)</a>:</h4>
<p>afonso360 <a href="https://github.com/bytecodealliance/wasmtime/issues/5499#issuecomment-1386087909">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/5499">issue #5499</a>:</p>
<blockquote>
<p>Looked into this a bit more, this <a href="https://github.com/afonso360/wasmtime/tree/freebsd-clear-cache">branch</a> also does the icache clearing. However I'm still getting the same error.</p>
<p>I'll try to track this down when I get a chance.</p>
</blockquote>



<hr><p>Last updated: Jan 20 2025 at 06:04 UTC</p>
</html>