<html>
<head><meta charset="utf-8"><title>wasmtime / issue #3266 Add a `Module::deserialize_file` m... · git-wasmtime · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/index.html">git-wasmtime</a></h2>
<h3>Topic: <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.233266.20Add.20a.20.60Module.3A.3Adeserialize_file.60.20m.2E.2E.2E.html">wasmtime / issue #3266 Add a `Module::deserialize_file` m...</a></h3>

<hr>

<base href="https://bytecodealliance.zulipchat.com">

<head><link href="https://bytecodealliance.github.io/zulip-archive/style.css" rel="stylesheet"></head>

<a name="251251346"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%233266%20Add%20a%20%60Module%3A%3Adeserialize_file%60%20m.../near/251251346" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.233266.20Add.20a.20.60Module.3A.3Adeserialize_file.60.20m.2E.2E.2E.html#251251346">(Aug 30 2021 at 15:59)</a>:</h4>
<p>alexcrichton <a href="https://github.com/bytecodealliance/wasmtime/pull/3266#issuecomment-908463520">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/3266">issue #3266</a>:</p>
<blockquote>
<p>It's worth noting that this will, by default, not play nicely with <a href="https://github.com/bytecodealliance/wasmtime/pull/3265">https://github.com/bytecodealliance/wasmtime/pull/3265</a>. Relocations are the only part of the file which we actually modify today, so some code will be added to tempoarily change the text section to read/write if relocations need to be applied. With <a href="https://github.com/bytecodealliance/wasmtime/pull/3254">https://github.com/bytecodealliance/wasmtime/pull/3254</a>, though, that should be rare. I don't actually know if it's possible for the new backend to generate any other relocations after we remove those for <code>call</code> instructions.</p>
</blockquote>



<a name="251253014"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%233266%20Add%20a%20%60Module%3A%3Adeserialize_file%60%20m.../near/251253014" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.233266.20Add.20a.20.60Module.3A.3Adeserialize_file.60.20m.2E.2E.2E.html#251253014">(Aug 30 2021 at 16:11)</a>:</h4>
<p>github-actions[bot] <a href="https://github.com/bytecodealliance/wasmtime/pull/3266#issuecomment-908474331">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/3266">issue #3266</a>:</p>
<blockquote>
<h4>Subscribe to Label Action</h4>
<p>cc @peterhuene</p>
<p>&lt;details&gt;<br>
This issue or pull request has been labeled: "wasmtime:api", "wasmtime:c-api"</p>
<p>Thus the following users have been cc'd because of the following labels:</p>
<ul>
<li>peterhuene: wasmtime:api, wasmtime:c-api</li>
</ul>
<p>To subscribe or unsubscribe from this label, edit the &lt;code&gt;.github/subscribe-to-label.json&lt;/code&gt; configuration file.</p>
<p><a href="https://github.com/bytecodealliance/subscribe-to-label-action">Learn more.</a><br>
&lt;/details&gt;</p>
</blockquote>



<a name="251275105"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%233266%20Add%20a%20%60Module%3A%3Adeserialize_file%60%20m.../near/251275105" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.233266.20Add.20a.20.60Module.3A.3Adeserialize_file.60.20m.2E.2E.2E.html#251275105">(Aug 30 2021 at 18:45)</a>:</h4>
<p>alexcrichton <a href="https://github.com/bytecodealliance/wasmtime/pull/3266#issuecomment-908593922">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/3266">issue #3266</a>:</p>
<blockquote>
<p>Ok I've added a commit to handle the case that we need relocations now that <a href="https://github.com/bytecodealliance/wasmtime/pull/3265">https://github.com/bytecodealliance/wasmtime/pull/3265</a> is in <code>main</code></p>
</blockquote>



<a name="251309205"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%233266%20Add%20a%20%60Module%3A%3Adeserialize_file%60%20m.../near/251309205" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.233266.20Add.20a.20.60Module.3A.3Adeserialize_file.60.20m.2E.2E.2E.html#251309205">(Aug 30 2021 at 23:15)</a>:</h4>
<p>peterhuene <a href="https://github.com/bytecodealliance/wasmtime/pull/3266#issuecomment-908771345">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/3266">issue #3266</a>:</p>
<blockquote>
<p>So I through a little test program together: <a href="https://gist.github.com/peterhuene/64a5dc5dd22f28950ec397a5709f0eda">https://gist.github.com/peterhuene/64a5dc5dd22f28950ec397a5709f0eda</a></p>
<p>This seems to do what we want: a single mapping where we can keep everything but the text section read-only and have CoW semantics for the text section when applying relocations.</p>
</blockquote>



<a name="251309484"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%233266%20Add%20a%20%60Module%3A%3Adeserialize_file%60%20m.../near/251309484" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.233266.20Add.20a.20.60Module.3A.3Adeserialize_file.60.20m.2E.2E.2E.html#251309484">(Aug 30 2021 at 23:19)</a>:</h4>
<p>peterhuene <a href="https://github.com/bytecodealliance/wasmtime/pull/3266#issuecomment-908772985">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/3266">issue #3266</a>:</p>
<blockquote>
<p>Also, we'll need to have something in <code>CodeMemory</code> for Windows that detects if the mapping is backed by a file and use <code>PAGE_WRITECOPY</code> (that's not a valid protection level for anonymous pages) for the relocations; otherwise we can stick to <code>PAGE_READWRITE</code>.</p>
</blockquote>



<a name="251309495"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%233266%20Add%20a%20%60Module%3A%3Adeserialize_file%60%20m.../near/251309495" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.233266.20Add.20a.20.60Module.3A.3Adeserialize_file.60.20m.2E.2E.2E.html#251309495">(Aug 30 2021 at 23:19)</a>:</h4>
<p>peterhuene edited a <a href="https://github.com/bytecodealliance/wasmtime/pull/3266#issuecomment-908771345">comment</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/3266">issue #3266</a>:</p>
<blockquote>
<p>So I threw a little test program together: <a href="https://gist.github.com/peterhuene/64a5dc5dd22f28950ec397a5709f0eda">https://gist.github.com/peterhuene/64a5dc5dd22f28950ec397a5709f0eda</a></p>
<p>This seems to do what we want: a single mapping where we can keep everything but the text section read-only and have CoW semantics for the text section when applying relocations.</p>
</blockquote>



<a name="251388470"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%233266%20Add%20a%20%60Module%3A%3Adeserialize_file%60%20m.../near/251388470" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.233266.20Add.20a.20.60Module.3A.3Adeserialize_file.60.20m.2E.2E.2E.html#251388470">(Aug 31 2021 at 13:54)</a>:</h4>
<p>alexcrichton <a href="https://github.com/bytecodealliance/wasmtime/pull/3266#issuecomment-909260657">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/3266">issue #3266</a>:</p>
<blockquote>
<blockquote>
<p>So I threw a little test program together: <a href="https://gist.github.com/peterhuene/64a5dc5dd22f28950ec397a5709f0eda">https://gist.github.com/peterhuene/64a5dc5dd22f28950ec397a5709f0eda</a></p>
</blockquote>
<p>Thanks for this! I just blindly copy/pasted that into Wasmtime now :)</p>
<p>As you can probably tell I did not indeed run tests at all on Windows beforehand, how naive of me to assume it would be the same! In any case I'm glad you know what you're doing, it would have taken me quite awhile to figure out how to align all those stars...</p>
</blockquote>



<a name="251394374"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%233266%20Add%20a%20%60Module%3A%3Adeserialize_file%60%20m.../near/251394374" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.233266.20Add.20a.20.60Module.3A.3Adeserialize_file.60.20m.2E.2E.2E.html#251394374">(Aug 31 2021 at 14:29)</a>:</h4>
<p>alexcrichton <a href="https://github.com/bytecodealliance/wasmtime/pull/3266#issuecomment-909291433">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/3266">issue #3266</a>:</p>
<blockquote>
<p>Oh hey and with your help works on the first try!</p>
</blockquote>



<hr><p>Last updated: Jan 20 2025 at 06:04 UTC</p>
</html>