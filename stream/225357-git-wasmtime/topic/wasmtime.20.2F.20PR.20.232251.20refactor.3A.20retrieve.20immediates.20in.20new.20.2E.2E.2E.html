<html>
<head><meta charset="utf-8"><title>wasmtime / PR #2251 refactor: retrieve immediates in new ... · git-wasmtime · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/index.html">git-wasmtime</a></h2>
<h3>Topic: <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232251.20refactor.3A.20retrieve.20immediates.20in.20new.20.2E.2E.2E.html">wasmtime / PR #2251 refactor: retrieve immediates in new ...</a></h3>

<hr>

<base href="https://bytecodealliance.zulipchat.com">

<head><link href="https://bytecodealliance.github.io/zulip-archive/style.css" rel="stylesheet"></head>

<a name="211947263"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232251%20refactor%3A%20retrieve%20immediates%20in%20new%20.../near/211947263" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232251.20refactor.3A.20retrieve.20immediates.20in.20new.20.2E.2E.2E.html#211947263">(Oct 01 2020 at 17:43)</a>:</h4>
<p><strong>abrown</strong> requested <a href="https://github.com/cfallin">cfallin</a> for a review on <a href="https://github.com/bytecodealliance/wasmtime/pull/2251">PR #2251</a>.</p>



<a name="211947269"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232251%20refactor%3A%20retrieve%20immediates%20in%20new%20.../near/211947269" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232251.20refactor.3A.20retrieve.20immediates.20in.20new.20.2E.2E.2E.html#211947269">(Oct 01 2020 at 17:43)</a>:</h4>
<p>abrown opened <a href="https://github.com/bytecodealliance/wasmtime/pull/2251">PR #2251</a> from <code>access-immediates</code> to <code>main</code>:</p>
<blockquote>
<p>@cfallin, here is what I came up with after we discussed this last week. This change:</p>
<ul>
<li>moves <code>DataValue</code> into cranelift-codegen so that I can use it as a value wrapper</li>
<li>gives <code>InstructionData</code> the ability to find immediate values in the format structures</li>
<li>reworks <code>LowerCtx::get_immediate</code> to grab the value from the instruction (and the DataFlowGraph for vector immediates)</li>
</ul>
<p>I felt like this approach provides the new backend a more abstract view of immediates instead of munging directly in the <code>InstructionData</code> but I didn't perform the refactor on the rest of the places the new backend grabs immediates because I wanted to get some feedback first.</p>
</blockquote>



<a name="211947470"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232251%20refactor%3A%20retrieve%20immediates%20in%20new%20.../near/211947470" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232251.20refactor.3A.20retrieve.20immediates.20in.20new.20.2E.2E.2E.html#211947470">(Oct 01 2020 at 17:45)</a>:</h4>
<p>abrown submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/2251#pullrequestreview-500580894">PR Review</a>.</p>



<a name="211947471"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232251%20refactor%3A%20retrieve%20immediates%20in%20new%20.../near/211947471" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232251.20refactor.3A.20retrieve.20immediates.20in.20new.20.2E.2E.2E.html#211947471">(Oct 01 2020 at 17:45)</a>:</h4>
<p>abrown created <a href="https://github.com/bytecodealliance/wasmtime/pull/2251#discussion_r498415423">PR Review Comment</a>:</p>
<blockquote>
<p>Here and on line 295 I had to switch unsigned to signed--there are other ways to do this (bump up the bit width, e.g.) but I'm not really sure it matters (users of this probably know what to do?)</p>
</blockquote>



<a name="211955766"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232251%20refactor%3A%20retrieve%20immediates%20in%20new%20.../near/211955766" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232251.20refactor.3A.20retrieve.20immediates.20in.20new.20.2E.2E.2E.html#211955766">(Oct 01 2020 at 18:44)</a>:</h4>
<p>cfallin submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/2251#pullrequestreview-500620901">PR Review</a>.</p>



<a name="211955767"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232251%20refactor%3A%20retrieve%20immediates%20in%20new%20.../near/211955767" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232251.20refactor.3A.20retrieve.20immediates.20in.20new.20.2E.2E.2E.html#211955767">(Oct 01 2020 at 18:44)</a>:</h4>
<p>cfallin submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/2251#pullrequestreview-500620901">PR Review</a>.</p>



<a name="211955768"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232251%20refactor%3A%20retrieve%20immediates%20in%20new%20.../near/211955768" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232251.20refactor.3A.20retrieve.20immediates.20in.20new.20.2E.2E.2E.html#211955768">(Oct 01 2020 at 18:44)</a>:</h4>
<p>cfallin created <a href="https://github.com/bytecodealliance/wasmtime/pull/2251#discussion_r498445613">PR Review Comment</a>:</p>
<blockquote>
<p>I'm not sure about <code>unimplemented!()</code> here -- usually that implies it would be possible but we just haven't done it -- perhaps <code>None</code> here, since we wrap <code>imm_value()</code> at a higher level? Or better, would it make sense to require a borrow of <code>dfg.immediates</code> as an argument to this function? Then we wouldn't need the two-level split logic between this match and <code>LowerCtx</code>'s...</p>
</blockquote>



<a name="211955769"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232251%20refactor%3A%20retrieve%20immediates%20in%20new%20.../near/211955769" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232251.20refactor.3A.20retrieve.20immediates.20in.20new.20.2E.2E.2E.html#211955769">(Oct 01 2020 at 18:44)</a>:</h4>
<p>cfallin created <a href="https://github.com/bytecodealliance/wasmtime/pull/2251#discussion_r498444554">PR Review Comment</a>:</p>
<blockquote>
<p>For clarity, maybe <code>let imm: u32 = imm.into();</code> then we can write <code>DataValue::from(imm as i32)</code>?</p>
</blockquote>



<a name="211971025"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232251%20refactor%3A%20retrieve%20immediates%20in%20new%20.../near/211971025" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232251.20refactor.3A.20retrieve.20immediates.20in.20new.20.2E.2E.2E.html#211971025">(Oct 01 2020 at 20:37)</a>:</h4>
<p>abrown updated <a href="https://github.com/bytecodealliance/wasmtime/pull/2251">PR #2251</a> from <code>access-immediates</code> to <code>main</code>:</p>
<blockquote>
<p>@cfallin, here is what I came up with after we discussed this last week. This change:</p>
<ul>
<li>moves <code>DataValue</code> into cranelift-codegen so that I can use it as a value wrapper</li>
<li>gives <code>InstructionData</code> the ability to find immediate values in the format structures</li>
<li>reworks <code>LowerCtx::get_immediate</code> to grab the value from the instruction (and the DataFlowGraph for vector immediates)</li>
</ul>
<p>I felt like this approach provides the new backend a more abstract view of immediates instead of munging directly in the <code>InstructionData</code> but I didn't perform the refactor on the rest of the places the new backend grabs immediates because I wanted to get some feedback first.</p>
</blockquote>



<a name="211971247"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232251%20refactor%3A%20retrieve%20immediates%20in%20new%20.../near/211971247" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232251.20refactor.3A.20retrieve.20immediates.20in.20new.20.2E.2E.2E.html#211971247">(Oct 01 2020 at 20:39)</a>:</h4>
<p>abrown updated <a href="https://github.com/bytecodealliance/wasmtime/pull/2251">PR #2251</a> from <code>access-immediates</code> to <code>main</code>:</p>
<blockquote>
<p>@cfallin, here is what I came up with after we discussed this last week. This change:</p>
<ul>
<li>moves <code>DataValue</code> into cranelift-codegen so that I can use it as a value wrapper</li>
<li>gives <code>InstructionData</code> the ability to find immediate values in the format structures</li>
<li>reworks <code>LowerCtx::get_immediate</code> to grab the value from the instruction (and the DataFlowGraph for vector immediates)</li>
</ul>
<p>I felt like this approach provides the new backend a more abstract view of immediates instead of munging directly in the <code>InstructionData</code> but I didn't perform the refactor on the rest of the places the new backend grabs immediates because I wanted to get some feedback first.</p>
</blockquote>



<a name="211971503"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232251%20refactor%3A%20retrieve%20immediates%20in%20new%20.../near/211971503" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232251.20refactor.3A.20retrieve.20immediates.20in.20new.20.2E.2E.2E.html#211971503">(Oct 01 2020 at 20:41)</a>:</h4>
<p>abrown submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/2251#pullrequestreview-500702187">PR Review</a>.</p>



<a name="211971504"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232251%20refactor%3A%20retrieve%20immediates%20in%20new%20.../near/211971504" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232251.20refactor.3A.20retrieve.20immediates.20in.20new.20.2E.2E.2E.html#211971504">(Oct 01 2020 at 20:41)</a>:</h4>
<p>abrown created <a href="https://github.com/bytecodealliance/wasmtime/pull/2251#discussion_r498501494">PR Review Comment</a>:</p>
<blockquote>
<p>Yeah, I was dubious about which way to go here. I felt like it was nice that this function didn't depend on the <code>DataFlowGraph</code> so I went with <code>None</code>.</p>
</blockquote>



<a name="211971544"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232251%20refactor%3A%20retrieve%20immediates%20in%20new%20.../near/211971544" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232251.20refactor.3A.20retrieve.20immediates.20in.20new.20.2E.2E.2E.html#211971544">(Oct 01 2020 at 20:41)</a>:</h4>
<p>abrown submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/2251#pullrequestreview-500702343">PR Review</a>.</p>



<a name="211971545"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232251%20refactor%3A%20retrieve%20immediates%20in%20new%20.../near/211971545" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232251.20refactor.3A.20retrieve.20immediates.20in.20new.20.2E.2E.2E.html#211971545">(Oct 01 2020 at 20:41)</a>:</h4>
<p>abrown created <a href="https://github.com/bytecodealliance/wasmtime/pull/2251#discussion_r498501602">PR Review Comment</a>:</p>
<blockquote>
<p>...And documented it some more.</p>
</blockquote>



<a name="211971723"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232251%20refactor%3A%20retrieve%20immediates%20in%20new%20.../near/211971723" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232251.20refactor.3A.20retrieve.20immediates.20in.20new.20.2E.2E.2E.html#211971723">(Oct 01 2020 at 20:42)</a>:</h4>
<p>abrown updated <a href="https://github.com/bytecodealliance/wasmtime/pull/2251">PR #2251</a> from <code>access-immediates</code> to <code>main</code>:</p>
<blockquote>
<p>@cfallin, here is what I came up with after we discussed this last week. This change:</p>
<ul>
<li>moves <code>DataValue</code> into cranelift-codegen so that I can use it as a value wrapper</li>
<li>gives <code>InstructionData</code> the ability to find immediate values in the format structures</li>
<li>reworks <code>LowerCtx::get_immediate</code> to grab the value from the instruction (and the DataFlowGraph for vector immediates)</li>
</ul>
<p>I felt like this approach provides the new backend a more abstract view of immediates instead of munging directly in the <code>InstructionData</code> but I didn't perform the refactor on the rest of the places the new backend grabs immediates because I wanted to get some feedback first.</p>
</blockquote>



<a name="211974437"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232251%20refactor%3A%20retrieve%20immediates%20in%20new%20.../near/211974437" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232251.20refactor.3A.20retrieve.20immediates.20in.20new.20.2E.2E.2E.html#211974437">(Oct 01 2020 at 21:01)</a>:</h4>
<p>bjorn3 submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/2251#pullrequestreview-500712022">PR Review</a>.</p>



<a name="211974438"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232251%20refactor%3A%20retrieve%20immediates%20in%20new%20.../near/211974438" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232251.20refactor.3A.20retrieve.20immediates.20in.20new.20.2E.2E.2E.html#211974438">(Oct 01 2020 at 21:01)</a>:</h4>
<p>bjorn3 submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/2251#pullrequestreview-500712022">PR Review</a>.</p>



<a name="211974439"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232251%20refactor%3A%20retrieve%20immediates%20in%20new%20.../near/211974439" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232251.20refactor.3A.20retrieve.20immediates.20in.20new.20.2E.2E.2E.html#211974439">(Oct 01 2020 at 21:01)</a>:</h4>
<p>bjorn3 created <a href="https://github.com/bytecodealliance/wasmtime/pull/2251#discussion_r498508646">PR Review Comment</a>:</p>
<blockquote>
<p>Please use <code>Ieee32</code>/<code>Ieee64</code> instead of f32/f64. Otherwise NaN bits could get changed.</p>
</blockquote>



<a name="211977394"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232251%20refactor%3A%20retrieve%20immediates%20in%20new%20.../near/211977394" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232251.20refactor.3A.20retrieve.20immediates.20in.20new.20.2E.2E.2E.html#211977394">(Oct 01 2020 at 21:24)</a>:</h4>
<p>abrown submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/2251#pullrequestreview-500728880">PR Review</a>.</p>



<a name="211977396"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232251%20refactor%3A%20retrieve%20immediates%20in%20new%20.../near/211977396" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232251.20refactor.3A.20retrieve.20immediates.20in.20new.20.2E.2E.2E.html#211977396">(Oct 01 2020 at 21:24)</a>:</h4>
<p>abrown created <a href="https://github.com/bytecodealliance/wasmtime/pull/2251#discussion_r498520566">PR Review Comment</a>:</p>
<blockquote>
<p>What do you think of <a href="https://doc.rust-lang.org/std/primitive.f32.html#method.from_bits">https://doc.rust-lang.org/std/primitive.f32.html#method.from_bits</a>? Looks to me like <code>f32::from_bits</code> (which is how we get from <code>Ieee32</code> for this value) is not going to change NaN bits at all.</p>
</blockquote>



<a name="212007077"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232251%20refactor%3A%20retrieve%20immediates%20in%20new%20.../near/212007077" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232251.20refactor.3A.20retrieve.20immediates.20in.20new.20.2E.2E.2E.html#212007077">(Oct 02 2020 at 05:45)</a>:</h4>
<p>bjorn3 submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/2251#pullrequestreview-500871022">PR Review</a>.</p>



<a name="212007078"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232251%20refactor%3A%20retrieve%20immediates%20in%20new%20.../near/212007078" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232251.20refactor.3A.20retrieve.20immediates.20in.20new.20.2E.2E.2E.html#212007078">(Oct 02 2020 at 05:45)</a>:</h4>
<p>bjorn3 created <a href="https://github.com/bytecodealliance/wasmtime/pull/2251#discussion_r498626439">PR Review Comment</a>:</p>
<blockquote>
<p>The <code>to_bits</code> method can change it. x86 processors normalize it when moving out of an SSE register I think.</p>
</blockquote>



<a name="212096979"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232251%20refactor%3A%20retrieve%20immediates%20in%20new%20.../near/212096979" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232251.20refactor.3A.20retrieve.20immediates.20in.20new.20.2E.2E.2E.html#212096979">(Oct 02 2020 at 16:23)</a>:</h4>
<p>abrown submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/2251#pullrequestreview-501275858">PR Review</a>.</p>



<a name="212096980"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232251%20refactor%3A%20retrieve%20immediates%20in%20new%20.../near/212096980" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232251.20refactor.3A.20retrieve.20immediates.20in.20new.20.2E.2E.2E.html#212096980">(Oct 02 2020 at 16:23)</a>:</h4>
<p>abrown created <a href="https://github.com/bytecodealliance/wasmtime/pull/2251#discussion_r498922480">PR Review Comment</a>:</p>
<blockquote>
<p>I don't know... Rust devs think the issue is "overblown": <a href="https://doc.rust-lang.org/src/core/num/f32.rs.html#700-702">https://doc.rust-lang.org/src/core/num/f32.rs.html#700-702</a>.</p>
</blockquote>



<a name="212099256"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232251%20refactor%3A%20retrieve%20immediates%20in%20new%20.../near/212099256" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232251.20refactor.3A.20retrieve.20immediates.20in.20new.20.2E.2E.2E.html#212099256">(Oct 02 2020 at 16:42)</a>:</h4>
<p>bjorn3 submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/2251#pullrequestreview-501288978">PR Review</a>.</p>



<a name="212099257"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232251%20refactor%3A%20retrieve%20immediates%20in%20new%20.../near/212099257" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232251.20refactor.3A.20retrieve.20immediates.20in.20new.20.2E.2E.2E.html#212099257">(Oct 02 2020 at 16:42)</a>:</h4>
<p>bjorn3 created <a href="https://github.com/bytecodealliance/wasmtime/pull/2251#discussion_r498932325">PR Review Comment</a>:</p>
<blockquote>
<p>That is a different issue. What I am talking about here is that for example when the user intended an sNaN it would quietly get turned into a regular NaN.</p>
</blockquote>



<a name="212099510"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232251%20refactor%3A%20retrieve%20immediates%20in%20new%20.../near/212099510" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232251.20refactor.3A.20retrieve.20immediates.20in.20new.20.2E.2E.2E.html#212099510">(Oct 02 2020 at 16:45)</a>:</h4>
<p>abrown submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/2251#pullrequestreview-501290586">PR Review</a>.</p>



<a name="212099511"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232251%20refactor%3A%20retrieve%20immediates%20in%20new%20.../near/212099511" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232251.20refactor.3A.20retrieve.20immediates.20in.20new.20.2E.2E.2E.html#212099511">(Oct 02 2020 at 16:45)</a>:</h4>
<p>abrown created <a href="https://github.com/bytecodealliance/wasmtime/pull/2251#discussion_r498933515">PR Review Comment</a>:</p>
<blockquote>
<p>Zulip?</p>
</blockquote>



<a name="212100069"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232251%20refactor%3A%20retrieve%20immediates%20in%20new%20.../near/212100069" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232251.20refactor.3A.20retrieve.20immediates.20in.20new.20.2E.2E.2E.html#212100069">(Oct 02 2020 at 16:50)</a>:</h4>
<p>cfallin submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/2251#pullrequestreview-501293958">PR Review</a>.</p>



<a name="212100070"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232251%20refactor%3A%20retrieve%20immediates%20in%20new%20.../near/212100070" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232251.20refactor.3A.20retrieve.20immediates.20in.20new.20.2E.2E.2E.html#212100070">(Oct 02 2020 at 16:50)</a>:</h4>
<p>cfallin created <a href="https://github.com/bytecodealliance/wasmtime/pull/2251#discussion_r498935962">PR Review Comment</a>:</p>
<blockquote>
<p>To add my 2¢ here: I don't think there's much cost to using <code>Ieee32</code>/<code>Ieee64</code> (just some bitcasts), it has accessors to give us float values when we need them, it guarantees bit-for-bit accuracy otherwise as we manipulate code, and we already use it elsewhere for constants. I'd prefer the whole lowering path, from CLIF to the final point that we emit constants into the <code>MachBuffer</code>, to avoid potential machine-specific issues with <code>f32</code>/<code>f64</code>. Possiblyl @sunfishcode has thoughts (I know you've talked about NaNs and determinism before)?</p>
</blockquote>



<a name="212100105"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232251%20refactor%3A%20retrieve%20immediates%20in%20new%20.../near/212100105" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232251.20refactor.3A.20retrieve.20immediates.20in.20new.20.2E.2E.2E.html#212100105">(Oct 02 2020 at 16:50)</a>:</h4>
<p>cfallin edited <a href="https://github.com/bytecodealliance/wasmtime/pull/2251#discussion_r498935962">PR Review Comment</a>.</p>



<a name="212102872"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232251%20refactor%3A%20retrieve%20immediates%20in%20new%20.../near/212102872" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232251.20refactor.3A.20retrieve.20immediates.20in.20new.20.2E.2E.2E.html#212102872">(Oct 02 2020 at 17:14)</a>:</h4>
<p>abrown submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/2251#pullrequestreview-501310090">PR Review</a>.</p>



<a name="212102873"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232251%20refactor%3A%20retrieve%20immediates%20in%20new%20.../near/212102873" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232251.20refactor.3A.20retrieve.20immediates.20in.20new.20.2E.2E.2E.html#212102873">(Oct 02 2020 at 17:14)</a>:</h4>
<p>abrown created <a href="https://github.com/bytecodealliance/wasmtime/pull/2251#discussion_r498947778">PR Review Comment</a>:</p>
<blockquote>
<p>I'm not opposed to using <code>Ieee32/Ieee64</code> here but I do want to sort out whether there are real issues that they avoid or not; if not, then I think Rust's <code>f32/f64</code> are a bit simpler and perhaps we should be using those other places, e.g., for CLIF parsing.</p>
</blockquote>



<a name="212112258"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232251%20refactor%3A%20retrieve%20immediates%20in%20new%20.../near/212112258" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232251.20refactor.3A.20retrieve.20immediates.20in.20new.20.2E.2E.2E.html#212112258">(Oct 02 2020 at 18:40)</a>:</h4>
<p>abrown submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/2251#pullrequestreview-501365723">PR Review</a>.</p>



<a name="212112259"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232251%20refactor%3A%20retrieve%20immediates%20in%20new%20.../near/212112259" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232251.20refactor.3A.20retrieve.20immediates.20in.20new.20.2E.2E.2E.html#212112259">(Oct 02 2020 at 18:40)</a>:</h4>
<p>abrown created <a href="https://github.com/bytecodealliance/wasmtime/pull/2251#discussion_r498990145">PR Review Comment</a>:</p>
<blockquote>
<p>Here is a summary of what @bjorn3 and I discussed on Zulip: because ARM machines might have <a href="https://developer.arm.com/documentation/ddi0344/i/neon-and-vfp-programmers-model/modes-of-operation/default-nan-mode?lang=en">default NaN mode</a> set during compilation but not during runtime, the <code>f32</code>, if operated on (@bjorn3 thinks even possibly by moving to a register), could lose its signalling bit. This makes me lean toward switching to use <code>Ieee32</code> but I would still like to hear @sunfishcode's opinion.</p>
<p>I'm still a bit mystified on why Rust core thinks this will not be an issue in their case: <a href="https://github.com/rust-lang/rust/commit/a2cdeb58f680b87b5bdb6a17cba857ac51307c8f#diff-14f327fd5e3b91eb2e9af0690596d156R284">https://github.com/rust-lang/rust/commit/a2cdeb58f680b87b5bdb6a17cba857ac51307c8f#diff-14f327fd5e3b91eb2e9af0690596d156R284</a>.</p>
</blockquote>



<a name="212112921"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232251%20refactor%3A%20retrieve%20immediates%20in%20new%20.../near/212112921" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232251.20refactor.3A.20retrieve.20immediates.20in.20new.20.2E.2E.2E.html#212112921">(Oct 02 2020 at 18:46)</a>:</h4>
<p>bjorn3 submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/2251#pullrequestreview-501369230">PR Review</a>.</p>



<a name="212112922"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232251%20refactor%3A%20retrieve%20immediates%20in%20new%20.../near/212112922" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232251.20refactor.3A.20retrieve.20immediates.20in.20new.20.2E.2E.2E.html#212112922">(Oct 02 2020 at 18:46)</a>:</h4>
<p>bjorn3 created <a href="https://github.com/bytecodealliance/wasmtime/pull/2251#discussion_r498992781">PR Review Comment</a>:</p>
<blockquote>
<p>I think what was thought to be a safety issue is sNaN causing a floating point trap as opposed to return sNaN or qNaN bits or even LLVM returning poison.</p>
</blockquote>



<a name="212237679"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232251%20refactor%3A%20retrieve%20immediates%20in%20new%20.../near/212237679" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232251.20refactor.3A.20retrieve.20immediates.20in.20new.20.2E.2E.2E.html#212237679">(Oct 04 2020 at 19:27)</a>:</h4>
<p>sunfishcode submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/2251#pullrequestreview-501652042">PR Review</a>.</p>



<a name="212237680"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232251%20refactor%3A%20retrieve%20immediates%20in%20new%20.../near/212237680" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232251.20refactor.3A.20retrieve.20immediates.20in.20new.20.2E.2E.2E.html#212237680">(Oct 04 2020 at 19:27)</a>:</h4>
<p>sunfishcode created <a href="https://github.com/bytecodealliance/wasmtime/pull/2251#discussion_r499280155">PR Review Comment</a>:</p>
<blockquote>
<p>I favor <code>Ieee32</code>/<code>Ieee64</code> here too.</p>
<p>It's my understanding that Rust as a language is still figuring out its strategy for NaN bits: <a href="https://github.com/rust-lang/unsafe-code-guidelines/issues/237">https://github.com/rust-lang/unsafe-code-guidelines/issues/237</a> (to be sure, it's a hard problem). Until that's resolved, I'd prefer not to skate near the edge :-).</p>
</blockquote>



<a name="212588352"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232251%20refactor%3A%20retrieve%20immediates%20in%20new%20.../near/212588352" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232251.20refactor.3A.20retrieve.20immediates.20in.20new.20.2E.2E.2E.html#212588352">(Oct 07 2020 at 17:00)</a>:</h4>
<p>abrown updated <a href="https://github.com/bytecodealliance/wasmtime/pull/2251">PR #2251</a> from <code>access-immediates</code> to <code>main</code>:</p>
<blockquote>
<p>@cfallin, here is what I came up with after we discussed this last week. This change:</p>
<ul>
<li>moves <code>DataValue</code> into cranelift-codegen so that I can use it as a value wrapper</li>
<li>gives <code>InstructionData</code> the ability to find immediate values in the format structures</li>
<li>reworks <code>LowerCtx::get_immediate</code> to grab the value from the instruction (and the DataFlowGraph for vector immediates)</li>
</ul>
<p>I felt like this approach provides the new backend a more abstract view of immediates instead of munging directly in the <code>InstructionData</code> but I didn't perform the refactor on the rest of the places the new backend grabs immediates because I wanted to get some feedback first.</p>
</blockquote>



<a name="212589570"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232251%20refactor%3A%20retrieve%20immediates%20in%20new%20.../near/212589570" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232251.20refactor.3A.20retrieve.20immediates.20in.20new.20.2E.2E.2E.html#212589570">(Oct 07 2020 at 17:09)</a>:</h4>
<p>abrown created <a href="https://github.com/bytecodealliance/wasmtime/pull/2251#discussion_r501175422">PR Review Comment</a>:</p>
<blockquote>
<p>This is the only change (and similarly on lines 237-238) that might be a bit risky in this commit: these functions are used to store and load values for the trampoline into a compiled function and I could <code>repr(C)</code> both <code>Ieee32</code> and <code>Ieee64</code> if there are doubts about the <a href="https://doc.rust-lang.org/reference/type-layout.html#primitive-data-layout">data layout</a>.</p>
</blockquote>



<a name="212589571"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232251%20refactor%3A%20retrieve%20immediates%20in%20new%20.../near/212589571" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232251.20refactor.3A.20retrieve.20immediates.20in.20new.20.2E.2E.2E.html#212589571">(Oct 07 2020 at 17:09)</a>:</h4>
<p>abrown submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/2251#pullrequestreview-504094717">PR Review</a>.</p>



<a name="212592794"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232251%20refactor%3A%20retrieve%20immediates%20in%20new%20.../near/212592794" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232251.20refactor.3A.20retrieve.20immediates.20in.20new.20.2E.2E.2E.html#212592794">(Oct 07 2020 at 17:33)</a>:</h4>
<p>abrown updated <a href="https://github.com/bytecodealliance/wasmtime/pull/2251">PR #2251</a> from <code>access-immediates</code> to <code>main</code>:</p>
<blockquote>
<p>@cfallin, here is what I came up with after we discussed this last week. This change:</p>
<ul>
<li>moves <code>DataValue</code> into cranelift-codegen so that I can use it as a value wrapper</li>
<li>gives <code>InstructionData</code> the ability to find immediate values in the format structures</li>
<li>reworks <code>LowerCtx::get_immediate</code> to grab the value from the instruction (and the DataFlowGraph for vector immediates)</li>
</ul>
<p>I felt like this approach provides the new backend a more abstract view of immediates instead of munging directly in the <code>InstructionData</code> but I didn't perform the refactor on the rest of the places the new backend grabs immediates because I wanted to get some feedback first.</p>
</blockquote>



<a name="212592962"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232251%20refactor%3A%20retrieve%20immediates%20in%20new%20.../near/212592962" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232251.20refactor.3A.20retrieve.20immediates.20in.20new.20.2E.2E.2E.html#212592962">(Oct 07 2020 at 17:34)</a>:</h4>
<p>abrown submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/2251#pullrequestreview-504114584">PR Review</a>.</p>



<a name="212592963"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232251%20refactor%3A%20retrieve%20immediates%20in%20new%20.../near/212592963" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232251.20refactor.3A.20retrieve.20immediates.20in.20new.20.2E.2E.2E.html#212592963">(Oct 07 2020 at 17:34)</a>:</h4>
<p>abrown created <a href="https://github.com/bytecodealliance/wasmtime/pull/2251#discussion_r501190894">PR Review Comment</a>:</p>
<blockquote>
<p>I added a <code>repr(C)</code> to <code>Ieee32</code> and <code>Ieee64</code> in the latest version of this commit; if they truly aren't necessary we can remove them later.</p>
</blockquote>



<a name="212606256"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%232251%20refactor%3A%20retrieve%20immediates%20in%20new%20.../near/212606256" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.232251.20refactor.3A.20retrieve.20immediates.20in.20new.20.2E.2E.2E.html#212606256">(Oct 07 2020 at 19:17)</a>:</h4>
<p>abrown merged <a href="https://github.com/bytecodealliance/wasmtime/pull/2251">PR #2251</a>.</p>



<hr><p>Last updated: Jan 20 2025 at 06:04 UTC</p>
</html>