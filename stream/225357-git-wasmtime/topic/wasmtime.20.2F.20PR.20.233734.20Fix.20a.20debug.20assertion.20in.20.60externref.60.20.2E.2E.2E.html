<html>
<head><meta charset="utf-8"><title>wasmtime / PR #3734 Fix a debug assertion in `externref` ... · git-wasmtime · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/index.html">git-wasmtime</a></h2>
<h3>Topic: <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.233734.20Fix.20a.20debug.20assertion.20in.20.60externref.60.20.2E.2E.2E.html">wasmtime / PR #3734 Fix a debug assertion in `externref` ...</a></h3>

<hr>

<base href="https://bytecodealliance.zulipchat.com">

<head><link href="https://bytecodealliance.github.io/zulip-archive/style.css" rel="stylesheet"></head>

<a name="269648050"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%233734%20Fix%20a%20debug%20assertion%20in%20%60externref%60%20.../near/269648050" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.233734.20Fix.20a.20debug.20assertion.20in.20.60externref.60.20.2E.2E.2E.html#269648050">(Jan 27 2022 at 22:14)</a>:</h4>
<p><strong>fitzgen</strong> requested <a href="https://github.com/alexcrichton">alexcrichton</a> for a review on <a href="https://github.com/bytecodealliance/wasmtime/pull/3734">PR #3734</a>.</p>



<a name="269648051"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%233734%20Fix%20a%20debug%20assertion%20in%20%60externref%60%20.../near/269648051" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.233734.20Fix.20a.20debug.20assertion.20in.20.60externref.60.20.2E.2E.2E.html#269648051">(Jan 27 2022 at 22:14)</a>:</h4>
<p>fitzgen opened <a href="https://github.com/bytecodealliance/wasmtime/pull/3734">PR #3734</a> from <code>externref-debug-assertion-fix</code> to <code>main</code>:</p>
<blockquote>
<p>See commit messages for details.</p>
</blockquote>



<a name="269649108"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%233734%20Fix%20a%20debug%20assertion%20in%20%60externref%60%20.../near/269649108" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.233734.20Fix.20a.20debug.20assertion.20in.20.60externref.60.20.2E.2E.2E.html#269649108">(Jan 27 2022 at 22:22)</a>:</h4>
<p>alexcrichton submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/3734#pullrequestreview-865501159">PR review</a>.</p>



<a name="269649109"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%233734%20Fix%20a%20debug%20assertion%20in%20%60externref%60%20.../near/269649109" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.233734.20Fix.20a.20debug.20assertion.20in.20.60externref.60.20.2E.2E.2E.html#269649109">(Jan 27 2022 at 22:22)</a>:</h4>
<p>alexcrichton submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/3734#pullrequestreview-865501159">PR review</a>.</p>



<a name="269649110"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%233734%20Fix%20a%20debug%20assertion%20in%20%60externref%60%20.../near/269649110" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.233734.20Fix.20a.20debug.20assertion.20in.20.60externref.60.20.2E.2E.2E.html#269649110">(Jan 27 2022 at 22:22)</a>:</h4>
<p>alexcrichton created <a href="https://github.com/bytecodealliance/wasmtime/pull/3734#discussion_r794051012">PR review comment</a>:</p>
<blockquote>
<p>I don't think I understand why this is necessary, but was this required from fuzzing?</p>
<p>Unlike the <code>wasmtime_activations_table_insert_with_gc</code> function above the <code>externref</code> here is not on the stack in wasm, it's only on the stack here in Rust, and it's already rooted with the <code>Some(externref)</code> which should be an owned value.</p>
<p>I think that means that there's no need to manually insert it into the table because a stack walk otherwise won't find this (unless it would otherwise find it for some other reason)</p>
</blockquote>



<a name="269649111"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%233734%20Fix%20a%20debug%20assertion%20in%20%60externref%60%20.../near/269649111" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.233734.20Fix.20a.20debug.20assertion.20in.20.60externref.60.20.2E.2E.2E.html#269649111">(Jan 27 2022 at 22:22)</a>:</h4>
<p>alexcrichton created <a href="https://github.com/bytecodealliance/wasmtime/pull/3734#discussion_r794050324">PR review comment</a>:</p>
<blockquote>
<p>This can end up doing a double-insertion between this and <code>insert_with_gc</code> below, and it might be good to avoid that? This method is only called when the table is full so <code>insert_without_gc</code> is already guaranteed to go straight to insertion in the slow path, so should a specialized method of the table be added for basically this use case?</p>
</blockquote>



<a name="269650771"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%233734%20Fix%20a%20debug%20assertion%20in%20%60externref%60%20.../near/269650771" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.233734.20Fix.20a.20debug.20assertion.20in.20.60externref.60.20.2E.2E.2E.html#269650771">(Jan 27 2022 at 22:36)</a>:</h4>
<p>fitzgen submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/3734#pullrequestreview-865512845">PR review</a>.</p>



<a name="269650773"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%233734%20Fix%20a%20debug%20assertion%20in%20%60externref%60%20.../near/269650773" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.233734.20Fix.20a.20debug.20assertion.20in.20.60externref.60.20.2E.2E.2E.html#269650773">(Jan 27 2022 at 22:36)</a>:</h4>
<p>fitzgen created <a href="https://github.com/bytecodealliance/wasmtime/pull/3734#discussion_r794059004">PR review comment</a>:</p>
<blockquote>
<p>It won't insert into the bump chunk, so I don't think there is anything to worry about here. We just do one more hash lookup than is strictly necessary, but that is fine as this is a slow path anyways.</p>
</blockquote>



<a name="269651856"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%233734%20Fix%20a%20debug%20assertion%20in%20%60externref%60%20.../near/269651856" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.233734.20Fix.20a.20debug.20assertion.20in.20.60externref.60.20.2E.2E.2E.html#269651856">(Jan 27 2022 at 22:45)</a>:</h4>
<p>fitzgen created <a href="https://github.com/bytecodealliance/wasmtime/pull/3734#discussion_r794063956">PR review comment</a>:</p>
<blockquote>
<p>No, this isn't required, it was just me being overly cautious. I'll remove it and force push.</p>
</blockquote>



<a name="269651857"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%233734%20Fix%20a%20debug%20assertion%20in%20%60externref%60%20.../near/269651857" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.233734.20Fix.20a.20debug.20assertion.20in.20.60externref.60.20.2E.2E.2E.html#269651857">(Jan 27 2022 at 22:45)</a>:</h4>
<p>fitzgen submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/3734#pullrequestreview-865519348">PR review</a>.</p>



<a name="269651929"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%233734%20Fix%20a%20debug%20assertion%20in%20%60externref%60%20.../near/269651929" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.233734.20Fix.20a.20debug.20assertion.20in.20.60externref.60.20.2E.2E.2E.html#269651929">(Jan 27 2022 at 22:46)</a>:</h4>
<p>fitzgen updated <a href="https://github.com/bytecodealliance/wasmtime/pull/3734">PR #3734</a> from <code>externref-debug-assertion-fix</code> to <code>main</code>.</p>



<a name="269665780"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%233734%20Fix%20a%20debug%20assertion%20in%20%60externref%60%20.../near/269665780" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.233734.20Fix.20a.20debug.20assertion.20in.20.60externref.60.20.2E.2E.2E.html#269665780">(Jan 28 2022 at 00:53)</a>:</h4>
<p>fitzgen updated <a href="https://github.com/bytecodealliance/wasmtime/pull/3734">PR #3734</a> from <code>externref-debug-assertion-fix</code> to <code>main</code>.</p>



<a name="269742745"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%233734%20Fix%20a%20debug%20assertion%20in%20%60externref%60%20.../near/269742745" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.233734.20Fix.20a.20debug.20assertion.20in.20.60externref.60.20.2E.2E.2E.html#269742745">(Jan 28 2022 at 14:21)</a>:</h4>
<p>alexcrichton submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/3734#pullrequestreview-866212218">PR review</a>.</p>



<a name="269742746"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%233734%20Fix%20a%20debug%20assertion%20in%20%60externref%60%20.../near/269742746" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.233734.20Fix.20a.20debug.20assertion.20in.20.60externref.60.20.2E.2E.2E.html#269742746">(Jan 28 2022 at 14:21)</a>:</h4>
<p>alexcrichton submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/3734#pullrequestreview-866212218">PR review</a>.</p>



<a name="269742747"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%233734%20Fix%20a%20debug%20assertion%20in%20%60externref%60%20.../near/269742747" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.233734.20Fix.20a.20debug.20assertion.20in.20.60externref.60.20.2E.2E.2E.html#269742747">(Jan 28 2022 at 14:21)</a>:</h4>
<p>alexcrichton created <a href="https://github.com/bytecodealliance/wasmtime/pull/3734#discussion_r794545482">PR review comment</a>:</p>
<blockquote>
<p>That's true, yeah. Could you update the comment here to indicate that this is doing some extra work but it's the slow path so it should be ok?</p>
</blockquote>



<a name="269774136"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%233734%20Fix%20a%20debug%20assertion%20in%20%60externref%60%20.../near/269774136" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.233734.20Fix.20a.20debug.20assertion.20in.20.60externref.60.20.2E.2E.2E.html#269774136">(Jan 28 2022 at 17:47)</a>:</h4>
<p>fitzgen updated <a href="https://github.com/bytecodealliance/wasmtime/pull/3734">PR #3734</a> from <code>externref-debug-assertion-fix</code> to <code>main</code>.</p>



<a name="269785813"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%233734%20Fix%20a%20debug%20assertion%20in%20%60externref%60%20.../near/269785813" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.233734.20Fix.20a.20debug.20assertion.20in.20.60externref.60.20.2E.2E.2E.html#269785813">(Jan 28 2022 at 19:03)</a>:</h4>
<p>fitzgen merged <a href="https://github.com/bytecodealliance/wasmtime/pull/3734">PR #3734</a>.</p>



<hr><p>Last updated: Jan 20 2025 at 06:04 UTC</p>
</html>