<html>
<head><meta charset="utf-8"><title>wasmtime / Issue #2735 Support PLT entries in `cranelift-... · git-wasmtime · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/index.html">git-wasmtime</a></h2>
<h3>Topic: <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20Issue.20.232735.20Support.20PLT.20entries.20in.20.60cranelift-.2E.2E.2E.html">wasmtime / Issue #2735 Support PLT entries in `cranelift-...</a></h3>

<hr>

<base href="https://bytecodealliance.zulipchat.com">

<head><link href="https://bytecodealliance.github.io/zulip-archive/style.css" rel="stylesheet"></head>

<a name="230773049"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20Issue%20%232735%20Support%20PLT%20entries%20in%20%60cranelift-.../near/230773049" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20Issue.20.232735.20Support.20PLT.20entries.20in.20.60cranelift-.2E.2E.2E.html#230773049">(Mar 17 2021 at 21:51)</a>:</h4>
<p>cfallin edited <a href="https://github.com/bytecodealliance/wasmtime/issues/2735">Issue #2735</a>:</p>
<blockquote>
<h4>Feature</h4>
<p>JIT for arm64</p>
<h4>Benefit</h4>
<p>x86 works and it would be nice to be able to use it on M1 mac as well</p>
<h4>Implementation</h4>
<p>it currently panics here: <a href="https://github.com/bytecodealliance/wasmtime/blob/5fecdfa49150e3304c1b949aab73bd4a0a02dbac/cranelift/jit/src/backend.rs#L183-L195">https://github.com/bytecodealliance/wasmtime/blob/5fecdfa49150e3304c1b949aab73bd4a0a02dbac/cranelift/jit/src/backend.rs#L183-L195</a> I'm unsure what needs to change/ whats blocking it</p>
<h4>Alternatives</h4>
<p>only make JIT available on x86<br>
</p>
</blockquote>



<a name="230773203"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20Issue%20%232735%20Support%20PLT%20entries%20in%20%60cranelift-.../near/230773203" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20Issue.20.232735.20Support.20PLT.20entries.20in.20.60cranelift-.2E.2E.2E.html#230773203">(Mar 17 2021 at 21:52)</a>:</h4>
<p>cfallin <a href="https://github.com/bytecodealliance/wasmtime/issues/2735#issuecomment-801467140">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/2735">Issue #2735</a>:</p>
<blockquote>
<p>@bnjbvr any thoughts on this? I'm not sure how PLTs ordinarily work on macOS/aarch64 but perhaps it's a simple addition?</p>
</blockquote>



<a name="230774730"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20Issue%20%232735%20Support%20PLT%20entries%20in%20%60cranelift-.../near/230774730" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20Issue.20.232735.20Support.20PLT.20entries.20in.20.60cranelift-.2E.2E.2E.html#230774730">(Mar 17 2021 at 22:01)</a>:</h4>
<p>bjorn3 <a href="https://github.com/bytecodealliance/wasmtime/issues/2735#issuecomment-801471323">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/2735">Issue #2735</a>:</p>
<blockquote>
<p>As workaround you could disable the <code>is_pic</code> flag when creating the <code>TargetIsa</code>.</p>
</blockquote>



<a name="230776930"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20Issue%20%232735%20Support%20PLT%20entries%20in%20%60cranelift-.../near/230776930" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20Issue.20.232735.20Support.20PLT.20entries.20in.20.60cranelift-.2E.2E.2E.html#230776930">(Mar 17 2021 at 22:11)</a>:</h4>
<p>bjorn3 <a href="https://github.com/bytecodealliance/wasmtime/issues/2735#issuecomment-801475570">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/2735">Issue #2735</a>:</p>
<blockquote>
<p>This is one of the plt entries of an executable I compiled on my phone:</p>
<p><div class="codehilite" data-code-language="GAS"><pre><span></span><code><span class="err">90</span> <span class="err">01</span> <span class="err">00</span> <span class="nf">B0</span>    <span class="no">adrp</span> <span class="no">x16</span><span class="p">,</span> <span class="mi">#0</span><span class="no">x31000</span>
<span class="err">11</span> <span class="nf">F2</span> <span class="mi">46</span> <span class="no">F9</span>    <span class="no">ldr</span>  <span class="no">x17</span><span class="p">,</span> <span class="p">[</span><span class="no">x16</span><span class="p">,</span> <span class="mi">#0</span><span class="no">xde0</span><span class="p">]</span>
<span class="err">10</span> <span class="err">82</span> <span class="err">37</span> <span class="err">91</span>    <span class="nf">add</span>  <span class="no">x16</span><span class="p">,</span> <span class="no">x16</span><span class="p">,</span> <span class="mi">#0</span><span class="no">xde0</span>
<span class="err">20</span> <span class="err">02</span> <span class="err">1</span><span class="nf">F</span> <span class="no">D6</span>    <span class="no">br</span>   <span class="no">x17</span>
</code></pre></div><br>
</p>
</blockquote>



<a name="230777353"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20Issue%20%232735%20Support%20PLT%20entries%20in%20%60cranelift-.../near/230777353" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20Issue.20.232735.20Support.20PLT.20entries.20in.20.60cranelift-.2E.2E.2E.html#230777353">(Mar 17 2021 at 22:13)</a>:</h4>
<p>benmkw <a href="https://github.com/bytecodealliance/wasmtime/issues/2735#issuecomment-801476541">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/2735">Issue #2735</a>:</p>
<blockquote>
<blockquote>
<p>As workaround you could disable the is_pic flag when creating the TargetIsa.</p>
</blockquote>
<p>Tried with <a href="https://github.com/bytecodealliance/cranelift-jit-demo">https://github.com/bytecodealliance/cranelift-jit-demo</a></p>
<div class="codehilite" data-code-language="Diff"><pre><span></span><code><span class="gh">diff --git a/Cargo.toml b/Cargo.toml</span>
<span class="gh">index 756983f..f6dd93f 100644</span>
<span class="gd">--- a/Cargo.toml</span>
<span class="gi">+++ b/Cargo.toml</span>
<span class="gu">@@ -8,7 +8,8 @@ description = "Toy language implemented using cranelift-jit"</span>
 edition = "2018"

 [dependencies]
<span class="gd">-cranelift = "0.69.0"</span>
<span class="gd">-cranelift-module = "0.69.0"</span>
<span class="gd">-cranelift-jit = "0.69.0"</span>
<span class="gi">+cranelift = "0.72.0"</span>
<span class="gi">+cranelift-module = "0.72.0"</span>
<span class="gi">+cranelift-jit = "0.72.0"</span>
<span class="gi">+cranelift-native = "0.72.0"</span>
 peg = "0.6"
<span class="gh">diff --git a/src/jit.rs b/src/jit.rs</span>
<span class="gh">index 160ac36..ffcff04 100644</span>
<span class="gd">--- a/src/jit.rs</span>
<span class="gi">+++ b/src/jit.rs</span>
<span class="gu">@@ -26,7 +26,17 @@ pub struct JIT {</span>

 impl Default for JIT {
     fn default() -&gt; Self {
<span class="gd">-        let builder = JITBuilder::new(cranelift_module::default_libcall_names());</span>
<span class="gi">+        let mut flag_builder = settings::builder();</span>
<span class="gi">+        // On at least AArch64, "colocated" calls use shorter-range relocations,</span>
<span class="gi">+        // which might not reach all definitions; we can't handle that here, so</span>
<span class="gi">+        // we require long-range relocation types.</span>
<span class="gi">+        flag_builder.set("use_colocated_libcalls", "false").unwrap();</span>
<span class="gi">+        flag_builder.set("is_pic", "false").unwrap();</span>
<span class="gi">+        let isa_builder = cranelift_native::builder().unwrap_or_else(|msg| {</span>
<span class="gi">+            panic!("host machine is not supported: {}", msg);</span>
<span class="gi">+        });</span>
<span class="gi">+        let isa = isa_builder.finish(settings::Flags::new(flag_builder));</span>
<span class="gi">+        let builder = JITBuilder::with_isa(isa, cranelift_module::default_libcall_names());</span>
         let module = JITModule::new(builder);
         Self {
             builder_context: FunctionBuilderContext::new(),
</code></pre></div>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="err">λ</span><span class="w">  </span><span class="p">(</span><span class="n">main</span><span class="o">|</span><span class="err">✚</span><span class="w"> </span><span class="mi">2</span><span class="p">)</span><span class="w"> </span><span class="n">cargo</span><span class="w"> </span><span class="n">run</span><span class="w"></span>
<span class="w">    </span><span class="n">Finished</span><span class="w"> </span><span class="n">dev</span><span class="w"> </span><span class="p">[</span><span class="n">unoptimized</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">debuginfo</span><span class="p">]</span><span class="w"> </span><span class="n">target</span><span class="p">(</span><span class="n">s</span><span class="p">)</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="mf">0.01</span><span class="n">s</span><span class="w"></span>
<span class="w">     </span><span class="n">Running</span><span class="w"> </span><span class="err">`</span><span class="n">target</span><span class="o">/</span><span class="n">debug</span><span class="o">/</span><span class="n">toy</span><span class="err">`</span><span class="w"></span>
<span class="n">the</span><span class="w"> </span><span class="n">answer</span><span class="w"> </span><span class="n">is</span>: <span class="mi">42</span><span class="w"></span>
<span class="n">recursive_fib</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">55</span><span class="w"></span>
<span class="n">iterative_fib</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">55</span><span class="w"></span>
<span class="n">hello</span><span class="w"> </span><span class="n">world</span><span class="o">!</span><span class="w"></span>
</code></pre></div>
<p>I could maybe PR that because I don't see how PIC is really relevant to the demo and it would make it work on more platforms </p>
</blockquote>



<a name="231345245"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20Issue%20%232735%20Support%20PLT%20entries%20in%20%60cranelift-.../near/231345245" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20Issue.20.232735.20Support.20PLT.20entries.20in.20.60cranelift-.2E.2E.2E.html#231345245">(Mar 22 2021 at 16:51)</a>:</h4>
<p>bnjbvr <a href="https://github.com/bytecodealliance/wasmtime/issues/2735#issuecomment-804224406">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/2735">Issue #2735</a>:</p>
<blockquote>
<p>I don't know how PLT tables work in MacOS/aarch64 either. It's easy to make it work for our use case (load from pointer into reg + branch into it), but if the linker expects a precise sequence like the one from @bjorn3's comment, we'd need to find what is precisely expected. I don't plan to work on this immediately, yet I'd be happy to try patches if that can help!</p>
</blockquote>



<a name="231346202"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20Issue%20%232735%20Support%20PLT%20entries%20in%20%60cranelift-.../near/231346202" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20Issue.20.232735.20Support.20PLT.20entries.20in.20.60cranelift-.2E.2E.2E.html#231346202">(Mar 22 2021 at 16:57)</a>:</h4>
<p>bjorn3 <a href="https://github.com/bytecodealliance/wasmtime/issues/2735#issuecomment-804228467">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/2735">Issue #2735</a>:</p>
<blockquote>
<p>In case of <code>cranelift-jit</code> no linker is involved. Or rather <code>cranelift-jit</code> is kind of the linker itself. It is not necessary to copy the exact same sequence. (Even on x86_64 I didn't use the exact same sequence) I merely posted it to show what it would roughly need to look like. Basically all the PLT entry needs to do in the case of <code>cranelift-jit</code> on any platform is load the corresponding GOT entry and jump to the loaded address. This is independent of the OS, but once Rust supports pointer authentication on the M1, the PLT entry code will need to be adapted to support pointer authentication.</p>
</blockquote>



<a name="232954500"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20Issue%20%232735%20Support%20PLT%20entries%20in%20%60cranelift-.../near/232954500" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20Issue.20.232735.20Support.20PLT.20entries.20in.20.60cranelift-.2E.2E.2E.html#232954500">(Apr 02 2021 at 21:29)</a>:</h4>
<p>otaviopace <a href="https://github.com/bytecodealliance/wasmtime/issues/2735#issuecomment-812723836">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/2735">Issue #2735</a>:</p>
<blockquote>
<p>Is this related to: <a href="https://github.com/bytecodealliance/wasmtime-go/issues/53">https://github.com/bytecodealliance/wasmtime-go/issues/53</a>?</p>
</blockquote>



<a name="232955065"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20Issue%20%232735%20Support%20PLT%20entries%20in%20%60cranelift-.../near/232955065" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20Issue.20.232735.20Support.20PLT.20entries.20in.20.60cranelift-.2E.2E.2E.html#232955065">(Apr 02 2021 at 21:34)</a>:</h4>
<p>cfallin <a href="https://github.com/bytecodealliance/wasmtime/issues/2735#issuecomment-812725382">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/2735">Issue #2735</a>:</p>
<blockquote>
<p>@octaviopace no, this issue doesn't need to be solved in order to run Wasmtime on macOS/aarch64 (M1) -- the <code>cranelift-jit</code> crate isn't used by Wasmtime.</p>
</blockquote>



<hr><p>Last updated: Jan 20 2025 at 06:04 UTC</p>
</html>