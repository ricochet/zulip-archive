<html>
<head><meta charset="utf-8"><title>wasmtime / issue #8997 CI: wasi-* crates tests failed due... · git-wasmtime · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/index.html">git-wasmtime</a></h2>
<h3>Topic: <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.238997.20CI.3A.20wasi-.2A.20crates.20tests.20failed.20due.2E.2E.2E.html">wasmtime / issue #8997 CI: wasi-* crates tests failed due...</a></h3>

<hr>

<base href="https://bytecodealliance.zulipchat.com">

<head><link href="https://bytecodealliance.github.io/zulip-archive/style.css" rel="stylesheet"></head>

<a name="453361336"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%238997%20CI%3A%20wasi-%2A%20crates%20tests%20failed%20due.../near/453361336" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.238997.20CI.3A.20wasi-.2A.20crates.20tests.20failed.20due.2E.2E.2E.html#453361336">(Jul 23 2024 at 08:50)</a>:</h4>
<p>iawia002 opened <a href="https://github.com/bytecodealliance/wasmtime/issues/8997">issue #8997</a>:</p>
<blockquote>
<p>I first encountered this issue at <a href="https://github.com/bytecodealliance/wasmtime/pull/8983#issuecomment-2242604361">https://github.com/bytecodealliance/wasmtime/pull/8983#issuecomment-2242604361</a>. When the <code>wasi-*</code> crates are grouped with <code>wasmtime-cranelift</code>/<code>wasmtime-environ</code>, the tests will panic:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="n">thread</span><span class="w"> </span><span class="o">'</span><span class="na">runtime_config_get</span><span class="o">'</span><span class="w"> </span><span class="n">panicked</span><span class="w"> </span><span class="n">at</span><span class="w"> </span><span class="n">crates</span><span class="o">/</span><span class="n">wasmtime</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">runtime</span><span class="o">/</span><span class="n">vm</span><span class="o">/</span><span class="n">libcalls</span><span class="p">.</span><span class="n">rs</span><span class="p">:</span><span class="mi">147</span><span class="p">:</span><span class="mi">5</span><span class="p">:</span>
<span class="nc">internal</span><span class="w"> </span><span class="n">error</span><span class="p">:</span><span class="w"> </span><span class="nc">entered</span><span class="w"> </span><span class="n">unreachable</span><span class="w"> </span><span class="n">code</span>
<span class="n">stack</span><span class="w"> </span><span class="n">backtrace</span><span class="p">:</span>
<span class="w">   </span><span class="mi">0</span><span class="p">:</span><span class="w"> </span><span class="nc">rust_begin_unwind</span>
<span class="w">   </span><span class="mi">1</span><span class="p">:</span><span class="w"> </span><span class="nc">core</span><span class="p">::</span><span class="n">panicking</span><span class="p">::</span><span class="n">panic_fmt</span>
<span class="w">   </span><span class="mi">2</span><span class="p">:</span><span class="w"> </span><span class="nc">core</span><span class="p">::</span><span class="n">panicking</span><span class="p">::</span><span class="n">panic</span>
<span class="w">   </span><span class="mi">3</span><span class="p">:</span><span class="w"> </span><span class="nc">wasmtime</span><span class="p">::</span><span class="n">runtime</span><span class="p">::</span><span class="n">vm</span><span class="p">::</span><span class="n">libcalls</span><span class="p">::</span><span class="n">raw</span><span class="p">::</span><span class="n">malloc_start</span>
</code></pre></div>
<p>So, I looked into the source of this code and eventually found that it is related to the <code>wmemcheck</code> feature:</p>
<p><a href="https://github.com/bytecodealliance/wasmtime/blob/80c42c427d828f6ccf004169d8dd018dc5b4d0f0/crates/wasmtime/src/runtime/vm/libcalls.rs#L120-L123">https://github.com/bytecodealliance/wasmtime/blob/80c42c427d828f6ccf004169d8dd018dc5b4d0f0/crates/wasmtime/src/runtime/vm/libcalls.rs#L120-L123</a></p>
<p>We enable all features during our testing, <code>wasmtime-environ</code> will generate the following function:</p>
<p><a href="https://github.com/bytecodealliance/wasmtime/blob/80c42c427d828f6ccf004169d8dd018dc5b4d0f0/crates/environ/src/builtin.rs#L56-L58">https://github.com/bytecodealliance/wasmtime/blob/80c42c427d828f6ccf004169d8dd018dc5b4d0f0/crates/environ/src/builtin.rs#L56-L58</a></p>
<p>However, for the <code>wasmtime</code> package, which is added as a dependency to the overall test, the <code>wmemcheck</code> feature is not enabled by default. This combination results in the follow code causing the wasm component program to panic directly:</p>
<p><div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="cp">#[allow(unused_variables, missing_docs)]</span>
<span class="k">pub</span><span class="w"> </span><span class="k">unsafe</span><span class="w"> </span><span class="k">extern</span><span class="w"> </span><span class="s">"C"</span><span class="w"> </span><span class="k">fn</span><span class="w"> </span><span class="nf">malloc_start</span><span class="p">(</span><span class="n">vmctx</span><span class="p">:</span><span class="w"> </span><span class="o">*</span><span class="k">mut</span><span class="w"> </span><span class="n">VMContext</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="p">::</span><span class="n">core</span><span class="p">::</span><span class="n">panicking</span><span class="p">::</span><span class="n">panic</span><span class="p">(</span><span class="s">"internal error: entered unreachable code"</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div><br>
</p>
</blockquote>



<a name="453362965"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%238997%20CI%3A%20wasi-%2A%20crates%20tests%20failed%20due.../near/453362965" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.238997.20CI.3A.20wasi-.2A.20crates.20tests.20failed.20due.2E.2E.2E.html#453362965">(Jul 23 2024 at 08:59)</a>:</h4>
<p>iawia002 edited <a href="https://github.com/bytecodealliance/wasmtime/issues/8997">issue #8997</a>:</p>
<blockquote>
<p>I first encountered this issue at <a href="https://github.com/bytecodealliance/wasmtime/pull/8983#issuecomment-2242604361">https://github.com/bytecodealliance/wasmtime/pull/8983#issuecomment-2242604361</a>. When the <code>wasi-*</code> crates are grouped with <code>wasmtime-cranelift</code>/<code>wasmtime-environ</code>, the tests will panic:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="n">thread</span><span class="w"> </span><span class="o">'</span><span class="na">runtime_config_get</span><span class="o">'</span><span class="w"> </span><span class="n">panicked</span><span class="w"> </span><span class="n">at</span><span class="w"> </span><span class="n">crates</span><span class="o">/</span><span class="n">wasmtime</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">runtime</span><span class="o">/</span><span class="n">vm</span><span class="o">/</span><span class="n">libcalls</span><span class="p">.</span><span class="n">rs</span><span class="p">:</span><span class="mi">147</span><span class="p">:</span><span class="mi">5</span><span class="p">:</span>
<span class="nc">internal</span><span class="w"> </span><span class="n">error</span><span class="p">:</span><span class="w"> </span><span class="nc">entered</span><span class="w"> </span><span class="n">unreachable</span><span class="w"> </span><span class="n">code</span>
<span class="n">stack</span><span class="w"> </span><span class="n">backtrace</span><span class="p">:</span>
<span class="w">   </span><span class="mi">0</span><span class="p">:</span><span class="w"> </span><span class="nc">rust_begin_unwind</span>
<span class="w">   </span><span class="mi">1</span><span class="p">:</span><span class="w"> </span><span class="nc">core</span><span class="p">::</span><span class="n">panicking</span><span class="p">::</span><span class="n">panic_fmt</span>
<span class="w">   </span><span class="mi">2</span><span class="p">:</span><span class="w"> </span><span class="nc">core</span><span class="p">::</span><span class="n">panicking</span><span class="p">::</span><span class="n">panic</span>
<span class="w">   </span><span class="mi">3</span><span class="p">:</span><span class="w"> </span><span class="nc">wasmtime</span><span class="p">::</span><span class="n">runtime</span><span class="p">::</span><span class="n">vm</span><span class="p">::</span><span class="n">libcalls</span><span class="p">::</span><span class="n">raw</span><span class="p">::</span><span class="n">malloc_start</span>
</code></pre></div>
<p>So, I looked into the source of this code and eventually found that it is related to the <code>wmemcheck</code> feature:</p>
<p><a href="https://github.com/bytecodealliance/wasmtime/blob/80c42c427d828f6ccf004169d8dd018dc5b4d0f0/crates/wasmtime/src/runtime/vm/libcalls.rs#L120-L123">https://github.com/bytecodealliance/wasmtime/blob/80c42c427d828f6ccf004169d8dd018dc5b4d0f0/crates/wasmtime/src/runtime/vm/libcalls.rs#L120-L123</a></p>
<p>We enable all features during our testing, <code>wasmtime-environ</code> will generate the following function:</p>
<p><a href="https://github.com/bytecodealliance/wasmtime/blob/80c42c427d828f6ccf004169d8dd018dc5b4d0f0/crates/environ/src/builtin.rs#L56-L58">https://github.com/bytecodealliance/wasmtime/blob/80c42c427d828f6ccf004169d8dd018dc5b4d0f0/crates/environ/src/builtin.rs#L56-L58</a></p>
<p>However, for the <code>wasmtime</code> package, which is added as a dependency to the overall test, the <code>wmemcheck</code> feature is not enabled by default. This combination results in the following generated code causing the wasm component program to panic directly:</p>
<p><div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="cp">#[allow(unused_variables, missing_docs)]</span>
<span class="k">pub</span><span class="w"> </span><span class="k">unsafe</span><span class="w"> </span><span class="k">extern</span><span class="w"> </span><span class="s">"C"</span><span class="w"> </span><span class="k">fn</span><span class="w"> </span><span class="nf">malloc_start</span><span class="p">(</span><span class="n">vmctx</span><span class="p">:</span><span class="w"> </span><span class="o">*</span><span class="k">mut</span><span class="w"> </span><span class="n">VMContext</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="p">::</span><span class="n">core</span><span class="p">::</span><span class="n">panicking</span><span class="p">::</span><span class="n">panic</span><span class="p">(</span><span class="s">"internal error: entered unreachable code"</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div><br>
</p>
</blockquote>



<a name="453511693"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%238997%20CI%3A%20wasi-%2A%20crates%20tests%20failed%20due.../near/453511693" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.238997.20CI.3A.20wasi-.2A.20crates.20tests.20failed.20due.2E.2E.2E.html#453511693">(Jul 23 2024 at 20:07)</a>:</h4>
<p>alexcrichton <a href="https://github.com/bytecodealliance/wasmtime/issues/8997#issuecomment-2246220016">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/8997">issue #8997</a>:</p>
<blockquote>
<p>Can you clarify a bit more how to trigger this? It's a bit difficult to piece together if this depends on pieces of <a href="https://github.com/bytecodealliance/wasmtime/pull/8983">https://github.com/bytecodealliance/wasmtime/pull/8983</a> which aren't landed in-tree.</p>
</blockquote>



<a name="453566270"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%238997%20CI%3A%20wasi-%2A%20crates%20tests%20failed%20due.../near/453566270" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.238997.20CI.3A.20wasi-.2A.20crates.20tests.20failed.20due.2E.2E.2E.html#453566270">(Jul 24 2024 at 01:26)</a>:</h4>
<p>iawia002 <a href="https://github.com/bytecodealliance/wasmtime/issues/8997#issuecomment-2246680866">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/8997">issue #8997</a>:</p>
<blockquote>
<p>Try the following script, which is similar to the one in <a href="https://github.com/bytecodealliance/wasmtime/actions/runs/10065177837/job/27823731852">CI</a>, but I've manually grouped <code>wasmtime-wasi-http</code> and <code>wasmtime-cranelift/wasmtime-environ</code> together to run simultaneously:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="p">.</span><span class="o">/</span><span class="n">ci</span><span class="o">/</span><span class="n">run</span><span class="o">-</span><span class="n">tests</span><span class="p">.</span><span class="n">sh</span><span class="w"> </span><span class="o">--</span><span class="n">locked</span><span class="w"> </span><span class="o">--</span><span class="n">package</span><span class="w"> </span><span class="n">cranelift</span><span class="o">-</span><span class="n">tools</span><span class="w"> </span><span class="o">--</span><span class="n">exclude</span><span class="w"> </span><span class="n">cranelift</span><span class="w"> </span><span class="o">--</span><span class="n">exclude</span><span class="w"> </span><span class="n">cranelift</span><span class="o">-</span><span class="n">codegen</span><span class="w"> </span><span class="o">--</span><span class="n">package</span><span class="w"> </span><span class="n">cranelift</span><span class="o">-</span><span class="n">bforest</span><span class="w"> </span><span class="o">--</span><span class="n">exclude</span><span class="w"> </span><span class="n">cranelift</span><span class="o">-</span><span class="n">entity</span><span class="w"> </span><span class="o">--</span><span class="n">exclude</span><span class="w"> </span><span class="n">cranelift</span><span class="o">-</span><span class="n">bitset</span><span class="w"> </span><span class="o">--</span><span class="n">package</span><span class="w"> </span><span class="n">cranelift</span><span class="o">-</span><span class="n">codegen</span><span class="o">-</span><span class="n">shared</span><span class="w"> </span><span class="o">--</span><span class="n">exclude</span><span class="w"> </span><span class="n">cranelift</span><span class="o">-</span><span class="n">control</span><span class="w"> </span><span class="o">--</span><span class="n">exclude</span><span class="w"> </span><span class="n">cranelift</span><span class="o">-</span><span class="n">codegen</span><span class="o">-</span><span class="n">meta</span><span class="w"> </span><span class="o">--</span><span class="n">package</span><span class="w"> </span><span class="n">cranelift</span><span class="o">-</span><span class="n">isle</span><span class="w"> </span><span class="o">--</span><span class="n">exclude</span><span class="w"> </span><span class="n">cranelift</span><span class="o">-</span><span class="n">frontend</span><span class="w"> </span><span class="o">--</span><span class="n">exclude</span><span class="w"> </span><span class="n">cranelift</span><span class="o">-</span><span class="n">interpreter</span><span class="w"> </span><span class="o">--</span><span class="n">package</span><span class="w"> </span><span class="n">cranelift</span><span class="o">-</span><span class="n">reader</span><span class="w"> </span><span class="o">--</span><span class="n">exclude</span><span class="w"> </span><span class="n">cranelift</span><span class="o">-</span><span class="n">jit</span><span class="w"> </span><span class="o">--</span><span class="n">exclude</span><span class="w"> </span><span class="n">cranelift</span><span class="o">-</span><span class="n">module</span><span class="w"> </span><span class="o">--</span><span class="n">package</span><span class="w"> </span><span class="n">cranelift</span><span class="o">-</span><span class="n">native</span><span class="w"> </span><span class="o">--</span><span class="n">exclude</span><span class="w"> </span><span class="n">wasmtime</span><span class="o">-</span><span class="n">jit</span><span class="o">-</span><span class="n">icache</span><span class="o">-</span><span class="n">coherence</span><span class="w"> </span><span class="o">--</span><span class="n">exclude</span><span class="w"> </span><span class="n">cranelift</span><span class="o">-</span><span class="n">object</span><span class="w"> </span><span class="o">--</span><span class="n">package</span><span class="w"> </span><span class="n">cranelift</span><span class="o">-</span><span class="n">filetests</span><span class="w"> </span><span class="o">--</span><span class="n">exclude</span><span class="w"> </span><span class="n">isle</span><span class="o">-</span><span class="n">fuzz</span><span class="w"> </span><span class="o">--</span><span class="n">exclude</span><span class="w"> </span><span class="n">islec</span><span class="w"> </span><span class="o">--</span><span class="n">package</span><span class="w"> </span><span class="n">cranelift</span><span class="o">-</span><span class="n">serde</span><span class="w"> </span><span class="o">--</span><span class="n">exclude</span><span class="w"> </span><span class="n">wasmtime</span><span class="o">-</span><span class="n">bench</span><span class="o">-</span><span class="n">api</span><span class="w"> </span><span class="o">--</span><span class="n">exclude</span><span class="w"> </span><span class="n">wasi</span><span class="o">-</span><span class="n">common</span><span class="w"> </span><span class="o">--</span><span class="n">exclude</span><span class="w"> </span><span class="n">wasmtime</span><span class="w"> </span><span class="o">--</span><span class="n">package</span><span class="w"> </span><span class="n">wasmtime</span><span class="o">-</span><span class="n">asm</span><span class="o">-</span><span class="n">macros</span><span class="w"> </span><span class="o">--</span><span class="n">exclude</span><span class="w"> </span><span class="n">wasmtime</span><span class="o">-</span><span class="n">cache</span><span class="w"> </span><span class="o">--</span><span class="n">exclude</span><span class="w"> </span><span class="n">wasmtime</span><span class="o">-</span><span class="n">component</span><span class="o">-</span><span class="kr">macro</span><span class="w"> </span><span class="o">--</span><span class="n">package</span><span class="w"> </span><span class="n">wasmtime</span><span class="o">-</span><span class="n">component</span><span class="o">-</span><span class="n">util</span><span class="w"> </span><span class="o">--</span><span class="n">exclude</span><span class="w"> </span><span class="n">wasmtime</span><span class="o">-</span><span class="n">wit</span><span class="o">-</span><span class="n">bindgen</span><span class="w"> </span><span class="o">--</span><span class="n">exclude</span><span class="w"> </span><span class="n">component</span><span class="o">-</span><span class="kr">macro</span><span class="o">-</span><span class="n">test</span><span class="o">-</span><span class="n">helpers</span><span class="w"> </span><span class="o">--</span><span class="n">package</span><span class="w"> </span><span class="n">wasmtime</span><span class="o">-</span><span class="n">cranelift</span><span class="w"> </span><span class="o">--</span><span class="n">exclude</span><span class="w"> </span><span class="n">cranelift</span><span class="o">-</span><span class="n">wasm</span><span class="w"> </span><span class="o">--</span><span class="n">exclude</span><span class="w"> </span><span class="n">wasmtime</span><span class="o">-</span><span class="n">types</span><span class="w"> </span><span class="o">--</span><span class="n">package</span><span class="w"> </span><span class="n">wasmtime</span><span class="o">-</span><span class="n">environ</span><span class="w"> </span><span class="o">--</span><span class="n">exclude</span><span class="w"> </span><span class="n">wasmtime</span><span class="o">-</span><span class="n">versioned</span><span class="o">-</span><span class="n">export</span><span class="o">-</span><span class="n">macros</span><span class="w"> </span><span class="o">--</span><span class="n">exclude</span><span class="w"> </span><span class="n">wasmtime</span><span class="o">-</span><span class="n">fiber</span><span class="w"> </span><span class="o">--</span><span class="n">package</span><span class="w"> </span><span class="n">wasmtime</span><span class="o">-</span><span class="n">jit</span><span class="o">-</span><span class="n">debug</span><span class="w"> </span><span class="o">--</span><span class="n">exclude</span><span class="w"> </span><span class="n">wasmtime</span><span class="o">-</span><span class="n">slab</span><span class="w"> </span><span class="o">--</span><span class="n">exclude</span><span class="w"> </span><span class="n">wasmtime</span><span class="o">-</span><span class="n">winch</span><span class="w"> </span><span class="o">--</span><span class="n">package</span><span class="w"> </span><span class="n">winch</span><span class="o">-</span><span class="n">codegen</span><span class="w"> </span><span class="o">--</span><span class="n">exclude</span><span class="w"> </span><span class="n">wasmtime</span><span class="o">-</span><span class="n">wmemcheck</span><span class="w"> </span><span class="o">--</span><span class="n">exclude</span><span class="w"> </span><span class="n">wiggle</span><span class="w"> </span><span class="o">--</span><span class="n">package</span><span class="w"> </span><span class="n">wiggle</span><span class="o">-</span><span class="kr">macro</span><span class="w"> </span><span class="o">--</span><span class="n">exclude</span><span class="w"> </span><span class="n">wiggle</span><span class="o">-</span><span class="n">generate</span><span class="w"> </span><span class="o">--</span><span class="n">exclude</span><span class="w"> </span><span class="n">wiggle</span><span class="o">-</span><span class="n">test</span><span class="w"> </span><span class="o">--</span><span class="n">package</span><span class="w"> </span><span class="n">test</span><span class="o">-</span><span class="n">programs</span><span class="o">-</span><span class="n">artifacts</span><span class="w"> </span><span class="o">--</span><span class="n">exclude</span><span class="w"> </span><span class="n">wasmtime</span><span class="o">-</span><span class="n">cli</span><span class="o">-</span><span class="n">flags</span><span class="w"> </span><span class="o">--</span><span class="n">exclude</span><span class="w"> </span><span class="n">wasmtime</span><span class="o">-</span><span class="n">wasi</span><span class="o">-</span><span class="n">nn</span><span class="w"> </span><span class="o">--</span><span class="n">exclude</span><span class="w"> </span><span class="n">wasmtime</span><span class="o">-</span><span class="n">wasi</span><span class="w"> </span><span class="o">--</span><span class="n">package</span><span class="w"> </span><span class="n">wasmtime</span><span class="o">-</span><span class="n">c</span><span class="o">-</span><span class="n">api</span><span class="w"> </span><span class="o">--</span><span class="n">exclude</span><span class="w"> </span><span class="n">wasmtime</span><span class="o">-</span><span class="n">c</span><span class="o">-</span><span class="n">api</span><span class="o">-</span><span class="k">impl</span><span class="w"> </span><span class="o">--</span><span class="n">exclude</span><span class="w"> </span><span class="n">wasmtime</span><span class="o">-</span><span class="n">c</span><span class="o">-</span><span class="n">api</span><span class="o">-</span><span class="n">macros</span><span class="w"> </span><span class="o">--</span><span class="n">package</span><span class="w"> </span><span class="n">wasmtime</span><span class="o">-</span><span class="n">environ</span><span class="o">-</span><span class="n">fuzz</span><span class="w"> </span><span class="o">--</span><span class="n">exclude</span><span class="w"> </span><span class="n">component</span><span class="o">-</span><span class="n">fuzz</span><span class="o">-</span><span class="n">util</span><span class="w"> </span><span class="o">--</span><span class="n">exclude</span><span class="w"> </span><span class="n">test</span><span class="o">-</span><span class="n">programs</span><span class="w"> </span><span class="o">--</span><span class="n">package</span><span class="w"> </span><span class="n">wasi</span><span class="o">-</span><span class="n">preview1</span><span class="o">-</span><span class="n">component</span><span class="o">-</span><span class="n">adapter</span><span class="w"> </span><span class="o">--</span><span class="n">exclude</span><span class="w"> </span><span class="n">byte</span><span class="o">-</span><span class="n">array</span><span class="o">-</span><span class="n">literals</span><span class="w"> </span><span class="o">--</span><span class="n">exclude</span><span class="w"> </span><span class="n">verify</span><span class="o">-</span><span class="n">component</span><span class="o">-</span><span class="n">adapter</span><span class="w"> </span><span class="o">--</span><span class="n">package</span><span class="w"> </span><span class="n">example</span><span class="o">-</span><span class="n">fib</span><span class="o">-</span><span class="n">debug</span><span class="o">-</span><span class="n">wasm</span><span class="w"> </span><span class="o">--</span><span class="n">exclude</span><span class="w"> </span><span class="n">example</span><span class="o">-</span><span class="n">wasi</span><span class="o">-</span><span class="n">wasm</span><span class="w"> </span><span class="o">--</span><span class="n">exclude</span><span class="w"> </span><span class="n">example</span><span class="o">-</span><span class="n">tokio</span><span class="o">-</span><span class="n">wasm</span><span class="w"> </span><span class="o">--</span><span class="n">package</span><span class="w"> </span><span class="n">example</span><span class="o">-</span><span class="n">component</span><span class="o">-</span><span class="n">wasm</span><span class="w"> </span><span class="o">--</span><span class="n">exclude</span><span class="w"> </span><span class="n">min</span><span class="o">-</span><span class="n">platform</span><span class="o">-</span><span class="n">host</span><span class="w"> </span><span class="o">--</span><span class="n">exclude</span><span class="w"> </span><span class="n">embedding</span><span class="w"> </span><span class="o">--</span><span class="n">package</span><span class="w"> </span><span class="n">wasmtime</span><span class="o">-</span><span class="n">fuzz</span><span class="w"> </span><span class="o">--</span><span class="n">exclude</span><span class="w"> </span><span class="n">component</span><span class="o">-</span><span class="n">test</span><span class="o">-</span><span class="n">util</span><span class="w"> </span><span class="o">--</span><span class="n">exclude</span><span class="w"> </span><span class="n">cranelift</span><span class="o">-</span><span class="n">fuzzgen</span><span class="w"> </span><span class="o">--</span><span class="n">package</span><span class="w"> </span><span class="n">wasmtime</span><span class="o">-</span><span class="n">fuzzing</span><span class="w"> </span><span class="o">--</span><span class="n">exclude</span><span class="w"> </span><span class="n">wasm</span><span class="o">-</span><span class="n">spec</span><span class="o">-</span><span class="n">interpreter</span><span class="w"> </span><span class="o">--</span><span class="n">exclude</span><span class="w"> </span><span class="n">wasmtime</span><span class="o">-</span><span class="n">wast</span><span class="w"> </span><span class="o">--</span><span class="n">exclude</span><span class="w"> </span><span class="n">wasmtime</span><span class="o">-</span><span class="n">cli</span><span class="w"> </span><span class="o">--</span><span class="n">package</span><span class="w"> </span><span class="n">wasmtime</span><span class="o">-</span><span class="n">explorer</span><span class="w"> </span><span class="o">--</span><span class="n">package</span><span class="w"> </span><span class="n">wasmtime</span><span class="o">-</span><span class="n">wasi</span><span class="o">-</span><span class="n">http</span><span class="w"> </span><span class="o">--</span><span class="n">exclude</span><span class="w"> </span><span class="n">wasmtime</span><span class="o">-</span><span class="n">wasi</span><span class="o">-</span><span class="n">runtime</span><span class="o">-</span><span class="n">config</span><span class="w"> </span><span class="o">--</span><span class="n">package</span><span class="w"> </span><span class="n">wasmtime</span><span class="o">-</span><span class="n">wasi</span><span class="o">-</span><span class="n">threads</span><span class="w"> </span><span class="o">--</span><span class="n">exclude</span><span class="w"> </span><span class="n">component</span><span class="o">-</span><span class="kr">macro</span><span class="o">-</span><span class="n">test</span><span class="w"> </span><span class="o">--</span><span class="n">exclude</span><span class="w"> </span><span class="n">wasmtime</span><span class="o">-</span><span class="n">test</span><span class="o">-</span><span class="n">macros</span>
</code></pre></div>
<p>Actually, this issue has always existed and is not related to #8983. We haven't encountered it before because the <code>wasi-*</code> crates just happened not to be grouped with <code>wasmtime-cranelift/wasmtime-environ</code>. #8983 added a new <code>wasi-*</code> crate, which caused the modulus algorithm to group the previously separated <code>wasmtime-wasi-runtime-config</code> and <code>wasmtime-cranelift/wasmtime-environ</code> together.</p>
</blockquote>



<a name="453715592"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%238997%20CI%3A%20wasi-%2A%20crates%20tests%20failed%20due.../near/453715592" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.238997.20CI.3A.20wasi-.2A.20crates.20tests.20failed.20due.2E.2E.2E.html#453715592">(Jul 24 2024 at 14:47)</a>:</h4>
<p>alexcrichton <a href="https://github.com/bytecodealliance/wasmtime/issues/8997#issuecomment-2248210940">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/8997">issue #8997</a>:</p>
<blockquote>
<p>Thanks! I suspected that it was a preexisting issue as well but just wasn't sure how to reproduce it, and the script there is helpful! This should be fixed by <a href="https://github.com/bytecodealliance/wasmtime/pull/9002">https://github.com/bytecodealliance/wasmtime/pull/9002</a>.</p>
</blockquote>



<a name="453741269"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%238997%20CI%3A%20wasi-%2A%20crates%20tests%20failed%20due.../near/453741269" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.238997.20CI.3A.20wasi-.2A.20crates.20tests.20failed.20due.2E.2E.2E.html#453741269">(Jul 24 2024 at 16:22)</a>:</h4>
<p>fitzgen closed <a href="https://github.com/bytecodealliance/wasmtime/issues/8997">issue #8997</a>:</p>
<blockquote>
<p>I first encountered this issue at <a href="https://github.com/bytecodealliance/wasmtime/pull/8983#issuecomment-2242604361">https://github.com/bytecodealliance/wasmtime/pull/8983#issuecomment-2242604361</a>. When the <code>wasi-*</code> crates are grouped with <code>wasmtime-cranelift</code>/<code>wasmtime-environ</code>, the tests will panic:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="n">thread</span><span class="w"> </span><span class="o">'</span><span class="na">runtime_config_get</span><span class="o">'</span><span class="w"> </span><span class="n">panicked</span><span class="w"> </span><span class="n">at</span><span class="w"> </span><span class="n">crates</span><span class="o">/</span><span class="n">wasmtime</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">runtime</span><span class="o">/</span><span class="n">vm</span><span class="o">/</span><span class="n">libcalls</span><span class="p">.</span><span class="n">rs</span><span class="p">:</span><span class="mi">147</span><span class="p">:</span><span class="mi">5</span><span class="p">:</span>
<span class="nc">internal</span><span class="w"> </span><span class="n">error</span><span class="p">:</span><span class="w"> </span><span class="nc">entered</span><span class="w"> </span><span class="n">unreachable</span><span class="w"> </span><span class="n">code</span>
<span class="n">stack</span><span class="w"> </span><span class="n">backtrace</span><span class="p">:</span>
<span class="w">   </span><span class="mi">0</span><span class="p">:</span><span class="w"> </span><span class="nc">rust_begin_unwind</span>
<span class="w">   </span><span class="mi">1</span><span class="p">:</span><span class="w"> </span><span class="nc">core</span><span class="p">::</span><span class="n">panicking</span><span class="p">::</span><span class="n">panic_fmt</span>
<span class="w">   </span><span class="mi">2</span><span class="p">:</span><span class="w"> </span><span class="nc">core</span><span class="p">::</span><span class="n">panicking</span><span class="p">::</span><span class="n">panic</span>
<span class="w">   </span><span class="mi">3</span><span class="p">:</span><span class="w"> </span><span class="nc">wasmtime</span><span class="p">::</span><span class="n">runtime</span><span class="p">::</span><span class="n">vm</span><span class="p">::</span><span class="n">libcalls</span><span class="p">::</span><span class="n">raw</span><span class="p">::</span><span class="n">malloc_start</span>
</code></pre></div>
<p>So, I looked into the source of this code and eventually found that it is related to the <code>wmemcheck</code> feature:</p>
<p><a href="https://github.com/bytecodealliance/wasmtime/blob/80c42c427d828f6ccf004169d8dd018dc5b4d0f0/crates/wasmtime/src/runtime/vm/libcalls.rs#L120-L123">https://github.com/bytecodealliance/wasmtime/blob/80c42c427d828f6ccf004169d8dd018dc5b4d0f0/crates/wasmtime/src/runtime/vm/libcalls.rs#L120-L123</a></p>
<p>We enable all features during our testing, <code>wasmtime-environ</code> will generate the following function:</p>
<p><a href="https://github.com/bytecodealliance/wasmtime/blob/80c42c427d828f6ccf004169d8dd018dc5b4d0f0/crates/environ/src/builtin.rs#L56-L58">https://github.com/bytecodealliance/wasmtime/blob/80c42c427d828f6ccf004169d8dd018dc5b4d0f0/crates/environ/src/builtin.rs#L56-L58</a></p>
<p>However, for the <code>wasmtime</code> package, which is added as a dependency to the overall test, the <code>wmemcheck</code> feature is not enabled by default. This combination results in the following generated code causing the wasm component program to panic directly:</p>
<p><div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="cp">#[allow(unused_variables, missing_docs)]</span>
<span class="k">pub</span><span class="w"> </span><span class="k">unsafe</span><span class="w"> </span><span class="k">extern</span><span class="w"> </span><span class="s">"C"</span><span class="w"> </span><span class="k">fn</span><span class="w"> </span><span class="nf">malloc_start</span><span class="p">(</span><span class="n">vmctx</span><span class="p">:</span><span class="w"> </span><span class="o">*</span><span class="k">mut</span><span class="w"> </span><span class="n">VMContext</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="p">::</span><span class="n">core</span><span class="p">::</span><span class="n">panicking</span><span class="p">::</span><span class="n">panic</span><span class="p">(</span><span class="s">"internal error: entered unreachable code"</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div><br>
</p>
</blockquote>



<hr><p>Last updated: Jan 20 2025 at 06:04 UTC</p>
</html>