<html>
<head><meta charset="utf-8"><title>wasmtime / issue #7109  Implement the `wasi:sockets/ip-na... · git-wasmtime · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/index.html">git-wasmtime</a></h2>
<h3>Topic: <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.237109.20.20Implement.20the.20.60wasi.3Asockets.2Fip-na.2E.2E.2E.html">wasmtime / issue #7109  Implement the `wasi:sockets/ip-na...</a></h3>

<hr>

<base href="https://bytecodealliance.zulipchat.com">

<head><link href="https://bytecodealliance.github.io/zulip-archive/style.css" rel="stylesheet"></head>

<a name="393816233"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%237109%20%20Implement%20the%20%60wasi%3Asockets/ip-na.../near/393816233" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.237109.20.20Implement.20the.20.60wasi.3Asockets.2Fip-na.2E.2E.2E.html#393816233">(Sep 28 2023 at 22:53)</a>:</h4>
<p>alexcrichton <a href="https://github.com/bytecodealliance/wasmtime/pull/7109#issuecomment-1740099372">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/7109">issue #7109</a>:</p>
<blockquote>
<p>cc @sunfishcode and @badeend </p>
<p>This is based on <a href="https://github.com/bytecodealliance/wasmtime/pull/7029">https://github.com/bytecodealliance/wasmtime/pull/7029</a> so only the last commits here are relevant.</p>
<p>I'm particularly keen to get y'alls input and thoughts on the implementation here. Was the intention to be able to use <code>getaddrinfo</code>? Or was the intention that implementations must avoid <code>getaddrinfo</code>? For example the documentation of the <code>ip-name-lookup</code> functions indicates that addresses shouldn't be parsed (which I assume means that resolving <code>"127.0.0.1"</code> should fail), but I couldn't find the option to specify to <code>getaddrinfo</code> that this must fail. I was basically wondering if y'all had an implementation for this in mind ahead of time, and if so I'd be happy to switch to that.</p>
</blockquote>



<a name="393816343"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%237109%20%20Implement%20the%20%60wasi%3Asockets/ip-na.../near/393816343" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.237109.20.20Implement.20the.20.60wasi.3Asockets.2Fip-na.2E.2E.2E.html#393816343">(Sep 28 2023 at 22:54)</a>:</h4>
<p>alexcrichton <a href="https://github.com/bytecodealliance/wasmtime/pull/7109#issuecomment-1740099881">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/7109">issue #7109</a>:</p>
<blockquote>
<p>Also I'm curious for y'all's thoughts on how to make this capability-based. For example right now I've added a global flag for "allow any name lookups at all" but that's quite coarse. Did y'all have thoughts already about how this might look like to configure from a CLI and how embedders might use it?</p>
</blockquote>



<a name="393997832"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%237109%20%20Implement%20the%20%60wasi%3Asockets/ip-na.../near/393997832" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.237109.20.20Implement.20the.20.60wasi.3Asockets.2Fip-na.2E.2E.2E.html#393997832">(Sep 29 2023 at 20:12)</a>:</h4>
<p>alexcrichton edited a <a href="https://github.com/bytecodealliance/wasmtime/pull/7109#issuecomment-1740099372">comment</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/7109">issue #7109</a>:</p>
<blockquote>
<p>cc @sunfishcode and @badeend </p>
<p><del>This is based on <a href="https://github.com/bytecodealliance/wasmtime/pull/7029">https://github.com/bytecodealliance/wasmtime/pull/7029</a> so only the last commits here are relevant.</del></p>
<p>I'm particularly keen to get y'alls input and thoughts on the implementation here. Was the intention to be able to use <code>getaddrinfo</code>? Or was the intention that implementations must avoid <code>getaddrinfo</code>? For example the documentation of the <code>ip-name-lookup</code> functions indicates that addresses shouldn't be parsed (which I assume means that resolving <code>"127.0.0.1"</code> should fail), but I couldn't find the option to specify to <code>getaddrinfo</code> that this must fail. I was basically wondering if y'all had an implementation for this in mind ahead of time, and if so I'd be happy to switch to that.</p>
</blockquote>



<a name="394178543"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%237109%20%20Implement%20the%20%60wasi%3Asockets/ip-na.../near/394178543" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.237109.20.20Implement.20the.20.60wasi.3Asockets.2Fip-na.2E.2E.2E.html#394178543">(Oct 01 2023 at 09:18)</a>:</h4>
<p>badeend <a href="https://github.com/bytecodealliance/wasmtime/pull/7109#issuecomment-1742018079">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/7109">issue #7109</a>:</p>
<blockquote>
<p>Hi!</p>
<p>I see the <code>name</code> parameter is directly passed on to <code>.to_socket_addrs()</code>. Which is understandable, but that doesn't quite reflect the proposal.</p>
<blockquote>
<p>was the intention that implementations must avoid getaddrinfo?</p>
</blockquote>
<p>No, but to keep the WASI API surface area as small &amp; simple as possible, it isn't a drop-in replacement either. From the Readme:</p>
<blockquote>
<h4>Why not getaddrinfo?</h4>
<p>The proposed <a href="http://./wasi-ip-name-lookup.wit">wasi-ip-name-lookup</a> module focuses strictly on translating internet domain names to ip addresses and nothing else.</p>
<p>Like BSD sockets, <code>getaddrinfo</code> is very generic and multipurpose by design. The proposed WASI API is <em>not</em>. This eliminates many of the other "hats" getaddrinfo has (and potential security holes), like:<br>
- Mapping service names to port numbers (<code>"https"</code> -&gt; <code>443</code>)<br>
- Mapping service names/ports to socket types (<code>"https"</code> -&gt; <code>SOCK_STREAM</code>)<br>
- Network interface name translation (<code>%eth0</code> -&gt; <code>1</code>)<br>
- IP address deserialization (<code>"127.0.0.1"</code> -&gt; <code>Ipv4Address(127, 0, 0, 1)</code>)<br>
- IP address string canonicalization (<code>"0:0:0:0:0:0:0:1"</code> -&gt; <code>"::1"</code>)<br>
- Constants lookup for <code>INADDR_ANY</code>, <code>INADDR_LOOPBACK</code>, <code>IN6ADDR_ANY_INIT</code> and <code>IN6ADDR_LOOPBACK_INIT</code>.</p>
<p>Many of these functionalities can be shimmed in the libc implementation. Though some require future WASI additions. An example is network interface name translation. That requires a future <code>if_nametoindex</code>-like syscall.</p>
</blockquote>
<hr>
<blockquote>
<p>(...) I've added a global flag for "allow any name lookups at all" but that's quite coarse. Did y'all have thoughts already about how this might look like to configure from a CLI and how embedders might use it?</p>
</blockquote>
<p>This issue might be relevant: <a href="https://github.com/WebAssembly/wasi-sockets/issues/32">https://github.com/WebAssembly/wasi-sockets/issues/32</a><br>
Also, this document exists: <a href="https://github.com/WebAssembly/wasi-sockets/blob/main/GrantingAccess.md">https://github.com/WebAssembly/wasi-sockets/blob/main/GrantingAccess.md</a> but keep in mind that it hasn't been updated since the first draft of the proposal.</p>
<p>For the initial implementation, a simple boolean (allow/deny everything) seems fine to me. <span aria-label="+1" class="emoji emoji-1f44d" role="img" title="+1">:+1:</span> </p>
</blockquote>



<a name="394206548"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%237109%20%20Implement%20the%20%60wasi%3Asockets/ip-na.../near/394206548" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.237109.20.20Implement.20the.20.60wasi.3Asockets.2Fip-na.2E.2E.2E.html#394206548">(Oct 01 2023 at 12:48)</a>:</h4>
<p>badeend <a href="https://github.com/bytecodealliance/wasmtime/pull/7109#issuecomment-1742071026">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/7109">issue #7109</a>:</p>
<blockquote>
<p>I've added input validation here: <a href="https://github.com/badeend/wasmtime/commits/wasi-ip-name-lookup">https://github.com/badeend/wasmtime/commits/wasi-ip-name-lookup</a></p>
</blockquote>



<a name="394449254"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%237109%20%20Implement%20the%20%60wasi%3Asockets/ip-na.../near/394449254" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.237109.20.20Implement.20the.20.60wasi.3Asockets.2Fip-na.2E.2E.2E.html#394449254">(Oct 02 2023 at 14:36)</a>:</h4>
<p>alexcrichton <a href="https://github.com/bytecodealliance/wasmtime/pull/7109#issuecomment-1743140792">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/7109">issue #7109</a>:</p>
<blockquote>
<p>Ok thanks! I saw the note about getaddrinfo yeah but I wasn't sure whether it was intended that a particular flag was passed or whether parsing was going to be required. I think your branch works well though, and I'll integrate that here, thanks for it!</p>
<p>Also sounds good on access restrictions for now, I like the <code>GrantingAccess.md</code> link and agree that it's probably best to start off with a simple boolean for now and it can be bikeshedded/expanded later.</p>
</blockquote>



<a name="394471243"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%237109%20%20Implement%20the%20%60wasi%3Asockets/ip-na.../near/394471243" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.237109.20.20Implement.20the.20.60wasi.3Asockets.2Fip-na.2E.2E.2E.html#394471243">(Oct 02 2023 at 16:28)</a>:</h4>
<p>fitzgen <a href="https://github.com/bytecodealliance/wasmtime/pull/7109#issuecomment-1743338584">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/7109">issue #7109</a>:</p>
<blockquote>
<p>Redirecting review to Pat since I'm not really familiar with WASI bits.</p>
</blockquote>



<hr><p>Last updated: Jan 20 2025 at 06:04 UTC</p>
</html>