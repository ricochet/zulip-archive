<html>
<head><meta charset="utf-8"><title>wasmtime / Issue #2354 Add extension marker to i32 argume... · git-wasmtime · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/index.html">git-wasmtime</a></h2>
<h3>Topic: <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20Issue.20.232354.20Add.20extension.20marker.20to.20i32.20argume.2E.2E.2E.html">wasmtime / Issue #2354 Add extension marker to i32 argume...</a></h3>

<hr>

<base href="https://bytecodealliance.zulipchat.com">

<head><link href="https://bytecodealliance.github.io/zulip-archive/style.css" rel="stylesheet"></head>

<a name="215483237"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20Issue%20%232354%20Add%20extension%20marker%20to%20i32%20argume.../near/215483237" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20Issue.20.232354.20Add.20extension.20marker.20to.20i32.20argume.2E.2E.2E.html#215483237">(Nov 03 2020 at 17:12)</a>:</h4>
<p>cfallin <a href="https://github.com/bytecodealliance/wasmtime/pull/2354#issuecomment-721262540">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/2354">Issue #2354</a>:</p>
<blockquote>
<p>Hmm -- this will potentially pessimize x64 and aarch64, as on both of those platforms the extension modes are actually used sometimes, and not ignored. Specifically, in the SpiderMonkey embedding (Baldrdash calling convention), the JIT requires all args to be zero-extended, so we do respect the extension modes. This change could thus result in extraneous extension instructions in the non-Baldrdash (i.e. normal SysV convention) case.</p>
<p>It's a bit confusing to me why the platform-independent IR leaks platform-specific ABI details, and perhaps we should clarify the design eventually. But in the meantime: is there a reason that the relevant backend(s) (this is an issue with IBM Z, I'm assuming?) can't unconditionally extend args, given that that is the ABI?</p>
</blockquote>



<a name="215484343"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20Issue%20%232354%20Add%20extension%20marker%20to%20i32%20argume.../near/215484343" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20Issue.20.232354.20Add.20extension.20marker.20to.20i32.20argume.2E.2E.2E.html#215484343">(Nov 03 2020 at 17:21)</a>:</h4>
<p>uweigand <a href="https://github.com/bytecodealliance/wasmtime/pull/2354#issuecomment-721267610">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/2354">Issue #2354</a>:</p>
<blockquote>
<blockquote>
<p>Hmm -- this will potentially pessimize x64 and aarch64, as on both of those platforms the extension modes are actually used sometimes, and not ignored. Specifically, in the SpiderMonkey embedding (Baldrdash calling convention), the JIT requires all args to be zero-extended, so we do respect the extension modes. This change could thus result in extraneous extension instructions in the non-Baldrdash (i.e. normal SysV convention) case.</p>
<p>It's a bit confusing to me why the platform-independent IR leaks platform-specific ABI details, and perhaps we should clarify the design eventually. But in the meantime: is there a reason that the relevant backend(s) (this is an issue with IBM Z, I'm assuming?) can't unconditionally extend args, given that that is the ABI?</p>
</blockquote>
<p>The extension marker specifies that the argument should be extended <strong>if and only if required by the ABI</strong>.  So if there is a difference between ABIs, the back-end should handle this accordingly.</p>
<p>The only reason why the extension marker is provided by the front-end is to specify signedness.  <strong>If</strong> the back-end decides the ABI requires extension, then it needs to know whether to zero- or sign-extend, and the only place that information can come from is the front-end.</p>
</blockquote>



<a name="215488533"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20Issue%20%232354%20Add%20extension%20marker%20to%20i32%20argume.../near/215488533" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20Issue.20.232354.20Add.20extension.20marker.20to.20i32.20argume.2E.2E.2E.html#215488533">(Nov 03 2020 at 17:52)</a>:</h4>
<p>cfallin <a href="https://github.com/bytecodealliance/wasmtime/pull/2354#issuecomment-721284100">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/2354">Issue #2354</a>:</p>
<blockquote>
<p>Interesting -- this doesn't match the definition that I had understood (namely, that the <code>ArgumentExtension</code> if present indicates that the argument <em>must</em> be extended as specified), so I went digging a bit:</p>
<ul>
<li>
<p>In the doc-comment for <code>ArgumentExtension</code>, all that is specified is "on some architectures, small integer function arguments are extended" (<a href="https://github.com/bytecodealliance/wasmtime/blob/5ab7b4aa7fdf2ec00d0c04c0dffc9c7b4c89ca83/cranelift/codegen/src/ir/extfunc.rs#L257-L260">link</a>) -- somewhat ambiguous, so let's look at what backends do...</p>
</li>
<li>
<p>In the current (production) x86 backend, it seems that <code>uext</code> and <code>sext</code> will unconditionally result in extend ops:</p>
<ul>
<li>In the x86 ABI code, the <code>ArgumentExtension</code> value is translated into a <code>ValueConversion</code>: <a href="https://github.com/bytecodealliance/wasmtime/blob/5ab7b4aa7fdf2ec00d0c04c0dffc9c7b4c89ca83/cranelift/codegen/src/isa/x86/abi.rs#L149-L153">link</a></li>
<li>Then, in the legalizer, this <code>ValueConversion</code> results in a <code>uextend</code> or <code>sextend</code> op: <a href="https://github.com/bytecodealliance/wasmtime/blob/5ab7b4aa7fdf2ec00d0c04c0dffc9c7b4c89ca83/cranelift/codegen/src/legalizer/boundary.rs#L591-L592">link</a></li>
</ul>
</li>
<li>
<p>In the new x64 and aarch64 backends, the <code>ArgumentExtension</code> unconditionally results in extend ops (from <code>ABIMachineSpec::gen_extend()</code>) if <code>Uext</code> or <code>Sext</code>: <a href="https://github.com/bytecodealliance/wasmtime/blob/5ab7b4aa7fdf2ec00d0c04c0dffc9c7b4c89ca83/cranelift/codegen/src/machinst/abi_impl.rs#L1202-L1218">link</a></p>
</li>
</ul>
<p>So the doc-comment spec is somewhat ambiguous, but all three backends currently treat the extension mode as a mandatory request (always extend if specified), so it's certainly the lowest-overhead choice to keep that definition. And, given that we have other Cranelift users out-of-tree, we should consider it a public interface and be hesitant to change it.</p>
<hr>
<p>I think I understand the difficulty here, though: it seems that in the past, the most common use (or at least the initial driving use) of this feature was SpiderMonkey's ABI, for which the environment definition could attach the required extension modes because it controls generation of signatures and callsite IR. No "vanilla" system ABI has this requirement, so for other environments, we have no way to infer the signedness of the value once we get to the backend, as this has to come from the frontend (as you say).</p>
<p>That said: at least for the <code>cranelift-wasm</code> crate and Wasmtime, we don't have a signed-<code>I32</code> type so I'm curious where the signedness may come from. In this patch, we're just unconditionally adding a <code>uext</code> attribute. Is the concern for other frontends, with the assumption that they will (also?) add their own sext/uext attributes?</p>
<p>If we truly need a notion of signedness for some ABIs to be implemented properly, then we can definitely discuss how to get this -- perhaps a signedness bit on types. That would need a wider discussion, of course. Anyone else have thoughts on this?</p>
</blockquote>



<a name="215488812"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20Issue%20%232354%20Add%20extension%20marker%20to%20i32%20argume.../near/215488812" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20Issue.20.232354.20Add.20extension.20marker.20to.20i32.20argume.2E.2E.2E.html#215488812">(Nov 03 2020 at 17:54)</a>:</h4>
<p>cfallin edited a <a href="https://github.com/bytecodealliance/wasmtime/pull/2354#issuecomment-721284100">comment</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/2354">Issue #2354</a>:</p>
<blockquote>
<p>Interesting -- this doesn't match the definition that I had understood (namely, that the <code>ArgumentExtension</code> if present indicates that the argument <em>must</em> be extended as specified), so I went digging a bit:</p>
<ul>
<li>
<p>In the doc-comment for <code>ArgumentExtension</code>, all that is specified is "on some architectures, small integer function arguments are extended" (<a href="https://github.com/bytecodealliance/wasmtime/blob/5ab7b4aa7fdf2ec00d0c04c0dffc9c7b4c89ca83/cranelift/codegen/src/ir/extfunc.rs#L257-L260">link</a>) -- somewhat ambiguous, so let's look at what backends do...</p>
</li>
<li>
<p>In the current (production) x86 backend, it seems that <code>uext</code> and <code>sext</code> will unconditionally result in extend ops:</p>
<ul>
<li>In the x86 ABI code, the <code>ArgumentExtension</code> value is translated into a <code>ValueConversion</code>: <a href="https://github.com/bytecodealliance/wasmtime/blob/5ab7b4aa7fdf2ec00d0c04c0dffc9c7b4c89ca83/cranelift/codegen/src/isa/x86/abi.rs#L149-L153">link</a></li>
<li>Then, in the legalizer, this <code>ValueConversion</code> results in a <code>uextend</code> or <code>sextend</code> op: <a href="https://github.com/bytecodealliance/wasmtime/blob/5ab7b4aa7fdf2ec00d0c04c0dffc9c7b4c89ca83/cranelift/codegen/src/legalizer/boundary.rs#L591-L592">link</a></li>
</ul>
</li>
<li>
<p>In the new x64 and aarch64 backends, the <code>ArgumentExtension</code> unconditionally results in extend ops (from <code>ABIMachineSpec::gen_extend()</code>) if <code>Uext</code> or <code>Sext</code>: <a href="https://github.com/bytecodealliance/wasmtime/blob/5ab7b4aa7fdf2ec00d0c04c0dffc9c7b4c89ca83/cranelift/codegen/src/machinst/abi_impl.rs#L1202-L1218">link</a></p>
</li>
</ul>
<p>So the doc-comment spec is somewhat ambiguous, but all three backends currently treat the extension mode as a mandatory request (always extend if specified), so it's certainly the lowest-overhead choice to keep that definition. And, given that we have other Cranelift users out-of-tree, we should consider it a public interface and be hesitant to change it.</p>
<hr>
<p>I think I understand the difficulty here, though: it seems that in the past, the most common use (or at least the initial driving use) of this feature was SpiderMonkey's ABI, for which the environment definition could attach the required extension modes because it controls generation of signatures and callsite IR. No "vanilla" system ABI has had this requirement yet, so for other environments, we have no way to infer the signedness of the value once we get to the backend, as this has to come from the frontend (as you say).</p>
<p>That said: at least for the <code>cranelift-wasm</code> crate and Wasmtime, we don't have a signed-<code>I32</code> type so I'm curious where the signedness may come from. In this patch, we're just unconditionally adding a <code>uext</code> attribute. Is the concern for other frontends, with the assumption that they will (also?) add their own sext/uext attributes?</p>
<p>If we truly need a notion of signedness for some ABIs to be implemented properly, then we can definitely discuss how to get this -- perhaps a signedness bit on types. That would need a wider discussion, of course. Anyone else have thoughts on this?</p>
</blockquote>



<a name="215489079"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20Issue%20%232354%20Add%20extension%20marker%20to%20i32%20argume.../near/215489079" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20Issue.20.232354.20Add.20extension.20marker.20to.20i32.20argume.2E.2E.2E.html#215489079">(Nov 03 2020 at 17:56)</a>:</h4>
<p>cfallin edited a <a href="https://github.com/bytecodealliance/wasmtime/pull/2354#issuecomment-721284100">comment</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/2354">Issue #2354</a>:</p>
<blockquote>
<p>Interesting -- this doesn't match the definition that I had understood (namely, that the <code>ArgumentExtension</code> if present indicates that the argument <em>must</em> be extended as specified), so I went digging a bit:</p>
<ul>
<li>
<p>In the doc-comment for <code>ArgumentExtension</code>, all that is specified is "on some architectures, small integer function arguments are extended" (<a href="https://github.com/bytecodealliance/wasmtime/blob/5ab7b4aa7fdf2ec00d0c04c0dffc9c7b4c89ca83/cranelift/codegen/src/ir/extfunc.rs#L257-L260">link</a>) -- somewhat ambiguous, so let's look at what backends do...</p>
</li>
<li>
<p>In the current (production) x86 backend, it seems that <code>uext</code> and <code>sext</code> will unconditionally result in extend ops:</p>
<ul>
<li>In the x86 ABI code, the <code>ArgumentExtension</code> value is translated into a <code>ValueConversion</code>: <a href="https://github.com/bytecodealliance/wasmtime/blob/5ab7b4aa7fdf2ec00d0c04c0dffc9c7b4c89ca83/cranelift/codegen/src/isa/x86/abi.rs#L149-L153">link</a></li>
<li>Then, in the legalizer, this <code>ValueConversion</code> results in a <code>uextend</code> or <code>sextend</code> op: <a href="https://github.com/bytecodealliance/wasmtime/blob/5ab7b4aa7fdf2ec00d0c04c0dffc9c7b4c89ca83/cranelift/codegen/src/legalizer/boundary.rs#L591-L592">link</a></li>
</ul>
</li>
<li>
<p>In the new x64 and aarch64 backends, the <code>ArgumentExtension</code> unconditionally results in extend ops (from <code>ABIMachineSpec::gen_extend()</code>) if <code>Uext</code> or <code>Sext</code>: <a href="https://github.com/bytecodealliance/wasmtime/blob/5ab7b4aa7fdf2ec00d0c04c0dffc9c7b4c89ca83/cranelift/codegen/src/machinst/abi_impl.rs#L1202-L1218">link</a></p>
</li>
</ul>
<p>So the doc-comment spec is somewhat ambiguous, but all three backends currently treat the extension mode as a mandatory request (always extend if specified), so it's certainly the lowest-overhead choice to keep that definition. And, given that we have other Cranelift users out-of-tree, we should consider it a public interface and be hesitant to change it.</p>
<hr>
<p>I think I understand the difficulty here, though: it seems that in the past, the most common use (or at least the initial driving use) of this feature was SpiderMonkey's ABI, for which the environment definition could attach the required extension modes because it controls generation of signatures and callsite IR. No "vanilla" system ABI has had this requirement yet, so for other environments, we have no way to infer the signedness of the value once we get to the backend, as this has to come from the frontend (as you say).</p>
<p>That said: at least for the <code>cranelift-wasm</code> crate and Wasmtime, we don't have a signed-<code>I32</code> type so I'm curious where the signedness may come from. In this patch, we're just unconditionally adding a <code>uext</code> attribute. Is the concern for other frontends, with the assumption that they will (also?) add their own sext/uext attributes? (Edit: @bjorn3, how does <code>cg_clif</code> handle signedness -- does it add uext/sext attributes?)</p>
<p>If we truly need a notion of signedness for some ABIs to be implemented properly, then we can definitely discuss how to get this -- perhaps a signedness bit on types. That would need a wider discussion, of course. Anyone else have thoughts on this?</p>
</blockquote>



<a name="215489786"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20Issue%20%232354%20Add%20extension%20marker%20to%20i32%20argume.../near/215489786" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20Issue.20.232354.20Add.20extension.20marker.20to.20i32.20argume.2E.2E.2E.html#215489786">(Nov 03 2020 at 18:02)</a>:</h4>
<p>bjorn3 <a href="https://github.com/bytecodealliance/wasmtime/pull/2354#issuecomment-721288949">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/2354">Issue #2354</a>:</p>
<blockquote>
<p>The LLVM LangRef states:</p>
<p><a href="https://llvm.org/docs/LangRef.html#parameter-attributes">https://llvm.org/docs/LangRef.html#parameter-attributes</a></p>
<blockquote>
<p>&lt;dl&gt;<br>
&lt;dt&gt;zeroext&lt;/dt&gt;<br>
&lt;dd&gt;This indicates to the code generator that the parameter or return value should be zero-extended to the extent required by the target’s ABI by the caller (for a parameter) or the callee (for a return value).&lt;/dd&gt;<br>
&lt;dt&gt;signext&lt;/dt&gt;<br>
&lt;dd&gt;This indicates to the code generator that the parameter or return value should be sign-extended to the extent required by the target’s ABI (which is usually 32-bits) by the caller (for a parameter) or the callee (for a return value).&lt;/dd&gt;<br>
&lt;/dl&gt;</p>
</blockquote>
<p>Unnecessarily extending the arguments shouldn't be observable unless you use a different type on the caller and callee side, which risks causing trouble on some architectures anyway. For this reason I wouldn't consider stopping with unnecessary extension a breaking change.</p>
<blockquote>
<p>Edit: @bjorn3, how does cg_clif handle signedness -- does it add uext/sext attributes?</p>
</blockquote>
<p>I don't handle this part of the C abi yet like many other things. I just never add uext/sext.</p>
<blockquote>
<p>If we truly need a notion of signedness for some ABIs to be implemented properly, then we can definitely discuss how to get this -- perhaps a signedness bit on types. That would need a wider discussion, of course. Anyone else have thoughts on this?</p>
</blockquote>
<p>LLVM doesn't have separate types for unsigned and signed integers either.</p>
</blockquote>



<a name="215492112"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20Issue%20%232354%20Add%20extension%20marker%20to%20i32%20argume.../near/215492112" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20Issue.20.232354.20Add.20extension.20marker.20to.20i32.20argume.2E.2E.2E.html#215492112">(Nov 03 2020 at 18:20)</a>:</h4>
<p>cfallin <a href="https://github.com/bytecodealliance/wasmtime/pull/2354#issuecomment-721298175">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/2354">Issue #2354</a>:</p>
<blockquote>
<p>Interesting; thanks for the LLVM reference -- a lot of valuable experience to learn from in their design decisions.</p>
<p>From first principles, I agree that it should actually make sense to have an "if you need to extend this, here is the signedness" bit of information on parameters; "always extend in this way" makes less sense, because it is hoisting the question of "do we extend", which is an ABI-level question, up to the machine-independent IR. So I'm coming to agree that we should align with that.</p>
<p>That said, the two concerns are:</p>
<ul>
<li>Performance: in the current backends, we always do the extends if extend-mode is specified. So we would want to alter this logic to "only extend if ABI requires it". But...</li>
<li>Compatibility: this <em>is</em> a breaking change in the sense that a user could currently be using the default ABI (e.g. <code>SystemV</code>), yet specifying extend-modes, and relying on the behavior that we always extend. The only case I am currently aware of where extensions matter is in SpiderMonkey, where we specify a different ABI anyway, so that's fine; but perhaps there are other uses for which this is not true.</li>
</ul>
<p>So, to accept this patch, I'd want to do the following things first:</p>
<ul>
<li>Verify that we don't have other users (frontends that generate CLIF directly, rather than through the wasm crate) that would rely on the current always-extend behavior.</li>
<li>Alter the behavior in the three backends (current-x86, new-x64, aarch64) to extend only in the <code>Baldrdash</code> ABI, so we don't have performance regressions.</li>
</ul>
<p>I can help with the latter -- it should be a pretty easy change. As to the former -- @sunfishcode or others, are we aware of any frontends that might break if we no longer unconditionally extend with sext/uext attributes are present?</p>
</blockquote>



<a name="215495263"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20Issue%20%232354%20Add%20extension%20marker%20to%20i32%20argume.../near/215495263" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20Issue.20.232354.20Add.20extension.20marker.20to.20i32.20argume.2E.2E.2E.html#215495263">(Nov 03 2020 at 18:46)</a>:</h4>
<p>bjorn3 <a href="https://github.com/bytecodealliance/wasmtime/pull/2354#issuecomment-721310622">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/2354">Issue #2354</a>:</p>
<blockquote>
<p>I went through all mentions of <code>ArgumentExtension</code> on github. After ignoring all vendorings of cranelift, I found the following uses:</p>
<p><a href="https://github.com/aranajhonny/lucet-membrane/blob/0b7598bf3fa24fbea5d7012331d9115cc3e5f55a/lucetc/src/types.rs">https://github.com/aranajhonny/lucet-membrane/blob/0b7598bf3fa24fbea5d7012331d9115cc3e5f55a/lucetc/src/types.rs</a></p>
<p><a href="https://github.com/aranajhonny/private-wasmer/blob/aa8b968d40cf998845643ce02f1a40c098b139ff/lib/clif-backend/src/trampoline.rs">https://github.com/aranajhonny/private-wasmer/blob/aa8b968d40cf998845643ce02f1a40c098b139ff/lib/clif-backend/src/trampoline.rs</a></p>
<p><a href="https://github.com/nebulet/nebulet/blob/f171d5ee81306e536f60af3617a12d82c5918e69/src/wasm/mod.rs">https://github.com/nebulet/nebulet/blob/f171d5ee81306e536f60af3617a12d82c5918e69/src/wasm/mod.rs</a></p>
<p>All use only <code>ArgumentExtension::None</code>.</p>
</blockquote>



<a name="215495421"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20Issue%20%232354%20Add%20extension%20marker%20to%20i32%20argume.../near/215495421" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20Issue.20.232354.20Add.20extension.20marker.20to.20i32.20argume.2E.2E.2E.html#215495421">(Nov 03 2020 at 18:48)</a>:</h4>
<p>bjorn3 edited a <a href="https://github.com/bytecodealliance/wasmtime/pull/2354#issuecomment-721310622">comment</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/2354">Issue #2354</a>:</p>
<blockquote>
<p>I went through all mentions of <code>ArgumentExtension</code> on github. After ignoring all vendorings of cranelift, I found the following uses:</p>
<p><a href="https://github.com/aranajhonny/lucet-membrane/blob/0b7598bf3fa24fbea5d7012331d9115cc3e5f55a/lucetc/src/types.rs">https://github.com/aranajhonny/lucet-membrane/blob/0b7598bf3fa24fbea5d7012331d9115cc3e5f55a/lucetc/src/types.rs</a></p>
<p><a href="https://github.com/aranajhonny/private-wasmer/blob/aa8b968d40cf998845643ce02f1a40c098b139ff/lib/clif-backend/src/trampoline.rs">https://github.com/aranajhonny/private-wasmer/blob/aa8b968d40cf998845643ce02f1a40c098b139ff/lib/clif-backend/src/trampoline.rs</a></p>
<p><a href="https://github.com/nebulet/nebulet/blob/f171d5ee81306e536f60af3617a12d82c5918e69/src/wasm/mod.rs">https://github.com/nebulet/nebulet/blob/f171d5ee81306e536f60af3617a12d82c5918e69/src/wasm/mod.rs</a></p>
<p>All use only <code>ArgumentExtension::None</code>.</p>
<p>Edit: that doesn't include <code>.uext()</code> and <code>.sext()</code>.</p>
</blockquote>



<a name="215495525"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20Issue%20%232354%20Add%20extension%20marker%20to%20i32%20argume.../near/215495525" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20Issue.20.232354.20Add.20extension.20marker.20to.20i32.20argume.2E.2E.2E.html#215495525">(Nov 03 2020 at 18:49)</a>:</h4>
<p>bjorn3 <a href="https://github.com/bytecodealliance/wasmtime/pull/2354#issuecomment-721311843">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/2354">Issue #2354</a>:</p>
<blockquote>
<p>In the subset of the crates that <a href="http://grep.app">grep.app</a> searches, <code>.uext()</code> and <code>.sext()</code> are only used inside a test of Cranelift.</p>
</blockquote>



<a name="215495964"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20Issue%20%232354%20Add%20extension%20marker%20to%20i32%20argume.../near/215495964" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20Issue.20.232354.20Add.20extension.20marker.20to.20i32.20argume.2E.2E.2E.html#215495964">(Nov 03 2020 at 18:53)</a>:</h4>
<p>uweigand <a href="https://github.com/bytecodealliance/wasmtime/pull/2354#issuecomment-721313757">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/2354">Issue #2354</a>:</p>
<blockquote>
<blockquote>
<p>The only case I am currently aware of where extensions matter is in SpiderMonkey, where we specify a different ABI anyway, so that's fine; but perhaps there are other uses for which this is not true.</p>
</blockquote>
<p>Actually, many 64-bit platform ABIs require extension to the full word size.  In addition to IBM Z (which is my problem), this is true for Power, Riscv, Mips, Sparc (just at first glance).   The only 64-bit platforms that do <em>not</em> require extension to 64 bits are x86_64 and aarch64 as far as I'm aware. (And note that even those still require extension for <em>smaller</em> types to at least 32 bits.)</p>
<blockquote>
<p>That said: at least for the cranelift-wasm crate and Wasmtime, we don't have a signed-I32 type so I'm curious where the signedness may come from. In this patch, we're just unconditionally adding a uext attribute. Is the concern for other frontends, with the assumption that they will (also?) add their own sext/uext attributes?</p>
</blockquote>
<p>I guess I could fix my problem for now by always doing an unsigned extend in the backend, if wasmtime types are always unsigned.  That just doesn't seem quite right if we want to consider other uses of cranelift going forward (e.g. I understand there's a Rust frontend in progress?).</p>
<p>Going back from the general discussion to this specific patch, it is actually not a very far-reaching change in that it only affects calls to certain external builtin functions.  (For calls strictly between two wasmtime functions, it does not really matter whether we adhere 100% to the platform ABI, as long as both sides agree.  So I haven't really bothered to change all generated calls to do the extension.)</p>
<p>Therefore, I'm not sure that any performance impact due to unnecessary extensions on just those builtin calls would actually be measurable on either x86_64 or aarch64.  So it may not even be immediately required to follow up with back-end changes there ...</p>
</blockquote>



<a name="215497107"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20Issue%20%232354%20Add%20extension%20marker%20to%20i32%20argume.../near/215497107" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20Issue.20.232354.20Add.20extension.20marker.20to.20i32.20argume.2E.2E.2E.html#215497107">(Nov 03 2020 at 19:02)</a>:</h4>
<p>bjorn3 <a href="https://github.com/bytecodealliance/wasmtime/pull/2354#issuecomment-721318268">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/2354">Issue #2354</a>:</p>
<blockquote>
<blockquote>
<p>(e.g. I understand there's a Rust frontend in progress?).</p>
</blockquote>
<p><span aria-label="wave" class="emoji emoji-1f44b" role="img" title="wave">:wave:</span></p>
<p>By the way I noticed that you only applied this change to the <code>cranelift-tools</code> crate, not Wasmtime or Cranelift itself.</p>
</blockquote>



<a name="215498214"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20Issue%20%232354%20Add%20extension%20marker%20to%20i32%20argume.../near/215498214" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20Issue.20.232354.20Add.20extension.20marker.20to.20i32.20argume.2E.2E.2E.html#215498214">(Nov 03 2020 at 19:12)</a>:</h4>
<p>uweigand <a href="https://github.com/bytecodealliance/wasmtime/pull/2354#issuecomment-721323045">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/2354">Issue #2354</a>:</p>
<blockquote>
<blockquote>
<blockquote>
<p>(e.g. I understand there's a Rust frontend in progress?).</p>
</blockquote>
<p>wave</p>
</blockquote>
<p>Ah, I see :-)</p>
<blockquote>
<p>By the way I noticed that you only applied this change to the <code>cranelift-tools</code> crate, not Wasmtime or Cranelift itself.</p>
</blockquote>
<p>As I said in my reply to Chris, I didn't systematically attempt to change <em>all</em> places that generate function call IR, only those where the call interfaces between wasmtime-generated code and some external platform code -- those are the only places where this makes a real difference (without this change, some wasm tests will fail or even crash on my platform).</p>
</blockquote>



<a name="215498422"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20Issue%20%232354%20Add%20extension%20marker%20to%20i32%20argume.../near/215498422" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20Issue.20.232354.20Add.20extension.20marker.20to.20i32.20argume.2E.2E.2E.html#215498422">(Nov 03 2020 at 19:14)</a>:</h4>
<p>cfallin <a href="https://github.com/bytecodealliance/wasmtime/pull/2354#issuecomment-721324008">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/2354">Issue #2354</a>:</p>
<blockquote>
<p>@bjorn3, thanks for doing that survey, and for creating the issue in the saltwater project!</p>
<p>@uweigand: I'll plan to update the extend behavior in the backends, likely tomorrow or Thursday (I actually have a day off today; I should probably disappear soon <span aria-label="smile" class="emoji emoji-1f642" role="img" title="smile">:smile:</span>). As per my latest message above, I agree that we should align to the "only extend if ABI specifies" behavior. I think it's fine to land this patch once the backends are updated (I'm hesitant to do so beforehand as even small perf regressions can be problematic for some users).</p>
<p>Anyway, thanks for the prodding on the extend semantics -- I feel like we're in a much clearer place now! I'll update the doc comment as well so that this is more precisely specified going forward.</p>
</blockquote>



<a name="215498478"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20Issue%20%232354%20Add%20extension%20marker%20to%20i32%20argume.../near/215498478" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20Issue.20.232354.20Add.20extension.20marker.20to.20i32.20argume.2E.2E.2E.html#215498478">(Nov 03 2020 at 19:15)</a>:</h4>
<p>cfallin edited a <a href="https://github.com/bytecodealliance/wasmtime/pull/2354#issuecomment-721324008">comment</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/2354">Issue #2354</a>:</p>
<blockquote>
<p>@bjorn3, thanks for doing that survey, and for creating the issue in the saltwater project!</p>
<p>@uweigand: I'll plan to update the extend behavior in the backends, likely tomorrow or Thursday (I actually have a day off today; I should probably disappear soon :-) ). As per my latest message above, I agree that we should align to the "only extend if ABI specifies" behavior. I think it's fine to land this patch once the backends are updated (I'm hesitant to do so beforehand as even small perf regressions can be problematic for some users).</p>
<p>Anyway, thanks for the prodding on the extend semantics -- I feel like we're in a much clearer place now! I'll update the doc comment as well so that this is more precisely specified going forward.</p>
</blockquote>



<a name="215499262"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20Issue%20%232354%20Add%20extension%20marker%20to%20i32%20argume.../near/215499262" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20Issue.20.232354.20Add.20extension.20marker.20to.20i32.20argume.2E.2E.2E.html#215499262">(Nov 03 2020 at 19:22)</a>:</h4>
<p>uweigand <a href="https://github.com/bytecodealliance/wasmtime/pull/2354#issuecomment-721327882">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/2354">Issue #2354</a>:</p>
<blockquote>
<p>@cfallin Thanks!</p>
</blockquote>



<a name="215501851"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20Issue%20%232354%20Add%20extension%20marker%20to%20i32%20argume.../near/215501851" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20Issue.20.232354.20Add.20extension.20marker.20to.20i32.20argume.2E.2E.2E.html#215501851">(Nov 03 2020 at 19:48)</a>:</h4>
<p>bjorn3 <a href="https://github.com/bytecodealliance/wasmtime/pull/2354#issuecomment-721340171">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/2354">Issue #2354</a>:</p>
<blockquote>
<blockquote>
<p>As I said in my reply to Chris, I didn't systematically attempt to change all places that generate function call IR, only those where the call interfaces between wasmtime-generated code and some external platform code -- those are the only places where this makes a real difference (without this change, some wasm tests will fail or even crash on my platform).</p>
</blockquote>
<p>You only changed the cranelift-tools crate, which exists for testing purposes only. It isn't used by Wasmtime. You probably also need to change it in Wasmtime to make interfacing between wasm and native code work.</p>
<blockquote>
<p>Is the concern for other frontends, with the assumption that they will (also?) add their own sext/uext attributes?</p>
</blockquote>
<p>Any change to Wasmtime will not affect other users of Cranelift. Only if you were to change Cranelift to default to a certain extension mode, would it affect other frontends.</p>
</blockquote>



<a name="215589457"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20Issue%20%232354%20Add%20extension%20marker%20to%20i32%20argume.../near/215589457" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20Issue.20.232354.20Add.20extension.20marker.20to.20i32.20argume.2E.2E.2E.html#215589457">(Nov 04 2020 at 14:41)</a>:</h4>
<p>uweigand <a href="https://github.com/bytecodealliance/wasmtime/pull/2354#issuecomment-721771824">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/2354">Issue #2354</a>:</p>
<blockquote>
<blockquote>
<p>You only changed the cranelift-tools crate, which exists for testing purposes only. It isn't used by Wasmtime. You probably also need to change it in Wasmtime to make interfacing between wasm and native code work.</p>
</blockquote>
<p>Maybe I'm confused.  My understanding is that this patch touches crates/cranelift/src/func_environ.rs, which exports routines to emit calls to builtin functions (using the AbiParam specs I'm modifying), e.g. the translate_memory_grow routine.  This is part of a clause<br>
<code>impl&lt;'module_environment&gt; cranelift_wasm::FuncEnvironment for FuncEnvironment&lt;'module_environment&gt; {
</code><br>
and the translate_memory_grow routine in that FuncEnvironment is then used from cranelift/wasm/src/code_translator.rs to implement the wasm memory.grow primitive.</p>
<p>Is that not correct?</p>
</blockquote>



<a name="215598258"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20Issue%20%232354%20Add%20extension%20marker%20to%20i32%20argume.../near/215598258" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20Issue.20.232354.20Add.20extension.20marker.20to.20i32.20argume.2E.2E.2E.html#215598258">(Nov 04 2020 at 15:38)</a>:</h4>
<p>bjorn3 <a href="https://github.com/bytecodealliance/wasmtime/pull/2354#issuecomment-721805731">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/2354">Issue #2354</a>:</p>
<blockquote>
<blockquote>
<p>crates/cranelift/src/func_environ.rs</p>
</blockquote>
<p>I thought it was <code>cranelift/src/...</code>. My bad. This will indeed apply the change to Wasmtime.</p>
</blockquote>



<hr><p>Last updated: Jan 20 2025 at 06:04 UTC</p>
</html>