<html>
<head><meta charset="utf-8"><title>wasmtime / Issue #2864 writev only outputs first paramete... · git-wasmtime · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/index.html">git-wasmtime</a></h2>
<h3>Topic: <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20Issue.20.232864.20writev.20only.20outputs.20first.20paramete.2E.2E.2E.html">wasmtime / Issue #2864 writev only outputs first paramete...</a></h3>

<hr>

<base href="https://bytecodealliance.zulipchat.com">

<head><link href="https://bytecodealliance.github.io/zulip-archive/style.css" rel="stylesheet"></head>

<a name="236553551"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20Issue%20%232864%20writev%20only%20outputs%20first%20paramete.../near/236553551" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20Issue.20.232864.20writev.20only.20outputs.20first.20paramete.2E.2E.2E.html#236553551">(Apr 28 2021 at 18:12)</a>:</h4>
<p>expnkx labeled <a href="https://github.com/bytecodealliance/wasmtime/issues/2864">Issue #2864</a>:</p>
<blockquote>
<p>Thanks for filing a bug report! Please fill out the TODOs below.</p>
<h3>Test Case</h3>
<p>#include&lt;fast_io.h&gt;</p>
<p>int main()<br>
{<br>
    print(fast_io::out(),"Hello World\n",fast_io::posix_clock_gettime(fast_io::posix_clock_id::realtime));<br>
}</p>
<h3>Expected Results</h3>
<p>It should output all results.</p>
<h3>Actual Results</h3>
<p>It only outputs the first one</p>
<h3>Versions and Environment</h3>
<p>Wasmtime version or commit: main</p>
<p>Operating system: windows</p>
<p>Architecture: x86_64</p>
<h3>Extra Info</h3>
<p>-stdlib=libstdc++</p>
</blockquote>



<a name="236553553"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20Issue%20%232864%20writev%20only%20outputs%20first%20paramete.../near/236553553" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20Issue.20.232864.20writev.20only.20outputs.20first.20paramete.2E.2E.2E.html#236553553">(Apr 28 2021 at 18:12)</a>:</h4>
<p>expnkx opened <a href="https://github.com/bytecodealliance/wasmtime/issues/2864">Issue #2864</a>:</p>
<blockquote>
<p>Thanks for filing a bug report! Please fill out the TODOs below.</p>
<h3>Test Case</h3>
<p>#include&lt;fast_io.h&gt;</p>
<p>int main()<br>
{<br>
    print(fast_io::out(),"Hello World\n",fast_io::posix_clock_gettime(fast_io::posix_clock_id::realtime));<br>
}</p>
<h3>Expected Results</h3>
<p>It should output all results.</p>
<h3>Actual Results</h3>
<p>It only outputs the first one</p>
<h3>Versions and Environment</h3>
<p>Wasmtime version or commit: main</p>
<p>Operating system: windows</p>
<p>Architecture: x86_64</p>
<h3>Extra Info</h3>
<p>-stdlib=libstdc++</p>
</blockquote>



<a name="236553650"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20Issue%20%232864%20writev%20only%20outputs%20first%20paramete.../near/236553650" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20Issue.20.232864.20writev.20only.20outputs.20first.20paramete.2E.2E.2E.html#236553650">(Apr 28 2021 at 18:13)</a>:</h4>
<p>expnkx edited <a href="https://github.com/bytecodealliance/wasmtime/issues/2864">Issue #2864</a>:</p>
<blockquote>
<p>Thanks for filing a bug report! Please fill out the TODOs below.</p>
<h3>Test Case</h3>
<p><a href="https://github.com/expnkx/fast_io/blob/02cc01ceea5cba4a40e35dc4ae1fd64e68148e2d/include/fast_io_hosted/platforms/posix.h#L1512">https://github.com/expnkx/fast_io/blob/02cc01ceea5cba4a40e35dc4ae1fd64e68148e2d/include/fast_io_hosted/platforms/posix.h#L1512</a></p>
<p>#include&lt;fast_io.h&gt;</p>
<p>int main()<br>
{<br>
    print(fast_io::out(),"Hello World\n",fast_io::posix_clock_gettime(fast_io::posix_clock_id::realtime));<br>
}</p>
<h3>Expected Results</h3>
<p>It should output all results.</p>
<h3>Actual Results</h3>
<p>It only outputs the first one</p>
<h3>Versions and Environment</h3>
<p>Wasmtime version or commit: main</p>
<p>Operating system: windows</p>
<p>Architecture: x86_64</p>
<h3>Extra Info</h3>
<p>-stdlib=libstdc++</p>
</blockquote>



<a name="236553667"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20Issue%20%232864%20writev%20only%20outputs%20first%20paramete.../near/236553667" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20Issue.20.232864.20writev.20only.20outputs.20first.20paramete.2E.2E.2E.html#236553667">(Apr 28 2021 at 18:13)</a>:</h4>
<p>expnkx edited <a href="https://github.com/bytecodealliance/wasmtime/issues/2864">Issue #2864</a>:</p>
<blockquote>
<p>Thanks for filing a bug report! Please fill out the TODOs below.</p>
<h3>Test Case</h3>
<p><a href="https://github.com/expnkx/fast_io/blob/02cc01ceea5cba4a40e35dc4ae1fd64e68148e2d/include/fast_io_hosted/platforms/posix.h#L1512">https://github.com/expnkx/fast_io/blob/02cc01ceea5cba4a40e35dc4ae1fd64e68148e2d/include/fast_io_hosted/platforms/posix.h#L1512</a></p>
<div class="codehilite" data-code-language="C++"><pre><span></span><code><span class="cp">#include</span><span class="cpf">&lt;fast_io.h&gt;</span><span class="cp"></span>

<span class="kt">int</span> <span class="nf">main</span><span class="p">()</span>
<span class="p">{</span>
    <span class="n">print</span><span class="p">(</span><span class="n">fast_io</span><span class="o">::</span><span class="n">out</span><span class="p">(),</span><span class="s">"Hello World</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span><span class="n">fast_io</span><span class="o">::</span><span class="n">posix_clock_gettime</span><span class="p">(</span><span class="n">fast_io</span><span class="o">::</span><span class="n">posix_clock_id</span><span class="o">::</span><span class="n">realtime</span><span class="p">));</span>
<span class="p">}</span>
</code></pre></div>
<h3>Expected Results</h3>
<p>It should output all results.</p>
<h3>Actual Results</h3>
<p>It only outputs the first one</p>
<h3>Versions and Environment</h3>
<p>Wasmtime version or commit: main</p>
<p>Operating system: windows</p>
<p>Architecture: x86_64</p>
<h3>Extra Info</h3>
<p>-stdlib=libstdc++</p>
</blockquote>



<a name="236554738"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20Issue%20%232864%20writev%20only%20outputs%20first%20paramete.../near/236554738" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20Issue.20.232864.20writev.20only.20outputs.20first.20paramete.2E.2E.2E.html#236554738">(Apr 28 2021 at 18:21)</a>:</h4>
<p>sunfishcode <a href="https://github.com/bytecodealliance/wasmtime/issues/2864#issuecomment-828676944">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/2864">Issue #2864</a>:</p>
<blockquote>
<p>As with POSIX <code>writev</code>, <code>__wasi_fd_write</code> may write fewer bytes than requested. It should return the number of bytes read, so that you can call it again with the unwritten portion of the buffer(s).</p>
</blockquote>



<a name="236575060"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20Issue%20%232864%20writev%20only%20outputs%20first%20paramete.../near/236575060" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20Issue.20.232864.20writev.20only.20outputs.20first.20paramete.2E.2E.2E.html#236575060">(Apr 28 2021 at 20:44)</a>:</h4>
<p>expnkx <a href="https://github.com/bytecodealliance/wasmtime/issues/2864#issuecomment-828765181">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/2864">Issue #2864</a>:</p>
<blockquote>
<blockquote>
<p>As with POSIX <code>writev</code>, <code>__wasi_fd_write</code> may write fewer bytes than requested. It should return the number of bytes read, so that you can call it again with the unwritten portion of the buffer(s).</p>
</blockquote>
<p>The problem is that these approaches break the atomicity of syscalls. And it might in a situation it only writes zero-bytes example. Also it leads to binary bloat.</p>
<p>It requires a fix in wasmtime tbh.</p>
<p><a href="https://github.com/expnkx/fast_io/blob/725695664091bc4e8fbb05df446aaad93642bbf5/include/fast_io_hosted/platforms/win32.h#L613">https://github.com/expnkx/fast_io/blob/725695664091bc4e8fbb05df446aaad93642bbf5/include/fast_io_hosted/platforms/win32.h#L613</a><br>
Here is my implementation on windows. Use LockFile to lock the file</p>
</blockquote>



<a name="236575102"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20Issue%20%232864%20writev%20only%20outputs%20first%20paramete.../near/236575102" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20Issue.20.232864.20writev.20only.20outputs.20first.20paramete.2E.2E.2E.html#236575102">(Apr 28 2021 at 20:44)</a>:</h4>
<p>expnkx edited a <a href="https://github.com/bytecodealliance/wasmtime/issues/2864#issuecomment-828765181">comment</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/2864">Issue #2864</a>:</p>
<blockquote>
<blockquote>
<p>As with POSIX <code>writev</code>, <code>__wasi_fd_write</code> may write fewer bytes than requested. It should return the number of bytes read, so that you can call it again with the unwritten portion of the buffer(s).</p>
</blockquote>
<p>The problem is that these approaches break the atomicity of syscalls. And it might in a situation it only writes zero-bytes example, the users have no idea how to deal with it. Also, it leads to binary bloat.</p>
<p>It requires a fix in wasmtime tbh.</p>
<p><a href="https://github.com/expnkx/fast_io/blob/725695664091bc4e8fbb05df446aaad93642bbf5/include/fast_io_hosted/platforms/win32.h#L613">https://github.com/expnkx/fast_io/blob/725695664091bc4e8fbb05df446aaad93642bbf5/include/fast_io_hosted/platforms/win32.h#L613</a><br>
Here is my implementation on windows. Use LockFile to lock the file</p>
</blockquote>



<a name="236576303"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20Issue%20%232864%20writev%20only%20outputs%20first%20paramete.../near/236576303" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20Issue.20.232864.20writev.20only.20outputs.20first.20paramete.2E.2E.2E.html#236576303">(Apr 28 2021 at 20:53)</a>:</h4>
<p>bjorn3 <a href="https://github.com/bytecodealliance/wasmtime/issues/2864#issuecomment-828772297">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/2864">Issue #2864</a>:</p>
<blockquote>
<p>What if part of the data could be written and then an error is returned? It would be incorrect to suggest that no data was written by returning an error. Returning only how many bytes werw actually written would still require the loop. The error could be EWOULDBLOCK for example which in case of async usage indicates that it will be possible in the future to write more data. In that case the application needs to know how many bytes were written and try again later. Moving thr write loop into the write/writev call also doesn't match the expectations of pretty much every unix application.</p>
</blockquote>



<a name="236576860"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20Issue%20%232864%20writev%20only%20outputs%20first%20paramete.../near/236576860" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20Issue.20.232864.20writev.20only.20outputs.20first.20paramete.2E.2E.2E.html#236576860">(Apr 28 2021 at 20:56)</a>:</h4>
<p>bjorn3 <a href="https://github.com/bytecodealliance/wasmtime/issues/2864#issuecomment-828774528">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/2864">Issue #2864</a>:</p>
<blockquote>
<blockquote>
<p>And it might in a situation it only writes zero-bytes example, the users have no idea how to deal with it.</p>
</blockquote>
<p>I don't think that is possible. For read itbis possible though and indicates EOF.</p>
</blockquote>



<a name="236577153"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20Issue%20%232864%20writev%20only%20outputs%20first%20paramete.../near/236577153" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20Issue.20.232864.20writev.20only.20outputs.20first.20paramete.2E.2E.2E.html#236577153">(Apr 28 2021 at 20:59)</a>:</h4>
<p>expnkx <a href="https://github.com/bytecodealliance/wasmtime/issues/2864#issuecomment-828776095">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/2864">Issue #2864</a>:</p>
<blockquote>
<blockquote>
<blockquote>
<p>And it might in a situation it only writes zero-bytes example, the users have no idea how to deal with it.</p>
</blockquote>
<p>I don't think that is possible. For read itbis possible though and indicates EOF.</p>
</blockquote>
<p>This is not readv or read. This is writev. It does not mean it is EOF.</p>
</blockquote>



<a name="236577226"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20Issue%20%232864%20writev%20only%20outputs%20first%20paramete.../near/236577226" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20Issue.20.232864.20writev.20only.20outputs.20first.20paramete.2E.2E.2E.html#236577226">(Apr 28 2021 at 21:00)</a>:</h4>
<p>expnkx edited a <a href="https://github.com/bytecodealliance/wasmtime/issues/2864#issuecomment-828776095">comment</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/2864">Issue #2864</a>:</p>
<blockquote>
<blockquote>
<blockquote>
<p>And it might in a situation it only writes zero-bytes example, the users have no idea how to deal with it.</p>
</blockquote>
<p>I don't think that is possible. For read itbis possible though and indicates EOF.</p>
</blockquote>
<p>This is not readv or read. This is writev. It does not mean it is EOF.<br>
Checking size is very bad idea imo for this since it can lead to block of the process.</p>
</blockquote>



<a name="236577325"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20Issue%20%232864%20writev%20only%20outputs%20first%20paramete.../near/236577325" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20Issue.20.232864.20writev.20only.20outputs.20first.20paramete.2E.2E.2E.html#236577325">(Apr 28 2021 at 21:00)</a>:</h4>
<p>bjorn3 edited a <a href="https://github.com/bytecodealliance/wasmtime/issues/2864#issuecomment-828774528">comment</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/2864">Issue #2864</a>:</p>
<blockquote>
<blockquote>
<p>And it might in a situation it only writes zero-bytes example, the users have no idea how to deal with it.</p>
</blockquote>
<p>I don't think that is possible. For read it is possible though and indicates EOF.</p>
</blockquote>



<a name="236579681"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20Issue%20%232864%20writev%20only%20outputs%20first%20paramete.../near/236579681" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20Issue.20.232864.20writev.20only.20outputs.20first.20paramete.2E.2E.2E.html#236579681">(Apr 28 2021 at 21:08)</a>:</h4>
<p>sunfishcode <a href="https://github.com/bytecodealliance/wasmtime/issues/2864#issuecomment-828781557">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/2864">Issue #2864</a>:</p>
<blockquote>
<p>The code bloat is a consequence of POSIX here; no implementation on a POSIX host can guarantee that it'll write all of all the buffers atomically without being interrupted. There has to be a loop somewhere, and if we follow POSIX, we can't put the loop in the WASI implementation because that would make it non-atomic.</p>
<p>WASI is working on some new I/O facilities which don't follow POSIX as closely, and when those are available we may have other options here. But right now, we have <code>__wasi_fd_write</code> and it does follow POSIX, and POSIX requires you to have a loop if you want all the buffers printed.</p>
</blockquote>



<a name="236580959"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20Issue%20%232864%20writev%20only%20outputs%20first%20paramete.../near/236580959" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20Issue.20.232864.20writev.20only.20outputs.20first.20paramete.2E.2E.2E.html#236580959">(Apr 28 2021 at 21:14)</a>:</h4>
<p>expnkx <a href="https://github.com/bytecodealliance/wasmtime/issues/2864#issuecomment-828784425">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/2864">Issue #2864</a>:</p>
<blockquote>
<blockquote>
<p>The code bloat is a consequence of POSIX here; no implementation on a POSIX host can guarantee that it'll write all of all the buffers atomically without being interrupted. There has to be a loop somewhere, and if we follow POSIX, we can't put the loop in the WASI implementation because that would make it non-atomic.</p>
<p>WASI is working on some new I/O facilities which don't follow POSIX as closely, and when those are available we may have other options here. But right now, we have <code>__wasi_fd_write</code> and it does follow POSIX, and POSIX requires you to have a loop if you want all the buffers printed.</p>
</blockquote>
<p>this has nothing to do with the code works on Linux but not on windows. Windows can work as long as you lock the file.<br>
It is absolutely the project's fault, not POSIX. POSIX never said you can provide a buggy implementation.</p>
</blockquote>



<a name="236581131"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20Issue%20%232864%20writev%20only%20outputs%20first%20paramete.../near/236581131" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20Issue.20.232864.20writev.20only.20outputs.20first.20paramete.2E.2E.2E.html#236581131">(Apr 28 2021 at 21:14)</a>:</h4>
<p>expnkx edited a <a href="https://github.com/bytecodealliance/wasmtime/issues/2864#issuecomment-828784425">comment</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/2864">Issue #2864</a>:</p>
<blockquote>
<blockquote>
<p>The code bloat is a consequence of POSIX here; no implementation on a POSIX host can guarantee that it'll write all of all the buffers atomically without being interrupted. There has to be a loop somewhere, and if we follow POSIX, we can't put the loop in the WASI implementation because that would make it non-atomic.</p>
<p>WASI is working on some new I/O facilities which don't follow POSIX as closely, and when those are available we may have other options here. But right now, we have <code>__wasi_fd_write</code> and it does follow POSIX, and POSIX requires you to have a loop if you want all the buffers printed.</p>
</blockquote>
<p>this has nothing to do with the code works on Linux but not on windows. Windows can work as long as you lock the file. I write the same code too and I never have any issues on windows.<br>
It is absolutely the project's fault, not POSIX. POSIX never said you can provide a buggy implementation.</p>
</blockquote>



<a name="236581897"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20Issue%20%232864%20writev%20only%20outputs%20first%20paramete.../near/236581897" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20Issue.20.232864.20writev.20only.20outputs.20first.20paramete.2E.2E.2E.html#236581897">(Apr 28 2021 at 21:18)</a>:</h4>
<p>expnkx edited a <a href="https://github.com/bytecodealliance/wasmtime/issues/2864#issuecomment-828784425">comment</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/2864">Issue #2864</a>:</p>
<blockquote>
<blockquote>
<p>The code bloat is a consequence of POSIX here; no implementation on a POSIX host can guarantee that it'll write all of all the buffers atomically without being interrupted. There has to be a loop somewhere, and if we follow POSIX, we can't put the loop in the WASI implementation because that would make it non-atomic.</p>
<p>WASI is working on some new I/O facilities which don't follow POSIX as closely, and when those are available we may have other options here. But right now, we have <code>__wasi_fd_write</code> and it does follow POSIX, and POSIX requires you to have a loop if you want all the buffers printed.</p>
</blockquote>
<p>this has nothing to do with the code works on Linux but not on windows. Windows can work as long as you lock the file. I write the same code too and I never have any issues on windows.<br>
It is absolutely the project's fault, not POSIX. POSIX never said you can provide a buggy implementation.</p>
<p>Atomicity of syscalls cannot be guaranteed with writev either. an example is a remote console or pipe on Linux. writev is not atomic either. However, file operations beside NFS are always atomic.</p>
</blockquote>



<a name="236582137"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20Issue%20%232864%20writev%20only%20outputs%20first%20paramete.../near/236582137" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20Issue.20.232864.20writev.20only.20outputs.20first.20paramete.2E.2E.2E.html#236582137">(Apr 28 2021 at 21:19)</a>:</h4>
<p>expnkx edited a <a href="https://github.com/bytecodealliance/wasmtime/issues/2864#issuecomment-828784425">comment</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/2864">Issue #2864</a>:</p>
<blockquote>
<blockquote>
<p>The code bloat is a consequence of POSIX here; no implementation on a POSIX host can guarantee that it'll write all of all the buffers atomically without being interrupted. There has to be a loop somewhere, and if we follow POSIX, we can't put the loop in the WASI implementation because that would make it non-atomic.</p>
<p>WASI is working on some new I/O facilities which don't follow POSIX as closely, and when those are available we may have other options here. But right now, we have <code>__wasi_fd_write</code> and it does follow POSIX, and POSIX requires you to have a loop if you want all the buffers printed.</p>
</blockquote>
<p>this has nothing to do with the code works on Linux but not on windows. Windows can work as long as you lock the file. I write the same code too and I never have any issues on windows.<br>
It is absolutely the project's fault, not POSIX. POSIX never said you can provide a buggy implementation.</p>
<p>Atomicity of syscalls cannot be guaranteed with writev either. an example is a remote console or pipe on Linux. writev is not atomic either. However, file operations besides NFS are always atomic.</p>
<p>The code works just fine on windows and it ensures atomicity for file operations.<br>
<a href="https://github.com/expnkx/fast_io/blob/725695664091bc4e8fbb05df446aaad93642bbf5/include/fast_io_hosted/platforms/win32.h#L613">https://github.com/expnkx/fast_io/blob/725695664091bc4e8fbb05df446aaad93642bbf5/include/fast_io_hosted/platforms/win32.h#L613</a></p>
</blockquote>



<a name="236582611"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20Issue%20%232864%20writev%20only%20outputs%20first%20paramete.../near/236582611" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20Issue.20.232864.20writev.20only.20outputs.20first.20paramete.2E.2E.2E.html#236582611">(Apr 28 2021 at 21:21)</a>:</h4>
<p>bjorn3 <a href="https://github.com/bytecodealliance/wasmtime/issues/2864#issuecomment-828788376">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/2864">Issue #2864</a>:</p>
<blockquote>
<p>The implementation is not buggy on windows. It can behave in exactly the same way on linux too. You are just lucky that your the amount of text you are printing is smaller than the pipe buffer size (64k on linux) and that your terminal immediately empties the pipe as soon as data gets received. If you were to write more than 64k at once, you are guaranteed to only get a partial write and when your terminal is too slow, you may get a partial write. This is just the semantics of the write function as defined by POSIX.</p>
</blockquote>



<a name="236584869"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20Issue%20%232864%20writev%20only%20outputs%20first%20paramete.../near/236584869" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20Issue.20.232864.20writev.20only.20outputs.20first.20paramete.2E.2E.2E.html#236584869">(Apr 28 2021 at 21:34)</a>:</h4>
<p>iximeow <a href="https://github.com/bytecodealliance/wasmtime/issues/2864#issuecomment-828795107">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/2864">Issue #2864</a>:</p>
<blockquote>
<blockquote>
<p>And it might in a situation it only writes zero-bytes example</p>
</blockquote>
<p>i also don't think this is possible - wasi-libc, wasmtime, and cap-std just pass the iovecs to Rust's stdlib. the <code>default_write_vectored</code> impl there selects the first _nonempty_ iovec for writing. if <code>write_vectored</code> returns zero it's because the system returned zero; either the iovec selected for writing was zero-length (and all iovs were zero-length), or a non-empty vector was selected for writing and the OS itself wrote zero bytes.</p>
</blockquote>



<a name="236584939"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20Issue%20%232864%20writev%20only%20outputs%20first%20paramete.../near/236584939" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20Issue.20.232864.20writev.20only.20outputs.20first.20paramete.2E.2E.2E.html#236584939">(Apr 28 2021 at 21:35)</a>:</h4>
<p>iximeow edited a <a href="https://github.com/bytecodealliance/wasmtime/issues/2864#issuecomment-828795107">comment</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/2864">Issue #2864</a>:</p>
<blockquote>
<blockquote>
<p>And it might in a situation it only writes zero-bytes example</p>
</blockquote>
<p>i also don't think this is possible - wasi-libc, wasmtime, and cap-std currently just pass the iovecs to Rust's stdlib. the <code>default_write_vectored</code> impl there selects the first _nonempty_ iovec for writing. if <code>write_vectored</code> returns zero it's because the system returned zero; either the iovec selected for writing was zero-length (and all iovs were zero-length), or a non-empty vector was selected for writing and the OS itself wrote zero bytes.</p>
</blockquote>



<a name="236585240"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20Issue%20%232864%20writev%20only%20outputs%20first%20paramete.../near/236585240" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20Issue.20.232864.20writev.20only.20outputs.20first.20paramete.2E.2E.2E.html#236585240">(Apr 28 2021 at 21:38)</a>:</h4>
<p>expnkx <a href="https://github.com/bytecodealliance/wasmtime/issues/2864#issuecomment-828796967">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/2864">Issue #2864</a>:</p>
<blockquote>
<blockquote>
<blockquote>
<p>And it might in a situation it only writes zero-bytes example</p>
</blockquote>
<p>i also don't think this is possible - wasi-libc, wasmtime, and cap-std currently just pass the iovecs to Rust's stdlib. the <code>default_write_vectored</code> impl there selects the first _nonempty_ iovec for writing. if <code>write_vectored</code> returns zero it's because the system returned zero; either the iovec selected for writing was zero-length (and all iovs were zero-length), or a non-empty vector was selected for writing and the OS itself wrote zero bytes.</p>
</blockquote>
<p>wraps around rust's stdlib are not something that is supposed to work with wasm imo. WASI is to abstract OS interface, not to abstract language interface.</p>
</blockquote>



<a name="236585373"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20Issue%20%232864%20writev%20only%20outputs%20first%20paramete.../near/236585373" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20Issue.20.232864.20writev.20only.20outputs.20first.20paramete.2E.2E.2E.html#236585373">(Apr 28 2021 at 21:39)</a>:</h4>
<p>expnkx edited a <a href="https://github.com/bytecodealliance/wasmtime/issues/2864#issuecomment-828796967">comment</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/2864">Issue #2864</a>:</p>
<blockquote>
<blockquote>
<blockquote>
<p>And it might in a situation it only writes zero-bytes example</p>
</blockquote>
<p>i also don't think this is possible - wasi-libc, wasmtime, and cap-std currently just pass the iovecs to Rust's stdlib. the <code>default_write_vectored</code> impl there selects the first _nonempty_ iovec for writing. if <code>write_vectored</code> returns zero it's because the system returned zero; either the iovec selected for writing was zero-length (and all iovs were zero-length), or a non-empty vector was selected for writing and the OS itself wrote zero bytes.</p>
</blockquote>
<p>wraps around rust's stdlib are not something that is supposed to work with wasm imo. WASI is to abstract OS interface, not to abstract language interface.<br>
BTW I do see IO performance bottleneck with using Rust stdlib.</p>
</blockquote>



<a name="236586850"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20Issue%20%232864%20writev%20only%20outputs%20first%20paramete.../near/236586850" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20Issue.20.232864.20writev.20only.20outputs.20first.20paramete.2E.2E.2E.html#236586850">(Apr 28 2021 at 21:54)</a>:</h4>
<p>sunfishcode <a href="https://github.com/bytecodealliance/wasmtime/issues/2864#issuecomment-828805900">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/2864">Issue #2864</a>:</p>
<blockquote>
<p>POSIX <a href="https://pubs.opengroup.org/onlinepubs/007904875/functions/write.html">says</a> "If write() is interrupted by a signal after it successfully writes some data, it shall return the number of bytes written". So even on Linux, where things may appear to work, they're not guaranteed to work in all cases. The system call could still be interrupted in some circumstances, and could perform an incomplete write in some circumstances. Consequently, Wasm code needs a loop if it wants all the buffers printed.</p>
<p>In theory, a <code>__wasi_fd_write</code> call could return zero. But this shouldn't be any different from it returning any other number less than the requested number. If the wasm code has a loop, the zero case isn't special.</p>
<p>WASI today is a synchronous API. It blocks. Many people are obviously interested in async I/O; various approaches are <a href="https://github.com/WebAssembly/stack-switching">in development</a>, but not available yet. So for now, it's a blocking API, and adding a loop around it doesn't introduce any new blocking.</p>
</blockquote>



<a name="236587337"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20Issue%20%232864%20writev%20only%20outputs%20first%20paramete.../near/236587337" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20Issue.20.232864.20writev.20only.20outputs.20first.20paramete.2E.2E.2E.html#236587337">(Apr 28 2021 at 22:00)</a>:</h4>
<p>expnkx <a href="https://github.com/bytecodealliance/wasmtime/issues/2864#issuecomment-828808714">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/2864">Issue #2864</a>:</p>
<blockquote>
<blockquote>
<p>POSIX <a href="https://pubs.opengroup.org/onlinepubs/007904875/functions/write.html">says</a> "If write() is interrupted by a signal after it successfully writes some data, it shall return the number of bytes written". So even on Linux, where things may appear to work, they're not guaranteed to work in all cases. The system call could still be interrupted in some circumstances, and could perform an incomplete write in some circumstances. Consequently, Wasm code needs a loop if it wants all the buffers printed.</p>
<p>In theory, a <code>__wasi_fd_write</code> call could return zero. But this shouldn't be any different from it returning any other number less than the requested number. If the wasm code has a loop, the zero case isn't special.</p>
<p>WASI today is a synchronous API. It blocks. Many people are obviously interested in async I/O; various approaches are <a href="https://github.com/WebAssembly/stack-switching">in development</a>, but not available yet. So for now, it's a blocking API, and adding a loop around it doesn't introduce any new blocking.</p>
</blockquote>
<p>if the API keeps returning 0, you get a block.</p>
</blockquote>



<a name="236589264"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20Issue%20%232864%20writev%20only%20outputs%20first%20paramete.../near/236589264" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20Issue.20.232864.20writev.20only.20outputs.20first.20paramete.2E.2E.2E.html#236589264">(Apr 28 2021 at 22:18)</a>:</h4>
<p>sunfishcode <a href="https://github.com/bytecodealliance/wasmtime/issues/2864#issuecomment-828817963">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/2864">Issue #2864</a>:</p>
<blockquote>
<blockquote>
<p>if the API keeps returning 0, you get a block.</p>
</blockquote>
<p>That is correct. The API itself can also block.</p>
</blockquote>



<a name="237872825"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20Issue%20%232864%20writev%20only%20outputs%20first%20paramete.../near/237872825" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20Issue.20.232864.20writev.20only.20outputs.20first.20paramete.2E.2E.2E.html#237872825">(May 07 2021 at 18:55)</a>:</h4>
<p>sunfishcode <a href="https://github.com/bytecodealliance/wasmtime/issues/2864#issuecomment-834693027">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/2864">Issue #2864</a>:</p>
<blockquote>
<p>The implementation is working as intended. To write a complete string reliably with the current WASI APIs, it's necessary to wrap the <code>__wasi_fd_write</code> call in a loop, as libc does.</p>
</blockquote>



<a name="237872826"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20Issue%20%232864%20writev%20only%20outputs%20first%20paramete.../near/237872826" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20Issue.20.232864.20writev.20only.20outputs.20first.20paramete.2E.2E.2E.html#237872826">(May 07 2021 at 18:55)</a>:</h4>
<p>sunfishcode closed <a href="https://github.com/bytecodealliance/wasmtime/issues/2864">Issue #2864</a>:</p>
<blockquote>
<p>Thanks for filing a bug report! Please fill out the TODOs below.</p>
<h3>Test Case</h3>
<p><a href="https://github.com/expnkx/fast_io/blob/02cc01ceea5cba4a40e35dc4ae1fd64e68148e2d/include/fast_io_hosted/platforms/posix.h#L1512">https://github.com/expnkx/fast_io/blob/02cc01ceea5cba4a40e35dc4ae1fd64e68148e2d/include/fast_io_hosted/platforms/posix.h#L1512</a></p>
<div class="codehilite" data-code-language="C++"><pre><span></span><code><span class="cp">#include</span><span class="cpf">&lt;fast_io.h&gt;</span><span class="cp"></span>

<span class="kt">int</span> <span class="nf">main</span><span class="p">()</span>
<span class="p">{</span>
    <span class="n">print</span><span class="p">(</span><span class="n">fast_io</span><span class="o">::</span><span class="n">out</span><span class="p">(),</span><span class="s">"Hello World</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span><span class="n">fast_io</span><span class="o">::</span><span class="n">posix_clock_gettime</span><span class="p">(</span><span class="n">fast_io</span><span class="o">::</span><span class="n">posix_clock_id</span><span class="o">::</span><span class="n">realtime</span><span class="p">));</span>
<span class="p">}</span>
</code></pre></div>
<h3>Expected Results</h3>
<p>It should output all results.</p>
<h3>Actual Results</h3>
<p>It only outputs the first one</p>
<h3>Versions and Environment</h3>
<p>Wasmtime version or commit: main</p>
<p>Operating system: windows</p>
<p>Architecture: x86_64</p>
<h3>Extra Info</h3>
<p>-stdlib=libstdc++</p>
</blockquote>



<hr><p>Last updated: Jan 20 2025 at 06:04 UTC</p>
</html>