<html>
<head><meta charset="utf-8"><title>wasmtime / issue #8799 Spurious panic in v1.21 &quot;Cannot st... · git-wasmtime · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/index.html">git-wasmtime</a></h2>
<h3>Topic: <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.238799.20Spurious.20panic.20in.20v1.2E21.20.22Cannot.20st.2E.2E.2E.html">wasmtime / issue #8799 Spurious panic in v1.21 &quot;Cannot st...</a></h3>

<hr>

<base href="https://bytecodealliance.zulipchat.com">

<head><link href="https://bytecodealliance.github.io/zulip-archive/style.css" rel="stylesheet"></head>

<a name="444568024"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%238799%20Spurious%20panic%20in%20v1.21%20%22Cannot%20st.../near/444568024" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.238799.20Spurious.20panic.20in.20v1.2E21.20.22Cannot.20st.2E.2E.2E.html#444568024">(Jun 13 2024 at 21:40)</a>:</h4>
<p><a href="https://github.com/milesj">milesj</a> added the bug label to <a href="https://github.com/bytecodealliance/wasmtime/issues/8799">Issue #8799</a>.</p>



<a name="444568026"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%238799%20Spurious%20panic%20in%20v1.21%20%22Cannot%20st.../near/444568026" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.238799.20Spurious.20panic.20in.20v1.2E21.20.22Cannot.20st.2E.2E.2E.html#444568026">(Jun 13 2024 at 21:40)</a>:</h4>
<p>milesj opened <a href="https://github.com/bytecodealliance/wasmtime/issues/8799">issue #8799</a>:</p>
<blockquote>
<p>I manage <a href="https://github.com/moonrepo/proto">proto</a> which utilizes a WASM plugin system powered by <a href="https://github.com/extism/extism">extism</a> (which uses wasmtime under the hood). I was using extism v1.3, which was using wasmtime v17, without issue.</p>
<p>I'm trying to upgrade extism to v1.4, which bumps wasmtime to v21, but some plugin calls fail with the following:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="n">Error</span><span class="p">:</span><span class="w">   </span><span class="err">×</span><span class="w"> </span><span class="n">Main</span><span class="w"> </span><span class="n">thread</span><span class="w"> </span><span class="n">panicked</span><span class="p">.</span>
<span class="w">  </span><span class="err">├─▶</span><span class="w"> </span><span class="n">at</span><span class="w"> </span><span class="o">/</span><span class="n">Users</span><span class="o">/</span><span class="n">miles</span><span class="o">/</span><span class="p">.</span><span class="n">cargo</span><span class="o">/</span><span class="n">registry</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">index</span><span class="p">.</span><span class="n">crates</span><span class="p">.</span><span class="n">io</span><span class="o">-</span><span class="mi">6</span><span class="n">f17d22bba15001f</span><span class="o">/</span>
<span class="w">  </span><span class="err">│</span><span class="w">   </span><span class="n">wasmtime</span><span class="o">-</span><span class="n">wasi</span><span class="o">-</span><span class="mf">21.0.1</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">runtime</span><span class="p">.</span><span class="n">rs</span><span class="p">:</span><span class="mi">94</span><span class="p">:</span><span class="mi">15</span>
<span class="w">  </span><span class="err">╰─▶</span><span class="w"> </span><span class="n">Cannot</span><span class="w"> </span><span class="n">start</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="n">runtime</span><span class="w"> </span><span class="n">from</span><span class="w"> </span><span class="n">within</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="n">runtime</span><span class="p">.</span><span class="w"> </span><span class="n">This</span><span class="w"> </span><span class="n">happens</span><span class="w"> </span><span class="n">because</span><span class="w"> </span><span class="n">a</span>
<span class="w">      </span><span class="n">function</span><span class="w"> </span><span class="p">(</span><span class="n">like</span><span class="w"> </span><span class="err">`</span><span class="n">block_on</span><span class="err">`</span><span class="p">)</span><span class="w"> </span><span class="n">attempted</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">block</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">current</span><span class="w"> </span><span class="n">thread</span><span class="w"> </span><span class="k">while</span>
<span class="w">      </span><span class="n">the</span><span class="w"> </span><span class="n">thread</span><span class="w"> </span><span class="n">is</span><span class="w"> </span><span class="n">being</span><span class="w"> </span><span class="n">used</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">drive</span><span class="w"> </span><span class="n">asynchronous</span><span class="w"> </span><span class="n">tasks</span><span class="p">.</span>
<span class="w">         </span><span class="mi">0</span><span class="p">:</span><span class="w"> </span><span class="mh">0x1048097c4</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">rust_begin_unwind</span>
<span class="w">                      </span><span class="n">at</span><span class="w"> </span><span class="o">/</span><span class="n">rustc</span><span class="o">/</span><span class="mi">129</span><span class="n">f3b9964af4d4a709d1383930ade12dfe7c081</span><span class="o">/</span>
<span class="w">      </span><span class="n">library</span><span class="o">/</span><span class="n">std</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">panicking</span><span class="p">.</span><span class="n">rs</span><span class="p">:</span><span class="mi">652</span>
<span class="w">         </span><span class="mi">1</span><span class="p">:</span><span class="w"> </span><span class="mh">0x1048d5ac0</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">core</span><span class="p">::</span><span class="n">panicking</span><span class="p">::</span><span class="n">panic_fmt</span><span class="p">::</span><span class="n">hc2b459a5bd3dce66</span>
<span class="w">                      </span><span class="n">at</span><span class="w"> </span><span class="o">/</span><span class="n">rustc</span><span class="o">/</span><span class="mi">129</span><span class="n">f3b9964af4d4a709d1383930ade12dfe7c081</span><span class="o">/</span>
<span class="w">      </span><span class="n">library</span><span class="o">/</span><span class="n">core</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">panicking</span><span class="p">.</span><span class="n">rs</span><span class="p">:</span><span class="mi">72</span>
<span class="w">         </span><span class="mi">2</span><span class="p">:</span><span class="w"> </span><span class="mh">0x1029145d0</span><span class="w"> </span><span class="o">-</span>
<span class="w">      </span><span class="n">tokio</span><span class="p">::</span><span class="n">runtime</span><span class="p">::</span><span class="n">context</span><span class="p">::</span><span class="n">runtime</span><span class="p">::</span><span class="n">enter_runtime</span><span class="p">::</span><span class="n">h71c67f9ce90d7adb</span>
<span class="w">                      </span><span class="n">at</span><span class="w"> </span><span class="o">/</span><span class="n">Users</span><span class="o">/</span><span class="n">miles</span><span class="o">/</span><span class="p">.</span><span class="n">cargo</span><span class="o">/</span><span class="n">registry</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">index</span><span class="p">.</span><span class="n">crates</span><span class="p">.</span><span class="n">io</span><span class="o">-</span>
<span class="w">      </span><span class="mi">6</span><span class="n">f17d22bba15001f</span><span class="o">/</span><span class="n">tokio</span><span class="o">-</span><span class="mf">1.38.0</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">runtime</span><span class="o">/</span><span class="n">context</span><span class="o">/</span><span class="n">runtime</span><span class="p">.</span><span class="n">rs</span><span class="p">:</span><span class="mi">68</span>
<span class="w">         </span><span class="mi">3</span><span class="p">:</span><span class="w"> </span><span class="mh">0x1029da4dc</span><span class="w"> </span><span class="o">-</span>
<span class="w">      </span><span class="n">tokio</span><span class="p">::</span><span class="n">runtime</span><span class="p">::</span><span class="n">handle</span><span class="p">::</span><span class="n">Handle</span><span class="p">::</span><span class="n">block_on</span><span class="p">::</span><span class="n">h1bf0d24a96667be4</span>
<span class="w">                      </span><span class="n">at</span><span class="w"> </span><span class="o">/</span><span class="n">Users</span><span class="o">/</span><span class="n">miles</span><span class="o">/</span><span class="p">.</span><span class="n">cargo</span><span class="o">/</span><span class="n">registry</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">index</span><span class="p">.</span><span class="n">crates</span><span class="p">.</span><span class="n">io</span><span class="o">-</span>
<span class="w">      </span><span class="mi">6</span><span class="n">f17d22bba15001f</span><span class="o">/</span><span class="n">tokio</span><span class="o">-</span><span class="mf">1.38.0</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">runtime</span><span class="o">/</span><span class="n">handle</span><span class="p">.</span><span class="n">rs</span><span class="p">:</span><span class="mi">309</span>
<span class="w">         </span><span class="mi">4</span><span class="p">:</span><span class="w"> </span><span class="mh">0x1029babc0</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">wasmtime_wasi</span><span class="p">::</span><span class="n">runtime</span><span class="p">::</span><span class="n">in_tokio</span><span class="p">::</span><span class="n">h86e6a68257414ba9</span>
<span class="w">                      </span><span class="n">at</span><span class="w"> </span><span class="o">/</span><span class="n">Users</span><span class="o">/</span><span class="n">miles</span><span class="o">/</span><span class="p">.</span><span class="n">cargo</span><span class="o">/</span><span class="n">registry</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">index</span><span class="p">.</span><span class="n">crates</span><span class="p">.</span><span class="n">io</span><span class="o">-</span>
<span class="w">      </span><span class="mi">6</span><span class="n">f17d22bba15001f</span><span class="o">/</span><span class="n">wasmtime</span><span class="o">-</span><span class="n">wasi</span><span class="o">-</span><span class="mf">21.0.1</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">runtime</span><span class="p">.</span><span class="n">rs</span><span class="p">:</span><span class="mi">94</span>
<span class="w">         </span><span class="mi">5</span><span class="p">:</span><span class="w"> </span><span class="mh">0x10287b7f4</span><span class="w"> </span><span class="o">-</span>
<span class="w">      </span><span class="n">wasmtime_wasi</span><span class="p">::</span><span class="n">preview1</span><span class="p">::</span><span class="n">sync</span><span class="p">::</span><span class="n">in_tokio</span><span class="p">::</span><span class="n">hfaa36b6685db3eb4</span>
<span class="w">                      </span><span class="n">at</span><span class="w"> </span><span class="o">/</span><span class="n">Users</span><span class="o">/</span><span class="n">miles</span><span class="o">/</span><span class="p">.</span><span class="n">cargo</span><span class="o">/</span><span class="n">registry</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">index</span><span class="p">.</span><span class="n">crates</span><span class="p">.</span><span class="n">io</span><span class="o">-</span>
<span class="w">      </span><span class="mi">6</span><span class="n">f17d22bba15001f</span><span class="o">/</span><span class="n">wasmtime</span><span class="o">-</span><span class="n">wasi</span><span class="o">-</span><span class="mf">21.0.1</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">preview1</span><span class="p">.</span><span class="n">rs</span><span class="p">:</span><span class="mi">797</span>
<span class="w">         </span><span class="mi">6</span><span class="p">:</span><span class="w"> </span><span class="mh">0x102871864</span><span class="w"> </span><span class="o">-</span>
<span class="w">      </span><span class="n">wasmtime_wasi</span><span class="p">::</span><span class="n">preview1</span><span class="p">::</span><span class="n">sync</span><span class="p">::</span><span class="n">add_wasi_snapshot_preview1_to_linker</span><span class="p">::</span>
<span class="w">      </span><span class="p">{{</span><span class="n">closure</span><span class="p">}}::</span><span class="n">hb4d9d1d03b870150</span>
<span class="w">                      </span><span class="n">at</span><span class="w"> </span><span class="o">/</span><span class="n">Users</span><span class="o">/</span><span class="n">miles</span><span class="o">/</span><span class="p">.</span><span class="n">cargo</span><span class="o">/</span><span class="n">registry</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">index</span><span class="p">.</span><span class="n">crates</span><span class="p">.</span><span class="n">io</span><span class="o">-</span>
<span class="w">      </span><span class="mi">6</span><span class="n">f17d22bba15001f</span><span class="o">/</span><span class="n">wasmtime</span><span class="o">-</span><span class="n">wasi</span><span class="o">-</span><span class="mf">21.0.1</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">preview1</span><span class="p">.</span><span class="n">rs</span><span class="p">:</span><span class="mi">779</span>
<span class="w">         </span><span class="mi">7</span><span class="p">:</span><span class="w"> </span><span class="mh">0x10282d308</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="o">&lt;</span><span class="n">F</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">wasmtime</span><span class="p">::</span><span class="n">runtime</span><span class="p">::</span><span class="n">func</span><span class="p">::</span><span class="n">IntoFunc</span><span class="o">&lt;</span><span class="n">T</span><span class="p">,</span>
<span class="w">      </span><span class="p">(</span><span class="n">wasmtime</span><span class="p">::</span><span class="n">runtime</span><span class="p">::</span><span class="n">func</span><span class="p">::</span><span class="n">Caller</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span><span class="p">,</span><span class="n">A1</span><span class="p">,</span><span class="n">A2</span><span class="p">,</span><span class="n">A3</span><span class="p">,</span><span class="n">A4</span><span class="p">,</span><span class="n">A5</span><span class="p">),</span><span class="n">R</span><span class="o">&gt;&gt;</span><span class="p">::</span><span class="n">into_func</span><span class="p">::</span><span class="n">nati</span>
<span class="w">      </span><span class="n">ve_call_shim</span><span class="p">::{{</span><span class="n">closure</span><span class="p">}}::</span><span class="n">h6523ad1cf21333de</span>
<span class="w">                      </span><span class="n">at</span><span class="w"> </span><span class="o">/</span><span class="n">Users</span><span class="o">/</span><span class="n">miles</span><span class="o">/</span><span class="p">.</span><span class="n">cargo</span><span class="o">/</span><span class="n">registry</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">index</span><span class="p">.</span><span class="n">crates</span><span class="p">.</span><span class="n">io</span><span class="o">-</span>
<span class="w">      </span><span class="mi">6</span><span class="n">f17d22bba15001f</span><span class="o">/</span><span class="n">wasmtime</span><span class="o">-</span><span class="mf">21.0.1</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">runtime</span><span class="o">/</span><span class="n">func</span><span class="p">.</span><span class="n">rs</span><span class="p">:</span><span class="mi">2216</span>
<span class="w">         </span><span class="mi">8</span><span class="p">:</span><span class="w"> </span><span class="mh">0x10297c33c</span><span class="w"> </span><span class="o">-</span>
<span class="w">      </span><span class="n">core</span><span class="p">::</span><span class="n">ops</span><span class="p">::</span><span class="n">function</span><span class="p">::</span><span class="nb">FnOnce</span><span class="p">::</span><span class="n">call_once</span><span class="p">::</span><span class="n">h91938a2041e64111</span>
<span class="w">                      </span><span class="n">at</span><span class="w"> </span><span class="o">/</span><span class="n">rustc</span><span class="o">/</span><span class="mi">129</span><span class="n">f3b9964af4d4a709d1383930ade12dfe7c081</span><span class="o">/</span>
<span class="w">      </span><span class="n">library</span><span class="o">/</span><span class="n">core</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">ops</span><span class="o">/</span><span class="n">function</span><span class="p">.</span><span class="n">rs</span><span class="p">:</span><span class="mi">250</span>
<span class="w">         </span><span class="mi">9</span><span class="p">:</span><span class="w"> </span><span class="mh">0x102841088</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">wasmtime</span><span class="p">::</span><span class="n">runtime</span><span class="p">::</span><span class="n">func</span><span class="p">::</span><span class="n">Caller</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span><span class="p">::</span><span class="n">with</span><span class="p">::</span>
<span class="w">      </span><span class="p">{{</span><span class="n">closure</span><span class="p">}}::</span><span class="n">hf3ae2a96081e3789</span>
<span class="w">                      </span><span class="n">at</span><span class="w"> </span><span class="o">/</span><span class="n">Users</span><span class="o">/</span><span class="n">miles</span><span class="o">/</span><span class="p">.</span><span class="n">cargo</span><span class="o">/</span><span class="n">registry</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">index</span><span class="p">.</span><span class="n">crates</span><span class="p">.</span><span class="n">io</span><span class="o">-</span>
<span class="w">      </span><span class="mi">6</span><span class="n">f17d22bba15001f</span><span class="o">/</span><span class="n">wasmtime</span><span class="o">-</span><span class="mf">21.0.1</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">runtime</span><span class="o">/</span><span class="n">func</span><span class="p">.</span><span class="n">rs</span><span class="p">:</span><span class="mi">2000</span>
<span class="w">        </span><span class="mi">10</span><span class="p">:</span><span class="w"> </span><span class="mh">0x1028b314c</span><span class="w"> </span><span class="o">-</span>
<span class="w">      </span><span class="n">wasmtime</span><span class="p">::</span><span class="n">runtime</span><span class="p">::</span><span class="n">vm</span><span class="p">::</span><span class="n">instance</span><span class="p">::</span><span class="n">Instance</span><span class="p">::</span><span class="n">from_vmctx</span><span class="p">::</span><span class="n">hadc721fcc0c8ce82</span>
<span class="w">                      </span><span class="n">at</span><span class="w"> </span><span class="o">/</span><span class="n">Users</span><span class="o">/</span><span class="n">miles</span><span class="o">/</span><span class="p">.</span><span class="n">cargo</span><span class="o">/</span><span class="n">registry</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">index</span><span class="p">.</span><span class="n">crates</span><span class="p">.</span><span class="n">io</span><span class="o">-</span>
<span class="w">      </span><span class="mi">6</span><span class="n">f17d22bba15001f</span><span class="o">/</span><span class="n">wasmtime</span><span class="o">-</span><span class="mf">21.0.1</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">runtime</span><span class="o">/</span><span class="n">vm</span><span class="o">/</span><span class="n">instance</span><span class="p">.</span><span class="n">rs</span><span class="p">:</span><span class="mi">240</span>
<span class="w">        </span><span class="mi">11</span><span class="p">:</span><span class="w"> </span><span class="mh">0x10283a7bc</span><span class="w"> </span><span class="o">-</span>
<span class="w">      </span><span class="n">wasmtime</span><span class="p">::</span><span class="n">runtime</span><span class="p">::</span><span class="n">func</span><span class="p">::</span><span class="n">Caller</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span><span class="p">::</span><span class="n">with</span><span class="p">::</span><span class="n">h7a637a6f69be75cc</span>
<span class="w">                      </span><span class="n">at</span><span class="w"> </span><span class="o">/</span><span class="n">Users</span><span class="o">/</span><span class="n">miles</span><span class="o">/</span><span class="p">.</span><span class="n">cargo</span><span class="o">/</span><span class="n">registry</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">index</span><span class="p">.</span><span class="n">crates</span><span class="p">.</span><span class="n">io</span><span class="o">-</span>
<span class="w">      </span><span class="mi">6</span><span class="n">f17d22bba15001f</span><span class="o">/</span><span class="n">wasmtime</span><span class="o">-</span><span class="mf">21.0.1</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">runtime</span><span class="o">/</span><span class="n">func</span><span class="p">.</span><span class="n">rs</span><span class="p">:</span><span class="mi">1996</span>
<span class="w">        </span><span class="mi">12</span><span class="p">:</span><span class="w"> </span><span class="mh">0x10282cf58</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="o">&lt;</span><span class="n">F</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">wasmtime</span><span class="p">::</span><span class="n">runtime</span><span class="p">::</span><span class="n">func</span><span class="p">::</span><span class="n">IntoFunc</span><span class="o">&lt;</span><span class="n">T</span><span class="p">,</span>
<span class="w">      </span><span class="p">(</span><span class="n">wasmtime</span><span class="p">::</span><span class="n">runtime</span><span class="p">::</span><span class="n">func</span><span class="p">::</span><span class="n">Caller</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span><span class="p">,</span><span class="n">A1</span><span class="p">,</span><span class="n">A2</span><span class="p">,</span><span class="n">A3</span><span class="p">,</span><span class="n">A4</span><span class="p">,</span><span class="n">A5</span><span class="p">),</span><span class="n">R</span><span class="o">&gt;&gt;</span><span class="p">::</span><span class="n">into_func</span><span class="p">::</span><span class="n">nati</span>
<span class="w">      </span><span class="n">ve_call_shim</span><span class="p">::{{</span><span class="n">closure</span><span class="p">}}::</span><span class="n">h13c08eccf960f6be</span>
<span class="w">                      </span><span class="n">at</span><span class="w"> </span><span class="o">/</span><span class="n">Users</span><span class="o">/</span><span class="n">miles</span><span class="o">/</span><span class="p">.</span><span class="n">cargo</span><span class="o">/</span><span class="n">registry</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">index</span><span class="p">.</span><span class="n">crates</span><span class="p">.</span><span class="n">io</span><span class="o">-</span>
<span class="w">      </span><span class="mi">6</span><span class="n">f17d22bba15001f</span><span class="o">/</span><span class="n">wasmtime</span><span class="o">-</span><span class="mf">21.0.1</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">runtime</span><span class="o">/</span><span class="n">func</span><span class="p">.</span><span class="n">rs</span><span class="p">:</span><span class="mi">2239</span>
<span class="w">        </span><span class="mi">13</span><span class="p">:</span><span class="w"> </span><span class="mh">0x1029fe3ac</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="o">&lt;</span><span class="n">core</span><span class="p">::</span><span class="n">panic</span><span class="p">::</span><span class="n">unwind_safe</span><span class="p">::</span><span class="n">AssertUnwindSafe</span><span class="o">&lt;</span><span class="n">F</span><span class="o">&gt;</span><span class="w"> </span><span class="k">as</span>
<span class="w">      </span><span class="n">core</span><span class="p">::</span><span class="n">ops</span><span class="p">::</span><span class="n">function</span><span class="p">::</span><span class="nb">FnOnce</span><span class="o">&lt;</span><span class="p">()</span><span class="o">&gt;&gt;</span><span class="p">::</span><span class="n">call_once</span><span class="p">::</span><span class="n">h9dbf965735c9e405</span>
<span class="w">                      </span><span class="n">at</span><span class="w"> </span><span class="o">/</span><span class="n">rustc</span><span class="o">/</span><span class="mi">129</span><span class="n">f3b9964af4d4a709d1383930ade12dfe7c081</span><span class="o">/</span>
<span class="w">      </span><span class="n">library</span><span class="o">/</span><span class="n">core</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">panic</span><span class="o">/</span><span class="n">unwind_safe</span><span class="p">.</span><span class="n">rs</span><span class="p">:</span><span class="mi">272</span>
<span class="w">        </span><span class="mi">14</span><span class="p">:</span><span class="w"> </span><span class="mh">0x1029c3c30</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">std</span><span class="p">::</span><span class="n">panicking</span><span class="p">::</span><span class="kr">try</span><span class="p">::</span><span class="n">do_call</span><span class="p">::</span><span class="n">h4b6c28649817d04f</span>
<span class="w">                      </span><span class="n">at</span><span class="w"> </span><span class="o">/</span><span class="n">rustc</span><span class="o">/</span><span class="mi">129</span><span class="n">f3b9964af4d4a709d1383930ade12dfe7c081</span><span class="o">/</span>
<span class="w">      </span><span class="n">library</span><span class="o">/</span><span class="n">std</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">panicking</span><span class="p">.</span><span class="n">rs</span><span class="p">:</span><span class="mi">559</span>
<span class="w">        </span><span class="mi">15</span><span class="p">:</span><span class="w"> </span><span class="mh">0x1029e4274</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">___rust_try</span>
<span class="w">        </span><span class="mi">16</span><span class="p">:</span><span class="w"> </span><span class="mh">0x1029c30b8</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">std</span><span class="p">::</span><span class="n">panicking</span><span class="p">::</span><span class="kr">try</span><span class="p">::</span><span class="n">hc904728b212a80ec</span>
<span class="w">                      </span><span class="n">at</span><span class="w"> </span><span class="o">/</span><span class="n">rustc</span><span class="o">/</span><span class="mi">129</span><span class="n">f3b9964af4d4a709d1383930ade12dfe7c081</span><span class="o">/</span>
<span class="w">      </span><span class="n">library</span><span class="o">/</span><span class="n">std</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">panicking</span><span class="p">.</span><span class="n">rs</span><span class="p">:</span><span class="mi">523</span>
<span class="w">        </span><span class="mi">17</span><span class="p">:</span><span class="w"> </span><span class="mh">0x10290c0b0</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">std</span><span class="p">::</span><span class="n">panic</span><span class="p">::</span><span class="n">catch_unwind</span><span class="p">::</span><span class="n">hc1ef182edf83b816</span>
<span class="w">                      </span><span class="n">at</span><span class="w"> </span><span class="o">/</span><span class="n">rustc</span><span class="o">/</span><span class="mi">129</span><span class="n">f3b9964af4d4a709d1383930ade12dfe7c081</span><span class="o">/</span>
<span class="w">      </span><span class="n">library</span><span class="o">/</span><span class="n">std</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">panic</span><span class="p">.</span><span class="n">rs</span><span class="p">:</span><span class="mi">149</span>
<span class="w">        </span><span class="mi">18</span><span class="p">:</span><span class="w"> </span><span class="mh">0x10288bee4</span><span class="w"> </span><span class="o">-</span>
<span class="w">      </span><span class="n">wasmtime</span><span class="p">::</span><span class="n">runtime</span><span class="p">::</span><span class="n">vm</span><span class="p">::</span><span class="n">traphandlers</span><span class="p">::</span><span class="n">catch_unwind_and_longjmp</span><span class="p">::</span><span class="n">hfc27d178</span>
<span class="w">      </span><span class="n">d428aaca</span>
<span class="w">                      </span><span class="n">at</span><span class="w"> </span><span class="o">/</span><span class="n">Users</span><span class="o">/</span><span class="n">miles</span><span class="o">/</span><span class="p">.</span><span class="n">cargo</span><span class="o">/</span><span class="n">registry</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">index</span><span class="p">.</span><span class="n">crates</span><span class="p">.</span><span class="n">io</span><span class="o">-</span>
<span class="w">      </span><span class="mi">6</span><span class="n">f17d22bba15001f</span><span class="o">/</span><span class="n">wasmtime</span><span class="o">-</span><span class="mf">21.0.1</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">runtime</span><span class="o">/</span><span class="n">vm</span><span class="o">/</span><span class="n">traphandlers</span><span class="p">.</span><span class="n">rs</span><span class="p">:</span><span class="mi">123</span>
<span class="w">        </span><span class="mi">19</span><span class="p">:</span><span class="w"> </span><span class="mh">0x10282ce54</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="o">&lt;</span><span class="n">F</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">wasmtime</span><span class="p">::</span><span class="n">runtime</span><span class="p">::</span><span class="n">func</span><span class="p">::</span><span class="n">IntoFunc</span><span class="o">&lt;</span><span class="n">T</span><span class="p">,</span>
<span class="w">      </span><span class="p">(</span><span class="n">wasmtime</span><span class="p">::</span><span class="n">runtime</span><span class="p">::</span><span class="n">func</span><span class="p">::</span><span class="n">Caller</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span><span class="p">,</span><span class="n">A1</span><span class="p">,</span><span class="n">A2</span><span class="p">,</span><span class="n">A3</span><span class="p">,</span><span class="n">A4</span><span class="p">,</span><span class="n">A5</span><span class="p">),</span><span class="n">R</span><span class="o">&gt;&gt;</span><span class="p">::</span><span class="n">into_func</span><span class="p">::</span><span class="n">nati</span>
<span class="w">      </span><span class="n">ve_call_shim</span><span class="p">::</span><span class="n">h6d324f8ac59a7ef9</span>
<span class="w">                      </span><span class="n">at</span><span class="w"> </span><span class="o">/</span><span class="n">Users</span><span class="o">/</span><span class="n">miles</span><span class="o">/</span><span class="p">.</span><span class="n">cargo</span><span class="o">/</span><span class="n">registry</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">index</span><span class="p">.</span><span class="n">crates</span><span class="p">.</span><span class="n">io</span><span class="o">-</span>
<span class="w">      </span><span class="mi">6</span><span class="n">f17d22bba15001f</span><span class="o">/</span><span class="n">wasmtime</span><span class="o">-</span><span class="mf">21.0.1</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">runtime</span><span class="o">/</span><span class="n">func</span><span class="p">.</span><span class="n">rs</span><span class="p">:</span><span class="mi">2237</span>
<span class="w">        </span><span class="mi">20</span><span class="p">:</span><span class="w"> </span><span class="mh">0x10ad6e960</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="o">&lt;</span><span class="n">unresolved</span><span class="o">&gt;</span>
</code></pre></div>
<p>This is _very confusing_ because both extism and proto are interacting with wasmtime through sync calls, so I'm not entirely sure how we're hitting tokio/async stuff. However, proto is using tokio itself to power the CLI, but wasm calls are non-async.</p>
<p>I tried stepping through the panic with a debugger, but I was unable to uncover where exactly it's happening. The debugger would constantly jump between tokio worker threads and I would lose context.</p>
<h3>Test Case</h3>
<p>N/A, use steps below</p>
<h3>Steps to Reproduce</h3>
<ul>
<li>Clone <code>git@github.com:moonrepo/proto.git</code></li>
<li>Checkout <code>0.37-extism</code></li>
<li>Run `cargo run -- install python 3.12.0 --log trace</li>
<li>Should panic with error</li>
</ul>
<h3>Expected Results</h3>
<p>Does not panic.</p>
<h3>Actual Results</h3>
<p>Consistently panics.</p>
<p>For context, this only happens with the proto python plugin, and not the other proto plugins. Here's the python plugin function that panics: <a href="https://github.com/moonrepo/python-plugin/blob/master/src/proto.rs#L143">https://github.com/moonrepo/python-plugin/blob/master/src/proto.rs#L143</a></p>
<h3>Versions and Environment</h3>
<p>Wasmtime version or commit: 21</p>
<p>Operating system: macos (but fails on all)</p>
<p>Architecture: arm64 (but fails on all)</p>
<h3>Extra Info</h3>
<p>PR of failing builds: <a href="https://github.com/moonrepo/proto/actions/runs/9504911118/job/26198611886?pr=515">https://github.com/moonrepo/proto/actions/runs/9504911118/job/26198611886?pr=515</a></p>
</blockquote>



<a name="444568309"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%238799%20Spurious%20panic%20in%20v1.21%20%22Cannot%20st.../near/444568309" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.238799.20Spurious.20panic.20in.20v1.2E21.20.22Cannot.20st.2E.2E.2E.html#444568309">(Jun 13 2024 at 21:43)</a>:</h4>
<p>milesj edited <a href="https://github.com/bytecodealliance/wasmtime/issues/8799">issue #8799</a>:</p>
<blockquote>
<p>I manage <a href="https://github.com/moonrepo/proto">proto</a> which utilizes a WASM plugin system powered by <a href="https://github.com/extism/extism">extism</a> (which uses wasmtime under the hood). I was using extism v1.3, which was using wasmtime v17, without issue.</p>
<p>I'm trying to upgrade extism to v1.4, which bumps wasmtime to v21, but some plugin calls fail with the following:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="n">Error</span><span class="p">:</span><span class="w">   </span><span class="err">×</span><span class="w"> </span><span class="n">Main</span><span class="w"> </span><span class="n">thread</span><span class="w"> </span><span class="n">panicked</span><span class="p">.</span>
<span class="w">  </span><span class="err">├─▶</span><span class="w"> </span><span class="n">at</span><span class="w"> </span><span class="o">/</span><span class="n">Users</span><span class="o">/</span><span class="n">miles</span><span class="o">/</span><span class="p">.</span><span class="n">cargo</span><span class="o">/</span><span class="n">registry</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">index</span><span class="p">.</span><span class="n">crates</span><span class="p">.</span><span class="n">io</span><span class="o">-</span><span class="mi">6</span><span class="n">f17d22bba15001f</span><span class="o">/</span>
<span class="w">  </span><span class="err">│</span><span class="w">   </span><span class="n">wasmtime</span><span class="o">-</span><span class="n">wasi</span><span class="o">-</span><span class="mf">21.0.1</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">runtime</span><span class="p">.</span><span class="n">rs</span><span class="p">:</span><span class="mi">94</span><span class="p">:</span><span class="mi">15</span>
<span class="w">  </span><span class="err">╰─▶</span><span class="w"> </span><span class="n">Cannot</span><span class="w"> </span><span class="n">start</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="n">runtime</span><span class="w"> </span><span class="n">from</span><span class="w"> </span><span class="n">within</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="n">runtime</span><span class="p">.</span><span class="w"> </span><span class="n">This</span><span class="w"> </span><span class="n">happens</span><span class="w"> </span><span class="n">because</span><span class="w"> </span><span class="n">a</span>
<span class="w">      </span><span class="n">function</span><span class="w"> </span><span class="p">(</span><span class="n">like</span><span class="w"> </span><span class="err">`</span><span class="n">block_on</span><span class="err">`</span><span class="p">)</span><span class="w"> </span><span class="n">attempted</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">block</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">current</span><span class="w"> </span><span class="n">thread</span><span class="w"> </span><span class="k">while</span>
<span class="w">      </span><span class="n">the</span><span class="w"> </span><span class="n">thread</span><span class="w"> </span><span class="n">is</span><span class="w"> </span><span class="n">being</span><span class="w"> </span><span class="n">used</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">drive</span><span class="w"> </span><span class="n">asynchronous</span><span class="w"> </span><span class="n">tasks</span><span class="p">.</span>
<span class="w">         </span><span class="mi">0</span><span class="p">:</span><span class="w"> </span><span class="mh">0x1048097c4</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">rust_begin_unwind</span>
<span class="w">                      </span><span class="n">at</span><span class="w"> </span><span class="o">/</span><span class="n">rustc</span><span class="o">/</span><span class="mi">129</span><span class="n">f3b9964af4d4a709d1383930ade12dfe7c081</span><span class="o">/</span>
<span class="w">      </span><span class="n">library</span><span class="o">/</span><span class="n">std</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">panicking</span><span class="p">.</span><span class="n">rs</span><span class="p">:</span><span class="mi">652</span>
<span class="w">         </span><span class="mi">1</span><span class="p">:</span><span class="w"> </span><span class="mh">0x1048d5ac0</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">core</span><span class="p">::</span><span class="n">panicking</span><span class="p">::</span><span class="n">panic_fmt</span><span class="p">::</span><span class="n">hc2b459a5bd3dce66</span>
<span class="w">                      </span><span class="n">at</span><span class="w"> </span><span class="o">/</span><span class="n">rustc</span><span class="o">/</span><span class="mi">129</span><span class="n">f3b9964af4d4a709d1383930ade12dfe7c081</span><span class="o">/</span>
<span class="w">      </span><span class="n">library</span><span class="o">/</span><span class="n">core</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">panicking</span><span class="p">.</span><span class="n">rs</span><span class="p">:</span><span class="mi">72</span>
<span class="w">         </span><span class="mi">2</span><span class="p">:</span><span class="w"> </span><span class="mh">0x1029145d0</span><span class="w"> </span><span class="o">-</span>
<span class="w">      </span><span class="n">tokio</span><span class="p">::</span><span class="n">runtime</span><span class="p">::</span><span class="n">context</span><span class="p">::</span><span class="n">runtime</span><span class="p">::</span><span class="n">enter_runtime</span><span class="p">::</span><span class="n">h71c67f9ce90d7adb</span>
<span class="w">                      </span><span class="n">at</span><span class="w"> </span><span class="o">/</span><span class="n">Users</span><span class="o">/</span><span class="n">miles</span><span class="o">/</span><span class="p">.</span><span class="n">cargo</span><span class="o">/</span><span class="n">registry</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">index</span><span class="p">.</span><span class="n">crates</span><span class="p">.</span><span class="n">io</span><span class="o">-</span>
<span class="w">      </span><span class="mi">6</span><span class="n">f17d22bba15001f</span><span class="o">/</span><span class="n">tokio</span><span class="o">-</span><span class="mf">1.38.0</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">runtime</span><span class="o">/</span><span class="n">context</span><span class="o">/</span><span class="n">runtime</span><span class="p">.</span><span class="n">rs</span><span class="p">:</span><span class="mi">68</span>
<span class="w">         </span><span class="mi">3</span><span class="p">:</span><span class="w"> </span><span class="mh">0x1029da4dc</span><span class="w"> </span><span class="o">-</span>
<span class="w">      </span><span class="n">tokio</span><span class="p">::</span><span class="n">runtime</span><span class="p">::</span><span class="n">handle</span><span class="p">::</span><span class="n">Handle</span><span class="p">::</span><span class="n">block_on</span><span class="p">::</span><span class="n">h1bf0d24a96667be4</span>
<span class="w">                      </span><span class="n">at</span><span class="w"> </span><span class="o">/</span><span class="n">Users</span><span class="o">/</span><span class="n">miles</span><span class="o">/</span><span class="p">.</span><span class="n">cargo</span><span class="o">/</span><span class="n">registry</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">index</span><span class="p">.</span><span class="n">crates</span><span class="p">.</span><span class="n">io</span><span class="o">-</span>
<span class="w">      </span><span class="mi">6</span><span class="n">f17d22bba15001f</span><span class="o">/</span><span class="n">tokio</span><span class="o">-</span><span class="mf">1.38.0</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">runtime</span><span class="o">/</span><span class="n">handle</span><span class="p">.</span><span class="n">rs</span><span class="p">:</span><span class="mi">309</span>
<span class="w">         </span><span class="mi">4</span><span class="p">:</span><span class="w"> </span><span class="mh">0x1029babc0</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">wasmtime_wasi</span><span class="p">::</span><span class="n">runtime</span><span class="p">::</span><span class="n">in_tokio</span><span class="p">::</span><span class="n">h86e6a68257414ba9</span>
<span class="w">                      </span><span class="n">at</span><span class="w"> </span><span class="o">/</span><span class="n">Users</span><span class="o">/</span><span class="n">miles</span><span class="o">/</span><span class="p">.</span><span class="n">cargo</span><span class="o">/</span><span class="n">registry</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">index</span><span class="p">.</span><span class="n">crates</span><span class="p">.</span><span class="n">io</span><span class="o">-</span>
<span class="w">      </span><span class="mi">6</span><span class="n">f17d22bba15001f</span><span class="o">/</span><span class="n">wasmtime</span><span class="o">-</span><span class="n">wasi</span><span class="o">-</span><span class="mf">21.0.1</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">runtime</span><span class="p">.</span><span class="n">rs</span><span class="p">:</span><span class="mi">94</span>
<span class="w">         </span><span class="mi">5</span><span class="p">:</span><span class="w"> </span><span class="mh">0x10287b7f4</span><span class="w"> </span><span class="o">-</span>
<span class="w">      </span><span class="n">wasmtime_wasi</span><span class="p">::</span><span class="n">preview1</span><span class="p">::</span><span class="n">sync</span><span class="p">::</span><span class="n">in_tokio</span><span class="p">::</span><span class="n">hfaa36b6685db3eb4</span>
<span class="w">                      </span><span class="n">at</span><span class="w"> </span><span class="o">/</span><span class="n">Users</span><span class="o">/</span><span class="n">miles</span><span class="o">/</span><span class="p">.</span><span class="n">cargo</span><span class="o">/</span><span class="n">registry</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">index</span><span class="p">.</span><span class="n">crates</span><span class="p">.</span><span class="n">io</span><span class="o">-</span>
<span class="w">      </span><span class="mi">6</span><span class="n">f17d22bba15001f</span><span class="o">/</span><span class="n">wasmtime</span><span class="o">-</span><span class="n">wasi</span><span class="o">-</span><span class="mf">21.0.1</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">preview1</span><span class="p">.</span><span class="n">rs</span><span class="p">:</span><span class="mi">797</span>
<span class="w">         </span><span class="mi">6</span><span class="p">:</span><span class="w"> </span><span class="mh">0x102871864</span><span class="w"> </span><span class="o">-</span>
<span class="w">      </span><span class="n">wasmtime_wasi</span><span class="p">::</span><span class="n">preview1</span><span class="p">::</span><span class="n">sync</span><span class="p">::</span><span class="n">add_wasi_snapshot_preview1_to_linker</span><span class="p">::</span>
<span class="w">      </span><span class="p">{{</span><span class="n">closure</span><span class="p">}}::</span><span class="n">hb4d9d1d03b870150</span>
<span class="w">                      </span><span class="n">at</span><span class="w"> </span><span class="o">/</span><span class="n">Users</span><span class="o">/</span><span class="n">miles</span><span class="o">/</span><span class="p">.</span><span class="n">cargo</span><span class="o">/</span><span class="n">registry</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">index</span><span class="p">.</span><span class="n">crates</span><span class="p">.</span><span class="n">io</span><span class="o">-</span>
<span class="w">      </span><span class="mi">6</span><span class="n">f17d22bba15001f</span><span class="o">/</span><span class="n">wasmtime</span><span class="o">-</span><span class="n">wasi</span><span class="o">-</span><span class="mf">21.0.1</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">preview1</span><span class="p">.</span><span class="n">rs</span><span class="p">:</span><span class="mi">779</span>
<span class="w">         </span><span class="mi">7</span><span class="p">:</span><span class="w"> </span><span class="mh">0x10282d308</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="o">&lt;</span><span class="n">F</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">wasmtime</span><span class="p">::</span><span class="n">runtime</span><span class="p">::</span><span class="n">func</span><span class="p">::</span><span class="n">IntoFunc</span><span class="o">&lt;</span><span class="n">T</span><span class="p">,</span>
<span class="w">      </span><span class="p">(</span><span class="n">wasmtime</span><span class="p">::</span><span class="n">runtime</span><span class="p">::</span><span class="n">func</span><span class="p">::</span><span class="n">Caller</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span><span class="p">,</span><span class="n">A1</span><span class="p">,</span><span class="n">A2</span><span class="p">,</span><span class="n">A3</span><span class="p">,</span><span class="n">A4</span><span class="p">,</span><span class="n">A5</span><span class="p">),</span><span class="n">R</span><span class="o">&gt;&gt;</span><span class="p">::</span><span class="n">into_func</span><span class="p">::</span><span class="n">nati</span>
<span class="w">      </span><span class="n">ve_call_shim</span><span class="p">::{{</span><span class="n">closure</span><span class="p">}}::</span><span class="n">h6523ad1cf21333de</span>
<span class="w">                      </span><span class="n">at</span><span class="w"> </span><span class="o">/</span><span class="n">Users</span><span class="o">/</span><span class="n">miles</span><span class="o">/</span><span class="p">.</span><span class="n">cargo</span><span class="o">/</span><span class="n">registry</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">index</span><span class="p">.</span><span class="n">crates</span><span class="p">.</span><span class="n">io</span><span class="o">-</span>
<span class="w">      </span><span class="mi">6</span><span class="n">f17d22bba15001f</span><span class="o">/</span><span class="n">wasmtime</span><span class="o">-</span><span class="mf">21.0.1</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">runtime</span><span class="o">/</span><span class="n">func</span><span class="p">.</span><span class="n">rs</span><span class="p">:</span><span class="mi">2216</span>
<span class="w">         </span><span class="mi">8</span><span class="p">:</span><span class="w"> </span><span class="mh">0x10297c33c</span><span class="w"> </span><span class="o">-</span>
<span class="w">      </span><span class="n">core</span><span class="p">::</span><span class="n">ops</span><span class="p">::</span><span class="n">function</span><span class="p">::</span><span class="nb">FnOnce</span><span class="p">::</span><span class="n">call_once</span><span class="p">::</span><span class="n">h91938a2041e64111</span>
<span class="w">                      </span><span class="n">at</span><span class="w"> </span><span class="o">/</span><span class="n">rustc</span><span class="o">/</span><span class="mi">129</span><span class="n">f3b9964af4d4a709d1383930ade12dfe7c081</span><span class="o">/</span>
<span class="w">      </span><span class="n">library</span><span class="o">/</span><span class="n">core</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">ops</span><span class="o">/</span><span class="n">function</span><span class="p">.</span><span class="n">rs</span><span class="p">:</span><span class="mi">250</span>
<span class="w">         </span><span class="mi">9</span><span class="p">:</span><span class="w"> </span><span class="mh">0x102841088</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">wasmtime</span><span class="p">::</span><span class="n">runtime</span><span class="p">::</span><span class="n">func</span><span class="p">::</span><span class="n">Caller</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span><span class="p">::</span><span class="n">with</span><span class="p">::</span>
<span class="w">      </span><span class="p">{{</span><span class="n">closure</span><span class="p">}}::</span><span class="n">hf3ae2a96081e3789</span>
<span class="w">                      </span><span class="n">at</span><span class="w"> </span><span class="o">/</span><span class="n">Users</span><span class="o">/</span><span class="n">miles</span><span class="o">/</span><span class="p">.</span><span class="n">cargo</span><span class="o">/</span><span class="n">registry</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">index</span><span class="p">.</span><span class="n">crates</span><span class="p">.</span><span class="n">io</span><span class="o">-</span>
<span class="w">      </span><span class="mi">6</span><span class="n">f17d22bba15001f</span><span class="o">/</span><span class="n">wasmtime</span><span class="o">-</span><span class="mf">21.0.1</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">runtime</span><span class="o">/</span><span class="n">func</span><span class="p">.</span><span class="n">rs</span><span class="p">:</span><span class="mi">2000</span>
<span class="w">        </span><span class="mi">10</span><span class="p">:</span><span class="w"> </span><span class="mh">0x1028b314c</span><span class="w"> </span><span class="o">-</span>
<span class="w">      </span><span class="n">wasmtime</span><span class="p">::</span><span class="n">runtime</span><span class="p">::</span><span class="n">vm</span><span class="p">::</span><span class="n">instance</span><span class="p">::</span><span class="n">Instance</span><span class="p">::</span><span class="n">from_vmctx</span><span class="p">::</span><span class="n">hadc721fcc0c8ce82</span>
<span class="w">                      </span><span class="n">at</span><span class="w"> </span><span class="o">/</span><span class="n">Users</span><span class="o">/</span><span class="n">miles</span><span class="o">/</span><span class="p">.</span><span class="n">cargo</span><span class="o">/</span><span class="n">registry</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">index</span><span class="p">.</span><span class="n">crates</span><span class="p">.</span><span class="n">io</span><span class="o">-</span>
<span class="w">      </span><span class="mi">6</span><span class="n">f17d22bba15001f</span><span class="o">/</span><span class="n">wasmtime</span><span class="o">-</span><span class="mf">21.0.1</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">runtime</span><span class="o">/</span><span class="n">vm</span><span class="o">/</span><span class="n">instance</span><span class="p">.</span><span class="n">rs</span><span class="p">:</span><span class="mi">240</span>
<span class="w">        </span><span class="mi">11</span><span class="p">:</span><span class="w"> </span><span class="mh">0x10283a7bc</span><span class="w"> </span><span class="o">-</span>
<span class="w">      </span><span class="n">wasmtime</span><span class="p">::</span><span class="n">runtime</span><span class="p">::</span><span class="n">func</span><span class="p">::</span><span class="n">Caller</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span><span class="p">::</span><span class="n">with</span><span class="p">::</span><span class="n">h7a637a6f69be75cc</span>
<span class="w">                      </span><span class="n">at</span><span class="w"> </span><span class="o">/</span><span class="n">Users</span><span class="o">/</span><span class="n">miles</span><span class="o">/</span><span class="p">.</span><span class="n">cargo</span><span class="o">/</span><span class="n">registry</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">index</span><span class="p">.</span><span class="n">crates</span><span class="p">.</span><span class="n">io</span><span class="o">-</span>
<span class="w">      </span><span class="mi">6</span><span class="n">f17d22bba15001f</span><span class="o">/</span><span class="n">wasmtime</span><span class="o">-</span><span class="mf">21.0.1</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">runtime</span><span class="o">/</span><span class="n">func</span><span class="p">.</span><span class="n">rs</span><span class="p">:</span><span class="mi">1996</span>
<span class="w">        </span><span class="mi">12</span><span class="p">:</span><span class="w"> </span><span class="mh">0x10282cf58</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="o">&lt;</span><span class="n">F</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">wasmtime</span><span class="p">::</span><span class="n">runtime</span><span class="p">::</span><span class="n">func</span><span class="p">::</span><span class="n">IntoFunc</span><span class="o">&lt;</span><span class="n">T</span><span class="p">,</span>
<span class="w">      </span><span class="p">(</span><span class="n">wasmtime</span><span class="p">::</span><span class="n">runtime</span><span class="p">::</span><span class="n">func</span><span class="p">::</span><span class="n">Caller</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span><span class="p">,</span><span class="n">A1</span><span class="p">,</span><span class="n">A2</span><span class="p">,</span><span class="n">A3</span><span class="p">,</span><span class="n">A4</span><span class="p">,</span><span class="n">A5</span><span class="p">),</span><span class="n">R</span><span class="o">&gt;&gt;</span><span class="p">::</span><span class="n">into_func</span><span class="p">::</span><span class="n">nati</span>
<span class="w">      </span><span class="n">ve_call_shim</span><span class="p">::{{</span><span class="n">closure</span><span class="p">}}::</span><span class="n">h13c08eccf960f6be</span>
<span class="w">                      </span><span class="n">at</span><span class="w"> </span><span class="o">/</span><span class="n">Users</span><span class="o">/</span><span class="n">miles</span><span class="o">/</span><span class="p">.</span><span class="n">cargo</span><span class="o">/</span><span class="n">registry</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">index</span><span class="p">.</span><span class="n">crates</span><span class="p">.</span><span class="n">io</span><span class="o">-</span>
<span class="w">      </span><span class="mi">6</span><span class="n">f17d22bba15001f</span><span class="o">/</span><span class="n">wasmtime</span><span class="o">-</span><span class="mf">21.0.1</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">runtime</span><span class="o">/</span><span class="n">func</span><span class="p">.</span><span class="n">rs</span><span class="p">:</span><span class="mi">2239</span>
<span class="w">        </span><span class="mi">13</span><span class="p">:</span><span class="w"> </span><span class="mh">0x1029fe3ac</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="o">&lt;</span><span class="n">core</span><span class="p">::</span><span class="n">panic</span><span class="p">::</span><span class="n">unwind_safe</span><span class="p">::</span><span class="n">AssertUnwindSafe</span><span class="o">&lt;</span><span class="n">F</span><span class="o">&gt;</span><span class="w"> </span><span class="k">as</span>
<span class="w">      </span><span class="n">core</span><span class="p">::</span><span class="n">ops</span><span class="p">::</span><span class="n">function</span><span class="p">::</span><span class="nb">FnOnce</span><span class="o">&lt;</span><span class="p">()</span><span class="o">&gt;&gt;</span><span class="p">::</span><span class="n">call_once</span><span class="p">::</span><span class="n">h9dbf965735c9e405</span>
<span class="w">                      </span><span class="n">at</span><span class="w"> </span><span class="o">/</span><span class="n">rustc</span><span class="o">/</span><span class="mi">129</span><span class="n">f3b9964af4d4a709d1383930ade12dfe7c081</span><span class="o">/</span>
<span class="w">      </span><span class="n">library</span><span class="o">/</span><span class="n">core</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">panic</span><span class="o">/</span><span class="n">unwind_safe</span><span class="p">.</span><span class="n">rs</span><span class="p">:</span><span class="mi">272</span>
<span class="w">        </span><span class="mi">14</span><span class="p">:</span><span class="w"> </span><span class="mh">0x1029c3c30</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">std</span><span class="p">::</span><span class="n">panicking</span><span class="p">::</span><span class="kr">try</span><span class="p">::</span><span class="n">do_call</span><span class="p">::</span><span class="n">h4b6c28649817d04f</span>
<span class="w">                      </span><span class="n">at</span><span class="w"> </span><span class="o">/</span><span class="n">rustc</span><span class="o">/</span><span class="mi">129</span><span class="n">f3b9964af4d4a709d1383930ade12dfe7c081</span><span class="o">/</span>
<span class="w">      </span><span class="n">library</span><span class="o">/</span><span class="n">std</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">panicking</span><span class="p">.</span><span class="n">rs</span><span class="p">:</span><span class="mi">559</span>
<span class="w">        </span><span class="mi">15</span><span class="p">:</span><span class="w"> </span><span class="mh">0x1029e4274</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">___rust_try</span>
<span class="w">        </span><span class="mi">16</span><span class="p">:</span><span class="w"> </span><span class="mh">0x1029c30b8</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">std</span><span class="p">::</span><span class="n">panicking</span><span class="p">::</span><span class="kr">try</span><span class="p">::</span><span class="n">hc904728b212a80ec</span>
<span class="w">                      </span><span class="n">at</span><span class="w"> </span><span class="o">/</span><span class="n">rustc</span><span class="o">/</span><span class="mi">129</span><span class="n">f3b9964af4d4a709d1383930ade12dfe7c081</span><span class="o">/</span>
<span class="w">      </span><span class="n">library</span><span class="o">/</span><span class="n">std</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">panicking</span><span class="p">.</span><span class="n">rs</span><span class="p">:</span><span class="mi">523</span>
<span class="w">        </span><span class="mi">17</span><span class="p">:</span><span class="w"> </span><span class="mh">0x10290c0b0</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">std</span><span class="p">::</span><span class="n">panic</span><span class="p">::</span><span class="n">catch_unwind</span><span class="p">::</span><span class="n">hc1ef182edf83b816</span>
<span class="w">                      </span><span class="n">at</span><span class="w"> </span><span class="o">/</span><span class="n">rustc</span><span class="o">/</span><span class="mi">129</span><span class="n">f3b9964af4d4a709d1383930ade12dfe7c081</span><span class="o">/</span>
<span class="w">      </span><span class="n">library</span><span class="o">/</span><span class="n">std</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">panic</span><span class="p">.</span><span class="n">rs</span><span class="p">:</span><span class="mi">149</span>
<span class="w">        </span><span class="mi">18</span><span class="p">:</span><span class="w"> </span><span class="mh">0x10288bee4</span><span class="w"> </span><span class="o">-</span>
<span class="w">      </span><span class="n">wasmtime</span><span class="p">::</span><span class="n">runtime</span><span class="p">::</span><span class="n">vm</span><span class="p">::</span><span class="n">traphandlers</span><span class="p">::</span><span class="n">catch_unwind_and_longjmp</span><span class="p">::</span><span class="n">hfc27d178</span>
<span class="w">      </span><span class="n">d428aaca</span>
<span class="w">                      </span><span class="n">at</span><span class="w"> </span><span class="o">/</span><span class="n">Users</span><span class="o">/</span><span class="n">miles</span><span class="o">/</span><span class="p">.</span><span class="n">cargo</span><span class="o">/</span><span class="n">registry</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">index</span><span class="p">.</span><span class="n">crates</span><span class="p">.</span><span class="n">io</span><span class="o">-</span>
<span class="w">      </span><span class="mi">6</span><span class="n">f17d22bba15001f</span><span class="o">/</span><span class="n">wasmtime</span><span class="o">-</span><span class="mf">21.0.1</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">runtime</span><span class="o">/</span><span class="n">vm</span><span class="o">/</span><span class="n">traphandlers</span><span class="p">.</span><span class="n">rs</span><span class="p">:</span><span class="mi">123</span>
<span class="w">        </span><span class="mi">19</span><span class="p">:</span><span class="w"> </span><span class="mh">0x10282ce54</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="o">&lt;</span><span class="n">F</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">wasmtime</span><span class="p">::</span><span class="n">runtime</span><span class="p">::</span><span class="n">func</span><span class="p">::</span><span class="n">IntoFunc</span><span class="o">&lt;</span><span class="n">T</span><span class="p">,</span>
<span class="w">      </span><span class="p">(</span><span class="n">wasmtime</span><span class="p">::</span><span class="n">runtime</span><span class="p">::</span><span class="n">func</span><span class="p">::</span><span class="n">Caller</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span><span class="p">,</span><span class="n">A1</span><span class="p">,</span><span class="n">A2</span><span class="p">,</span><span class="n">A3</span><span class="p">,</span><span class="n">A4</span><span class="p">,</span><span class="n">A5</span><span class="p">),</span><span class="n">R</span><span class="o">&gt;&gt;</span><span class="p">::</span><span class="n">into_func</span><span class="p">::</span><span class="n">nati</span>
<span class="w">      </span><span class="n">ve_call_shim</span><span class="p">::</span><span class="n">h6d324f8ac59a7ef9</span>
<span class="w">                      </span><span class="n">at</span><span class="w"> </span><span class="o">/</span><span class="n">Users</span><span class="o">/</span><span class="n">miles</span><span class="o">/</span><span class="p">.</span><span class="n">cargo</span><span class="o">/</span><span class="n">registry</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">index</span><span class="p">.</span><span class="n">crates</span><span class="p">.</span><span class="n">io</span><span class="o">-</span>
<span class="w">      </span><span class="mi">6</span><span class="n">f17d22bba15001f</span><span class="o">/</span><span class="n">wasmtime</span><span class="o">-</span><span class="mf">21.0.1</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">runtime</span><span class="o">/</span><span class="n">func</span><span class="p">.</span><span class="n">rs</span><span class="p">:</span><span class="mi">2237</span>
<span class="w">        </span><span class="mi">20</span><span class="p">:</span><span class="w"> </span><span class="mh">0x10ad6e960</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="o">&lt;</span><span class="n">unresolved</span><span class="o">&gt;</span>
</code></pre></div>
<p>This is _very confusing_ because both extism and proto are interacting with wasmtime through sync calls, so I'm not entirely sure how we're hitting tokio/async stuff. However, proto is using tokio itself to power the CLI, but wasm calls are non-async.</p>
<p>I tried stepping through the panic with a debugger, but I was unable to uncover where exactly it's happening. The debugger would constantly jump between tokio worker threads and I would lose context.</p>
<h3>Test Case</h3>
<p>N/A, use steps below</p>
<h3>Steps to Reproduce</h3>
<ul>
<li>Clone <code>git@github.com:moonrepo/proto.git</code></li>
<li>Checkout <code>0.37-extism</code></li>
<li>Run <code>cargo run -- install python 3.12.0 --log trace</code></li>
<li>Should panic with error</li>
</ul>
<h3>Expected Results</h3>
<p>Does not panic.</p>
<h3>Actual Results</h3>
<p>Consistently panics.</p>
<p>For context, this only happens with the proto python plugin, and not the other proto plugins. Here's the python plugin function that panics: <a href="https://github.com/moonrepo/python-plugin/blob/master/src/proto.rs#L143">https://github.com/moonrepo/python-plugin/blob/master/src/proto.rs#L143</a></p>
<h3>Versions and Environment</h3>
<p>Wasmtime version or commit: 21</p>
<p>Operating system: macos (but fails on all)</p>
<p>Architecture: arm64 (but fails on all)</p>
<h3>Extra Info</h3>
<p>PR of failing builds: <a href="https://github.com/moonrepo/proto/actions/runs/9504911118/job/26198611886?pr=515">https://github.com/moonrepo/proto/actions/runs/9504911118/job/26198611886?pr=515</a></p>
</blockquote>



<a name="444570159"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%238799%20Spurious%20panic%20in%20v1.21%20%22Cannot%20st.../near/444570159" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.238799.20Spurious.20panic.20in.20v1.2E21.20.22Cannot.20st.2E.2E.2E.html#444570159">(Jun 13 2024 at 21:59)</a>:</h4>
<p>alexcrichton <a href="https://github.com/bytecodealliance/wasmtime/issues/8799#issuecomment-2166865193">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/8799">issue #8799</a>:</p>
<blockquote>
<p>Thanks for the report! If you're able to reproduce locally can you attach <code>gdb</code> and capture a backtrace of the thread at the time of the panic?</p>
<p>That backtrace should be able to go through wasm code and see everything and that's the main culprit to look at there. My hunch as to what's going on is that you're executing WebAssembly code on a Tokio event loop and that's what's causing the panic. This is just a hunch though so a stack trace would be able to help diagnose this. If this is the case then the best fix would likely be to offload the execution of WebAssembly to a worker thread not on the Tokio event loop</p>
</blockquote>



<a name="444571767"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%238799%20Spurious%20panic%20in%20v1.21%20%22Cannot%20st.../near/444571767" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.238799.20Spurious.20panic.20in.20v1.2E21.20.22Cannot.20st.2E.2E.2E.html#444571767">(Jun 13 2024 at 22:08)</a>:</h4>
<p>nilslice <a href="https://github.com/bytecodealliance/wasmtime/issues/8799#issuecomment-2166874594">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/8799">issue #8799</a>:</p>
<blockquote>
<p>@alexcrichton - thanks for the suggestion. Do you know if this happened to be a recent change where this function was introduced? </p>
<p><a href="https://docs.rs/wasmtime-wasi/21.0.1/wasmtime_wasi/runtime/fn.with_ambient_tokio_runtime.html">https://docs.rs/wasmtime-wasi/21.0.1/wasmtime_wasi/runtime/fn.with_ambient_tokio_runtime.html#</a></p>
<p>If so, it may be the solution we need to enable on-event-loop WebAssembly execution. </p>
<p>In Extism, there's a check for some needed extra runtime initialization (see: <a href="https://github.com/extism/extism/blob/c3e912dffb97269a5f305b6258ae0992e1d6e5c4/runtime/src/plugin.rs#L630-L633">https://github.com/extism/extism/blob/c3e912dffb97269a5f305b6258ae0992e1d6e5c4/runtime/src/plugin.rs#L630-L633</a>) </p>
<p>Perhaps it was previously the case that <code>wasmtime_wasi</code> assumed it could be executed from within an existing tokio runtime, and now it expects to be the parent tokio context? </p>
</blockquote>



<a name="444573410"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%238799%20Spurious%20panic%20in%20v1.21%20%22Cannot%20st.../near/444573410" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.238799.20Spurious.20panic.20in.20v1.2E21.20.22Cannot.20st.2E.2E.2E.html#444573410">(Jun 13 2024 at 22:17)</a>:</h4>
<p>pchickey <a href="https://github.com/bytecodealliance/wasmtime/issues/8799#issuecomment-2166884108">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/8799">issue #8799</a>:</p>
<blockquote>
<p>This change landed in the 19 release <a href="https://github.com/bytecodealliance/wasmtime/blob/release-19.0.0/RELEASES.md#changed">https://github.com/bytecodealliance/wasmtime/blob/release-19.0.0/RELEASES.md#changed</a> <a href="https://github.com/bytecodealliance/wasmtime/pull/7933">https://github.com/bytecodealliance/wasmtime/pull/7933</a> when the new wasmtime-wasi implementation was promoted to the default (root of crate) and the legacy wasi-common was removed as an export from wasmtime-wasi.</p>
<p>In the new wasmtime-wasi implementation, tokio is required to be used either externally to wasmtime when using <code>add_to_linker_async</code> and the <code>instantiate_async</code>/<code>call_async</code> mode of entering wasm, or else it if you use <code>add_to_linker_sync</code> it creates its own private tokio runtime to run that same async code in each import function call. Tokio wont let you create a new runtime on the same stack that an existing runtime is on. So, if you wish to use wasmtime-wasi through a the synchronous wasmtime interface, you'll have to do so on a new stack (via thread creation as Alex suggests) or else switch to using the async wasmtime interface.</p>
</blockquote>



<a name="444573536"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%238799%20Spurious%20panic%20in%20v1.21%20%22Cannot%20st.../near/444573536" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.238799.20Spurious.20panic.20in.20v1.2E21.20.22Cannot.20st.2E.2E.2E.html#444573536">(Jun 13 2024 at 22:18)</a>:</h4>
<p>pchickey edited a <a href="https://github.com/bytecodealliance/wasmtime/issues/8799#issuecomment-2166884108">comment</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/8799">issue #8799</a>:</p>
<blockquote>
<p>This change landed in the 19 release <a href="https://github.com/bytecodealliance/wasmtime/blob/release-19.0.0/RELEASES.md#changed">https://github.com/bytecodealliance/wasmtime/blob/release-19.0.0/RELEASES.md#changed</a> <a href="https://github.com/bytecodealliance/wasmtime/pull/7933">https://github.com/bytecodealliance/wasmtime/pull/7933</a> when the new wasmtime-wasi implementation was promoted to the default (root of crate) and the legacy wasi-common was removed as an export from wasmtime-wasi.</p>
<p>In the new wasmtime-wasi implementation, tokio is required to be used either externally to wasmtime when using <code>add_to_linker_async</code> and the <code>instantiate_async</code>/<code>call_async</code> mode of entering wasm, or else it if you use <code>add_to_linker_sync</code> it creates its own private tokio runtime to run that same async code in each import function call. Tokio wont let you create a new runtime on the same stack that an existing runtime is on. So, if you wish to use wasmtime-wasi through a the synchronous wasmtime interface, you'll have to do so on a new stack (via thread creation as Alex suggests) or else switch to using the async wasmtime interface.</p>
<p>Your other alternative is to use the wasi-common implementation, but that is approaching its EOL at this point, so we don't recommend that as a long term solution.</p>
</blockquote>



<a name="444716523"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%238799%20Spurious%20panic%20in%20v1.21%20%22Cannot%20st.../near/444716523" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.238799.20Spurious.20panic.20in.20v1.2E21.20.22Cannot.20st.2E.2E.2E.html#444716523">(Jun 14 2024 at 14:49)</a>:</h4>
<p>alexcrichton closed <a href="https://github.com/bytecodealliance/wasmtime/issues/8799">issue #8799</a>:</p>
<blockquote>
<p>I manage <a href="https://github.com/moonrepo/proto">proto</a> which utilizes a WASM plugin system powered by <a href="https://github.com/extism/extism">extism</a> (which uses wasmtime under the hood). I was using extism v1.3, which was using wasmtime v17, without issue.</p>
<p>I'm trying to upgrade extism to v1.4, which bumps wasmtime to v21, but some plugin calls fail with the following:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="n">Error</span><span class="p">:</span><span class="w">   </span><span class="err">×</span><span class="w"> </span><span class="n">Main</span><span class="w"> </span><span class="n">thread</span><span class="w"> </span><span class="n">panicked</span><span class="p">.</span>
<span class="w">  </span><span class="err">├─▶</span><span class="w"> </span><span class="n">at</span><span class="w"> </span><span class="o">/</span><span class="n">Users</span><span class="o">/</span><span class="n">miles</span><span class="o">/</span><span class="p">.</span><span class="n">cargo</span><span class="o">/</span><span class="n">registry</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">index</span><span class="p">.</span><span class="n">crates</span><span class="p">.</span><span class="n">io</span><span class="o">-</span><span class="mi">6</span><span class="n">f17d22bba15001f</span><span class="o">/</span>
<span class="w">  </span><span class="err">│</span><span class="w">   </span><span class="n">wasmtime</span><span class="o">-</span><span class="n">wasi</span><span class="o">-</span><span class="mf">21.0.1</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">runtime</span><span class="p">.</span><span class="n">rs</span><span class="p">:</span><span class="mi">94</span><span class="p">:</span><span class="mi">15</span>
<span class="w">  </span><span class="err">╰─▶</span><span class="w"> </span><span class="n">Cannot</span><span class="w"> </span><span class="n">start</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="n">runtime</span><span class="w"> </span><span class="n">from</span><span class="w"> </span><span class="n">within</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="n">runtime</span><span class="p">.</span><span class="w"> </span><span class="n">This</span><span class="w"> </span><span class="n">happens</span><span class="w"> </span><span class="n">because</span><span class="w"> </span><span class="n">a</span>
<span class="w">      </span><span class="n">function</span><span class="w"> </span><span class="p">(</span><span class="n">like</span><span class="w"> </span><span class="err">`</span><span class="n">block_on</span><span class="err">`</span><span class="p">)</span><span class="w"> </span><span class="n">attempted</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">block</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">current</span><span class="w"> </span><span class="n">thread</span><span class="w"> </span><span class="k">while</span>
<span class="w">      </span><span class="n">the</span><span class="w"> </span><span class="n">thread</span><span class="w"> </span><span class="n">is</span><span class="w"> </span><span class="n">being</span><span class="w"> </span><span class="n">used</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">drive</span><span class="w"> </span><span class="n">asynchronous</span><span class="w"> </span><span class="n">tasks</span><span class="p">.</span>
<span class="w">         </span><span class="mi">0</span><span class="p">:</span><span class="w"> </span><span class="mh">0x1048097c4</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">rust_begin_unwind</span>
<span class="w">                      </span><span class="n">at</span><span class="w"> </span><span class="o">/</span><span class="n">rustc</span><span class="o">/</span><span class="mi">129</span><span class="n">f3b9964af4d4a709d1383930ade12dfe7c081</span><span class="o">/</span>
<span class="w">      </span><span class="n">library</span><span class="o">/</span><span class="n">std</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">panicking</span><span class="p">.</span><span class="n">rs</span><span class="p">:</span><span class="mi">652</span>
<span class="w">         </span><span class="mi">1</span><span class="p">:</span><span class="w"> </span><span class="mh">0x1048d5ac0</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">core</span><span class="p">::</span><span class="n">panicking</span><span class="p">::</span><span class="n">panic_fmt</span><span class="p">::</span><span class="n">hc2b459a5bd3dce66</span>
<span class="w">                      </span><span class="n">at</span><span class="w"> </span><span class="o">/</span><span class="n">rustc</span><span class="o">/</span><span class="mi">129</span><span class="n">f3b9964af4d4a709d1383930ade12dfe7c081</span><span class="o">/</span>
<span class="w">      </span><span class="n">library</span><span class="o">/</span><span class="n">core</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">panicking</span><span class="p">.</span><span class="n">rs</span><span class="p">:</span><span class="mi">72</span>
<span class="w">         </span><span class="mi">2</span><span class="p">:</span><span class="w"> </span><span class="mh">0x1029145d0</span><span class="w"> </span><span class="o">-</span>
<span class="w">      </span><span class="n">tokio</span><span class="p">::</span><span class="n">runtime</span><span class="p">::</span><span class="n">context</span><span class="p">::</span><span class="n">runtime</span><span class="p">::</span><span class="n">enter_runtime</span><span class="p">::</span><span class="n">h71c67f9ce90d7adb</span>
<span class="w">                      </span><span class="n">at</span><span class="w"> </span><span class="o">/</span><span class="n">Users</span><span class="o">/</span><span class="n">miles</span><span class="o">/</span><span class="p">.</span><span class="n">cargo</span><span class="o">/</span><span class="n">registry</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">index</span><span class="p">.</span><span class="n">crates</span><span class="p">.</span><span class="n">io</span><span class="o">-</span>
<span class="w">      </span><span class="mi">6</span><span class="n">f17d22bba15001f</span><span class="o">/</span><span class="n">tokio</span><span class="o">-</span><span class="mf">1.38.0</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">runtime</span><span class="o">/</span><span class="n">context</span><span class="o">/</span><span class="n">runtime</span><span class="p">.</span><span class="n">rs</span><span class="p">:</span><span class="mi">68</span>
<span class="w">         </span><span class="mi">3</span><span class="p">:</span><span class="w"> </span><span class="mh">0x1029da4dc</span><span class="w"> </span><span class="o">-</span>
<span class="w">      </span><span class="n">tokio</span><span class="p">::</span><span class="n">runtime</span><span class="p">::</span><span class="n">handle</span><span class="p">::</span><span class="n">Handle</span><span class="p">::</span><span class="n">block_on</span><span class="p">::</span><span class="n">h1bf0d24a96667be4</span>
<span class="w">                      </span><span class="n">at</span><span class="w"> </span><span class="o">/</span><span class="n">Users</span><span class="o">/</span><span class="n">miles</span><span class="o">/</span><span class="p">.</span><span class="n">cargo</span><span class="o">/</span><span class="n">registry</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">index</span><span class="p">.</span><span class="n">crates</span><span class="p">.</span><span class="n">io</span><span class="o">-</span>
<span class="w">      </span><span class="mi">6</span><span class="n">f17d22bba15001f</span><span class="o">/</span><span class="n">tokio</span><span class="o">-</span><span class="mf">1.38.0</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">runtime</span><span class="o">/</span><span class="n">handle</span><span class="p">.</span><span class="n">rs</span><span class="p">:</span><span class="mi">309</span>
<span class="w">         </span><span class="mi">4</span><span class="p">:</span><span class="w"> </span><span class="mh">0x1029babc0</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">wasmtime_wasi</span><span class="p">::</span><span class="n">runtime</span><span class="p">::</span><span class="n">in_tokio</span><span class="p">::</span><span class="n">h86e6a68257414ba9</span>
<span class="w">                      </span><span class="n">at</span><span class="w"> </span><span class="o">/</span><span class="n">Users</span><span class="o">/</span><span class="n">miles</span><span class="o">/</span><span class="p">.</span><span class="n">cargo</span><span class="o">/</span><span class="n">registry</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">index</span><span class="p">.</span><span class="n">crates</span><span class="p">.</span><span class="n">io</span><span class="o">-</span>
<span class="w">      </span><span class="mi">6</span><span class="n">f17d22bba15001f</span><span class="o">/</span><span class="n">wasmtime</span><span class="o">-</span><span class="n">wasi</span><span class="o">-</span><span class="mf">21.0.1</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">runtime</span><span class="p">.</span><span class="n">rs</span><span class="p">:</span><span class="mi">94</span>
<span class="w">         </span><span class="mi">5</span><span class="p">:</span><span class="w"> </span><span class="mh">0x10287b7f4</span><span class="w"> </span><span class="o">-</span>
<span class="w">      </span><span class="n">wasmtime_wasi</span><span class="p">::</span><span class="n">preview1</span><span class="p">::</span><span class="n">sync</span><span class="p">::</span><span class="n">in_tokio</span><span class="p">::</span><span class="n">hfaa36b6685db3eb4</span>
<span class="w">                      </span><span class="n">at</span><span class="w"> </span><span class="o">/</span><span class="n">Users</span><span class="o">/</span><span class="n">miles</span><span class="o">/</span><span class="p">.</span><span class="n">cargo</span><span class="o">/</span><span class="n">registry</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">index</span><span class="p">.</span><span class="n">crates</span><span class="p">.</span><span class="n">io</span><span class="o">-</span>
<span class="w">      </span><span class="mi">6</span><span class="n">f17d22bba15001f</span><span class="o">/</span><span class="n">wasmtime</span><span class="o">-</span><span class="n">wasi</span><span class="o">-</span><span class="mf">21.0.1</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">preview1</span><span class="p">.</span><span class="n">rs</span><span class="p">:</span><span class="mi">797</span>
<span class="w">         </span><span class="mi">6</span><span class="p">:</span><span class="w"> </span><span class="mh">0x102871864</span><span class="w"> </span><span class="o">-</span>
<span class="w">      </span><span class="n">wasmtime_wasi</span><span class="p">::</span><span class="n">preview1</span><span class="p">::</span><span class="n">sync</span><span class="p">::</span><span class="n">add_wasi_snapshot_preview1_to_linker</span><span class="p">::</span>
<span class="w">      </span><span class="p">{{</span><span class="n">closure</span><span class="p">}}::</span><span class="n">hb4d9d1d03b870150</span>
<span class="w">                      </span><span class="n">at</span><span class="w"> </span><span class="o">/</span><span class="n">Users</span><span class="o">/</span><span class="n">miles</span><span class="o">/</span><span class="p">.</span><span class="n">cargo</span><span class="o">/</span><span class="n">registry</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">index</span><span class="p">.</span><span class="n">crates</span><span class="p">.</span><span class="n">io</span><span class="o">-</span>
<span class="w">      </span><span class="mi">6</span><span class="n">f17d22bba15001f</span><span class="o">/</span><span class="n">wasmtime</span><span class="o">-</span><span class="n">wasi</span><span class="o">-</span><span class="mf">21.0.1</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">preview1</span><span class="p">.</span><span class="n">rs</span><span class="p">:</span><span class="mi">779</span>
<span class="w">         </span><span class="mi">7</span><span class="p">:</span><span class="w"> </span><span class="mh">0x10282d308</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="o">&lt;</span><span class="n">F</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">wasmtime</span><span class="p">::</span><span class="n">runtime</span><span class="p">::</span><span class="n">func</span><span class="p">::</span><span class="n">IntoFunc</span><span class="o">&lt;</span><span class="n">T</span><span class="p">,</span>
<span class="w">      </span><span class="p">(</span><span class="n">wasmtime</span><span class="p">::</span><span class="n">runtime</span><span class="p">::</span><span class="n">func</span><span class="p">::</span><span class="n">Caller</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span><span class="p">,</span><span class="n">A1</span><span class="p">,</span><span class="n">A2</span><span class="p">,</span><span class="n">A3</span><span class="p">,</span><span class="n">A4</span><span class="p">,</span><span class="n">A5</span><span class="p">),</span><span class="n">R</span><span class="o">&gt;&gt;</span><span class="p">::</span><span class="n">into_func</span><span class="p">::</span><span class="n">nati</span>
<span class="w">      </span><span class="n">ve_call_shim</span><span class="p">::{{</span><span class="n">closure</span><span class="p">}}::</span><span class="n">h6523ad1cf21333de</span>
<span class="w">                      </span><span class="n">at</span><span class="w"> </span><span class="o">/</span><span class="n">Users</span><span class="o">/</span><span class="n">miles</span><span class="o">/</span><span class="p">.</span><span class="n">cargo</span><span class="o">/</span><span class="n">registry</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">index</span><span class="p">.</span><span class="n">crates</span><span class="p">.</span><span class="n">io</span><span class="o">-</span>
<span class="w">      </span><span class="mi">6</span><span class="n">f17d22bba15001f</span><span class="o">/</span><span class="n">wasmtime</span><span class="o">-</span><span class="mf">21.0.1</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">runtime</span><span class="o">/</span><span class="n">func</span><span class="p">.</span><span class="n">rs</span><span class="p">:</span><span class="mi">2216</span>
<span class="w">         </span><span class="mi">8</span><span class="p">:</span><span class="w"> </span><span class="mh">0x10297c33c</span><span class="w"> </span><span class="o">-</span>
<span class="w">      </span><span class="n">core</span><span class="p">::</span><span class="n">ops</span><span class="p">::</span><span class="n">function</span><span class="p">::</span><span class="nb">FnOnce</span><span class="p">::</span><span class="n">call_once</span><span class="p">::</span><span class="n">h91938a2041e64111</span>
<span class="w">                      </span><span class="n">at</span><span class="w"> </span><span class="o">/</span><span class="n">rustc</span><span class="o">/</span><span class="mi">129</span><span class="n">f3b9964af4d4a709d1383930ade12dfe7c081</span><span class="o">/</span>
<span class="w">      </span><span class="n">library</span><span class="o">/</span><span class="n">core</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">ops</span><span class="o">/</span><span class="n">function</span><span class="p">.</span><span class="n">rs</span><span class="p">:</span><span class="mi">250</span>
<span class="w">         </span><span class="mi">9</span><span class="p">:</span><span class="w"> </span><span class="mh">0x102841088</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">wasmtime</span><span class="p">::</span><span class="n">runtime</span><span class="p">::</span><span class="n">func</span><span class="p">::</span><span class="n">Caller</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span><span class="p">::</span><span class="n">with</span><span class="p">::</span>
<span class="w">      </span><span class="p">{{</span><span class="n">closure</span><span class="p">}}::</span><span class="n">hf3ae2a96081e3789</span>
<span class="w">                      </span><span class="n">at</span><span class="w"> </span><span class="o">/</span><span class="n">Users</span><span class="o">/</span><span class="n">miles</span><span class="o">/</span><span class="p">.</span><span class="n">cargo</span><span class="o">/</span><span class="n">registry</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">index</span><span class="p">.</span><span class="n">crates</span><span class="p">.</span><span class="n">io</span><span class="o">-</span>
<span class="w">      </span><span class="mi">6</span><span class="n">f17d22bba15001f</span><span class="o">/</span><span class="n">wasmtime</span><span class="o">-</span><span class="mf">21.0.1</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">runtime</span><span class="o">/</span><span class="n">func</span><span class="p">.</span><span class="n">rs</span><span class="p">:</span><span class="mi">2000</span>
<span class="w">        </span><span class="mi">10</span><span class="p">:</span><span class="w"> </span><span class="mh">0x1028b314c</span><span class="w"> </span><span class="o">-</span>
<span class="w">      </span><span class="n">wasmtime</span><span class="p">::</span><span class="n">runtime</span><span class="p">::</span><span class="n">vm</span><span class="p">::</span><span class="n">instance</span><span class="p">::</span><span class="n">Instance</span><span class="p">::</span><span class="n">from_vmctx</span><span class="p">::</span><span class="n">hadc721fcc0c8ce82</span>
<span class="w">                      </span><span class="n">at</span><span class="w"> </span><span class="o">/</span><span class="n">Users</span><span class="o">/</span><span class="n">miles</span><span class="o">/</span><span class="p">.</span><span class="n">cargo</span><span class="o">/</span><span class="n">registry</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">index</span><span class="p">.</span><span class="n">crates</span><span class="p">.</span><span class="n">io</span><span class="o">-</span>
<span class="w">      </span><span class="mi">6</span><span class="n">f17d22bba15001f</span><span class="o">/</span><span class="n">wasmtime</span><span class="o">-</span><span class="mf">21.0.1</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">runtime</span><span class="o">/</span><span class="n">vm</span><span class="o">/</span><span class="n">instance</span><span class="p">.</span><span class="n">rs</span><span class="p">:</span><span class="mi">240</span>
<span class="w">        </span><span class="mi">11</span><span class="p">:</span><span class="w"> </span><span class="mh">0x10283a7bc</span><span class="w"> </span><span class="o">-</span>
<span class="w">      </span><span class="n">wasmtime</span><span class="p">::</span><span class="n">runtime</span><span class="p">::</span><span class="n">func</span><span class="p">::</span><span class="n">Caller</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span><span class="p">::</span><span class="n">with</span><span class="p">::</span><span class="n">h7a637a6f69be75cc</span>
<span class="w">                      </span><span class="n">at</span><span class="w"> </span><span class="o">/</span><span class="n">Users</span><span class="o">/</span><span class="n">miles</span><span class="o">/</span><span class="p">.</span><span class="n">cargo</span><span class="o">/</span><span class="n">registry</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">index</span><span class="p">.</span><span class="n">crates</span><span class="p">.</span><span class="n">io</span><span class="o">-</span>
<span class="w">      </span><span class="mi">6</span><span class="n">f17d22bba15001f</span><span class="o">/</span><span class="n">wasmtime</span><span class="o">-</span><span class="mf">21.0.1</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">runtime</span><span class="o">/</span><span class="n">func</span><span class="p">.</span><span class="n">rs</span><span class="p">:</span><span class="mi">1996</span>
<span class="w">        </span><span class="mi">12</span><span class="p">:</span><span class="w"> </span><span class="mh">0x10282cf58</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="o">&lt;</span><span class="n">F</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">wasmtime</span><span class="p">::</span><span class="n">runtime</span><span class="p">::</span><span class="n">func</span><span class="p">::</span><span class="n">IntoFunc</span><span class="o">&lt;</span><span class="n">T</span><span class="p">,</span>
<span class="w">      </span><span class="p">(</span><span class="n">wasmtime</span><span class="p">::</span><span class="n">runtime</span><span class="p">::</span><span class="n">func</span><span class="p">::</span><span class="n">Caller</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span><span class="p">,</span><span class="n">A1</span><span class="p">,</span><span class="n">A2</span><span class="p">,</span><span class="n">A3</span><span class="p">,</span><span class="n">A4</span><span class="p">,</span><span class="n">A5</span><span class="p">),</span><span class="n">R</span><span class="o">&gt;&gt;</span><span class="p">::</span><span class="n">into_func</span><span class="p">::</span><span class="n">nati</span>
<span class="w">      </span><span class="n">ve_call_shim</span><span class="p">::{{</span><span class="n">closure</span><span class="p">}}::</span><span class="n">h13c08eccf960f6be</span>
<span class="w">                      </span><span class="n">at</span><span class="w"> </span><span class="o">/</span><span class="n">Users</span><span class="o">/</span><span class="n">miles</span><span class="o">/</span><span class="p">.</span><span class="n">cargo</span><span class="o">/</span><span class="n">registry</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">index</span><span class="p">.</span><span class="n">crates</span><span class="p">.</span><span class="n">io</span><span class="o">-</span>
<span class="w">      </span><span class="mi">6</span><span class="n">f17d22bba15001f</span><span class="o">/</span><span class="n">wasmtime</span><span class="o">-</span><span class="mf">21.0.1</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">runtime</span><span class="o">/</span><span class="n">func</span><span class="p">.</span><span class="n">rs</span><span class="p">:</span><span class="mi">2239</span>
<span class="w">        </span><span class="mi">13</span><span class="p">:</span><span class="w"> </span><span class="mh">0x1029fe3ac</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="o">&lt;</span><span class="n">core</span><span class="p">::</span><span class="n">panic</span><span class="p">::</span><span class="n">unwind_safe</span><span class="p">::</span><span class="n">AssertUnwindSafe</span><span class="o">&lt;</span><span class="n">F</span><span class="o">&gt;</span><span class="w"> </span><span class="k">as</span>
<span class="w">      </span><span class="n">core</span><span class="p">::</span><span class="n">ops</span><span class="p">::</span><span class="n">function</span><span class="p">::</span><span class="nb">FnOnce</span><span class="o">&lt;</span><span class="p">()</span><span class="o">&gt;&gt;</span><span class="p">::</span><span class="n">call_once</span><span class="p">::</span><span class="n">h9dbf965735c9e405</span>
<span class="w">                      </span><span class="n">at</span><span class="w"> </span><span class="o">/</span><span class="n">rustc</span><span class="o">/</span><span class="mi">129</span><span class="n">f3b9964af4d4a709d1383930ade12dfe7c081</span><span class="o">/</span>
<span class="w">      </span><span class="n">library</span><span class="o">/</span><span class="n">core</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">panic</span><span class="o">/</span><span class="n">unwind_safe</span><span class="p">.</span><span class="n">rs</span><span class="p">:</span><span class="mi">272</span>
<span class="w">        </span><span class="mi">14</span><span class="p">:</span><span class="w"> </span><span class="mh">0x1029c3c30</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">std</span><span class="p">::</span><span class="n">panicking</span><span class="p">::</span><span class="kr">try</span><span class="p">::</span><span class="n">do_call</span><span class="p">::</span><span class="n">h4b6c28649817d04f</span>
<span class="w">                      </span><span class="n">at</span><span class="w"> </span><span class="o">/</span><span class="n">rustc</span><span class="o">/</span><span class="mi">129</span><span class="n">f3b9964af4d4a709d1383930ade12dfe7c081</span><span class="o">/</span>
<span class="w">      </span><span class="n">library</span><span class="o">/</span><span class="n">std</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">panicking</span><span class="p">.</span><span class="n">rs</span><span class="p">:</span><span class="mi">559</span>
<span class="w">        </span><span class="mi">15</span><span class="p">:</span><span class="w"> </span><span class="mh">0x1029e4274</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">___rust_try</span>
<span class="w">        </span><span class="mi">16</span><span class="p">:</span><span class="w"> </span><span class="mh">0x1029c30b8</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">std</span><span class="p">::</span><span class="n">panicking</span><span class="p">::</span><span class="kr">try</span><span class="p">::</span><span class="n">hc904728b212a80ec</span>
<span class="w">                      </span><span class="n">at</span><span class="w"> </span><span class="o">/</span><span class="n">rustc</span><span class="o">/</span><span class="mi">129</span><span class="n">f3b9964af4d4a709d1383930ade12dfe7c081</span><span class="o">/</span>
<span class="w">      </span><span class="n">library</span><span class="o">/</span><span class="n">std</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">panicking</span><span class="p">.</span><span class="n">rs</span><span class="p">:</span><span class="mi">523</span>
<span class="w">        </span><span class="mi">17</span><span class="p">:</span><span class="w"> </span><span class="mh">0x10290c0b0</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">std</span><span class="p">::</span><span class="n">panic</span><span class="p">::</span><span class="n">catch_unwind</span><span class="p">::</span><span class="n">hc1ef182edf83b816</span>
<span class="w">                      </span><span class="n">at</span><span class="w"> </span><span class="o">/</span><span class="n">rustc</span><span class="o">/</span><span class="mi">129</span><span class="n">f3b9964af4d4a709d1383930ade12dfe7c081</span><span class="o">/</span>
<span class="w">      </span><span class="n">library</span><span class="o">/</span><span class="n">std</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">panic</span><span class="p">.</span><span class="n">rs</span><span class="p">:</span><span class="mi">149</span>
<span class="w">        </span><span class="mi">18</span><span class="p">:</span><span class="w"> </span><span class="mh">0x10288bee4</span><span class="w"> </span><span class="o">-</span>
<span class="w">      </span><span class="n">wasmtime</span><span class="p">::</span><span class="n">runtime</span><span class="p">::</span><span class="n">vm</span><span class="p">::</span><span class="n">traphandlers</span><span class="p">::</span><span class="n">catch_unwind_and_longjmp</span><span class="p">::</span><span class="n">hfc27d178</span>
<span class="w">      </span><span class="n">d428aaca</span>
<span class="w">                      </span><span class="n">at</span><span class="w"> </span><span class="o">/</span><span class="n">Users</span><span class="o">/</span><span class="n">miles</span><span class="o">/</span><span class="p">.</span><span class="n">cargo</span><span class="o">/</span><span class="n">registry</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">index</span><span class="p">.</span><span class="n">crates</span><span class="p">.</span><span class="n">io</span><span class="o">-</span>
<span class="w">      </span><span class="mi">6</span><span class="n">f17d22bba15001f</span><span class="o">/</span><span class="n">wasmtime</span><span class="o">-</span><span class="mf">21.0.1</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">runtime</span><span class="o">/</span><span class="n">vm</span><span class="o">/</span><span class="n">traphandlers</span><span class="p">.</span><span class="n">rs</span><span class="p">:</span><span class="mi">123</span>
<span class="w">        </span><span class="mi">19</span><span class="p">:</span><span class="w"> </span><span class="mh">0x10282ce54</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="o">&lt;</span><span class="n">F</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">wasmtime</span><span class="p">::</span><span class="n">runtime</span><span class="p">::</span><span class="n">func</span><span class="p">::</span><span class="n">IntoFunc</span><span class="o">&lt;</span><span class="n">T</span><span class="p">,</span>
<span class="w">      </span><span class="p">(</span><span class="n">wasmtime</span><span class="p">::</span><span class="n">runtime</span><span class="p">::</span><span class="n">func</span><span class="p">::</span><span class="n">Caller</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span><span class="p">,</span><span class="n">A1</span><span class="p">,</span><span class="n">A2</span><span class="p">,</span><span class="n">A3</span><span class="p">,</span><span class="n">A4</span><span class="p">,</span><span class="n">A5</span><span class="p">),</span><span class="n">R</span><span class="o">&gt;&gt;</span><span class="p">::</span><span class="n">into_func</span><span class="p">::</span><span class="n">nati</span>
<span class="w">      </span><span class="n">ve_call_shim</span><span class="p">::</span><span class="n">h6d324f8ac59a7ef9</span>
<span class="w">                      </span><span class="n">at</span><span class="w"> </span><span class="o">/</span><span class="n">Users</span><span class="o">/</span><span class="n">miles</span><span class="o">/</span><span class="p">.</span><span class="n">cargo</span><span class="o">/</span><span class="n">registry</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">index</span><span class="p">.</span><span class="n">crates</span><span class="p">.</span><span class="n">io</span><span class="o">-</span>
<span class="w">      </span><span class="mi">6</span><span class="n">f17d22bba15001f</span><span class="o">/</span><span class="n">wasmtime</span><span class="o">-</span><span class="mf">21.0.1</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">runtime</span><span class="o">/</span><span class="n">func</span><span class="p">.</span><span class="n">rs</span><span class="p">:</span><span class="mi">2237</span>
<span class="w">        </span><span class="mi">20</span><span class="p">:</span><span class="w"> </span><span class="mh">0x10ad6e960</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="o">&lt;</span><span class="n">unresolved</span><span class="o">&gt;</span>
</code></pre></div>
<p>This is _very confusing_ because both extism and proto are interacting with wasmtime through sync calls, so I'm not entirely sure how we're hitting tokio/async stuff. However, proto is using tokio itself to power the CLI, but wasm calls are non-async.</p>
<p>I tried stepping through the panic with a debugger, but I was unable to uncover where exactly it's happening. The debugger would constantly jump between tokio worker threads and I would lose context.</p>
<h3>Test Case</h3>
<p>N/A, use steps below</p>
<h3>Steps to Reproduce</h3>
<ul>
<li>Clone <code>git@github.com:moonrepo/proto.git</code></li>
<li>Checkout <code>0.37-extism</code></li>
<li>Run <code>cargo run -- install python 3.12.0 --log trace</code></li>
<li>Should panic with error</li>
</ul>
<h3>Expected Results</h3>
<p>Does not panic.</p>
<h3>Actual Results</h3>
<p>Consistently panics.</p>
<p>For context, this only happens with the proto python plugin, and not the other proto plugins. Here's the python plugin function that panics: <a href="https://github.com/moonrepo/python-plugin/blob/master/src/proto.rs#L143">https://github.com/moonrepo/python-plugin/blob/master/src/proto.rs#L143</a></p>
<h3>Versions and Environment</h3>
<p>Wasmtime version or commit: 21</p>
<p>Operating system: macos (but fails on all)</p>
<p>Architecture: arm64 (but fails on all)</p>
<h3>Extra Info</h3>
<p>PR of failing builds: <a href="https://github.com/moonrepo/proto/actions/runs/9504911118/job/26198611886?pr=515">https://github.com/moonrepo/proto/actions/runs/9504911118/job/26198611886?pr=515</a></p>
</blockquote>



<a name="444716528"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%238799%20Spurious%20panic%20in%20v1.21%20%22Cannot%20st.../near/444716528" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.238799.20Spurious.20panic.20in.20v1.2E21.20.22Cannot.20st.2E.2E.2E.html#444716528">(Jun 14 2024 at 14:49)</a>:</h4>
<p>alexcrichton <a href="https://github.com/bytecodealliance/wasmtime/issues/8799#issuecomment-2168206993">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/8799">issue #8799</a>:</p>
<blockquote>
<p>I think that this issue is currently working as intended in the sense that this is a consequence of the current design of wasmtime-wasi. Given that I'm going to close this, but @nilslice if there are still difficulties/issues remaining let me know and I can reopen too.</p>
</blockquote>



<a name="444723217"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%238799%20Spurious%20panic%20in%20v1.21%20%22Cannot%20st.../near/444723217" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.238799.20Spurious.20panic.20in.20v1.2E21.20.22Cannot.20st.2E.2E.2E.html#444723217">(Jun 14 2024 at 15:20)</a>:</h4>
<p>nilslice <a href="https://github.com/bytecodealliance/wasmtime/issues/8799#issuecomment-2168260503">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/8799">issue #8799</a>:</p>
<blockquote>
<p>Thanks! We ended up switching back to wasi-common to fix. </p>
</blockquote>



<hr><p>Last updated: Jan 20 2025 at 06:04 UTC</p>
</html>