<html>
<head><meta charset="utf-8"><title>wasmtime / PR #9987 winch: x64 atomic stores · git-wasmtime · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/index.html">git-wasmtime</a></h2>
<h3>Topic: <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.239987.20winch.3A.20x64.20atomic.20stores.html">wasmtime / PR #9987 winch: x64 atomic stores</a></h3>

<hr>

<base href="https://bytecodealliance.zulipchat.com">

<head><link href="https://bytecodealliance.github.io/zulip-archive/style.css" rel="stylesheet"></head>

<a name="493184514"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%239987%20winch%3A%20x64%20atomic%20stores/near/493184514" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.239987.20winch.3A.20x64.20atomic.20stores.html#493184514">(Jan 12 2025 at 12:10)</a>:</h4>
<p>MarinPostma opened <a href="https://github.com/bytecodealliance/wasmtime/pull/9987">PR #9987</a> from <code>MarinPostma:winc-x64-atomic-store</code> to <code>bytecodealliance:main</code>:</p>
<blockquote>
<p>This PR implements x64 store operations:</p>
<ul>
<li><code>i32.atomic.store8</code></li>
<li><code>i32.atomic.store16</code></li>
<li><code>i32.atomic.store</code></li>
<li><code>i64.atomic.store8</code></li>
<li><code>i64.atomic.store16</code></li>
<li><code>i64.atomic.store32</code></li>
<li><code>i64.atomic.store</code></li>
</ul>
<p><a href="https://github.com/bytecodealliance/wasmtime/issues/9734">https://github.com/bytecodealliance/wasmtime/issues/9734</a></p>
</blockquote>



<a name="493184516"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%239987%20winch%3A%20x64%20atomic%20stores/near/493184516" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.239987.20winch.3A.20x64.20atomic.20stores.html#493184516">(Jan 12 2025 at 12:10)</a>:</h4>
<p><strong>MarinPostma</strong> requested <a href="https://github.com/orgs/bytecodealliance/teams/wasmtime-compiler-reviewers">wasmtime-compiler-reviewers</a> for a review on <a href="https://github.com/bytecodealliance/wasmtime/pull/9987">PR #9987</a>.</p>



<a name="493184517"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%239987%20winch%3A%20x64%20atomic%20stores/near/493184517" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.239987.20winch.3A.20x64.20atomic.20stores.html#493184517">(Jan 12 2025 at 12:10)</a>:</h4>
<p><strong>MarinPostma</strong> requested <a href="https://github.com/fitzgen">fitzgen</a> for a review on <a href="https://github.com/bytecodealliance/wasmtime/pull/9987">PR #9987</a>.</p>



<a name="493184518"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%239987%20winch%3A%20x64%20atomic%20stores/near/493184518" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.239987.20winch.3A.20x64.20atomic.20stores.html#493184518">(Jan 12 2025 at 12:10)</a>:</h4>
<p><strong>MarinPostma</strong> requested <a href="https://github.com/orgs/bytecodealliance/teams/wasmtime-core-reviewers">wasmtime-core-reviewers</a> for a review on <a href="https://github.com/bytecodealliance/wasmtime/pull/9987">PR #9987</a>.</p>



<a name="493190735"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%239987%20winch%3A%20x64%20atomic%20stores/near/493190735" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.239987.20winch.3A.20x64.20atomic.20stores.html#493190735">(Jan 12 2025 at 13:44)</a>:</h4>
<p>github-actions[bot] <a href="https://github.com/bytecodealliance/wasmtime/pull/9987#issuecomment-2585741256">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/9987">PR #9987</a>:</p>
<blockquote>
<h4>Subscribe to Label Action</h4>
<p>cc @saulecabrera</p>
<p>&lt;details&gt;<br>
This issue or pull request has been labeled: "winch"</p>
<p>Thus the following users have been cc'd because of the following labels:</p>
<ul>
<li>saulecabrera: winch</li>
</ul>
<p>To subscribe or unsubscribe from this label, edit the &lt;code&gt;.github/subscribe-to-label.json&lt;/code&gt; configuration file.</p>
<p><a href="https://github.com/bytecodealliance/subscribe-to-label-action">Learn more.</a><br>
&lt;/details&gt;</p>
</blockquote>



<a name="493200426"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%239987%20winch%3A%20x64%20atomic%20stores/near/493200426" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.239987.20winch.3A.20x64.20atomic.20stores.html#493200426">(Jan 12 2025 at 16:00)</a>:</h4>
<p>MarinPostma updated <a href="https://github.com/bytecodealliance/wasmtime/pull/9987">PR #9987</a>.</p>



<a name="493362611"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%239987%20winch%3A%20x64%20atomic%20stores/near/493362611" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.239987.20winch.3A.20x64.20atomic.20stores.html#493362611">(Jan 13 2025 at 14:15)</a>:</h4>
<p>saulecabrera submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/9987#pullrequestreview-2546703965">PR review</a>:</p>
<blockquote>
<p>One thing that we might want to do as part of this change before proceeding further with the development of the rest of the instructions in the proposal,  is to ensure that addresses are aligned for atomic loads/stores. See the <a href="https://github.com/WebAssembly/threads/blob/main/proposals/threads/Overview.md#alignment">alignment</a> of the proposal. </p>
<p>To check for alignment, I'd recommend creating a new method in the <code>CodeGen</code> module (e.g., <code>emit_check_alignment</code>) and either calling it before calling <code>emit_compute_heap_addr</code> or enhancing <code>emit_compute_heap_addr</code> to check alignment internally if the load/store is atomic. </p>
<p>For reference, <a href="https://github.com/bytecodealliance/wasmtime/blob/main/crates/cranelift/src/translate/code_translator.rs#L3306">this is how alignment is handled in Cranelift.</a> </p>
</blockquote>



<a name="493362612"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%239987%20winch%3A%20x64%20atomic%20stores/near/493362612" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.239987.20winch.3A.20x64.20atomic.20stores.html#493362612">(Jan 13 2025 at 14:15)</a>:</h4>
<p>saulecabrera created <a href="https://github.com/bytecodealliance/wasmtime/pull/9987#discussion_r1913240586">PR review comment</a>:</p>
<blockquote>
<p><div class="codehilite" data-code-language="suggestion"><pre><span></span><code>                // To stay consistent with cranelift, we emit a normal store followed by a mfence,
</code></pre></div><br>
</p>
</blockquote>



<a name="493378121"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%239987%20winch%3A%20x64%20atomic%20stores/near/493378121" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.239987.20winch.3A.20x64.20atomic.20stores.html#493378121">(Jan 13 2025 at 15:22)</a>:</h4>
<p>saulecabrera submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/9987#pullrequestreview-2546703965">PR review</a>:</p>
<blockquote>
<p>One thing that we might want to do as part of this change before proceeding further with the development of the rest of the instructions in the proposal,  is to ensure that addresses are aligned for atomic loads/stores. See the <a href="https://github.com/WebAssembly/threads/blob/main/proposals/threads/Overview.md#alignment">alignment</a> section of the proposal. </p>
<p>To check for alignment, I'd recommend creating a new method in the <code>CodeGen</code> module (e.g., <code>emit_check_alignment</code>) and either calling it before calling <code>emit_compute_heap_addr</code> or enhancing <code>emit_compute_heap_addr</code> to check alignment internally if the load/store is atomic. </p>
<p>For reference, <a href="https://github.com/bytecodealliance/wasmtime/blob/main/crates/cranelift/src/translate/code_translator.rs#L3306">this is how alignment is handled in Cranelift.</a> </p>
</blockquote>



<a name="493416754"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%239987%20winch%3A%20x64%20atomic%20stores/near/493416754" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.239987.20winch.3A.20x64.20atomic.20stores.html#493416754">(Jan 13 2025 at 18:09)</a>:</h4>
<p>MarinPostma updated <a href="https://github.com/bytecodealliance/wasmtime/pull/9987">PR #9987</a>.</p>



<a name="493435219"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%239987%20winch%3A%20x64%20atomic%20stores/near/493435219" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.239987.20winch.3A.20x64.20atomic.20stores.html#493435219">(Jan 13 2025 at 19:53)</a>:</h4>
<p>MarinPostma updated <a href="https://github.com/bytecodealliance/wasmtime/pull/9987">PR #9987</a>.</p>



<a name="493438041"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%239987%20winch%3A%20x64%20atomic%20stores/near/493438041" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.239987.20winch.3A.20x64.20atomic.20stores.html#493438041">(Jan 13 2025 at 20:07)</a>:</h4>
<p>MarinPostma updated <a href="https://github.com/bytecodealliance/wasmtime/pull/9987">PR #9987</a>.</p>



<a name="493438327"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%239987%20winch%3A%20x64%20atomic%20stores/near/493438327" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.239987.20winch.3A.20x64.20atomic.20stores.html#493438327">(Jan 13 2025 at 20:09)</a>:</h4>
<p>MarinPostma updated <a href="https://github.com/bytecodealliance/wasmtime/pull/9987">PR #9987</a>.</p>



<a name="493440347"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%239987%20winch%3A%20x64%20atomic%20stores/near/493440347" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.239987.20winch.3A.20x64.20atomic.20stores.html#493440347">(Jan 13 2025 at 20:20)</a>:</h4>
<p>MarinPostma updated <a href="https://github.com/bytecodealliance/wasmtime/pull/9987">PR #9987</a>.</p>



<a name="493440551"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%239987%20winch%3A%20x64%20atomic%20stores/near/493440551" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.239987.20winch.3A.20x64.20atomic.20stores.html#493440551">(Jan 13 2025 at 20:21)</a>:</h4>
<p>MarinPostma <a href="https://github.com/bytecodealliance/wasmtime/pull/9987#issuecomment-2588117127">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/9987">PR #9987</a>:</p>
<blockquote>
<p>@saulecabrera I have added the align check</p>
</blockquote>



<a name="493441500"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%239987%20winch%3A%20x64%20atomic%20stores/near/493441500" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.239987.20winch.3A.20x64.20atomic.20stores.html#493441500">(Jan 13 2025 at 20:26)</a>:</h4>
<p>MarinPostma updated <a href="https://github.com/bytecodealliance/wasmtime/pull/9987">PR #9987</a>.</p>



<a name="493441814"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%239987%20winch%3A%20x64%20atomic%20stores/near/493441814" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.239987.20winch.3A.20x64.20atomic.20stores.html#493441814">(Jan 13 2025 at 20:28)</a>:</h4>
<p>MarinPostma updated <a href="https://github.com/bytecodealliance/wasmtime/pull/9987">PR #9987</a>.</p>



<a name="493442230"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%239987%20winch%3A%20x64%20atomic%20stores/near/493442230" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.239987.20winch.3A.20x64.20atomic.20stores.html#493442230">(Jan 13 2025 at 20:31)</a>:</h4>
<p>MarinPostma updated <a href="https://github.com/bytecodealliance/wasmtime/pull/9987">PR #9987</a>.</p>



<a name="493595090"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%239987%20winch%3A%20x64%20atomic%20stores/near/493595090" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.239987.20winch.3A.20x64.20atomic.20stores.html#493595090">(Jan 14 2025 at 14:16)</a>:</h4>
<p>saulecabrera submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/9987#pullrequestreview-2549480560">PR review</a>.</p>



<a name="493595092"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%239987%20winch%3A%20x64%20atomic%20stores/near/493595092" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.239987.20winch.3A.20x64.20atomic.20stores.html#493595092">(Jan 14 2025 at 14:16)</a>:</h4>
<p>saulecabrera created <a href="https://github.com/bytecodealliance/wasmtime/pull/9987#discussion_r1914677528">PR review comment</a>:</p>
<blockquote>
<p>Generally in the codegen module, we try to stick with the <code>emit_*</code> prefix, for consistency, could you update the name of this method? </p>
</blockquote>



<a name="493595093"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%239987%20winch%3A%20x64%20atomic%20stores/near/493595093" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.239987.20winch.3A.20x64.20atomic.20stores.html#493595093">(Jan 14 2025 at 14:16)</a>:</h4>
<p>saulecabrera created <a href="https://github.com/bytecodealliance/wasmtime/pull/9987#discussion_r1914875946">PR review comment</a>:</p>
<blockquote>
<p>What do you think of either:</p>
<ul>
<li>Passing an enum here describing the type of heap address computation: (<code>HeapAddress::AlignChecked</code>, <code>HeapAddress::AlignUnchecked</code>)</li>
<li>Creating a wrapper method <code>emit_compute_heap_address_align_checked</code>, which internally calls <code>emit_check_align</code> and <code>emit_compute_heap_address</code>? </li>
</ul>
<p>Heap address calculation is a very critical piece of the compiler, so I'd recommend against passing boolean params, to make it less error prone at call sites. </p>
</blockquote>



<a name="493595094"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%239987%20winch%3A%20x64%20atomic%20stores/near/493595094" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.239987.20winch.3A.20x64.20atomic.20stores.html#493595094">(Jan 14 2025 at 14:16)</a>:</h4>
<p>saulecabrera created <a href="https://github.com/bytecodealliance/wasmtime/pull/9987#discussion_r1914897030">PR review comment</a>:</p>
<blockquote>
<p>I believe you could use a scratch register here? (<code>scratch!(M)</code>)</p>
</blockquote>



<a name="493595095"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%239987%20winch%3A%20x64%20atomic%20stores/near/493595095" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.239987.20winch.3A.20x64.20atomic.20stores.html#493595095">(Jan 14 2025 at 14:16)</a>:</h4>
<p>saulecabrera created <a href="https://github.com/bytecodealliance/wasmtime/pull/9987#discussion_r1914888019">PR review comment</a>:</p>
<blockquote>
<p>One thing to note with using <code>self.context.pop_to_reg</code> is that this method needs to ensure that the value is pushed back to the value stack after all the checks are emitted, to ensure that <code>emit_compute_heap_address</code> is able to pop the address. </p>
</blockquote>



<a name="493595096"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%239987%20winch%3A%20x64%20atomic%20stores/near/493595096" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.239987.20winch.3A.20x64.20atomic.20stores.html#493595096">(Jan 14 2025 at 14:16)</a>:</h4>
<p>saulecabrera created <a href="https://github.com/bytecodealliance/wasmtime/pull/9987#discussion_r1914881476">PR review comment</a>:</p>
<blockquote>
<p>I'd recommend using <code>self.context.pop_to_reg</code>, which already handles all the cases for moving a value to a register; e.g., in this case if a the value is already a register, this code will emit a move, which could be avoided, and more importantly it'll reduce register pressure. </p>
</blockquote>



<a name="493603169"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%239987%20winch%3A%20x64%20atomic%20stores/near/493603169" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.239987.20winch.3A.20x64.20atomic.20stores.html#493603169">(Jan 14 2025 at 14:54)</a>:</h4>
<p>MarinPostma updated <a href="https://github.com/bytecodealliance/wasmtime/pull/9987">PR #9987</a>.</p>



<a name="493604026"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%239987%20winch%3A%20x64%20atomic%20stores/near/493604026" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.239987.20winch.3A.20x64.20atomic.20stores.html#493604026">(Jan 14 2025 at 14:58)</a>:</h4>
<p>MarinPostma updated <a href="https://github.com/bytecodealliance/wasmtime/pull/9987">PR #9987</a>.</p>



<a name="493608870"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%239987%20winch%3A%20x64%20atomic%20stores/near/493608870" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.239987.20winch.3A.20x64.20atomic.20stores.html#493608870">(Jan 14 2025 at 15:21)</a>:</h4>
<p>saulecabrera submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/9987#pullrequestreview-2550065963">PR review</a>:</p>
<blockquote>
<p>Looks good, thanks! </p>
<p>After the trailing comment is deleted, we can land this one. </p>
</blockquote>



<a name="493608871"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%239987%20winch%3A%20x64%20atomic%20stores/near/493608871" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.239987.20winch.3A.20x64.20atomic.20stores.html#493608871">(Jan 14 2025 at 15:21)</a>:</h4>
<p>saulecabrera created <a href="https://github.com/bytecodealliance/wasmtime/pull/9987#discussion_r1915027948">PR review comment</a>:</p>
<blockquote>
<p><div class="codehilite" data-code-language="suggestion"><pre><span></span><code>
</code></pre></div><br>
</p>
</blockquote>



<a name="493609060"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%239987%20winch%3A%20x64%20atomic%20stores/near/493609060" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.239987.20winch.3A.20x64.20atomic.20stores.html#493609060">(Jan 14 2025 at 15:22)</a>:</h4>
<p>MarinPostma updated <a href="https://github.com/bytecodealliance/wasmtime/pull/9987">PR #9987</a>.</p>



<a name="493618307"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%239987%20winch%3A%20x64%20atomic%20stores/near/493618307" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.239987.20winch.3A.20x64.20atomic.20stores.html#493618307">(Jan 14 2025 at 16:05)</a>:</h4>
<p>MarinPostma <a href="https://github.com/bytecodealliance/wasmtime/pull/9987#issuecomment-2590355186">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/9987">PR #9987</a>:</p>
<blockquote>
<p>@saulecabrera it's not working yet I had to move to a x86 machine to debug, I'll ping you when i fixed it</p>
</blockquote>



<a name="493632144"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%239987%20winch%3A%20x64%20atomic%20stores/near/493632144" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.239987.20winch.3A.20x64.20atomic.20stores.html#493632144">(Jan 14 2025 at 17:13)</a>:</h4>
<p>MarinPostma submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/9987#pullrequestreview-2550481200">PR review</a>.</p>



<a name="493632150"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%239987%20winch%3A%20x64%20atomic%20stores/near/493632150" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.239987.20winch.3A.20x64.20atomic.20stores.html#493632150">(Jan 14 2025 at 17:13)</a>:</h4>
<p>MarinPostma created <a href="https://github.com/bytecodealliance/wasmtime/pull/9987#discussion_r1915279348">PR review comment</a>:</p>
<blockquote>
<p>I'm a bit worried about the risk of clobbering the a scratch register here. The register is used across multiple masm operation, and we do use scratch registers in masm often.</p>
</blockquote>



<a name="493633846"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%239987%20winch%3A%20x64%20atomic%20stores/near/493633846" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.239987.20winch.3A.20x64.20atomic.20stores.html#493633846">(Jan 14 2025 at 17:23)</a>:</h4>
<p>MarinPostma submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/9987#pullrequestreview-2550508367">PR review</a>.</p>



<a name="493633847"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%239987%20winch%3A%20x64%20atomic%20stores/near/493633847" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.239987.20winch.3A.20x64.20atomic.20stores.html#493633847">(Jan 14 2025 at 17:23)</a>:</h4>
<p>MarinPostma created <a href="https://github.com/bytecodealliance/wasmtime/pull/9987#discussion_r1915295538">PR review comment</a>:</p>
<blockquote>
<p>I've been playing around with that, but it turns out that we need to move the address to a register anyway, because we potentially need to add the <code>offset</code> to the <code>addr</code>, and we cannot do that with the <code>addr</code> as a <code>dst</code>, as we need the address intact for computing the heap address later on. The reason why we can't add with <code>tmp</code> as a dst, is because that will return a <code>InvalidTwoArgumentForm</code>.</p>
<p>In light of this, I think peeking and moving to <code>tmp</code> would save a <code>mov</code> in the case where we need to compute the offset. WDYT?</p>
</blockquote>



<a name="493635323"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%239987%20winch%3A%20x64%20atomic%20stores/near/493635323" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.239987.20winch.3A.20x64.20atomic.20stores.html#493635323">(Jan 14 2025 at 17:31)</a>:</h4>
<p>MarinPostma updated <a href="https://github.com/bytecodealliance/wasmtime/pull/9987">PR #9987</a>.</p>



<a name="493637394"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%239987%20winch%3A%20x64%20atomic%20stores/near/493637394" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.239987.20winch.3A.20x64.20atomic.20stores.html#493637394">(Jan 14 2025 at 17:44)</a>:</h4>
<p>MarinPostma <a href="https://github.com/bytecodealliance/wasmtime/pull/9987#issuecomment-2590697769">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/9987">PR #9987</a>:</p>
<blockquote>
<p>@saulecabrera, I have made the changes you requested, I also responded to your comments, let me know if you want me to make the changes I suggested in the comments instead.</p>
</blockquote>



<a name="493668636"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%239987%20winch%3A%20x64%20atomic%20stores/near/493668636" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.239987.20winch.3A.20x64.20atomic.20stores.html#493668636">(Jan 14 2025 at 20:55)</a>:</h4>
<p>saulecabrera submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/9987#pullrequestreview-2550998602">PR review</a>.</p>



<a name="493668637"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%239987%20winch%3A%20x64%20atomic%20stores/near/493668637" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.239987.20winch.3A.20x64.20atomic.20stores.html#493668637">(Jan 14 2025 at 20:55)</a>:</h4>
<p>saulecabrera created <a href="https://github.com/bytecodealliance/wasmtime/pull/9987#discussion_r1915587716">PR review comment</a>:</p>
<blockquote>
<p>Oh that's a good point yeah. My main concern with <code>peek</code> is that nothing is preventing any other method to accidentally pop the wrong value from the stack. However, since this pattern is local to this method, I don't think there's a huge risk, so yeah, let's try the peek approach. One comment to your original implementation, could you return an error instead of doing <code>peek().unwrap()</code>? We have <code>CodeGenError::missing_values_in_stack</code> for this kind of situation. </p>
</blockquote>



<a name="493917758"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%239987%20winch%3A%20x64%20atomic%20stores/near/493917758" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.239987.20winch.3A.20x64.20atomic.20stores.html#493917758">(Jan 15 2025 at 12:44)</a>:</h4>
<p>MarinPostma updated <a href="https://github.com/bytecodealliance/wasmtime/pull/9987">PR #9987</a>.</p>



<a name="493922181"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%239987%20winch%3A%20x64%20atomic%20stores/near/493922181" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.239987.20winch.3A.20x64.20atomic.20stores.html#493922181">(Jan 15 2025 at 13:04)</a>:</h4>
<p>MarinPostma updated <a href="https://github.com/bytecodealliance/wasmtime/pull/9987">PR #9987</a>.</p>



<a name="493922330"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%239987%20winch%3A%20x64%20atomic%20stores/near/493922330" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.239987.20winch.3A.20x64.20atomic.20stores.html#493922330">(Jan 15 2025 at 13:05)</a>:</h4>
<p>MarinPostma <a href="https://github.com/bytecodealliance/wasmtime/pull/9987#issuecomment-2592809078">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/9987">PR #9987</a>:</p>
<blockquote>
<p>@saulecabrera I made the final changes</p>
</blockquote>



<a name="493929334"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%239987%20winch%3A%20x64%20atomic%20stores/near/493929334" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.239987.20winch.3A.20x64.20atomic.20stores.html#493929334">(Jan 15 2025 at 13:41)</a>:</h4>
<p>saulecabrera merged <a href="https://github.com/bytecodealliance/wasmtime/pull/9987">PR #9987</a>.</p>



<hr><p>Last updated: Jan 20 2025 at 06:04 UTC</p>
</html>