<html>
<head><meta charset="utf-8"><title>wasmtime / PR #5409 Fix optimization rules for narrow typ... · git-wasmtime · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/index.html">git-wasmtime</a></h2>
<h3>Topic: <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.235409.20Fix.20optimization.20rules.20for.20narrow.20typ.2E.2E.2E.html">wasmtime / PR #5409 Fix optimization rules for narrow typ...</a></h3>

<hr>

<base href="https://bytecodealliance.zulipchat.com">

<head><link href="https://bytecodealliance.github.io/zulip-archive/style.css" rel="stylesheet"></head>

<a name="314970032"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%235409%20Fix%20optimization%20rules%20for%20narrow%20typ.../near/314970032" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.235409.20Fix.20optimization.20rules.20for.20narrow.20typ.2E.2E.2E.html#314970032">(Dec 09 2022 at 19:45)</a>:</h4>
<p>cfallin opened <a href="https://github.com/bytecodealliance/wasmtime/pull/5409">PR #5409</a> from <code>egraph-issue-5405</code> to <code>main</code>:</p>
<blockquote>
<p>This fixes #5405.</p>
<p>In the egraph mid-end's optimization rules, we were rewriting e.g. imuls of two iconsts to an iconst of the result, but without masking off the high bits (beyond the result type's width). This was producing iconsts with set high bits beyond their types' width, which is not legal.</p>
<p>In addition, this PR adds some optimizations to the algebraic rules to recognize e.g. <code>x == x</code> (and all other integer comparison operators) and resolve to 1 or 0 as appropriate.</p>
<p>&lt;!--</p>
<p>Please ensure that the following steps are all taken care of before submitting<br>
the PR.</p>
<ul>
<li>
<p>[ ] This has been discussed in issue #..., or if not, please tell us why<br>
  here.</p>
</li>
<li>
<p>[ ] A short description of what this does, why it is needed; if the<br>
  description becomes long, the matter should probably be discussed in an issue<br>
  first.</p>
</li>
<li>
<p>[ ] This PR contains test cases, if meaningful.</p>
</li>
<li>[ ] A reviewer from the core maintainer team has been assigned for this PR.<br>
  If you don't know who could review this, please indicate so. The list of<br>
  suggested reviewers on the right can help you.</li>
</ul>
<p>Please ensure all communication adheres to the <a href="https://github.com/bytecodealliance/wasmtime/blob/master/CODE_OF_CONDUCT.md">code of
conduct</a>.<br>
--&gt;<br>
</p>
</blockquote>



<a name="314970033"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%235409%20Fix%20optimization%20rules%20for%20narrow%20typ.../near/314970033" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.235409.20Fix.20optimization.20rules.20for.20narrow.20typ.2E.2E.2E.html#314970033">(Dec 09 2022 at 19:45)</a>:</h4>
<p><strong>cfallin</strong> requested <a href="https://github.com/elliottt">elliottt</a> for a review on <a href="https://github.com/bytecodealliance/wasmtime/pull/5409">PR #5409</a>.</p>



<a name="314970035"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%235409%20Fix%20optimization%20rules%20for%20narrow%20typ.../near/314970035" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.235409.20Fix.20optimization.20rules.20for.20narrow.20typ.2E.2E.2E.html#314970035">(Dec 09 2022 at 19:45)</a>:</h4>
<p><strong>cfallin</strong> requested <a href="https://github.com/fitzgen">fitzgen</a> for a review on <a href="https://github.com/bytecodealliance/wasmtime/pull/5409">PR #5409</a>.</p>



<a name="314970037"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%235409%20Fix%20optimization%20rules%20for%20narrow%20typ.../near/314970037" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.235409.20Fix.20optimization.20rules.20for.20narrow.20typ.2E.2E.2E.html#314970037">(Dec 09 2022 at 19:45)</a>:</h4>
<p><strong>cfallin</strong> requested <a href="https://github.com/jameysharp">jameysharp</a> for a review on <a href="https://github.com/bytecodealliance/wasmtime/pull/5409">PR #5409</a>.</p>



<a name="314971034"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%235409%20Fix%20optimization%20rules%20for%20narrow%20typ.../near/314971034" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.235409.20Fix.20optimization.20rules.20for.20narrow.20typ.2E.2E.2E.html#314971034">(Dec 09 2022 at 19:52)</a>:</h4>
<p>cfallin updated <a href="https://github.com/bytecodealliance/wasmtime/pull/5409">PR #5409</a> from <code>egraph-issue-5405</code> to <code>main</code>.</p>



<a name="314972736"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%235409%20Fix%20optimization%20rules%20for%20narrow%20typ.../near/314972736" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.235409.20Fix.20optimization.20rules.20for.20narrow.20typ.2E.2E.2E.html#314972736">(Dec 09 2022 at 20:02)</a>:</h4>
<p>jameysharp submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/5409#pullrequestreview-1212197865">PR review</a>.</p>



<a name="314972738"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%235409%20Fix%20optimization%20rules%20for%20narrow%20typ.../near/314972738" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.235409.20Fix.20optimization.20rules.20for.20narrow.20typ.2E.2E.2E.html#314972738">(Dec 09 2022 at 20:02)</a>:</h4>
<p>jameysharp submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/5409#pullrequestreview-1212197865">PR review</a>.</p>



<a name="314972739"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%235409%20Fix%20optimization%20rules%20for%20narrow%20typ.../near/314972739" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.235409.20Fix.20optimization.20rules.20for.20narrow.20typ.2E.2E.2E.html#314972739">(Dec 09 2022 at 20:02)</a>:</h4>
<p>jameysharp created <a href="https://github.com/bytecodealliance/wasmtime/pull/5409#discussion_r1044802530">PR review comment</a>:</p>
<blockquote>
<p>I don't believe this works when <code>ty.bits()</code> is exactly 64.</p>
<p>Instead you could use <code>u64::MAX &gt;&gt; (64 - ty.bits())</code>, since we know <code>ty.bits()</code> is never 0.</p>
<p>Alternatively, since any bit-width that's no smaller than 64 doesn't need any masking, you could remove the assert and use something like:</p>
<p><div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="k">if</span><span class="w"> </span><span class="kd">let</span><span class="w"> </span><span class="nb">Some</span><span class="p">(</span><span class="n">bit</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="k">u64</span><span class="p">.</span><span class="n">checked_shl</span><span class="p">(</span><span class="n">ty</span><span class="p">.</span><span class="n">bits</span><span class="p">())</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">Imm64</span>::<span class="n">new</span><span class="p">((</span><span class="n">x</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="p">(</span><span class="n">bit</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="p">))</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="kt">i64</span><span class="p">)</span><span class="w"></span>
<span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">Imm64</span>::<span class="n">new</span><span class="p">(</span><span class="n">x</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="kt">i64</span><span class="p">)</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div><br>
</p>
</blockquote>



<a name="314975927"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%235409%20Fix%20optimization%20rules%20for%20narrow%20typ.../near/314975927" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.235409.20Fix.20optimization.20rules.20for.20narrow.20typ.2E.2E.2E.html#314975927">(Dec 09 2022 at 20:22)</a>:</h4>
<p>cfallin submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/5409#pullrequestreview-1212217762">PR review</a>.</p>



<a name="314975965"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%235409%20Fix%20optimization%20rules%20for%20narrow%20typ.../near/314975965" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.235409.20Fix.20optimization.20rules.20for.20narrow.20typ.2E.2E.2E.html#314975965">(Dec 09 2022 at 20:22)</a>:</h4>
<p>cfallin created <a href="https://github.com/bytecodealliance/wasmtime/pull/5409#discussion_r1044816414">PR review comment</a>:</p>
<blockquote>
<p>Ah, yes, sorry for missing that! I prefer the version without conditionals (the first expression you gave) so I've gone with that.</p>
</blockquote>



<a name="314976261"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%235409%20Fix%20optimization%20rules%20for%20narrow%20typ.../near/314976261" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.235409.20Fix.20optimization.20rules.20for.20narrow.20typ.2E.2E.2E.html#314976261">(Dec 09 2022 at 20:24)</a>:</h4>
<p>cfallin updated <a href="https://github.com/bytecodealliance/wasmtime/pull/5409">PR #5409</a> from <code>egraph-issue-5405</code> to <code>main</code>.</p>



<a name="314976992"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%235409%20Fix%20optimization%20rules%20for%20narrow%20typ.../near/314976992" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.235409.20Fix.20optimization.20rules.20for.20narrow.20typ.2E.2E.2E.html#314976992">(Dec 09 2022 at 20:29)</a>:</h4>
<p>jameysharp submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/5409#pullrequestreview-1212224694">PR review</a>.</p>



<a name="314976993"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%235409%20Fix%20optimization%20rules%20for%20narrow%20typ.../near/314976993" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.235409.20Fix.20optimization.20rules.20for.20narrow.20typ.2E.2E.2E.html#314976993">(Dec 09 2022 at 20:29)</a>:</h4>
<p>jameysharp created <a href="https://github.com/bytecodealliance/wasmtime/pull/5409#discussion_r1044821094">PR review comment</a>:</p>
<blockquote>
<p>I don't understand pulling <code>ty.bits() == 64</code> out as a special case if you're using the right-shift version below. <code>u64::MAX &gt;&gt; 0</code> should be a correct mask for this case.</p>
</blockquote>



<a name="314987796"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%235409%20Fix%20optimization%20rules%20for%20narrow%20typ.../near/314987796" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.235409.20Fix.20optimization.20rules.20for.20narrow.20typ.2E.2E.2E.html#314987796">(Dec 09 2022 at 21:44)</a>:</h4>
<p>cfallin updated <a href="https://github.com/bytecodealliance/wasmtime/pull/5409">PR #5409</a> from <code>egraph-issue-5405</code> to <code>main</code>.</p>



<a name="314987912"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%235409%20Fix%20optimization%20rules%20for%20narrow%20typ.../near/314987912" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.235409.20Fix.20optimization.20rules.20for.20narrow.20typ.2E.2E.2E.html#314987912">(Dec 09 2022 at 21:45)</a>:</h4>
<p>cfallin submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/5409#pullrequestreview-1212287876">PR review</a>.</p>



<a name="314987913"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%235409%20Fix%20optimization%20rules%20for%20narrow%20typ.../near/314987913" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.235409.20Fix.20optimization.20rules.20for.20narrow.20typ.2E.2E.2E.html#314987913">(Dec 09 2022 at 21:45)</a>:</h4>
<p>cfallin created <a href="https://github.com/bytecodealliance/wasmtime/pull/5409#discussion_r1044864270">PR review comment</a>:</p>
<blockquote>
<p>Argh, yeah, I wrote it the conditionalized way first and then decided I liked the right-shift variant better, but only updated locally and didn't actually delete the conditional. I think I've found the rest of my brain now; sorry about that...</p>
</blockquote>



<a name="314987935"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%235409%20Fix%20optimization%20rules%20for%20narrow%20typ.../near/314987935" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.235409.20Fix.20optimization.20rules.20for.20narrow.20typ.2E.2E.2E.html#314987935">(Dec 09 2022 at 21:45)</a>:</h4>
<p>jameysharp submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/5409#pullrequestreview-1212288023">PR review</a>.</p>



<a name="314988860"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%235409%20Fix%20optimization%20rules%20for%20narrow%20typ.../near/314988860" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.235409.20Fix.20optimization.20rules.20for.20narrow.20typ.2E.2E.2E.html#314988860">(Dec 09 2022 at 21:54)</a>:</h4>
<p>cfallin has enabled auto merge for <a href="https://github.com/bytecodealliance/wasmtime/pull/5409">PR #5409</a>.</p>



<a name="314993910"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%235409%20Fix%20optimization%20rules%20for%20narrow%20typ.../near/314993910" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.235409.20Fix.20optimization.20rules.20for.20narrow.20typ.2E.2E.2E.html#314993910">(Dec 09 2022 at 22:29)</a>:</h4>
<p>cfallin merged <a href="https://github.com/bytecodealliance/wasmtime/pull/5409">PR #5409</a>.</p>



<hr><p>Last updated: Jan 20 2025 at 06:04 UTC</p>
</html>