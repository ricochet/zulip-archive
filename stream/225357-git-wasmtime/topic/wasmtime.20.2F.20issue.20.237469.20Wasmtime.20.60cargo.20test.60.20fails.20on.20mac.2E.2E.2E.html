<html>
<head><meta charset="utf-8"><title>wasmtime / issue #7469 Wasmtime `cargo test` fails on mac... · git-wasmtime · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/index.html">git-wasmtime</a></h2>
<h3>Topic: <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.237469.20Wasmtime.20.60cargo.20test.60.20fails.20on.20mac.2E.2E.2E.html">wasmtime / issue #7469 Wasmtime `cargo test` fails on mac...</a></h3>

<hr>

<base href="https://bytecodealliance.zulipchat.com">

<head><link href="https://bytecodealliance.github.io/zulip-archive/style.css" rel="stylesheet"></head>

<a name="400072330"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%237469%20Wasmtime%20%60cargo%20test%60%20fails%20on%20mac.../near/400072330" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.237469.20Wasmtime.20.60cargo.20test.60.20fails.20on.20mac.2E.2E.2E.html#400072330">(Nov 03 2023 at 06:25)</a>:</h4>
<p>cfallin opened <a href="https://github.com/bytecodealliance/wasmtime/issues/7469">issue #7469</a>:</p>
<blockquote>
<p>On my M1 machine, with Rust 1.73.0, having removed <code>target/</code> and starting from a fresh <code>main</code> (<code>630f8e32d8921a08ead7d27955686342f9f6fa06</code>), I see:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="n">cfallin</span><span class="o">@</span><span class="n">min</span>:<span class="o">~/</span><span class="n">work</span><span class="o">/</span><span class="n">wasmtime</span><span class="o">%</span><span class="w"> </span><span class="n">cargo</span><span class="w"> </span><span class="n">test</span>
<span class="p">[</span><span class="w"> </span><span class="o">..</span><span class="p">.]</span>
<span class="w">     </span><span class="n">Compiling</span><span class="w"> </span><span class="n">object</span><span class="w"> </span><span class="n">v0</span><span class="p">.</span><span class="mf">32.0</span>
<span class="w">     </span><span class="n">Compiling</span><span class="w"> </span><span class="n">wasi</span><span class="w"> </span><span class="n">v0</span><span class="p">.</span><span class="mf">11.0</span><span class="o">+</span><span class="n">wasi</span><span class="o">-</span><span class="n">snapshot</span><span class="o">-</span><span class="n">preview1</span>
<span class="w">     </span><span class="n">Compiling</span><span class="w"> </span><span class="n">serde_derive</span><span class="w"> </span><span class="n">v1</span><span class="p">.</span><span class="mf">0.188</span>
<span class="w">     </span><span class="n">Compiling</span><span class="w"> </span><span class="n">wasi</span><span class="o">-</span><span class="n">preview1</span><span class="o">-</span><span class="n">component</span><span class="o">-</span><span class="n">adapter</span><span class="w"> </span><span class="n">v15</span><span class="p">.</span><span class="mf">0.0</span><span class="w"> </span><span class="p">(</span><span class="o">/</span><span class="n">Users</span><span class="o">/</span><span class="n">cfallin</span><span class="o">/</span><span class="n">work</span><span class="o">/</span><span class="n">wasmtime</span><span class="o">/</span><span class="n">crates</span><span class="o">/</span><span class="n">wasi</span><span class="o">-</span><span class="n">preview1</span><span class="o">-</span><span class="n">component</span><span class="o">-</span><span class="n">adapter</span><span class="p">)</span>
<span class="w">  </span><span class="n">error</span>: <span class="nc">failed</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">run</span><span class="w"> </span><span class="n">custom</span><span class="w"> </span><span class="n">build</span><span class="w"> </span><span class="n">command</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="err">`</span><span class="n">wasi</span><span class="o">-</span><span class="n">preview1</span><span class="o">-</span><span class="n">component</span><span class="o">-</span><span class="n">adapter</span><span class="w"> </span><span class="n">v15</span><span class="p">.</span><span class="mf">0.0</span><span class="w"> </span><span class="p">(</span><span class="o">/</span><span class="n">Users</span><span class="o">/</span><span class="n">cfallin</span><span class="o">/</span><span class="n">work</span><span class="o">/</span><span class="n">wasmtime</span><span class="o">/</span><span class="n">crates</span><span class="o">/</span><span class="n">wasi</span><span class="o">-</span><span class="n">preview1</span><span class="o">-</span><span class="n">component</span><span class="o">-</span><span class="n">adapter</span><span class="p">)</span><span class="err">`</span>

<span class="w">  </span><span class="n">Caused</span><span class="w"> </span><span class="n">by</span>:
    <span class="nc">process</span><span class="w"> </span><span class="n">didn</span><span class="o">'</span><span class="na">t</span><span class="w"> </span><span class="n">exit</span><span class="w"> </span><span class="n">successfully</span>: <span class="err">`</span><span class="o">/</span><span class="n">Users</span><span class="o">/</span><span class="n">cfallin</span><span class="o">/</span><span class="n">work</span><span class="o">/</span><span class="n">wasmtime</span><span class="o">/</span><span class="n">target</span><span class="o">/</span><span class="n">debug</span><span class="o">/</span><span class="n">build</span><span class="o">/</span><span class="n">test</span><span class="o">-</span><span class="n">programs</span><span class="o">-</span><span class="n">artifacts</span><span class="o">-</span><span class="mi">02</span><span class="n">bef33e1d1021a1</span><span class="o">/</span><span class="n">out</span><span class="o">/</span><span class="n">release</span><span class="o">/</span><span class="n">build</span><span class="o">/</span><span class="n">wasi</span><span class="o">-</span><span class="n">preview1</span><span class="o">-</span><span class="n">component</span><span class="o">-</span><span class="n">adapter</span><span class="o">-</span><span class="n">ced036fa4eed0f20</span><span class="o">/</span><span class="n">build</span><span class="o">-</span><span class="n">script</span><span class="o">-</span><span class="n">build</span><span class="err">`</span><span class="w"> </span><span class="p">(</span><span class="n">signal</span>: <span class="mi">9</span><span class="p">,</span><span class="w"> </span><span class="n">SIGKILL</span>: <span class="nc">kill</span><span class="p">)</span>
<span class="w">  </span><span class="n">warning</span>: <span class="nc">build</span><span class="w"> </span><span class="n">failed</span><span class="p">,</span><span class="w"> </span><span class="n">waiting</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">other</span><span class="w"> </span><span class="n">jobs</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">finish</span><span class="o">..</span><span class="p">.</span>
<span class="w">  </span><span class="n">thread</span><span class="w"> </span><span class="o">'</span><span class="na">main</span><span class="o">'</span><span class="w"> </span><span class="n">panicked</span><span class="w"> </span><span class="n">at</span><span class="w"> </span><span class="n">crates</span><span class="o">/</span><span class="n">test</span><span class="o">-</span><span class="n">programs</span><span class="o">/</span><span class="n">artifacts</span><span class="o">/</span><span class="n">build</span><span class="p">.</span><span class="n">rs</span>:<span class="mi">122</span>:<span class="mi">5</span>:
  <span class="nc">assertion</span><span class="w"> </span><span class="n">failed</span>: <span class="nc">status</span><span class="p">.</span><span class="n">success</span><span class="p">()</span>
<span class="w">  </span><span class="n">note</span>: <span class="nc">run</span><span class="w"> </span><span class="n">with</span><span class="w"> </span><span class="err">`</span><span class="n">RUST_BACKTRACE</span><span class="o">=</span><span class="mi">1</span><span class="err">`</span><span class="w"> </span><span class="n">environment</span><span class="w"> </span><span class="n">variable</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">display</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="n">backtrace</span>
</code></pre></div>
<p>and if I try launching <code>build-script-build</code> manually, I see</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="n">cfallin</span><span class="o">@</span><span class="n">min</span>:<span class="o">~/</span><span class="n">work</span><span class="o">/</span><span class="n">wasmtime</span><span class="o">%</span><span class="w"> </span><span class="o">/</span><span class="n">Users</span><span class="o">/</span><span class="n">cfallin</span><span class="o">/</span><span class="n">work</span><span class="o">/</span><span class="n">wasmtime</span><span class="o">/</span><span class="n">target</span><span class="o">/</span><span class="n">debug</span><span class="o">/</span><span class="n">build</span><span class="o">/</span><span class="n">test</span><span class="o">-</span><span class="n">programs</span><span class="o">-</span><span class="n">artifacts</span><span class="o">-</span><span class="mi">02</span><span class="n">bef33e1d1021a1</span><span class="o">/</span><span class="n">out</span><span class="o">/</span><span class="n">release</span><span class="o">/</span><span class="n">build</span><span class="o">/</span><span class="n">wasi</span><span class="o">-</span><span class="n">preview1</span><span class="o">-</span><span class="n">component</span><span class="o">-</span><span class="n">adapter</span><span class="o">-</span><span class="n">ced036fa4eed0f20</span><span class="o">/</span><span class="n">build</span><span class="o">-</span><span class="n">script</span><span class="o">-</span><span class="n">build</span>
<span class="n">zsh</span>: <span class="nc">killed</span>
</code></pre></div>
<p>A little more digging indicates</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="n">cfallin</span><span class="o">@</span><span class="n">min</span>:<span class="o">~/</span><span class="n">work</span><span class="o">/</span><span class="n">wasmtime</span><span class="o">%</span><span class="w"> </span><span class="n">codesign</span><span class="w"> </span><span class="o">-</span><span class="n">v</span><span class="w"> </span><span class="o">/</span><span class="n">Users</span><span class="o">/</span><span class="n">cfallin</span><span class="o">/</span><span class="n">work</span><span class="o">/</span><span class="n">wasmtime</span><span class="o">/</span><span class="n">target</span><span class="o">/</span><span class="n">debug</span><span class="o">/</span><span class="n">build</span><span class="o">/</span><span class="n">test</span><span class="o">-</span><span class="n">programs</span><span class="o">-</span><span class="n">artifacts</span><span class="o">-</span><span class="mi">02</span><span class="n">bef33e1d1021a1</span><span class="o">/</span><span class="n">out</span><span class="o">/</span><span class="n">release</span><span class="o">/</span><span class="n">build</span><span class="o">/</span><span class="n">wasi</span><span class="o">-</span><span class="n">preview1</span><span class="o">-</span><span class="n">component</span><span class="o">-</span><span class="n">adapter</span><span class="o">-</span><span class="n">ced036fa4eed0f20</span><span class="o">/</span><span class="n">build</span><span class="o">-</span><span class="n">script</span><span class="o">-</span><span class="n">build</span>
<span class="o">/</span><span class="n">Users</span><span class="o">/</span><span class="n">cfallin</span><span class="o">/</span><span class="n">work</span><span class="o">/</span><span class="n">wasmtime</span><span class="o">/</span><span class="n">target</span><span class="o">/</span><span class="n">debug</span><span class="o">/</span><span class="n">build</span><span class="o">/</span><span class="n">test</span><span class="o">-</span><span class="n">programs</span><span class="o">-</span><span class="n">artifacts</span><span class="o">-</span><span class="mi">02</span><span class="n">bef33e1d1021a1</span><span class="o">/</span><span class="n">out</span><span class="o">/</span><span class="n">release</span><span class="o">/</span><span class="n">build</span><span class="o">/</span><span class="n">wasi</span><span class="o">-</span><span class="n">preview1</span><span class="o">-</span><span class="n">component</span><span class="o">-</span><span class="n">adapter</span><span class="o">-</span><span class="n">ced036fa4eed0f20</span><span class="o">/</span><span class="n">build</span><span class="o">-</span><span class="n">script</span><span class="o">-</span><span class="n">build</span>: <span class="nc">code</span><span class="w"> </span><span class="n">object</span><span class="w"> </span><span class="n">is</span><span class="w"> </span><span class="n">not</span><span class="w"> </span><span class="n">signed</span><span class="w"> </span><span class="n">at</span><span class="w"> </span><span class="n">all</span>
<span class="n">In</span><span class="w"> </span><span class="n">architecture</span>: <span class="nc">arm64</span>
</code></pre></div>
<p>which is wildly confusing, because macOS/aarch64 requires all binaries to be signed (even just locally), and the way that dev-tools normally handle this is by invoking <code>codesign</code> after linking to add an ad-hoc local signature. Lack of any signature would explain <code>SIGKILL</code> from the kernel.</p>
<p>I'm also fairly perplexed because I believe I'm not the only one here using macOS/aarch64 (cc @alexcrichton at the very least?). The one slightly non-mainstream-path thing I'm doing is using Nix/home-manager locally (<code>rustup</code> and <code>cargo</code> are both <code>~/.nix-profile/bin/cargo</code>) but local Rust development works perfectly fine otherwise.</p>
<p>I'm not sure what to debug from here -- but is there some custom build invocation somewhere that is doing something manually and not signing the binary?</p>
</blockquote>



<a name="400072471"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%237469%20Wasmtime%20%60cargo%20test%60%20fails%20on%20mac.../near/400072471" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.237469.20Wasmtime.20.60cargo.20test.60.20fails.20on.20mac.2E.2E.2E.html#400072471">(Nov 03 2023 at 06:26)</a>:</h4>
<p>cfallin edited <a href="https://github.com/bytecodealliance/wasmtime/issues/7469">issue #7469</a>:</p>
<blockquote>
<p>On my M1 machine, with Rust 1.73.0, having removed <code>target/</code> and starting from a fresh <code>main</code> (<code>630f8e32d8921a08ead7d27955686342f9f6fa06</code>), I see:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="n">cfallin</span><span class="o">@</span><span class="n">min</span>:<span class="o">~/</span><span class="n">work</span><span class="o">/</span><span class="n">wasmtime</span><span class="o">%</span><span class="w"> </span><span class="n">cargo</span><span class="w"> </span><span class="n">test</span>
<span class="p">[</span><span class="w"> </span><span class="o">..</span><span class="p">.]</span>
<span class="w">     </span><span class="n">Compiling</span><span class="w"> </span><span class="n">object</span><span class="w"> </span><span class="n">v0</span><span class="p">.</span><span class="mf">32.0</span>
<span class="w">     </span><span class="n">Compiling</span><span class="w"> </span><span class="n">wasi</span><span class="w"> </span><span class="n">v0</span><span class="p">.</span><span class="mf">11.0</span><span class="o">+</span><span class="n">wasi</span><span class="o">-</span><span class="n">snapshot</span><span class="o">-</span><span class="n">preview1</span>
<span class="w">     </span><span class="n">Compiling</span><span class="w"> </span><span class="n">serde_derive</span><span class="w"> </span><span class="n">v1</span><span class="p">.</span><span class="mf">0.188</span>
<span class="w">     </span><span class="n">Compiling</span><span class="w"> </span><span class="n">wasi</span><span class="o">-</span><span class="n">preview1</span><span class="o">-</span><span class="n">component</span><span class="o">-</span><span class="n">adapter</span><span class="w"> </span><span class="n">v15</span><span class="p">.</span><span class="mf">0.0</span><span class="w"> </span><span class="p">(</span><span class="o">/</span><span class="n">Users</span><span class="o">/</span><span class="n">cfallin</span><span class="o">/</span><span class="n">work</span><span class="o">/</span><span class="n">wasmtime</span><span class="o">/</span><span class="n">crates</span><span class="o">/</span><span class="n">wasi</span><span class="o">-</span><span class="n">preview1</span><span class="o">-</span><span class="n">component</span><span class="o">-</span><span class="n">adapter</span><span class="p">)</span>
<span class="w">  </span><span class="n">error</span>: <span class="nc">failed</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">run</span><span class="w"> </span><span class="n">custom</span><span class="w"> </span><span class="n">build</span><span class="w"> </span><span class="n">command</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="err">`</span><span class="n">wasi</span><span class="o">-</span><span class="n">preview1</span><span class="o">-</span><span class="n">component</span><span class="o">-</span><span class="n">adapter</span><span class="w"> </span><span class="n">v15</span><span class="p">.</span><span class="mf">0.0</span><span class="w"> </span><span class="p">(</span><span class="o">/</span><span class="n">Users</span><span class="o">/</span><span class="n">cfallin</span><span class="o">/</span><span class="n">work</span><span class="o">/</span><span class="n">wasmtime</span><span class="o">/</span><span class="n">crates</span><span class="o">/</span><span class="n">wasi</span><span class="o">-</span><span class="n">preview1</span><span class="o">-</span><span class="n">component</span><span class="o">-</span><span class="n">adapter</span><span class="p">)</span><span class="err">`</span>

<span class="w">  </span><span class="n">Caused</span><span class="w"> </span><span class="n">by</span>:
    <span class="nc">process</span><span class="w"> </span><span class="n">didn</span><span class="o">'</span><span class="na">t</span><span class="w"> </span><span class="n">exit</span><span class="w"> </span><span class="n">successfully</span>: <span class="err">`</span><span class="o">/</span><span class="n">Users</span><span class="o">/</span><span class="n">cfallin</span><span class="o">/</span><span class="n">work</span><span class="o">/</span><span class="n">wasmtime</span><span class="o">/</span><span class="n">target</span><span class="o">/</span><span class="n">debug</span><span class="o">/</span><span class="n">build</span><span class="o">/</span><span class="n">test</span><span class="o">-</span><span class="n">programs</span><span class="o">-</span><span class="n">artifacts</span><span class="o">-</span><span class="mi">02</span><span class="n">bef33e1d1021a1</span><span class="o">/</span><span class="n">out</span><span class="o">/</span><span class="n">release</span><span class="o">/</span><span class="n">build</span><span class="o">/</span><span class="n">wasi</span><span class="o">-</span><span class="n">preview1</span><span class="o">-</span><span class="n">component</span><span class="o">-</span><span class="n">adapter</span><span class="o">-</span><span class="n">ced036fa4eed0f20</span><span class="o">/</span><span class="n">build</span><span class="o">-</span><span class="n">script</span><span class="o">-</span><span class="n">build</span><span class="err">`</span><span class="w"> </span><span class="p">(</span><span class="n">signal</span>: <span class="mi">9</span><span class="p">,</span><span class="w"> </span><span class="n">SIGKILL</span>: <span class="nc">kill</span><span class="p">)</span>
<span class="w">  </span><span class="n">warning</span>: <span class="nc">build</span><span class="w"> </span><span class="n">failed</span><span class="p">,</span><span class="w"> </span><span class="n">waiting</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">other</span><span class="w"> </span><span class="n">jobs</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">finish</span><span class="o">..</span><span class="p">.</span>
<span class="w">  </span><span class="n">thread</span><span class="w"> </span><span class="o">'</span><span class="na">main</span><span class="o">'</span><span class="w"> </span><span class="n">panicked</span><span class="w"> </span><span class="n">at</span><span class="w"> </span><span class="n">crates</span><span class="o">/</span><span class="n">test</span><span class="o">-</span><span class="n">programs</span><span class="o">/</span><span class="n">artifacts</span><span class="o">/</span><span class="n">build</span><span class="p">.</span><span class="n">rs</span>:<span class="mi">122</span>:<span class="mi">5</span>:
  <span class="nc">assertion</span><span class="w"> </span><span class="n">failed</span>: <span class="nc">status</span><span class="p">.</span><span class="n">success</span><span class="p">()</span>
<span class="w">  </span><span class="n">note</span>: <span class="nc">run</span><span class="w"> </span><span class="n">with</span><span class="w"> </span><span class="err">`</span><span class="n">RUST_BACKTRACE</span><span class="o">=</span><span class="mi">1</span><span class="err">`</span><span class="w"> </span><span class="n">environment</span><span class="w"> </span><span class="n">variable</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">display</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="n">backtrace</span>
</code></pre></div>
<p>and if I try launching <code>build-script-build</code> manually, I see</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="n">cfallin</span><span class="o">@</span><span class="n">min</span>:<span class="o">~/</span><span class="n">work</span><span class="o">/</span><span class="n">wasmtime</span><span class="o">%</span><span class="w"> </span><span class="o">/</span><span class="n">Users</span><span class="o">/</span><span class="n">cfallin</span><span class="o">/</span><span class="n">work</span><span class="o">/</span><span class="n">wasmtime</span><span class="o">/</span><span class="n">target</span><span class="o">/</span><span class="n">debug</span><span class="o">/</span><span class="n">build</span><span class="o">/</span><span class="n">test</span><span class="o">-</span><span class="n">programs</span><span class="o">-</span><span class="n">artifacts</span><span class="o">-</span><span class="mi">02</span><span class="n">bef33e1d1021a1</span><span class="o">/</span><span class="n">out</span><span class="o">/</span><span class="n">release</span><span class="o">/</span><span class="n">build</span><span class="o">/</span><span class="n">wasi</span><span class="o">-</span><span class="n">preview1</span><span class="o">-</span><span class="n">component</span><span class="o">-</span><span class="n">adapter</span><span class="o">-</span><span class="n">ced036fa4eed0f20</span><span class="o">/</span><span class="n">build</span><span class="o">-</span><span class="n">script</span><span class="o">-</span><span class="n">build</span>
<span class="n">zsh</span>: <span class="nc">killed</span>
</code></pre></div>
<p>A little more digging indicates</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="n">cfallin</span><span class="o">@</span><span class="n">min</span>:<span class="o">~/</span><span class="n">work</span><span class="o">/</span><span class="n">wasmtime</span><span class="o">%</span><span class="w"> </span><span class="n">codesign</span><span class="w"> </span><span class="o">-</span><span class="n">v</span><span class="w"> </span><span class="o">/</span><span class="n">Users</span><span class="o">/</span><span class="n">cfallin</span><span class="o">/</span><span class="n">work</span><span class="o">/</span><span class="n">wasmtime</span><span class="o">/</span><span class="n">target</span><span class="o">/</span><span class="n">debug</span><span class="o">/</span><span class="n">build</span><span class="o">/</span><span class="n">test</span><span class="o">-</span><span class="n">programs</span><span class="o">-</span><span class="n">artifacts</span><span class="o">-</span><span class="mi">02</span><span class="n">bef33e1d1021a1</span><span class="o">/</span><span class="n">out</span><span class="o">/</span><span class="n">release</span><span class="o">/</span><span class="n">build</span><span class="o">/</span><span class="n">wasi</span><span class="o">-</span><span class="n">preview1</span><span class="o">-</span><span class="n">component</span><span class="o">-</span><span class="n">adapter</span><span class="o">-</span><span class="n">ced036fa4eed0f20</span><span class="o">/</span><span class="n">build</span><span class="o">-</span><span class="n">script</span><span class="o">-</span><span class="n">build</span>
<span class="o">/</span><span class="n">Users</span><span class="o">/</span><span class="n">cfallin</span><span class="o">/</span><span class="n">work</span><span class="o">/</span><span class="n">wasmtime</span><span class="o">/</span><span class="n">target</span><span class="o">/</span><span class="n">debug</span><span class="o">/</span><span class="n">build</span><span class="o">/</span><span class="n">test</span><span class="o">-</span><span class="n">programs</span><span class="o">-</span><span class="n">artifacts</span><span class="o">-</span><span class="mi">02</span><span class="n">bef33e1d1021a1</span><span class="o">/</span><span class="n">out</span><span class="o">/</span><span class="n">release</span><span class="o">/</span><span class="n">build</span><span class="o">/</span><span class="n">wasi</span><span class="o">-</span><span class="n">preview1</span><span class="o">-</span><span class="n">component</span><span class="o">-</span><span class="n">adapter</span><span class="o">-</span><span class="n">ced036fa4eed0f20</span><span class="o">/</span><span class="n">build</span><span class="o">-</span><span class="n">script</span><span class="o">-</span><span class="n">build</span>: <span class="nc">code</span><span class="w"> </span><span class="n">object</span><span class="w"> </span><span class="n">is</span><span class="w"> </span><span class="n">not</span><span class="w"> </span><span class="n">signed</span><span class="w"> </span><span class="n">at</span><span class="w"> </span><span class="n">all</span>
<span class="n">In</span><span class="w"> </span><span class="n">architecture</span>: <span class="nc">arm64</span>
</code></pre></div>
<p>which is wildly confusing, because macOS/aarch64 requires all binaries to be signed (even just locally), and the way that dev-tools normally handle this is by invoking <code>codesign</code> after linking to add an ad-hoc local signature. Lack of any signature would explain <code>SIGKILL</code> from the kernel.</p>
<p>I'm also fairly perplexed because I believe I'm not the only one here using macOS/aarch64 (cc @alexcrichton at the very least?). The one slightly non-mainstream-path thing I'm doing is using Nix/home-manager locally (<code>rustup</code> and <code>cargo</code> are <code>~/.nix-profile/bin/{rustup,cargo}</code>) but local Rust development works perfectly fine otherwise.</p>
<p>I'm not sure what to debug from here -- but is there some custom build invocation somewhere that is doing something manually and not signing the binary?</p>
</blockquote>



<a name="400131653"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%237469%20Wasmtime%20%60cargo%20test%60%20fails%20on%20mac.../near/400131653" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.237469.20Wasmtime.20.60cargo.20test.60.20fails.20on.20mac.2E.2E.2E.html#400131653">(Nov 03 2023 at 13:14)</a>:</h4>
<p>alexcrichton <a href="https://github.com/bytecodealliance/wasmtime/issues/7469#issuecomment-1792418080">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/7469">issue #7469</a>:</p>
<blockquote>
<p>What macOS version are you on? I haven't had any issues myself but I also haven't updated to the latest (sonoma I think?), I'm on 13.5.1.</p>
<p>I'm not aware of anything codesigning related that rustc does myself, so if this is a new requirement of sonoma then that may be what's happening. Otherwise does this reproduce in a "hello world" for example with <code>cargo run</code>? (e.g. can any rustc-generated executable run on your system?)</p>
</blockquote>



<a name="400160340"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%237469%20Wasmtime%20%60cargo%20test%60%20fails%20on%20mac.../near/400160340" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.237469.20Wasmtime.20.60cargo.20test.60.20fails.20on.20mac.2E.2E.2E.html#400160340">(Nov 03 2023 at 15:49)</a>:</h4>
<p>cfallin <a href="https://github.com/bytecodealliance/wasmtime/issues/7469#issuecomment-1792686416">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/7469">issue #7469</a>:</p>
<blockquote>
<p>I'm on Ventura (13.6) -- haven't updated to Sonoma yet.</p>
<p>Codesigning has actually been a platform requirement on macOS/aarch64 since Apple Silicon rolled out; it's handled mostly transparently in either the linker or compiler drivers (I'm not sure which) by adding an ad-hoc signature to any binary one compiles locally. That's part of why I'm so surprised this is coming up!</p>
<p>I can build and run a Hello World fine; I've been building <code>cilf-util</code> and <code>wasmtime</code> (CLI binary) and developing with both for the past few weeks with no problem; it's just now that I thought to do a <code>cargo test</code> locally in the root and discovered this.</p>
<p>I can reproduce both on personal (M1) and work (M2) laptops; I'll try to bisect further...</p>
</blockquote>



<a name="400163301"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%237469%20Wasmtime%20%60cargo%20test%60%20fails%20on%20mac.../near/400163301" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.237469.20Wasmtime.20.60cargo.20test.60.20fails.20on.20mac.2E.2E.2E.html#400163301">(Nov 03 2023 at 16:04)</a>:</h4>
<p>alexcrichton <a href="https://github.com/bytecodealliance/wasmtime/issues/7469#issuecomment-1792710171">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/7469">issue #7469</a>:</p>
<blockquote>
<p>Weird! I dunno if something changed in 13.6, but I at least have been running tests regularly on an M2 for months now with no hiccups. I'd be pretty surprised if Nix factored meaningfully into this, so I'm as confused as you are...</p>
</blockquote>



<a name="400164671"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%237469%20Wasmtime%20%60cargo%20test%60%20fails%20on%20mac.../near/400164671" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.237469.20Wasmtime.20.60cargo.20test.60.20fails.20on.20mac.2E.2E.2E.html#400164671">(Nov 03 2023 at 16:12)</a>:</h4>
<p>cfallin <a href="https://github.com/bytecodealliance/wasmtime/issues/7469#issuecomment-1792726539">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/7469">issue #7469</a>:</p>
<blockquote>
<p>I've bisected this to f4be360648e080aae8d856967e6d2c40cccf57da (#7182), in a clean checkout and removing <code>target</code> each time to avoid incremental compilation weirdness. I guess that's the PR I would have suspected as well. Trying to dig into the actual failure now...</p>
</blockquote>



<a name="400166148"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%237469%20Wasmtime%20%60cargo%20test%60%20fails%20on%20mac.../near/400166148" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.237469.20Wasmtime.20.60cargo.20test.60.20fails.20on.20mac.2E.2E.2E.html#400166148">(Nov 03 2023 at 16:19)</a>:</h4>
<p>cfallin closed <a href="https://github.com/bytecodealliance/wasmtime/issues/7469">issue #7469</a>:</p>
<blockquote>
<p>On my M1 machine, with Rust 1.73.0, having removed <code>target/</code> and starting from a fresh <code>main</code> (<code>630f8e32d8921a08ead7d27955686342f9f6fa06</code>), I see:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="n">cfallin</span><span class="o">@</span><span class="n">min</span>:<span class="o">~/</span><span class="n">work</span><span class="o">/</span><span class="n">wasmtime</span><span class="o">%</span><span class="w"> </span><span class="n">cargo</span><span class="w"> </span><span class="n">test</span>
<span class="p">[</span><span class="w"> </span><span class="o">..</span><span class="p">.]</span>
<span class="w">     </span><span class="n">Compiling</span><span class="w"> </span><span class="n">object</span><span class="w"> </span><span class="n">v0</span><span class="p">.</span><span class="mf">32.0</span>
<span class="w">     </span><span class="n">Compiling</span><span class="w"> </span><span class="n">wasi</span><span class="w"> </span><span class="n">v0</span><span class="p">.</span><span class="mf">11.0</span><span class="o">+</span><span class="n">wasi</span><span class="o">-</span><span class="n">snapshot</span><span class="o">-</span><span class="n">preview1</span>
<span class="w">     </span><span class="n">Compiling</span><span class="w"> </span><span class="n">serde_derive</span><span class="w"> </span><span class="n">v1</span><span class="p">.</span><span class="mf">0.188</span>
<span class="w">     </span><span class="n">Compiling</span><span class="w"> </span><span class="n">wasi</span><span class="o">-</span><span class="n">preview1</span><span class="o">-</span><span class="n">component</span><span class="o">-</span><span class="n">adapter</span><span class="w"> </span><span class="n">v15</span><span class="p">.</span><span class="mf">0.0</span><span class="w"> </span><span class="p">(</span><span class="o">/</span><span class="n">Users</span><span class="o">/</span><span class="n">cfallin</span><span class="o">/</span><span class="n">work</span><span class="o">/</span><span class="n">wasmtime</span><span class="o">/</span><span class="n">crates</span><span class="o">/</span><span class="n">wasi</span><span class="o">-</span><span class="n">preview1</span><span class="o">-</span><span class="n">component</span><span class="o">-</span><span class="n">adapter</span><span class="p">)</span>
<span class="w">  </span><span class="n">error</span>: <span class="nc">failed</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">run</span><span class="w"> </span><span class="n">custom</span><span class="w"> </span><span class="n">build</span><span class="w"> </span><span class="n">command</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="err">`</span><span class="n">wasi</span><span class="o">-</span><span class="n">preview1</span><span class="o">-</span><span class="n">component</span><span class="o">-</span><span class="n">adapter</span><span class="w"> </span><span class="n">v15</span><span class="p">.</span><span class="mf">0.0</span><span class="w"> </span><span class="p">(</span><span class="o">/</span><span class="n">Users</span><span class="o">/</span><span class="n">cfallin</span><span class="o">/</span><span class="n">work</span><span class="o">/</span><span class="n">wasmtime</span><span class="o">/</span><span class="n">crates</span><span class="o">/</span><span class="n">wasi</span><span class="o">-</span><span class="n">preview1</span><span class="o">-</span><span class="n">component</span><span class="o">-</span><span class="n">adapter</span><span class="p">)</span><span class="err">`</span>

<span class="w">  </span><span class="n">Caused</span><span class="w"> </span><span class="n">by</span>:
    <span class="nc">process</span><span class="w"> </span><span class="n">didn</span><span class="o">'</span><span class="na">t</span><span class="w"> </span><span class="n">exit</span><span class="w"> </span><span class="n">successfully</span>: <span class="err">`</span><span class="o">/</span><span class="n">Users</span><span class="o">/</span><span class="n">cfallin</span><span class="o">/</span><span class="n">work</span><span class="o">/</span><span class="n">wasmtime</span><span class="o">/</span><span class="n">target</span><span class="o">/</span><span class="n">debug</span><span class="o">/</span><span class="n">build</span><span class="o">/</span><span class="n">test</span><span class="o">-</span><span class="n">programs</span><span class="o">-</span><span class="n">artifacts</span><span class="o">-</span><span class="mi">02</span><span class="n">bef33e1d1021a1</span><span class="o">/</span><span class="n">out</span><span class="o">/</span><span class="n">release</span><span class="o">/</span><span class="n">build</span><span class="o">/</span><span class="n">wasi</span><span class="o">-</span><span class="n">preview1</span><span class="o">-</span><span class="n">component</span><span class="o">-</span><span class="n">adapter</span><span class="o">-</span><span class="n">ced036fa4eed0f20</span><span class="o">/</span><span class="n">build</span><span class="o">-</span><span class="n">script</span><span class="o">-</span><span class="n">build</span><span class="err">`</span><span class="w"> </span><span class="p">(</span><span class="n">signal</span>: <span class="mi">9</span><span class="p">,</span><span class="w"> </span><span class="n">SIGKILL</span>: <span class="nc">kill</span><span class="p">)</span>
<span class="w">  </span><span class="n">warning</span>: <span class="nc">build</span><span class="w"> </span><span class="n">failed</span><span class="p">,</span><span class="w"> </span><span class="n">waiting</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">other</span><span class="w"> </span><span class="n">jobs</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">finish</span><span class="o">..</span><span class="p">.</span>
<span class="w">  </span><span class="n">thread</span><span class="w"> </span><span class="o">'</span><span class="na">main</span><span class="o">'</span><span class="w"> </span><span class="n">panicked</span><span class="w"> </span><span class="n">at</span><span class="w"> </span><span class="n">crates</span><span class="o">/</span><span class="n">test</span><span class="o">-</span><span class="n">programs</span><span class="o">/</span><span class="n">artifacts</span><span class="o">/</span><span class="n">build</span><span class="p">.</span><span class="n">rs</span>:<span class="mi">122</span>:<span class="mi">5</span>:
  <span class="nc">assertion</span><span class="w"> </span><span class="n">failed</span>: <span class="nc">status</span><span class="p">.</span><span class="n">success</span><span class="p">()</span>
<span class="w">  </span><span class="n">note</span>: <span class="nc">run</span><span class="w"> </span><span class="n">with</span><span class="w"> </span><span class="err">`</span><span class="n">RUST_BACKTRACE</span><span class="o">=</span><span class="mi">1</span><span class="err">`</span><span class="w"> </span><span class="n">environment</span><span class="w"> </span><span class="n">variable</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">display</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="n">backtrace</span>
</code></pre></div>
<p>and if I try launching <code>build-script-build</code> manually, I see</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="n">cfallin</span><span class="o">@</span><span class="n">min</span>:<span class="o">~/</span><span class="n">work</span><span class="o">/</span><span class="n">wasmtime</span><span class="o">%</span><span class="w"> </span><span class="o">/</span><span class="n">Users</span><span class="o">/</span><span class="n">cfallin</span><span class="o">/</span><span class="n">work</span><span class="o">/</span><span class="n">wasmtime</span><span class="o">/</span><span class="n">target</span><span class="o">/</span><span class="n">debug</span><span class="o">/</span><span class="n">build</span><span class="o">/</span><span class="n">test</span><span class="o">-</span><span class="n">programs</span><span class="o">-</span><span class="n">artifacts</span><span class="o">-</span><span class="mi">02</span><span class="n">bef33e1d1021a1</span><span class="o">/</span><span class="n">out</span><span class="o">/</span><span class="n">release</span><span class="o">/</span><span class="n">build</span><span class="o">/</span><span class="n">wasi</span><span class="o">-</span><span class="n">preview1</span><span class="o">-</span><span class="n">component</span><span class="o">-</span><span class="n">adapter</span><span class="o">-</span><span class="n">ced036fa4eed0f20</span><span class="o">/</span><span class="n">build</span><span class="o">-</span><span class="n">script</span><span class="o">-</span><span class="n">build</span>
<span class="n">zsh</span>: <span class="nc">killed</span>
</code></pre></div>
<p>A little more digging indicates</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="n">cfallin</span><span class="o">@</span><span class="n">min</span>:<span class="o">~/</span><span class="n">work</span><span class="o">/</span><span class="n">wasmtime</span><span class="o">%</span><span class="w"> </span><span class="n">codesign</span><span class="w"> </span><span class="o">-</span><span class="n">v</span><span class="w"> </span><span class="o">/</span><span class="n">Users</span><span class="o">/</span><span class="n">cfallin</span><span class="o">/</span><span class="n">work</span><span class="o">/</span><span class="n">wasmtime</span><span class="o">/</span><span class="n">target</span><span class="o">/</span><span class="n">debug</span><span class="o">/</span><span class="n">build</span><span class="o">/</span><span class="n">test</span><span class="o">-</span><span class="n">programs</span><span class="o">-</span><span class="n">artifacts</span><span class="o">-</span><span class="mi">02</span><span class="n">bef33e1d1021a1</span><span class="o">/</span><span class="n">out</span><span class="o">/</span><span class="n">release</span><span class="o">/</span><span class="n">build</span><span class="o">/</span><span class="n">wasi</span><span class="o">-</span><span class="n">preview1</span><span class="o">-</span><span class="n">component</span><span class="o">-</span><span class="n">adapter</span><span class="o">-</span><span class="n">ced036fa4eed0f20</span><span class="o">/</span><span class="n">build</span><span class="o">-</span><span class="n">script</span><span class="o">-</span><span class="n">build</span>
<span class="o">/</span><span class="n">Users</span><span class="o">/</span><span class="n">cfallin</span><span class="o">/</span><span class="n">work</span><span class="o">/</span><span class="n">wasmtime</span><span class="o">/</span><span class="n">target</span><span class="o">/</span><span class="n">debug</span><span class="o">/</span><span class="n">build</span><span class="o">/</span><span class="n">test</span><span class="o">-</span><span class="n">programs</span><span class="o">-</span><span class="n">artifacts</span><span class="o">-</span><span class="mi">02</span><span class="n">bef33e1d1021a1</span><span class="o">/</span><span class="n">out</span><span class="o">/</span><span class="n">release</span><span class="o">/</span><span class="n">build</span><span class="o">/</span><span class="n">wasi</span><span class="o">-</span><span class="n">preview1</span><span class="o">-</span><span class="n">component</span><span class="o">-</span><span class="n">adapter</span><span class="o">-</span><span class="n">ced036fa4eed0f20</span><span class="o">/</span><span class="n">build</span><span class="o">-</span><span class="n">script</span><span class="o">-</span><span class="n">build</span>: <span class="nc">code</span><span class="w"> </span><span class="n">object</span><span class="w"> </span><span class="n">is</span><span class="w"> </span><span class="n">not</span><span class="w"> </span><span class="n">signed</span><span class="w"> </span><span class="n">at</span><span class="w"> </span><span class="n">all</span>
<span class="n">In</span><span class="w"> </span><span class="n">architecture</span>: <span class="nc">arm64</span>
</code></pre></div>
<p>which is wildly confusing, because macOS/aarch64 requires all binaries to be signed (even just locally), and the way that dev-tools normally handle this is by invoking <code>codesign</code> after linking to add an ad-hoc local signature. Lack of any signature would explain <code>SIGKILL</code> from the kernel.</p>
<p>I'm also fairly perplexed because I believe I'm not the only one here using macOS/aarch64 (cc @alexcrichton at the very least?). The one slightly non-mainstream-path thing I'm doing is using Nix/home-manager locally (<code>rustup</code> and <code>cargo</code> are <code>~/.nix-profile/bin/{rustup,cargo}</code>) but local Rust development works perfectly fine otherwise.</p>
<p>I'm not sure what to debug from here -- but is there some custom build invocation somewhere that is doing something manually and not signing the binary?</p>
</blockquote>



<a name="400166149"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%237469%20Wasmtime%20%60cargo%20test%60%20fails%20on%20mac.../near/400166149" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.237469.20Wasmtime.20.60cargo.20test.60.20fails.20on.20mac.2E.2E.2E.html#400166149">(Nov 03 2023 at 16:19)</a>:</h4>
<p>cfallin <a href="https://github.com/bytecodealliance/wasmtime/issues/7469#issuecomment-1792740693">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/7469">issue #7469</a>:</p>
<blockquote>
<p>I've worked it out: my home-manager setup was shadowing the system clang/LLVM with a Nix-provided clang/LLVM, and that one apparently knows how to create macOS/aarch64 binaries but does not sign them by default. (As one does?) And because home-manager is so neat and good at applying the same config everywhere, I had applied this to my work and personal laptops. Removing that shadowing and going back to system clang fixes the build. Sorry for the noise!</p>
</blockquote>



<hr><p>Last updated: Jan 20 2025 at 06:04 UTC</p>
</html>