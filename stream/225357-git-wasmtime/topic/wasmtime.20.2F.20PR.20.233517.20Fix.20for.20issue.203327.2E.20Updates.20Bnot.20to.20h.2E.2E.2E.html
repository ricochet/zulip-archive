<html>
<head><meta charset="utf-8"><title>wasmtime / PR #3517 Fix for issue 3327. Updates Bnot to h... · git-wasmtime · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/index.html">git-wasmtime</a></h2>
<h3>Topic: <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.233517.20Fix.20for.20issue.203327.2E.20Updates.20Bnot.20to.20h.2E.2E.2E.html">wasmtime / PR #3517 Fix for issue 3327. Updates Bnot to h...</a></h3>

<hr>

<base href="https://bytecodealliance.zulipchat.com">

<head><link href="https://bytecodealliance.github.io/zulip-archive/style.css" rel="stylesheet"></head>

<a name="261203241"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%233517%20Fix%20for%20issue%203327.%20Updates%20Bnot%20to%20h.../near/261203241" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.233517.20Fix.20for.20issue.203327.2E.20Updates.20Bnot.20to.20h.2E.2E.2E.html#261203241">(Nov 12 2021 at 01:36)</a>:</h4>
<p>jlb6740 opened <a href="https://github.com/bytecodealliance/wasmtime/pull/3517">PR #3517</a> from <code>fix-issue-3327</code> to <code>main</code>:</p>
<blockquote>
<p>&lt;!--</p>
<p>Please ensure that the following steps are all taken care of before submitting<br>
the PR.</p>
<ul>
<li>
<p>[ ] This has been discussed in issue #..., or if not, please tell us why<br>
  here.</p>
</li>
<li>
<p>[ ] A short description of what this does, why it is needed; if the<br>
  description becomes long, the matter should probably be discussed in an issue<br>
  first.</p>
</li>
<li>
<p>[ ] This PR contains test cases, if meaningful.</p>
</li>
<li>[ ] A reviewer from the core maintainer team has been assigned for this PR.<br>
  If you don't know who could review this, please indicate so. The list of<br>
  suggested reviewers on the right can help you.</li>
</ul>
<p>Please ensure all communication adheres to the <a href="https://github.com/bytecodealliance/wasmtime/blob/master/CODE_OF_CONDUCT.md">code of
conduct</a>.<br>
--&gt;<br>
</p>
</blockquote>



<a name="261203411"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%233517%20Fix%20for%20issue%203327.%20Updates%20Bnot%20to%20h.../near/261203411" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.233517.20Fix.20for.20issue.203327.2E.20Updates.20Bnot.20to.20h.2E.2E.2E.html#261203411">(Nov 12 2021 at 01:40)</a>:</h4>
<p><strong>jlb6740</strong> requested <a href="https://github.com/alexcrichton">alexcrichton</a> for a review on <a href="https://github.com/bytecodealliance/wasmtime/pull/3517">PR #3517</a>.</p>



<a name="261203416"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%233517%20Fix%20for%20issue%203327.%20Updates%20Bnot%20to%20h.../near/261203416" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.233517.20Fix.20for.20issue.203327.2E.20Updates.20Bnot.20to.20h.2E.2E.2E.html#261203416">(Nov 12 2021 at 01:40)</a>:</h4>
<p><strong>jlb6740</strong> requested <a href="https://github.com/cfallin">cfallin</a> for a review on <a href="https://github.com/bytecodealliance/wasmtime/pull/3517">PR #3517</a>.</p>



<a name="261311421"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%233517%20Fix%20for%20issue%203327.%20Updates%20Bnot%20to%20h.../near/261311421" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.233517.20Fix.20for.20issue.203327.2E.20Updates.20Bnot.20to.20h.2E.2E.2E.html#261311421">(Nov 12 2021 at 21:13)</a>:</h4>
<p>abrown submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/3517#pullrequestreview-805231235">PR review</a>.</p>



<a name="261311422"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%233517%20Fix%20for%20issue%203327.%20Updates%20Bnot%20to%20h.../near/261311422" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.233517.20Fix.20for.20issue.203327.2E.20Updates.20Bnot.20to.20h.2E.2E.2E.html#261311422">(Nov 12 2021 at 21:13)</a>:</h4>
<p>abrown created <a href="https://github.com/bytecodealliance/wasmtime/pull/3517#discussion_r748588818">PR review comment</a>:</p>
<blockquote>
<div class="codehilite" data-code-language="suggestion"><pre><span></span><code>                ctx.emit(Inst::equals(types::I32X4, RegMem::from(tmp), tmp));
</code></pre></div>
<p>This change would avoid the extra instruction and might fix the NaN comparison issue.</p>
</blockquote>



<a name="261503742"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%233517%20Fix%20for%20issue%203327.%20Updates%20Bnot%20to%20h.../near/261503742" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.233517.20Fix.20for.20issue.203327.2E.20Updates.20Bnot.20to.20h.2E.2E.2E.html#261503742">(Nov 15 2021 at 14:31)</a>:</h4>
<p>alexcrichton submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/3517#pullrequestreview-806139849">PR review</a>.</p>



<a name="261503743"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%233517%20Fix%20for%20issue%203327.%20Updates%20Bnot%20to%20h.../near/261503743" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.233517.20Fix.20for.20issue.203327.2E.20Updates.20Bnot.20to.20h.2E.2E.2E.html#261503743">(Nov 15 2021 at 14:31)</a>:</h4>
<p>alexcrichton created <a href="https://github.com/bytecodealliance/wasmtime/pull/3517#discussion_r749379373">PR review comment</a>:</p>
<blockquote>
<p>I believe this would fix the issue, yes, because this would avoid doing a floating-point-compare which runs the risk of doing NaN comparisons. I don't know about the performance implications of this, though, and whether it's better to do or not.</p>
<p>Otherwise though I think that this <code>xor</code> is probably worth both a comment and a test, or otherwise somehow sharing code with the other spot in <code>f32x4.abs</code> which generates an all-ones mask.</p>
</blockquote>



<a name="261525556"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%233517%20Fix%20for%20issue%203327.%20Updates%20Bnot%20to%20h.../near/261525556" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.233517.20Fix.20for.20issue.203327.2E.20Updates.20Bnot.20to.20h.2E.2E.2E.html#261525556">(Nov 15 2021 at 16:55)</a>:</h4>
<p>jlb6740 submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/3517#pullrequestreview-806322622">PR review</a>.</p>



<a name="261525558"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%233517%20Fix%20for%20issue%203327.%20Updates%20Bnot%20to%20h.../near/261525558" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.233517.20Fix.20for.20issue.203327.2E.20Updates.20Bnot.20to.20h.2E.2E.2E.html#261525558">(Nov 15 2021 at 16:55)</a>:</h4>
<p>jlb6740 created <a href="https://github.com/bytecodealliance/wasmtime/pull/3517#discussion_r749513116">PR review comment</a>:</p>
<blockquote>
<p>@alexcrichton @abrown The xorps isn't a new idea. It's what we do in a couple of places. For example here is the sequence that prompted the bug:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="p">(</span><span class="n">module</span><span class="w"></span>
<span class="w">  </span><span class="p">(</span><span class="n">func</span><span class="w"> </span><span class="p">(</span><span class="n">result</span><span class="w"> </span><span class="n">v128</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="n">v128</span><span class="p">.</span><span class="k">const</span><span class="w"> </span><span class="n">f32x4</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="mi">0</span><span class="w"></span>
<span class="w">    </span><span class="n">f32x4</span><span class="p">.</span><span class="n">abs</span><span class="w"></span>
<span class="w">    </span><span class="n">v128</span><span class="p">.</span><span class="n">not</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="p">(</span><span class="n">export</span><span class="w"> </span><span class="s">"1"</span><span class="w"> </span><span class="p">(</span><span class="n">func</span><span class="w"> </span><span class="mi">0</span><span class="p">))</span><span class="w"></span>
<span class="p">)</span><span class="w"></span>
</code></pre></div>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="mi">0000000000000000</span><span class="w"> </span><span class="o">&lt;</span><span class="n">_wasm_function_0</span><span class="o">&gt;</span>:
       <span class="mi">0</span>:       <span class="mi">55</span><span class="w">                      </span><span class="n">push</span><span class="w">   </span><span class="o">%</span><span class="n">rbp</span><span class="w"></span>
<span class="w">       </span><span class="mi">1</span>:       <span class="mi">48</span><span class="w"> </span><span class="mi">89</span><span class="w"> </span><span class="n">e5</span><span class="w">                </span><span class="n">mov</span><span class="w">    </span><span class="o">%</span><span class="n">rsp</span><span class="p">,</span><span class="o">%</span><span class="n">rbp</span><span class="w"></span>
<span class="w">       </span><span class="mi">4</span>:       <span class="nc">f3</span><span class="w"> </span><span class="mi">0</span><span class="n">f</span><span class="w"> </span><span class="mi">6</span><span class="n">f</span><span class="w"> </span><span class="mi">05</span><span class="w"> </span><span class="mi">24</span><span class="w"> </span><span class="mi">00</span><span class="w"> </span><span class="mi">00</span><span class="w">    </span><span class="n">movdqu</span><span class="w"> </span><span class="mh">0x24</span><span class="p">(</span><span class="o">%</span><span class="n">rip</span><span class="p">),</span><span class="o">%</span><span class="n">xmm0</span><span class="w">        </span>#<span class="w"> </span><span class="mi">30</span><span class="w"> </span><span class="o">&lt;</span><span class="n">_wasm_function_0</span><span class="o">+</span><span class="mh">0x30</span><span class="o">&gt;</span><span class="w"></span>
<span class="w">       </span><span class="n">b</span>:       <span class="mi">00</span><span class="w"></span>
<span class="w">       </span><span class="n">c</span>:       <span class="mi">0</span><span class="n">f</span><span class="w"> </span><span class="mi">57</span><span class="w"> </span><span class="n">c9</span><span class="w">                </span><span class="n">xorps</span><span class="w">  </span><span class="o">%</span><span class="n">xmm1</span><span class="p">,</span><span class="o">%</span><span class="n">xmm1</span><span class="w"></span>
<span class="w">       </span><span class="n">f</span>:       <span class="mi">0</span><span class="n">f</span><span class="w"> </span><span class="n">c2</span><span class="w"> </span><span class="n">c9</span><span class="w"> </span><span class="mi">00</span><span class="w">             </span><span class="n">cmpeqps</span><span class="w"> </span><span class="o">%</span><span class="n">xmm1</span><span class="p">,</span><span class="o">%</span><span class="n">xmm1</span><span class="w"></span>
<span class="w">      </span><span class="mi">13</span>:       <span class="mi">66</span><span class="w"> </span><span class="mi">0</span><span class="n">f</span><span class="w"> </span><span class="mi">72</span><span class="w"> </span><span class="n">d1</span><span class="w"> </span><span class="mi">01</span><span class="w">          </span><span class="n">psrld</span><span class="w">  </span><span class="cp">$</span><span class="mh">0x1</span><span class="p">,</span><span class="o">%</span><span class="n">xmm1</span><span class="w"></span>
<span class="w">      </span><span class="mi">18</span>:       <span class="mi">0</span><span class="n">f</span><span class="w"> </span><span class="mi">54</span><span class="w"> </span><span class="n">c1</span><span class="w">                </span><span class="n">andps</span><span class="w">  </span><span class="o">%</span><span class="n">xmm1</span><span class="p">,</span><span class="o">%</span><span class="n">xmm0</span><span class="w"></span>
<span class="w">      </span><span class="mi">1</span><span class="n">b</span>:       <span class="mi">0</span><span class="n">f</span><span class="w"> </span><span class="n">c2</span><span class="w"> </span><span class="n">c9</span><span class="w"> </span><span class="mi">00</span><span class="w">             </span><span class="n">cmpeqps</span><span class="w"> </span><span class="o">%</span><span class="n">xmm1</span><span class="p">,</span><span class="o">%</span><span class="n">xmm1</span><span class="w"></span>
<span class="w">      </span><span class="mi">1</span><span class="n">f</span>:       <span class="mi">0</span><span class="n">f</span><span class="w"> </span><span class="mi">57</span><span class="w"> </span><span class="n">c1</span><span class="w">                </span><span class="n">xorps</span><span class="w">  </span><span class="o">%</span><span class="n">xmm1</span><span class="p">,</span><span class="o">%</span><span class="n">xmm0</span><span class="w"></span>
<span class="w">      </span><span class="mi">22</span>:       <span class="mi">48</span><span class="w"> </span><span class="mi">89</span><span class="w"> </span><span class="n">ec</span><span class="w">                </span><span class="n">mov</span><span class="w">    </span><span class="o">%</span><span class="n">rbp</span><span class="p">,</span><span class="o">%</span><span class="n">rsp</span><span class="w"></span>
<span class="w">      </span><span class="mi">25</span>:       <span class="mi">5</span><span class="n">d</span><span class="w">                      </span><span class="n">pop</span><span class="w">    </span><span class="o">%</span><span class="n">rbp</span><span class="w"></span>
<span class="w">      </span><span class="mi">26</span>:       <span class="nc">c3</span><span class="w">                      </span><span class="n">retq</span><span class="w"></span>
</code></pre></div>
<p>The instruction at address "c" does an xorps instead of an integer compare and we do this because of the types. Is it really a good idea to override the types used? Should we override types for the abs as well?</p>
</blockquote>



<a name="261526467"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%233517%20Fix%20for%20issue%203327.%20Updates%20Bnot%20to%20h.../near/261526467" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.233517.20Fix.20for.20issue.203327.2E.20Updates.20Bnot.20to.20h.2E.2E.2E.html#261526467">(Nov 15 2021 at 17:01)</a>:</h4>
<p>jlb6740 edited <a href="https://github.com/bytecodealliance/wasmtime/pull/3517#discussion_r749513116">PR review comment</a>.</p>



<a name="261526496"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%233517%20Fix%20for%20issue%203327.%20Updates%20Bnot%20to%20h.../near/261526496" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.233517.20Fix.20for.20issue.203327.2E.20Updates.20Bnot.20to.20h.2E.2E.2E.html#261526496">(Nov 15 2021 at 17:01)</a>:</h4>
<p>jlb6740 edited <a href="https://github.com/bytecodealliance/wasmtime/pull/3517#discussion_r749513116">PR review comment</a>.</p>



<a name="261541420"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%233517%20Fix%20for%20issue%203327.%20Updates%20Bnot%20to%20h.../near/261541420" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.233517.20Fix.20for.20issue.203327.2E.20Updates.20Bnot.20to.20h.2E.2E.2E.html#261541420">(Nov 15 2021 at 18:47)</a>:</h4>
<p>alexcrichton submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/3517#pullrequestreview-806430802">PR review</a>.</p>



<a name="261541422"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%233517%20Fix%20for%20issue%203327.%20Updates%20Bnot%20to%20h.../near/261541422" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.233517.20Fix.20for.20issue.203327.2E.20Updates.20Bnot.20to.20h.2E.2E.2E.html#261541422">(Nov 15 2021 at 18:47)</a>:</h4>
<p>alexcrichton created <a href="https://github.com/bytecodealliance/wasmtime/pull/3517#discussion_r749592910">PR review comment</a>:</p>
<blockquote>
<p>Ah yeah I don't know myself which is better. I agree that both should do the same thing, but whether we do an integer compare then move that to floating-point-typed instructions or instead to xor/cmp both with a floating point type I dunno.</p>
<p>FWIW for <code>f32x4.abs</code> LLVM generates this code for x86_64:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="p">.</span><span class="n">LCPI0_0</span>:
        <span class="p">.</span><span class="n">long</span><span class="w">   </span><span class="mh">0x7fffffff</span><span class="w">                      </span>#<span class="w"> </span><span class="n">float</span><span class="w"> </span><span class="n">NaN</span><span class="w"></span>
<span class="w">        </span><span class="p">.</span><span class="n">long</span><span class="w">   </span><span class="mh">0x7fffffff</span><span class="w">                      </span>#<span class="w"> </span><span class="n">float</span><span class="w"> </span><span class="n">NaN</span><span class="w"></span>
<span class="w">        </span><span class="p">.</span><span class="n">long</span><span class="w">   </span><span class="mh">0x7fffffff</span><span class="w">                      </span>#<span class="w"> </span><span class="n">float</span><span class="w"> </span><span class="n">NaN</span><span class="w"></span>
<span class="w">        </span><span class="p">.</span><span class="n">long</span><span class="w">   </span><span class="mh">0x7fffffff</span><span class="w">                      </span>#<span class="w"> </span><span class="n">float</span><span class="w"> </span><span class="n">NaN</span><span class="w"></span>
<span class="n">foo</span>:                                    #<span class="w"> </span><span class="o">@</span><span class="n">foo</span><span class="w"></span>
<span class="w">        </span><span class="n">andps</span><span class="w">   </span><span class="n">xmm0</span><span class="p">,</span><span class="w"> </span><span class="n">xmmword</span><span class="w"> </span><span class="n">ptr</span><span class="w"> </span><span class="p">[</span><span class="n">rip</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="p">.</span><span class="n">LCPI0_0</span><span class="p">]</span><span class="w"></span>
<span class="w">        </span><span class="n">ret</span><span class="w"></span>
</code></pre></div>
<p>and the rough <code>v128.not</code> equiavlent for LLVM seems to be:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="n">foo</span>:                                    #<span class="w"> </span><span class="o">@</span><span class="n">foo</span><span class="w"></span>
<span class="w">        </span><span class="n">pcmpeqd</span><span class="w"> </span><span class="n">xmm1</span><span class="p">,</span><span class="w"> </span><span class="n">xmm1</span><span class="w"></span>
<span class="w">        </span><span class="n">pxor</span><span class="w">    </span><span class="n">xmm0</span><span class="p">,</span><span class="w"> </span><span class="n">xmm1</span><span class="w"></span>
<span class="w">        </span><span class="n">ret</span><span class="w"></span>
</code></pre></div>
<p>Although this is in isolation where it's not doing other float ops around there so this isn't necessarily definitive I think.</p>
</blockquote>



<a name="261545165"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%233517%20Fix%20for%20issue%203327.%20Updates%20Bnot%20to%20h.../near/261545165" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.233517.20Fix.20for.20issue.203327.2E.20Updates.20Bnot.20to.20h.2E.2E.2E.html#261545165">(Nov 15 2021 at 19:16)</a>:</h4>
<p>jlb6740 updated <a href="https://github.com/bytecodealliance/wasmtime/pull/3517">PR #3517</a> from <code>fix-issue-3327</code> to <code>main</code>.</p>



<a name="261545691"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%233517%20Fix%20for%20issue%203327.%20Updates%20Bnot%20to%20h.../near/261545691" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.233517.20Fix.20for.20issue.203327.2E.20Updates.20Bnot.20to.20h.2E.2E.2E.html#261545691">(Nov 15 2021 at 19:20)</a>:</h4>
<p>jlb6740 submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/3517#pullrequestreview-806459444">PR review</a>.</p>



<a name="261545692"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%233517%20Fix%20for%20issue%203327.%20Updates%20Bnot%20to%20h.../near/261545692" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.233517.20Fix.20for.20issue.203327.2E.20Updates.20Bnot.20to.20h.2E.2E.2E.html#261545692">(Nov 15 2021 at 19:20)</a>:</h4>
<p>jlb6740 created <a href="https://github.com/bytecodealliance/wasmtime/pull/3517#discussion_r749614440">PR review comment</a>:</p>
<blockquote>
<p>Thanks @alexcrichton So looks like LLVM is using integer compare too. I've made that update. I didn't touch abs because I think that is a separate patch but looks like that could be more efficient as well. </p>
</blockquote>



<a name="261551397"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%233517%20Fix%20for%20issue%203327.%20Updates%20Bnot%20to%20h.../near/261551397" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.233517.20Fix.20for.20issue.203327.2E.20Updates.20Bnot.20to.20h.2E.2E.2E.html#261551397">(Nov 15 2021 at 20:03)</a>:</h4>
<p>abrown submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/3517#pullrequestreview-806495982">PR review</a>.</p>



<a name="261551399"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%233517%20Fix%20for%20issue%203327.%20Updates%20Bnot%20to%20h.../near/261551399" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.233517.20Fix.20for.20issue.203327.2E.20Updates.20Bnot.20to.20h.2E.2E.2E.html#261551399">(Nov 15 2021 at 20:03)</a>:</h4>
<p>abrown created <a href="https://github.com/bytecodealliance/wasmtime/pull/3517#discussion_r749642984">PR review comment</a>:</p>
<blockquote>
<p>I agree that from a Cranelift perspective it is a bit odd to use the <code>types::I32X4</code> since it may have nothing to do with the types we are lowering here, but I think that is a refactoring problem. We actually don't want to be writing <code>Inst::equals(...)</code> here (and in other places)--we want to write <code>construct_all_ones(...)</code> since that is actually what we are trying to do. <code>construct_all_ones</code> does not exist and I can't remember if there was some other helper that could do this type of thing (and the inverse, construct all zeroes, as well).</p>
<p>Inside such a helper, I think the best x86 code to emit is probably <code>PCMPEQD</code> (the output of <code>Inst::equals(types::I32X4, ...</code>) since that fixes the NaN issue and avoids an extra instruction. I checked to see how much the extra instruction would affect things and my conclusion is that 1) in tight loops the extra instruction could be a factor and 2) the int-to-FP domain switching is not an issue. </p>
</blockquote>



<a name="261556104"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%233517%20Fix%20for%20issue%203327.%20Updates%20Bnot%20to%20h.../near/261556104" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.233517.20Fix.20for.20issue.203327.2E.20Updates.20Bnot.20to.20h.2E.2E.2E.html#261556104">(Nov 15 2021 at 20:42)</a>:</h4>
<p>jlb6740 submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/3517#pullrequestreview-806526564">PR review</a>.</p>



<a name="261556106"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%233517%20Fix%20for%20issue%203327.%20Updates%20Bnot%20to%20h.../near/261556106" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.233517.20Fix.20for.20issue.203327.2E.20Updates.20Bnot.20to.20h.2E.2E.2E.html#261556106">(Nov 15 2021 at 20:42)</a>:</h4>
<p>jlb6740 created <a href="https://github.com/bytecodealliance/wasmtime/pull/3517#discussion_r749666354">PR review comment</a>:</p>
<blockquote>
<p>I commented to @abrown offline .. but my concern was also about mixing integer and float instructions for SIMD. In real codes (not this fuzzing example) they'll likely be other floating point SIMD instructions operating on these registers and it's supposed to be a bad for performance to mix between integer and floating point operations. Not sure where in the manuals but it's mentioned here in this stack overflow on some older system: <a href="https://stackoverflow.com/questions/4996384/do-i-get-a-performance-penalty-when-mixing-sse-integer-float-simd-instructions">https://stackoverflow.com/questions/4996384/do-i-get-a-performance-penalty-when-mixing-sse-integer-float-simd-instructions</a> . None-the-less I pushed the patch to hardcode the type. </p>
</blockquote>



<a name="261556165"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%233517%20Fix%20for%20issue%203327.%20Updates%20Bnot%20to%20h.../near/261556165" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.233517.20Fix.20for.20issue.203327.2E.20Updates.20Bnot.20to.20h.2E.2E.2E.html#261556165">(Nov 15 2021 at 20:43)</a>:</h4>
<p>jlb6740 edited <a href="https://github.com/bytecodealliance/wasmtime/pull/3517#discussion_r749666354">PR review comment</a>.</p>



<a name="261556733"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%233517%20Fix%20for%20issue%203327.%20Updates%20Bnot%20to%20h.../near/261556733" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.233517.20Fix.20for.20issue.203327.2E.20Updates.20Bnot.20to.20h.2E.2E.2E.html#261556733">(Nov 15 2021 at 20:48)</a>:</h4>
<p>jlb6740 submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/3517#pullrequestreview-806531327">PR review</a>.</p>



<a name="261556734"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%233517%20Fix%20for%20issue%203327.%20Updates%20Bnot%20to%20h.../near/261556734" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.233517.20Fix.20for.20issue.203327.2E.20Updates.20Bnot.20to.20h.2E.2E.2E.html#261556734">(Nov 15 2021 at 20:48)</a>:</h4>
<p>jlb6740 created <a href="https://github.com/bytecodealliance/wasmtime/pull/3517#discussion_r749669876">PR review comment</a>:</p>
<blockquote>
<p>@abrown .. Yes construct all ones is exactly what we are inlining here. </p>
</blockquote>



<a name="261559552"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%233517%20Fix%20for%20issue%203327.%20Updates%20Bnot%20to%20h.../near/261559552" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.233517.20Fix.20for.20issue.203327.2E.20Updates.20Bnot.20to.20h.2E.2E.2E.html#261559552">(Nov 15 2021 at 21:10)</a>:</h4>
<p>jlb6740 updated <a href="https://github.com/bytecodealliance/wasmtime/pull/3517">PR #3517</a> from <code>fix-issue-3327</code> to <code>main</code>.</p>



<a name="261575592"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%233517%20Fix%20for%20issue%203327.%20Updates%20Bnot%20to%20h.../near/261575592" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.233517.20Fix.20for.20issue.203327.2E.20Updates.20Bnot.20to.20h.2E.2E.2E.html#261575592">(Nov 15 2021 at 23:22)</a>:</h4>
<p>jlb6740 updated <a href="https://github.com/bytecodealliance/wasmtime/pull/3517">PR #3517</a> from <code>fix-issue-3327</code> to <code>main</code>.</p>



<a name="261575646"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%233517%20Fix%20for%20issue%203327.%20Updates%20Bnot%20to%20h.../near/261575646" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.233517.20Fix.20for.20issue.203327.2E.20Updates.20Bnot.20to.20h.2E.2E.2E.html#261575646">(Nov 15 2021 at 23:22)</a>:</h4>
<p>jlb6740 updated <a href="https://github.com/bytecodealliance/wasmtime/pull/3517">PR #3517</a> from <code>fix-issue-3327</code> to <code>main</code>.</p>



<a name="261578464"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%233517%20Fix%20for%20issue%203327.%20Updates%20Bnot%20to%20h.../near/261578464" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.233517.20Fix.20for.20issue.203327.2E.20Updates.20Bnot.20to.20h.2E.2E.2E.html#261578464">(Nov 15 2021 at 23:55)</a>:</h4>
<p>abrown submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/3517#pullrequestreview-806658122">PR review</a>.</p>



<a name="261584879"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%233517%20Fix%20for%20issue%203327.%20Updates%20Bnot%20to%20h.../near/261584879" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.233517.20Fix.20for.20issue.203327.2E.20Updates.20Bnot.20to.20h.2E.2E.2E.html#261584879">(Nov 16 2021 at 01:04)</a>:</h4>
<p>jlb6740 updated <a href="https://github.com/bytecodealliance/wasmtime/pull/3517">PR #3517</a> from <code>fix-issue-3327</code> to <code>main</code>.</p>



<a name="261588882"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%233517%20Fix%20for%20issue%203327.%20Updates%20Bnot%20to%20h.../near/261588882" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.233517.20Fix.20for.20issue.203327.2E.20Updates.20Bnot.20to.20h.2E.2E.2E.html#261588882">(Nov 16 2021 at 02:04)</a>:</h4>
<p>jlb6740 updated <a href="https://github.com/bytecodealliance/wasmtime/pull/3517">PR #3517</a> from <code>fix-issue-3327</code> to <code>main</code>.</p>



<a name="261591379"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%233517%20Fix%20for%20issue%203327.%20Updates%20Bnot%20to%20h.../near/261591379" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.233517.20Fix.20for.20issue.203327.2E.20Updates.20Bnot.20to.20h.2E.2E.2E.html#261591379">(Nov 16 2021 at 02:47)</a>:</h4>
<p>jlb6740 merged <a href="https://github.com/bytecodealliance/wasmtime/pull/3517">PR #3517</a>.</p>



<hr><p>Last updated: Jan 20 2025 at 06:04 UTC</p>
</html>