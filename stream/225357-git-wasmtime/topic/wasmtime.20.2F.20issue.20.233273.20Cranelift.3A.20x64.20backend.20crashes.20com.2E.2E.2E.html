<html>
<head><meta charset="utf-8"><title>wasmtime / issue #3273 Cranelift: x64 backend crashes com... · git-wasmtime · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/index.html">git-wasmtime</a></h2>
<h3>Topic: <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.233273.20Cranelift.3A.20x64.20backend.20crashes.20com.2E.2E.2E.html">wasmtime / issue #3273 Cranelift: x64 backend crashes com...</a></h3>

<hr>

<base href="https://bytecodealliance.zulipchat.com">

<head><link href="https://bytecodealliance.github.io/zulip-archive/style.css" rel="stylesheet"></head>

<a name="251564664"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%233273%20Cranelift%3A%20x64%20backend%20crashes%20com.../near/251564664" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.233273.20Cranelift.3A.20x64.20backend.20crashes.20com.2E.2E.2E.html#251564664">(Sep 01 2021 at 14:09)</a>:</h4>
<p>afonso360 labeled <a href="https://github.com/bytecodealliance/wasmtime/issues/3273">issue #3273</a>:</p>
<blockquote>
<p>Hey, In #3272 @dheaton-arm implemented tests for a standalone <code>iadd_pairwise</code> instruction without a <code>swiden_low</code>/<code>swiden_high</code>/<code>uwiden_low</code>/<code>uwiden_high</code> instruction as an input. It looks like this case is not implemented in the x64 backend, instead we always perform an optimization and merge those previous instructions.</p>
<h3><code>.clif</code> Test Case</h3>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="n">test</span><span class="w"> </span><span class="n">run</span><span class="w"></span>
<span class="n">target</span><span class="w"> </span><span class="n">x86_64</span><span class="w"> </span><span class="n">machinst</span><span class="w"></span>

<span class="n">function</span><span class="w"> </span><span class="o">%</span><span class="n">iaddp_i8x16</span><span class="p">(</span><span class="n">i8x16</span><span class="p">,</span><span class="w"> </span><span class="n">i8x16</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nc">i8x16</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="n">block0</span><span class="p">(</span><span class="n">v0</span>: <span class="nc">i8x16</span><span class="p">,</span><span class="w"> </span><span class="n">v1</span>: <span class="nc">i8x16</span><span class="p">)</span>:
    <span class="nc">v2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">iadd_pairwise</span><span class="w"> </span><span class="n">v0</span><span class="p">,</span><span class="w"> </span><span class="n">v1</span><span class="w"></span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">v2</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
<span class="p">;</span><span class="w"> </span><span class="n">run</span>: <span class="o">%</span><span class="n">iaddp_i8x16</span><span class="p">([</span><span class="mi">1</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="mi">3</span><span class="w"> </span><span class="mi">4</span><span class="w"> </span><span class="mi">5</span><span class="w"> </span><span class="mi">6</span><span class="w"> </span><span class="mi">7</span><span class="w"> </span><span class="mi">8</span><span class="w"> </span><span class="mi">9</span><span class="w"> </span><span class="mi">10</span><span class="w"> </span><span class="mi">11</span><span class="w"> </span><span class="mi">12</span><span class="w"> </span><span class="mi">13</span><span class="w"> </span><span class="mi">14</span><span class="w"> </span><span class="mi">15</span><span class="w"> </span><span class="mi">16</span><span class="p">],</span><span class="w"> </span><span class="p">[</span><span class="mi">17</span><span class="w"> </span><span class="mi">18</span><span class="w"> </span><span class="mi">19</span><span class="w"> </span><span class="mi">20</span><span class="w"> </span><span class="mi">21</span><span class="w"> </span><span class="mi">22</span><span class="w"> </span><span class="mi">23</span><span class="w"> </span><span class="mi">24</span><span class="w"> </span><span class="mi">25</span><span class="w"> </span><span class="mi">26</span><span class="w"> </span><span class="mi">27</span><span class="w"> </span><span class="mi">28</span><span class="w"> </span><span class="mi">29</span><span class="w"> </span><span class="mi">30</span><span class="w"> </span><span class="mi">31</span><span class="w"> </span><span class="mi">32</span><span class="p">])</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="p">[</span><span class="mi">3</span><span class="w"> </span><span class="mi">7</span><span class="w"> </span><span class="mi">11</span><span class="w"> </span><span class="mi">15</span><span class="w"> </span><span class="mi">19</span><span class="w"> </span><span class="mi">23</span><span class="w"> </span><span class="mi">27</span><span class="w"> </span><span class="mi">31</span><span class="w"> </span><span class="mi">35</span><span class="w"> </span><span class="mi">39</span><span class="w"> </span><span class="mi">43</span><span class="w"> </span><span class="mi">47</span><span class="w"> </span><span class="mi">51</span><span class="w"> </span><span class="mi">55</span><span class="w"> </span><span class="mi">59</span><span class="w"> </span><span class="mi">63</span><span class="p">]</span><span class="w"></span>

<span class="n">function</span><span class="w"> </span><span class="o">%</span><span class="n">iaddp_i16x8</span><span class="p">(</span><span class="n">i16x8</span><span class="p">,</span><span class="w"> </span><span class="n">i16x8</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nc">i16x8</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="n">block0</span><span class="p">(</span><span class="n">v0</span>: <span class="nc">i16x8</span><span class="p">,</span><span class="w"> </span><span class="n">v1</span>: <span class="nc">i16x8</span><span class="p">)</span>:
    <span class="nc">v2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">iadd_pairwise</span><span class="w"> </span><span class="n">v0</span><span class="p">,</span><span class="w"> </span><span class="n">v1</span><span class="w"></span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">v2</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
<span class="p">;</span><span class="w"> </span><span class="n">run</span>: <span class="o">%</span><span class="n">iaddp_i16x8</span><span class="p">([</span><span class="mi">1</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="mi">3</span><span class="w"> </span><span class="mi">4</span><span class="w"> </span><span class="mi">5</span><span class="w"> </span><span class="mi">6</span><span class="w"> </span><span class="mi">7</span><span class="w"> </span><span class="mi">8</span><span class="p">],</span><span class="w"> </span><span class="p">[</span><span class="mi">100</span><span class="w"> </span><span class="mi">99</span><span class="w"> </span><span class="mi">98</span><span class="w"> </span><span class="mi">97</span><span class="w"> </span><span class="mi">96</span><span class="w"> </span><span class="mi">95</span><span class="w"> </span><span class="mi">94</span><span class="w"> </span><span class="mi">93</span><span class="p">])</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="p">[</span><span class="mi">3</span><span class="w"> </span><span class="mi">7</span><span class="w"> </span><span class="mi">11</span><span class="w"> </span><span class="mi">15</span><span class="w"> </span><span class="mi">199</span><span class="w"> </span><span class="mi">195</span><span class="w"> </span><span class="mi">191</span><span class="w"> </span><span class="mi">187</span><span class="p">]</span><span class="w"></span>

<span class="n">function</span><span class="w"> </span><span class="o">%</span><span class="n">iaddp_i32x4</span><span class="p">(</span><span class="n">i32x4</span><span class="p">,</span><span class="w"> </span><span class="n">i32x4</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nc">i32x4</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="n">block0</span><span class="p">(</span><span class="n">v0</span>: <span class="nc">i32x4</span><span class="p">,</span><span class="w"> </span><span class="n">v1</span>: <span class="nc">i32x4</span><span class="p">)</span>:
    <span class="nc">v2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">iadd_pairwise</span><span class="w"> </span><span class="n">v0</span><span class="p">,</span><span class="w"> </span><span class="n">v1</span><span class="w"></span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">v2</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
<span class="p">;</span><span class="w"> </span><span class="n">run</span>: <span class="o">%</span><span class="n">iaddp_i32x4</span><span class="p">([</span><span class="mi">1</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="mi">3</span><span class="w"> </span><span class="mi">4</span><span class="p">],</span><span class="w"> </span><span class="p">[</span><span class="mi">5</span><span class="w"> </span><span class="mi">6</span><span class="w"> </span><span class="mi">7</span><span class="w"> </span><span class="mi">8</span><span class="p">])</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="p">[</span><span class="mi">3</span><span class="w"> </span><span class="mi">7</span><span class="w"> </span><span class="mi">11</span><span class="w"> </span><span class="mi">15</span><span class="p">]</span><span class="w"></span>
<span class="p">;</span><span class="w"> </span><span class="n">run</span>: <span class="o">%</span><span class="n">iaddp_i32x4</span><span class="p">([</span><span class="mi">4294967290</span><span class="w"> </span><span class="mi">5</span><span class="w"> </span><span class="mi">4294967290</span><span class="w"> </span><span class="mi">5</span><span class="p">],</span><span class="w"> </span><span class="p">[</span><span class="mi">100</span><span class="w"> </span><span class="mi">100</span><span class="w"> </span><span class="mi">100</span><span class="w"> </span><span class="mi">100</span><span class="p">])</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="p">[</span><span class="mi">4294967295</span><span class="w"> </span><span class="mi">4294967295</span><span class="w"> </span><span class="mi">200</span><span class="w"> </span><span class="mi">200</span><span class="p">]</span><span class="w"></span>
</code></pre></div>
<h3>Steps to Reproduce</h3>
<p>Run <code>clif-util the-above.clif</code></p>
<h3>Expected Results</h3>
<p>Tests to pass</p>
<h3>Actual Results</h3>
<p>Cranelift crashes with:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="n">thread</span><span class="w"> </span><span class="o">'</span><span class="na">worker</span><span class="w"> </span>#<span class="mi">0</span><span class="o">'</span><span class="w"> </span><span class="n">panicked</span><span class="w"> </span><span class="n">at</span><span class="w"> </span><span class="o">'</span><span class="na">not</span><span class="w"> </span><span class="n">implemented</span>: <span class="nc">Operands</span><span class="w"> </span><span class="n">not</span><span class="w"> </span><span class="n">supported</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">IaddPairwise</span><span class="o">'</span><span class="p">,</span><span class="w"> </span><span class="n">cranelift</span><span class="err">\</span><span class="n">codegen</span><span class="err">\</span><span class="n">src</span><span class="err">\</span><span class="n">isa</span><span class="err">\</span><span class="n">x64</span><span class="err">\</span><span class="n">lower</span><span class="p">.</span><span class="n">rs</span>:<span class="mi">5095</span>:<span class="mi">17</span><span class="w"></span>
<span class="n">note</span>: <span class="nc">run</span><span class="w"> </span><span class="n">with</span><span class="w"> </span><span class="err">`</span><span class="n">RUST_BACKTRACE</span><span class="o">=</span><span class="mi">1</span><span class="err">`</span><span class="w"> </span><span class="n">environment</span><span class="w"> </span><span class="n">variable</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">display</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="n">backtrace</span><span class="w"></span>
<span class="n">FAIL</span><span class="w"> </span><span class="p">.</span><span class="err">\</span><span class="n">filetests</span><span class="err">\</span><span class="n">filetests</span><span class="err">\</span><span class="n">runtests</span><span class="err">\</span><span class="n">test</span><span class="p">.</span><span class="n">clif</span>: <span class="nc">panicked</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="n">worker</span><span class="w"> </span>#<span class="mi">0</span>: <span class="nc">not</span><span class="w"> </span><span class="n">implemented</span>: <span class="nc">Operands</span><span class="w"> </span><span class="n">not</span><span class="w"> </span><span class="n">supported</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">IaddPairwise</span><span class="w"></span>
</code></pre></div>
<h3>Versions and Environment</h3>
<p>Cranelift version or commit: main<br>
Operating system: Windows<br>
Architecture: x64</p>
<h3>Extra Info</h3>
<p>The test file above should be in-tree at <code>cranelift/filetests/filetests/runtests/simd-iaddpairwise.clif</code>, once #3272 is merged.<br>
</p>
</blockquote>



<a name="251564665"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%233273%20Cranelift%3A%20x64%20backend%20crashes%20com.../near/251564665" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.233273.20Cranelift.3A.20x64.20backend.20crashes.20com.2E.2E.2E.html#251564665">(Sep 01 2021 at 14:09)</a>:</h4>
<p>afonso360 opened <a href="https://github.com/bytecodealliance/wasmtime/issues/3273">issue #3273</a>:</p>
<blockquote>
<p>Hey, In #3272 @dheaton-arm implemented tests for a standalone <code>iadd_pairwise</code> instruction without a <code>swiden_low</code>/<code>swiden_high</code>/<code>uwiden_low</code>/<code>uwiden_high</code> instruction as an input. It looks like this case is not implemented in the x64 backend, instead we always perform an optimization and merge those previous instructions.</p>
<h3><code>.clif</code> Test Case</h3>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="n">test</span><span class="w"> </span><span class="n">run</span><span class="w"></span>
<span class="n">target</span><span class="w"> </span><span class="n">x86_64</span><span class="w"> </span><span class="n">machinst</span><span class="w"></span>

<span class="n">function</span><span class="w"> </span><span class="o">%</span><span class="n">iaddp_i8x16</span><span class="p">(</span><span class="n">i8x16</span><span class="p">,</span><span class="w"> </span><span class="n">i8x16</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nc">i8x16</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="n">block0</span><span class="p">(</span><span class="n">v0</span>: <span class="nc">i8x16</span><span class="p">,</span><span class="w"> </span><span class="n">v1</span>: <span class="nc">i8x16</span><span class="p">)</span>:
    <span class="nc">v2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">iadd_pairwise</span><span class="w"> </span><span class="n">v0</span><span class="p">,</span><span class="w"> </span><span class="n">v1</span><span class="w"></span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">v2</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
<span class="p">;</span><span class="w"> </span><span class="n">run</span>: <span class="o">%</span><span class="n">iaddp_i8x16</span><span class="p">([</span><span class="mi">1</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="mi">3</span><span class="w"> </span><span class="mi">4</span><span class="w"> </span><span class="mi">5</span><span class="w"> </span><span class="mi">6</span><span class="w"> </span><span class="mi">7</span><span class="w"> </span><span class="mi">8</span><span class="w"> </span><span class="mi">9</span><span class="w"> </span><span class="mi">10</span><span class="w"> </span><span class="mi">11</span><span class="w"> </span><span class="mi">12</span><span class="w"> </span><span class="mi">13</span><span class="w"> </span><span class="mi">14</span><span class="w"> </span><span class="mi">15</span><span class="w"> </span><span class="mi">16</span><span class="p">],</span><span class="w"> </span><span class="p">[</span><span class="mi">17</span><span class="w"> </span><span class="mi">18</span><span class="w"> </span><span class="mi">19</span><span class="w"> </span><span class="mi">20</span><span class="w"> </span><span class="mi">21</span><span class="w"> </span><span class="mi">22</span><span class="w"> </span><span class="mi">23</span><span class="w"> </span><span class="mi">24</span><span class="w"> </span><span class="mi">25</span><span class="w"> </span><span class="mi">26</span><span class="w"> </span><span class="mi">27</span><span class="w"> </span><span class="mi">28</span><span class="w"> </span><span class="mi">29</span><span class="w"> </span><span class="mi">30</span><span class="w"> </span><span class="mi">31</span><span class="w"> </span><span class="mi">32</span><span class="p">])</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="p">[</span><span class="mi">3</span><span class="w"> </span><span class="mi">7</span><span class="w"> </span><span class="mi">11</span><span class="w"> </span><span class="mi">15</span><span class="w"> </span><span class="mi">19</span><span class="w"> </span><span class="mi">23</span><span class="w"> </span><span class="mi">27</span><span class="w"> </span><span class="mi">31</span><span class="w"> </span><span class="mi">35</span><span class="w"> </span><span class="mi">39</span><span class="w"> </span><span class="mi">43</span><span class="w"> </span><span class="mi">47</span><span class="w"> </span><span class="mi">51</span><span class="w"> </span><span class="mi">55</span><span class="w"> </span><span class="mi">59</span><span class="w"> </span><span class="mi">63</span><span class="p">]</span><span class="w"></span>

<span class="n">function</span><span class="w"> </span><span class="o">%</span><span class="n">iaddp_i16x8</span><span class="p">(</span><span class="n">i16x8</span><span class="p">,</span><span class="w"> </span><span class="n">i16x8</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nc">i16x8</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="n">block0</span><span class="p">(</span><span class="n">v0</span>: <span class="nc">i16x8</span><span class="p">,</span><span class="w"> </span><span class="n">v1</span>: <span class="nc">i16x8</span><span class="p">)</span>:
    <span class="nc">v2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">iadd_pairwise</span><span class="w"> </span><span class="n">v0</span><span class="p">,</span><span class="w"> </span><span class="n">v1</span><span class="w"></span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">v2</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
<span class="p">;</span><span class="w"> </span><span class="n">run</span>: <span class="o">%</span><span class="n">iaddp_i16x8</span><span class="p">([</span><span class="mi">1</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="mi">3</span><span class="w"> </span><span class="mi">4</span><span class="w"> </span><span class="mi">5</span><span class="w"> </span><span class="mi">6</span><span class="w"> </span><span class="mi">7</span><span class="w"> </span><span class="mi">8</span><span class="p">],</span><span class="w"> </span><span class="p">[</span><span class="mi">100</span><span class="w"> </span><span class="mi">99</span><span class="w"> </span><span class="mi">98</span><span class="w"> </span><span class="mi">97</span><span class="w"> </span><span class="mi">96</span><span class="w"> </span><span class="mi">95</span><span class="w"> </span><span class="mi">94</span><span class="w"> </span><span class="mi">93</span><span class="p">])</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="p">[</span><span class="mi">3</span><span class="w"> </span><span class="mi">7</span><span class="w"> </span><span class="mi">11</span><span class="w"> </span><span class="mi">15</span><span class="w"> </span><span class="mi">199</span><span class="w"> </span><span class="mi">195</span><span class="w"> </span><span class="mi">191</span><span class="w"> </span><span class="mi">187</span><span class="p">]</span><span class="w"></span>

<span class="n">function</span><span class="w"> </span><span class="o">%</span><span class="n">iaddp_i32x4</span><span class="p">(</span><span class="n">i32x4</span><span class="p">,</span><span class="w"> </span><span class="n">i32x4</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nc">i32x4</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="n">block0</span><span class="p">(</span><span class="n">v0</span>: <span class="nc">i32x4</span><span class="p">,</span><span class="w"> </span><span class="n">v1</span>: <span class="nc">i32x4</span><span class="p">)</span>:
    <span class="nc">v2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">iadd_pairwise</span><span class="w"> </span><span class="n">v0</span><span class="p">,</span><span class="w"> </span><span class="n">v1</span><span class="w"></span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">v2</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
<span class="p">;</span><span class="w"> </span><span class="n">run</span>: <span class="o">%</span><span class="n">iaddp_i32x4</span><span class="p">([</span><span class="mi">1</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="mi">3</span><span class="w"> </span><span class="mi">4</span><span class="p">],</span><span class="w"> </span><span class="p">[</span><span class="mi">5</span><span class="w"> </span><span class="mi">6</span><span class="w"> </span><span class="mi">7</span><span class="w"> </span><span class="mi">8</span><span class="p">])</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="p">[</span><span class="mi">3</span><span class="w"> </span><span class="mi">7</span><span class="w"> </span><span class="mi">11</span><span class="w"> </span><span class="mi">15</span><span class="p">]</span><span class="w"></span>
<span class="p">;</span><span class="w"> </span><span class="n">run</span>: <span class="o">%</span><span class="n">iaddp_i32x4</span><span class="p">([</span><span class="mi">4294967290</span><span class="w"> </span><span class="mi">5</span><span class="w"> </span><span class="mi">4294967290</span><span class="w"> </span><span class="mi">5</span><span class="p">],</span><span class="w"> </span><span class="p">[</span><span class="mi">100</span><span class="w"> </span><span class="mi">100</span><span class="w"> </span><span class="mi">100</span><span class="w"> </span><span class="mi">100</span><span class="p">])</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="p">[</span><span class="mi">4294967295</span><span class="w"> </span><span class="mi">4294967295</span><span class="w"> </span><span class="mi">200</span><span class="w"> </span><span class="mi">200</span><span class="p">]</span><span class="w"></span>
</code></pre></div>
<h3>Steps to Reproduce</h3>
<p>Run <code>clif-util the-above.clif</code></p>
<h3>Expected Results</h3>
<p>Tests to pass</p>
<h3>Actual Results</h3>
<p>Cranelift crashes with:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="n">thread</span><span class="w"> </span><span class="o">'</span><span class="na">worker</span><span class="w"> </span>#<span class="mi">0</span><span class="o">'</span><span class="w"> </span><span class="n">panicked</span><span class="w"> </span><span class="n">at</span><span class="w"> </span><span class="o">'</span><span class="na">not</span><span class="w"> </span><span class="n">implemented</span>: <span class="nc">Operands</span><span class="w"> </span><span class="n">not</span><span class="w"> </span><span class="n">supported</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">IaddPairwise</span><span class="o">'</span><span class="p">,</span><span class="w"> </span><span class="n">cranelift</span><span class="err">\</span><span class="n">codegen</span><span class="err">\</span><span class="n">src</span><span class="err">\</span><span class="n">isa</span><span class="err">\</span><span class="n">x64</span><span class="err">\</span><span class="n">lower</span><span class="p">.</span><span class="n">rs</span>:<span class="mi">5095</span>:<span class="mi">17</span><span class="w"></span>
<span class="n">note</span>: <span class="nc">run</span><span class="w"> </span><span class="n">with</span><span class="w"> </span><span class="err">`</span><span class="n">RUST_BACKTRACE</span><span class="o">=</span><span class="mi">1</span><span class="err">`</span><span class="w"> </span><span class="n">environment</span><span class="w"> </span><span class="n">variable</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">display</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="n">backtrace</span><span class="w"></span>
<span class="n">FAIL</span><span class="w"> </span><span class="p">.</span><span class="err">\</span><span class="n">filetests</span><span class="err">\</span><span class="n">filetests</span><span class="err">\</span><span class="n">runtests</span><span class="err">\</span><span class="n">test</span><span class="p">.</span><span class="n">clif</span>: <span class="nc">panicked</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="n">worker</span><span class="w"> </span>#<span class="mi">0</span>: <span class="nc">not</span><span class="w"> </span><span class="n">implemented</span>: <span class="nc">Operands</span><span class="w"> </span><span class="n">not</span><span class="w"> </span><span class="n">supported</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">IaddPairwise</span><span class="w"></span>
</code></pre></div>
<h3>Versions and Environment</h3>
<p>Cranelift version or commit: main<br>
Operating system: Windows<br>
Architecture: x64</p>
<h3>Extra Info</h3>
<p>The test file above should be in-tree at <code>cranelift/filetests/filetests/runtests/simd-iaddpairwise.clif</code>, once #3272 is merged.<br>
</p>
</blockquote>



<a name="251564666"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%233273%20Cranelift%3A%20x64%20backend%20crashes%20com.../near/251564666" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.233273.20Cranelift.3A.20x64.20backend.20crashes.20com.2E.2E.2E.html#251564666">(Sep 01 2021 at 14:09)</a>:</h4>
<p>afonso360 labeled <a href="https://github.com/bytecodealliance/wasmtime/issues/3273">issue #3273</a>:</p>
<blockquote>
<p>Hey, In #3272 @dheaton-arm implemented tests for a standalone <code>iadd_pairwise</code> instruction without a <code>swiden_low</code>/<code>swiden_high</code>/<code>uwiden_low</code>/<code>uwiden_high</code> instruction as an input. It looks like this case is not implemented in the x64 backend, instead we always perform an optimization and merge those previous instructions.</p>
<h3><code>.clif</code> Test Case</h3>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="n">test</span><span class="w"> </span><span class="n">run</span><span class="w"></span>
<span class="n">target</span><span class="w"> </span><span class="n">x86_64</span><span class="w"> </span><span class="n">machinst</span><span class="w"></span>

<span class="n">function</span><span class="w"> </span><span class="o">%</span><span class="n">iaddp_i8x16</span><span class="p">(</span><span class="n">i8x16</span><span class="p">,</span><span class="w"> </span><span class="n">i8x16</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nc">i8x16</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="n">block0</span><span class="p">(</span><span class="n">v0</span>: <span class="nc">i8x16</span><span class="p">,</span><span class="w"> </span><span class="n">v1</span>: <span class="nc">i8x16</span><span class="p">)</span>:
    <span class="nc">v2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">iadd_pairwise</span><span class="w"> </span><span class="n">v0</span><span class="p">,</span><span class="w"> </span><span class="n">v1</span><span class="w"></span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">v2</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
<span class="p">;</span><span class="w"> </span><span class="n">run</span>: <span class="o">%</span><span class="n">iaddp_i8x16</span><span class="p">([</span><span class="mi">1</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="mi">3</span><span class="w"> </span><span class="mi">4</span><span class="w"> </span><span class="mi">5</span><span class="w"> </span><span class="mi">6</span><span class="w"> </span><span class="mi">7</span><span class="w"> </span><span class="mi">8</span><span class="w"> </span><span class="mi">9</span><span class="w"> </span><span class="mi">10</span><span class="w"> </span><span class="mi">11</span><span class="w"> </span><span class="mi">12</span><span class="w"> </span><span class="mi">13</span><span class="w"> </span><span class="mi">14</span><span class="w"> </span><span class="mi">15</span><span class="w"> </span><span class="mi">16</span><span class="p">],</span><span class="w"> </span><span class="p">[</span><span class="mi">17</span><span class="w"> </span><span class="mi">18</span><span class="w"> </span><span class="mi">19</span><span class="w"> </span><span class="mi">20</span><span class="w"> </span><span class="mi">21</span><span class="w"> </span><span class="mi">22</span><span class="w"> </span><span class="mi">23</span><span class="w"> </span><span class="mi">24</span><span class="w"> </span><span class="mi">25</span><span class="w"> </span><span class="mi">26</span><span class="w"> </span><span class="mi">27</span><span class="w"> </span><span class="mi">28</span><span class="w"> </span><span class="mi">29</span><span class="w"> </span><span class="mi">30</span><span class="w"> </span><span class="mi">31</span><span class="w"> </span><span class="mi">32</span><span class="p">])</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="p">[</span><span class="mi">3</span><span class="w"> </span><span class="mi">7</span><span class="w"> </span><span class="mi">11</span><span class="w"> </span><span class="mi">15</span><span class="w"> </span><span class="mi">19</span><span class="w"> </span><span class="mi">23</span><span class="w"> </span><span class="mi">27</span><span class="w"> </span><span class="mi">31</span><span class="w"> </span><span class="mi">35</span><span class="w"> </span><span class="mi">39</span><span class="w"> </span><span class="mi">43</span><span class="w"> </span><span class="mi">47</span><span class="w"> </span><span class="mi">51</span><span class="w"> </span><span class="mi">55</span><span class="w"> </span><span class="mi">59</span><span class="w"> </span><span class="mi">63</span><span class="p">]</span><span class="w"></span>

<span class="n">function</span><span class="w"> </span><span class="o">%</span><span class="n">iaddp_i16x8</span><span class="p">(</span><span class="n">i16x8</span><span class="p">,</span><span class="w"> </span><span class="n">i16x8</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nc">i16x8</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="n">block0</span><span class="p">(</span><span class="n">v0</span>: <span class="nc">i16x8</span><span class="p">,</span><span class="w"> </span><span class="n">v1</span>: <span class="nc">i16x8</span><span class="p">)</span>:
    <span class="nc">v2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">iadd_pairwise</span><span class="w"> </span><span class="n">v0</span><span class="p">,</span><span class="w"> </span><span class="n">v1</span><span class="w"></span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">v2</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
<span class="p">;</span><span class="w"> </span><span class="n">run</span>: <span class="o">%</span><span class="n">iaddp_i16x8</span><span class="p">([</span><span class="mi">1</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="mi">3</span><span class="w"> </span><span class="mi">4</span><span class="w"> </span><span class="mi">5</span><span class="w"> </span><span class="mi">6</span><span class="w"> </span><span class="mi">7</span><span class="w"> </span><span class="mi">8</span><span class="p">],</span><span class="w"> </span><span class="p">[</span><span class="mi">100</span><span class="w"> </span><span class="mi">99</span><span class="w"> </span><span class="mi">98</span><span class="w"> </span><span class="mi">97</span><span class="w"> </span><span class="mi">96</span><span class="w"> </span><span class="mi">95</span><span class="w"> </span><span class="mi">94</span><span class="w"> </span><span class="mi">93</span><span class="p">])</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="p">[</span><span class="mi">3</span><span class="w"> </span><span class="mi">7</span><span class="w"> </span><span class="mi">11</span><span class="w"> </span><span class="mi">15</span><span class="w"> </span><span class="mi">199</span><span class="w"> </span><span class="mi">195</span><span class="w"> </span><span class="mi">191</span><span class="w"> </span><span class="mi">187</span><span class="p">]</span><span class="w"></span>

<span class="n">function</span><span class="w"> </span><span class="o">%</span><span class="n">iaddp_i32x4</span><span class="p">(</span><span class="n">i32x4</span><span class="p">,</span><span class="w"> </span><span class="n">i32x4</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nc">i32x4</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="n">block0</span><span class="p">(</span><span class="n">v0</span>: <span class="nc">i32x4</span><span class="p">,</span><span class="w"> </span><span class="n">v1</span>: <span class="nc">i32x4</span><span class="p">)</span>:
    <span class="nc">v2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">iadd_pairwise</span><span class="w"> </span><span class="n">v0</span><span class="p">,</span><span class="w"> </span><span class="n">v1</span><span class="w"></span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">v2</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
<span class="p">;</span><span class="w"> </span><span class="n">run</span>: <span class="o">%</span><span class="n">iaddp_i32x4</span><span class="p">([</span><span class="mi">1</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="mi">3</span><span class="w"> </span><span class="mi">4</span><span class="p">],</span><span class="w"> </span><span class="p">[</span><span class="mi">5</span><span class="w"> </span><span class="mi">6</span><span class="w"> </span><span class="mi">7</span><span class="w"> </span><span class="mi">8</span><span class="p">])</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="p">[</span><span class="mi">3</span><span class="w"> </span><span class="mi">7</span><span class="w"> </span><span class="mi">11</span><span class="w"> </span><span class="mi">15</span><span class="p">]</span><span class="w"></span>
<span class="p">;</span><span class="w"> </span><span class="n">run</span>: <span class="o">%</span><span class="n">iaddp_i32x4</span><span class="p">([</span><span class="mi">4294967290</span><span class="w"> </span><span class="mi">5</span><span class="w"> </span><span class="mi">4294967290</span><span class="w"> </span><span class="mi">5</span><span class="p">],</span><span class="w"> </span><span class="p">[</span><span class="mi">100</span><span class="w"> </span><span class="mi">100</span><span class="w"> </span><span class="mi">100</span><span class="w"> </span><span class="mi">100</span><span class="p">])</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="p">[</span><span class="mi">4294967295</span><span class="w"> </span><span class="mi">4294967295</span><span class="w"> </span><span class="mi">200</span><span class="w"> </span><span class="mi">200</span><span class="p">]</span><span class="w"></span>
</code></pre></div>
<h3>Steps to Reproduce</h3>
<p>Run <code>clif-util the-above.clif</code></p>
<h3>Expected Results</h3>
<p>Tests to pass</p>
<h3>Actual Results</h3>
<p>Cranelift crashes with:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="n">thread</span><span class="w"> </span><span class="o">'</span><span class="na">worker</span><span class="w"> </span>#<span class="mi">0</span><span class="o">'</span><span class="w"> </span><span class="n">panicked</span><span class="w"> </span><span class="n">at</span><span class="w"> </span><span class="o">'</span><span class="na">not</span><span class="w"> </span><span class="n">implemented</span>: <span class="nc">Operands</span><span class="w"> </span><span class="n">not</span><span class="w"> </span><span class="n">supported</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">IaddPairwise</span><span class="o">'</span><span class="p">,</span><span class="w"> </span><span class="n">cranelift</span><span class="err">\</span><span class="n">codegen</span><span class="err">\</span><span class="n">src</span><span class="err">\</span><span class="n">isa</span><span class="err">\</span><span class="n">x64</span><span class="err">\</span><span class="n">lower</span><span class="p">.</span><span class="n">rs</span>:<span class="mi">5095</span>:<span class="mi">17</span><span class="w"></span>
<span class="n">note</span>: <span class="nc">run</span><span class="w"> </span><span class="n">with</span><span class="w"> </span><span class="err">`</span><span class="n">RUST_BACKTRACE</span><span class="o">=</span><span class="mi">1</span><span class="err">`</span><span class="w"> </span><span class="n">environment</span><span class="w"> </span><span class="n">variable</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">display</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="n">backtrace</span><span class="w"></span>
<span class="n">FAIL</span><span class="w"> </span><span class="p">.</span><span class="err">\</span><span class="n">filetests</span><span class="err">\</span><span class="n">filetests</span><span class="err">\</span><span class="n">runtests</span><span class="err">\</span><span class="n">test</span><span class="p">.</span><span class="n">clif</span>: <span class="nc">panicked</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="n">worker</span><span class="w"> </span>#<span class="mi">0</span>: <span class="nc">not</span><span class="w"> </span><span class="n">implemented</span>: <span class="nc">Operands</span><span class="w"> </span><span class="n">not</span><span class="w"> </span><span class="n">supported</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">IaddPairwise</span><span class="w"></span>
</code></pre></div>
<h3>Versions and Environment</h3>
<p>Cranelift version or commit: main<br>
Operating system: Windows<br>
Architecture: x64</p>
<h3>Extra Info</h3>
<p>The test file above should be in-tree at <code>cranelift/filetests/filetests/runtests/simd-iaddpairwise.clif</code>, once #3272 is merged.<br>
</p>
</blockquote>



<a name="251606205"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%233273%20Cranelift%3A%20x64%20backend%20crashes%20com.../near/251606205" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.233273.20Cranelift.3A.20x64.20backend.20crashes.20com.2E.2E.2E.html#251606205">(Sep 01 2021 at 18:24)</a>:</h4>
<p>cfallin <a href="https://github.com/bytecodealliance/wasmtime/issues/3273#issuecomment-910544282">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/3273">issue #3273</a>:</p>
<blockquote>
<p>cc @jlb6740 -- we discussed at the time (in #3209) that it was fine to merge without this more general case in order to make forward progress, but that we should eventually fill out the general case. Thanks for creating the issue to track this!</p>
</blockquote>



<a name="251956158"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%233273%20Cranelift%3A%20x64%20backend%20crashes%20com.../near/251956158" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.233273.20Cranelift.3A.20x64.20backend.20crashes.20com.2E.2E.2E.html#251956158">(Sep 03 2021 at 23:49)</a>:</h4>
<p>abrown labeled <a href="https://github.com/bytecodealliance/wasmtime/issues/3273">issue #3273</a>:</p>
<blockquote>
<p>Hey, In #3272 @dheaton-arm implemented tests for a standalone <code>iadd_pairwise</code> instruction without a <code>swiden_low</code>/<code>swiden_high</code>/<code>uwiden_low</code>/<code>uwiden_high</code> instruction as an input. It looks like this case is not implemented in the x64 backend, instead we always perform an optimization and merge those previous instructions.</p>
<h3><code>.clif</code> Test Case</h3>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="n">test</span><span class="w"> </span><span class="n">run</span><span class="w"></span>
<span class="n">target</span><span class="w"> </span><span class="n">x86_64</span><span class="w"> </span><span class="n">machinst</span><span class="w"></span>

<span class="n">function</span><span class="w"> </span><span class="o">%</span><span class="n">iaddp_i8x16</span><span class="p">(</span><span class="n">i8x16</span><span class="p">,</span><span class="w"> </span><span class="n">i8x16</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nc">i8x16</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="n">block0</span><span class="p">(</span><span class="n">v0</span>: <span class="nc">i8x16</span><span class="p">,</span><span class="w"> </span><span class="n">v1</span>: <span class="nc">i8x16</span><span class="p">)</span>:
    <span class="nc">v2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">iadd_pairwise</span><span class="w"> </span><span class="n">v0</span><span class="p">,</span><span class="w"> </span><span class="n">v1</span><span class="w"></span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">v2</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
<span class="p">;</span><span class="w"> </span><span class="n">run</span>: <span class="o">%</span><span class="n">iaddp_i8x16</span><span class="p">([</span><span class="mi">1</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="mi">3</span><span class="w"> </span><span class="mi">4</span><span class="w"> </span><span class="mi">5</span><span class="w"> </span><span class="mi">6</span><span class="w"> </span><span class="mi">7</span><span class="w"> </span><span class="mi">8</span><span class="w"> </span><span class="mi">9</span><span class="w"> </span><span class="mi">10</span><span class="w"> </span><span class="mi">11</span><span class="w"> </span><span class="mi">12</span><span class="w"> </span><span class="mi">13</span><span class="w"> </span><span class="mi">14</span><span class="w"> </span><span class="mi">15</span><span class="w"> </span><span class="mi">16</span><span class="p">],</span><span class="w"> </span><span class="p">[</span><span class="mi">17</span><span class="w"> </span><span class="mi">18</span><span class="w"> </span><span class="mi">19</span><span class="w"> </span><span class="mi">20</span><span class="w"> </span><span class="mi">21</span><span class="w"> </span><span class="mi">22</span><span class="w"> </span><span class="mi">23</span><span class="w"> </span><span class="mi">24</span><span class="w"> </span><span class="mi">25</span><span class="w"> </span><span class="mi">26</span><span class="w"> </span><span class="mi">27</span><span class="w"> </span><span class="mi">28</span><span class="w"> </span><span class="mi">29</span><span class="w"> </span><span class="mi">30</span><span class="w"> </span><span class="mi">31</span><span class="w"> </span><span class="mi">32</span><span class="p">])</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="p">[</span><span class="mi">3</span><span class="w"> </span><span class="mi">7</span><span class="w"> </span><span class="mi">11</span><span class="w"> </span><span class="mi">15</span><span class="w"> </span><span class="mi">19</span><span class="w"> </span><span class="mi">23</span><span class="w"> </span><span class="mi">27</span><span class="w"> </span><span class="mi">31</span><span class="w"> </span><span class="mi">35</span><span class="w"> </span><span class="mi">39</span><span class="w"> </span><span class="mi">43</span><span class="w"> </span><span class="mi">47</span><span class="w"> </span><span class="mi">51</span><span class="w"> </span><span class="mi">55</span><span class="w"> </span><span class="mi">59</span><span class="w"> </span><span class="mi">63</span><span class="p">]</span><span class="w"></span>

<span class="n">function</span><span class="w"> </span><span class="o">%</span><span class="n">iaddp_i16x8</span><span class="p">(</span><span class="n">i16x8</span><span class="p">,</span><span class="w"> </span><span class="n">i16x8</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nc">i16x8</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="n">block0</span><span class="p">(</span><span class="n">v0</span>: <span class="nc">i16x8</span><span class="p">,</span><span class="w"> </span><span class="n">v1</span>: <span class="nc">i16x8</span><span class="p">)</span>:
    <span class="nc">v2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">iadd_pairwise</span><span class="w"> </span><span class="n">v0</span><span class="p">,</span><span class="w"> </span><span class="n">v1</span><span class="w"></span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">v2</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
<span class="p">;</span><span class="w"> </span><span class="n">run</span>: <span class="o">%</span><span class="n">iaddp_i16x8</span><span class="p">([</span><span class="mi">1</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="mi">3</span><span class="w"> </span><span class="mi">4</span><span class="w"> </span><span class="mi">5</span><span class="w"> </span><span class="mi">6</span><span class="w"> </span><span class="mi">7</span><span class="w"> </span><span class="mi">8</span><span class="p">],</span><span class="w"> </span><span class="p">[</span><span class="mi">100</span><span class="w"> </span><span class="mi">99</span><span class="w"> </span><span class="mi">98</span><span class="w"> </span><span class="mi">97</span><span class="w"> </span><span class="mi">96</span><span class="w"> </span><span class="mi">95</span><span class="w"> </span><span class="mi">94</span><span class="w"> </span><span class="mi">93</span><span class="p">])</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="p">[</span><span class="mi">3</span><span class="w"> </span><span class="mi">7</span><span class="w"> </span><span class="mi">11</span><span class="w"> </span><span class="mi">15</span><span class="w"> </span><span class="mi">199</span><span class="w"> </span><span class="mi">195</span><span class="w"> </span><span class="mi">191</span><span class="w"> </span><span class="mi">187</span><span class="p">]</span><span class="w"></span>

<span class="n">function</span><span class="w"> </span><span class="o">%</span><span class="n">iaddp_i32x4</span><span class="p">(</span><span class="n">i32x4</span><span class="p">,</span><span class="w"> </span><span class="n">i32x4</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nc">i32x4</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="n">block0</span><span class="p">(</span><span class="n">v0</span>: <span class="nc">i32x4</span><span class="p">,</span><span class="w"> </span><span class="n">v1</span>: <span class="nc">i32x4</span><span class="p">)</span>:
    <span class="nc">v2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">iadd_pairwise</span><span class="w"> </span><span class="n">v0</span><span class="p">,</span><span class="w"> </span><span class="n">v1</span><span class="w"></span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">v2</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
<span class="p">;</span><span class="w"> </span><span class="n">run</span>: <span class="o">%</span><span class="n">iaddp_i32x4</span><span class="p">([</span><span class="mi">1</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="mi">3</span><span class="w"> </span><span class="mi">4</span><span class="p">],</span><span class="w"> </span><span class="p">[</span><span class="mi">5</span><span class="w"> </span><span class="mi">6</span><span class="w"> </span><span class="mi">7</span><span class="w"> </span><span class="mi">8</span><span class="p">])</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="p">[</span><span class="mi">3</span><span class="w"> </span><span class="mi">7</span><span class="w"> </span><span class="mi">11</span><span class="w"> </span><span class="mi">15</span><span class="p">]</span><span class="w"></span>
<span class="p">;</span><span class="w"> </span><span class="n">run</span>: <span class="o">%</span><span class="n">iaddp_i32x4</span><span class="p">([</span><span class="mi">4294967290</span><span class="w"> </span><span class="mi">5</span><span class="w"> </span><span class="mi">4294967290</span><span class="w"> </span><span class="mi">5</span><span class="p">],</span><span class="w"> </span><span class="p">[</span><span class="mi">100</span><span class="w"> </span><span class="mi">100</span><span class="w"> </span><span class="mi">100</span><span class="w"> </span><span class="mi">100</span><span class="p">])</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="p">[</span><span class="mi">4294967295</span><span class="w"> </span><span class="mi">4294967295</span><span class="w"> </span><span class="mi">200</span><span class="w"> </span><span class="mi">200</span><span class="p">]</span><span class="w"></span>
</code></pre></div>
<h3>Steps to Reproduce</h3>
<p>Run <code>clif-util the-above.clif</code></p>
<h3>Expected Results</h3>
<p>Tests to pass</p>
<h3>Actual Results</h3>
<p>Cranelift crashes with:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="n">thread</span><span class="w"> </span><span class="o">'</span><span class="na">worker</span><span class="w"> </span>#<span class="mi">0</span><span class="o">'</span><span class="w"> </span><span class="n">panicked</span><span class="w"> </span><span class="n">at</span><span class="w"> </span><span class="o">'</span><span class="na">not</span><span class="w"> </span><span class="n">implemented</span>: <span class="nc">Operands</span><span class="w"> </span><span class="n">not</span><span class="w"> </span><span class="n">supported</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">IaddPairwise</span><span class="o">'</span><span class="p">,</span><span class="w"> </span><span class="n">cranelift</span><span class="err">\</span><span class="n">codegen</span><span class="err">\</span><span class="n">src</span><span class="err">\</span><span class="n">isa</span><span class="err">\</span><span class="n">x64</span><span class="err">\</span><span class="n">lower</span><span class="p">.</span><span class="n">rs</span>:<span class="mi">5095</span>:<span class="mi">17</span><span class="w"></span>
<span class="n">note</span>: <span class="nc">run</span><span class="w"> </span><span class="n">with</span><span class="w"> </span><span class="err">`</span><span class="n">RUST_BACKTRACE</span><span class="o">=</span><span class="mi">1</span><span class="err">`</span><span class="w"> </span><span class="n">environment</span><span class="w"> </span><span class="n">variable</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">display</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="n">backtrace</span><span class="w"></span>
<span class="n">FAIL</span><span class="w"> </span><span class="p">.</span><span class="err">\</span><span class="n">filetests</span><span class="err">\</span><span class="n">filetests</span><span class="err">\</span><span class="n">runtests</span><span class="err">\</span><span class="n">test</span><span class="p">.</span><span class="n">clif</span>: <span class="nc">panicked</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="n">worker</span><span class="w"> </span>#<span class="mi">0</span>: <span class="nc">not</span><span class="w"> </span><span class="n">implemented</span>: <span class="nc">Operands</span><span class="w"> </span><span class="n">not</span><span class="w"> </span><span class="n">supported</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">IaddPairwise</span><span class="w"></span>
</code></pre></div>
<h3>Versions and Environment</h3>
<p>Cranelift version or commit: main<br>
Operating system: Windows<br>
Architecture: x64</p>
<h3>Extra Info</h3>
<p>The test file above should be in-tree at <code>cranelift/filetests/filetests/runtests/simd-iaddpairwise.clif</code>, once #3272 is merged.<br>
</p>
</blockquote>



<a name="368737422"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%233273%20Cranelift%3A%20x64%20backend%20crashes%20com.../near/368737422" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.233273.20Cranelift.3A.20x64.20backend.20crashes.20com.2E.2E.2E.html#368737422">(Jun 23 2023 at 02:46)</a>:</h4>
<p>alexcrichton <a href="https://github.com/bytecodealliance/wasmtime/issues/3273#issuecomment-1603612619">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/3273">issue #3273</a>:</p>
<blockquote>
<p>This was implemented in <a href="https://github.com/bytecodealliance/wasmtime/pull/6561">https://github.com/bytecodealliance/wasmtime/pull/6561</a> for the x64 backend, with tests enabled there, so I'm going to close this</p>
</blockquote>



<a name="368737425"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%233273%20Cranelift%3A%20x64%20backend%20crashes%20com.../near/368737425" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.233273.20Cranelift.3A.20x64.20backend.20crashes.20com.2E.2E.2E.html#368737425">(Jun 23 2023 at 02:46)</a>:</h4>
<p>alexcrichton closed <a href="https://github.com/bytecodealliance/wasmtime/issues/3273">issue #3273</a>:</p>
<blockquote>
<p>Hey, In #3272 @dheaton-arm implemented tests for a standalone <code>iadd_pairwise</code> instruction without a <code>swiden_low</code>/<code>swiden_high</code>/<code>uwiden_low</code>/<code>uwiden_high</code> instruction as an input. It looks like this case is not implemented in the x64 backend, instead we always perform an optimization and merge those previous instructions.</p>
<h3><code>.clif</code> Test Case</h3>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="n">test</span><span class="w"> </span><span class="n">run</span>
<span class="n">target</span><span class="w"> </span><span class="n">x86_64</span><span class="w"> </span><span class="n">machinst</span>

<span class="n">function</span><span class="w"> </span><span class="o">%</span><span class="n">iaddp_i8x16</span><span class="p">(</span><span class="n">i8x16</span><span class="p">,</span><span class="w"> </span><span class="n">i8x16</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nc">i8x16</span><span class="w"> </span><span class="p">{</span>
<span class="n">block0</span><span class="p">(</span><span class="n">v0</span>: <span class="nc">i8x16</span><span class="p">,</span><span class="w"> </span><span class="n">v1</span>: <span class="nc">i8x16</span><span class="p">)</span>:
    <span class="nc">v2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">iadd_pairwise</span><span class="w"> </span><span class="n">v0</span><span class="p">,</span><span class="w"> </span><span class="n">v1</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">v2</span>
<span class="p">}</span>
<span class="p">;</span><span class="w"> </span><span class="n">run</span>: <span class="o">%</span><span class="n">iaddp_i8x16</span><span class="p">([</span><span class="mi">1</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="mi">3</span><span class="w"> </span><span class="mi">4</span><span class="w"> </span><span class="mi">5</span><span class="w"> </span><span class="mi">6</span><span class="w"> </span><span class="mi">7</span><span class="w"> </span><span class="mi">8</span><span class="w"> </span><span class="mi">9</span><span class="w"> </span><span class="mi">10</span><span class="w"> </span><span class="mi">11</span><span class="w"> </span><span class="mi">12</span><span class="w"> </span><span class="mi">13</span><span class="w"> </span><span class="mi">14</span><span class="w"> </span><span class="mi">15</span><span class="w"> </span><span class="mi">16</span><span class="p">],</span><span class="w"> </span><span class="p">[</span><span class="mi">17</span><span class="w"> </span><span class="mi">18</span><span class="w"> </span><span class="mi">19</span><span class="w"> </span><span class="mi">20</span><span class="w"> </span><span class="mi">21</span><span class="w"> </span><span class="mi">22</span><span class="w"> </span><span class="mi">23</span><span class="w"> </span><span class="mi">24</span><span class="w"> </span><span class="mi">25</span><span class="w"> </span><span class="mi">26</span><span class="w"> </span><span class="mi">27</span><span class="w"> </span><span class="mi">28</span><span class="w"> </span><span class="mi">29</span><span class="w"> </span><span class="mi">30</span><span class="w"> </span><span class="mi">31</span><span class="w"> </span><span class="mi">32</span><span class="p">])</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="p">[</span><span class="mi">3</span><span class="w"> </span><span class="mi">7</span><span class="w"> </span><span class="mi">11</span><span class="w"> </span><span class="mi">15</span><span class="w"> </span><span class="mi">19</span><span class="w"> </span><span class="mi">23</span><span class="w"> </span><span class="mi">27</span><span class="w"> </span><span class="mi">31</span><span class="w"> </span><span class="mi">35</span><span class="w"> </span><span class="mi">39</span><span class="w"> </span><span class="mi">43</span><span class="w"> </span><span class="mi">47</span><span class="w"> </span><span class="mi">51</span><span class="w"> </span><span class="mi">55</span><span class="w"> </span><span class="mi">59</span><span class="w"> </span><span class="mi">63</span><span class="p">]</span>

<span class="n">function</span><span class="w"> </span><span class="o">%</span><span class="n">iaddp_i16x8</span><span class="p">(</span><span class="n">i16x8</span><span class="p">,</span><span class="w"> </span><span class="n">i16x8</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nc">i16x8</span><span class="w"> </span><span class="p">{</span>
<span class="n">block0</span><span class="p">(</span><span class="n">v0</span>: <span class="nc">i16x8</span><span class="p">,</span><span class="w"> </span><span class="n">v1</span>: <span class="nc">i16x8</span><span class="p">)</span>:
    <span class="nc">v2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">iadd_pairwise</span><span class="w"> </span><span class="n">v0</span><span class="p">,</span><span class="w"> </span><span class="n">v1</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">v2</span>
<span class="p">}</span>
<span class="p">;</span><span class="w"> </span><span class="n">run</span>: <span class="o">%</span><span class="n">iaddp_i16x8</span><span class="p">([</span><span class="mi">1</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="mi">3</span><span class="w"> </span><span class="mi">4</span><span class="w"> </span><span class="mi">5</span><span class="w"> </span><span class="mi">6</span><span class="w"> </span><span class="mi">7</span><span class="w"> </span><span class="mi">8</span><span class="p">],</span><span class="w"> </span><span class="p">[</span><span class="mi">100</span><span class="w"> </span><span class="mi">99</span><span class="w"> </span><span class="mi">98</span><span class="w"> </span><span class="mi">97</span><span class="w"> </span><span class="mi">96</span><span class="w"> </span><span class="mi">95</span><span class="w"> </span><span class="mi">94</span><span class="w"> </span><span class="mi">93</span><span class="p">])</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="p">[</span><span class="mi">3</span><span class="w"> </span><span class="mi">7</span><span class="w"> </span><span class="mi">11</span><span class="w"> </span><span class="mi">15</span><span class="w"> </span><span class="mi">199</span><span class="w"> </span><span class="mi">195</span><span class="w"> </span><span class="mi">191</span><span class="w"> </span><span class="mi">187</span><span class="p">]</span>

<span class="n">function</span><span class="w"> </span><span class="o">%</span><span class="n">iaddp_i32x4</span><span class="p">(</span><span class="n">i32x4</span><span class="p">,</span><span class="w"> </span><span class="n">i32x4</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nc">i32x4</span><span class="w"> </span><span class="p">{</span>
<span class="n">block0</span><span class="p">(</span><span class="n">v0</span>: <span class="nc">i32x4</span><span class="p">,</span><span class="w"> </span><span class="n">v1</span>: <span class="nc">i32x4</span><span class="p">)</span>:
    <span class="nc">v2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">iadd_pairwise</span><span class="w"> </span><span class="n">v0</span><span class="p">,</span><span class="w"> </span><span class="n">v1</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">v2</span>
<span class="p">}</span>
<span class="p">;</span><span class="w"> </span><span class="n">run</span>: <span class="o">%</span><span class="n">iaddp_i32x4</span><span class="p">([</span><span class="mi">1</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="mi">3</span><span class="w"> </span><span class="mi">4</span><span class="p">],</span><span class="w"> </span><span class="p">[</span><span class="mi">5</span><span class="w"> </span><span class="mi">6</span><span class="w"> </span><span class="mi">7</span><span class="w"> </span><span class="mi">8</span><span class="p">])</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="p">[</span><span class="mi">3</span><span class="w"> </span><span class="mi">7</span><span class="w"> </span><span class="mi">11</span><span class="w"> </span><span class="mi">15</span><span class="p">]</span>
<span class="p">;</span><span class="w"> </span><span class="n">run</span>: <span class="o">%</span><span class="n">iaddp_i32x4</span><span class="p">([</span><span class="mi">4294967290</span><span class="w"> </span><span class="mi">5</span><span class="w"> </span><span class="mi">4294967290</span><span class="w"> </span><span class="mi">5</span><span class="p">],</span><span class="w"> </span><span class="p">[</span><span class="mi">100</span><span class="w"> </span><span class="mi">100</span><span class="w"> </span><span class="mi">100</span><span class="w"> </span><span class="mi">100</span><span class="p">])</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="p">[</span><span class="mi">4294967295</span><span class="w"> </span><span class="mi">4294967295</span><span class="w"> </span><span class="mi">200</span><span class="w"> </span><span class="mi">200</span><span class="p">]</span>
</code></pre></div>
<h3>Steps to Reproduce</h3>
<p>Run <code>clif-util the-above.clif</code></p>
<h3>Expected Results</h3>
<p>Tests to pass</p>
<h3>Actual Results</h3>
<p>Cranelift crashes with:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="n">thread</span><span class="w"> </span><span class="o">'</span><span class="na">worker</span><span class="w"> </span>#<span class="mi">0</span><span class="o">'</span><span class="w"> </span><span class="n">panicked</span><span class="w"> </span><span class="n">at</span><span class="w"> </span><span class="o">'</span><span class="na">not</span><span class="w"> </span><span class="n">implemented</span>: <span class="nc">Operands</span><span class="w"> </span><span class="n">not</span><span class="w"> </span><span class="n">supported</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">IaddPairwise</span><span class="o">'</span><span class="p">,</span><span class="w"> </span><span class="n">cranelift</span><span class="err">\</span><span class="n">codegen</span><span class="err">\</span><span class="n">src</span><span class="err">\</span><span class="n">isa</span><span class="err">\</span><span class="n">x64</span><span class="err">\</span><span class="n">lower</span><span class="p">.</span><span class="n">rs</span>:<span class="mi">5095</span>:<span class="mi">17</span>
<span class="n">note</span>: <span class="nc">run</span><span class="w"> </span><span class="n">with</span><span class="w"> </span><span class="err">`</span><span class="n">RUST_BACKTRACE</span><span class="o">=</span><span class="mi">1</span><span class="err">`</span><span class="w"> </span><span class="n">environment</span><span class="w"> </span><span class="n">variable</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">display</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="n">backtrace</span>
<span class="n">FAIL</span><span class="w"> </span><span class="p">.</span><span class="err">\</span><span class="n">filetests</span><span class="err">\</span><span class="n">filetests</span><span class="err">\</span><span class="n">runtests</span><span class="err">\</span><span class="n">test</span><span class="p">.</span><span class="n">clif</span>: <span class="nc">panicked</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="n">worker</span><span class="w"> </span>#<span class="mi">0</span>: <span class="nc">not</span><span class="w"> </span><span class="n">implemented</span>: <span class="nc">Operands</span><span class="w"> </span><span class="n">not</span><span class="w"> </span><span class="n">supported</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">IaddPairwise</span>
</code></pre></div>
<h3>Versions and Environment</h3>
<p>Cranelift version or commit: main<br>
Operating system: Windows<br>
Architecture: x64</p>
<h3>Extra Info</h3>
<p>The test file above should be in-tree at <code>cranelift/filetests/filetests/runtests/simd-iaddpairwise.clif</code>, once #3272 is merged.<br>
</p>
</blockquote>



<hr><p>Last updated: Jan 20 2025 at 06:04 UTC</p>
</html>