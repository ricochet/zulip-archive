<html>
<head><meta charset="utf-8"><title>wasmtime / issue #3654 Cranelift: timing module for `cran... · git-wasmtime · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/index.html">git-wasmtime</a></h2>
<h3>Topic: <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.233654.20Cranelift.3A.20timing.20module.20for.20.60cran.2E.2E.2E.html">wasmtime / issue #3654 Cranelift: timing module for `cran...</a></h3>

<hr>

<base href="https://bytecodealliance.zulipchat.com">

<head><link href="https://bytecodealliance.github.io/zulip-archive/style.css" rel="stylesheet"></head>

<a name="267028423"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%233654%20Cranelift%3A%20timing%20module%20for%20%60cran.../near/267028423" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.233654.20Cranelift.3A.20timing.20module.20for.20.60cran.2E.2E.2E.html#267028423">(Jan 06 2022 at 05:57)</a>:</h4>
<p>kdy1 opened <a href="https://github.com/bytecodealliance/wasmtime/issues/3654">issue #3654</a>:</p>
<blockquote>
<p>Thanks for filing an issue! Please fill out the TODOs below.</p>
<h3><code>.clif</code> Test Case</h3>
<p>I think this is not relevant because it's an issue about thread-local usage. </p>
<p><a href="https://github.com/bytecodealliance/wasmtime/blob/8043c1f919a77905255eded33e4e51a6fbfd1de1/cranelift/codegen/src/timing.rs#L178-L181">https://github.com/bytecodealliance/wasmtime/blob/8043c1f919a77905255eded33e4e51a6fbfd1de1/cranelift/codegen/src/timing.rs#L178-L181</a></p>
<p>This is the issue</p>
<h3>Steps to Reproduce</h3>
<ol>
<li>git clone <a href="https://github.com/swc-project/swc.git">https://github.com/swc-project/swc.git</a></li>
<li>cd swc</li>
<li>git checkout d901b6222f8a77beed64968fcb4764bbacf8c755</li>
<li>yarn build</li>
<li>yarn test</li>
</ol>
<h3>Expected Results</h3>
<p>Tests should success</p>
<h3>Actual Results</h3>
<p><code>node.js</code> fails to load the swc node binding, because the node binding is using too much TLS space.</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="o">/</span><span class="n">swc</span><span class="o">/</span><span class="n">swc</span><span class="p">.</span><span class="n">linux</span><span class="o">-</span><span class="n">x64</span><span class="o">-</span><span class="n">gnu</span><span class="p">.</span><span class="n">node</span>: <span class="nc">cannot</span><span class="w"> </span><span class="n">allocate</span><span class="w"> </span><span class="n">memory</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="k">static</span><span class="w"> </span><span class="n">TLS</span><span class="w"> </span><span class="n">block</span><span class="w"></span>
</code></pre></div>
<h3>Versions and Environment</h3>
<p>Cranelift version or commit: Current master (<a href="https://github.com/bytecodealliance/wasmtime/commit/8043c1f919a77905255eded33e4e51a6fbfd1de1">https://github.com/bytecodealliance/wasmtime/commit/8043c1f919a77905255eded33e4e51a6fbfd1de1</a>)</p>
<p>Operating system: linux with glibc</p>
<p>Architecture: gnu</p>
<h3>Extra Info</h3>
<p>Is it fine to add a cargo feature like <code>disable-timing</code>?</p>
</blockquote>



<a name="267028424"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%233654%20Cranelift%3A%20timing%20module%20for%20%60cran.../near/267028424" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.233654.20Cranelift.3A.20timing.20module.20for.20.60cran.2E.2E.2E.html#267028424">(Jan 06 2022 at 05:57)</a>:</h4>
<p>kdy1 labeled <a href="https://github.com/bytecodealliance/wasmtime/issues/3654">issue #3654</a>:</p>
<blockquote>
<p>Thanks for filing an issue! Please fill out the TODOs below.</p>
<h3><code>.clif</code> Test Case</h3>
<p>I think this is not relevant because it's an issue about thread-local usage. </p>
<p><a href="https://github.com/bytecodealliance/wasmtime/blob/8043c1f919a77905255eded33e4e51a6fbfd1de1/cranelift/codegen/src/timing.rs#L178-L181">https://github.com/bytecodealliance/wasmtime/blob/8043c1f919a77905255eded33e4e51a6fbfd1de1/cranelift/codegen/src/timing.rs#L178-L181</a></p>
<p>This is the issue</p>
<h3>Steps to Reproduce</h3>
<ol>
<li>git clone <a href="https://github.com/swc-project/swc.git">https://github.com/swc-project/swc.git</a></li>
<li>cd swc</li>
<li>git checkout d901b6222f8a77beed64968fcb4764bbacf8c755</li>
<li>yarn build</li>
<li>yarn test</li>
</ol>
<h3>Expected Results</h3>
<p>Tests should success</p>
<h3>Actual Results</h3>
<p><code>node.js</code> fails to load the swc node binding, because the node binding is using too much TLS space.</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="o">/</span><span class="n">swc</span><span class="o">/</span><span class="n">swc</span><span class="p">.</span><span class="n">linux</span><span class="o">-</span><span class="n">x64</span><span class="o">-</span><span class="n">gnu</span><span class="p">.</span><span class="n">node</span>: <span class="nc">cannot</span><span class="w"> </span><span class="n">allocate</span><span class="w"> </span><span class="n">memory</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="k">static</span><span class="w"> </span><span class="n">TLS</span><span class="w"> </span><span class="n">block</span><span class="w"></span>
</code></pre></div>
<h3>Versions and Environment</h3>
<p>Cranelift version or commit: Current master (<a href="https://github.com/bytecodealliance/wasmtime/commit/8043c1f919a77905255eded33e4e51a6fbfd1de1">https://github.com/bytecodealliance/wasmtime/commit/8043c1f919a77905255eded33e4e51a6fbfd1de1</a>)</p>
<p>Operating system: linux with glibc</p>
<p>Architecture: gnu</p>
<h3>Extra Info</h3>
<p>Is it fine to add a cargo feature like <code>disable-timing</code>?</p>
</blockquote>



<a name="267028425"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%233654%20Cranelift%3A%20timing%20module%20for%20%60cran.../near/267028425" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.233654.20Cranelift.3A.20timing.20module.20for.20.60cran.2E.2E.2E.html#267028425">(Jan 06 2022 at 05:57)</a>:</h4>
<p>kdy1 labeled <a href="https://github.com/bytecodealliance/wasmtime/issues/3654">issue #3654</a>:</p>
<blockquote>
<p>Thanks for filing an issue! Please fill out the TODOs below.</p>
<h3><code>.clif</code> Test Case</h3>
<p>I think this is not relevant because it's an issue about thread-local usage. </p>
<p><a href="https://github.com/bytecodealliance/wasmtime/blob/8043c1f919a77905255eded33e4e51a6fbfd1de1/cranelift/codegen/src/timing.rs#L178-L181">https://github.com/bytecodealliance/wasmtime/blob/8043c1f919a77905255eded33e4e51a6fbfd1de1/cranelift/codegen/src/timing.rs#L178-L181</a></p>
<p>This is the issue</p>
<h3>Steps to Reproduce</h3>
<ol>
<li>git clone <a href="https://github.com/swc-project/swc.git">https://github.com/swc-project/swc.git</a></li>
<li>cd swc</li>
<li>git checkout d901b6222f8a77beed64968fcb4764bbacf8c755</li>
<li>yarn build</li>
<li>yarn test</li>
</ol>
<h3>Expected Results</h3>
<p>Tests should success</p>
<h3>Actual Results</h3>
<p><code>node.js</code> fails to load the swc node binding, because the node binding is using too much TLS space.</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="o">/</span><span class="n">swc</span><span class="o">/</span><span class="n">swc</span><span class="p">.</span><span class="n">linux</span><span class="o">-</span><span class="n">x64</span><span class="o">-</span><span class="n">gnu</span><span class="p">.</span><span class="n">node</span>: <span class="nc">cannot</span><span class="w"> </span><span class="n">allocate</span><span class="w"> </span><span class="n">memory</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="k">static</span><span class="w"> </span><span class="n">TLS</span><span class="w"> </span><span class="n">block</span><span class="w"></span>
</code></pre></div>
<h3>Versions and Environment</h3>
<p>Cranelift version or commit: Current master (<a href="https://github.com/bytecodealliance/wasmtime/commit/8043c1f919a77905255eded33e4e51a6fbfd1de1">https://github.com/bytecodealliance/wasmtime/commit/8043c1f919a77905255eded33e4e51a6fbfd1de1</a>)</p>
<p>Operating system: linux with glibc</p>
<p>Architecture: gnu</p>
<h3>Extra Info</h3>
<p>Is it fine to add a cargo feature like <code>disable-timing</code>?</p>
</blockquote>



<a name="267028430"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%233654%20Cranelift%3A%20timing%20module%20for%20%60cran.../near/267028430" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.233654.20Cranelift.3A.20timing.20module.20for.20.60cran.2E.2E.2E.html#267028430">(Jan 06 2022 at 05:58)</a>:</h4>
<p>kdy1 edited <a href="https://github.com/bytecodealliance/wasmtime/issues/3654">issue #3654</a>:</p>
<blockquote>
<h3><code>.clif</code> Test Case</h3>
<p>I think this is not relevant because it's an issue about thread-local usage. </p>
<p><a href="https://github.com/bytecodealliance/wasmtime/blob/8043c1f919a77905255eded33e4e51a6fbfd1de1/cranelift/codegen/src/timing.rs#L178-L181">https://github.com/bytecodealliance/wasmtime/blob/8043c1f919a77905255eded33e4e51a6fbfd1de1/cranelift/codegen/src/timing.rs#L178-L181</a></p>
<p>This is the issue</p>
<h3>Steps to Reproduce</h3>
<ol>
<li>git clone <a href="https://github.com/swc-project/swc.git">https://github.com/swc-project/swc.git</a></li>
<li>cd swc</li>
<li>git checkout d901b6222f8a77beed64968fcb4764bbacf8c755</li>
<li>yarn build</li>
<li>yarn test</li>
</ol>
<h3>Expected Results</h3>
<p>Tests should success</p>
<h3>Actual Results</h3>
<p><code>node.js</code> fails to load the swc node binding, because the node binding is using too much TLS space.</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="o">/</span><span class="n">swc</span><span class="o">/</span><span class="n">swc</span><span class="p">.</span><span class="n">linux</span><span class="o">-</span><span class="n">x64</span><span class="o">-</span><span class="n">gnu</span><span class="p">.</span><span class="n">node</span>: <span class="nc">cannot</span><span class="w"> </span><span class="n">allocate</span><span class="w"> </span><span class="n">memory</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="k">static</span><span class="w"> </span><span class="n">TLS</span><span class="w"> </span><span class="n">block</span><span class="w"></span>
</code></pre></div>
<h3>Versions and Environment</h3>
<p>Cranelift version or commit: Current master (<a href="https://github.com/bytecodealliance/wasmtime/commit/8043c1f919a77905255eded33e4e51a6fbfd1de1">https://github.com/bytecodealliance/wasmtime/commit/8043c1f919a77905255eded33e4e51a6fbfd1de1</a>)</p>
<p>Operating system: linux with glibc</p>
<p>Architecture: gnu</p>
<h3>Extra Info</h3>
<p>Is it fine to add a cargo feature like <code>disable-timing</code>?</p>
</blockquote>



<a name="267034749"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%233654%20Cranelift%3A%20timing%20module%20for%20%60cran.../near/267034749" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.233654.20Cranelift.3A.20timing.20module.20for.20.60cran.2E.2E.2E.html#267034749">(Jan 06 2022 at 08:06)</a>:</h4>
<p>bjorn3 <a href="https://github.com/bytecodealliance/wasmtime/issues/3654#issuecomment-1006360189">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/3654">issue #3654</a>:</p>
<blockquote>
<p>Can you run <code>llvm-objdump -C -t /path/to/swc.node</code> and then grep for <code>.tdata</code> or <code>.tbss</code>? This should make it clear which thread local variables are responsible for the excessive TLS usage. The timing module uses less than the maximum of 2048 bytes.</p>
<p><a href="https://fasterthanli.me/articles/a-dynamic-linker-murder-mystery">https://fasterthanli.me/articles/a-dynamic-linker-murder-mystery</a></p>
</blockquote>



<a name="267036173"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%233654%20Cranelift%3A%20timing%20module%20for%20%60cran.../near/267036173" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.233654.20Cranelift.3A.20timing.20module.20for.20.60cran.2E.2E.2E.html#267036173">(Jan 06 2022 at 08:28)</a>:</h4>
<p>kdy1 <a href="https://github.com/bytecodealliance/wasmtime/issues/3654#issuecomment-1006372104">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/3654">issue #3654</a>:</p>
<blockquote>
<p>Of course! Sorry, I thought I posted it.</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="cp">$</span><span class="w"> </span><span class="n">readelf</span><span class="w"> </span><span class="o">-</span><span class="n">Wl</span><span class="w"> </span><span class="n">swc</span><span class="p">.</span><span class="n">linux</span><span class="o">-</span><span class="n">x64</span><span class="o">-</span><span class="n">gnu</span><span class="p">.</span><span class="n">node</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">grep</span><span class="w"> </span><span class="o">-</span><span class="n">E</span><span class="w"> </span><span class="o">'</span><span class="na">PhysAddr</span><span class="o">|</span><span class="n">TLS</span><span class="o">'</span><span class="w"></span>

<span class="w">  </span><span class="n">Type</span><span class="w">           </span><span class="n">Offset</span><span class="w">   </span><span class="n">VirtAddr</span><span class="w">           </span><span class="n">PhysAddr</span><span class="w">           </span><span class="n">FileSiz</span><span class="w">  </span><span class="n">MemSiz</span><span class="w">   </span><span class="n">Flg</span><span class="w"> </span><span class="n">Align</span><span class="w"></span>
<span class="w">  </span><span class="n">TLS</span><span class="w">            </span><span class="mh">0x2028980</span><span class="w"> </span><span class="mh">0x0000000002029980</span><span class="w"> </span><span class="mh">0x0000000002029980</span><span class="w"> </span><span class="mh">0x0000b0</span><span class="w"> </span><span class="mh">0x00084d</span><span class="w"> </span><span class="n">R</span><span class="w">   </span><span class="mh">0x10</span><span class="w"></span>
</code></pre></div>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="cp">$</span><span class="w"> </span><span class="n">llvm</span><span class="o">-</span><span class="n">objdump</span><span class="w"> </span><span class="o">-</span><span class="n">C</span><span class="w"> </span><span class="o">-</span><span class="n">t</span><span class="w"> </span><span class="n">swc</span><span class="p">.</span><span class="n">linux</span><span class="o">-</span><span class="n">x64</span><span class="o">-</span><span class="n">gnu</span><span class="p">.</span><span class="n">node</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">grep</span><span class="w"> </span><span class="o">-</span><span class="n">F</span><span class="w"> </span><span class="o">'</span><span class="p">.</span><span class="n">tdata</span><span class="o">'</span><span class="w"></span>

<span class="mi">0000000002029980</span><span class="w"> </span><span class="n">l</span><span class="w">    </span><span class="n">d</span><span class="w">  </span><span class="p">.</span><span class="n">tdata</span><span class="w"> </span><span class="mi">00000000</span><span class="w"> </span><span class="p">.</span><span class="n">tdata</span><span class="w"></span>
<span class="mi">0000000000000078</span><span class="w"> </span><span class="n">l</span><span class="w">     </span><span class="n">O</span><span class="w"> </span><span class="p">.</span><span class="n">tdata</span><span class="w"> </span><span class="mi">00000028</span><span class="w"> </span><span class="n">tracing_core</span>::<span class="n">dispatcher</span>::<span class="n">CURRENT_STATE</span>::<span class="n">__getit</span>::<span class="n">__KEY</span>::<span class="n">h1e739189ed69442f</span><span class="w"></span>
<span class="mi">0000000000000060</span><span class="w"> </span><span class="n">l</span><span class="w">     </span><span class="n">O</span><span class="w"> </span><span class="p">.</span><span class="n">tdata</span><span class="w"> </span><span class="mi">00000018</span><span class="w"> </span><span class="n">sharded_slab</span>::<span class="n">tid</span>::<span class="n">REGISTRATION</span>::<span class="n">__getit</span>::<span class="n">__KEY</span>::<span class="n">h361b7be9b3025982</span><span class="w"></span>
<span class="mi">00000000000000</span><span class="n">a0</span><span class="w"> </span><span class="n">l</span><span class="w">     </span><span class="n">O</span><span class="w"> </span><span class="p">.</span><span class="n">tdata</span><span class="w"> </span><span class="mi">00000001</span><span class="w"> </span><span class="n">backtrace</span>::<span class="n">lock</span>::<span class="n">LOCK_HELD</span>::<span class="n">__getit</span>::<span class="n">__KEY</span>::<span class="n">h3cc357ac3fd8018a</span><span class="w"> </span><span class="p">(.</span><span class="mf">0.0</span><span class="p">)</span><span class="w"></span>
<span class="mi">00000000000000</span><span class="n">a1</span><span class="w"> </span><span class="n">l</span><span class="w">     </span><span class="n">O</span><span class="w"> </span><span class="p">.</span><span class="n">tdata</span><span class="w"> </span><span class="mi">00000001</span><span class="w"> </span><span class="n">cranelift_codegen</span>::<span class="n">timing</span>::<span class="n">details</span>::<span class="n">CURRENT_PASS</span>::<span class="n">__getit</span>::<span class="n">__KEY</span>::<span class="n">h06255f6d1e918b18</span><span class="w"> </span><span class="p">(.</span><span class="mf">0.0</span><span class="p">)</span><span class="w"></span>
<span class="mi">0000000000000000</span><span class="w"> </span><span class="n">l</span><span class="w">     </span><span class="n">O</span><span class="w"> </span><span class="p">.</span><span class="n">tdata</span><span class="w"> </span><span class="mi">00000030</span><span class="w"> </span><span class="n">parking_lot_core</span>::<span class="n">parking_lot</span>::<span class="n">with_thread_data</span>::<span class="n">THREAD_DATA</span>::<span class="n">__getit</span>::<span class="n">__KEY</span>::<span class="n">h03e0eec2789cad6f</span><span class="w"></span>
<span class="mi">0000000000000030</span><span class="w"> </span><span class="n">l</span><span class="w">     </span><span class="n">O</span><span class="w"> </span><span class="p">.</span><span class="n">tdata</span><span class="w"> </span><span class="mi">00000028</span><span class="w"> </span><span class="n">std</span>::<span class="n">sys_common</span>::<span class="n">thread_info</span>::<span class="n">THREAD_INFO</span>::<span class="n">__getit</span>::<span class="n">VAL</span>::<span class="n">h7220d9cfd6f7a9c4</span><span class="w"></span>
<span class="mi">00000000000000</span><span class="n">a8</span><span class="w"> </span><span class="n">l</span><span class="w">     </span><span class="n">O</span><span class="w"> </span><span class="p">.</span><span class="n">tdata</span><span class="w"> </span><span class="mi">00000008</span><span class="w"> </span><span class="n">_mi_heap_default</span><span class="w"></span>
</code></pre></div>
<p><div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="cp">$</span><span class="w"> </span><span class="n">llvm</span><span class="o">-</span><span class="n">objdump</span><span class="w"> </span><span class="o">-</span><span class="n">C</span><span class="w"> </span><span class="o">-</span><span class="n">t</span><span class="w"> </span><span class="n">swc</span><span class="p">.</span><span class="n">linux</span><span class="o">-</span><span class="n">x64</span><span class="o">-</span><span class="n">gnu</span><span class="p">.</span><span class="n">node</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">grep</span><span class="w"> </span><span class="o">-</span><span class="n">F</span><span class="w"> </span><span class="o">'</span><span class="p">.</span><span class="n">tbss</span><span class="o">'</span><span class="w"></span>

<span class="mi">0000000002029</span><span class="n">a30</span><span class="w"> </span><span class="n">l</span><span class="w">    </span><span class="n">d</span><span class="w">  </span><span class="p">.</span><span class="n">tbss</span><span class="w">  </span><span class="mi">00000000</span><span class="w"> </span><span class="p">.</span><span class="n">tbss</span><span class="w"></span>
<span class="mi">0000000000000660</span><span class="w"> </span><span class="n">l</span><span class="w">     </span><span class="n">O</span><span class="w"> </span><span class="p">.</span><span class="n">tbss</span><span class="w">  </span><span class="mi">00000018</span><span class="w"> </span><span class="n">swc_common</span>::<span class="n">syntax_pos</span>::<span class="n">GLOBALS</span>::<span class="n">FOO</span>::<span class="n">__getit</span>::<span class="n">__KEY</span>::<span class="n">h9429b619b9c3b9a4</span><span class="w"></span>
<span class="mi">0000000000000778</span><span class="w"> </span><span class="n">l</span><span class="w">     </span><span class="n">O</span><span class="w"> </span><span class="p">.</span><span class="n">tbss</span><span class="w">  </span><span class="mi">00000018</span><span class="w"> </span><span class="n">rayon_core</span>::<span class="n">registry</span>::<span class="n">WORKER_THREAD_STATE</span>::<span class="n">__getit</span>::<span class="n">__KEY</span>::<span class="n">h858fe9d7bafa379a</span><span class="w"></span>
<span class="mi">0000000000000790</span><span class="w"> </span><span class="n">l</span><span class="w">     </span><span class="n">O</span><span class="w"> </span><span class="p">.</span><span class="n">tbss</span><span class="w">  </span><span class="mi">00000028</span><span class="w"> </span><span class="n">rayon_core</span>::<span class="n">registry</span>::<span class="n">Registry</span>::<span class="n">in_worker_cold</span>::<span class="n">LOCK_LATCH</span>::<span class="n">__getit</span>::<span class="n">__KEY</span>::<span class="n">h697c1168d92c27b8</span><span class="w"></span>
<span class="mi">0000000000000750</span><span class="w"> </span><span class="n">l</span><span class="w">     </span><span class="n">O</span><span class="w"> </span><span class="p">.</span><span class="n">tbss</span><span class="w">  </span><span class="mi">00000028</span><span class="w"> </span><span class="n">tracing_subscriber</span>::<span class="n">filter</span>::<span class="n">layer_filters</span>::<span class="n">FILTERING</span>::<span class="n">__getit</span>::<span class="n">__KEY</span>::<span class="n">hfcf018e992ac8c34</span><span class="w"></span>
<span class="mi">0000000000000698</span><span class="w"> </span><span class="n">l</span><span class="w">     </span><span class="n">O</span><span class="w"> </span><span class="p">.</span><span class="n">tbss</span><span class="w">  </span><span class="mi">00000030</span><span class="w"> </span><span class="n">thread_local</span>::<span class="n">thread_id</span>::<span class="n">THREAD_HOLDER</span>::<span class="n">__getit</span>::<span class="n">__KEY</span>::<span class="n">h4ca3716321184c00</span><span class="w"></span>
<span class="mi">00000000000006</span><span class="n">d0</span><span class="w"> </span><span class="n">l</span><span class="w">     </span><span class="n">O</span><span class="w"> </span><span class="p">.</span><span class="n">tbss</span><span class="w">  </span><span class="mi">00000030</span><span class="w"> </span><span class="n">tracing_subscriber</span>::<span class="n">filter</span>::<span class="n">env</span>::<span class="n">SCOPE</span>::<span class="n">__getit</span>::<span class="n">__KEY</span>::<span class="n">h7643333f5d409469</span><span class="w"></span>
<span class="mi">0000000000000700</span><span class="w"> </span><span class="n">l</span><span class="w">     </span><span class="n">O</span><span class="w"> </span><span class="p">.</span><span class="n">tbss</span><span class="w">  </span><span class="mi">00000018</span><span class="w"> </span><span class="n">tracing_subscriber</span>::<span class="n">registry</span>::<span class="n">sharded</span>::<span class="n">CLOSE_COUNT</span>::<span class="n">__getit</span>::<span class="n">__KEY</span>::<span class="n">h6de4dd54e98564a1</span><span class="w"></span>
<span class="mi">00000000000005</span><span class="n">b8</span><span class="w"> </span><span class="n">l</span><span class="w">     </span><span class="n">O</span><span class="w"> </span><span class="p">.</span><span class="n">tbss</span><span class="w">  </span><span class="mi">00000018</span><span class="w"> </span><span class="n">regex</span>::<span class="n">pool</span>::<span class="n">THREAD_ID</span>::<span class="n">__getit</span>::<span class="n">__KEY</span>::<span class="n">h15dd10060d91dde1</span><span class="w"></span>
<span class="mi">0000000000000680</span><span class="w"> </span><span class="n">l</span><span class="w">     </span><span class="n">O</span><span class="w"> </span><span class="p">.</span><span class="n">tbss</span><span class="w">  </span><span class="mi">00000018</span><span class="w"> </span><span class="n">swc_ecma_transforms_base</span>::<span class="n">helpers</span>::<span class="n">HELPERS</span>::<span class="n">FOO</span>::<span class="n">__getit</span>::<span class="n">__KEY</span>::<span class="n">h8bfa7f8e1f9e3276</span><span class="w"></span>
<span class="mi">0000000000000720</span><span class="w"> </span><span class="n">l</span><span class="w">     </span><span class="n">O</span><span class="w"> </span><span class="p">.</span><span class="n">tbss</span><span class="w">  </span><span class="mi">00000030</span><span class="w"> </span><span class="n">_</span><span class="cp">$LT$tracing_subscriber</span><span class="o">..</span><span class="n">fmt</span><span class="o">..</span><span class="n">fmt_layer</span><span class="o">..</span><span class="n">Layer</span><span class="cp">$LT$S$C$N$C$E$C$W$GT$$u20$as$u20$tracing_subscriber</span><span class="o">..</span><span class="n">layer</span><span class="o">..</span><span class="n">Layer</span><span class="cp">$LT$S$GT$$GT$</span>::<span class="n">on_event</span>::<span class="n">BUF</span>::<span class="n">__getit</span>::<span class="n">__KEY</span>::<span class="n">h95b197147e77bb07</span><span class="w"></span>
<span class="mi">00000000000007</span><span class="n">b8</span><span class="w"> </span><span class="n">l</span><span class="w">     </span><span class="n">O</span><span class="w"> </span><span class="p">.</span><span class="n">tbss</span><span class="w">  </span><span class="mi">00000018</span><span class="w"> </span><span class="n">crossbeam_epoch</span>::<span class="n">default</span>::<span class="n">HANDLE</span>::<span class="n">__getit</span>::<span class="n">__KEY</span>::<span class="n">h0c1b98d9dd2a21b8</span><span class="w"></span>
<span class="mi">0000000000000820</span><span class="w"> </span><span class="n">l</span><span class="w">     </span><span class="n">O</span><span class="w"> </span><span class="p">.</span><span class="n">tbss</span><span class="w">  </span><span class="mi">00000020</span><span class="w"> </span><span class="n">std</span>::<span class="n">collections</span>::<span class="n">hash</span>::<span class="n">map</span>::<span class="n">RandomState</span>::<span class="n">new</span>::<span class="n">KEYS</span>::<span class="n">__getit</span>::<span class="n">__KEY</span>::<span class="n">h8c747f1f3fba03b2</span><span class="w"></span>
<span class="mi">0000000000000640</span><span class="w"> </span><span class="n">l</span><span class="w">     </span><span class="n">O</span><span class="w"> </span><span class="p">.</span><span class="n">tbss</span><span class="w">  </span><span class="mi">00000018</span><span class="w"> </span><span class="n">swc_common</span>::<span class="n">errors</span>::<span class="n">HANDLER</span>::<span class="n">FOO</span>::<span class="n">__getit</span>::<span class="n">__KEY</span>::<span class="n">hdbd2b92021199add</span><span class="w"></span>
<span class="mi">00000000000000</span><span class="n">b0</span><span class="w"> </span><span class="n">l</span><span class="w">     </span><span class="n">O</span><span class="w"> </span><span class="p">.</span><span class="n">tbss</span><span class="w">  </span><span class="mi">000004</span><span class="n">b8</span><span class="w"> </span><span class="n">cranelift_codegen</span>::<span class="n">timing</span>::<span class="n">details</span>::<span class="n">PASS_TIME</span>::<span class="n">__getit</span>::<span class="n">__KEY</span>::<span class="n">hf5cf71b784ccc3ac</span><span class="w"></span>
<span class="mi">0000000000000570</span><span class="w"> </span><span class="n">l</span><span class="w">     </span><span class="n">O</span><span class="w"> </span><span class="p">.</span><span class="n">tbss</span><span class="w">  </span><span class="mi">00000048</span><span class="w"> </span><span class="n">napi</span>::<span class="n">bindgen_runtime</span>::<span class="n">module_register</span>::<span class="n">REGISTERED_CLASSES</span>::<span class="n">__getit</span>::<span class="n">__KEY</span>::<span class="n">hb4af2239b740d668</span><span class="w"></span>
<span class="mi">00000000000005</span><span class="n">d0</span><span class="w"> </span><span class="n">l</span><span class="w">     </span><span class="n">O</span><span class="w"> </span><span class="p">.</span><span class="n">tbss</span><span class="w">  </span><span class="mi">00000018</span><span class="w"> </span><span class="n">std</span>::<span class="n">io</span>::<span class="n">stdio</span>::<span class="n">OUTPUT_CAPTURE</span>::<span class="n">__getit</span>::<span class="n">__KEY</span>::<span class="n">hf77b7ab11412dca1</span><span class="w"></span>
<span class="mi">0000000000000608</span><span class="w"> </span><span class="n">l</span><span class="w">     </span><span class="n">O</span><span class="w"> </span><span class="p">.</span><span class="n">tbss</span><span class="w">  </span><span class="mi">00000001</span><span class="w"> </span><span class="n">std</span>::<span class="n">sys_common</span>::<span class="n">thread_info</span>::<span class="n">THREAD_INFO</span>::<span class="n">__getit</span>::<span class="n">STATE</span>::<span class="n">h8d316da519a744b0</span><span class="w"> </span><span class="p">(.</span><span class="mf">0.0</span><span class="p">)</span><span class="w"></span>
<span class="mi">00000000000005</span><span class="n">f0</span><span class="w"> </span><span class="n">l</span><span class="w">     </span><span class="n">O</span><span class="w"> </span><span class="p">.</span><span class="n">tbss</span><span class="w">  </span><span class="mi">00000018</span><span class="w"> </span><span class="n">std</span>::<span class="n">panicking</span>::<span class="n">panic_count</span>::<span class="n">LOCAL_PANIC_COUNT</span>::<span class="n">__getit</span>::<span class="n">__KEY</span>::<span class="n">h00a600e6cc6ae43d</span><span class="w"></span>
<span class="mi">0000000000000610</span><span class="w"> </span><span class="n">l</span><span class="w">     </span><span class="n">O</span><span class="w"> </span><span class="p">.</span><span class="n">tbss</span><span class="w">  </span><span class="mi">00000028</span><span class="w"> </span><span class="n">swc_common</span>::<span class="n">errors</span>::<span class="n">TRACK_DIAGNOSTICS</span>::<span class="n">__getit</span>::<span class="n">__KEY</span>::<span class="n">h47e578a9e812e486</span><span class="w"></span>
<span class="mi">0000000000000840</span><span class="w"> </span><span class="n">l</span><span class="w">     </span><span class="n">O</span><span class="w"> </span><span class="p">.</span><span class="n">tbss</span><span class="w">  </span><span class="mi">0000000</span><span class="n">c</span><span class="w"> </span><span class="n">wast</span>::<span class="n">resolve</span>::<span class="n">gensym</span>::<span class="n">NEXT</span>::<span class="n">__getit</span>::<span class="n">__KEY</span>::<span class="n">h427fbcdc6e5f05e2</span><span class="w"></span>
<span class="mi">00000000000007</span><span class="n">d0</span><span class="w"> </span><span class="n">l</span><span class="w">     </span><span class="n">O</span><span class="w"> </span><span class="p">.</span><span class="n">tbss</span><span class="w">  </span><span class="mi">00000020</span><span class="w"> </span><span class="n">wasmer_vm</span>::<span class="n">trap</span>::<span class="n">traphandlers</span>::<span class="n">tls</span>::<span class="n">raw</span>::<span class="n">PTR</span>::<span class="n">__getit</span>::<span class="n">__KEY</span>::<span class="n">hd09811897ad75770</span><span class="w"></span>
<span class="mi">00000000000007</span><span class="n">f0</span><span class="w"> </span><span class="n">l</span><span class="w">     </span><span class="n">O</span><span class="w"> </span><span class="p">.</span><span class="n">tbss</span><span class="w">  </span><span class="mi">00000030</span><span class="w"> </span><span class="n">wasmer_vm</span>::<span class="n">trap</span>::<span class="n">traphandlers</span>::<span class="n">lazy_per_thread_init</span>::<span class="n">TLS</span>::<span class="n">__getit</span>::<span class="n">__KEY</span>::<span class="n">h620135b9ef0504b6</span><span class="w"></span>
<span class="mi">000000000000084</span><span class="n">c</span><span class="w"> </span><span class="n">l</span><span class="w">     </span><span class="n">O</span><span class="w"> </span><span class="p">.</span><span class="n">tbss</span><span class="w">  </span><span class="mi">00000001</span><span class="w"> </span><span class="n">recurse</span><span class="w"></span>
</code></pre></div><br>
</p>
</blockquote>



<a name="267067160"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%233654%20Cranelift%3A%20timing%20module%20for%20%60cran.../near/267067160" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.233654.20Cranelift.3A.20timing.20module.20for.20.60cran.2E.2E.2E.html#267067160">(Jan 06 2022 at 14:35)</a>:</h4>
<p>bjorn3 <a href="https://github.com/bytecodealliance/wasmtime/issues/3654#issuecomment-1006638940">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/3654">issue #3654</a>:</p>
<blockquote>
<p>I see. Cranelift indeed uses a lot of tls space. Still it feels like this should be fixed in nodejs or napi and not in cranelift. Swc is compiled as dynamic library that is dlopened, so it should use dynamic tls and not static tls. Static tls is only allowed for the main executable and the dynamic libraries declared as dependencies of the main executable. The fact that it works at all in some cases is because glibc reserved another 1024 bytes just in case someone dlopens a dynamic library compiled with static tls instead of dynamic tls.</p>
<p>After I wrote the above text I did some digging and it seems like <code>zig cc</code> which is used by napi passes <code>-ftls-model=initial-exec</code>: <a href="https://cs.github.com/ziglang/zig/blob/5c228765f1094d30e64d13c0077c67b2867ecd6a/src/glibc.zig?q=tls-model%20language%3AZig#L325">https://cs.github.com/ziglang/zig/blob/5c228765f1094d30e64d13c0077c67b2867ecd6a/src/glibc.zig?q=tls-model%20language%3AZig#L325</a> Patching this away should fix the issue for you.</p>
</blockquote>



<a name="267067193"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%233654%20Cranelift%3A%20timing%20module%20for%20%60cran.../near/267067193" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.233654.20Cranelift.3A.20timing.20module.20for.20.60cran.2E.2E.2E.html#267067193">(Jan 06 2022 at 14:35)</a>:</h4>
<p>bjorn3 edited a <a href="https://github.com/bytecodealliance/wasmtime/issues/3654#issuecomment-1006638940">comment</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/3654">issue #3654</a>:</p>
<blockquote>
<p>I see. Cranelift indeed uses a lot of tls space. Still it feels like this should be fixed in nodejs or napi and not in cranelift. Swc is compiled as dynamic library that is dlopened, so it should use dynamic tls and not static tls. Static tls is only allowed for the main executable and the dynamic libraries declared as dependencies of the main executable. The fact that it works at all in some cases is because glibc reserved another 1024 bytes just in case someone dlopens a dynamic library compiled with static tls instead of dynamic tls.</p>
<p>After I wrote the above text I did some digging and it seems like <code>zig cc</code> which is used by napi passes <code>-ftls-model=initial-exec</code>: <a href="https://cs.github.com/ziglang/zig/blob/5c228765f1094d30e64d13c0077c67b2867ecd6a/src/glibc.zig?q=tls-model%20language%3AZig#L325">https://cs.github.com/ziglang/zig/blob/5c228765f1094d30e64d13c0077c67b2867ecd6a/src/glibc.zig?q=tls-model%20language%3AZig#L325</a> Patching this away may fix the issue for you.</p>
</blockquote>



<a name="267067323"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%233654%20Cranelift%3A%20timing%20module%20for%20%60cran.../near/267067323" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.233654.20Cranelift.3A.20timing.20module.20for.20.60cran.2E.2E.2E.html#267067323">(Jan 06 2022 at 14:37)</a>:</h4>
<p>bjorn3 edited a <a href="https://github.com/bytecodealliance/wasmtime/issues/3654#issuecomment-1006638940">comment</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/3654">issue #3654</a>:</p>
<blockquote>
<p>I see. Cranelift indeed uses a lot of tls space. Still it feels like this should be fixed in nodejs or napi and not in cranelift. Swc is compiled as dynamic library that is dlopened, so it should use dynamic tls and not static tls. Static tls is only allowed for the main executable and the dynamic libraries declared as dependencies of the main executable. The fact that it works at all in some cases is because glibc reserved another 1024 bytes just in case someone dlopens a dynamic library compiled with static tls instead of dynamic tls.</p>
<p>After I wrote the above text I did some digging and it seems like <code>zig cc</code> which is used by napi passes <code>-ftls-model=initial-exec</code>: <a href="https://cs.github.com/ziglang/zig/blob/5c228765f1094d30e64d13c0077c67b2867ecd6a/src/glibc.zig?q=tls-model%20language%3AZig#L325">https://cs.github.com/ziglang/zig/blob/5c228765f1094d30e64d13c0077c67b2867ecd6a/src/glibc.zig?q=tls-model%20language%3AZig#L325</a> Patching this away may fix the issue for you. Edit: or is that just for building a static copy of glibc itself?</p>
</blockquote>



<a name="267067522"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%233654%20Cranelift%3A%20timing%20module%20for%20%60cran.../near/267067522" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.233654.20Cranelift.3A.20timing.20module.20for.20.60cran.2E.2E.2E.html#267067522">(Jan 06 2022 at 14:39)</a>:</h4>
<p>kdy1 <a href="https://github.com/bytecodealliance/wasmtime/issues/3654#issuecomment-1006641686">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/3654">issue #3654</a>:</p>
<blockquote>
<p>How do you think about a cargo feature to strip out timing facilities?<br>
Actually, I don't need it at all.</p>
</blockquote>



<a name="267067901"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%233654%20Cranelift%3A%20timing%20module%20for%20%60cran.../near/267067901" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.233654.20Cranelift.3A.20timing.20module.20for.20.60cran.2E.2E.2E.html#267067901">(Jan 06 2022 at 14:42)</a>:</h4>
<p>bjorn3 <a href="https://github.com/bytecodealliance/wasmtime/issues/3654#issuecomment-1006644367">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/3654">issue #3654</a>:</p>
<blockquote>
<p>I personally think that is fine to add. I just think the tls problem should be solved at it's root to prevent anyone else from being caught by this or it regression again in the future due to some other crate or changes in the standard library or optimizations.</p>
</blockquote>



<hr><p>Last updated: Jan 20 2025 at 06:04 UTC</p>
</html>