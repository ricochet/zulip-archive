<html>
<head><meta charset="utf-8"><title>wasmtime / PR #4217 Refactor the ComponentValue impls for... · git-wasmtime · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/index.html">git-wasmtime</a></h2>
<h3>Topic: <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.234217.20Refactor.20the.20ComponentValue.20impls.20for.2E.2E.2E.html">wasmtime / PR #4217 Refactor the ComponentValue impls for...</a></h3>

<hr>

<base href="https://bytecodealliance.zulipchat.com">

<head><link href="https://bytecodealliance.github.io/zulip-archive/style.css" rel="stylesheet"></head>

<a name="284925253"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%234217%20Refactor%20the%20ComponentValue%20impls%20for.../near/284925253" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.234217.20Refactor.20the.20ComponentValue.20impls.20for.2E.2E.2E.html#284925253">(Jun 03 2022 at 19:49)</a>:</h4>
<p><strong>jameysharp</strong> requested <a href="https://github.com/alexcrichton">alexcrichton</a> for a review on <a href="https://github.com/bytecodealliance/wasmtime/pull/4217">PR #4217</a>.</p>



<a name="284925254"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%234217%20Refactor%20the%20ComponentValue%20impls%20for.../near/284925254" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.234217.20Refactor.20the.20ComponentValue.20impls.20for.2E.2E.2E.html#284925254">(Jun 03 2022 at 19:49)</a>:</h4>
<p>jameysharp opened <a href="https://github.com/bytecodealliance/wasmtime/pull/4217">PR #4217</a> from <code>component-tuple-refactor</code> to <code>main</code>:</p>
<blockquote>
<p>These helper functions are also useful for implementing this trait on user-defined record and tuple types.</p>
</blockquote>



<a name="284925568"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%234217%20Refactor%20the%20ComponentValue%20impls%20for.../near/284925568" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.234217.20Refactor.20the.20ComponentValue.20impls.20for.2E.2E.2E.html#284925568">(Jun 03 2022 at 19:53)</a>:</h4>
<p>jameysharp updated <a href="https://github.com/bytecodealliance/wasmtime/pull/4217">PR #4217</a> from <code>component-tuple-refactor</code> to <code>main</code>.</p>



<a name="284926199"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%234217%20Refactor%20the%20ComponentValue%20impls%20for.../near/284926199" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.234217.20Refactor.20the.20ComponentValue.20impls.20for.2E.2E.2E.html#284926199">(Jun 03 2022 at 19:59)</a>:</h4>
<p>alexcrichton submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/4217#pullrequestreview-995444122">PR review</a>.</p>



<a name="284926200"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%234217%20Refactor%20the%20ComponentValue%20impls%20for.../near/284926200" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.234217.20Refactor.20the.20ComponentValue.20impls.20for.2E.2E.2E.html#284926200">(Jun 03 2022 at 19:59)</a>:</h4>
<p>alexcrichton created <a href="https://github.com/bytecodealliance/wasmtime/pull/4217#discussion_r889299404">PR review comment</a>:</p>
<blockquote>
<p>I think this probably won't be reused externally because it specifically matches the <code>Tuple</code> type, right?</p>
</blockquote>



<a name="284926202"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%234217%20Refactor%20the%20ComponentValue%20impls%20for.../near/284926202" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.234217.20Refactor.20the.20ComponentValue.20impls.20for.2E.2E.2E.html#284926202">(Jun 03 2022 at 19:59)</a>:</h4>
<p>alexcrichton submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/4217#pullrequestreview-995444122">PR review</a>.</p>



<a name="284926625"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%234217%20Refactor%20the%20ComponentValue%20impls%20for.../near/284926625" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.234217.20Refactor.20the.20ComponentValue.20impls.20for.2E.2E.2E.html#284926625">(Jun 03 2022 at 20:03)</a>:</h4>
<p>jameysharp submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/4217#pullrequestreview-995450058">PR review</a>.</p>



<a name="284926626"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%234217%20Refactor%20the%20ComponentValue%20impls%20for.../near/284926626" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.234217.20Refactor.20the.20ComponentValue.20impls.20for.2E.2E.2E.html#284926626">(Jun 03 2022 at 20:03)</a>:</h4>
<p>jameysharp created <a href="https://github.com/bytecodealliance/wasmtime/pull/4217#discussion_r889303798">PR review comment</a>:</p>
<blockquote>
<p>I think the wasm tuple type is the right thing for tuple-like structs and enum variants, so I'm expecting to use it for those. Does that seem right?</p>
</blockquote>



<a name="284927377"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%234217%20Refactor%20the%20ComponentValue%20impls%20for.../near/284927377" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.234217.20Refactor.20the.20ComponentValue.20impls.20for.2E.2E.2E.html#284927377">(Jun 03 2022 at 20:11)</a>:</h4>
<p>alexcrichton submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/4217#pullrequestreview-995462171">PR review</a>.</p>



<a name="284927378"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%234217%20Refactor%20the%20ComponentValue%20impls%20for.../near/284927378" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.234217.20Refactor.20the.20ComponentValue.20impls.20for.2E.2E.2E.html#284927378">(Jun 03 2022 at 20:11)</a>:</h4>
<p>alexcrichton created <a href="https://github.com/bytecodealliance/wasmtime/pull/4217#discussion_r889311793">PR review comment</a>:</p>
<blockquote>
<p>In that you're mapping <code>struct Foo(u32, u32)</code> to <code>tuple&lt;u32, u32&gt;</code> in the component model? For that I'd probably just return an error on a struct looking like that since that's already exposed as tuples and there's not really much need to expose a different way to name tuples in Rust.</p>
<p>For enum variants are you supporting <code>enum Foo { A(u32, u32) }</code>? If so personally I'd prefer to reject that for now and stay strict in the derive to stay close to the component model representation if we can.</p>
<p>Depending how the whole ecosystem shakes out we can revisit in the future and add "sugar" if this sort of type structure ends up being common in wit</p>
</blockquote>



<a name="284928824"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%234217%20Refactor%20the%20ComponentValue%20impls%20for.../near/284928824" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.234217.20Refactor.20the.20ComponentValue.20impls.20for.2E.2E.2E.html#284928824">(Jun 03 2022 at 20:26)</a>:</h4>
<p>jameysharp created <a href="https://github.com/bytecodealliance/wasmtime/pull/4217#discussion_r889322976">PR review comment</a>:</p>
<blockquote>
<p>Huh, I see. Sure, I can do it that way.</p>
<p>I still want to factor this function out of the <code>impl_component_ty_for_tuples</code> macro, even if it isn't public. It's very similar to the typechecking function for unions, and with the addition of names, both of those resemble the typechecking functions for records, enums, and variants. I think it'll be helpful to keep them all next to each other.</p>
<p>I've verified that rustc generates the same code on x86-64 release builds after refactoring the impl for tuples this way. (It inlines the helper function and unrolls the iterator, so the recursive typechecking calls are all direct.) So it seems to me that the main consideration here is whether the refactoring is easier to understand, and for me, getting code out of macros helps a lot in my ability to understand it.</p>
</blockquote>



<a name="284928825"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%234217%20Refactor%20the%20ComponentValue%20impls%20for.../near/284928825" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.234217.20Refactor.20the.20ComponentValue.20impls.20for.2E.2E.2E.html#284928825">(Jun 03 2022 at 20:26)</a>:</h4>
<p>jameysharp submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/4217#pullrequestreview-995481580">PR review</a>.</p>



<a name="284931372"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%234217%20Refactor%20the%20ComponentValue%20impls%20for.../near/284931372" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.234217.20Refactor.20the.20ComponentValue.20impls.20for.2E.2E.2E.html#284931372">(Jun 03 2022 at 20:53)</a>:</h4>
<p>alexcrichton submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/4217#pullrequestreview-995515753">PR review</a>.</p>



<a name="284931373"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%234217%20Refactor%20the%20ComponentValue%20impls%20for.../near/284931373" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.234217.20Refactor.20the.20ComponentValue.20impls.20for.2E.2E.2E.html#284931373">(Jun 03 2022 at 20:53)</a>:</h4>
<p>alexcrichton created <a href="https://github.com/bytecodealliance/wasmtime/pull/4217#discussion_r889341503">PR review comment</a>:</p>
<blockquote>
<p>Ok that seems reasonable to me yeah. In general we don't have to worry too much about type-checking performance since that's typically front-loaded where possible off the critical path so it's ok to drop <code>#[inline]</code> on functions like this and otherwise just optimize it later if we really need to.</p>
</blockquote>



<a name="285008721"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%234217%20Refactor%20the%20ComponentValue%20impls%20for.../near/285008721" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.234217.20Refactor.20the.20ComponentValue.20impls.20for.2E.2E.2E.html#285008721">(Jun 05 2022 at 01:09)</a>:</h4>
<p>jameysharp updated <a href="https://github.com/bytecodealliance/wasmtime/pull/4217">PR #4217</a> from <code>component-tuple-refactor</code> to <code>main</code>.</p>



<a name="285008851"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%234217%20Refactor%20the%20ComponentValue%20impls%20for.../near/285008851" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.234217.20Refactor.20the.20ComponentValue.20impls.20for.2E.2E.2E.html#285008851">(Jun 05 2022 at 01:12)</a>:</h4>
<p>jameysharp submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/4217#pullrequestreview-995965594">PR review</a>.</p>



<a name="285008852"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%234217%20Refactor%20the%20ComponentValue%20impls%20for.../near/285008852" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.234217.20Refactor.20the.20ComponentValue.20impls.20for.2E.2E.2E.html#285008852">(Jun 05 2022 at 01:12)</a>:</h4>
<p>jameysharp created <a href="https://github.com/bytecodealliance/wasmtime/pull/4217#discussion_r889632660">PR review comment</a>:</p>
<blockquote>
<p>Okay, I fixed <code>typecheck_tuple</code> to not be <code>pub</code>. Thanks for your review! Anything else blocking this from merge?</p>
</blockquote>



<a name="285129576"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%234217%20Refactor%20the%20ComponentValue%20impls%20for.../near/285129576" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.234217.20Refactor.20the.20ComponentValue.20impls.20for.2E.2E.2E.html#285129576">(Jun 06 2022 at 15:44)</a>:</h4>
<p>jameysharp merged <a href="https://github.com/bytecodealliance/wasmtime/pull/4217">PR #4217</a>.</p>



<hr><p>Last updated: Jan 20 2025 at 06:04 UTC</p>
</html>