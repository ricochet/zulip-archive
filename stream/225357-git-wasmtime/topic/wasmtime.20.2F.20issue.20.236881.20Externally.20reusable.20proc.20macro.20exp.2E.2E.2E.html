<html>
<head><meta charset="utf-8"><title>wasmtime / issue #6881 Externally reusable proc macro exp... · git-wasmtime · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/index.html">git-wasmtime</a></h2>
<h3>Topic: <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.236881.20Externally.20reusable.20proc.20macro.20exp.2E.2E.2E.html">wasmtime / issue #6881 Externally reusable proc macro exp...</a></h3>

<hr>

<base href="https://bytecodealliance.zulipchat.com">

<head><link href="https://bytecodealliance.github.io/zulip-archive/style.css" rel="stylesheet"></head>

<a name="386595076"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%236881%20Externally%20reusable%20proc%20macro%20exp.../near/386595076" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.236881.20Externally.20reusable.20proc.20macro.20exp.2E.2E.2E.html#386595076">(Aug 22 2023 at 12:19)</a>:</h4>
<p>vados-cosmonic opened <a href="https://github.com/bytecodealliance/wasmtime/issues/6881">issue #6881</a>:</p>
<blockquote>
<h4>Feature</h4>
<p>I'd like to be able to reuse and modify the output of macros like <code>wit-bindgen::generate</code> and <code>wasmtime::component::bindgen</code></p>
<h4>Benefit</h4>
<p>Users will be able to build on the code generated by <code>*bindgen</code> crates.</p>
<p>This is a somewhat "backdoor" way of solving the following other issues:</p>
<p><a href="https://github.com/bytecodealliance/wit-bindgen/issues/554">https://github.com/bytecodealliance/wit-bindgen/issues/554</a><br>
<a href="https://github.com/WebAssembly/component-model/issues/58">https://github.com/WebAssembly/component-model/issues/58</a> (it probably does not make sense to make annotations, but language specific bindgen modification probably makes more sense)</p>
<h4>Implementation</h4>
<p>To make that happen, it should be possible to move top level (and possibly lower) macro functionality (i.e. <code>fn (input: InputStream) -&gt; proc_macro::InputStream</code>) to a separate crate that exports the transformations (and configuration/<code>Parse</code> impls necessary), and publish those separately, with a <em>re-export</em> under the original packages.</p>
<h4>Alternatives</h4>
<p>Alternatively, people can make partial copies of the current existing crates in order to use the functionality therein. </p>
<p>I've done this, and while it does work, it introduces an unnecessary partial vendoring of <code>wasmtime</code> in the downstream crate. Certainly a reasonable stop gap solution, but it would be much preferred if the import could boil down to mostly one dependency on a crate like <code>wit-bindgen-macros</code>/<code>wit-bindgen-macro-util</code>.<br>
</p>
</blockquote>



<a name="386595300"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%236881%20Externally%20reusable%20proc%20macro%20exp.../near/386595300" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.236881.20Externally.20reusable.20proc.20macro.20exp.2E.2E.2E.html#386595300">(Aug 22 2023 at 12:20)</a>:</h4>
<p>vados-cosmonic edited <a href="https://github.com/bytecodealliance/wasmtime/issues/6881">issue #6881</a>:</p>
<blockquote>
<h4>Feature</h4>
<p>I'd like to be able to reuse and modify the output of macros like <code>wit-bindgen::generate</code> and <code>wasmtime::component::bindgen</code></p>
<h4>Benefit</h4>
<p>Users will be able to build on the code generated by <code>*bindgen</code> crates.</p>
<p>This is a somewhat "backdoor" way of solving the following other issues:</p>
<p><a href="https://github.com/bytecodealliance/wit-bindgen/issues/554">https://github.com/bytecodealliance/wit-bindgen/issues/554</a><br>
<a href="https://github.com/WebAssembly/component-model/issues/58">https://github.com/WebAssembly/component-model/issues/58</a> (it probably does not make sense to make annotations, but language specific bindgen modification probably makes more sense)</p>
<h4>Implementation</h4>
<p>To make that happen, I'd like to move top level (and possibly lower) macro functionality (ex. functions with the signature <code>(input: proc_macro::InputStream) -&gt; proc_macro::InputStream</code>) to a separate crate(s) that exports the transformations (and configuration/<code>Parse</code> impls necessary), and publish those separately, with a <em>re-export</em> under the original packages.</p>
<h4>Alternatives</h4>
<p>Alternatively, people can make partial copies of the current existing crates in order to use the functionality therein. </p>
<p>I've done this, and while it does work, it introduces an unnecessary partial vendoring of <code>wasmtime</code> in the downstream crate. Certainly a reasonable stop gap solution, but it would be much preferred if the import could boil down to mostly one dependency on a crate like <code>wit-bindgen-macros</code>/<code>wit-bindgen-macro-util</code>.<br>
</p>
</blockquote>



<a name="386654677"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%236881%20Externally%20reusable%20proc%20macro%20exp.../near/386654677" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.236881.20Externally.20reusable.20proc.20macro.20exp.2E.2E.2E.html#386654677">(Aug 22 2023 at 16:54)</a>:</h4>
<p>kajacx <a href="https://github.com/bytecodealliance/wasmtime/issues/6881#issuecomment-1688580455">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/6881">issue #6881</a>:</p>
<blockquote>
<p>This would certainly be great. I am currently also using the workaround of manually copying the macro crate's code so that I can modify the outcoming <code>TokenStream</code>, for example <a href="https://github.com/kajacx/wasm-bridge/blob/master/crates/wasm-bridge-macros/src/lib.rs#L32">here</a>.</p>
<p>I have already created <a href="https://github.com/bytecodealliance/wasmtime/issues/6690">this issue</a> in the past, but was closed. I think @alexcrichton didn't understand what I wanted, so let me re-iterate:</p>
<p>All that we are asking for is that the <a href="https://docs.rs/wasmtime-component-macro/10.0.1/wasmtime_component_macro/"><code>wasmtime_component_macro</code></a> (and the wit-bindgen equivalent for the guest) is split into two: one that exports the macros as normal functions with <code>TokenStream -&gt; TokenStream</code> signatures, and a second crate that just re-exports those functions as proc macros.</p>
<p>That's all. I don't expect any support in terms of "stability" of the resulting code from the macro or anything like that.</p>
</blockquote>



<a name="386678876"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%236881%20Externally%20reusable%20proc%20macro%20exp.../near/386678876" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.236881.20Externally.20reusable.20proc.20macro.20exp.2E.2E.2E.html#386678876">(Aug 22 2023 at 19:24)</a>:</h4>
<p>alexcrichton <a href="https://github.com/bytecodealliance/wasmtime/issues/6881#issuecomment-1688795823">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/6881">issue #6881</a>:</p>
<blockquote>
<p>At least personally I don't have much more to add over what I <a href="https://github.com/bytecodealliance/wasmtime/issues/6690#issuecomment-1622664036">already mentioned</a>. I apologize if you felt misunderstood, but I feel like I understand what you're saying and asking for and what I'm trying to explain is why it may seem like a simple ask it's not as simple as it appears on the surface and I don't think is something we should take on maintaining.</p>
<p>The more "public surface area" of Wasmtime that folks use the more we inevitably get pushback when making changes or issues whenever changes are made. These aren't something we are really planning on maintaining beyond the interfaces that are intended.</p>
<p>My recommendation is still to either (a) copy and vendor the sources yourself to take on the maintenance burden yourselves or (b) work on integrating these features upstream here in Wasmtime.</p>
</blockquote>



<a name="386728730"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%236881%20Externally%20reusable%20proc%20macro%20exp.../near/386728730" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.236881.20Externally.20reusable.20proc.20macro.20exp.2E.2E.2E.html#386728730">(Aug 23 2023 at 01:47)</a>:</h4>
<p>vados-cosmonic <a href="https://github.com/bytecodealliance/wasmtime/issues/6881#issuecomment-1689140459">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/6881">issue #6881</a>:</p>
<blockquote>
<p>Hey @alexcrichton apologies I searched but somehow <em>didn't see</em> that other thread! I made this thread thinking I was late to making one at all in the official repo after asking on Zulip. </p>
<p>My apologies -- the workaround as noted is fine (as is trying to integrate the features in jiving with Wasmtime proper).</p>
</blockquote>



<a name="386728731"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%236881%20Externally%20reusable%20proc%20macro%20exp.../near/386728731" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.236881.20Externally.20reusable.20proc.20macro.20exp.2E.2E.2E.html#386728731">(Aug 23 2023 at 01:47)</a>:</h4>
<p>vados-cosmonic closed <a href="https://github.com/bytecodealliance/wasmtime/issues/6881">issue #6881</a>:</p>
<blockquote>
<h4>Feature</h4>
<p>I'd like to be able to reuse and modify the output of macros like <code>wit-bindgen::generate</code> and <code>wasmtime::component::bindgen</code></p>
<h4>Benefit</h4>
<p>Users will be able to build on the code generated by <code>*bindgen</code> crates.</p>
<p>This is a somewhat "backdoor" way of solving the following other issues:</p>
<p><a href="https://github.com/bytecodealliance/wit-bindgen/issues/554">https://github.com/bytecodealliance/wit-bindgen/issues/554</a><br>
<a href="https://github.com/WebAssembly/component-model/issues/58">https://github.com/WebAssembly/component-model/issues/58</a> (it probably does not make sense to make annotations, but language specific bindgen modification probably makes more sense)</p>
<h4>Implementation</h4>
<p>To make that happen, I'd like to move top level (and possibly lower) macro functionality (ex. functions with the signature <code>(input: proc_macro::InputStream) -&gt; proc_macro::InputStream</code>) to a separate crate(s) that exports the transformations (and configuration/<code>Parse</code> impls necessary), and publish those separately, with a <em>re-export</em> under the original packages.</p>
<h4>Alternatives</h4>
<p>Alternatively, people can make partial copies of the current existing crates in order to use the functionality therein. </p>
<p>I've done this, and while it does work, it introduces an unnecessary partial vendoring of <code>wasmtime</code> in the downstream crate. Certainly a reasonable stop gap solution, but it would be much preferred if the import could boil down to mostly one dependency on a crate like <code>wit-bindgen-macros</code>/<code>wit-bindgen-macro-util</code>.<br>
</p>
</blockquote>



<a name="386792704"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%236881%20Externally%20reusable%20proc%20macro%20exp.../near/386792704" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.236881.20Externally.20reusable.20proc.20macro.20exp.2E.2E.2E.html#386792704">(Aug 23 2023 at 08:42)</a>:</h4>
<p>kajacx <a href="https://github.com/bytecodealliance/wasmtime/issues/6881#issuecomment-1689537874">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/6881">issue #6881</a>:</p>
<blockquote>
<p>@alexcrichton <em>I understand what you're saying and asking for</em> ... <em>I don't think is something we should take on maintaining.</em> I am not asking you to maintain the output of the proc macro any more than you do already. Let me explain it this way:</p>
<p>Wasmtime version 12 released, so to update my code, I have to:</p>
<p>1) Find the proc macro repository on github<br>
2) Manually update the Cargo.toml dependencies, some of which are workspace dependencies, so this includes sifting through the code and finding the actual versions<br>
3) Manually copy the new source code<br>
4) Fix any problems that are created by using a new (and not necessarily compatible) version of the proc macro</p>
<p>Now let's compare this to how this would look like if the proc macro crates were split in two:</p>
<p>1) Update the version of the dependent proc macro crate to 12.something<br>
4) Fix any problems that are created by using a new (and not necessarily compatible) version of the proc macro</p>
<p>The point 4 is exactly the same, because it's exactly the same code. So how is the first approach better?</p>
<p>I do not understand what "maintaining" are you talking about, I am not asking you to maintain anything, just split the crate in two and do everything else the same way you are doing.</p>
</blockquote>



<a name="386940699"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%236881%20Externally%20reusable%20proc%20macro%20exp.../near/386940699" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.236881.20Externally.20reusable.20proc.20macro.20exp.2E.2E.2E.html#386940699">(Aug 23 2023 at 19:52)</a>:</h4>
<p>alexcrichton <a href="https://github.com/bytecodealliance/wasmtime/issues/6881#issuecomment-1690548322">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/6881">issue #6881</a>:</p>
<blockquote>
<p>To expand on this, I can say yes I understand what you're saying @kajacx and I additionally understand how that is appealing from your perspective. From your perspective I agree that it's less work for you and doesn't seem too add much maintenance on the project.</p>
<p>From Wasmtime's perspective, however, there's a few issues in my opinion:</p>
<ul>
<li>There's no reason for this split in the sense that if someone changes it there's no test that will fail or reason to keep it the way it is. This means that it can change at any time, and a request in the future to change it back to the way it was is, in my opinion, maintenance.</li>
<li>You may not be the only user of this feature. While you may be willing to update when Wasmtime changes others may be less willing and may open issues here asking for guidance in updating, request that changes be backed out, or something like that.</li>
<li>More generally even if users use a feature like this and update just fine there may be subtle runtime or other issues which aren't predicted since we, the maintainers of wasmtime, aren't necessarily going into this eyes open. This means that subtle issues may arise into our issue queue which we then debug and spend time on which end up bottoming out in code elsewhere we can't do much about.</li>
</ul>
<p>Personally I'd prefer to avoid these situations. I understand that the distinctions I'm making are subtle and somewhat hand-wavy as well. To be clear I'm just one maintainer here and there are many others, so if others are willing to help you carry through a change like this I'm happy to hand it off to them.</p>
</blockquote>



<hr><p>Last updated: Jan 20 2025 at 06:04 UTC</p>
</html>