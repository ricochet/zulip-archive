<html>
<head><meta charset="utf-8"><title>wasmtime / PR #6087 riscv64: Add `Zba` extension instruct... · git-wasmtime · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/index.html">git-wasmtime</a></h2>
<h3>Topic: <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.236087.20riscv64.3A.20Add.20.60Zba.60.20extension.20instruct.2E.2E.2E.html">wasmtime / PR #6087 riscv64: Add `Zba` extension instruct...</a></h3>

<hr>

<base href="https://bytecodealliance.zulipchat.com">

<head><link href="https://bytecodealliance.github.io/zulip-archive/style.css" rel="stylesheet"></head>

<a name="343654391"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%236087%20riscv64%3A%20Add%20%60Zba%60%20extension%20instruct.../near/343654391" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.236087.20riscv64.3A.20Add.20.60Zba.60.20extension.20instruct.2E.2E.2E.html#343654391">(Mar 22 2023 at 11:59)</a>:</h4>
<p>afonso360 opened <a href="https://github.com/bytecodealliance/wasmtime/pull/6087">PR #6087</a> from <code>riscv-zba</code> to <code>main</code>:</p>
<blockquote>
<p><span aria-label="wave" class="emoji emoji-1f44b" role="img" title="wave">:wave:</span> Hey,</p>
<p>This PR adds the instructions present in the <a href="https://five-embeddev.com/riscv-bitmanip/draft/bitmanip.html#zba">Zba extension</a> to the RISC-V 64 backend. The Zba extension contains instructions for address generation.</p>
<p>Here's a quick summary:<br>
| Mnemonic | Description |<br>
| ------------ | ------------ |<br>
| <code>add.uw rd, rs1, rs2</code> | <a href="https://five-embeddev.com/riscv-bitmanip/draft/bitmanip.html#insns-add_uw">Add unsigned word</a> |<br>
| <code>sh1add rd, rs1, rs2</code> | <a href="https://five-embeddev.com/riscv-bitmanip/draft/bitmanip.html#insns-sh1add">Shift left by 1 and add</a> |<br>
| <code>sh1add.uw rd, rs1, rs2</code> | <a href="https://five-embeddev.com/riscv-bitmanip/draft/bitmanip.html#insns-sh1add_uw">Shift unsigned word left by 1 and add</a> |<br>
| <code>sh2add rd, rs1, rs2</code> | <a href="https://five-embeddev.com/riscv-bitmanip/draft/bitmanip.html#insns-sh2add">Shift left by 2 and add</a> |<br>
| <code>sh2add.uw rd, rs1, rs2</code> | <a href="https://five-embeddev.com/riscv-bitmanip/draft/bitmanip.html#insns-sh2add_uw">Shift unsigned word left by 2 and add</a> |<br>
| <code>sh3add rd, rs1, rs2</code> | <a href="https://five-embeddev.com/riscv-bitmanip/draft/bitmanip.html#insns-sh3add">Shift left by 3 and add</a> |<br>
| <code>sh3add.uw rd, rs1, rs2</code> | <a href="https://five-embeddev.com/riscv-bitmanip/draft/bitmanip.html#insns-sh3add_uw">Shift unsigned word left by 3 and add</a> |<br>
| <code>slli.uw rd, rs1, imm</code> | <a href="https://five-embeddev.com/riscv-bitmanip/draft/bitmanip.html#insns-slli_uw">Shift-left unsigned word (Immediate)</a> |</p>
<p>Besides directly matching the above, we also add the <code>zext.w</code> mnemnoic which is essentially <code>add.uw rd, rs, zero</code>.</p>
<p>I've left this fuzzing overnight on a riscv64 machine and all seems ok so far.</p>
</blockquote>



<a name="343665799"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%236087%20riscv64%3A%20Add%20%60Zba%60%20extension%20instruct.../near/343665799" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.236087.20riscv64.3A.20Add.20.60Zba.60.20extension.20instruct.2E.2E.2E.html#343665799">(Mar 22 2023 at 12:46)</a>:</h4>
<p>afonso360 updated <a href="https://github.com/bytecodealliance/wasmtime/pull/6087">PR #6087</a> from <code>riscv-zba</code> to <code>main</code>.</p>



<a name="343795749"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%236087%20riscv64%3A%20Add%20%60Zba%60%20extension%20instruct.../near/343795749" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.236087.20riscv64.3A.20Add.20.60Zba.60.20extension.20instruct.2E.2E.2E.html#343795749">(Mar 22 2023 at 22:16)</a>:</h4>
<p>jameysharp submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/6087#pullrequestreview-1353082471">PR review</a>.</p>



<a name="343795750"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%236087%20riscv64%3A%20Add%20%60Zba%60%20extension%20instruct.../near/343795750" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.236087.20riscv64.3A.20Add.20.60Zba.60.20extension.20instruct.2E.2E.2E.html#343795750">(Mar 22 2023 at 22:16)</a>:</h4>
<p>jameysharp submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/6087#pullrequestreview-1353082471">PR review</a>.</p>



<a name="343795752"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%236087%20riscv64%3A%20Add%20%60Zba%60%20extension%20instruct.../near/343795752" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.236087.20riscv64.3A.20Add.20.60Zba.60.20extension.20instruct.2E.2E.2E.html#343795752">(Mar 22 2023 at 22:16)</a>:</h4>
<p>jameysharp created <a href="https://github.com/bytecodealliance/wasmtime/pull/6087#discussion_r1145414144">PR review comment</a>:</p>
<blockquote>
<p>A <code>uextend</code> can't have a result type of the same width as its operand, so <code>(ty_32_or_64 ty)</code> can be replaced with <code>$I64</code> in these rules.</p>
</blockquote>



<a name="343795753"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%236087%20riscv64%3A%20Add%20%60Zba%60%20extension%20instruct.../near/343795753" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.236087.20riscv64.3A.20Add.20.60Zba.60.20extension.20instruct.2E.2E.2E.html#343795753">(Mar 22 2023 at 22:16)</a>:</h4>
<p>jameysharp created <a href="https://github.com/bytecodealliance/wasmtime/pull/6087#discussion_r1145142029">PR review comment</a>:</p>
<blockquote>
<p>I believe this can be at priority 2 without overlapping with the <code>zext.h</code> rule above, since this rule only extends from I32 and that rule only extends from I16.</p>
<p>Then I think you can undo all the priority changes in the remaining <code>extend</code> rules below.</p>
<p>That said, I like the idea of putting both the I128 rules at the same priority, so it's clear that the only difference between them is the <code>ExtendOp</code>. (That may improve the ISLE compiler's output by making it clear that the other pattern matches can all be shared.) So I'd be in favor of still bumping the sign-extend-to-128 case up to priority 3.</p>
</blockquote>



<a name="343795754"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%236087%20riscv64%3A%20Add%20%60Zba%60%20extension%20instruct.../near/343795754" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.236087.20riscv64.3A.20Add.20.60Zba.60.20extension.20instruct.2E.2E.2E.html#343795754">(Mar 22 2023 at 22:16)</a>:</h4>
<p>jameysharp created <a href="https://github.com/bytecodealliance/wasmtime/pull/6087#discussion_r1145397578">PR review comment</a>:</p>
<blockquote>
<p>Nice catch, noticing that this rule could never fire because the <code>fits_in_64</code> case would always match first. I had extended the overlap checker to catch that sort of bug, but since it doesn't know how extractors like <code>fits_in_64</code> and <code>fits_in_32</code> are related, it couldn't find this particular issue.</p>
<p>That said, is there any benefit to treating 32-bit <code>iadd</code> differently than 64-bit <code>iadd</code>? The upper bits shouldn't matter on either input or output.</p>
<p>I see that <code>addw</code> sign-extends the 32-bit result to 64-bits, so using it would make sense in a rule matching <code>(has_type $I64 (sextend (has_type $I32 (iadd x y))))</code>.</p>
</blockquote>



<a name="343795755"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%236087%20riscv64%3A%20Add%20%60Zba%60%20extension%20instruct.../near/343795755" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.236087.20riscv64.3A.20Add.20.60Zba.60.20extension.20instruct.2E.2E.2E.html#343795755">(Mar 22 2023 at 22:16)</a>:</h4>
<p>jameysharp created <a href="https://github.com/bytecodealliance/wasmtime/pull/6087#discussion_r1145433635">PR review comment</a>:</p>
<blockquote>
<p>This is another case where you can replace <code>(fits_in_64 ty)</code> with <code>$I64</code>, because there are no other types which satisfy both that pattern and the constraints on <code>uextend</code> from <code>$I32</code>.</p>
<p>Possible future work: remove all uses of <code>maybe_uextend</code> from <code>ishl</code> lowering rules, and add egraph rules to remove any <code>uextend</code>/<code>sextend</code>/<code>ireduce</code> from the second operand to <code>ishl</code>/<code>ushr</code>/<code>sshr</code>. Since Cranelift's shifts all accept any integer type as the second operand, no matter what the controlling type is, and because shift amounts are always masked to at most 7 bits, it's always safe to remove both widening and narrowing conversions.</p>
</blockquote>



<a name="343795756"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%236087%20riscv64%3A%20Add%20%60Zba%60%20extension%20instruct.../near/343795756" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.236087.20riscv64.3A.20Add.20.60Zba.60.20extension.20instruct.2E.2E.2E.html#343795756">(Mar 22 2023 at 22:16)</a>:</h4>
<p>jameysharp created <a href="https://github.com/bytecodealliance/wasmtime/pull/6087#discussion_r1145420017">PR review comment</a>:</p>
<blockquote>
<p>ISLE will generate slightly better Rust if you use the infallible <code>u64_from_imm64</code> extractor instead of the fallible <code>uimm8</code> extractor. In both cases the patterns will match the same inputs, but with <code>uimm8</code> it'll test that the input is in the range 0..256 before checking against the specific constant values.</p>
</blockquote>



<a name="343795757"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%236087%20riscv64%3A%20Add%20%60Zba%60%20extension%20instruct.../near/343795757" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.236087.20riscv64.3A.20Add.20.60Zba.60.20extension.20instruct.2E.2E.2E.html#343795757">(Mar 22 2023 at 22:16)</a>:</h4>
<p>jameysharp created <a href="https://github.com/bytecodealliance/wasmtime/pull/6087#discussion_r1145430668">PR review comment</a>:</p>
<blockquote>
<p>I think that, like <code>add.uw</code>, the <code>shnadd.uw</code> instructions will only give the correct result if we're zero-extending from exactly <code>$I32</code> to exactly <code>$I64</code>.</p>
<p>I'd also request a VERY LOUD comment here <span aria-label="sweat smile" class="emoji emoji-1f605" role="img" title="sweat smile">:sweat_smile:</span> that these instructions can only implement <code>(ishl (uextend _) _)</code>, _not_ <code>(uextend (ishl _ _))</code>. Getting that wrong on x86 was basically the cause of our last CVE. I believe you've gotten them right here, if I read the instruction-set manual correctly, but I was worried for a moment.</p>
</blockquote>



<a name="343795758"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%236087%20riscv64%3A%20Add%20%60Zba%60%20extension%20instruct.../near/343795758" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.236087.20riscv64.3A.20Add.20.60Zba.60.20extension.20instruct.2E.2E.2E.html#343795758">(Mar 22 2023 at 22:16)</a>:</h4>
<p>jameysharp created <a href="https://github.com/bytecodealliance/wasmtime/pull/6087#discussion_r1145454112">PR review comment</a>:</p>
<blockquote>
<p>Let's add more runtests which are like <code>sh1add_uext</code> but with the <code>uextend</code> on the result of the <code>ishl</code> instead of on its first operand. These additional tests should verify that when <code>v1</code> has its most significant N bits set, those bits aren't added into the upper half of <code>v0</code>.</p>
</blockquote>



<a name="343795759"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%236087%20riscv64%3A%20Add%20%60Zba%60%20extension%20instruct.../near/343795759" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.236087.20riscv64.3A.20Add.20.60Zba.60.20extension.20instruct.2E.2E.2E.html#343795759">(Mar 22 2023 at 22:16)</a>:</h4>
<p>jameysharp created <a href="https://github.com/bytecodealliance/wasmtime/pull/6087#discussion_r1145458007">PR review comment</a>:</p>
<blockquote>
<p>What would you think of this replacement, and similarly in <code>sh3add_uext</code> doing the same but with 8 instead of 4? It's slightly easier for me to do the math in my head that way.</p>
<div class="codehilite" data-code-language="suggestion"><pre><span></span><code>; run: %sh2add_uext(4, 0xFFFFFFFF) == 0x400000000
</code></pre></div>
<p>I'm also thinking something like these tests would be good:</p>
<p><div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="p">;</span><span class="w"> </span><span class="n">run</span>: <span class="o">%</span><span class="n">sh1add_uext</span><span class="p">(</span><span class="mh">0x100000000</span><span class="p">,</span><span class="w"> </span><span class="mh">0x80000000</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mh">0x200000000</span>
<span class="p">;</span><span class="w"> </span><span class="n">run</span>: <span class="o">%</span><span class="n">sh2add_uext</span><span class="p">(</span><span class="mh">0x100000000</span><span class="p">,</span><span class="w"> </span><span class="mh">0x80000000</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mh">0x300000000</span>
<span class="p">;</span><span class="w"> </span><span class="n">run</span>: <span class="o">%</span><span class="n">sh3add_uext</span><span class="p">(</span><span class="mh">0x100000000</span><span class="p">,</span><span class="w"> </span><span class="mh">0x80000000</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mh">0x500000000</span>
</code></pre></div><br>
</p>
</blockquote>



<a name="343999162"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%236087%20riscv64%3A%20Add%20%60Zba%60%20extension%20instruct.../near/343999162" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.236087.20riscv64.3A.20Add.20.60Zba.60.20extension.20instruct.2E.2E.2E.html#343999162">(Mar 23 2023 at 14:36)</a>:</h4>
<p>afonso360 submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/6087#pullrequestreview-1354782369">PR review</a>.</p>



<a name="343999163"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%236087%20riscv64%3A%20Add%20%60Zba%60%20extension%20instruct.../near/343999163" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.236087.20riscv64.3A.20Add.20.60Zba.60.20extension.20instruct.2E.2E.2E.html#343999163">(Mar 23 2023 at 14:36)</a>:</h4>
<p>afonso360 created <a href="https://github.com/bytecodealliance/wasmtime/pull/6087#discussion_r1146298930">PR review comment</a>:</p>
<blockquote>
<blockquote>
<p>That said, is there any benefit to treating 32-bit iadd differently than 64-bit iadd? The upper bits shouldn't matter on either input or output.</p>
</blockquote>
<p>Not really other than perhaps it being a hint that we only care about the 32bits for whoever is reading the ASM? Not sure that warrants a different rule.</p>
<blockquote>
<p>I see that addw sign-extends the 32-bit result to 64-bits, so using it would make sense in a rule matching (has_type $I64 (sextend (has_type $I32 (iadd x y)))).</p>
</blockquote>
<p>Yeah that's a good suggestion, I'll add that!</p>
</blockquote>



<a name="343999707"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%236087%20riscv64%3A%20Add%20%60Zba%60%20extension%20instruct.../near/343999707" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.236087.20riscv64.3A.20Add.20.60Zba.60.20extension.20instruct.2E.2E.2E.html#343999707">(Mar 23 2023 at 14:38)</a>:</h4>
<p>afonso360 edited <a href="https://github.com/bytecodealliance/wasmtime/pull/6087#discussion_r1146298930">PR review comment</a>.</p>



<a name="344016829"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%236087%20riscv64%3A%20Add%20%60Zba%60%20extension%20instruct.../near/344016829" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.236087.20riscv64.3A.20Add.20.60Zba.60.20extension.20instruct.2E.2E.2E.html#344016829">(Mar 23 2023 at 15:32)</a>:</h4>
<p>afonso360 submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/6087#pullrequestreview-1354906593">PR review</a>.</p>



<a name="344016831"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%236087%20riscv64%3A%20Add%20%60Zba%60%20extension%20instruct.../near/344016831" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.236087.20riscv64.3A.20Add.20.60Zba.60.20extension.20instruct.2E.2E.2E.html#344016831">(Mar 23 2023 at 15:32)</a>:</h4>
<p>afonso360 created <a href="https://github.com/bytecodealliance/wasmtime/pull/6087#discussion_r1146381219">PR review comment</a>:</p>
<blockquote>
<p>That seems correct, and I think since we don't force <code>uextend</code> here to be i32, it's wrong for i8/i16.</p>
<p>I also double checked against LLVM, and they also <a href="https://godbolt.org/z/qbjj4ETsd">manually sign extend i16/i8 before using <code>shnadd</code></a>.</p>
</blockquote>



<a name="344018027"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%236087%20riscv64%3A%20Add%20%60Zba%60%20extension%20instruct.../near/344018027" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.236087.20riscv64.3A.20Add.20.60Zba.60.20extension.20instruct.2E.2E.2E.html#344018027">(Mar 23 2023 at 15:36)</a>:</h4>
<p>afonso360 submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/6087#pullrequestreview-1354915341">PR review</a>.</p>



<a name="344018031"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%236087%20riscv64%3A%20Add%20%60Zba%60%20extension%20instruct.../near/344018031" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.236087.20riscv64.3A.20Add.20.60Zba.60.20extension.20instruct.2E.2E.2E.html#344018031">(Mar 23 2023 at 15:36)</a>:</h4>
<p>afonso360 created <a href="https://github.com/bytecodealliance/wasmtime/pull/6087#discussion_r1146387053">PR review comment</a>:</p>
<blockquote>
<blockquote>
<p>This is another case where you can replace (fits_in_64 ty) with $I64, because there are no other types which satisfy both that pattern and the constraints on uextend from $I32.</p>
</blockquote>
<p><span aria-label="+1" class="emoji emoji-1f44d" role="img" title="+1">:+1:</span></p>
<blockquote>
<p>Possible future work: remove all uses of maybe_uextend from ishl lowering rules, and add egraph rules to remove any uextend/sextend/ireduce from the second operand to ishl/ushr/sshr. Since Cranelift's shifts all accept any integer type as the second operand, no matter what the controlling type is, and because shift amounts are always masked to at most 7 bits, it's always safe to remove both widening and narrowing conversions.</p>
</blockquote>
<p>That seems like a good idea!</p>
</blockquote>



<a name="344018666"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%236087%20riscv64%3A%20Add%20%60Zba%60%20extension%20instruct.../near/344018666" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.236087.20riscv64.3A.20Add.20.60Zba.60.20extension.20instruct.2E.2E.2E.html#344018666">(Mar 23 2023 at 15:38)</a>:</h4>
<p>jameysharp submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/6087#pullrequestreview-1354920001">PR review</a>.</p>



<a name="344018667"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%236087%20riscv64%3A%20Add%20%60Zba%60%20extension%20instruct.../near/344018667" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.236087.20riscv64.3A.20Add.20.60Zba.60.20extension.20instruct.2E.2E.2E.html#344018667">(Mar 23 2023 at 15:38)</a>:</h4>
<p>jameysharp created <a href="https://github.com/bytecodealliance/wasmtime/pull/6087#discussion_r1146390240">PR review comment</a>:</p>
<blockquote>
<p>I think that's showing zero-extend rather than sign-extend, but yeah, it looks like LLVM doesn't try to do anything special for this pattern for u8 or u16.</p>
</blockquote>



<a name="344068469"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%236087%20riscv64%3A%20Add%20%60Zba%60%20extension%20instruct.../near/344068469" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.236087.20riscv64.3A.20Add.20.60Zba.60.20extension.20instruct.2E.2E.2E.html#344068469">(Mar 23 2023 at 18:30)</a>:</h4>
<p>afonso360 updated <a href="https://github.com/bytecodealliance/wasmtime/pull/6087">PR #6087</a> from <code>riscv-zba</code> to <code>main</code>.</p>



<a name="344072452"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%236087%20riscv64%3A%20Add%20%60Zba%60%20extension%20instruct.../near/344072452" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.236087.20riscv64.3A.20Add.20.60Zba.60.20extension.20instruct.2E.2E.2E.html#344072452">(Mar 23 2023 at 18:47)</a>:</h4>
<p>jameysharp submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/6087#pullrequestreview-1355341278">PR review</a>.</p>



<a name="344072455"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%236087%20riscv64%3A%20Add%20%60Zba%60%20extension%20instruct.../near/344072455" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.236087.20riscv64.3A.20Add.20.60Zba.60.20extension.20instruct.2E.2E.2E.html#344072455">(Mar 23 2023 at 18:47)</a>:</h4>
<p>jameysharp submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/6087#pullrequestreview-1355341278">PR review</a>.</p>



<a name="344072457"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%236087%20riscv64%3A%20Add%20%60Zba%60%20extension%20instruct.../near/344072457" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.236087.20riscv64.3A.20Add.20.60Zba.60.20extension.20instruct.2E.2E.2E.html#344072457">(Mar 23 2023 at 18:47)</a>:</h4>
<p>jameysharp created <a href="https://github.com/bytecodealliance/wasmtime/pull/6087#discussion_r1146673715">PR review comment</a>:</p>
<blockquote>
<p>Let's just sneak a little space in here:</p>
<p><div class="codehilite" data-code-language="suggestion"><pre><span></span><code>(rule 3 (lower (has_type $I64 (ishl (uextend x @ (value_type $I32)) (maybe_uextend (imm12_from_value y)))))
</code></pre></div><br>
</p>
</blockquote>



<a name="344073856"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%236087%20riscv64%3A%20Add%20%60Zba%60%20extension%20instruct.../near/344073856" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.236087.20riscv64.3A.20Add.20.60Zba.60.20extension.20instruct.2E.2E.2E.html#344073856">(Mar 23 2023 at 18:52)</a>:</h4>
<p>afonso360 updated <a href="https://github.com/bytecodealliance/wasmtime/pull/6087">PR #6087</a> from <code>riscv-zba</code> to <code>main</code>.</p>



<a name="344078765"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%236087%20riscv64%3A%20Add%20%60Zba%60%20extension%20instruct.../near/344078765" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.236087.20riscv64.3A.20Add.20.60Zba.60.20extension.20instruct.2E.2E.2E.html#344078765">(Mar 23 2023 at 19:12)</a>:</h4>
<p>afonso360 updated <a href="https://github.com/bytecodealliance/wasmtime/pull/6087">PR #6087</a> from <code>riscv-zba</code> to <code>main</code>.</p>



<a name="344095874"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%236087%20riscv64%3A%20Add%20%60Zba%60%20extension%20instruct.../near/344095874" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.236087.20riscv64.3A.20Add.20.60Zba.60.20extension.20instruct.2E.2E.2E.html#344095874">(Mar 23 2023 at 20:36)</a>:</h4>
<p>afonso360 merged <a href="https://github.com/bytecodealliance/wasmtime/pull/6087">PR #6087</a>.</p>



<hr><p>Last updated: Jan 20 2025 at 06:04 UTC</p>
</html>