<html>
<head><meta charset="utf-8"><title>wasmtime / PR #9093 wasmtime: Check stack limits only on ... · git-wasmtime · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/index.html">git-wasmtime</a></h2>
<h3>Topic: <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.239093.20wasmtime.3A.20Check.20stack.20limits.20only.20on.20.2E.2E.2E.html">wasmtime / PR #9093 wasmtime: Check stack limits only on ...</a></h3>

<hr>

<base href="https://bytecodealliance.zulipchat.com">

<head><link href="https://bytecodealliance.github.io/zulip-archive/style.css" rel="stylesheet"></head>

<a name="457462042"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%239093%20wasmtime%3A%20Check%20stack%20limits%20only%20on%20.../near/457462042" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.239093.20wasmtime.3A.20Check.20stack.20limits.20only.20on.20.2E.2E.2E.html#457462042">(Aug 08 2024 at 19:40)</a>:</h4>
<p>jameysharp opened <a href="https://github.com/bytecodealliance/wasmtime/pull/9093">PR #9093</a> from <code>jameysharp:wasmtime-probe-stack</code> to <code>bytecodealliance:main</code>:</p>
<blockquote>
<p>Currently, we do an explicit check for stack overflow on entry to every WebAssembly function. But that costs some time, and is a significant performance hit for very short functions.</p>
<p>This commit instead switches Wasmtime to relying on guard pages at the end of the stack to catch stack overflow, so the MMU does this check for "free". This means we may allow deeper recursion in guest code than we did before.</p>
<p>To make this work, we need Wasmtime's signal handlers to recognize when a guest memory fault is in a stack guard page and report the appropriate stack-overflow trap code.</p>
<p>Note that we can't turn host-code signals into guest traps, so the signal handlers have to verify that the signal occurred in guest code.</p>
<p>When the guest calls host code (explicitly due to calling an imported host function, or implicitly due to a libcall inserted by Wasmtime or Cranelift), we also need to ensure that there is enough stack space available for the host code to not hit the guard pages. We do that by checking the stack limit that the embedder provided in the trampolines where we exit wasm.</p>
<hr>
<p>I've been laid off from Fastly so I won't be pursuing this further, but I feel good about the work I put into it so far and want to leave it here in case anyone else wants to pick it up.</p>
</blockquote>



<a name="488892789"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%239093%20wasmtime%3A%20Check%20stack%20limits%20only%20on%20.../near/488892789" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.239093.20wasmtime.3A.20Check.20stack.20limits.20only.20on.20.2E.2E.2E.html#488892789">(Dec 13 2024 at 17:53)</a>:</h4>
<p>sunfishcode updated <a href="https://github.com/bytecodealliance/wasmtime/pull/9093">PR #9093</a>.</p>



<a name="488916840"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%239093%20wasmtime%3A%20Check%20stack%20limits%20only%20on%20.../near/488916840" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.239093.20wasmtime.3A.20Check.20stack.20limits.20only.20on.20.2E.2E.2E.html#488916840">(Dec 13 2024 at 20:40)</a>:</h4>
<p>sunfishcode updated <a href="https://github.com/bytecodealliance/wasmtime/pull/9093">PR #9093</a>.</p>



<a name="488916892"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%239093%20wasmtime%3A%20Check%20stack%20limits%20only%20on%20.../near/488916892" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.239093.20wasmtime.3A.20Check.20stack.20limits.20only.20on.20.2E.2E.2E.html#488916892">(Dec 13 2024 at 20:40)</a>:</h4>
<p>sunfishcode <a href="https://github.com/bytecodealliance/wasmtime/pull/9093#issuecomment-2542298287">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/9093">PR #9093</a>:</p>
<blockquote>
<p>I've now rebased this and ported it to main. There some test failures at the moment.</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="n">thread</span><span class="w"> </span><span class="o">'</span><span class="na">stack_overflow</span><span class="p">::</span><span class="n">host_always_has_some_stack</span><span class="o">'</span><span class="w"> </span><span class="n">has</span><span class="w"> </span><span class="n">overflowed</span><span class="w"> </span><span class="n">its</span><span class="w"> </span><span class="n">stack</span>
<span class="n">fatal</span><span class="w"> </span><span class="n">runtime</span><span class="w"> </span><span class="n">error</span><span class="p">:</span><span class="w"> </span><span class="nc">stack</span><span class="w"> </span><span class="n">overflow</span>
</code></pre></div>
<p>which I'm looking into.<br>
</p>
</blockquote>



<a name="488925929"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%239093%20wasmtime%3A%20Check%20stack%20limits%20only%20on%20.../near/488925929" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.239093.20wasmtime.3A.20Check.20stack.20limits.20only.20on.20.2E.2E.2E.html#488925929">(Dec 13 2024 at 21:44)</a>:</h4>
<p>github-actions[bot] <a href="https://github.com/bytecodealliance/wasmtime/pull/9093#issuecomment-2542430775">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/9093">PR #9093</a>:</p>
<blockquote>
<h4>Subscribe to Label Action</h4>
<p>cc @fitzgen</p>
<p>&lt;details&gt;<br>
This issue or pull request has been labeled: "pulley", "wasmtime:api"</p>
<p>Thus the following users have been cc'd because of the following labels:</p>
<ul>
<li>fitzgen: pulley</li>
</ul>
<p>To subscribe or unsubscribe from this label, edit the &lt;code&gt;.github/subscribe-to-label.json&lt;/code&gt; configuration file.</p>
<p><a href="https://github.com/bytecodealliance/subscribe-to-label-action">Learn more.</a><br>
&lt;/details&gt;</p>
</blockquote>



<a name="489854016"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%239093%20wasmtime%3A%20Check%20stack%20limits%20only%20on%20.../near/489854016" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.239093.20wasmtime.3A.20Check.20stack.20limits.20only.20on.20.2E.2E.2E.html#489854016">(Dec 18 2024 at 22:43)</a>:</h4>
<p>sunfishcode <a href="https://github.com/bytecodealliance/wasmtime/pull/9093#issuecomment-2552410097">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/9093">PR #9093</a>:</p>
<blockquote>
<p>The stack overflow in the host appears to be because the stack limit checks are in the trampolines, however host libcalls don't use trampolines. The testcase disables sse4_1 and does <code>f32.ceil</code>, which causes it to get a host libcall, so it calls from guest to host without a trampoline, and therefore without checking the stack limit.<br>
</p>
</blockquote>



<a name="489856703"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%239093%20wasmtime%3A%20Check%20stack%20limits%20only%20on%20.../near/489856703" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.239093.20wasmtime.3A.20Check.20stack.20limits.20only.20on.20.2E.2E.2E.html#489856703">(Dec 18 2024 at 23:04)</a>:</h4>
<p>cfallin <a href="https://github.com/bytecodealliance/wasmtime/pull/9093#issuecomment-2552433650">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/9093">PR #9093</a>:</p>
<blockquote>
<p>I remember talking about the libcall problem at the time with @jameysharp but have only vague recollections of the various answers we came up with; but IIRC we did decide that recognizing the overflow by fault address in guard page was more reliable than trying to deduce fault reason from PC (because we don't know the first instruction that might touch the guard page in the &lt;1 page frame size case); I see this PR does that with some logic checking if the fault address is within a certain distance of SP; I remember us realizing that this might also (should also?) work for libcalls because natively compiled code is also compatible with a guard-page scheme. So I guess I'm curious: what's the reason that this condition isn't triggering in this case?</p>
<p>(Apologies if I've lost too much context -- it's been a long time and I skimmed this PR again but there are many subtleties!)</p>
</blockquote>



<a name="489857229"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%239093%20wasmtime%3A%20Check%20stack%20limits%20only%20on%20.../near/489857229" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.239093.20wasmtime.3A.20Check.20stack.20limits.20only.20on.20.2E.2E.2E.html#489857229">(Dec 18 2024 at 23:08)</a>:</h4>
<p>fitzgen <a href="https://github.com/bytecodealliance/wasmtime/pull/9093#issuecomment-2552437664">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/9093">PR #9093</a>:</p>
<blockquote>
<p>Also it seems like libcalls should probably do stack checks as well, since I would be hesitant to try and recover from runtime code hitting the guard page, so it might make sense to make the locals use trampolines like imports do.</p>
</blockquote>



<a name="489860104"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%239093%20wasmtime%3A%20Check%20stack%20limits%20only%20on%20.../near/489860104" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.239093.20wasmtime.3A.20Check.20stack.20limits.20only.20on.20.2E.2E.2E.html#489860104">(Dec 18 2024 at 23:34)</a>:</h4>
<p>alexcrichton <a href="https://github.com/bytecodealliance/wasmtime/pull/9093#issuecomment-2552464121">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/9093">PR #9093</a>:</p>
<blockquote>
<p>If it helps I've got an <a href="https://github.com/alexcrichton/wasmtime/commits/remove-stack-limit/">old wasmtime branch</a> which removed the stack limit checks from functions through generating trampolines for all libcalls. I never pushed that over the finish line though in terms of polish and testing</p>
</blockquote>



<a name="490025222"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%239093%20wasmtime%3A%20Check%20stack%20limits%20only%20on%20.../near/490025222" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.239093.20wasmtime.3A.20Check.20stack.20limits.20only.20on.20.2E.2E.2E.html#490025222">(Dec 19 2024 at 18:26)</a>:</h4>
<p>jameysharp <a href="https://github.com/bytecodealliance/wasmtime/pull/9093#issuecomment-2555508897">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/9093">PR #9093</a>:</p>
<blockquote>
<p>I've lost the context I had on this.</p>
<p>I believe Wasmtime libcalls work correctly in this PR, because they use Wasmtime's trampolines, which this PR makes do stack limit checks. It's only the Cranelift libcalls that still don't work.</p>
<p>There was some reason why we can only safely use the guard page if we see that the faulting instruction is in Cranelift-compiled code. I think because our only recourse in the signal handler is to fully unwind the stack, and we can't trigger Rust panic unwinding let alone any libc cleanup, so there's no telling what invariants are broken if we just rewind the stack in native code. But the specific way we use Cranelift is always safe to just drop everything at any time.</p>
<p>I remember at one point intending to add support to Cranelift for inserting a stack limit check immediately before any libcall, or insert it in the prologue like today but only if some libcalls appear somewhere in the function. I don't remember if that was the last plan I had in mind or if something had superceded it.</p>
<p>I definitely carefully considered Alex's old branch. I only found out about it after landing on the idea of checking the stack pointer in the signal handler, and it was reassuring to see we'd both landed in the same place there.</p>
<p>I was not comfortable with the specific mechanism in that branch for getting stack limit checks into Cranelift libcalls.</p>
<ul>
<li>The idea there was that Cranelift makes us supply the function for it to call, so let's supply a function that does a stack limit check.</li>
<li>But we need the vmctx to find the stack limit, and Cranelift doesn't pass that to libcalls. (I discussed changing that with Chris, IIRC; I think we decided not to.)</li>
<li>So Alex needed to look up the vmctx again, from thread-locals. Nobody wants to do that from Cranelift, so we need to call into Rust to do the thread-local lookup.</li>
<li>But we need to do a stack limit check before calling into Rust!</li>
<li>We can assume some upper bound on how much stack we'll need for the thread-local lookup. So Alex did something I think involving synthesizing a Cranelift function that would touch the stack some distance down; to hit the guard page and trigger the signal handler, maybe? And it was recursive for reasons I didn't understand, doing this four times or something. </li>
<li>If that function returns then it's safe to call the Rust function to get the vmctx, then do the stack limit check by hand, then call the real libcall. These steps can be represented in CLIF, so the signal handler protects this function too.</li>
</ul>
<p>End result was calling two extra Cranelift functions plus a Rust function before the real libcall could run, and that felt like a lot of trouble to me.</p>
<p>I hope this helps!</p>
</blockquote>



<a name="490078520"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%239093%20wasmtime%3A%20Check%20stack%20limits%20only%20on%20.../near/490078520" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.239093.20wasmtime.3A.20Check.20stack.20limits.20only.20on.20.2E.2E.2E.html#490078520">(Dec 20 2024 at 01:36)</a>:</h4>
<p>sunfishcode updated <a href="https://github.com/bytecodealliance/wasmtime/pull/9093">PR #9093</a>.</p>



<a name="490080404"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%239093%20wasmtime%3A%20Check%20stack%20limits%20only%20on%20.../near/490080404" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.239093.20wasmtime.3A.20Check.20stack.20limits.20only.20on.20.2E.2E.2E.html#490080404">(Dec 20 2024 at 01:57)</a>:</h4>
<p>sunfishcode <a href="https://github.com/bytecodealliance/wasmtime/pull/9093#issuecomment-2556108034">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/9093">PR #9093</a>:</p>
<blockquote>
<p>@jameysharp Thanks, that's useful context!</p>
<p>@alexcrichton Thanks for that branch. It's worth considering that approach, however if possible, I'd like to try taking an approach where we just pass vmctx to the libcalls and use trampolines, so that they work the same as other Wasmtime builtins, rather than having the libcall code do special things.</p>
<p>I've now added patches to experiment with making the calls to ceil/floor/etc. work like normal Wasmtime builtins, meaning they get a vmctx and a trampoline in the normal way. This involves handling them in the Wasm-to-Cranelift translator, which is a little annoying, but has the nice side effect of eliminating a whole separate relocation mechanism from Wasmtime, so I think it's an overall simplification. See the changes in crates/cranelift/src/translate/code_translator.rs for the place where this hooks in.</p>
<p>There's a test failure in <a href="http://host_sefault.rs">host_sefault.rs</a>. The test attempts to trigger a crash by deliberately misconfiguring the host, and with this patch, we interpret the crash as a Wasm trap, which causes the test to fail. I need to investigate more.</p>
<p>There are lots of Pulley failures still. I haven't yet looked at how all this interacts with Pulley.</p>
<p>And the patch is a bit rough still. I need to tidy up all the loose ends around x86_pshufb and <code>__m128i</code> and things, and some bits of unnecessary relocation code left behind, and probably other things too.</p>
</blockquote>



<a name="490196929"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%239093%20wasmtime%3A%20Check%20stack%20limits%20only%20on%20.../near/490196929" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.239093.20wasmtime.3A.20Check.20stack.20limits.20only.20on.20.2E.2E.2E.html#490196929">(Dec 20 2024 at 16:46)</a>:</h4>
<p>alexcrichton <a href="https://github.com/bytecodealliance/wasmtime/pull/9093#issuecomment-2557368799">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/9093">PR #9093</a>:</p>
<blockquote>
<blockquote>
<p>This involves handling them in the Wasm-to-Cranelift translator, which is a little annoying, but has the nice side effect of eliminating a whole separate relocation mechanism from Wasmtime, so I think it's an overall simplification</p>
</blockquote>
<p>Oh I really like that strategy, much better than the hack I had <span aria-label="+1" class="emoji emoji-1f44d" role="img" title="+1">:+1:</span> </p>
<blockquote>
<p>There are lots of Pulley failures still. I haven't yet looked at how all this interacts with Pulley.</p>
</blockquote>
<p>Feel free to ignore any pulley failures where possible, but if that's causing issues I can help take a deeper look too!</p>
</blockquote>



<a name="490241318"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%239093%20wasmtime%3A%20Check%20stack%20limits%20only%20on%20.../near/490241318" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.239093.20wasmtime.3A.20Check.20stack.20limits.20only.20on.20.2E.2E.2E.html#490241318">(Dec 20 2024 at 22:48)</a>:</h4>
<p>sunfishcode updated <a href="https://github.com/bytecodealliance/wasmtime/pull/9093">PR #9093</a>.</p>



<a name="490242314"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%239093%20wasmtime%3A%20Check%20stack%20limits%20only%20on%20.../near/490242314" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.239093.20wasmtime.3A.20Check.20stack.20limits.20only.20on.20.2E.2E.2E.html#490242314">(Dec 20 2024 at 22:59)</a>:</h4>
<p>sunfishcode updated <a href="https://github.com/bytecodealliance/wasmtime/pull/9093">PR #9093</a>.</p>



<a name="490245506"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%239093%20wasmtime%3A%20Check%20stack%20limits%20only%20on%20.../near/490245506" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.239093.20wasmtime.3A.20Check.20stack.20limits.20only.20on.20.2E.2E.2E.html#490245506">(Dec 20 2024 at 23:37)</a>:</h4>
<p>sunfishcode updated <a href="https://github.com/bytecodealliance/wasmtime/pull/9093">PR #9093</a>.</p>



<a name="490251792"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%239093%20wasmtime%3A%20Check%20stack%20limits%20only%20on%20.../near/490251792" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.239093.20wasmtime.3A.20Check.20stack.20limits.20only.20on.20.2E.2E.2E.html#490251792">(Dec 21 2024 at 01:00)</a>:</h4>
<p>sunfishcode <a href="https://github.com/bytecodealliance/wasmtime/pull/9093#issuecomment-2557927829">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/9093">PR #9093</a>:</p>
<blockquote>
<p>The patch is now tidied up more. I still need to fix the <a href="http://host_segfault.rs">host_segfault.rs</a> test, and there's a todo to figure out the stack pointer on s390x, but I think it's otherwise in pretty good shape.</p>
<p>@alexcrichton The CI shows a lot of pulley failures; any help you could provide with those would be appreciated!</p>
</blockquote>



<a name="492128711"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%239093%20wasmtime%3A%20Check%20stack%20limits%20only%20on%20.../near/492128711" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.239093.20wasmtime.3A.20Check.20stack.20limits.20only.20on.20.2E.2E.2E.html#492128711">(Jan 06 2025 at 15:42)</a>:</h4>
<p>alexcrichton <a href="https://github.com/bytecodealliance/wasmtime/pull/9093#issuecomment-2573373759">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/9093">PR #9093</a>:</p>
<blockquote>
<p>Ah I think what's happening there is that the pulley stack is different from the native stack so the limit recorded when we enter wasm isn't actually the limit that needs to be checked by wasm itself. I think an easy fix though would be to skip stack limit checks on Pulley entirely since that already has to check all decrements manually anyway. (basically just generate different CLIF for pulley targets)</p>
</blockquote>



<a name="494044615"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%239093%20wasmtime%3A%20Check%20stack%20limits%20only%20on%20.../near/494044615" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.239093.20wasmtime.3A.20Check.20stack.20limits.20only.20on.20.2E.2E.2E.html#494044615">(Jan 16 2025 at 00:57)</a>:</h4>
<p>sunfishcode updated <a href="https://github.com/bytecodealliance/wasmtime/pull/9093">PR #9093</a>.</p>



<a name="494255643"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%239093%20wasmtime%3A%20Check%20stack%20limits%20only%20on%20.../near/494255643" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.239093.20wasmtime.3A.20Check.20stack.20limits.20only.20on.20.2E.2E.2E.html#494255643">(Jan 17 2025 at 00:04)</a>:</h4>
<p>sunfishcode updated <a href="https://github.com/bytecodealliance/wasmtime/pull/9093">PR #9093</a>.</p>



<a name="494258384"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%239093%20wasmtime%3A%20Check%20stack%20limits%20only%20on%20.../near/494258384" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.239093.20wasmtime.3A.20Check.20stack.20limits.20only.20on.20.2E.2E.2E.html#494258384">(Jan 17 2025 at 00:31)</a>:</h4>
<p><strong>sunfishcode</strong> has marked <a href="https://github.com/bytecodealliance/wasmtime/pull/9093">PR #9093</a> as ready for review.</p>



<a name="494258386"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%239093%20wasmtime%3A%20Check%20stack%20limits%20only%20on%20.../near/494258386" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.239093.20wasmtime.3A.20Check.20stack.20limits.20only.20on.20.2E.2E.2E.html#494258386">(Jan 17 2025 at 00:31)</a>:</h4>
<p><strong>sunfishcode</strong> requested <a href="https://github.com/cfallin">cfallin</a> for a review on <a href="https://github.com/bytecodealliance/wasmtime/pull/9093">PR #9093</a>.</p>



<a name="494258387"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%239093%20wasmtime%3A%20Check%20stack%20limits%20only%20on%20.../near/494258387" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.239093.20wasmtime.3A.20Check.20stack.20limits.20only.20on.20.2E.2E.2E.html#494258387">(Jan 17 2025 at 00:31)</a>:</h4>
<p><strong>sunfishcode</strong> requested <a href="https://github.com/orgs/bytecodealliance/teams/wasmtime-compiler-reviewers">wasmtime-compiler-reviewers</a> for a review on <a href="https://github.com/bytecodealliance/wasmtime/pull/9093">PR #9093</a>.</p>



<a name="494258388"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%239093%20wasmtime%3A%20Check%20stack%20limits%20only%20on%20.../near/494258388" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.239093.20wasmtime.3A.20Check.20stack.20limits.20only.20on.20.2E.2E.2E.html#494258388">(Jan 17 2025 at 00:31)</a>:</h4>
<p><strong>sunfishcode</strong> requested <a href="https://github.com/alexcrichton">alexcrichton</a> for a review on <a href="https://github.com/bytecodealliance/wasmtime/pull/9093">PR #9093</a>.</p>



<a name="494258389"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%239093%20wasmtime%3A%20Check%20stack%20limits%20only%20on%20.../near/494258389" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.239093.20wasmtime.3A.20Check.20stack.20limits.20only.20on.20.2E.2E.2E.html#494258389">(Jan 17 2025 at 00:31)</a>:</h4>
<p><strong>sunfishcode</strong> requested <a href="https://github.com/orgs/bytecodealliance/teams/wasmtime-core-reviewers">wasmtime-core-reviewers</a> for a review on <a href="https://github.com/bytecodealliance/wasmtime/pull/9093">PR #9093</a>.</p>



<a name="494258390"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%239093%20wasmtime%3A%20Check%20stack%20limits%20only%20on%20.../near/494258390" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.239093.20wasmtime.3A.20Check.20stack.20limits.20only.20on.20.2E.2E.2E.html#494258390">(Jan 17 2025 at 00:31)</a>:</h4>
<p><strong>sunfishcode</strong> requested <a href="https://github.com/orgs/bytecodealliance/teams/wasmtime-default-reviewers">wasmtime-default-reviewers</a> for a review on <a href="https://github.com/bytecodealliance/wasmtime/pull/9093">PR #9093</a>.</p>



<a name="494259192"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%239093%20wasmtime%3A%20Check%20stack%20limits%20only%20on%20.../near/494259192" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.239093.20wasmtime.3A.20Check.20stack.20limits.20only.20on.20.2E.2E.2E.html#494259192">(Jan 17 2025 at 00:39)</a>:</h4>
<p>sunfishcode <a href="https://github.com/bytecodealliance/wasmtime/pull/9093#issuecomment-2597193109">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/9093">PR #9093</a>:</p>
<blockquote>
<p>I've now figured got all the pulley interactions untangled, and fixed the <a href="http://host_segfault.rs">host_segfault.rs</a> test in a defensible way, and that fixes all the remaining test failures, and I believe this is now ready for review.</p>
<p>As a recap of what's here:</p>
<ul>
<li>
<p>This PR eliminates all Cranelift-generated builtins from Wasmtime, and deletes the associated relocation handling. For things like floor/ceil/etc. without sse4 and vector swizzles on x86 without pshufb, Wasmtime inserts libcalls in the Wasm-to-cranelift translator instead, so that they work like all other libcalls in Wasmtime. That's a nice simplification, and it helps this PR by ensuring that all libcalls go through the same trampoline mechanism, which can ensure that we handle stack overflow for them consistently.</p>
</li>
<li>
<p>This PR switches Wasmtime to rely on the stack guard pages for catching most stack overflows, when signal-handling is available, and in this mode it only does explicit checks on exits from Wasm code, such as trampoline calls into host functions. This reduces the overhead of entering Wasm because we no longer need explicit stack overflow checks on entrypoints.<br>
</p>
</li>
</ul>
</blockquote>



<a name="494386418"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%239093%20wasmtime%3A%20Check%20stack%20limits%20only%20on%20.../near/494386418" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.239093.20wasmtime.3A.20Check.20stack.20limits.20only.20on.20.2E.2E.2E.html#494386418">(Jan 17 2025 at 15:36)</a>:</h4>
<p>alexcrichton updated <a href="https://github.com/bytecodealliance/wasmtime/pull/9093">PR #9093</a>.</p>



<a name="494392372"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%239093%20wasmtime%3A%20Check%20stack%20limits%20only%20on%20.../near/494392372" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.239093.20wasmtime.3A.20Check.20stack.20limits.20only.20on.20.2E.2E.2E.html#494392372">(Jan 17 2025 at 16:06)</a>:</h4>
<p>alexcrichton submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/9093#pullrequestreview-2559327860">PR review</a>:</p>
<blockquote>
<p>Thanks again for continuing to push on this! I've left a number of comments below, although nothing too major. I've additionally pushed a commit with <code>prtest:full</code> (feel free to remove that and push your own) to run the full test suite before getting to the merge queue.</p>
<p>Some high-level questions though:</p>
<ul>
<li>I may have missed it during this review, but IIRC we currently have inline stack probes turned off and this PR will require us to turn them back on, right?</li>
<li>Could you review the stack overflow tests we currently have and ensure they're testing all the various bits necessary to stress this new scheme?</li>
</ul>
<p>For testing and example is that the <a href="https://github.com/bytecodealliance/wasmtime/blob/6ac02e1092af3ed5dd57c9af30133b1d2b9d28f1/tests/all/stack_overflow.rs#L8">existing tests</a> don't stress this PR. At each level of recursion they call out to the host meaning that we'll never get close to the guard page. IIRC I rewrote that test at some point to instead perform N recursive calls and then call the host, after which the test would do a bit of a search to figure out what N causes stack overflow and it would test N-10..N to ensure that stack overflow wouldn't happen (or something like that). I never felt happy enough with the test coverage to land something, but regardless I feel that our current testing of stack overflow is insufficient to land this since I think that test doesn't ever hit the guard page.</p>
</blockquote>



<a name="494392379"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%239093%20wasmtime%3A%20Check%20stack%20limits%20only%20on%20.../near/494392379" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.239093.20wasmtime.3A.20Check.20stack.20limits.20only.20on.20.2E.2E.2E.html#494392379">(Jan 17 2025 at 16:06)</a>:</h4>
<p>alexcrichton created <a href="https://github.com/bytecodealliance/wasmtime/pull/9093#discussion_r1920378620">PR review comment</a>:</p>
<blockquote>
<p>Could you add some comments as to why stack overflow traps are ignored here?</p>
</blockquote>



<a name="494392381"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%239093%20wasmtime%3A%20Check%20stack%20limits%20only%20on%20.../near/494392381" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.239093.20wasmtime.3A.20Check.20stack.20limits.20only.20on.20.2E.2E.2E.html#494392381">(Jan 17 2025 at 16:06)</a>:</h4>
<p>alexcrichton created <a href="https://github.com/bytecodealliance/wasmtime/pull/9093#discussion_r1920376847">PR review comment</a>:</p>
<blockquote>
<p>If you're up for it, and it's ok to defer this to later, our stack overflow story is complicated enough it might be worth having a dedicated page in <code>docs/*.md</code> to talk about. Just for internal documentation, not necessarily user facting, but I feel like we've got a lot of scattered bits about stack overflow in various places as our strategy has evolved over time. For example the "The Wasm spec..." bit here is duplicated with <code>save_last_wasm_exit_fp_and_pc</code> below and neither gives a complete picture of how stack overflow is handled. In reality to understand how stack overflow works it requires understanding lots of locations, which is where I think a <code>docs/*.md</code> would be good that every place could point back to.</p>
<p>I realize though that reorganizing docs is mostly orthogonal to this PR, so I think it's ok to defer this to later if you'd prefer to not tackle this now.</p>
</blockquote>



<a name="494392382"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%239093%20wasmtime%3A%20Check%20stack%20limits%20only%20on%20.../near/494392382" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.239093.20wasmtime.3A.20Check.20stack.20limits.20only.20on.20.2E.2E.2E.html#494392382">(Jan 17 2025 at 16:06)</a>:</h4>
<p>alexcrichton created <a href="https://github.com/bytecodealliance/wasmtime/pull/9093#discussion_r1920382637">PR review comment</a>:</p>
<blockquote>
<p>How does this end up working? I would have thought that <code>i8x16</code> being empty or <code>__m128i</code> are both incompatible with Pulley's <code>[i8; 16]</code> definition...</p>
</blockquote>



<a name="494392386"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%239093%20wasmtime%3A%20Check%20stack%20limits%20only%20on%20.../near/494392386" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.239093.20wasmtime.3A.20Check.20stack.20limits.20only.20on.20.2E.2E.2E.html#494392386">(Jan 17 2025 at 16:06)</a>:</h4>
<p>alexcrichton created <a href="https://github.com/bytecodealliance/wasmtime/pull/9093#discussion_r1920390467">PR review comment</a>:</p>
<blockquote>
<p>This'll want to be removed because the sp for Pulley is tracked in <code>x_regs</code>. In generally ideally this PR wouldn't have any changes to Pulley here </p>
</blockquote>



<a name="494392388"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%239093%20wasmtime%3A%20Check%20stack%20limits%20only%20on%20.../near/494392388" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.239093.20wasmtime.3A.20Check.20stack.20limits.20only.20on.20.2E.2E.2E.html#494392388">(Jan 17 2025 at 16:06)</a>:</h4>
<p>alexcrichton created <a href="https://github.com/bytecodealliance/wasmtime/pull/9093#discussion_r1920380241">PR review comment</a>:</p>
<blockquote>
<p>Would it be possible to drop this type definition entirely? Ideally we do want this to be <code>__m128i</code> on x86 because that is guaranteed to be an xmm register in the ABI. I think this might be possible by putting <code>#[cfg(target_arch = "x86_64")]</code> on the definitions of the intrinsics themselves? (IIRC the macro already supports feature-gated intrinsics so I think it should support platform-specific intrinsics as well)</p>
</blockquote>



<a name="494392389"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%239093%20wasmtime%3A%20Check%20stack%20limits%20only%20on%20.../near/494392389" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.239093.20wasmtime.3A.20Check.20stack.20limits.20only.20on.20.2E.2E.2E.html#494392389">(Jan 17 2025 at 16:06)</a>:</h4>
<p>alexcrichton created <a href="https://github.com/bytecodealliance/wasmtime/pull/9093#discussion_r1920385019">PR review comment</a>:</p>
<blockquote>
<p>Oh I see the pulley changes down below...</p>
<p>Could this <code>call</code> macro be updated on Pulley to just skip the shuffle/swizzle intrinsics entirely? That way it'd fall into a panic at the bottom of this function. That would also avoid the need to update pulley with methods that can't be supported and are just fixing the build for these bits too</p>
</blockquote>



<a name="494392391"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%239093%20wasmtime%3A%20Check%20stack%20limits%20only%20on%20.../near/494392391" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.239093.20wasmtime.3A.20Check.20stack.20limits.20only.20on.20.2E.2E.2E.html#494392391">(Jan 17 2025 at 16:06)</a>:</h4>
<p>alexcrichton created <a href="https://github.com/bytecodealliance/wasmtime/pull/9093#discussion_r1920389507">PR review comment</a>:</p>
<blockquote>
<p>This'll definitely want some comments as to what's going on here. For example why the <code>-128</code> and why the <code>+4096</code>? (e.g. why 128, why 4096 instead of <code>page_size</code>, etc)</p>
</blockquote>



<a name="494392394"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%239093%20wasmtime%3A%20Check%20stack%20limits%20only%20on%20.../near/494392394" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.239093.20wasmtime.3A.20Check.20stack.20limits.20only.20on.20.2E.2E.2E.html#494392394">(Jan 17 2025 at 16:06)</a>:</h4>
<p>alexcrichton created <a href="https://github.com/bytecodealliance/wasmtime/pull/9093#discussion_r1920402348">PR review comment</a>:</p>
<blockquote>
<p>Could this be split out into a new expectation of "WasmStackOverflow" which requires that the <code>STACK_OVERFLOW_CODE</code> is exited with? I'd ideally prefer to be as strict as possible when matching on this.</p>
</blockquote>



<a name="494392398"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%239093%20wasmtime%3A%20Check%20stack%20limits%20only%20on%20.../near/494392398" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.239093.20wasmtime.3A.20Check.20stack.20limits.20only.20on.20.2E.2E.2E.html#494392398">(Jan 17 2025 at 16:06)</a>:</h4>
<p>alexcrichton created <a href="https://github.com/bytecodealliance/wasmtime/pull/9093#discussion_r1920388098">PR review comment</a>:</p>
<blockquote>
<p>I suspect this won't be able to get past CI, so I pushed a commit to this PR with <code>prtest:full</code> to run the full test suite to help catch this earlier</p>
</blockquote>



<a name="494392399"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%239093%20wasmtime%3A%20Check%20stack%20limits%20only%20on%20.../near/494392399" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.239093.20wasmtime.3A.20Check.20stack.20limits.20only.20on.20.2E.2E.2E.html#494392399">(Jan 17 2025 at 16:06)</a>:</h4>
<p>alexcrichton created <a href="https://github.com/bytecodealliance/wasmtime/pull/9093#discussion_r1920373897">PR review comment</a>:</p>
<blockquote>
<p>Could the <code>is_pulley</code> check get lifted to the outer conditional to avoid two levels of nesting?</p>
</blockquote>



<a name="494392400"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%239093%20wasmtime%3A%20Check%20stack%20limits%20only%20on%20.../near/494392400" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.239093.20wasmtime.3A.20Check.20stack.20limits.20only.20on.20.2E.2E.2E.html#494392400">(Jan 17 2025 at 16:06)</a>:</h4>
<p>alexcrichton created <a href="https://github.com/bytecodealliance/wasmtime/pull/9093#discussion_r1920385850">PR review comment</a>:</p>
<blockquote>
<p>For this my hope is that with a <code>#[cfg]</code> on the intrinsic definition we could avoid needing to define this entirely</p>
</blockquote>



<hr><p>Last updated: Jan 20 2025 at 06:04 UTC</p>
</html>