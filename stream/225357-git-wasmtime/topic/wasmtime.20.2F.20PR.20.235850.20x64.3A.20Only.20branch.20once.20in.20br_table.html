<html>
<head><meta charset="utf-8"><title>wasmtime / PR #5850 x64: Only branch once in br_table · git-wasmtime · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/index.html">git-wasmtime</a></h2>
<h3>Topic: <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.235850.20x64.3A.20Only.20branch.20once.20in.20br_table.html">wasmtime / PR #5850 x64: Only branch once in br_table</a></h3>

<hr>

<base href="https://bytecodealliance.zulipchat.com">

<head><link href="https://bytecodealliance.github.io/zulip-archive/style.css" rel="stylesheet"></head>

<a name="329330752"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%235850%20x64%3A%20Only%20branch%20once%20in%20br_table/near/329330752" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.235850.20x64.3A.20Only.20branch.20once.20in.20br_table.html#329330752">(Feb 22 2023 at 02:34)</a>:</h4>
<p>jameysharp opened <a href="https://github.com/bytecodealliance/wasmtime/pull/5850">PR #5850</a> from <code>branch-once</code> to <code>main</code>:</p>
<blockquote>
<p>This uses the <code>cmov</code> that was necessary anyway for Spectre mitigation to clamp the table index, instead of zeroing it. By then placing the default target as the last entry in the table, we can use just one branch instruction in all cases.</p>
<p>This is a net savings of two bytes in the encoding of x64's br_table pseudoinstruction.</p>
<p>I haven't done any benchmarking yet. I'm guessing either this will be faster because it doesn't branch as often, or it will be slower because it executes more instructions in the common case where the bounds check succeeds.</p>
<p>I also haven't updated the comments in the implementation because first I wanted to see if this works at all (it passes the test suite!) and whether folks have strong arguments for or against this change.</p>
<p>It's just a random idea I had and thought I'd try out.</p>
</blockquote>



<a name="329330753"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%235850%20x64%3A%20Only%20branch%20once%20in%20br_table/near/329330753" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.235850.20x64.3A.20Only.20branch.20once.20in.20br_table.html#329330753">(Feb 22 2023 at 02:34)</a>:</h4>
<p><strong>jameysharp</strong> requested <a href="https://github.com/cfallin">cfallin</a> for a review on <a href="https://github.com/bytecodealliance/wasmtime/pull/5850">PR #5850</a>.</p>



<a name="329604352"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%235850%20x64%3A%20Only%20branch%20once%20in%20br_table/near/329604352" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.235850.20x64.3A.20Only.20branch.20once.20in.20br_table.html#329604352">(Feb 22 2023 at 23:23)</a>:</h4>
<p>jameysharp updated <a href="https://github.com/bytecodealliance/wasmtime/pull/5850">PR #5850</a> from <code>branch-once</code> to <code>main</code>.</p>



<a name="329604482"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%235850%20x64%3A%20Only%20branch%20once%20in%20br_table/near/329604482" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.235850.20x64.3A.20Only.20branch.20once.20in.20br_table.html#329604482">(Feb 22 2023 at 23:24)</a>:</h4>
<p><strong>jameysharp</strong> has marked <a href="https://github.com/bytecodealliance/wasmtime/pull/5850">PR #5850</a> as ready for review.</p>



<a name="329612926"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%235850%20x64%3A%20Only%20branch%20once%20in%20br_table/near/329612926" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.235850.20x64.3A.20Only.20branch.20once.20in.20br_table.html#329612926">(Feb 23 2023 at 01:07)</a>:</h4>
<p>cfallin submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/5850#pullrequestreview-1310495971">PR review</a>.</p>



<a name="329612927"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%235850%20x64%3A%20Only%20branch%20once%20in%20br_table/near/329612927" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.235850.20x64.3A.20Only.20branch.20once.20in.20br_table.html#329612927">(Feb 23 2023 at 01:07)</a>:</h4>
<p>cfallin submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/5850#pullrequestreview-1310495971">PR review</a>.</p>



<a name="329612928"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%235850%20x64%3A%20Only%20branch%20once%20in%20br_table/near/329612928" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.235850.20x64.3A.20Only.20branch.20once.20in.20br_table.html#329612928">(Feb 23 2023 at 01:07)</a>:</h4>
<p>cfallin created <a href="https://github.com/bytecodealliance/wasmtime/pull/5850#discussion_r1115153845">PR review comment</a>:</p>
<blockquote>
<p>Can we add a comment here that this is safe because <code>tmp2</code> is written only after <code>idx</code> is used, and likewise a comment in <code>emit.rs</code> in the listing of the emitted sequence that if this property changes, we need to update regalloc metadata?</p>
</blockquote>



<a name="336379192"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%235850%20x64%3A%20Only%20branch%20once%20in%20br_table/near/336379192" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.235850.20x64.3A.20Only.20branch.20once.20in.20br_table.html#336379192">(Feb 24 2023 at 02:08)</a>:</h4>
<p>jameysharp updated <a href="https://github.com/bytecodealliance/wasmtime/pull/5850">PR #5850</a> from <code>branch-once</code> to <code>main</code>.</p>



<a name="336379244"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%235850%20x64%3A%20Only%20branch%20once%20in%20br_table/near/336379244" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.235850.20x64.3A.20Only.20branch.20once.20in.20br_table.html#336379244">(Feb 24 2023 at 02:09)</a>:</h4>
<p>jameysharp has enabled auto merge for <a href="https://github.com/bytecodealliance/wasmtime/pull/5850">PR #5850</a>.</p>



<a name="336404057"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%235850%20x64%3A%20Only%20branch%20once%20in%20br_table/near/336404057" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.235850.20x64.3A.20Only.20branch.20once.20in.20br_table.html#336404057">(Feb 24 2023 at 06:22)</a>:</h4>
<p>jameysharp merged <a href="https://github.com/bytecodealliance/wasmtime/pull/5850">PR #5850</a>.</p>



<hr><p>Last updated: Jan 20 2025 at 06:04 UTC</p>
</html>