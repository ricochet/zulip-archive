<html>
<head><meta charset="utf-8"><title>wasmtime / issue #9542 wasmtime serve: allow component re... · git-wasmtime · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/index.html">git-wasmtime</a></h2>
<h3>Topic: <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.239542.20wasmtime.20serve.3A.20allow.20component.20re.2E.2E.2E.html">wasmtime / issue #9542 wasmtime serve: allow component re...</a></h3>

<hr>

<base href="https://bytecodealliance.zulipchat.com">

<head><link href="https://bytecodealliance.github.io/zulip-archive/style.css" rel="stylesheet"></head>

<a name="480121166"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%239542%20wasmtime%20serve%3A%20allow%20component%20re.../near/480121166" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.239542.20wasmtime.20serve.3A.20allow.20component.20re.2E.2E.2E.html#480121166">(Nov 01 2024 at 21:34)</a>:</h4>
<p>ydnar opened <a href="https://github.com/bytecodealliance/wasmtime/issues/9542">issue #9542</a>:</p>
<blockquote>
<p>Thanks for filing a feature request! Please fill out the TODOs below.</p>
<h4>Feature</h4>
<p>I’d like an option (or default) for <code>wasmtime serve</code> to reuse a component for multiple requests.</p>
<h4>Benefit</h4>
<p>Amortize costly runtime or application initialization across multiple requests.</p>
<h4>Implementation</h4>
<p>Not sure!</p>
<h4>Alternatives</h4>
<p>Use a different <code>wasi-http</code> host other than <code>wasmtime</code> in development that supports instance reuse?<br>
</p>
</blockquote>



<a name="480121204"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%239542%20wasmtime%20serve%3A%20allow%20component%20re.../near/480121204" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.239542.20wasmtime.20serve.3A.20allow.20component.20re.2E.2E.2E.html#480121204">(Nov 01 2024 at 21:35)</a>:</h4>
<p>ydnar edited <a href="https://github.com/bytecodealliance/wasmtime/issues/9542">issue #9542</a>:</p>
<blockquote>
<p>Thanks for filing a feature request! Please fill out the TODOs below.</p>
<h4>Feature</h4>
<p>I’d like an option (or default) for <code>wasmtime serve</code> to reuse a component for multiple requests. e.g. <code>wasmtime serve --reuse</code> or <code>wasmtime serve --no-reuse</code></p>
<h4>Benefit</h4>
<p>Amortize costly runtime or application initialization across multiple requests.</p>
<h4>Implementation</h4>
<p>Not sure!</p>
<h4>Alternatives</h4>
<p>Use a different <code>wasi-http</code> host other than <code>wasmtime</code> in development that supports instance reuse?<br>
</p>
</blockquote>



<a name="480126269"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%239542%20wasmtime%20serve%3A%20allow%20component%20re.../near/480126269" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.239542.20wasmtime.20serve.3A.20allow.20component.20re.2E.2E.2E.html#480126269">(Nov 01 2024 at 22:30)</a>:</h4>
<p>bjorn3 <a href="https://github.com/bytecodealliance/wasmtime/issues/9542#issuecomment-2452672844">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/9542">issue #9542</a>:</p>
<blockquote>
<blockquote>
<p>Amortize costly runtime or application initialization across multiple requests.</p>
</blockquote>
<p><a href="https://github.com/bytecodealliance/wizer">Wizer</a> is intended to help with that. It takes a wasm module, runs the initialization code in it and then produces a new wasm module with all initialization already done. It does require some minor changes to your own code to indicate when initialization is done though.</p>
</blockquote>



<a name="480240349"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%239542%20wasmtime%20serve%3A%20allow%20component%20re.../near/480240349" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.239542.20wasmtime.20serve.3A.20allow.20component.20re.2E.2E.2E.html#480240349">(Nov 02 2024 at 18:24)</a>:</h4>
<p>alexcrichton <a href="https://github.com/bytecodealliance/wasmtime/issues/9542#issuecomment-2453085045">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/9542">issue #9542</a>:</p>
<blockquote>
<p>I've got an <a href="https://github.com/alexcrichton/wasmtime/commits/instance-reuse">old branch of mine</a> that I was experimenting with for this which I just rebased to dust it off a bit. There's been some discussion amongst folks historically about this and one of the concerns historically has been about certain instances either requiring reuse or explicitly not supporting reuse and how to surface that in the component itself. Those discussions never reached a firm conclusion one way or another though which is why it's never landed as a feature yet. I'll note that I'm not intimately familiar with the concerns here and I'm mostly a proxy for other (e.g. @lukewagner I think knows much more about the concerns both ways here).</p>
<p>Otherwise I'll definitely echo @bjorn3's idea of wizer. I suspect @ydnar you're already familiar with it but for anyone else who happens upon this in the future we've done a lot of work in Wasmtime to make instantiation as fast as possible through tools like wizer, APIs like <code>InstancePre</code>, and allocators like the pooling allocator in Wasmtime. That often can make instantiation fast enough for scenarios that instance reuse isn't required.</p>
<p>I'd also still acknowledge though that even with all the tools in the toolbox I think there's still real situations where instance-per-request isn't fast enough. Personally I think we should support a flag like this on the command line (the default being perhaps a separate question).</p>
</blockquote>



<a name="480242464"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%239542%20wasmtime%20serve%3A%20allow%20component%20re.../near/480242464" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.239542.20wasmtime.20serve.3A.20allow.20component.20re.2E.2E.2E.html#480242464">(Nov 02 2024 at 18:57)</a>:</h4>
<p>ydnar <a href="https://github.com/bytecodealliance/wasmtime/issues/9542#issuecomment-2453095480">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/9542">issue #9542</a>:</p>
<blockquote>
<p>Thanks!</p>
<p>Wizer works to a point, but cannot help amortize long-lived connections to upstream servers (like databases).</p>
<p>Echoing some live conversations with @alexcrichton and @lukewagner: I think the design of wasi:http/proxy implies reuse, but does not mandate it. A host can choose to not reuse, and a guest can exit to indicate it doesn't want to be reused.</p>
<p>My specific use case: I'm working on a talk for WasmCon with @mossaka, demoing a Go implementation of wasi-http, and would love to show off the new go:wasmexport feature that integrates with goroutines and the runtime.</p>
</blockquote>



<a name="480546132"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%239542%20wasmtime%20serve%3A%20allow%20component%20re.../near/480546132" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.239542.20wasmtime.20serve.3A.20allow.20component.20re.2E.2E.2E.html#480546132">(Nov 04 2024 at 23:39)</a>:</h4>
<p>lukewagner <a href="https://github.com/bytecodealliance/wasmtime/issues/9542#issuecomment-2455925067">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/9542">issue #9542</a>:</p>
<blockquote>
<p>FWIW, a summary of the idea proposed in <a href="https://github.com/WebAssembly/component-model/issues/307">component-model/#307</a> is:</p>
<ul>
<li>have <code>wasmtime serve</code> default to instance-per-request, but offer a flag to enable instance reuse</li>
<li>define a new (non-custom) section in component binaries containing a "reuse hint"</li>
<li>if <code>wasmtime serve</code> instantiates a component that transitively contains the "reuse hint" without the instance-reuse-flag being set, an informative console message is issued</li>
</ul>
<p>This would seem to me to balance the many subtle competing concerns.</p>
</blockquote>



<a name="480550941"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%239542%20wasmtime%20serve%3A%20allow%20component%20re.../near/480550941" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.239542.20wasmtime.20serve.3A.20allow.20component.20re.2E.2E.2E.html#480550941">(Nov 05 2024 at 00:22)</a>:</h4>
<p>ydnar <a href="https://github.com/bytecodealliance/wasmtime/issues/9542#issuecomment-2455970482">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/9542">issue #9542</a>:</p>
<blockquote>
<blockquote>
<p>define a new (non-custom) section in component binaries containing a "reuse hint"</p>
</blockquote>
<p>A couple challenges I see with this approach:</p>
<ul>
<li>It changes the binary format, requiring tooling changes.</li>
<li>It requires tooling to thread intent ("I want this component to [not] be reused") from code, pragma, or flags, through to the resulting binary. Where does a component or module author express this intent?</li>
<li>It is static—versus the component itself indicating, dynamically, at runtime, that it should or should not be reused.</li>
</ul>
<p>I’d favor an alternative, where:</p>
<ul>
<li>Instance reuse is expected and allowed, not not required.</li>
<li>Hosts can choose how much reuse to offer, from zero to unbounded. This maps to existing ephemeral/"serverless" deployment models.</li>
<li>Instances can <em>choose</em> to not be reused by exiting e.g. calling something like <code>wasi:cli/exit</code>.</li>
</ul>
</blockquote>



<a name="480551080"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%239542%20wasmtime%20serve%3A%20allow%20component%20re.../near/480551080" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.239542.20wasmtime.20serve.3A.20allow.20component.20re.2E.2E.2E.html#480551080">(Nov 05 2024 at 00:24)</a>:</h4>
<p>ydnar edited a <a href="https://github.com/bytecodealliance/wasmtime/issues/9542#issuecomment-2455970482">comment</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/9542">issue #9542</a>:</p>
<blockquote>
<blockquote>
<p>define a new (non-custom) section in component binaries containing a "reuse hint"</p>
</blockquote>
<p>A couple challenges I see with this approach:</p>
<ul>
<li>It changes the binary format, requiring tooling changes.</li>
<li>It requires tooling to thread intent ("I want this component to [not] be reused") from code, pragma, or flags, through to the resulting binary. Where does a component or module author express this intent?</li>
<li>It is static—versus the component itself indicating, dynamically, at runtime, that it should or should not be reused.</li>
</ul>
<p>I’d favor an alternative, where:</p>
<ul>
<li>Instance reuse is expected and allowed, not not required.</li>
<li>Hosts can choose how much reuse to offer, from zero to unbounded. This maps to existing ephemeral/"serverless" deployment models.</li>
<li>Instances can <em>choose</em> to not be reused by exiting e.g. calling something like <code>wasi:cli/exit</code>.</li>
<li>Instances can indicate they wish to be reused [indefinitely], but the host does not have to honor it.</li>
</ul>
</blockquote>



<a name="480557241"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%239542%20wasmtime%20serve%3A%20allow%20component%20re.../near/480557241" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.239542.20wasmtime.20serve.3A.20allow.20component.20re.2E.2E.2E.html#480557241">(Nov 05 2024 at 01:30)</a>:</h4>
<p>lukewagner <a href="https://github.com/bytecodealliance/wasmtime/issues/9542#issuecomment-2456038377">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/9542">issue #9542</a>:</p>
<blockquote>
<p>Hrm, I'm not sure if what you're proposing is any different...</p>
<blockquote>
<ul>
<li>Instance reuse is expected and allowed, not not required.</li>
<li>Hosts can choose how much reuse to offer, from zero to unbounded. This maps to existing ephemeral/"serverless" deployment models.</li>
</ul>
</blockquote>
<p>These are already the case (both in the component model in general and explicitly in WASI HTTP's doc comments).</p>
<blockquote>
<ul>
<li>Instances can choose to not be reused by exiting e.g. calling something like wasi:cli/exit.</li>
</ul>
</blockquote>
<p>This too is also already possible.  (I'll point out that, since <code>wasi:cli/exit</code> is essentially just a trap without the negative connotation, this is an anti-composable thing for a component to do, since it tears down the whole component DAG including any client components that probably didn't want to die just because they called an imported utility function.  There are better options, but I think they're not relevant here.)</p>
<blockquote>
<ul>
<li>Instances can indicate they wish to be reused [indefinitely], but the host does not have to honor it.</li>
</ul>
</blockquote>
<p>This is what the "reuse hint" is.  I don't know if you're imagining some more dynamic indication (calling an imported function or something), but that's no less work (perhaps more) and has less up-front information that can be used by the runtime/platform to provide useful diagnostics to the developer.  I also don't know if you're worrying about what's expressible in the <a href="https://github.com/WebAssembly/component-model/pull/378">core webassembly build target</a>, but we can always express the reuse hint as some symbolic core wasm import or export that <code>wasm-tools component new</code> (or core runtimes) understand the meaning of.</p>
<p>Lastly, I don't know if you're proposing to change the <em>default</em> behavior of <code>wasmtime serve</code> (when no flags are specified), but I think a number of folks have strong opinions on that (since it preemptively gives up temporal isolation), so if you are I'd suggest separating out that discussion from the more mechanistic discussions of expressing intent here.</p>
</blockquote>



<a name="480763570"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%239542%20wasmtime%20serve%3A%20allow%20component%20re.../near/480763570" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.239542.20wasmtime.20serve.3A.20allow.20component.20re.2E.2E.2E.html#480763570">(Nov 05 2024 at 16:53)</a>:</h4>
<p>ydnar <a href="https://github.com/bytecodealliance/wasmtime/issues/9542#issuecomment-2457695779">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/9542">issue #9542</a>:</p>
<blockquote>
<p>Thanks for breaking down the overlapping problem spaces here!</p>
<ul>
<li>I think Wasmtime should, by default, reuse instances. I think it’s more straightforward to define temporal isolation as a subset of behavior, rather than reuse as a superset.</li>
<li>As for a component expressing whether it wants to be reused: I’d favor dynamic (code instead of configuration). If could be as simple as a well-known or "core" export that returns a <code>bool</code> or <code>enum</code> value. </li>
</ul>
</blockquote>



<a name="480763639"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%239542%20wasmtime%20serve%3A%20allow%20component%20re.../near/480763639" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.239542.20wasmtime.20serve.3A.20allow.20component.20re.2E.2E.2E.html#480763639">(Nov 05 2024 at 16:53)</a>:</h4>
<p>ydnar edited a <a href="https://github.com/bytecodealliance/wasmtime/issues/9542#issuecomment-2457695779">comment</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/9542">issue #9542</a>:</p>
<blockquote>
<p>Thanks for breaking down the overlapping problem spaces here!</p>
<ul>
<li>I think Wasmtime should, by default, reuse instances. I think it’s more straightforward to define temporal isolation as a subset of behavior, rather than reuse as a superset.</li>
<li>As for a component expressing whether it wants to be reused: I’d favor dynamic over static (code instead of configuration). If could be as simple as a well-known or "core" export that returns a <code>bool</code> or <code>enum</code> value. </li>
</ul>
</blockquote>



<hr><p>Last updated: Jan 20 2025 at 06:04 UTC</p>
</html>